<html lang="en"><head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Blitzball FFX Remastered</title>
    <style>:root {
    --ffx-blue-deep: #020408;
    --ffx-blue-dark: #0a1525;
    --ffx-blue-mid: #152a45;
    --ffx-blue-light: #2a4d75;
    --ffx-cyan: #60c0d0;
    --ffx-cyan-glow: #00ffff;
    --ffx-gold: #c8b060;
    --ffx-gold-light: #f0e090;
    --ffx-gold-dark: #8a7030;
    --ffx-glass-bg: rgba(10, 20, 40, 0.75);
    --ffx-glass-border: rgba(100, 200, 255, 0.3);
    
    --font-title: 'Garamond', 'Times New Roman', serif;
    --font-data: 'Impact', 'Arial Narrow', sans-serif;
    --font-ui: 'Courier New', monospace;
    --font-spira: 'Spira', 'Impact', sans-serif;
}

@font-face {
    font-family: 'Spira';
    src: url('https://files.catbox.moe/zyn7s3.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
}

html, body {
    margin: 0;
    padding: 0;
    background-color: #000;
    overflow: hidden;
    width: 100vw;
    height: 100%;
    position: fixed; 
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    font-family: var(--font-data);
    color: white;
    user-select: none;
    -webkit-user-select: none;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
}

* {
    box-sizing: border-box;
}

/* --- MAIN GAME CONTAINER --- */
#game-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    max-width: none;
    background: #000510;
    box-shadow: none;
    overflow: hidden;
    transition: filter 0.05s;
    z-index: 1;
}

/* --- IMPACT FX --- */
#game-container.impact-fx {
    animation: impactShake 0.1s ease-in-out;
    filter: contrast(1.2) brightness(1.1);
}

#game-container.impact-heavy {
    animation: impactShake 0.2s ease-in-out;
    filter: contrast(1.5) brightness(1.3) sepia(0.4) hue-rotate(-10deg);
}

#game-container.impact-shatter {
    animation: impactShake 0.4s ease-in-out;
    filter: contrast(2.0) invert(0.1) saturate(2.0);
}

@keyframes impactShake {
    0% { transform: translate(0, 0); }
    25% { transform: translate(-5px, 5px); }
    50% { transform: translate(5px, -5px); }
    75% { transform: translate(-5px, -5px); }
    100% { transform: translate(0, 0); }
}

/* --- CANVAS & RENDER --- */
canvas {
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    image-rendering: pixelated; 
    z-index: 0;
}

/* --- GIF OVERLAY --- */
#screen-overlay-gif {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    mix-blend-mode: overlay;
    opacity: 1.0;
    pointer-events: none;
    z-index: 950;
    image-rendering: pixelated;
}

#ui-layer {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    z-index: 1000;
}

/* --- CINEMATIC BARS --- */
#cinematic-bars .bar {
    position: absolute;
    left: 0; width: 100%; height: 0;
    background: black;
    transition: height 0.5s ease;
    z-index: 800;
}
#cinematic-bars .bar.top { top: 0; }
#cinematic-bars .bar.bottom { bottom: 0; }

/* --- TECH FLASH OVERLAY --- */
#tech-flash-overlay {
    position: absolute;
    top: 20%; left: 0; width: 100%; height: 120px;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(0, 20, 60, 0.9) 20%, rgba(0, 20, 60, 0.9) 80%, rgba(0,0,0,0) 100%);
    z-index: 2200;
    backdrop-filter: blur(2px);
    border-top: 1px solid rgba(100, 255, 255, 0.3);
    border-bottom: 1px solid rgba(100, 255, 255, 0.3);
    animation: flashEnter 0.15s ease-out;
}

@keyframes flashEnter {
    from { transform: scaleY(0); opacity: 0; }
    to { transform: scaleY(1); opacity: 1; }
}

.tech-content-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    transform: skewX(-10deg);
}

.tech-text {
    font-family: var(--font-spira);
    font-size: clamp(28px, 10vw, 42px);
    color: #ffffff;
    text-shadow: 0 0 10px #00ffff, 0 0 20px #0000ff;
    letter-spacing: 3px;
    margin-bottom: 2px;
    font-style: italic;
    animation: blinkText 0.08s infinite alternate;
    text-align: center;
}

.tech-sub-text {
    font-family: var(--font-ui);
    font-size: 14px;
    color: #00ffff;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 8px;
    text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
}

.tech-timer-track {
    width: 250px;
    height: 8px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #444;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
}

.tech-timer-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffffff, #00ffff);
    width: 100%;
    transform-origin: left;
    box-shadow: 0 0 10px #00ffff;
}

@keyframes blinkText {
    from { opacity: 0.8; text-shadow: 0 0 5px #00ffff; transform: scale(1); }
    to { opacity: 1.0; text-shadow: 0 0 20px #ffffff, 0 0 10px #00ffff; transform: scale(1.02); }
}

/* --- HUD TOP --- */
#hud-top {
    position: absolute;
    top: 0;
    left: 0;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    width: 100%;
    padding: 15px;
    padding-top: max(15px, env(safe-area-inset-top));
    padding-left: max(15px, env(safe-area-inset-left));
    padding-right: max(15px, env(safe-area-inset-right));
    box-sizing: border-box;
    background: linear-gradient(to bottom, rgba(0, 5, 15, 0.9) 0%, rgba(0,0,0,0) 100%);
    pointer-events: none;
}

.team-wing {
    position: relative;
    display: flex;
    align-items: center;
    width: 130px;
    height: 50px;
    background: linear-gradient(160deg, var(--ffx-blue-mid) 0%, var(--ffx-blue-deep) 100%);
    border: 1px solid var(--ffx-blue-light);
    border-top: 2px solid var(--ffx-cyan);
    border-radius: 4px;
    transform: skewX(-15deg);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    padding: 0 10px;
}

.team-wing.away {
    transform: skewX(15deg);
    flex-direction: row-reverse;
    border-top-color: #ff6666;
    background: linear-gradient(-160deg, #2a1010 0%, #100505 100%);
}

.team-data {
    display: flex;
    flex-direction: column;
    justify-content: center;
    transform: skewX(15deg);
}
.team-wing.away .team-data { transform: skewX(-15deg); text-align: right; }

.team-name {
    font-family: var(--font-title);
    font-size: 14px;
    color: var(--ffx-gold-light);
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 2px 2px rgba(0,0,0,0.8);
}
.team-sub {
    font-family: var(--font-data);
    font-size: 10px;
    color: var(--ffx-cyan);
    opacity: 0.8;
}
.team-wing.away .team-sub { color: #ffaaaa; }

.score-box {
    font-family: var(--font-data);
    font-size: 38px;
    color: white;
    text-shadow: 0 0 10px var(--ffx-cyan-glow);
    transform: skewX(15deg);
    margin: 0 10px;
}
.team-wing.away .score-box { transform: skewX(-15deg); text-shadow: 0 0 10px #ff4444; }

.timer-complex {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: -5px;
}

.timer-crystal-ring {
    position: absolute;
    top: -25px;
    width: 120px;
    height: 60px;
    border-radius: 50%;
    border-top: 3px solid var(--ffx-gold);
    border-bottom: 1px solid transparent;
    box-shadow: 0 -5px 15px rgba(200, 180, 100, 0.3);
    z-index: -1;
    background: radial-gradient(ellipse at top, rgba(20, 40, 80, 0.8), transparent 70%);
}

#half-indicator {
    font-family: var(--font-data);
    font-size: 10px;
    color: var(--ffx-gold);
    letter-spacing: 2px;
    margin-bottom: -2px;
    text-shadow: 0 0 5px var(--ffx-gold-dark);
}

#timer-display {
    font-family: var(--font-data);
    font-size: 42px;
    background: linear-gradient(to bottom, #fff 0%, #ffd700 50%, #b8860b 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.8));
    letter-spacing: 1px;
}

/* --- PLAYER STATUS PANEL --- */
#player-status-panel {
    position: absolute;
    bottom: max(160px, env(safe-area-inset-bottom) + 40px);
    left: max(20px, env(safe-area-inset-left));
    width: 160px;
    padding: 10px;
    background: linear-gradient(90deg, rgba(0, 10, 30, 0.8) 0%, rgba(0,0,0,0) 100%);
    border-left: 3px solid var(--ffx-cyan);
    border-radius: 0 10px 10px 0;
    backdrop-filter: blur(4px);
    transform: skewX(-10deg);
    pointer-events: none;
    display: none;
}

.char-name {
    font-family: var(--font-title);
    font-size: 18px;
    color: white;
    text-transform: uppercase;
    margin-bottom: 5px;
    transform: skewX(10deg);
    text-shadow: 0 0 5px var(--ffx-blue-light);
}

.hp-gauge-container {
    display: flex;
    align-items: center;
    margin-bottom: 4px;
    transform: skewX(10deg);
}
.hp-label { font-size: 10px; color: var(--ffx-cyan); width: 20px; }
.hp-bar-track {
    flex-grow: 1;
    height: 6px;
    background: rgba(0,0,0,0.5);
    border: 1px solid #444;
    margin: 0 5px;
}
.hp-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #00ff00, #ccffcc);
    box-shadow: 0 0 5px #00ff00;
}
.hp-value { font-size: 10px; color: #fff; width: 45px; text-align: right; }

.tech-gauge-container {
    display: flex;
    align-items: center;
    transform: skewX(10deg);
}
.tech-label { font-size: 10px; color: var(--ffx-gold); width: 20px; }
.tech-bar-track {
    flex-grow: 1;
    height: 4px;
    background: rgba(0,0,0,0.5);
    border: 1px solid #444;
    margin: 0 5px;
}
.tech-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffaa00, #ffffaa);
}

/* --- MINIMAP --- */
#minimap-container {
    position: absolute;
    top: max(80px, env(safe-area-inset-top) + 60px);
    right: max(20px, env(safe-area-inset-right));
    width: 110px;
    height: 110px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.radar-rim {
    position: absolute;
    width: 100%; height: 100%;
    border-radius: 50%;
    border: 2px solid var(--ffx-blue-light);
    box-shadow: 0 0 15px var(--ffx-blue-mid), inset 0 0 20px rgba(0,0,0,0.8);
    background: radial-gradient(circle, rgba(0, 20, 60, 0.4) 0%, rgba(0, 5, 10, 0.8) 100%);
    z-index: 5;
}

#minimap {
    position: relative;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    z-index: 6;
    overflow: hidden;
}

.radar-label {
    position: absolute;
    bottom: -15px;
    width: 140%;
    left: -20%;
    text-align: center;
    font-family: var(--font-spira);
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 0 5px var(--ffx-cyan);
}

.map-dot {
    position: absolute;
    width: 6px; height: 6px;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 4px currentColor;
}
.map-dot.home { background: var(--ffx-cyan); color: var(--ffx-cyan); }
.map-dot.away { background: #ff4444; color: #ff4444; }
.map-dot.ball { 
    background: #ff00cc;
    color: #ff00cc; 
    width: 12px; height: 12px;
    border: 2px solid #ffffff;
    z-index: 20;
    animation: blinkBall 0.3s infinite alternate;
    box-shadow: 0 0 6px #ff00cc;
}
.map-dot.nap { background: #333; color: #000; border: 1px solid #555; }
.map-dot.active-player { 
    background: #00ff00 !important; 
    color: #00ff00 !important; 
    box-shadow: 0 0 8px #00ff00;
    z-index: 15;
    transform: translate(-50%, -50%) scale(1.2);
}
.map-dot.ball-carrier {
    box-shadow: 0 0 15px #fff, 0 0 30px #ffaa00;
    border: 2px solid #ffffff;
    background-color: #ffaa00 !important;
    z-index: 100;
    width: 10px; height: 10px;
    animation: carrierPulse 0.8s infinite alternate;
}
@keyframes carrierPulse {
    from { transform: translate(-50%, -50%) scale(1.2); box-shadow: 0 0 10px #fff; opacity: 0.8; }
    to { transform: translate(-50%, -50%) scale(1.8); box-shadow: 0 0 25px #ffcc00; opacity: 1.0; }
}
@keyframes blinkBall { from { opacity: 1; transform: translate(-50%, -50%) scale(1); } to { opacity: 0.5; transform: translate(-50%, -50%) scale(1.3); } }

/* --- ANNOUNCEMENTS --- */
#announcement {
    position: absolute;
    top: 40%; 
    left: 5%; 
    width: 90%;
    text-align: center;
    font-family: var(--font-data);
    font-size: clamp(40px, 12vw, 72px);
    font-weight: 900;
    font-style: italic;
    text-transform: uppercase;
    letter-spacing: 2px;
    line-height: 1.0;
    white-space: normal;
    background: linear-gradient(to bottom, #fff 0%, #ffd700 40%, #b8860b 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 10px rgba(255, 100, 0, 0.5)) drop-shadow(3px 3px 0 #000);
    display: none;
    z-index: 2000;
    animation: announceSlide 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    pointer-events: none;
}

@keyframes announceSlide {
    from { transform: scale(0) rotate(-5deg); opacity: 0; }
    to { transform: scale(1) rotate(0deg); opacity: 1; }
}

/* --- JOYSTICK --- */
#joystick-hit-zone {
    position: absolute;
    bottom: 0; left: 0;
    width: 50%; height: 50%;
    z-index: 1000;
    background: rgba(0,0,0,0); 
    touch-action: none;
    pointer-events: auto;
}

#joystick-visual-container {
    position: absolute;
    top: 0; left: 0;
    width: 0; height: 0;
    overflow: visible;
    pointer-events: none;
    display: none;
    z-index: 1100;
}

#joystick-base {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 120px; height: 120px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(0, 40, 80, 0.4) 0%, rgba(0, 10, 20, 0.1) 60%, transparent 100%);
    border: 1px solid rgba(100, 220, 255, 0.3);
    box-shadow: 0 0 20px rgba(0, 100, 255, 0.2), inset 0 0 30px rgba(0, 50, 100, 0.3);
    animation: basePulse 2s infinite alternate;
}

@keyframes basePulse {
    from { box-shadow: 0 0 10px rgba(0, 100, 255, 0.2); border-color: rgba(100, 220, 255, 0.2); }
    to { box-shadow: 0 0 25px rgba(0, 100, 255, 0.5); border-color: rgba(100, 255, 255, 0.6); }
}

#joystick-knob {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 50px; height: 50px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, #e0ffff 0%, #00aaff 40%, #004488 80%, #001122 100%);
    border: 2px solid #88ccff;
    box-shadow: 0 0 15px #00ffff, inset 0 0 10px rgba(255,255,255,0.8);
    transition: transform 0.05s linear;
}

#joystick-knob::after {
    content: "";
    position: absolute;
    top: 20%; left: 20%; width: 20%; height: 20%;
    background: radial-gradient(circle, #ffffff 0%, transparent 70%);
    filter: blur(2px);
    opacity: 0.8;
}

.touch-ripple {
    position: absolute;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(200, 255, 255, 0.8) 0%, rgba(0, 255, 255, 0.4) 40%, transparent 70%);
    transform: translate(-50%, -50%) scale(0);
    animation: rippleAnim 0.6s ease-out forwards;
    pointer-events: none;
    z-index: 9000;
    mix-blend-mode: screen;
}

@keyframes rippleAnim {
    0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(3.0); opacity: 0; }
}

#camera-zone {
    position: absolute;
    top: 0; right: 0; width: 50%; height: 100%;
    pointer-events: auto;
    touch-action: none;
    z-index: 50;
}

/* --- ACTION BUTTON --- */
#action-container {
    position: absolute;
    bottom: max(40px, env(safe-area-inset-bottom)); 
    right: max(40px, env(safe-area-inset-right));
    display: flex;
    flex-direction: column;
    align-items: center;
    pointer-events: auto;
    z-index: 100;
}

.command-menu-bg {
    position: absolute;
    width: 180px; height: 80px;
    bottom: 15px;
    background: linear-gradient(90deg, transparent 0%, rgba(0, 10, 30, 0.8) 50%, transparent 100%);
    border-bottom: 1px solid rgba(0, 200, 255, 0.3);
    z-index: -1;
}

.command-ring {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 130px; height: 130px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-top: 2px solid rgba(0, 255, 255, 0.6);
    border-bottom: 2px solid rgba(0, 255, 255, 0.6);
    border-radius: 50%;
    animation: spinReverse 15s linear infinite;
    pointer-events: none;
    box-shadow: 0 0 15px rgba(0, 100, 255, 0.2);
}
@keyframes spinReverse { from { transform: translate(-50%, -50%) rotate(360deg); } to { transform: translate(-50%, -50%) rotate(0deg); } }

#action-label {
    font-family: var(--font-spira);
    font-size: 12px;
    color: var(--ffx-cyan);
    background: rgba(0, 5, 10, 0.8);
    padding: 4px 12px;
    border: 1px solid var(--ffx-blue-light);
    border-radius: 10px;
    margin-bottom: 15px;
    text-transform: uppercase;
    letter-spacing: 2px;
    box-shadow: 0 0 10px rgba(0,0,0,0.8);
    text-shadow: 0 0 5px var(--ffx-cyan);
    transition: all 0.3s;
}

#action-button {
    position: absolute;
    top: 0; left: 0;
    width: 100px; height: 100px;
    border-radius: 50%;
    cursor: pointer;
    transition: transform 0.1s, filter 0.3s;
    background: radial-gradient(circle at 35% 35%, #ffffff 0%, #0088ff 40%, #002266 80%, #000 100%);
    border: 3px solid #44aaff;
    box-shadow: 0 0 20px rgba(0, 100, 255, 0.8), inset 0 0 20px rgba(255, 255, 255, 0.4);
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: visible;
    z-index: 10;
}

#pass-button {
    display: none !important;
    position: absolute;
    bottom: -20px; left: -30px;
    width: 60px; height: 60px;
    border-radius: 50%;
    cursor: pointer;
    z-index: 9;
}

#action-button::before {
    content: '';
    position: absolute;
    top: -40px; left: -40px; right: -40px; bottom: -40px;
    border-radius: 50%;
    z-index: 10;
}

#action-button:active { transform: scale(0.92); }

#action-button .btn-text {
    font-family: var(--font-title);
    font-size: 22px;
    font-weight: bold;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8), 0 0 10px rgba(255,255,255,0.5);
    z-index: 5;
    pointer-events: none;
    letter-spacing: 1px;
}

#action-button .btn-glare {
    position: absolute;
    top: -50%; left: -50%; width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.4) 50%, transparent 60%);
    animation: glarePass 5s infinite;
    pointer-events: none;
    z-index: 6;
    border-radius: 50%;
}

.limit-ring {
    position: absolute;
    top: -5px; left: -5px; right: -5px; bottom: -5px;
    border-radius: 50%;
    border: 2px solid transparent;
    box-shadow: 0 0 0 transparent;
    transition: all 0.5s;
    z-index: 1;
    pointer-events: none;
}

#action-button.shoot-mode {
    background: radial-gradient(circle at 35% 35%, #ffffaa 0%, #ffaa00 40%, #882200 80%, #220000 100%);
    border-color: #ffcc00;
    box-shadow: 0 0 30px rgba(255, 100, 0, 0.8), inset 0 0 20px rgba(255, 255, 0, 0.5);
}

#action-button.limit-ready .limit-ring {
    border-color: #ffdd44;
    animation: limitPulse 0.8s ease-in-out infinite alternate;
}

.shoot-label {
    color: #ffdd44 !important;
    border-color: #ffaa00 !important;
    text-shadow: 0 0 10px #ff4400 !important;
}

@keyframes limitPulse {
    0% { transform: scale(1.0); box-shadow: 0 0 10px #ffaa00, inset 0 0 5px #ffaa00; opacity: 0.5; }
    100% { transform: scale(1.15); box-shadow: 0 0 30px #ff4400, inset 0 0 15px #ff0000; opacity: 1.0; }
}

/* --- AUTO TOGGLE --- */
#auto-toggle {
    position: absolute;
    top: max(200px, env(safe-area-inset-top) + 60px); 
    right: max(20px, env(safe-area-inset-right));
    width: 110px;
    padding: 10px 0;
    text-align: center;
    font-size: 12px;
    font-weight: bold;
    color: var(--ffx-cyan);
    background: linear-gradient(135deg, rgba(0, 20, 40, 0.8) 0%, rgba(0, 5, 10, 0.9) 100%);
    border: 1px solid var(--ffx-blue-light);
    border-top: 1px solid var(--ffx-cyan);
    border-radius: 4px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    backdrop-filter: blur(4px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    pointer-events: auto;
    transition: all 0.2s;
    z-index: 100;
}

#auto-toggle:hover {
    background: rgba(0, 40, 80, 0.9);
    box-shadow: 0 0 15px var(--ffx-cyan);
    color: white;
}

#auto-toggle.active {
    background: linear-gradient(135deg, rgba(100, 20, 0, 0.8) 0%, rgba(40, 0, 0, 0.9) 100%);
    border-color: #ff4400;
    color: #ffaa00;
    animation: pulseRed 2s infinite;
}
@keyframes pulseRed { 0% { box-shadow: 0 0 5px #ff0000; } 50% { box-shadow: 0 0 20px #ff4400; } 100% { box-shadow: 0 0 5px #ff0000; } }

/* --- FLOATING TEXT --- */
.floating-text-wrapper {
    position: absolute;
    top: 0; left: 0;
    pointer-events: none;
    z-index: 2000;
    will-change: transform;
}

.floating-text-inner {
    display: block;
    font-family: var(--font-data);
    font-weight: 900;
    text-transform: uppercase;
    white-space: nowrap;
    text-align: center;
    font-size: 24px; 
    text-shadow: 1px 1px 0 #000;
    opacity: 0.9;
}

.floating-text-inner.damage {
    font-size: 42px;
    font-style: italic;
    background: linear-gradient(to bottom, #ffffff 0%, #ffcc00 40%, #ff4400 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 4px 4px rgba(0,0,0,0.8));
    animation: popDamage 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

.floating-text-inner.heal {
    font-size: 36px;
    color: #44ff44;
    text-shadow: 0 0 10px #00ff00;
    animation: floatUp 1s ease-out forwards;
}

.floating-text-inner.venom {
    font-family: var(--font-data);
    font-size: 42px;
    font-style: italic;
    color: #aaff00;
    text-shadow: 0 0 10px #448800, 2px 2px 0 #002200;
    background: linear-gradient(to bottom, #ccff66 0%, #66cc00 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 5px rgba(100, 255, 0, 0.5));
    animation: dripStatus 2s infinite;
}

.floating-text-inner.sleep {
    font-family: var(--font-title);
    font-size: 42px;
    color: #ffffff;
    text-shadow: 0 0 15px #0044ff, 0 0 30px #0000ff;
    opacity: 0.9;
    animation: driftStatus 3s ease-in-out infinite;
}

.floating-text-inner.wither {
    font-family: var(--font-data);
    font-size: 38px;
    color: #cccccc;
    text-shadow: 2px 2px 0 #444444;
    background: linear-gradient(to bottom, #eeeeee 0%, #888888 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: witherStatus 1.5s forwards;
}

.floating-text-inner.tech {
    font-family: var(--font-title);
    font-size: 32px;
    color: #00ffff;
    background: rgba(0, 10, 30, 0.7);
    padding: 2px 10px;
    border: 1px solid #00ffff;
    border-radius: 4px;
    box-shadow: 0 0 10px #0088ff;
    text-shadow: 0 0 5px #fff;
    animation: shakeTech 0.6s ease-in-out, flashTech 0.3s;
    transform-origin: center;
}

.floating-text-inner.save, .floating-text-inner.block {
    font-size: 48px;
    font-weight: 900;
    color: #ffffff;
    -webkit-text-stroke: 1px #004488;
    text-shadow: 0 0 20px #0088ff;
    animation: popDamage 0.5s ease-out forwards;
}

@keyframes popDamage {
    0% { transform: scale(0.5); opacity: 0; }
    20% { transform: scale(1.5); opacity: 1; }
    40% { transform: scale(1.0); opacity: 1; }
    100% { transform: scale(1.0); opacity: 0; }
}

@keyframes floatUp {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(-50px); opacity: 0; }
}

@keyframes dripStatus {
    0% { transform: scaleY(1); filter: blur(0px); }
    50% { transform: scaleY(1.1) translateY(5px); filter: blur(1px); }
    100% { transform: scaleY(1); filter: blur(0px); }
}

@keyframes driftStatus {
    0% { transform: translateX(0) rotate(0deg); opacity: 0; }
    20% { opacity: 1; }
    50% { transform: translateX(15px) translateY(-20px) rotate(10deg); }
    100% { transform: translateX(-15px) translateY(-50px) rotate(-10deg); opacity: 0; }
}

@keyframes witherStatus {
    0% { transform: scale(1); filter: grayscale(0%); opacity: 1; }
    100% { transform: scale(0.6); filter: grayscale(100%); opacity: 0; }
}

@keyframes shakeTech {
    0% { transform: scale(0.8); }
    10%, 30%, 50%, 70%, 90% { transform: scale(1.1) translate(-2px, 2px); }
    20%, 40%, 60%, 80% { transform: scale(1.1) translate(2px, -2px); }
    100% { transform: scale(1.0); }
}

@keyframes flashTech {
    0% { background-color: #fff; color: #000; border-color: #fff; }
    100% { background-color: rgba(0, 10, 30, 0.85); color: #00ffff; border-color: #00ffff; }
}

#loading {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    color: var(--ffx-cyan);
    text-transform: uppercase;
    letter-spacing: 5px;
    animation: blink 1s infinite;
}
@keyframes blink { 50% { opacity: 0.5; } }

#controls-hint {
    position: absolute;
    top: 130px; width: 100%;
    text-align: center;
    font-size: 10px;
    color: rgba(255,255,255,0.4);
    text-transform: uppercase;
    pointer-events: none;
}

.floating-text-inner.comic-impact {
    font-family: 'Impact', sans-serif;
    font-size: 42px;
    color: #ffff00; 
    -webkit-text-stroke: 1px #000;
    text-shadow: 3px 3px 0 #ff0000;
    font-style: italic;
    transform-origin: center;
    white-space: nowrap;
    animation: comicPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    z-index: 2500;
}

.floating-text-inner.comic-action {
    font-family: 'Arial Black', sans-serif;
    font-size: 28px;
    color: #00ffff; 
    -webkit-text-stroke: 1px #000;
    text-shadow: 2px 2px 0 #0044aa;
    font-style: italic;
    white-space: nowrap;
    animation: comicSlide 0.4s ease-out forwards;
    z-index: 2500;
}

@keyframes comicPop {
    0% { transform: scale(0) rotate(-20deg); opacity: 0; }
    40% { transform: scale(1.2) rotate(5deg); opacity: 1; }
    60% { transform: scale(1.0) rotate(-5deg); opacity: 1; }
    100% { transform: scale(1.1) rotate(0deg); opacity: 0; }
}

@keyframes comicSlide {
    0% { transform: translate(-20px, 20px) scale(0.5); opacity: 0; }
    100% { transform: translate(20px, -20px) scale(1.2); opacity: 0; }
}

/* --- MAIN MENU --- */
#main-menu {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease-in-out;
    background: radial-gradient(circle at center, rgba(0, 20, 60, 0.2) 0%, rgba(0, 5, 10, 0.5) 100%);
    backdrop-filter: blur(2px);
}

#main-menu.active {
    opacity: 1;
    pointer-events: auto;
}

.menu-bg-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: 
        linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,0.1) 50%), 
        linear-gradient(90deg, rgba(255,0,0,0.03), rgba(0,255,0,0.01), rgba(0,0,255,0.03));
    background-size: 100% 2px, 3px 100%;
    pointer-events: none;
    z-index: -1;
}

.ffx-logo-container {
    margin-bottom: 60px;
    text-align: center;
    transform: skewX(-10deg);
}

.ffx-logo-main {
    font-family: var(--font-title);
    font-size: 64px;
    color: #ffffff;
    text-shadow: 0 0 10px #00ffff, 0 0 20px #0088ff, 0 0 40px #0000ff;
    letter-spacing: 5px;
    background: linear-gradient(to bottom, #ffffff 0%, #aaccff 50%, #0088ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.8));
}

.ffx-logo-sub {
    font-family: var(--font-spira);
    font-size: 18px;
    color: var(--ffx-gold);
    letter-spacing: 12px;
    margin-top: -5px;
    text-shadow: 0 0 5px #ffaa00;
}

.menu-options {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 300px;
}

.menu-item {
    position: relative;
    padding: 15px 30px;
    background: linear-gradient(90deg, rgba(0, 40, 80, 0.6) 0%, rgba(0, 10, 20, 0.0) 100%);
    border-left: 4px solid rgba(100, 200, 255, 0.3);
    border-bottom: 1px solid rgba(100, 200, 255, 0.1);
    cursor: pointer;
    transition: all 0.2s;
    transform: skewX(-10deg);
    display: flex;
    align-items: center;
}

.menu-item:hover {
    background: linear-gradient(90deg, rgba(0, 80, 160, 0.8) 0%, rgba(0, 20, 40, 0.0) 100%);
    border-left-color: #00ffff;
    padding-left: 40px;
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
}

.menu-item .label {
    font-family: var(--font-title);
    font-size: 24px;
    color: #cccccc;
    letter-spacing: 2px;
    text-transform: uppercase;
    transform: skewX(10deg);
    transition: color 0.2s;
}

.menu-item:hover .label {
    color: #ffffff;
    text-shadow: 0 0 10px #00ffff;
}

.menu-item .cursor {
    font-size: 18px;
    color: var(--ffx-gold);
    margin-right: 15px;
    opacity: 0;
    transform: translateX(-10px) skewX(10deg);
    transition: all 0.2s;
}

.menu-item:hover .cursor {
    opacity: 1;
    transform: translateX(0) skewX(10deg);
}

.menu-footer {
    position: absolute;
    bottom: 20px;
    font-family: var(--font-ui);
    font-size: 10px;
    color: rgba(255,255,255,0.3);
    letter-spacing: 2px;
}

/* --- PRACTICE OVERLAY --- */
#practice-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 5, 10, 0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2500;
    pointer-events: none;
}

#practice-overlay.active {
    display: flex;
}

.practice-panel {
    position: absolute;
    top: max(60px, env(safe-area-inset-top) + 40px); 
    right: max(20px, env(safe-area-inset-right));
    width: 280px;
    background: linear-gradient(160deg, rgba(0, 20, 50, 0.95) 0%, rgba(0, 10, 20, 0.98) 100%);
    border: 1px solid #4488ff;
    border-radius: 0 0 15px 0;
    box-shadow: 0 0 20px rgba(0, 100, 255, 0.2), inset 0 0 50px rgba(0, 20, 60, 0.5);
    padding: 15px;
    pointer-events: auto;
    transform: skewX(-2deg);
    backdrop-filter: blur(5px);
}

.panel-header {
    margin-bottom: 15px;
    text-align: center;
}

.panel-title-group {
    display: flex;
    flex-direction: column;
}

.panel-title {
    font-family: var(--font-title);
    font-size: clamp(18px, 6vw, 24px);
    color: #ffffff;
    text-shadow: 0 0 10px #00ffff;
    letter-spacing: 2px;
}

.panel-subtitle {
    font-family: var(--font-spira);
    font-size: 8px;
    color: #4488ff;
    letter-spacing: 4px;
    margin-top: -2px;
}

.panel-deco-line {
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, transparent, #00ffff, transparent);
    margin-top: 5px;
    box-shadow: 0 0 5px #00ffff;
}

.panel-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.section-label {
    font-family: var(--font-ui);
    font-size: 10px;
    color: var(--ffx-gold);
    border-bottom: 1px solid rgba(200, 176, 96, 0.3);
    margin-bottom: 5px;
    padding-bottom: 2px;
    letter-spacing: 1px;
}

.drill-list {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.drill-btn {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    background: linear-gradient(90deg, rgba(255, 255, 255, 0.05), transparent);
    border-left: 2px solid transparent;
    cursor: pointer;
    font-family: var(--font-data);
    font-size: 14px;
    color: #aaa;
    transition: all 0.2s;
}

.drill-btn:hover {
    background: linear-gradient(90deg, rgba(0, 255, 255, 0.1), transparent);
    color: #fff;
    padding-left: 15px;
}

.drill-btn.active {
    background: linear-gradient(90deg, rgba(0, 100, 255, 0.4), transparent);
    border-left: 3px solid #00ffff;
    color: #fff;
    text-shadow: 0 0 5px #00ffff;
}

.drill-btn .icon {
    width: 20px;
    text-align: center;
    margin-right: 10px;
    color: var(--ffx-cyan);
}

.option-list {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.option-toggle {
    display: flex;
    align-items: center;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 12px;
    color: #ccc;
    transition: color 0.2s;
}

.option-toggle:hover { color: #fff; }

.option-toggle .checkbox {
    margin-right: 10px;
    color: #444;
    font-family: monospace;
    font-size: 14px;
}

.option-toggle.active .checkbox {
    color: #00ff00;
    text-shadow: 0 0 5px #00ff00;
}

.option-toggle.active {
    color: #fff;
}

.action-btn {
    text-align: center;
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid #444;
    padding: 6px;
    font-size: 11px;
    color: #aaa;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.action-btn:hover {
    border-color: #fff;
    color: #fff;
    background: rgba(255, 255, 255, 0.1);
}

#p-exit:hover {
    border-color: #ff4444;
    color: #ff4444;
    background: rgba(50, 0, 0, 0.3);
}

.panel-footer {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    text-align: center;
}

#drill-instruction {
    font-size: 10px;
    color: var(--ffx-cyan);
    margin-bottom: 5px;
    font-style: italic;
}

#drill-score {
    font-family: var(--font-data);
    font-size: 24px;
    color: var(--ffx-gold);
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

.panel-minimize-btn {
    position: absolute;
    top: 10px; right: 10px;
    width: 20px; height: 20px;
    border: 1px solid var(--ffx-cyan);
    color: var(--ffx-cyan);
    text-align: center;
    line-height: 18px;
    cursor: pointer;
    font-size: 14px;
    background: rgba(0,0,0,0.5);
    transition: all 0.2s;
}
.panel-minimize-btn:hover { 
    background: var(--ffx-cyan); 
    color: #000; 
    box-shadow: 0 0 5px var(--ffx-cyan);
}

#practice-restore-btn {
    position: absolute;
    top: max(60px, env(safe-area-inset-top) + 40px); 
    right: max(20px, env(safe-area-inset-right));
    padding: 8px 15px;
    background: linear-gradient(90deg, rgba(0, 20, 50, 0.9) 0%, rgba(0, 10, 20, 0.9) 100%);
    border: 1px solid var(--ffx-cyan);
    border-left: 3px solid var(--ffx-cyan);
    color: var(--ffx-cyan);
    font-family: var(--font-data);
    font-size: 12px;
    letter-spacing: 1px;
    cursor: pointer;
    z-index: 2400;
    display: none;
    pointer-events: auto;
    transform: skewX(-10deg);
    box-shadow: 0 0 10px rgba(0, 100, 255, 0.2);
    text-transform: uppercase;
}
#practice-restore-btn:hover {
    background: rgba(0, 40, 80, 0.9);
    color: #fff;
    text-shadow: 0 0 5px #00ffff;
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
}

/* --- AIM JOYSTICK --- */
#aim-joystick-zone {
    position: absolute;
    bottom: max(150px, env(safe-area-inset-bottom));
    right: 0;
    width: 40%;
    height: 35%;
    z-index: 1000;
    background: rgba(0,0,0,0);
    touch-action: none;
    pointer-events: auto;
}

#aim-joystick-visual {
    position: absolute;
    top: 0; left: 0;
    width: 0; height: 0;
    overflow: visible;
    pointer-events: none;
    display: none;
    z-index: 1100;
}

#aim-joystick-base {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 90px; height: 90px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(255, 100, 0, 0.3) 0%, rgba(80, 20, 0, 0.1) 60%, transparent 100%);
    border: 1px solid rgba(255, 150, 50, 0.4);
    box-shadow: 0 0 15px rgba(255, 100, 0, 0.2), inset 0 0 20px rgba(255, 50, 0, 0.2);
}

#aim-joystick-knob {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 40px; height: 40px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, #ffcc88 0%, #ff6600 40%, #882200 80%, #220000 100%);
    border: 2px solid #ffaa44;
    box-shadow: 0 0 10px #ff4400, inset 0 0 8px rgba(255,255,255,0.6);
    transition: transform 0.05s linear;
}

#aim-joystick-knob::after {
    content: "AIM";
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 8px;
    color: white;
    font-family: var(--font-data);
    text-shadow: 0 0 3px #000;
}

/* --- TACKLE BUTTON --- */
#tackle-button {
    position: absolute;
    bottom: max(160px, env(safe-area-inset-bottom) + 100px);
    right: max(40px, env(safe-area-inset-right));
    width: 70px;
    height: 70px;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    justify-content: center;
    align-items: center;
    pointer-events: auto;
    z-index: 100;
    background: radial-gradient(circle at 35% 35%, #ff8888 0%, #cc0000 40%, #660000 80%, #220000 100%);
    border: 3px solid #ff4444;
    box-shadow: 0 0 15px rgba(255, 50, 50, 0.6), inset 0 0 15px rgba(255, 200, 200, 0.3);
    transition: transform 0.1s, filter 0.2s;
}

#tackle-button:active {
    transform: scale(0.9);
    filter: brightness(1.2);
}

#tackle-button.active {
    background: radial-gradient(circle at 35% 35%, #ffffff 0%, #ff4444 40%, #aa0000 80%, #440000 100%);
    box-shadow: 0 0 25px rgba(255, 100, 100, 0.9);
}

#tackle-button .btn-text {
    font-family: var(--font-data);
    font-size: 12px;
    font-weight: bold;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    pointer-events: none;
    text-transform: uppercase;
    letter-spacing: 1px;
}

#tackle-button .btn-glare {
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.3) 50%, transparent 60%);
    pointer-events: none;
    border-radius: 50%;
    animation: glarePass 4s infinite;
}

#tackle-button.urgent {
    animation: urgentPulse 0.5s infinite alternate;
    background: radial-gradient(circle at 35% 35%, #ff5555 0%, #ff0000 40%, #880000 100%);
    border-color: #ffaaaa;
    box-shadow: 0 0 20px #ff0000;
}

@keyframes urgentPulse {
    from { transform: scale(1.0); }
    to { transform: scale(1.15); }
}

/* --- CHARGE POWER METER --- */
#charge-meter-container {
    position: absolute;
    bottom: max(250px, env(safe-area-inset-bottom) + 100px);
    left: 50%;
    transform: translateX(-50%);
    width: 200px;
    display: none;
    flex-direction: column;
    align-items: center;
    pointer-events: none;
    z-index: 2000;
    background: rgba(0, 10, 30, 0.8);
    padding: 10px 15px;
    border: 1px solid var(--ffx-cyan);
    border-radius: 5px;
    box-shadow: 0 0 15px rgba(0, 100, 255, 0.3);
}

.charge-label {
    font-family: var(--font-spira);
    font-size: 12px;
    color: var(--ffx-cyan);
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 5px;
}

.charge-meter-track {
    width: 100%;
    height: 12px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #444;
    border-radius: 6px;
    overflow: hidden;
}

#charge-meter-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #0af, #0f0);
    box-shadow: 0 0 10px #0f0;
    transition: width 0.05s linear, background 0.1s;
    border-radius: 5px;
}

.charge-hint {
    font-family: var(--font-ui);
    font-size: 10px;
    color: var(--ffx-gold);
    margin-top: 5px;
    opacity: 0.8;
    animation: blink 0.5s infinite;
}

/* --- GOAL DISTANCE INDICATOR --- */
#goal-distance-container {
    position: absolute;
    top: max(75px, env(safe-area-inset-top) + 55px);
    left: max(20px, env(safe-area-inset-left));
    display: flex;
    flex-direction: column;
    align-items: center;
    pointer-events: none;
    z-index: 100;
    background: linear-gradient(90deg, rgba(0, 10, 30, 0.7) 0%, transparent 100%);
    padding: 5px 15px 5px 10px;
    border-left: 2px solid var(--ffx-gold);
}

.distance-label {
    font-family: var(--font-spira);
    font-size: 8px;
    color: var(--ffx-gold);
    letter-spacing: 2px;
    text-transform: uppercase;
}

#goal-distance {
    font-family: var(--font-data);
    font-size: 24px;
    color: white;
    text-shadow: 0 0 5px var(--ffx-gold);
}

/* --- SETTINGS BUTTON --- */
#settings-button {
    position: absolute;
    top: max(240px, env(safe-area-inset-top) + 100px);
    right: max(20px, env(safe-area-inset-right));
    width: 110px;
    padding: 8px 0;
    text-align: center;
    font-size: 10px;
    font-weight: bold;
    color: #888;
    background: linear-gradient(135deg, rgba(20, 20, 20, 0.8) 0%, rgba(10, 10, 10, 0.9) 100%);
    border: 1px solid #444;
    border-radius: 4px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    pointer-events: auto;
    transition: all 0.2s;
    z-index: 100;
}

#settings-button:hover {
    background: rgba(40, 40, 40, 0.9);
    border-color: #888;
    color: #fff;
}

/* --- SETTINGS PANEL --- */
#settings-panel {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 280px;
    background: linear-gradient(160deg, rgba(0, 20, 50, 0.98) 0%, rgba(0, 10, 20, 0.99) 100%);
    border: 2px solid var(--ffx-cyan);
    border-radius: 10px;
    box-shadow: 0 0 30px rgba(0, 100, 255, 0.4);
    z-index: 3500;
    pointer-events: auto;
    backdrop-filter: blur(10px);
}

.settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid rgba(100, 200, 255, 0.3);
    background: rgba(0, 30, 60, 0.5);
}

.settings-header span {
    font-family: var(--font-title);
    font-size: 20px;
    color: white;
    text-shadow: 0 0 5px var(--ffx-cyan);
    letter-spacing: 3px;
}

#settings-close {
    width: 30px;
    height: 30px;
    border: 1px solid #ff4444;
    background: rgba(50, 0, 0, 0.5);
    color: #ff4444;
    font-size: 14px;
    cursor: pointer;
    border-radius: 5px;
    transition: all 0.2s;
}

#settings-close:hover {
    background: #ff4444;
    color: white;
}

.settings-content {
    padding: 20px;
}

.setting-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 5px;
}

.setting-row label {
    font-family: var(--font-data);
    font-size: 14px;
    color: #ccc;
}

.setting-row input[type="range"] {
    width: 100px;
    accent-color: var(--ffx-cyan);
}

.setting-row input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--ffx-cyan);
    cursor: pointer;
}

/* --- GLARE ANIMATION --- */
@keyframes glarePass {
    0% { transform: translateX(-100%) rotate(45deg); }
    30% { transform: translateX(100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}

/* --- STATUS TYPE FLOATING TEXT --- */
.floating-text-inner.status {
    font-family: var(--font-data);
    font-size: 28px;
    font-style: italic;
    color: #ff00ff;
    text-shadow: 0 0 10px #ff00ff, 2px 2px 0 #000;
    animation: statusPop 1.2s ease-out forwards;
}

@keyframes statusPop {
    0% { transform: scale(0.5) translateY(0); opacity: 0; }
    20% { transform: scale(1.3) translateY(-10px); opacity: 1; }
    100% { transform: scale(1.0) translateY(-40px); opacity: 0; }
}

/* --- GOAL TYPE FLOATING TEXT --- */
.floating-text-inner.goal {
    font-family: var(--font-data);
    font-size: 48px;
    font-weight: 900;
    background: linear-gradient(to bottom, #fff 0%, #ffd700 50%, #ff8800 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 4px 4px rgba(0,0,0,0.9));
    animation: goalPop 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

@keyframes goalPop {
    0% { transform: scale(0) rotate(-10deg); opacity: 0; }
    50% { transform: scale(1.5) rotate(5deg); opacity: 1; }
    100% { transform: scale(1.2) rotate(0deg); opacity: 0; }
}

/* --- DEFAULT TYPE FLOATING TEXT --- */
.floating-text-inner.default {
    font-family: var(--font-data);
    font-size: 24px;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    animation: floatUp 0.8s ease-out forwards;
}

/* --- MOBILE PORTRAIT OPTIMIZATIONS --- */
@media screen and (orientation: portrait) and (max-width: 600px) {
    .team-wing { width: 90px; padding: 0 5px; }
    .score-box { font-size: 24px; margin: 0 5px; }
    .team-name { font-size: 10px; }
    .team-sub { display: none; }
    
    .timer-crystal-ring { width: 80px; height: 40px; top: -15px; }
    #timer-display { font-size: 28px; }
    
    #minimap-container { width: 90px; height: 90px; }
    #minimap { width: 80px; height: 80px; }
    .radar-label { font-size: 10px; }
    
    .tech-text { font-size: 24px; }
    
    #action-button { width: 80px; height: 80px; }
    .command-ring { width: 100px; height: 100px; }
    #action-label { font-size: 10px; padding: 2px 8px; }
    
    #player-status-panel { width: 130px; bottom: max(140px, env(safe-area-inset-bottom) + 20px); }
    .char-name { font-size: 14px; }
    
    #auto-toggle, #settings-button, #practice-restore-btn {
        width: 90px;
        font-size: 9px;
        right: max(10px, env(safe-area-inset-right));
    }
    
    #goal-distance-container { left: max(10px, env(safe-area-inset-left)); }
#goal-distance { font-size: 18px; }
}

/* --- GESTURE HINT --- */
#gesture-hint {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 200px; height: 300px;
    pointer-events: none;
    display: none;
    z-index: 2500;
    opacity: 0.9;
}

#gesture-hint.active {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.curve-arrow {
    filter: drop-shadow(0 0 5px #00ffff);
    animation: dashDraw 1.5s linear infinite;
}

@keyframes dashDraw {
    to { stroke-dashoffset: -30; }
}

.gesture-text {
    font-family: var(--font-data);
    font-size: 24px;
    color: #ffffff;
    text-shadow: 0 0 10px #00ffff;
    margin-top: -50px;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-align: center;
}

.gesture-hand {
    font-size: 48px;
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    animation: handSwipe 1.5s ease-in-out infinite;
    filter: drop-shadow(0 0 10px black);
}

@keyframes handSwipe {
    0% { transform: translate(-50%, 50px) rotate(0deg); opacity: 0; }
    20% { opacity: 1; }
    80% { transform: translate(20px, -100px) rotate(20deg); opacity: 1; }
    100% { transform: translate(0px, -120px) rotate(10deg); opacity: 0; }
}

/* --- SWIPE TRAIL (INTUITIVE FEEDBACK) --- */
.swipe-trail-dot {
    position: absolute;
    width: 12px;
    height: 12px;
    background: radial-gradient(circle, #00ffff 0%, rgba(0, 255, 255, 0) 70%);
    border-radius: 50%;
    pointer-events: none;
    z-index: 9000;
    animation: fadeTrail 0.5s linear forwards;
    mix-blend-mode: screen;
}

@keyframes fadeTrail {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(0.2); opacity: 0; }
}
@keyframes fadeTrail {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(0.2); opacity: 0; }
}

/* --- OFFSCREEN INDICATOR --- */
#offscreen-indicator {
    position: absolute;
    top: 0; left: 0;
    width: 40px; height: 40px;
    margin-left: -20px; margin-top: -20px;
    z-index: 1500;
    pointer-events: none;
    display: none;
    filter: drop-shadow(0 0 5px #000);
}

#offscreen-indicator .arrow {
    width: 0; height: 0;
    border-left: 15px solid transparent;
    border-right: 15px solid transparent;
    border-bottom: 25px solid #00ff00; /* Green for player */
    animation: pulseArrow 0.5s infinite alternate;
    transform-origin: center bottom;
}

@keyframes pulseArrow {
    from { transform: scale(1); filter: brightness(1); }
    to { transform: scale(1.2); filter: brightness(1.5); }
}</style>

    <!-- Three.js Core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- GLTFLoader -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/utils/SkeletonUtils.js"></script>
    <!-- Lil-GUI -->
    <script src="https://cdn.jsdelivr.net/npm/lil-gui@0.19.1/dist/lil-gui.umd.min.js"></script>
<script type="importmap">{"imports":{"style.css":"data:text/css;base64,OnJvb3QgewogICAgLS1mZngtYmx1ZS1kZWVwOiAjMDIwNDA4OwogICAgLS1mZngtYmx1ZS1kYXJrOiAjMGExNTI1OwogICAgLS1mZngtYmx1ZS1taWQ6ICMxNTJhNDU7CiAgICAtLWZmeC1ibHVlLWxpZ2h0OiAjMmE0ZDc1OwogICAgLS1mZngtY3lhbjogIzYwYzBkMDsKICAgIC0tZmZ4LWN5YW4tZ2xvdzogIzAwZmZmZjsKICAgIC0tZmZ4LWdvbGQ6ICNjOGIwNjA7CiAgICAtLWZmeC1nb2xkLWxpZ2h0OiAjZjBlMDkwOwogICAgLS1mZngtZ29sZC1kYXJrOiAjOGE3MDMwOwogICAgLS1mZngtZ2xhc3MtYmc6IHJnYmEoMTAsIDIwLCA0MCwgMC43NSk7CiAgICAtLWZmeC1nbGFzcy1ib3JkZXI6IHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIAogICAgLS1mb250LXRpdGxlOiAnR2FyYW1vbmQnLCAnVGltZXMgTmV3IFJvbWFuJywgc2VyaWY7CiAgICAtLWZvbnQtZGF0YTogJ0ltcGFjdCcsICdBcmlhbCBOYXJyb3cnLCBzYW5zLXNlcmlmOwogICAgLS1mb250LXVpOiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAtLWZvbnQtc3BpcmE6ICdTcGlyYScsICdJbXBhY3QnLCBzYW5zLXNlcmlmOwp9CgpAZm9udC1mYWNlIHsKICAgIGZvbnQtZmFtaWx5OiAnU3BpcmEnOwogICAgc3JjOiB1cmwoJ2h0dHBzOi8vZmlsZXMuY2F0Ym94Lm1vZS96eW43czMudHRmJykgZm9ybWF0KCd0cnVldHlwZScpOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgIGZvbnQtc3R5bGU6IG5vcm1hbDsKfQoKaHRtbCwgYm9keSB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB3aWR0aDogMTAwdnc7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBwb3NpdGlvbjogZml4ZWQ7IAogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHJpZ2h0OiAwOwogICAgYm90dG9tOiAwOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBjb2xvcjogd2hpdGU7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICBwYWRkaW5nLXRvcDogZW52KHNhZmUtYXJlYS1pbnNldC10b3ApOwogICAgcGFkZGluZy1ib3R0b206IGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKTsKICAgIHBhZGRpbmctbGVmdDogZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KTsKICAgIHBhZGRpbmctcmlnaHQ6IGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpOwp9CgoqIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7Cn0KCi8qIC0tLSBNQUlOIEdBTUUgQ09OVEFJTkVSIC0tLSAqLwojZ2FtZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgbWF4LXdpZHRoOiBub25lOwogICAgYmFja2dyb3VuZDogIzAwMDUxMDsKICAgIGJveC1zaGFkb3c6IG5vbmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgdHJhbnNpdGlvbjogZmlsdGVyIDAuMDVzOwogICAgei1pbmRleDogMTsKfQoKLyogLS0tIElNUEFDVCBGWCAtLS0gKi8KI2dhbWUtY29udGFpbmVyLmltcGFjdC1meCB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuMXMgZWFzZS1pbi1vdXQ7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDEuMikgYnJpZ2h0bmVzcygxLjEpOwp9CgojZ2FtZS1jb250YWluZXIuaW1wYWN0LWhlYXZ5IHsKICAgIGFuaW1hdGlvbjogaW1wYWN0U2hha2UgMC4ycyBlYXNlLWluLW91dDsKICAgIGZpbHRlcjogY29udHJhc3QoMS41KSBicmlnaHRuZXNzKDEuMykgc2VwaWEoMC40KSBodWUtcm90YXRlKC0xMGRlZyk7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3Qtc2hhdHRlciB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuNHMgZWFzZS1pbi1vdXQ7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDIuMCkgaW52ZXJ0KDAuMSkgc2F0dXJhdGUoMi4wKTsKfQoKQGtleWZyYW1lcyBpbXBhY3RTaGFrZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDAsIDApOyB9CiAgICAyNSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNXB4LCA1cHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSg1cHgsIC01cHgpOyB9CiAgICA3NSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNXB4LCAtNXB4KTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDAsIDApOyB9Cn0KCi8qIC0tLSBDQU5WQVMgJiBSRU5ERVIgLS0tICovCmNhbnZhcyB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsKICAgIGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGltYWdlLXJlbmRlcmluZzogcGl4ZWxhdGVkOyAKICAgIHotaW5kZXg6IDA7Cn0KCi8qIC0tLSBHSUYgT1ZFUkxBWSAtLS0gKi8KI3NjcmVlbi1vdmVybGF5LWdpZiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgb2JqZWN0LWZpdDogY292ZXI7CiAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKICAgIG9wYWNpdHk6IDEuMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogOTUwOwogICAgaW1hZ2UtcmVuZGVyaW5nOiBwaXhlbGF0ZWQ7Cn0KCiN1aS1sYXllciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgei1pbmRleDogMTAwMDsKfQoKLyogLS0tIENJTkVNQVRJQyBCQVJTIC0tLSAqLwojY2luZW1hdGljLWJhcnMgLmJhciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAwOwogICAgYmFja2dyb3VuZDogYmxhY2s7CiAgICB0cmFuc2l0aW9uOiBoZWlnaHQgMC41cyBlYXNlOwogICAgei1pbmRleDogODAwOwp9CiNjaW5lbWF0aWMtYmFycyAuYmFyLnRvcCB7IHRvcDogMDsgfQojY2luZW1hdGljLWJhcnMgLmJhci5ib3R0b20geyBib3R0b206IDA7IH0KCi8qIC0tLSBURUNIIEZMQVNIIE9WRVJMQVkgLS0tICovCiN0ZWNoLWZsYXNoLW92ZXJsYXkgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAyMCU7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEyMHB4OwogICAgZGlzcGxheTogbm9uZTsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwwLDAsMCkgMCUsIHJnYmEoMCwgMjAsIDYwLCAwLjkpIDIwJSwgcmdiYSgwLCAyMCwgNjAsIDAuOSkgODAlLCByZ2JhKDAsMCwwLDApIDEwMCUpOwogICAgei1pbmRleDogMjIwMDsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigycHgpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMTAwLCAyNTUsIDI1NSwgMC4zKTsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDEwMCwgMjU1LCAyNTUsIDAuMyk7CiAgICBhbmltYXRpb246IGZsYXNoRW50ZXIgMC4xNXMgZWFzZS1vdXQ7Cn0KCkBrZXlmcmFtZXMgZmxhc2hFbnRlciB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiBzY2FsZVkoMCk7IG9wYWNpdHk6IDA7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZVkoMSk7IG9wYWNpdHk6IDE7IH0KfQoKLnRlY2gtY29udGVudC13cmFwcGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goLTEwZGVnKTsKfQoKLnRlY2gtdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IGNsYW1wKDI4cHgsIDEwdncsIDQycHgpOwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZiwgMCAwIDIwcHggIzAwMDBmZjsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7CiAgICBtYXJnaW4tYm90dG9tOiAycHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBhbmltYXRpb246IGJsaW5rVGV4dCAwLjA4cyBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCi50ZWNoLXN1Yi10ZXh0IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjMDBmZmZmOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjUpOwp9CgoudGVjaC10aW1lci10cmFjayB7CiAgICB3aWR0aDogMjUwcHg7CiAgICBoZWlnaHQ6IDhweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC42KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggcmdiYSgwLDAsMCwwLjUpOwp9CgoudGVjaC10aW1lci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmZmZiwgIzAwZmZmZik7CiAgICB3aWR0aDogMTAwJTsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGxlZnQ7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwp9CgpAa2V5ZnJhbWVzIGJsaW5rVGV4dCB7CiAgICBmcm9tIHsgb3BhY2l0eTogMC44OyB0ZXh0LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOyB0cmFuc2Zvcm06IHNjYWxlKDEpOyB9CiAgICB0byB7IG9wYWNpdHk6IDEuMDsgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICNmZmZmZmYsIDAgMCAxMHB4ICMwMGZmZmY7IHRyYW5zZm9ybTogc2NhbGUoMS4wMik7IH0KfQoKLyogLS0tIEhVRCBUT1AgLS0tICovCiNodWQtdG9wIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsKICAgIGxlZnQ6IDA7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgYWxpZ24taXRlbXM6IGZsZXgtc3RhcnQ7CiAgICB3aWR0aDogMTAwJTsKICAgIHBhZGRpbmc6IDE1cHg7CiAgICBwYWRkaW5nLXRvcDogbWF4KDE1cHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSk7CiAgICBwYWRkaW5nLWxlZnQ6IG1heCgxNXB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQpKTsKICAgIHBhZGRpbmctcmlnaHQ6IG1heCgxNXB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgcmdiYSgwLCA1LCAxNSwgMC45KSAwJSwgcmdiYSgwLDAsMCwwKSAxMDAlKTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgoudGVhbS13aW5nIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgd2lkdGg6IDEzMHB4OwogICAgaGVpZ2h0OiA1MHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE2MGRlZywgdmFyKC0tZmZ4LWJsdWUtbWlkKSAwJSwgdmFyKC0tZmZ4LWJsdWUtZGVlcCkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3JkZXItdG9wOiAycHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpOwogICAgYm94LXNoYWRvdzogMCA1cHggMTVweCByZ2JhKDAsIDAsIDAsIDAuNSk7CiAgICBwYWRkaW5nOiAwIDEwcHg7Cn0KCi50ZWFtLXdpbmcuYXdheSB7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDE1ZGVnKTsKICAgIGZsZXgtZGlyZWN0aW9uOiByb3ctcmV2ZXJzZTsKICAgIGJvcmRlci10b3AtY29sb3I6ICNmZjY2NjY7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoLTE2MGRlZywgIzJhMTAxMCAwJSwgIzEwMDUwNSAxMDAlKTsKfQoKLnRlYW0tZGF0YSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZyk7Cn0KLnRlYW0td2luZy5hd2F5IC50ZWFtLWRhdGEgeyB0cmFuc2Zvcm06IHNrZXdYKC0xNWRlZyk7IHRleHQtYWxpZ246IHJpZ2h0OyB9CgoudGVhbS1uYW1lIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZC1saWdodCk7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIHRleHQtc2hhZG93OiAwIDJweCAycHggcmdiYSgwLDAsMCwwLjgpOwp9Ci50ZWFtLXN1YiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBvcGFjaXR5OiAwLjg7Cn0KLnRlYW0td2luZy5hd2F5IC50ZWFtLXN1YiB7IGNvbG9yOiAjZmZhYWFhOyB9Cgouc2NvcmUtYm94IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzOHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4IHZhcigtLWZmeC1jeWFuLWdsb3cpOwogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZyk7CiAgICBtYXJnaW46IDAgMTBweDsKfQoudGVhbS13aW5nLmF3YXkgLnNjb3JlLWJveCB7IHRyYW5zZm9ybTogc2tld1goLTE1ZGVnKTsgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICNmZjQ0NDQ7IH0KCi50aW1lci1jb21wbGV4IHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG1hcmdpbi10b3A6IC01cHg7Cn0KCi50aW1lci1jcnlzdGFsLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtMjVweDsKICAgIHdpZHRoOiAxMjBweDsKICAgIGhlaWdodDogNjBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlci10b3A6IDNweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3gtc2hhZG93OiAwIC01cHggMTVweCByZ2JhKDIwMCwgMTgwLCAxMDAsIDAuMyk7CiAgICB6LWluZGV4OiAtMTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChlbGxpcHNlIGF0IHRvcCwgcmdiYSgyMCwgNDAsIDgwLCAwLjgpLCB0cmFuc3BhcmVudCA3MCUpOwp9CgojaGFsZi1pbmRpY2F0b3IgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG1hcmdpbi1ib3R0b206IC0ycHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtZ29sZC1kYXJrKTsKfQoKI3RpbWVyLWRpc3BsYXkgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmIDAlLCAjZmZkNzAwIDUwJSwgI2I4ODYwYiAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygycHggMnB4IDBweCByZ2JhKDAsMCwwLDAuOCkpOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKLyogLS0tIFBMQVlFUiBTVEFUVVMgUEFORUwgLS0tICovCiNwbGF5ZXItc3RhdHVzLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyA0MHB4KTsKICAgIGxlZnQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQpKTsKICAgIHdpZHRoOiAxNjBweDsKICAgIHBhZGRpbmc6IDEwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMTAsIDMwLCAwLjgpIDAlLCByZ2JhKDAsMCwwLDApIDEwMCUpOwogICAgYm9yZGVyLWxlZnQ6IDNweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiAwIDEwcHggMTBweCAwOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7Cn0KCi5jaGFyLW5hbWUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAxOHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKICAgIHRyYW5zZm9ybTogc2tld1goMTBkZWcpOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwp9CgouaHAtZ2F1Z2UtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogNHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7Cn0KLmhwLWxhYmVsIHsgZm9udC1zaXplOiAxMHB4OyBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOyB3aWR0aDogMjBweDsgfQouaHAtYmFyLXRyYWNrIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGhlaWdodDogNnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIG1hcmdpbjogMCA1cHg7Cn0KLmhwLWJhci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgIzAwZmYwMCwgI2NjZmZjYyk7CiAgICBib3gtc2hhZG93OiAwIDAgNXB4ICMwMGZmMDA7Cn0KLmhwLXZhbHVlIHsgZm9udC1zaXplOiAxMHB4OyBjb2xvcjogI2ZmZjsgd2lkdGg6IDQ1cHg7IHRleHQtYWxpZ246IHJpZ2h0OyB9CgoudGVjaC1nYXVnZS1jb250YWluZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDEwZGVnKTsKfQoudGVjaC1sYWJlbCB7IGZvbnQtc2l6ZTogMTBweDsgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsgd2lkdGg6IDIwcHg7IH0KLnRlY2gtYmFyLXRyYWNrIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGhlaWdodDogNHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIG1hcmdpbjogMCA1cHg7Cn0KLnRlY2gtYmFyLWZpbGwgewogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjZmZhYTAwLCAjZmZmZmFhKTsKfQoKLyogLS0tIE1JTklNQVAgLS0tICovCiNtaW5pbWFwLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg4MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA2MHB4KTsKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgaGVpZ2h0OiAxMTBweDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7Cn0KCi5yYWRhci1yaW0gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHZhcigtLWZmeC1ibHVlLWxpZ2h0KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHZhcigtLWZmeC1ibHVlLW1pZCksIGluc2V0IDAgMCAyMHB4IHJnYmEoMCwwLDAsMC44KTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMCwgMjAsIDYwLCAwLjQpIDAlLCByZ2JhKDAsIDUsIDEwLCAwLjgpIDEwMCUpOwogICAgei1pbmRleDogNTsKfQoKI21pbmltYXAgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgd2lkdGg6IDEwMHB4OwogICAgaGVpZ2h0OiAxMDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHotaW5kZXg6IDY7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgoucmFkYXItbGFiZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAtMTVweDsKICAgIHdpZHRoOiAxNDAlOwogICAgbGVmdDogLTIwJTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4pOwp9CgoubWFwLWRvdCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB3aWR0aDogNnB4OyBoZWlnaHQ6IDZweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgYm94LXNoYWRvdzogMCAwIDRweCBjdXJyZW50Q29sb3I7Cn0KLm1hcC1kb3QuaG9tZSB7IGJhY2tncm91bmQ6IHZhcigtLWZmeC1jeWFuKTsgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsgfQoubWFwLWRvdC5hd2F5IHsgYmFja2dyb3VuZDogI2ZmNDQ0NDsgY29sb3I6ICNmZjQ0NDQ7IH0KLm1hcC1kb3QuYmFsbCB7IAogICAgYmFja2dyb3VuZDogI2ZmMDBjYzsKICAgIGNvbG9yOiAjZmYwMGNjOyAKICAgIHdpZHRoOiAxMnB4OyBoZWlnaHQ6IDEycHg7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjZmZmZmZmOwogICAgei1pbmRleDogMjA7CiAgICBhbmltYXRpb246IGJsaW5rQmFsbCAwLjNzIGluZmluaXRlIGFsdGVybmF0ZTsKICAgIGJveC1zaGFkb3c6IDAgMCA2cHggI2ZmMDBjYzsKfQoubWFwLWRvdC5uYXAgeyBiYWNrZ3JvdW5kOiAjMzMzOyBjb2xvcjogIzAwMDsgYm9yZGVyOiAxcHggc29saWQgIzU1NTsgfQoubWFwLWRvdC5hY3RpdmUtcGxheWVyIHsgCiAgICBiYWNrZ3JvdW5kOiAjMDBmZjAwICFpbXBvcnRhbnQ7IAogICAgY29sb3I6ICMwMGZmMDAgIWltcG9ydGFudDsgCiAgICBib3gtc2hhZG93OiAwIDAgOHB4ICMwMGZmMDA7CiAgICB6LWluZGV4OiAxNTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuMik7Cn0KLm1hcC1kb3QuYmFsbC1jYXJyaWVyIHsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4ICNmZmYsIDAgMCAzMHB4ICNmZmFhMDA7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjZmZmZmZmOwogICAgYmFja2dyb3VuZC1jb2xvcjogI2ZmYWEwMCAhaW1wb3J0YW50OwogICAgei1pbmRleDogMTAwOwogICAgd2lkdGg6IDEwcHg7IGhlaWdodDogMTBweDsKICAgIGFuaW1hdGlvbjogY2FycmllclB1bHNlIDAuOHMgaW5maW5pdGUgYWx0ZXJuYXRlOwp9CkBrZXlmcmFtZXMgY2FycmllclB1bHNlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjIpOyBib3gtc2hhZG93OiAwIDAgMTBweCAjZmZmOyBvcGFjaXR5OiAwLjg7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS44KTsgYm94LXNoYWRvdzogMCAwIDI1cHggI2ZmY2MwMDsgb3BhY2l0eTogMS4wOyB9Cn0KQGtleWZyYW1lcyBibGlua0JhbGwgeyBmcm9tIHsgb3BhY2l0eTogMTsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IH0gdG8geyBvcGFjaXR5OiAwLjU7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuMyk7IH0gfQoKLyogLS0tIEFOTk9VTkNFTUVOVFMgLS0tICovCiNhbm5vdW5jZW1lbnQgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA0MCU7IAogICAgbGVmdDogNSU7IAogICAgd2lkdGg6IDkwJTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiBjbGFtcCg0MHB4LCAxMnZ3LCA3MnB4KTsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICB3aGl0ZS1zcGFjZTogbm9ybWFsOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZiAwJSwgI2ZmZDcwMCA0MCUsICNiODg2MGIgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggcmdiYSgyNTUsIDEwMCwgMCwgMC41KSkgZHJvcC1zaGFkb3coM3B4IDNweCAwICMwMDApOwogICAgZGlzcGxheTogbm9uZTsKICAgIHotaW5kZXg6IDIwMDA7CiAgICBhbmltYXRpb246IGFubm91bmNlU2xpZGUgMC41cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKQGtleWZyYW1lcyBhbm5vdW5jZVNsaWRlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHNjYWxlKDApIHJvdGF0ZSgtNWRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZSgxKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDE7IH0KfQoKLyogLS0tIEpPWVNUSUNLIC0tLSAqLwojam95c3RpY2staGl0LXpvbmUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDUwJTsgaGVpZ2h0OiA1MCU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwKTsgCiAgICB0b3VjaC1hY3Rpb246IG5vbmU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKfQoKI2pveXN0aWNrLXZpc3VhbC1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDA7IGhlaWdodDogMDsKICAgIG92ZXJmbG93OiB2aXNpYmxlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMTEwMDsKfQoKI2pveXN0aWNrLWJhc2UgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDEyMHB4OyBoZWlnaHQ6IDEyMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgwLCA0MCwgODAsIDAuNCkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjEpIDYwJSwgdHJhbnNwYXJlbnQgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDEwMCwgMjIwLCAyNTUsIDAuMyk7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpLCBpbnNldCAwIDAgMzBweCByZ2JhKDAsIDUwLCAxMDAsIDAuMyk7CiAgICBhbmltYXRpb246IGJhc2VQdWxzZSAycyBpbmZpbml0ZSBhbHRlcm5hdGU7Cn0KCkBrZXlmcmFtZXMgYmFzZVB1bHNlIHsKICAgIGZyb20geyBib3gtc2hhZG93OiAwIDAgMTBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpOyBib3JkZXItY29sb3I6IHJnYmEoMTAwLCAyMjAsIDI1NSwgMC4yKTsgfQogICAgdG8geyBib3gtc2hhZG93OiAwIDAgMjVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjUpOyBib3JkZXItY29sb3I6IHJnYmEoMTAwLCAyNTUsIDI1NSwgMC42KTsgfQp9Cgojam95c3RpY2sta25vYiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogNTBweDsgaGVpZ2h0OiA1MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzMCUgMzAlLCAjZTBmZmZmIDAlLCAjMDBhYWZmIDQwJSwgIzAwNDQ4OCA4MCUsICMwMDExMjIgMTAwJSk7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjODhjY2ZmOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggIzAwZmZmZiwgaW5zZXQgMCAwIDEwcHggcmdiYSgyNTUsMjU1LDI1NSwwLjgpOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMDVzIGxpbmVhcjsKfQoKI2pveXN0aWNrLWtub2I6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICIiOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAyMCU7IGxlZnQ6IDIwJTsgd2lkdGg6IDIwJTsgaGVpZ2h0OiAyMCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAjZmZmZmZmIDAlLCB0cmFuc3BhcmVudCA3MCUpOwogICAgZmlsdGVyOiBibHVyKDJweCk7CiAgICBvcGFjaXR5OiAwLjg7Cn0KCi50b3VjaC1yaXBwbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgyMDAsIDI1NSwgMjU1LCAwLjgpIDAlLCByZ2JhKDAsIDI1NSwgMjU1LCAwLjQpIDQwJSwgdHJhbnNwYXJlbnQgNzAlKTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDApOwogICAgYW5pbWF0aW9uOiByaXBwbGVBbmltIDAuNnMgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDkwMDA7CiAgICBtaXgtYmxlbmQtbW9kZTogc2NyZWVuOwp9CgpAa2V5ZnJhbWVzIHJpcHBsZUFuaW0gewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgwKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDMuMCk7IG9wYWNpdHk6IDA7IH0KfQoKI2NhbWVyYS16b25lIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgcmlnaHQ6IDA7IHdpZHRoOiA1MCU7IGhlaWdodDogMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdG91Y2gtYWN0aW9uOiBub25lOwogICAgei1pbmRleDogNTA7Cn0KCi8qIC0tLSBBQ1RJT04gQlVUVE9OIC0tLSAqLwojYWN0aW9uLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCg0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOyAKICAgIHJpZ2h0OiBtYXgoNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB6LWluZGV4OiAxMDA7Cn0KCi5jb21tYW5kLW1lbnUtYmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDE4MHB4OyBoZWlnaHQ6IDgwcHg7CiAgICBib3R0b206IDE1cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHRyYW5zcGFyZW50IDAlLCByZ2JhKDAsIDEwLCAzMCwgMC44KSA1MCUsIHRyYW5zcGFyZW50IDEwMCUpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMCwgMjAwLCAyNTUsIDAuMyk7CiAgICB6LWluZGV4OiAtMTsKfQoKLmNvbW1hbmQtcmluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMTMwcHg7IGhlaWdodDogMTMwcHg7CiAgICBib3JkZXI6IDJweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7CiAgICBib3JkZXItdG9wOiAycHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC42KTsKICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCByZ2JhKDAsIDI1NSwgMjU1LCAwLjYpOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYW5pbWF0aW9uOiBzcGluUmV2ZXJzZSAxNXMgbGluZWFyIGluZmluaXRlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpOwp9CkBrZXlmcmFtZXMgc3BpblJldmVyc2UgeyBmcm9tIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgcm90YXRlKDM2MGRlZyk7IH0gdG8geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSByb3RhdGUoMGRlZyk7IH0gfQoKI2FjdGlvbi1sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCA1LCAxMCwgMC44KTsKICAgIHBhZGRpbmc6IDRweCAxMnB4OwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwogICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMCwwLDAsMC44KTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjNzOwp9CgojYWN0aW9uLWJ1dHRvbiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwcHg7IGhlaWdodDogMTAwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4xcywgZmlsdGVyIDAuM3M7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZmZmZmYgMCUsICMwMDg4ZmYgNDAlLCAjMDAyMjY2IDgwJSwgIzAwMCAxMDAlKTsKICAgIGJvcmRlcjogM3B4IHNvbGlkICM0NGFhZmY7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjgpLCBpbnNldCAwIDAgMjBweCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNCk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICB6LWluZGV4OiAxMDsKfQoKI3Bhc3MtYnV0dG9uIHsKICAgIGRpc3BsYXk6IG5vbmUgIWltcG9ydGFudDsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogLTIwcHg7IGxlZnQ6IC0zMHB4OwogICAgd2lkdGg6IDYwcHg7IGhlaWdodDogNjBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHotaW5kZXg6IDk7Cn0KCiNhY3Rpb24tYnV0dG9uOjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC00MHB4OyBsZWZ0OiAtNDBweDsgcmlnaHQ6IC00MHB4OyBib3R0b206IC00MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgei1pbmRleDogMTA7Cn0KCiNhY3Rpb24tYnV0dG9uOmFjdGl2ZSB7IHRyYW5zZm9ybTogc2NhbGUoMC45Mik7IH0KCiNhY3Rpb24tYnV0dG9uIC5idG4tdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDIycHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDJweCA0cHggcmdiYSgwLDAsMCwwLjgpLCAwIDAgMTBweCByZ2JhKDI1NSwyNTUsMjU1LDAuNSk7CiAgICB6LWluZGV4OiA1OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgojYWN0aW9uLWJ1dHRvbiAuYnRuLWdsYXJlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwJTsgbGVmdDogLTUwJTsgd2lkdGg6IDIwMCU7IGhlaWdodDogMjAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg0NWRlZywgdHJhbnNwYXJlbnQgNDAlLCByZ2JhKDI1NSwyNTUsMjU1LDAuNCkgNTAlLCB0cmFuc3BhcmVudCA2MCUpOwogICAgYW5pbWF0aW9uOiBnbGFyZVBhc3MgNXMgaW5maW5pdGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDY7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7Cn0KCi5saW1pdC1yaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTVweDsgbGVmdDogLTVweDsgcmlnaHQ6IC01cHg7IGJvdHRvbTogLTVweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHRyYW5zcGFyZW50OwogICAgYm94LXNoYWRvdzogMCAwIDAgdHJhbnNwYXJlbnQ7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC41czsKICAgIHotaW5kZXg6IDE7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKI2FjdGlvbi1idXR0b24uc2hvb3QtbW9kZSB7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZmZmYWEgMCUsICNmZmFhMDAgNDAlLCAjODgyMjAwIDgwJSwgIzIyMDAwMCAxMDAlKTsKICAgIGJvcmRlci1jb2xvcjogI2ZmY2MwMDsKICAgIGJveC1zaGFkb3c6IDAgMCAzMHB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuOCksIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCAyNTUsIDAsIDAuNSk7Cn0KCiNhY3Rpb24tYnV0dG9uLmxpbWl0LXJlYWR5IC5saW1pdC1yaW5nIHsKICAgIGJvcmRlci1jb2xvcjogI2ZmZGQ0NDsKICAgIGFuaW1hdGlvbjogbGltaXRQdWxzZSAwLjhzIGVhc2UtaW4tb3V0IGluZmluaXRlIGFsdGVybmF0ZTsKfQoKLnNob290LWxhYmVsIHsKICAgIGNvbG9yOiAjZmZkZDQ0ICFpbXBvcnRhbnQ7CiAgICBib3JkZXItY29sb3I6ICNmZmFhMDAgIWltcG9ydGFudDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmY0NDAwICFpbXBvcnRhbnQ7Cn0KCkBrZXlmcmFtZXMgbGltaXRQdWxzZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgYm94LXNoYWRvdzogMCAwIDEwcHggI2ZmYWEwMCwgaW5zZXQgMCAwIDVweCAjZmZhYTAwOyBvcGFjaXR5OiAwLjU7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMTUpOyBib3gtc2hhZG93OiAwIDAgMzBweCAjZmY0NDAwLCBpbnNldCAwIDAgMTVweCAjZmYwMDAwOyBvcGFjaXR5OiAxLjA7IH0KfQoKLyogLS0tIEFVVE8gVE9HR0xFIC0tLSAqLwojYXV0by10b2dnbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoMjAwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDYwcHgpOyAKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgcGFkZGluZzogMTBweCAwOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgwLCAyMCwgNDAsIDAuOCkgMCUsIHJnYmEoMCwgNSwgMTAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3JkZXItdG9wOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNHB4KTsKICAgIGJveC1zaGFkb3c6IDAgNXB4IDE1cHggcmdiYSgwLDAsMCwwLjMpOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIHotaW5kZXg6IDEwMDsKfQoKI2F1dG8tdG9nZ2xlOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjkpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggdmFyKC0tZmZ4LWN5YW4pOwogICAgY29sb3I6IHdoaXRlOwp9CgojYXV0by10b2dnbGUuYWN0aXZlIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMTAwLCAyMCwgMCwgMC44KSAwJSwgcmdiYSg0MCwgMCwgMCwgMC45KSAxMDAlKTsKICAgIGJvcmRlci1jb2xvcjogI2ZmNDQwMDsKICAgIGNvbG9yOiAjZmZhYTAwOwogICAgYW5pbWF0aW9uOiBwdWxzZVJlZCAycyBpbmZpbml0ZTsKfQpAa2V5ZnJhbWVzIHB1bHNlUmVkIHsgMCUgeyBib3gtc2hhZG93OiAwIDAgNXB4ICNmZjAwMDA7IH0gNTAlIHsgYm94LXNoYWRvdzogMCAwIDIwcHggI2ZmNDQwMDsgfSAxMDAlIHsgYm94LXNoYWRvdzogMCAwIDVweCAjZmYwMDAwOyB9IH0KCi8qIC0tLSBGTE9BVElORyBURVhUIC0tLSAqLwouZmxvYXRpbmctdGV4dC13cmFwcGVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogMjAwMDsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm07Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyIHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDI0cHg7IAogICAgdGV4dC1zaGFkb3c6IDFweCAxcHggMCAjMDAwOwogICAgb3BhY2l0eTogMC45Owp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5kYW1hZ2UgewogICAgZm9udC1zaXplOiA0MnB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZmZmZiAwJSwgI2ZmY2MwMCA0MCUsICNmZjQ0MDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCA0cHggNHB4IHJnYmEoMCwwLDAsMC44KSk7CiAgICBhbmltYXRpb246IHBvcERhbWFnZSAwLjhzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KSBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuaGVhbCB7CiAgICBmb250LXNpemU6IDM2cHg7CiAgICBjb2xvcjogIzQ0ZmY0NDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZjAwOwogICAgYW5pbWF0aW9uOiBmbG9hdFVwIDFzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci52ZW5vbSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGNvbG9yOiAjYWFmZjAwOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICM0NDg4MDAsIDJweCAycHggMCAjMDAyMjAwOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2NjZmY2NiAwJSwgIzY2Y2MwMCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgNXB4IHJnYmEoMTAwLCAyNTUsIDAsIDAuNSkpOwogICAgYW5pbWF0aW9uOiBkcmlwU3RhdHVzIDJzIGluZmluaXRlOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5zbGVlcCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTVweCAjMDA0NGZmLCAwIDAgMzBweCAjMDAwMGZmOwogICAgb3BhY2l0eTogMC45OwogICAgYW5pbWF0aW9uOiBkcmlmdFN0YXR1cyAzcyBlYXNlLWluLW91dCBpbmZpbml0ZTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIud2l0aGVyIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzOHB4OwogICAgY29sb3I6ICNjY2NjY2M7CiAgICB0ZXh0LXNoYWRvdzogMnB4IDJweCAwICM0NDQ0NDQ7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZWVlZWVlIDAlLCAjODg4ODg4IDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHdpdGhlclN0YXR1cyAxLjVzIGZvcndhcmRzOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci50ZWNoIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMzJweDsKICAgIGNvbG9yOiAjMDBmZmZmOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAxMCwgMzAsIDAuNyk7CiAgICBwYWRkaW5nOiAycHggMTBweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkICMwMGZmZmY7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjMDA4OGZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggI2ZmZjsKICAgIGFuaW1hdGlvbjogc2hha2VUZWNoIDAuNnMgZWFzZS1pbi1vdXQsIGZsYXNoVGVjaCAwLjNzOwogICAgdHJhbnNmb3JtLW9yaWdpbjogY2VudGVyOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5zYXZlLCAuZmxvYXRpbmctdGV4dC1pbm5lci5ibG9jayB7CiAgICBmb250LXNpemU6IDQ4cHg7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgY29sb3I6ICNmZmZmZmY7CiAgICAtd2Via2l0LXRleHQtc3Ryb2tlOiAxcHggIzAwNDQ4ODsKICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCAjMDA4OGZmOwogICAgYW5pbWF0aW9uOiBwb3BEYW1hZ2UgMC41cyBlYXNlLW91dCBmb3J3YXJkczsKfQoKQGtleWZyYW1lcyBwb3BEYW1hZ2UgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuNSk7IG9wYWNpdHk6IDA7IH0KICAgIDIwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS41KTsgb3BhY2l0eTogMTsgfQogICAgNDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgZmxvYXRVcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNTBweCk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyBkcmlwU3RhdHVzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZVkoMSk7IGZpbHRlcjogYmx1cigwcHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlWSgxLjEpIHRyYW5zbGF0ZVkoNXB4KTsgZmlsdGVyOiBibHVyKDFweCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlWSgxKTsgZmlsdGVyOiBibHVyKDBweCk7IH0KfQoKQGtleWZyYW1lcyBkcmlmdFN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIDIwJSB7IG9wYWNpdHk6IDE7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxNXB4KSB0cmFuc2xhdGVZKC0yMHB4KSByb3RhdGUoMTBkZWcpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0xNXB4KSB0cmFuc2xhdGVZKC01MHB4KSByb3RhdGUoLTEwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIHdpdGhlclN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IGZpbHRlcjogZ3JheXNjYWxlKDAlKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC42KTsgZmlsdGVyOiBncmF5c2NhbGUoMTAwJSk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyBzaGFrZVRlY2ggewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuOCk7IH0KICAgIDEwJSwgMzAlLCA1MCUsIDcwJSwgOTAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjEpIHRyYW5zbGF0ZSgtMnB4LCAycHgpOyB9CiAgICAyMCUsIDQwJSwgNjAlLCA4MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSkgdHJhbnNsYXRlKDJweCwgLTJweCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IH0KfQoKQGtleWZyYW1lcyBmbGFzaFRlY2ggewogICAgMCUgeyBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZmOyBjb2xvcjogIzAwMDsgYm9yZGVyLWNvbG9yOiAjZmZmOyB9CiAgICAxMDAlIHsgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgwLCAxMCwgMzAsIDAuODUpOyBjb2xvcjogIzAwZmZmZjsgYm9yZGVyLWNvbG9yOiAjMDBmZmZmOyB9Cn0KCiNsb2FkaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgIGFuaW1hdGlvbjogYmxpbmsgMXMgaW5maW5pdGU7Cn0KQGtleWZyYW1lcyBibGluayB7IDUwJSB7IG9wYWNpdHk6IDAuNTsgfSB9CgojY29udHJvbHMtaGludCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDEzMHB4OyB3aWR0aDogMTAwJTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiByZ2JhKDI1NSwyNTUsMjU1LDAuNCk7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmNvbWljLWltcGFjdCB7CiAgICBmb250LWZhbWlseTogJ0ltcGFjdCcsIHNhbnMtc2VyaWY7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBjb2xvcjogI2ZmZmYwMDsgCiAgICAtd2Via2l0LXRleHQtc3Ryb2tlOiAxcHggIzAwMDsKICAgIHRleHQtc2hhZG93OiAzcHggM3B4IDAgI2ZmMDAwMDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGNlbnRlcjsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICBhbmltYXRpb246IGNvbWljUG9wIDAuNHMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpIGZvcndhcmRzOwogICAgei1pbmRleDogMjUwMDsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuY29taWMtYWN0aW9uIHsKICAgIGZvbnQtZmFtaWx5OiAnQXJpYWwgQmxhY2snLCBzYW5zLXNlcmlmOwogICAgZm9udC1zaXplOiAyOHB4OwogICAgY29sb3I6ICMwMGZmZmY7IAogICAgLXdlYmtpdC10ZXh0LXN0cm9rZTogMXB4ICMwMDA7CiAgICB0ZXh0LXNoYWRvdzogMnB4IDJweCAwICMwMDQ0YWE7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgYW5pbWF0aW9uOiBjb21pY1NsaWRlIDAuNHMgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICB6LWluZGV4OiAyNTAwOwp9CgpAa2V5ZnJhbWVzIGNvbWljUG9wIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwKSByb3RhdGUoLTIwZGVnKTsgb3BhY2l0eTogMDsgfQogICAgNDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjIpIHJvdGF0ZSg1ZGVnKTsgb3BhY2l0eTogMTsgfQogICAgNjAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApIHJvdGF0ZSgtNWRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSkgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgY29taWNTbGlkZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC0yMHB4LCAyMHB4KSBzY2FsZSgwLjUpOyBvcGFjaXR5OiAwOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMjBweCwgLTIwcHgpIHNjYWxlKDEuMik7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIE1BSU4gTUVOVSAtLS0gKi8KI21haW4tbWVudSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDMwMDA7CiAgICBvcGFjaXR5OiAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuNXMgZWFzZS1pbi1vdXQ7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IGNlbnRlciwgcmdiYSgwLCAyMCwgNjAsIDAuMikgMCUsIHJnYmEoMCwgNSwgMTAsIDAuNSkgMTAwJSk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMnB4KTsKfQoKI21haW4tbWVudS5hY3RpdmUgewogICAgb3BhY2l0eTogMTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgoubWVudS1iZy1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IAogICAgICAgIGxpbmVhci1ncmFkaWVudChyZ2JhKDAsMCwwLDApIDUwJSwgcmdiYSgwLDAsMCwwLjEpIDUwJSksIAogICAgICAgIGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgyNTUsMCwwLDAuMDMpLCByZ2JhKDAsMjU1LDAsMC4wMSksIHJnYmEoMCwwLDI1NSwwLjAzKSk7CiAgICBiYWNrZ3JvdW5kLXNpemU6IDEwMCUgMnB4LCAzcHggMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogLTE7Cn0KCi5mZngtbG9nby1jb250YWluZXIgewogICAgbWFyZ2luLWJvdHRvbTogNjBweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goLTEwZGVnKTsKfQoKLmZmeC1sb2dvLW1haW4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiA2NHB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZiwgMCAwIDIwcHggIzAwODhmZiwgMCAwIDQwcHggIzAwMDBmZjsKICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmZmZmIDAlLCAjYWFjY2ZmIDUwJSwgIzAwODhmZiAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDVweCA1cHggcmdiYSgwLDAsMCwwLjgpKTsKfQoKLmZmeC1sb2dvLXN1YiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDE4cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDEycHg7CiAgICBtYXJnaW4tdG9wOiAtNXB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggI2ZmYWEwMDsKfQoKLm1lbnUtb3B0aW9ucyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogMTVweDsKICAgIHdpZHRoOiAzMDBweDsKfQoKLm1lbnUtaXRlbSB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBwYWRkaW5nOiAxNXB4IDMwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgNDAsIDgwLCAwLjYpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC4wKSAxMDAlKTsKICAgIGJvcmRlci1sZWZ0OiA0cHggc29saWQgcmdiYSgxMDAsIDIwMCwgMjU1LCAwLjMpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4xKTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7Cn0KCi5tZW51LWl0ZW06aG92ZXIgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDgwLCAxNjAsIDAuOCkgMCUsIHJnYmEoMCwgMjAsIDQwLCAwLjApIDEwMCUpOwogICAgYm9yZGVyLWxlZnQtY29sb3I6ICMwMGZmZmY7CiAgICBwYWRkaW5nLWxlZnQ6IDQwcHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjIpOwp9CgoubWVudS1pdGVtIC5sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogI2NjY2NjYzsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7CiAgICB0cmFuc2l0aW9uOiBjb2xvciAwLjJzOwp9CgoubWVudS1pdGVtOmhvdmVyIC5sYWJlbCB7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwp9CgoubWVudS1pdGVtIC5jdXJzb3IgewogICAgZm9udC1zaXplOiAxOHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIG1hcmdpbi1yaWdodDogMTVweDsKICAgIG9wYWNpdHk6IDA7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTEwcHgpIHNrZXdYKDEwZGVnKTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwp9CgoubWVudS1pdGVtOmhvdmVyIC5jdXJzb3IgewogICAgb3BhY2l0eTogMTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKSBza2V3WCgxMGRlZyk7Cn0KCi5tZW51LWZvb3RlciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDIwcHg7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogcmdiYSgyNTUsMjU1LDI1NSwwLjMpOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKfQoKLyogLS0tIFBSQUNUSUNFIE9WRVJMQVkgLS0tICovCiNwcmFjdGljZS1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNSwgMTAsIDAuNik7CiAgICBkaXNwbGF5OiBub25lOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgei1pbmRleDogMjUwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgojcHJhY3RpY2Utb3ZlcmxheS5hY3RpdmUgewogICAgZGlzcGxheTogZmxleDsKfQoKLnByYWN0aWNlLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDYwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDQwcHgpOyAKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDI4MHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE2MGRlZywgcmdiYSgwLCAyMCwgNTAsIDAuOTUpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC45OCkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ4OGZmOwogICAgYm9yZGVyLXJhZGl1czogMCAwIDE1cHggMDsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMiksIGluc2V0IDAgMCA1MHB4IHJnYmEoMCwgMjAsIDYwLCAwLjUpOwogICAgcGFkZGluZzogMTVweDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMmRlZyk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNXB4KTsKfQoKLnBhbmVsLWhlYWRlciB7CiAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgoucGFuZWwtdGl0bGUtZ3JvdXAgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47Cn0KCi5wYW5lbC10aXRsZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IGNsYW1wKDE4cHgsIDZ2dywgMjRweCk7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKfQoKLnBhbmVsLXN1YnRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogOHB4OwogICAgY29sb3I6ICM0NDg4ZmY7CiAgICBsZXR0ZXItc3BhY2luZzogNHB4OwogICAgbWFyZ2luLXRvcDogLTJweDsKfQoKLnBhbmVsLWRlY28tbGluZSB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMnB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgIzAwZmZmZiwgdHJhbnNwYXJlbnQpOwogICAgbWFyZ2luLXRvcDogNXB4OwogICAgYm94LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOwp9CgoucGFuZWwtY29udGVudCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogMTVweDsKfQoKLnNlY3Rpb24tbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDIwMCwgMTc2LCA5NiwgMC4zKTsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKICAgIHBhZGRpbmctYm90dG9tOiAycHg7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgouZHJpbGwtbGlzdCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogNXB4Owp9CgouZHJpbGwtYnRuIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcGFkZGluZzogOHB4IDEycHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4wNSksIHRyYW5zcGFyZW50KTsKICAgIGJvcmRlci1sZWZ0OiAycHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjYWFhOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7Cn0KCi5kcmlsbC1idG46aG92ZXIgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDI1NSwgMjU1LCAwLjEpLCB0cmFuc3BhcmVudCk7CiAgICBjb2xvcjogI2ZmZjsKICAgIHBhZGRpbmctbGVmdDogMTVweDsKfQoKLmRyaWxsLWJ0bi5hY3RpdmUgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDEwMCwgMjU1LCAwLjQpLCB0cmFuc3BhcmVudCk7CiAgICBib3JkZXItbGVmdDogM3B4IHNvbGlkICMwMGZmZmY7CiAgICBjb2xvcjogI2ZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMGZmZmY7Cn0KCi5kcmlsbC1idG4gLmljb24gewogICAgd2lkdGg6IDIwcHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBtYXJnaW4tcmlnaHQ6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwp9Cgoub3B0aW9uLWxpc3QgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBnYXA6IDVweDsKfQoKLm9wdGlvbi10b2dnbGUgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwYWRkaW5nOiA1cHggMTBweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiAjY2NjOwogICAgdHJhbnNpdGlvbjogY29sb3IgMC4yczsKfQoKLm9wdGlvbi10b2dnbGU6aG92ZXIgeyBjb2xvcjogI2ZmZjsgfQoKLm9wdGlvbi10b2dnbGUgLmNoZWNrYm94IHsKICAgIG1hcmdpbi1yaWdodDogMTBweDsKICAgIGNvbG9yOiAjNDQ0OwogICAgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsKICAgIGZvbnQtc2l6ZTogMTRweDsKfQoKLm9wdGlvbi10b2dnbGUuYWN0aXZlIC5jaGVja2JveCB7CiAgICBjb2xvcjogIzAwZmYwMDsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMGZmMDA7Cn0KCi5vcHRpb24tdG9nZ2xlLmFjdGl2ZSB7CiAgICBjb2xvcjogI2ZmZjsKfQoKLmFjdGlvbi1idG4gewogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIHBhZGRpbmc6IDZweDsKICAgIGZvbnQtc2l6ZTogMTFweDsKICAgIGNvbG9yOiAjYWFhOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICBtYXJnaW4tYm90dG9tOiA1cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKLmFjdGlvbi1idG46aG92ZXIgewogICAgYm9yZGVyLWNvbG9yOiAjZmZmOwogICAgY29sb3I6ICNmZmY7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7Cn0KCiNwLWV4aXQ6aG92ZXIgewogICAgYm9yZGVyLWNvbG9yOiAjZmY0NDQ0OwogICAgY29sb3I6ICNmZjQ0NDQ7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDUwLCAwLCAwLCAwLjMpOwp9CgoucGFuZWwtZm9vdGVyIHsKICAgIG1hcmdpbi10b3A6IDE1cHg7CiAgICBwYWRkaW5nLXRvcDogMTBweDsKICAgIGJvcmRlci10b3A6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCiNkcmlsbC1pbnN0cnVjdGlvbiB7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgbWFyZ2luLWJvdHRvbTogNXB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwp9CgojZHJpbGwtc2NvcmUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMjU1LCAyMTUsIDAsIDAuNSk7Cn0KCi5wYW5lbC1taW5pbWl6ZS1idG4gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMHB4OyByaWdodDogMTBweDsKICAgIHdpZHRoOiAyMHB4OyBoZWlnaHQ6IDIwcHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbGluZS1oZWlnaHQ6IDE4cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDAuNSk7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoucGFuZWwtbWluaW1pemUtYnRuOmhvdmVyIHsgCiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtY3lhbik7IAogICAgY29sb3I6ICMwMDA7IAogICAgYm94LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7Cn0KCiNwcmFjdGljZS1yZXN0b3JlLWJ0biB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA0MHB4KTsgCiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHBhZGRpbmc6IDhweCAxNXB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDIwLCA1MCwgMC45KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItbGVmdDogM3B4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB6LWluZGV4OiAyNDAwOwogICAgZGlzcGxheTogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC4yKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KI3ByYWN0aWNlLXJlc3RvcmUtYnRuOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjkpOwogICAgY29sb3I6ICNmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLyogLS0tIEFJTSBKT1lTVElDSyAtLS0gKi8KI2FpbS1qb3lzdGljay16b25lIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE1MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOwogICAgcmlnaHQ6IDA7CiAgICB3aWR0aDogNDAlOwogICAgaGVpZ2h0OiAzNSU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwKTsKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgojYWltLWpveXN0aWNrLXZpc3VhbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMDsgaGVpZ2h0OiAwOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAxMTAwOwp9CgojYWltLWpveXN0aWNrLWJhc2UgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDkwcHg7IGhlaWdodDogOTBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMjU1LCAxMDAsIDAsIDAuMykgMCUsIHJnYmEoODAsIDIwLCAwLCAwLjEpIDYwJSwgdHJhbnNwYXJlbnQgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMTUwLCA1MCwgMC40KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuMiksIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCA1MCwgMCwgMC4yKTsKfQoKI2FpbS1qb3lzdGljay1rbm9iIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiA0MHB4OyBoZWlnaHQ6IDQwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsICNmZmNjODggMCUsICNmZjY2MDAgNDAlLCAjODgyMjAwIDgwJSwgIzIyMDAwMCAxMDAlKTsKICAgIGJvcmRlcjogMnB4IHNvbGlkICNmZmFhNDQ7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjZmY0NDAwLCBpbnNldCAwIDAgOHB4IHJnYmEoMjU1LDI1NSwyNTUsMC42KTsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjA1cyBsaW5lYXI7Cn0KCiNhaW0tam95c3RpY2sta25vYjo6YWZ0ZXIgewogICAgY29udGVudDogIkFJTSI7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBmb250LXNpemU6IDhweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgdGV4dC1zaGFkb3c6IDAgMCAzcHggIzAwMDsKfQoKLyogLS0tIFRBQ0tMRSBCVVRUT04gLS0tICovCiN0YWNrbGUtYnV0dG9uIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyAxMDBweCk7CiAgICByaWdodDogbWF4KDQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiA3MHB4OwogICAgaGVpZ2h0OiA3MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZGlzcGxheTogbm9uZTsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgei1pbmRleDogMTAwOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmY4ODg4IDAlLCAjY2MwMDAwIDQwJSwgIzY2MDAwMCA4MCUsICMyMjAwMDAgMTAwJSk7CiAgICBib3JkZXI6IDNweCBzb2xpZCAjZmY0NDQ0OwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgyNTUsIDUwLCA1MCwgMC42KSwgaW5zZXQgMCAwIDE1cHggcmdiYSgyNTUsIDIwMCwgMjAwLCAwLjMpOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMXMsIGZpbHRlciAwLjJzOwp9CgojdGFja2xlLWJ1dHRvbjphY3RpdmUgewogICAgdHJhbnNmb3JtOiBzY2FsZSgwLjkpOwogICAgZmlsdGVyOiBicmlnaHRuZXNzKDEuMik7Cn0KCiN0YWNrbGUtYnV0dG9uLmFjdGl2ZSB7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZmZmZmYgMCUsICNmZjQ0NDQgNDAlLCAjYWEwMDAwIDgwJSwgIzQ0MDAwMCAxMDAlKTsKICAgIGJveC1zaGFkb3c6IDAgMCAyNXB4IHJnYmEoMjU1LCAxMDAsIDEwMCwgMC45KTsKfQoKI3RhY2tsZS1idXR0b24gLmJ0bi10ZXh0IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAxcHggMnB4IHJnYmEoMCwwLDAsMC44KTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7Cn0KCiN0YWNrbGUtYnV0dG9uIC5idG4tZ2xhcmUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtNTAlOyBsZWZ0OiAtNTAlOwogICAgd2lkdGg6IDIwMCU7IGhlaWdodDogMjAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg0NWRlZywgdHJhbnNwYXJlbnQgNDAlLCByZ2JhKDI1NSwyNTUsMjU1LDAuMykgNTAlLCB0cmFuc3BhcmVudCA2MCUpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBhbmltYXRpb246IGdsYXJlUGFzcyA0cyBpbmZpbml0ZTsKfQoKI3RhY2tsZS1idXR0b24udXJnZW50IHsKICAgIGFuaW1hdGlvbjogdXJnZW50UHVsc2UgMC41cyBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZjU1NTUgMCUsICNmZjAwMDAgNDAlLCAjODgwMDAwIDEwMCUpOwogICAgYm9yZGVyLWNvbG9yOiAjZmZhYWFhOwogICAgYm94LXNoYWRvdzogMCAwIDIwcHggI2ZmMDAwMDsKfQoKQGtleWZyYW1lcyB1cmdlbnRQdWxzZSB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyB9CiAgICB0byB7IHRyYW5zZm9ybTogc2NhbGUoMS4xNSk7IH0KfQoKLyogLS0tIENIQVJHRSBQT1dFUiBNRVRFUiAtLS0gKi8KI2NoYXJnZS1tZXRlci1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiBtYXgoMjUwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSArIDEwMHB4KTsKICAgIGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKTsKICAgIHdpZHRoOiAyMDBweDsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogMjAwMDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMTAsIDMwLCAwLjgpOwogICAgcGFkZGluZzogMTBweCAxNXB4OwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogNXB4OwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLCAxMDAsIDI1NSwgMC4zKTsKfQoKLmNoYXJnZS1sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBtYXJnaW4tYm90dG9tOiA1cHg7Cn0KCi5jaGFyZ2UtbWV0ZXItdHJhY2sgewogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEycHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuNik7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ0OwogICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKI2NoYXJnZS1tZXRlci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIHdpZHRoOiAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgIzBhZiwgIzBmMCk7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjMGYwOwogICAgdHJhbnNpdGlvbjogd2lkdGggMC4wNXMgbGluZWFyLCBiYWNrZ3JvdW5kIDAuMXM7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7Cn0KCi5jaGFyZ2UtaGludCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbWFyZ2luLXRvcDogNXB4OwogICAgb3BhY2l0eTogMC44OwogICAgYW5pbWF0aW9uOiBibGluayAwLjVzIGluZmluaXRlOwp9CgovKiAtLS0gR09BTCBESVNUQU5DRSBJTkRJQ0FUT1IgLS0tICovCiNnb2FsLWRpc3RhbmNlLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg3NXB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA1NXB4KTsKICAgIGxlZnQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQpKTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogMTAwOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDEwLCAzMCwgMC43KSAwJSwgdHJhbnNwYXJlbnQgMTAwJSk7CiAgICBwYWRkaW5nOiA1cHggMTVweCA1cHggMTBweDsKICAgIGJvcmRlci1sZWZ0OiAycHggc29saWQgdmFyKC0tZmZ4LWdvbGQpOwp9CgouZGlzdGFuY2UtbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiA4cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KCiNnb2FsLWRpc3RhbmNlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWdvbGQpOwp9CgovKiAtLS0gU0VUVElOR1MgQlVUVE9OIC0tLSAqLwojc2V0dGluZ3MtYnV0dG9uIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDI0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyAxMDBweCk7CiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiAxMTBweDsKICAgIHBhZGRpbmc6IDhweCAwOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICBjb2xvcjogIzg4ODsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMjAsIDIwLCAyMCwgMC44KSAwJSwgcmdiYSgxMCwgMTAsIDEwLCAwLjkpIDEwMCUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIHotaW5kZXg6IDEwMDsKfQoKI3NldHRpbmdzLWJ1dHRvbjpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDQwLCA0MCwgNDAsIDAuOSk7CiAgICBib3JkZXItY29sb3I6ICM4ODg7CiAgICBjb2xvcjogI2ZmZjsKfQoKLyogLS0tIFNFVFRJTkdTIFBBTkVMIC0tLSAqLwojc2V0dGluZ3MtcGFuZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7CiAgICBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiAyODBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHJnYmEoMCwgMjAsIDUwLCAwLjk4KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOTkpIDEwMCUpOwogICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgIGJveC1zaGFkb3c6IDAgMCAzMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuNCk7CiAgICB6LWluZGV4OiAzNTAwOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTBweCk7Cn0KCi5zZXR0aW5ncy1oZWFkZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwYWRkaW5nOiAxNXB4OwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMzAsIDYwLCAwLjUpOwp9Cgouc2V0dGluZ3MtaGVhZGVyIHNwYW4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAyMHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4pOwogICAgbGV0dGVyLXNwYWNpbmc6IDNweDsKfQoKI3NldHRpbmdzLWNsb3NlIHsKICAgIHdpZHRoOiAzMHB4OwogICAgaGVpZ2h0OiAzMHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgI2ZmNDQ0NDsKICAgIGJhY2tncm91bmQ6IHJnYmEoNTAsIDAsIDAsIDAuNSk7CiAgICBjb2xvcjogI2ZmNDQ0NDsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwp9Cgojc2V0dGluZ3MtY2xvc2U6aG92ZXIgewogICAgYmFja2dyb3VuZDogI2ZmNDQ0NDsKICAgIGNvbG9yOiB3aGl0ZTsKfQoKLnNldHRpbmdzLWNvbnRlbnQgewogICAgcGFkZGluZzogMjBweDsKfQoKLnNldHRpbmctcm93IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogMTVweDsKICAgIHBhZGRpbmc6IDEwcHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuMyk7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7Cn0KCi5zZXR0aW5nLXJvdyBsYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjY2NjOwp9Cgouc2V0dGluZy1yb3cgaW5wdXRbdHlwZT0icmFuZ2UiXSB7CiAgICB3aWR0aDogMTAwcHg7CiAgICBhY2NlbnQtY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKfQoKLnNldHRpbmctcm93IGlucHV0W3R5cGU9ImNoZWNrYm94Il0gewogICAgd2lkdGg6IDIwcHg7CiAgICBoZWlnaHQ6IDIwcHg7CiAgICBhY2NlbnQtY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGN1cnNvcjogcG9pbnRlcjsKfQoKLyogLS0tIEdMQVJFIEFOSU1BVElPTiAtLS0gKi8KQGtleWZyYW1lcyBnbGFyZVBhc3MgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTEwMCUpIHJvdGF0ZSg0NWRlZyk7IH0KICAgIDMwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxMDAlKSByb3RhdGUoNDVkZWcpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDEwMCUpIHJvdGF0ZSg0NWRlZyk7IH0KfQoKLyogLS0tIFNUQVRVUyBUWVBFIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LWlubmVyLnN0YXR1cyB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjhweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGNvbG9yOiAjZmYwMGZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICNmZjAwZmYsIDJweCAycHggMCAjMDAwOwogICAgYW5pbWF0aW9uOiBzdGF0dXNQb3AgMS4ycyBlYXNlLW91dCBmb3J3YXJkczsKfQoKQGtleWZyYW1lcyBzdGF0dXNQb3AgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuNSkgdHJhbnNsYXRlWSgwKTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjMpIHRyYW5zbGF0ZVkoLTEwcHgpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApIHRyYW5zbGF0ZVkoLTQwcHgpOyBvcGFjaXR5OiAwOyB9Cn0KCi8qIC0tLSBHT0FMIFRZUEUgRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtaW5uZXIuZ29hbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogNDhweDsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmIDAlLCAjZmZkNzAwIDUwJSwgI2ZmODgwMCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDRweCA0cHggcmdiYSgwLDAsMCwwLjkpKTsKICAgIGFuaW1hdGlvbjogZ29hbFBvcCAxcyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSkgZm9yd2FyZHM7Cn0KCkBrZXlmcmFtZXMgZ29hbFBvcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMCkgcm90YXRlKC0xMGRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS41KSByb3RhdGUoNWRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMikgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9Cn0KCi8qIC0tLSBERUZBVUxUIFRZUEUgRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtaW5uZXIuZGVmYXVsdCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDJweCA0cHggcmdiYSgwLDAsMCwwLjgpOwogICAgYW5pbWF0aW9uOiBmbG9hdFVwIDAuOHMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCi8qIC0tLSBNT0JJTEUgUE9SVFJBSVQgT1BUSU1JWkFUSU9OUyAtLS0gKi8KQG1lZGlhIHNjcmVlbiBhbmQgKG9yaWVudGF0aW9uOiBwb3J0cmFpdCkgYW5kIChtYXgtd2lkdGg6IDYwMHB4KSB7CiAgICAudGVhbS13aW5nIHsgd2lkdGg6IDkwcHg7IHBhZGRpbmc6IDAgNXB4OyB9CiAgICAuc2NvcmUtYm94IHsgZm9udC1zaXplOiAyNHB4OyBtYXJnaW46IDAgNXB4OyB9CiAgICAudGVhbS1uYW1lIHsgZm9udC1zaXplOiAxMHB4OyB9CiAgICAudGVhbS1zdWIgeyBkaXNwbGF5OiBub25lOyB9CiAgICAKICAgIC50aW1lci1jcnlzdGFsLXJpbmcgeyB3aWR0aDogODBweDsgaGVpZ2h0OiA0MHB4OyB0b3A6IC0xNXB4OyB9CiAgICAjdGltZXItZGlzcGxheSB7IGZvbnQtc2l6ZTogMjhweDsgfQogICAgCiAgICAjbWluaW1hcC1jb250YWluZXIgeyB3aWR0aDogOTBweDsgaGVpZ2h0OiA5MHB4OyB9CiAgICAjbWluaW1hcCB7IHdpZHRoOiA4MHB4OyBoZWlnaHQ6IDgwcHg7IH0KICAgIC5yYWRhci1sYWJlbCB7IGZvbnQtc2l6ZTogMTBweDsgfQogICAgCiAgICAudGVjaC10ZXh0IHsgZm9udC1zaXplOiAyNHB4OyB9CiAgICAKICAgICNhY3Rpb24tYnV0dG9uIHsgd2lkdGg6IDgwcHg7IGhlaWdodDogODBweDsgfQogICAgLmNvbW1hbmQtcmluZyB7IHdpZHRoOiAxMDBweDsgaGVpZ2h0OiAxMDBweDsgfQogICAgI2FjdGlvbi1sYWJlbCB7IGZvbnQtc2l6ZTogMTBweDsgcGFkZGluZzogMnB4IDhweDsgfQogICAgCiAgICAjcGxheWVyLXN0YXR1cy1wYW5lbCB7IHdpZHRoOiAxMzBweDsgYm90dG9tOiBtYXgoMTQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSArIDIwcHgpOyB9CiAgICAuY2hhci1uYW1lIHsgZm9udC1zaXplOiAxNHB4OyB9CiAgICAKICAgICNhdXRvLXRvZ2dsZSwgI3NldHRpbmdzLWJ1dHRvbiwgI3ByYWN0aWNlLXJlc3RvcmUtYnRuIHsKICAgICAgICB3aWR0aDogOTBweDsKICAgICAgICBmb250LXNpemU6IDlweDsKICAgICAgICByaWdodDogbWF4KDEwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIH0KICAgIAogICAgI2dvYWwtZGlzdGFuY2UtY29udGFpbmVyIHsgbGVmdDogbWF4KDEwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtbGVmdCkpOyB9CiNnb2FsLWRpc3RhbmNlIHsgZm9udC1zaXplOiAxOHB4OyB9Cn0KCi8qIC0tLSBHRVNUVVJFIEhJTlQgLS0tICovCiNnZXN0dXJlLWhpbnQgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDIwMHB4OyBoZWlnaHQ6IDMwMHB4OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMjUwMDsKICAgIG9wYWNpdHk6IDAuOTsKfQoKI2dlc3R1cmUtaGludC5hY3RpdmUgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7Cn0KCi5jdXJ2ZS1hcnJvdyB7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA1cHggIzAwZmZmZik7CiAgICBhbmltYXRpb246IGRhc2hEcmF3IDEuNXMgbGluZWFyIGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIGRhc2hEcmF3IHsKICAgIHRvIHsgc3Ryb2tlLWRhc2hvZmZzZXQ6IC0zMDsgfQp9CgouZ2VzdHVyZS10ZXh0IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKICAgIG1hcmdpbi10b3A6IC01MHB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCi5nZXN0dXJlLWhhbmQgewogICAgZm9udC1zaXplOiA0OHB4OwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAyMHB4OwogICAgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgYW5pbWF0aW9uOiBoYW5kU3dpcGUgMS41cyBlYXNlLWluLW91dCBpbmZpbml0ZTsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggYmxhY2spOwp9CgpAa2V5ZnJhbWVzIGhhbmRTd2lwZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIDUwcHgpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgb3BhY2l0eTogMTsgfQogICAgODAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMjBweCwgLTEwMHB4KSByb3RhdGUoMjBkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMHB4LCAtMTIwcHgpIHJvdGF0ZSgxMGRlZyk7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIFNXSVBFIFRSQUlMIChJTlRVSVRJVkUgRkVFREJBQ0spIC0tLSAqLwouc3dpcGUtdHJhaWwtZG90IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxMnB4OwogICAgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgIzAwZmZmZiAwJSwgcmdiYSgwLCAyNTUsIDI1NSwgMCkgNzAlKTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogOTAwMDsKICAgIGFuaW1hdGlvbjogZmFkZVRyYWlsIDAuNXMgbGluZWFyIGZvcndhcmRzOwogICAgbWl4LWJsZW5kLW1vZGU6IHNjcmVlbjsKfQoKQGtleWZyYW1lcyBmYWRlVHJhaWwgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjIpOyBvcGFjaXR5OiAwOyB9Cn0KQGtleWZyYW1lcyBmYWRlVHJhaWwgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjIpOyBvcGFjaXR5OiAwOyB9Cn0KCi8qIC0tLSBPRkZTQ1JFRU4gSU5ESUNBVE9SIC0tLSAqLwojb2Zmc2NyZWVuLWluZGljYXRvciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogNDBweDsgaGVpZ2h0OiA0MHB4OwogICAgbWFyZ2luLWxlZnQ6IC0yMHB4OyBtYXJnaW4tdG9wOiAtMjBweDsKICAgIHotaW5kZXg6IDE1MDA7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA1cHggIzAwMCk7Cn0KCiNvZmZzY3JlZW4taW5kaWNhdG9yIC5hcnJvdyB7CiAgICB3aWR0aDogMDsgaGVpZ2h0OiAwOwogICAgYm9yZGVyLWxlZnQ6IDE1cHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItcmlnaHQ6IDE1cHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItYm90dG9tOiAyNXB4IHNvbGlkICMwMGZmMDA7IC8qIEdyZWVuIGZvciBwbGF5ZXIgKi8KICAgIGFuaW1hdGlvbjogcHVsc2VBcnJvdyAwLjVzIGluZmluaXRlIGFsdGVybmF0ZTsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGNlbnRlciBib3R0b207Cn0KCkBrZXlmcmFtZXMgcHVsc2VBcnJvdyB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgZmlsdGVyOiBicmlnaHRuZXNzKDEpOyB9CiAgICB0byB7IHRyYW5zZm9ybTogc2NhbGUoMS4yKTsgZmlsdGVyOiBicmlnaHRuZXNzKDEuNSk7IH0KfQ==","./style.css":"data:text/css;base64,OnJvb3QgewogICAgLS1mZngtYmx1ZS1kZWVwOiAjMDIwNDA4OwogICAgLS1mZngtYmx1ZS1kYXJrOiAjMGExNTI1OwogICAgLS1mZngtYmx1ZS1taWQ6ICMxNTJhNDU7CiAgICAtLWZmeC1ibHVlLWxpZ2h0OiAjMmE0ZDc1OwogICAgLS1mZngtY3lhbjogIzYwYzBkMDsKICAgIC0tZmZ4LWN5YW4tZ2xvdzogIzAwZmZmZjsKICAgIC0tZmZ4LWdvbGQ6ICNjOGIwNjA7CiAgICAtLWZmeC1nb2xkLWxpZ2h0OiAjZjBlMDkwOwogICAgLS1mZngtZ29sZC1kYXJrOiAjOGE3MDMwOwogICAgLS1mZngtZ2xhc3MtYmc6IHJnYmEoMTAsIDIwLCA0MCwgMC43NSk7CiAgICAtLWZmeC1nbGFzcy1ib3JkZXI6IHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIAogICAgLS1mb250LXRpdGxlOiAnR2FyYW1vbmQnLCAnVGltZXMgTmV3IFJvbWFuJywgc2VyaWY7CiAgICAtLWZvbnQtZGF0YTogJ0ltcGFjdCcsICdBcmlhbCBOYXJyb3cnLCBzYW5zLXNlcmlmOwogICAgLS1mb250LXVpOiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAtLWZvbnQtc3BpcmE6ICdTcGlyYScsICdJbXBhY3QnLCBzYW5zLXNlcmlmOwp9CgpAZm9udC1mYWNlIHsKICAgIGZvbnQtZmFtaWx5OiAnU3BpcmEnOwogICAgc3JjOiB1cmwoJ2h0dHBzOi8vZmlsZXMuY2F0Ym94Lm1vZS96eW43czMudHRmJykgZm9ybWF0KCd0cnVldHlwZScpOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgIGZvbnQtc3R5bGU6IG5vcm1hbDsKfQoKaHRtbCwgYm9keSB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB3aWR0aDogMTAwdnc7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBwb3NpdGlvbjogZml4ZWQ7IAogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHJpZ2h0OiAwOwogICAgYm90dG9tOiAwOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBjb2xvcjogd2hpdGU7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICBwYWRkaW5nLXRvcDogZW52KHNhZmUtYXJlYS1pbnNldC10b3ApOwogICAgcGFkZGluZy1ib3R0b206IGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKTsKICAgIHBhZGRpbmctbGVmdDogZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KTsKICAgIHBhZGRpbmctcmlnaHQ6IGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpOwp9CgoqIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7Cn0KCi8qIC0tLSBNQUlOIEdBTUUgQ09OVEFJTkVSIC0tLSAqLwojZ2FtZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgbWF4LXdpZHRoOiBub25lOwogICAgYmFja2dyb3VuZDogIzAwMDUxMDsKICAgIGJveC1zaGFkb3c6IG5vbmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgdHJhbnNpdGlvbjogZmlsdGVyIDAuMDVzOwogICAgei1pbmRleDogMTsKfQoKLyogLS0tIElNUEFDVCBGWCAtLS0gKi8KI2dhbWUtY29udGFpbmVyLmltcGFjdC1meCB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuMXMgZWFzZS1pbi1vdXQ7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDEuMikgYnJpZ2h0bmVzcygxLjEpOwp9CgojZ2FtZS1jb250YWluZXIuaW1wYWN0LWhlYXZ5IHsKICAgIGFuaW1hdGlvbjogaW1wYWN0U2hha2UgMC4ycyBlYXNlLWluLW91dDsKICAgIGZpbHRlcjogY29udHJhc3QoMS41KSBicmlnaHRuZXNzKDEuMykgc2VwaWEoMC40KSBodWUtcm90YXRlKC0xMGRlZyk7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3Qtc2hhdHRlciB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuNHMgZWFzZS1pbi1vdXQ7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDIuMCkgaW52ZXJ0KDAuMSkgc2F0dXJhdGUoMi4wKTsKfQoKQGtleWZyYW1lcyBpbXBhY3RTaGFrZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDAsIDApOyB9CiAgICAyNSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNXB4LCA1cHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSg1cHgsIC01cHgpOyB9CiAgICA3NSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNXB4LCAtNXB4KTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDAsIDApOyB9Cn0KCi8qIC0tLSBDQU5WQVMgJiBSRU5ERVIgLS0tICovCmNhbnZhcyB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsKICAgIGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGltYWdlLXJlbmRlcmluZzogcGl4ZWxhdGVkOyAKICAgIHotaW5kZXg6IDA7Cn0KCi8qIC0tLSBHSUYgT1ZFUkxBWSAtLS0gKi8KI3NjcmVlbi1vdmVybGF5LWdpZiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgb2JqZWN0LWZpdDogY292ZXI7CiAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKICAgIG9wYWNpdHk6IDEuMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogOTUwOwogICAgaW1hZ2UtcmVuZGVyaW5nOiBwaXhlbGF0ZWQ7Cn0KCiN1aS1sYXllciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgei1pbmRleDogMTAwMDsKfQoKLyogLS0tIENJTkVNQVRJQyBCQVJTIC0tLSAqLwojY2luZW1hdGljLWJhcnMgLmJhciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAwOwogICAgYmFja2dyb3VuZDogYmxhY2s7CiAgICB0cmFuc2l0aW9uOiBoZWlnaHQgMC41cyBlYXNlOwogICAgei1pbmRleDogODAwOwp9CiNjaW5lbWF0aWMtYmFycyAuYmFyLnRvcCB7IHRvcDogMDsgfQojY2luZW1hdGljLWJhcnMgLmJhci5ib3R0b20geyBib3R0b206IDA7IH0KCi8qIC0tLSBURUNIIEZMQVNIIE9WRVJMQVkgLS0tICovCiN0ZWNoLWZsYXNoLW92ZXJsYXkgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAyMCU7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEyMHB4OwogICAgZGlzcGxheTogbm9uZTsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwwLDAsMCkgMCUsIHJnYmEoMCwgMjAsIDYwLCAwLjkpIDIwJSwgcmdiYSgwLCAyMCwgNjAsIDAuOSkgODAlLCByZ2JhKDAsMCwwLDApIDEwMCUpOwogICAgei1pbmRleDogMjIwMDsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigycHgpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMTAwLCAyNTUsIDI1NSwgMC4zKTsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDEwMCwgMjU1LCAyNTUsIDAuMyk7CiAgICBhbmltYXRpb246IGZsYXNoRW50ZXIgMC4xNXMgZWFzZS1vdXQ7Cn0KCkBrZXlmcmFtZXMgZmxhc2hFbnRlciB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiBzY2FsZVkoMCk7IG9wYWNpdHk6IDA7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZVkoMSk7IG9wYWNpdHk6IDE7IH0KfQoKLnRlY2gtY29udGVudC13cmFwcGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goLTEwZGVnKTsKfQoKLnRlY2gtdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IGNsYW1wKDI4cHgsIDEwdncsIDQycHgpOwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZiwgMCAwIDIwcHggIzAwMDBmZjsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7CiAgICBtYXJnaW4tYm90dG9tOiAycHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBhbmltYXRpb246IGJsaW5rVGV4dCAwLjA4cyBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCi50ZWNoLXN1Yi10ZXh0IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjMDBmZmZmOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjUpOwp9CgoudGVjaC10aW1lci10cmFjayB7CiAgICB3aWR0aDogMjUwcHg7CiAgICBoZWlnaHQ6IDhweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC42KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggcmdiYSgwLDAsMCwwLjUpOwp9CgoudGVjaC10aW1lci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmZmZiwgIzAwZmZmZik7CiAgICB3aWR0aDogMTAwJTsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGxlZnQ7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwp9CgpAa2V5ZnJhbWVzIGJsaW5rVGV4dCB7CiAgICBmcm9tIHsgb3BhY2l0eTogMC44OyB0ZXh0LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOyB0cmFuc2Zvcm06IHNjYWxlKDEpOyB9CiAgICB0byB7IG9wYWNpdHk6IDEuMDsgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICNmZmZmZmYsIDAgMCAxMHB4ICMwMGZmZmY7IHRyYW5zZm9ybTogc2NhbGUoMS4wMik7IH0KfQoKLyogLS0tIEhVRCBUT1AgLS0tICovCiNodWQtdG9wIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsKICAgIGxlZnQ6IDA7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgYWxpZ24taXRlbXM6IGZsZXgtc3RhcnQ7CiAgICB3aWR0aDogMTAwJTsKICAgIHBhZGRpbmc6IDE1cHg7CiAgICBwYWRkaW5nLXRvcDogbWF4KDE1cHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSk7CiAgICBwYWRkaW5nLWxlZnQ6IG1heCgxNXB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQpKTsKICAgIHBhZGRpbmctcmlnaHQ6IG1heCgxNXB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgcmdiYSgwLCA1LCAxNSwgMC45KSAwJSwgcmdiYSgwLDAsMCwwKSAxMDAlKTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgoudGVhbS13aW5nIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgd2lkdGg6IDEzMHB4OwogICAgaGVpZ2h0OiA1MHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE2MGRlZywgdmFyKC0tZmZ4LWJsdWUtbWlkKSAwJSwgdmFyKC0tZmZ4LWJsdWUtZGVlcCkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3JkZXItdG9wOiAycHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpOwogICAgYm94LXNoYWRvdzogMCA1cHggMTVweCByZ2JhKDAsIDAsIDAsIDAuNSk7CiAgICBwYWRkaW5nOiAwIDEwcHg7Cn0KCi50ZWFtLXdpbmcuYXdheSB7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDE1ZGVnKTsKICAgIGZsZXgtZGlyZWN0aW9uOiByb3ctcmV2ZXJzZTsKICAgIGJvcmRlci10b3AtY29sb3I6ICNmZjY2NjY7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoLTE2MGRlZywgIzJhMTAxMCAwJSwgIzEwMDUwNSAxMDAlKTsKfQoKLnRlYW0tZGF0YSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZyk7Cn0KLnRlYW0td2luZy5hd2F5IC50ZWFtLWRhdGEgeyB0cmFuc2Zvcm06IHNrZXdYKC0xNWRlZyk7IHRleHQtYWxpZ246IHJpZ2h0OyB9CgoudGVhbS1uYW1lIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZC1saWdodCk7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIHRleHQtc2hhZG93OiAwIDJweCAycHggcmdiYSgwLDAsMCwwLjgpOwp9Ci50ZWFtLXN1YiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBvcGFjaXR5OiAwLjg7Cn0KLnRlYW0td2luZy5hd2F5IC50ZWFtLXN1YiB7IGNvbG9yOiAjZmZhYWFhOyB9Cgouc2NvcmUtYm94IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzOHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4IHZhcigtLWZmeC1jeWFuLWdsb3cpOwogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZyk7CiAgICBtYXJnaW46IDAgMTBweDsKfQoudGVhbS13aW5nLmF3YXkgLnNjb3JlLWJveCB7IHRyYW5zZm9ybTogc2tld1goLTE1ZGVnKTsgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICNmZjQ0NDQ7IH0KCi50aW1lci1jb21wbGV4IHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG1hcmdpbi10b3A6IC01cHg7Cn0KCi50aW1lci1jcnlzdGFsLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtMjVweDsKICAgIHdpZHRoOiAxMjBweDsKICAgIGhlaWdodDogNjBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlci10b3A6IDNweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3gtc2hhZG93OiAwIC01cHggMTVweCByZ2JhKDIwMCwgMTgwLCAxMDAsIDAuMyk7CiAgICB6LWluZGV4OiAtMTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChlbGxpcHNlIGF0IHRvcCwgcmdiYSgyMCwgNDAsIDgwLCAwLjgpLCB0cmFuc3BhcmVudCA3MCUpOwp9CgojaGFsZi1pbmRpY2F0b3IgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG1hcmdpbi1ib3R0b206IC0ycHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtZ29sZC1kYXJrKTsKfQoKI3RpbWVyLWRpc3BsYXkgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmIDAlLCAjZmZkNzAwIDUwJSwgI2I4ODYwYiAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygycHggMnB4IDBweCByZ2JhKDAsMCwwLDAuOCkpOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKLyogLS0tIFBMQVlFUiBTVEFUVVMgUEFORUwgLS0tICovCiNwbGF5ZXItc3RhdHVzLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyA0MHB4KTsKICAgIGxlZnQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQpKTsKICAgIHdpZHRoOiAxNjBweDsKICAgIHBhZGRpbmc6IDEwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMTAsIDMwLCAwLjgpIDAlLCByZ2JhKDAsMCwwLDApIDEwMCUpOwogICAgYm9yZGVyLWxlZnQ6IDNweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiAwIDEwcHggMTBweCAwOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7Cn0KCi5jaGFyLW5hbWUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAxOHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKICAgIHRyYW5zZm9ybTogc2tld1goMTBkZWcpOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwp9CgouaHAtZ2F1Z2UtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogNHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7Cn0KLmhwLWxhYmVsIHsgZm9udC1zaXplOiAxMHB4OyBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOyB3aWR0aDogMjBweDsgfQouaHAtYmFyLXRyYWNrIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGhlaWdodDogNnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIG1hcmdpbjogMCA1cHg7Cn0KLmhwLWJhci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgIzAwZmYwMCwgI2NjZmZjYyk7CiAgICBib3gtc2hhZG93OiAwIDAgNXB4ICMwMGZmMDA7Cn0KLmhwLXZhbHVlIHsgZm9udC1zaXplOiAxMHB4OyBjb2xvcjogI2ZmZjsgd2lkdGg6IDQ1cHg7IHRleHQtYWxpZ246IHJpZ2h0OyB9CgoudGVjaC1nYXVnZS1jb250YWluZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDEwZGVnKTsKfQoudGVjaC1sYWJlbCB7IGZvbnQtc2l6ZTogMTBweDsgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsgd2lkdGg6IDIwcHg7IH0KLnRlY2gtYmFyLXRyYWNrIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGhlaWdodDogNHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIG1hcmdpbjogMCA1cHg7Cn0KLnRlY2gtYmFyLWZpbGwgewogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjZmZhYTAwLCAjZmZmZmFhKTsKfQoKLyogLS0tIE1JTklNQVAgLS0tICovCiNtaW5pbWFwLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg4MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA2MHB4KTsKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgaGVpZ2h0OiAxMTBweDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7Cn0KCi5yYWRhci1yaW0gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHZhcigtLWZmeC1ibHVlLWxpZ2h0KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHZhcigtLWZmeC1ibHVlLW1pZCksIGluc2V0IDAgMCAyMHB4IHJnYmEoMCwwLDAsMC44KTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMCwgMjAsIDYwLCAwLjQpIDAlLCByZ2JhKDAsIDUsIDEwLCAwLjgpIDEwMCUpOwogICAgei1pbmRleDogNTsKfQoKI21pbmltYXAgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgd2lkdGg6IDEwMHB4OwogICAgaGVpZ2h0OiAxMDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHotaW5kZXg6IDY7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgoucmFkYXItbGFiZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAtMTVweDsKICAgIHdpZHRoOiAxNDAlOwogICAgbGVmdDogLTIwJTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4pOwp9CgoubWFwLWRvdCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB3aWR0aDogNnB4OyBoZWlnaHQ6IDZweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgYm94LXNoYWRvdzogMCAwIDRweCBjdXJyZW50Q29sb3I7Cn0KLm1hcC1kb3QuaG9tZSB7IGJhY2tncm91bmQ6IHZhcigtLWZmeC1jeWFuKTsgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsgfQoubWFwLWRvdC5hd2F5IHsgYmFja2dyb3VuZDogI2ZmNDQ0NDsgY29sb3I6ICNmZjQ0NDQ7IH0KLm1hcC1kb3QuYmFsbCB7IAogICAgYmFja2dyb3VuZDogI2ZmMDBjYzsKICAgIGNvbG9yOiAjZmYwMGNjOyAKICAgIHdpZHRoOiAxMnB4OyBoZWlnaHQ6IDEycHg7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjZmZmZmZmOwogICAgei1pbmRleDogMjA7CiAgICBhbmltYXRpb246IGJsaW5rQmFsbCAwLjNzIGluZmluaXRlIGFsdGVybmF0ZTsKICAgIGJveC1zaGFkb3c6IDAgMCA2cHggI2ZmMDBjYzsKfQoubWFwLWRvdC5uYXAgeyBiYWNrZ3JvdW5kOiAjMzMzOyBjb2xvcjogIzAwMDsgYm9yZGVyOiAxcHggc29saWQgIzU1NTsgfQoubWFwLWRvdC5hY3RpdmUtcGxheWVyIHsgCiAgICBiYWNrZ3JvdW5kOiAjMDBmZjAwICFpbXBvcnRhbnQ7IAogICAgY29sb3I6ICMwMGZmMDAgIWltcG9ydGFudDsgCiAgICBib3gtc2hhZG93OiAwIDAgOHB4ICMwMGZmMDA7CiAgICB6LWluZGV4OiAxNTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuMik7Cn0KLm1hcC1kb3QuYmFsbC1jYXJyaWVyIHsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4ICNmZmYsIDAgMCAzMHB4ICNmZmFhMDA7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjZmZmZmZmOwogICAgYmFja2dyb3VuZC1jb2xvcjogI2ZmYWEwMCAhaW1wb3J0YW50OwogICAgei1pbmRleDogMTAwOwogICAgd2lkdGg6IDEwcHg7IGhlaWdodDogMTBweDsKICAgIGFuaW1hdGlvbjogY2FycmllclB1bHNlIDAuOHMgaW5maW5pdGUgYWx0ZXJuYXRlOwp9CkBrZXlmcmFtZXMgY2FycmllclB1bHNlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjIpOyBib3gtc2hhZG93OiAwIDAgMTBweCAjZmZmOyBvcGFjaXR5OiAwLjg7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS44KTsgYm94LXNoYWRvdzogMCAwIDI1cHggI2ZmY2MwMDsgb3BhY2l0eTogMS4wOyB9Cn0KQGtleWZyYW1lcyBibGlua0JhbGwgeyBmcm9tIHsgb3BhY2l0eTogMTsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IH0gdG8geyBvcGFjaXR5OiAwLjU7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuMyk7IH0gfQoKLyogLS0tIEFOTk9VTkNFTUVOVFMgLS0tICovCiNhbm5vdW5jZW1lbnQgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA0MCU7IAogICAgbGVmdDogNSU7IAogICAgd2lkdGg6IDkwJTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiBjbGFtcCg0MHB4LCAxMnZ3LCA3MnB4KTsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICB3aGl0ZS1zcGFjZTogbm9ybWFsOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZiAwJSwgI2ZmZDcwMCA0MCUsICNiODg2MGIgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggcmdiYSgyNTUsIDEwMCwgMCwgMC41KSkgZHJvcC1zaGFkb3coM3B4IDNweCAwICMwMDApOwogICAgZGlzcGxheTogbm9uZTsKICAgIHotaW5kZXg6IDIwMDA7CiAgICBhbmltYXRpb246IGFubm91bmNlU2xpZGUgMC41cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKQGtleWZyYW1lcyBhbm5vdW5jZVNsaWRlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHNjYWxlKDApIHJvdGF0ZSgtNWRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZSgxKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDE7IH0KfQoKLyogLS0tIEpPWVNUSUNLIC0tLSAqLwojam95c3RpY2staGl0LXpvbmUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDUwJTsgaGVpZ2h0OiA1MCU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwKTsgCiAgICB0b3VjaC1hY3Rpb246IG5vbmU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKfQoKI2pveXN0aWNrLXZpc3VhbC1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDA7IGhlaWdodDogMDsKICAgIG92ZXJmbG93OiB2aXNpYmxlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMTEwMDsKfQoKI2pveXN0aWNrLWJhc2UgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDEyMHB4OyBoZWlnaHQ6IDEyMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgwLCA0MCwgODAsIDAuNCkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjEpIDYwJSwgdHJhbnNwYXJlbnQgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDEwMCwgMjIwLCAyNTUsIDAuMyk7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpLCBpbnNldCAwIDAgMzBweCByZ2JhKDAsIDUwLCAxMDAsIDAuMyk7CiAgICBhbmltYXRpb246IGJhc2VQdWxzZSAycyBpbmZpbml0ZSBhbHRlcm5hdGU7Cn0KCkBrZXlmcmFtZXMgYmFzZVB1bHNlIHsKICAgIGZyb20geyBib3gtc2hhZG93OiAwIDAgMTBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpOyBib3JkZXItY29sb3I6IHJnYmEoMTAwLCAyMjAsIDI1NSwgMC4yKTsgfQogICAgdG8geyBib3gtc2hhZG93OiAwIDAgMjVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjUpOyBib3JkZXItY29sb3I6IHJnYmEoMTAwLCAyNTUsIDI1NSwgMC42KTsgfQp9Cgojam95c3RpY2sta25vYiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogNTBweDsgaGVpZ2h0OiA1MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzMCUgMzAlLCAjZTBmZmZmIDAlLCAjMDBhYWZmIDQwJSwgIzAwNDQ4OCA4MCUsICMwMDExMjIgMTAwJSk7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjODhjY2ZmOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggIzAwZmZmZiwgaW5zZXQgMCAwIDEwcHggcmdiYSgyNTUsMjU1LDI1NSwwLjgpOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMDVzIGxpbmVhcjsKfQoKI2pveXN0aWNrLWtub2I6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICIiOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAyMCU7IGxlZnQ6IDIwJTsgd2lkdGg6IDIwJTsgaGVpZ2h0OiAyMCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAjZmZmZmZmIDAlLCB0cmFuc3BhcmVudCA3MCUpOwogICAgZmlsdGVyOiBibHVyKDJweCk7CiAgICBvcGFjaXR5OiAwLjg7Cn0KCi50b3VjaC1yaXBwbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgyMDAsIDI1NSwgMjU1LCAwLjgpIDAlLCByZ2JhKDAsIDI1NSwgMjU1LCAwLjQpIDQwJSwgdHJhbnNwYXJlbnQgNzAlKTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDApOwogICAgYW5pbWF0aW9uOiByaXBwbGVBbmltIDAuNnMgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDkwMDA7CiAgICBtaXgtYmxlbmQtbW9kZTogc2NyZWVuOwp9CgpAa2V5ZnJhbWVzIHJpcHBsZUFuaW0gewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgwKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDMuMCk7IG9wYWNpdHk6IDA7IH0KfQoKI2NhbWVyYS16b25lIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgcmlnaHQ6IDA7IHdpZHRoOiA1MCU7IGhlaWdodDogMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdG91Y2gtYWN0aW9uOiBub25lOwogICAgei1pbmRleDogNTA7Cn0KCi8qIC0tLSBBQ1RJT04gQlVUVE9OIC0tLSAqLwojYWN0aW9uLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCg0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOyAKICAgIHJpZ2h0OiBtYXgoNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB6LWluZGV4OiAxMDA7Cn0KCi5jb21tYW5kLW1lbnUtYmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDE4MHB4OyBoZWlnaHQ6IDgwcHg7CiAgICBib3R0b206IDE1cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHRyYW5zcGFyZW50IDAlLCByZ2JhKDAsIDEwLCAzMCwgMC44KSA1MCUsIHRyYW5zcGFyZW50IDEwMCUpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMCwgMjAwLCAyNTUsIDAuMyk7CiAgICB6LWluZGV4OiAtMTsKfQoKLmNvbW1hbmQtcmluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMTMwcHg7IGhlaWdodDogMTMwcHg7CiAgICBib3JkZXI6IDJweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7CiAgICBib3JkZXItdG9wOiAycHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC42KTsKICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCByZ2JhKDAsIDI1NSwgMjU1LCAwLjYpOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYW5pbWF0aW9uOiBzcGluUmV2ZXJzZSAxNXMgbGluZWFyIGluZmluaXRlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpOwp9CkBrZXlmcmFtZXMgc3BpblJldmVyc2UgeyBmcm9tIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgcm90YXRlKDM2MGRlZyk7IH0gdG8geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSByb3RhdGUoMGRlZyk7IH0gfQoKI2FjdGlvbi1sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCA1LCAxMCwgMC44KTsKICAgIHBhZGRpbmc6IDRweCAxMnB4OwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwogICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMCwwLDAsMC44KTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjNzOwp9CgojYWN0aW9uLWJ1dHRvbiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwcHg7IGhlaWdodDogMTAwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4xcywgZmlsdGVyIDAuM3M7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZmZmZmYgMCUsICMwMDg4ZmYgNDAlLCAjMDAyMjY2IDgwJSwgIzAwMCAxMDAlKTsKICAgIGJvcmRlcjogM3B4IHNvbGlkICM0NGFhZmY7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjgpLCBpbnNldCAwIDAgMjBweCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNCk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICB6LWluZGV4OiAxMDsKfQoKI3Bhc3MtYnV0dG9uIHsKICAgIGRpc3BsYXk6IG5vbmUgIWltcG9ydGFudDsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogLTIwcHg7IGxlZnQ6IC0zMHB4OwogICAgd2lkdGg6IDYwcHg7IGhlaWdodDogNjBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHotaW5kZXg6IDk7Cn0KCiNhY3Rpb24tYnV0dG9uOjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC00MHB4OyBsZWZ0OiAtNDBweDsgcmlnaHQ6IC00MHB4OyBib3R0b206IC00MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgei1pbmRleDogMTA7Cn0KCiNhY3Rpb24tYnV0dG9uOmFjdGl2ZSB7IHRyYW5zZm9ybTogc2NhbGUoMC45Mik7IH0KCiNhY3Rpb24tYnV0dG9uIC5idG4tdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDIycHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDJweCA0cHggcmdiYSgwLDAsMCwwLjgpLCAwIDAgMTBweCByZ2JhKDI1NSwyNTUsMjU1LDAuNSk7CiAgICB6LWluZGV4OiA1OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgojYWN0aW9uLWJ1dHRvbiAuYnRuLWdsYXJlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwJTsgbGVmdDogLTUwJTsgd2lkdGg6IDIwMCU7IGhlaWdodDogMjAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg0NWRlZywgdHJhbnNwYXJlbnQgNDAlLCByZ2JhKDI1NSwyNTUsMjU1LDAuNCkgNTAlLCB0cmFuc3BhcmVudCA2MCUpOwogICAgYW5pbWF0aW9uOiBnbGFyZVBhc3MgNXMgaW5maW5pdGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDY7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7Cn0KCi5saW1pdC1yaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTVweDsgbGVmdDogLTVweDsgcmlnaHQ6IC01cHg7IGJvdHRvbTogLTVweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHRyYW5zcGFyZW50OwogICAgYm94LXNoYWRvdzogMCAwIDAgdHJhbnNwYXJlbnQ7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC41czsKICAgIHotaW5kZXg6IDE7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKI2FjdGlvbi1idXR0b24uc2hvb3QtbW9kZSB7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZmZmYWEgMCUsICNmZmFhMDAgNDAlLCAjODgyMjAwIDgwJSwgIzIyMDAwMCAxMDAlKTsKICAgIGJvcmRlci1jb2xvcjogI2ZmY2MwMDsKICAgIGJveC1zaGFkb3c6IDAgMCAzMHB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuOCksIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCAyNTUsIDAsIDAuNSk7Cn0KCiNhY3Rpb24tYnV0dG9uLmxpbWl0LXJlYWR5IC5saW1pdC1yaW5nIHsKICAgIGJvcmRlci1jb2xvcjogI2ZmZGQ0NDsKICAgIGFuaW1hdGlvbjogbGltaXRQdWxzZSAwLjhzIGVhc2UtaW4tb3V0IGluZmluaXRlIGFsdGVybmF0ZTsKfQoKLnNob290LWxhYmVsIHsKICAgIGNvbG9yOiAjZmZkZDQ0ICFpbXBvcnRhbnQ7CiAgICBib3JkZXItY29sb3I6ICNmZmFhMDAgIWltcG9ydGFudDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmY0NDAwICFpbXBvcnRhbnQ7Cn0KCkBrZXlmcmFtZXMgbGltaXRQdWxzZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgYm94LXNoYWRvdzogMCAwIDEwcHggI2ZmYWEwMCwgaW5zZXQgMCAwIDVweCAjZmZhYTAwOyBvcGFjaXR5OiAwLjU7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMTUpOyBib3gtc2hhZG93OiAwIDAgMzBweCAjZmY0NDAwLCBpbnNldCAwIDAgMTVweCAjZmYwMDAwOyBvcGFjaXR5OiAxLjA7IH0KfQoKLyogLS0tIEFVVE8gVE9HR0xFIC0tLSAqLwojYXV0by10b2dnbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoMjAwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDYwcHgpOyAKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgcGFkZGluZzogMTBweCAwOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgwLCAyMCwgNDAsIDAuOCkgMCUsIHJnYmEoMCwgNSwgMTAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3JkZXItdG9wOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNHB4KTsKICAgIGJveC1zaGFkb3c6IDAgNXB4IDE1cHggcmdiYSgwLDAsMCwwLjMpOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIHotaW5kZXg6IDEwMDsKfQoKI2F1dG8tdG9nZ2xlOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjkpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggdmFyKC0tZmZ4LWN5YW4pOwogICAgY29sb3I6IHdoaXRlOwp9CgojYXV0by10b2dnbGUuYWN0aXZlIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMTAwLCAyMCwgMCwgMC44KSAwJSwgcmdiYSg0MCwgMCwgMCwgMC45KSAxMDAlKTsKICAgIGJvcmRlci1jb2xvcjogI2ZmNDQwMDsKICAgIGNvbG9yOiAjZmZhYTAwOwogICAgYW5pbWF0aW9uOiBwdWxzZVJlZCAycyBpbmZpbml0ZTsKfQpAa2V5ZnJhbWVzIHB1bHNlUmVkIHsgMCUgeyBib3gtc2hhZG93OiAwIDAgNXB4ICNmZjAwMDA7IH0gNTAlIHsgYm94LXNoYWRvdzogMCAwIDIwcHggI2ZmNDQwMDsgfSAxMDAlIHsgYm94LXNoYWRvdzogMCAwIDVweCAjZmYwMDAwOyB9IH0KCi8qIC0tLSBGTE9BVElORyBURVhUIC0tLSAqLwouZmxvYXRpbmctdGV4dC13cmFwcGVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogMjAwMDsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm07Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyIHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDI0cHg7IAogICAgdGV4dC1zaGFkb3c6IDFweCAxcHggMCAjMDAwOwogICAgb3BhY2l0eTogMC45Owp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5kYW1hZ2UgewogICAgZm9udC1zaXplOiA0MnB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZmZmZiAwJSwgI2ZmY2MwMCA0MCUsICNmZjQ0MDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCA0cHggNHB4IHJnYmEoMCwwLDAsMC44KSk7CiAgICBhbmltYXRpb246IHBvcERhbWFnZSAwLjhzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KSBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuaGVhbCB7CiAgICBmb250LXNpemU6IDM2cHg7CiAgICBjb2xvcjogIzQ0ZmY0NDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZjAwOwogICAgYW5pbWF0aW9uOiBmbG9hdFVwIDFzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci52ZW5vbSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGNvbG9yOiAjYWFmZjAwOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICM0NDg4MDAsIDJweCAycHggMCAjMDAyMjAwOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2NjZmY2NiAwJSwgIzY2Y2MwMCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgNXB4IHJnYmEoMTAwLCAyNTUsIDAsIDAuNSkpOwogICAgYW5pbWF0aW9uOiBkcmlwU3RhdHVzIDJzIGluZmluaXRlOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5zbGVlcCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTVweCAjMDA0NGZmLCAwIDAgMzBweCAjMDAwMGZmOwogICAgb3BhY2l0eTogMC45OwogICAgYW5pbWF0aW9uOiBkcmlmdFN0YXR1cyAzcyBlYXNlLWluLW91dCBpbmZpbml0ZTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIud2l0aGVyIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzOHB4OwogICAgY29sb3I6ICNjY2NjY2M7CiAgICB0ZXh0LXNoYWRvdzogMnB4IDJweCAwICM0NDQ0NDQ7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZWVlZWVlIDAlLCAjODg4ODg4IDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHdpdGhlclN0YXR1cyAxLjVzIGZvcndhcmRzOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci50ZWNoIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMzJweDsKICAgIGNvbG9yOiAjMDBmZmZmOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAxMCwgMzAsIDAuNyk7CiAgICBwYWRkaW5nOiAycHggMTBweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkICMwMGZmZmY7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjMDA4OGZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggI2ZmZjsKICAgIGFuaW1hdGlvbjogc2hha2VUZWNoIDAuNnMgZWFzZS1pbi1vdXQsIGZsYXNoVGVjaCAwLjNzOwogICAgdHJhbnNmb3JtLW9yaWdpbjogY2VudGVyOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5zYXZlLCAuZmxvYXRpbmctdGV4dC1pbm5lci5ibG9jayB7CiAgICBmb250LXNpemU6IDQ4cHg7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgY29sb3I6ICNmZmZmZmY7CiAgICAtd2Via2l0LXRleHQtc3Ryb2tlOiAxcHggIzAwNDQ4ODsKICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCAjMDA4OGZmOwogICAgYW5pbWF0aW9uOiBwb3BEYW1hZ2UgMC41cyBlYXNlLW91dCBmb3J3YXJkczsKfQoKQGtleWZyYW1lcyBwb3BEYW1hZ2UgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuNSk7IG9wYWNpdHk6IDA7IH0KICAgIDIwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS41KTsgb3BhY2l0eTogMTsgfQogICAgNDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgZmxvYXRVcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNTBweCk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyBkcmlwU3RhdHVzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZVkoMSk7IGZpbHRlcjogYmx1cigwcHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlWSgxLjEpIHRyYW5zbGF0ZVkoNXB4KTsgZmlsdGVyOiBibHVyKDFweCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlWSgxKTsgZmlsdGVyOiBibHVyKDBweCk7IH0KfQoKQGtleWZyYW1lcyBkcmlmdFN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIDIwJSB7IG9wYWNpdHk6IDE7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxNXB4KSB0cmFuc2xhdGVZKC0yMHB4KSByb3RhdGUoMTBkZWcpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0xNXB4KSB0cmFuc2xhdGVZKC01MHB4KSByb3RhdGUoLTEwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIHdpdGhlclN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IGZpbHRlcjogZ3JheXNjYWxlKDAlKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC42KTsgZmlsdGVyOiBncmF5c2NhbGUoMTAwJSk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyBzaGFrZVRlY2ggewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuOCk7IH0KICAgIDEwJSwgMzAlLCA1MCUsIDcwJSwgOTAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjEpIHRyYW5zbGF0ZSgtMnB4LCAycHgpOyB9CiAgICAyMCUsIDQwJSwgNjAlLCA4MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSkgdHJhbnNsYXRlKDJweCwgLTJweCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IH0KfQoKQGtleWZyYW1lcyBmbGFzaFRlY2ggewogICAgMCUgeyBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZmOyBjb2xvcjogIzAwMDsgYm9yZGVyLWNvbG9yOiAjZmZmOyB9CiAgICAxMDAlIHsgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgwLCAxMCwgMzAsIDAuODUpOyBjb2xvcjogIzAwZmZmZjsgYm9yZGVyLWNvbG9yOiAjMDBmZmZmOyB9Cn0KCiNsb2FkaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgIGFuaW1hdGlvbjogYmxpbmsgMXMgaW5maW5pdGU7Cn0KQGtleWZyYW1lcyBibGluayB7IDUwJSB7IG9wYWNpdHk6IDAuNTsgfSB9CgojY29udHJvbHMtaGludCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDEzMHB4OyB3aWR0aDogMTAwJTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiByZ2JhKDI1NSwyNTUsMjU1LDAuNCk7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmNvbWljLWltcGFjdCB7CiAgICBmb250LWZhbWlseTogJ0ltcGFjdCcsIHNhbnMtc2VyaWY7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBjb2xvcjogI2ZmZmYwMDsgCiAgICAtd2Via2l0LXRleHQtc3Ryb2tlOiAxcHggIzAwMDsKICAgIHRleHQtc2hhZG93OiAzcHggM3B4IDAgI2ZmMDAwMDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGNlbnRlcjsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICBhbmltYXRpb246IGNvbWljUG9wIDAuNHMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpIGZvcndhcmRzOwogICAgei1pbmRleDogMjUwMDsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuY29taWMtYWN0aW9uIHsKICAgIGZvbnQtZmFtaWx5OiAnQXJpYWwgQmxhY2snLCBzYW5zLXNlcmlmOwogICAgZm9udC1zaXplOiAyOHB4OwogICAgY29sb3I6ICMwMGZmZmY7IAogICAgLXdlYmtpdC10ZXh0LXN0cm9rZTogMXB4ICMwMDA7CiAgICB0ZXh0LXNoYWRvdzogMnB4IDJweCAwICMwMDQ0YWE7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgYW5pbWF0aW9uOiBjb21pY1NsaWRlIDAuNHMgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICB6LWluZGV4OiAyNTAwOwp9CgpAa2V5ZnJhbWVzIGNvbWljUG9wIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwKSByb3RhdGUoLTIwZGVnKTsgb3BhY2l0eTogMDsgfQogICAgNDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjIpIHJvdGF0ZSg1ZGVnKTsgb3BhY2l0eTogMTsgfQogICAgNjAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApIHJvdGF0ZSgtNWRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSkgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgY29taWNTbGlkZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC0yMHB4LCAyMHB4KSBzY2FsZSgwLjUpOyBvcGFjaXR5OiAwOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMjBweCwgLTIwcHgpIHNjYWxlKDEuMik7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIE1BSU4gTUVOVSAtLS0gKi8KI21haW4tbWVudSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDMwMDA7CiAgICBvcGFjaXR5OiAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuNXMgZWFzZS1pbi1vdXQ7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IGNlbnRlciwgcmdiYSgwLCAyMCwgNjAsIDAuMikgMCUsIHJnYmEoMCwgNSwgMTAsIDAuNSkgMTAwJSk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMnB4KTsKfQoKI21haW4tbWVudS5hY3RpdmUgewogICAgb3BhY2l0eTogMTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgoubWVudS1iZy1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IAogICAgICAgIGxpbmVhci1ncmFkaWVudChyZ2JhKDAsMCwwLDApIDUwJSwgcmdiYSgwLDAsMCwwLjEpIDUwJSksIAogICAgICAgIGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgyNTUsMCwwLDAuMDMpLCByZ2JhKDAsMjU1LDAsMC4wMSksIHJnYmEoMCwwLDI1NSwwLjAzKSk7CiAgICBiYWNrZ3JvdW5kLXNpemU6IDEwMCUgMnB4LCAzcHggMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogLTE7Cn0KCi5mZngtbG9nby1jb250YWluZXIgewogICAgbWFyZ2luLWJvdHRvbTogNjBweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goLTEwZGVnKTsKfQoKLmZmeC1sb2dvLW1haW4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiA2NHB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZiwgMCAwIDIwcHggIzAwODhmZiwgMCAwIDQwcHggIzAwMDBmZjsKICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmZmZmIDAlLCAjYWFjY2ZmIDUwJSwgIzAwODhmZiAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDVweCA1cHggcmdiYSgwLDAsMCwwLjgpKTsKfQoKLmZmeC1sb2dvLXN1YiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDE4cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDEycHg7CiAgICBtYXJnaW4tdG9wOiAtNXB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggI2ZmYWEwMDsKfQoKLm1lbnUtb3B0aW9ucyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogMTVweDsKICAgIHdpZHRoOiAzMDBweDsKfQoKLm1lbnUtaXRlbSB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBwYWRkaW5nOiAxNXB4IDMwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgNDAsIDgwLCAwLjYpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC4wKSAxMDAlKTsKICAgIGJvcmRlci1sZWZ0OiA0cHggc29saWQgcmdiYSgxMDAsIDIwMCwgMjU1LCAwLjMpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4xKTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7Cn0KCi5tZW51LWl0ZW06aG92ZXIgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDgwLCAxNjAsIDAuOCkgMCUsIHJnYmEoMCwgMjAsIDQwLCAwLjApIDEwMCUpOwogICAgYm9yZGVyLWxlZnQtY29sb3I6ICMwMGZmZmY7CiAgICBwYWRkaW5nLWxlZnQ6IDQwcHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjIpOwp9CgoubWVudS1pdGVtIC5sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogI2NjY2NjYzsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7CiAgICB0cmFuc2l0aW9uOiBjb2xvciAwLjJzOwp9CgoubWVudS1pdGVtOmhvdmVyIC5sYWJlbCB7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwp9CgoubWVudS1pdGVtIC5jdXJzb3IgewogICAgZm9udC1zaXplOiAxOHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIG1hcmdpbi1yaWdodDogMTVweDsKICAgIG9wYWNpdHk6IDA7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTEwcHgpIHNrZXdYKDEwZGVnKTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwp9CgoubWVudS1pdGVtOmhvdmVyIC5jdXJzb3IgewogICAgb3BhY2l0eTogMTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKSBza2V3WCgxMGRlZyk7Cn0KCi5tZW51LWZvb3RlciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDIwcHg7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogcmdiYSgyNTUsMjU1LDI1NSwwLjMpOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKfQoKLyogLS0tIFBSQUNUSUNFIE9WRVJMQVkgLS0tICovCiNwcmFjdGljZS1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNSwgMTAsIDAuNik7CiAgICBkaXNwbGF5OiBub25lOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgei1pbmRleDogMjUwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgojcHJhY3RpY2Utb3ZlcmxheS5hY3RpdmUgewogICAgZGlzcGxheTogZmxleDsKfQoKLnByYWN0aWNlLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDYwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDQwcHgpOyAKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDI4MHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE2MGRlZywgcmdiYSgwLCAyMCwgNTAsIDAuOTUpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC45OCkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ4OGZmOwogICAgYm9yZGVyLXJhZGl1czogMCAwIDE1cHggMDsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMiksIGluc2V0IDAgMCA1MHB4IHJnYmEoMCwgMjAsIDYwLCAwLjUpOwogICAgcGFkZGluZzogMTVweDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMmRlZyk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNXB4KTsKfQoKLnBhbmVsLWhlYWRlciB7CiAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgoucGFuZWwtdGl0bGUtZ3JvdXAgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47Cn0KCi5wYW5lbC10aXRsZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IGNsYW1wKDE4cHgsIDZ2dywgMjRweCk7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKfQoKLnBhbmVsLXN1YnRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogOHB4OwogICAgY29sb3I6ICM0NDg4ZmY7CiAgICBsZXR0ZXItc3BhY2luZzogNHB4OwogICAgbWFyZ2luLXRvcDogLTJweDsKfQoKLnBhbmVsLWRlY28tbGluZSB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMnB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgIzAwZmZmZiwgdHJhbnNwYXJlbnQpOwogICAgbWFyZ2luLXRvcDogNXB4OwogICAgYm94LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOwp9CgoucGFuZWwtY29udGVudCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogMTVweDsKfQoKLnNlY3Rpb24tbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDIwMCwgMTc2LCA5NiwgMC4zKTsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKICAgIHBhZGRpbmctYm90dG9tOiAycHg7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgouZHJpbGwtbGlzdCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogNXB4Owp9CgouZHJpbGwtYnRuIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcGFkZGluZzogOHB4IDEycHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4wNSksIHRyYW5zcGFyZW50KTsKICAgIGJvcmRlci1sZWZ0OiAycHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjYWFhOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7Cn0KCi5kcmlsbC1idG46aG92ZXIgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDI1NSwgMjU1LCAwLjEpLCB0cmFuc3BhcmVudCk7CiAgICBjb2xvcjogI2ZmZjsKICAgIHBhZGRpbmctbGVmdDogMTVweDsKfQoKLmRyaWxsLWJ0bi5hY3RpdmUgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDEwMCwgMjU1LCAwLjQpLCB0cmFuc3BhcmVudCk7CiAgICBib3JkZXItbGVmdDogM3B4IHNvbGlkICMwMGZmZmY7CiAgICBjb2xvcjogI2ZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMGZmZmY7Cn0KCi5kcmlsbC1idG4gLmljb24gewogICAgd2lkdGg6IDIwcHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBtYXJnaW4tcmlnaHQ6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwp9Cgoub3B0aW9uLWxpc3QgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBnYXA6IDVweDsKfQoKLm9wdGlvbi10b2dnbGUgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwYWRkaW5nOiA1cHggMTBweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiAjY2NjOwogICAgdHJhbnNpdGlvbjogY29sb3IgMC4yczsKfQoKLm9wdGlvbi10b2dnbGU6aG92ZXIgeyBjb2xvcjogI2ZmZjsgfQoKLm9wdGlvbi10b2dnbGUgLmNoZWNrYm94IHsKICAgIG1hcmdpbi1yaWdodDogMTBweDsKICAgIGNvbG9yOiAjNDQ0OwogICAgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsKICAgIGZvbnQtc2l6ZTogMTRweDsKfQoKLm9wdGlvbi10b2dnbGUuYWN0aXZlIC5jaGVja2JveCB7CiAgICBjb2xvcjogIzAwZmYwMDsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMGZmMDA7Cn0KCi5vcHRpb24tdG9nZ2xlLmFjdGl2ZSB7CiAgICBjb2xvcjogI2ZmZjsKfQoKLmFjdGlvbi1idG4gewogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIHBhZGRpbmc6IDZweDsKICAgIGZvbnQtc2l6ZTogMTFweDsKICAgIGNvbG9yOiAjYWFhOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICBtYXJnaW4tYm90dG9tOiA1cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKLmFjdGlvbi1idG46aG92ZXIgewogICAgYm9yZGVyLWNvbG9yOiAjZmZmOwogICAgY29sb3I6ICNmZmY7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7Cn0KCiNwLWV4aXQ6aG92ZXIgewogICAgYm9yZGVyLWNvbG9yOiAjZmY0NDQ0OwogICAgY29sb3I6ICNmZjQ0NDQ7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDUwLCAwLCAwLCAwLjMpOwp9CgoucGFuZWwtZm9vdGVyIHsKICAgIG1hcmdpbi10b3A6IDE1cHg7CiAgICBwYWRkaW5nLXRvcDogMTBweDsKICAgIGJvcmRlci10b3A6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCiNkcmlsbC1pbnN0cnVjdGlvbiB7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgbWFyZ2luLWJvdHRvbTogNXB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwp9CgojZHJpbGwtc2NvcmUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMjU1LCAyMTUsIDAsIDAuNSk7Cn0KCi5wYW5lbC1taW5pbWl6ZS1idG4gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMHB4OyByaWdodDogMTBweDsKICAgIHdpZHRoOiAyMHB4OyBoZWlnaHQ6IDIwcHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbGluZS1oZWlnaHQ6IDE4cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDAuNSk7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoucGFuZWwtbWluaW1pemUtYnRuOmhvdmVyIHsgCiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtY3lhbik7IAogICAgY29sb3I6ICMwMDA7IAogICAgYm94LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7Cn0KCiNwcmFjdGljZS1yZXN0b3JlLWJ0biB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA0MHB4KTsgCiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHBhZGRpbmc6IDhweCAxNXB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDIwLCA1MCwgMC45KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItbGVmdDogM3B4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB6LWluZGV4OiAyNDAwOwogICAgZGlzcGxheTogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC4yKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KI3ByYWN0aWNlLXJlc3RvcmUtYnRuOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjkpOwogICAgY29sb3I6ICNmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLyogLS0tIEFJTSBKT1lTVElDSyAtLS0gKi8KI2FpbS1qb3lzdGljay16b25lIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE1MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOwogICAgcmlnaHQ6IDA7CiAgICB3aWR0aDogNDAlOwogICAgaGVpZ2h0OiAzNSU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwKTsKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgojYWltLWpveXN0aWNrLXZpc3VhbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMDsgaGVpZ2h0OiAwOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAxMTAwOwp9CgojYWltLWpveXN0aWNrLWJhc2UgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDkwcHg7IGhlaWdodDogOTBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMjU1LCAxMDAsIDAsIDAuMykgMCUsIHJnYmEoODAsIDIwLCAwLCAwLjEpIDYwJSwgdHJhbnNwYXJlbnQgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMTUwLCA1MCwgMC40KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuMiksIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCA1MCwgMCwgMC4yKTsKfQoKI2FpbS1qb3lzdGljay1rbm9iIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiA0MHB4OyBoZWlnaHQ6IDQwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsICNmZmNjODggMCUsICNmZjY2MDAgNDAlLCAjODgyMjAwIDgwJSwgIzIyMDAwMCAxMDAlKTsKICAgIGJvcmRlcjogMnB4IHNvbGlkICNmZmFhNDQ7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjZmY0NDAwLCBpbnNldCAwIDAgOHB4IHJnYmEoMjU1LDI1NSwyNTUsMC42KTsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjA1cyBsaW5lYXI7Cn0KCiNhaW0tam95c3RpY2sta25vYjo6YWZ0ZXIgewogICAgY29udGVudDogIkFJTSI7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBmb250LXNpemU6IDhweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgdGV4dC1zaGFkb3c6IDAgMCAzcHggIzAwMDsKfQoKLyogLS0tIFRBQ0tMRSBCVVRUT04gLS0tICovCiN0YWNrbGUtYnV0dG9uIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyAxMDBweCk7CiAgICByaWdodDogbWF4KDQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiA3MHB4OwogICAgaGVpZ2h0OiA3MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZGlzcGxheTogbm9uZTsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgei1pbmRleDogMTAwOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmY4ODg4IDAlLCAjY2MwMDAwIDQwJSwgIzY2MDAwMCA4MCUsICMyMjAwMDAgMTAwJSk7CiAgICBib3JkZXI6IDNweCBzb2xpZCAjZmY0NDQ0OwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgyNTUsIDUwLCA1MCwgMC42KSwgaW5zZXQgMCAwIDE1cHggcmdiYSgyNTUsIDIwMCwgMjAwLCAwLjMpOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMXMsIGZpbHRlciAwLjJzOwp9CgojdGFja2xlLWJ1dHRvbjphY3RpdmUgewogICAgdHJhbnNmb3JtOiBzY2FsZSgwLjkpOwogICAgZmlsdGVyOiBicmlnaHRuZXNzKDEuMik7Cn0KCiN0YWNrbGUtYnV0dG9uLmFjdGl2ZSB7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZmZmZmYgMCUsICNmZjQ0NDQgNDAlLCAjYWEwMDAwIDgwJSwgIzQ0MDAwMCAxMDAlKTsKICAgIGJveC1zaGFkb3c6IDAgMCAyNXB4IHJnYmEoMjU1LCAxMDAsIDEwMCwgMC45KTsKfQoKI3RhY2tsZS1idXR0b24gLmJ0bi10ZXh0IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAxcHggMnB4IHJnYmEoMCwwLDAsMC44KTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7Cn0KCiN0YWNrbGUtYnV0dG9uIC5idG4tZ2xhcmUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtNTAlOyBsZWZ0OiAtNTAlOwogICAgd2lkdGg6IDIwMCU7IGhlaWdodDogMjAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg0NWRlZywgdHJhbnNwYXJlbnQgNDAlLCByZ2JhKDI1NSwyNTUsMjU1LDAuMykgNTAlLCB0cmFuc3BhcmVudCA2MCUpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBhbmltYXRpb246IGdsYXJlUGFzcyA0cyBpbmZpbml0ZTsKfQoKI3RhY2tsZS1idXR0b24udXJnZW50IHsKICAgIGFuaW1hdGlvbjogdXJnZW50UHVsc2UgMC41cyBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZjU1NTUgMCUsICNmZjAwMDAgNDAlLCAjODgwMDAwIDEwMCUpOwogICAgYm9yZGVyLWNvbG9yOiAjZmZhYWFhOwogICAgYm94LXNoYWRvdzogMCAwIDIwcHggI2ZmMDAwMDsKfQoKQGtleWZyYW1lcyB1cmdlbnRQdWxzZSB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyB9CiAgICB0byB7IHRyYW5zZm9ybTogc2NhbGUoMS4xNSk7IH0KfQoKLyogLS0tIENIQVJHRSBQT1dFUiBNRVRFUiAtLS0gKi8KI2NoYXJnZS1tZXRlci1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiBtYXgoMjUwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSArIDEwMHB4KTsKICAgIGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKTsKICAgIHdpZHRoOiAyMDBweDsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogMjAwMDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMTAsIDMwLCAwLjgpOwogICAgcGFkZGluZzogMTBweCAxNXB4OwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogNXB4OwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLCAxMDAsIDI1NSwgMC4zKTsKfQoKLmNoYXJnZS1sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBtYXJnaW4tYm90dG9tOiA1cHg7Cn0KCi5jaGFyZ2UtbWV0ZXItdHJhY2sgewogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEycHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuNik7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ0OwogICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKI2NoYXJnZS1tZXRlci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIHdpZHRoOiAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgIzBhZiwgIzBmMCk7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjMGYwOwogICAgdHJhbnNpdGlvbjogd2lkdGggMC4wNXMgbGluZWFyLCBiYWNrZ3JvdW5kIDAuMXM7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7Cn0KCi5jaGFyZ2UtaGludCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbWFyZ2luLXRvcDogNXB4OwogICAgb3BhY2l0eTogMC44OwogICAgYW5pbWF0aW9uOiBibGluayAwLjVzIGluZmluaXRlOwp9CgovKiAtLS0gR09BTCBESVNUQU5DRSBJTkRJQ0FUT1IgLS0tICovCiNnb2FsLWRpc3RhbmNlLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg3NXB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA1NXB4KTsKICAgIGxlZnQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQpKTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogMTAwOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDEwLCAzMCwgMC43KSAwJSwgdHJhbnNwYXJlbnQgMTAwJSk7CiAgICBwYWRkaW5nOiA1cHggMTVweCA1cHggMTBweDsKICAgIGJvcmRlci1sZWZ0OiAycHggc29saWQgdmFyKC0tZmZ4LWdvbGQpOwp9CgouZGlzdGFuY2UtbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiA4cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KCiNnb2FsLWRpc3RhbmNlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWdvbGQpOwp9CgovKiAtLS0gU0VUVElOR1MgQlVUVE9OIC0tLSAqLwojc2V0dGluZ3MtYnV0dG9uIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDI0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyAxMDBweCk7CiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiAxMTBweDsKICAgIHBhZGRpbmc6IDhweCAwOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICBjb2xvcjogIzg4ODsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMjAsIDIwLCAyMCwgMC44KSAwJSwgcmdiYSgxMCwgMTAsIDEwLCAwLjkpIDEwMCUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIHotaW5kZXg6IDEwMDsKfQoKI3NldHRpbmdzLWJ1dHRvbjpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDQwLCA0MCwgNDAsIDAuOSk7CiAgICBib3JkZXItY29sb3I6ICM4ODg7CiAgICBjb2xvcjogI2ZmZjsKfQoKLyogLS0tIFNFVFRJTkdTIFBBTkVMIC0tLSAqLwojc2V0dGluZ3MtcGFuZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7CiAgICBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiAyODBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHJnYmEoMCwgMjAsIDUwLCAwLjk4KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOTkpIDEwMCUpOwogICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgIGJveC1zaGFkb3c6IDAgMCAzMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuNCk7CiAgICB6LWluZGV4OiAzNTAwOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTBweCk7Cn0KCi5zZXR0aW5ncy1oZWFkZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwYWRkaW5nOiAxNXB4OwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMzAsIDYwLCAwLjUpOwp9Cgouc2V0dGluZ3MtaGVhZGVyIHNwYW4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAyMHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4pOwogICAgbGV0dGVyLXNwYWNpbmc6IDNweDsKfQoKI3NldHRpbmdzLWNsb3NlIHsKICAgIHdpZHRoOiAzMHB4OwogICAgaGVpZ2h0OiAzMHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgI2ZmNDQ0NDsKICAgIGJhY2tncm91bmQ6IHJnYmEoNTAsIDAsIDAsIDAuNSk7CiAgICBjb2xvcjogI2ZmNDQ0NDsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwp9Cgojc2V0dGluZ3MtY2xvc2U6aG92ZXIgewogICAgYmFja2dyb3VuZDogI2ZmNDQ0NDsKICAgIGNvbG9yOiB3aGl0ZTsKfQoKLnNldHRpbmdzLWNvbnRlbnQgewogICAgcGFkZGluZzogMjBweDsKfQoKLnNldHRpbmctcm93IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogMTVweDsKICAgIHBhZGRpbmc6IDEwcHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuMyk7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7Cn0KCi5zZXR0aW5nLXJvdyBsYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjY2NjOwp9Cgouc2V0dGluZy1yb3cgaW5wdXRbdHlwZT0icmFuZ2UiXSB7CiAgICB3aWR0aDogMTAwcHg7CiAgICBhY2NlbnQtY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKfQoKLnNldHRpbmctcm93IGlucHV0W3R5cGU9ImNoZWNrYm94Il0gewogICAgd2lkdGg6IDIwcHg7CiAgICBoZWlnaHQ6IDIwcHg7CiAgICBhY2NlbnQtY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGN1cnNvcjogcG9pbnRlcjsKfQoKLyogLS0tIEdMQVJFIEFOSU1BVElPTiAtLS0gKi8KQGtleWZyYW1lcyBnbGFyZVBhc3MgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTEwMCUpIHJvdGF0ZSg0NWRlZyk7IH0KICAgIDMwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxMDAlKSByb3RhdGUoNDVkZWcpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDEwMCUpIHJvdGF0ZSg0NWRlZyk7IH0KfQoKLyogLS0tIFNUQVRVUyBUWVBFIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LWlubmVyLnN0YXR1cyB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjhweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGNvbG9yOiAjZmYwMGZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICNmZjAwZmYsIDJweCAycHggMCAjMDAwOwogICAgYW5pbWF0aW9uOiBzdGF0dXNQb3AgMS4ycyBlYXNlLW91dCBmb3J3YXJkczsKfQoKQGtleWZyYW1lcyBzdGF0dXNQb3AgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuNSkgdHJhbnNsYXRlWSgwKTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjMpIHRyYW5zbGF0ZVkoLTEwcHgpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApIHRyYW5zbGF0ZVkoLTQwcHgpOyBvcGFjaXR5OiAwOyB9Cn0KCi8qIC0tLSBHT0FMIFRZUEUgRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtaW5uZXIuZ29hbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogNDhweDsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmIDAlLCAjZmZkNzAwIDUwJSwgI2ZmODgwMCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDRweCA0cHggcmdiYSgwLDAsMCwwLjkpKTsKICAgIGFuaW1hdGlvbjogZ29hbFBvcCAxcyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSkgZm9yd2FyZHM7Cn0KCkBrZXlmcmFtZXMgZ29hbFBvcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMCkgcm90YXRlKC0xMGRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS41KSByb3RhdGUoNWRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMikgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9Cn0KCi8qIC0tLSBERUZBVUxUIFRZUEUgRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtaW5uZXIuZGVmYXVsdCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDJweCA0cHggcmdiYSgwLDAsMCwwLjgpOwogICAgYW5pbWF0aW9uOiBmbG9hdFVwIDAuOHMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCi8qIC0tLSBNT0JJTEUgUE9SVFJBSVQgT1BUSU1JWkFUSU9OUyAtLS0gKi8KQG1lZGlhIHNjcmVlbiBhbmQgKG9yaWVudGF0aW9uOiBwb3J0cmFpdCkgYW5kIChtYXgtd2lkdGg6IDYwMHB4KSB7CiAgICAudGVhbS13aW5nIHsgd2lkdGg6IDkwcHg7IHBhZGRpbmc6IDAgNXB4OyB9CiAgICAuc2NvcmUtYm94IHsgZm9udC1zaXplOiAyNHB4OyBtYXJnaW46IDAgNXB4OyB9CiAgICAudGVhbS1uYW1lIHsgZm9udC1zaXplOiAxMHB4OyB9CiAgICAudGVhbS1zdWIgeyBkaXNwbGF5OiBub25lOyB9CiAgICAKICAgIC50aW1lci1jcnlzdGFsLXJpbmcgeyB3aWR0aDogODBweDsgaGVpZ2h0OiA0MHB4OyB0b3A6IC0xNXB4OyB9CiAgICAjdGltZXItZGlzcGxheSB7IGZvbnQtc2l6ZTogMjhweDsgfQogICAgCiAgICAjbWluaW1hcC1jb250YWluZXIgeyB3aWR0aDogOTBweDsgaGVpZ2h0OiA5MHB4OyB9CiAgICAjbWluaW1hcCB7IHdpZHRoOiA4MHB4OyBoZWlnaHQ6IDgwcHg7IH0KICAgIC5yYWRhci1sYWJlbCB7IGZvbnQtc2l6ZTogMTBweDsgfQogICAgCiAgICAudGVjaC10ZXh0IHsgZm9udC1zaXplOiAyNHB4OyB9CiAgICAKICAgICNhY3Rpb24tYnV0dG9uIHsgd2lkdGg6IDgwcHg7IGhlaWdodDogODBweDsgfQogICAgLmNvbW1hbmQtcmluZyB7IHdpZHRoOiAxMDBweDsgaGVpZ2h0OiAxMDBweDsgfQogICAgI2FjdGlvbi1sYWJlbCB7IGZvbnQtc2l6ZTogMTBweDsgcGFkZGluZzogMnB4IDhweDsgfQogICAgCiAgICAjcGxheWVyLXN0YXR1cy1wYW5lbCB7IHdpZHRoOiAxMzBweDsgYm90dG9tOiBtYXgoMTQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSArIDIwcHgpOyB9CiAgICAuY2hhci1uYW1lIHsgZm9udC1zaXplOiAxNHB4OyB9CiAgICAKICAgICNhdXRvLXRvZ2dsZSwgI3NldHRpbmdzLWJ1dHRvbiwgI3ByYWN0aWNlLXJlc3RvcmUtYnRuIHsKICAgICAgICB3aWR0aDogOTBweDsKICAgICAgICBmb250LXNpemU6IDlweDsKICAgICAgICByaWdodDogbWF4KDEwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIH0KICAgIAogICAgI2dvYWwtZGlzdGFuY2UtY29udGFpbmVyIHsgbGVmdDogbWF4KDEwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtbGVmdCkpOyB9CiNnb2FsLWRpc3RhbmNlIHsgZm9udC1zaXplOiAxOHB4OyB9Cn0KCi8qIC0tLSBHRVNUVVJFIEhJTlQgLS0tICovCiNnZXN0dXJlLWhpbnQgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDIwMHB4OyBoZWlnaHQ6IDMwMHB4OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMjUwMDsKICAgIG9wYWNpdHk6IDAuOTsKfQoKI2dlc3R1cmUtaGludC5hY3RpdmUgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7Cn0KCi5jdXJ2ZS1hcnJvdyB7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA1cHggIzAwZmZmZik7CiAgICBhbmltYXRpb246IGRhc2hEcmF3IDEuNXMgbGluZWFyIGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIGRhc2hEcmF3IHsKICAgIHRvIHsgc3Ryb2tlLWRhc2hvZmZzZXQ6IC0zMDsgfQp9CgouZ2VzdHVyZS10ZXh0IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKICAgIG1hcmdpbi10b3A6IC01MHB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCi5nZXN0dXJlLWhhbmQgewogICAgZm9udC1zaXplOiA0OHB4OwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAyMHB4OwogICAgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgYW5pbWF0aW9uOiBoYW5kU3dpcGUgMS41cyBlYXNlLWluLW91dCBpbmZpbml0ZTsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggYmxhY2spOwp9CgpAa2V5ZnJhbWVzIGhhbmRTd2lwZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIDUwcHgpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgb3BhY2l0eTogMTsgfQogICAgODAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMjBweCwgLTEwMHB4KSByb3RhdGUoMjBkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMHB4LCAtMTIwcHgpIHJvdGF0ZSgxMGRlZyk7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIFNXSVBFIFRSQUlMIChJTlRVSVRJVkUgRkVFREJBQ0spIC0tLSAqLwouc3dpcGUtdHJhaWwtZG90IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxMnB4OwogICAgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgIzAwZmZmZiAwJSwgcmdiYSgwLCAyNTUsIDI1NSwgMCkgNzAlKTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogOTAwMDsKICAgIGFuaW1hdGlvbjogZmFkZVRyYWlsIDAuNXMgbGluZWFyIGZvcndhcmRzOwogICAgbWl4LWJsZW5kLW1vZGU6IHNjcmVlbjsKfQoKQGtleWZyYW1lcyBmYWRlVHJhaWwgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjIpOyBvcGFjaXR5OiAwOyB9Cn0KQGtleWZyYW1lcyBmYWRlVHJhaWwgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjIpOyBvcGFjaXR5OiAwOyB9Cn0KCi8qIC0tLSBPRkZTQ1JFRU4gSU5ESUNBVE9SIC0tLSAqLwojb2Zmc2NyZWVuLWluZGljYXRvciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogNDBweDsgaGVpZ2h0OiA0MHB4OwogICAgbWFyZ2luLWxlZnQ6IC0yMHB4OyBtYXJnaW4tdG9wOiAtMjBweDsKICAgIHotaW5kZXg6IDE1MDA7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA1cHggIzAwMCk7Cn0KCiNvZmZzY3JlZW4taW5kaWNhdG9yIC5hcnJvdyB7CiAgICB3aWR0aDogMDsgaGVpZ2h0OiAwOwogICAgYm9yZGVyLWxlZnQ6IDE1cHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItcmlnaHQ6IDE1cHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItYm90dG9tOiAyNXB4IHNvbGlkICMwMGZmMDA7IC8qIEdyZWVuIGZvciBwbGF5ZXIgKi8KICAgIGFuaW1hdGlvbjogcHVsc2VBcnJvdyAwLjVzIGluZmluaXRlIGFsdGVybmF0ZTsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGNlbnRlciBib3R0b207Cn0KCkBrZXlmcmFtZXMgcHVsc2VBcnJvdyB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgZmlsdGVyOiBicmlnaHRuZXNzKDEpOyB9CiAgICB0byB7IHRyYW5zZm9ybTogc2NhbGUoMS4yKTsgZmlsdGVyOiBicmlnaHRuZXNzKDEuNSk7IH0KfQ==","/style.css":"data:text/css;base64,OnJvb3QgewogICAgLS1mZngtYmx1ZS1kZWVwOiAjMDIwNDA4OwogICAgLS1mZngtYmx1ZS1kYXJrOiAjMGExNTI1OwogICAgLS1mZngtYmx1ZS1taWQ6ICMxNTJhNDU7CiAgICAtLWZmeC1ibHVlLWxpZ2h0OiAjMmE0ZDc1OwogICAgLS1mZngtY3lhbjogIzYwYzBkMDsKICAgIC0tZmZ4LWN5YW4tZ2xvdzogIzAwZmZmZjsKICAgIC0tZmZ4LWdvbGQ6ICNjOGIwNjA7CiAgICAtLWZmeC1nb2xkLWxpZ2h0OiAjZjBlMDkwOwogICAgLS1mZngtZ29sZC1kYXJrOiAjOGE3MDMwOwogICAgLS1mZngtZ2xhc3MtYmc6IHJnYmEoMTAsIDIwLCA0MCwgMC43NSk7CiAgICAtLWZmeC1nbGFzcy1ib3JkZXI6IHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIAogICAgLS1mb250LXRpdGxlOiAnR2FyYW1vbmQnLCAnVGltZXMgTmV3IFJvbWFuJywgc2VyaWY7CiAgICAtLWZvbnQtZGF0YTogJ0ltcGFjdCcsICdBcmlhbCBOYXJyb3cnLCBzYW5zLXNlcmlmOwogICAgLS1mb250LXVpOiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAtLWZvbnQtc3BpcmE6ICdTcGlyYScsICdJbXBhY3QnLCBzYW5zLXNlcmlmOwp9CgpAZm9udC1mYWNlIHsKICAgIGZvbnQtZmFtaWx5OiAnU3BpcmEnOwogICAgc3JjOiB1cmwoJ2h0dHBzOi8vZmlsZXMuY2F0Ym94Lm1vZS96eW43czMudHRmJykgZm9ybWF0KCd0cnVldHlwZScpOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgIGZvbnQtc3R5bGU6IG5vcm1hbDsKfQoKaHRtbCwgYm9keSB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB3aWR0aDogMTAwdnc7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBwb3NpdGlvbjogZml4ZWQ7IAogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHJpZ2h0OiAwOwogICAgYm90dG9tOiAwOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBjb2xvcjogd2hpdGU7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICBwYWRkaW5nLXRvcDogZW52KHNhZmUtYXJlYS1pbnNldC10b3ApOwogICAgcGFkZGluZy1ib3R0b206IGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKTsKICAgIHBhZGRpbmctbGVmdDogZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KTsKICAgIHBhZGRpbmctcmlnaHQ6IGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpOwp9CgoqIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7Cn0KCi8qIC0tLSBNQUlOIEdBTUUgQ09OVEFJTkVSIC0tLSAqLwojZ2FtZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgbWF4LXdpZHRoOiBub25lOwogICAgYmFja2dyb3VuZDogIzAwMDUxMDsKICAgIGJveC1zaGFkb3c6IG5vbmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgdHJhbnNpdGlvbjogZmlsdGVyIDAuMDVzOwogICAgei1pbmRleDogMTsKfQoKLyogLS0tIElNUEFDVCBGWCAtLS0gKi8KI2dhbWUtY29udGFpbmVyLmltcGFjdC1meCB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuMXMgZWFzZS1pbi1vdXQ7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDEuMikgYnJpZ2h0bmVzcygxLjEpOwp9CgojZ2FtZS1jb250YWluZXIuaW1wYWN0LWhlYXZ5IHsKICAgIGFuaW1hdGlvbjogaW1wYWN0U2hha2UgMC4ycyBlYXNlLWluLW91dDsKICAgIGZpbHRlcjogY29udHJhc3QoMS41KSBicmlnaHRuZXNzKDEuMykgc2VwaWEoMC40KSBodWUtcm90YXRlKC0xMGRlZyk7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3Qtc2hhdHRlciB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuNHMgZWFzZS1pbi1vdXQ7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDIuMCkgaW52ZXJ0KDAuMSkgc2F0dXJhdGUoMi4wKTsKfQoKQGtleWZyYW1lcyBpbXBhY3RTaGFrZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDAsIDApOyB9CiAgICAyNSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNXB4LCA1cHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSg1cHgsIC01cHgpOyB9CiAgICA3NSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNXB4LCAtNXB4KTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDAsIDApOyB9Cn0KCi8qIC0tLSBDQU5WQVMgJiBSRU5ERVIgLS0tICovCmNhbnZhcyB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsKICAgIGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGltYWdlLXJlbmRlcmluZzogcGl4ZWxhdGVkOyAKICAgIHotaW5kZXg6IDA7Cn0KCi8qIC0tLSBHSUYgT1ZFUkxBWSAtLS0gKi8KI3NjcmVlbi1vdmVybGF5LWdpZiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgb2JqZWN0LWZpdDogY292ZXI7CiAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKICAgIG9wYWNpdHk6IDEuMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogOTUwOwogICAgaW1hZ2UtcmVuZGVyaW5nOiBwaXhlbGF0ZWQ7Cn0KCiN1aS1sYXllciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgei1pbmRleDogMTAwMDsKfQoKLyogLS0tIENJTkVNQVRJQyBCQVJTIC0tLSAqLwojY2luZW1hdGljLWJhcnMgLmJhciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAwOwogICAgYmFja2dyb3VuZDogYmxhY2s7CiAgICB0cmFuc2l0aW9uOiBoZWlnaHQgMC41cyBlYXNlOwogICAgei1pbmRleDogODAwOwp9CiNjaW5lbWF0aWMtYmFycyAuYmFyLnRvcCB7IHRvcDogMDsgfQojY2luZW1hdGljLWJhcnMgLmJhci5ib3R0b20geyBib3R0b206IDA7IH0KCi8qIC0tLSBURUNIIEZMQVNIIE9WRVJMQVkgLS0tICovCiN0ZWNoLWZsYXNoLW92ZXJsYXkgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAyMCU7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEyMHB4OwogICAgZGlzcGxheTogbm9uZTsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwwLDAsMCkgMCUsIHJnYmEoMCwgMjAsIDYwLCAwLjkpIDIwJSwgcmdiYSgwLCAyMCwgNjAsIDAuOSkgODAlLCByZ2JhKDAsMCwwLDApIDEwMCUpOwogICAgei1pbmRleDogMjIwMDsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigycHgpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMTAwLCAyNTUsIDI1NSwgMC4zKTsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDEwMCwgMjU1LCAyNTUsIDAuMyk7CiAgICBhbmltYXRpb246IGZsYXNoRW50ZXIgMC4xNXMgZWFzZS1vdXQ7Cn0KCkBrZXlmcmFtZXMgZmxhc2hFbnRlciB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiBzY2FsZVkoMCk7IG9wYWNpdHk6IDA7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZVkoMSk7IG9wYWNpdHk6IDE7IH0KfQoKLnRlY2gtY29udGVudC13cmFwcGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goLTEwZGVnKTsKfQoKLnRlY2gtdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IGNsYW1wKDI4cHgsIDEwdncsIDQycHgpOwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZiwgMCAwIDIwcHggIzAwMDBmZjsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7CiAgICBtYXJnaW4tYm90dG9tOiAycHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBhbmltYXRpb246IGJsaW5rVGV4dCAwLjA4cyBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCi50ZWNoLXN1Yi10ZXh0IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjMDBmZmZmOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjUpOwp9CgoudGVjaC10aW1lci10cmFjayB7CiAgICB3aWR0aDogMjUwcHg7CiAgICBoZWlnaHQ6IDhweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC42KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggcmdiYSgwLDAsMCwwLjUpOwp9CgoudGVjaC10aW1lci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmZmZiwgIzAwZmZmZik7CiAgICB3aWR0aDogMTAwJTsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGxlZnQ7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwp9CgpAa2V5ZnJhbWVzIGJsaW5rVGV4dCB7CiAgICBmcm9tIHsgb3BhY2l0eTogMC44OyB0ZXh0LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOyB0cmFuc2Zvcm06IHNjYWxlKDEpOyB9CiAgICB0byB7IG9wYWNpdHk6IDEuMDsgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICNmZmZmZmYsIDAgMCAxMHB4ICMwMGZmZmY7IHRyYW5zZm9ybTogc2NhbGUoMS4wMik7IH0KfQoKLyogLS0tIEhVRCBUT1AgLS0tICovCiNodWQtdG9wIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsKICAgIGxlZnQ6IDA7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgYWxpZ24taXRlbXM6IGZsZXgtc3RhcnQ7CiAgICB3aWR0aDogMTAwJTsKICAgIHBhZGRpbmc6IDE1cHg7CiAgICBwYWRkaW5nLXRvcDogbWF4KDE1cHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSk7CiAgICBwYWRkaW5nLWxlZnQ6IG1heCgxNXB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQpKTsKICAgIHBhZGRpbmctcmlnaHQ6IG1heCgxNXB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgcmdiYSgwLCA1LCAxNSwgMC45KSAwJSwgcmdiYSgwLDAsMCwwKSAxMDAlKTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgoudGVhbS13aW5nIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgd2lkdGg6IDEzMHB4OwogICAgaGVpZ2h0OiA1MHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE2MGRlZywgdmFyKC0tZmZ4LWJsdWUtbWlkKSAwJSwgdmFyKC0tZmZ4LWJsdWUtZGVlcCkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3JkZXItdG9wOiAycHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpOwogICAgYm94LXNoYWRvdzogMCA1cHggMTVweCByZ2JhKDAsIDAsIDAsIDAuNSk7CiAgICBwYWRkaW5nOiAwIDEwcHg7Cn0KCi50ZWFtLXdpbmcuYXdheSB7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDE1ZGVnKTsKICAgIGZsZXgtZGlyZWN0aW9uOiByb3ctcmV2ZXJzZTsKICAgIGJvcmRlci10b3AtY29sb3I6ICNmZjY2NjY7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoLTE2MGRlZywgIzJhMTAxMCAwJSwgIzEwMDUwNSAxMDAlKTsKfQoKLnRlYW0tZGF0YSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZyk7Cn0KLnRlYW0td2luZy5hd2F5IC50ZWFtLWRhdGEgeyB0cmFuc2Zvcm06IHNrZXdYKC0xNWRlZyk7IHRleHQtYWxpZ246IHJpZ2h0OyB9CgoudGVhbS1uYW1lIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZC1saWdodCk7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIHRleHQtc2hhZG93OiAwIDJweCAycHggcmdiYSgwLDAsMCwwLjgpOwp9Ci50ZWFtLXN1YiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBvcGFjaXR5OiAwLjg7Cn0KLnRlYW0td2luZy5hd2F5IC50ZWFtLXN1YiB7IGNvbG9yOiAjZmZhYWFhOyB9Cgouc2NvcmUtYm94IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzOHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4IHZhcigtLWZmeC1jeWFuLWdsb3cpOwogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZyk7CiAgICBtYXJnaW46IDAgMTBweDsKfQoudGVhbS13aW5nLmF3YXkgLnNjb3JlLWJveCB7IHRyYW5zZm9ybTogc2tld1goLTE1ZGVnKTsgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICNmZjQ0NDQ7IH0KCi50aW1lci1jb21wbGV4IHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG1hcmdpbi10b3A6IC01cHg7Cn0KCi50aW1lci1jcnlzdGFsLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtMjVweDsKICAgIHdpZHRoOiAxMjBweDsKICAgIGhlaWdodDogNjBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlci10b3A6IDNweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3gtc2hhZG93OiAwIC01cHggMTVweCByZ2JhKDIwMCwgMTgwLCAxMDAsIDAuMyk7CiAgICB6LWluZGV4OiAtMTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChlbGxpcHNlIGF0IHRvcCwgcmdiYSgyMCwgNDAsIDgwLCAwLjgpLCB0cmFuc3BhcmVudCA3MCUpOwp9CgojaGFsZi1pbmRpY2F0b3IgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG1hcmdpbi1ib3R0b206IC0ycHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtZ29sZC1kYXJrKTsKfQoKI3RpbWVyLWRpc3BsYXkgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmIDAlLCAjZmZkNzAwIDUwJSwgI2I4ODYwYiAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygycHggMnB4IDBweCByZ2JhKDAsMCwwLDAuOCkpOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKLyogLS0tIFBMQVlFUiBTVEFUVVMgUEFORUwgLS0tICovCiNwbGF5ZXItc3RhdHVzLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyA0MHB4KTsKICAgIGxlZnQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQpKTsKICAgIHdpZHRoOiAxNjBweDsKICAgIHBhZGRpbmc6IDEwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMTAsIDMwLCAwLjgpIDAlLCByZ2JhKDAsMCwwLDApIDEwMCUpOwogICAgYm9yZGVyLWxlZnQ6IDNweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiAwIDEwcHggMTBweCAwOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7Cn0KCi5jaGFyLW5hbWUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAxOHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKICAgIHRyYW5zZm9ybTogc2tld1goMTBkZWcpOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwp9CgouaHAtZ2F1Z2UtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogNHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7Cn0KLmhwLWxhYmVsIHsgZm9udC1zaXplOiAxMHB4OyBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOyB3aWR0aDogMjBweDsgfQouaHAtYmFyLXRyYWNrIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGhlaWdodDogNnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIG1hcmdpbjogMCA1cHg7Cn0KLmhwLWJhci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgIzAwZmYwMCwgI2NjZmZjYyk7CiAgICBib3gtc2hhZG93OiAwIDAgNXB4ICMwMGZmMDA7Cn0KLmhwLXZhbHVlIHsgZm9udC1zaXplOiAxMHB4OyBjb2xvcjogI2ZmZjsgd2lkdGg6IDQ1cHg7IHRleHQtYWxpZ246IHJpZ2h0OyB9CgoudGVjaC1nYXVnZS1jb250YWluZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDEwZGVnKTsKfQoudGVjaC1sYWJlbCB7IGZvbnQtc2l6ZTogMTBweDsgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsgd2lkdGg6IDIwcHg7IH0KLnRlY2gtYmFyLXRyYWNrIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGhlaWdodDogNHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIG1hcmdpbjogMCA1cHg7Cn0KLnRlY2gtYmFyLWZpbGwgewogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjZmZhYTAwLCAjZmZmZmFhKTsKfQoKLyogLS0tIE1JTklNQVAgLS0tICovCiNtaW5pbWFwLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg4MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA2MHB4KTsKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgaGVpZ2h0OiAxMTBweDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7Cn0KCi5yYWRhci1yaW0gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHZhcigtLWZmeC1ibHVlLWxpZ2h0KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHZhcigtLWZmeC1ibHVlLW1pZCksIGluc2V0IDAgMCAyMHB4IHJnYmEoMCwwLDAsMC44KTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMCwgMjAsIDYwLCAwLjQpIDAlLCByZ2JhKDAsIDUsIDEwLCAwLjgpIDEwMCUpOwogICAgei1pbmRleDogNTsKfQoKI21pbmltYXAgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgd2lkdGg6IDEwMHB4OwogICAgaGVpZ2h0OiAxMDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHotaW5kZXg6IDY7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgoucmFkYXItbGFiZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAtMTVweDsKICAgIHdpZHRoOiAxNDAlOwogICAgbGVmdDogLTIwJTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4pOwp9CgoubWFwLWRvdCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB3aWR0aDogNnB4OyBoZWlnaHQ6IDZweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgYm94LXNoYWRvdzogMCAwIDRweCBjdXJyZW50Q29sb3I7Cn0KLm1hcC1kb3QuaG9tZSB7IGJhY2tncm91bmQ6IHZhcigtLWZmeC1jeWFuKTsgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsgfQoubWFwLWRvdC5hd2F5IHsgYmFja2dyb3VuZDogI2ZmNDQ0NDsgY29sb3I6ICNmZjQ0NDQ7IH0KLm1hcC1kb3QuYmFsbCB7IAogICAgYmFja2dyb3VuZDogI2ZmMDBjYzsKICAgIGNvbG9yOiAjZmYwMGNjOyAKICAgIHdpZHRoOiAxMnB4OyBoZWlnaHQ6IDEycHg7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjZmZmZmZmOwogICAgei1pbmRleDogMjA7CiAgICBhbmltYXRpb246IGJsaW5rQmFsbCAwLjNzIGluZmluaXRlIGFsdGVybmF0ZTsKICAgIGJveC1zaGFkb3c6IDAgMCA2cHggI2ZmMDBjYzsKfQoubWFwLWRvdC5uYXAgeyBiYWNrZ3JvdW5kOiAjMzMzOyBjb2xvcjogIzAwMDsgYm9yZGVyOiAxcHggc29saWQgIzU1NTsgfQoubWFwLWRvdC5hY3RpdmUtcGxheWVyIHsgCiAgICBiYWNrZ3JvdW5kOiAjMDBmZjAwICFpbXBvcnRhbnQ7IAogICAgY29sb3I6ICMwMGZmMDAgIWltcG9ydGFudDsgCiAgICBib3gtc2hhZG93OiAwIDAgOHB4ICMwMGZmMDA7CiAgICB6LWluZGV4OiAxNTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuMik7Cn0KLm1hcC1kb3QuYmFsbC1jYXJyaWVyIHsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4ICNmZmYsIDAgMCAzMHB4ICNmZmFhMDA7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjZmZmZmZmOwogICAgYmFja2dyb3VuZC1jb2xvcjogI2ZmYWEwMCAhaW1wb3J0YW50OwogICAgei1pbmRleDogMTAwOwogICAgd2lkdGg6IDEwcHg7IGhlaWdodDogMTBweDsKICAgIGFuaW1hdGlvbjogY2FycmllclB1bHNlIDAuOHMgaW5maW5pdGUgYWx0ZXJuYXRlOwp9CkBrZXlmcmFtZXMgY2FycmllclB1bHNlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjIpOyBib3gtc2hhZG93OiAwIDAgMTBweCAjZmZmOyBvcGFjaXR5OiAwLjg7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS44KTsgYm94LXNoYWRvdzogMCAwIDI1cHggI2ZmY2MwMDsgb3BhY2l0eTogMS4wOyB9Cn0KQGtleWZyYW1lcyBibGlua0JhbGwgeyBmcm9tIHsgb3BhY2l0eTogMTsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IH0gdG8geyBvcGFjaXR5OiAwLjU7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuMyk7IH0gfQoKLyogLS0tIEFOTk9VTkNFTUVOVFMgLS0tICovCiNhbm5vdW5jZW1lbnQgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA0MCU7IAogICAgbGVmdDogNSU7IAogICAgd2lkdGg6IDkwJTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiBjbGFtcCg0MHB4LCAxMnZ3LCA3MnB4KTsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICB3aGl0ZS1zcGFjZTogbm9ybWFsOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZiAwJSwgI2ZmZDcwMCA0MCUsICNiODg2MGIgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggcmdiYSgyNTUsIDEwMCwgMCwgMC41KSkgZHJvcC1zaGFkb3coM3B4IDNweCAwICMwMDApOwogICAgZGlzcGxheTogbm9uZTsKICAgIHotaW5kZXg6IDIwMDA7CiAgICBhbmltYXRpb246IGFubm91bmNlU2xpZGUgMC41cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKQGtleWZyYW1lcyBhbm5vdW5jZVNsaWRlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHNjYWxlKDApIHJvdGF0ZSgtNWRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZSgxKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDE7IH0KfQoKLyogLS0tIEpPWVNUSUNLIC0tLSAqLwojam95c3RpY2staGl0LXpvbmUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDUwJTsgaGVpZ2h0OiA1MCU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwKTsgCiAgICB0b3VjaC1hY3Rpb246IG5vbmU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKfQoKI2pveXN0aWNrLXZpc3VhbC1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDA7IGhlaWdodDogMDsKICAgIG92ZXJmbG93OiB2aXNpYmxlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMTEwMDsKfQoKI2pveXN0aWNrLWJhc2UgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDEyMHB4OyBoZWlnaHQ6IDEyMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgwLCA0MCwgODAsIDAuNCkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjEpIDYwJSwgdHJhbnNwYXJlbnQgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDEwMCwgMjIwLCAyNTUsIDAuMyk7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpLCBpbnNldCAwIDAgMzBweCByZ2JhKDAsIDUwLCAxMDAsIDAuMyk7CiAgICBhbmltYXRpb246IGJhc2VQdWxzZSAycyBpbmZpbml0ZSBhbHRlcm5hdGU7Cn0KCkBrZXlmcmFtZXMgYmFzZVB1bHNlIHsKICAgIGZyb20geyBib3gtc2hhZG93OiAwIDAgMTBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpOyBib3JkZXItY29sb3I6IHJnYmEoMTAwLCAyMjAsIDI1NSwgMC4yKTsgfQogICAgdG8geyBib3gtc2hhZG93OiAwIDAgMjVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjUpOyBib3JkZXItY29sb3I6IHJnYmEoMTAwLCAyNTUsIDI1NSwgMC42KTsgfQp9Cgojam95c3RpY2sta25vYiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogNTBweDsgaGVpZ2h0OiA1MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzMCUgMzAlLCAjZTBmZmZmIDAlLCAjMDBhYWZmIDQwJSwgIzAwNDQ4OCA4MCUsICMwMDExMjIgMTAwJSk7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjODhjY2ZmOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggIzAwZmZmZiwgaW5zZXQgMCAwIDEwcHggcmdiYSgyNTUsMjU1LDI1NSwwLjgpOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMDVzIGxpbmVhcjsKfQoKI2pveXN0aWNrLWtub2I6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICIiOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAyMCU7IGxlZnQ6IDIwJTsgd2lkdGg6IDIwJTsgaGVpZ2h0OiAyMCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAjZmZmZmZmIDAlLCB0cmFuc3BhcmVudCA3MCUpOwogICAgZmlsdGVyOiBibHVyKDJweCk7CiAgICBvcGFjaXR5OiAwLjg7Cn0KCi50b3VjaC1yaXBwbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgyMDAsIDI1NSwgMjU1LCAwLjgpIDAlLCByZ2JhKDAsIDI1NSwgMjU1LCAwLjQpIDQwJSwgdHJhbnNwYXJlbnQgNzAlKTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDApOwogICAgYW5pbWF0aW9uOiByaXBwbGVBbmltIDAuNnMgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDkwMDA7CiAgICBtaXgtYmxlbmQtbW9kZTogc2NyZWVuOwp9CgpAa2V5ZnJhbWVzIHJpcHBsZUFuaW0gewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgwKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDMuMCk7IG9wYWNpdHk6IDA7IH0KfQoKI2NhbWVyYS16b25lIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgcmlnaHQ6IDA7IHdpZHRoOiA1MCU7IGhlaWdodDogMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdG91Y2gtYWN0aW9uOiBub25lOwogICAgei1pbmRleDogNTA7Cn0KCi8qIC0tLSBBQ1RJT04gQlVUVE9OIC0tLSAqLwojYWN0aW9uLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCg0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOyAKICAgIHJpZ2h0OiBtYXgoNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB6LWluZGV4OiAxMDA7Cn0KCi5jb21tYW5kLW1lbnUtYmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDE4MHB4OyBoZWlnaHQ6IDgwcHg7CiAgICBib3R0b206IDE1cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHRyYW5zcGFyZW50IDAlLCByZ2JhKDAsIDEwLCAzMCwgMC44KSA1MCUsIHRyYW5zcGFyZW50IDEwMCUpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMCwgMjAwLCAyNTUsIDAuMyk7CiAgICB6LWluZGV4OiAtMTsKfQoKLmNvbW1hbmQtcmluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMTMwcHg7IGhlaWdodDogMTMwcHg7CiAgICBib3JkZXI6IDJweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7CiAgICBib3JkZXItdG9wOiAycHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC42KTsKICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCByZ2JhKDAsIDI1NSwgMjU1LCAwLjYpOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYW5pbWF0aW9uOiBzcGluUmV2ZXJzZSAxNXMgbGluZWFyIGluZmluaXRlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpOwp9CkBrZXlmcmFtZXMgc3BpblJldmVyc2UgeyBmcm9tIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgcm90YXRlKDM2MGRlZyk7IH0gdG8geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSByb3RhdGUoMGRlZyk7IH0gfQoKI2FjdGlvbi1sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCA1LCAxMCwgMC44KTsKICAgIHBhZGRpbmc6IDRweCAxMnB4OwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwogICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMCwwLDAsMC44KTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjNzOwp9CgojYWN0aW9uLWJ1dHRvbiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwcHg7IGhlaWdodDogMTAwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4xcywgZmlsdGVyIDAuM3M7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZmZmZmYgMCUsICMwMDg4ZmYgNDAlLCAjMDAyMjY2IDgwJSwgIzAwMCAxMDAlKTsKICAgIGJvcmRlcjogM3B4IHNvbGlkICM0NGFhZmY7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjgpLCBpbnNldCAwIDAgMjBweCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNCk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICB6LWluZGV4OiAxMDsKfQoKI3Bhc3MtYnV0dG9uIHsKICAgIGRpc3BsYXk6IG5vbmUgIWltcG9ydGFudDsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogLTIwcHg7IGxlZnQ6IC0zMHB4OwogICAgd2lkdGg6IDYwcHg7IGhlaWdodDogNjBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHotaW5kZXg6IDk7Cn0KCiNhY3Rpb24tYnV0dG9uOjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC00MHB4OyBsZWZ0OiAtNDBweDsgcmlnaHQ6IC00MHB4OyBib3R0b206IC00MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgei1pbmRleDogMTA7Cn0KCiNhY3Rpb24tYnV0dG9uOmFjdGl2ZSB7IHRyYW5zZm9ybTogc2NhbGUoMC45Mik7IH0KCiNhY3Rpb24tYnV0dG9uIC5idG4tdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDIycHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDJweCA0cHggcmdiYSgwLDAsMCwwLjgpLCAwIDAgMTBweCByZ2JhKDI1NSwyNTUsMjU1LDAuNSk7CiAgICB6LWluZGV4OiA1OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgojYWN0aW9uLWJ1dHRvbiAuYnRuLWdsYXJlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwJTsgbGVmdDogLTUwJTsgd2lkdGg6IDIwMCU7IGhlaWdodDogMjAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg0NWRlZywgdHJhbnNwYXJlbnQgNDAlLCByZ2JhKDI1NSwyNTUsMjU1LDAuNCkgNTAlLCB0cmFuc3BhcmVudCA2MCUpOwogICAgYW5pbWF0aW9uOiBnbGFyZVBhc3MgNXMgaW5maW5pdGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDY7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7Cn0KCi5saW1pdC1yaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTVweDsgbGVmdDogLTVweDsgcmlnaHQ6IC01cHg7IGJvdHRvbTogLTVweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHRyYW5zcGFyZW50OwogICAgYm94LXNoYWRvdzogMCAwIDAgdHJhbnNwYXJlbnQ7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC41czsKICAgIHotaW5kZXg6IDE7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKI2FjdGlvbi1idXR0b24uc2hvb3QtbW9kZSB7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZmZmYWEgMCUsICNmZmFhMDAgNDAlLCAjODgyMjAwIDgwJSwgIzIyMDAwMCAxMDAlKTsKICAgIGJvcmRlci1jb2xvcjogI2ZmY2MwMDsKICAgIGJveC1zaGFkb3c6IDAgMCAzMHB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuOCksIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCAyNTUsIDAsIDAuNSk7Cn0KCiNhY3Rpb24tYnV0dG9uLmxpbWl0LXJlYWR5IC5saW1pdC1yaW5nIHsKICAgIGJvcmRlci1jb2xvcjogI2ZmZGQ0NDsKICAgIGFuaW1hdGlvbjogbGltaXRQdWxzZSAwLjhzIGVhc2UtaW4tb3V0IGluZmluaXRlIGFsdGVybmF0ZTsKfQoKLnNob290LWxhYmVsIHsKICAgIGNvbG9yOiAjZmZkZDQ0ICFpbXBvcnRhbnQ7CiAgICBib3JkZXItY29sb3I6ICNmZmFhMDAgIWltcG9ydGFudDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmY0NDAwICFpbXBvcnRhbnQ7Cn0KCkBrZXlmcmFtZXMgbGltaXRQdWxzZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgYm94LXNoYWRvdzogMCAwIDEwcHggI2ZmYWEwMCwgaW5zZXQgMCAwIDVweCAjZmZhYTAwOyBvcGFjaXR5OiAwLjU7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMTUpOyBib3gtc2hhZG93OiAwIDAgMzBweCAjZmY0NDAwLCBpbnNldCAwIDAgMTVweCAjZmYwMDAwOyBvcGFjaXR5OiAxLjA7IH0KfQoKLyogLS0tIEFVVE8gVE9HR0xFIC0tLSAqLwojYXV0by10b2dnbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoMjAwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDYwcHgpOyAKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgcGFkZGluZzogMTBweCAwOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgwLCAyMCwgNDAsIDAuOCkgMCUsIHJnYmEoMCwgNSwgMTAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3JkZXItdG9wOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNHB4KTsKICAgIGJveC1zaGFkb3c6IDAgNXB4IDE1cHggcmdiYSgwLDAsMCwwLjMpOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIHotaW5kZXg6IDEwMDsKfQoKI2F1dG8tdG9nZ2xlOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjkpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggdmFyKC0tZmZ4LWN5YW4pOwogICAgY29sb3I6IHdoaXRlOwp9CgojYXV0by10b2dnbGUuYWN0aXZlIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMTAwLCAyMCwgMCwgMC44KSAwJSwgcmdiYSg0MCwgMCwgMCwgMC45KSAxMDAlKTsKICAgIGJvcmRlci1jb2xvcjogI2ZmNDQwMDsKICAgIGNvbG9yOiAjZmZhYTAwOwogICAgYW5pbWF0aW9uOiBwdWxzZVJlZCAycyBpbmZpbml0ZTsKfQpAa2V5ZnJhbWVzIHB1bHNlUmVkIHsgMCUgeyBib3gtc2hhZG93OiAwIDAgNXB4ICNmZjAwMDA7IH0gNTAlIHsgYm94LXNoYWRvdzogMCAwIDIwcHggI2ZmNDQwMDsgfSAxMDAlIHsgYm94LXNoYWRvdzogMCAwIDVweCAjZmYwMDAwOyB9IH0KCi8qIC0tLSBGTE9BVElORyBURVhUIC0tLSAqLwouZmxvYXRpbmctdGV4dC13cmFwcGVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogMjAwMDsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm07Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyIHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDI0cHg7IAogICAgdGV4dC1zaGFkb3c6IDFweCAxcHggMCAjMDAwOwogICAgb3BhY2l0eTogMC45Owp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5kYW1hZ2UgewogICAgZm9udC1zaXplOiA0MnB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZmZmZiAwJSwgI2ZmY2MwMCA0MCUsICNmZjQ0MDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCA0cHggNHB4IHJnYmEoMCwwLDAsMC44KSk7CiAgICBhbmltYXRpb246IHBvcERhbWFnZSAwLjhzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KSBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuaGVhbCB7CiAgICBmb250LXNpemU6IDM2cHg7CiAgICBjb2xvcjogIzQ0ZmY0NDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZjAwOwogICAgYW5pbWF0aW9uOiBmbG9hdFVwIDFzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci52ZW5vbSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGNvbG9yOiAjYWFmZjAwOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICM0NDg4MDAsIDJweCAycHggMCAjMDAyMjAwOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2NjZmY2NiAwJSwgIzY2Y2MwMCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgNXB4IHJnYmEoMTAwLCAyNTUsIDAsIDAuNSkpOwogICAgYW5pbWF0aW9uOiBkcmlwU3RhdHVzIDJzIGluZmluaXRlOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5zbGVlcCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTVweCAjMDA0NGZmLCAwIDAgMzBweCAjMDAwMGZmOwogICAgb3BhY2l0eTogMC45OwogICAgYW5pbWF0aW9uOiBkcmlmdFN0YXR1cyAzcyBlYXNlLWluLW91dCBpbmZpbml0ZTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIud2l0aGVyIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzOHB4OwogICAgY29sb3I6ICNjY2NjY2M7CiAgICB0ZXh0LXNoYWRvdzogMnB4IDJweCAwICM0NDQ0NDQ7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZWVlZWVlIDAlLCAjODg4ODg4IDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHdpdGhlclN0YXR1cyAxLjVzIGZvcndhcmRzOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci50ZWNoIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMzJweDsKICAgIGNvbG9yOiAjMDBmZmZmOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAxMCwgMzAsIDAuNyk7CiAgICBwYWRkaW5nOiAycHggMTBweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkICMwMGZmZmY7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjMDA4OGZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggI2ZmZjsKICAgIGFuaW1hdGlvbjogc2hha2VUZWNoIDAuNnMgZWFzZS1pbi1vdXQsIGZsYXNoVGVjaCAwLjNzOwogICAgdHJhbnNmb3JtLW9yaWdpbjogY2VudGVyOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5zYXZlLCAuZmxvYXRpbmctdGV4dC1pbm5lci5ibG9jayB7CiAgICBmb250LXNpemU6IDQ4cHg7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgY29sb3I6ICNmZmZmZmY7CiAgICAtd2Via2l0LXRleHQtc3Ryb2tlOiAxcHggIzAwNDQ4ODsKICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCAjMDA4OGZmOwogICAgYW5pbWF0aW9uOiBwb3BEYW1hZ2UgMC41cyBlYXNlLW91dCBmb3J3YXJkczsKfQoKQGtleWZyYW1lcyBwb3BEYW1hZ2UgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuNSk7IG9wYWNpdHk6IDA7IH0KICAgIDIwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS41KTsgb3BhY2l0eTogMTsgfQogICAgNDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgZmxvYXRVcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNTBweCk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyBkcmlwU3RhdHVzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZVkoMSk7IGZpbHRlcjogYmx1cigwcHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlWSgxLjEpIHRyYW5zbGF0ZVkoNXB4KTsgZmlsdGVyOiBibHVyKDFweCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlWSgxKTsgZmlsdGVyOiBibHVyKDBweCk7IH0KfQoKQGtleWZyYW1lcyBkcmlmdFN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIDIwJSB7IG9wYWNpdHk6IDE7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxNXB4KSB0cmFuc2xhdGVZKC0yMHB4KSByb3RhdGUoMTBkZWcpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0xNXB4KSB0cmFuc2xhdGVZKC01MHB4KSByb3RhdGUoLTEwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIHdpdGhlclN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IGZpbHRlcjogZ3JheXNjYWxlKDAlKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC42KTsgZmlsdGVyOiBncmF5c2NhbGUoMTAwJSk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyBzaGFrZVRlY2ggewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuOCk7IH0KICAgIDEwJSwgMzAlLCA1MCUsIDcwJSwgOTAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjEpIHRyYW5zbGF0ZSgtMnB4LCAycHgpOyB9CiAgICAyMCUsIDQwJSwgNjAlLCA4MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSkgdHJhbnNsYXRlKDJweCwgLTJweCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IH0KfQoKQGtleWZyYW1lcyBmbGFzaFRlY2ggewogICAgMCUgeyBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZmOyBjb2xvcjogIzAwMDsgYm9yZGVyLWNvbG9yOiAjZmZmOyB9CiAgICAxMDAlIHsgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgwLCAxMCwgMzAsIDAuODUpOyBjb2xvcjogIzAwZmZmZjsgYm9yZGVyLWNvbG9yOiAjMDBmZmZmOyB9Cn0KCiNsb2FkaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgIGFuaW1hdGlvbjogYmxpbmsgMXMgaW5maW5pdGU7Cn0KQGtleWZyYW1lcyBibGluayB7IDUwJSB7IG9wYWNpdHk6IDAuNTsgfSB9CgojY29udHJvbHMtaGludCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDEzMHB4OyB3aWR0aDogMTAwJTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiByZ2JhKDI1NSwyNTUsMjU1LDAuNCk7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmNvbWljLWltcGFjdCB7CiAgICBmb250LWZhbWlseTogJ0ltcGFjdCcsIHNhbnMtc2VyaWY7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBjb2xvcjogI2ZmZmYwMDsgCiAgICAtd2Via2l0LXRleHQtc3Ryb2tlOiAxcHggIzAwMDsKICAgIHRleHQtc2hhZG93OiAzcHggM3B4IDAgI2ZmMDAwMDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGNlbnRlcjsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICBhbmltYXRpb246IGNvbWljUG9wIDAuNHMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpIGZvcndhcmRzOwogICAgei1pbmRleDogMjUwMDsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuY29taWMtYWN0aW9uIHsKICAgIGZvbnQtZmFtaWx5OiAnQXJpYWwgQmxhY2snLCBzYW5zLXNlcmlmOwogICAgZm9udC1zaXplOiAyOHB4OwogICAgY29sb3I6ICMwMGZmZmY7IAogICAgLXdlYmtpdC10ZXh0LXN0cm9rZTogMXB4ICMwMDA7CiAgICB0ZXh0LXNoYWRvdzogMnB4IDJweCAwICMwMDQ0YWE7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgYW5pbWF0aW9uOiBjb21pY1NsaWRlIDAuNHMgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICB6LWluZGV4OiAyNTAwOwp9CgpAa2V5ZnJhbWVzIGNvbWljUG9wIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwKSByb3RhdGUoLTIwZGVnKTsgb3BhY2l0eTogMDsgfQogICAgNDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjIpIHJvdGF0ZSg1ZGVnKTsgb3BhY2l0eTogMTsgfQogICAgNjAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApIHJvdGF0ZSgtNWRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSkgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgY29taWNTbGlkZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC0yMHB4LCAyMHB4KSBzY2FsZSgwLjUpOyBvcGFjaXR5OiAwOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMjBweCwgLTIwcHgpIHNjYWxlKDEuMik7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIE1BSU4gTUVOVSAtLS0gKi8KI21haW4tbWVudSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDMwMDA7CiAgICBvcGFjaXR5OiAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuNXMgZWFzZS1pbi1vdXQ7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IGNlbnRlciwgcmdiYSgwLCAyMCwgNjAsIDAuMikgMCUsIHJnYmEoMCwgNSwgMTAsIDAuNSkgMTAwJSk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMnB4KTsKfQoKI21haW4tbWVudS5hY3RpdmUgewogICAgb3BhY2l0eTogMTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgoubWVudS1iZy1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IAogICAgICAgIGxpbmVhci1ncmFkaWVudChyZ2JhKDAsMCwwLDApIDUwJSwgcmdiYSgwLDAsMCwwLjEpIDUwJSksIAogICAgICAgIGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgyNTUsMCwwLDAuMDMpLCByZ2JhKDAsMjU1LDAsMC4wMSksIHJnYmEoMCwwLDI1NSwwLjAzKSk7CiAgICBiYWNrZ3JvdW5kLXNpemU6IDEwMCUgMnB4LCAzcHggMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogLTE7Cn0KCi5mZngtbG9nby1jb250YWluZXIgewogICAgbWFyZ2luLWJvdHRvbTogNjBweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goLTEwZGVnKTsKfQoKLmZmeC1sb2dvLW1haW4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiA2NHB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZiwgMCAwIDIwcHggIzAwODhmZiwgMCAwIDQwcHggIzAwMDBmZjsKICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmZmZmIDAlLCAjYWFjY2ZmIDUwJSwgIzAwODhmZiAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDVweCA1cHggcmdiYSgwLDAsMCwwLjgpKTsKfQoKLmZmeC1sb2dvLXN1YiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDE4cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDEycHg7CiAgICBtYXJnaW4tdG9wOiAtNXB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggI2ZmYWEwMDsKfQoKLm1lbnUtb3B0aW9ucyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogMTVweDsKICAgIHdpZHRoOiAzMDBweDsKfQoKLm1lbnUtaXRlbSB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBwYWRkaW5nOiAxNXB4IDMwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgNDAsIDgwLCAwLjYpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC4wKSAxMDAlKTsKICAgIGJvcmRlci1sZWZ0OiA0cHggc29saWQgcmdiYSgxMDAsIDIwMCwgMjU1LCAwLjMpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4xKTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7Cn0KCi5tZW51LWl0ZW06aG92ZXIgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDgwLCAxNjAsIDAuOCkgMCUsIHJnYmEoMCwgMjAsIDQwLCAwLjApIDEwMCUpOwogICAgYm9yZGVyLWxlZnQtY29sb3I6ICMwMGZmZmY7CiAgICBwYWRkaW5nLWxlZnQ6IDQwcHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjIpOwp9CgoubWVudS1pdGVtIC5sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogI2NjY2NjYzsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7CiAgICB0cmFuc2l0aW9uOiBjb2xvciAwLjJzOwp9CgoubWVudS1pdGVtOmhvdmVyIC5sYWJlbCB7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwp9CgoubWVudS1pdGVtIC5jdXJzb3IgewogICAgZm9udC1zaXplOiAxOHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIG1hcmdpbi1yaWdodDogMTVweDsKICAgIG9wYWNpdHk6IDA7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTEwcHgpIHNrZXdYKDEwZGVnKTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwp9CgoubWVudS1pdGVtOmhvdmVyIC5jdXJzb3IgewogICAgb3BhY2l0eTogMTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKSBza2V3WCgxMGRlZyk7Cn0KCi5tZW51LWZvb3RlciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDIwcHg7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogcmdiYSgyNTUsMjU1LDI1NSwwLjMpOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKfQoKLyogLS0tIFBSQUNUSUNFIE9WRVJMQVkgLS0tICovCiNwcmFjdGljZS1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNSwgMTAsIDAuNik7CiAgICBkaXNwbGF5OiBub25lOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgei1pbmRleDogMjUwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgojcHJhY3RpY2Utb3ZlcmxheS5hY3RpdmUgewogICAgZGlzcGxheTogZmxleDsKfQoKLnByYWN0aWNlLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDYwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDQwcHgpOyAKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDI4MHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE2MGRlZywgcmdiYSgwLCAyMCwgNTAsIDAuOTUpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC45OCkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ4OGZmOwogICAgYm9yZGVyLXJhZGl1czogMCAwIDE1cHggMDsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMiksIGluc2V0IDAgMCA1MHB4IHJnYmEoMCwgMjAsIDYwLCAwLjUpOwogICAgcGFkZGluZzogMTVweDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMmRlZyk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNXB4KTsKfQoKLnBhbmVsLWhlYWRlciB7CiAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgoucGFuZWwtdGl0bGUtZ3JvdXAgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47Cn0KCi5wYW5lbC10aXRsZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IGNsYW1wKDE4cHgsIDZ2dywgMjRweCk7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKfQoKLnBhbmVsLXN1YnRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogOHB4OwogICAgY29sb3I6ICM0NDg4ZmY7CiAgICBsZXR0ZXItc3BhY2luZzogNHB4OwogICAgbWFyZ2luLXRvcDogLTJweDsKfQoKLnBhbmVsLWRlY28tbGluZSB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMnB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgIzAwZmZmZiwgdHJhbnNwYXJlbnQpOwogICAgbWFyZ2luLXRvcDogNXB4OwogICAgYm94LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOwp9CgoucGFuZWwtY29udGVudCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogMTVweDsKfQoKLnNlY3Rpb24tbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDIwMCwgMTc2LCA5NiwgMC4zKTsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKICAgIHBhZGRpbmctYm90dG9tOiAycHg7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgouZHJpbGwtbGlzdCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogNXB4Owp9CgouZHJpbGwtYnRuIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcGFkZGluZzogOHB4IDEycHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4wNSksIHRyYW5zcGFyZW50KTsKICAgIGJvcmRlci1sZWZ0OiAycHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjYWFhOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7Cn0KCi5kcmlsbC1idG46aG92ZXIgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDI1NSwgMjU1LCAwLjEpLCB0cmFuc3BhcmVudCk7CiAgICBjb2xvcjogI2ZmZjsKICAgIHBhZGRpbmctbGVmdDogMTVweDsKfQoKLmRyaWxsLWJ0bi5hY3RpdmUgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDEwMCwgMjU1LCAwLjQpLCB0cmFuc3BhcmVudCk7CiAgICBib3JkZXItbGVmdDogM3B4IHNvbGlkICMwMGZmZmY7CiAgICBjb2xvcjogI2ZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMGZmZmY7Cn0KCi5kcmlsbC1idG4gLmljb24gewogICAgd2lkdGg6IDIwcHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBtYXJnaW4tcmlnaHQ6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwp9Cgoub3B0aW9uLWxpc3QgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBnYXA6IDVweDsKfQoKLm9wdGlvbi10b2dnbGUgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwYWRkaW5nOiA1cHggMTBweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiAjY2NjOwogICAgdHJhbnNpdGlvbjogY29sb3IgMC4yczsKfQoKLm9wdGlvbi10b2dnbGU6aG92ZXIgeyBjb2xvcjogI2ZmZjsgfQoKLm9wdGlvbi10b2dnbGUgLmNoZWNrYm94IHsKICAgIG1hcmdpbi1yaWdodDogMTBweDsKICAgIGNvbG9yOiAjNDQ0OwogICAgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsKICAgIGZvbnQtc2l6ZTogMTRweDsKfQoKLm9wdGlvbi10b2dnbGUuYWN0aXZlIC5jaGVja2JveCB7CiAgICBjb2xvcjogIzAwZmYwMDsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMGZmMDA7Cn0KCi5vcHRpb24tdG9nZ2xlLmFjdGl2ZSB7CiAgICBjb2xvcjogI2ZmZjsKfQoKLmFjdGlvbi1idG4gewogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIHBhZGRpbmc6IDZweDsKICAgIGZvbnQtc2l6ZTogMTFweDsKICAgIGNvbG9yOiAjYWFhOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICBtYXJnaW4tYm90dG9tOiA1cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKLmFjdGlvbi1idG46aG92ZXIgewogICAgYm9yZGVyLWNvbG9yOiAjZmZmOwogICAgY29sb3I6ICNmZmY7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7Cn0KCiNwLWV4aXQ6aG92ZXIgewogICAgYm9yZGVyLWNvbG9yOiAjZmY0NDQ0OwogICAgY29sb3I6ICNmZjQ0NDQ7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDUwLCAwLCAwLCAwLjMpOwp9CgoucGFuZWwtZm9vdGVyIHsKICAgIG1hcmdpbi10b3A6IDE1cHg7CiAgICBwYWRkaW5nLXRvcDogMTBweDsKICAgIGJvcmRlci10b3A6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCiNkcmlsbC1pbnN0cnVjdGlvbiB7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgbWFyZ2luLWJvdHRvbTogNXB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwp9CgojZHJpbGwtc2NvcmUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMjU1LCAyMTUsIDAsIDAuNSk7Cn0KCi5wYW5lbC1taW5pbWl6ZS1idG4gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMHB4OyByaWdodDogMTBweDsKICAgIHdpZHRoOiAyMHB4OyBoZWlnaHQ6IDIwcHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbGluZS1oZWlnaHQ6IDE4cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDAuNSk7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoucGFuZWwtbWluaW1pemUtYnRuOmhvdmVyIHsgCiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtY3lhbik7IAogICAgY29sb3I6ICMwMDA7IAogICAgYm94LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7Cn0KCiNwcmFjdGljZS1yZXN0b3JlLWJ0biB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA0MHB4KTsgCiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHBhZGRpbmc6IDhweCAxNXB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDIwLCA1MCwgMC45KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItbGVmdDogM3B4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB6LWluZGV4OiAyNDAwOwogICAgZGlzcGxheTogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC4yKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KI3ByYWN0aWNlLXJlc3RvcmUtYnRuOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjkpOwogICAgY29sb3I6ICNmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLyogLS0tIEFJTSBKT1lTVElDSyAtLS0gKi8KI2FpbS1qb3lzdGljay16b25lIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE1MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOwogICAgcmlnaHQ6IDA7CiAgICB3aWR0aDogNDAlOwogICAgaGVpZ2h0OiAzNSU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwKTsKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgojYWltLWpveXN0aWNrLXZpc3VhbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMDsgaGVpZ2h0OiAwOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAxMTAwOwp9CgojYWltLWpveXN0aWNrLWJhc2UgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDkwcHg7IGhlaWdodDogOTBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMjU1LCAxMDAsIDAsIDAuMykgMCUsIHJnYmEoODAsIDIwLCAwLCAwLjEpIDYwJSwgdHJhbnNwYXJlbnQgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMTUwLCA1MCwgMC40KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuMiksIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCA1MCwgMCwgMC4yKTsKfQoKI2FpbS1qb3lzdGljay1rbm9iIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiA0MHB4OyBoZWlnaHQ6IDQwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsICNmZmNjODggMCUsICNmZjY2MDAgNDAlLCAjODgyMjAwIDgwJSwgIzIyMDAwMCAxMDAlKTsKICAgIGJvcmRlcjogMnB4IHNvbGlkICNmZmFhNDQ7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjZmY0NDAwLCBpbnNldCAwIDAgOHB4IHJnYmEoMjU1LDI1NSwyNTUsMC42KTsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjA1cyBsaW5lYXI7Cn0KCiNhaW0tam95c3RpY2sta25vYjo6YWZ0ZXIgewogICAgY29udGVudDogIkFJTSI7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBmb250LXNpemU6IDhweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgdGV4dC1zaGFkb3c6IDAgMCAzcHggIzAwMDsKfQoKLyogLS0tIFRBQ0tMRSBCVVRUT04gLS0tICovCiN0YWNrbGUtYnV0dG9uIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyAxMDBweCk7CiAgICByaWdodDogbWF4KDQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiA3MHB4OwogICAgaGVpZ2h0OiA3MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZGlzcGxheTogbm9uZTsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgei1pbmRleDogMTAwOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmY4ODg4IDAlLCAjY2MwMDAwIDQwJSwgIzY2MDAwMCA4MCUsICMyMjAwMDAgMTAwJSk7CiAgICBib3JkZXI6IDNweCBzb2xpZCAjZmY0NDQ0OwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgyNTUsIDUwLCA1MCwgMC42KSwgaW5zZXQgMCAwIDE1cHggcmdiYSgyNTUsIDIwMCwgMjAwLCAwLjMpOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMXMsIGZpbHRlciAwLjJzOwp9CgojdGFja2xlLWJ1dHRvbjphY3RpdmUgewogICAgdHJhbnNmb3JtOiBzY2FsZSgwLjkpOwogICAgZmlsdGVyOiBicmlnaHRuZXNzKDEuMik7Cn0KCiN0YWNrbGUtYnV0dG9uLmFjdGl2ZSB7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZmZmZmYgMCUsICNmZjQ0NDQgNDAlLCAjYWEwMDAwIDgwJSwgIzQ0MDAwMCAxMDAlKTsKICAgIGJveC1zaGFkb3c6IDAgMCAyNXB4IHJnYmEoMjU1LCAxMDAsIDEwMCwgMC45KTsKfQoKI3RhY2tsZS1idXR0b24gLmJ0bi10ZXh0IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAxcHggMnB4IHJnYmEoMCwwLDAsMC44KTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7Cn0KCiN0YWNrbGUtYnV0dG9uIC5idG4tZ2xhcmUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtNTAlOyBsZWZ0OiAtNTAlOwogICAgd2lkdGg6IDIwMCU7IGhlaWdodDogMjAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg0NWRlZywgdHJhbnNwYXJlbnQgNDAlLCByZ2JhKDI1NSwyNTUsMjU1LDAuMykgNTAlLCB0cmFuc3BhcmVudCA2MCUpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBhbmltYXRpb246IGdsYXJlUGFzcyA0cyBpbmZpbml0ZTsKfQoKI3RhY2tsZS1idXR0b24udXJnZW50IHsKICAgIGFuaW1hdGlvbjogdXJnZW50UHVsc2UgMC41cyBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZjU1NTUgMCUsICNmZjAwMDAgNDAlLCAjODgwMDAwIDEwMCUpOwogICAgYm9yZGVyLWNvbG9yOiAjZmZhYWFhOwogICAgYm94LXNoYWRvdzogMCAwIDIwcHggI2ZmMDAwMDsKfQoKQGtleWZyYW1lcyB1cmdlbnRQdWxzZSB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyB9CiAgICB0byB7IHRyYW5zZm9ybTogc2NhbGUoMS4xNSk7IH0KfQoKLyogLS0tIENIQVJHRSBQT1dFUiBNRVRFUiAtLS0gKi8KI2NoYXJnZS1tZXRlci1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiBtYXgoMjUwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSArIDEwMHB4KTsKICAgIGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKTsKICAgIHdpZHRoOiAyMDBweDsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogMjAwMDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMTAsIDMwLCAwLjgpOwogICAgcGFkZGluZzogMTBweCAxNXB4OwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogNXB4OwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLCAxMDAsIDI1NSwgMC4zKTsKfQoKLmNoYXJnZS1sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBtYXJnaW4tYm90dG9tOiA1cHg7Cn0KCi5jaGFyZ2UtbWV0ZXItdHJhY2sgewogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEycHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuNik7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ0OwogICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKI2NoYXJnZS1tZXRlci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIHdpZHRoOiAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgIzBhZiwgIzBmMCk7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjMGYwOwogICAgdHJhbnNpdGlvbjogd2lkdGggMC4wNXMgbGluZWFyLCBiYWNrZ3JvdW5kIDAuMXM7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7Cn0KCi5jaGFyZ2UtaGludCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbWFyZ2luLXRvcDogNXB4OwogICAgb3BhY2l0eTogMC44OwogICAgYW5pbWF0aW9uOiBibGluayAwLjVzIGluZmluaXRlOwp9CgovKiAtLS0gR09BTCBESVNUQU5DRSBJTkRJQ0FUT1IgLS0tICovCiNnb2FsLWRpc3RhbmNlLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg3NXB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA1NXB4KTsKICAgIGxlZnQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQpKTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogMTAwOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDEwLCAzMCwgMC43KSAwJSwgdHJhbnNwYXJlbnQgMTAwJSk7CiAgICBwYWRkaW5nOiA1cHggMTVweCA1cHggMTBweDsKICAgIGJvcmRlci1sZWZ0OiAycHggc29saWQgdmFyKC0tZmZ4LWdvbGQpOwp9CgouZGlzdGFuY2UtbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiA4cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KCiNnb2FsLWRpc3RhbmNlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWdvbGQpOwp9CgovKiAtLS0gU0VUVElOR1MgQlVUVE9OIC0tLSAqLwojc2V0dGluZ3MtYnV0dG9uIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDI0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyAxMDBweCk7CiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiAxMTBweDsKICAgIHBhZGRpbmc6IDhweCAwOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICBjb2xvcjogIzg4ODsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMjAsIDIwLCAyMCwgMC44KSAwJSwgcmdiYSgxMCwgMTAsIDEwLCAwLjkpIDEwMCUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIHotaW5kZXg6IDEwMDsKfQoKI3NldHRpbmdzLWJ1dHRvbjpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDQwLCA0MCwgNDAsIDAuOSk7CiAgICBib3JkZXItY29sb3I6ICM4ODg7CiAgICBjb2xvcjogI2ZmZjsKfQoKLyogLS0tIFNFVFRJTkdTIFBBTkVMIC0tLSAqLwojc2V0dGluZ3MtcGFuZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7CiAgICBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiAyODBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHJnYmEoMCwgMjAsIDUwLCAwLjk4KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOTkpIDEwMCUpOwogICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgIGJveC1zaGFkb3c6IDAgMCAzMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuNCk7CiAgICB6LWluZGV4OiAzNTAwOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTBweCk7Cn0KCi5zZXR0aW5ncy1oZWFkZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwYWRkaW5nOiAxNXB4OwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMzAsIDYwLCAwLjUpOwp9Cgouc2V0dGluZ3MtaGVhZGVyIHNwYW4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAyMHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4pOwogICAgbGV0dGVyLXNwYWNpbmc6IDNweDsKfQoKI3NldHRpbmdzLWNsb3NlIHsKICAgIHdpZHRoOiAzMHB4OwogICAgaGVpZ2h0OiAzMHB4OwogICAgYm9yZGVyOiAxcHggc29saWQgI2ZmNDQ0NDsKICAgIGJhY2tncm91bmQ6IHJnYmEoNTAsIDAsIDAsIDAuNSk7CiAgICBjb2xvcjogI2ZmNDQ0NDsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwp9Cgojc2V0dGluZ3MtY2xvc2U6aG92ZXIgewogICAgYmFja2dyb3VuZDogI2ZmNDQ0NDsKICAgIGNvbG9yOiB3aGl0ZTsKfQoKLnNldHRpbmdzLWNvbnRlbnQgewogICAgcGFkZGluZzogMjBweDsKfQoKLnNldHRpbmctcm93IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogMTVweDsKICAgIHBhZGRpbmc6IDEwcHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuMyk7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7Cn0KCi5zZXR0aW5nLXJvdyBsYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjY2NjOwp9Cgouc2V0dGluZy1yb3cgaW5wdXRbdHlwZT0icmFuZ2UiXSB7CiAgICB3aWR0aDogMTAwcHg7CiAgICBhY2NlbnQtY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKfQoKLnNldHRpbmctcm93IGlucHV0W3R5cGU9ImNoZWNrYm94Il0gewogICAgd2lkdGg6IDIwcHg7CiAgICBoZWlnaHQ6IDIwcHg7CiAgICBhY2NlbnQtY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGN1cnNvcjogcG9pbnRlcjsKfQoKLyogLS0tIEdMQVJFIEFOSU1BVElPTiAtLS0gKi8KQGtleWZyYW1lcyBnbGFyZVBhc3MgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTEwMCUpIHJvdGF0ZSg0NWRlZyk7IH0KICAgIDMwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxMDAlKSByb3RhdGUoNDVkZWcpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDEwMCUpIHJvdGF0ZSg0NWRlZyk7IH0KfQoKLyogLS0tIFNUQVRVUyBUWVBFIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LWlubmVyLnN0YXR1cyB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjhweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGNvbG9yOiAjZmYwMGZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICNmZjAwZmYsIDJweCAycHggMCAjMDAwOwogICAgYW5pbWF0aW9uOiBzdGF0dXNQb3AgMS4ycyBlYXNlLW91dCBmb3J3YXJkczsKfQoKQGtleWZyYW1lcyBzdGF0dXNQb3AgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuNSkgdHJhbnNsYXRlWSgwKTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjMpIHRyYW5zbGF0ZVkoLTEwcHgpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApIHRyYW5zbGF0ZVkoLTQwcHgpOyBvcGFjaXR5OiAwOyB9Cn0KCi8qIC0tLSBHT0FMIFRZUEUgRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtaW5uZXIuZ29hbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogNDhweDsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmIDAlLCAjZmZkNzAwIDUwJSwgI2ZmODgwMCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDRweCA0cHggcmdiYSgwLDAsMCwwLjkpKTsKICAgIGFuaW1hdGlvbjogZ29hbFBvcCAxcyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSkgZm9yd2FyZHM7Cn0KCkBrZXlmcmFtZXMgZ29hbFBvcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMCkgcm90YXRlKC0xMGRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS41KSByb3RhdGUoNWRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMikgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9Cn0KCi8qIC0tLSBERUZBVUxUIFRZUEUgRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtaW5uZXIuZGVmYXVsdCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDJweCA0cHggcmdiYSgwLDAsMCwwLjgpOwogICAgYW5pbWF0aW9uOiBmbG9hdFVwIDAuOHMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCi8qIC0tLSBNT0JJTEUgUE9SVFJBSVQgT1BUSU1JWkFUSU9OUyAtLS0gKi8KQG1lZGlhIHNjcmVlbiBhbmQgKG9yaWVudGF0aW9uOiBwb3J0cmFpdCkgYW5kIChtYXgtd2lkdGg6IDYwMHB4KSB7CiAgICAudGVhbS13aW5nIHsgd2lkdGg6IDkwcHg7IHBhZGRpbmc6IDAgNXB4OyB9CiAgICAuc2NvcmUtYm94IHsgZm9udC1zaXplOiAyNHB4OyBtYXJnaW46IDAgNXB4OyB9CiAgICAudGVhbS1uYW1lIHsgZm9udC1zaXplOiAxMHB4OyB9CiAgICAudGVhbS1zdWIgeyBkaXNwbGF5OiBub25lOyB9CiAgICAKICAgIC50aW1lci1jcnlzdGFsLXJpbmcgeyB3aWR0aDogODBweDsgaGVpZ2h0OiA0MHB4OyB0b3A6IC0xNXB4OyB9CiAgICAjdGltZXItZGlzcGxheSB7IGZvbnQtc2l6ZTogMjhweDsgfQogICAgCiAgICAjbWluaW1hcC1jb250YWluZXIgeyB3aWR0aDogOTBweDsgaGVpZ2h0OiA5MHB4OyB9CiAgICAjbWluaW1hcCB7IHdpZHRoOiA4MHB4OyBoZWlnaHQ6IDgwcHg7IH0KICAgIC5yYWRhci1sYWJlbCB7IGZvbnQtc2l6ZTogMTBweDsgfQogICAgCiAgICAudGVjaC10ZXh0IHsgZm9udC1zaXplOiAyNHB4OyB9CiAgICAKICAgICNhY3Rpb24tYnV0dG9uIHsgd2lkdGg6IDgwcHg7IGhlaWdodDogODBweDsgfQogICAgLmNvbW1hbmQtcmluZyB7IHdpZHRoOiAxMDBweDsgaGVpZ2h0OiAxMDBweDsgfQogICAgI2FjdGlvbi1sYWJlbCB7IGZvbnQtc2l6ZTogMTBweDsgcGFkZGluZzogMnB4IDhweDsgfQogICAgCiAgICAjcGxheWVyLXN0YXR1cy1wYW5lbCB7IHdpZHRoOiAxMzBweDsgYm90dG9tOiBtYXgoMTQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSArIDIwcHgpOyB9CiAgICAuY2hhci1uYW1lIHsgZm9udC1zaXplOiAxNHB4OyB9CiAgICAKICAgICNhdXRvLXRvZ2dsZSwgI3NldHRpbmdzLWJ1dHRvbiwgI3ByYWN0aWNlLXJlc3RvcmUtYnRuIHsKICAgICAgICB3aWR0aDogOTBweDsKICAgICAgICBmb250LXNpemU6IDlweDsKICAgICAgICByaWdodDogbWF4KDEwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIH0KICAgIAogICAgI2dvYWwtZGlzdGFuY2UtY29udGFpbmVyIHsgbGVmdDogbWF4KDEwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtbGVmdCkpOyB9CiNnb2FsLWRpc3RhbmNlIHsgZm9udC1zaXplOiAxOHB4OyB9Cn0KCi8qIC0tLSBHRVNUVVJFIEhJTlQgLS0tICovCiNnZXN0dXJlLWhpbnQgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDIwMHB4OyBoZWlnaHQ6IDMwMHB4OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMjUwMDsKICAgIG9wYWNpdHk6IDAuOTsKfQoKI2dlc3R1cmUtaGludC5hY3RpdmUgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7Cn0KCi5jdXJ2ZS1hcnJvdyB7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA1cHggIzAwZmZmZik7CiAgICBhbmltYXRpb246IGRhc2hEcmF3IDEuNXMgbGluZWFyIGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIGRhc2hEcmF3IHsKICAgIHRvIHsgc3Ryb2tlLWRhc2hvZmZzZXQ6IC0zMDsgfQp9CgouZ2VzdHVyZS10ZXh0IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKICAgIG1hcmdpbi10b3A6IC01MHB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCi5nZXN0dXJlLWhhbmQgewogICAgZm9udC1zaXplOiA0OHB4OwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAyMHB4OwogICAgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgYW5pbWF0aW9uOiBoYW5kU3dpcGUgMS41cyBlYXNlLWluLW91dCBpbmZpbml0ZTsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggYmxhY2spOwp9CgpAa2V5ZnJhbWVzIGhhbmRTd2lwZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIDUwcHgpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgb3BhY2l0eTogMTsgfQogICAgODAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMjBweCwgLTEwMHB4KSByb3RhdGUoMjBkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMHB4LCAtMTIwcHgpIHJvdGF0ZSgxMGRlZyk7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIFNXSVBFIFRSQUlMIChJTlRVSVRJVkUgRkVFREJBQ0spIC0tLSAqLwouc3dpcGUtdHJhaWwtZG90IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxMnB4OwogICAgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgIzAwZmZmZiAwJSwgcmdiYSgwLCAyNTUsIDI1NSwgMCkgNzAlKTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogOTAwMDsKICAgIGFuaW1hdGlvbjogZmFkZVRyYWlsIDAuNXMgbGluZWFyIGZvcndhcmRzOwogICAgbWl4LWJsZW5kLW1vZGU6IHNjcmVlbjsKfQoKQGtleWZyYW1lcyBmYWRlVHJhaWwgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjIpOyBvcGFjaXR5OiAwOyB9Cn0KQGtleWZyYW1lcyBmYWRlVHJhaWwgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjIpOyBvcGFjaXR5OiAwOyB9Cn0KCi8qIC0tLSBPRkZTQ1JFRU4gSU5ESUNBVE9SIC0tLSAqLwojb2Zmc2NyZWVuLWluZGljYXRvciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogNDBweDsgaGVpZ2h0OiA0MHB4OwogICAgbWFyZ2luLWxlZnQ6IC0yMHB4OyBtYXJnaW4tdG9wOiAtMjBweDsKICAgIHotaW5kZXg6IDE1MDA7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA1cHggIzAwMCk7Cn0KCiNvZmZzY3JlZW4taW5kaWNhdG9yIC5hcnJvdyB7CiAgICB3aWR0aDogMDsgaGVpZ2h0OiAwOwogICAgYm9yZGVyLWxlZnQ6IDE1cHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItcmlnaHQ6IDE1cHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItYm90dG9tOiAyNXB4IHNvbGlkICMwMGZmMDA7IC8qIEdyZWVuIGZvciBwbGF5ZXIgKi8KICAgIGFuaW1hdGlvbjogcHVsc2VBcnJvdyAwLjVzIGluZmluaXRlIGFsdGVybmF0ZTsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGNlbnRlciBib3R0b207Cn0KCkBrZXlmcmFtZXMgcHVsc2VBcnJvdyB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgZmlsdGVyOiBicmlnaHRuZXNzKDEpOyB9CiAgICB0byB7IHRyYW5zZm9ybTogc2NhbGUoMS4yKTsgZmlsdGVyOiBicmlnaHRuZXNzKDEuNSk7IH0KfQ==","AssetLoader.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfbG9hZGVyID0gbmV3IFRIUkVFLkdMVEZMb2FkZXIoKTsKCiAgICAvLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQovLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQogICAgZnVuY3Rpb24gY29udmVydE1hdGVyaWFsKG9sZE1hdCwgaXNTa2lubmVkKSB7CiAgICAgICAgCiAgICAgICAgLy8gUHJlc2VydmUgdGV4dHVyZTogQ2hlY2sgbWFwLCB0aGVuIGVtaXNzaXZlTWFwCiAgICAgICAgY29uc3QgdGV4dHVyZSA9IG9sZE1hdC5tYXAgfHwgb2xkTWF0LmVtaXNzaXZlTWFwIHx8IG51bGw7CgogICAgICAgIC8vIEZPUkNFIE9QQVFVRSBWSVNJQklMSVRZCiAgICAgICAgLy8gV2Ugb3ZlcnJpZGUgdHJhbnNwYXJlbmN5IHRvIGVuc3VyZSBtb2RlbHMgYXJlIGFsd2F5cyB2aXNpYmxlIChmaXhpbmcgdGhlICJpbnZpc2libGUgbW9kZWwiIGlzc3VlKS4KICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIG1hcDogdGV4dHVyZSwKICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAgICAgICAgLy8gRk9SQ0UgV0hJVEU6IFJlbW92ZSBhbnkgdGludCBmcm9tIEdMVEYKICAgICAgICAgICAgc2tpbm5pbmc6IGlzU2tpbm5lZCwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgLy8gUmVuZGVyIGJvdGggc2lkZXMgdG8gcHJldmVudCBiYWNrZmFjZSBjdWxsaW5nIGludmlzaWJpbGl0eQogICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsICAgICAvLyBEaXNhYmxlIHRyYW5zcGFyZW5jeSB0byBwcmV2ZW50IHNvcnRpbmcgaXNzdWVzCiAgICAgICAgICAgIG9wYWNpdHk6IDEuMCwgICAgICAgICAgIC8vIEZvcmNlIGZ1bGwgb3BhY2l0eQogICAgICAgICAgICBhbHBoYVRlc3Q6IDAuNSwgICAgICAgICAvLyBTdHJvbmcgYWxwaGEgdGVzdCBmb3IgY3V0b3V0cyAobmV0cy9ncmF0ZXMpCiAgICAgICAgICAgIHZlcnRleENvbG9yczogb2xkTWF0LnZlcnRleENvbG9ycywgLy8gUHJlc2VydmUgdmVydGV4IGNvbG9ycwogICAgICAgICAgICBkZXB0aFRlc3Q6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IHRydWUsICAgICAgIC8vIEZvcmNlIGRlcHRoIHdyaXRlIHNvIGl0IG9jY2x1ZGVzIHByb3Blcmx5CiAgICAgICAgICAgIGZvZzogdHJ1ZQogICAgICAgIH07CgogICAgICAgIC8vIEVuc3VyZSB0ZXh0dXJlIGVuY29kaW5nIGlzIGNvcnJlY3QgZm9yIFRocmVlLmpzCiAgICAgICAgaWYgKHBhcmFtcy5tYXApIHBhcmFtcy5tYXAuZW5jb2RpbmcgPSBUSFJFRS5zUkdCRW5jb2Rpbmc7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwocGFyYW1zKTsKICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlciA9IHsKICAgICAgICBsb2FkTW9kZWw6IGZ1bmN0aW9uKHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yKSB7CiAgICAgICAgICAgIF9sb2FkZXIubG9hZCh1cmwsIGZ1bmN0aW9uKGdsdGYpIHsKICAgICAgICAgICAgICAgIGdsdGYuc2NlbmUudHJhdmVyc2UoZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCkgewpub2RlLmNhc3RTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBQcmV2ZW50IGludmlzaWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZS5tYXRlcmlhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gbm9kZS5tYXRlcmlhbC5tYXAobSA9PiBjb252ZXJ0TWF0ZXJpYWwobSwgbm9kZS5pc1NraW5uZWRNZXNoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBjb252ZXJ0TWF0ZXJpYWwobm9kZS5tYXRlcmlhbCwgbm9kZS5pc1NraW5uZWRNZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKG9uTG9hZCkgb25Mb2FkKGdsdGYpOwogICAgICAgICAgICB9LCBvblByb2dyZXNzLCBvbkVycm9yKTsKICAgICAgICB9CiAgICB9Owp9KSgpOw==","./AssetLoader.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfbG9hZGVyID0gbmV3IFRIUkVFLkdMVEZMb2FkZXIoKTsKCiAgICAvLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQovLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQogICAgZnVuY3Rpb24gY29udmVydE1hdGVyaWFsKG9sZE1hdCwgaXNTa2lubmVkKSB7CiAgICAgICAgCiAgICAgICAgLy8gUHJlc2VydmUgdGV4dHVyZTogQ2hlY2sgbWFwLCB0aGVuIGVtaXNzaXZlTWFwCiAgICAgICAgY29uc3QgdGV4dHVyZSA9IG9sZE1hdC5tYXAgfHwgb2xkTWF0LmVtaXNzaXZlTWFwIHx8IG51bGw7CgogICAgICAgIC8vIEZPUkNFIE9QQVFVRSBWSVNJQklMSVRZCiAgICAgICAgLy8gV2Ugb3ZlcnJpZGUgdHJhbnNwYXJlbmN5IHRvIGVuc3VyZSBtb2RlbHMgYXJlIGFsd2F5cyB2aXNpYmxlIChmaXhpbmcgdGhlICJpbnZpc2libGUgbW9kZWwiIGlzc3VlKS4KICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIG1hcDogdGV4dHVyZSwKICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAgICAgICAgLy8gRk9SQ0UgV0hJVEU6IFJlbW92ZSBhbnkgdGludCBmcm9tIEdMVEYKICAgICAgICAgICAgc2tpbm5pbmc6IGlzU2tpbm5lZCwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgLy8gUmVuZGVyIGJvdGggc2lkZXMgdG8gcHJldmVudCBiYWNrZmFjZSBjdWxsaW5nIGludmlzaWJpbGl0eQogICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsICAgICAvLyBEaXNhYmxlIHRyYW5zcGFyZW5jeSB0byBwcmV2ZW50IHNvcnRpbmcgaXNzdWVzCiAgICAgICAgICAgIG9wYWNpdHk6IDEuMCwgICAgICAgICAgIC8vIEZvcmNlIGZ1bGwgb3BhY2l0eQogICAgICAgICAgICBhbHBoYVRlc3Q6IDAuNSwgICAgICAgICAvLyBTdHJvbmcgYWxwaGEgdGVzdCBmb3IgY3V0b3V0cyAobmV0cy9ncmF0ZXMpCiAgICAgICAgICAgIHZlcnRleENvbG9yczogb2xkTWF0LnZlcnRleENvbG9ycywgLy8gUHJlc2VydmUgdmVydGV4IGNvbG9ycwogICAgICAgICAgICBkZXB0aFRlc3Q6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IHRydWUsICAgICAgIC8vIEZvcmNlIGRlcHRoIHdyaXRlIHNvIGl0IG9jY2x1ZGVzIHByb3Blcmx5CiAgICAgICAgICAgIGZvZzogdHJ1ZQogICAgICAgIH07CgogICAgICAgIC8vIEVuc3VyZSB0ZXh0dXJlIGVuY29kaW5nIGlzIGNvcnJlY3QgZm9yIFRocmVlLmpzCiAgICAgICAgaWYgKHBhcmFtcy5tYXApIHBhcmFtcy5tYXAuZW5jb2RpbmcgPSBUSFJFRS5zUkdCRW5jb2Rpbmc7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwocGFyYW1zKTsKICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlciA9IHsKICAgICAgICBsb2FkTW9kZWw6IGZ1bmN0aW9uKHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yKSB7CiAgICAgICAgICAgIF9sb2FkZXIubG9hZCh1cmwsIGZ1bmN0aW9uKGdsdGYpIHsKICAgICAgICAgICAgICAgIGdsdGYuc2NlbmUudHJhdmVyc2UoZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCkgewpub2RlLmNhc3RTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBQcmV2ZW50IGludmlzaWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZS5tYXRlcmlhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gbm9kZS5tYXRlcmlhbC5tYXAobSA9PiBjb252ZXJ0TWF0ZXJpYWwobSwgbm9kZS5pc1NraW5uZWRNZXNoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBjb252ZXJ0TWF0ZXJpYWwobm9kZS5tYXRlcmlhbCwgbm9kZS5pc1NraW5uZWRNZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKG9uTG9hZCkgb25Mb2FkKGdsdGYpOwogICAgICAgICAgICB9LCBvblByb2dyZXNzLCBvbkVycm9yKTsKICAgICAgICB9CiAgICB9Owp9KSgpOw==","/AssetLoader.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfbG9hZGVyID0gbmV3IFRIUkVFLkdMVEZMb2FkZXIoKTsKCiAgICAvLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQovLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQogICAgZnVuY3Rpb24gY29udmVydE1hdGVyaWFsKG9sZE1hdCwgaXNTa2lubmVkKSB7CiAgICAgICAgCiAgICAgICAgLy8gUHJlc2VydmUgdGV4dHVyZTogQ2hlY2sgbWFwLCB0aGVuIGVtaXNzaXZlTWFwCiAgICAgICAgY29uc3QgdGV4dHVyZSA9IG9sZE1hdC5tYXAgfHwgb2xkTWF0LmVtaXNzaXZlTWFwIHx8IG51bGw7CgogICAgICAgIC8vIEZPUkNFIE9QQVFVRSBWSVNJQklMSVRZCiAgICAgICAgLy8gV2Ugb3ZlcnJpZGUgdHJhbnNwYXJlbmN5IHRvIGVuc3VyZSBtb2RlbHMgYXJlIGFsd2F5cyB2aXNpYmxlIChmaXhpbmcgdGhlICJpbnZpc2libGUgbW9kZWwiIGlzc3VlKS4KICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIG1hcDogdGV4dHVyZSwKICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAgICAgICAgLy8gRk9SQ0UgV0hJVEU6IFJlbW92ZSBhbnkgdGludCBmcm9tIEdMVEYKICAgICAgICAgICAgc2tpbm5pbmc6IGlzU2tpbm5lZCwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgLy8gUmVuZGVyIGJvdGggc2lkZXMgdG8gcHJldmVudCBiYWNrZmFjZSBjdWxsaW5nIGludmlzaWJpbGl0eQogICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsICAgICAvLyBEaXNhYmxlIHRyYW5zcGFyZW5jeSB0byBwcmV2ZW50IHNvcnRpbmcgaXNzdWVzCiAgICAgICAgICAgIG9wYWNpdHk6IDEuMCwgICAgICAgICAgIC8vIEZvcmNlIGZ1bGwgb3BhY2l0eQogICAgICAgICAgICBhbHBoYVRlc3Q6IDAuNSwgICAgICAgICAvLyBTdHJvbmcgYWxwaGEgdGVzdCBmb3IgY3V0b3V0cyAobmV0cy9ncmF0ZXMpCiAgICAgICAgICAgIHZlcnRleENvbG9yczogb2xkTWF0LnZlcnRleENvbG9ycywgLy8gUHJlc2VydmUgdmVydGV4IGNvbG9ycwogICAgICAgICAgICBkZXB0aFRlc3Q6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IHRydWUsICAgICAgIC8vIEZvcmNlIGRlcHRoIHdyaXRlIHNvIGl0IG9jY2x1ZGVzIHByb3Blcmx5CiAgICAgICAgICAgIGZvZzogdHJ1ZQogICAgICAgIH07CgogICAgICAgIC8vIEVuc3VyZSB0ZXh0dXJlIGVuY29kaW5nIGlzIGNvcnJlY3QgZm9yIFRocmVlLmpzCiAgICAgICAgaWYgKHBhcmFtcy5tYXApIHBhcmFtcy5tYXAuZW5jb2RpbmcgPSBUSFJFRS5zUkdCRW5jb2Rpbmc7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwocGFyYW1zKTsKICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlciA9IHsKICAgICAgICBsb2FkTW9kZWw6IGZ1bmN0aW9uKHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yKSB7CiAgICAgICAgICAgIF9sb2FkZXIubG9hZCh1cmwsIGZ1bmN0aW9uKGdsdGYpIHsKICAgICAgICAgICAgICAgIGdsdGYuc2NlbmUudHJhdmVyc2UoZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCkgewpub2RlLmNhc3RTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBQcmV2ZW50IGludmlzaWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZS5tYXRlcmlhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gbm9kZS5tYXRlcmlhbC5tYXAobSA9PiBjb252ZXJ0TWF0ZXJpYWwobSwgbm9kZS5pc1NraW5uZWRNZXNoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBjb252ZXJ0TWF0ZXJpYWwobm9kZS5tYXRlcmlhbCwgbm9kZS5pc1NraW5uZWRNZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKG9uTG9hZCkgb25Mb2FkKGdsdGYpOwogICAgICAgICAgICB9LCBvblByb2dyZXNzLCBvbkVycm9yKTsKICAgICAgICB9CiAgICB9Owp9KSgpOw==","Player.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBCYWxsIExhYiAvIERldlRvb2xzOiB0aHJvdyAmIGN1cnZlIG1hcHBpbmcga25vYnMKICAgIC8vIChEZWZhdWx0cyBtYXRjaCBjdXJyZW50IGZlZWw7IERldlRvb2xzIGNhbiB0d2VhayBhdCBydW50aW1lLikKICAgIHdpbmRvdy5mbHV4LlRocm93Q29uZmlnID0gd2luZG93LmZsdXguVGhyb3dDb25maWcgfHwgewogICAgICAgIFNXSVBFX01JTl9QWDogMjAsCiAgICAgICAgQUlNX0RYX1NDQUxFOiAxLjAsCiAgICAgICAgQUlNX0RZX1NDQUxFOiAxLjAsCgogICAgICAgIFBPV0VSX0JBU0U6IDEuMCwKICAgICAgICBQT1dFUl9SQU5HRTogMC44LCAgICAgICAgICAvLyBCYXNlIG11bHRpcGxpZXIgPSBQT1dFUl9CQVNFICsgcmF0aW8qUE9XRVJfUkFOR0UKICAgICAgICBQT1dFUl9NQVhfQk9OVVNfUkFUSU86IDAuOTUsCiAgICAgICAgUE9XRVJfTUFYX01VTFRJUExJRVI6IDIuNSwKCiAgICAgICAgQ1VSVkVfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBDVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEOiAwLjI1LAogICAgICAgIENVUlZFX1NQSU5fU0NBTEU6IDEwMDAuMCwKICAgICAgICBDVVJWRV9TUEVFRF9NVUxUOiAxLjUsCiAgICAgICAgQ1VSVkVfU1BJTl9DQVA6IDE1MDAuMCwKICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDUwMC4wCiAgICB9OwoKICAgIC8vIEFzc2lzdCBrbm9icyAoMC4uMSk6IGhlbHBzIG1ha2UgdGhlIGdhbWUgZmVlbCAic3BvcnR5IiArIGZsdWlkIHdpdGhvdXQgZ29pbmcgZnVsbCBhdXRvLgogICAgd2luZG93LmZsdXguQXNzaXN0Q29uZmlnID0gd2luZG93LmZsdXguQXNzaXN0Q29uZmlnIHx8IHsKICAgICAgICBQQVNTX0FJTV9BU1NJU1Q6IDAuNjUsCiAgICAgICAgU0hPVF9BSU1fQVNTSVNUOiAwLjM1LAogICAgICAgIENBVENIX0FTU0lTVDogMC41NSwKICAgICAgICBTVEVFUklOR19BU1NJU1Q6IDAuMzUsCiAgICAgICAgSU5QVVRfUkVTUE9OU0U6IDE0LjAsCiAgICAgICAgUEFTU19DT05FX0RFRzogNjAsCiAgICAgICAgU0hPVF9DT05FX0RFRzogMzUsCiAgICAgICAgUEFTU19MRUFEX1RJTUU6IDAuMjIsCiAgICAgICAgU0hPVF9MSUZUOiAwLjA4CiAgICB9OwoKLy8gUmV1c2FibGUgbWF0aCBvYmplY3RzCmNvbnN0IF9wVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9wVmVjMiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfcFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BRdWF0MiA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRhcmdldFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BFdWxlciA9IG5ldyBUSFJFRS5FdWxlcigpOwogICAgY29uc3QgX3BBeGlzWSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApOwogICAgY29uc3QgX3BBeGlzWiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpOwoKY2xhc3MgUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSA9ICdNRicpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLnJvbGUgPSByb2xlOwogICAgICAgICAgICB0aGlzLnRlYW0gPSBudWxsOyAvLyBBc3NpZ25lZCBieSBUZWFtLmFkZFBsYXllcgogICAgICAgICAgICB0aGlzLmhvbWVQb3NpdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLm1peGVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hY3Rpb25zID0ge307CiAgICAgICAgICAgIHRoaXMuYWN0aXZlQWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdpZGxlJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2xhc3RMb2NvbW90aW9uID0gJ2lkbGUnOwp0aGlzLmlucHV0VmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuZGVzaXJlZElucHV0VmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAvLyBQaHlzaWNzIChEcmlmdC9JbmVydGlhIE1vZGVsKQogICAgICAgICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYWNjZWxlcmF0aW9uID0gMTIuMDsKICAgICAgICAgICAgdGhpcy5kcmFnID0gMy4wOwogICAgICAgICAgICB0aGlzLm1heFNwZWVkID0gOC4wOwogICAgICAgICAgICAvLyBCb25lIHJlZmVyZW5jZSBmb3IgaG9sZGluZyBiYWxsCiAgICAgICAgICAgIHRoaXMuaGFuZEJvbmUgPSBudWxsOwp0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duID0gMDsgLy8gUmVwbGFjZXMgc2V0VGltZW91dCBmb3Igc2FmZXR5CgogICAgICAgICAgICAvLyBCbGl0emJhbGwgU3RhdHMKICAgICAgICAgICAgdGhpcy5zdGF0cyA9IHsKICAgICAgICAgICAgICAgIEhQOiAxMDAsCiAgICAgICAgICAgICAgICBtYXhIUDogMTAwLAogICAgICAgICAgICAgICAgRU46IDMwLAogICAgICAgICAgICAgICAgQVQ6IDEwLAogICAgICAgICAgICAgICAgUEE6IDE1LAogICAgICAgICAgICAgICAgQkw6IDEwLAogICAgICAgICAgICAgICAgU0g6IDE1LAogICAgICAgICAgICAgICAgQ0E6IDEwLAogICAgICAgICAgICAgICAgU1A6IDYwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBMZXZlbGluZyBTeXN0ZW0KICAgICAgICAgICAgdGhpcy5sZXZlbCA9IDE7CiAgICAgICAgICAgIHRoaXMuZXhwID0gMDsKICAgICAgICAgICAgdGhpcy5uZXh0TGV2ZWxFeHAgPSAxMDA7CgogICAgICAgICAgICAvLyBTdGF0dXMgRWZmZWN0cyAmIFRlY2huaXF1ZXMKICAgICAgICAgICAgdGhpcy5zdGF0dXMgPSB7CiAgICAgICAgICAgICAgICB2ZW5vbTogMCwKICAgICAgICAgICAgICAgIG5hcDogMCwKICAgICAgICAgICAgICAgIHdpdGhlcjogeyBQQTogMCwgU0g6IDAsIEFUOiAwLCBCTDogMCwgQ0E6IDAsIFNQOiAwIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMubWFya2luZyA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubGVhcm5lZFRlY2hzID0gW107CgogICAgICAgICAgICB0aGlzLnRlY2hzID0gewogICAgICAgICAgICAgICAgdGFja2xlOiBudWxsLAogICAgICAgICAgICAgICAgc2hvb3Q6IG51bGwsCiAgICAgICAgICAgICAgICBwYXNzOiBudWxsLAogICAgICAgICAgICAgICAgcGFzc2l2ZTogbnVsbAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVmlzdWFscwogICAgICAgICAgICB0aGlzLmJhc2VDb2xvckhleCA9IDB4ZmZmZmZmOwogICAgICAgICAgICB0aGlzLm9yaWdpbmFsTWF0ZXJpYWxzID0gW107CiAgICAgICAgICAgIHRoaXMuYXVyYU1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLnJvdGF0aW9uT2Zmc2V0ID0gMDsKdGhpcy5iYXNlU2NhbGUgPSAxLjE3OyAvLyBJbmNyZWFzZWQgfjglCgogICAgICAgICAgICAvLyBSZWFsLXRpbWUgU3RhdHMKICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSB0aGlzLnN0YXRzLkVOOwp0aGlzLnRhY2tsZVJhZGl1cyA9IDIuMDsgLy8gUmVkdWNlZCBmcm9tIDIuNSB0byByZWR1Y2Ugc3dhcm0gbG9jawoKICAgICAgICAgICAgdGhpcy5zcGVlZCA9IDQuMDsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CgogICAgICAgICAgICB0aGlzLmhhc0JhbGwgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBEYXNoIFN0YXRlCiAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmRhc2hUb3RhbFRpbWUgPSAwLjU7CnRoaXMuZGFzaENvb2xkb3duID0gMDsKICAgICAgICAgICAgdGhpcy5kYXNoVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIC8vIEZlZWRiYWNrIEFjY3VtdWxhdG9ycwogICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSA9IDA7CiAgICAgICAgICAgIHRoaXMuX2RhbWFnZVRpbWVyID0gMDsKCiAgICAgICAgICAgIC8vIEhQIEJhcgogICAgICAgICAgICB0aGlzLmhwQmFyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5ocEJhckZpbGwgPSBudWxsOwoKICAgICAgICAgICAgLy8gR2FtZXBsYXkgRmxvdyBUaW1lcnMKICAgICAgICAgICAgdGhpcy5zdHVuVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLmltbXVuaXR5VGltZXIgPSAwOwoKICAgICAgICAgICAgLy8gQmFua2luZyAmIFZlcnRpY2FsaXR5CiAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0WSA9IDA7CgogICAgICAgICAgICAvLyBFbmNvdW50ZXIgU3lzdGVtCiAgICAgICAgICAgIHRoaXMuaXNFbmdhZ2VkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY2xhc2hUaW1lciA9IDA7CgogICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsgLy8gVHJhY2sgZHVyYXRpb24gb2YgY3VycmVudCBlbmdhZ2VtZW50CiAgICAgICAgICAgIC8vIENoYXJnZSBNZWNoYW5pYwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jaGFyZ2VUaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5tYXhDaGFyZ2VUaW1lID0gMS41OwoKICAgICAgICAgICAgLy8gRklYRUQ6IEltcHJvdmVkIFJvdGF0aW9uIFN0YXRlIHdpdGggaHlzdGVyZXNpcwogICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IDA7CiAgICAgICAgICAgIHRoaXMubGFzdFZhbGlkWWF3ID0gMDsgLy8gU3RvcmUgbGFzdCBrbm93biBnb29kIHlhdyBmb3IgZGVhZHpvbmUgaGFuZGxpbmcKICAgICAgICAgICAgdGhpcy5waXRjaEFtb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMuZmFjaW5nRGVhZHpvbmUgPSAwLjM7IC8vIE1pbmltdW0gaW5wdXQvdmVsb2NpdHkgbWFnbml0dWRlIHRvIHVwZGF0ZSBmYWNpbmcKCiAgICAgICAgICAgIC8vIFBhcnRpY2xlIEVtaXNzaW9uIFRpbWVycwogICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycyA9IHsKICAgICAgICAgICAgICAgIHZlbm9tOiAwLAogICAgICAgICAgICAgICAgbmFwOiAwLAogICAgICAgICAgICAgICAgd2l0aGVyOiAwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBEZXZUb29scyBGbGFncwogICAgICAgICAgICB0aGlzLmlzR29kTW9kZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUGFzcyBUYXJnZXQgSW5kaWNhdG9yCi8vIFBhc3MgVGFyZ2V0IEluZGljYXRvcgogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IgPSBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQnViYmxlIFRyYWlsIFRpbWVyCiAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMDsKCnRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyID0gMDsKICAgICAgICB9CgogICAgICAgIHN5bmNSb3RhdGlvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgZXVsZXIgPSBuZXcgVEhSRUUuRXVsZXIoKS5zZXRGcm9tUXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbiwgJ1lYWicpOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgPSBldWxlci55IC0gdGhpcy5yb3RhdGlvbk9mZnNldDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgIHRoaXMubGFzdFZhbGlkWWF3ID0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ID0gMDsKICAgICAgICB9CgogICAgICAgIGdldFN0YXQobmFtZSkgewogICAgICAgICAgICBsZXQgdmFsID0gdGhpcy5zdGF0c1tuYW1lXTsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltuYW1lXSA+IDApIHsKICAgICAgICAgICAgICAgIHZhbCAqPSAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICB9CgogICAgICAgIGFwcGx5U3RhdHVzKHR5cGUsIGR1cmF0aW9uLCBzdWJUeXBlID0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMudmVub20gPiAxLjA7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy52ZW5vbSA9IE1hdGgubWF4KHRoaXMuc3RhdHVzLnZlbm9tLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnJvbGV9IHBvaXNvbmVkIWApOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQT0lTT04iLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMubmFwID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gTWF0aC5tYXgodGhpcy5zdGF0dXMubmFwLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gZmVsbCBhc2xlZXAhYCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNMRUVQIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3dpdGhlcicgJiYgc3ViVHlwZSkgewogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFZhbCA9IHRoaXMuc3RhdHVzLndpdGhlcltzdWJUeXBlXSB8fCAwOwogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gY3VycmVudFZhbCA+IDEuMDsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLndpdGhlcltzdWJUeXBlXSA9IE1hdGgubWF4KGN1cnJlbnRWYWwsIGR1cmF0aW9uKTsKCiAgICAgICAgICAgICAgICBpZiAoIXdhc0FjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gd2l0aGVyZWQgJHtzdWJUeXBlfSFgKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgV0lUSEVSICR7c3ViVHlwZX1gLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZURlcml2ZWRTdGF0cygpIHsKICAgICAgICAgICAgY29uc3Qgc3AgPSB0aGlzLmdldFN0YXQoJ1NQJyk7CiAgICAgICAgICAgIHRoaXMubWF4U3BlZWQgPSA1LjAgKyAoc3AgLyAxNS4wKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSB0aGlzLmdldFN0YXQoJ0VOJyk7CiAgICAgICAgfQoKc2V0TWVzaChzb3VyY2VNZXNoLCBhbmltYXRpb25zKSB7CiAgICAgICAgICAgIHRoaXMubWVzaCA9IHNvdXJjZU1lc2g7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUhQQmFyKCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUF1cmEoKTsKICAgICAgICAgICAgdGhpcy5fY3JlYXRlUGFzc1RhcmdldEluZGljYXRvcigpOwoKICAgICAgICAgICAgLy8gQ3VzdG9tIENoYXJhY3RlciBTY2FsaW5nCiAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUuaW5jbHVkZXMoJ1RpZHVzJykpIHRoaXMuYmFzZVNjYWxlID0gMS42OwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB0aGlzLmJhc2VTY2FsZSA9IDEuNDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXNoLnNjYWxlLnNldFNjYWxhcih0aGlzLmJhc2VTY2FsZSk7CgogICAgICAgICAgICB0aGlzLm1lc2gudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCAmJiBub2RlLm1hdGVyaWFsKSB7CmNvbnN0IGNvbnZlcnRPbmUgPSAobWF0KSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG0gPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwOiBtYXQubWFwIHx8IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogbmV3IFRIUkVFLkNvbG9yKDB4ZmZmZmZmKSwgLy8gRk9SQ0UgV0hJVEU6IElnbm9yZSBzb3VyY2UgY29sb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiAhIW1hdC50cmFuc3BhcmVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IChtYXQub3BhY2l0eSAhPT0gdW5kZWZpbmVkID8gbWF0Lm9wYWNpdHkgOiAxKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFscGhhVGVzdDogKG1hdC5hbHBoYVRlc3QgIT09IHVuZGVmaW5lZCA/IG1hdC5hbHBoYVRlc3QgOiAwKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpZGU6IG1hdC5zaWRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwdGhUZXN0OiBtYXQuZGVwdGhUZXN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogbWF0LmRlcHRoV3JpdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb2c6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBza2lubmluZzogISFub2RlLmlzU2tpbm5lZE1lc2gKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMucHVzaCh7IG1hdGVyaWFsOiBtLCBiYXNlQ29sb3I6IG0uY29sb3IuY2xvbmUoKSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG07CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gQXJyYXkuaXNBcnJheShub2RlLm1hdGVyaWFsKQogICAgICAgICAgICAgICAgICAgICAgICA/IG5vZGUubWF0ZXJpYWwubWFwKGNvbnZlcnRPbmUpCiAgICAgICAgICAgICAgICAgICAgICAgIDogY29udmVydE9uZShub2RlLm1hdGVyaWFsKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAobm9kZS5pc0JvbmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gbm9kZS5uYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKChuYW1lLmluY2x1ZGVzKCdoYW5kJykgJiYgbmFtZS5pbmNsdWRlcygncicpKSB8fCBuYW1lLmluY2x1ZGVzKCdyaWdodGhhbmQnKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRCb25lID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5taXhlciA9IG5ldyBUSFJFRS5BbmltYXRpb25NaXhlcih0aGlzLm1lc2gpOwoKICAgICAgICAgICAgLy8gTGF5ZXJlZCBhbmltYXRpb24gc3lzdGVtIChsb2NvbW90aW9uIGJhc2UgKyB1cHBlci1ib2R5IG92ZXJsYXkgKyBmdWxsLWJvZHkgb25lLXNob3RzKQogICAgICAgICAgICB0aGlzLmNsaXBzID0ge307CiAgICAgICAgICAgIHRoaXMudXBwZXJBY3Rpb25zID0ge307CiAgICAgICAgICAgIHRoaXMuYmFzZUFjdGlvbnMgPSB7fTsKICAgICAgICAgICAgdGhpcy5hY3RpdmVVcHBlckFjdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX3VwcGVyTG9ja2VkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX3VwcGVyTG9ja2VkU3RhdGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLl9sYXllcmVkRW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX2xvY29tb3Rpb25GYWRlID0gMC4yOwogICAgICAgICAgICB0aGlzLl9hbmltU3BlZWRTbW9vdGhlZCA9IDA7CiAgICAgICAgICAgIHRoaXMuX2Jhc2VTdXBwcmVzc2lvbiA9IDA7CgoKICAgICAgICAgICAgaWYgKGFuaW1hdGlvbnMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IF9ub3JtQ2xpcE5hbWUgPSAocykgPT4gKHMgfHwgJycpCiAgICAgICAgICAgICAgICAgICAgLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvW19cLV0rL2csICcgJykKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXHMrL2csICcgJykKICAgICAgICAgICAgICAgICAgICAudHJpbSgpOwoKICAgICAgICAgICAgICAgIGFuaW1hdGlvbnMuZm9yRWFjaCgoY2xpcCkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBfbm9ybUNsaXBOYW1lKGNsaXAubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWN0aW9uID0gdGhpcy5taXhlci5jbGlwQWN0aW9uKGNsaXApOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhcyA9IChyZSkgPT4gcmUudGVzdChuYW1lKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVnID0gKGtleSkgPT4geyB0aGlzLmFjdGlvbnNba2V5XSA9IGFjdGlvbjsgdGhpcy5jbGlwc1trZXldID0gY2xpcDsgfTsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIENvcmUgbG9jb21vdGlvbiAtLS0KICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC90cmVhZHx0cmVhZGluZ3xpZGxlfGZsb2F0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnKCdpZGxlJyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2Rhc2h8c3ByaW50fGJ1cnN0fGZhc3Rccypzd2ltfHN3aW1ccypmYXN0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnKCdkYXNoJyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3N3aW18ZnJlZXN0eWxlfGNyYXdsLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnKCdzd2ltJyk7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBUaHJvd2luZyAocGFzcy9zaG90IHZhcmlhbnRzIGlmIHByZXNlbnQpIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC90aHJvd3x0b3NzfHBpdGNoLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhcygvc2hvb3R8c2hvdHxnb2FsLykpIHJlZygndGhyb3dfc2hvdCcpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChoYXMoL3Bhc3MvKSkgcmVnKCd0aHJvd19wYXNzJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgcmVnKCd0aHJvdycpOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gQ2F0Y2hpbmcgKGp1bXAvYWlyIHZhcmlhbnRzIGlmIHByZXNlbnQpIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jYXRjaHxyZWNlaXZlfGdyYWJ8aW50ZXJjZXB0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhcygvanVtcHxsZWFwfGFpcnxkaXZlLykpIHJlZygnY2F0Y2hfanVtcCcpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHJlZygnY2F0Y2gnKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIEhpdCAvIFJlYWN0IC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9yZWFjdHxoaXR8aHVydHxkYW1hZ2V8c3RhZ2dlcnxrbm9jay8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZygncmVhY3QnKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIE9wdGlvbmFsIHN0YXRlcyAob25seSB1c2VkIGlmIGNsaXBzIGV4aXN0KSAtLS0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvY2hhcmdlfGFpbXxyZWFkeXx3aW5kdXB8aG9sZC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZygnY2hhcmdlJyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3RhY2tsZXxjaGVja3xyYW0vKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZWcoJ3RhY2tsZScpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9ibG9ja3xzYXZlLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnKCdibG9jaycpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jZWxlYnJhdGV8dmljdG9yeXxjaGVlci8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZygnY2VsZWJyYXRlJyk7CgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aW9uc1tjbGlwLm5hbWVdID0gYWN0aW9uOyB0aGlzLmNsaXBzW2NsaXAubmFtZV0gPSBjbGlwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CmlmICh0aGlzLmFjdGlvbnNbJ2lkbGUnXSkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2xheWVyZWRFbmFibGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW4gbGF5ZXJlZCBtb2RlIHdlIGRvbid0IHVzZSB0aGUgc2luZ2xlLWFjdGlvbiBzdGF0ZSBtYWNoaW5lLgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFjdGlvbnNbJ2lkbGUnXS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3Rpb25zWydpZGxlJ10ucGxheSgpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgZmlyc3QgPSBPYmplY3QudmFsdWVzKHRoaXMuYWN0aW9ucylbMF07CiAgICAgICAgICAgICAgICBpZihmaXJzdCkgZmlyc3QucGxheSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIGxheWVyZWQgbWl4aW5nIGlmIGVuYWJsZWQuCiAgICAgICAgICAgIGlmICh0aGlzLl9sYXllcmVkRW5hYmxlZCkgewogICAgICAgICAgICAgICAgdGhpcy5faW5pdExheWVyZWRBbmltYXRpb24oKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBPbmUtc2hvdCBhbmltYXRpb24gbG9jazogcHJldmVudCBsb2NvbW90aW9uIGZyb20gaW50ZXJydXB0aW5nIHRocm93L2NhdGNoL3JlYWN0LgogICAgICAgICAgICAvLyBXaGVuIGEgb25lLXNob3QgZmluaXNoZXMsIGF1dG9tYXRpY2FsbHkgcmV0dXJuIHRvIGxvY29tb3Rpb24uCiAgICAgICAgICAgIGlmICh0aGlzLm1peGVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1peGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2ZpbmlzaGVkJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2FuaW1Mb2NrZWQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBpZiAoIWUgfHwgIWUuYWN0aW9uKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgIC8vIFVwcGVyLWJvZHkgb25lLXNob3QgaGFuZGxpbmcKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fdXBwZXJMb2NrZWQgJiYgdGhpcy5hY3RpdmVVcHBlckFjdGlvbiAmJiBlLmFjdGlvbiA9PT0gdGhpcy5hY3RpdmVVcHBlckFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl91cHBlckxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl91cHBlckxvY2tlZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsgZS5hY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsgZS5hY3Rpb24uZmFkZU91dCgwLjA4KTsgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVVcHBlckFjdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChlLmFjdGlvbiAhPT0gdGhpcy5hY3RpdmVBY3Rpb24pIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvY2tlZFN0YXRlID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgLy8gVW5jbGFtcCBzbyBmdXR1cmUgcGxheXMgZG9uJ3QgZnJlZXplIG9uIGxhc3QgZnJhbWUuCiAgICAgICAgICAgICAgICAgICAgdHJ5IHsgZS5hY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsgfSBjYXRjaCAoXykge30KCiAgICAgICAgICAgICAgICAgICAgLy8gUmV0dXJuIHRvIGxvY29tb3Rpb24gdW5sZXNzIGFub3RoZXIgb3ZlcnJpZGUgaXMgYWN0aXZlLgogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMTUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9Cgp9CgpwbGF5KGFjdGlvbk5hbWUsIGR1cmF0aW9uID0gMC41KSB7CiAgICAgICAgICAgIGNvbnN0IG5ld0FjdGlvbiA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFuZXdBY3Rpb24gfHwgbmV3QWN0aW9uID09PSB0aGlzLmFjdGl2ZUFjdGlvbikgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZlQWN0aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUFjdGlvbi5mYWRlT3V0KGR1cmF0aW9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbmV3QWN0aW9uLnJlc2V0KCk7CiAgICAgICAgICAgIG5ld0FjdGlvbi5mYWRlSW4oZHVyYXRpb24pOwogICAgICAgICAgICBuZXdBY3Rpb24ucGxheSgpOwogICAgICAgICAgICB0aGlzLmFjdGl2ZUFjdGlvbiA9IG5ld0FjdGlvbjsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlTG9jb21vdGlvbkFuaW0oZHVyYXRpb24gPSAwLjIpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2xheWVyZWRFbmFibGVkKSB7IHRoaXMuX2xvY29tb3Rpb25GYWRlID0gZHVyYXRpb247IHJldHVybjsgfQoKICAgICAgICAgICAgaWYgKHRoaXMuX2FuaW1Mb2NrZWQpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHZ4ID0gdGhpcy52ZWxvY2l0eSA/IHRoaXMudmVsb2NpdHkueCA6IDA7CiAgICAgICAgICAgIGNvbnN0IHZ6ID0gdGhpcy52ZWxvY2l0eSA/IHRoaXMudmVsb2NpdHkueiA6IDA7CgogICAgICAgICAgICBjb25zdCBpbnB1dE1vdmluZyA9IHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wNTsKICAgICAgICAgICAgY29uc3QgdmVsTW92aW5nID0gKHZ4ICogdnggKyB2eiAqIHZ6KSA+IDAuMDI7CgogICAgICAgICAgICBjb25zdCBtb3ZpbmcgPSBpbnB1dE1vdmluZyB8fCB2ZWxNb3Zpbmc7CgogICAgICAgICAgICBsZXQgdGFyZ2V0ID0gbW92aW5nID8gJ3N3aW0nIDogJ2lkbGUnOwogICAgICAgICAgICBpZiAobW92aW5nICYmIHRoaXMuaXNEYXNoaW5nICYmIHRoaXMuYWN0aW9uc1snZGFzaCddKSB0YXJnZXQgPSAnZGFzaCc7CgogICAgICAgICAgICAvLyBPcHRpb25hbDogd2hpbGUgc3RhdGlvbmFyeSBhbmQgY2hhcmdpbmcsIHByZWZlciBhIGNoYXJnZS9haW0gbG9vcCBpZiBpdCBleGlzdHMuCiAgICAgICAgICAgIGlmICghbW92aW5nICYmIHRoaXMuaXNDaGFyZ2luZyAmJiB0aGlzLmFjdGlvbnNbJ2NoYXJnZSddKSB0YXJnZXQgPSAnY2hhcmdlJzsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSB0YXJnZXQpIHsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBsb29waW5nIGZvciBsb2NvbW90aW9uLXN0eWxlIGNsaXBzCiAgICAgICAgICAgICAgICBjb25zdCBhID0gdGhpcy5hY3Rpb25zW3RhcmdldF07CiAgICAgICAgICAgICAgICBpZiAoYSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7IGEuc2V0TG9vcChUSFJFRS5Mb29wUmVwZWF0KTsgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgICAgICAgICBhLmNsYW1wV2hlbkZpbmlzaGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnBsYXkodGFyZ2V0LCBkdXJhdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLl9sYXN0TG9jb21vdGlvbiA9IHRhcmdldDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcGxheU9uZVNob3QoYWN0aW9uTmFtZSwgZHVyYXRpb24gPSAwLjEsIG9wdHMgPSB7fSkgewogICAgICAgICAgICAvLyBJbiBsYXllcmVkIG1vZGUsIHJvdXRlIHRocm93cy9jYXRjaGVzIHRvIHRoZSB1cHBlci1ib2R5IGxheWVyIHNvIHBsYXllcnMgY2FuIGtlZXAgc3dpbW1pbmcuCiAgICAgICAgICAgIGlmICh0aGlzLl9sYXllcmVkRW5hYmxlZCkgewogICAgICAgICAgICAgICAgY29uc3QgdXBwZXJLZXlzID0gewogICAgICAgICAgICAgICAgICAgICd0aHJvdyc6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgJ3Rocm93X3Bhc3MnOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICd0aHJvd19zaG90JzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAnY2F0Y2gnOiB0cnVlCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaWYgKHVwcGVyS2V5c1thY3Rpb25OYW1lXSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wbGF5VXBwZXJPbmVTaG90KGFjdGlvbk5hbWUsIGR1cmF0aW9uLCBvcHRzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYSA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFhKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICAvLyBMb2NrIGxvY29tb3Rpb24gc28gaXQgZG9lc24ndCBzdG9tcCB0aGUgb25lLXNob3QuCiAgICAgICAgICAgIHRoaXMuX2FuaW1Mb2NrZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IGFjdGlvbk5hbWU7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgYS5yZXNldCgpOwogICAgICAgICAgICAgICAgYS5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgIGEuY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgYS50aW1lU2NhbGUgPSAob3B0cy50aW1lU2NhbGUgIT09IHVuZGVmaW5lZCA/IG9wdHMudGltZVNjYWxlIDogMS4wKTsKICAgICAgICAgICAgfSBjYXRjaCAoXykge30KCiAgICAgICAgICAgIHRoaXMucGxheShhY3Rpb25OYW1lLCBkdXJhdGlvbik7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBzZXRJbnB1dCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRlc2lyZWRJbnB1dFZlY3Rvci5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmRlc2lyZWRJbnB1dFZlY3Rvci5zZXQoeCwgMCwgeik7CiAgICAgICAgfQoKcmVjZWl2ZUJhbGwoKSB7CiAgICAgICAgICAgIHRoaXMuY2FuQ2F0Y2ggPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENSSVRJQ0FMIEZJWDogUmVzZXQgc3RhdGVzIHRoYXQgbWlnaHQgcHJldmVudCBzaG9vdGluZwogICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2hpZGVDaGFyZ2VVSSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLm5hcCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuaGFzQmFsbCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuaW1tdW5pdHlUaW1lciA9IDIuMDsKCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5sYXN0SG9sZGVyICYmIGJhbGwubGFzdEhvbGRlci50ZWFtID09PSB0aGlzLnRlYW0gJiYgYmFsbC5sYXN0SG9sZGVyICE9PSB0aGlzKSB7CiAgICAgICAgICAgICAgICBiYWxsLmxhc3RIb2xkZXIuZ2FpbkV4cCgyKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FpbkV4cCgxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYmFsbFkgPSAodGhpcy5iYWxsUmVmICYmIHRoaXMuYmFsbFJlZi5tZXNoKSA/IHRoaXMuYmFsbFJlZi5tZXNoLnBvc2l0aW9uLnkgOiAwOwogICAgICAgICAgICBjb25zdCBjYXRjaEtleSA9IChiYWxsWSA+IDAuMjUgJiYgdGhpcy5hY3Rpb25zWydjYXRjaF9qdW1wJ10pID8gJ2NhdGNoX2p1bXAnIDogJ2NhdGNoJzsKICAgICAgICAgICAgdGhpcy5wbGF5T25lU2hvdChjYXRjaEtleSwgMC4xKTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTTkFQISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWFjdGlvbiIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICAgICAgX2luaXRMYXllcmVkQW5pbWF0aW9uKCkgewogICAgICAgICAgICAvLyBCYXNlIGxheWVyOiBpZGxlL3N3aW0vZGFzaCBhcmUgYWx3YXlzIHBsYXlpbmcsIHdlIGp1c3QgYmxlbmQgd2VpZ2h0cy4KICAgICAgICAgICAgY29uc3QgZW5zdXJlTG9vcGluZyA9IChhKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWEpIHJldHVybjsKICAgICAgICAgICAgICAgIHRyeSB7IGEuc2V0TG9vcChUSFJFRS5Mb29wUmVwZWF0KTsgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgICAgIGEuY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGEuZW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBpZGxlID0gdGhpcy5hY3Rpb25zWydpZGxlJ10gfHwgbnVsbDsKICAgICAgICAgICAgY29uc3Qgc3dpbSA9IHRoaXMuYWN0aW9uc1snc3dpbSddIHx8IG51bGw7CiAgICAgICAgICAgIGNvbnN0IGRhc2ggPSB0aGlzLmFjdGlvbnNbJ2Rhc2gnXSB8fCBudWxsOwoKICAgICAgICAgICAgdGhpcy5iYXNlQWN0aW9ucy5pZGxlID0gaWRsZTsKICAgICAgICAgICAgdGhpcy5iYXNlQWN0aW9ucy5zd2ltID0gc3dpbTsKICAgICAgICAgICAgdGhpcy5iYXNlQWN0aW9ucy5kYXNoID0gZGFzaDsKCiAgICAgICAgICAgIC8vIFN0YXJ0IGJhc2UgYWN0aW9ucyBzbyB3ZSBjYW4gYmxlbmQgd2VpZ2h0cyB3aXRob3V0IHJlc3RhcnRpbmcgY2xpcHMgKHNtb290aGVyIG9uIG1vYmlsZSkuCiAgICAgICAgICAgIFtpZGxlLCBzd2ltLCBkYXNoXS5mb3JFYWNoKChhKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWEpIHJldHVybjsKICAgICAgICAgICAgICAgIGVuc3VyZUxvb3BpbmcoYSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGEucGxheSgpOwogICAgICAgICAgICAgICAgICAgIGEuc2V0RWZmZWN0aXZlV2VpZ2h0KDApOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBVcHBlci1ib2R5IGxheWVyOiBmaWx0ZXJlZCBjbGlwcyBmb3IgdGhyb3cvY2F0Y2gvY2hhcmdlIChvbmx5IHVwcGVyIGJvbmVzKS4KICAgICAgICAgICAgY29uc3QgdXBwZXJIaW50cyA9IFsnc3BpbmUnLCdjaGVzdCcsJ25lY2snLCdoZWFkJywnc2hvdWxkZXInLCdjbGF2aWNsZScsJ2FybScsJ2ZvcmVhcm0nLCdoYW5kJywnd3Jpc3QnLCd0aHVtYicsJ2ZpbmdlciddOwogICAgICAgICAgICBjb25zdCBpc1VwcGVyQm9uZU5hbWUgPSAoYm9uZU5hbWUpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IG4gPSAoYm9uZU5hbWUgfHwgJycpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGggb2YgdXBwZXJIaW50cykgaWYgKG4uaW5jbHVkZXMoaCkpIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgZmlsdGVyQ2xpcFRyYWNrcyA9IChjbGlwLCBwcmVkaWNhdGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghY2xpcCkgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICBjb25zdCB0cmFja3MgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdCBvZiAoY2xpcC50cmFja3MgfHwgW10pKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhY2tOYW1lID0gdC5uYW1lIHx8ICcnOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJvbmVOYW1lID0gdHJhY2tOYW1lLnNwbGl0KCcuJylbMF07CiAgICAgICAgICAgICAgICAgICAgaWYgKHByZWRpY2F0ZShib25lTmFtZSkpIHRyYWNrcy5wdXNoKHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCF0cmFja3MubGVuZ3RoKSByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIGNvbnN0IGZpbHRlcmVkID0gY2xpcC5jbG9uZSgpOwogICAgICAgICAgICAgICAgZmlsdGVyZWQudHJhY2tzID0gdHJhY2tzOwogICAgICAgICAgICAgICAgZmlsdGVyZWQubmFtZSA9IChjbGlwLm5hbWUgfHwgJ2NsaXAnKSArICJfVVBQRVIiOwogICAgICAgICAgICAgICAgcmV0dXJuIGZpbHRlcmVkOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgbWFrZVVwcGVyQWN0aW9uID0gKGtleSwgbG9vcE1vZGUpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGNsaXAgPSB0aGlzLmNsaXBzW2tleV07CiAgICAgICAgICAgICAgICBpZiAoIWNsaXApIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgY29uc3QgdXBwZXJDbGlwID0gZmlsdGVyQ2xpcFRyYWNrcyhjbGlwLCBpc1VwcGVyQm9uZU5hbWUpOwogICAgICAgICAgICAgICAgaWYgKCF1cHBlckNsaXApIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgY29uc3QgYSA9IHRoaXMubWl4ZXIuY2xpcEFjdGlvbih1cHBlckNsaXApOwogICAgICAgICAgICAgICAgYS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChsb29wTW9kZSA9PT0gJ2xvb3AnKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsgYS5zZXRMb29wKFRIUkVFLkxvb3BSZXBlYXQpOyB9IGNhdGNoIChfKSB7fQogICAgICAgICAgICAgICAgICAgIGEuY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsgYS5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgICAgICAgICBhLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgYS5zZXRFZmZlY3RpdmVXZWlnaHQoMCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxvb3BNb2RlID09PSAnbG9vcCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYS5wbGF5KCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYS5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgICAgIHRoaXMudXBwZXJBY3Rpb25zW2tleV0gPSBhOwogICAgICAgICAgICAgICAgcmV0dXJuIGE7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBQcmVmZXJyZWQgdXBwZXIgb3ZlcmxheSBjbGlwcyAoaWYgdGhleSBleGlzdCkKICAgICAgICAgICAgbWFrZVVwcGVyQWN0aW9uKCdjaGFyZ2UnLCAnbG9vcCcpOwogICAgICAgICAgICBtYWtlVXBwZXJBY3Rpb24oJ3Rocm93JywgJ29uY2UnKTsKICAgICAgICAgICAgbWFrZVVwcGVyQWN0aW9uKCd0aHJvd19wYXNzJywgJ29uY2UnKTsKICAgICAgICAgICAgbWFrZVVwcGVyQWN0aW9uKCd0aHJvd19zaG90JywgJ29uY2UnKTsKICAgICAgICAgICAgbWFrZVVwcGVyQWN0aW9uKCdjYXRjaCcsICdvbmNlJyk7CgogICAgICAgICAgICAvLyBTdGFydCB3aXRoIHNhbmUgZGVmYXVsdHMKICAgICAgICAgICAgdGhpcy5fYW5pbVNwZWVkU21vb3RoZWQgPSAwOwogICAgICAgICAgICB0aGlzLl9iYXNlU3VwcHJlc3Npb24gPSAwOwogICAgICAgIH0KCiAgICAgICAgX3BsYXlVcHBlck9uZVNob3QoYWN0aW9uTmFtZSwgZmFkZSA9IDAuMDgsIG9wdHMgPSB7fSkgewogICAgICAgICAgICBjb25zdCBhID0gdGhpcy51cHBlckFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgIGlmICghYSkgewogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gZnVsbC1ib2R5IG9uZS1zaG90IGlmIG5vIHVwcGVyIGNsaXAgZXhpc3RzLgogICAgICAgICAgICAgICAgY29uc3QgZmEgPSB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgICAgICBpZiAoIWZhKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IGFjdGlvbk5hbWU7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZlQWN0aW9uICYmIHRoaXMuYWN0aXZlQWN0aW9uICE9PSBmYSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7IHRoaXMuYWN0aXZlQWN0aW9uLmZhZGVPdXQoZmFkZSk7IH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBmYS5yZXNldCgpOwogICAgICAgICAgICAgICAgICAgIGZhLmVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGZhLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgIGZhLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBmYS5zZXRFZmZlY3RpdmVUaW1lU2NhbGUob3B0cy50aW1lU2NhbGUgIT09IHVuZGVmaW5lZCA/IG9wdHMudGltZVNjYWxlIDogMS4wKTsKICAgICAgICAgICAgICAgICAgICBmYS5zZXRFZmZlY3RpdmVXZWlnaHQoMS4wKTsKICAgICAgICAgICAgICAgICAgICBmYS5mYWRlSW4oZmFkZSk7CiAgICAgICAgICAgICAgICAgICAgZmEucGxheSgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoXykge30KCiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUFjdGlvbiA9IGZhOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGFjdGlvbk5hbWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3RvcCBhbnkgY3VycmVudCB1cHBlciBvbmUtc2hvdAogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVVcHBlckFjdGlvbiAmJiB0aGlzLmFjdGl2ZVVwcGVyQWN0aW9uICE9PSBhKSB7CiAgICAgICAgICAgICAgICB0cnkgeyB0aGlzLmFjdGl2ZVVwcGVyQWN0aW9uLmZhZGVPdXQoMC4wNik7IH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwcGVyTG9ja2VkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5fdXBwZXJMb2NrZWRTdGF0ZSA9IGFjdGlvbk5hbWU7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlVXBwZXJBY3Rpb24gPSBhOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGEucmVzZXQoKTsKICAgICAgICAgICAgICAgIGEuZW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBhLnNldEVmZmVjdGl2ZVRpbWVTY2FsZShvcHRzLnRpbWVTY2FsZSAhPT0gdW5kZWZpbmVkID8gb3B0cy50aW1lU2NhbGUgOiAxLjApOwogICAgICAgICAgICAgICAgYS5zZXRFZmZlY3RpdmVXZWlnaHQoMS4wKTsKICAgICAgICAgICAgICAgIGEuc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICBhLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGEuZmFkZUluKGZhZGUpOwogICAgICAgICAgICAgICAgYS5wbGF5KCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKF8pIHt9CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIF9zZXRXZWlnaHQoYWN0aW9uLCB0YXJnZXQsIGxlcnBBbHBoYSkgewogICAgICAgICAgICBpZiAoIWFjdGlvbikgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBjdXIgPSAoYWN0aW9uLmdldEVmZmVjdGl2ZVdlaWdodCA/IGFjdGlvbi5nZXRFZmZlY3RpdmVXZWlnaHQoKSA6IDApIHx8IDA7CiAgICAgICAgICAgIGNvbnN0IG5leHQgPSBjdXIgKyAodGFyZ2V0IC0gY3VyKSAqIGxlcnBBbHBoYTsKICAgICAgICAgICAgdHJ5IHsgYWN0aW9uLnNldEVmZmVjdGl2ZVdlaWdodChuZXh0KTsgfSBjYXRjaCAoXykge30KICAgICAgICB9CgogICAgICAgIF91cGRhdGVMYXllcmVkQW5pbWF0aW9uKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5taXhlcikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gU21vb3RoIHNwZWVkIChoZWxwcyBvbiBtb2JpbGUgaml0dGVyKQogICAgICAgICAgICBjb25zdCB2eCA9IHRoaXMudmVsb2NpdHkgPyB0aGlzLnZlbG9jaXR5LnggOiAwOwogICAgICAgICAgICBjb25zdCB2eiA9IHRoaXMudmVsb2NpdHkgPyB0aGlzLnZlbG9jaXR5LnogOiAwOwogICAgICAgICAgICBjb25zdCBzcGVlZCA9IE1hdGguc3FydCh2eCAqIHZ4ICsgdnogKiB2eik7CiAgICAgICAgICAgIHRoaXMuX2FuaW1TcGVlZFNtb290aGVkICs9IChzcGVlZCAtIHRoaXMuX2FuaW1TcGVlZFNtb290aGVkKSAqIE1hdGgubWluKDEsIGR0ICogMTAuMCk7CgogICAgICAgICAgICAvLyBCYXNlIHN1cHByZXNzaW9uIGR1cmluZyBmdWxsLWJvZHkgb25lLXNob3RzCiAgICAgICAgICAgIGNvbnN0IHdhbnRTdXBwID0gdGhpcy5fYW5pbUxvY2tlZCA/IDEuMCA6IDAuMDsKICAgICAgICAgICAgdGhpcy5fYmFzZVN1cHByZXNzaW9uICs9ICh3YW50U3VwcCAtIHRoaXMuX2Jhc2VTdXBwcmVzc2lvbikgKiBNYXRoLm1pbigxLCBkdCAqIDE0LjApOwogICAgICAgICAgICBjb25zdCBiYXNlTXVsID0gMS4wIC0gdGhpcy5fYmFzZVN1cHByZXNzaW9uOwoKICAgICAgICAgICAgY29uc3QgZmFkZSA9ICh0aGlzLl9sb2NvbW90aW9uRmFkZSB8fCAwLjIpOwogICAgICAgICAgICBjb25zdCBsZXJwQWxwaGEgPSBNYXRoLm1pbigxLCBkdCAvIE1hdGgubWF4KDAuMDAwMSwgZmFkZSkpOwoKICAgICAgICAgICAgLy8gQmxlbmQgaWRsZSA8LT4gc3dpbSB1c2luZyBhIHNvZnQgdGhyZXNob2xkICsgaHlzdGVyZXNpcwogICAgICAgICAgICBjb25zdCBpbk1vdmUgPSAodGhpcy5pbnB1dFZlY3RvciAmJiB0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwLjA1KTsKICAgICAgICAgICAgY29uc3QgbW92aW5nID0gaW5Nb3ZlIHx8IHRoaXMuX2FuaW1TcGVlZFNtb290aGVkID4gMC4wODsKCiAgICAgICAgICAgIC8vIFNtb290aCBzd2ltIGJsZW5kCiAgICAgICAgICAgIGNvbnN0IHN3aW1CbGVuZCA9IG1vdmluZyA/IE1hdGgubWluKDEsIE1hdGgubWF4KDAsICh0aGlzLl9hbmltU3BlZWRTbW9vdGhlZCAtIDAuMDUpIC8gMC40NSkpIDogMDsKICAgICAgICAgICAgY29uc3QgZGFzaEJsZW5kID0gKHRoaXMuaXNEYXNoaW5nICYmIHRoaXMuYmFzZUFjdGlvbnMuZGFzaCkgPyAxIDogMDsKCiAgICAgICAgICAgIGNvbnN0IGlkbGVXID0gKDEgLSBzd2ltQmxlbmQpICogKDEgLSBkYXNoQmxlbmQpICogYmFzZU11bDsKICAgICAgICAgICAgY29uc3Qgc3dpbVcgPSAoc3dpbUJsZW5kKSAqICgxIC0gZGFzaEJsZW5kKSAqIGJhc2VNdWw7CiAgICAgICAgICAgIGNvbnN0IGRhc2hXID0gKGRhc2hCbGVuZCkgKiBiYXNlTXVsOwoKICAgICAgICAgICAgdGhpcy5fc2V0V2VpZ2h0KHRoaXMuYmFzZUFjdGlvbnMuaWRsZSwgaWRsZVcsIGxlcnBBbHBoYSk7CiAgICAgICAgICAgIHRoaXMuX3NldFdlaWdodCh0aGlzLmJhc2VBY3Rpb25zLnN3aW0sIHN3aW1XLCBsZXJwQWxwaGEpOwogICAgICAgICAgICB0aGlzLl9zZXRXZWlnaHQodGhpcy5iYXNlQWN0aW9ucy5kYXNoLCBkYXNoVywgbGVycEFscGhhKTsKCiAgICAgICAgICAgIC8vIFRpbWUtc2NhbGUgbG9jb21vdGlvbiBzbyBpdCBtYXRjaGVzIGFjdHVhbCBtb3Rpb24KICAgICAgICAgICAgaWYgKHRoaXMuYmFzZUFjdGlvbnMuc3dpbSkgewogICAgICAgICAgICAgICAgY29uc3QgdHMgPSAwLjc1ICsgTWF0aC5taW4oMS41LCB0aGlzLl9hbmltU3BlZWRTbW9vdGhlZCAqIDEuMik7CiAgICAgICAgICAgICAgICB0cnkgeyB0aGlzLmJhc2VBY3Rpb25zLnN3aW0uc2V0RWZmZWN0aXZlVGltZVNjYWxlKHRzKTsgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5iYXNlQWN0aW9ucy5kYXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0cyA9IDEuMSArIE1hdGgubWluKDEuMiwgdGhpcy5fYW5pbVNwZWVkU21vb3RoZWQgKiAwLjgpOwogICAgICAgICAgICAgICAgdHJ5IHsgdGhpcy5iYXNlQWN0aW9ucy5kYXNoLnNldEVmZmVjdGl2ZVRpbWVTY2FsZSh0cyk7IH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuYmFzZUFjdGlvbnMuaWRsZSkgewogICAgICAgICAgICAgICAgdHJ5IHsgdGhpcy5iYXNlQWN0aW9ucy5pZGxlLnNldEVmZmVjdGl2ZVRpbWVTY2FsZSgxLjApOyB9IGNhdGNoIChfKSB7fQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcHBlci1ib2R5IG92ZXJsYXkgKGFpbS9jaGFyZ2UgbG9vcCkgd2hlbiBob2xkaW5nIGJhbGwuCiAgICAgICAgICAgIGNvbnN0IGNoYXJnZUEgPSB0aGlzLnVwcGVyQWN0aW9uc1snY2hhcmdlJ10gfHwgbnVsbDsKICAgICAgICAgICAgY29uc3Qgd2FudHNDaGFyZ2UgPSAoIXRoaXMuX3VwcGVyTG9ja2VkKSAmJiBjaGFyZ2VBICYmIHRoaXMuaGFzQmFsbCAmJiAodGhpcy5pc0NoYXJnaW5nIHx8IHRoaXMuY2hhcmdlVGltZSA+IDAuMDUpOwogICAgICAgICAgICBjb25zdCBjaGFyZ2VUYXJnZXRXID0gd2FudHNDaGFyZ2UgPyAxLjAgOiAwLjA7CiAgICAgICAgICAgIHRoaXMuX3NldFdlaWdodChjaGFyZ2VBLCBjaGFyZ2VUYXJnZXRXLCBsZXJwQWxwaGEpOwoKICAgICAgICAgICAgaWYgKGNoYXJnZUEgJiYgd2FudHNDaGFyZ2UpIHsKICAgICAgICAgICAgICAgIHRyeSB7IGNoYXJnZUEuc2V0RWZmZWN0aXZlVGltZVNjYWxlKDEuMCk7IH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElmIGZ1bGwtYm9keSBvbmUtc2hvdCBpcyBhY3RpdmUsIGFsc28gZGFtcCB1cHBlciBvdmVybGF5IHNvIGl0IGRvZXNuJ3QgZmlnaHQuCiAgICAgICAgICAgIGlmICh0aGlzLl9hbmltTG9ja2VkICYmIGNoYXJnZUEpIHsKICAgICAgICAgICAgICAgIHRyeSB7IGNoYXJnZUEuc2V0RWZmZWN0aXZlV2VpZ2h0KDApOyB9IGNhdGNoIChfKSB7fQogICAgICAgICAgICB9CiAgICAgICAgfQoKCnRocm93QmFsbChiYWxsLCBmb3JjZWRUeXBlID0gbnVsbCwgcG93ZXJNdWx0aXBsaWVyID0gMS4wLCBmb3JjZWRTcGluID0gbnVsbCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaGFzQmFsbCB8fCB0aGlzLmlzVGhyb3dpbmcpIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKCiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IHRydWU7CgogICAgICAgICAgICAvLyBMb2NrIGFpbSBkaXJlY3Rpb24gYXQgc3RhcnQgb2YgdGhyb3cKICAgICAgICAgICAgdGhpcy5sb2NrZWRBaW1WZWN0b3IgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKSA+IDAuMSkgewogICAgICAgICAgICAgICAgdGhpcy5sb2NrZWRBaW1WZWN0b3IuY29weSh0aGlzLmlucHV0VmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMubG9ja2VkQWltVmVjdG9yLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9Cgpjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLTQ2IDogNDY7CiAgICAgICAgICAgIGNvbnN0IGRpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKCiAgICAgICAgICAgIGxldCB0eXBlID0gZm9yY2VkVHlwZTsKICAgICAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICAgICAgICB0eXBlID0gKGRpc3RUb0dvYWwgPCAyNSkgPyAnU0gnIDogJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgaXNGaW5pc2hlciA9ICh0eXBlID09PSAnU0gnICYmIGRpc3RUb0dvYWwgPCAxMi4wKTsKCiAgICAgICAgICAgIGxldCB0ZWNoTmFtZSA9ICh0eXBlID09PSAnU0gnKSA/IHRoaXMudGVjaHMuc2hvb3QgOiB0aGlzLnRlY2hzLnBhc3M7CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMudmVub20gPiAwICYmIHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTSUxFTkNFRCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInN0YXR1cyIpOwogICAgICAgICAgICAgICAgdGVjaE5hbWUgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgd2luZHVwVGltZSA9IDEwMDsKICAgICAgICAgICAgbGV0IGFuaW1TcGVlZCA9IDEuNTsKCiAgICAgICAgICAgIGlmIChwb3dlck11bHRpcGxpZXIgPiAxLjEpIHsKICAgICAgICAgICAgICAgIHdpbmR1cFRpbWUgKz0gMjAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNGaW5pc2hlciAmJiAhdGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIHdpbmR1cFRpbWUgPSA1MDsKICAgICAgICAgICAgICAgIGFuaW1TcGVlZCA9IDMuMDsKICAgICAgICAgICAgfQoKaWYgKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICB3aW5kdXBUaW1lID0gNDAwOwogICAgICAgICAgICAgICAgYW5pbVNwZWVkID0gMC44OwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLnBsYXlDaW5lbWF0aWModGVjaE5hbWUsIHRoaXMubWVzaCwgMS4yKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLmltbXVuaXR5VGltZXIgPSAxLjU7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IHRlY2hOYW1lLnJlcGxhY2UoJ18nLCAnICcpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihsYWJlbCwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE5FVzogU3Bhd24gVGVjaCBHbHlwaCAoVmVydGljYWwgQ2FzdGluZyBDaXJjbGUpCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmdseXBoTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ3RlY2gnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50OiB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAxLjIsCiAgICAgICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IDQuMCwKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGVTcGVlZDogMS41LAogICAgICAgICAgICAgICAgICAgICAgICBvZmZzZXRZOiAxLjIsCiAgICAgICAgICAgICAgICAgICAgICAgIGZhY2VDYW1lcmE6IHRydWUKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUGljayBiZXN0IHRocm93IGNsaXAgKHBhc3Mvc2hvdCB2YXJpYW50cyBpZiBwcmVzZW50KQogICAgICAgICAgICBjb25zdCB0aHJvd0tleSA9CiAgICAgICAgICAgICAgICAodHlwZSA9PT0gJ1NIJyAmJiB0aGlzLmFjdGlvbnNbJ3Rocm93X3Nob3QnXSkgPyAndGhyb3dfc2hvdCcgOgogICAgICAgICAgICAgICAgKHR5cGUgPT09ICdQQScgJiYgdGhpcy5hY3Rpb25zWyd0aHJvd19wYXNzJ10pID8gJ3Rocm93X3Bhc3MnIDoKICAgICAgICAgICAgICAgICd0aHJvdyc7CgogICAgICAgICAgICB0aGlzLnBsYXlPbmVTaG90KHRocm93S2V5LCAwLjEsIHsgdGltZVNjYWxlOiBhbmltU3BlZWQgfSk7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCAmJiAhdGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIldIT09TSCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWFjdGlvbiIpOwogICAgICAgICAgICB9CgpzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIC8vIFNhZmV0eTogSWYgYmFsbCBob2xkZXIgaXMgc3RpbGwgdXMsIHByb2NlZWQuIElmIGhhc0JhbGwgaXMgZmFsc2UgYnV0IGhvbGRlciBpcyB1cywgYXNzdW1lIHN5bmMgbGFnIGFuZCBwcm9jZWVkLgogICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCB8fCAoYmFsbCAmJiBiYWxsLmhvbGRlciA9PT0gdGhpcykpIHsKY29uc3QgdGhyb3dBY3Rpb24gPSB0aGlzLmFjdGlvbnNbdGhyb3dLZXldOwogICAgICAgICAgICAgICAgICAgIGlmICh0aHJvd0FjdGlvbikgdGhyb3dBY3Rpb24udGltZVNjYWxlID0gMS4wOwoKICAgICAgICAgICAgICAgICAgICBsZXQgZmluYWxEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgICAgIGxldCByZWZlcmVuY2VEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKaWYgKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIuY29weSh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlRGlyLmNvcHkoZmluYWxEaXIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUkVNT1ZFRDogSW5zdGFudCByb3RhdGlvbiBzbmFwLiAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhlIHVwZGF0ZSBsb29wIGhhbmRsZXMgc21vb3RoIHJvdGF0aW9uIHZpYSB0YXJnZXRZYXcuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgcHJldmVudHMgdGhlICJmbGlwcGluZyBhcm91bmQiIHZpc3VhbCBnbGl0Y2guCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIuY29weSh0aGlzLmxvY2tlZEFpbVZlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZURpci5jb3B5KHRoaXMubG9ja2VkQWltVmVjdG9yKTsKICAgICAgICAgICAgICAgICAgICB9Cgpjb25zdCBzcGluID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAgICAgICAgIGlmIChmb3JjZWRTcGluKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNwaW4uY29weShmb3JjZWRTcGluKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnB1dERpciA9IHRoaXMuaW5wdXRWZWN0b3IuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY3Jvc3NZID0gbmV3IFRIUkVFLlZlY3RvcjMoKS5jcm9zc1ZlY3RvcnMocmVmZXJlbmNlRGlyLCBpbnB1dERpcikueTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhjcm9zc1kpID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGluLnNldCgwLCBjcm9zc1kgKiAxMi4wLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGV0IGJhc2VDb3N0ID0gKHR5cGUgPT09ICdTSCcpID8gMjAgOiAxMDsKICAgICAgICAgICAgICAgICAgICBsZXQgdGVjaENvc3QgPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoQm9udXMgPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoUGF5bG9hZCA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd2ZW5vbSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDIwIDogMTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICd2ZW5vbScsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd3aXRoZXInOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gKHR5cGUgPT09ICdTSCcgPyAyMCA6IDEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnd2l0aGVyJywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ25hcCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDM1IDogMzApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICduYXAnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3BoZXJlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9IDI1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBybmcgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxMSkgKyA1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSBybmc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnc3BoZXJlJywgbGV2ZWw6IDEsIGJvbnVzOiBybmcgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGBTUEhFUkUgKyR7cm5nfWAsIHRoaXMubWVzaC5wb3NpdGlvbiwgImdvYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdqZWNodCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSA0MDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdqZWNodCcsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BlcmZvcm1KZWNodEtub2NrYmFjaygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2ludmlzaWJsZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAyNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdpbnZpc2libGUnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdG90YWxDb3N0ID0gYmFzZUNvc3QgKyB0ZWNoQ29zdDsKCiAgICAgICAgICAgICAgICAgICAgbGV0IHBvd2VyRmFjdG9yID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQIDwgdG90YWxDb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvd2VyRmFjdG9yID0gMC41OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlRJUkVEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSB0b3RhbENvc3Q7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdFZhbCA9IHRoaXMuZ2V0U3RhdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICs9IHRlY2hCb251czsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IHBvd2VyRmFjdG9yOwogICAgICAgICAgICAgICAgICAgIHN0YXRWYWwgKj0gcG93ZXJNdWx0aXBsaWVyOwoKY29uc3QgZ29hbFogPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC00NiA6IDQ2OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCBnb2FsWiAtIHRoaXMubWVzaC5wb3NpdGlvbi56KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnb2FsRG90ID0gZmluYWxEaXIuZG90KGdvYWxEaXIpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBnb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMiwgZ29hbFopOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0b0dvYWwgPSBnb2FsUG9zLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzaCA9IHRoaXMuZ2V0U3RhdCgnU0gnKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2V0dGluZ3MyID0gKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPKSA/IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPLnNldHRpbmdzIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgQUMyID0gd2luZG93LmZsdXguQXNzaXN0Q29uZmlnIHx8IHt9OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzaG90QXNzaXN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgKHNldHRpbmdzMiAmJiB0eXBlb2Ygc2V0dGluZ3MyLnNob3RBaW1Bc3Npc3QgPT09ICdudW1iZXInKSA/IHNldHRpbmdzMi5zaG90QWltQXNzaXN0IDogKEFDMi5TSE9UX0FJTV9BU1NJU1QgIT09IHVuZGVmaW5lZCA/IEFDMi5TSE9UX0FJTV9BU1NJU1QgOiAwLjM1KSkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjb25lRGVnID0gKEFDMi5TSE9UX0NPTkVfREVHICE9PSB1bmRlZmluZWQgPyBBQzIuU0hPVF9DT05FX0RFRyA6IDM1KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWluRG90ID0gTWF0aC5jb3MoY29uZURlZyAqIE1hdGguUEkgLyAxODApOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQmxlbmQgYW1vdW50OiBzdGF0cyAqIHVzZXIgYXNzaXN0IChrZXB0IG1vZGVzdCBzbyBpdCdzIG5vdCAiYmFieSIgZWFzeSkuCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBzaG90QXNzaXN0ICogTWF0aC5taW4oMC45LCBNYXRoLm1heCgwLjA4LCBzaCAvIDEwMC4wKSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBwbGF5ZXIgZXhwbGljaXRseSBhaW1lZCwgcmVkdWNlIGhlbHAgYnV0IGtlZXAgc29tZSB0byBwcmVzZXJ2ZSBmbG93LgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzaXN0RmFjdG9yICo9IDAuNTU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnb2FsRG90ID4gbWluRG90KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgKGdvYWxEb3QgLSBtaW5Eb3QpIC8gKDEuMCAtIG1pbkRvdCkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHcgPSB1ICogdSAqICgzIC0gMiAqIHUpOyAvLyBzbW9vdGhzdGVwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5sZXJwKHRvR29hbCwgYXNzaXN0RmFjdG9yICogdyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0ZpbmlzaGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMDU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNMQU0hIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9Cn0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMjIgKyAoMC4xMCAqIHNob3RBc3Npc3QpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAovLyBHb2FsaWUgTG9mdCBCb251cyAoUHJldmVudCBpbnRlcmNlcHRpb24gYnkgaW1tZWRpYXRlIGRlZmVuZGVyKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yb2xlID09PSAnR0wnKSBmaW5hbERpci55ICs9IDAuODsgLy8gSGlnaCBsb2Z0IGZvciBjbGVhcmFuY2UKCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5fZmluZFBhc3NUYXJnZXRJbkNvbmUoZmluYWxEaXIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0b01hdGUgPSB0YXJnZXQubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIExlYWQgdGhlIHJlY2VpdmVyIHNsaWdodGx5IChzY2FsZXMgd2l0aCBkaXN0YW5jZSwgY2FwcGVkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2V0dGluZ3MyID0gKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPKSA/IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPLnNldHRpbmdzIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IEFDMiA9IHdpbmRvdy5mbHV4LkFzc2lzdENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlYWRUQmFzZSA9IChBQzIuUEFTU19MRUFEX1RJTUUgIT09IHVuZGVmaW5lZCA/IEFDMi5QQVNTX0xFQURfVElNRSA6IDAuMjIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGVhZFQgPSBsZWFkVEJhc2UgKyBNYXRoLm1pbigwLjIwLCBkaXN0ICogMC4wMDcpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQudmVsb2NpdHkgJiYgdGFyZ2V0LnZlbG9jaXR5Lmxlbmd0aFNxICYmIHRhcmdldC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMC4wMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvTWF0ZS5hZGRTY2FsZWRWZWN0b3IodGFyZ2V0LnZlbG9jaXR5LCBsZWFkVCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b01hdGUubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGEgPSB0aGlzLmdldFN0YXQoJ1BBJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXNzQXNzaXN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgKHNldHRpbmdzMiAmJiB0eXBlb2Ygc2V0dGluZ3MyLnBhc3NBaW1Bc3Npc3QgPT09ICdudW1iZXInKSA/IHNldHRpbmdzMi5wYXNzQWltQXNzaXN0IDogKEFDMi5QQVNTX0FJTV9BU1NJU1QgIT09IHVuZGVmaW5lZCA/IEFDMi5QQVNTX0FJTV9BU1NJU1QgOiAwLjY1KSkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbmVEZWcgPSAoQUMyLlBBU1NfQ09ORV9ERUcgIT09IHVuZGVmaW5lZCA/IEFDMi5QQVNTX0NPTkVfREVHIDogNjApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWluRG90ID0gTWF0aC5jb3MoY29uZURlZyAqIE1hdGguUEkgLyAxODApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZG90TWF0ZSA9IE1hdGgubWF4KC0xLCBNYXRoLm1pbigxLCBmaW5hbERpci5kb3QodG9NYXRlKSkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBwYXNzQXNzaXN0ICogTWF0aC5taW4oMS4wLCAwLjM1ICsgKHBhIC8gODAuMCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHBsYXllciBleHBsaWNpdGx5IGFpbWVkLCByZWR1Y2UgaGVscCBidXQga2VlcCBzb21lIHRvIHByZXNlcnZlIGZsb3cuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lzdEZhY3RvciAqPSAwLjU1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb3RNYXRlID4gbWluRG90KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIChkb3RNYXRlIC0gbWluRG90KSAvICgxLjAgLSBtaW5Eb3QpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdyA9IHUgKiB1ICogKDMgLSAyICogdSk7IC8vIHNtb290aHN0ZXAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5sZXJwKHRvTWF0ZSwgYXNzaXN0RmFjdG9yICogdyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gTG9mdDogc2NhbGVzIHdpdGggZGlzdGFuY2UgKGhlbHBzIHRoZSByZWNlaXZlciByZWFkIGl0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIueSArPSBNYXRoLm1pbigwLjYsIGRpc3QgKiAwLjAzKSArICgwLjA1ICogcGFzc0Fzc2lzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR29hbGllIExvZnQgQm9udXMgZm9yIFBhc3NpbmcKLy8gR29hbGllIExvZnQgQm9udXMgZm9yIFBhc3NpbmcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgZmluYWxEaXIueSArPSAwLjg7IC8vIEhpZ2ggbG9mdCBmb3IgY2xlYXJhbmNlCiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRlY2hQYXlsb2FkICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCh0aGlzLCB0ZWNoTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKYmFsbC5zaG9vdChmaW5hbERpciwgc3RhdFZhbCwgdHlwZSwgdGVjaFBheWxvYWQsIHNwaW4pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEV4dHJhIGdyYWNlIHBlcmlvZCBmb3IgR29hbGllIHRvIHByZXZlbnQgcG9pbnQtYmxhbmsgaW50ZXJjZXB0aW9ucwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJvbGUgPT09ICdHTCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYmFsbC5jYXRjaEdyYWNlUGVyaW9kID0gMC42OyAvLyAwLjZzIGltbXVuaXR5IChhcHByb3ggMTAtMTJtIHRyYXZlbCkKICAgICAgICAgICAgICAgICAgICB9Cgp0aGlzLmxvc2VCYWxsKCk7Cgp0aGlzLmNhdGNoQ29vbGRvd24gPSAxLjA7IC8vIDFzIGNvb2xkb3duCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW5DYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB3aW5kdXBUaW1lKTsKCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CiAgICAgICAgICAgIH0sIHdpbmR1cFRpbWUgKyA1MDApOwogICAgICAgIH0KCiAgICAgICAgX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGFpbURpcikgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSkgcmV0dXJuIG51bGw7CgogICAgICAgICAgICBjb25zdCBzZXR0aW5ncyA9ICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTykgPyB3aW5kb3cuZmx1eC5fZGVidWdJTy5zZXR0aW5ncyA6IG51bGw7CiAgICAgICAgICAgIGNvbnN0IEFDID0gd2luZG93LmZsdXguQXNzaXN0Q29uZmlnIHx8IHt9OwogICAgICAgICAgICBjb25zdCBwYXNzQXNzaXN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgKHNldHRpbmdzICYmIHR5cGVvZiBzZXR0aW5ncy5wYXNzQWltQXNzaXN0ID09PSAnbnVtYmVyJykgPyBzZXR0aW5ncy5wYXNzQWltQXNzaXN0IDogKEFDLlBBU1NfQUlNX0FTU0lTVCAhPT0gdW5kZWZpbmVkID8gQUMuUEFTU19BSU1fQVNTSVNUIDogMC42NSkpKTsKCiAgICAgICAgICAgIC8vIFdpZGVyIGludGVudCBjb25lIGFzIGFzc2lzdCBpbmNyZWFzZXMgKHN0aWxsIHJlcXVpcmVzIHBvaW50aW5nIGdlbmVyYWxseSBhdCB0aGUgdGVhbW1hdGUpCiAgICAgICAgICAgIGNvbnN0IGNvbmVEZWcgPSAoQUMuUEFTU19DT05FX0RFRyAhPT0gdW5kZWZpbmVkID8gQUMuUEFTU19DT05FX0RFRyA6IDYwKTsKICAgICAgICAgICAgY29uc3QgY29uZU1pbkRvdCA9IE1hdGguY29zKGNvbmVEZWcgKiBNYXRoLlBJIC8gMTgwKTsKICAgICAgICAgICAgY29uc3QgbWluRG90ID0gKDAuNzUgKiAoMS4wIC0gcGFzc0Fzc2lzdCkpICsgKGNvbmVNaW5Eb3QgKiBwYXNzQXNzaXN0KTsKCiAgICAgICAgICAgIGxldCBiZXN0VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IGJlc3RTY29yZSA9IC1JbmZpbml0eTsKCiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtNDYgOiA0NjsKICAgICAgICAgICAgY29uc3QgZm9yd2FyZFNpZ24gPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKCiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKG1hdGUgPT09IHRoaXMgfHwgIW1hdGUubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAobWF0ZS5zdGF0dXMgJiYgbWF0ZS5zdGF0dXMubmFwID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAobWF0ZS5zdHVuVGltZXIgJiYgbWF0ZS5zdHVuVGltZXIgPiAwLjIpIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIGNvbnN0IHRvTWF0ZSA9IG1hdGUubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRvTWF0ZS5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgMC4wMDEpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgdG9NYXRlLm11bHRpcGx5U2NhbGFyKDEuMCAvIGRpc3QpOwoKICAgICAgICAgICAgICAgIGNvbnN0IGRvdCA9IGFpbURpci5kb3QodG9NYXRlKTsKICAgICAgICAgICAgICAgIGlmIChkb3QgPCBtaW5Eb3QpIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIC8vIFByZWZlcjogc3Ryb25nIGFsaWdubWVudCwgcmVhc29uYWJsZSBkaXN0YW5jZSwgZm9yd2FyZCBwcm9ncmVzcy4KICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RTY29yZSA9IDEuMCAtIE1hdGgubWluKDEuMCwgZGlzdCAvIDMwLjApOwogICAgICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBmb3J3YXJkU2lnbiAqIChtYXRlLm1lc2gucG9zaXRpb24ueiAtIHRoaXMubWVzaC5wb3NpdGlvbi56KTsKICAgICAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzU2NvcmUgPSBNYXRoLm1heCgtMS4wLCBNYXRoLm1pbigxLjAsIHByb2dyZXNzIC8gMTguMCkpOwoKICAgICAgICAgICAgICAgIC8vIFNsaWdodCBiaWFzIHRvd2FyZCBtYXRlcyBjbG9zZXIgdG8gb3Bwb25lbnQgZ29hbCAoZmVlbHMgbW9yZSAic3BvcnR5IiAvIGF0dGFja2luZykKICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxQcm94ID0gMS4wIC0gTWF0aC5taW4oMS4wLCBNYXRoLmFicyhtYXRlLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKSAvIDYwLjApOwoKICAgICAgICAgICAgICAgIGxldCBzY29yZSA9IChkb3QgKiAzLjApICsgKGRpc3RTY29yZSAqIDEuMikgKyAocHJvZ3Jlc3NTY29yZSAqIDAuOCkgKyAoZ29hbFByb3ggKiAwLjQpOwoKICAgICAgICAgICAgICAgIGlmIChzY29yZSA+IGJlc3RTY29yZSkgewogICAgICAgICAgICAgICAgICAgIGJlc3RTY29yZSA9IHNjb3JlOwogICAgICAgICAgICAgICAgICAgIGJlc3RUYXJnZXQgPSBtYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gYmVzdFRhcmdldDsKICAgICAgICB9CgpzdGFydENoYXJnZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgfHwgdGhpcy5pc1Rocm93aW5nIHx8IHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jaGFyZ2VUaW1lID0gMDsKCi8vIFZpc3VhbHMgaGFuZGxlZCBpbiB1cGRhdGUKCiAgICAgICAgICAgIC8vIFNob3cgY2hhcmdlIFVJCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUNoYXJnZVVJKDApOwoKICAgICAgICAgICAgLy8gTkVXOiBTcGF3biBDaGFyZ2UgR2x5cGggKEdyb3VuZCBSaW5nKQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ2NoYXJnZScsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICBsaWZlOiB0aGlzLm1heENoYXJnZVRpbWUsCiAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogMy4wLAogICAgICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IDAuMiwKICAgICAgICAgICAgICAgICAgICBvZmZzZXRZOiAwLjEKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKcmVsZWFzZUNoYXJnZShkeCwgZHksIGN1cnZlSW5wdXQgPSBudWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc0NoYXJnaW5nKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUG93ZXIgQ2FsY3VsYXRpb24KICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1pbih0aGlzLmNoYXJnZVRpbWUgLyB0aGlzLm1heENoYXJnZVRpbWUsIDEuMCk7CiAgICAgICAgICAgIGNvbnN0IFRDID0gd2luZG93LmZsdXguVGhyb3dDb25maWcgfHwge307CgogICAgICAgICAgICAvLyBCYXNlIG11bHRpcGxpZXIgKGRlZmF1bHRzOiAxLjAgdG8gMS44KQogICAgICAgICAgICBsZXQgbXVsdGlwbGllciA9IChUQy5QT1dFUl9CQVNFICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9CQVNFIDogMS4wKSArIChyYXRpbyAqIChUQy5QT1dFUl9SQU5HRSAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfUkFOR0UgOiAwLjgpKTsvLyBNQVggUE9XRVIgQk9OVVM6IElmIGhlbGQgbmVhciBtYXgsIHNpZ25pZmljYW50IGJvb3N0CiAgICAgICAgICAgIGlmIChyYXRpbyA+IChUQy5QT1dFUl9NQVhfQk9OVVNfUkFUSU8gIT09IHVuZGVmaW5lZCA/IFRDLlBPV0VSX01BWF9CT05VU19SQVRJTyA6IDAuOTUpKSB7CiAgICAgICAgICAgICAgICBtdWx0aXBsaWVyID0gKFRDLlBPV0VSX01BWF9NVUxUSVBMSUVSICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9NQVhfTVVMVElQTElFUiA6IDIuNSk7IC8vIENyaXRpY2FsIFBvd2VyCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIk1BWCBQT1dFUiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZEZvdkltcHVsc2UoLTEwKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKCiAgICAgICAgICAgIC8vIEFpbSBWZWN0b3IgQ2FsY3VsYXRpb24KICAgICAgICAgICAgbGV0IGFpbVZlYyA9IG51bGw7CiAgICAgICAgICAgIGNvbnN0IHN3aXBlTGVuID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwoKICAgICAgICAgICAgaWYgKHN3aXBlTGVuID4gKFRDLlNXSVBFX01JTl9QWCAhPT0gdW5kZWZpbmVkID8gVEMuU1dJUEVfTUlOX1BYIDogMjApKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjYW1lcmEgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhOwogICAgICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgICAgICBpZiAoY2FtZXJhKSB7CiAgICAgICAgICAgICAgICAgICAgY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKGZ3ZCk7CiAgICAgICAgICAgICAgICAgICAgZndkLnkgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmIChmd2QubGVuZ3RoU3EoKSA8IDAuMDAxKSBmd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGZ3ZC5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgcmlnaHQuY3Jvc3NWZWN0b3JzKGZ3ZCwgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCkpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICAgICAgd29ybGRWZWMuYWRkU2NhbGVkVmVjdG9yKHJpZ2h0LCBkeCAqIChUQy5BSU1fRFhfU0NBTEUgIT09IHVuZGVmaW5lZCA/IFRDLkFJTV9EWF9TQ0FMRSA6IDEuMCkpOwogICAgICAgICAgICAgICAgICAgIHdvcmxkVmVjLmFkZFNjYWxlZFZlY3Rvcihmd2QsIC1keSAqIChUQy5BSU1fRFlfU0NBTEUgIT09IHVuZGVmaW5lZCA/IFRDLkFJTV9EWV9TQ0FMRSA6IDEuMCkpOwogICAgICAgICAgICAgICAgICAgIHdvcmxkVmVjLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBhaW1WZWMgPSB3b3JsZFZlYzsKICAgICAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gYWltVmVjOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBhaW1WZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYWltVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBudWxsOwogICAgICAgICAgICB9CgovLyAtLS0gQU5BTE9HIENVUlZFIExPR0lDIC0tLQogICAgICAgICAgICAvLyBGb3JtdWxhOiBDdXJ2ZSA9IEludGVuc2l0eSAqIFNwZWVkCiAgICAgICAgICAgIGxldCBzcGluVmVjID0gbnVsbDsKICAgICAgICAgICAgCmlmICgoVEMuQ1VSVkVfRU5BQkxFRCAhPT0gZmFsc2UpICYmIGN1cnZlSW5wdXQgJiYgTWF0aC5hYnMoY3VydmVJbnB1dC5pbnRlbnNpdHkpID4gKFRDLkNVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQgOiAwLjI1KSkgewogICAgICAgICAgICAgICAgY29uc3QgcmF3SW50ZW5zaXR5ID0gTWF0aC5hYnMoY3VydmVJbnB1dC5pbnRlbnNpdHkpOwogICAgICAgICAgICAgICAgY29uc3Qgc2lnbiA9IE1hdGguc2lnbihjdXJ2ZUlucHV0LmludGVuc2l0eSk7IC8vIFBvc2l0aXZlID0gUmlnaHQgSHVtcCA9IExlZnQgQ3VydmUKICAgICAgICAgICAgICAgIGNvbnN0IHN3aXBlU3BlZWQgPSBjdXJ2ZUlucHV0LnNwZWVkIHx8IDEuMDsKCiAgICAgICAgICAgICAgICAvLyAxLiBCYXNlIFNwaW4gZnJvbSBBcmMgKFR1bmVkIGZvciByZWFsaXNtLCBubyBjeWNsb25lcykKLy8gMS4gQmFzZSBTcGluIGZyb20gQXJjIChIZXJjdWxlYW4gQm9vc3QpCiAgICAgICAgICAgICAgICBsZXQgc3Bpbk1hZyA9IHJhd0ludGVuc2l0eSAqIChUQy5DVVJWRV9TUElOX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9TUElOX1NDQUxFIDogMTAwMC4wKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBTcGVlZCBCb251cyAoUXVpY2tuZXNzIGFkZHMgUlBNKQogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWRCb251cyA9IE1hdGgubWF4KDEuMCwgc3dpcGVTcGVlZCAqIChUQy5DVVJWRV9TUEVFRF9NVUxUICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9TUEVFRF9NVUxUIDogMS41KSk7CiAgICAgICAgICAgICAgICBzcGluTWFnICo9IHNwZWVkQm9udXM7CgogICAgICAgICAgICAgICAgLy8gQ2FwIChJbmNyZWFzZWQgdG8gMTUwMCBmb3IgbWFzc2l2ZSBhcmNzKQogICAgICAgICAgICAgICAgc3Bpbk1hZyA9IE1hdGgubWluKChUQy5DVVJWRV9TUElOX0NBUCAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BJTl9DQVAgOiAxNTAwLjApLCBzcGluTWFnKTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSBTcGluCiAgICAgICAgICAgICAgICAvLyBSaWdodCBIdW1wIChQb3NpdGl2ZSBJbnRlbnNpdHkpIC0+IExlZnQgQ3VydmUgKFBvc2l0aXZlIFNwaW4gWSkKICAgICAgICAgICAgICAgIHNwaW5WZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCBzcGluTWFnICogc2lnbiwgMCk7CiAgICAgICAgICAgICAgICAKaWYgKHNwaW5NYWcgPiAoVEMuQ1VSVkVfUEVSRkVDVF9TUElOICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9QRVJGRUNUX1NQSU4gOiA1MDAuMCkgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlBFUkZFQ1QgQ1VSVkUiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFJvbGxJbXB1bHNlKHNpZ24gKiAtMC4zKTsgLy8gVGlsdCBjYW1lcmEgaW50byB0aGUgY3VydmUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERldGVybWluZSBUeXBlIChQYXNzIHZzIFNob290KQovLyBEZXRlcm1pbmUgVHlwZSAoUGFzcyB2cyBTaG9vdCkKICAgICAgICAgICAgY29uc3QgZ29hbFogPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC00NiA6IDQ2OwogICAgICAgICAgICBjb25zdCBnb2FsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbFogLSB0aGlzLm1lc2gucG9zaXRpb24ueikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGNvbnN0IGRvdEdvYWwgPSBhaW1WZWMuZG90KGdvYWxEaXIpOwoKICAgICAgICAgICAgbGV0IHR5cGUgPSAnUEEnOwogICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CgogICAgICAgICAgICBpZiAoZG90R29hbCA+IDAuOCAmJiBkaXN0VG9Hb2FsIDwgMzUuMCkgewogICAgICAgICAgICAgICAgdHlwZSA9ICdTSCc7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZG90R29hbCA+IDAuNSAmJiBkaXN0VG9Hb2FsIDwgMjAuMCkgewogICAgICAgICAgICAgICAgdHlwZSA9ICdTSCc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNtYXJ0IFBhc3MgT3ZlcnJpZGUKICAgICAgICAgICAgY29uc3QgdGFyZ2V0TWF0ZSA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGFpbVZlYyk7CiAgICAgICAgICAgIGlmICh0YXJnZXRNYXRlICYmIHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RNYXRlID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGFyZ2V0TWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0TWF0ZSA8IDEyLjApIHR5cGUgPSAnUEEnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmIChiYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCB0eXBlLCBtdWx0aXBsaWVyLCBzcGluVmVjKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBDaGFyZ2UgVUkgbWV0aG9kcwogICAgICAgIF91cGRhdGVDaGFyZ2VVSShyYXRpbykgewogICAgICAgICAgICBjb25zdCBtZXRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItZmlsbCcpOwogICAgICAgICAgICBpZiAobWV0ZXIpIHsKICAgICAgICAgICAgICAgIG1ldGVyLnN0eWxlLndpZHRoID0gYCR7cmF0aW8gKiAxMDB9JWA7CiAgICAgICAgICAgICAgICBpZiAocmF0aW8gPiAwLjkpIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmMCwgI2Y4MCknOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyYXRpbyA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIG1ldGVyLnN0eWxlLmJhY2tncm91bmQgPSAnbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjMGYwLCAjZmYwKSc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1ldGVyLnN0eWxlLmJhY2tncm91bmQgPSAnbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjMGFmLCAjMGYwKSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NoYXJnZS1tZXRlci1jb250YWluZXInKTsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lcikgY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgIH0KCiAgICAgICAgX2hpZGVDaGFyZ2VVSSgpIHsKICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NoYXJnZS1tZXRlci1jb250YWluZXInKTsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lcikgY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQoKICAgICAgICBzZXRPdmVycmlkZUFpbSh4LCB6KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5vdmVycmlkZUFpbVZlY3RvcikgdGhpcy5vdmVycmlkZUFpbVZlY3RvciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3Iuc2V0KHgsIDAsIHopLm5vcm1hbGl6ZSgpOwogICAgICAgIH0KCmxvc2VCYWxsKCkgewogICAgICAgICAgICB0aGlzLmhhc0JhbGwgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCk7CiAgICAgICAgICAgIC8vIEZpeDogRW5zdXJlIHBsYXllciBjYW4gY2F0Y2ggYWdhaW4gaWYgdGhleSBsb3NlIHBvc3Nlc3Npb24gdW5leHBlY3RlZGx5CiAgICAgICAgICAgIHRoaXMuY2FuQ2F0Y2ggPSB0cnVlOwogICAgICAgICAgICAvLyBTYWZldHk6IFJlc2V0IHN0YXRlcyB0byBwcmV2ZW50IGxvY2tpbmcKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKICAgICAgICB9Cgp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIFNZTkMgRklYOiBJZiBiYWxsIHRoaW5rcyBJIGhvbGQgaXQsIGJ1dCBJIGRvbid0LCBmb3JjZSByZWNlaXZlCiAgICAgICAgICAgIGlmICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLmhvbGRlciA9PT0gdGhpcyAmJiAhdGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIlN5bmNpbmcgYmFsbCBwb3NzZXNzaW9uIHRvIHBsYXllciIpOwogICAgICAgICAgICAgICAgdGhpcy5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIElucHV0IHNtb290aGluZyAobGVzcyB0d2l0Y2h5IC8gbW9yZSAic3dpbW15IikKICAgICAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX2RlYnVnSU8pID8gd2luZG93LmZsdXguX2RlYnVnSU8uc2V0dGluZ3MgOiBudWxsOwogICAgICAgICAgICBjb25zdCBBQyA9IHdpbmRvdy5mbHV4LkFzc2lzdENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgY29uc3QgaW5wdXRSZXNwID0gKHNldHRpbmdzICYmIHR5cGVvZiBzZXR0aW5ncy5pbnB1dFJlc3BvbnNlID09PSAnbnVtYmVyJykgPyBzZXR0aW5ncy5pbnB1dFJlc3BvbnNlIDogKEFDLklOUFVUX1JFU1BPTlNFICE9PSB1bmRlZmluZWQgPyBBQy5JTlBVVF9SRVNQT05TRSA6IDE0LjApOwogICAgICAgICAgICBjb25zdCBzdGVlcmluZ0Fzc2lzdCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIChzZXR0aW5ncyAmJiB0eXBlb2Ygc2V0dGluZ3Muc3RlZXJpbmdBc3Npc3QgPT09ICdudW1iZXInKSA/IHNldHRpbmdzLnN0ZWVyaW5nQXNzaXN0IDogKEFDLlNURUVSSU5HX0FTU0lTVCAhPT0gdW5kZWZpbmVkID8gQUMuU1RFRVJJTkdfQVNTSVNUIDogMC4wKSkpOwoKICAgICAgICAgICAgLy8gSGlnaGVyIHNwZWVkIC0+IGEgdG91Y2ggbW9yZSBkYW1waW5nIHNvIHlvdSdyZSBub3Qgb3Zlci1zdGVlcmluZy4KICAgICAgICAgICAgY29uc3Qgc3BlZWROb3cgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICBjb25zdCByZXNwID0gTWF0aC5tYXgoNC4wLCBpbnB1dFJlc3AgKiAoMS4wICsgMC4yNSAqIHN0ZWVyaW5nQXNzaXN0KSAqIChzcGVlZE5vdyA+IDYuMCA/IDAuODUgOiAxLjApKTsKICAgICAgICAgICAgY29uc3QgdElucHV0ID0gMSAtIE1hdGgucG93KDAuMDAxLCBkdCAqIHJlc3ApOwogICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLmxlcnAodGhpcy5kZXNpcmVkSW5wdXRWZWN0b3IsIHRJbnB1dCk7CgogICAgICAgICAgICBpZiAodGhpcy5pc0dvZE1vZGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgPSB0aGlzLnN0YXRzLm1heEhQOwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSB0aGlzLmdldFN0YXQoJ0VOJyk7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy52ZW5vbSA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5uYXAgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBbmltYXRpb246IGxheWVyZWQgbWl4aW5nIChiYXNlIGxvY29tb3Rpb24gKyB1cHBlci1ib2R5IG92ZXJsYXkgKyBvbmUtc2hvdHMpCiAgICAgICAgICAgIGlmICh0aGlzLl9sYXllcmVkRW5hYmxlZCkgdGhpcy5fdXBkYXRlTGF5ZXJlZEFuaW1hdGlvbihkdCk7CiAgICAgICAgICAgIGVsc2UgdGhpcy5fdXBkYXRlTG9jb21vdGlvbkFuaW0oMC4yKTsKCiAgICAgICAgICAgIGlmICh0aGlzLm1peGVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1peGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXMoZHQpOwoKICAgICAgICAgICAgLy8gQ2hhcmdlIExvZ2ljCi8vIENoYXJnZSBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaGFzQmFsbCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0U2NhbGFyKHRoaXMuYmFzZVNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CnRoaXMuY2hhcmdlVGltZSArPSBkdDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBVVRPLVJFTEVBU0U6IElmIGhlbGQgdG9vIGxvbmcgKDNzKSwgZm9yY2UgcmVsZWFzZSB0byBwcmV2ZW50IHN0dWNrIHN0YXRlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2hhcmdlVGltZSA+IDMuMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbGVhc2VDaGFyZ2UoMCwgMCk7IC8vIEZvcmNlIHdlYWsgc2hvdAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHRoaXMuY2hhcmdlVGltZSAvIHRoaXMubWF4Q2hhcmdlVGltZSwgMS4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMZXZpdGF0aW9uIChQb3dlcmluZyB1cCkKICAgICAgICAgICAgICAgICAgICBjb25zdCBob3ZlciA9IChNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMikgKiAwLjEpICsgKHJhdGlvICogMC44KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBWaWJyYXRpb24gKEludGVuc2l0eSBpbmNyZWFzZXMgd2l0aCBjaGFyZ2UpCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hha2UgPSAwLjA1ICsgKDAuMSAqIHJhdGlvKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBcHBseSBZIG9mZnNldCAoSG92ZXIgKyBKaXR0ZXIpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSBob3ZlciArIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEFwcGx5IFJvdGF0aW9uIEppdHRlciAodmlhIGJhbmtpbmcvcGl0Y2ggdmFyaWFibGVzKQogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgYXZvaWRzIHBvc2l0aW9uYWwgZHJpZnQgd2hpbGUgZ2l2aW5nIGEgInN0cnVnZ2xpbmcgdG8gY29udGFpbiBwb3dlciIgbG9vawogICAgICAgICAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlOwoKICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgc2NhbGUgc3RheXMgbm9ybWFsIChSZW1vdmUgc3dlbGxpbmcgZWZmZWN0KQogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5zY2FsZS5zZXRTY2FsYXIodGhpcy5iYXNlU2NhbGUpOwoKICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSShyYXRpbyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KaWYgKHRoaXMuZGFzaENvb2xkb3duID4gMCkgdGhpcy5kYXNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmNsYXNoQ29vbGRvd24gPiAwKSB0aGlzLmNsYXNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLnN0dW5UaW1lciA+IDApIHRoaXMuc3R1blRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5pbW11bml0eVRpbWVyID4gMCkgdGhpcy5pbW11bml0eVRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5jYXRjaENvb2xkb3duID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2F0Y2hDb29sZG93biA8PSAwKSB0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBEYXNoIExvZ2ljCi8vIERhc2ggTG9naWMKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUaW1lIC09IGR0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLl9kYXNoUGFydGljbGVUaW1lciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9kYXNoUGFydGljbGVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZGFzaFBhcnRpY2xlVGltZXIgPSAwLjAzOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWNrID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmFjay5sZW5ndGhTcSgpIDwgMC4xKSBiYWNrLnNldCgwLCAwLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChiYWNrLm11bHRpcGx5U2NhbGFyKDAuNSkpOwogICAgICAgICAgICAgICAgICAgICAgICBwb3MueSArPSAxLjAgKyAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcy54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwb3MsIHsgc2NhbGU6IDIuNSB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gU21vb3RoIFJvdGF0aW9uIGR1cmluZyBEYXNoCiAgICAgICAgICAgICAgICBsZXQgZGlmZiA9IHRoaXMudGFyZ2V0WWF3IC0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICAgICAgd2hpbGUgKGRpZmYgPiBNYXRoLlBJKSBkaWZmIC09IE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgd2hpbGUgKGRpZmYgPCAtTWF0aC5QSSkgZGlmZiArPSBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgdHVyblNwZWVkID0gMTUuMDsgLy8gRmFzdCB0dXJuaW5nIGZvciBkYXNoCiAgICAgICAgICAgICAgICBjb25zdCBjaGFuZ2UgPSBNYXRoLm1heCgtdHVyblNwZWVkICogZHQsIE1hdGgubWluKHR1cm5TcGVlZCAqIGR0LCBkaWZmKSk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgKz0gY2hhbmdlOwoKICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrVGFja2xlQ29sbGlzaW9uKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUaW1lIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGFzaFR5cGUgPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLmRhc2hWZWMpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAxIC0gKHRoaXMuZGFzaFRpbWUgLyB0aGlzLmRhc2hUb3RhbFRpbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IE1hdGguc2luKHQgKiBNYXRoLlBJKSAqIDMuMDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBIb3Jpem9udGFsIERhc2ggTW92ZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IDA7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBWaXN1YWwgVGFja2xlIExlYW4gKFNob3VsZGVyIEJhc2ggQW5pbWF0aW9uKQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gMSAtICh0aGlzLmRhc2hUaW1lIC8gdGhpcy5kYXNoVG90YWxUaW1lKTsgLy8gMCB0byAxCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlYW4gPSBNYXRoLnNpbih0ICogTWF0aC5QSSk7IC8vIFBlYWsgYXQgMS4wIGluIG1pZGRsZQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmUtYXBwbHkgYmFzZSBmYWNpbmcgKyBBZ2dyZXNzaXZlIFNob3VsZGVyIENoZWNrCi8vIFJlLWFwcGx5IGJhc2UgZmFjaW5nICsgQWdncmVzc2l2ZSBTaG91bGRlciBDaGVjawogICAgICAgICAgICAgICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCB0aGlzLmN1cnJlbnRZYXcgKyB0aGlzLnJvdGF0aW9uT2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaXRjaCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB5YXcgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcm9sbCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBsdW5nZUFtdCA9IDA7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXNoVHlwZSA9PT0gJ2hvcml6b250YWwnIHx8IHRoaXMuZGFzaFR5cGUgPT09ICdicmVhaycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUQUNLTEUvQlJFQUs6IEFnZ3Jlc3NpdmUgU2hvdWxkZXIgQ2hlY2sKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaXRjaCA9IDEuMiAqIGxlYW47IC8vIEhlYWQgZG93biAvIExlYW4gZm9yd2FyZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlhdyA9IDAuOCAqIGxlYW47ICAgLy8gVHVybiBzaG91bGRlciBpbnRvIHRhcmdldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvbGwgPSAtMC42ICogbGVhbjsgLy8gRGlwIHNob3VsZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbHVuZ2VBbXQgPSAwLjggKiBsZWFuOyAvLyBUaHJ1c3QgbWVzaCBmb3J3YXJkIHZpc3VhbGx5CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5kYXNoVHlwZSA9PT0gJ3NwcmludCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTUFJJTlQ6IEFlcm9keW5hbWljIGxlYW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaXRjaCA9IDAuNSAqIGxlYW47IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGx1bmdlQW10ID0gMC4yICogbGVhbjsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXBwbHkgTHVuZ2UgKFZpc3VhbCBPZmZzZXQpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsdW5nZUFtdCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfcFZlYy5zZXQoMCwgMCwgbHVuZ2VBbXQpLmFwcGx5UXVhdGVybmlvbihfcFF1YXQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBfcEV1bGVyLnNldChwaXRjaCwgeWF3LCByb2xsKTsKICAgICAgICAgICAgICAgICAgICAgICAgX3BRdWF0Mi5zZXRGcm9tRXVsZXIoX3BFdWxlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5UXVhdGVybmlvbnMoX3BRdWF0LCBfcFF1YXQyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC45Nik7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOTYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBTdHVuL05hcCBDaGVjawogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRyYWdGYWN0b3IgPSBNYXRoLm1heCgwLCAxIC0gKDIuMCAqIGR0KSk7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKGRyYWdGYWN0b3IpOwoKICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CgogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9sYXllcmVkRW5hYmxlZCAmJiAhdGhpcy5fYW5pbUxvY2tlZCAmJiB0aGlzLnN0YXRlICE9PSAnaWRsZScgJiYgdGhpcy5zdGF0ZSAhPT0gJ2NhdGNoJykgdGhpcy5wbGF5KCdpZGxlJywgMC41KTsKCiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIUEJhcigpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVQcmVzc3VyZShkdCk7CgogICAgICAgICAgICBpZiAodGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICgyLjAgKiBkdCkpKTsKCiAgICAgICAgICAgICAgICB0aGlzLl9hcHBseVNvZnRDb2xsaXNpb24oZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlHb2FsQ3JlYXNlKGR0KTsKCiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwoKdGhpcy5fdXBkYXRlVmVydGljYWxpdHkoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQmFua2luZyhkdCk7IC8vIEVuYWJsZSByb3RhdGlvbiBkdXJpbmcgdGhyb3cKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZlcnRpY2FsaXR5KGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUJhbmtpbmcoZHQpOwogICAgICAgICAgICB9Cgp0aGlzLl91cGRhdGVIUEJhcigpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwoKICAgICAgICAgICAgLy8gQnViYmxlIFRyYWlsIExvZ2ljCi8vIEJ1YmJsZSBUcmFpbCBMb2dpYyAoRHluYW1pYykKICAgICAgICAgICAgY29uc3Qgc3BlZWRTcSA9IHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHNwZWVkU3EgPiAxLjAgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2J1YmJsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFja0RpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAxLiBTdGFuZGFyZCBXYWtlIChBbHdheXMgc3Bhd24pCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gYmFja0Rpci5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKDAuOCk7CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LnkgPSAwLjUgKyBNYXRoLnJhbmRvbSgpICogMC41OyAKICAgICAgICAgICAgICAgICAgICBvZmZzZXQueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgIG9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZScsIHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLCB7IHNjYWxlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMjUgfSk7CgogICAgICAgICAgICAgICAgICAgIC8vIDIuIENhdml0YXRpb24gKEhpZ2ggU3BlZWQpIC0gQWRkIG9uIHRvcAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzSGlnaFNwZWVkID0gc3BlZWRTcSA+IDQwLjA7IAogICAgICAgICAgICAgICAgICAgIGlmIChpc0hpZ2hTcGVlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1PZmZzZXQgPSBiYWNrRGlyLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC41ICsgTWF0aC5yYW5kb20oKSowLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC55ID0gMC41ICsgKE1hdGgucmFuZG9tKCktMC41KSowLjg7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlX21pY3JvJywgdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG1PZmZzZXQpLCB7IHNjYWxlOiAwLjA2ICsgTWF0aC5yYW5kb20oKSowLjA4IH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4wMzsgCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwLjE7IAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQp9CgogICAgICAgIF91cGRhdGVTdGF0dXMoZHQpIHsKICAgICAgICAgICAgY29uc3QgcG0gPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyIDogbnVsbDsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy52ZW5vbSA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLnZlbm9tIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSA1ICogZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA8IDApIHRoaXMuc3RhdHMuSFAgPSAwOwoKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnZlbm9tIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BhcnRpY2xlVGltZXJzLnZlbm9tIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bigndmVub20nLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnZlbm9tID0gMC4xNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsICYmIHRoaXMuc3RhdHMuSFAgPCB0aGlzLnN0YXRzLm1heEhQKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCArPSA1ICogZHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPiB0aGlzLnN0YXRzLm1heEhQKSB0aGlzLnN0YXRzLkhQID0gdGhpcy5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSAyLjAgKiBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQIDwgMCkgdGhpcy5zdGF0cy5IUCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5uYXAgLT0gZHQ7CgogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMubmFwIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BhcnRpY2xlVGltZXJzLm5hcCA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ25hcCcsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMubmFwID0gMC44OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgaXNXaXRoZXJpbmcgPSBmYWxzZTsKICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHRoaXMuc3RhdHVzLndpdGhlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltrZXldID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLndpdGhlcltrZXldIC09IGR0OwogICAgICAgICAgICAgICAgICAgIGlzV2l0aGVyaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGlzV2l0aGVyaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMud2l0aGVyIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignd2l0aGVyJywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgPSAwLjI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbHMoKTsKICAgICAgICB9CgpfdXBkYXRlVmlzdWFscygpIHsKICAgICAgICAgICAgLy8gUkVNT1ZFRDogWWVsbG93IHNwaGVyZS90aW50IGxvZ2ljIGFzIHBlciByZXF1ZXN0LgogICAgICAgICAgICAvLyBBbHdheXMgcmV2ZXJ0IHRvIGJhc2UgY29sb3IuCiAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMuZm9yRWFjaChlbnRyeSA9PiB7CiAgICAgICAgICAgICAgICBlbnRyeS5tYXRlcmlhbC5jb2xvci5jb3B5KGVudHJ5LmJhc2VDb2xvcik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgX2NyZWF0ZUF1cmEoKSB7CiAgICAgICAgICAgIC8vIEF1cmEgcmVtb3ZlZCBwZXIgdXNlciByZXF1ZXN0CiAgICAgICAgICAgIHRoaXMuYXVyYU1lc2ggPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBQYXNzIHRhcmdldCBpbmRpY2F0b3IKICAgICAgICBfY3JlYXRlUGFzc1RhcmdldEluZGljYXRvcigpIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIGEgcmluZyB0aGF0IGhpZ2hsaWdodHMgcG90ZW50aWFsIHBhc3MgdGFyZ2V0cwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUmluZ0dlb21ldHJ5KDAuOCwgMS4wLCAxNik7CiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBjb2xvcjogMHgwMGZmMDAsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuNiwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvciA9IG5ldyBUSFJFRS5NZXNoKGdlbywgbWF0KTsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnJvdGF0aW9uLnggPSAtTWF0aC5QSSAvIDI7CiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci5wb3NpdGlvbi55ID0gMC4xOwogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaGFzQmFsbCB8fCAhdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRmluZCBiZXN0IHBhc3MgdGFyZ2V0CiAgICAgICAgICAgIGNvbnN0IGFpbURpciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGFpbURpcik7CgogICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5tZXNoICYmIHRoaXMucGFzc1RhcmdldEluZGljYXRvcikgewogICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnBvc2l0aW9uLnggPSB0YXJnZXQubWVzaC5wb3NpdGlvbi54OwogICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnBvc2l0aW9uLnogPSB0YXJnZXQubWVzaC5wb3NpdGlvbi56OwogICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnBvc2l0aW9uLnkgPSAwLjE7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3Iucm90YXRpb24ueiArPSAwLjA1OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5faGlkZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9oaWRlUGFzc1RhcmdldEluZGljYXRvcnMoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpfYXBwbHlTb2Z0Q29sbGlzaW9uKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoIHx8ICF3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IHRlYW1zID0gW2dhbWUudGVhbXMuaG9tZSwgZ2FtZS50ZWFtcy5hd2F5XTsKCiAgICAgICAgICAgIGNvbnN0IHJlcHVsc2lvblJhZGl1cyA9IDAuNTsgLy8gUmVkdWNlZCB0byAwLjUgdG8gZml4IGludmlzaWJsZSB3YWxsIGlzc3VlcwogICAgICAgICAgICBjb25zdCBzdGlmZm5lc3MgPSAxNS4wOwoKICAgICAgICAgICAgdGVhbXMuZm9yRWFjaCh0ZWFtID0+IHsKICAgICAgICAgICAgICAgIGlmICghdGVhbSkgcmV0dXJuOwogICAgICAgICAgICAgICAgdGVhbS5wbGF5ZXJzLmZvckVhY2gob3RoZXIgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChvdGhlciA9PT0gdGhpcyB8fCAhb3RoZXIubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBkeCA9IHRoaXMubWVzaC5wb3NpdGlvbi54IC0gb3RoZXIubWVzaC5wb3NpdGlvbi54OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGR5ID0gdGhpcy5tZXNoLnBvc2l0aW9uLnkgLSBvdGhlci5tZXNoLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHogPSB0aGlzLm1lc2gucG9zaXRpb24ueiAtIG90aGVyLm1lc2gucG9zaXRpb24uejsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdFNxID0gZHgqZHggKyBkeSpkeSArIGR6KmR6OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1pbkRpc3QgPSByZXB1bHNpb25SYWRpdXMgKiAyLjA7CgogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0U3EgPCBtaW5EaXN0ICogbWluRGlzdCAmJiBkaXN0U3EgPiAwLjAwMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkaXN0U3EpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvdmVybGFwID0gbWluRGlzdCAtIGRpc3Q7CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmb3JjZSA9IG92ZXJsYXAgKiBzdGlmZm5lc3M7CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBueCA9IGR4IC8gZGlzdDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbnkgPSBkeSAvIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG56ID0gZHogLyBkaXN0OwoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9IG54ICogZm9yY2UgKiBkdDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICs9IG55ICogZm9yY2UgKiBkdDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9IG56ICogZm9yY2UgKiBkdDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICB0aGlzLl9hcHBseVNvZnRDb2xsaXNpb24oZHQpOwp0aGlzLl9hcHBseUdvYWxDcmVhc2UoZHQpOwoKICAgICAgICAgICAgY29uc3QgaW5wdXRMZW5TcSA9IHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKTsKICAgICAgICAgICAgY29uc3QgaXNJbnB1dEFjdGl2ZSA9IGlucHV0TGVuU3EgPiAwLjAxOwoKICAgICAgICAgICAgbGV0IGN1cnJlbnRNYXhTcGVlZCA9IHRoaXMubWF4U3BlZWQ7CmlmICh0aGlzLmlzRW5nYWdlZCkgY3VycmVudE1heFNwZWVkICo9IDAuODsgLy8gQnVmZmVkIGZyb20gMC41IHRvIGFsbG93IGVzY2FwZQogICAgICAgICAgICBpZiAodGhpcy5pc0NoYXJnaW5nKSBjdXJyZW50TWF4U3BlZWQgKj0gMC45OwoKICAgICAgICAgICAgaWYgKGlzSW5wdXRBY3RpdmUpIHsKICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5pbnB1dFZlY3Rvcikubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0VmVsWCA9IF9wVmVjLnggKiBjdXJyZW50TWF4U3BlZWQ7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRWZWxaID0gX3BWZWMueiAqIGN1cnJlbnRNYXhTcGVlZDsKCiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50U3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWRSYXRpbyA9IE1hdGgubWluKDEuMCwgY3VycmVudFNwZWVkIC8gdGhpcy5tYXhTcGVlZCk7CgogICAgICAgICAgICAgICAgY29uc3QgYWdpbGl0eSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDEwLjAsIDIuMCwgc3BlZWRSYXRpbyk7CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IDEuMCAtIE1hdGgucG93KDAuMDEsIGR0ICogYWdpbGl0eSk7CgogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9ICh0YXJnZXRWZWxYIC0gdGhpcy52ZWxvY2l0eS54KSAqIHQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gKHRhcmdldFZlbFogLSB0aGlzLnZlbG9jaXR5LnopICogdDsKCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2xheWVyZWRFbmFibGVkICYmICF0aGlzLl9hbmltTG9ja2VkICYmIHRoaXMuc3RhdGUgIT09ICdzd2ltJykgdGhpcy5wbGF5KCdzd2ltJywgMC4yKTsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBicmFrZUZhY3RvciA9IDIuMDsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAxLjAgLSBNYXRoLnBvdygwLjEsIGR0ICogYnJha2VGYWN0b3IpOwoKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSAoMCAtIHRoaXMudmVsb2NpdHkueCkgKiB0OwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9ICgwIC0gdGhpcy52ZWxvY2l0eS56KSAqIHQ7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKSA8IDAuMDEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCB0aGlzLnZlbG9jaXR5LnksIDApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghdGhpcy5fbGF5ZXJlZEVuYWJsZWQgJiYgIXRoaXMuX2FuaW1Mb2NrZWQgJiYgdGhpcy5zdGF0ZSAhPT0gJ2lkbGUnICYmIHRoaXMuc3RhdGUgIT09ICdjYXRjaCcgJiYgdGhpcy5zdGF0ZSAhPT0gJ3Rocm93JyAmJiB0aGlzLnN0YXRlICE9PSAncmVhY3QnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5KCdpZGxlJywgMC4zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IE1hdGgubWF4KDAsIDEuMCAtICgyLjAgKiBkdCkpOwoKICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVZlcnRpY2FsaXR5KGR0KSB7CiAgICAgICAgICAgIGxldCB0YXJnZXRZID0gMDsKCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKCiAgICAgICAgICAgIGlmIChiYWxsICYmIGJhbGwubWVzaCAmJiAhdGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9CYWxsID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMTUuMCkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldFkgPSBiYWxsLm1lc2gucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGFyZ2V0WSA9IDAuNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgeURpZmYgPSB0YXJnZXRZIC0gdGhpcy5tZXNoLnBvc2l0aW9uLnk7CgogICAgICAgICAgICBjb25zdCBsaWZ0ID0geURpZmYgKiAxMC4wICogZHQ7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSArPSBsaWZ0OwoKICAgICAgICAgICAgaWYgKHRoaXMubWVzaC5wb3NpdGlvbi55ID4gOC4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IDguMDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSAtMC41OwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubWVzaC5wb3NpdGlvbi55IDwgLTguMCkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSAtOC4wOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IC0wLjU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEZJWEVEOiBJbXByb3ZlZCBiYW5raW5nIHdpdGggaHlzdGVyZXNpcyB0byBwcmV2ZW50IGZhY2luZyBmbGlwcwovLyBGSVhFRDogSW1wcm92ZWQgYmFua2luZyB3aXRoIGh5c3RlcmVzaXMgdG8gcHJldmVudCBmYWNpbmcgZmxpcHMKICAgICAgICBfdXBkYXRlQmFua2luZyhkdCkgewogICAgICAgICAgICBjb25zdCBpbnB1dExlblNxID0gdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpOwogICAgICAgICAgICBjb25zdCB2ZWxMZW5TcSA9IHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKTsKCiAgICAgICAgICAgIGxldCB0YXJnZXRZYXcgPSB0aGlzLnRhcmdldFlhdzsKICAgICAgICAgICAgbGV0IHNob3VsZFVwZGF0ZVlhdyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUFJJT1JJVFkgMTogRXhwbGljaXQgQWltIChBaW0gU3RpY2sgLyBTd2lwZSkKICAgICAgICAgICAgaWYgKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgIHRhcmdldFlhdyA9IE1hdGguYXRhbjIodGhpcy5vdmVycmlkZUFpbVZlY3Rvci54LCB0aGlzLm92ZXJyaWRlQWltVmVjdG9yLnopOwogICAgICAgICAgICAgICAgc2hvdWxkVXBkYXRlWWF3ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBQUklPUklUWSAyOiBNb3ZlbWVudCBJbnB1dAogICAgICAgICAgICBlbHNlIGlmIChpbnB1dExlblNxID4gdGhpcy5mYWNpbmdEZWFkem9uZSAqIHRoaXMuZmFjaW5nRGVhZHpvbmUpIHsKICAgICAgICAgICAgICAgIHRhcmdldFlhdyA9IE1hdGguYXRhbjIodGhpcy5pbnB1dFZlY3Rvci54LCB0aGlzLmlucHV0VmVjdG9yLnopOwogICAgICAgICAgICAgICAgc2hvdWxkVXBkYXRlWWF3ID0gdHJ1ZTsKICAgICAgICAgICAgfSAKICAgICAgICAgICAgLy8gUFJJT1JJVFkgMzogVmVsb2NpdHkgKERyaWZ0aW5nKQogICAgICAgICAgICBlbHNlIGlmICh2ZWxMZW5TcSA+IHRoaXMuZmFjaW5nRGVhZHpvbmUgKiB0aGlzLmZhY2luZ0RlYWR6b25lKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMudmVsb2NpdHkueCwgdGhpcy52ZWxvY2l0eS56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElmIHdlIHNob3VsZCB1cGRhdGUsIGRvIHNvLiBPdGhlcndpc2Uga2VlcCBsYXN0IHZhbGlkIHlhdwogICAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlWWF3KSB7CiAgICAgICAgICAgICAgICB0aGlzLmxhc3RWYWxpZFlhdyA9IHRhcmdldFlhdzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRhcmdldFlhdyA9IHRoaXMubGFzdFZhbGlkWWF3OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbW9vdGggWWF3IHdpdGggd3JhcC1hcm91bmQgaGFuZGxpbmcKICAgICAgICAgICAgbGV0IGRpZmYgPSB0YXJnZXRZYXcgLSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgIHdoaWxlIChkaWZmID4gTWF0aC5QSSkgZGlmZiAtPSBNYXRoLlBJICogMjsKICAgICAgICAgICAgd2hpbGUgKGRpZmYgPCAtTWF0aC5QSSkgZGlmZiArPSBNYXRoLlBJICogMjsKCiAgICAgICAgICAgIGNvbnN0IHNwZWVkUmF0aW8gPSBNYXRoLm1pbigxLjAsIHRoaXMudmVsb2NpdHkubGVuZ3RoKCkgLyB0aGlzLm1heFNwZWVkKTsKY29uc3QgdHVyblNwZWVkID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoOC4wLCA0LjAsIHNwZWVkUmF0aW8pOyAvLyBSZWR1Y2VkIGZyb20gMTIuMC82LjAgdG8gcmVkdWNlIGZsaXBwaW5nCgogICAgICAgICAgICAvLyBQcmV2ZW50IHN1ZGRlbiBzbmFwcyB3aGVuIGRpZmYgaXMgdmVyeSBsYXJnZSAodGVsZXBvcnQvcmVzZXQgc2NlbmFyaW9zKQogICAgICAgICAgICBjb25zdCBtYXhZYXdDaGFuZ2UgPSBNYXRoLlBJICogZHQgKiB0dXJuU3BlZWQ7CiAgICAgICAgICAgIGNvbnN0IHlhd0NoYW5nZSA9IE1hdGgubWF4KC1tYXhZYXdDaGFuZ2UsIE1hdGgubWluKG1heFlhd0NoYW5nZSwgZGlmZiAqIGR0ICogdHVyblNwZWVkKSk7CgogICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgKz0geWF3Q2hhbmdlOwogICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IHRhcmdldFlhdzsKCiAgICAgICAgICAgIC8vIEJhbmtpbmcKICAgICAgICAgICAgY29uc3QgYmFua1NlbnNpdGl2aXR5ID0gMC44OwogICAgICAgICAgICBjb25zdCBtYXhCYW5rID0gMC43NTsKCiAgICAgICAgICAgIGxldCB0YXJnZXRCYW5rID0gLWRpZmYgKiBiYW5rU2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIHRhcmdldEJhbmsgPSBNYXRoLm1heCgtbWF4QmFuaywgTWF0aC5taW4obWF4QmFuaywgdGFyZ2V0QmFuaykpOwoKICAgICAgICAgICAgY29uc3QgYmFua0xlcnAgPSAxLjAgLSBNYXRoLnBvdygwLjAyLCBkdCk7CiAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCArPSAodGFyZ2V0QmFuayAtIHRoaXMuYmFua2luZ0Ftb3VudCkgKiBiYW5rTGVycDsKCiAgICAgICAgICAgIC8vIFBpdGNoCiAgICAgICAgICAgIGNvbnN0IHBpdGNoU2Vuc2l0aXZpdHkgPSAwLjE7CiAgICAgICAgICAgIGNvbnN0IG1heFBpdGNoID0gMS4wOwoKICAgICAgICAgICAgbGV0IHRhcmdldFBpdGNoID0gLXRoaXMudmVsb2NpdHkueSAqIHBpdGNoU2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIHRhcmdldFBpdGNoID0gTWF0aC5tYXgoLW1heFBpdGNoLCBNYXRoLm1pbihtYXhQaXRjaCwgdGFyZ2V0UGl0Y2gpKTsKCiAgICAgICAgICAgIGNvbnN0IHBpdGNoTGVycCA9IDEuMCAtIE1hdGgucG93KDAuMDUsIGR0KTsKICAgICAgICAgICAgdGhpcy5waXRjaEFtb3VudCArPSAodGFyZ2V0UGl0Y2ggLSB0aGlzLnBpdGNoQW1vdW50KSAqIHBpdGNoTGVycDsKCiAgICAgICAgICAgIC8vIEFwcGx5IFJvdGF0aW9uCiAgICAgICAgICAgIGNvbnN0IGZpbmFsWWF3ID0gdGhpcy5jdXJyZW50WWF3ICsgdGhpcy5yb3RhdGlvbk9mZnNldDsKCiAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLnNldEZyb21BeGlzQW5nbGUoX3BBeGlzWSwgZmluYWxZYXcpOwoKICAgICAgICAgICAgX3BRdWF0LnNldEZyb21BeGlzQW5nbGUobmV3IFRIUkVFLlZlY3RvcjMoMSwgMCwgMCksIHRoaXMucGl0Y2hBbW91bnQpOwogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseShfcFF1YXQpOwoKICAgICAgICAgICAgX3BRdWF0LnNldEZyb21BeGlzQW5nbGUobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSksIHRoaXMuYmFua2luZ0Ftb3VudCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wUXVhdCk7CgogICAgICAgICAgICAvLyBJZGxlIEJvYgogICAgICAgICAgICBpZiAodmVsTGVuU3EgPCAwLjEgJiYgIXRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0aW1lID0gRGF0ZS5ub3coKSAqIDAuMDAxNTsKICAgICAgICAgICAgICAgIGNvbnN0IGJvYlBpdGNoID0gTWF0aC5zaW4odGltZSkgKiAwLjAzOwogICAgICAgICAgICAgICAgY29uc3QgYm9iUm9sbCA9IE1hdGguY29zKHRpbWUgKiAwLjcpICogMC4wMjsKCl9wRXVsZXIuc2V0KGJvYlBpdGNoLCAwLCBib2JSb2xsKTsKICAgICAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tRXVsZXIoX3BFdWxlcik7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseShfcFF1YXQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2NoZWNrVGFja2xlUHJlc3N1cmUoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNFbmdhZ2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIXRoaXMudGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CgogICAgICAgICAgICBpZiAoIW9wcG9uZW50VGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGVuZ2FnZWRUaGlzRnJhbWUgPSBmYWxzZTsKICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlUmFkaXVzID0gdGhpcy5pc0VuZ2FnZWQgPyB0aGlzLnRhY2tsZVJhZGl1cyAqIDEuMiA6IHRoaXMudGFja2xlUmFkaXVzOwoKICAgICAgICAgICAgLy8gMS4gQ2hlY2sgRW5nYWdlbWVudCBTdGF0dXMKICAgICAgICAgICAgZm9yIChjb25zdCBlbnRpdHkgb2Ygb3Bwb25lbnRUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghZW50aXR5Lm1lc2ggfHwgZW50aXR5LnN0YXR1cy5uYXAgPiAwIHx8IGVudGl0eS5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhlbnRpdHkubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IGVmZmVjdGl2ZVJhZGl1cykgewogICAgICAgICAgICAgICAgICAgIGVuZ2FnZWRUaGlzRnJhbWUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gVXBkYXRlIFRpbWVyICYgVUkgRmVlZGJhY2sKICAgICAgICAgICAgaWYgKGVuZ2FnZWRUaGlzRnJhbWUpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBKdXN0IGJlY2FtZSBlbmdhZ2VkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbS5pc0h1bWFuICYmIHRoaXMudGVhbS5hY3RpdmVQbGF5ZXIgPT09IHRoaXMgJiYgZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkVOR0FHRUQhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtYWN0aW9uIik7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhpbnQgZm9yIHRoZSBwbGF5ZXIKICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0VuZ2FnZWQgJiYgdGhpcy5oYXNCYWxsICYmIGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJSRUFLIE5PVyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDIwMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciArPSBkdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5jb3VudGVyVGltZXIgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmlzRW5nYWdlZCA9IGVuZ2FnZWRUaGlzRnJhbWU7CgogICAgICAgICAgICAvLyAzLiBBcHBseSBEYW1hZ2UgKFdpdGggR3JhY2UgUGVyaW9kKQogICAgICAgICAgICAvLyBHcmFjZSBQZXJpb2Q6IDAuNXMgYmVmb3JlIGRhbWFnZSBzdGFydHMgdGlja2luZwogICAgICAgICAgICBpZiAodGhpcy5pc0VuZ2FnZWQgJiYgdGhpcy5lbmNvdW50ZXJUaW1lciA+IDAuNSkgewogICAgICAgICAgICAgICAgZm9yIChjb25zdCBlbnRpdHkgb2Ygb3Bwb25lbnRUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWVudGl0eS5tZXNoIHx8IGVudGl0eS5zdGF0dXMubmFwID4gMCB8fCBlbnRpdHkuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGVudGl0eS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IGVmZmVjdGl2ZVJhZGl1cykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBEaXNjcmV0ZSBDbGFzaCBFdmVudAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW50aXR5LmNsYXNoQ29vbGRvd24gPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzb2x2ZUNsYXNoKGVudGl0eSwgZ2FtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHkuY2xhc2hDb29sZG93biA9IDIuMDsgLy8gSW5jcmVhc2VkIGNvb2xkb3duICh3YXMgMS41KSB0byByZWR1Y2Ugc3BhbQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPD0gMCkgewogICAgICAgICAgICAgICAgdGhpcy5mdW1ibGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9yZXNvbHZlQ2xhc2gob3Bwb25lbnQsIGdhbWUpIHsKICAgICAgICAgICAgY29uc3Qgb3BwQVQgPSBvcHBvbmVudC5nZXRTdGF0KCdBVCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmFyaWFuY2U6IDAuOCB0byAxLjIKICAgICAgICAgICAgY29uc3QgdmFyaWFuY2UgPSAwLjggKyBNYXRoLnJhbmRvbSgpICogMC40OwogICAgICAgICAgICBsZXQgZGFtYWdlID0gTWF0aC5mbG9vcihvcHBBVCAqIHZhcmlhbmNlKTsKICAgICAgICAgICAgaWYgKGRhbWFnZSA8IDEpIGRhbWFnZSA9IDE7CgogICAgICAgICAgICAvLyBEaXJlY3Rpb25hbCBTaGllbGRpbmcKICAgICAgICAgICAgLy8gQ2FycmllciBGb3J3YXJkCiAgICAgICAgICAgIF9wVmVjLmNvcHkoX3BBeGlzWikuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsgCiAgICAgICAgICAgIC8vIFZlY3RvciBUbyBPcHBvbmVudAogICAgICAgICAgICBjb25zdCB0b09wcCA9IG9wcG9uZW50Lm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRvdCA9IF9wVmVjLmRvdCh0b09wcCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJZiBvcHBvbmVudCBpcyBCRUhJTkQgKGRvdCA8IC0wLjIpLCBkYW1hZ2UgaXMgcmVkdWNlZCAoU2hpZWxkaW5nKS4KICAgICAgICAgICAgbGV0IGlzU2hpZWxkZWQgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGRvdCA8IC0wLjIpIHsKICAgICAgICAgICAgICAgIGRhbWFnZSA9IE1hdGguZmxvb3IoZGFtYWdlICogMC41KTsKICAgICAgICAgICAgICAgIGlzU2hpZWxkZWQgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBcHBseSBEYW1hZ2UKICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gZGFtYWdlOwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPCAwKSB0aGlzLmN1cnJlbnRFTiA9IDA7CgogICAgICAgICAgICAvLyBUZWNoIEVmZmVjdHMKICAgICAgICAgICAgaWYgKG9wcG9uZW50LnRlY2hzLnRhY2tsZSkgewogICAgICAgICAgICAgICAgaWYgKG9wcG9uZW50LnRlY2hzLnRhY2tsZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ3Zlbm9tJywgMTAuMCk7CiAgICAgICAgICAgICAgICAgICAgZGFtYWdlICs9IDM7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wcG9uZW50LnRlY2hzLnRhY2tsZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0cyA9IFsnUEEnLCAnU0gnLCAnQVQnLCAnRU4nXTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBzdGF0c1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBzdGF0cy5sZW5ndGgpXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCd3aXRoZXInLCAxMC4wLCB0YXJnZXQpOwogICAgICAgICAgICAgICAgICAgIGRhbWFnZSArPSAzOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcHBvbmVudC50ZWNocy50YWNrbGUgPT09ICdkcmFpbicpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IGRhbWFnZTsgCiAgICAgICAgICAgICAgICAgICAgb3Bwb25lbnQuc3RhdHMuSFAgKz0gZGFtYWdlOwogICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkRSQUlOIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiaGVhbCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBWaXN1YWxzIC0gSlVJQ0VEIFVQCiAgICAgICAgICAgIGNvbnN0IG1pZFBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmxlcnAob3Bwb25lbnQubWVzaC5wb3NpdGlvbiwgMC41KTsKICAgICAgICAgICAgbWlkUG9zLnkgKz0gMS41OwoKICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAoaXNTaGllbGRlZCkgewogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTSElFTEQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJibG9jayIpOwogICAgICAgICAgICAgICAgICAgIH0sIDEwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERhbWFnZSBmZWVkYmFjawogICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oYCR7ZGFtYWdlfWAsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIC8vIE1hc3NpdmUgSW1wYWN0IEp1aWNlCiAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgbWlkUG9zLCB7IHNjYWxlOiAzLjAsIGxpZmU6IDAuNCB9KTsKICAgICAgICAgICAgICAgIGdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIG1pZFBvcywgeyBzY2FsZTogNC4wIH0pOwogICAgICAgICAgICAgICAgLy8gRGVicmlzIHNob3dlcgogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8NjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2RlYnJpcycsIG1pZFBvcywgeyBzY2FsZTogMC40IH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZ2FtZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAvLyBIRVJDVUxFQU4gU0hBS0UKICAgICAgICAgICAgICAgIGdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgyLjUpOyAvLyBJbmNyZWFzZWQgZnJvbSAxLjIKICAgICAgICAgICAgICAgIGdhbWUuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKC01KTsgLy8gWm9vbSBpbiBpbXBhY3QKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGdhbWUudHJpZ2dlckltcGFjdCkgewogICAgICAgICAgICAgICAgLy8gRnJlZXplIGZyYW1lCiAgICAgICAgICAgICAgICBnYW1lLnRyaWdnZXJJbXBhY3QoMC4xNSwgJ2hlYXZ5Jyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9wcG9uZW50LmdhaW5FeHAoMik7CiAgICAgICAgfQoKICAgICAgICBfcGVyZm9ybUplY2h0S25vY2tiYWNrKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW1JZCA9IHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW0gPSBnYW1lLnRlYW1zW29wcG9uZW50VGVhbUlkXTsKCiAgICAgICAgICAgIGlmICghb3Bwb25lbnRUZWFtKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCByYW5nZSA9IDYuMDsKICAgICAgICAgICAgY29uc3QgZm9yY2UgPSAyNS4wOwoKICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiSkVDSFQgU0hPVCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJnb2FsIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9wcG9uZW50VGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHAubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHJhbmdlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlyID0gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgZGlyLnkgPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgZGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LmFkZChkaXIubXVsdGlwbHlTY2FsYXIoZm9yY2UpKTsKCiAgICAgICAgICAgICAgICAgICAgcC5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBjb25zdCByZWFjdEFjdGlvbiA9IHAuYWN0aW9ucyAmJiBwLmFjdGlvbnNbJ3JlYWN0J107CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlYWN0QWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWN0QWN0aW9uLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgICAgICByZWFjdEFjdGlvbi5jbGFtcFdoZW5GaW5pc2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheU9uZVNob3QoJ3JlYWN0JywgMC4xKTsKfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjYXRjaCcsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNNQUNLISIsIHAubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS50cmlnZ2VySW1wYWN0KSBnYW1lLnRyaWdnZXJJbXBhY3QoMC4xNSwgJ3NoYXR0ZXInKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW1ibGUoKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJGVU1CTEUhIEVOIERlcGxldGVkLiIpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCAmJiB0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNSQVNIISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnN0dW5UaW1lciA9IDEuNTsKCiAgICAgICAgICAgIGNvbnN0IGJhY2tEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICBiYWNrRGlyLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICBiYWNrRGlyLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICBiYWNrRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoYmFja0Rpci5tdWx0aXBseVNjYWxhcigxMi4wKSk7CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICBpZiAoYmFsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGVqZWN0RGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoTWF0aC5yYW5kb20oKS0wLjUsIDAuOCwgTWF0aC5yYW5kb20oKS0wLjUpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGJhbGwuc2hvb3QoZWplY3REaXIsIDYuMCwgJ25vbmUnKTsKdGhpcy5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FuQ2F0Y2ggPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBkYXNoKHgsIHopIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuZGFzaENvb2xkb3duID4gMCkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gT0ZGRU5TRTogQlJFQUsgVEFDS0xFCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgJiYgdGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNvc3QgPSAxNTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPCBjb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiRkFJTEVEISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRFTiAtPSBjb3N0OwogICAgICAgICAgICAgICAgdGhpcy5pc0Rhc2hpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5kYXNoVGltZSA9IDAuNDsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaENvb2xkb3duID0gMi4wOwogICAgICAgICAgICAgICAgdGhpcy5kYXNoVHlwZSA9ICdicmVhayc7CgpfcFZlYy5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKF9wVmVjLm11bHRpcGx5U2NhbGFyKDE1LjApKTsKCiAgICAgICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwoKICAgICAgICAgICAgICAgIG9wcG9uZW50VGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ocC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHRoaXMudGFja2xlUmFkaXVzICogMS41KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHB1c2hEaXIgPSBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHVzaERpci55ID0gMC41OwogICAgICAgICAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LmFkZChwdXNoRGlyLm11bHRpcGx5U2NhbGFyKDE1LjApKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3R1blRpbWVyID0gMi4wOwogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXkoJ2NhdGNoJywgMC4yKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNUVU4hIiwgcC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCmlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJCUkVBSyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKLy8gTkVXOiBTcGF3biBCcmVhayBHbHlwaCAoRXhwbG9zaXZlIEJ1cnN0KQogICAgICAgICAgICAgICAgaWYgKGdhbWUuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ3N0YXR1cycsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDAuNSwKICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogOC4wLAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAzLjAsCiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFk6IDAuNQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCi8vIFBhcnRpY2xlIEJ1cnN0IChCcmVhayBUYWNrbGUpCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAyLjAsIGxpZmU6IDAuMyB9KTsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuNSB9KTsKICAgICAgICAgICAgICAgICAgICAvLyBCdWJibGUgQnVyc3QKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzMDsgaSsrKSB7CmNvbnN0IGJQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQoX3BWZWMuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSksIDEuMCsoTWF0aC5yYW5kb20oKS0wLjUpLCAoTWF0aC5yYW5kb20oKS0wLjUpKSk7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2J1YmJsZScsIGJQb3MsIHsgc2NhbGU6IDAuMiArIE1hdGgucmFuZG9tKCkgKiAwLjQgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChnYW1lLnRyaWdnZXJJbXBhY3QpIGdhbWUudHJpZ2dlckltcGFjdCgwLjE1LCAnaGVhdnknKTsKCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9GRkVOU0U6IFNQUklOVAogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjb3N0ID0gNTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRFTiA8IGNvc3QpIHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJOTyBFTiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOIC09IGNvc3Q7CiAgICAgICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gMC40OwogICAgICAgICAgICAgICAgdGhpcy5kYXNoQ29vbGRvd24gPSAxLjU7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ3NwcmludCc7Cgpjb25zdCBidXJzdERpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGlmIChidXJzdERpci5sZW5ndGhTcSgpIDwgMC4xKSBidXJzdERpci5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChidXJzdERpci5tdWx0aXBseVNjYWxhcigxNS4wKSk7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgyMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkRBU0ghIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBERUZFTlNFOiBCTE9DSyAvIFRBQ0tMRQogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGxldCBpc0Jsb2NrQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA4LjAgJiYgYmFsbC5tZXNoLnBvc2l0aW9uLnkgPiAyLjUpIHsKICAgICAgICAgICAgICAgICAgICBpc0Jsb2NrQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5kYXNoVGltZSA9IHRoaXMuZGFzaFRvdGFsVGltZTsKICAgICAgICAgICAgdGhpcy5kYXNoQ29vbGRvd24gPSAxLjU7CgogICAgICAgICAgICBjb25zdCBsZW4gPSBNYXRoLnNxcnQoeCp4ICsgeip6KTsKICAgICAgICAgICAgY29uc3QgbnggPSAobGVuID4gMCkgPyB4L2xlbiA6IDA7CiAgICAgICAgICAgIGNvbnN0IG56ID0gKGxlbiA+IDApID8gei9sZW4gOiAwOwoKaWYgKGxlbiA+IDApIHsKICAgICAgICAgICAgICAgIC8vIFNtb290aCB0dXJuIGZvciBkYXNoIGluc3RlYWQgb2Ygc25hcAogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSBNYXRoLmF0YW4yKG54LCBueik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQmxvY2tDb250ZXh0KSB7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ3ZlcnRpY2FsJzsKCiAgICAgICAgICAgICAgICBjb25zdCBkaXJUb0JhbGwgPSBiYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGRpclRvQmFsbC55ID0gMDsKCiAgICAgICAgICAgICAgICBpZiAoZGlyVG9CYWxsLmxlbmd0aFNxKCkgPiAwLjAxKSB7CiAgICAgICAgICAgICAgICAgICAgZGlyVG9CYWxsLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZGFzaFZlYy5jb3B5KGRpclRvQmFsbCkubXVsdGlwbHlTY2FsYXIoOC4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXNoVmVjLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBjYXRjaEFjdGlvbiA9IHRoaXMuYWN0aW9uc1snY2F0Y2gnXTsKICAgICAgICAgICAgICAgIGlmIChjYXRjaEFjdGlvbikgewogICAgICAgICAgICAgICAgICAgIGNhdGNoQWN0aW9uLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgIGNhdGNoQWN0aW9uLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjYXRjaEFjdGlvbi50aW1lU2NhbGUgPSAxLjU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnBsYXkoJ2NhdGNoJywgMC4xKTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRlZmF1bHQiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ2hvcml6b250YWwnOwogICAgICAgICAgICAgICAgdGhpcy5faGFzSGl0VGFja2xlID0gZmFsc2U7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdmVsb2NpdHkgaW1wdWxzZSBpbiBkYXNoIGRpcmVjdGlvbgovLyBBcHBseSB2ZWxvY2l0eSBpbXB1bHNlIGluIGRhc2ggZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBfcFZlYy5zZXQobngsIDAsIG56KTsKICAgICAgICAgICAgICAgIGlmIChfcFZlYy5sZW5ndGhTcSgpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChfcFZlYy5tdWx0aXBseVNjYWxhcigyMC4wKSk7CgogICAgICAgICAgICAgICAgY29uc3QgbHVuZ2VBY3Rpb24gPSB0aGlzLmFjdGlvbnNbJ3Rocm93J107CiAgICAgICAgICAgICAgICBpZiAobHVuZ2VBY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICBsdW5nZUFjdGlvbi5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgICAgICBsdW5nZUFjdGlvbi5jbGFtcFdoZW5GaW5pc2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgbHVuZ2VBY3Rpb24udGltZVNjYWxlID0gMi4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wbGF5KCd0aHJvdycsIDAuMSk7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjA1LCAnZGVmYXVsdCcpOwogICAgICAgICAgICB9CgppZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZEZvdkltcHVsc2UoMTApOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC4zKTsgCiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gRGFzaCBFZmZlY3QKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRhc2hQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgIGRhc2hQb3MueSArPSAxLjA7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBkYXNoUG9zLCB7IHNjYWxlOiAxLjUsIGxpZmU6IDAuMyB9KTsKICAgICAgICAgICAgICAgIC8vIFNwZWVkIGxpbmVzCiAgICAgICAgICAgICAgICBjb25zdCBiYWNrID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGRhc2hQb3MuY2xvbmUoKS5hZGQoYmFjay5tdWx0aXBseVNjYWxhcihNYXRoLnJhbmRvbSgpKSk7CiAgICAgICAgICAgICAgICAgICAgcC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwLCB7IHNjYWxlOiAxLjUgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jcmVhdGVIUEJhcigpIHsKICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gbmV3IFRIUkVFLkdyb3VwKCk7CgogICAgICAgICAgICBjb25zdCBiZ0dlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDEuMiwgMC4xNSk7CiAgICAgICAgICAgIGNvbnN0IGJnTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDAwMDAwLCBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCBkZXB0aFRlc3Q6IGZhbHNlIH0pOwogICAgICAgICAgICBjb25zdCBiZyA9IG5ldyBUSFJFRS5NZXNoKGJnR2VvLCBiZ01hdCk7CiAgICAgICAgICAgIGNvbnRhaW5lci5hZGQoYmcpOwoKICAgICAgICAgICAgY29uc3QgZmlsbEdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDEuMTYsIDAuMTEpOwogICAgICAgICAgICBmaWxsR2VvLnRyYW5zbGF0ZSgwLjU4LCAwLCAwKTsKICAgICAgICAgICAgY29uc3QgZmlsbE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmYwMCwgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgZGVwdGhUZXN0OiBmYWxzZSB9KTsKICAgICAgICAgICAgdGhpcy5ocEJhckZpbGwgPSBuZXcgVEhSRUUuTWVzaChmaWxsR2VvLCBmaWxsTWF0KTsKICAgICAgICAgICAgdGhpcy5ocEJhckZpbGwucG9zaXRpb24uc2V0KC0wLjU4LCAwLCAwLjAxKTsKICAgICAgICAgICAgY29udGFpbmVyLmFkZCh0aGlzLmhwQmFyRmlsbCk7CgogICAgICAgICAgICB0aGlzLmhwQmFyID0gY29udGFpbmVyOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmhwQmFyKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVIUEJhcigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhwQmFyIHx8ICF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIHRoaXMuaHBCYXIucG9zaXRpb24uY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLmhwQmFyLnBvc2l0aW9uLnkgKz0gMi4yOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLmxvb2tBdCh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhLnBvc2l0aW9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgcGN0ID0gTWF0aC5tYXgoMCwgdGhpcy5zdGF0cy5IUCAvIHRoaXMuc3RhdHMubWF4SFApOwogICAgICAgICAgICB0aGlzLmhwQmFyRmlsbC5zY2FsZS5zZXRYKHBjdCk7CgogICAgICAgICAgICBpZiAocGN0ID4gMC41KSB0aGlzLmhwQmFyRmlsbC5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHgwMGZmMDApOwogICAgICAgICAgICBlbHNlIGlmIChwY3QgPiAwLjI1KSB0aGlzLmhwQmFyRmlsbC5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZmZmMDApOwogICAgICAgICAgICBlbHNlIHRoaXMuaHBCYXJGaWxsLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmMDAwMCk7CgogICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSAocGN0IDwgMC45OCk7CiAgICAgICAgfQoKICAgICAgICBnYWluRXhwKGFtb3VudCkgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSB8fCB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CgogICAgICAgICAgICB0aGlzLmV4cCArPSBhbW91bnQ7CgogICAgICAgICAgICBpZiAodGhpcy5leHAgPj0gdGhpcy5uZXh0TGV2ZWxFeHApIHsKICAgICAgICAgICAgICAgIHRoaXMubGV2ZWxVcCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsZXZlbFVwKCkgewogICAgICAgICAgICB0aGlzLmxldmVsKys7CiAgICAgICAgICAgIHRoaXMuZXhwIC09IHRoaXMubmV4dExldmVsRXhwOwogICAgICAgICAgICB0aGlzLm5leHRMZXZlbEV4cCA9IE1hdGguZmxvb3IodGhpcy5uZXh0TGV2ZWxFeHAgKiAxLjUpOwoKICAgICAgICAgICAgY29uc3Qga2V5cyA9IFsnSFAnLCAnRU4nLCAnQVQnLCAnUEEnLCAnQkwnLCAnU0gnLCAnQ0EnLCAnU1AnXTsKCiAgICAgICAgICAgIGNvbnN0IGhwR2FpbiA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDIwKSArIDEwOwogICAgICAgICAgICB0aGlzLnN0YXRzLm1heEhQICs9IGhwR2FpbjsKICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCA9IHRoaXMuc3RhdHMubWF4SFA7CgogICAgICAgICAgICBrZXlzLmZvckVhY2goayA9PiB7CiAgICAgICAgICAgICAgICBpZiAoayA9PT0gJ0hQJykgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPiAwLjQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnYWluID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMikgKyAxOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHNba10gKz0gZ2FpbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gcmVhY2hlZCBMZXZlbCAke3RoaXMubGV2ZWx9IWApOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgdGhpcy5tZXNoKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJMRVZFTCBVUCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jaGVja1RhY2tsZUNvbGxpc2lvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW0gfHwgdGhpcy5faGFzSGl0VGFja2xlKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwoKICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3Bwb25lbnRUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG9wcC5tZXNoLnBvc2l0aW9uKTsKCmlmIChkaXN0IDwgMy4wKSB7IC8vIEluY3JlYXNlZCBmcm9tIDIuMCBmb3IgZWFzaWVyIGhpdHMKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNvbHZlVGFja2xlSGl0KG9wcCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGFzSGl0VGFja2xlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9yZXNvbHZlVGFja2xlSGl0KG9wcCkgewogICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKC0wLjUpOwogICAgICAgICAgICBpZiAoIXRoaXMuX2xheWVyZWRFbmFibGVkKSB0aGlzLnBsYXkoJ2lkbGUnLCAwLjIpOwoKICAgICAgICAgICAgY29uc3QgYXQgPSB0aGlzLmdldFN0YXQoJ0FUJyk7CiAgICAgICAgICAgIGxldCBkYW1hZ2UgPSBhdCAqIDMuMDsKCiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnRhY2tsZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgb3BwLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDEwLjApOwogICAgICAgICAgICAgICAgZGFtYWdlICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50ZWNocy50YWNrbGUgPT09ICd3aXRoZXInKSB7CiAgICAgICAgICAgICAgICBvcHAuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDEwLjAsICdFTicpOwogICAgICAgICAgICAgICAgZGFtYWdlICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50ZWNocy50YWNrbGUgPT09ICdkcmFpbicpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgKz0gMjA7CiAgICAgICAgICAgICAgICBvcHAuc3RhdHMuSFAgLT0gMjA7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJEUkFJTiIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBvcHAuY3VycmVudEVOIC09IGRhbWFnZTsKCmlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUmVtb3ZlZCAiRU4iIHN1ZmZpeCBmb3IgY2xlYW5lciBsb29rCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgJHtNYXRoLmZsb29yKGRhbWFnZSl9YCwgb3BwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCQU0hIiwgb3BwLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAob3BwLmN1cnJlbnRFTiA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgb3BwLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBvcHAuc3R1blRpbWVyID0gMC41OwogICAgICAgICAgICAgICAgICAgIG9wcC5wbGF5T25lU2hvdCgncmVhY3QnLCAwLjEpOwp9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMudGFja2xlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQodGhpcywgdGhpcy50ZWNocy50YWNrbGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG9wcC5zdHVuVGltZXIgPSAxLjA7CiAgICAgICAgICAgICAgICBvcHAucGxheU9uZVNob3QoJ3JlYWN0JywgMC4xKTsKaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTTUFDSyEiLCBvcHAubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBwdXNoRGlyID0gb3BwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgcHVzaERpci55ID0gMC4yOwogICAgICAgICAgICBvcHAudmVsb2NpdHkuYWRkKHB1c2hEaXIubXVsdGlwbHlTY2FsYXIoMTIuMCkpOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjEsICdoZWF2eScpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuOCk7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaCkgewpjb25zdCBtaWQgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQob3BwLm1lc2gucG9zaXRpb24pLm11bHRpcGx5U2NhbGFyKDAuNSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaChtaWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAovLyBCdWJibGUgQnVyc3QgKFRhY2tsZSBIaXQpCi8vIEJ1YmJsZSBCdXJzdCAoVGFja2xlIEhpdCkKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG1pZCA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmxlcnAob3BwLm1lc2gucG9zaXRpb24sIDAuNSk7CiAgICAgICAgICAgICAgICBtaWQueSArPSAxLjA7CiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzMDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYnViYmxlUG9zID0gbWlkLmNsb25lKCkuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKChNYXRoLnJhbmRvbSgpLTAuNSkqMS41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjEuNSwgKE1hdGgucmFuZG9tKCktMC41KSoxLjUpKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBidWJibGVQb3MsIHsgc2NhbGU6IDAuMTUgKyBNYXRoLnJhbmRvbSgpICogMC4zNSB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5R29hbENyZWFzZShkdCkgewoKICAgICAgICAgICAgY29uc3QgZ29hbHMgPSBbCgogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgNDYpLAogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgLTQ2KQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gMTAuMDsKCiAgICAgICAgICAgIGdvYWxzLmZvckVhY2goZ29hbCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBkeCA9IHRoaXMubWVzaC5wb3NpdGlvbi54IC0gZ29hbC54OwogICAgICAgICAgICAgICAgY29uc3QgZHogPSB0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWwuejsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IGR4KmR4ICsgZHoqZHo7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IHJhZGl1cyAqIHJhZGl1cykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZGlzdFNxKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWCA9IGRpc3QgPiAwID8gZHggLyBkaXN0IDogMTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWiA9IGRpc3QgPiAwID8gZHogLyBkaXN0IDogMDsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSA1MC4wOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSBwdXNoWCAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9IHB1c2haICogZm9yY2UgKiBkdDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByYWRpdXMgLSAwLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xhbXBSYXRpbyA9IHJhZGl1cyAvIChkaXN0ICsgMC4wMDEpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueCA9IGdvYWwueCArIGR4ICogY2xhbXBSYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSBnb2FsLnogKyBkeiAqIGNsYW1wUmF0aW87CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguUGxheWVyID0gUGxheWVyOwp9KSgpOwo=","./Player.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBCYWxsIExhYiAvIERldlRvb2xzOiB0aHJvdyAmIGN1cnZlIG1hcHBpbmcga25vYnMKICAgIC8vIChEZWZhdWx0cyBtYXRjaCBjdXJyZW50IGZlZWw7IERldlRvb2xzIGNhbiB0d2VhayBhdCBydW50aW1lLikKICAgIHdpbmRvdy5mbHV4LlRocm93Q29uZmlnID0gd2luZG93LmZsdXguVGhyb3dDb25maWcgfHwgewogICAgICAgIFNXSVBFX01JTl9QWDogMjAsCiAgICAgICAgQUlNX0RYX1NDQUxFOiAxLjAsCiAgICAgICAgQUlNX0RZX1NDQUxFOiAxLjAsCgogICAgICAgIFBPV0VSX0JBU0U6IDEuMCwKICAgICAgICBQT1dFUl9SQU5HRTogMC44LCAgICAgICAgICAvLyBCYXNlIG11bHRpcGxpZXIgPSBQT1dFUl9CQVNFICsgcmF0aW8qUE9XRVJfUkFOR0UKICAgICAgICBQT1dFUl9NQVhfQk9OVVNfUkFUSU86IDAuOTUsCiAgICAgICAgUE9XRVJfTUFYX01VTFRJUExJRVI6IDIuNSwKCiAgICAgICAgQ1VSVkVfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBDVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEOiAwLjI1LAogICAgICAgIENVUlZFX1NQSU5fU0NBTEU6IDEwMDAuMCwKICAgICAgICBDVVJWRV9TUEVFRF9NVUxUOiAxLjUsCiAgICAgICAgQ1VSVkVfU1BJTl9DQVA6IDE1MDAuMCwKICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDUwMC4wCiAgICB9OwoKICAgIC8vIEFzc2lzdCBrbm9icyAoMC4uMSk6IGhlbHBzIG1ha2UgdGhlIGdhbWUgZmVlbCAic3BvcnR5IiArIGZsdWlkIHdpdGhvdXQgZ29pbmcgZnVsbCBhdXRvLgogICAgd2luZG93LmZsdXguQXNzaXN0Q29uZmlnID0gd2luZG93LmZsdXguQXNzaXN0Q29uZmlnIHx8IHsKICAgICAgICBQQVNTX0FJTV9BU1NJU1Q6IDAuNjUsCiAgICAgICAgU0hPVF9BSU1fQVNTSVNUOiAwLjM1LAogICAgICAgIENBVENIX0FTU0lTVDogMC41NSwKICAgICAgICBTVEVFUklOR19BU1NJU1Q6IDAuMzUsCiAgICAgICAgSU5QVVRfUkVTUE9OU0U6IDE0LjAsCiAgICAgICAgUEFTU19DT05FX0RFRzogNjAsCiAgICAgICAgU0hPVF9DT05FX0RFRzogMzUsCiAgICAgICAgUEFTU19MRUFEX1RJTUU6IDAuMjIsCiAgICAgICAgU0hPVF9MSUZUOiAwLjA4CiAgICB9OwoKLy8gUmV1c2FibGUgbWF0aCBvYmplY3RzCmNvbnN0IF9wVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9wVmVjMiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfcFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BRdWF0MiA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRhcmdldFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BFdWxlciA9IG5ldyBUSFJFRS5FdWxlcigpOwogICAgY29uc3QgX3BBeGlzWSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApOwogICAgY29uc3QgX3BBeGlzWiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpOwoKY2xhc3MgUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSA9ICdNRicpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLnJvbGUgPSByb2xlOwogICAgICAgICAgICB0aGlzLnRlYW0gPSBudWxsOyAvLyBBc3NpZ25lZCBieSBUZWFtLmFkZFBsYXllcgogICAgICAgICAgICB0aGlzLmhvbWVQb3NpdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLm1peGVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hY3Rpb25zID0ge307CiAgICAgICAgICAgIHRoaXMuYWN0aXZlQWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdpZGxlJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2xhc3RMb2NvbW90aW9uID0gJ2lkbGUnOwp0aGlzLmlucHV0VmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuZGVzaXJlZElucHV0VmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAvLyBQaHlzaWNzIChEcmlmdC9JbmVydGlhIE1vZGVsKQogICAgICAgICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYWNjZWxlcmF0aW9uID0gMTIuMDsKICAgICAgICAgICAgdGhpcy5kcmFnID0gMy4wOwogICAgICAgICAgICB0aGlzLm1heFNwZWVkID0gOC4wOwogICAgICAgICAgICAvLyBCb25lIHJlZmVyZW5jZSBmb3IgaG9sZGluZyBiYWxsCiAgICAgICAgICAgIHRoaXMuaGFuZEJvbmUgPSBudWxsOwp0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duID0gMDsgLy8gUmVwbGFjZXMgc2V0VGltZW91dCBmb3Igc2FmZXR5CgogICAgICAgICAgICAvLyBCbGl0emJhbGwgU3RhdHMKICAgICAgICAgICAgdGhpcy5zdGF0cyA9IHsKICAgICAgICAgICAgICAgIEhQOiAxMDAsCiAgICAgICAgICAgICAgICBtYXhIUDogMTAwLAogICAgICAgICAgICAgICAgRU46IDMwLAogICAgICAgICAgICAgICAgQVQ6IDEwLAogICAgICAgICAgICAgICAgUEE6IDE1LAogICAgICAgICAgICAgICAgQkw6IDEwLAogICAgICAgICAgICAgICAgU0g6IDE1LAogICAgICAgICAgICAgICAgQ0E6IDEwLAogICAgICAgICAgICAgICAgU1A6IDYwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBMZXZlbGluZyBTeXN0ZW0KICAgICAgICAgICAgdGhpcy5sZXZlbCA9IDE7CiAgICAgICAgICAgIHRoaXMuZXhwID0gMDsKICAgICAgICAgICAgdGhpcy5uZXh0TGV2ZWxFeHAgPSAxMDA7CgogICAgICAgICAgICAvLyBTdGF0dXMgRWZmZWN0cyAmIFRlY2huaXF1ZXMKICAgICAgICAgICAgdGhpcy5zdGF0dXMgPSB7CiAgICAgICAgICAgICAgICB2ZW5vbTogMCwKICAgICAgICAgICAgICAgIG5hcDogMCwKICAgICAgICAgICAgICAgIHdpdGhlcjogeyBQQTogMCwgU0g6IDAsIEFUOiAwLCBCTDogMCwgQ0E6IDAsIFNQOiAwIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMubWFya2luZyA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubGVhcm5lZFRlY2hzID0gW107CgogICAgICAgICAgICB0aGlzLnRlY2hzID0gewogICAgICAgICAgICAgICAgdGFja2xlOiBudWxsLAogICAgICAgICAgICAgICAgc2hvb3Q6IG51bGwsCiAgICAgICAgICAgICAgICBwYXNzOiBudWxsLAogICAgICAgICAgICAgICAgcGFzc2l2ZTogbnVsbAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVmlzdWFscwogICAgICAgICAgICB0aGlzLmJhc2VDb2xvckhleCA9IDB4ZmZmZmZmOwogICAgICAgICAgICB0aGlzLm9yaWdpbmFsTWF0ZXJpYWxzID0gW107CiAgICAgICAgICAgIHRoaXMuYXVyYU1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLnJvdGF0aW9uT2Zmc2V0ID0gMDsKdGhpcy5iYXNlU2NhbGUgPSAxLjE3OyAvLyBJbmNyZWFzZWQgfjglCgogICAgICAgICAgICAvLyBSZWFsLXRpbWUgU3RhdHMKICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSB0aGlzLnN0YXRzLkVOOwp0aGlzLnRhY2tsZVJhZGl1cyA9IDIuMDsgLy8gUmVkdWNlZCBmcm9tIDIuNSB0byByZWR1Y2Ugc3dhcm0gbG9jawoKICAgICAgICAgICAgdGhpcy5zcGVlZCA9IDQuMDsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CgogICAgICAgICAgICB0aGlzLmhhc0JhbGwgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBEYXNoIFN0YXRlCiAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmRhc2hUb3RhbFRpbWUgPSAwLjU7CnRoaXMuZGFzaENvb2xkb3duID0gMDsKICAgICAgICAgICAgdGhpcy5kYXNoVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIC8vIEZlZWRiYWNrIEFjY3VtdWxhdG9ycwogICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSA9IDA7CiAgICAgICAgICAgIHRoaXMuX2RhbWFnZVRpbWVyID0gMDsKCiAgICAgICAgICAgIC8vIEhQIEJhcgogICAgICAgICAgICB0aGlzLmhwQmFyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5ocEJhckZpbGwgPSBudWxsOwoKICAgICAgICAgICAgLy8gR2FtZXBsYXkgRmxvdyBUaW1lcnMKICAgICAgICAgICAgdGhpcy5zdHVuVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLmltbXVuaXR5VGltZXIgPSAwOwoKICAgICAgICAgICAgLy8gQmFua2luZyAmIFZlcnRpY2FsaXR5CiAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0WSA9IDA7CgogICAgICAgICAgICAvLyBFbmNvdW50ZXIgU3lzdGVtCiAgICAgICAgICAgIHRoaXMuaXNFbmdhZ2VkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY2xhc2hUaW1lciA9IDA7CgogICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsgLy8gVHJhY2sgZHVyYXRpb24gb2YgY3VycmVudCBlbmdhZ2VtZW50CiAgICAgICAgICAgIC8vIENoYXJnZSBNZWNoYW5pYwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jaGFyZ2VUaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5tYXhDaGFyZ2VUaW1lID0gMS41OwoKICAgICAgICAgICAgLy8gRklYRUQ6IEltcHJvdmVkIFJvdGF0aW9uIFN0YXRlIHdpdGggaHlzdGVyZXNpcwogICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IDA7CiAgICAgICAgICAgIHRoaXMubGFzdFZhbGlkWWF3ID0gMDsgLy8gU3RvcmUgbGFzdCBrbm93biBnb29kIHlhdyBmb3IgZGVhZHpvbmUgaGFuZGxpbmcKICAgICAgICAgICAgdGhpcy5waXRjaEFtb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMuZmFjaW5nRGVhZHpvbmUgPSAwLjM7IC8vIE1pbmltdW0gaW5wdXQvdmVsb2NpdHkgbWFnbml0dWRlIHRvIHVwZGF0ZSBmYWNpbmcKCiAgICAgICAgICAgIC8vIFBhcnRpY2xlIEVtaXNzaW9uIFRpbWVycwogICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycyA9IHsKICAgICAgICAgICAgICAgIHZlbm9tOiAwLAogICAgICAgICAgICAgICAgbmFwOiAwLAogICAgICAgICAgICAgICAgd2l0aGVyOiAwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBEZXZUb29scyBGbGFncwogICAgICAgICAgICB0aGlzLmlzR29kTW9kZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUGFzcyBUYXJnZXQgSW5kaWNhdG9yCi8vIFBhc3MgVGFyZ2V0IEluZGljYXRvcgogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IgPSBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQnViYmxlIFRyYWlsIFRpbWVyCiAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMDsKCnRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyID0gMDsKICAgICAgICB9CgogICAgICAgIHN5bmNSb3RhdGlvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgZXVsZXIgPSBuZXcgVEhSRUUuRXVsZXIoKS5zZXRGcm9tUXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbiwgJ1lYWicpOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgPSBldWxlci55IC0gdGhpcy5yb3RhdGlvbk9mZnNldDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgIHRoaXMubGFzdFZhbGlkWWF3ID0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ID0gMDsKICAgICAgICB9CgogICAgICAgIGdldFN0YXQobmFtZSkgewogICAgICAgICAgICBsZXQgdmFsID0gdGhpcy5zdGF0c1tuYW1lXTsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltuYW1lXSA+IDApIHsKICAgICAgICAgICAgICAgIHZhbCAqPSAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICB9CgogICAgICAgIGFwcGx5U3RhdHVzKHR5cGUsIGR1cmF0aW9uLCBzdWJUeXBlID0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMudmVub20gPiAxLjA7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy52ZW5vbSA9IE1hdGgubWF4KHRoaXMuc3RhdHVzLnZlbm9tLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnJvbGV9IHBvaXNvbmVkIWApOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQT0lTT04iLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMubmFwID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gTWF0aC5tYXgodGhpcy5zdGF0dXMubmFwLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gZmVsbCBhc2xlZXAhYCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNMRUVQIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3dpdGhlcicgJiYgc3ViVHlwZSkgewogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFZhbCA9IHRoaXMuc3RhdHVzLndpdGhlcltzdWJUeXBlXSB8fCAwOwogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gY3VycmVudFZhbCA+IDEuMDsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLndpdGhlcltzdWJUeXBlXSA9IE1hdGgubWF4KGN1cnJlbnRWYWwsIGR1cmF0aW9uKTsKCiAgICAgICAgICAgICAgICBpZiAoIXdhc0FjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gd2l0aGVyZWQgJHtzdWJUeXBlfSFgKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgV0lUSEVSICR7c3ViVHlwZX1gLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZURlcml2ZWRTdGF0cygpIHsKICAgICAgICAgICAgY29uc3Qgc3AgPSB0aGlzLmdldFN0YXQoJ1NQJyk7CiAgICAgICAgICAgIHRoaXMubWF4U3BlZWQgPSA1LjAgKyAoc3AgLyAxNS4wKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSB0aGlzLmdldFN0YXQoJ0VOJyk7CiAgICAgICAgfQoKc2V0TWVzaChzb3VyY2VNZXNoLCBhbmltYXRpb25zKSB7CiAgICAgICAgICAgIHRoaXMubWVzaCA9IHNvdXJjZU1lc2g7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUhQQmFyKCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUF1cmEoKTsKICAgICAgICAgICAgdGhpcy5fY3JlYXRlUGFzc1RhcmdldEluZGljYXRvcigpOwoKICAgICAgICAgICAgLy8gQ3VzdG9tIENoYXJhY3RlciBTY2FsaW5nCiAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUuaW5jbHVkZXMoJ1RpZHVzJykpIHRoaXMuYmFzZVNjYWxlID0gMS42OwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB0aGlzLmJhc2VTY2FsZSA9IDEuNDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXNoLnNjYWxlLnNldFNjYWxhcih0aGlzLmJhc2VTY2FsZSk7CgogICAgICAgICAgICB0aGlzLm1lc2gudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCAmJiBub2RlLm1hdGVyaWFsKSB7CmNvbnN0IGNvbnZlcnRPbmUgPSAobWF0KSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG0gPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwOiBtYXQubWFwIHx8IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogbmV3IFRIUkVFLkNvbG9yKDB4ZmZmZmZmKSwgLy8gRk9SQ0UgV0hJVEU6IElnbm9yZSBzb3VyY2UgY29sb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiAhIW1hdC50cmFuc3BhcmVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IChtYXQub3BhY2l0eSAhPT0gdW5kZWZpbmVkID8gbWF0Lm9wYWNpdHkgOiAxKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFscGhhVGVzdDogKG1hdC5hbHBoYVRlc3QgIT09IHVuZGVmaW5lZCA/IG1hdC5hbHBoYVRlc3QgOiAwKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpZGU6IG1hdC5zaWRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwdGhUZXN0OiBtYXQuZGVwdGhUZXN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogbWF0LmRlcHRoV3JpdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb2c6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBza2lubmluZzogISFub2RlLmlzU2tpbm5lZE1lc2gKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMucHVzaCh7IG1hdGVyaWFsOiBtLCBiYXNlQ29sb3I6IG0uY29sb3IuY2xvbmUoKSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG07CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gQXJyYXkuaXNBcnJheShub2RlLm1hdGVyaWFsKQogICAgICAgICAgICAgICAgICAgICAgICA/IG5vZGUubWF0ZXJpYWwubWFwKGNvbnZlcnRPbmUpCiAgICAgICAgICAgICAgICAgICAgICAgIDogY29udmVydE9uZShub2RlLm1hdGVyaWFsKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAobm9kZS5pc0JvbmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gbm9kZS5uYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKChuYW1lLmluY2x1ZGVzKCdoYW5kJykgJiYgbmFtZS5pbmNsdWRlcygncicpKSB8fCBuYW1lLmluY2x1ZGVzKCdyaWdodGhhbmQnKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRCb25lID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5taXhlciA9IG5ldyBUSFJFRS5BbmltYXRpb25NaXhlcih0aGlzLm1lc2gpOwoKICAgICAgICAgICAgLy8gTGF5ZXJlZCBhbmltYXRpb24gc3lzdGVtIChsb2NvbW90aW9uIGJhc2UgKyB1cHBlci1ib2R5IG92ZXJsYXkgKyBmdWxsLWJvZHkgb25lLXNob3RzKQogICAgICAgICAgICB0aGlzLmNsaXBzID0ge307CiAgICAgICAgICAgIHRoaXMudXBwZXJBY3Rpb25zID0ge307CiAgICAgICAgICAgIHRoaXMuYmFzZUFjdGlvbnMgPSB7fTsKICAgICAgICAgICAgdGhpcy5hY3RpdmVVcHBlckFjdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX3VwcGVyTG9ja2VkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX3VwcGVyTG9ja2VkU3RhdGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLl9sYXllcmVkRW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX2xvY29tb3Rpb25GYWRlID0gMC4yOwogICAgICAgICAgICB0aGlzLl9hbmltU3BlZWRTbW9vdGhlZCA9IDA7CiAgICAgICAgICAgIHRoaXMuX2Jhc2VTdXBwcmVzc2lvbiA9IDA7CgoKICAgICAgICAgICAgaWYgKGFuaW1hdGlvbnMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IF9ub3JtQ2xpcE5hbWUgPSAocykgPT4gKHMgfHwgJycpCiAgICAgICAgICAgICAgICAgICAgLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvW19cLV0rL2csICcgJykKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXHMrL2csICcgJykKICAgICAgICAgICAgICAgICAgICAudHJpbSgpOwoKICAgICAgICAgICAgICAgIGFuaW1hdGlvbnMuZm9yRWFjaCgoY2xpcCkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBfbm9ybUNsaXBOYW1lKGNsaXAubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWN0aW9uID0gdGhpcy5taXhlci5jbGlwQWN0aW9uKGNsaXApOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhcyA9IChyZSkgPT4gcmUudGVzdChuYW1lKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVnID0gKGtleSkgPT4geyB0aGlzLmFjdGlvbnNba2V5XSA9IGFjdGlvbjsgdGhpcy5jbGlwc1trZXldID0gY2xpcDsgfTsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIENvcmUgbG9jb21vdGlvbiAtLS0KICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC90cmVhZHx0cmVhZGluZ3xpZGxlfGZsb2F0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnKCdpZGxlJyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2Rhc2h8c3ByaW50fGJ1cnN0fGZhc3Rccypzd2ltfHN3aW1ccypmYXN0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnKCdkYXNoJyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3N3aW18ZnJlZXN0eWxlfGNyYXdsLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnKCdzd2ltJyk7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBUaHJvd2luZyAocGFzcy9zaG90IHZhcmlhbnRzIGlmIHByZXNlbnQpIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC90aHJvd3x0b3NzfHBpdGNoLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhcygvc2hvb3R8c2hvdHxnb2FsLykpIHJlZygndGhyb3dfc2hvdCcpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChoYXMoL3Bhc3MvKSkgcmVnKCd0aHJvd19wYXNzJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgcmVnKCd0aHJvdycpOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gQ2F0Y2hpbmcgKGp1bXAvYWlyIHZhcmlhbnRzIGlmIHByZXNlbnQpIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jYXRjaHxyZWNlaXZlfGdyYWJ8aW50ZXJjZXB0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhcygvanVtcHxsZWFwfGFpcnxkaXZlLykpIHJlZygnY2F0Y2hfanVtcCcpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHJlZygnY2F0Y2gnKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIEhpdCAvIFJlYWN0IC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9yZWFjdHxoaXR8aHVydHxkYW1hZ2V8c3RhZ2dlcnxrbm9jay8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZygncmVhY3QnKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIE9wdGlvbmFsIHN0YXRlcyAob25seSB1c2VkIGlmIGNsaXBzIGV4aXN0KSAtLS0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvY2hhcmdlfGFpbXxyZWFkeXx3aW5kdXB8aG9sZC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZygnY2hhcmdlJyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3RhY2tsZXxjaGVja3xyYW0vKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZWcoJ3RhY2tsZScpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9ibG9ja3xzYXZlLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnKCdibG9jaycpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jZWxlYnJhdGV8dmljdG9yeXxjaGVlci8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZygnY2VsZWJyYXRlJyk7CgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aW9uc1tjbGlwLm5hbWVdID0gYWN0aW9uOyB0aGlzLmNsaXBzW2NsaXAubmFtZV0gPSBjbGlwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CmlmICh0aGlzLmFjdGlvbnNbJ2lkbGUnXSkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2xheWVyZWRFbmFibGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW4gbGF5ZXJlZCBtb2RlIHdlIGRvbid0IHVzZSB0aGUgc2luZ2xlLWFjdGlvbiBzdGF0ZSBtYWNoaW5lLgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFjdGlvbnNbJ2lkbGUnXS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3Rpb25zWydpZGxlJ10ucGxheSgpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgZmlyc3QgPSBPYmplY3QudmFsdWVzKHRoaXMuYWN0aW9ucylbMF07CiAgICAgICAgICAgICAgICBpZihmaXJzdCkgZmlyc3QucGxheSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIGxheWVyZWQgbWl4aW5nIGlmIGVuYWJsZWQuCiAgICAgICAgICAgIGlmICh0aGlzLl9sYXllcmVkRW5hYmxlZCkgewogICAgICAgICAgICAgICAgdGhpcy5faW5pdExheWVyZWRBbmltYXRpb24oKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBPbmUtc2hvdCBhbmltYXRpb24gbG9jazogcHJldmVudCBsb2NvbW90aW9uIGZyb20gaW50ZXJydXB0aW5nIHRocm93L2NhdGNoL3JlYWN0LgogICAgICAgICAgICAvLyBXaGVuIGEgb25lLXNob3QgZmluaXNoZXMsIGF1dG9tYXRpY2FsbHkgcmV0dXJuIHRvIGxvY29tb3Rpb24uCiAgICAgICAgICAgIGlmICh0aGlzLm1peGVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1peGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2ZpbmlzaGVkJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2FuaW1Mb2NrZWQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBpZiAoIWUgfHwgIWUuYWN0aW9uKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgIC8vIFVwcGVyLWJvZHkgb25lLXNob3QgaGFuZGxpbmcKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fdXBwZXJMb2NrZWQgJiYgdGhpcy5hY3RpdmVVcHBlckFjdGlvbiAmJiBlLmFjdGlvbiA9PT0gdGhpcy5hY3RpdmVVcHBlckFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl91cHBlckxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl91cHBlckxvY2tlZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsgZS5hY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsgZS5hY3Rpb24uZmFkZU91dCgwLjA4KTsgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVVcHBlckFjdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChlLmFjdGlvbiAhPT0gdGhpcy5hY3RpdmVBY3Rpb24pIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvY2tlZFN0YXRlID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgLy8gVW5jbGFtcCBzbyBmdXR1cmUgcGxheXMgZG9uJ3QgZnJlZXplIG9uIGxhc3QgZnJhbWUuCiAgICAgICAgICAgICAgICAgICAgdHJ5IHsgZS5hY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsgfSBjYXRjaCAoXykge30KCiAgICAgICAgICAgICAgICAgICAgLy8gUmV0dXJuIHRvIGxvY29tb3Rpb24gdW5sZXNzIGFub3RoZXIgb3ZlcnJpZGUgaXMgYWN0aXZlLgogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMTUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9Cgp9CgpwbGF5KGFjdGlvbk5hbWUsIGR1cmF0aW9uID0gMC41KSB7CiAgICAgICAgICAgIGNvbnN0IG5ld0FjdGlvbiA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFuZXdBY3Rpb24gfHwgbmV3QWN0aW9uID09PSB0aGlzLmFjdGl2ZUFjdGlvbikgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZlQWN0aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUFjdGlvbi5mYWRlT3V0KGR1cmF0aW9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbmV3QWN0aW9uLnJlc2V0KCk7CiAgICAgICAgICAgIG5ld0FjdGlvbi5mYWRlSW4oZHVyYXRpb24pOwogICAgICAgICAgICBuZXdBY3Rpb24ucGxheSgpOwogICAgICAgICAgICB0aGlzLmFjdGl2ZUFjdGlvbiA9IG5ld0FjdGlvbjsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlTG9jb21vdGlvbkFuaW0oZHVyYXRpb24gPSAwLjIpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2xheWVyZWRFbmFibGVkKSB7IHRoaXMuX2xvY29tb3Rpb25GYWRlID0gZHVyYXRpb247IHJldHVybjsgfQoKICAgICAgICAgICAgaWYgKHRoaXMuX2FuaW1Mb2NrZWQpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHZ4ID0gdGhpcy52ZWxvY2l0eSA/IHRoaXMudmVsb2NpdHkueCA6IDA7CiAgICAgICAgICAgIGNvbnN0IHZ6ID0gdGhpcy52ZWxvY2l0eSA/IHRoaXMudmVsb2NpdHkueiA6IDA7CgogICAgICAgICAgICBjb25zdCBpbnB1dE1vdmluZyA9IHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wNTsKICAgICAgICAgICAgY29uc3QgdmVsTW92aW5nID0gKHZ4ICogdnggKyB2eiAqIHZ6KSA+IDAuMDI7CgogICAgICAgICAgICBjb25zdCBtb3ZpbmcgPSBpbnB1dE1vdmluZyB8fCB2ZWxNb3Zpbmc7CgogICAgICAgICAgICBsZXQgdGFyZ2V0ID0gbW92aW5nID8gJ3N3aW0nIDogJ2lkbGUnOwogICAgICAgICAgICBpZiAobW92aW5nICYmIHRoaXMuaXNEYXNoaW5nICYmIHRoaXMuYWN0aW9uc1snZGFzaCddKSB0YXJnZXQgPSAnZGFzaCc7CgogICAgICAgICAgICAvLyBPcHRpb25hbDogd2hpbGUgc3RhdGlvbmFyeSBhbmQgY2hhcmdpbmcsIHByZWZlciBhIGNoYXJnZS9haW0gbG9vcCBpZiBpdCBleGlzdHMuCiAgICAgICAgICAgIGlmICghbW92aW5nICYmIHRoaXMuaXNDaGFyZ2luZyAmJiB0aGlzLmFjdGlvbnNbJ2NoYXJnZSddKSB0YXJnZXQgPSAnY2hhcmdlJzsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSB0YXJnZXQpIHsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBsb29waW5nIGZvciBsb2NvbW90aW9uLXN0eWxlIGNsaXBzCiAgICAgICAgICAgICAgICBjb25zdCBhID0gdGhpcy5hY3Rpb25zW3RhcmdldF07CiAgICAgICAgICAgICAgICBpZiAoYSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7IGEuc2V0TG9vcChUSFJFRS5Mb29wUmVwZWF0KTsgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgICAgICAgICBhLmNsYW1wV2hlbkZpbmlzaGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnBsYXkodGFyZ2V0LCBkdXJhdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLl9sYXN0TG9jb21vdGlvbiA9IHRhcmdldDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcGxheU9uZVNob3QoYWN0aW9uTmFtZSwgZHVyYXRpb24gPSAwLjEsIG9wdHMgPSB7fSkgewogICAgICAgICAgICAvLyBJbiBsYXllcmVkIG1vZGUsIHJvdXRlIHRocm93cy9jYXRjaGVzIHRvIHRoZSB1cHBlci1ib2R5IGxheWVyIHNvIHBsYXllcnMgY2FuIGtlZXAgc3dpbW1pbmcuCiAgICAgICAgICAgIGlmICh0aGlzLl9sYXllcmVkRW5hYmxlZCkgewogICAgICAgICAgICAgICAgY29uc3QgdXBwZXJLZXlzID0gewogICAgICAgICAgICAgICAgICAgICd0aHJvdyc6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgJ3Rocm93X3Bhc3MnOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICd0aHJvd19zaG90JzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAnY2F0Y2gnOiB0cnVlCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaWYgKHVwcGVyS2V5c1thY3Rpb25OYW1lXSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wbGF5VXBwZXJPbmVTaG90KGFjdGlvbk5hbWUsIGR1cmF0aW9uLCBvcHRzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYSA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFhKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICAvLyBMb2NrIGxvY29tb3Rpb24gc28gaXQgZG9lc24ndCBzdG9tcCB0aGUgb25lLXNob3QuCiAgICAgICAgICAgIHRoaXMuX2FuaW1Mb2NrZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IGFjdGlvbk5hbWU7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgYS5yZXNldCgpOwogICAgICAgICAgICAgICAgYS5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgIGEuY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgYS50aW1lU2NhbGUgPSAob3B0cy50aW1lU2NhbGUgIT09IHVuZGVmaW5lZCA/IG9wdHMudGltZVNjYWxlIDogMS4wKTsKICAgICAgICAgICAgfSBjYXRjaCAoXykge30KCiAgICAgICAgICAgIHRoaXMucGxheShhY3Rpb25OYW1lLCBkdXJhdGlvbik7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBzZXRJbnB1dCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRlc2lyZWRJbnB1dFZlY3Rvci5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmRlc2lyZWRJbnB1dFZlY3Rvci5zZXQoeCwgMCwgeik7CiAgICAgICAgfQoKcmVjZWl2ZUJhbGwoKSB7CiAgICAgICAgICAgIHRoaXMuY2FuQ2F0Y2ggPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENSSVRJQ0FMIEZJWDogUmVzZXQgc3RhdGVzIHRoYXQgbWlnaHQgcHJldmVudCBzaG9vdGluZwogICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2hpZGVDaGFyZ2VVSSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLm5hcCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuaGFzQmFsbCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuaW1tdW5pdHlUaW1lciA9IDIuMDsKCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5sYXN0SG9sZGVyICYmIGJhbGwubGFzdEhvbGRlci50ZWFtID09PSB0aGlzLnRlYW0gJiYgYmFsbC5sYXN0SG9sZGVyICE9PSB0aGlzKSB7CiAgICAgICAgICAgICAgICBiYWxsLmxhc3RIb2xkZXIuZ2FpbkV4cCgyKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FpbkV4cCgxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYmFsbFkgPSAodGhpcy5iYWxsUmVmICYmIHRoaXMuYmFsbFJlZi5tZXNoKSA/IHRoaXMuYmFsbFJlZi5tZXNoLnBvc2l0aW9uLnkgOiAwOwogICAgICAgICAgICBjb25zdCBjYXRjaEtleSA9IChiYWxsWSA+IDAuMjUgJiYgdGhpcy5hY3Rpb25zWydjYXRjaF9qdW1wJ10pID8gJ2NhdGNoX2p1bXAnIDogJ2NhdGNoJzsKICAgICAgICAgICAgdGhpcy5wbGF5T25lU2hvdChjYXRjaEtleSwgMC4xKTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTTkFQISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWFjdGlvbiIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICAgICAgX2luaXRMYXllcmVkQW5pbWF0aW9uKCkgewogICAgICAgICAgICAvLyBCYXNlIGxheWVyOiBpZGxlL3N3aW0vZGFzaCBhcmUgYWx3YXlzIHBsYXlpbmcsIHdlIGp1c3QgYmxlbmQgd2VpZ2h0cy4KICAgICAgICAgICAgY29uc3QgZW5zdXJlTG9vcGluZyA9IChhKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWEpIHJldHVybjsKICAgICAgICAgICAgICAgIHRyeSB7IGEuc2V0TG9vcChUSFJFRS5Mb29wUmVwZWF0KTsgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgICAgIGEuY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGEuZW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBpZGxlID0gdGhpcy5hY3Rpb25zWydpZGxlJ10gfHwgbnVsbDsKICAgICAgICAgICAgY29uc3Qgc3dpbSA9IHRoaXMuYWN0aW9uc1snc3dpbSddIHx8IG51bGw7CiAgICAgICAgICAgIGNvbnN0IGRhc2ggPSB0aGlzLmFjdGlvbnNbJ2Rhc2gnXSB8fCBudWxsOwoKICAgICAgICAgICAgdGhpcy5iYXNlQWN0aW9ucy5pZGxlID0gaWRsZTsKICAgICAgICAgICAgdGhpcy5iYXNlQWN0aW9ucy5zd2ltID0gc3dpbTsKICAgICAgICAgICAgdGhpcy5iYXNlQWN0aW9ucy5kYXNoID0gZGFzaDsKCiAgICAgICAgICAgIC8vIFN0YXJ0IGJhc2UgYWN0aW9ucyBzbyB3ZSBjYW4gYmxlbmQgd2VpZ2h0cyB3aXRob3V0IHJlc3RhcnRpbmcgY2xpcHMgKHNtb290aGVyIG9uIG1vYmlsZSkuCiAgICAgICAgICAgIFtpZGxlLCBzd2ltLCBkYXNoXS5mb3JFYWNoKChhKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWEpIHJldHVybjsKICAgICAgICAgICAgICAgIGVuc3VyZUxvb3BpbmcoYSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGEucGxheSgpOwogICAgICAgICAgICAgICAgICAgIGEuc2V0RWZmZWN0aXZlV2VpZ2h0KDApOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBVcHBlci1ib2R5IGxheWVyOiBmaWx0ZXJlZCBjbGlwcyBmb3IgdGhyb3cvY2F0Y2gvY2hhcmdlIChvbmx5IHVwcGVyIGJvbmVzKS4KICAgICAgICAgICAgY29uc3QgdXBwZXJIaW50cyA9IFsnc3BpbmUnLCdjaGVzdCcsJ25lY2snLCdoZWFkJywnc2hvdWxkZXInLCdjbGF2aWNsZScsJ2FybScsJ2ZvcmVhcm0nLCdoYW5kJywnd3Jpc3QnLCd0aHVtYicsJ2ZpbmdlciddOwogICAgICAgICAgICBjb25zdCBpc1VwcGVyQm9uZU5hbWUgPSAoYm9uZU5hbWUpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IG4gPSAoYm9uZU5hbWUgfHwgJycpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGggb2YgdXBwZXJIaW50cykgaWYgKG4uaW5jbHVkZXMoaCkpIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgZmlsdGVyQ2xpcFRyYWNrcyA9IChjbGlwLCBwcmVkaWNhdGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghY2xpcCkgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICBjb25zdCB0cmFja3MgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdCBvZiAoY2xpcC50cmFja3MgfHwgW10pKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhY2tOYW1lID0gdC5uYW1lIHx8ICcnOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJvbmVOYW1lID0gdHJhY2tOYW1lLnNwbGl0KCcuJylbMF07CiAgICAgICAgICAgICAgICAgICAgaWYgKHByZWRpY2F0ZShib25lTmFtZSkpIHRyYWNrcy5wdXNoKHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCF0cmFja3MubGVuZ3RoKSByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIGNvbnN0IGZpbHRlcmVkID0gY2xpcC5jbG9uZSgpOwogICAgICAgICAgICAgICAgZmlsdGVyZWQudHJhY2tzID0gdHJhY2tzOwogICAgICAgICAgICAgICAgZmlsdGVyZWQubmFtZSA9IChjbGlwLm5hbWUgfHwgJ2NsaXAnKSArICJfVVBQRVIiOwogICAgICAgICAgICAgICAgcmV0dXJuIGZpbHRlcmVkOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgbWFrZVVwcGVyQWN0aW9uID0gKGtleSwgbG9vcE1vZGUpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGNsaXAgPSB0aGlzLmNsaXBzW2tleV07CiAgICAgICAgICAgICAgICBpZiAoIWNsaXApIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgY29uc3QgdXBwZXJDbGlwID0gZmlsdGVyQ2xpcFRyYWNrcyhjbGlwLCBpc1VwcGVyQm9uZU5hbWUpOwogICAgICAgICAgICAgICAgaWYgKCF1cHBlckNsaXApIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgY29uc3QgYSA9IHRoaXMubWl4ZXIuY2xpcEFjdGlvbih1cHBlckNsaXApOwogICAgICAgICAgICAgICAgYS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChsb29wTW9kZSA9PT0gJ2xvb3AnKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsgYS5zZXRMb29wKFRIUkVFLkxvb3BSZXBlYXQpOyB9IGNhdGNoIChfKSB7fQogICAgICAgICAgICAgICAgICAgIGEuY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsgYS5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgICAgICAgICBhLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgYS5zZXRFZmZlY3RpdmVXZWlnaHQoMCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxvb3BNb2RlID09PSAnbG9vcCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYS5wbGF5KCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYS5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgICAgIHRoaXMudXBwZXJBY3Rpb25zW2tleV0gPSBhOwogICAgICAgICAgICAgICAgcmV0dXJuIGE7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBQcmVmZXJyZWQgdXBwZXIgb3ZlcmxheSBjbGlwcyAoaWYgdGhleSBleGlzdCkKICAgICAgICAgICAgbWFrZVVwcGVyQWN0aW9uKCdjaGFyZ2UnLCAnbG9vcCcpOwogICAgICAgICAgICBtYWtlVXBwZXJBY3Rpb24oJ3Rocm93JywgJ29uY2UnKTsKICAgICAgICAgICAgbWFrZVVwcGVyQWN0aW9uKCd0aHJvd19wYXNzJywgJ29uY2UnKTsKICAgICAgICAgICAgbWFrZVVwcGVyQWN0aW9uKCd0aHJvd19zaG90JywgJ29uY2UnKTsKICAgICAgICAgICAgbWFrZVVwcGVyQWN0aW9uKCdjYXRjaCcsICdvbmNlJyk7CgogICAgICAgICAgICAvLyBTdGFydCB3aXRoIHNhbmUgZGVmYXVsdHMKICAgICAgICAgICAgdGhpcy5fYW5pbVNwZWVkU21vb3RoZWQgPSAwOwogICAgICAgICAgICB0aGlzLl9iYXNlU3VwcHJlc3Npb24gPSAwOwogICAgICAgIH0KCiAgICAgICAgX3BsYXlVcHBlck9uZVNob3QoYWN0aW9uTmFtZSwgZmFkZSA9IDAuMDgsIG9wdHMgPSB7fSkgewogICAgICAgICAgICBjb25zdCBhID0gdGhpcy51cHBlckFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgIGlmICghYSkgewogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gZnVsbC1ib2R5IG9uZS1zaG90IGlmIG5vIHVwcGVyIGNsaXAgZXhpc3RzLgogICAgICAgICAgICAgICAgY29uc3QgZmEgPSB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgICAgICBpZiAoIWZhKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IGFjdGlvbk5hbWU7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZlQWN0aW9uICYmIHRoaXMuYWN0aXZlQWN0aW9uICE9PSBmYSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7IHRoaXMuYWN0aXZlQWN0aW9uLmZhZGVPdXQoZmFkZSk7IH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBmYS5yZXNldCgpOwogICAgICAgICAgICAgICAgICAgIGZhLmVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGZhLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgIGZhLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBmYS5zZXRFZmZlY3RpdmVUaW1lU2NhbGUob3B0cy50aW1lU2NhbGUgIT09IHVuZGVmaW5lZCA/IG9wdHMudGltZVNjYWxlIDogMS4wKTsKICAgICAgICAgICAgICAgICAgICBmYS5zZXRFZmZlY3RpdmVXZWlnaHQoMS4wKTsKICAgICAgICAgICAgICAgICAgICBmYS5mYWRlSW4oZmFkZSk7CiAgICAgICAgICAgICAgICAgICAgZmEucGxheSgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoXykge30KCiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUFjdGlvbiA9IGZhOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGFjdGlvbk5hbWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3RvcCBhbnkgY3VycmVudCB1cHBlciBvbmUtc2hvdAogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVVcHBlckFjdGlvbiAmJiB0aGlzLmFjdGl2ZVVwcGVyQWN0aW9uICE9PSBhKSB7CiAgICAgICAgICAgICAgICB0cnkgeyB0aGlzLmFjdGl2ZVVwcGVyQWN0aW9uLmZhZGVPdXQoMC4wNik7IH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwcGVyTG9ja2VkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5fdXBwZXJMb2NrZWRTdGF0ZSA9IGFjdGlvbk5hbWU7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlVXBwZXJBY3Rpb24gPSBhOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGEucmVzZXQoKTsKICAgICAgICAgICAgICAgIGEuZW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBhLnNldEVmZmVjdGl2ZVRpbWVTY2FsZShvcHRzLnRpbWVTY2FsZSAhPT0gdW5kZWZpbmVkID8gb3B0cy50aW1lU2NhbGUgOiAxLjApOwogICAgICAgICAgICAgICAgYS5zZXRFZmZlY3RpdmVXZWlnaHQoMS4wKTsKICAgICAgICAgICAgICAgIGEuc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICBhLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGEuZmFkZUluKGZhZGUpOwogICAgICAgICAgICAgICAgYS5wbGF5KCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKF8pIHt9CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIF9zZXRXZWlnaHQoYWN0aW9uLCB0YXJnZXQsIGxlcnBBbHBoYSkgewogICAgICAgICAgICBpZiAoIWFjdGlvbikgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBjdXIgPSAoYWN0aW9uLmdldEVmZmVjdGl2ZVdlaWdodCA/IGFjdGlvbi5nZXRFZmZlY3RpdmVXZWlnaHQoKSA6IDApIHx8IDA7CiAgICAgICAgICAgIGNvbnN0IG5leHQgPSBjdXIgKyAodGFyZ2V0IC0gY3VyKSAqIGxlcnBBbHBoYTsKICAgICAgICAgICAgdHJ5IHsgYWN0aW9uLnNldEVmZmVjdGl2ZVdlaWdodChuZXh0KTsgfSBjYXRjaCAoXykge30KICAgICAgICB9CgogICAgICAgIF91cGRhdGVMYXllcmVkQW5pbWF0aW9uKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5taXhlcikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gU21vb3RoIHNwZWVkIChoZWxwcyBvbiBtb2JpbGUgaml0dGVyKQogICAgICAgICAgICBjb25zdCB2eCA9IHRoaXMudmVsb2NpdHkgPyB0aGlzLnZlbG9jaXR5LnggOiAwOwogICAgICAgICAgICBjb25zdCB2eiA9IHRoaXMudmVsb2NpdHkgPyB0aGlzLnZlbG9jaXR5LnogOiAwOwogICAgICAgICAgICBjb25zdCBzcGVlZCA9IE1hdGguc3FydCh2eCAqIHZ4ICsgdnogKiB2eik7CiAgICAgICAgICAgIHRoaXMuX2FuaW1TcGVlZFNtb290aGVkICs9IChzcGVlZCAtIHRoaXMuX2FuaW1TcGVlZFNtb290aGVkKSAqIE1hdGgubWluKDEsIGR0ICogMTAuMCk7CgogICAgICAgICAgICAvLyBCYXNlIHN1cHByZXNzaW9uIGR1cmluZyBmdWxsLWJvZHkgb25lLXNob3RzCiAgICAgICAgICAgIGNvbnN0IHdhbnRTdXBwID0gdGhpcy5fYW5pbUxvY2tlZCA/IDEuMCA6IDAuMDsKICAgICAgICAgICAgdGhpcy5fYmFzZVN1cHByZXNzaW9uICs9ICh3YW50U3VwcCAtIHRoaXMuX2Jhc2VTdXBwcmVzc2lvbikgKiBNYXRoLm1pbigxLCBkdCAqIDE0LjApOwogICAgICAgICAgICBjb25zdCBiYXNlTXVsID0gMS4wIC0gdGhpcy5fYmFzZVN1cHByZXNzaW9uOwoKICAgICAgICAgICAgY29uc3QgZmFkZSA9ICh0aGlzLl9sb2NvbW90aW9uRmFkZSB8fCAwLjIpOwogICAgICAgICAgICBjb25zdCBsZXJwQWxwaGEgPSBNYXRoLm1pbigxLCBkdCAvIE1hdGgubWF4KDAuMDAwMSwgZmFkZSkpOwoKICAgICAgICAgICAgLy8gQmxlbmQgaWRsZSA8LT4gc3dpbSB1c2luZyBhIHNvZnQgdGhyZXNob2xkICsgaHlzdGVyZXNpcwogICAgICAgICAgICBjb25zdCBpbk1vdmUgPSAodGhpcy5pbnB1dFZlY3RvciAmJiB0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwLjA1KTsKICAgICAgICAgICAgY29uc3QgbW92aW5nID0gaW5Nb3ZlIHx8IHRoaXMuX2FuaW1TcGVlZFNtb290aGVkID4gMC4wODsKCiAgICAgICAgICAgIC8vIFNtb290aCBzd2ltIGJsZW5kCiAgICAgICAgICAgIGNvbnN0IHN3aW1CbGVuZCA9IG1vdmluZyA/IE1hdGgubWluKDEsIE1hdGgubWF4KDAsICh0aGlzLl9hbmltU3BlZWRTbW9vdGhlZCAtIDAuMDUpIC8gMC40NSkpIDogMDsKICAgICAgICAgICAgY29uc3QgZGFzaEJsZW5kID0gKHRoaXMuaXNEYXNoaW5nICYmIHRoaXMuYmFzZUFjdGlvbnMuZGFzaCkgPyAxIDogMDsKCiAgICAgICAgICAgIGNvbnN0IGlkbGVXID0gKDEgLSBzd2ltQmxlbmQpICogKDEgLSBkYXNoQmxlbmQpICogYmFzZU11bDsKICAgICAgICAgICAgY29uc3Qgc3dpbVcgPSAoc3dpbUJsZW5kKSAqICgxIC0gZGFzaEJsZW5kKSAqIGJhc2VNdWw7CiAgICAgICAgICAgIGNvbnN0IGRhc2hXID0gKGRhc2hCbGVuZCkgKiBiYXNlTXVsOwoKICAgICAgICAgICAgdGhpcy5fc2V0V2VpZ2h0KHRoaXMuYmFzZUFjdGlvbnMuaWRsZSwgaWRsZVcsIGxlcnBBbHBoYSk7CiAgICAgICAgICAgIHRoaXMuX3NldFdlaWdodCh0aGlzLmJhc2VBY3Rpb25zLnN3aW0sIHN3aW1XLCBsZXJwQWxwaGEpOwogICAgICAgICAgICB0aGlzLl9zZXRXZWlnaHQodGhpcy5iYXNlQWN0aW9ucy5kYXNoLCBkYXNoVywgbGVycEFscGhhKTsKCiAgICAgICAgICAgIC8vIFRpbWUtc2NhbGUgbG9jb21vdGlvbiBzbyBpdCBtYXRjaGVzIGFjdHVhbCBtb3Rpb24KICAgICAgICAgICAgaWYgKHRoaXMuYmFzZUFjdGlvbnMuc3dpbSkgewogICAgICAgICAgICAgICAgY29uc3QgdHMgPSAwLjc1ICsgTWF0aC5taW4oMS41LCB0aGlzLl9hbmltU3BlZWRTbW9vdGhlZCAqIDEuMik7CiAgICAgICAgICAgICAgICB0cnkgeyB0aGlzLmJhc2VBY3Rpb25zLnN3aW0uc2V0RWZmZWN0aXZlVGltZVNjYWxlKHRzKTsgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5iYXNlQWN0aW9ucy5kYXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0cyA9IDEuMSArIE1hdGgubWluKDEuMiwgdGhpcy5fYW5pbVNwZWVkU21vb3RoZWQgKiAwLjgpOwogICAgICAgICAgICAgICAgdHJ5IHsgdGhpcy5iYXNlQWN0aW9ucy5kYXNoLnNldEVmZmVjdGl2ZVRpbWVTY2FsZSh0cyk7IH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuYmFzZUFjdGlvbnMuaWRsZSkgewogICAgICAgICAgICAgICAgdHJ5IHsgdGhpcy5iYXNlQWN0aW9ucy5pZGxlLnNldEVmZmVjdGl2ZVRpbWVTY2FsZSgxLjApOyB9IGNhdGNoIChfKSB7fQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcHBlci1ib2R5IG92ZXJsYXkgKGFpbS9jaGFyZ2UgbG9vcCkgd2hlbiBob2xkaW5nIGJhbGwuCiAgICAgICAgICAgIGNvbnN0IGNoYXJnZUEgPSB0aGlzLnVwcGVyQWN0aW9uc1snY2hhcmdlJ10gfHwgbnVsbDsKICAgICAgICAgICAgY29uc3Qgd2FudHNDaGFyZ2UgPSAoIXRoaXMuX3VwcGVyTG9ja2VkKSAmJiBjaGFyZ2VBICYmIHRoaXMuaGFzQmFsbCAmJiAodGhpcy5pc0NoYXJnaW5nIHx8IHRoaXMuY2hhcmdlVGltZSA+IDAuMDUpOwogICAgICAgICAgICBjb25zdCBjaGFyZ2VUYXJnZXRXID0gd2FudHNDaGFyZ2UgPyAxLjAgOiAwLjA7CiAgICAgICAgICAgIHRoaXMuX3NldFdlaWdodChjaGFyZ2VBLCBjaGFyZ2VUYXJnZXRXLCBsZXJwQWxwaGEpOwoKICAgICAgICAgICAgaWYgKGNoYXJnZUEgJiYgd2FudHNDaGFyZ2UpIHsKICAgICAgICAgICAgICAgIHRyeSB7IGNoYXJnZUEuc2V0RWZmZWN0aXZlVGltZVNjYWxlKDEuMCk7IH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElmIGZ1bGwtYm9keSBvbmUtc2hvdCBpcyBhY3RpdmUsIGFsc28gZGFtcCB1cHBlciBvdmVybGF5IHNvIGl0IGRvZXNuJ3QgZmlnaHQuCiAgICAgICAgICAgIGlmICh0aGlzLl9hbmltTG9ja2VkICYmIGNoYXJnZUEpIHsKICAgICAgICAgICAgICAgIHRyeSB7IGNoYXJnZUEuc2V0RWZmZWN0aXZlV2VpZ2h0KDApOyB9IGNhdGNoIChfKSB7fQogICAgICAgICAgICB9CiAgICAgICAgfQoKCnRocm93QmFsbChiYWxsLCBmb3JjZWRUeXBlID0gbnVsbCwgcG93ZXJNdWx0aXBsaWVyID0gMS4wLCBmb3JjZWRTcGluID0gbnVsbCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaGFzQmFsbCB8fCB0aGlzLmlzVGhyb3dpbmcpIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKCiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IHRydWU7CgogICAgICAgICAgICAvLyBMb2NrIGFpbSBkaXJlY3Rpb24gYXQgc3RhcnQgb2YgdGhyb3cKICAgICAgICAgICAgdGhpcy5sb2NrZWRBaW1WZWN0b3IgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKSA+IDAuMSkgewogICAgICAgICAgICAgICAgdGhpcy5sb2NrZWRBaW1WZWN0b3IuY29weSh0aGlzLmlucHV0VmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMubG9ja2VkQWltVmVjdG9yLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9Cgpjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLTQ2IDogNDY7CiAgICAgICAgICAgIGNvbnN0IGRpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKCiAgICAgICAgICAgIGxldCB0eXBlID0gZm9yY2VkVHlwZTsKICAgICAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICAgICAgICB0eXBlID0gKGRpc3RUb0dvYWwgPCAyNSkgPyAnU0gnIDogJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgaXNGaW5pc2hlciA9ICh0eXBlID09PSAnU0gnICYmIGRpc3RUb0dvYWwgPCAxMi4wKTsKCiAgICAgICAgICAgIGxldCB0ZWNoTmFtZSA9ICh0eXBlID09PSAnU0gnKSA/IHRoaXMudGVjaHMuc2hvb3QgOiB0aGlzLnRlY2hzLnBhc3M7CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMudmVub20gPiAwICYmIHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTSUxFTkNFRCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInN0YXR1cyIpOwogICAgICAgICAgICAgICAgdGVjaE5hbWUgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgd2luZHVwVGltZSA9IDEwMDsKICAgICAgICAgICAgbGV0IGFuaW1TcGVlZCA9IDEuNTsKCiAgICAgICAgICAgIGlmIChwb3dlck11bHRpcGxpZXIgPiAxLjEpIHsKICAgICAgICAgICAgICAgIHdpbmR1cFRpbWUgKz0gMjAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNGaW5pc2hlciAmJiAhdGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIHdpbmR1cFRpbWUgPSA1MDsKICAgICAgICAgICAgICAgIGFuaW1TcGVlZCA9IDMuMDsKICAgICAgICAgICAgfQoKaWYgKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICB3aW5kdXBUaW1lID0gNDAwOwogICAgICAgICAgICAgICAgYW5pbVNwZWVkID0gMC44OwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLnBsYXlDaW5lbWF0aWModGVjaE5hbWUsIHRoaXMubWVzaCwgMS4yKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLmltbXVuaXR5VGltZXIgPSAxLjU7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IHRlY2hOYW1lLnJlcGxhY2UoJ18nLCAnICcpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihsYWJlbCwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE5FVzogU3Bhd24gVGVjaCBHbHlwaCAoVmVydGljYWwgQ2FzdGluZyBDaXJjbGUpCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmdseXBoTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ3RlY2gnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50OiB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAxLjIsCiAgICAgICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IDQuMCwKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGVTcGVlZDogMS41LAogICAgICAgICAgICAgICAgICAgICAgICBvZmZzZXRZOiAxLjIsCiAgICAgICAgICAgICAgICAgICAgICAgIGZhY2VDYW1lcmE6IHRydWUKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUGljayBiZXN0IHRocm93IGNsaXAgKHBhc3Mvc2hvdCB2YXJpYW50cyBpZiBwcmVzZW50KQogICAgICAgICAgICBjb25zdCB0aHJvd0tleSA9CiAgICAgICAgICAgICAgICAodHlwZSA9PT0gJ1NIJyAmJiB0aGlzLmFjdGlvbnNbJ3Rocm93X3Nob3QnXSkgPyAndGhyb3dfc2hvdCcgOgogICAgICAgICAgICAgICAgKHR5cGUgPT09ICdQQScgJiYgdGhpcy5hY3Rpb25zWyd0aHJvd19wYXNzJ10pID8gJ3Rocm93X3Bhc3MnIDoKICAgICAgICAgICAgICAgICd0aHJvdyc7CgogICAgICAgICAgICB0aGlzLnBsYXlPbmVTaG90KHRocm93S2V5LCAwLjEsIHsgdGltZVNjYWxlOiBhbmltU3BlZWQgfSk7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCAmJiAhdGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIldIT09TSCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWFjdGlvbiIpOwogICAgICAgICAgICB9CgpzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIC8vIFNhZmV0eTogSWYgYmFsbCBob2xkZXIgaXMgc3RpbGwgdXMsIHByb2NlZWQuIElmIGhhc0JhbGwgaXMgZmFsc2UgYnV0IGhvbGRlciBpcyB1cywgYXNzdW1lIHN5bmMgbGFnIGFuZCBwcm9jZWVkLgogICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCB8fCAoYmFsbCAmJiBiYWxsLmhvbGRlciA9PT0gdGhpcykpIHsKY29uc3QgdGhyb3dBY3Rpb24gPSB0aGlzLmFjdGlvbnNbdGhyb3dLZXldOwogICAgICAgICAgICAgICAgICAgIGlmICh0aHJvd0FjdGlvbikgdGhyb3dBY3Rpb24udGltZVNjYWxlID0gMS4wOwoKICAgICAgICAgICAgICAgICAgICBsZXQgZmluYWxEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgICAgIGxldCByZWZlcmVuY2VEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKaWYgKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIuY29weSh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlRGlyLmNvcHkoZmluYWxEaXIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUkVNT1ZFRDogSW5zdGFudCByb3RhdGlvbiBzbmFwLiAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhlIHVwZGF0ZSBsb29wIGhhbmRsZXMgc21vb3RoIHJvdGF0aW9uIHZpYSB0YXJnZXRZYXcuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgcHJldmVudHMgdGhlICJmbGlwcGluZyBhcm91bmQiIHZpc3VhbCBnbGl0Y2guCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIuY29weSh0aGlzLmxvY2tlZEFpbVZlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZURpci5jb3B5KHRoaXMubG9ja2VkQWltVmVjdG9yKTsKICAgICAgICAgICAgICAgICAgICB9Cgpjb25zdCBzcGluID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAgICAgICAgIGlmIChmb3JjZWRTcGluKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNwaW4uY29weShmb3JjZWRTcGluKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnB1dERpciA9IHRoaXMuaW5wdXRWZWN0b3IuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY3Jvc3NZID0gbmV3IFRIUkVFLlZlY3RvcjMoKS5jcm9zc1ZlY3RvcnMocmVmZXJlbmNlRGlyLCBpbnB1dERpcikueTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhjcm9zc1kpID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGluLnNldCgwLCBjcm9zc1kgKiAxMi4wLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGV0IGJhc2VDb3N0ID0gKHR5cGUgPT09ICdTSCcpID8gMjAgOiAxMDsKICAgICAgICAgICAgICAgICAgICBsZXQgdGVjaENvc3QgPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoQm9udXMgPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoUGF5bG9hZCA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd2ZW5vbSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDIwIDogMTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICd2ZW5vbScsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd3aXRoZXInOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gKHR5cGUgPT09ICdTSCcgPyAyMCA6IDEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnd2l0aGVyJywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ25hcCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDM1IDogMzApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICduYXAnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3BoZXJlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9IDI1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBybmcgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxMSkgKyA1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSBybmc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnc3BoZXJlJywgbGV2ZWw6IDEsIGJvbnVzOiBybmcgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGBTUEhFUkUgKyR7cm5nfWAsIHRoaXMubWVzaC5wb3NpdGlvbiwgImdvYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdqZWNodCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSA0MDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdqZWNodCcsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BlcmZvcm1KZWNodEtub2NrYmFjaygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2ludmlzaWJsZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAyNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdpbnZpc2libGUnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdG90YWxDb3N0ID0gYmFzZUNvc3QgKyB0ZWNoQ29zdDsKCiAgICAgICAgICAgICAgICAgICAgbGV0IHBvd2VyRmFjdG9yID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQIDwgdG90YWxDb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvd2VyRmFjdG9yID0gMC41OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlRJUkVEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSB0b3RhbENvc3Q7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdFZhbCA9IHRoaXMuZ2V0U3RhdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICs9IHRlY2hCb251czsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IHBvd2VyRmFjdG9yOwogICAgICAgICAgICAgICAgICAgIHN0YXRWYWwgKj0gcG93ZXJNdWx0aXBsaWVyOwoKY29uc3QgZ29hbFogPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC00NiA6IDQ2OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCBnb2FsWiAtIHRoaXMubWVzaC5wb3NpdGlvbi56KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnb2FsRG90ID0gZmluYWxEaXIuZG90KGdvYWxEaXIpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBnb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMiwgZ29hbFopOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0b0dvYWwgPSBnb2FsUG9zLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzaCA9IHRoaXMuZ2V0U3RhdCgnU0gnKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2V0dGluZ3MyID0gKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPKSA/IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPLnNldHRpbmdzIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgQUMyID0gd2luZG93LmZsdXguQXNzaXN0Q29uZmlnIHx8IHt9OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzaG90QXNzaXN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgKHNldHRpbmdzMiAmJiB0eXBlb2Ygc2V0dGluZ3MyLnNob3RBaW1Bc3Npc3QgPT09ICdudW1iZXInKSA/IHNldHRpbmdzMi5zaG90QWltQXNzaXN0IDogKEFDMi5TSE9UX0FJTV9BU1NJU1QgIT09IHVuZGVmaW5lZCA/IEFDMi5TSE9UX0FJTV9BU1NJU1QgOiAwLjM1KSkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjb25lRGVnID0gKEFDMi5TSE9UX0NPTkVfREVHICE9PSB1bmRlZmluZWQgPyBBQzIuU0hPVF9DT05FX0RFRyA6IDM1KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWluRG90ID0gTWF0aC5jb3MoY29uZURlZyAqIE1hdGguUEkgLyAxODApOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQmxlbmQgYW1vdW50OiBzdGF0cyAqIHVzZXIgYXNzaXN0IChrZXB0IG1vZGVzdCBzbyBpdCdzIG5vdCAiYmFieSIgZWFzeSkuCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBzaG90QXNzaXN0ICogTWF0aC5taW4oMC45LCBNYXRoLm1heCgwLjA4LCBzaCAvIDEwMC4wKSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBwbGF5ZXIgZXhwbGljaXRseSBhaW1lZCwgcmVkdWNlIGhlbHAgYnV0IGtlZXAgc29tZSB0byBwcmVzZXJ2ZSBmbG93LgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzaXN0RmFjdG9yICo9IDAuNTU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnb2FsRG90ID4gbWluRG90KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgKGdvYWxEb3QgLSBtaW5Eb3QpIC8gKDEuMCAtIG1pbkRvdCkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHcgPSB1ICogdSAqICgzIC0gMiAqIHUpOyAvLyBzbW9vdGhzdGVwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5sZXJwKHRvR29hbCwgYXNzaXN0RmFjdG9yICogdyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0ZpbmlzaGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMDU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNMQU0hIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9Cn0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMjIgKyAoMC4xMCAqIHNob3RBc3Npc3QpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAovLyBHb2FsaWUgTG9mdCBCb251cyAoUHJldmVudCBpbnRlcmNlcHRpb24gYnkgaW1tZWRpYXRlIGRlZmVuZGVyKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yb2xlID09PSAnR0wnKSBmaW5hbERpci55ICs9IDAuODsgLy8gSGlnaCBsb2Z0IGZvciBjbGVhcmFuY2UKCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5fZmluZFBhc3NUYXJnZXRJbkNvbmUoZmluYWxEaXIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0b01hdGUgPSB0YXJnZXQubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIExlYWQgdGhlIHJlY2VpdmVyIHNsaWdodGx5IChzY2FsZXMgd2l0aCBkaXN0YW5jZSwgY2FwcGVkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2V0dGluZ3MyID0gKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPKSA/IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPLnNldHRpbmdzIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IEFDMiA9IHdpbmRvdy5mbHV4LkFzc2lzdENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlYWRUQmFzZSA9IChBQzIuUEFTU19MRUFEX1RJTUUgIT09IHVuZGVmaW5lZCA/IEFDMi5QQVNTX0xFQURfVElNRSA6IDAuMjIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGVhZFQgPSBsZWFkVEJhc2UgKyBNYXRoLm1pbigwLjIwLCBkaXN0ICogMC4wMDcpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQudmVsb2NpdHkgJiYgdGFyZ2V0LnZlbG9jaXR5Lmxlbmd0aFNxICYmIHRhcmdldC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMC4wMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvTWF0ZS5hZGRTY2FsZWRWZWN0b3IodGFyZ2V0LnZlbG9jaXR5LCBsZWFkVCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b01hdGUubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGEgPSB0aGlzLmdldFN0YXQoJ1BBJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXNzQXNzaXN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgKHNldHRpbmdzMiAmJiB0eXBlb2Ygc2V0dGluZ3MyLnBhc3NBaW1Bc3Npc3QgPT09ICdudW1iZXInKSA/IHNldHRpbmdzMi5wYXNzQWltQXNzaXN0IDogKEFDMi5QQVNTX0FJTV9BU1NJU1QgIT09IHVuZGVmaW5lZCA/IEFDMi5QQVNTX0FJTV9BU1NJU1QgOiAwLjY1KSkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbmVEZWcgPSAoQUMyLlBBU1NfQ09ORV9ERUcgIT09IHVuZGVmaW5lZCA/IEFDMi5QQVNTX0NPTkVfREVHIDogNjApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWluRG90ID0gTWF0aC5jb3MoY29uZURlZyAqIE1hdGguUEkgLyAxODApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZG90TWF0ZSA9IE1hdGgubWF4KC0xLCBNYXRoLm1pbigxLCBmaW5hbERpci5kb3QodG9NYXRlKSkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBwYXNzQXNzaXN0ICogTWF0aC5taW4oMS4wLCAwLjM1ICsgKHBhIC8gODAuMCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHBsYXllciBleHBsaWNpdGx5IGFpbWVkLCByZWR1Y2UgaGVscCBidXQga2VlcCBzb21lIHRvIHByZXNlcnZlIGZsb3cuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lzdEZhY3RvciAqPSAwLjU1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb3RNYXRlID4gbWluRG90KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIChkb3RNYXRlIC0gbWluRG90KSAvICgxLjAgLSBtaW5Eb3QpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdyA9IHUgKiB1ICogKDMgLSAyICogdSk7IC8vIHNtb290aHN0ZXAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5sZXJwKHRvTWF0ZSwgYXNzaXN0RmFjdG9yICogdyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gTG9mdDogc2NhbGVzIHdpdGggZGlzdGFuY2UgKGhlbHBzIHRoZSByZWNlaXZlciByZWFkIGl0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIueSArPSBNYXRoLm1pbigwLjYsIGRpc3QgKiAwLjAzKSArICgwLjA1ICogcGFzc0Fzc2lzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR29hbGllIExvZnQgQm9udXMgZm9yIFBhc3NpbmcKLy8gR29hbGllIExvZnQgQm9udXMgZm9yIFBhc3NpbmcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgZmluYWxEaXIueSArPSAwLjg7IC8vIEhpZ2ggbG9mdCBmb3IgY2xlYXJhbmNlCiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRlY2hQYXlsb2FkICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCh0aGlzLCB0ZWNoTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKYmFsbC5zaG9vdChmaW5hbERpciwgc3RhdFZhbCwgdHlwZSwgdGVjaFBheWxvYWQsIHNwaW4pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEV4dHJhIGdyYWNlIHBlcmlvZCBmb3IgR29hbGllIHRvIHByZXZlbnQgcG9pbnQtYmxhbmsgaW50ZXJjZXB0aW9ucwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJvbGUgPT09ICdHTCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYmFsbC5jYXRjaEdyYWNlUGVyaW9kID0gMC42OyAvLyAwLjZzIGltbXVuaXR5IChhcHByb3ggMTAtMTJtIHRyYXZlbCkKICAgICAgICAgICAgICAgICAgICB9Cgp0aGlzLmxvc2VCYWxsKCk7Cgp0aGlzLmNhdGNoQ29vbGRvd24gPSAxLjA7IC8vIDFzIGNvb2xkb3duCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW5DYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB3aW5kdXBUaW1lKTsKCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CiAgICAgICAgICAgIH0sIHdpbmR1cFRpbWUgKyA1MDApOwogICAgICAgIH0KCiAgICAgICAgX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGFpbURpcikgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSkgcmV0dXJuIG51bGw7CgogICAgICAgICAgICBjb25zdCBzZXR0aW5ncyA9ICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTykgPyB3aW5kb3cuZmx1eC5fZGVidWdJTy5zZXR0aW5ncyA6IG51bGw7CiAgICAgICAgICAgIGNvbnN0IEFDID0gd2luZG93LmZsdXguQXNzaXN0Q29uZmlnIHx8IHt9OwogICAgICAgICAgICBjb25zdCBwYXNzQXNzaXN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgKHNldHRpbmdzICYmIHR5cGVvZiBzZXR0aW5ncy5wYXNzQWltQXNzaXN0ID09PSAnbnVtYmVyJykgPyBzZXR0aW5ncy5wYXNzQWltQXNzaXN0IDogKEFDLlBBU1NfQUlNX0FTU0lTVCAhPT0gdW5kZWZpbmVkID8gQUMuUEFTU19BSU1fQVNTSVNUIDogMC42NSkpKTsKCiAgICAgICAgICAgIC8vIFdpZGVyIGludGVudCBjb25lIGFzIGFzc2lzdCBpbmNyZWFzZXMgKHN0aWxsIHJlcXVpcmVzIHBvaW50aW5nIGdlbmVyYWxseSBhdCB0aGUgdGVhbW1hdGUpCiAgICAgICAgICAgIGNvbnN0IGNvbmVEZWcgPSAoQUMuUEFTU19DT05FX0RFRyAhPT0gdW5kZWZpbmVkID8gQUMuUEFTU19DT05FX0RFRyA6IDYwKTsKICAgICAgICAgICAgY29uc3QgY29uZU1pbkRvdCA9IE1hdGguY29zKGNvbmVEZWcgKiBNYXRoLlBJIC8gMTgwKTsKICAgICAgICAgICAgY29uc3QgbWluRG90ID0gKDAuNzUgKiAoMS4wIC0gcGFzc0Fzc2lzdCkpICsgKGNvbmVNaW5Eb3QgKiBwYXNzQXNzaXN0KTsKCiAgICAgICAgICAgIGxldCBiZXN0VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IGJlc3RTY29yZSA9IC1JbmZpbml0eTsKCiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtNDYgOiA0NjsKICAgICAgICAgICAgY29uc3QgZm9yd2FyZFNpZ24gPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKCiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKG1hdGUgPT09IHRoaXMgfHwgIW1hdGUubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAobWF0ZS5zdGF0dXMgJiYgbWF0ZS5zdGF0dXMubmFwID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAobWF0ZS5zdHVuVGltZXIgJiYgbWF0ZS5zdHVuVGltZXIgPiAwLjIpIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIGNvbnN0IHRvTWF0ZSA9IG1hdGUubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRvTWF0ZS5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgMC4wMDEpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgdG9NYXRlLm11bHRpcGx5U2NhbGFyKDEuMCAvIGRpc3QpOwoKICAgICAgICAgICAgICAgIGNvbnN0IGRvdCA9IGFpbURpci5kb3QodG9NYXRlKTsKICAgICAgICAgICAgICAgIGlmIChkb3QgPCBtaW5Eb3QpIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIC8vIFByZWZlcjogc3Ryb25nIGFsaWdubWVudCwgcmVhc29uYWJsZSBkaXN0YW5jZSwgZm9yd2FyZCBwcm9ncmVzcy4KICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RTY29yZSA9IDEuMCAtIE1hdGgubWluKDEuMCwgZGlzdCAvIDMwLjApOwogICAgICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBmb3J3YXJkU2lnbiAqIChtYXRlLm1lc2gucG9zaXRpb24ueiAtIHRoaXMubWVzaC5wb3NpdGlvbi56KTsKICAgICAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzU2NvcmUgPSBNYXRoLm1heCgtMS4wLCBNYXRoLm1pbigxLjAsIHByb2dyZXNzIC8gMTguMCkpOwoKICAgICAgICAgICAgICAgIC8vIFNsaWdodCBiaWFzIHRvd2FyZCBtYXRlcyBjbG9zZXIgdG8gb3Bwb25lbnQgZ29hbCAoZmVlbHMgbW9yZSAic3BvcnR5IiAvIGF0dGFja2luZykKICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxQcm94ID0gMS4wIC0gTWF0aC5taW4oMS4wLCBNYXRoLmFicyhtYXRlLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKSAvIDYwLjApOwoKICAgICAgICAgICAgICAgIGxldCBzY29yZSA9IChkb3QgKiAzLjApICsgKGRpc3RTY29yZSAqIDEuMikgKyAocHJvZ3Jlc3NTY29yZSAqIDAuOCkgKyAoZ29hbFByb3ggKiAwLjQpOwoKICAgICAgICAgICAgICAgIGlmIChzY29yZSA+IGJlc3RTY29yZSkgewogICAgICAgICAgICAgICAgICAgIGJlc3RTY29yZSA9IHNjb3JlOwogICAgICAgICAgICAgICAgICAgIGJlc3RUYXJnZXQgPSBtYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gYmVzdFRhcmdldDsKICAgICAgICB9CgpzdGFydENoYXJnZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgfHwgdGhpcy5pc1Rocm93aW5nIHx8IHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jaGFyZ2VUaW1lID0gMDsKCi8vIFZpc3VhbHMgaGFuZGxlZCBpbiB1cGRhdGUKCiAgICAgICAgICAgIC8vIFNob3cgY2hhcmdlIFVJCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUNoYXJnZVVJKDApOwoKICAgICAgICAgICAgLy8gTkVXOiBTcGF3biBDaGFyZ2UgR2x5cGggKEdyb3VuZCBSaW5nKQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ2NoYXJnZScsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICBsaWZlOiB0aGlzLm1heENoYXJnZVRpbWUsCiAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogMy4wLAogICAgICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IDAuMiwKICAgICAgICAgICAgICAgICAgICBvZmZzZXRZOiAwLjEKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKcmVsZWFzZUNoYXJnZShkeCwgZHksIGN1cnZlSW5wdXQgPSBudWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc0NoYXJnaW5nKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUG93ZXIgQ2FsY3VsYXRpb24KICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1pbih0aGlzLmNoYXJnZVRpbWUgLyB0aGlzLm1heENoYXJnZVRpbWUsIDEuMCk7CiAgICAgICAgICAgIGNvbnN0IFRDID0gd2luZG93LmZsdXguVGhyb3dDb25maWcgfHwge307CgogICAgICAgICAgICAvLyBCYXNlIG11bHRpcGxpZXIgKGRlZmF1bHRzOiAxLjAgdG8gMS44KQogICAgICAgICAgICBsZXQgbXVsdGlwbGllciA9IChUQy5QT1dFUl9CQVNFICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9CQVNFIDogMS4wKSArIChyYXRpbyAqIChUQy5QT1dFUl9SQU5HRSAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfUkFOR0UgOiAwLjgpKTsvLyBNQVggUE9XRVIgQk9OVVM6IElmIGhlbGQgbmVhciBtYXgsIHNpZ25pZmljYW50IGJvb3N0CiAgICAgICAgICAgIGlmIChyYXRpbyA+IChUQy5QT1dFUl9NQVhfQk9OVVNfUkFUSU8gIT09IHVuZGVmaW5lZCA/IFRDLlBPV0VSX01BWF9CT05VU19SQVRJTyA6IDAuOTUpKSB7CiAgICAgICAgICAgICAgICBtdWx0aXBsaWVyID0gKFRDLlBPV0VSX01BWF9NVUxUSVBMSUVSICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9NQVhfTVVMVElQTElFUiA6IDIuNSk7IC8vIENyaXRpY2FsIFBvd2VyCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIk1BWCBQT1dFUiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZEZvdkltcHVsc2UoLTEwKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKCiAgICAgICAgICAgIC8vIEFpbSBWZWN0b3IgQ2FsY3VsYXRpb24KICAgICAgICAgICAgbGV0IGFpbVZlYyA9IG51bGw7CiAgICAgICAgICAgIGNvbnN0IHN3aXBlTGVuID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwoKICAgICAgICAgICAgaWYgKHN3aXBlTGVuID4gKFRDLlNXSVBFX01JTl9QWCAhPT0gdW5kZWZpbmVkID8gVEMuU1dJUEVfTUlOX1BYIDogMjApKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjYW1lcmEgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhOwogICAgICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgICAgICBpZiAoY2FtZXJhKSB7CiAgICAgICAgICAgICAgICAgICAgY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKGZ3ZCk7CiAgICAgICAgICAgICAgICAgICAgZndkLnkgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmIChmd2QubGVuZ3RoU3EoKSA8IDAuMDAxKSBmd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGZ3ZC5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgcmlnaHQuY3Jvc3NWZWN0b3JzKGZ3ZCwgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCkpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICAgICAgd29ybGRWZWMuYWRkU2NhbGVkVmVjdG9yKHJpZ2h0LCBkeCAqIChUQy5BSU1fRFhfU0NBTEUgIT09IHVuZGVmaW5lZCA/IFRDLkFJTV9EWF9TQ0FMRSA6IDEuMCkpOwogICAgICAgICAgICAgICAgICAgIHdvcmxkVmVjLmFkZFNjYWxlZFZlY3Rvcihmd2QsIC1keSAqIChUQy5BSU1fRFlfU0NBTEUgIT09IHVuZGVmaW5lZCA/IFRDLkFJTV9EWV9TQ0FMRSA6IDEuMCkpOwogICAgICAgICAgICAgICAgICAgIHdvcmxkVmVjLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBhaW1WZWMgPSB3b3JsZFZlYzsKICAgICAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gYWltVmVjOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBhaW1WZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYWltVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBudWxsOwogICAgICAgICAgICB9CgovLyAtLS0gQU5BTE9HIENVUlZFIExPR0lDIC0tLQogICAgICAgICAgICAvLyBGb3JtdWxhOiBDdXJ2ZSA9IEludGVuc2l0eSAqIFNwZWVkCiAgICAgICAgICAgIGxldCBzcGluVmVjID0gbnVsbDsKICAgICAgICAgICAgCmlmICgoVEMuQ1VSVkVfRU5BQkxFRCAhPT0gZmFsc2UpICYmIGN1cnZlSW5wdXQgJiYgTWF0aC5hYnMoY3VydmVJbnB1dC5pbnRlbnNpdHkpID4gKFRDLkNVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQgOiAwLjI1KSkgewogICAgICAgICAgICAgICAgY29uc3QgcmF3SW50ZW5zaXR5ID0gTWF0aC5hYnMoY3VydmVJbnB1dC5pbnRlbnNpdHkpOwogICAgICAgICAgICAgICAgY29uc3Qgc2lnbiA9IE1hdGguc2lnbihjdXJ2ZUlucHV0LmludGVuc2l0eSk7IC8vIFBvc2l0aXZlID0gUmlnaHQgSHVtcCA9IExlZnQgQ3VydmUKICAgICAgICAgICAgICAgIGNvbnN0IHN3aXBlU3BlZWQgPSBjdXJ2ZUlucHV0LnNwZWVkIHx8IDEuMDsKCiAgICAgICAgICAgICAgICAvLyAxLiBCYXNlIFNwaW4gZnJvbSBBcmMgKFR1bmVkIGZvciByZWFsaXNtLCBubyBjeWNsb25lcykKLy8gMS4gQmFzZSBTcGluIGZyb20gQXJjIChIZXJjdWxlYW4gQm9vc3QpCiAgICAgICAgICAgICAgICBsZXQgc3Bpbk1hZyA9IHJhd0ludGVuc2l0eSAqIChUQy5DVVJWRV9TUElOX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9TUElOX1NDQUxFIDogMTAwMC4wKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBTcGVlZCBCb251cyAoUXVpY2tuZXNzIGFkZHMgUlBNKQogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWRCb251cyA9IE1hdGgubWF4KDEuMCwgc3dpcGVTcGVlZCAqIChUQy5DVVJWRV9TUEVFRF9NVUxUICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9TUEVFRF9NVUxUIDogMS41KSk7CiAgICAgICAgICAgICAgICBzcGluTWFnICo9IHNwZWVkQm9udXM7CgogICAgICAgICAgICAgICAgLy8gQ2FwIChJbmNyZWFzZWQgdG8gMTUwMCBmb3IgbWFzc2l2ZSBhcmNzKQogICAgICAgICAgICAgICAgc3Bpbk1hZyA9IE1hdGgubWluKChUQy5DVVJWRV9TUElOX0NBUCAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BJTl9DQVAgOiAxNTAwLjApLCBzcGluTWFnKTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSBTcGluCiAgICAgICAgICAgICAgICAvLyBSaWdodCBIdW1wIChQb3NpdGl2ZSBJbnRlbnNpdHkpIC0+IExlZnQgQ3VydmUgKFBvc2l0aXZlIFNwaW4gWSkKICAgICAgICAgICAgICAgIHNwaW5WZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCBzcGluTWFnICogc2lnbiwgMCk7CiAgICAgICAgICAgICAgICAKaWYgKHNwaW5NYWcgPiAoVEMuQ1VSVkVfUEVSRkVDVF9TUElOICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9QRVJGRUNUX1NQSU4gOiA1MDAuMCkgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlBFUkZFQ1QgQ1VSVkUiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFJvbGxJbXB1bHNlKHNpZ24gKiAtMC4zKTsgLy8gVGlsdCBjYW1lcmEgaW50byB0aGUgY3VydmUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERldGVybWluZSBUeXBlIChQYXNzIHZzIFNob290KQovLyBEZXRlcm1pbmUgVHlwZSAoUGFzcyB2cyBTaG9vdCkKICAgICAgICAgICAgY29uc3QgZ29hbFogPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC00NiA6IDQ2OwogICAgICAgICAgICBjb25zdCBnb2FsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbFogLSB0aGlzLm1lc2gucG9zaXRpb24ueikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGNvbnN0IGRvdEdvYWwgPSBhaW1WZWMuZG90KGdvYWxEaXIpOwoKICAgICAgICAgICAgbGV0IHR5cGUgPSAnUEEnOwogICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CgogICAgICAgICAgICBpZiAoZG90R29hbCA+IDAuOCAmJiBkaXN0VG9Hb2FsIDwgMzUuMCkgewogICAgICAgICAgICAgICAgdHlwZSA9ICdTSCc7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZG90R29hbCA+IDAuNSAmJiBkaXN0VG9Hb2FsIDwgMjAuMCkgewogICAgICAgICAgICAgICAgdHlwZSA9ICdTSCc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNtYXJ0IFBhc3MgT3ZlcnJpZGUKICAgICAgICAgICAgY29uc3QgdGFyZ2V0TWF0ZSA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGFpbVZlYyk7CiAgICAgICAgICAgIGlmICh0YXJnZXRNYXRlICYmIHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RNYXRlID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGFyZ2V0TWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0TWF0ZSA8IDEyLjApIHR5cGUgPSAnUEEnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmIChiYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCB0eXBlLCBtdWx0aXBsaWVyLCBzcGluVmVjKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBDaGFyZ2UgVUkgbWV0aG9kcwogICAgICAgIF91cGRhdGVDaGFyZ2VVSShyYXRpbykgewogICAgICAgICAgICBjb25zdCBtZXRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItZmlsbCcpOwogICAgICAgICAgICBpZiAobWV0ZXIpIHsKICAgICAgICAgICAgICAgIG1ldGVyLnN0eWxlLndpZHRoID0gYCR7cmF0aW8gKiAxMDB9JWA7CiAgICAgICAgICAgICAgICBpZiAocmF0aW8gPiAwLjkpIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmMCwgI2Y4MCknOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyYXRpbyA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIG1ldGVyLnN0eWxlLmJhY2tncm91bmQgPSAnbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjMGYwLCAjZmYwKSc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1ldGVyLnN0eWxlLmJhY2tncm91bmQgPSAnbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjMGFmLCAjMGYwKSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NoYXJnZS1tZXRlci1jb250YWluZXInKTsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lcikgY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgIH0KCiAgICAgICAgX2hpZGVDaGFyZ2VVSSgpIHsKICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NoYXJnZS1tZXRlci1jb250YWluZXInKTsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lcikgY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQoKICAgICAgICBzZXRPdmVycmlkZUFpbSh4LCB6KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5vdmVycmlkZUFpbVZlY3RvcikgdGhpcy5vdmVycmlkZUFpbVZlY3RvciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3Iuc2V0KHgsIDAsIHopLm5vcm1hbGl6ZSgpOwogICAgICAgIH0KCmxvc2VCYWxsKCkgewogICAgICAgICAgICB0aGlzLmhhc0JhbGwgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCk7CiAgICAgICAgICAgIC8vIEZpeDogRW5zdXJlIHBsYXllciBjYW4gY2F0Y2ggYWdhaW4gaWYgdGhleSBsb3NlIHBvc3Nlc3Npb24gdW5leHBlY3RlZGx5CiAgICAgICAgICAgIHRoaXMuY2FuQ2F0Y2ggPSB0cnVlOwogICAgICAgICAgICAvLyBTYWZldHk6IFJlc2V0IHN0YXRlcyB0byBwcmV2ZW50IGxvY2tpbmcKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKICAgICAgICB9Cgp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIFNZTkMgRklYOiBJZiBiYWxsIHRoaW5rcyBJIGhvbGQgaXQsIGJ1dCBJIGRvbid0LCBmb3JjZSByZWNlaXZlCiAgICAgICAgICAgIGlmICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLmhvbGRlciA9PT0gdGhpcyAmJiAhdGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIlN5bmNpbmcgYmFsbCBwb3NzZXNzaW9uIHRvIHBsYXllciIpOwogICAgICAgICAgICAgICAgdGhpcy5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIElucHV0IHNtb290aGluZyAobGVzcyB0d2l0Y2h5IC8gbW9yZSAic3dpbW15IikKICAgICAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX2RlYnVnSU8pID8gd2luZG93LmZsdXguX2RlYnVnSU8uc2V0dGluZ3MgOiBudWxsOwogICAgICAgICAgICBjb25zdCBBQyA9IHdpbmRvdy5mbHV4LkFzc2lzdENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgY29uc3QgaW5wdXRSZXNwID0gKHNldHRpbmdzICYmIHR5cGVvZiBzZXR0aW5ncy5pbnB1dFJlc3BvbnNlID09PSAnbnVtYmVyJykgPyBzZXR0aW5ncy5pbnB1dFJlc3BvbnNlIDogKEFDLklOUFVUX1JFU1BPTlNFICE9PSB1bmRlZmluZWQgPyBBQy5JTlBVVF9SRVNQT05TRSA6IDE0LjApOwogICAgICAgICAgICBjb25zdCBzdGVlcmluZ0Fzc2lzdCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIChzZXR0aW5ncyAmJiB0eXBlb2Ygc2V0dGluZ3Muc3RlZXJpbmdBc3Npc3QgPT09ICdudW1iZXInKSA/IHNldHRpbmdzLnN0ZWVyaW5nQXNzaXN0IDogKEFDLlNURUVSSU5HX0FTU0lTVCAhPT0gdW5kZWZpbmVkID8gQUMuU1RFRVJJTkdfQVNTSVNUIDogMC4wKSkpOwoKICAgICAgICAgICAgLy8gSGlnaGVyIHNwZWVkIC0+IGEgdG91Y2ggbW9yZSBkYW1waW5nIHNvIHlvdSdyZSBub3Qgb3Zlci1zdGVlcmluZy4KICAgICAgICAgICAgY29uc3Qgc3BlZWROb3cgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICBjb25zdCByZXNwID0gTWF0aC5tYXgoNC4wLCBpbnB1dFJlc3AgKiAoMS4wICsgMC4yNSAqIHN0ZWVyaW5nQXNzaXN0KSAqIChzcGVlZE5vdyA+IDYuMCA/IDAuODUgOiAxLjApKTsKICAgICAgICAgICAgY29uc3QgdElucHV0ID0gMSAtIE1hdGgucG93KDAuMDAxLCBkdCAqIHJlc3ApOwogICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLmxlcnAodGhpcy5kZXNpcmVkSW5wdXRWZWN0b3IsIHRJbnB1dCk7CgogICAgICAgICAgICBpZiAodGhpcy5pc0dvZE1vZGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgPSB0aGlzLnN0YXRzLm1heEhQOwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSB0aGlzLmdldFN0YXQoJ0VOJyk7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy52ZW5vbSA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5uYXAgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBbmltYXRpb246IGxheWVyZWQgbWl4aW5nIChiYXNlIGxvY29tb3Rpb24gKyB1cHBlci1ib2R5IG92ZXJsYXkgKyBvbmUtc2hvdHMpCiAgICAgICAgICAgIGlmICh0aGlzLl9sYXllcmVkRW5hYmxlZCkgdGhpcy5fdXBkYXRlTGF5ZXJlZEFuaW1hdGlvbihkdCk7CiAgICAgICAgICAgIGVsc2UgdGhpcy5fdXBkYXRlTG9jb21vdGlvbkFuaW0oMC4yKTsKCiAgICAgICAgICAgIGlmICh0aGlzLm1peGVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1peGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXMoZHQpOwoKICAgICAgICAgICAgLy8gQ2hhcmdlIExvZ2ljCi8vIENoYXJnZSBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaGFzQmFsbCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0U2NhbGFyKHRoaXMuYmFzZVNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CnRoaXMuY2hhcmdlVGltZSArPSBkdDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBVVRPLVJFTEVBU0U6IElmIGhlbGQgdG9vIGxvbmcgKDNzKSwgZm9yY2UgcmVsZWFzZSB0byBwcmV2ZW50IHN0dWNrIHN0YXRlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2hhcmdlVGltZSA+IDMuMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbGVhc2VDaGFyZ2UoMCwgMCk7IC8vIEZvcmNlIHdlYWsgc2hvdAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHRoaXMuY2hhcmdlVGltZSAvIHRoaXMubWF4Q2hhcmdlVGltZSwgMS4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMZXZpdGF0aW9uIChQb3dlcmluZyB1cCkKICAgICAgICAgICAgICAgICAgICBjb25zdCBob3ZlciA9IChNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMikgKiAwLjEpICsgKHJhdGlvICogMC44KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBWaWJyYXRpb24gKEludGVuc2l0eSBpbmNyZWFzZXMgd2l0aCBjaGFyZ2UpCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hha2UgPSAwLjA1ICsgKDAuMSAqIHJhdGlvKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBcHBseSBZIG9mZnNldCAoSG92ZXIgKyBKaXR0ZXIpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSBob3ZlciArIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEFwcGx5IFJvdGF0aW9uIEppdHRlciAodmlhIGJhbmtpbmcvcGl0Y2ggdmFyaWFibGVzKQogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgYXZvaWRzIHBvc2l0aW9uYWwgZHJpZnQgd2hpbGUgZ2l2aW5nIGEgInN0cnVnZ2xpbmcgdG8gY29udGFpbiBwb3dlciIgbG9vawogICAgICAgICAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlOwoKICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgc2NhbGUgc3RheXMgbm9ybWFsIChSZW1vdmUgc3dlbGxpbmcgZWZmZWN0KQogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5zY2FsZS5zZXRTY2FsYXIodGhpcy5iYXNlU2NhbGUpOwoKICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSShyYXRpbyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KaWYgKHRoaXMuZGFzaENvb2xkb3duID4gMCkgdGhpcy5kYXNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmNsYXNoQ29vbGRvd24gPiAwKSB0aGlzLmNsYXNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLnN0dW5UaW1lciA+IDApIHRoaXMuc3R1blRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5pbW11bml0eVRpbWVyID4gMCkgdGhpcy5pbW11bml0eVRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5jYXRjaENvb2xkb3duID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2F0Y2hDb29sZG93biA8PSAwKSB0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBEYXNoIExvZ2ljCi8vIERhc2ggTG9naWMKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUaW1lIC09IGR0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLl9kYXNoUGFydGljbGVUaW1lciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9kYXNoUGFydGljbGVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZGFzaFBhcnRpY2xlVGltZXIgPSAwLjAzOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWNrID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmFjay5sZW5ndGhTcSgpIDwgMC4xKSBiYWNrLnNldCgwLCAwLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChiYWNrLm11bHRpcGx5U2NhbGFyKDAuNSkpOwogICAgICAgICAgICAgICAgICAgICAgICBwb3MueSArPSAxLjAgKyAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcy54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwb3MsIHsgc2NhbGU6IDIuNSB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gU21vb3RoIFJvdGF0aW9uIGR1cmluZyBEYXNoCiAgICAgICAgICAgICAgICBsZXQgZGlmZiA9IHRoaXMudGFyZ2V0WWF3IC0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICAgICAgd2hpbGUgKGRpZmYgPiBNYXRoLlBJKSBkaWZmIC09IE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgd2hpbGUgKGRpZmYgPCAtTWF0aC5QSSkgZGlmZiArPSBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgdHVyblNwZWVkID0gMTUuMDsgLy8gRmFzdCB0dXJuaW5nIGZvciBkYXNoCiAgICAgICAgICAgICAgICBjb25zdCBjaGFuZ2UgPSBNYXRoLm1heCgtdHVyblNwZWVkICogZHQsIE1hdGgubWluKHR1cm5TcGVlZCAqIGR0LCBkaWZmKSk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgKz0gY2hhbmdlOwoKICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrVGFja2xlQ29sbGlzaW9uKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUaW1lIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGFzaFR5cGUgPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLmRhc2hWZWMpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAxIC0gKHRoaXMuZGFzaFRpbWUgLyB0aGlzLmRhc2hUb3RhbFRpbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IE1hdGguc2luKHQgKiBNYXRoLlBJKSAqIDMuMDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBIb3Jpem9udGFsIERhc2ggTW92ZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IDA7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBWaXN1YWwgVGFja2xlIExlYW4gKFNob3VsZGVyIEJhc2ggQW5pbWF0aW9uKQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gMSAtICh0aGlzLmRhc2hUaW1lIC8gdGhpcy5kYXNoVG90YWxUaW1lKTsgLy8gMCB0byAxCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlYW4gPSBNYXRoLnNpbih0ICogTWF0aC5QSSk7IC8vIFBlYWsgYXQgMS4wIGluIG1pZGRsZQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmUtYXBwbHkgYmFzZSBmYWNpbmcgKyBBZ2dyZXNzaXZlIFNob3VsZGVyIENoZWNrCi8vIFJlLWFwcGx5IGJhc2UgZmFjaW5nICsgQWdncmVzc2l2ZSBTaG91bGRlciBDaGVjawogICAgICAgICAgICAgICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCB0aGlzLmN1cnJlbnRZYXcgKyB0aGlzLnJvdGF0aW9uT2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaXRjaCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB5YXcgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcm9sbCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBsdW5nZUFtdCA9IDA7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXNoVHlwZSA9PT0gJ2hvcml6b250YWwnIHx8IHRoaXMuZGFzaFR5cGUgPT09ICdicmVhaycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUQUNLTEUvQlJFQUs6IEFnZ3Jlc3NpdmUgU2hvdWxkZXIgQ2hlY2sKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaXRjaCA9IDEuMiAqIGxlYW47IC8vIEhlYWQgZG93biAvIExlYW4gZm9yd2FyZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlhdyA9IDAuOCAqIGxlYW47ICAgLy8gVHVybiBzaG91bGRlciBpbnRvIHRhcmdldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvbGwgPSAtMC42ICogbGVhbjsgLy8gRGlwIHNob3VsZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbHVuZ2VBbXQgPSAwLjggKiBsZWFuOyAvLyBUaHJ1c3QgbWVzaCBmb3J3YXJkIHZpc3VhbGx5CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5kYXNoVHlwZSA9PT0gJ3NwcmludCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTUFJJTlQ6IEFlcm9keW5hbWljIGxlYW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaXRjaCA9IDAuNSAqIGxlYW47IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGx1bmdlQW10ID0gMC4yICogbGVhbjsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXBwbHkgTHVuZ2UgKFZpc3VhbCBPZmZzZXQpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsdW5nZUFtdCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfcFZlYy5zZXQoMCwgMCwgbHVuZ2VBbXQpLmFwcGx5UXVhdGVybmlvbihfcFF1YXQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBfcEV1bGVyLnNldChwaXRjaCwgeWF3LCByb2xsKTsKICAgICAgICAgICAgICAgICAgICAgICAgX3BRdWF0Mi5zZXRGcm9tRXVsZXIoX3BFdWxlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5UXVhdGVybmlvbnMoX3BRdWF0LCBfcFF1YXQyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC45Nik7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOTYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBTdHVuL05hcCBDaGVjawogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRyYWdGYWN0b3IgPSBNYXRoLm1heCgwLCAxIC0gKDIuMCAqIGR0KSk7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKGRyYWdGYWN0b3IpOwoKICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CgogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9sYXllcmVkRW5hYmxlZCAmJiAhdGhpcy5fYW5pbUxvY2tlZCAmJiB0aGlzLnN0YXRlICE9PSAnaWRsZScgJiYgdGhpcy5zdGF0ZSAhPT0gJ2NhdGNoJykgdGhpcy5wbGF5KCdpZGxlJywgMC41KTsKCiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIUEJhcigpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVQcmVzc3VyZShkdCk7CgogICAgICAgICAgICBpZiAodGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICgyLjAgKiBkdCkpKTsKCiAgICAgICAgICAgICAgICB0aGlzLl9hcHBseVNvZnRDb2xsaXNpb24oZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlHb2FsQ3JlYXNlKGR0KTsKCiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwoKdGhpcy5fdXBkYXRlVmVydGljYWxpdHkoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQmFua2luZyhkdCk7IC8vIEVuYWJsZSByb3RhdGlvbiBkdXJpbmcgdGhyb3cKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZlcnRpY2FsaXR5KGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUJhbmtpbmcoZHQpOwogICAgICAgICAgICB9Cgp0aGlzLl91cGRhdGVIUEJhcigpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwoKICAgICAgICAgICAgLy8gQnViYmxlIFRyYWlsIExvZ2ljCi8vIEJ1YmJsZSBUcmFpbCBMb2dpYyAoRHluYW1pYykKICAgICAgICAgICAgY29uc3Qgc3BlZWRTcSA9IHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHNwZWVkU3EgPiAxLjAgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2J1YmJsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFja0RpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAxLiBTdGFuZGFyZCBXYWtlIChBbHdheXMgc3Bhd24pCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gYmFja0Rpci5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKDAuOCk7CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LnkgPSAwLjUgKyBNYXRoLnJhbmRvbSgpICogMC41OyAKICAgICAgICAgICAgICAgICAgICBvZmZzZXQueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgIG9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZScsIHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLCB7IHNjYWxlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMjUgfSk7CgogICAgICAgICAgICAgICAgICAgIC8vIDIuIENhdml0YXRpb24gKEhpZ2ggU3BlZWQpIC0gQWRkIG9uIHRvcAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzSGlnaFNwZWVkID0gc3BlZWRTcSA+IDQwLjA7IAogICAgICAgICAgICAgICAgICAgIGlmIChpc0hpZ2hTcGVlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1PZmZzZXQgPSBiYWNrRGlyLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC41ICsgTWF0aC5yYW5kb20oKSowLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC55ID0gMC41ICsgKE1hdGgucmFuZG9tKCktMC41KSowLjg7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlX21pY3JvJywgdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG1PZmZzZXQpLCB7IHNjYWxlOiAwLjA2ICsgTWF0aC5yYW5kb20oKSowLjA4IH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4wMzsgCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwLjE7IAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQp9CgogICAgICAgIF91cGRhdGVTdGF0dXMoZHQpIHsKICAgICAgICAgICAgY29uc3QgcG0gPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyIDogbnVsbDsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy52ZW5vbSA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLnZlbm9tIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSA1ICogZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA8IDApIHRoaXMuc3RhdHMuSFAgPSAwOwoKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnZlbm9tIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BhcnRpY2xlVGltZXJzLnZlbm9tIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bigndmVub20nLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnZlbm9tID0gMC4xNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsICYmIHRoaXMuc3RhdHMuSFAgPCB0aGlzLnN0YXRzLm1heEhQKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCArPSA1ICogZHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPiB0aGlzLnN0YXRzLm1heEhQKSB0aGlzLnN0YXRzLkhQID0gdGhpcy5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSAyLjAgKiBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQIDwgMCkgdGhpcy5zdGF0cy5IUCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5uYXAgLT0gZHQ7CgogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMubmFwIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BhcnRpY2xlVGltZXJzLm5hcCA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ25hcCcsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMubmFwID0gMC44OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgaXNXaXRoZXJpbmcgPSBmYWxzZTsKICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHRoaXMuc3RhdHVzLndpdGhlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltrZXldID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLndpdGhlcltrZXldIC09IGR0OwogICAgICAgICAgICAgICAgICAgIGlzV2l0aGVyaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGlzV2l0aGVyaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMud2l0aGVyIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignd2l0aGVyJywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgPSAwLjI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbHMoKTsKICAgICAgICB9CgpfdXBkYXRlVmlzdWFscygpIHsKICAgICAgICAgICAgLy8gUkVNT1ZFRDogWWVsbG93IHNwaGVyZS90aW50IGxvZ2ljIGFzIHBlciByZXF1ZXN0LgogICAgICAgICAgICAvLyBBbHdheXMgcmV2ZXJ0IHRvIGJhc2UgY29sb3IuCiAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMuZm9yRWFjaChlbnRyeSA9PiB7CiAgICAgICAgICAgICAgICBlbnRyeS5tYXRlcmlhbC5jb2xvci5jb3B5KGVudHJ5LmJhc2VDb2xvcik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgX2NyZWF0ZUF1cmEoKSB7CiAgICAgICAgICAgIC8vIEF1cmEgcmVtb3ZlZCBwZXIgdXNlciByZXF1ZXN0CiAgICAgICAgICAgIHRoaXMuYXVyYU1lc2ggPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBQYXNzIHRhcmdldCBpbmRpY2F0b3IKICAgICAgICBfY3JlYXRlUGFzc1RhcmdldEluZGljYXRvcigpIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIGEgcmluZyB0aGF0IGhpZ2hsaWdodHMgcG90ZW50aWFsIHBhc3MgdGFyZ2V0cwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUmluZ0dlb21ldHJ5KDAuOCwgMS4wLCAxNik7CiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBjb2xvcjogMHgwMGZmMDAsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuNiwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvciA9IG5ldyBUSFJFRS5NZXNoKGdlbywgbWF0KTsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnJvdGF0aW9uLnggPSAtTWF0aC5QSSAvIDI7CiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci5wb3NpdGlvbi55ID0gMC4xOwogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaGFzQmFsbCB8fCAhdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRmluZCBiZXN0IHBhc3MgdGFyZ2V0CiAgICAgICAgICAgIGNvbnN0IGFpbURpciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGFpbURpcik7CgogICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5tZXNoICYmIHRoaXMucGFzc1RhcmdldEluZGljYXRvcikgewogICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnBvc2l0aW9uLnggPSB0YXJnZXQubWVzaC5wb3NpdGlvbi54OwogICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnBvc2l0aW9uLnogPSB0YXJnZXQubWVzaC5wb3NpdGlvbi56OwogICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnBvc2l0aW9uLnkgPSAwLjE7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3Iucm90YXRpb24ueiArPSAwLjA1OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5faGlkZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9oaWRlUGFzc1RhcmdldEluZGljYXRvcnMoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpfYXBwbHlTb2Z0Q29sbGlzaW9uKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoIHx8ICF3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IHRlYW1zID0gW2dhbWUudGVhbXMuaG9tZSwgZ2FtZS50ZWFtcy5hd2F5XTsKCiAgICAgICAgICAgIGNvbnN0IHJlcHVsc2lvblJhZGl1cyA9IDAuNTsgLy8gUmVkdWNlZCB0byAwLjUgdG8gZml4IGludmlzaWJsZSB3YWxsIGlzc3VlcwogICAgICAgICAgICBjb25zdCBzdGlmZm5lc3MgPSAxNS4wOwoKICAgICAgICAgICAgdGVhbXMuZm9yRWFjaCh0ZWFtID0+IHsKICAgICAgICAgICAgICAgIGlmICghdGVhbSkgcmV0dXJuOwogICAgICAgICAgICAgICAgdGVhbS5wbGF5ZXJzLmZvckVhY2gob3RoZXIgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChvdGhlciA9PT0gdGhpcyB8fCAhb3RoZXIubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBkeCA9IHRoaXMubWVzaC5wb3NpdGlvbi54IC0gb3RoZXIubWVzaC5wb3NpdGlvbi54OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGR5ID0gdGhpcy5tZXNoLnBvc2l0aW9uLnkgLSBvdGhlci5tZXNoLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHogPSB0aGlzLm1lc2gucG9zaXRpb24ueiAtIG90aGVyLm1lc2gucG9zaXRpb24uejsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdFNxID0gZHgqZHggKyBkeSpkeSArIGR6KmR6OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1pbkRpc3QgPSByZXB1bHNpb25SYWRpdXMgKiAyLjA7CgogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0U3EgPCBtaW5EaXN0ICogbWluRGlzdCAmJiBkaXN0U3EgPiAwLjAwMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkaXN0U3EpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvdmVybGFwID0gbWluRGlzdCAtIGRpc3Q7CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmb3JjZSA9IG92ZXJsYXAgKiBzdGlmZm5lc3M7CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBueCA9IGR4IC8gZGlzdDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbnkgPSBkeSAvIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG56ID0gZHogLyBkaXN0OwoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9IG54ICogZm9yY2UgKiBkdDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICs9IG55ICogZm9yY2UgKiBkdDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9IG56ICogZm9yY2UgKiBkdDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICB0aGlzLl9hcHBseVNvZnRDb2xsaXNpb24oZHQpOwp0aGlzLl9hcHBseUdvYWxDcmVhc2UoZHQpOwoKICAgICAgICAgICAgY29uc3QgaW5wdXRMZW5TcSA9IHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKTsKICAgICAgICAgICAgY29uc3QgaXNJbnB1dEFjdGl2ZSA9IGlucHV0TGVuU3EgPiAwLjAxOwoKICAgICAgICAgICAgbGV0IGN1cnJlbnRNYXhTcGVlZCA9IHRoaXMubWF4U3BlZWQ7CmlmICh0aGlzLmlzRW5nYWdlZCkgY3VycmVudE1heFNwZWVkICo9IDAuODsgLy8gQnVmZmVkIGZyb20gMC41IHRvIGFsbG93IGVzY2FwZQogICAgICAgICAgICBpZiAodGhpcy5pc0NoYXJnaW5nKSBjdXJyZW50TWF4U3BlZWQgKj0gMC45OwoKICAgICAgICAgICAgaWYgKGlzSW5wdXRBY3RpdmUpIHsKICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5pbnB1dFZlY3Rvcikubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0VmVsWCA9IF9wVmVjLnggKiBjdXJyZW50TWF4U3BlZWQ7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRWZWxaID0gX3BWZWMueiAqIGN1cnJlbnRNYXhTcGVlZDsKCiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50U3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWRSYXRpbyA9IE1hdGgubWluKDEuMCwgY3VycmVudFNwZWVkIC8gdGhpcy5tYXhTcGVlZCk7CgogICAgICAgICAgICAgICAgY29uc3QgYWdpbGl0eSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDEwLjAsIDIuMCwgc3BlZWRSYXRpbyk7CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IDEuMCAtIE1hdGgucG93KDAuMDEsIGR0ICogYWdpbGl0eSk7CgogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9ICh0YXJnZXRWZWxYIC0gdGhpcy52ZWxvY2l0eS54KSAqIHQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gKHRhcmdldFZlbFogLSB0aGlzLnZlbG9jaXR5LnopICogdDsKCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2xheWVyZWRFbmFibGVkICYmICF0aGlzLl9hbmltTG9ja2VkICYmIHRoaXMuc3RhdGUgIT09ICdzd2ltJykgdGhpcy5wbGF5KCdzd2ltJywgMC4yKTsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBicmFrZUZhY3RvciA9IDIuMDsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAxLjAgLSBNYXRoLnBvdygwLjEsIGR0ICogYnJha2VGYWN0b3IpOwoKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSAoMCAtIHRoaXMudmVsb2NpdHkueCkgKiB0OwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9ICgwIC0gdGhpcy52ZWxvY2l0eS56KSAqIHQ7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKSA8IDAuMDEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCB0aGlzLnZlbG9jaXR5LnksIDApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghdGhpcy5fbGF5ZXJlZEVuYWJsZWQgJiYgIXRoaXMuX2FuaW1Mb2NrZWQgJiYgdGhpcy5zdGF0ZSAhPT0gJ2lkbGUnICYmIHRoaXMuc3RhdGUgIT09ICdjYXRjaCcgJiYgdGhpcy5zdGF0ZSAhPT0gJ3Rocm93JyAmJiB0aGlzLnN0YXRlICE9PSAncmVhY3QnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5KCdpZGxlJywgMC4zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IE1hdGgubWF4KDAsIDEuMCAtICgyLjAgKiBkdCkpOwoKICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVZlcnRpY2FsaXR5KGR0KSB7CiAgICAgICAgICAgIGxldCB0YXJnZXRZID0gMDsKCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKCiAgICAgICAgICAgIGlmIChiYWxsICYmIGJhbGwubWVzaCAmJiAhdGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9CYWxsID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMTUuMCkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldFkgPSBiYWxsLm1lc2gucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGFyZ2V0WSA9IDAuNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgeURpZmYgPSB0YXJnZXRZIC0gdGhpcy5tZXNoLnBvc2l0aW9uLnk7CgogICAgICAgICAgICBjb25zdCBsaWZ0ID0geURpZmYgKiAxMC4wICogZHQ7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSArPSBsaWZ0OwoKICAgICAgICAgICAgaWYgKHRoaXMubWVzaC5wb3NpdGlvbi55ID4gOC4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IDguMDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSAtMC41OwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubWVzaC5wb3NpdGlvbi55IDwgLTguMCkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSAtOC4wOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IC0wLjU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEZJWEVEOiBJbXByb3ZlZCBiYW5raW5nIHdpdGggaHlzdGVyZXNpcyB0byBwcmV2ZW50IGZhY2luZyBmbGlwcwovLyBGSVhFRDogSW1wcm92ZWQgYmFua2luZyB3aXRoIGh5c3RlcmVzaXMgdG8gcHJldmVudCBmYWNpbmcgZmxpcHMKICAgICAgICBfdXBkYXRlQmFua2luZyhkdCkgewogICAgICAgICAgICBjb25zdCBpbnB1dExlblNxID0gdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpOwogICAgICAgICAgICBjb25zdCB2ZWxMZW5TcSA9IHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKTsKCiAgICAgICAgICAgIGxldCB0YXJnZXRZYXcgPSB0aGlzLnRhcmdldFlhdzsKICAgICAgICAgICAgbGV0IHNob3VsZFVwZGF0ZVlhdyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUFJJT1JJVFkgMTogRXhwbGljaXQgQWltIChBaW0gU3RpY2sgLyBTd2lwZSkKICAgICAgICAgICAgaWYgKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgIHRhcmdldFlhdyA9IE1hdGguYXRhbjIodGhpcy5vdmVycmlkZUFpbVZlY3Rvci54LCB0aGlzLm92ZXJyaWRlQWltVmVjdG9yLnopOwogICAgICAgICAgICAgICAgc2hvdWxkVXBkYXRlWWF3ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBQUklPUklUWSAyOiBNb3ZlbWVudCBJbnB1dAogICAgICAgICAgICBlbHNlIGlmIChpbnB1dExlblNxID4gdGhpcy5mYWNpbmdEZWFkem9uZSAqIHRoaXMuZmFjaW5nRGVhZHpvbmUpIHsKICAgICAgICAgICAgICAgIHRhcmdldFlhdyA9IE1hdGguYXRhbjIodGhpcy5pbnB1dFZlY3Rvci54LCB0aGlzLmlucHV0VmVjdG9yLnopOwogICAgICAgICAgICAgICAgc2hvdWxkVXBkYXRlWWF3ID0gdHJ1ZTsKICAgICAgICAgICAgfSAKICAgICAgICAgICAgLy8gUFJJT1JJVFkgMzogVmVsb2NpdHkgKERyaWZ0aW5nKQogICAgICAgICAgICBlbHNlIGlmICh2ZWxMZW5TcSA+IHRoaXMuZmFjaW5nRGVhZHpvbmUgKiB0aGlzLmZhY2luZ0RlYWR6b25lKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMudmVsb2NpdHkueCwgdGhpcy52ZWxvY2l0eS56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElmIHdlIHNob3VsZCB1cGRhdGUsIGRvIHNvLiBPdGhlcndpc2Uga2VlcCBsYXN0IHZhbGlkIHlhdwogICAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlWWF3KSB7CiAgICAgICAgICAgICAgICB0aGlzLmxhc3RWYWxpZFlhdyA9IHRhcmdldFlhdzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRhcmdldFlhdyA9IHRoaXMubGFzdFZhbGlkWWF3OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbW9vdGggWWF3IHdpdGggd3JhcC1hcm91bmQgaGFuZGxpbmcKICAgICAgICAgICAgbGV0IGRpZmYgPSB0YXJnZXRZYXcgLSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgIHdoaWxlIChkaWZmID4gTWF0aC5QSSkgZGlmZiAtPSBNYXRoLlBJICogMjsKICAgICAgICAgICAgd2hpbGUgKGRpZmYgPCAtTWF0aC5QSSkgZGlmZiArPSBNYXRoLlBJICogMjsKCiAgICAgICAgICAgIGNvbnN0IHNwZWVkUmF0aW8gPSBNYXRoLm1pbigxLjAsIHRoaXMudmVsb2NpdHkubGVuZ3RoKCkgLyB0aGlzLm1heFNwZWVkKTsKY29uc3QgdHVyblNwZWVkID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoOC4wLCA0LjAsIHNwZWVkUmF0aW8pOyAvLyBSZWR1Y2VkIGZyb20gMTIuMC82LjAgdG8gcmVkdWNlIGZsaXBwaW5nCgogICAgICAgICAgICAvLyBQcmV2ZW50IHN1ZGRlbiBzbmFwcyB3aGVuIGRpZmYgaXMgdmVyeSBsYXJnZSAodGVsZXBvcnQvcmVzZXQgc2NlbmFyaW9zKQogICAgICAgICAgICBjb25zdCBtYXhZYXdDaGFuZ2UgPSBNYXRoLlBJICogZHQgKiB0dXJuU3BlZWQ7CiAgICAgICAgICAgIGNvbnN0IHlhd0NoYW5nZSA9IE1hdGgubWF4KC1tYXhZYXdDaGFuZ2UsIE1hdGgubWluKG1heFlhd0NoYW5nZSwgZGlmZiAqIGR0ICogdHVyblNwZWVkKSk7CgogICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgKz0geWF3Q2hhbmdlOwogICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IHRhcmdldFlhdzsKCiAgICAgICAgICAgIC8vIEJhbmtpbmcKICAgICAgICAgICAgY29uc3QgYmFua1NlbnNpdGl2aXR5ID0gMC44OwogICAgICAgICAgICBjb25zdCBtYXhCYW5rID0gMC43NTsKCiAgICAgICAgICAgIGxldCB0YXJnZXRCYW5rID0gLWRpZmYgKiBiYW5rU2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIHRhcmdldEJhbmsgPSBNYXRoLm1heCgtbWF4QmFuaywgTWF0aC5taW4obWF4QmFuaywgdGFyZ2V0QmFuaykpOwoKICAgICAgICAgICAgY29uc3QgYmFua0xlcnAgPSAxLjAgLSBNYXRoLnBvdygwLjAyLCBkdCk7CiAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCArPSAodGFyZ2V0QmFuayAtIHRoaXMuYmFua2luZ0Ftb3VudCkgKiBiYW5rTGVycDsKCiAgICAgICAgICAgIC8vIFBpdGNoCiAgICAgICAgICAgIGNvbnN0IHBpdGNoU2Vuc2l0aXZpdHkgPSAwLjE7CiAgICAgICAgICAgIGNvbnN0IG1heFBpdGNoID0gMS4wOwoKICAgICAgICAgICAgbGV0IHRhcmdldFBpdGNoID0gLXRoaXMudmVsb2NpdHkueSAqIHBpdGNoU2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIHRhcmdldFBpdGNoID0gTWF0aC5tYXgoLW1heFBpdGNoLCBNYXRoLm1pbihtYXhQaXRjaCwgdGFyZ2V0UGl0Y2gpKTsKCiAgICAgICAgICAgIGNvbnN0IHBpdGNoTGVycCA9IDEuMCAtIE1hdGgucG93KDAuMDUsIGR0KTsKICAgICAgICAgICAgdGhpcy5waXRjaEFtb3VudCArPSAodGFyZ2V0UGl0Y2ggLSB0aGlzLnBpdGNoQW1vdW50KSAqIHBpdGNoTGVycDsKCiAgICAgICAgICAgIC8vIEFwcGx5IFJvdGF0aW9uCiAgICAgICAgICAgIGNvbnN0IGZpbmFsWWF3ID0gdGhpcy5jdXJyZW50WWF3ICsgdGhpcy5yb3RhdGlvbk9mZnNldDsKCiAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLnNldEZyb21BeGlzQW5nbGUoX3BBeGlzWSwgZmluYWxZYXcpOwoKICAgICAgICAgICAgX3BRdWF0LnNldEZyb21BeGlzQW5nbGUobmV3IFRIUkVFLlZlY3RvcjMoMSwgMCwgMCksIHRoaXMucGl0Y2hBbW91bnQpOwogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseShfcFF1YXQpOwoKICAgICAgICAgICAgX3BRdWF0LnNldEZyb21BeGlzQW5nbGUobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSksIHRoaXMuYmFua2luZ0Ftb3VudCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wUXVhdCk7CgogICAgICAgICAgICAvLyBJZGxlIEJvYgogICAgICAgICAgICBpZiAodmVsTGVuU3EgPCAwLjEgJiYgIXRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0aW1lID0gRGF0ZS5ub3coKSAqIDAuMDAxNTsKICAgICAgICAgICAgICAgIGNvbnN0IGJvYlBpdGNoID0gTWF0aC5zaW4odGltZSkgKiAwLjAzOwogICAgICAgICAgICAgICAgY29uc3QgYm9iUm9sbCA9IE1hdGguY29zKHRpbWUgKiAwLjcpICogMC4wMjsKCl9wRXVsZXIuc2V0KGJvYlBpdGNoLCAwLCBib2JSb2xsKTsKICAgICAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tRXVsZXIoX3BFdWxlcik7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseShfcFF1YXQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2NoZWNrVGFja2xlUHJlc3N1cmUoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNFbmdhZ2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIXRoaXMudGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CgogICAgICAgICAgICBpZiAoIW9wcG9uZW50VGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGVuZ2FnZWRUaGlzRnJhbWUgPSBmYWxzZTsKICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlUmFkaXVzID0gdGhpcy5pc0VuZ2FnZWQgPyB0aGlzLnRhY2tsZVJhZGl1cyAqIDEuMiA6IHRoaXMudGFja2xlUmFkaXVzOwoKICAgICAgICAgICAgLy8gMS4gQ2hlY2sgRW5nYWdlbWVudCBTdGF0dXMKICAgICAgICAgICAgZm9yIChjb25zdCBlbnRpdHkgb2Ygb3Bwb25lbnRUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghZW50aXR5Lm1lc2ggfHwgZW50aXR5LnN0YXR1cy5uYXAgPiAwIHx8IGVudGl0eS5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhlbnRpdHkubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IGVmZmVjdGl2ZVJhZGl1cykgewogICAgICAgICAgICAgICAgICAgIGVuZ2FnZWRUaGlzRnJhbWUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gVXBkYXRlIFRpbWVyICYgVUkgRmVlZGJhY2sKICAgICAgICAgICAgaWYgKGVuZ2FnZWRUaGlzRnJhbWUpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBKdXN0IGJlY2FtZSBlbmdhZ2VkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbS5pc0h1bWFuICYmIHRoaXMudGVhbS5hY3RpdmVQbGF5ZXIgPT09IHRoaXMgJiYgZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkVOR0FHRUQhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtYWN0aW9uIik7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhpbnQgZm9yIHRoZSBwbGF5ZXIKICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0VuZ2FnZWQgJiYgdGhpcy5oYXNCYWxsICYmIGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJSRUFLIE5PVyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDIwMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciArPSBkdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5jb3VudGVyVGltZXIgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmlzRW5nYWdlZCA9IGVuZ2FnZWRUaGlzRnJhbWU7CgogICAgICAgICAgICAvLyAzLiBBcHBseSBEYW1hZ2UgKFdpdGggR3JhY2UgUGVyaW9kKQogICAgICAgICAgICAvLyBHcmFjZSBQZXJpb2Q6IDAuNXMgYmVmb3JlIGRhbWFnZSBzdGFydHMgdGlja2luZwogICAgICAgICAgICBpZiAodGhpcy5pc0VuZ2FnZWQgJiYgdGhpcy5lbmNvdW50ZXJUaW1lciA+IDAuNSkgewogICAgICAgICAgICAgICAgZm9yIChjb25zdCBlbnRpdHkgb2Ygb3Bwb25lbnRUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWVudGl0eS5tZXNoIHx8IGVudGl0eS5zdGF0dXMubmFwID4gMCB8fCBlbnRpdHkuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGVudGl0eS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IGVmZmVjdGl2ZVJhZGl1cykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBEaXNjcmV0ZSBDbGFzaCBFdmVudAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW50aXR5LmNsYXNoQ29vbGRvd24gPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzb2x2ZUNsYXNoKGVudGl0eSwgZ2FtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHkuY2xhc2hDb29sZG93biA9IDIuMDsgLy8gSW5jcmVhc2VkIGNvb2xkb3duICh3YXMgMS41KSB0byByZWR1Y2Ugc3BhbQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPD0gMCkgewogICAgICAgICAgICAgICAgdGhpcy5mdW1ibGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9yZXNvbHZlQ2xhc2gob3Bwb25lbnQsIGdhbWUpIHsKICAgICAgICAgICAgY29uc3Qgb3BwQVQgPSBvcHBvbmVudC5nZXRTdGF0KCdBVCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmFyaWFuY2U6IDAuOCB0byAxLjIKICAgICAgICAgICAgY29uc3QgdmFyaWFuY2UgPSAwLjggKyBNYXRoLnJhbmRvbSgpICogMC40OwogICAgICAgICAgICBsZXQgZGFtYWdlID0gTWF0aC5mbG9vcihvcHBBVCAqIHZhcmlhbmNlKTsKICAgICAgICAgICAgaWYgKGRhbWFnZSA8IDEpIGRhbWFnZSA9IDE7CgogICAgICAgICAgICAvLyBEaXJlY3Rpb25hbCBTaGllbGRpbmcKICAgICAgICAgICAgLy8gQ2FycmllciBGb3J3YXJkCiAgICAgICAgICAgIF9wVmVjLmNvcHkoX3BBeGlzWikuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsgCiAgICAgICAgICAgIC8vIFZlY3RvciBUbyBPcHBvbmVudAogICAgICAgICAgICBjb25zdCB0b09wcCA9IG9wcG9uZW50Lm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRvdCA9IF9wVmVjLmRvdCh0b09wcCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJZiBvcHBvbmVudCBpcyBCRUhJTkQgKGRvdCA8IC0wLjIpLCBkYW1hZ2UgaXMgcmVkdWNlZCAoU2hpZWxkaW5nKS4KICAgICAgICAgICAgbGV0IGlzU2hpZWxkZWQgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGRvdCA8IC0wLjIpIHsKICAgICAgICAgICAgICAgIGRhbWFnZSA9IE1hdGguZmxvb3IoZGFtYWdlICogMC41KTsKICAgICAgICAgICAgICAgIGlzU2hpZWxkZWQgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBcHBseSBEYW1hZ2UKICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gZGFtYWdlOwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPCAwKSB0aGlzLmN1cnJlbnRFTiA9IDA7CgogICAgICAgICAgICAvLyBUZWNoIEVmZmVjdHMKICAgICAgICAgICAgaWYgKG9wcG9uZW50LnRlY2hzLnRhY2tsZSkgewogICAgICAgICAgICAgICAgaWYgKG9wcG9uZW50LnRlY2hzLnRhY2tsZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ3Zlbm9tJywgMTAuMCk7CiAgICAgICAgICAgICAgICAgICAgZGFtYWdlICs9IDM7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wcG9uZW50LnRlY2hzLnRhY2tsZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0cyA9IFsnUEEnLCAnU0gnLCAnQVQnLCAnRU4nXTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBzdGF0c1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBzdGF0cy5sZW5ndGgpXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCd3aXRoZXInLCAxMC4wLCB0YXJnZXQpOwogICAgICAgICAgICAgICAgICAgIGRhbWFnZSArPSAzOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcHBvbmVudC50ZWNocy50YWNrbGUgPT09ICdkcmFpbicpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IGRhbWFnZTsgCiAgICAgICAgICAgICAgICAgICAgb3Bwb25lbnQuc3RhdHMuSFAgKz0gZGFtYWdlOwogICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkRSQUlOIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiaGVhbCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBWaXN1YWxzIC0gSlVJQ0VEIFVQCiAgICAgICAgICAgIGNvbnN0IG1pZFBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmxlcnAob3Bwb25lbnQubWVzaC5wb3NpdGlvbiwgMC41KTsKICAgICAgICAgICAgbWlkUG9zLnkgKz0gMS41OwoKICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAoaXNTaGllbGRlZCkgewogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTSElFTEQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJibG9jayIpOwogICAgICAgICAgICAgICAgICAgIH0sIDEwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERhbWFnZSBmZWVkYmFjawogICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oYCR7ZGFtYWdlfWAsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIC8vIE1hc3NpdmUgSW1wYWN0IEp1aWNlCiAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgbWlkUG9zLCB7IHNjYWxlOiAzLjAsIGxpZmU6IDAuNCB9KTsKICAgICAgICAgICAgICAgIGdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIG1pZFBvcywgeyBzY2FsZTogNC4wIH0pOwogICAgICAgICAgICAgICAgLy8gRGVicmlzIHNob3dlcgogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8NjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2RlYnJpcycsIG1pZFBvcywgeyBzY2FsZTogMC40IH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZ2FtZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAvLyBIRVJDVUxFQU4gU0hBS0UKICAgICAgICAgICAgICAgIGdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgyLjUpOyAvLyBJbmNyZWFzZWQgZnJvbSAxLjIKICAgICAgICAgICAgICAgIGdhbWUuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKC01KTsgLy8gWm9vbSBpbiBpbXBhY3QKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGdhbWUudHJpZ2dlckltcGFjdCkgewogICAgICAgICAgICAgICAgLy8gRnJlZXplIGZyYW1lCiAgICAgICAgICAgICAgICBnYW1lLnRyaWdnZXJJbXBhY3QoMC4xNSwgJ2hlYXZ5Jyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9wcG9uZW50LmdhaW5FeHAoMik7CiAgICAgICAgfQoKICAgICAgICBfcGVyZm9ybUplY2h0S25vY2tiYWNrKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW1JZCA9IHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW0gPSBnYW1lLnRlYW1zW29wcG9uZW50VGVhbUlkXTsKCiAgICAgICAgICAgIGlmICghb3Bwb25lbnRUZWFtKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCByYW5nZSA9IDYuMDsKICAgICAgICAgICAgY29uc3QgZm9yY2UgPSAyNS4wOwoKICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiSkVDSFQgU0hPVCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJnb2FsIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9wcG9uZW50VGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHAubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHJhbmdlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlyID0gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgZGlyLnkgPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgZGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LmFkZChkaXIubXVsdGlwbHlTY2FsYXIoZm9yY2UpKTsKCiAgICAgICAgICAgICAgICAgICAgcC5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBjb25zdCByZWFjdEFjdGlvbiA9IHAuYWN0aW9ucyAmJiBwLmFjdGlvbnNbJ3JlYWN0J107CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlYWN0QWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWN0QWN0aW9uLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgICAgICByZWFjdEFjdGlvbi5jbGFtcFdoZW5GaW5pc2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheU9uZVNob3QoJ3JlYWN0JywgMC4xKTsKfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjYXRjaCcsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNNQUNLISIsIHAubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS50cmlnZ2VySW1wYWN0KSBnYW1lLnRyaWdnZXJJbXBhY3QoMC4xNSwgJ3NoYXR0ZXInKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW1ibGUoKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJGVU1CTEUhIEVOIERlcGxldGVkLiIpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCAmJiB0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNSQVNIISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnN0dW5UaW1lciA9IDEuNTsKCiAgICAgICAgICAgIGNvbnN0IGJhY2tEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICBiYWNrRGlyLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICBiYWNrRGlyLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICBiYWNrRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoYmFja0Rpci5tdWx0aXBseVNjYWxhcigxMi4wKSk7CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICBpZiAoYmFsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGVqZWN0RGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoTWF0aC5yYW5kb20oKS0wLjUsIDAuOCwgTWF0aC5yYW5kb20oKS0wLjUpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGJhbGwuc2hvb3QoZWplY3REaXIsIDYuMCwgJ25vbmUnKTsKdGhpcy5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FuQ2F0Y2ggPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBkYXNoKHgsIHopIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuZGFzaENvb2xkb3duID4gMCkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gT0ZGRU5TRTogQlJFQUsgVEFDS0xFCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgJiYgdGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNvc3QgPSAxNTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPCBjb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiRkFJTEVEISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRFTiAtPSBjb3N0OwogICAgICAgICAgICAgICAgdGhpcy5pc0Rhc2hpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5kYXNoVGltZSA9IDAuNDsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaENvb2xkb3duID0gMi4wOwogICAgICAgICAgICAgICAgdGhpcy5kYXNoVHlwZSA9ICdicmVhayc7CgpfcFZlYy5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKF9wVmVjLm11bHRpcGx5U2NhbGFyKDE1LjApKTsKCiAgICAgICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwoKICAgICAgICAgICAgICAgIG9wcG9uZW50VGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ocC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHRoaXMudGFja2xlUmFkaXVzICogMS41KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHB1c2hEaXIgPSBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHVzaERpci55ID0gMC41OwogICAgICAgICAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LmFkZChwdXNoRGlyLm11bHRpcGx5U2NhbGFyKDE1LjApKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3R1blRpbWVyID0gMi4wOwogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXkoJ2NhdGNoJywgMC4yKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNUVU4hIiwgcC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCmlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJCUkVBSyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKLy8gTkVXOiBTcGF3biBCcmVhayBHbHlwaCAoRXhwbG9zaXZlIEJ1cnN0KQogICAgICAgICAgICAgICAgaWYgKGdhbWUuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ3N0YXR1cycsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDAuNSwKICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogOC4wLAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAzLjAsCiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFk6IDAuNQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCi8vIFBhcnRpY2xlIEJ1cnN0IChCcmVhayBUYWNrbGUpCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAyLjAsIGxpZmU6IDAuMyB9KTsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuNSB9KTsKICAgICAgICAgICAgICAgICAgICAvLyBCdWJibGUgQnVyc3QKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzMDsgaSsrKSB7CmNvbnN0IGJQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQoX3BWZWMuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSksIDEuMCsoTWF0aC5yYW5kb20oKS0wLjUpLCAoTWF0aC5yYW5kb20oKS0wLjUpKSk7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2J1YmJsZScsIGJQb3MsIHsgc2NhbGU6IDAuMiArIE1hdGgucmFuZG9tKCkgKiAwLjQgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChnYW1lLnRyaWdnZXJJbXBhY3QpIGdhbWUudHJpZ2dlckltcGFjdCgwLjE1LCAnaGVhdnknKTsKCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9GRkVOU0U6IFNQUklOVAogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjb3N0ID0gNTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRFTiA8IGNvc3QpIHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJOTyBFTiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOIC09IGNvc3Q7CiAgICAgICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gMC40OwogICAgICAgICAgICAgICAgdGhpcy5kYXNoQ29vbGRvd24gPSAxLjU7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ3NwcmludCc7Cgpjb25zdCBidXJzdERpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGlmIChidXJzdERpci5sZW5ndGhTcSgpIDwgMC4xKSBidXJzdERpci5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChidXJzdERpci5tdWx0aXBseVNjYWxhcigxNS4wKSk7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgyMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkRBU0ghIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBERUZFTlNFOiBCTE9DSyAvIFRBQ0tMRQogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGxldCBpc0Jsb2NrQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA4LjAgJiYgYmFsbC5tZXNoLnBvc2l0aW9uLnkgPiAyLjUpIHsKICAgICAgICAgICAgICAgICAgICBpc0Jsb2NrQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5kYXNoVGltZSA9IHRoaXMuZGFzaFRvdGFsVGltZTsKICAgICAgICAgICAgdGhpcy5kYXNoQ29vbGRvd24gPSAxLjU7CgogICAgICAgICAgICBjb25zdCBsZW4gPSBNYXRoLnNxcnQoeCp4ICsgeip6KTsKICAgICAgICAgICAgY29uc3QgbnggPSAobGVuID4gMCkgPyB4L2xlbiA6IDA7CiAgICAgICAgICAgIGNvbnN0IG56ID0gKGxlbiA+IDApID8gei9sZW4gOiAwOwoKaWYgKGxlbiA+IDApIHsKICAgICAgICAgICAgICAgIC8vIFNtb290aCB0dXJuIGZvciBkYXNoIGluc3RlYWQgb2Ygc25hcAogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSBNYXRoLmF0YW4yKG54LCBueik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQmxvY2tDb250ZXh0KSB7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ3ZlcnRpY2FsJzsKCiAgICAgICAgICAgICAgICBjb25zdCBkaXJUb0JhbGwgPSBiYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGRpclRvQmFsbC55ID0gMDsKCiAgICAgICAgICAgICAgICBpZiAoZGlyVG9CYWxsLmxlbmd0aFNxKCkgPiAwLjAxKSB7CiAgICAgICAgICAgICAgICAgICAgZGlyVG9CYWxsLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZGFzaFZlYy5jb3B5KGRpclRvQmFsbCkubXVsdGlwbHlTY2FsYXIoOC4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXNoVmVjLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBjYXRjaEFjdGlvbiA9IHRoaXMuYWN0aW9uc1snY2F0Y2gnXTsKICAgICAgICAgICAgICAgIGlmIChjYXRjaEFjdGlvbikgewogICAgICAgICAgICAgICAgICAgIGNhdGNoQWN0aW9uLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgIGNhdGNoQWN0aW9uLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjYXRjaEFjdGlvbi50aW1lU2NhbGUgPSAxLjU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnBsYXkoJ2NhdGNoJywgMC4xKTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRlZmF1bHQiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ2hvcml6b250YWwnOwogICAgICAgICAgICAgICAgdGhpcy5faGFzSGl0VGFja2xlID0gZmFsc2U7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdmVsb2NpdHkgaW1wdWxzZSBpbiBkYXNoIGRpcmVjdGlvbgovLyBBcHBseSB2ZWxvY2l0eSBpbXB1bHNlIGluIGRhc2ggZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBfcFZlYy5zZXQobngsIDAsIG56KTsKICAgICAgICAgICAgICAgIGlmIChfcFZlYy5sZW5ndGhTcSgpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChfcFZlYy5tdWx0aXBseVNjYWxhcigyMC4wKSk7CgogICAgICAgICAgICAgICAgY29uc3QgbHVuZ2VBY3Rpb24gPSB0aGlzLmFjdGlvbnNbJ3Rocm93J107CiAgICAgICAgICAgICAgICBpZiAobHVuZ2VBY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICBsdW5nZUFjdGlvbi5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgICAgICBsdW5nZUFjdGlvbi5jbGFtcFdoZW5GaW5pc2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgbHVuZ2VBY3Rpb24udGltZVNjYWxlID0gMi4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wbGF5KCd0aHJvdycsIDAuMSk7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjA1LCAnZGVmYXVsdCcpOwogICAgICAgICAgICB9CgppZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZEZvdkltcHVsc2UoMTApOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC4zKTsgCiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gRGFzaCBFZmZlY3QKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRhc2hQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgIGRhc2hQb3MueSArPSAxLjA7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBkYXNoUG9zLCB7IHNjYWxlOiAxLjUsIGxpZmU6IDAuMyB9KTsKICAgICAgICAgICAgICAgIC8vIFNwZWVkIGxpbmVzCiAgICAgICAgICAgICAgICBjb25zdCBiYWNrID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGRhc2hQb3MuY2xvbmUoKS5hZGQoYmFjay5tdWx0aXBseVNjYWxhcihNYXRoLnJhbmRvbSgpKSk7CiAgICAgICAgICAgICAgICAgICAgcC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwLCB7IHNjYWxlOiAxLjUgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jcmVhdGVIUEJhcigpIHsKICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gbmV3IFRIUkVFLkdyb3VwKCk7CgogICAgICAgICAgICBjb25zdCBiZ0dlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDEuMiwgMC4xNSk7CiAgICAgICAgICAgIGNvbnN0IGJnTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDAwMDAwLCBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCBkZXB0aFRlc3Q6IGZhbHNlIH0pOwogICAgICAgICAgICBjb25zdCBiZyA9IG5ldyBUSFJFRS5NZXNoKGJnR2VvLCBiZ01hdCk7CiAgICAgICAgICAgIGNvbnRhaW5lci5hZGQoYmcpOwoKICAgICAgICAgICAgY29uc3QgZmlsbEdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDEuMTYsIDAuMTEpOwogICAgICAgICAgICBmaWxsR2VvLnRyYW5zbGF0ZSgwLjU4LCAwLCAwKTsKICAgICAgICAgICAgY29uc3QgZmlsbE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmYwMCwgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgZGVwdGhUZXN0OiBmYWxzZSB9KTsKICAgICAgICAgICAgdGhpcy5ocEJhckZpbGwgPSBuZXcgVEhSRUUuTWVzaChmaWxsR2VvLCBmaWxsTWF0KTsKICAgICAgICAgICAgdGhpcy5ocEJhckZpbGwucG9zaXRpb24uc2V0KC0wLjU4LCAwLCAwLjAxKTsKICAgICAgICAgICAgY29udGFpbmVyLmFkZCh0aGlzLmhwQmFyRmlsbCk7CgogICAgICAgICAgICB0aGlzLmhwQmFyID0gY29udGFpbmVyOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmhwQmFyKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVIUEJhcigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhwQmFyIHx8ICF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIHRoaXMuaHBCYXIucG9zaXRpb24uY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLmhwQmFyLnBvc2l0aW9uLnkgKz0gMi4yOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLmxvb2tBdCh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhLnBvc2l0aW9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgcGN0ID0gTWF0aC5tYXgoMCwgdGhpcy5zdGF0cy5IUCAvIHRoaXMuc3RhdHMubWF4SFApOwogICAgICAgICAgICB0aGlzLmhwQmFyRmlsbC5zY2FsZS5zZXRYKHBjdCk7CgogICAgICAgICAgICBpZiAocGN0ID4gMC41KSB0aGlzLmhwQmFyRmlsbC5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHgwMGZmMDApOwogICAgICAgICAgICBlbHNlIGlmIChwY3QgPiAwLjI1KSB0aGlzLmhwQmFyRmlsbC5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZmZmMDApOwogICAgICAgICAgICBlbHNlIHRoaXMuaHBCYXJGaWxsLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmMDAwMCk7CgogICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSAocGN0IDwgMC45OCk7CiAgICAgICAgfQoKICAgICAgICBnYWluRXhwKGFtb3VudCkgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSB8fCB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CgogICAgICAgICAgICB0aGlzLmV4cCArPSBhbW91bnQ7CgogICAgICAgICAgICBpZiAodGhpcy5leHAgPj0gdGhpcy5uZXh0TGV2ZWxFeHApIHsKICAgICAgICAgICAgICAgIHRoaXMubGV2ZWxVcCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsZXZlbFVwKCkgewogICAgICAgICAgICB0aGlzLmxldmVsKys7CiAgICAgICAgICAgIHRoaXMuZXhwIC09IHRoaXMubmV4dExldmVsRXhwOwogICAgICAgICAgICB0aGlzLm5leHRMZXZlbEV4cCA9IE1hdGguZmxvb3IodGhpcy5uZXh0TGV2ZWxFeHAgKiAxLjUpOwoKICAgICAgICAgICAgY29uc3Qga2V5cyA9IFsnSFAnLCAnRU4nLCAnQVQnLCAnUEEnLCAnQkwnLCAnU0gnLCAnQ0EnLCAnU1AnXTsKCiAgICAgICAgICAgIGNvbnN0IGhwR2FpbiA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDIwKSArIDEwOwogICAgICAgICAgICB0aGlzLnN0YXRzLm1heEhQICs9IGhwR2FpbjsKICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCA9IHRoaXMuc3RhdHMubWF4SFA7CgogICAgICAgICAgICBrZXlzLmZvckVhY2goayA9PiB7CiAgICAgICAgICAgICAgICBpZiAoayA9PT0gJ0hQJykgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPiAwLjQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnYWluID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMikgKyAxOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHNba10gKz0gZ2FpbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gcmVhY2hlZCBMZXZlbCAke3RoaXMubGV2ZWx9IWApOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgdGhpcy5tZXNoKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJMRVZFTCBVUCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jaGVja1RhY2tsZUNvbGxpc2lvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW0gfHwgdGhpcy5faGFzSGl0VGFja2xlKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwoKICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3Bwb25lbnRUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG9wcC5tZXNoLnBvc2l0aW9uKTsKCmlmIChkaXN0IDwgMy4wKSB7IC8vIEluY3JlYXNlZCBmcm9tIDIuMCBmb3IgZWFzaWVyIGhpdHMKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNvbHZlVGFja2xlSGl0KG9wcCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGFzSGl0VGFja2xlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9yZXNvbHZlVGFja2xlSGl0KG9wcCkgewogICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKC0wLjUpOwogICAgICAgICAgICBpZiAoIXRoaXMuX2xheWVyZWRFbmFibGVkKSB0aGlzLnBsYXkoJ2lkbGUnLCAwLjIpOwoKICAgICAgICAgICAgY29uc3QgYXQgPSB0aGlzLmdldFN0YXQoJ0FUJyk7CiAgICAgICAgICAgIGxldCBkYW1hZ2UgPSBhdCAqIDMuMDsKCiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnRhY2tsZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgb3BwLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDEwLjApOwogICAgICAgICAgICAgICAgZGFtYWdlICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50ZWNocy50YWNrbGUgPT09ICd3aXRoZXInKSB7CiAgICAgICAgICAgICAgICBvcHAuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDEwLjAsICdFTicpOwogICAgICAgICAgICAgICAgZGFtYWdlICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50ZWNocy50YWNrbGUgPT09ICdkcmFpbicpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgKz0gMjA7CiAgICAgICAgICAgICAgICBvcHAuc3RhdHMuSFAgLT0gMjA7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJEUkFJTiIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBvcHAuY3VycmVudEVOIC09IGRhbWFnZTsKCmlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUmVtb3ZlZCAiRU4iIHN1ZmZpeCBmb3IgY2xlYW5lciBsb29rCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgJHtNYXRoLmZsb29yKGRhbWFnZSl9YCwgb3BwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCQU0hIiwgb3BwLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAob3BwLmN1cnJlbnRFTiA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgb3BwLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBvcHAuc3R1blRpbWVyID0gMC41OwogICAgICAgICAgICAgICAgICAgIG9wcC5wbGF5T25lU2hvdCgncmVhY3QnLCAwLjEpOwp9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMudGFja2xlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQodGhpcywgdGhpcy50ZWNocy50YWNrbGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG9wcC5zdHVuVGltZXIgPSAxLjA7CiAgICAgICAgICAgICAgICBvcHAucGxheU9uZVNob3QoJ3JlYWN0JywgMC4xKTsKaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTTUFDSyEiLCBvcHAubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBwdXNoRGlyID0gb3BwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgcHVzaERpci55ID0gMC4yOwogICAgICAgICAgICBvcHAudmVsb2NpdHkuYWRkKHB1c2hEaXIubXVsdGlwbHlTY2FsYXIoMTIuMCkpOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjEsICdoZWF2eScpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuOCk7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaCkgewpjb25zdCBtaWQgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQob3BwLm1lc2gucG9zaXRpb24pLm11bHRpcGx5U2NhbGFyKDAuNSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaChtaWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAovLyBCdWJibGUgQnVyc3QgKFRhY2tsZSBIaXQpCi8vIEJ1YmJsZSBCdXJzdCAoVGFja2xlIEhpdCkKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG1pZCA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmxlcnAob3BwLm1lc2gucG9zaXRpb24sIDAuNSk7CiAgICAgICAgICAgICAgICBtaWQueSArPSAxLjA7CiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzMDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYnViYmxlUG9zID0gbWlkLmNsb25lKCkuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKChNYXRoLnJhbmRvbSgpLTAuNSkqMS41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjEuNSwgKE1hdGgucmFuZG9tKCktMC41KSoxLjUpKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBidWJibGVQb3MsIHsgc2NhbGU6IDAuMTUgKyBNYXRoLnJhbmRvbSgpICogMC4zNSB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5R29hbENyZWFzZShkdCkgewoKICAgICAgICAgICAgY29uc3QgZ29hbHMgPSBbCgogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgNDYpLAogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgLTQ2KQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gMTAuMDsKCiAgICAgICAgICAgIGdvYWxzLmZvckVhY2goZ29hbCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBkeCA9IHRoaXMubWVzaC5wb3NpdGlvbi54IC0gZ29hbC54OwogICAgICAgICAgICAgICAgY29uc3QgZHogPSB0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWwuejsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IGR4KmR4ICsgZHoqZHo7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IHJhZGl1cyAqIHJhZGl1cykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZGlzdFNxKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWCA9IGRpc3QgPiAwID8gZHggLyBkaXN0IDogMTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWiA9IGRpc3QgPiAwID8gZHogLyBkaXN0IDogMDsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSA1MC4wOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSBwdXNoWCAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9IHB1c2haICogZm9yY2UgKiBkdDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByYWRpdXMgLSAwLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xhbXBSYXRpbyA9IHJhZGl1cyAvIChkaXN0ICsgMC4wMDEpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueCA9IGdvYWwueCArIGR4ICogY2xhbXBSYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSBnb2FsLnogKyBkeiAqIGNsYW1wUmF0aW87CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguUGxheWVyID0gUGxheWVyOwp9KSgpOwo=","/Player.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBCYWxsIExhYiAvIERldlRvb2xzOiB0aHJvdyAmIGN1cnZlIG1hcHBpbmcga25vYnMKICAgIC8vIChEZWZhdWx0cyBtYXRjaCBjdXJyZW50IGZlZWw7IERldlRvb2xzIGNhbiB0d2VhayBhdCBydW50aW1lLikKICAgIHdpbmRvdy5mbHV4LlRocm93Q29uZmlnID0gd2luZG93LmZsdXguVGhyb3dDb25maWcgfHwgewogICAgICAgIFNXSVBFX01JTl9QWDogMjAsCiAgICAgICAgQUlNX0RYX1NDQUxFOiAxLjAsCiAgICAgICAgQUlNX0RZX1NDQUxFOiAxLjAsCgogICAgICAgIFBPV0VSX0JBU0U6IDEuMCwKICAgICAgICBQT1dFUl9SQU5HRTogMC44LCAgICAgICAgICAvLyBCYXNlIG11bHRpcGxpZXIgPSBQT1dFUl9CQVNFICsgcmF0aW8qUE9XRVJfUkFOR0UKICAgICAgICBQT1dFUl9NQVhfQk9OVVNfUkFUSU86IDAuOTUsCiAgICAgICAgUE9XRVJfTUFYX01VTFRJUExJRVI6IDIuNSwKCiAgICAgICAgQ1VSVkVfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBDVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEOiAwLjI1LAogICAgICAgIENVUlZFX1NQSU5fU0NBTEU6IDEwMDAuMCwKICAgICAgICBDVVJWRV9TUEVFRF9NVUxUOiAxLjUsCiAgICAgICAgQ1VSVkVfU1BJTl9DQVA6IDE1MDAuMCwKICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDUwMC4wCiAgICB9OwoKICAgIC8vIEFzc2lzdCBrbm9icyAoMC4uMSk6IGhlbHBzIG1ha2UgdGhlIGdhbWUgZmVlbCAic3BvcnR5IiArIGZsdWlkIHdpdGhvdXQgZ29pbmcgZnVsbCBhdXRvLgogICAgd2luZG93LmZsdXguQXNzaXN0Q29uZmlnID0gd2luZG93LmZsdXguQXNzaXN0Q29uZmlnIHx8IHsKICAgICAgICBQQVNTX0FJTV9BU1NJU1Q6IDAuNjUsCiAgICAgICAgU0hPVF9BSU1fQVNTSVNUOiAwLjM1LAogICAgICAgIENBVENIX0FTU0lTVDogMC41NSwKICAgICAgICBTVEVFUklOR19BU1NJU1Q6IDAuMzUsCiAgICAgICAgSU5QVVRfUkVTUE9OU0U6IDE0LjAsCiAgICAgICAgUEFTU19DT05FX0RFRzogNjAsCiAgICAgICAgU0hPVF9DT05FX0RFRzogMzUsCiAgICAgICAgUEFTU19MRUFEX1RJTUU6IDAuMjIsCiAgICAgICAgU0hPVF9MSUZUOiAwLjA4CiAgICB9OwoKLy8gUmV1c2FibGUgbWF0aCBvYmplY3RzCmNvbnN0IF9wVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9wVmVjMiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfcFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BRdWF0MiA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRhcmdldFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BFdWxlciA9IG5ldyBUSFJFRS5FdWxlcigpOwogICAgY29uc3QgX3BBeGlzWSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApOwogICAgY29uc3QgX3BBeGlzWiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpOwoKY2xhc3MgUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSA9ICdNRicpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLnJvbGUgPSByb2xlOwogICAgICAgICAgICB0aGlzLnRlYW0gPSBudWxsOyAvLyBBc3NpZ25lZCBieSBUZWFtLmFkZFBsYXllcgogICAgICAgICAgICB0aGlzLmhvbWVQb3NpdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLm1peGVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hY3Rpb25zID0ge307CiAgICAgICAgICAgIHRoaXMuYWN0aXZlQWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdpZGxlJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2xhc3RMb2NvbW90aW9uID0gJ2lkbGUnOwp0aGlzLmlucHV0VmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuZGVzaXJlZElucHV0VmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAvLyBQaHlzaWNzIChEcmlmdC9JbmVydGlhIE1vZGVsKQogICAgICAgICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYWNjZWxlcmF0aW9uID0gMTIuMDsKICAgICAgICAgICAgdGhpcy5kcmFnID0gMy4wOwogICAgICAgICAgICB0aGlzLm1heFNwZWVkID0gOC4wOwogICAgICAgICAgICAvLyBCb25lIHJlZmVyZW5jZSBmb3IgaG9sZGluZyBiYWxsCiAgICAgICAgICAgIHRoaXMuaGFuZEJvbmUgPSBudWxsOwp0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duID0gMDsgLy8gUmVwbGFjZXMgc2V0VGltZW91dCBmb3Igc2FmZXR5CgogICAgICAgICAgICAvLyBCbGl0emJhbGwgU3RhdHMKICAgICAgICAgICAgdGhpcy5zdGF0cyA9IHsKICAgICAgICAgICAgICAgIEhQOiAxMDAsCiAgICAgICAgICAgICAgICBtYXhIUDogMTAwLAogICAgICAgICAgICAgICAgRU46IDMwLAogICAgICAgICAgICAgICAgQVQ6IDEwLAogICAgICAgICAgICAgICAgUEE6IDE1LAogICAgICAgICAgICAgICAgQkw6IDEwLAogICAgICAgICAgICAgICAgU0g6IDE1LAogICAgICAgICAgICAgICAgQ0E6IDEwLAogICAgICAgICAgICAgICAgU1A6IDYwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBMZXZlbGluZyBTeXN0ZW0KICAgICAgICAgICAgdGhpcy5sZXZlbCA9IDE7CiAgICAgICAgICAgIHRoaXMuZXhwID0gMDsKICAgICAgICAgICAgdGhpcy5uZXh0TGV2ZWxFeHAgPSAxMDA7CgogICAgICAgICAgICAvLyBTdGF0dXMgRWZmZWN0cyAmIFRlY2huaXF1ZXMKICAgICAgICAgICAgdGhpcy5zdGF0dXMgPSB7CiAgICAgICAgICAgICAgICB2ZW5vbTogMCwKICAgICAgICAgICAgICAgIG5hcDogMCwKICAgICAgICAgICAgICAgIHdpdGhlcjogeyBQQTogMCwgU0g6IDAsIEFUOiAwLCBCTDogMCwgQ0E6IDAsIFNQOiAwIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMubWFya2luZyA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubGVhcm5lZFRlY2hzID0gW107CgogICAgICAgICAgICB0aGlzLnRlY2hzID0gewogICAgICAgICAgICAgICAgdGFja2xlOiBudWxsLAogICAgICAgICAgICAgICAgc2hvb3Q6IG51bGwsCiAgICAgICAgICAgICAgICBwYXNzOiBudWxsLAogICAgICAgICAgICAgICAgcGFzc2l2ZTogbnVsbAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVmlzdWFscwogICAgICAgICAgICB0aGlzLmJhc2VDb2xvckhleCA9IDB4ZmZmZmZmOwogICAgICAgICAgICB0aGlzLm9yaWdpbmFsTWF0ZXJpYWxzID0gW107CiAgICAgICAgICAgIHRoaXMuYXVyYU1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLnJvdGF0aW9uT2Zmc2V0ID0gMDsKdGhpcy5iYXNlU2NhbGUgPSAxLjE3OyAvLyBJbmNyZWFzZWQgfjglCgogICAgICAgICAgICAvLyBSZWFsLXRpbWUgU3RhdHMKICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSB0aGlzLnN0YXRzLkVOOwp0aGlzLnRhY2tsZVJhZGl1cyA9IDIuMDsgLy8gUmVkdWNlZCBmcm9tIDIuNSB0byByZWR1Y2Ugc3dhcm0gbG9jawoKICAgICAgICAgICAgdGhpcy5zcGVlZCA9IDQuMDsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CgogICAgICAgICAgICB0aGlzLmhhc0JhbGwgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBEYXNoIFN0YXRlCiAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmRhc2hUb3RhbFRpbWUgPSAwLjU7CnRoaXMuZGFzaENvb2xkb3duID0gMDsKICAgICAgICAgICAgdGhpcy5kYXNoVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIC8vIEZlZWRiYWNrIEFjY3VtdWxhdG9ycwogICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSA9IDA7CiAgICAgICAgICAgIHRoaXMuX2RhbWFnZVRpbWVyID0gMDsKCiAgICAgICAgICAgIC8vIEhQIEJhcgogICAgICAgICAgICB0aGlzLmhwQmFyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5ocEJhckZpbGwgPSBudWxsOwoKICAgICAgICAgICAgLy8gR2FtZXBsYXkgRmxvdyBUaW1lcnMKICAgICAgICAgICAgdGhpcy5zdHVuVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLmltbXVuaXR5VGltZXIgPSAwOwoKICAgICAgICAgICAgLy8gQmFua2luZyAmIFZlcnRpY2FsaXR5CiAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0WSA9IDA7CgogICAgICAgICAgICAvLyBFbmNvdW50ZXIgU3lzdGVtCiAgICAgICAgICAgIHRoaXMuaXNFbmdhZ2VkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY2xhc2hUaW1lciA9IDA7CgogICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsgLy8gVHJhY2sgZHVyYXRpb24gb2YgY3VycmVudCBlbmdhZ2VtZW50CiAgICAgICAgICAgIC8vIENoYXJnZSBNZWNoYW5pYwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jaGFyZ2VUaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5tYXhDaGFyZ2VUaW1lID0gMS41OwoKICAgICAgICAgICAgLy8gRklYRUQ6IEltcHJvdmVkIFJvdGF0aW9uIFN0YXRlIHdpdGggaHlzdGVyZXNpcwogICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IDA7CiAgICAgICAgICAgIHRoaXMubGFzdFZhbGlkWWF3ID0gMDsgLy8gU3RvcmUgbGFzdCBrbm93biBnb29kIHlhdyBmb3IgZGVhZHpvbmUgaGFuZGxpbmcKICAgICAgICAgICAgdGhpcy5waXRjaEFtb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMuZmFjaW5nRGVhZHpvbmUgPSAwLjM7IC8vIE1pbmltdW0gaW5wdXQvdmVsb2NpdHkgbWFnbml0dWRlIHRvIHVwZGF0ZSBmYWNpbmcKCiAgICAgICAgICAgIC8vIFBhcnRpY2xlIEVtaXNzaW9uIFRpbWVycwogICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycyA9IHsKICAgICAgICAgICAgICAgIHZlbm9tOiAwLAogICAgICAgICAgICAgICAgbmFwOiAwLAogICAgICAgICAgICAgICAgd2l0aGVyOiAwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBEZXZUb29scyBGbGFncwogICAgICAgICAgICB0aGlzLmlzR29kTW9kZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUGFzcyBUYXJnZXQgSW5kaWNhdG9yCi8vIFBhc3MgVGFyZ2V0IEluZGljYXRvcgogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IgPSBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQnViYmxlIFRyYWlsIFRpbWVyCiAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMDsKCnRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyID0gMDsKICAgICAgICB9CgogICAgICAgIHN5bmNSb3RhdGlvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgZXVsZXIgPSBuZXcgVEhSRUUuRXVsZXIoKS5zZXRGcm9tUXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbiwgJ1lYWicpOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgPSBldWxlci55IC0gdGhpcy5yb3RhdGlvbk9mZnNldDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgIHRoaXMubGFzdFZhbGlkWWF3ID0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ID0gMDsKICAgICAgICB9CgogICAgICAgIGdldFN0YXQobmFtZSkgewogICAgICAgICAgICBsZXQgdmFsID0gdGhpcy5zdGF0c1tuYW1lXTsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltuYW1lXSA+IDApIHsKICAgICAgICAgICAgICAgIHZhbCAqPSAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICB9CgogICAgICAgIGFwcGx5U3RhdHVzKHR5cGUsIGR1cmF0aW9uLCBzdWJUeXBlID0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMudmVub20gPiAxLjA7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy52ZW5vbSA9IE1hdGgubWF4KHRoaXMuc3RhdHVzLnZlbm9tLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnJvbGV9IHBvaXNvbmVkIWApOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQT0lTT04iLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMubmFwID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gTWF0aC5tYXgodGhpcy5zdGF0dXMubmFwLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gZmVsbCBhc2xlZXAhYCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNMRUVQIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3dpdGhlcicgJiYgc3ViVHlwZSkgewogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFZhbCA9IHRoaXMuc3RhdHVzLndpdGhlcltzdWJUeXBlXSB8fCAwOwogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gY3VycmVudFZhbCA+IDEuMDsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLndpdGhlcltzdWJUeXBlXSA9IE1hdGgubWF4KGN1cnJlbnRWYWwsIGR1cmF0aW9uKTsKCiAgICAgICAgICAgICAgICBpZiAoIXdhc0FjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gd2l0aGVyZWQgJHtzdWJUeXBlfSFgKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgV0lUSEVSICR7c3ViVHlwZX1gLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZURlcml2ZWRTdGF0cygpIHsKICAgICAgICAgICAgY29uc3Qgc3AgPSB0aGlzLmdldFN0YXQoJ1NQJyk7CiAgICAgICAgICAgIHRoaXMubWF4U3BlZWQgPSA1LjAgKyAoc3AgLyAxNS4wKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSB0aGlzLmdldFN0YXQoJ0VOJyk7CiAgICAgICAgfQoKc2V0TWVzaChzb3VyY2VNZXNoLCBhbmltYXRpb25zKSB7CiAgICAgICAgICAgIHRoaXMubWVzaCA9IHNvdXJjZU1lc2g7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUhQQmFyKCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUF1cmEoKTsKICAgICAgICAgICAgdGhpcy5fY3JlYXRlUGFzc1RhcmdldEluZGljYXRvcigpOwoKICAgICAgICAgICAgLy8gQ3VzdG9tIENoYXJhY3RlciBTY2FsaW5nCiAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUuaW5jbHVkZXMoJ1RpZHVzJykpIHRoaXMuYmFzZVNjYWxlID0gMS42OwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB0aGlzLmJhc2VTY2FsZSA9IDEuNDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXNoLnNjYWxlLnNldFNjYWxhcih0aGlzLmJhc2VTY2FsZSk7CgogICAgICAgICAgICB0aGlzLm1lc2gudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCAmJiBub2RlLm1hdGVyaWFsKSB7CmNvbnN0IGNvbnZlcnRPbmUgPSAobWF0KSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG0gPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwOiBtYXQubWFwIHx8IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogbmV3IFRIUkVFLkNvbG9yKDB4ZmZmZmZmKSwgLy8gRk9SQ0UgV0hJVEU6IElnbm9yZSBzb3VyY2UgY29sb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiAhIW1hdC50cmFuc3BhcmVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IChtYXQub3BhY2l0eSAhPT0gdW5kZWZpbmVkID8gbWF0Lm9wYWNpdHkgOiAxKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFscGhhVGVzdDogKG1hdC5hbHBoYVRlc3QgIT09IHVuZGVmaW5lZCA/IG1hdC5hbHBoYVRlc3QgOiAwKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpZGU6IG1hdC5zaWRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwdGhUZXN0OiBtYXQuZGVwdGhUZXN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogbWF0LmRlcHRoV3JpdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb2c6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBza2lubmluZzogISFub2RlLmlzU2tpbm5lZE1lc2gKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMucHVzaCh7IG1hdGVyaWFsOiBtLCBiYXNlQ29sb3I6IG0uY29sb3IuY2xvbmUoKSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG07CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gQXJyYXkuaXNBcnJheShub2RlLm1hdGVyaWFsKQogICAgICAgICAgICAgICAgICAgICAgICA/IG5vZGUubWF0ZXJpYWwubWFwKGNvbnZlcnRPbmUpCiAgICAgICAgICAgICAgICAgICAgICAgIDogY29udmVydE9uZShub2RlLm1hdGVyaWFsKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAobm9kZS5pc0JvbmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gbm9kZS5uYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKChuYW1lLmluY2x1ZGVzKCdoYW5kJykgJiYgbmFtZS5pbmNsdWRlcygncicpKSB8fCBuYW1lLmluY2x1ZGVzKCdyaWdodGhhbmQnKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRCb25lID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5taXhlciA9IG5ldyBUSFJFRS5BbmltYXRpb25NaXhlcih0aGlzLm1lc2gpOwoKICAgICAgICAgICAgLy8gTGF5ZXJlZCBhbmltYXRpb24gc3lzdGVtIChsb2NvbW90aW9uIGJhc2UgKyB1cHBlci1ib2R5IG92ZXJsYXkgKyBmdWxsLWJvZHkgb25lLXNob3RzKQogICAgICAgICAgICB0aGlzLmNsaXBzID0ge307CiAgICAgICAgICAgIHRoaXMudXBwZXJBY3Rpb25zID0ge307CiAgICAgICAgICAgIHRoaXMuYmFzZUFjdGlvbnMgPSB7fTsKICAgICAgICAgICAgdGhpcy5hY3RpdmVVcHBlckFjdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX3VwcGVyTG9ja2VkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX3VwcGVyTG9ja2VkU3RhdGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLl9sYXllcmVkRW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX2xvY29tb3Rpb25GYWRlID0gMC4yOwogICAgICAgICAgICB0aGlzLl9hbmltU3BlZWRTbW9vdGhlZCA9IDA7CiAgICAgICAgICAgIHRoaXMuX2Jhc2VTdXBwcmVzc2lvbiA9IDA7CgoKICAgICAgICAgICAgaWYgKGFuaW1hdGlvbnMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IF9ub3JtQ2xpcE5hbWUgPSAocykgPT4gKHMgfHwgJycpCiAgICAgICAgICAgICAgICAgICAgLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvW19cLV0rL2csICcgJykKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXHMrL2csICcgJykKICAgICAgICAgICAgICAgICAgICAudHJpbSgpOwoKICAgICAgICAgICAgICAgIGFuaW1hdGlvbnMuZm9yRWFjaCgoY2xpcCkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBfbm9ybUNsaXBOYW1lKGNsaXAubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWN0aW9uID0gdGhpcy5taXhlci5jbGlwQWN0aW9uKGNsaXApOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhcyA9IChyZSkgPT4gcmUudGVzdChuYW1lKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVnID0gKGtleSkgPT4geyB0aGlzLmFjdGlvbnNba2V5XSA9IGFjdGlvbjsgdGhpcy5jbGlwc1trZXldID0gY2xpcDsgfTsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIENvcmUgbG9jb21vdGlvbiAtLS0KICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC90cmVhZHx0cmVhZGluZ3xpZGxlfGZsb2F0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnKCdpZGxlJyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2Rhc2h8c3ByaW50fGJ1cnN0fGZhc3Rccypzd2ltfHN3aW1ccypmYXN0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnKCdkYXNoJyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3N3aW18ZnJlZXN0eWxlfGNyYXdsLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnKCdzd2ltJyk7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBUaHJvd2luZyAocGFzcy9zaG90IHZhcmlhbnRzIGlmIHByZXNlbnQpIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC90aHJvd3x0b3NzfHBpdGNoLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhcygvc2hvb3R8c2hvdHxnb2FsLykpIHJlZygndGhyb3dfc2hvdCcpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChoYXMoL3Bhc3MvKSkgcmVnKCd0aHJvd19wYXNzJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgcmVnKCd0aHJvdycpOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gQ2F0Y2hpbmcgKGp1bXAvYWlyIHZhcmlhbnRzIGlmIHByZXNlbnQpIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jYXRjaHxyZWNlaXZlfGdyYWJ8aW50ZXJjZXB0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhcygvanVtcHxsZWFwfGFpcnxkaXZlLykpIHJlZygnY2F0Y2hfanVtcCcpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHJlZygnY2F0Y2gnKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIEhpdCAvIFJlYWN0IC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9yZWFjdHxoaXR8aHVydHxkYW1hZ2V8c3RhZ2dlcnxrbm9jay8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZygncmVhY3QnKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIE9wdGlvbmFsIHN0YXRlcyAob25seSB1c2VkIGlmIGNsaXBzIGV4aXN0KSAtLS0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvY2hhcmdlfGFpbXxyZWFkeXx3aW5kdXB8aG9sZC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZygnY2hhcmdlJyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3RhY2tsZXxjaGVja3xyYW0vKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZWcoJ3RhY2tsZScpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9ibG9ja3xzYXZlLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnKCdibG9jaycpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jZWxlYnJhdGV8dmljdG9yeXxjaGVlci8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZygnY2VsZWJyYXRlJyk7CgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aW9uc1tjbGlwLm5hbWVdID0gYWN0aW9uOyB0aGlzLmNsaXBzW2NsaXAubmFtZV0gPSBjbGlwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CmlmICh0aGlzLmFjdGlvbnNbJ2lkbGUnXSkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2xheWVyZWRFbmFibGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW4gbGF5ZXJlZCBtb2RlIHdlIGRvbid0IHVzZSB0aGUgc2luZ2xlLWFjdGlvbiBzdGF0ZSBtYWNoaW5lLgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFjdGlvbnNbJ2lkbGUnXS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3Rpb25zWydpZGxlJ10ucGxheSgpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheSgnaWRsZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgZmlyc3QgPSBPYmplY3QudmFsdWVzKHRoaXMuYWN0aW9ucylbMF07CiAgICAgICAgICAgICAgICBpZihmaXJzdCkgZmlyc3QucGxheSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIGxheWVyZWQgbWl4aW5nIGlmIGVuYWJsZWQuCiAgICAgICAgICAgIGlmICh0aGlzLl9sYXllcmVkRW5hYmxlZCkgewogICAgICAgICAgICAgICAgdGhpcy5faW5pdExheWVyZWRBbmltYXRpb24oKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBPbmUtc2hvdCBhbmltYXRpb24gbG9jazogcHJldmVudCBsb2NvbW90aW9uIGZyb20gaW50ZXJydXB0aW5nIHRocm93L2NhdGNoL3JlYWN0LgogICAgICAgICAgICAvLyBXaGVuIGEgb25lLXNob3QgZmluaXNoZXMsIGF1dG9tYXRpY2FsbHkgcmV0dXJuIHRvIGxvY29tb3Rpb24uCiAgICAgICAgICAgIGlmICh0aGlzLm1peGVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1peGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2ZpbmlzaGVkJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2FuaW1Mb2NrZWQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBpZiAoIWUgfHwgIWUuYWN0aW9uKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgIC8vIFVwcGVyLWJvZHkgb25lLXNob3QgaGFuZGxpbmcKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fdXBwZXJMb2NrZWQgJiYgdGhpcy5hY3RpdmVVcHBlckFjdGlvbiAmJiBlLmFjdGlvbiA9PT0gdGhpcy5hY3RpdmVVcHBlckFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl91cHBlckxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl91cHBlckxvY2tlZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsgZS5hY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsgZS5hY3Rpb24uZmFkZU91dCgwLjA4KTsgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVVcHBlckFjdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChlLmFjdGlvbiAhPT0gdGhpcy5hY3RpdmVBY3Rpb24pIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvY2tlZFN0YXRlID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgLy8gVW5jbGFtcCBzbyBmdXR1cmUgcGxheXMgZG9uJ3QgZnJlZXplIG9uIGxhc3QgZnJhbWUuCiAgICAgICAgICAgICAgICAgICAgdHJ5IHsgZS5hY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsgfSBjYXRjaCAoXykge30KCiAgICAgICAgICAgICAgICAgICAgLy8gUmV0dXJuIHRvIGxvY29tb3Rpb24gdW5sZXNzIGFub3RoZXIgb3ZlcnJpZGUgaXMgYWN0aXZlLgogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMTUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9Cgp9CgpwbGF5KGFjdGlvbk5hbWUsIGR1cmF0aW9uID0gMC41KSB7CiAgICAgICAgICAgIGNvbnN0IG5ld0FjdGlvbiA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFuZXdBY3Rpb24gfHwgbmV3QWN0aW9uID09PSB0aGlzLmFjdGl2ZUFjdGlvbikgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZlQWN0aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUFjdGlvbi5mYWRlT3V0KGR1cmF0aW9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbmV3QWN0aW9uLnJlc2V0KCk7CiAgICAgICAgICAgIG5ld0FjdGlvbi5mYWRlSW4oZHVyYXRpb24pOwogICAgICAgICAgICBuZXdBY3Rpb24ucGxheSgpOwogICAgICAgICAgICB0aGlzLmFjdGl2ZUFjdGlvbiA9IG5ld0FjdGlvbjsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlTG9jb21vdGlvbkFuaW0oZHVyYXRpb24gPSAwLjIpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2xheWVyZWRFbmFibGVkKSB7IHRoaXMuX2xvY29tb3Rpb25GYWRlID0gZHVyYXRpb247IHJldHVybjsgfQoKICAgICAgICAgICAgaWYgKHRoaXMuX2FuaW1Mb2NrZWQpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHZ4ID0gdGhpcy52ZWxvY2l0eSA/IHRoaXMudmVsb2NpdHkueCA6IDA7CiAgICAgICAgICAgIGNvbnN0IHZ6ID0gdGhpcy52ZWxvY2l0eSA/IHRoaXMudmVsb2NpdHkueiA6IDA7CgogICAgICAgICAgICBjb25zdCBpbnB1dE1vdmluZyA9IHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wNTsKICAgICAgICAgICAgY29uc3QgdmVsTW92aW5nID0gKHZ4ICogdnggKyB2eiAqIHZ6KSA+IDAuMDI7CgogICAgICAgICAgICBjb25zdCBtb3ZpbmcgPSBpbnB1dE1vdmluZyB8fCB2ZWxNb3Zpbmc7CgogICAgICAgICAgICBsZXQgdGFyZ2V0ID0gbW92aW5nID8gJ3N3aW0nIDogJ2lkbGUnOwogICAgICAgICAgICBpZiAobW92aW5nICYmIHRoaXMuaXNEYXNoaW5nICYmIHRoaXMuYWN0aW9uc1snZGFzaCddKSB0YXJnZXQgPSAnZGFzaCc7CgogICAgICAgICAgICAvLyBPcHRpb25hbDogd2hpbGUgc3RhdGlvbmFyeSBhbmQgY2hhcmdpbmcsIHByZWZlciBhIGNoYXJnZS9haW0gbG9vcCBpZiBpdCBleGlzdHMuCiAgICAgICAgICAgIGlmICghbW92aW5nICYmIHRoaXMuaXNDaGFyZ2luZyAmJiB0aGlzLmFjdGlvbnNbJ2NoYXJnZSddKSB0YXJnZXQgPSAnY2hhcmdlJzsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSB0YXJnZXQpIHsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBsb29waW5nIGZvciBsb2NvbW90aW9uLXN0eWxlIGNsaXBzCiAgICAgICAgICAgICAgICBjb25zdCBhID0gdGhpcy5hY3Rpb25zW3RhcmdldF07CiAgICAgICAgICAgICAgICBpZiAoYSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7IGEuc2V0TG9vcChUSFJFRS5Mb29wUmVwZWF0KTsgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgICAgICAgICBhLmNsYW1wV2hlbkZpbmlzaGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnBsYXkodGFyZ2V0LCBkdXJhdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLl9sYXN0TG9jb21vdGlvbiA9IHRhcmdldDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcGxheU9uZVNob3QoYWN0aW9uTmFtZSwgZHVyYXRpb24gPSAwLjEsIG9wdHMgPSB7fSkgewogICAgICAgICAgICAvLyBJbiBsYXllcmVkIG1vZGUsIHJvdXRlIHRocm93cy9jYXRjaGVzIHRvIHRoZSB1cHBlci1ib2R5IGxheWVyIHNvIHBsYXllcnMgY2FuIGtlZXAgc3dpbW1pbmcuCiAgICAgICAgICAgIGlmICh0aGlzLl9sYXllcmVkRW5hYmxlZCkgewogICAgICAgICAgICAgICAgY29uc3QgdXBwZXJLZXlzID0gewogICAgICAgICAgICAgICAgICAgICd0aHJvdyc6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgJ3Rocm93X3Bhc3MnOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICd0aHJvd19zaG90JzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAnY2F0Y2gnOiB0cnVlCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaWYgKHVwcGVyS2V5c1thY3Rpb25OYW1lXSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wbGF5VXBwZXJPbmVTaG90KGFjdGlvbk5hbWUsIGR1cmF0aW9uLCBvcHRzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYSA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFhKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICAvLyBMb2NrIGxvY29tb3Rpb24gc28gaXQgZG9lc24ndCBzdG9tcCB0aGUgb25lLXNob3QuCiAgICAgICAgICAgIHRoaXMuX2FuaW1Mb2NrZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IGFjdGlvbk5hbWU7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgYS5yZXNldCgpOwogICAgICAgICAgICAgICAgYS5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgIGEuY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgYS50aW1lU2NhbGUgPSAob3B0cy50aW1lU2NhbGUgIT09IHVuZGVmaW5lZCA/IG9wdHMudGltZVNjYWxlIDogMS4wKTsKICAgICAgICAgICAgfSBjYXRjaCAoXykge30KCiAgICAgICAgICAgIHRoaXMucGxheShhY3Rpb25OYW1lLCBkdXJhdGlvbik7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBzZXRJbnB1dCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRlc2lyZWRJbnB1dFZlY3Rvci5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmRlc2lyZWRJbnB1dFZlY3Rvci5zZXQoeCwgMCwgeik7CiAgICAgICAgfQoKcmVjZWl2ZUJhbGwoKSB7CiAgICAgICAgICAgIHRoaXMuY2FuQ2F0Y2ggPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENSSVRJQ0FMIEZJWDogUmVzZXQgc3RhdGVzIHRoYXQgbWlnaHQgcHJldmVudCBzaG9vdGluZwogICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2hpZGVDaGFyZ2VVSSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLm5hcCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuaGFzQmFsbCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuaW1tdW5pdHlUaW1lciA9IDIuMDsKCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5sYXN0SG9sZGVyICYmIGJhbGwubGFzdEhvbGRlci50ZWFtID09PSB0aGlzLnRlYW0gJiYgYmFsbC5sYXN0SG9sZGVyICE9PSB0aGlzKSB7CiAgICAgICAgICAgICAgICBiYWxsLmxhc3RIb2xkZXIuZ2FpbkV4cCgyKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FpbkV4cCgxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYmFsbFkgPSAodGhpcy5iYWxsUmVmICYmIHRoaXMuYmFsbFJlZi5tZXNoKSA/IHRoaXMuYmFsbFJlZi5tZXNoLnBvc2l0aW9uLnkgOiAwOwogICAgICAgICAgICBjb25zdCBjYXRjaEtleSA9IChiYWxsWSA+IDAuMjUgJiYgdGhpcy5hY3Rpb25zWydjYXRjaF9qdW1wJ10pID8gJ2NhdGNoX2p1bXAnIDogJ2NhdGNoJzsKICAgICAgICAgICAgdGhpcy5wbGF5T25lU2hvdChjYXRjaEtleSwgMC4xKTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTTkFQISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWFjdGlvbiIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICAgICAgX2luaXRMYXllcmVkQW5pbWF0aW9uKCkgewogICAgICAgICAgICAvLyBCYXNlIGxheWVyOiBpZGxlL3N3aW0vZGFzaCBhcmUgYWx3YXlzIHBsYXlpbmcsIHdlIGp1c3QgYmxlbmQgd2VpZ2h0cy4KICAgICAgICAgICAgY29uc3QgZW5zdXJlTG9vcGluZyA9IChhKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWEpIHJldHVybjsKICAgICAgICAgICAgICAgIHRyeSB7IGEuc2V0TG9vcChUSFJFRS5Mb29wUmVwZWF0KTsgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgICAgIGEuY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGEuZW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBpZGxlID0gdGhpcy5hY3Rpb25zWydpZGxlJ10gfHwgbnVsbDsKICAgICAgICAgICAgY29uc3Qgc3dpbSA9IHRoaXMuYWN0aW9uc1snc3dpbSddIHx8IG51bGw7CiAgICAgICAgICAgIGNvbnN0IGRhc2ggPSB0aGlzLmFjdGlvbnNbJ2Rhc2gnXSB8fCBudWxsOwoKICAgICAgICAgICAgdGhpcy5iYXNlQWN0aW9ucy5pZGxlID0gaWRsZTsKICAgICAgICAgICAgdGhpcy5iYXNlQWN0aW9ucy5zd2ltID0gc3dpbTsKICAgICAgICAgICAgdGhpcy5iYXNlQWN0aW9ucy5kYXNoID0gZGFzaDsKCiAgICAgICAgICAgIC8vIFN0YXJ0IGJhc2UgYWN0aW9ucyBzbyB3ZSBjYW4gYmxlbmQgd2VpZ2h0cyB3aXRob3V0IHJlc3RhcnRpbmcgY2xpcHMgKHNtb290aGVyIG9uIG1vYmlsZSkuCiAgICAgICAgICAgIFtpZGxlLCBzd2ltLCBkYXNoXS5mb3JFYWNoKChhKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWEpIHJldHVybjsKICAgICAgICAgICAgICAgIGVuc3VyZUxvb3BpbmcoYSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGEucGxheSgpOwogICAgICAgICAgICAgICAgICAgIGEuc2V0RWZmZWN0aXZlV2VpZ2h0KDApOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBVcHBlci1ib2R5IGxheWVyOiBmaWx0ZXJlZCBjbGlwcyBmb3IgdGhyb3cvY2F0Y2gvY2hhcmdlIChvbmx5IHVwcGVyIGJvbmVzKS4KICAgICAgICAgICAgY29uc3QgdXBwZXJIaW50cyA9IFsnc3BpbmUnLCdjaGVzdCcsJ25lY2snLCdoZWFkJywnc2hvdWxkZXInLCdjbGF2aWNsZScsJ2FybScsJ2ZvcmVhcm0nLCdoYW5kJywnd3Jpc3QnLCd0aHVtYicsJ2ZpbmdlciddOwogICAgICAgICAgICBjb25zdCBpc1VwcGVyQm9uZU5hbWUgPSAoYm9uZU5hbWUpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IG4gPSAoYm9uZU5hbWUgfHwgJycpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGggb2YgdXBwZXJIaW50cykgaWYgKG4uaW5jbHVkZXMoaCkpIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgZmlsdGVyQ2xpcFRyYWNrcyA9IChjbGlwLCBwcmVkaWNhdGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghY2xpcCkgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICBjb25zdCB0cmFja3MgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdCBvZiAoY2xpcC50cmFja3MgfHwgW10pKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhY2tOYW1lID0gdC5uYW1lIHx8ICcnOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJvbmVOYW1lID0gdHJhY2tOYW1lLnNwbGl0KCcuJylbMF07CiAgICAgICAgICAgICAgICAgICAgaWYgKHByZWRpY2F0ZShib25lTmFtZSkpIHRyYWNrcy5wdXNoKHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCF0cmFja3MubGVuZ3RoKSByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIGNvbnN0IGZpbHRlcmVkID0gY2xpcC5jbG9uZSgpOwogICAgICAgICAgICAgICAgZmlsdGVyZWQudHJhY2tzID0gdHJhY2tzOwogICAgICAgICAgICAgICAgZmlsdGVyZWQubmFtZSA9IChjbGlwLm5hbWUgfHwgJ2NsaXAnKSArICJfVVBQRVIiOwogICAgICAgICAgICAgICAgcmV0dXJuIGZpbHRlcmVkOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgbWFrZVVwcGVyQWN0aW9uID0gKGtleSwgbG9vcE1vZGUpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGNsaXAgPSB0aGlzLmNsaXBzW2tleV07CiAgICAgICAgICAgICAgICBpZiAoIWNsaXApIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgY29uc3QgdXBwZXJDbGlwID0gZmlsdGVyQ2xpcFRyYWNrcyhjbGlwLCBpc1VwcGVyQm9uZU5hbWUpOwogICAgICAgICAgICAgICAgaWYgKCF1cHBlckNsaXApIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgY29uc3QgYSA9IHRoaXMubWl4ZXIuY2xpcEFjdGlvbih1cHBlckNsaXApOwogICAgICAgICAgICAgICAgYS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChsb29wTW9kZSA9PT0gJ2xvb3AnKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsgYS5zZXRMb29wKFRIUkVFLkxvb3BSZXBlYXQpOyB9IGNhdGNoIChfKSB7fQogICAgICAgICAgICAgICAgICAgIGEuY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsgYS5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgICAgICAgICBhLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgYS5zZXRFZmZlY3RpdmVXZWlnaHQoMCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxvb3BNb2RlID09PSAnbG9vcCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYS5wbGF5KCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYS5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgICAgIHRoaXMudXBwZXJBY3Rpb25zW2tleV0gPSBhOwogICAgICAgICAgICAgICAgcmV0dXJuIGE7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBQcmVmZXJyZWQgdXBwZXIgb3ZlcmxheSBjbGlwcyAoaWYgdGhleSBleGlzdCkKICAgICAgICAgICAgbWFrZVVwcGVyQWN0aW9uKCdjaGFyZ2UnLCAnbG9vcCcpOwogICAgICAgICAgICBtYWtlVXBwZXJBY3Rpb24oJ3Rocm93JywgJ29uY2UnKTsKICAgICAgICAgICAgbWFrZVVwcGVyQWN0aW9uKCd0aHJvd19wYXNzJywgJ29uY2UnKTsKICAgICAgICAgICAgbWFrZVVwcGVyQWN0aW9uKCd0aHJvd19zaG90JywgJ29uY2UnKTsKICAgICAgICAgICAgbWFrZVVwcGVyQWN0aW9uKCdjYXRjaCcsICdvbmNlJyk7CgogICAgICAgICAgICAvLyBTdGFydCB3aXRoIHNhbmUgZGVmYXVsdHMKICAgICAgICAgICAgdGhpcy5fYW5pbVNwZWVkU21vb3RoZWQgPSAwOwogICAgICAgICAgICB0aGlzLl9iYXNlU3VwcHJlc3Npb24gPSAwOwogICAgICAgIH0KCiAgICAgICAgX3BsYXlVcHBlck9uZVNob3QoYWN0aW9uTmFtZSwgZmFkZSA9IDAuMDgsIG9wdHMgPSB7fSkgewogICAgICAgICAgICBjb25zdCBhID0gdGhpcy51cHBlckFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgIGlmICghYSkgewogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gZnVsbC1ib2R5IG9uZS1zaG90IGlmIG5vIHVwcGVyIGNsaXAgZXhpc3RzLgogICAgICAgICAgICAgICAgY29uc3QgZmEgPSB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgICAgICBpZiAoIWZhKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IGFjdGlvbk5hbWU7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZlQWN0aW9uICYmIHRoaXMuYWN0aXZlQWN0aW9uICE9PSBmYSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7IHRoaXMuYWN0aXZlQWN0aW9uLmZhZGVPdXQoZmFkZSk7IH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBmYS5yZXNldCgpOwogICAgICAgICAgICAgICAgICAgIGZhLmVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGZhLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgIGZhLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBmYS5zZXRFZmZlY3RpdmVUaW1lU2NhbGUob3B0cy50aW1lU2NhbGUgIT09IHVuZGVmaW5lZCA/IG9wdHMudGltZVNjYWxlIDogMS4wKTsKICAgICAgICAgICAgICAgICAgICBmYS5zZXRFZmZlY3RpdmVXZWlnaHQoMS4wKTsKICAgICAgICAgICAgICAgICAgICBmYS5mYWRlSW4oZmFkZSk7CiAgICAgICAgICAgICAgICAgICAgZmEucGxheSgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoXykge30KCiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUFjdGlvbiA9IGZhOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGFjdGlvbk5hbWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3RvcCBhbnkgY3VycmVudCB1cHBlciBvbmUtc2hvdAogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVVcHBlckFjdGlvbiAmJiB0aGlzLmFjdGl2ZVVwcGVyQWN0aW9uICE9PSBhKSB7CiAgICAgICAgICAgICAgICB0cnkgeyB0aGlzLmFjdGl2ZVVwcGVyQWN0aW9uLmZhZGVPdXQoMC4wNik7IH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwcGVyTG9ja2VkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5fdXBwZXJMb2NrZWRTdGF0ZSA9IGFjdGlvbk5hbWU7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlVXBwZXJBY3Rpb24gPSBhOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGEucmVzZXQoKTsKICAgICAgICAgICAgICAgIGEuZW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBhLnNldEVmZmVjdGl2ZVRpbWVTY2FsZShvcHRzLnRpbWVTY2FsZSAhPT0gdW5kZWZpbmVkID8gb3B0cy50aW1lU2NhbGUgOiAxLjApOwogICAgICAgICAgICAgICAgYS5zZXRFZmZlY3RpdmVXZWlnaHQoMS4wKTsKICAgICAgICAgICAgICAgIGEuc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICBhLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGEuZmFkZUluKGZhZGUpOwogICAgICAgICAgICAgICAgYS5wbGF5KCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKF8pIHt9CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIF9zZXRXZWlnaHQoYWN0aW9uLCB0YXJnZXQsIGxlcnBBbHBoYSkgewogICAgICAgICAgICBpZiAoIWFjdGlvbikgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBjdXIgPSAoYWN0aW9uLmdldEVmZmVjdGl2ZVdlaWdodCA/IGFjdGlvbi5nZXRFZmZlY3RpdmVXZWlnaHQoKSA6IDApIHx8IDA7CiAgICAgICAgICAgIGNvbnN0IG5leHQgPSBjdXIgKyAodGFyZ2V0IC0gY3VyKSAqIGxlcnBBbHBoYTsKICAgICAgICAgICAgdHJ5IHsgYWN0aW9uLnNldEVmZmVjdGl2ZVdlaWdodChuZXh0KTsgfSBjYXRjaCAoXykge30KICAgICAgICB9CgogICAgICAgIF91cGRhdGVMYXllcmVkQW5pbWF0aW9uKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5taXhlcikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gU21vb3RoIHNwZWVkIChoZWxwcyBvbiBtb2JpbGUgaml0dGVyKQogICAgICAgICAgICBjb25zdCB2eCA9IHRoaXMudmVsb2NpdHkgPyB0aGlzLnZlbG9jaXR5LnggOiAwOwogICAgICAgICAgICBjb25zdCB2eiA9IHRoaXMudmVsb2NpdHkgPyB0aGlzLnZlbG9jaXR5LnogOiAwOwogICAgICAgICAgICBjb25zdCBzcGVlZCA9IE1hdGguc3FydCh2eCAqIHZ4ICsgdnogKiB2eik7CiAgICAgICAgICAgIHRoaXMuX2FuaW1TcGVlZFNtb290aGVkICs9IChzcGVlZCAtIHRoaXMuX2FuaW1TcGVlZFNtb290aGVkKSAqIE1hdGgubWluKDEsIGR0ICogMTAuMCk7CgogICAgICAgICAgICAvLyBCYXNlIHN1cHByZXNzaW9uIGR1cmluZyBmdWxsLWJvZHkgb25lLXNob3RzCiAgICAgICAgICAgIGNvbnN0IHdhbnRTdXBwID0gdGhpcy5fYW5pbUxvY2tlZCA/IDEuMCA6IDAuMDsKICAgICAgICAgICAgdGhpcy5fYmFzZVN1cHByZXNzaW9uICs9ICh3YW50U3VwcCAtIHRoaXMuX2Jhc2VTdXBwcmVzc2lvbikgKiBNYXRoLm1pbigxLCBkdCAqIDE0LjApOwogICAgICAgICAgICBjb25zdCBiYXNlTXVsID0gMS4wIC0gdGhpcy5fYmFzZVN1cHByZXNzaW9uOwoKICAgICAgICAgICAgY29uc3QgZmFkZSA9ICh0aGlzLl9sb2NvbW90aW9uRmFkZSB8fCAwLjIpOwogICAgICAgICAgICBjb25zdCBsZXJwQWxwaGEgPSBNYXRoLm1pbigxLCBkdCAvIE1hdGgubWF4KDAuMDAwMSwgZmFkZSkpOwoKICAgICAgICAgICAgLy8gQmxlbmQgaWRsZSA8LT4gc3dpbSB1c2luZyBhIHNvZnQgdGhyZXNob2xkICsgaHlzdGVyZXNpcwogICAgICAgICAgICBjb25zdCBpbk1vdmUgPSAodGhpcy5pbnB1dFZlY3RvciAmJiB0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwLjA1KTsKICAgICAgICAgICAgY29uc3QgbW92aW5nID0gaW5Nb3ZlIHx8IHRoaXMuX2FuaW1TcGVlZFNtb290aGVkID4gMC4wODsKCiAgICAgICAgICAgIC8vIFNtb290aCBzd2ltIGJsZW5kCiAgICAgICAgICAgIGNvbnN0IHN3aW1CbGVuZCA9IG1vdmluZyA/IE1hdGgubWluKDEsIE1hdGgubWF4KDAsICh0aGlzLl9hbmltU3BlZWRTbW9vdGhlZCAtIDAuMDUpIC8gMC40NSkpIDogMDsKICAgICAgICAgICAgY29uc3QgZGFzaEJsZW5kID0gKHRoaXMuaXNEYXNoaW5nICYmIHRoaXMuYmFzZUFjdGlvbnMuZGFzaCkgPyAxIDogMDsKCiAgICAgICAgICAgIGNvbnN0IGlkbGVXID0gKDEgLSBzd2ltQmxlbmQpICogKDEgLSBkYXNoQmxlbmQpICogYmFzZU11bDsKICAgICAgICAgICAgY29uc3Qgc3dpbVcgPSAoc3dpbUJsZW5kKSAqICgxIC0gZGFzaEJsZW5kKSAqIGJhc2VNdWw7CiAgICAgICAgICAgIGNvbnN0IGRhc2hXID0gKGRhc2hCbGVuZCkgKiBiYXNlTXVsOwoKICAgICAgICAgICAgdGhpcy5fc2V0V2VpZ2h0KHRoaXMuYmFzZUFjdGlvbnMuaWRsZSwgaWRsZVcsIGxlcnBBbHBoYSk7CiAgICAgICAgICAgIHRoaXMuX3NldFdlaWdodCh0aGlzLmJhc2VBY3Rpb25zLnN3aW0sIHN3aW1XLCBsZXJwQWxwaGEpOwogICAgICAgICAgICB0aGlzLl9zZXRXZWlnaHQodGhpcy5iYXNlQWN0aW9ucy5kYXNoLCBkYXNoVywgbGVycEFscGhhKTsKCiAgICAgICAgICAgIC8vIFRpbWUtc2NhbGUgbG9jb21vdGlvbiBzbyBpdCBtYXRjaGVzIGFjdHVhbCBtb3Rpb24KICAgICAgICAgICAgaWYgKHRoaXMuYmFzZUFjdGlvbnMuc3dpbSkgewogICAgICAgICAgICAgICAgY29uc3QgdHMgPSAwLjc1ICsgTWF0aC5taW4oMS41LCB0aGlzLl9hbmltU3BlZWRTbW9vdGhlZCAqIDEuMik7CiAgICAgICAgICAgICAgICB0cnkgeyB0aGlzLmJhc2VBY3Rpb25zLnN3aW0uc2V0RWZmZWN0aXZlVGltZVNjYWxlKHRzKTsgfSBjYXRjaCAoXykge30KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5iYXNlQWN0aW9ucy5kYXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0cyA9IDEuMSArIE1hdGgubWluKDEuMiwgdGhpcy5fYW5pbVNwZWVkU21vb3RoZWQgKiAwLjgpOwogICAgICAgICAgICAgICAgdHJ5IHsgdGhpcy5iYXNlQWN0aW9ucy5kYXNoLnNldEVmZmVjdGl2ZVRpbWVTY2FsZSh0cyk7IH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuYmFzZUFjdGlvbnMuaWRsZSkgewogICAgICAgICAgICAgICAgdHJ5IHsgdGhpcy5iYXNlQWN0aW9ucy5pZGxlLnNldEVmZmVjdGl2ZVRpbWVTY2FsZSgxLjApOyB9IGNhdGNoIChfKSB7fQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcHBlci1ib2R5IG92ZXJsYXkgKGFpbS9jaGFyZ2UgbG9vcCkgd2hlbiBob2xkaW5nIGJhbGwuCiAgICAgICAgICAgIGNvbnN0IGNoYXJnZUEgPSB0aGlzLnVwcGVyQWN0aW9uc1snY2hhcmdlJ10gfHwgbnVsbDsKICAgICAgICAgICAgY29uc3Qgd2FudHNDaGFyZ2UgPSAoIXRoaXMuX3VwcGVyTG9ja2VkKSAmJiBjaGFyZ2VBICYmIHRoaXMuaGFzQmFsbCAmJiAodGhpcy5pc0NoYXJnaW5nIHx8IHRoaXMuY2hhcmdlVGltZSA+IDAuMDUpOwogICAgICAgICAgICBjb25zdCBjaGFyZ2VUYXJnZXRXID0gd2FudHNDaGFyZ2UgPyAxLjAgOiAwLjA7CiAgICAgICAgICAgIHRoaXMuX3NldFdlaWdodChjaGFyZ2VBLCBjaGFyZ2VUYXJnZXRXLCBsZXJwQWxwaGEpOwoKICAgICAgICAgICAgaWYgKGNoYXJnZUEgJiYgd2FudHNDaGFyZ2UpIHsKICAgICAgICAgICAgICAgIHRyeSB7IGNoYXJnZUEuc2V0RWZmZWN0aXZlVGltZVNjYWxlKDEuMCk7IH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElmIGZ1bGwtYm9keSBvbmUtc2hvdCBpcyBhY3RpdmUsIGFsc28gZGFtcCB1cHBlciBvdmVybGF5IHNvIGl0IGRvZXNuJ3QgZmlnaHQuCiAgICAgICAgICAgIGlmICh0aGlzLl9hbmltTG9ja2VkICYmIGNoYXJnZUEpIHsKICAgICAgICAgICAgICAgIHRyeSB7IGNoYXJnZUEuc2V0RWZmZWN0aXZlV2VpZ2h0KDApOyB9IGNhdGNoIChfKSB7fQogICAgICAgICAgICB9CiAgICAgICAgfQoKCnRocm93QmFsbChiYWxsLCBmb3JjZWRUeXBlID0gbnVsbCwgcG93ZXJNdWx0aXBsaWVyID0gMS4wLCBmb3JjZWRTcGluID0gbnVsbCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaGFzQmFsbCB8fCB0aGlzLmlzVGhyb3dpbmcpIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKCiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IHRydWU7CgogICAgICAgICAgICAvLyBMb2NrIGFpbSBkaXJlY3Rpb24gYXQgc3RhcnQgb2YgdGhyb3cKICAgICAgICAgICAgdGhpcy5sb2NrZWRBaW1WZWN0b3IgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKSA+IDAuMSkgewogICAgICAgICAgICAgICAgdGhpcy5sb2NrZWRBaW1WZWN0b3IuY29weSh0aGlzLmlucHV0VmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMubG9ja2VkQWltVmVjdG9yLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9Cgpjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLTQ2IDogNDY7CiAgICAgICAgICAgIGNvbnN0IGRpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKCiAgICAgICAgICAgIGxldCB0eXBlID0gZm9yY2VkVHlwZTsKICAgICAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICAgICAgICB0eXBlID0gKGRpc3RUb0dvYWwgPCAyNSkgPyAnU0gnIDogJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgaXNGaW5pc2hlciA9ICh0eXBlID09PSAnU0gnICYmIGRpc3RUb0dvYWwgPCAxMi4wKTsKCiAgICAgICAgICAgIGxldCB0ZWNoTmFtZSA9ICh0eXBlID09PSAnU0gnKSA/IHRoaXMudGVjaHMuc2hvb3QgOiB0aGlzLnRlY2hzLnBhc3M7CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMudmVub20gPiAwICYmIHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTSUxFTkNFRCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInN0YXR1cyIpOwogICAgICAgICAgICAgICAgdGVjaE5hbWUgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgd2luZHVwVGltZSA9IDEwMDsKICAgICAgICAgICAgbGV0IGFuaW1TcGVlZCA9IDEuNTsKCiAgICAgICAgICAgIGlmIChwb3dlck11bHRpcGxpZXIgPiAxLjEpIHsKICAgICAgICAgICAgICAgIHdpbmR1cFRpbWUgKz0gMjAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNGaW5pc2hlciAmJiAhdGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIHdpbmR1cFRpbWUgPSA1MDsKICAgICAgICAgICAgICAgIGFuaW1TcGVlZCA9IDMuMDsKICAgICAgICAgICAgfQoKaWYgKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICB3aW5kdXBUaW1lID0gNDAwOwogICAgICAgICAgICAgICAgYW5pbVNwZWVkID0gMC44OwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLnBsYXlDaW5lbWF0aWModGVjaE5hbWUsIHRoaXMubWVzaCwgMS4yKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLmltbXVuaXR5VGltZXIgPSAxLjU7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IHRlY2hOYW1lLnJlcGxhY2UoJ18nLCAnICcpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihsYWJlbCwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE5FVzogU3Bhd24gVGVjaCBHbHlwaCAoVmVydGljYWwgQ2FzdGluZyBDaXJjbGUpCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmdseXBoTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ3RlY2gnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50OiB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAxLjIsCiAgICAgICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IDQuMCwKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGVTcGVlZDogMS41LAogICAgICAgICAgICAgICAgICAgICAgICBvZmZzZXRZOiAxLjIsCiAgICAgICAgICAgICAgICAgICAgICAgIGZhY2VDYW1lcmE6IHRydWUKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUGljayBiZXN0IHRocm93IGNsaXAgKHBhc3Mvc2hvdCB2YXJpYW50cyBpZiBwcmVzZW50KQogICAgICAgICAgICBjb25zdCB0aHJvd0tleSA9CiAgICAgICAgICAgICAgICAodHlwZSA9PT0gJ1NIJyAmJiB0aGlzLmFjdGlvbnNbJ3Rocm93X3Nob3QnXSkgPyAndGhyb3dfc2hvdCcgOgogICAgICAgICAgICAgICAgKHR5cGUgPT09ICdQQScgJiYgdGhpcy5hY3Rpb25zWyd0aHJvd19wYXNzJ10pID8gJ3Rocm93X3Bhc3MnIDoKICAgICAgICAgICAgICAgICd0aHJvdyc7CgogICAgICAgICAgICB0aGlzLnBsYXlPbmVTaG90KHRocm93S2V5LCAwLjEsIHsgdGltZVNjYWxlOiBhbmltU3BlZWQgfSk7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCAmJiAhdGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIldIT09TSCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWFjdGlvbiIpOwogICAgICAgICAgICB9CgpzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIC8vIFNhZmV0eTogSWYgYmFsbCBob2xkZXIgaXMgc3RpbGwgdXMsIHByb2NlZWQuIElmIGhhc0JhbGwgaXMgZmFsc2UgYnV0IGhvbGRlciBpcyB1cywgYXNzdW1lIHN5bmMgbGFnIGFuZCBwcm9jZWVkLgogICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCB8fCAoYmFsbCAmJiBiYWxsLmhvbGRlciA9PT0gdGhpcykpIHsKY29uc3QgdGhyb3dBY3Rpb24gPSB0aGlzLmFjdGlvbnNbdGhyb3dLZXldOwogICAgICAgICAgICAgICAgICAgIGlmICh0aHJvd0FjdGlvbikgdGhyb3dBY3Rpb24udGltZVNjYWxlID0gMS4wOwoKICAgICAgICAgICAgICAgICAgICBsZXQgZmluYWxEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgICAgIGxldCByZWZlcmVuY2VEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKaWYgKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIuY29weSh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlRGlyLmNvcHkoZmluYWxEaXIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUkVNT1ZFRDogSW5zdGFudCByb3RhdGlvbiBzbmFwLiAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhlIHVwZGF0ZSBsb29wIGhhbmRsZXMgc21vb3RoIHJvdGF0aW9uIHZpYSB0YXJnZXRZYXcuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgcHJldmVudHMgdGhlICJmbGlwcGluZyBhcm91bmQiIHZpc3VhbCBnbGl0Y2guCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIuY29weSh0aGlzLmxvY2tlZEFpbVZlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZURpci5jb3B5KHRoaXMubG9ja2VkQWltVmVjdG9yKTsKICAgICAgICAgICAgICAgICAgICB9Cgpjb25zdCBzcGluID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAgICAgICAgIGlmIChmb3JjZWRTcGluKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNwaW4uY29weShmb3JjZWRTcGluKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnB1dERpciA9IHRoaXMuaW5wdXRWZWN0b3IuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY3Jvc3NZID0gbmV3IFRIUkVFLlZlY3RvcjMoKS5jcm9zc1ZlY3RvcnMocmVmZXJlbmNlRGlyLCBpbnB1dERpcikueTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhjcm9zc1kpID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGluLnNldCgwLCBjcm9zc1kgKiAxMi4wLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGV0IGJhc2VDb3N0ID0gKHR5cGUgPT09ICdTSCcpID8gMjAgOiAxMDsKICAgICAgICAgICAgICAgICAgICBsZXQgdGVjaENvc3QgPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoQm9udXMgPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoUGF5bG9hZCA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd2ZW5vbSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDIwIDogMTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICd2ZW5vbScsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd3aXRoZXInOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gKHR5cGUgPT09ICdTSCcgPyAyMCA6IDEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnd2l0aGVyJywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ25hcCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDM1IDogMzApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICduYXAnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3BoZXJlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9IDI1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBybmcgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxMSkgKyA1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSBybmc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnc3BoZXJlJywgbGV2ZWw6IDEsIGJvbnVzOiBybmcgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGBTUEhFUkUgKyR7cm5nfWAsIHRoaXMubWVzaC5wb3NpdGlvbiwgImdvYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdqZWNodCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSA0MDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdqZWNodCcsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BlcmZvcm1KZWNodEtub2NrYmFjaygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2ludmlzaWJsZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAyNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdpbnZpc2libGUnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdG90YWxDb3N0ID0gYmFzZUNvc3QgKyB0ZWNoQ29zdDsKCiAgICAgICAgICAgICAgICAgICAgbGV0IHBvd2VyRmFjdG9yID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQIDwgdG90YWxDb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvd2VyRmFjdG9yID0gMC41OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlRJUkVEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSB0b3RhbENvc3Q7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdFZhbCA9IHRoaXMuZ2V0U3RhdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICs9IHRlY2hCb251czsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IHBvd2VyRmFjdG9yOwogICAgICAgICAgICAgICAgICAgIHN0YXRWYWwgKj0gcG93ZXJNdWx0aXBsaWVyOwoKY29uc3QgZ29hbFogPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC00NiA6IDQ2OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCBnb2FsWiAtIHRoaXMubWVzaC5wb3NpdGlvbi56KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnb2FsRG90ID0gZmluYWxEaXIuZG90KGdvYWxEaXIpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBnb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMiwgZ29hbFopOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0b0dvYWwgPSBnb2FsUG9zLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzaCA9IHRoaXMuZ2V0U3RhdCgnU0gnKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2V0dGluZ3MyID0gKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPKSA/IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPLnNldHRpbmdzIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgQUMyID0gd2luZG93LmZsdXguQXNzaXN0Q29uZmlnIHx8IHt9OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzaG90QXNzaXN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgKHNldHRpbmdzMiAmJiB0eXBlb2Ygc2V0dGluZ3MyLnNob3RBaW1Bc3Npc3QgPT09ICdudW1iZXInKSA/IHNldHRpbmdzMi5zaG90QWltQXNzaXN0IDogKEFDMi5TSE9UX0FJTV9BU1NJU1QgIT09IHVuZGVmaW5lZCA/IEFDMi5TSE9UX0FJTV9BU1NJU1QgOiAwLjM1KSkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjb25lRGVnID0gKEFDMi5TSE9UX0NPTkVfREVHICE9PSB1bmRlZmluZWQgPyBBQzIuU0hPVF9DT05FX0RFRyA6IDM1KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWluRG90ID0gTWF0aC5jb3MoY29uZURlZyAqIE1hdGguUEkgLyAxODApOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQmxlbmQgYW1vdW50OiBzdGF0cyAqIHVzZXIgYXNzaXN0IChrZXB0IG1vZGVzdCBzbyBpdCdzIG5vdCAiYmFieSIgZWFzeSkuCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBzaG90QXNzaXN0ICogTWF0aC5taW4oMC45LCBNYXRoLm1heCgwLjA4LCBzaCAvIDEwMC4wKSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBwbGF5ZXIgZXhwbGljaXRseSBhaW1lZCwgcmVkdWNlIGhlbHAgYnV0IGtlZXAgc29tZSB0byBwcmVzZXJ2ZSBmbG93LgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzaXN0RmFjdG9yICo9IDAuNTU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnb2FsRG90ID4gbWluRG90KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgKGdvYWxEb3QgLSBtaW5Eb3QpIC8gKDEuMCAtIG1pbkRvdCkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHcgPSB1ICogdSAqICgzIC0gMiAqIHUpOyAvLyBzbW9vdGhzdGVwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5sZXJwKHRvR29hbCwgYXNzaXN0RmFjdG9yICogdyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0ZpbmlzaGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMDU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNMQU0hIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9Cn0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMjIgKyAoMC4xMCAqIHNob3RBc3Npc3QpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAovLyBHb2FsaWUgTG9mdCBCb251cyAoUHJldmVudCBpbnRlcmNlcHRpb24gYnkgaW1tZWRpYXRlIGRlZmVuZGVyKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yb2xlID09PSAnR0wnKSBmaW5hbERpci55ICs9IDAuODsgLy8gSGlnaCBsb2Z0IGZvciBjbGVhcmFuY2UKCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5fZmluZFBhc3NUYXJnZXRJbkNvbmUoZmluYWxEaXIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0b01hdGUgPSB0YXJnZXQubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIExlYWQgdGhlIHJlY2VpdmVyIHNsaWdodGx5IChzY2FsZXMgd2l0aCBkaXN0YW5jZSwgY2FwcGVkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2V0dGluZ3MyID0gKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPKSA/IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPLnNldHRpbmdzIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IEFDMiA9IHdpbmRvdy5mbHV4LkFzc2lzdENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlYWRUQmFzZSA9IChBQzIuUEFTU19MRUFEX1RJTUUgIT09IHVuZGVmaW5lZCA/IEFDMi5QQVNTX0xFQURfVElNRSA6IDAuMjIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGVhZFQgPSBsZWFkVEJhc2UgKyBNYXRoLm1pbigwLjIwLCBkaXN0ICogMC4wMDcpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQudmVsb2NpdHkgJiYgdGFyZ2V0LnZlbG9jaXR5Lmxlbmd0aFNxICYmIHRhcmdldC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMC4wMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvTWF0ZS5hZGRTY2FsZWRWZWN0b3IodGFyZ2V0LnZlbG9jaXR5LCBsZWFkVCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b01hdGUubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGEgPSB0aGlzLmdldFN0YXQoJ1BBJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXNzQXNzaXN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgKHNldHRpbmdzMiAmJiB0eXBlb2Ygc2V0dGluZ3MyLnBhc3NBaW1Bc3Npc3QgPT09ICdudW1iZXInKSA/IHNldHRpbmdzMi5wYXNzQWltQXNzaXN0IDogKEFDMi5QQVNTX0FJTV9BU1NJU1QgIT09IHVuZGVmaW5lZCA/IEFDMi5QQVNTX0FJTV9BU1NJU1QgOiAwLjY1KSkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbmVEZWcgPSAoQUMyLlBBU1NfQ09ORV9ERUcgIT09IHVuZGVmaW5lZCA/IEFDMi5QQVNTX0NPTkVfREVHIDogNjApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWluRG90ID0gTWF0aC5jb3MoY29uZURlZyAqIE1hdGguUEkgLyAxODApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZG90TWF0ZSA9IE1hdGgubWF4KC0xLCBNYXRoLm1pbigxLCBmaW5hbERpci5kb3QodG9NYXRlKSkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBwYXNzQXNzaXN0ICogTWF0aC5taW4oMS4wLCAwLjM1ICsgKHBhIC8gODAuMCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHBsYXllciBleHBsaWNpdGx5IGFpbWVkLCByZWR1Y2UgaGVscCBidXQga2VlcCBzb21lIHRvIHByZXNlcnZlIGZsb3cuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lzdEZhY3RvciAqPSAwLjU1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb3RNYXRlID4gbWluRG90KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIChkb3RNYXRlIC0gbWluRG90KSAvICgxLjAgLSBtaW5Eb3QpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdyA9IHUgKiB1ICogKDMgLSAyICogdSk7IC8vIHNtb290aHN0ZXAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5sZXJwKHRvTWF0ZSwgYXNzaXN0RmFjdG9yICogdyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gTG9mdDogc2NhbGVzIHdpdGggZGlzdGFuY2UgKGhlbHBzIHRoZSByZWNlaXZlciByZWFkIGl0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIueSArPSBNYXRoLm1pbigwLjYsIGRpc3QgKiAwLjAzKSArICgwLjA1ICogcGFzc0Fzc2lzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR29hbGllIExvZnQgQm9udXMgZm9yIFBhc3NpbmcKLy8gR29hbGllIExvZnQgQm9udXMgZm9yIFBhc3NpbmcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgZmluYWxEaXIueSArPSAwLjg7IC8vIEhpZ2ggbG9mdCBmb3IgY2xlYXJhbmNlCiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRlY2hQYXlsb2FkICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCh0aGlzLCB0ZWNoTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKYmFsbC5zaG9vdChmaW5hbERpciwgc3RhdFZhbCwgdHlwZSwgdGVjaFBheWxvYWQsIHNwaW4pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEV4dHJhIGdyYWNlIHBlcmlvZCBmb3IgR29hbGllIHRvIHByZXZlbnQgcG9pbnQtYmxhbmsgaW50ZXJjZXB0aW9ucwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJvbGUgPT09ICdHTCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYmFsbC5jYXRjaEdyYWNlUGVyaW9kID0gMC42OyAvLyAwLjZzIGltbXVuaXR5IChhcHByb3ggMTAtMTJtIHRyYXZlbCkKICAgICAgICAgICAgICAgICAgICB9Cgp0aGlzLmxvc2VCYWxsKCk7Cgp0aGlzLmNhdGNoQ29vbGRvd24gPSAxLjA7IC8vIDFzIGNvb2xkb3duCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW5DYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB3aW5kdXBUaW1lKTsKCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CiAgICAgICAgICAgIH0sIHdpbmR1cFRpbWUgKyA1MDApOwogICAgICAgIH0KCiAgICAgICAgX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGFpbURpcikgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSkgcmV0dXJuIG51bGw7CgogICAgICAgICAgICBjb25zdCBzZXR0aW5ncyA9ICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTykgPyB3aW5kb3cuZmx1eC5fZGVidWdJTy5zZXR0aW5ncyA6IG51bGw7CiAgICAgICAgICAgIGNvbnN0IEFDID0gd2luZG93LmZsdXguQXNzaXN0Q29uZmlnIHx8IHt9OwogICAgICAgICAgICBjb25zdCBwYXNzQXNzaXN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgKHNldHRpbmdzICYmIHR5cGVvZiBzZXR0aW5ncy5wYXNzQWltQXNzaXN0ID09PSAnbnVtYmVyJykgPyBzZXR0aW5ncy5wYXNzQWltQXNzaXN0IDogKEFDLlBBU1NfQUlNX0FTU0lTVCAhPT0gdW5kZWZpbmVkID8gQUMuUEFTU19BSU1fQVNTSVNUIDogMC42NSkpKTsKCiAgICAgICAgICAgIC8vIFdpZGVyIGludGVudCBjb25lIGFzIGFzc2lzdCBpbmNyZWFzZXMgKHN0aWxsIHJlcXVpcmVzIHBvaW50aW5nIGdlbmVyYWxseSBhdCB0aGUgdGVhbW1hdGUpCiAgICAgICAgICAgIGNvbnN0IGNvbmVEZWcgPSAoQUMuUEFTU19DT05FX0RFRyAhPT0gdW5kZWZpbmVkID8gQUMuUEFTU19DT05FX0RFRyA6IDYwKTsKICAgICAgICAgICAgY29uc3QgY29uZU1pbkRvdCA9IE1hdGguY29zKGNvbmVEZWcgKiBNYXRoLlBJIC8gMTgwKTsKICAgICAgICAgICAgY29uc3QgbWluRG90ID0gKDAuNzUgKiAoMS4wIC0gcGFzc0Fzc2lzdCkpICsgKGNvbmVNaW5Eb3QgKiBwYXNzQXNzaXN0KTsKCiAgICAgICAgICAgIGxldCBiZXN0VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IGJlc3RTY29yZSA9IC1JbmZpbml0eTsKCiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtNDYgOiA0NjsKICAgICAgICAgICAgY29uc3QgZm9yd2FyZFNpZ24gPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKCiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKG1hdGUgPT09IHRoaXMgfHwgIW1hdGUubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAobWF0ZS5zdGF0dXMgJiYgbWF0ZS5zdGF0dXMubmFwID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAobWF0ZS5zdHVuVGltZXIgJiYgbWF0ZS5zdHVuVGltZXIgPiAwLjIpIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIGNvbnN0IHRvTWF0ZSA9IG1hdGUubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRvTWF0ZS5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgMC4wMDEpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgdG9NYXRlLm11bHRpcGx5U2NhbGFyKDEuMCAvIGRpc3QpOwoKICAgICAgICAgICAgICAgIGNvbnN0IGRvdCA9IGFpbURpci5kb3QodG9NYXRlKTsKICAgICAgICAgICAgICAgIGlmIChkb3QgPCBtaW5Eb3QpIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIC8vIFByZWZlcjogc3Ryb25nIGFsaWdubWVudCwgcmVhc29uYWJsZSBkaXN0YW5jZSwgZm9yd2FyZCBwcm9ncmVzcy4KICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RTY29yZSA9IDEuMCAtIE1hdGgubWluKDEuMCwgZGlzdCAvIDMwLjApOwogICAgICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBmb3J3YXJkU2lnbiAqIChtYXRlLm1lc2gucG9zaXRpb24ueiAtIHRoaXMubWVzaC5wb3NpdGlvbi56KTsKICAgICAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzU2NvcmUgPSBNYXRoLm1heCgtMS4wLCBNYXRoLm1pbigxLjAsIHByb2dyZXNzIC8gMTguMCkpOwoKICAgICAgICAgICAgICAgIC8vIFNsaWdodCBiaWFzIHRvd2FyZCBtYXRlcyBjbG9zZXIgdG8gb3Bwb25lbnQgZ29hbCAoZmVlbHMgbW9yZSAic3BvcnR5IiAvIGF0dGFja2luZykKICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxQcm94ID0gMS4wIC0gTWF0aC5taW4oMS4wLCBNYXRoLmFicyhtYXRlLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKSAvIDYwLjApOwoKICAgICAgICAgICAgICAgIGxldCBzY29yZSA9IChkb3QgKiAzLjApICsgKGRpc3RTY29yZSAqIDEuMikgKyAocHJvZ3Jlc3NTY29yZSAqIDAuOCkgKyAoZ29hbFByb3ggKiAwLjQpOwoKICAgICAgICAgICAgICAgIGlmIChzY29yZSA+IGJlc3RTY29yZSkgewogICAgICAgICAgICAgICAgICAgIGJlc3RTY29yZSA9IHNjb3JlOwogICAgICAgICAgICAgICAgICAgIGJlc3RUYXJnZXQgPSBtYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gYmVzdFRhcmdldDsKICAgICAgICB9CgpzdGFydENoYXJnZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgfHwgdGhpcy5pc1Rocm93aW5nIHx8IHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jaGFyZ2VUaW1lID0gMDsKCi8vIFZpc3VhbHMgaGFuZGxlZCBpbiB1cGRhdGUKCiAgICAgICAgICAgIC8vIFNob3cgY2hhcmdlIFVJCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUNoYXJnZVVJKDApOwoKICAgICAgICAgICAgLy8gTkVXOiBTcGF3biBDaGFyZ2UgR2x5cGggKEdyb3VuZCBSaW5nKQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ2NoYXJnZScsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICBsaWZlOiB0aGlzLm1heENoYXJnZVRpbWUsCiAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogMy4wLAogICAgICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IDAuMiwKICAgICAgICAgICAgICAgICAgICBvZmZzZXRZOiAwLjEKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKcmVsZWFzZUNoYXJnZShkeCwgZHksIGN1cnZlSW5wdXQgPSBudWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc0NoYXJnaW5nKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUG93ZXIgQ2FsY3VsYXRpb24KICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1pbih0aGlzLmNoYXJnZVRpbWUgLyB0aGlzLm1heENoYXJnZVRpbWUsIDEuMCk7CiAgICAgICAgICAgIGNvbnN0IFRDID0gd2luZG93LmZsdXguVGhyb3dDb25maWcgfHwge307CgogICAgICAgICAgICAvLyBCYXNlIG11bHRpcGxpZXIgKGRlZmF1bHRzOiAxLjAgdG8gMS44KQogICAgICAgICAgICBsZXQgbXVsdGlwbGllciA9IChUQy5QT1dFUl9CQVNFICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9CQVNFIDogMS4wKSArIChyYXRpbyAqIChUQy5QT1dFUl9SQU5HRSAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfUkFOR0UgOiAwLjgpKTsvLyBNQVggUE9XRVIgQk9OVVM6IElmIGhlbGQgbmVhciBtYXgsIHNpZ25pZmljYW50IGJvb3N0CiAgICAgICAgICAgIGlmIChyYXRpbyA+IChUQy5QT1dFUl9NQVhfQk9OVVNfUkFUSU8gIT09IHVuZGVmaW5lZCA/IFRDLlBPV0VSX01BWF9CT05VU19SQVRJTyA6IDAuOTUpKSB7CiAgICAgICAgICAgICAgICBtdWx0aXBsaWVyID0gKFRDLlBPV0VSX01BWF9NVUxUSVBMSUVSICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9NQVhfTVVMVElQTElFUiA6IDIuNSk7IC8vIENyaXRpY2FsIFBvd2VyCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIk1BWCBQT1dFUiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZEZvdkltcHVsc2UoLTEwKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKCiAgICAgICAgICAgIC8vIEFpbSBWZWN0b3IgQ2FsY3VsYXRpb24KICAgICAgICAgICAgbGV0IGFpbVZlYyA9IG51bGw7CiAgICAgICAgICAgIGNvbnN0IHN3aXBlTGVuID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwoKICAgICAgICAgICAgaWYgKHN3aXBlTGVuID4gKFRDLlNXSVBFX01JTl9QWCAhPT0gdW5kZWZpbmVkID8gVEMuU1dJUEVfTUlOX1BYIDogMjApKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjYW1lcmEgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhOwogICAgICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgICAgICBpZiAoY2FtZXJhKSB7CiAgICAgICAgICAgICAgICAgICAgY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKGZ3ZCk7CiAgICAgICAgICAgICAgICAgICAgZndkLnkgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmIChmd2QubGVuZ3RoU3EoKSA8IDAuMDAxKSBmd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGZ3ZC5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgcmlnaHQuY3Jvc3NWZWN0b3JzKGZ3ZCwgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCkpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICAgICAgd29ybGRWZWMuYWRkU2NhbGVkVmVjdG9yKHJpZ2h0LCBkeCAqIChUQy5BSU1fRFhfU0NBTEUgIT09IHVuZGVmaW5lZCA/IFRDLkFJTV9EWF9TQ0FMRSA6IDEuMCkpOwogICAgICAgICAgICAgICAgICAgIHdvcmxkVmVjLmFkZFNjYWxlZFZlY3Rvcihmd2QsIC1keSAqIChUQy5BSU1fRFlfU0NBTEUgIT09IHVuZGVmaW5lZCA/IFRDLkFJTV9EWV9TQ0FMRSA6IDEuMCkpOwogICAgICAgICAgICAgICAgICAgIHdvcmxkVmVjLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBhaW1WZWMgPSB3b3JsZFZlYzsKICAgICAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gYWltVmVjOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBhaW1WZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYWltVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBudWxsOwogICAgICAgICAgICB9CgovLyAtLS0gQU5BTE9HIENVUlZFIExPR0lDIC0tLQogICAgICAgICAgICAvLyBGb3JtdWxhOiBDdXJ2ZSA9IEludGVuc2l0eSAqIFNwZWVkCiAgICAgICAgICAgIGxldCBzcGluVmVjID0gbnVsbDsKICAgICAgICAgICAgCmlmICgoVEMuQ1VSVkVfRU5BQkxFRCAhPT0gZmFsc2UpICYmIGN1cnZlSW5wdXQgJiYgTWF0aC5hYnMoY3VydmVJbnB1dC5pbnRlbnNpdHkpID4gKFRDLkNVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQgOiAwLjI1KSkgewogICAgICAgICAgICAgICAgY29uc3QgcmF3SW50ZW5zaXR5ID0gTWF0aC5hYnMoY3VydmVJbnB1dC5pbnRlbnNpdHkpOwogICAgICAgICAgICAgICAgY29uc3Qgc2lnbiA9IE1hdGguc2lnbihjdXJ2ZUlucHV0LmludGVuc2l0eSk7IC8vIFBvc2l0aXZlID0gUmlnaHQgSHVtcCA9IExlZnQgQ3VydmUKICAgICAgICAgICAgICAgIGNvbnN0IHN3aXBlU3BlZWQgPSBjdXJ2ZUlucHV0LnNwZWVkIHx8IDEuMDsKCiAgICAgICAgICAgICAgICAvLyAxLiBCYXNlIFNwaW4gZnJvbSBBcmMgKFR1bmVkIGZvciByZWFsaXNtLCBubyBjeWNsb25lcykKLy8gMS4gQmFzZSBTcGluIGZyb20gQXJjIChIZXJjdWxlYW4gQm9vc3QpCiAgICAgICAgICAgICAgICBsZXQgc3Bpbk1hZyA9IHJhd0ludGVuc2l0eSAqIChUQy5DVVJWRV9TUElOX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9TUElOX1NDQUxFIDogMTAwMC4wKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBTcGVlZCBCb251cyAoUXVpY2tuZXNzIGFkZHMgUlBNKQogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWRCb251cyA9IE1hdGgubWF4KDEuMCwgc3dpcGVTcGVlZCAqIChUQy5DVVJWRV9TUEVFRF9NVUxUICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9TUEVFRF9NVUxUIDogMS41KSk7CiAgICAgICAgICAgICAgICBzcGluTWFnICo9IHNwZWVkQm9udXM7CgogICAgICAgICAgICAgICAgLy8gQ2FwIChJbmNyZWFzZWQgdG8gMTUwMCBmb3IgbWFzc2l2ZSBhcmNzKQogICAgICAgICAgICAgICAgc3Bpbk1hZyA9IE1hdGgubWluKChUQy5DVVJWRV9TUElOX0NBUCAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BJTl9DQVAgOiAxNTAwLjApLCBzcGluTWFnKTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSBTcGluCiAgICAgICAgICAgICAgICAvLyBSaWdodCBIdW1wIChQb3NpdGl2ZSBJbnRlbnNpdHkpIC0+IExlZnQgQ3VydmUgKFBvc2l0aXZlIFNwaW4gWSkKICAgICAgICAgICAgICAgIHNwaW5WZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCBzcGluTWFnICogc2lnbiwgMCk7CiAgICAgICAgICAgICAgICAKaWYgKHNwaW5NYWcgPiAoVEMuQ1VSVkVfUEVSRkVDVF9TUElOICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9QRVJGRUNUX1NQSU4gOiA1MDAuMCkgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlBFUkZFQ1QgQ1VSVkUiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFJvbGxJbXB1bHNlKHNpZ24gKiAtMC4zKTsgLy8gVGlsdCBjYW1lcmEgaW50byB0aGUgY3VydmUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERldGVybWluZSBUeXBlIChQYXNzIHZzIFNob290KQovLyBEZXRlcm1pbmUgVHlwZSAoUGFzcyB2cyBTaG9vdCkKICAgICAgICAgICAgY29uc3QgZ29hbFogPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC00NiA6IDQ2OwogICAgICAgICAgICBjb25zdCBnb2FsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbFogLSB0aGlzLm1lc2gucG9zaXRpb24ueikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGNvbnN0IGRvdEdvYWwgPSBhaW1WZWMuZG90KGdvYWxEaXIpOwoKICAgICAgICAgICAgbGV0IHR5cGUgPSAnUEEnOwogICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CgogICAgICAgICAgICBpZiAoZG90R29hbCA+IDAuOCAmJiBkaXN0VG9Hb2FsIDwgMzUuMCkgewogICAgICAgICAgICAgICAgdHlwZSA9ICdTSCc7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZG90R29hbCA+IDAuNSAmJiBkaXN0VG9Hb2FsIDwgMjAuMCkgewogICAgICAgICAgICAgICAgdHlwZSA9ICdTSCc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNtYXJ0IFBhc3MgT3ZlcnJpZGUKICAgICAgICAgICAgY29uc3QgdGFyZ2V0TWF0ZSA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGFpbVZlYyk7CiAgICAgICAgICAgIGlmICh0YXJnZXRNYXRlICYmIHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RNYXRlID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGFyZ2V0TWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0TWF0ZSA8IDEyLjApIHR5cGUgPSAnUEEnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmIChiYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCB0eXBlLCBtdWx0aXBsaWVyLCBzcGluVmVjKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBDaGFyZ2UgVUkgbWV0aG9kcwogICAgICAgIF91cGRhdGVDaGFyZ2VVSShyYXRpbykgewogICAgICAgICAgICBjb25zdCBtZXRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItZmlsbCcpOwogICAgICAgICAgICBpZiAobWV0ZXIpIHsKICAgICAgICAgICAgICAgIG1ldGVyLnN0eWxlLndpZHRoID0gYCR7cmF0aW8gKiAxMDB9JWA7CiAgICAgICAgICAgICAgICBpZiAocmF0aW8gPiAwLjkpIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmMCwgI2Y4MCknOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyYXRpbyA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIG1ldGVyLnN0eWxlLmJhY2tncm91bmQgPSAnbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjMGYwLCAjZmYwKSc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1ldGVyLnN0eWxlLmJhY2tncm91bmQgPSAnbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjMGFmLCAjMGYwKSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NoYXJnZS1tZXRlci1jb250YWluZXInKTsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lcikgY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgIH0KCiAgICAgICAgX2hpZGVDaGFyZ2VVSSgpIHsKICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NoYXJnZS1tZXRlci1jb250YWluZXInKTsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lcikgY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQoKICAgICAgICBzZXRPdmVycmlkZUFpbSh4LCB6KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5vdmVycmlkZUFpbVZlY3RvcikgdGhpcy5vdmVycmlkZUFpbVZlY3RvciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3Iuc2V0KHgsIDAsIHopLm5vcm1hbGl6ZSgpOwogICAgICAgIH0KCmxvc2VCYWxsKCkgewogICAgICAgICAgICB0aGlzLmhhc0JhbGwgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCk7CiAgICAgICAgICAgIC8vIEZpeDogRW5zdXJlIHBsYXllciBjYW4gY2F0Y2ggYWdhaW4gaWYgdGhleSBsb3NlIHBvc3Nlc3Npb24gdW5leHBlY3RlZGx5CiAgICAgICAgICAgIHRoaXMuY2FuQ2F0Y2ggPSB0cnVlOwogICAgICAgICAgICAvLyBTYWZldHk6IFJlc2V0IHN0YXRlcyB0byBwcmV2ZW50IGxvY2tpbmcKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKICAgICAgICB9Cgp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIFNZTkMgRklYOiBJZiBiYWxsIHRoaW5rcyBJIGhvbGQgaXQsIGJ1dCBJIGRvbid0LCBmb3JjZSByZWNlaXZlCiAgICAgICAgICAgIGlmICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLmhvbGRlciA9PT0gdGhpcyAmJiAhdGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIlN5bmNpbmcgYmFsbCBwb3NzZXNzaW9uIHRvIHBsYXllciIpOwogICAgICAgICAgICAgICAgdGhpcy5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIElucHV0IHNtb290aGluZyAobGVzcyB0d2l0Y2h5IC8gbW9yZSAic3dpbW15IikKICAgICAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX2RlYnVnSU8pID8gd2luZG93LmZsdXguX2RlYnVnSU8uc2V0dGluZ3MgOiBudWxsOwogICAgICAgICAgICBjb25zdCBBQyA9IHdpbmRvdy5mbHV4LkFzc2lzdENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgY29uc3QgaW5wdXRSZXNwID0gKHNldHRpbmdzICYmIHR5cGVvZiBzZXR0aW5ncy5pbnB1dFJlc3BvbnNlID09PSAnbnVtYmVyJykgPyBzZXR0aW5ncy5pbnB1dFJlc3BvbnNlIDogKEFDLklOUFVUX1JFU1BPTlNFICE9PSB1bmRlZmluZWQgPyBBQy5JTlBVVF9SRVNQT05TRSA6IDE0LjApOwogICAgICAgICAgICBjb25zdCBzdGVlcmluZ0Fzc2lzdCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIChzZXR0aW5ncyAmJiB0eXBlb2Ygc2V0dGluZ3Muc3RlZXJpbmdBc3Npc3QgPT09ICdudW1iZXInKSA/IHNldHRpbmdzLnN0ZWVyaW5nQXNzaXN0IDogKEFDLlNURUVSSU5HX0FTU0lTVCAhPT0gdW5kZWZpbmVkID8gQUMuU1RFRVJJTkdfQVNTSVNUIDogMC4wKSkpOwoKICAgICAgICAgICAgLy8gSGlnaGVyIHNwZWVkIC0+IGEgdG91Y2ggbW9yZSBkYW1waW5nIHNvIHlvdSdyZSBub3Qgb3Zlci1zdGVlcmluZy4KICAgICAgICAgICAgY29uc3Qgc3BlZWROb3cgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICBjb25zdCByZXNwID0gTWF0aC5tYXgoNC4wLCBpbnB1dFJlc3AgKiAoMS4wICsgMC4yNSAqIHN0ZWVyaW5nQXNzaXN0KSAqIChzcGVlZE5vdyA+IDYuMCA/IDAuODUgOiAxLjApKTsKICAgICAgICAgICAgY29uc3QgdElucHV0ID0gMSAtIE1hdGgucG93KDAuMDAxLCBkdCAqIHJlc3ApOwogICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLmxlcnAodGhpcy5kZXNpcmVkSW5wdXRWZWN0b3IsIHRJbnB1dCk7CgogICAgICAgICAgICBpZiAodGhpcy5pc0dvZE1vZGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgPSB0aGlzLnN0YXRzLm1heEhQOwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSB0aGlzLmdldFN0YXQoJ0VOJyk7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy52ZW5vbSA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5uYXAgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBbmltYXRpb246IGxheWVyZWQgbWl4aW5nIChiYXNlIGxvY29tb3Rpb24gKyB1cHBlci1ib2R5IG92ZXJsYXkgKyBvbmUtc2hvdHMpCiAgICAgICAgICAgIGlmICh0aGlzLl9sYXllcmVkRW5hYmxlZCkgdGhpcy5fdXBkYXRlTGF5ZXJlZEFuaW1hdGlvbihkdCk7CiAgICAgICAgICAgIGVsc2UgdGhpcy5fdXBkYXRlTG9jb21vdGlvbkFuaW0oMC4yKTsKCiAgICAgICAgICAgIGlmICh0aGlzLm1peGVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1peGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXMoZHQpOwoKICAgICAgICAgICAgLy8gQ2hhcmdlIExvZ2ljCi8vIENoYXJnZSBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaGFzQmFsbCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0U2NhbGFyKHRoaXMuYmFzZVNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CnRoaXMuY2hhcmdlVGltZSArPSBkdDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBVVRPLVJFTEVBU0U6IElmIGhlbGQgdG9vIGxvbmcgKDNzKSwgZm9yY2UgcmVsZWFzZSB0byBwcmV2ZW50IHN0dWNrIHN0YXRlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2hhcmdlVGltZSA+IDMuMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbGVhc2VDaGFyZ2UoMCwgMCk7IC8vIEZvcmNlIHdlYWsgc2hvdAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHRoaXMuY2hhcmdlVGltZSAvIHRoaXMubWF4Q2hhcmdlVGltZSwgMS4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMZXZpdGF0aW9uIChQb3dlcmluZyB1cCkKICAgICAgICAgICAgICAgICAgICBjb25zdCBob3ZlciA9IChNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMikgKiAwLjEpICsgKHJhdGlvICogMC44KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBWaWJyYXRpb24gKEludGVuc2l0eSBpbmNyZWFzZXMgd2l0aCBjaGFyZ2UpCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hha2UgPSAwLjA1ICsgKDAuMSAqIHJhdGlvKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBcHBseSBZIG9mZnNldCAoSG92ZXIgKyBKaXR0ZXIpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSBob3ZlciArIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEFwcGx5IFJvdGF0aW9uIEppdHRlciAodmlhIGJhbmtpbmcvcGl0Y2ggdmFyaWFibGVzKQogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgYXZvaWRzIHBvc2l0aW9uYWwgZHJpZnQgd2hpbGUgZ2l2aW5nIGEgInN0cnVnZ2xpbmcgdG8gY29udGFpbiBwb3dlciIgbG9vawogICAgICAgICAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlOwoKICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgc2NhbGUgc3RheXMgbm9ybWFsIChSZW1vdmUgc3dlbGxpbmcgZWZmZWN0KQogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5zY2FsZS5zZXRTY2FsYXIodGhpcy5iYXNlU2NhbGUpOwoKICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSShyYXRpbyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KaWYgKHRoaXMuZGFzaENvb2xkb3duID4gMCkgdGhpcy5kYXNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmNsYXNoQ29vbGRvd24gPiAwKSB0aGlzLmNsYXNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLnN0dW5UaW1lciA+IDApIHRoaXMuc3R1blRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5pbW11bml0eVRpbWVyID4gMCkgdGhpcy5pbW11bml0eVRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5jYXRjaENvb2xkb3duID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2F0Y2hDb29sZG93biA8PSAwKSB0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBEYXNoIExvZ2ljCi8vIERhc2ggTG9naWMKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUaW1lIC09IGR0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLl9kYXNoUGFydGljbGVUaW1lciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9kYXNoUGFydGljbGVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZGFzaFBhcnRpY2xlVGltZXIgPSAwLjAzOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWNrID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmFjay5sZW5ndGhTcSgpIDwgMC4xKSBiYWNrLnNldCgwLCAwLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChiYWNrLm11bHRpcGx5U2NhbGFyKDAuNSkpOwogICAgICAgICAgICAgICAgICAgICAgICBwb3MueSArPSAxLjAgKyAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcy54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwb3MsIHsgc2NhbGU6IDIuNSB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gU21vb3RoIFJvdGF0aW9uIGR1cmluZyBEYXNoCiAgICAgICAgICAgICAgICBsZXQgZGlmZiA9IHRoaXMudGFyZ2V0WWF3IC0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICAgICAgd2hpbGUgKGRpZmYgPiBNYXRoLlBJKSBkaWZmIC09IE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgd2hpbGUgKGRpZmYgPCAtTWF0aC5QSSkgZGlmZiArPSBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgdHVyblNwZWVkID0gMTUuMDsgLy8gRmFzdCB0dXJuaW5nIGZvciBkYXNoCiAgICAgICAgICAgICAgICBjb25zdCBjaGFuZ2UgPSBNYXRoLm1heCgtdHVyblNwZWVkICogZHQsIE1hdGgubWluKHR1cm5TcGVlZCAqIGR0LCBkaWZmKSk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgKz0gY2hhbmdlOwoKICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrVGFja2xlQ29sbGlzaW9uKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUaW1lIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGFzaFR5cGUgPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLmRhc2hWZWMpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAxIC0gKHRoaXMuZGFzaFRpbWUgLyB0aGlzLmRhc2hUb3RhbFRpbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IE1hdGguc2luKHQgKiBNYXRoLlBJKSAqIDMuMDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBIb3Jpem9udGFsIERhc2ggTW92ZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IDA7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBWaXN1YWwgVGFja2xlIExlYW4gKFNob3VsZGVyIEJhc2ggQW5pbWF0aW9uKQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gMSAtICh0aGlzLmRhc2hUaW1lIC8gdGhpcy5kYXNoVG90YWxUaW1lKTsgLy8gMCB0byAxCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlYW4gPSBNYXRoLnNpbih0ICogTWF0aC5QSSk7IC8vIFBlYWsgYXQgMS4wIGluIG1pZGRsZQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmUtYXBwbHkgYmFzZSBmYWNpbmcgKyBBZ2dyZXNzaXZlIFNob3VsZGVyIENoZWNrCi8vIFJlLWFwcGx5IGJhc2UgZmFjaW5nICsgQWdncmVzc2l2ZSBTaG91bGRlciBDaGVjawogICAgICAgICAgICAgICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCB0aGlzLmN1cnJlbnRZYXcgKyB0aGlzLnJvdGF0aW9uT2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaXRjaCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB5YXcgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcm9sbCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBsdW5nZUFtdCA9IDA7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXNoVHlwZSA9PT0gJ2hvcml6b250YWwnIHx8IHRoaXMuZGFzaFR5cGUgPT09ICdicmVhaycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUQUNLTEUvQlJFQUs6IEFnZ3Jlc3NpdmUgU2hvdWxkZXIgQ2hlY2sKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaXRjaCA9IDEuMiAqIGxlYW47IC8vIEhlYWQgZG93biAvIExlYW4gZm9yd2FyZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlhdyA9IDAuOCAqIGxlYW47ICAgLy8gVHVybiBzaG91bGRlciBpbnRvIHRhcmdldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvbGwgPSAtMC42ICogbGVhbjsgLy8gRGlwIHNob3VsZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbHVuZ2VBbXQgPSAwLjggKiBsZWFuOyAvLyBUaHJ1c3QgbWVzaCBmb3J3YXJkIHZpc3VhbGx5CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5kYXNoVHlwZSA9PT0gJ3NwcmludCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTUFJJTlQ6IEFlcm9keW5hbWljIGxlYW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaXRjaCA9IDAuNSAqIGxlYW47IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGx1bmdlQW10ID0gMC4yICogbGVhbjsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXBwbHkgTHVuZ2UgKFZpc3VhbCBPZmZzZXQpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsdW5nZUFtdCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfcFZlYy5zZXQoMCwgMCwgbHVuZ2VBbXQpLmFwcGx5UXVhdGVybmlvbihfcFF1YXQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBfcEV1bGVyLnNldChwaXRjaCwgeWF3LCByb2xsKTsKICAgICAgICAgICAgICAgICAgICAgICAgX3BRdWF0Mi5zZXRGcm9tRXVsZXIoX3BFdWxlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5UXVhdGVybmlvbnMoX3BRdWF0LCBfcFF1YXQyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC45Nik7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOTYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBTdHVuL05hcCBDaGVjawogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRyYWdGYWN0b3IgPSBNYXRoLm1heCgwLCAxIC0gKDIuMCAqIGR0KSk7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKGRyYWdGYWN0b3IpOwoKICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CgogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9sYXllcmVkRW5hYmxlZCAmJiAhdGhpcy5fYW5pbUxvY2tlZCAmJiB0aGlzLnN0YXRlICE9PSAnaWRsZScgJiYgdGhpcy5zdGF0ZSAhPT0gJ2NhdGNoJykgdGhpcy5wbGF5KCdpZGxlJywgMC41KTsKCiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIUEJhcigpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVQcmVzc3VyZShkdCk7CgogICAgICAgICAgICBpZiAodGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICgyLjAgKiBkdCkpKTsKCiAgICAgICAgICAgICAgICB0aGlzLl9hcHBseVNvZnRDb2xsaXNpb24oZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlHb2FsQ3JlYXNlKGR0KTsKCiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwoKdGhpcy5fdXBkYXRlVmVydGljYWxpdHkoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQmFua2luZyhkdCk7IC8vIEVuYWJsZSByb3RhdGlvbiBkdXJpbmcgdGhyb3cKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZlcnRpY2FsaXR5KGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUJhbmtpbmcoZHQpOwogICAgICAgICAgICB9Cgp0aGlzLl91cGRhdGVIUEJhcigpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwoKICAgICAgICAgICAgLy8gQnViYmxlIFRyYWlsIExvZ2ljCi8vIEJ1YmJsZSBUcmFpbCBMb2dpYyAoRHluYW1pYykKICAgICAgICAgICAgY29uc3Qgc3BlZWRTcSA9IHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHNwZWVkU3EgPiAxLjAgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2J1YmJsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFja0RpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAxLiBTdGFuZGFyZCBXYWtlIChBbHdheXMgc3Bhd24pCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gYmFja0Rpci5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKDAuOCk7CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LnkgPSAwLjUgKyBNYXRoLnJhbmRvbSgpICogMC41OyAKICAgICAgICAgICAgICAgICAgICBvZmZzZXQueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgIG9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZScsIHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLCB7IHNjYWxlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMjUgfSk7CgogICAgICAgICAgICAgICAgICAgIC8vIDIuIENhdml0YXRpb24gKEhpZ2ggU3BlZWQpIC0gQWRkIG9uIHRvcAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzSGlnaFNwZWVkID0gc3BlZWRTcSA+IDQwLjA7IAogICAgICAgICAgICAgICAgICAgIGlmIChpc0hpZ2hTcGVlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1PZmZzZXQgPSBiYWNrRGlyLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC41ICsgTWF0aC5yYW5kb20oKSowLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC55ID0gMC41ICsgKE1hdGgucmFuZG9tKCktMC41KSowLjg7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlX21pY3JvJywgdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG1PZmZzZXQpLCB7IHNjYWxlOiAwLjA2ICsgTWF0aC5yYW5kb20oKSowLjA4IH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4wMzsgCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwLjE7IAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQp9CgogICAgICAgIF91cGRhdGVTdGF0dXMoZHQpIHsKICAgICAgICAgICAgY29uc3QgcG0gPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyIDogbnVsbDsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy52ZW5vbSA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLnZlbm9tIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSA1ICogZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA8IDApIHRoaXMuc3RhdHMuSFAgPSAwOwoKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnZlbm9tIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BhcnRpY2xlVGltZXJzLnZlbm9tIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bigndmVub20nLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnZlbm9tID0gMC4xNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsICYmIHRoaXMuc3RhdHMuSFAgPCB0aGlzLnN0YXRzLm1heEhQKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCArPSA1ICogZHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPiB0aGlzLnN0YXRzLm1heEhQKSB0aGlzLnN0YXRzLkhQID0gdGhpcy5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSAyLjAgKiBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQIDwgMCkgdGhpcy5zdGF0cy5IUCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5uYXAgLT0gZHQ7CgogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMubmFwIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BhcnRpY2xlVGltZXJzLm5hcCA8PSAwICYmIHBtKSB7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ25hcCcsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMubmFwID0gMC44OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgaXNXaXRoZXJpbmcgPSBmYWxzZTsKICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHRoaXMuc3RhdHVzLndpdGhlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltrZXldID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLndpdGhlcltrZXldIC09IGR0OwogICAgICAgICAgICAgICAgICAgIGlzV2l0aGVyaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGlzV2l0aGVyaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMud2l0aGVyIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignd2l0aGVyJywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgPSAwLjI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbHMoKTsKICAgICAgICB9CgpfdXBkYXRlVmlzdWFscygpIHsKICAgICAgICAgICAgLy8gUkVNT1ZFRDogWWVsbG93IHNwaGVyZS90aW50IGxvZ2ljIGFzIHBlciByZXF1ZXN0LgogICAgICAgICAgICAvLyBBbHdheXMgcmV2ZXJ0IHRvIGJhc2UgY29sb3IuCiAgICAgICAgICAgIHRoaXMub3JpZ2luYWxNYXRlcmlhbHMuZm9yRWFjaChlbnRyeSA9PiB7CiAgICAgICAgICAgICAgICBlbnRyeS5tYXRlcmlhbC5jb2xvci5jb3B5KGVudHJ5LmJhc2VDb2xvcik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgX2NyZWF0ZUF1cmEoKSB7CiAgICAgICAgICAgIC8vIEF1cmEgcmVtb3ZlZCBwZXIgdXNlciByZXF1ZXN0CiAgICAgICAgICAgIHRoaXMuYXVyYU1lc2ggPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBQYXNzIHRhcmdldCBpbmRpY2F0b3IKICAgICAgICBfY3JlYXRlUGFzc1RhcmdldEluZGljYXRvcigpIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIGEgcmluZyB0aGF0IGhpZ2hsaWdodHMgcG90ZW50aWFsIHBhc3MgdGFyZ2V0cwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUmluZ0dlb21ldHJ5KDAuOCwgMS4wLCAxNik7CiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBjb2xvcjogMHgwMGZmMDAsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuNiwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvciA9IG5ldyBUSFJFRS5NZXNoKGdlbywgbWF0KTsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnJvdGF0aW9uLnggPSAtTWF0aC5QSSAvIDI7CiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci5wb3NpdGlvbi55ID0gMC4xOwogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaGFzQmFsbCB8fCAhdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRmluZCBiZXN0IHBhc3MgdGFyZ2V0CiAgICAgICAgICAgIGNvbnN0IGFpbURpciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGFpbURpcik7CgogICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5tZXNoICYmIHRoaXMucGFzc1RhcmdldEluZGljYXRvcikgewogICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnBvc2l0aW9uLnggPSB0YXJnZXQubWVzaC5wb3NpdGlvbi54OwogICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnBvc2l0aW9uLnogPSB0YXJnZXQubWVzaC5wb3NpdGlvbi56OwogICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnBvc2l0aW9uLnkgPSAwLjE7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3Iucm90YXRpb24ueiArPSAwLjA1OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5faGlkZVBhc3NUYXJnZXRJbmRpY2F0b3JzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9oaWRlUGFzc1RhcmdldEluZGljYXRvcnMoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpfYXBwbHlTb2Z0Q29sbGlzaW9uKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoIHx8ICF3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IHRlYW1zID0gW2dhbWUudGVhbXMuaG9tZSwgZ2FtZS50ZWFtcy5hd2F5XTsKCiAgICAgICAgICAgIGNvbnN0IHJlcHVsc2lvblJhZGl1cyA9IDAuNTsgLy8gUmVkdWNlZCB0byAwLjUgdG8gZml4IGludmlzaWJsZSB3YWxsIGlzc3VlcwogICAgICAgICAgICBjb25zdCBzdGlmZm5lc3MgPSAxNS4wOwoKICAgICAgICAgICAgdGVhbXMuZm9yRWFjaCh0ZWFtID0+IHsKICAgICAgICAgICAgICAgIGlmICghdGVhbSkgcmV0dXJuOwogICAgICAgICAgICAgICAgdGVhbS5wbGF5ZXJzLmZvckVhY2gob3RoZXIgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChvdGhlciA9PT0gdGhpcyB8fCAhb3RoZXIubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBkeCA9IHRoaXMubWVzaC5wb3NpdGlvbi54IC0gb3RoZXIubWVzaC5wb3NpdGlvbi54OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGR5ID0gdGhpcy5tZXNoLnBvc2l0aW9uLnkgLSBvdGhlci5tZXNoLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHogPSB0aGlzLm1lc2gucG9zaXRpb24ueiAtIG90aGVyLm1lc2gucG9zaXRpb24uejsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdFNxID0gZHgqZHggKyBkeSpkeSArIGR6KmR6OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1pbkRpc3QgPSByZXB1bHNpb25SYWRpdXMgKiAyLjA7CgogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0U3EgPCBtaW5EaXN0ICogbWluRGlzdCAmJiBkaXN0U3EgPiAwLjAwMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkaXN0U3EpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvdmVybGFwID0gbWluRGlzdCAtIGRpc3Q7CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmb3JjZSA9IG92ZXJsYXAgKiBzdGlmZm5lc3M7CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBueCA9IGR4IC8gZGlzdDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbnkgPSBkeSAvIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG56ID0gZHogLyBkaXN0OwoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9IG54ICogZm9yY2UgKiBkdDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICs9IG55ICogZm9yY2UgKiBkdDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9IG56ICogZm9yY2UgKiBkdDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICB0aGlzLl9hcHBseVNvZnRDb2xsaXNpb24oZHQpOwp0aGlzLl9hcHBseUdvYWxDcmVhc2UoZHQpOwoKICAgICAgICAgICAgY29uc3QgaW5wdXRMZW5TcSA9IHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKTsKICAgICAgICAgICAgY29uc3QgaXNJbnB1dEFjdGl2ZSA9IGlucHV0TGVuU3EgPiAwLjAxOwoKICAgICAgICAgICAgbGV0IGN1cnJlbnRNYXhTcGVlZCA9IHRoaXMubWF4U3BlZWQ7CmlmICh0aGlzLmlzRW5nYWdlZCkgY3VycmVudE1heFNwZWVkICo9IDAuODsgLy8gQnVmZmVkIGZyb20gMC41IHRvIGFsbG93IGVzY2FwZQogICAgICAgICAgICBpZiAodGhpcy5pc0NoYXJnaW5nKSBjdXJyZW50TWF4U3BlZWQgKj0gMC45OwoKICAgICAgICAgICAgaWYgKGlzSW5wdXRBY3RpdmUpIHsKICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5pbnB1dFZlY3Rvcikubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0VmVsWCA9IF9wVmVjLnggKiBjdXJyZW50TWF4U3BlZWQ7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRWZWxaID0gX3BWZWMueiAqIGN1cnJlbnRNYXhTcGVlZDsKCiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50U3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWRSYXRpbyA9IE1hdGgubWluKDEuMCwgY3VycmVudFNwZWVkIC8gdGhpcy5tYXhTcGVlZCk7CgogICAgICAgICAgICAgICAgY29uc3QgYWdpbGl0eSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDEwLjAsIDIuMCwgc3BlZWRSYXRpbyk7CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IDEuMCAtIE1hdGgucG93KDAuMDEsIGR0ICogYWdpbGl0eSk7CgogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9ICh0YXJnZXRWZWxYIC0gdGhpcy52ZWxvY2l0eS54KSAqIHQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gKHRhcmdldFZlbFogLSB0aGlzLnZlbG9jaXR5LnopICogdDsKCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2xheWVyZWRFbmFibGVkICYmICF0aGlzLl9hbmltTG9ja2VkICYmIHRoaXMuc3RhdGUgIT09ICdzd2ltJykgdGhpcy5wbGF5KCdzd2ltJywgMC4yKTsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBicmFrZUZhY3RvciA9IDIuMDsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAxLjAgLSBNYXRoLnBvdygwLjEsIGR0ICogYnJha2VGYWN0b3IpOwoKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSAoMCAtIHRoaXMudmVsb2NpdHkueCkgKiB0OwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9ICgwIC0gdGhpcy52ZWxvY2l0eS56KSAqIHQ7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKSA8IDAuMDEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCB0aGlzLnZlbG9jaXR5LnksIDApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghdGhpcy5fbGF5ZXJlZEVuYWJsZWQgJiYgIXRoaXMuX2FuaW1Mb2NrZWQgJiYgdGhpcy5zdGF0ZSAhPT0gJ2lkbGUnICYmIHRoaXMuc3RhdGUgIT09ICdjYXRjaCcgJiYgdGhpcy5zdGF0ZSAhPT0gJ3Rocm93JyAmJiB0aGlzLnN0YXRlICE9PSAncmVhY3QnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5KCdpZGxlJywgMC4zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IE1hdGgubWF4KDAsIDEuMCAtICgyLjAgKiBkdCkpOwoKICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLnZlbG9jaXR5KS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVZlcnRpY2FsaXR5KGR0KSB7CiAgICAgICAgICAgIGxldCB0YXJnZXRZID0gMDsKCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKCiAgICAgICAgICAgIGlmIChiYWxsICYmIGJhbGwubWVzaCAmJiAhdGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9CYWxsID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMTUuMCkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldFkgPSBiYWxsLm1lc2gucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGFyZ2V0WSA9IDAuNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgeURpZmYgPSB0YXJnZXRZIC0gdGhpcy5tZXNoLnBvc2l0aW9uLnk7CgogICAgICAgICAgICBjb25zdCBsaWZ0ID0geURpZmYgKiAxMC4wICogZHQ7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSArPSBsaWZ0OwoKICAgICAgICAgICAgaWYgKHRoaXMubWVzaC5wb3NpdGlvbi55ID4gOC4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IDguMDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSAtMC41OwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubWVzaC5wb3NpdGlvbi55IDwgLTguMCkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSAtOC4wOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IC0wLjU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEZJWEVEOiBJbXByb3ZlZCBiYW5raW5nIHdpdGggaHlzdGVyZXNpcyB0byBwcmV2ZW50IGZhY2luZyBmbGlwcwovLyBGSVhFRDogSW1wcm92ZWQgYmFua2luZyB3aXRoIGh5c3RlcmVzaXMgdG8gcHJldmVudCBmYWNpbmcgZmxpcHMKICAgICAgICBfdXBkYXRlQmFua2luZyhkdCkgewogICAgICAgICAgICBjb25zdCBpbnB1dExlblNxID0gdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpOwogICAgICAgICAgICBjb25zdCB2ZWxMZW5TcSA9IHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKTsKCiAgICAgICAgICAgIGxldCB0YXJnZXRZYXcgPSB0aGlzLnRhcmdldFlhdzsKICAgICAgICAgICAgbGV0IHNob3VsZFVwZGF0ZVlhdyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUFJJT1JJVFkgMTogRXhwbGljaXQgQWltIChBaW0gU3RpY2sgLyBTd2lwZSkKICAgICAgICAgICAgaWYgKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgIHRhcmdldFlhdyA9IE1hdGguYXRhbjIodGhpcy5vdmVycmlkZUFpbVZlY3Rvci54LCB0aGlzLm92ZXJyaWRlQWltVmVjdG9yLnopOwogICAgICAgICAgICAgICAgc2hvdWxkVXBkYXRlWWF3ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBQUklPUklUWSAyOiBNb3ZlbWVudCBJbnB1dAogICAgICAgICAgICBlbHNlIGlmIChpbnB1dExlblNxID4gdGhpcy5mYWNpbmdEZWFkem9uZSAqIHRoaXMuZmFjaW5nRGVhZHpvbmUpIHsKICAgICAgICAgICAgICAgIHRhcmdldFlhdyA9IE1hdGguYXRhbjIodGhpcy5pbnB1dFZlY3Rvci54LCB0aGlzLmlucHV0VmVjdG9yLnopOwogICAgICAgICAgICAgICAgc2hvdWxkVXBkYXRlWWF3ID0gdHJ1ZTsKICAgICAgICAgICAgfSAKICAgICAgICAgICAgLy8gUFJJT1JJVFkgMzogVmVsb2NpdHkgKERyaWZ0aW5nKQogICAgICAgICAgICBlbHNlIGlmICh2ZWxMZW5TcSA+IHRoaXMuZmFjaW5nRGVhZHpvbmUgKiB0aGlzLmZhY2luZ0RlYWR6b25lKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMudmVsb2NpdHkueCwgdGhpcy52ZWxvY2l0eS56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElmIHdlIHNob3VsZCB1cGRhdGUsIGRvIHNvLiBPdGhlcndpc2Uga2VlcCBsYXN0IHZhbGlkIHlhdwogICAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlWWF3KSB7CiAgICAgICAgICAgICAgICB0aGlzLmxhc3RWYWxpZFlhdyA9IHRhcmdldFlhdzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRhcmdldFlhdyA9IHRoaXMubGFzdFZhbGlkWWF3OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbW9vdGggWWF3IHdpdGggd3JhcC1hcm91bmQgaGFuZGxpbmcKICAgICAgICAgICAgbGV0IGRpZmYgPSB0YXJnZXRZYXcgLSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgIHdoaWxlIChkaWZmID4gTWF0aC5QSSkgZGlmZiAtPSBNYXRoLlBJICogMjsKICAgICAgICAgICAgd2hpbGUgKGRpZmYgPCAtTWF0aC5QSSkgZGlmZiArPSBNYXRoLlBJICogMjsKCiAgICAgICAgICAgIGNvbnN0IHNwZWVkUmF0aW8gPSBNYXRoLm1pbigxLjAsIHRoaXMudmVsb2NpdHkubGVuZ3RoKCkgLyB0aGlzLm1heFNwZWVkKTsKY29uc3QgdHVyblNwZWVkID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoOC4wLCA0LjAsIHNwZWVkUmF0aW8pOyAvLyBSZWR1Y2VkIGZyb20gMTIuMC82LjAgdG8gcmVkdWNlIGZsaXBwaW5nCgogICAgICAgICAgICAvLyBQcmV2ZW50IHN1ZGRlbiBzbmFwcyB3aGVuIGRpZmYgaXMgdmVyeSBsYXJnZSAodGVsZXBvcnQvcmVzZXQgc2NlbmFyaW9zKQogICAgICAgICAgICBjb25zdCBtYXhZYXdDaGFuZ2UgPSBNYXRoLlBJICogZHQgKiB0dXJuU3BlZWQ7CiAgICAgICAgICAgIGNvbnN0IHlhd0NoYW5nZSA9IE1hdGgubWF4KC1tYXhZYXdDaGFuZ2UsIE1hdGgubWluKG1heFlhd0NoYW5nZSwgZGlmZiAqIGR0ICogdHVyblNwZWVkKSk7CgogICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgKz0geWF3Q2hhbmdlOwogICAgICAgICAgICB0aGlzLnRhcmdldFlhdyA9IHRhcmdldFlhdzsKCiAgICAgICAgICAgIC8vIEJhbmtpbmcKICAgICAgICAgICAgY29uc3QgYmFua1NlbnNpdGl2aXR5ID0gMC44OwogICAgICAgICAgICBjb25zdCBtYXhCYW5rID0gMC43NTsKCiAgICAgICAgICAgIGxldCB0YXJnZXRCYW5rID0gLWRpZmYgKiBiYW5rU2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIHRhcmdldEJhbmsgPSBNYXRoLm1heCgtbWF4QmFuaywgTWF0aC5taW4obWF4QmFuaywgdGFyZ2V0QmFuaykpOwoKICAgICAgICAgICAgY29uc3QgYmFua0xlcnAgPSAxLjAgLSBNYXRoLnBvdygwLjAyLCBkdCk7CiAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCArPSAodGFyZ2V0QmFuayAtIHRoaXMuYmFua2luZ0Ftb3VudCkgKiBiYW5rTGVycDsKCiAgICAgICAgICAgIC8vIFBpdGNoCiAgICAgICAgICAgIGNvbnN0IHBpdGNoU2Vuc2l0aXZpdHkgPSAwLjE7CiAgICAgICAgICAgIGNvbnN0IG1heFBpdGNoID0gMS4wOwoKICAgICAgICAgICAgbGV0IHRhcmdldFBpdGNoID0gLXRoaXMudmVsb2NpdHkueSAqIHBpdGNoU2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIHRhcmdldFBpdGNoID0gTWF0aC5tYXgoLW1heFBpdGNoLCBNYXRoLm1pbihtYXhQaXRjaCwgdGFyZ2V0UGl0Y2gpKTsKCiAgICAgICAgICAgIGNvbnN0IHBpdGNoTGVycCA9IDEuMCAtIE1hdGgucG93KDAuMDUsIGR0KTsKICAgICAgICAgICAgdGhpcy5waXRjaEFtb3VudCArPSAodGFyZ2V0UGl0Y2ggLSB0aGlzLnBpdGNoQW1vdW50KSAqIHBpdGNoTGVycDsKCiAgICAgICAgICAgIC8vIEFwcGx5IFJvdGF0aW9uCiAgICAgICAgICAgIGNvbnN0IGZpbmFsWWF3ID0gdGhpcy5jdXJyZW50WWF3ICsgdGhpcy5yb3RhdGlvbk9mZnNldDsKCiAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLnNldEZyb21BeGlzQW5nbGUoX3BBeGlzWSwgZmluYWxZYXcpOwoKICAgICAgICAgICAgX3BRdWF0LnNldEZyb21BeGlzQW5nbGUobmV3IFRIUkVFLlZlY3RvcjMoMSwgMCwgMCksIHRoaXMucGl0Y2hBbW91bnQpOwogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseShfcFF1YXQpOwoKICAgICAgICAgICAgX3BRdWF0LnNldEZyb21BeGlzQW5nbGUobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSksIHRoaXMuYmFua2luZ0Ftb3VudCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wUXVhdCk7CgogICAgICAgICAgICAvLyBJZGxlIEJvYgogICAgICAgICAgICBpZiAodmVsTGVuU3EgPCAwLjEgJiYgIXRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0aW1lID0gRGF0ZS5ub3coKSAqIDAuMDAxNTsKICAgICAgICAgICAgICAgIGNvbnN0IGJvYlBpdGNoID0gTWF0aC5zaW4odGltZSkgKiAwLjAzOwogICAgICAgICAgICAgICAgY29uc3QgYm9iUm9sbCA9IE1hdGguY29zKHRpbWUgKiAwLjcpICogMC4wMjsKCl9wRXVsZXIuc2V0KGJvYlBpdGNoLCAwLCBib2JSb2xsKTsKICAgICAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tRXVsZXIoX3BFdWxlcik7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseShfcFF1YXQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2NoZWNrVGFja2xlUHJlc3N1cmUoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNFbmdhZ2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIXRoaXMudGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CgogICAgICAgICAgICBpZiAoIW9wcG9uZW50VGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGVuZ2FnZWRUaGlzRnJhbWUgPSBmYWxzZTsKICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlUmFkaXVzID0gdGhpcy5pc0VuZ2FnZWQgPyB0aGlzLnRhY2tsZVJhZGl1cyAqIDEuMiA6IHRoaXMudGFja2xlUmFkaXVzOwoKICAgICAgICAgICAgLy8gMS4gQ2hlY2sgRW5nYWdlbWVudCBTdGF0dXMKICAgICAgICAgICAgZm9yIChjb25zdCBlbnRpdHkgb2Ygb3Bwb25lbnRUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghZW50aXR5Lm1lc2ggfHwgZW50aXR5LnN0YXR1cy5uYXAgPiAwIHx8IGVudGl0eS5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhlbnRpdHkubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IGVmZmVjdGl2ZVJhZGl1cykgewogICAgICAgICAgICAgICAgICAgIGVuZ2FnZWRUaGlzRnJhbWUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gVXBkYXRlIFRpbWVyICYgVUkgRmVlZGJhY2sKICAgICAgICAgICAgaWYgKGVuZ2FnZWRUaGlzRnJhbWUpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBKdXN0IGJlY2FtZSBlbmdhZ2VkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbS5pc0h1bWFuICYmIHRoaXMudGVhbS5hY3RpdmVQbGF5ZXIgPT09IHRoaXMgJiYgZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkVOR0FHRUQhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtYWN0aW9uIik7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhpbnQgZm9yIHRoZSBwbGF5ZXIKICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0VuZ2FnZWQgJiYgdGhpcy5oYXNCYWxsICYmIGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJSRUFLIE5PVyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDIwMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciArPSBkdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5jb3VudGVyVGltZXIgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmlzRW5nYWdlZCA9IGVuZ2FnZWRUaGlzRnJhbWU7CgogICAgICAgICAgICAvLyAzLiBBcHBseSBEYW1hZ2UgKFdpdGggR3JhY2UgUGVyaW9kKQogICAgICAgICAgICAvLyBHcmFjZSBQZXJpb2Q6IDAuNXMgYmVmb3JlIGRhbWFnZSBzdGFydHMgdGlja2luZwogICAgICAgICAgICBpZiAodGhpcy5pc0VuZ2FnZWQgJiYgdGhpcy5lbmNvdW50ZXJUaW1lciA+IDAuNSkgewogICAgICAgICAgICAgICAgZm9yIChjb25zdCBlbnRpdHkgb2Ygb3Bwb25lbnRUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWVudGl0eS5tZXNoIHx8IGVudGl0eS5zdGF0dXMubmFwID4gMCB8fCBlbnRpdHkuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGVudGl0eS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IGVmZmVjdGl2ZVJhZGl1cykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBEaXNjcmV0ZSBDbGFzaCBFdmVudAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW50aXR5LmNsYXNoQ29vbGRvd24gPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzb2x2ZUNsYXNoKGVudGl0eSwgZ2FtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHkuY2xhc2hDb29sZG93biA9IDIuMDsgLy8gSW5jcmVhc2VkIGNvb2xkb3duICh3YXMgMS41KSB0byByZWR1Y2Ugc3BhbQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPD0gMCkgewogICAgICAgICAgICAgICAgdGhpcy5mdW1ibGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9yZXNvbHZlQ2xhc2gob3Bwb25lbnQsIGdhbWUpIHsKICAgICAgICAgICAgY29uc3Qgb3BwQVQgPSBvcHBvbmVudC5nZXRTdGF0KCdBVCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmFyaWFuY2U6IDAuOCB0byAxLjIKICAgICAgICAgICAgY29uc3QgdmFyaWFuY2UgPSAwLjggKyBNYXRoLnJhbmRvbSgpICogMC40OwogICAgICAgICAgICBsZXQgZGFtYWdlID0gTWF0aC5mbG9vcihvcHBBVCAqIHZhcmlhbmNlKTsKICAgICAgICAgICAgaWYgKGRhbWFnZSA8IDEpIGRhbWFnZSA9IDE7CgogICAgICAgICAgICAvLyBEaXJlY3Rpb25hbCBTaGllbGRpbmcKICAgICAgICAgICAgLy8gQ2FycmllciBGb3J3YXJkCiAgICAgICAgICAgIF9wVmVjLmNvcHkoX3BBeGlzWikuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsgCiAgICAgICAgICAgIC8vIFZlY3RvciBUbyBPcHBvbmVudAogICAgICAgICAgICBjb25zdCB0b09wcCA9IG9wcG9uZW50Lm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRvdCA9IF9wVmVjLmRvdCh0b09wcCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJZiBvcHBvbmVudCBpcyBCRUhJTkQgKGRvdCA8IC0wLjIpLCBkYW1hZ2UgaXMgcmVkdWNlZCAoU2hpZWxkaW5nKS4KICAgICAgICAgICAgbGV0IGlzU2hpZWxkZWQgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGRvdCA8IC0wLjIpIHsKICAgICAgICAgICAgICAgIGRhbWFnZSA9IE1hdGguZmxvb3IoZGFtYWdlICogMC41KTsKICAgICAgICAgICAgICAgIGlzU2hpZWxkZWQgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBcHBseSBEYW1hZ2UKICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gZGFtYWdlOwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPCAwKSB0aGlzLmN1cnJlbnRFTiA9IDA7CgogICAgICAgICAgICAvLyBUZWNoIEVmZmVjdHMKICAgICAgICAgICAgaWYgKG9wcG9uZW50LnRlY2hzLnRhY2tsZSkgewogICAgICAgICAgICAgICAgaWYgKG9wcG9uZW50LnRlY2hzLnRhY2tsZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ3Zlbm9tJywgMTAuMCk7CiAgICAgICAgICAgICAgICAgICAgZGFtYWdlICs9IDM7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wcG9uZW50LnRlY2hzLnRhY2tsZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0cyA9IFsnUEEnLCAnU0gnLCAnQVQnLCAnRU4nXTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBzdGF0c1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBzdGF0cy5sZW5ndGgpXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCd3aXRoZXInLCAxMC4wLCB0YXJnZXQpOwogICAgICAgICAgICAgICAgICAgIGRhbWFnZSArPSAzOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcHBvbmVudC50ZWNocy50YWNrbGUgPT09ICdkcmFpbicpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IGRhbWFnZTsgCiAgICAgICAgICAgICAgICAgICAgb3Bwb25lbnQuc3RhdHMuSFAgKz0gZGFtYWdlOwogICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkRSQUlOIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiaGVhbCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBWaXN1YWxzIC0gSlVJQ0VEIFVQCiAgICAgICAgICAgIGNvbnN0IG1pZFBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmxlcnAob3Bwb25lbnQubWVzaC5wb3NpdGlvbiwgMC41KTsKICAgICAgICAgICAgbWlkUG9zLnkgKz0gMS41OwoKICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAoaXNTaGllbGRlZCkgewogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTSElFTEQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJibG9jayIpOwogICAgICAgICAgICAgICAgICAgIH0sIDEwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERhbWFnZSBmZWVkYmFjawogICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oYCR7ZGFtYWdlfWAsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIC8vIE1hc3NpdmUgSW1wYWN0IEp1aWNlCiAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgbWlkUG9zLCB7IHNjYWxlOiAzLjAsIGxpZmU6IDAuNCB9KTsKICAgICAgICAgICAgICAgIGdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIG1pZFBvcywgeyBzY2FsZTogNC4wIH0pOwogICAgICAgICAgICAgICAgLy8gRGVicmlzIHNob3dlcgogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8NjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2RlYnJpcycsIG1pZFBvcywgeyBzY2FsZTogMC40IH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZ2FtZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAvLyBIRVJDVUxFQU4gU0hBS0UKICAgICAgICAgICAgICAgIGdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgyLjUpOyAvLyBJbmNyZWFzZWQgZnJvbSAxLjIKICAgICAgICAgICAgICAgIGdhbWUuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKC01KTsgLy8gWm9vbSBpbiBpbXBhY3QKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGdhbWUudHJpZ2dlckltcGFjdCkgewogICAgICAgICAgICAgICAgLy8gRnJlZXplIGZyYW1lCiAgICAgICAgICAgICAgICBnYW1lLnRyaWdnZXJJbXBhY3QoMC4xNSwgJ2hlYXZ5Jyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9wcG9uZW50LmdhaW5FeHAoMik7CiAgICAgICAgfQoKICAgICAgICBfcGVyZm9ybUplY2h0S25vY2tiYWNrKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW1JZCA9IHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW0gPSBnYW1lLnRlYW1zW29wcG9uZW50VGVhbUlkXTsKCiAgICAgICAgICAgIGlmICghb3Bwb25lbnRUZWFtKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCByYW5nZSA9IDYuMDsKICAgICAgICAgICAgY29uc3QgZm9yY2UgPSAyNS4wOwoKICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiSkVDSFQgU0hPVCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJnb2FsIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9wcG9uZW50VGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHAubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHJhbmdlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlyID0gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgZGlyLnkgPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgZGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LmFkZChkaXIubXVsdGlwbHlTY2FsYXIoZm9yY2UpKTsKCiAgICAgICAgICAgICAgICAgICAgcC5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBjb25zdCByZWFjdEFjdGlvbiA9IHAuYWN0aW9ucyAmJiBwLmFjdGlvbnNbJ3JlYWN0J107CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlYWN0QWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWN0QWN0aW9uLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgICAgICByZWFjdEFjdGlvbi5jbGFtcFdoZW5GaW5pc2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheU9uZVNob3QoJ3JlYWN0JywgMC4xKTsKfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjYXRjaCcsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNNQUNLISIsIHAubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS50cmlnZ2VySW1wYWN0KSBnYW1lLnRyaWdnZXJJbXBhY3QoMC4xNSwgJ3NoYXR0ZXInKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW1ibGUoKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJGVU1CTEUhIEVOIERlcGxldGVkLiIpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCAmJiB0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNSQVNIISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnN0dW5UaW1lciA9IDEuNTsKCiAgICAgICAgICAgIGNvbnN0IGJhY2tEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICBiYWNrRGlyLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICBiYWNrRGlyLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICBiYWNrRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoYmFja0Rpci5tdWx0aXBseVNjYWxhcigxMi4wKSk7CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICBpZiAoYmFsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGVqZWN0RGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoTWF0aC5yYW5kb20oKS0wLjUsIDAuOCwgTWF0aC5yYW5kb20oKS0wLjUpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGJhbGwuc2hvb3QoZWplY3REaXIsIDYuMCwgJ25vbmUnKTsKdGhpcy5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FuQ2F0Y2ggPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBkYXNoKHgsIHopIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nIHx8IHRoaXMuZGFzaENvb2xkb3duID4gMCkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gT0ZGRU5TRTogQlJFQUsgVEFDS0xFCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgJiYgdGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNvc3QgPSAxNTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RU4gPCBjb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiRkFJTEVEISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRFTiAtPSBjb3N0OwogICAgICAgICAgICAgICAgdGhpcy5pc0Rhc2hpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5kYXNoVGltZSA9IDAuNDsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaENvb2xkb3duID0gMi4wOwogICAgICAgICAgICAgICAgdGhpcy5kYXNoVHlwZSA9ICdicmVhayc7CgpfcFZlYy5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKF9wVmVjLm11bHRpcGx5U2NhbGFyKDE1LjApKTsKCiAgICAgICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwoKICAgICAgICAgICAgICAgIG9wcG9uZW50VGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ocC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHRoaXMudGFja2xlUmFkaXVzICogMS41KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHB1c2hEaXIgPSBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHVzaERpci55ID0gMC41OwogICAgICAgICAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LmFkZChwdXNoRGlyLm11bHRpcGx5U2NhbGFyKDE1LjApKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3R1blRpbWVyID0gMi4wOwogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXkoJ2NhdGNoJywgMC4yKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNUVU4hIiwgcC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCmlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJCUkVBSyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKLy8gTkVXOiBTcGF3biBCcmVhayBHbHlwaCAoRXhwbG9zaXZlIEJ1cnN0KQogICAgICAgICAgICAgICAgaWYgKGdhbWUuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5nbHlwaE1hbmFnZXIuc3Bhd24oJ3N0YXR1cycsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDAuNSwKICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogOC4wLAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAzLjAsCiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFk6IDAuNQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCi8vIFBhcnRpY2xlIEJ1cnN0IChCcmVhayBUYWNrbGUpCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAyLjAsIGxpZmU6IDAuMyB9KTsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuNSB9KTsKICAgICAgICAgICAgICAgICAgICAvLyBCdWJibGUgQnVyc3QKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzMDsgaSsrKSB7CmNvbnN0IGJQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQoX3BWZWMuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSksIDEuMCsoTWF0aC5yYW5kb20oKS0wLjUpLCAoTWF0aC5yYW5kb20oKS0wLjUpKSk7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2J1YmJsZScsIGJQb3MsIHsgc2NhbGU6IDAuMiArIE1hdGgucmFuZG9tKCkgKiAwLjQgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChnYW1lLnRyaWdnZXJJbXBhY3QpIGdhbWUudHJpZ2dlckltcGFjdCgwLjE1LCAnaGVhdnknKTsKCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9GRkVOU0U6IFNQUklOVAogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjb3N0ID0gNTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRFTiA8IGNvc3QpIHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJOTyBFTiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOIC09IGNvc3Q7CiAgICAgICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gMC40OwogICAgICAgICAgICAgICAgdGhpcy5kYXNoQ29vbGRvd24gPSAxLjU7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ3NwcmludCc7Cgpjb25zdCBidXJzdERpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGlmIChidXJzdERpci5sZW5ndGhTcSgpIDwgMC4xKSBidXJzdERpci5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChidXJzdERpci5tdWx0aXBseVNjYWxhcigxNS4wKSk7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgyMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkRBU0ghIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBERUZFTlNFOiBCTE9DSyAvIFRBQ0tMRQogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGxldCBpc0Jsb2NrQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA4LjAgJiYgYmFsbC5tZXNoLnBvc2l0aW9uLnkgPiAyLjUpIHsKICAgICAgICAgICAgICAgICAgICBpc0Jsb2NrQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5kYXNoVGltZSA9IHRoaXMuZGFzaFRvdGFsVGltZTsKICAgICAgICAgICAgdGhpcy5kYXNoQ29vbGRvd24gPSAxLjU7CgogICAgICAgICAgICBjb25zdCBsZW4gPSBNYXRoLnNxcnQoeCp4ICsgeip6KTsKICAgICAgICAgICAgY29uc3QgbnggPSAobGVuID4gMCkgPyB4L2xlbiA6IDA7CiAgICAgICAgICAgIGNvbnN0IG56ID0gKGxlbiA+IDApID8gei9sZW4gOiAwOwoKaWYgKGxlbiA+IDApIHsKICAgICAgICAgICAgICAgIC8vIFNtb290aCB0dXJuIGZvciBkYXNoIGluc3RlYWQgb2Ygc25hcAogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSBNYXRoLmF0YW4yKG54LCBueik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQmxvY2tDb250ZXh0KSB7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ3ZlcnRpY2FsJzsKCiAgICAgICAgICAgICAgICBjb25zdCBkaXJUb0JhbGwgPSBiYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGRpclRvQmFsbC55ID0gMDsKCiAgICAgICAgICAgICAgICBpZiAoZGlyVG9CYWxsLmxlbmd0aFNxKCkgPiAwLjAxKSB7CiAgICAgICAgICAgICAgICAgICAgZGlyVG9CYWxsLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZGFzaFZlYy5jb3B5KGRpclRvQmFsbCkubXVsdGlwbHlTY2FsYXIoOC4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXNoVmVjLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBjYXRjaEFjdGlvbiA9IHRoaXMuYWN0aW9uc1snY2F0Y2gnXTsKICAgICAgICAgICAgICAgIGlmIChjYXRjaEFjdGlvbikgewogICAgICAgICAgICAgICAgICAgIGNhdGNoQWN0aW9uLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgIGNhdGNoQWN0aW9uLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjYXRjaEFjdGlvbi50aW1lU2NhbGUgPSAxLjU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnBsYXkoJ2NhdGNoJywgMC4xKTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRlZmF1bHQiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ2hvcml6b250YWwnOwogICAgICAgICAgICAgICAgdGhpcy5faGFzSGl0VGFja2xlID0gZmFsc2U7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdmVsb2NpdHkgaW1wdWxzZSBpbiBkYXNoIGRpcmVjdGlvbgovLyBBcHBseSB2ZWxvY2l0eSBpbXB1bHNlIGluIGRhc2ggZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBfcFZlYy5zZXQobngsIDAsIG56KTsKICAgICAgICAgICAgICAgIGlmIChfcFZlYy5sZW5ndGhTcSgpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LmFkZChfcFZlYy5tdWx0aXBseVNjYWxhcigyMC4wKSk7CgogICAgICAgICAgICAgICAgY29uc3QgbHVuZ2VBY3Rpb24gPSB0aGlzLmFjdGlvbnNbJ3Rocm93J107CiAgICAgICAgICAgICAgICBpZiAobHVuZ2VBY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICBsdW5nZUFjdGlvbi5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgICAgICBsdW5nZUFjdGlvbi5jbGFtcFdoZW5GaW5pc2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgbHVuZ2VBY3Rpb24udGltZVNjYWxlID0gMi4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wbGF5KCd0aHJvdycsIDAuMSk7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjA1LCAnZGVmYXVsdCcpOwogICAgICAgICAgICB9CgppZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZEZvdkltcHVsc2UoMTApOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMC4zKTsgCiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gRGFzaCBFZmZlY3QKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRhc2hQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgIGRhc2hQb3MueSArPSAxLjA7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBkYXNoUG9zLCB7IHNjYWxlOiAxLjUsIGxpZmU6IDAuMyB9KTsKICAgICAgICAgICAgICAgIC8vIFNwZWVkIGxpbmVzCiAgICAgICAgICAgICAgICBjb25zdCBiYWNrID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpOwogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGRhc2hQb3MuY2xvbmUoKS5hZGQoYmFjay5tdWx0aXBseVNjYWxhcihNYXRoLnJhbmRvbSgpKSk7CiAgICAgICAgICAgICAgICAgICAgcC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwLCB7IHNjYWxlOiAxLjUgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jcmVhdGVIUEJhcigpIHsKICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gbmV3IFRIUkVFLkdyb3VwKCk7CgogICAgICAgICAgICBjb25zdCBiZ0dlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDEuMiwgMC4xNSk7CiAgICAgICAgICAgIGNvbnN0IGJnTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDAwMDAwLCBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCBkZXB0aFRlc3Q6IGZhbHNlIH0pOwogICAgICAgICAgICBjb25zdCBiZyA9IG5ldyBUSFJFRS5NZXNoKGJnR2VvLCBiZ01hdCk7CiAgICAgICAgICAgIGNvbnRhaW5lci5hZGQoYmcpOwoKICAgICAgICAgICAgY29uc3QgZmlsbEdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDEuMTYsIDAuMTEpOwogICAgICAgICAgICBmaWxsR2VvLnRyYW5zbGF0ZSgwLjU4LCAwLCAwKTsKICAgICAgICAgICAgY29uc3QgZmlsbE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmYwMCwgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgZGVwdGhUZXN0OiBmYWxzZSB9KTsKICAgICAgICAgICAgdGhpcy5ocEJhckZpbGwgPSBuZXcgVEhSRUUuTWVzaChmaWxsR2VvLCBmaWxsTWF0KTsKICAgICAgICAgICAgdGhpcy5ocEJhckZpbGwucG9zaXRpb24uc2V0KC0wLjU4LCAwLCAwLjAxKTsKICAgICAgICAgICAgY29udGFpbmVyLmFkZCh0aGlzLmhwQmFyRmlsbCk7CgogICAgICAgICAgICB0aGlzLmhwQmFyID0gY29udGFpbmVyOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmhwQmFyKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVIUEJhcigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhwQmFyIHx8ICF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIHRoaXMuaHBCYXIucG9zaXRpb24uY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLmhwQmFyLnBvc2l0aW9uLnkgKz0gMi4yOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLmxvb2tBdCh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhLnBvc2l0aW9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgcGN0ID0gTWF0aC5tYXgoMCwgdGhpcy5zdGF0cy5IUCAvIHRoaXMuc3RhdHMubWF4SFApOwogICAgICAgICAgICB0aGlzLmhwQmFyRmlsbC5zY2FsZS5zZXRYKHBjdCk7CgogICAgICAgICAgICBpZiAocGN0ID4gMC41KSB0aGlzLmhwQmFyRmlsbC5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHgwMGZmMDApOwogICAgICAgICAgICBlbHNlIGlmIChwY3QgPiAwLjI1KSB0aGlzLmhwQmFyRmlsbC5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZmZmMDApOwogICAgICAgICAgICBlbHNlIHRoaXMuaHBCYXJGaWxsLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmMDAwMCk7CgogICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSAocGN0IDwgMC45OCk7CiAgICAgICAgfQoKICAgICAgICBnYWluRXhwKGFtb3VudCkgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSB8fCB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CgogICAgICAgICAgICB0aGlzLmV4cCArPSBhbW91bnQ7CgogICAgICAgICAgICBpZiAodGhpcy5leHAgPj0gdGhpcy5uZXh0TGV2ZWxFeHApIHsKICAgICAgICAgICAgICAgIHRoaXMubGV2ZWxVcCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsZXZlbFVwKCkgewogICAgICAgICAgICB0aGlzLmxldmVsKys7CiAgICAgICAgICAgIHRoaXMuZXhwIC09IHRoaXMubmV4dExldmVsRXhwOwogICAgICAgICAgICB0aGlzLm5leHRMZXZlbEV4cCA9IE1hdGguZmxvb3IodGhpcy5uZXh0TGV2ZWxFeHAgKiAxLjUpOwoKICAgICAgICAgICAgY29uc3Qga2V5cyA9IFsnSFAnLCAnRU4nLCAnQVQnLCAnUEEnLCAnQkwnLCAnU0gnLCAnQ0EnLCAnU1AnXTsKCiAgICAgICAgICAgIGNvbnN0IGhwR2FpbiA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDIwKSArIDEwOwogICAgICAgICAgICB0aGlzLnN0YXRzLm1heEhQICs9IGhwR2FpbjsKICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCA9IHRoaXMuc3RhdHMubWF4SFA7CgogICAgICAgICAgICBrZXlzLmZvckVhY2goayA9PiB7CiAgICAgICAgICAgICAgICBpZiAoayA9PT0gJ0hQJykgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPiAwLjQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnYWluID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMikgKyAxOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHNba10gKz0gZ2FpbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gcmVhY2hlZCBMZXZlbCAke3RoaXMubGV2ZWx9IWApOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgdGhpcy5tZXNoKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJMRVZFTCBVUCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jaGVja1RhY2tsZUNvbGxpc2lvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW0gfHwgdGhpcy5faGFzSGl0VGFja2xlKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwoKICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3Bwb25lbnRUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG9wcC5tZXNoLnBvc2l0aW9uKTsKCmlmIChkaXN0IDwgMy4wKSB7IC8vIEluY3JlYXNlZCBmcm9tIDIuMCBmb3IgZWFzaWVyIGhpdHMKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNvbHZlVGFja2xlSGl0KG9wcCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGFzSGl0VGFja2xlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9yZXNvbHZlVGFja2xlSGl0KG9wcCkgewogICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKC0wLjUpOwogICAgICAgICAgICBpZiAoIXRoaXMuX2xheWVyZWRFbmFibGVkKSB0aGlzLnBsYXkoJ2lkbGUnLCAwLjIpOwoKICAgICAgICAgICAgY29uc3QgYXQgPSB0aGlzLmdldFN0YXQoJ0FUJyk7CiAgICAgICAgICAgIGxldCBkYW1hZ2UgPSBhdCAqIDMuMDsKCiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnRhY2tsZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgb3BwLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDEwLjApOwogICAgICAgICAgICAgICAgZGFtYWdlICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50ZWNocy50YWNrbGUgPT09ICd3aXRoZXInKSB7CiAgICAgICAgICAgICAgICBvcHAuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDEwLjAsICdFTicpOwogICAgICAgICAgICAgICAgZGFtYWdlICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50ZWNocy50YWNrbGUgPT09ICdkcmFpbicpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgKz0gMjA7CiAgICAgICAgICAgICAgICBvcHAuc3RhdHMuSFAgLT0gMjA7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJEUkFJTiIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBvcHAuY3VycmVudEVOIC09IGRhbWFnZTsKCmlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUmVtb3ZlZCAiRU4iIHN1ZmZpeCBmb3IgY2xlYW5lciBsb29rCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgJHtNYXRoLmZsb29yKGRhbWFnZSl9YCwgb3BwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCQU0hIiwgb3BwLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAob3BwLmN1cnJlbnRFTiA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgb3BwLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBvcHAuc3R1blRpbWVyID0gMC41OwogICAgICAgICAgICAgICAgICAgIG9wcC5wbGF5T25lU2hvdCgncmVhY3QnLCAwLjEpOwp9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMudGFja2xlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQodGhpcywgdGhpcy50ZWNocy50YWNrbGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG9wcC5zdHVuVGltZXIgPSAxLjA7CiAgICAgICAgICAgICAgICBvcHAucGxheU9uZVNob3QoJ3JlYWN0JywgMC4xKTsKaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTTUFDSyEiLCBvcHAubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBwdXNoRGlyID0gb3BwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgcHVzaERpci55ID0gMC4yOwogICAgICAgICAgICBvcHAudmVsb2NpdHkuYWRkKHB1c2hEaXIubXVsdGlwbHlTY2FsYXIoMTIuMCkpOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjEsICdoZWF2eScpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuOCk7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaCkgewpjb25zdCBtaWQgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQob3BwLm1lc2gucG9zaXRpb24pLm11bHRpcGx5U2NhbGFyKDAuNSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaChtaWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAovLyBCdWJibGUgQnVyc3QgKFRhY2tsZSBIaXQpCi8vIEJ1YmJsZSBCdXJzdCAoVGFja2xlIEhpdCkKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG1pZCA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmxlcnAob3BwLm1lc2gucG9zaXRpb24sIDAuNSk7CiAgICAgICAgICAgICAgICBtaWQueSArPSAxLjA7CiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzMDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYnViYmxlUG9zID0gbWlkLmNsb25lKCkuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKChNYXRoLnJhbmRvbSgpLTAuNSkqMS41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjEuNSwgKE1hdGgucmFuZG9tKCktMC41KSoxLjUpKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBidWJibGVQb3MsIHsgc2NhbGU6IDAuMTUgKyBNYXRoLnJhbmRvbSgpICogMC4zNSB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5R29hbENyZWFzZShkdCkgewoKICAgICAgICAgICAgY29uc3QgZ29hbHMgPSBbCgogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgNDYpLAogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgLTQ2KQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gMTAuMDsKCiAgICAgICAgICAgIGdvYWxzLmZvckVhY2goZ29hbCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBkeCA9IHRoaXMubWVzaC5wb3NpdGlvbi54IC0gZ29hbC54OwogICAgICAgICAgICAgICAgY29uc3QgZHogPSB0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWwuejsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IGR4KmR4ICsgZHoqZHo7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IHJhZGl1cyAqIHJhZGl1cykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZGlzdFNxKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWCA9IGRpc3QgPiAwID8gZHggLyBkaXN0IDogMTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWiA9IGRpc3QgPiAwID8gZHogLyBkaXN0IDogMDsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSA1MC4wOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSBwdXNoWCAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9IHB1c2haICogZm9yY2UgKiBkdDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByYWRpdXMgLSAwLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xhbXBSYXRpbyA9IHJhZGl1cyAvIChkaXN0ICsgMC4wMDEpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueCA9IGdvYWwueCArIGR4ICogY2xhbXBSYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSBnb2FsLnogKyBkeiAqIGNsYW1wUmF0aW87CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguUGxheWVyID0gUGxheWVyOwp9KSgpOwo=","main.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgLy8gTmFtZXNwYWNlCiAgICB3aW5kb3cuZmx1eCA9IHdpbmRvdy5mbHV4IHx8IHt9OwogICAgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyA9IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgfHwgW107CgogICAgLy8gQ29uZmlnCmNvbnN0IF9jb25maWcgPSB7CiAgICAgICAgaW50ZXJuYWxXaWR0aDogMzYwLAogICAgICAgIGludGVybmFsSGVpZ2h0OiA2NDAsCiAgICAgICAgYmdDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgZm9nQ29sb3I6IDB4MDAxZTM2LAogICAgICAgIGZvZ0RlbnNpdHk6IDAuMDAwMSwgLy8gRHJhc3RpY2FsbHkgcmVkdWNlZCB0byBlbnN1cmUgdmlzaWJpbGl0eQogICAgICAgIGFyZW5hUmFkaXVzOiA0OC4wCiAgICB9OwoKICAgIC8vIEdsb2JhbHMKLy8gR2xvYmFscwogICAgY29uc3QgX2lucHV0ID0geyB4OiAwLCB5OiAwIH07IC8vIElucHV0IHN0YXRlCiAgICAKICAgIC8vIFNoYWRlciBVbmlmb3JtcwogICAgY29uc3QgX2FyZW5hVW5pZm9ybXMgPSB7CiAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICB1SW1wYWN0UG9zOiB7IHZhbHVlOiBuZXcgVEhSRUUuVmVjdG9yMygpIH0sCiAgICAgICAgdUltcGFjdFN0cjogeyB2YWx1ZTogMC4wIH0KICAgIH07CiAgICBjb25zdCBfcGFydGljbGVVbmlmb3JtcyA9IHsKICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9CiAgICB9OwoKICAgIC8vIEV4cG9zZSBJbXBhY3QgVHJpZ2dlcgogICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0ID0gZnVuY3Rpb24ocG9zLCBzdHJlbmd0aCkgewogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RQb3MudmFsdWUuY29weShwb3MpOwogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RTdHIudmFsdWUgPSBzdHJlbmd0aCAqIDIuMDsgLy8gU2NhbGUgdXAgZm9yIHZpc2liaWxpdHkKICAgIH07Ci8vIF9pbnB1dCBhbHJlYWR5IGRlY2xhcmVkIGFib3ZlCiAgICBjb25zdCBfdGVtcFZlYzEgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBSZXVzYWJsZSBmb3IgcGh5c2ljcy9sb2dpYwogICAgY29uc3QgX3RlbXBWZWMyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsgLy8gUmV1c2FibGUgZm9yIHBoeXNpY3MvbG9naWMKICAgIGNvbnN0IF90ZW1wVmVjMyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7IC8vIFJldXNhYmxlIGZvciBwcmVkaWN0aXZlIGFzc2lzdAogICAgbGV0IF9zY2VuZSwgX2NhbWVyYSwgX3JlbmRlcmVyLCBfY2xvY2s7CiAgICBsZXQgX2hvbWVUZWFtLCBfYXdheVRlYW07CiAgICBsZXQgX2JhbGw7CiAgICBsZXQgX2dhbWVNYW5hZ2VyOwogICAgbGV0IF9tZW51TWFuYWdlcjsKICAgIGxldCBfYXVkaW9NYW5hZ2VyOwoKICAgIGxldCBfY2FtZXJhTWFuYWdlcjsKICAgIGxldCBfd2F0ZXJPdmVybGF5OwogICAgbGV0IF9saWdodFNoYWZ0czsKICAgIGxldCBfc3RhZGl1bTsKICAgIGxldCBfZ2x5cGhNYW5hZ2VyOwoKICAgIC8vIElNUFJPVkVEOiBTZXR0aW5ncyBvYmplY3QKICAgIGNvbnN0IF9zZXR0aW5ncyA9IHsKICAgICAgICBqb3lzdGlja1NlbnNpdGl2aXR5OiAxLjAsCiAgICAgICAgYWltQXNzaXN0OiB0cnVlLAogICAgICAgIGNhbWVyYVNoYWtlOiB0cnVlLAogICAgICAgIGhpdFN0b3A6IHRydWUsCiAgICAgICAgaW52ZXJ0Q2FtZXJhOiBmYWxzZSwKICAgICAgICBhdXRvUmVjZW50ZXI6IHRydWUsCgogICAgICAgIC8vIC0tLSAiRkVFTFMgR09PRCIgQVNTSVNUIExBWUVSICh0dW5hYmxlIGluIERldlRvb2xzIHNuYXBzaG90cykgLS0tCiAgICAgICAgLy8gMC4wID0gb2ZmIC8gcHVyZSBza2lsbCwgMS4wID0gdmVyeSBoZWxwZnVsIGJ1dCBub3QgZnVsbCBhdXRvLXBsYXkuCiAgICAgICAgcGFzc0FpbUFzc2lzdDogMC42NSwKICAgICAgICBzaG90QWltQXNzaXN0OiAwLjM1LAogICAgICAgIGNhdGNoQXNzaXN0OiAwLjU1LAogICAgICAgIHN0ZWVyaW5nQXNzaXN0OiAwLjM1LAoKICAgICAgICAvLyBIaWdoZXIgPSBzbmFwcGllciBpbnB1dCwgbG93ZXIgPSBmbG9hdGllci4KICAgICAgICBpbnB1dFJlc3BvbnNlOiAxNC4wLAoKICAgICAgICAvLyBTZWNvbmRzIGFoZWFkIHVzZWQgZm9yIGNhdGNoIHByZWRpY3Rpb24gKGhlbHBzIHdpdGggZmFzdCBiYWxscykuCiAgICAgICAgcHJlZGljdGl2ZUNhdGNoVGltZTogMC4xMgogICAgfTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIERlYnVnIElPIEJyaWRnZSAoZXhwb3NlZCBmb3IgRGV2VG9vbHMgSlNPTiBzbmFwc2hvdHMpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IF9kZWJ1Z0lPID0gd2luZG93LmZsdXguX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyB8fCB7fTsKICAgIF9kZWJ1Z0lPLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgX2RlYnVnSU8uaW5wdXQgPSBfZGVidWdJTy5pbnB1dCB8fCB7fTsKICAgIF9kZWJ1Z0lPLnBlcmYgPSBfZGVidWdJTy5wZXJmIHx8IHsgZnJhbWU6IDAsIHJhd0R0OiAwLCBkdDogMCwgZnBzOiAwLCBhdmdGcHM6IDAgfTsKCgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBUb3VjaCBoZWxwZXJzIChtdWx0aS10b3VjaCBzYWZlKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBmdW5jdGlvbiBfZmluZFRvdWNoQnlJZCh0b3VjaExpc3QsIGlkKSB7CiAgICAgICAgaWYgKGlkID09PSBudWxsIHx8IGlkID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgICAgIGlmICghdG91Y2hMaXN0KSByZXR1cm4gbnVsbDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRvdWNoTGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCB0ID0gdG91Y2hMaXN0W2ldOwogICAgICAgICAgICBpZiAodCAmJiB0LmlkZW50aWZpZXIgPT09IGlkKSByZXR1cm4gdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gX2VuZGVkVG91Y2hCeUlkKGNoYW5nZWRUb3VjaGVzLCBpZCkgewogICAgICAgIGlmIChpZCA9PT0gbnVsbCB8fCBpZCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgICBpZiAoIWNoYW5nZWRUb3VjaGVzKSByZXR1cm4gbnVsbDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoYW5nZWRUb3VjaGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IHQgPSBjaGFuZ2VkVG91Y2hlc1tpXTsKICAgICAgICAgICAgaWYgKHQgJiYgdC5pZGVudGlmaWVyID09PSBpZCkgcmV0dXJuIHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKCiAgICBmdW5jdGlvbiBpbml0KCkgewogICAgICAgIF9jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKCiAgICAgICAgLy8gMS4gU2NlbmUKICAgICAgICBfc2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTsKICAgICAgICBfc2NlbmUuYmFja2dyb3VuZCA9IG5ldyBUSFJFRS5Db2xvcihfY29uZmlnLmJnQ29sb3IpOwogICAgICAgIF9zY2VuZS5mb2cgPSBuZXcgVEhSRUUuRm9nRXhwMihfY29uZmlnLmZvZ0NvbG9yLCBfY29uZmlnLmZvZ0RlbnNpdHkpOwoKICAgICAgICAvLyAyLiBDYW1lcmEKICAgICAgICBjb25zdCBhc3BlY3QgPSBfY29uZmlnLmludGVybmFsV2lkdGggLyBfY29uZmlnLmludGVybmFsSGVpZ2h0OwpfY2FtZXJhID0gbmV3IFRIUkVFLlBlcnNwZWN0aXZlQ2FtZXJhKDYwLCBhc3BlY3QsIDAuMSwgNTAwKTsKX2NhbWVyYS5wb3NpdGlvbi5zZXQoMCwgMTQsIDIyKTsKICAgICAgICBfY2FtZXJhLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICBfc2NlbmUuYWRkKF9jYW1lcmEpOyAvLyBFbnN1cmUgY2FtZXJhIGlzIGluIHNjZW5lIGZvciBjaGlsZHJlbiB0byByZW5kZXIKCiAgICAgICAgLy8gMy4gUmVuZGVyZXIKLy8gMy4gUmVuZGVyZXIKICAgICAgICBfcmVuZGVyZXIgPSBuZXcgVEhSRUUuV2ViR0xSZW5kZXJlcih7IAogICAgICAgICAgICBhbnRpYWxpYXM6IGZhbHNlLAogICAgICAgICAgICBwb3dlclByZWZlcmVuY2U6ICJoaWdoLXBlcmZvcm1hbmNlIiwKICAgICAgICAgICAgcHJlY2lzaW9uOiAibWVkaXVtcCIsIC8vIE1vYmlsZSBvcHRpbWl6YXRpb246IGZhc3RlciBzaGFkZXJzCiAgICAgICAgICAgIHN0ZW5jaWw6IGZhbHNlLCAgICAgICAvLyBEaXNhYmxlIHN0ZW5jaWwgYnVmZmVyIGlmIG5vdCB1c2VkCiAgICAgICAgICAgIGRlcHRoOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgX3JlbmRlcmVyLnNldFBpeGVsUmF0aW8oMSk7IC8vIEZvcmNlIDE6MSBwaXhlbCByYXRpbywgd2UgaGFuZGxlIHNjYWxpbmcgdmlhIHNldFNpemUKICAgICAgICBfcmVuZGVyZXIuYXV0b0NsZWFyID0gZmFsc2U7IC8vIFdlIG1hbmFnZSBjbGVhcmluZyB2aWEgYmFja2dyb3VuZCBvciBtYW51YWwgY2FsbHMgaWYgbmVlZGVkICh0aG91Z2ggc2NlbmUuYmFja2dyb3VuZCBoYW5kbGVzIGNvbG9yKQogICAgICAgIC8vIEV4cG9zZSByZW5kZXJlciBmb3IgRGV2VG9vbHMKICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSBfZ2FtZU1hbmFnZXIucmVuZGVyZXIgPSBfcmVuZGVyZXI7IAogICAgICAgIGVsc2Ugd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID0geyByZW5kZXJlcjogX3JlbmRlcmVyIH07IC8vIFRlbXAgaG9vawpfY29udGFpbmVyLmFwcGVuZENoaWxkKF9yZW5kZXJlci5kb21FbGVtZW50KTsKCi8vIC0tLSBWaWRlbyBPdmVybGF5IEVuZm9yY2VtZW50IC0tLQogICAgICAgIC8vIC0tLSBPdmVybGF5IFZpZGVvIExvZ2ljIFJlbW92ZWQgKFN3aXRjaGVkIHRvIEdJRikgLS0tCiAgICAgICAgLy8gNS4gRW52aXJvbm1lbnQKICAgICAgICBjcmVhdGVQYXJ0aWNsZXMoKTsKICAgICAgICBjcmVhdGVBcmVuYSgpOwoKLy8gNS41IEdhbWUgTWFuYWdlcgpfZ2FtZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguR2FtZU1hbmFnZXIoX3NjZW5lLCAndWktbGF5ZXInLCBfY2FtZXJhLCBfcmVuZGVyZXIpOwogICAgICAgIAogICAgICAgIC8vIDUuNS4xIEF1ZGlvIE1hbmFnZXIKICAgICAgICBfYXVkaW9NYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkF1ZGlvTWFuYWdlcigpOwogICAgICAgIF9nYW1lTWFuYWdlci5hdWRpb01hbmFnZXIgPSBfYXVkaW9NYW5hZ2VyOwoKICAgICAgICAvLyA1LjYgQ2FtZXJhIE1hbmFnZXIKICAgICAgICBfY2FtZXJhTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5DYW1lcmFNYW5hZ2VyKF9jYW1lcmEsIF9zY2VuZSk7CiAgICAgICAgX2dhbWVNYW5hZ2VyLmNhbWVyYU1hbmFnZXIgPSBfY2FtZXJhTWFuYWdlcjsKCiAgICAgICAgLy8gNS43IERldiBUb29scwppZiAod2luZG93LmZsdXguRGV2VG9vbHMpIHsKICAgICAgICAgICAgbmV3IHdpbmRvdy5mbHV4LkRldlRvb2xzKF9nYW1lTWFuYWdlcik7CiAgICAgICAgfQovLyA1LjggV2F0ZXIgT3ZlcmxheSwgTGlnaHQgU2hhZnRzLCBTdGFkaXVtLCBHbHlwaHMKICAgICAgICBfd2F0ZXJPdmVybGF5ID0gbmV3IHdpbmRvdy5mbHV4LldhdGVyT3ZlcmxheShfY2FtZXJhKTsKICAgICAgICBfbGlnaHRTaGFmdHMgPSBuZXcgd2luZG93LmZsdXguTGlnaHRTaGFmdHMoX3NjZW5lKTsKICAgICAgICBfc3RhZGl1bSA9IG5ldyB3aW5kb3cuZmx1eC5TdGFkaXVtKF9zY2VuZSk7CiAgICAgICAgX2dseXBoTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5HbHlwaE1hbmFnZXIoX3NjZW5lKTsKICAgICAgICAKaWYgKF9nYW1lTWFuYWdlcikgewogICAgICAgICAgICBfZ2FtZU1hbmFnZXIuZ2x5cGhNYW5hZ2VyID0gX2dseXBoTWFuYWdlcjsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLndhdGVyT3ZlcmxheSA9IF93YXRlck92ZXJsYXk7CiAgICAgICAgICAgIF9nYW1lTWFuYWdlci5saWdodFNoYWZ0cyA9IF9saWdodFNoYWZ0czsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnN0YWRpdW0gPSBfc3RhZGl1bTsKICAgICAgICB9CiAgICAgICAgLy8gNi4gVGVhbXMgU2V0dXAKICAgICAgICBfaG9tZVRlYW0gPSBuZXcgd2luZG93LmZsdXguVGVhbShfc2NlbmUsICdob21lJywgMSwgMHgwMGFhZmYsIHRydWUpOwogICAgICAgIF9hd2F5VGVhbSA9IG5ldyB3aW5kb3cuZmx1eC5UZWFtKF9zY2VuZSwgJ2F3YXknLCAtMSwgMHhmZjY2NjYsIGZhbHNlKTsKCiAgICAgICAgLy8gNy4gQmFsbAogICAgICAgIF9iYWxsID0gbmV3IHdpbmRvdy5mbHV4LkJhbGwoX3NjZW5lKTsKCiAgICAgICAgLy8gSU1QUk9WRUQ6IExpbmsgYmFsbCB0byBjYW1lcmEgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICBfY2FtZXJhTWFuYWdlci5zZXRCYWxsKF9iYWxsKTsKCiAgICAgICAgLy8gOC4gVGVhbSBSb3N0ZXIgTW9kZWxzCiAgICAgICAgY29uc3Qgcm9sZXMgPSBbJ0xGJywgJ1JGJywgJ01GJywgJ0xEJywgJ1JEJywgJ0dMJ107CiAgICAgICAgY29uc3QgaG9tZVJvc3RlciA9IHsKICAgICAgICAgICAgTEY6IHsgbmFtZTogJ1RpZHVzJywgdXJsOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2RhNzg4YmVmMjU4YzRmMGI4ZDllZjFhY2MxOWM1NTY3LmdsYicgfSwKICAgICAgICAgICAgUkY6IHsgbmFtZTogJ1dha2thJywgdXJsOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzLzU5MTE0Yzk4OTUxNjQ3YzliOGRhNzRiMGJkMzYzNmNiLmdsYicgfSwKICAgICAgICAgICAgTUY6IHsgbmFtZTogJ0xldHR5JywgdXJsOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzLzQzYWNlMzRjNmZkOTQyMTU5NjdlODQyYmY5MDlkYTVlLmdsYicgfSwKICAgICAgICAgICAgTEQ6IHsgbmFtZTogJ0RhdHRvJywgdXJsOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2U2ZDY3ZWNiMmU0YzQ3MTViZDczYTQwNzk1ZTFkM2Q1LmdsYicgfSwKICAgICAgICAgICAgUkQ6IHsgbmFtZTogJ0phc3N1JywgdXJsOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzLzgyMTY0NTk1NjczNTRlNjM5NThkNDEwOGQ4MjhkZTk4LmdsYicgfSwKICAgICAgICAgICAgR0w6IHsgbmFtZTogJ0JvdHRhJywgdXJsOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2FkMTU1ZWZlZGMwZDQ4ZmRhZDA5ZGEzZTFjYWU5Yzk3LmdsYicgfQogICAgICAgIH07CgogICAgICAgIGNvbnN0IGFwcGx5U3RhdHMgPSAocCwgcm9sZSwgaXNIb21lKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHRlYW1MZXZlbCA9IGlzSG9tZSA/IDI1IDogMjI7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LlRlYW0uZ2VuZXJhdGVTdGF0cyhwLCByb2xlLCB0ZWFtTGV2ZWwsIGlzSG9tZSk7CgogICAgICAgICAgICBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDU7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNQICs9IDM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDM7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkVOICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdCcm90aGVyJykpIHsKICAgICAgICAgICAgICAgIHAuc3RhdHMuU1AgPSA5OTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcC5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CiAgICAgICAgfTsKCiAgICAgICAgbGV0IGhvbWVMb2FkZWQgPSAwOwogICAgICAgIGNvbnN0IHJvbGVHbHRmcyA9IHt9OwoKICAgICAgICBjb25zdCBmaW5hbGl6ZVRlYW1zID0gKCkgPT4gewogICAgICAgICAgICByb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZ2x0ZiA9IHJvbGVHbHRmc1tyb2xlXSB8fCByb2xlR2x0ZnMuTEY7CgogICAgICAgICAgICAgICAgY29uc3QgcCA9IChyb2xlID09PSAnR0wnKQogICAgICAgICAgICAgICAgICAgID8gbmV3IHdpbmRvdy5mbHV4LkdvYWxpZShfc2NlbmUsIHJvbGUpCiAgICAgICAgICAgICAgICAgICAgOiBuZXcgd2luZG93LmZsdXguQUlQbGF5ZXIoX3NjZW5lLCByb2xlKTsKCiAgICAgICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgICAgICBwLmNoYXJhY3Rlck5hbWUgPSBlbnRyeSA/IGBDUFUgJHtlbnRyeS5uYW1lfWAgOiAnQ1BVJzsKICAgICAgICAgICAgICAgIGFwcGx5U3RhdHMocCwgcm9sZSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmICYmIGdsdGYuc2NlbmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjbG9uZSA9IFRIUkVFLlNrZWxldG9uVXRpbHMuY2xvbmUoZ2x0Zi5zY2VuZSk7CiAgICAgICAgICAgICAgICAgICAgcC5zZXRNZXNoKGNsb25lLCBnbHRmLmFuaW1hdGlvbnMgfHwgW10pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ01pc3NpbmcgR0xURiBmb3IgYXdheSByb2xlOicsIHJvbGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS5hZGRQbGF5ZXIocCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYWxsUGxheWVycyA9IFsuLi5faG9tZVRlYW0ucGxheWVycywgLi4uX2F3YXlUZWFtLnBsYXllcnNdOwogICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAocC5iYWxsUmVmID09PSBudWxsKSBwLmJhbGxSZWYgPSBfYmFsbDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyID0gX2hvbWVUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy50YWNrbGUgPSAndmVub20nOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy5zaG9vdCA9ICdzcGhlcmUnOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0VxdWlwcGVkIEhvbWUgTUYgd2l0aCBWZW5vbSBUYWNrbGUgJiBTcGhlcmUgU2hvdCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBhd2F5TUYgPSBfYXdheVRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgaWYgKGF3YXlNRikgewogICAgICAgICAgICAgICAgYXdheU1GLnRlY2hzLnRhY2tsZSA9ICd3aXRoZXInOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF9hd2F5VGVhbS5zZXRGb3JtYXRpb24oJ0NvdW50ZXInKTsKCiAgICAgICAgICAgIGNvbnN0IGF3YXlHTCA9IF9hd2F5VGVhbS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICBpZiAoYXdheUdMKSB7CiAgICAgICAgICAgICAgICBhd2F5R0wudGVjaHMuYWN0aXZlID0gJ3N1cGVyX2dvYWxpZSc7CiAgICAgICAgICAgICAgICBhd2F5R0wudGVjaHMucGFzc2l2ZSA9ICdncmlwX2dsb3Zlcyc7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRXF1aXBwZWQgQXdheSBHTCB3aXRoIFN1cGVyIEdvYWxpZScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfaG9tZVRlYW0uYXNzaWduTWFya3MoX2F3YXlUZWFtKTsKICAgICAgICAgICAgX2F3YXlUZWFtLmFzc2lnbk1hcmtzKF9ob21lVGVhbSk7CgogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9hZGluZycpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci5yZWdpc3RlclRlYW1zKF9ob21lVGVhbSwgX2F3YXlUZWFtLCBfYmFsbCk7CgogICAgICAgICAgICAgICAgX21lbnVNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4Lk1lbnVNYW5hZ2VyKF9nYW1lTWFuYWdlcik7CiAgICAgICAgICAgICAgICBfbWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCnJvbGVzLmZvckVhY2gocm9sZSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGVudHJ5ID0gaG9tZVJvc3Rlcltyb2xlXTsKICAgICAgICAgICAgaWYgKCFlbnRyeSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb25Db21wbGV0ZSA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGhvbWVMb2FkZWQrKzsKICAgICAgICAgICAgICAgIGlmIChob21lTG9hZGVkID49IHJvbGVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGZpbmFsaXplVGVhbXMoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbChlbnRyeS51cmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgICAgICByb2xlR2x0ZnNbcm9sZV0gPSBnbHRmOwoKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSAocm9sZSA9PT0gJ0dMJykKICAgICAgICAgICAgICAgICAgICA/IG5ldyB3aW5kb3cuZmx1eC5Hb2FsaWUoX3NjZW5lLCByb2xlKQogICAgICAgICAgICAgICAgICAgIDogbmV3IHdpbmRvdy5mbHV4LkFJUGxheWVyKF9zY2VuZSwgcm9sZSk7CgogICAgICAgICAgICAgICAgcC5jaGFyYWN0ZXJOYW1lID0gZW50cnkubmFtZTsKICAgICAgICAgICAgICAgIGFwcGx5U3RhdHMocCwgcm9sZSwgdHJ1ZSk7CgogICAgICAgICAgICAgICAgY29uc3QgY2xvbmUgPSBUSFJFRS5Ta2VsZXRvblV0aWxzLmNsb25lKGdsdGYuc2NlbmUpOwogICAgICAgICAgICAgICAgcC5zZXRNZXNoKGNsb25lLCBnbHRmLmFuaW1hdGlvbnMpOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFkZFBsYXllcihwKTsKCiAgICAgICAgICAgICAgICBvbkNvbXBsZXRlKCk7CiAgICAgICAgICAgIH0sIHVuZGVmaW5lZCwgKGVycikgPT4gewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGxvYWQgbW9kZWwnLCBlbnRyeS5uYW1lLCBlbnRyeS51cmwsIGVycik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIE1lc2ggKFJlZCBCb3gpCiAgICAgICAgICAgICAgICBjb25zdCBmYWxsYmFja0dlbyA9IG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSgxLCAyLCAxKTsKICAgICAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmYwMDAwLCB3aXJlZnJhbWU6IHRydWUgfSk7CiAgICAgICAgICAgICAgICBjb25zdCBmYWxsYmFja01lc2ggPSBuZXcgVEhSRUUuTWVzaChmYWxsYmFja0dlbywgZmFsbGJhY2tNYXQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTdG9yZSBkdW1teSBpbiByb2xlR2x0ZnMgZm9yIGF3YXkgdGVhbSBjbG9uaW5nCiAgICAgICAgICAgICAgICByb2xlR2x0ZnNbcm9sZV0gPSB7IHNjZW5lOiBmYWxsYmFja01lc2gsIGFuaW1hdGlvbnM6IFtdIH07CgogICAgICAgICAgICAgICAgY29uc3QgcCA9IChyb2xlID09PSAnR0wnKQogICAgICAgICAgICAgICAgICAgID8gbmV3IHdpbmRvdy5mbHV4LkdvYWxpZShfc2NlbmUsIHJvbGUpCiAgICAgICAgICAgICAgICAgICAgOiBuZXcgd2luZG93LmZsdXguQUlQbGF5ZXIoX3NjZW5lLCByb2xlKTsKCiAgICAgICAgICAgICAgICBwLmNoYXJhY3Rlck5hbWUgPSBlbnRyeS5uYW1lICsgIiAoRXJyb3IpIjsKICAgICAgICAgICAgICAgIGFwcGx5U3RhdHMocCwgcm9sZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHAuc2V0TWVzaChmYWxsYmFja01lc2guY2xvbmUoKSwgW10pOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFkZFBsYXllcihwKTsKCiAgICAgICAgICAgICAgICBvbkNvbXBsZXRlKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICAvLyA4LiBJbnB1dAogICAgICAgIHNldHVwSW5wdXRzKCk7CgogICAgICAgIC8vIDkuIExvb3AKICAgICAgICBfY2xvY2sgPSBuZXcgVEhSRUUuQ2xvY2soKTsKICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoYW5pbWF0ZSk7CgogICAgICAgIC8vIEhhbmRsZSByZXNpemUKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgb25SZXNpemUpOwogICAgICAgIG9uUmVzaXplKCk7CiAgICB9CgpmdW5jdGlvbiBjcmVhdGVQYXJ0aWNsZXMoKSB7CiAgICAgICAgY29uc3QgY291bnQgPSAxNTAwOyAvLyBJbmNyZWFzZWQgY291bnQKICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgIGNvbnN0IHZlcnRpY2VzID0gW107CiAgICAgICAgY29uc3Qgb2Zmc2V0cyA9IFtdOyAvLyBSYW5kb20gb2Zmc2V0cyBmb3IgaW5kZXBlbmRlbnQgYm9iYmluZwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICAgICAgdmVydGljZXMucHVzaCgKICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDgwLCAvLyBXaWRlciBzcHJlYWQgWAogICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogNTAsIC8vIFdpZGVyIHNwcmVhZCBZCiAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA4MCAgLy8gV2lkZXIgc3ByZWFkIFoKICAgICAgICAgICAgKTsKICAgICAgICAgICAgb2Zmc2V0cy5wdXNoKE1hdGgucmFuZG9tKCkgKiAxMDApOwogICAgICAgIH0KCiAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCdwb3NpdGlvbicsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKHZlcnRpY2VzLCAzKSk7CiAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCdhT2Zmc2V0JywgbmV3IFRIUkVFLkZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUob2Zmc2V0cywgMSkpOwoKICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgIHVuaWZvcm1zOiBfcGFydGljbGVVbmlmb3JtcywKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IGFPZmZzZXQ7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZBbHBoYTsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWMzIHBvcyA9IHBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgIC8vIEJvYmJpbmcgbW90aW9uOiBTaW5lIHdhdmUgYmFzZWQgb24gdGltZSArIHJhbmRvbSBvZmZzZXQKICAgICAgICAgICAgICAgICAgICBmbG9hdCBib2IgPSBzaW4odVRpbWUgKiAwLjUgKyBhT2Zmc2V0KSAqIDIuMDsKICAgICAgICAgICAgICAgICAgICBwb3MueSArPSBib2I7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdmVjNCBtdlBvc2l0aW9uID0gbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3MsIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbXZQb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTaXplIGF0dGVudWF0aW9uIC0gU21hbGwgYW5kIHNoaW1tZXJ5CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc2l6ZUJhc2UgPSAyLjAgKyBzaW4odVRpbWUgKiAzLjAgKyBhT2Zmc2V0KSAqIDEuMDsgCiAgICAgICAgICAgICAgICAgICAgZ2xfUG9pbnRTaXplID0gc2l6ZUJhc2UgKiAoMjAuMCAvIC1tdlBvc2l0aW9uLnopOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhZGUgYmFzZWQgb24gZGlzdGFuY2UvaGVpZ2h0CiAgICAgICAgICAgICAgICAgICAgdkFscGhhID0gMC41ICsgMC41ICogc2luKHVUaW1lICogMi4wICsgYU9mZnNldCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAsCiAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZBbHBoYTsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTb2Z0IGdsb3cgcGFydGljbGUgKER1c3QgbW90ZSkKICAgICAgICAgICAgICAgICAgICB2ZWMyIGNvb3JkID0gZ2xfUG9pbnRDb29yZCAtIHZlYzIoMC41KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkaXN0ID0gbGVuZ3RoKGNvb3JkKTsKICAgICAgICAgICAgICAgICAgICBpZihkaXN0ID4gMC41KSBkaXNjYXJkOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFNvZnQgZmFsbG9mZiBmb3Igc2hpbW1lcgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHN0cmVuZ3RoID0gMS4wIC0gKGRpc3QgKiAyLjApOwogICAgICAgICAgICAgICAgICAgIHN0cmVuZ3RoID0gcG93KHN0cmVuZ3RoLCAyLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEN5YW4vQmx1ZSB0aW50LCBhZGRpdGl2ZSBmZWVsCiAgICAgICAgICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNCgwLjcsIDAuOSwgMS4wLCB2QWxwaGEgKiBzdHJlbmd0aCAqIDAuOCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgcG9pbnRzID0gbmV3IFRIUkVFLlBvaW50cyhnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgIHBvaW50cy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgX3NjZW5lLmFkZChwb2ludHMpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlQXJlbmEoKSB7CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuU3BoZXJlR2VvbWV0cnkoX2NvbmZpZy5hcmVuYVJhZGl1cywgMzIsIDMyKTsKICAgICAgICAKICAgICAgICBjb25zdCB0ZXhMb2FkZXIgPSBuZXcgVEhSRUUuVGV4dHVyZUxvYWRlcigpOwogICAgICAgIGNvbnN0IGFyZW5hVGV4ID0gdGV4TG9hZGVyLmxvYWQoJ2h0dHBzOi8vaS5wb3N0aW1nLmNjL1cxTHNINjhRL2ZpbGUtMDAwMDAwMDAyM2VjNzFmNTk2NTkzODI5ZTgxMTg3NjAtKDEpLnBuZycpOwogICAgICAgIGFyZW5hVGV4Lm1hZ0ZpbHRlciA9IFRIUkVFLk5lYXJlc3RGaWx0ZXI7CiAgICAgICAgYXJlbmFUZXgubWluRmlsdGVyID0gVEhSRUUuTmVhcmVzdEZpbHRlcjsKICAgICAgICBhcmVuYVRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGFyZW5hVGV4LndyYXBUID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgYXJlbmFUZXgucmVwZWF0LnNldCg2LCA0KTsKCiAgICAgICAgLy8gLS0tIFByb2NlZHVyYWwgSGV4IFRleHR1cmUgKElubmVyIExheWVyKSAtLS0KICAgICAgICBjb25zdCBoZXhUZXggPSAoKCkgPT4gewogICAgICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgICAgIGMud2lkdGggPSA1MTI7IGMuaGVpZ2h0ID0gNTEyOwogICAgICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgIC8vIFRyYW5zcGFyZW50IGJhY2tncm91bmQKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLDAsNTEyLDUxMik7CiAgICAgICAgICAgIAogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgwLCAyNTUsIDI1NSwgMC44KSc7CiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgICAgICBjdHguc2hhZG93Qmx1ciA9IDEwOwogICAgICAgICAgICBjdHguc2hhZG93Q29sb3IgPSAnIzAwZmZmZic7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCByID0gNjQ7CiAgICAgICAgICAgIGNvbnN0IHcgPSByICogMjsKICAgICAgICAgICAgY29uc3QgaCA9IE1hdGguc3FydCgzKSAqIHI7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEcmF3IEhleGVzCiAgICAgICAgICAgIGZvcihsZXQgeSA9IC0xOyB5IDwgNTEyL2ggKyAyOyB5KyspIHsKICAgICAgICAgICAgICAgIGZvcihsZXQgeCA9IC0xOyB4IDwgNTEyLyh3KjAuNzUpICsgMjsgeCsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3ggPSB4ICogdyAqIDAuNzU7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3kgPSB5ICogaCArICh4JTI9PT0wID8gMCA6IGgvMik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDY7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmcgPSBNYXRoLlBJLzMgKiBpOwogICAgICAgICAgICAgICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYW5nKSpyLCBjeSArIE1hdGguc2luKGFuZykqcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ2VudGVyIGRvdAogICAgICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgwLCAxMDAsIDI1NSwgMC4zKSc7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKGN4LCBjeSwgNSwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICAgICAgfSkoKTsKICAgICAgICBoZXhUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBoZXhUZXgud3JhcFQgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBoZXhUZXgucmVwZWF0LnNldCg0LCAyKTsKCiAgICAgICAgLy8gLS0tIEFyZW5hIDEgKE91dGVyIEdyaWQpIC0tLQogICAgICAgIGNvbnN0IG1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiBhcmVuYVRleCwKICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLAogICAgICAgICAgICB3aXJlZnJhbWU6IGZhbHNlLAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKb3BhY2l0eTogMC4zLCAKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgY29uc3QgYXJlbmEgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgIF9zY2VuZS5hZGQoYXJlbmEpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaCA9IGFyZW5hOwoKICAgICAgICAvLyAtLS0gQXJlbmEgMiAoSW5uZXIgSGV4ICsgSW1wYWN0IFNoYWRlcikgLS0tCiAgICAgICAgLy8gV2UgdXNlIGEgY3VzdG9tIHNoYWRlciB0byB3YXJwIHZlcnRpY2VzIG9uIGltcGFjdAogICAgICAgIGNvbnN0IGFyZW5hVW5pZm9ybXMgPSBUSFJFRS5Vbmlmb3Jtc1V0aWxzLm1lcmdlKFsKICAgICAgICAgICAgVEhSRUUuVW5pZm9ybXNMaWJbJ2NvbW1vbiddLAogICAgICAgICAgICBfYXJlbmFVbmlmb3JtcywKICAgICAgICAgICAgeyAKICAgICAgICAgICAgICAgIHRNYXA6IHsgdmFsdWU6IGhleFRleCB9LAp1T3BhY2l0eTogeyB2YWx1ZTogMC4yNSB9IC8vIEV4cG9zZWQgdW5pZm9ybQogICAgICAgICAgICB9CiAgICAgICAgXSk7CgogICAgICAgIGNvbnN0IG1hdGVyaWFsMiA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgIHVuaWZvcm1zOiBhcmVuYVVuaWZvcm1zLAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgc2lkZTogVEhSRUUuQmFja1NpZGUsCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMzIHVJbXBhY3RQb3M7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVJbXBhY3RTdHI7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdlV2OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdlV2ID0gdXY7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJbXBhY3QgTG9naWMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkaXN0ID0gZGlzdGFuY2UocG9zLCB1SW1wYWN0UG9zKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYWRpdXMgPSAyMC4wOyAvLyBSYWRpdXMgb2YgZGVmb3JtYXRpb24KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHJhZGl1cykgewogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCB0ID0gZGlzdCAvIHJhZGl1czsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgYnVsZ2UgPSAoMS4wIC0gdCkgKiAoMS4wIC0gdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHJpcHBsZSA9IHNpbih0ICogMTAuMCAtIHVUaW1lICogNS4wKSAqIDAuMTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBub3JtYWwgPSBub3JtYWxpemUocG9zKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zICs9IG5vcm1hbCAqIChidWxnZSAqIHVJbXBhY3RTdHIpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3MsIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAsCiAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIHNhbXBsZXIyRCB0TWFwOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1SW1wYWN0U3RyOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWM0IHRleENvbG9yID0gdGV4dHVyZTJEKHRNYXAsIHZVdik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQmFzZSBvcGFjaXR5ICsgSW1wYWN0IEhpZ2hsaWdodAogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gdU9wYWNpdHkgKiB0ZXhDb2xvci5hOwogICAgICAgICAgICAgICAgICAgIGFscGhhICs9IHVJbXBhY3RTdHIgKiAwLjAyOyAKCiAgICAgICAgICAgICAgICAgICAgLy8gVGludCBDeWFuL0JsdWUKICAgICAgICAgICAgICAgICAgICB2ZWMzIGNvbG9yID0gdGV4Q29sb3IucmdiICogdmVjMygwLjUsIDEuMCwgMS4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTY2FubGluZSBlZmZlY3QKICAgICAgICAgICAgICAgICAgICBmbG9hdCBzY2FuID0gc2luKHZVdi55ICogMTAwLjAgKyB1SW1wYWN0U3RyKSAqIDAuMTsKICAgICAgICAgICAgICAgICAgICBjb2xvciArPSBzY2FuOwoKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbG9yLCBhbHBoYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgYXJlbmEyID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsMik7CiAgICAgICAgYXJlbmEyLnNjYWxlLnNldFNjYWxhcigwLjk4KTsgLy8gU2xpZ2h0bHkgc21hbGxlcgogICAgICAgIF9zY2VuZS5hZGQoYXJlbmEyKTsKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyID0gYXJlbmEyOwogICAgICAgIC8vIC0tLSBORVc6IEZGWCBHT0FMIE1PREVMUyAtLS0KICAgICAgICBjb25zdCBnb2FsVXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hNTE2YmQ5MGZhN2M0ZGVkYjVkY2JmZGY4MDNmMTNkNS5nbGInOwogICAgICAgIAogICAgICAgIGNvbnN0IG9uR29hbExvYWRlZCA9IChtb2RlbCwgaXNGYWxsYmFjaykgPT4gewogICAgICAgICAgICBjb25zdCBnb2FsQSA9IG1vZGVsOwogICAgICAgICAgICAvLyBNb3ZlZCBkb3duIH4xNWZ0ICg0LjVtKSB0b3RhbCBhcyByZXF1ZXN0ZWQKLy8gTW92ZWQgZG93biB+MTVmdCAoNC41bSkgdG90YWwgYXMgcmVxdWVzdGVkLCBwdXNoZWQgYmFjayB0byBlZGdlCiAgICAgICAgICAgIGdvYWxBLnBvc2l0aW9uLnNldCgwLCAtNC41LCAtNDYpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFpc0ZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBnb2FsQS5zY2FsZS5zZXRTY2FsYXIoNTQuMCk7IC8vIEluY3JlYXNlZCA1MCUgKHdhcyAzNi4wKQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFNldHVwIEdvYWwgQQogICAgICAgICAgICBnb2FsQS50cmF2ZXJzZShjID0+IHsKICAgICAgICAgICAgICAgIGlmKGMuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgYy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7IC8vIENSSVRJQ0FMOiBQcmV2ZW50IGN1bGxpbmcKICAgICAgICAgICAgICAgICAgICBjLnJlbmRlck9yZGVyID0gMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgbWF0ZXJpYWwgaXMgdmlzaWJsZQogICAgICAgICAgICAgICAgICAgIGlmIChjLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZmZmZmKTsgLy8gV2hpdGUgdG8gc2hvdyBvcmlnaW5hbCB0ZXh0dXJlL2NvbG9ycyAod2FzIGJsdWUpCiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwudHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLnNpZGUgPSBUSFJFRS5Eb3VibGVTaWRlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmRlcHRoV3JpdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmRlcHRoVGVzdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgX3NjZW5lLmFkZChnb2FsQSk7CgogICAgICAgICAgICAvLyBTZXR1cCBHb2FsIEIKICAgICAgICAgICAgY29uc3QgZ29hbEIgPSBpc0ZhbGxiYWNrID8gZ29hbEEuY2xvbmUoKSA6IFRIUkVFLlNrZWxldG9uVXRpbHMuY2xvbmUoZ29hbEEpOwoKZ29hbEIucG9zaXRpb24uc2V0KDAsIC00LjUsIDQ2KTsgLy8gTW92ZWQgY2xvc2VyICh3YXMgNDUpIGFuZCBkb3duCiAgICAgICAgICAgIGdvYWxCLnJvdGF0aW9uLnkgPSBNYXRoLlBJOwogICAgICAgICAgICAvLyBFbnN1cmUgR29hbCBCIG1lc2hlcyBhcmUgYWxzbyBwZXJzaXN0ZW50CiAgICAgICAgICAgIGdvYWxCLnRyYXZlcnNlKGMgPT4gewogICAgICAgICAgICAgICAgaWYoYy5pc01lc2gpIGMuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIF9zY2VuZS5hZGQoZ29hbEIpOwogICAgICAgIH07CgogICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbChnb2FsVXJsLCAoZ2x0ZikgPT4gewogICAgICAgICAgICBvbkdvYWxMb2FkZWQoZ2x0Zi5zY2VuZSwgZmFsc2UpOwogICAgICAgIH0sIHVuZGVmaW5lZCwgKGVycikgPT4gewogICAgICAgICAgICBjb25zb2xlLndhcm4oIkdvYWwgbW9kZWwgZmFpbGVkIHRvIGxvYWQuIFVzaW5nIGZhbGxiYWNrLiIsIGVycik7CiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSg3NSwgNDUsIDEwKTsgLy8gRmFsbGJhY2sgbWFzc2l2ZSBib3ggKFNjYWxlZCAxLjV4KQogICAgICAgICAgICBjb25zdCBmYWxsYmFja01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmZmZmZiwgd2lyZWZyYW1lOiB0cnVlIH0pOwogICAgICAgICAgICBjb25zdCBmYWxsYmFjayA9IG5ldyBUSFJFRS5NZXNoKGdlbywgZmFsbGJhY2tNYXQpOwogICAgICAgICAgICBvbkdvYWxMb2FkZWQoZmFsbGJhY2ssIHRydWUpOwogICAgICAgIH0pOwoKICAgICAgICAvLyAtLS0gTkVXOiBNQVNTSVZFIEZJRUxEIE1BUktJTkdTIC0tLQogICAgICAgIGNyZWF0ZUZpZWxkTWFya2luZ3MoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVGaWVsZE1hcmtpbmdzKCkgewogICAgICAgIGNvbnN0IHNpemUgPSAxMDI0OwogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gc2l6ZTsgYy5oZWlnaHQgPSBzaXplOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBjeCA9IHNpemUvMjsgY29uc3QgY3kgPSBzaXplLzI7CgogICAgICAgIC8vIEhlbHBlciB0byBkcmF3CiAgICAgICAgY29uc3QgZHJhdyA9ICgpID0+IHsKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBzaXplLCBzaXplKTsKCiAgICAgICAgICAgIC8vIEdsb3cgU2V0dGluZ3MKICAgICAgICAgICAgY3R4LnNoYWRvd0JsdXIgPSAyMDsKICAgICAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gJyMwMGZmZmYnOwogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgxMDAsIDI1NSwgMjU1LCAwLjkpJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDU7CiAgICAgICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKCiAgICAgICAgICAgIC8vIDEuIE1haW4gRmllbGQgQ2lyY2xlIChUaGUgU3BoZXJlIEVxdWF0b3IpCiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDQ1MCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgLy8gMi4gSW5uZXIgRGVjb3JhdGl2ZSBSaW5nCiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDQyMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDAsIDIwMCwgMjU1LCAwLjUpJzsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgLy8gMy4gQ2VudGVyIEJsaXR6b2ZmIFpvbmUgKENvbXBsZXggU3Rhci9SdW5lKQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45KSc7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDgwLCAwLCBNYXRoLlBJKjIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbm5lciBTdGFyIFBhdHRlcm4KICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw1OyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGEgPSAoaS81KSpNYXRoLlBJKjIgLSBNYXRoLlBJLzI7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gY3ggKyBNYXRoLmNvcyhhKSo2MDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjeSArIE1hdGguc2luKGEpKjYwOwogICAgICAgICAgICAgICAgaWYoaT09PTApIGN0eC5tb3ZlVG8oeCx5KTsgZWxzZSBjdHgubGluZVRvKHgseSk7CiAgICAgICAgICAgICAgICAvLyBJbm5lciBwb2ludAogICAgICAgICAgICAgICAgY29uc3QgYTIgPSAoKGkrMC41KS81KSpNYXRoLlBJKjIgLSBNYXRoLlBJLzI7CiAgICAgICAgICAgICAgICBjb25zdCB4MiA9IGN4ICsgTWF0aC5jb3MoYTIpKjI1OwogICAgICAgICAgICAgICAgY29uc3QgeTIgPSBjeSArIE1hdGguc2luKGEyKSoyNTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeDIseTIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgLy8gNC4gTWlkZmllbGQgTGluZQogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oMCwgY3kpOyBjdHgubGluZVRvKHNpemUsIGN5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgLy8gNS4gR29hbCBCb3hlcyAoVHJhcGV6b2lkcykKICAgICAgICAgICAgY29uc3QgZHJhd0dvYWxCb3ggPSAoeVBvcywgZGlyKSA9PiB7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKGN4IC0gMTUwLCB5UG9zKTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oY3ggKyAxNTAsIHlQb3MpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIDIyNSwgeVBvcyArIChkaXIgKiAxMjApKTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oY3ggLSAyMjUsIHlQb3MgKyAoZGlyICogMTIwKSk7CiAgICAgICAgICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGRyYXdHb2FsQm94KDUwLCAxKTsgLy8gVG9wIChIb21lIHNpZGUgaW4gdGV4dHVyZSBzcGFjZSkKICAgICAgICAgICAgZHJhd0dvYWxCb3goc2l6ZS01MCwgLTEpOyAvLyBCb3R0b20KCiAgICAgICAgICAgIC8vIDYuIFJ1bmVzIChQcm9jZWR1cmFsIFRleHQgUmluZykKICAgICAgICAgICAgLy8gVXNlIFNwaXJhIGZvbnQgaWYgbG9hZGVkLCBmYWxsYmFjayB0byBtb25vc3BhY2UKICAgICAgICAgICAgY3R4LmZvbnQgPSAnMzJweCBTcGlyYSwgbW9ub3NwYWNlJzsgCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgwLCAyNTUsIDI1NSwgMC43KSc7CiAgICAgICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICAgICAgY3R4LnRleHRCYXNlbGluZSA9ICdtaWRkbGUnOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcnVuZXMgPSAiQkxJVFpCQUxMIFNQSEVSRSBQT09MIFpBTkFSS0FORCBBQllTUyBFVEVSTkFMIENBTE0gIjsKICAgICAgICAgICAgY29uc3QgcnVuZUNvdW50ID0gMzI7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHJ1bmVDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gcnVuZUNvdW50KSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgY29uc3QgciA9IDQ4MDsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBjeCArIE1hdGguY29zKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gY3kgKyBNYXRoLnNpbihhbmdsZSkgKiByOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICAgICAgY3R4LnRyYW5zbGF0ZSh4LCB5KTsKICAgICAgICAgICAgICAgIGN0eC5yb3RhdGUoYW5nbGUgKyBNYXRoLlBJLzIpOwogICAgICAgICAgICAgICAgY29uc3QgY2hhciA9IHJ1bmVzW2kgJSBydW5lcy5sZW5ndGhdOwogICAgICAgICAgICAgICAgY3R4LmZpbGxUZXh0KGNoYXIsIDAsIDApOwogICAgICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdGV4ID0gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICAgICAgICAgIHRleC5hbmlzb3Ryb3B5ID0gMTY7CgogICAgICAgICAgICAvLyBGbG9vciBQbGFuZSAoRGVlcCkKLy8gRmxvb3IgUGxhbmUgKERlZXApCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDkwLCA5MCk7CiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBtYXA6IHRleCwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC44LAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjb25zdCBmaWVsZCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgbWF0KTsKICAgICAgICAgICAgZmllbGQucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICAgICAgZmllbGQucG9zaXRpb24ueSA9IC04LjA7IC8vIFN1bmsgZGVlcCBpbnRvIHRoZSBzcGhlcmUKICAgICAgICAgICAgX3NjZW5lLmFkZChmaWVsZCk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gQXR0ZW1wdCB0byBsb2FkIGZvbnQgZmlyc3QKICAgICAgICBkb2N1bWVudC5mb250cy5sb2FkKCczMnB4IFNwaXJhJykudGhlbigoKSA9PiB7CiAgICAgICAgICAgIGRyYXcoKTsKICAgICAgICB9KS5jYXRjaCgoKSA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiU3BpcmEgZm9udCBmYWlsZWQgdG8gbG9hZCBmb3IgY2FudmFzLCB1c2luZyBmYWxsYmFjay4iKTsKICAgICAgICAgICAgZHJhdygpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBGbG9hdGluZyBIb2xvZ3JhcGhpYyBSaW5ncyAoTWlkLWhlaWdodCkKICAgICAgICBjb25zdCByaW5nR2VvID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkoMjAsIDAuMSwgMTYsIDEwMCk7CiAgICAgICAgY29uc3QgcmluZ01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiwgdHJhbnNwYXJlbnQ6IHRydWUsIG9wYWNpdHk6IDAuMywgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcgfSk7CiAgICAgICAgY29uc3QgcmluZzEgPSBuZXcgVEhSRUUuTWVzaChyaW5nR2VvLCByaW5nTWF0KTsKICAgICAgICByaW5nMS5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDI7CiAgICAgICAgcmluZzEucG9zaXRpb24ueSA9IDA7CiAgICAgICAgX3NjZW5lLmFkZChyaW5nMSk7CiAgICAgICAgCiAgICAgICAgY29uc3QgcmluZzIgPSBuZXcgVEhSRUUuTWVzaChyaW5nR2VvLCByaW5nTWF0KTsKICAgICAgICByaW5nMi5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDI7CiAgICAgICAgcmluZzIuc2NhbGUuc2V0U2NhbGFyKDEuMik7CiAgICAgICAgcmluZzIucG9zaXRpb24ueSA9IDQuMDsKICAgICAgICBfc2NlbmUuYWRkKHJpbmcyKTsKCiAgICAgICAgLy8gQW5pbWF0ZSBSaW5ncyAoaW50ZWdyYXRlZCBpbnRvIG1haW4gbG9vcCB0byBhdm9pZCBhIHNlY29uZCBSQUYgb24gbW9iaWxlKQogICAgICAgIGxldCBfcmluZ1RpbWUgPSAwOwogICAgICAgIGNvbnN0IF9yaW5nVXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIF9yaW5nVGltZSArPSBkdDsKICAgICAgICAgICAgaWYgKHJpbmcxKSB7CiAgICAgICAgICAgICAgICByaW5nMS5yb3RhdGlvbi56ICs9IGR0ICogMC45OwogICAgICAgICAgICAgICAgcmluZzEuc2NhbGUuc2V0U2NhbGFyKDEuMCArIE1hdGguc2luKF9yaW5nVGltZSAqIDAuNSkgKiAwLjA1KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmluZzIpIHsKICAgICAgICAgICAgICAgIHJpbmcyLnJvdGF0aW9uLnogLT0gZHQgKiAwLjc1OwogICAgICAgICAgICAgICAgcmluZzIucG9zaXRpb24ueSA9IDQuMCArIE1hdGguY29zKF9yaW5nVGltZSAqIDAuNykgKiAxLjA7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGlmICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzKSB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLnB1c2goX3JpbmdVcGRhdGUpOwp9CgogICAgLy8gLS0tIElOUFVUIFNZU1RFTSAtLS0KLy8gLS0tIElOUFVUIFNZU1RFTSAtLS0KY29uc3QgX2tleXMgPSB7fTsKLy8gR2xvYmFscyBtb3ZlZCB0byBiZWxvdyBoZWxwZXIKCiAgICAvLyBIZWxwZXI6IEFuYWx5emUgY3VydmUgZ2VvbWV0cnkgZm9yIGFuYWxvZyBjb250cm9sCiAgICBjb25zdCBhbmFseXplU3dpcGVDdXJ2ZSA9IChwb2ludHMpID0+IHsKICAgICAgICBpZiAocG9pbnRzLmxlbmd0aCA8IDMpIHJldHVybiB7IGludGVuc2l0eTogMCwgc3BlZWQ6IDAsIGR4OiAwLCBkeTogMCB9OwogICAgICAgIAogICAgICAgIGNvbnN0IHBTdGFydCA9IHBvaW50c1swXTsKICAgICAgICBjb25zdCBwRW5kID0gcG9pbnRzW3BvaW50cy5sZW5ndGggLSAxXTsKICAgICAgICBjb25zdCBtaWRJZHggPSBNYXRoLmZsb29yKHBvaW50cy5sZW5ndGggLyAyKTsKICAgICAgICBjb25zdCBwTWlkID0gcG9pbnRzW21pZElkeF07CgogICAgICAgIGNvbnN0IGR4ID0gcEVuZC54IC0gcFN0YXJ0Lng7CiAgICAgICAgY29uc3QgZHkgPSBwRW5kLnkgLSBwU3RhcnQueTsKICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwogICAgICAgIGNvbnN0IGR0ID0gcEVuZC50IC0gcFN0YXJ0LnQ7CiAgICAgICAgY29uc3Qgc3BlZWQgPSAoZHQgPiAwKSA/IGRpc3QgLyBkdCA6IDA7IC8vIHB4L21zCgogICAgICAgIGlmIChkaXN0IDwgNTApIHJldHVybiB7IGludGVuc2l0eTogMCwgc3BlZWQ6IHNwZWVkLCBkeCwgZHkgfTsKCiAgICAgICAgY29uc3QgdlNNX3ggPSBwTWlkLnggLSBwU3RhcnQueDsKICAgICAgICBjb25zdCB2U01feSA9IHBNaWQueSAtIHBTdGFydC55OwoKICAgICAgICAvLyBDcm9zcyBwcm9kdWN0IGdpdmVzIHNpZ25lZCBhcmVhL2N1cnZhdHVyZSBkaXJlY3Rpb24KICAgICAgICBjb25zdCBjcm9zcyA9IChkeCAqIHZTTV95KSAtIChkeSAqIHZTTV94KTsKICAgICAgICAvLyBOb3JtYWxpemUgYnkgZGlzdGFuY2Ugc3F1YXJlZCB0byBnZXQgYSBjdXJ2YXR1cmUgcmF0aW8gaW5kZXBlbmRlbnQgb2Ygc2NhbGUKY29uc3QgaW50ZW5zaXR5ID0gY3Jvc3MgLyAoZGlzdCAqIGRpc3QpOwoKICAgICAgICByZXR1cm4geyBpbnRlbnNpdHksIHNwZWVkLCBkeCwgZHkgfTsKICAgIH07CiAgICBsZXQgX3N3aXBlUG9pbnRzID0gW107IC8vIFRyYWNrIHN3aXBlIGhpc3RvcnkgZm9yIGN1cnZlcwogICAgY29uc3QgX2FpbUlucHV0ID0geyB4OiAwLCB5OiAwLCBhY3RpdmU6IGZhbHNlIH07IC8vIE5FVzogQWltIGpveXN0aWNrCgogICAgY29uc3QgX2FjdGlvbkJ1ZmZlciA9IHsgYWN0aXZlOiBmYWxzZSwgdGltZXN0YW1wOiAwLCBkdXJhdGlvbjogMzAwIH07CgogICAgY29uc3QgX2NhbUZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfY2FtUmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3VwQXhpcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApOwoKICAgIGZ1bmN0aW9uIHNldHVwSW5wdXRzKCkgewogICAgICAgIC8vIEtleWJvYXJkCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICBfa2V5c1tlLmtleV0gPSB0cnVlOwogICAgICAgICAgICBpZiAoZS5jb2RlID09PSAnU3BhY2UnICYmIF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyICYmIF9iYWxsKSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLnRocm93QmFsbChfYmFsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gTkVXOiBUYWNrbGUgb24gU2hpZnQKICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ1NoaWZ0TGVmdCcgfHwgZS5jb2RlID09PSAnU2hpZnRSaWdodCcpIHsKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuZGFzaChwLmlucHV0VmVjdG9yLngsIHAuaW5wdXRWZWN0b3Iueik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CiAgICAgICAgfSk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgKGUpID0+IHsgX2tleXNbZS5rZXldID0gZmFsc2U7IHVwZGF0ZUlucHV0VmVjdG9yKCk7IH0pOwoKICAgICAgICAvLyAtLS0gRkxPQVRJTkcgSk9ZU1RJQ0sgKE1vdmVtZW50KSAtLS0KICAgICAgICBjb25zdCBoaXRab25lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2pveXN0aWNrLWhpdC16b25lJyk7CiAgICAgICAgY29uc3QgdmlzdWFscyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay12aXN1YWwtY29udGFpbmVyJyk7CiAgICAgICAgY29uc3QgYmFzZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1iYXNlJyk7CiAgICAgICAgY29uc3Qga25vYiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1rbm9iJyk7CgogICAgICAgIGxldCBzdGFydFggPSAwLCBzdGFydFkgPSAwOwogICAgICAgIGxldCBkcmFnZ2luZyA9IGZhbHNlOwogICAgICAgIGNvbnN0IG1heERpc3QgPSA0MDsKCiAgICAgICAgbGV0IG1vdmVUb3VjaElkID0gbnVsbDsKICAgICAgICBjb25zdCBtb3ZlRGVhZHpvbmVQeCA9IDY7CgogICAgICAgIC8vIEV4cG9zZSBtb3ZlIGpveXN0aWNrIHN0YXRlIGZvciBzbmFwc2hvdHMKICAgICAgICBjb25zdCBfZGJnID0gd2luZG93LmZsdXguX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyB8fCB7fTsKICAgICAgICBfZGJnLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgICAgIF9kYmcuaW5wdXQgPSBfZGJnLmlucHV0IHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQubW92ZSA9IF9kYmcuaW5wdXQubW92ZSB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUudmVjdG9yID0gX2lucHV0OwogICAgICAgIF9kYmcuaW5wdXQubW92ZS5kcmFnZ2luZyA9IGRyYWdnaW5nOwogICAgICAgIF9kYmcuaW5wdXQubW92ZS50b3VjaElkID0gbW92ZVRvdWNoSWQ7CgoKICAgICAgICBjb25zdCBoYW5kbGVTdGFydCA9IChjbGllbnRYLCBjbGllbnRZKSA9PiB7CiAgICAgICAgICAgIGRyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgc3RhcnRYID0gY2xpZW50WDsKCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5tb3ZlKSB7CiAgICAgICAgICAgICAgICBfZGJnLmlucHV0Lm1vdmUuZHJhZ2dpbmcgPSBkcmFnZ2luZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3RhcnRZID0gY2xpZW50WTsKCiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUubGVmdCA9IGAke2NsaWVudFh9cHhgOwogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLnRvcCA9IGAke2NsaWVudFl9cHhgOwoKICAgICAgICAgICAga25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKC01MCUsIC01MCUpYDsKCiAgICAgICAgICAgIGNyZWF0ZVJpcHBsZShjbGllbnRYLCBjbGllbnRZKTsKCiAgICAgICAgICAgIF9pbnB1dC54ID0gMDsKICAgICAgICAgICAgX2lucHV0LnkgPSAwOwogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGhhbmRsZU1vdmUgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CgogICAgICAgICAgICBsZXQgZHggPSBjbGllbnRYIC0gc3RhcnRYOwogICAgICAgICAgICBsZXQgZHkgPSBjbGllbnRZIC0gc3RhcnRZOwoKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCgogICAgICAgICAgICAvLyBEZWFkem9uZSB0byBwcmV2ZW50IGRyaWZ0IGZyb20gdGlueSB0aHVtYiBqaXR0ZXIKICAgICAgICAgICAgaWYgKGRpc3QgPCBtb3ZlRGVhZHpvbmVQeCkgewogICAgICAgICAgICAgICAgZHggPSAwOwogICAgICAgICAgICAgICAgZHkgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgIGR4ID0gKGR4IC8gZGlzdCkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgZHkgPSAoZHkgLyBkaXN0KSAqIG1heERpc3Q7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZShjYWxjKC01MCUgKyAke2R4fXB4KSwgY2FsYygtNTAlICsgJHtkeX1weCkpYDsKCiAgICAgICAgICAgIF9pbnB1dC54ID0gKGR4IC8gbWF4RGlzdCkgKiBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eTsKICAgICAgICAgICAgX2lucHV0LnkgPSAoZHkgLyBtYXhEaXN0KSAqIF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5OwogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGhhbmRsZUVuZCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBkcmFnZ2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgbW92ZVRvdWNoSWQgPSBudWxsOwoKICAgICAgICAgICAgdmlzdWFscy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0Lm1vdmUpIHsKICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS5kcmFnZ2luZyA9IGRyYWdnaW5nOwogICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnRvdWNoSWQgPSBtb3ZlVG91Y2hJZDsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIF9pbnB1dC54ID0gMDsKICAgICAgICAgICAgX2lucHV0LnkgPSAwOwogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH07CgogICAgICAgIGlmIChoaXRab25lKSB7CiAgICAgICAgICAgIGhpdFpvbmUuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlc1swXSkgPyBlLmNoYW5nZWRUb3VjaGVzWzBdIDogZS50b3VjaGVzWzBdOwogICAgICAgICAgICAgICAgbW92ZVRvdWNoSWQgPSB0ID8gdC5pZGVudGlmaWVyIDogbnVsbDsKICAgICAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5tb3ZlKSB7CiAgICAgICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnRvdWNoSWQgPSBtb3ZlVG91Y2hJZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhhbmRsZVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IF9maW5kVG91Y2hCeUlkKGUudG91Y2hlcywgbW92ZVRvdWNoSWQpOwogICAgICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgICAgICBoYW5kbGVNb3ZlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIG1vdmVUb3VjaElkKTsKICAgICAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOyAvLyBJZ25vcmUgb3RoZXIgZmluZ2VycyBsaWZ0aW5nCiAgICAgICAgICAgICAgICBoYW5kbGVFbmQoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIG1vdmVUb3VjaElkKTsKICAgICAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgaGFuZGxlRW5kKCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaGl0Wm9uZS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaGFuZGxlU3RhcnQoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZHJhZ2dpbmcpIGhhbmRsZU1vdmUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVFbmQpOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIE5FVzogQUlNIEpPWVNUSUNLIChSaWdodCBzaWRlKSAtLS0KICAgICAgICBzZXR1cEFpbUpveXN0aWNrKCk7CgogICAgICAgIC8vIC0tLSBORVc6IFRBQ0tMRSBCVVRUT04gLS0tCiAgICAgICAgc2V0dXBUYWNrbGVCdXR0b24oKTsKCiAgICAgICAgLy8gU3dpcGUgRGV0ZWN0aW9uCi8vIFN3aXBlIERldGVjdGlvbgogICAgICAgIGxldCBzd2lwZVN0YXJ0ID0geyB4OiAwLCB5OiAwLCB0OiAwIH07CiAgICAgICAgbGV0IHN3aXBlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgCiAgICAgICAgLy8gRXhwb3NlIHN3aXBlL3Rocm93IGdlc3R1cmUgc3RhdGUgZm9yIHNuYXBzaG90cwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUgPSBfZGJnLmlucHV0LnN3aXBlIHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUuc3RhcnQgPSBzd2lwZVN0YXJ0OwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsKICAgICAgICBfZGJnLmlucHV0LnN3aXBlLnBvaW50cyA9IF9zd2lwZVBvaW50czsKY29uc3Qgb25Td2lwZVN0YXJ0ID0gKHgsIHkpID0+IHsKICAgICAgICAgICAgc3dpcGVTdGFydC54ID0geDsKICAgICAgICAgICAgc3dpcGVTdGFydC55ID0geTsKICAgICAgICAgICAgc3dpcGVTdGFydC50ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgX3N3aXBlUG9pbnRzID0gW3t4LCB5LCB0OiBEYXRlLm5vdygpfV07CiAgICAgICAgfTsKCmNvbnN0IG9uU3dpcGVNb3ZlID0gKHgsIHkpID0+IHsKICAgICAgICAgICAgaWYgKF9zd2lwZVBvaW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBfc3dpcGVQb2ludHMucHVzaCh7eCwgeSwgdDogRGF0ZS5ub3coKX0pOwogICAgICAgICAgICAgICAgY3JlYXRlU3dpcGVUcmFpbERvdCh4LCB5KTsgLy8gVmlzdWFsIEZlZWRiYWNrCiAgICAgICAgICAgIH0KICAgICAgICB9OwoKY29uc3Qgb25Td2lwZUVuZCA9ICh4LCB5KSA9PiB7CiAgICAgICAgICAgIGlmIChfc3dpcGVQb2ludHMubGVuZ3RoIDwgMikgcmV0dXJuOwogICAgICAgICAgICBfc3dpcGVQb2ludHMucHVzaCh7eCwgeSwgdDogRGF0ZS5ub3coKX0pOwoKICAgICAgICAgICAgY29uc3QgeyBpbnRlbnNpdHksIHNwZWVkLCBkeCwgZHkgfSA9IGFuYWx5emVTd2lwZUN1cnZlKF9zd2lwZVBvaW50cyk7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIgJiYgX2NhbWVyYSkgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgICAgICAgICAgLy8gLS0tIENVUlZFIEJBTEwgREVURUNUSU9OIChJbW1lZGlhdGUgVGhyb3cpIC0tLQovLyAtLS0gQ1VSVkUgQkFMTCBERVRFQ1RJT04gKEltbWVkaWF0ZSBUaHJvdykgLS0tCiAgICAgICAgICAgICAgICBpZiAocC5oYXNCYWxsICYmICFwLmlzVGhyb3dpbmcgJiYgIXAuaXNDaGFyZ2luZykgewogICAgICAgICAgICAgICAgICAgIC8vIEFuYWxvZyBDdXJ2ZSBDaGVjazogVGhyZXNob2xkIDAuMjUgcmVxdWlyZXMgYSBkZWxpYmVyYXRlIGFyYyAoVGhlICJGZWF0IikKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoaW50ZW5zaXR5KSA+IDAuMjUgJiYgZGlzdCA+IDEwMCkgewogICAgICAgICAgICAgICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICAgICAgICAgICAgICBfY2FtRndkLnkgPSAwOyBfY2FtRndkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRYID0gKF9jYW1SaWdodC54ICogZHgpICsgKF9jYW1Gd2QueCAqIC1keSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWiA9IChfY2FtUmlnaHQueiAqIGR4KSArIChfY2FtRndkLnogKiAtZHkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0aHJvd0RpciA9IG5ldyBUSFJFRS5WZWN0b3IzKHdvcmxkWCwgMCwgd29ybGRaKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1hcCBpbnRlbnNpdHkgdG8gc3BpbiAtIERyYXN0aWNhbGx5IHJlZHVjZWQgc2Vuc2l0aXZpdHkKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF3U3BpbiA9IE1hdGguYWJzKGludGVuc2l0eSkgKiAzMDAuMDsgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkRmFjdG9yID0gTWF0aC5taW4oMS41LCBzcGVlZCAvIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5Qb3dlciA9IE1hdGgubWluKDQwMC4wLCByYXdTcGluICogc3BlZWRGYWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluU2lnbiA9IE1hdGguc2lnbihpbnRlbnNpdHkpOyAKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIHNwaW5Qb3dlciAqIHNwaW5TaWduLCAwKTsKCgogICAgICAgICAgICAgICAgICAgICAgICBwLnNldE92ZXJyaWRlQWltKHRocm93RGlyLngsIHRocm93RGlyLnopOwogICAgICAgICAgICAgICAgICAgICAgICBwLnRocm93QmFsbCh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCwgJ1NIJywgMS4wLCBzcGluVmVjKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRSIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVSaXBwbGUoeCwgeSk7CiAgICAgICAgICAgICAgICAgICAgICAgIF9zd2lwZVBvaW50cyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47IAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gU1RBTkRBUkQgREFTSCAvIEFJTSAtLS0KICAgICAgICAgICAgICAgIF9jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgICAgICBfY2FtRndkLnkgPSAwOwogICAgICAgICAgICAgICAgaWYgKF9jYW1Gd2QubGVuZ3RoU3EoKSA8IDAuMDAxKSBfY2FtRndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgICAgICBlbHNlIF9jYW1Gd2Qubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhfY2FtRndkLCBfdXBBeGlzKS5ub3JtYWxpemUoKTsKCmNvbnN0IHdvcmxkWDIgPSAoX2NhbVJpZ2h0LnggKiBkeCkgKyAoX2NhbUZ3ZC54ICogLWR5KTsKICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWjIgPSAoX2NhbVJpZ2h0LnogKiBkeCkgKyAoX2NhbUZ3ZC56ICogLWR5KTsKCiAgICAgICAgICAgICAgICBpZiAocC5pc1Rocm93aW5nKSB7CnAuc2V0T3ZlcnJpZGVBaW0od29ybGRYMiwgd29ybGRaMik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQUlNISIsIHAubWVzaC5wb3NpdGlvbiwgImRlZmF1bHQiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewppZiAoZGlzdCA+IDUwKSBwLmRhc2god29ybGRYMiwgd29ybGRaMik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY3JlYXRlUmlwcGxlKHgsIHkpOwogICAgICAgICAgICB9Cl9zd2lwZVBvaW50cyA9IFtdOwogICAgICAgIH07CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgdCA9IChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXNbMF0pID8gZS5jaGFuZ2VkVG91Y2hlc1swXSA6IGUudG91Y2hlc1swXTsKICAgICAgICAgICAgc3dpcGVUb3VjaElkID0gdCA/IHQuaWRlbnRpZmllciA6IG51bGw7Ci8vIG9uU3dpcGVTdGFydCh0LmNsaWVudFgsIHQuY2xpZW50WSk7IC8vIEZpeGVkIHN5bnRheCBlcnJvcgogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuc3dpcGUpIHsgX2RiZy5pbnB1dC5zd2lwZS50b3VjaElkID0gc3dpcGVUb3VjaElkOyB9CiAgICAgICAgICAgIG9uU3dpcGVTdGFydCh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgICAgIGNyZWF0ZVJpcHBsZSh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIHN3aXBlVG91Y2hJZCk7CiAgICAgICAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICAgICAgICBvblN3aXBlTW92ZSh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIHN3aXBlVG91Y2hJZCk7CiAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOyAvLyBJZ25vcmUgb3RoZXIgZmluZ2VycyBsaWZ0aW5nCiAgICAgICAgICAgIG9uU3dpcGVFbmQodEVuZC5jbGllbnRYLCB0RW5kLmNsaWVudFkpOwogICAgICAgICAgICBzd2lwZVRvdWNoSWQgPSBudWxsOwogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuc3dpcGUpIHsgX2RiZy5pbnB1dC5zd2lwZS50b3VjaElkID0gc3dpcGVUb3VjaElkOyB9CiAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgKGUpID0+IHsKaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIHN3aXBlVG91Y2hJZCk7CiAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOyAvLyBJZ25vcmUgb3RoZXIgZmluZ2VycyBsaWZ0aW5nCiAgICAgICAgICAgIG9uU3dpcGVFbmQodEVuZC5jbGllbnRYLCB0RW5kLmNsaWVudFkpOwogICAgICAgICAgICBzd2lwZVRvdWNoSWQgPSBudWxsOwogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuc3dpcGUpIHsgX2RiZy5pbnB1dC5zd2lwZS50b3VjaElkID0gc3dpcGVUb3VjaElkOyB9CiAgICAgICAgCiAgICAgICAgfSk7Ci8vIE1vdXNlIFN3aXBlCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKCiAgICAgICAgICAgIG9uU3dpcGVTdGFydChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgIGNyZWF0ZVJpcHBsZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSkgcmV0dXJuOwogICAgICAgICAgICAvLyBPbmx5IHRyYWNrIGlmIG1vdXNlIGlzIGRvd24gKHNpbXVsYXRpbmcgZHJhZykKICAgICAgICAgICAgaWYgKGUuYnV0dG9ucyA9PT0gMSkgewogICAgICAgICAgICAgICAgb25Td2lwZU1vdmUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKICAgICAgICAgICAgb25Td2lwZUVuZChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIEFjdGlvbiBCdXR0b24gKFNob290L1Bhc3MpCiAgICAgICAgY29uc3QgYWN0aW9uQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKCmNvbnN0IHNldHVwQnV0dG9uID0gKGJ0bikgPT4gewogICAgICAgICAgICBpZiAoIWJ0bikgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGJ0blN0YXJ0WCA9IDA7CiAgICAgICAgICAgIGxldCBidG5TdGFydFkgPSAwOwogICAgICAgICAgICBsZXQgaXNEcmFnZ2luZyA9IGZhbHNlOwogICAgICAgICAgICBsZXQgc3dpcGVQb2ludHMgPSBbXTsKICAgICAgICAgICAgbGV0IGFjdGlvblRvdWNoSWQgPSBudWxsOwoKICAgICAgICAgICAgY29uc3QgYXR0ZW1wdEFjdGlvbiA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGlmICghX2hvbWVUZWFtIHx8ICFfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgICAgICBpZiAocC5oYXNCYWxsICYmICFwLmlzQ2hhcmdpbmcgJiYgIXAuaXNUaHJvd2luZyAmJiBwLnN0YXR1cy5uYXAgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBoYW5kbGVTdGFydCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIuYXR0ZW1wdFRlY2hDb3B5KCk7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpLCAxMDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pc0RlbW9Nb2RlKSByZXR1cm47CgogICAgICAgICAgICAgICAgbGV0IGNsaWVudFggPSBlLmNsaWVudFg7CiAgICAgICAgICAgICAgICBsZXQgY2xpZW50WSA9IGUuY2xpZW50WTsKICAgICAgICAgICAgICAgIGlmIChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IGUuY2hhbmdlZFRvdWNoZXNbMF07CiAgICAgICAgICAgICAgICAgICAgYWN0aW9uVG91Y2hJZCA9IHQuaWRlbnRpZmllcjsKICAgICAgICAgICAgICAgICAgICBjbGllbnRYID0gdC5jbGllbnRYOwogICAgICAgICAgICAgICAgICAgIGNsaWVudFkgPSB0LmNsaWVudFk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGFjdGlvblRvdWNoSWQgPSBudWxsOyAvLyBtb3VzZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnRuU3RhcnRYID0gY2xpZW50WDsKICAgICAgICAgICAgICAgIGJ0blN0YXJ0WSA9IGNsaWVudFk7CiAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHN3aXBlUG9pbnRzID0gW3t4OiBjbGllbnRYLCB5OiBjbGllbnRZLCB0OiBEYXRlLm5vdygpfV07CgogICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci50aW1lc3RhbXAgPSBEYXRlLm5vdygpOwoKICAgICAgICAgICAgICAgIGlmIChhdHRlbXB0QWN0aW9uKCkpIHsKICAgICAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEF0dGFjaCBnbG9iYWwgbGlzdGVuZXJzIHRvIHRyYWNrIHN3aXBlIG91dHNpZGUgYnV0dG9uCiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgaGFuZGxlTW92ZSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIGhhbmRsZU1vdmUpOwogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgaGFuZGxlTW92ZSA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWlzRHJhZ2dpbmcpIHJldHVybjsKCiAgICAgICAgICAgICAgICAvLyBUb3VjaCBwYXRoIChtdWx0aS10b3VjaCBzYWZlKQogICAgICAgICAgICAgICAgaWYgKGUudG91Y2hlcyAmJiBhY3Rpb25Ub3VjaElkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IF9maW5kVG91Y2hCeUlkKGUudG91Y2hlcywgYWN0aW9uVG91Y2hJZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgc3dpcGVQb2ludHMucHVzaCh7eDogdC5jbGllbnRYLCB5OiB0LmNsaWVudFksIHQ6IERhdGUubm93KCl9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTW91c2UgcGF0aAogICAgICAgICAgICAgICAgY29uc3QgY2xpZW50WCA9IGUuY2xpZW50WDsKICAgICAgICAgICAgICAgIGNvbnN0IGNsaWVudFkgPSBlLmNsaWVudFk7CiAgICAgICAgICAgICAgICBzd2lwZVBvaW50cy5wdXNoKHt4OiBjbGllbnRYLCB5OiBjbGllbnRZLCB0OiBEYXRlLm5vdygpfSk7CiAgICAgICAgICAgIH07Cgpjb25zdCBoYW5kbGVFbmQgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgbGV0IGR4ID0gMDsKICAgICAgICAgICAgICAgIGxldCBkeSA9IDA7CiAgICAgICAgICAgICAgICBsZXQgdmFsaWRFbmQgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAvLyAxLiBDaGVjayBUb3VjaAogICAgICAgICAgICAgICAgaWYgKGUuY2hhbmdlZFRvdWNoZXMgJiYgYWN0aW9uVG91Y2hJZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgYWN0aW9uVG91Y2hJZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRFbmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZHggPSB0RW5kLmNsaWVudFggLSBidG5TdGFydFg7CiAgICAgICAgICAgICAgICAgICAgICAgIGR5ID0gdEVuZC5jbGllbnRZIC0gYnRuU3RhcnRZOwogICAgICAgICAgICAgICAgICAgICAgICB2YWxpZEVuZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvblRvdWNoSWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICAvLyAyLiBDaGVjayBNb3VzZQogICAgICAgICAgICAgICAgZWxzZSBpZiAoIWUuY2hhbmdlZFRvdWNoZXMgJiYgaXNEcmFnZ2luZykgewogICAgICAgICAgICAgICAgICAgIGR4ID0gZS5jbGllbnRYIC0gYnRuU3RhcnRYOwogICAgICAgICAgICAgICAgICAgIGR5ID0gZS5jbGllbnRZIC0gYnRuU3RhcnRZOwogICAgICAgICAgICAgICAgICAgIHZhbGlkRW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIXZhbGlkRW5kKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gQ2xlYW51cCBsaXN0ZW5lcnMKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBoYW5kbGVNb3ZlKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIGhhbmRsZU1vdmUpOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVFbmQpOwoKICAgICAgICAgICAgICAgIGlmICghaXNEcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgaXNEcmFnZ2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB3YXNCdWZmZXJlZCA9IF9hY3Rpb25CdWZmZXIuYWN0aXZlOwogICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDdXJ2ZSBBbmFseXNpcwogICAgICAgICAgICAgICAgICAgIGxldCBjdXJ2ZURhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIGxldCBzcGluVmVjID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGN1cnZlIGlmIHdlIGhhdmUgZW5vdWdoIGRhdGEKLy8gQ2FsY3VsYXRlIGN1cnZlIGlmIHdlIGhhdmUgZW5vdWdoIGRhdGEKICAgICAgICAgICAgICAgICAgICBpZiAoc3dpcGVQb2ludHMubGVuZ3RoID4gMikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmFseXNpcyA9IGFuYWx5emVTd2lwZUN1cnZlKHN3aXBlUG9pbnRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSGlnaCB0aHJlc2hvbGQgZm9yIGJ1dHRvbiByZWxlYXNlIHRvbwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoYW5hbHlzaXMuaW50ZW5zaXR5KSA+IDAuMjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnZlRGF0YSA9IGFuYWx5c2lzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgc3BpbiB2ZWN0b3IgZm9yIG1vdXNlL3RvdWNoIHVuaWZpZWQgKENvbnNlcnZhdGl2ZSB2YWx1ZXMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluUG93ZXIgPSBNYXRoLm1pbig0MDAuMCwgTWF0aC5hYnMoYW5hbHlzaXMuaW50ZW5zaXR5KSAqIDE1MDAuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluU2lnbiA9IE1hdGguc2lnbihhbmFseXNpcy5pbnRlbnNpdHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BpblZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIHNwaW5Qb3dlciAqIHNwaW5TaWduLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQp9CgogICAgICAgICAgICAgICAgICAgIC8vIEVYRUNVVEUKICAgICAgICAgICAgICAgICAgICBpZiAocC5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5vcm1hbCBSZWxlYXNlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcGluVmVjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBVbmlmaWVkIHNwaW4gcGFzc2luZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlQ2hhcmdlKGR4LCBkeSwgeyBpbnRlbnNpdHk6IGN1cnZlRGF0YS5pbnRlbnNpdHksIHNwZWVkOiBjdXJ2ZURhdGEuc3BlZWQgfSk7IAogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlQ2hhcmdlKGR4LCBkeSwgY3VydmVEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh3YXNCdWZmZXJlZCAmJiBwLmhhc0JhbGwgJiYgIXAuaXNUaHJvd2luZyAmJiBwLnN0YXR1cy5uYXAgPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBCdWZmZXJlZCBUYXAgKEluc3RhbnQgU2hvdCkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9yY2Ugc3RhcnQgYW5kIHJlbGVhc2UgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGFydENoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBwLnJlbGVhc2VDaGFyZ2UoZHgsIGR5LCBjdXJ2ZURhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBoYW5kbGVTdGFydCwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIGhhbmRsZVN0YXJ0KTsKICAgICAgICB9OwogICAgICAgIHNldHVwQnV0dG9uKGFjdGlvbkJ0bik7CgovLyBBdXRvIFRvZ2dsZQogICAgICAgIGNvbnN0IGF1dG9CdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXV0by10b2dnbGUnKTsKICAgICAgICBpZiAoYXV0b0J0bikgewogICAgICAgICAgICBjb25zdCBoYW5kbGVUb2dnbGUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnRvZ2dsZURlbW9Nb2RlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgYXV0b0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGhhbmRsZVRvZ2dsZSk7CmF1dG9CdG4uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBoYW5kbGVUb2dnbGUoKTsKICAgICAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogU2V0dGluZ3MgQnV0dG9uCiAgICAgICAgc2V0dXBTZXR0aW5nc0J1dHRvbigpOwogICAgfQoKICAgIC8vIE5FVzogQWltIEpveXN0aWNrIFNldHVwCi8vIE5FVzogQWltIEpveXN0aWNrIFNldHVwCmZ1bmN0aW9uIHNldHVwQWltSm95c3RpY2soKSB7CiAgICAgICAgY29uc3QgYWltS25vYiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaW0tam95c3RpY2sta25vYicpOwogICAgICAgIGNvbnN0IGFpbVZpc3VhbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWltLWpveXN0aWNrLXZpc3VhbCcpOwogICAgICAgIGNvbnN0IGFpbVpvbmUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWltLWpveXN0aWNrLXpvbmUnKTsKICAgICAgICBpZiAoIWFpbVpvbmUpIHJldHVybjsKICAgICAgICBsZXQgYWltU3RhcnRYID0gMCwgYWltU3RhcnRZID0gMDsKICAgICAgICBsZXQgYWltRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICBjb25zdCBhaW1NYXhEaXN0ID0gMzU7CiAgICAgICAgbGV0IGFpbVRvdWNoSWQgPSBudWxsOwoKICAgICAgICAKCiAgICAgICAgLy8gRXhwb3NlIGFpbSBqb3lzdGljayBzdGF0ZSBmb3Igc25hcHNob3RzCiAgICAgICAgY29uc3QgX2RiZyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPID0gd2luZG93LmZsdXguX2RlYnVnSU8gfHwge307CiAgICAgICAgX2RiZy5zZXR0aW5ncyA9IF9zZXR0aW5nczsKICAgICAgICBfZGJnLmlucHV0ID0gX2RiZy5pbnB1dCB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0LmFpbSA9IF9kYmcuaW5wdXQuYWltIHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQuYWltLnZlY3RvciA9IF9haW1JbnB1dDsKICAgICAgICBfZGJnLmlucHV0LmFpbS5kcmFnZ2luZyA9IGFpbURyYWdnaW5nOwogICAgICAgIF9kYmcuaW5wdXQuYWltLnRvdWNoSWQgPSBhaW1Ub3VjaElkOwpjb25zdCBoYW5kbGVBaW1TdGFydCA9IChjbGllbnRYLCBjbGllbnRZKSA9PiB7CiAgICAgICAgICAgIGFpbURyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgYWltU3RhcnRYID0gY2xpZW50WDsKCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5haW0pIHsgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsgfQoKICAgICAgICAgICAgYWltU3RhcnRZID0gY2xpZW50WTsKICAgICAgICAgICAgX2FpbUlucHV0LmFjdGl2ZSA9IHRydWU7CgogICAgICAgICAgICBpZiAoYWltVmlzdWFscykgewogICAgICAgICAgICAgICAgYWltVmlzdWFscy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIGFpbVZpc3VhbHMuc3R5bGUubGVmdCA9IGAke2NsaWVudFh9cHhgOwogICAgICAgICAgICAgICAgYWltVmlzdWFscy5zdHlsZS50b3AgPSBgJHtjbGllbnRZfXB4YDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYWltS25vYikgewogICAgICAgICAgICAgICAgYWltS25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKC01MCUsIC01MCUpYDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGNvbnN0IGhhbmRsZUFpbU1vdmUgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CgogICAgICAgICAgICBsZXQgZHggPSBjbGllbnRYIC0gYWltU3RhcnRYOwogICAgICAgICAgICBsZXQgZHkgPSBjbGllbnRZIC0gYWltU3RhcnRZOwoKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCiAgICAgICAgICAgIGlmIChkaXN0ID4gYWltTWF4RGlzdCkgewogICAgICAgICAgICAgICAgZHggPSAoZHggLyBkaXN0KSAqIGFpbU1heERpc3Q7CiAgICAgICAgICAgICAgICBkeSA9IChkeSAvIGRpc3QpICogYWltTWF4RGlzdDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGFpbUtub2IpIHsKICAgICAgICAgICAgICAgIGFpbUtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZShjYWxjKC01MCUgKyAke2R4fXB4KSwgY2FsYygtNTAlICsgJHtkeX1weCkpYDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTm9ybWFsaXplIGFuZCB0cmFuc2Zvcm0gdG8gd29ybGQgc3BhY2UKICAgICAgICAgICAgX2FpbUlucHV0LnggPSBkeCAvIGFpbU1heERpc3Q7CiAgICAgICAgICAgIF9haW1JbnB1dC55ID0gZHkgLyBhaW1NYXhEaXN0OwoKICAgICAgICAgICAgLy8gQXBwbHkgYWltIHRvIHBsYXllciBpZiBjaGFyZ2luZwogICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgaWYgKHAuaXNDaGFyZ2luZyB8fCBwLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUcmFuc2Zvcm0gc2NyZWVuIGFpbSB0byB3b3JsZCBzcGFjZQogICAgICAgICAgICAgICAgICAgIF9jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgICAgICAgICBlbHNlIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhfY2FtRndkLCBfdXBBeGlzKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRYID0gKF9jYW1SaWdodC54ICogX2FpbUlucHV0LngpICsgKF9jYW1Gd2QueCAqIC1fYWltSW5wdXQueSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRaID0gKF9jYW1SaWdodC56ICogX2FpbUlucHV0LngpICsgKF9jYW1Gd2QueiAqIC1fYWltSW5wdXQueSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyh3b3JsZFgpID4gMC4xIHx8IE1hdGguYWJzKHdvcmxkWikgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRPdmVycmlkZUFpbSh3b3JsZFgsIHdvcmxkWik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCmNvbnN0IGhhbmRsZUFpbUVuZCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBhaW1EcmFnZ2luZyA9IGZhbHNlOwogICAgICAgICAgICBfYWltSW5wdXQuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIF9haW1JbnB1dC54ID0gMDsKICAgICAgICAgICAgX2FpbUlucHV0LnkgPSAwOwoKICAgICAgICAgICAgaWYgKGFpbVZpc3VhbHMpIHsKICAgICAgICAgICAgICAgIGFpbVZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2xlYXIgcGxheWVyIGFpbSBvdmVycmlkZQogICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIub3ZlcnJpZGVBaW1WZWN0b3IgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgYWltWm9uZS5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBjb25zdCB0ID0gKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlc1swXSkgPyBlLmNoYW5nZWRUb3VjaGVzWzBdIDogZS50b3VjaGVzWzBdOwogICAgICAgICAgICBhaW1Ub3VjaElkID0gdCA/IHQuaWRlbnRpZmllciA6IG51bGw7CiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5haW0pIHsgX2RiZy5pbnB1dC5haW0udG91Y2hJZCA9IGFpbVRvdWNoSWQ7IH0KICAgICAgICAgICAgaGFuZGxlQWltU3RhcnQodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgY29uc3QgdCA9IF9maW5kVG91Y2hCeUlkKGUudG91Y2hlcywgYWltVG91Y2hJZCk7CiAgICAgICAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICAgICAgICBoYW5kbGVBaW1Nb3ZlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgYWltVG91Y2hJZCk7CiAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOwogICAgICAgICAgICBhaW1Ub3VjaElkID0gbnVsbDsKICAgICAgICAgICAgaGFuZGxlQWltRW5kKCk7CiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5haW0pIHsgX2RiZy5pbnB1dC5haW0udG91Y2hJZCA9IGFpbVRvdWNoSWQ7IF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7IH0KICAgICAgICAgICAgaGFuZGxlQWltRW5kKCk7CiAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIGFpbVRvdWNoSWQpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgYWltVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZUFpbUVuZCgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLnRvdWNoSWQgPSBhaW1Ub3VjaElkOyBfZGJnLmlucHV0LmFpbS5kcmFnZ2luZyA9IGFpbURyYWdnaW5nOyB9CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZUFpbUVuZCgpOwogICAgICAgIH0pOwovLyBNb3VzZSBzdXBwb3J0IGZvciBkZXNrdG9wIHRlc3RpbmcKICAgICAgICBhaW1ab25lLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgIGhhbmRsZUFpbVN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGFpbURyYWdnaW5nKSBoYW5kbGVBaW1Nb3ZlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChhaW1EcmFnZ2luZykgaGFuZGxlQWltRW5kKCk7CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gTkVXOiBUYWNrbGUgQnV0dG9uIFNldHVwCiAgICBmdW5jdGlvbiBzZXR1cFRhY2tsZUJ1dHRvbigpIHsKICAgICAgICBjb25zdCB0YWNrbGVCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGFja2xlLWJ1dHRvbicpOwogICAgICAgIGlmICghdGFja2xlQnRuKSByZXR1cm47CgogICAgICAgIGNvbnN0IGhhbmRsZVRhY2tsZSA9IChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmlzRGVtb01vZGUpIHJldHVybjsKCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgICAgICAgICAgLy8gSWYgd2UgZG9uJ3QgaGF2ZSB0aGUgYmFsbCwgZGFzaC90YWNrbGUKICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gR2V0IGN1cnJlbnQgbW92ZW1lbnQgZGlyZWN0aW9uIG9yIGZvcndhcmQKICAgICAgICAgICAgICAgICAgICBsZXQgZGFzaFggPSBwLmlucHV0VmVjdG9yLng7CiAgICAgICAgICAgICAgICAgICAgbGV0IGRhc2haID0gcC5pbnB1dFZlY3Rvci56OwoKICAgICAgICAgICAgICAgICAgICAvLyBJZiBub3QgbW92aW5nLCBkYXNoIGZvcndhcmQKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGFzaFgpIDwgMC4xICYmIE1hdGguYWJzKGRhc2haKSA8IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24ocC5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgICAgICAgICBkYXNoWCA9IGZ3ZC54OwogICAgICAgICAgICAgICAgICAgICAgICBkYXNoWiA9IGZ3ZC56OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcC5kYXNoKGRhc2hYLCBkYXNoWik7CgogICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRhY2tsZUJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSwgMjAwKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiVEFDS0xFISIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQnJlYWsgdGFja2xlIGlmIGVuZ2FnZWQKICAgICAgICAgICAgICAgICAgICBwLmRhc2gocC5pbnB1dFZlY3Rvci54LCBwLmlucHV0VmVjdG9yLnopOwogICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRhY2tsZUJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSwgMjAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlVGFja2xlLCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBoYW5kbGVUYWNrbGUpOwogICAgfQoKICAgIC8vIE5FVzogU2V0dGluZ3MgQnV0dG9uIFNldHVwCi8vIE5FVzogU2V0dGluZ3MgQnV0dG9uIFNldHVwCmZ1bmN0aW9uIHNldHVwU2V0dGluZ3NCdXR0b24oKSB7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2V0dGluZ3MtYnV0dG9uJyk7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NQYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXR0aW5ncy1wYW5lbCcpOwogICAgICAgIGNvbnN0IHNldHRpbmdzQ2xvc2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2V0dGluZ3MtY2xvc2UnKTsKCiAgICAgICAgaWYgKCFzZXR0aW5nc0J0biB8fCAhc2V0dGluZ3NQYW5lbCkgcmV0dXJuOwoKICAgICAgICBzZXR0aW5nc0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID0gc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID09PSAnbm9uZScgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIH0pOwoKICAgICAgICBpZiAoc2V0dGluZ3NDbG9zZSkgewogICAgICAgICAgICBzZXR0aW5nc0Nsb3NlLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIFNlbnNpdGl2aXR5IHNsaWRlcgogICAgICAgIGNvbnN0IHNlbnNpdGl2aXR5U2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlbnNpdGl2aXR5LXNsaWRlcicpOwogICAgICAgIGlmIChzZW5zaXRpdml0eVNsaWRlcikgewogICAgICAgICAgICBzZW5zaXRpdml0eVNsaWRlci52YWx1ZSA9IF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5ICogMTAwOwogICAgICAgICAgICBzZW5zaXRpdml0eVNsaWRlci5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eSA9IGUudGFyZ2V0LnZhbHVlIC8gMTAwOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIEFpbSBhc3Npc3QgdG9nZ2xlCiAgICAgICAgY29uc3QgYWltQXNzaXN0VG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1hc3Npc3QtdG9nZ2xlJyk7CiAgICAgICAgaWYgKGFpbUFzc2lzdFRvZ2dsZSkgewogICAgICAgICAgICBhaW1Bc3Npc3RUb2dnbGUuY2hlY2tlZCA9IF9zZXR0aW5ncy5haW1Bc3Npc3Q7CiAgICAgICAgICAgIGFpbUFzc2lzdFRvZ2dsZS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgX3NldHRpbmdzLmFpbUFzc2lzdCA9IGUudGFyZ2V0LmNoZWNrZWQ7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gQ2FtZXJhIHNoYWtlIHRvZ2dsZQogICAgICAgIGNvbnN0IHNoYWtlVG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NoYWtlLXRvZ2dsZScpOwogICAgICAgIGlmIChzaGFrZVRvZ2dsZSkgewogICAgICAgICAgICBzaGFrZVRvZ2dsZS5jaGVja2VkID0gX3NldHRpbmdzLmNhbWVyYVNoYWtlOwogICAgICAgICAgICBzaGFrZVRvZ2dsZS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgX3NldHRpbmdzLmNhbWVyYVNoYWtlID0gZS50YXJnZXQuY2hlY2tlZDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBWb2x1bWUgc2xpZGVyCiAgICAgICAgY29uc3Qgdm9sdW1lU2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ZvbHVtZS1zbGlkZXInKTsKICAgICAgICBpZiAodm9sdW1lU2xpZGVyICYmIF9hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgdm9sdW1lU2xpZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHZvbCA9IGUudGFyZ2V0LnZhbHVlIC8gMTAwOwogICAgICAgICAgICAgICAgX2F1ZGlvTWFuYWdlci5zZXRWb2x1bWUodm9sKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBFeGl0IHRvIE1lbnUKICAgICAgICBjb25zdCBleGl0QnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2V4aXQtdG8tbWVudS1idG4nKTsKICAgICAgICBpZiAoZXhpdEJ0bikgewogICAgICAgICAgICBleGl0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKF9tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIF9tZW51TWFuYWdlci5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIuc3RhdGUgPSAnbWVudSc7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgcHJhY3RpY2UgaWYgcnVubmluZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlSW5wdXRWZWN0b3IoKSB7CiAgICAgICAgbGV0IHggPSBfaW5wdXQueCB8fCAwOwogICAgICAgIGxldCB6ID0gX2lucHV0LnkgfHwgMDsKCiAgICAgICAgaWYgKF9rZXlzWyd3J10gfHwgX2tleXNbJ0Fycm93VXAnXSkgeiAtPSAxOwogICAgICAgIGlmIChfa2V5c1sncyddIHx8IF9rZXlzWydBcnJvd0Rvd24nXSkgeiArPSAxOwogICAgICAgIGlmIChfa2V5c1snYSddIHx8IF9rZXlzWydBcnJvd0xlZnQnXSkgeCAtPSAxOwogICAgICAgIGlmIChfa2V5c1snZCddIHx8IF9rZXlzWydBcnJvd1JpZ2h0J10pIHggKz0gMTsKCiAgICAgICAgY29uc3QgbGVuU3EgPSB4KnggKyB6Kno7CiAgICAgICAgaWYgKGxlblNxID4gMSkgewogICAgICAgICAgICBjb25zdCBsZW4gPSBNYXRoLnNxcnQobGVuU3EpOwogICAgICAgICAgICB4IC89IGxlbjsKICAgICAgICAgICAgeiAvPSBsZW47CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNOYU4oeCkpIHggPSAwOwogICAgICAgIGlmIChpc05hTih6KSkgeiA9IDA7CgogICAgICAgIGlmIChfY2FtZXJhKSB7CiAgICAgICAgICAgIF9jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CgogICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICBfY2FtUmlnaHQuc2V0KDEsIDAsIDApOwogICAgICAgIH0KCiAgICAgICAgbGV0IHdvcmxkWCA9IChfY2FtRndkLnggKiAteikgKyAoX2NhbVJpZ2h0LnggKiB4KTsKICAgICAgICBsZXQgd29ybGRaID0gKF9jYW1Gd2QueiAqIC16KSArIChfY2FtUmlnaHQueiAqIHgpOwoKICAgICAgICBpZiAoaXNOYU4od29ybGRYKSB8fCBpc05hTih3b3JsZFopKSB7CiAgICAgICAgICAgIHdvcmxkWCA9IDA7CiAgICAgICAgICAgIHdvcmxkWiA9IDA7CiAgICAgICAgfQoKICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiAhX2dhbWVNYW5hZ2VyLmlzRGVtb01vZGUpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQod29ybGRYLCB3b3JsZFopOwogICAgICAgICAgICB9Cgp9CiAgICB9CmZ1bmN0aW9uIGNyZWF0ZVJpcHBsZSh4LCB5KSB7CiAgICAgICAgY29uc3QgcmlwcGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgcmlwcGxlLmNsYXNzTmFtZSA9ICd0b3VjaC1yaXBwbGUnOwogICAgICAgIHJpcHBsZS5zdHlsZS5sZWZ0ID0gYCR7eH1weGA7CiAgICAgICAgcmlwcGxlLnN0eWxlLnRvcCA9IGAke3l9cHhgOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpLmFwcGVuZENoaWxkKHJpcHBsZSk7CgogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAocmlwcGxlLnBhcmVudE5vZGUpIHJpcHBsZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHJpcHBsZSk7CiAgICAgICAgfSwgNjAwKTsKCiAgICB9CgogICAgLy8gTkVXOiBWaXN1YWwgU3dpcGUgVHJhaWwKICAgIGZ1bmN0aW9uIGNyZWF0ZVN3aXBlVHJhaWxEb3QoeCwgeSkgewogICAgICAgIGNvbnN0IGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIGRvdC5jbGFzc05hbWUgPSAnc3dpcGUtdHJhaWwtZG90JzsKICAgICAgICBkb3Quc3R5bGUubGVmdCA9IGAke3ggLSA2fXB4YDsgLy8gQ2VudGVyICgxMnB4IHdpZHRoKQogICAgICAgIGRvdC5zdHlsZS50b3AgPSBgJHt5IC0gNn1weGA7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJykuYXBwZW5kQ2hpbGQoZG90KTsKICAgICAgICAKICAgICAgICAvLyBDU1MgYW5pbWF0aW9uIGhhbmRsZXMgcmVtb3ZhbCwgYnV0IHdlIGNsZWFuIHVwIERPTSB0byBiZSBzYWZlCiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGlmIChkb3QucGFyZW50Tm9kZSkgZG90LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZG90KTsKICAgICAgICB9LCA1MDApOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uUmVzaXplKCkgewogICAgICAgIGNvbnN0IHdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgIAogICAgICAgIGlmIChfY2FtZXJhKSB7CiAgICAgICAgICAgIF9jYW1lcmEuYXNwZWN0ID0gd2lkdGggLyBoZWlnaHQ7CiAgICAgICAgICAgIF9jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBTdHJpY3RseSAwLjUwIGFzIHJlcXVlc3RlZAogICAgICAgIGNvbnN0IHJlc1NjYWxlID0gMC41MDsKICAgICAgICAKICAgICAgICBfY29uZmlnLmludGVybmFsV2lkdGggPSBNYXRoLmZsb29yKHdpZHRoICogcmVzU2NhbGUpOwogICAgICAgIF9jb25maWcuaW50ZXJuYWxIZWlnaHQgPSBNYXRoLmZsb29yKGhlaWdodCAqIHJlc1NjYWxlKTsKCiAgICAgICAgaWYgKF9yZW5kZXJlcikgewogICAgICAgICAgICBfcmVuZGVyZXIuc2V0U2l6ZShfY29uZmlnLmludGVybmFsV2lkdGgsIF9jb25maWcuaW50ZXJuYWxIZWlnaHQsIGZhbHNlKTsKICAgICAgICB9CiAgICB9CgpmdW5jdGlvbiBhbmltYXRlKCkgewogICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRlKTsKCiAgICAgICAgY29uc3QgcmF3RHQgPSBfY2xvY2suZ2V0RGVsdGEoKTsKICAgICAgICAvLyBDbGFtcCBkdCB0byBwcmV2ZW50IHNwaXJhbHMgb2YgZGVhdGggKG1heCAwLjFzKQogICAgICAgIGNvbnN0IGR0ID0gTWF0aC5taW4ocmF3RHQsIDAuMSkgKiAod2luZG93LmZsdXgudGltZVNjYWxlICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC50aW1lU2NhbGUgOiAwLjgpOwoKICAgICAgICAKCiAgICAgICAgLy8gUGVyZiBzdGF0cyBmb3IgRGV2VG9vbHMgc25hcHNob3RzCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPLnBlcmYpIHsKICAgICAgICAgICAgY29uc3QgcGVyZiA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPLnBlcmY7CiAgICAgICAgICAgIHBlcmYuZnJhbWUgPSAocGVyZi5mcmFtZSB8fCAwKSArIDE7CiAgICAgICAgICAgIHBlcmYucmF3RHQgPSByYXdEdDsKICAgICAgICAgICAgcGVyZi5kdCA9IGR0OwogICAgICAgICAgICBjb25zdCBmcHMgPSBkdCA+IDAgPyAoMSAvIGR0KSA6IDA7CiAgICAgICAgICAgIHBlcmYuZnBzID0gZnBzOwogICAgICAgICAgICBwZXJmLmF2Z0ZwcyA9IChwZXJmLmF2Z0ZwcyAmJiBwZXJmLmF2Z0ZwcyA+IDApID8gKHBlcmYuYXZnRnBzICogMC45ICsgZnBzICogMC4xKSA6IGZwczsKICAgICAgICB9Ci8vIEltcGFjdCBGcmFtZXMKICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pbXBhY3RQYXVzZSA+IDApIHsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmltcGFjdFBhdXNlIC09IGR0OwogICAgICAgICAgICBpZiAoX3JlbmRlcmVyICYmIF9zY2VuZSAmJiBfY2FtZXJhKSB7CiAgICAgICAgICAgICAgICBfcmVuZGVyZXIucmVuZGVyKF9zY2VuZSwgX2NhbWVyYSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKCiAgICAgICAgLy8gQWN0aW9uIEJ1ZmZlciBQcm9jZXNzaW5nCiAgICAgICAgaWYgKF9hY3Rpb25CdWZmZXIuYWN0aXZlKSB7CiAgICAgICAgICAgIGlmIChEYXRlLm5vdygpIC0gX2FjdGlvbkJ1ZmZlci50aW1lc3RhbXAgPiBfYWN0aW9uQnVmZmVyLmR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgJiYgIXAuaXNDaGFyZ2luZyAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ0bikgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gTWVudSBTdGF0ZSBIYW5kbGluZwogICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLnN0YXRlID09PSAnbWVudScgJiYgX2NhbWVyYSkgewogICAgICAgICAgICBjb25zdCB0aW1lID0gRGF0ZS5ub3coKSAqIDAuMDAwNTsKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gNTA7CiAgICAgICAgICAgIF9jYW1lcmEucG9zaXRpb24ueCA9IE1hdGguc2luKHRpbWUpICogcmFkaXVzOwogICAgICAgICAgICBfY2FtZXJhLnBvc2l0aW9uLnogPSBNYXRoLmNvcyh0aW1lKSAqIHJhZGl1czsKICAgICAgICAgICAgX2NhbWVyYS5wb3NpdGlvbi55ID0gMjA7CiAgICAgICAgICAgIF9jYW1lcmEubG9va0F0KDAsIDAsIDApOwoKICAgICAgICAgICAgaWYgKF9yZW5kZXJlciAmJiBfc2NlbmUpIHsKICAgICAgICAgICAgICAgIF9yZW5kZXJlci5yZW5kZXIoX3NjZW5lLCBfY2FtZXJhKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKLy8gU3RhYmxlIHN1Yi1zdGVwcGluZyAocHJldmVudHMgZHQgc3Bpa2VzIGZyb20gbWFraW5nIHBoeXNpY3MvY2FtZXJhIGZlZWwgZmxvYXR5IG9uIG1vYmlsZSkKICAgICAgICBjb25zdCBfbWF4U3RlcCA9IDEgLyA2MDsKICAgICAgICBjb25zdCBfc3RlcHMgPSBNYXRoLm1pbig0LCBNYXRoLm1heCgxLCBNYXRoLmNlaWwoZHQgLyBfbWF4U3RlcCkpKTsKICAgICAgICBjb25zdCBfc3RlcER0ID0gZHQgLyBfc3RlcHM7CgogICAgICAgIGZvciAobGV0IF9zaSA9IDA7IF9zaSA8IF9zdGVwczsgX3NpKyspIHsKICAgICAgICAgICAgY29uc3QgX3NkdCA9IF9zdGVwRHQ7CgogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSBfZ2FtZU1hbmFnZXIudXBkYXRlKF9zZHQpOwoKICAgICAgICAgICAgLy8gSWYgaW4gQXNzZXQgRm9yZ2UgbW9kZSwgc2tpcCBnYW1lIGxvZ2ljIGFuZCBzdGFuZGFyZCByZW5kZXJpbmcKICAgICAgICAgICAgLy8gRGV2VG9vbHMgaGFuZGxlcyB0aGUgcmVuZGVyaW5nIGluIGl0cyBob29rZWQgdXBkYXRlIGZ1bmN0aW9uCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmlzRm9yZ2VNb2RlKSB7CiAgICAgICAgICAgICAgICAvLyBGb3JnZSBtb2RlIGhhbmRsZXMgaXRzIG93biByZW5kZXJpbmcgbG9vcCBpbiBEZXZUb29scyBob29rCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVwZGF0ZSBFbnRpdGllcwogICAgICAgICAgICBpZiAoX2hvbWVUZWFtKSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0udXBkYXRlKF9zZHQpOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IGNoZWNrQmFsbEdyYWIocCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoX2F3YXlUZWFtKSB7CiAgICAgICAgICAgICAgICBfYXdheVRlYW0udXBkYXRlKF9zZHQpOwogICAgICAgICAgICAgICAgX2F3YXlUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IGNoZWNrQmFsbEdyYWIocCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoX2JhbGwpIHsKICAgICAgICAgICAgICAgIF9iYWxsLnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmFsbCBMYWIgcnVudGltZSAodHJhamVjdG9yeSBwcmV2aWV3IC8gcmVjb3JkLXJlcGxheSkKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWIgJiYgdHlwZW9mIHdpbmRvdy5mbHV4LmJhbGxMYWIudXBkYXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5iYWxsTGFiLnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIENhbWVyYQogICAgICAgICAgICB1cGRhdGVDYW1lcmFMb2dpYyhfc2R0KTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBWaXN1YWxzCiAgICAgICAgICAgIGlmIChfd2F0ZXJPdmVybGF5KSBfd2F0ZXJPdmVybGF5LnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgaWYgKF9saWdodFNoYWZ0cykgX2xpZ2h0U2hhZnRzLnVwZGF0ZShfc2R0KTsKCiAgICAgICAgICAgIC8vIFJ1bnRpbWUgdXBkYXRlcnMgKEZYLCBhcmVuYSByaW5ncywgZXRjLikKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgJiYgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IHVpID0gMDsgdWkgPCB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLmxlbmd0aDsgdWkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZuID0gd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVyc1t1aV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJykgZm4oX3NkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVwZGF0ZSBHbG9iYWwgVW5pZm9ybXMKICAgICAgICAgICAgaWYgKF9hcmVuYVVuaWZvcm1zKSB7CiAgICAgICAgICAgICAgICBfYXJlbmFVbmlmb3Jtcy51VGltZS52YWx1ZSArPSBfc2R0OwogICAgICAgICAgICAgICAgLy8gRGVjYXkgaW1wYWN0IHN0cmVuZ3RoCiAgICAgICAgICAgICAgICBfYXJlbmFVbmlmb3Jtcy51SW1wYWN0U3RyLnZhbHVlICo9IE1hdGgubWF4KDAsIDEuMCAtIF9zZHQgKiA0LjApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChfcGFydGljbGVVbmlmb3JtcykgewogICAgICAgICAgICAgICAgX3BhcnRpY2xlVW5pZm9ybXMudVRpbWUudmFsdWUgKz0gX3NkdDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKF9zdGFkaXVtKSBfc3RhZGl1bS51cGRhdGUoX3NkdCk7CiAgICAgICAgfQoKCiAgICAgICAgaWYgKF9yZW5kZXJlciAmJiBfc2NlbmUgJiYgX2NhbWVyYSkgewogICAgICAgICAgICBfcmVuZGVyZXIucmVuZGVyKF9zY2VuZSwgX2NhbWVyYSk7CiAgICAgICAgfQogICAgICAgIC8vIFVJIFVwZGF0ZXMKICAgICAgICB1cGRhdGVVSSgpOwogICAgfQoKICAgIGZ1bmN0aW9uIHVwZGF0ZVVJKCkgewogICAgICAgIGlmICghX2hvbWVUZWFtIHx8ICFfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSByZXR1cm47CgogICAgICAgIGNvbnN0IGJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY3Rpb24tYnV0dG9uJyk7CiAgICAgICAgY29uc3QgbGJsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1sYWJlbCcpOwogICAgICAgIGNvbnN0IHRhY2tsZUJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0YWNrbGUtYnV0dG9uJyk7CiAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgIGlmIChidG4gJiYgbGJsKSB7CiAgICAgICAgICAgIGNvbnN0IGJ0blRleHQgPSBidG4ucXVlcnlTZWxlY3RvcignLmJ0bi10ZXh0Jyk7CgogICAgICAgICAgICBpZiAocC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoYnRuVGV4dCAmJiBidG5UZXh0LmlubmVyVGV4dCAhPT0gIkFDVElPTiIpIHsKICAgICAgICAgICAgICAgICAgICBidG5UZXh0LmlubmVyVGV4dCA9ICJBQ1RJT04iOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdzaG9vdC1tb2RlJyk7CiAgICAgICAgICAgICAgICAgICAgbGJsLmlubmVyVGV4dCA9ICJPRkZFTlNFIjsKICAgICAgICAgICAgICAgICAgICBsYmwuY2xhc3NMaXN0LmFkZCgnc2hvb3QtbGFiZWwnKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBpc0hpZ2hFbmVyZ3kgPSAocC5zdGF0cy5IUCAvIHAuc3RhdHMubWF4SFApID4gMC40OwogICAgICAgICAgICAgICAgaWYgKGlzSGlnaEVuZXJneSkgewogICAgICAgICAgICAgICAgICAgIGlmICghYnRuLmNsYXNzTGlzdC5jb250YWlucygnbGltaXQtcmVhZHknKSkgYnRuLmNsYXNzTGlzdC5hZGQoJ2xpbWl0LXJlYWR5Jyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChidG4uY2xhc3NMaXN0LmNvbnRhaW5zKCdsaW1pdC1yZWFkeScpKSBidG4uY2xhc3NMaXN0LnJlbW92ZSgnbGltaXQtcmVhZHknKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoYnRuVGV4dCAmJiBidG5UZXh0LmlubmVyVGV4dCAhPT0gIlNXSU0iKSB7CiAgICAgICAgICAgICAgICAgICAgYnRuVGV4dC5pbm5lclRleHQgPSAiU1dJTSI7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob290LW1vZGUnKTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnbGltaXQtcmVhZHknKTsKICAgICAgICAgICAgICAgICAgICBsYmwuaW5uZXJUZXh0ID0gIk5PUk1BTCI7CiAgICAgICAgICAgICAgICAgICAgbGJsLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob290LWxhYmVsJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFVwZGF0ZSB0YWNrbGUgYnV0dG9uIHZpc2liaWxpdHkKICAgICAgICBpZiAodGFja2xlQnRuKSB7CiAgICAgICAgICAgIGlmICghcC5oYXNCYWxsIHx8IHAuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICB0YWNrbGVCdG4uc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSB0YWNrbGUgYnV0dG9uIHRleHQgYmFzZWQgb24gY29udGV4dAogICAgICAgICAgICAgICAgY29uc3QgdGFja2xlVGV4dCA9IHRhY2tsZUJ0bi5xdWVyeVNlbGVjdG9yKCcuYnRuLXRleHQnKTsKICAgICAgICAgICAgICAgIGlmICh0YWNrbGVUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaXNFbmdhZ2VkICYmIHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVUZXh0LmlubmVyVGV4dCA9ICdCUkVBSyc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCd1cmdlbnQnKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVUZXh0LmlubmVyVGV4dCA9ICdUQUNLTEUnOwogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVCdG4uY2xhc3NMaXN0LnJlbW92ZSgndXJnZW50Jyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFja2xlQnRuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFVwZGF0ZSBkaXN0YW5jZSB0byBnb2FsIGluZGljYXRvcgogICAgICAgIGNvbnN0IGRpc3RJbmRpY2F0b3IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ29hbC1kaXN0YW5jZScpOwogICAgICAgIGlmIChkaXN0SW5kaWNhdG9yICYmIHAubWVzaCkgewogICAgICAgICAgICBjb25zdCBnb2FsWiA9IChwLnRlYW0gJiYgcC50ZWFtLnNpZGUgPT09IDEpID8gLTI4IDogMjg7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLmFicyhwLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgZGlzdEluZGljYXRvci5pbm5lclRleHQgPSBgJHtNYXRoLmZsb29yKGRpc3QpfW1gOwogICAgICAgIH0KICAgIH0KCmZ1bmN0aW9uIHVwZGF0ZUNhbWVyYUxvZ2ljKGR0KSB7CiAgICAgICAgaWYgKCFfY2FtZXJhTWFuYWdlciB8fCAhX2JhbGwpIHJldHVybjsKCiAgICAgICAgbGV0IHRhcmdldE1lc2ggPSBfYmFsbC5tZXNoOwogICAgICAgIGxldCB0YXJnZXRWZWwgPSBfYmFsbC52ZWxvY2l0eTsKICAgICAgICBsZXQgdGFyZ2V0SW5wdXQgPSBudWxsOwogICAgICAgIGxldCBpc0FpbWluZyA9IGZhbHNlOwoKICAgICAgICBpZiAoX2JhbGwuaG9sZGVyICYmIF9iYWxsLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgIHRhcmdldE1lc2ggPSBfYmFsbC5ob2xkZXIubWVzaDsKICAgICAgICAgICAgdGFyZ2V0VmVsID0gX2JhbGwuaG9sZGVyLnZlbG9jaXR5OwogICAgICAgICAgICBpZiAoX2JhbGwuaG9sZGVyLmlucHV0VmVjdG9yKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRJbnB1dCA9IF9iYWxsLmhvbGRlci5pbnB1dFZlY3RvcjsKICAgICAgICAgICAgfQovLyBDaGVjayBhaW1pbmcgc3RhdGUgKENoYXJnaW5nIG9yIFRocm93aW5nKQogICAgICAgICAgICBpZiAoX2JhbGwuaG9sZGVyLmlzQ2hhcmdpbmcgfHwgX2JhbGwuaG9sZGVyLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIGlzQWltaW5nID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KHRhcmdldE1lc2gsIHRhcmdldFZlbCwgdGFyZ2V0SW5wdXQsIGlzQWltaW5nKTsKICAgICAgICBfY2FtZXJhTWFuYWdlci51cGRhdGUoZHQpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNoZWNrQmFsbEdyYWIoZW50aXR5KSB7CiAgICAgICAgaWYgKCFlbnRpdHkuY2FuQ2F0Y2gpIHJldHVybjsKICAgICAgICBpZiAoX2JhbGwgJiYgIV9iYWxsLmlzQ2F0Y2hhYmxlKCkpIHJldHVybjsKICAgICAgICBpZiAoZW50aXR5LnN0dW5UaW1lciA+IDAgfHwgKGVudGl0eS5zdGF0dXMgJiYgZW50aXR5LnN0YXR1cy5uYXAgPiAwKSkgcmV0dXJuOwogICAgICAgIGlmIChfYmFsbC5zdGF0ZSAhPT0gJ2ZyZWUnKSByZXR1cm47CiAgICAgICAgaWYgKCFfYmFsbC5tZXNoIHx8ICFlbnRpdHkubWVzaCkgcmV0dXJuOwoKY29uc3QgYmFsbFBvcyA9IF9iYWxsLm1lc2gucG9zaXRpb247CiAgICAgICAgY29uc3QgZW50UG9zID0gZW50aXR5Lm1lc2gucG9zaXRpb247CgogICAgICAgIGNvbnN0IGR4ID0gYmFsbFBvcy54IC0gZW50UG9zLng7CiAgICAgICAgY29uc3QgZHogPSBiYWxsUG9zLnogLSBlbnRQb3MuejsKICAgICAgICBjb25zdCBkaXN0WFogPSBNYXRoLnNxcnQoZHgqZHggKyBkeipkeik7CiAgICAgICAgY29uc3QgZGlzdFkgPSBNYXRoLmFicyhiYWxsUG9zLnkgLSBlbnRQb3MueSk7CgogICAgICAgIC8vIEFzc2lzdCB0dW5pbmcgKDAuLjEpCiAgICAgICAgY29uc3QgcyA9ICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTyAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTy5zZXR0aW5ncykgPyB3aW5kb3cuZmx1eC5fZGVidWdJTy5zZXR0aW5ncyA6IG51bGw7CiAgICAgICAgY29uc3QgY2F0Y2hBc3Npc3QgPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCAocyAmJiB0eXBlb2Ygcy5jYXRjaEFzc2lzdCA9PT0gJ251bWJlcicpID8gcy5jYXRjaEFzc2lzdCA6IDAuMCkpOwogICAgICAgIGNvbnN0IHByZWRpY3RpdmVUID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMC41LCAocyAmJiB0eXBlb2Ygcy5wcmVkaWN0aXZlQ2F0Y2hUaW1lID09PSAnbnVtYmVyJykgPyBzLnByZWRpY3RpdmVDYXRjaFRpbWUgOiAwLjEyKSk7CgogICAgICAgIC8vIFByZWRpY3RpdmUgc2FtcGxlIChoZWxwcyB3aXRoIGZhc3QgYmFsbHMgdGhhdCBza2ltIGJ5KQogICAgICAgIGNvbnN0IHByZWRQb3MgPSBfdGVtcFZlYzMuY29weShiYWxsUG9zKS5hZGRTY2FsZWRWZWN0b3IoX2JhbGwudmVsb2NpdHksIHByZWRpY3RpdmVUKTsKCiAgICAgICAgY29uc3QgZHhQID0gcHJlZFBvcy54IC0gZW50UG9zLng7CiAgICAgICAgY29uc3QgZHpQID0gcHJlZFBvcy56IC0gZW50UG9zLno7CiAgICAgICAgY29uc3QgZGlzdFhaUHJlZCA9IE1hdGguc3FydChkeFAqZHhQICsgZHpQKmR6UCk7CiAgICAgICAgY29uc3QgZGlzdFlQcmVkID0gTWF0aC5hYnMocHJlZFBvcy55IC0gZW50UG9zLnkpOwoKICAgICAgICBjb25zdCBlZmZEaXN0WFogPSBNYXRoLm1pbihkaXN0WFosIGRpc3RYWlByZWQpOwogICAgICAgIGNvbnN0IGVmZkRpc3RZICA9IE1hdGgubWluKGRpc3RZLCAgZGlzdFlQcmVkKTsKCiAgICAgICAgY29uc3QgdG91Y2hSYWRpdXMgPSAxLjAgKyAoMC42ICogY2F0Y2hBc3Npc3QpOwogICAgICAgIC8vIEJhc2UgcmFkaWkgKHNsaWdodGx5IGZvcmdpdmluZyBieSBkZWZhdWx0OyBhc3Npc3Qgc2NhbGVzIHRoZW0gdXApCiAgICAgICAgbGV0IG1hZ25ldFJhZGl1cyA9IDEuOCArICgxLjYgKiBjYXRjaEFzc2lzdCk7CiAgICAgICAgbGV0IGludGVyYWN0aW9uUmFkaXVzID0gMy41ICsgKDIuMiAqIGNhdGNoQXNzaXN0KTsKICAgICAgICBsZXQgY2F0Y2hIZWlnaHQgPSAzLjAgKyAoMS42ICogY2F0Y2hBc3Npc3QpOwoKICAgICAgICBpZiAoZW50aXR5LmlzRGFzaGluZykgewogICAgICAgICAgICBtYWduZXRSYWRpdXMgPSAzLjA7CiAgICAgICAgICAgIGludGVyYWN0aW9uUmFkaXVzID0gNC41OwogICAgICAgICAgICBjYXRjaEhlaWdodCA9IDQuNTsKICAgICAgICB9CgogICAgICAgIGlmIChlZmZEaXN0WFogPiBpbnRlcmFjdGlvblJhZGl1cyB8fCBlZmZEaXN0WSA+IGNhdGNoSGVpZ2h0KSByZXR1cm47CgogICAgICAgIC8vIE9wdGltaXphdGlvbjogVXNlIHNoYXJlZCB2ZWN0b3JzIHRvIGF2b2lkIEdDCmNvbnN0IHNhbXBsZVBvcyA9IChkaXN0WFpQcmVkIDwgZGlzdFhaKSA/IHByZWRQb3MgOiBiYWxsUG9zOwogICAgICAgIF90ZW1wVmVjMS5jb3B5KHNhbXBsZVBvcykuc3ViKGVudFBvcykubm9ybWFsaXplKCk7IC8vIHRvQmFsbCAocHJlZGljdGl2ZSBpZiBjbG9zZXIpCiAgICAgICAgX3RlbXBWZWMyLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24oZW50aXR5Lm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7IC8vIHBsYXllckZvcndhcmQKCiAgICAgICAgY29uc3QgZmFjaW5nRG90ID0gX3RlbXBWZWMyLmRvdChfdGVtcFZlYzEpOwoKICAgICAgICBjb25zdCBjb25lVGhyZXNob2xkID0gLTAuMiAtICgwLjQgKiAodHlwZW9mIGNhdGNoQXNzaXN0ICE9PSAndW5kZWZpbmVkJyA/IGNhdGNoQXNzaXN0IDogMC4wKSk7CiAgICAgICAgY29uc3QgaXNJbkNvbmUgPSBmYWNpbmdEb3QgPiBjb25lVGhyZXNob2xkOwogICAgICAgIGNvbnN0IGlzSW5Ub3VjaCA9IGVmZkRpc3RYWiA8IHRvdWNoUmFkaXVzOwoKICAgICAgICBpZiAoZWZmRGlzdFhaIDwgaW50ZXJhY3Rpb25SYWRpdXMgJiYgIWlzSW5Db25lKSB7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldEFuZ2xlID0gTWF0aC5hdGFuMihfdGVtcFZlYzEueCwgX3RlbXBWZWMxLnopOwogICAgICAgICAgICBjb25zdCBxID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMSwwKSwgdGFyZ2V0QW5nbGUpOwogICAgICAgICAgICBlbnRpdHkubWVzaC5xdWF0ZXJuaW9uLnNsZXJwKHEsIDAuMSk7CiAgICAgICAgICAgIGlmIChlbnRpdHkuc3luY1JvdGF0aW9uKSBlbnRpdHkuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgfQoKLy8gKFJlbW92ZWQgZHVwbGljYXRlIGxvZ2ljIGJsb2NrKQoKICAgICAgICBpZiAoaXNJblRvdWNoIHx8IChlZmZEaXN0WFogPCBtYWduZXRSYWRpdXMgJiYgaXNJbkNvbmUpKSB7CiAgICAgICAgICAgIC8vIEJMQVNUIFRIUk9VR0ggTE9HSUMKICAgICAgICAgICAgY29uc3QgYmFsbFNwZWVkID0gX2JhbGwudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgIGxldCBjYXRjaENoYW5jZSA9IDEuMDsKCiAgICAgICAgICAgIC8vIElmIGJhbGwgaXMgbW92aW5nIGZhc3QgKGUuZy4gPiAyMCksIGNoZWNrIENBCiAgICAgICAgICAgIGlmIChiYWxsU3BlZWQgPiAyMC4wKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjYSA9IGVudGl0eS5nZXRTdGF0KCdDQScpOwogICAgICAgICAgICAgICAgLy8gRGlmZmljdWx0eSBzY2FsZXMgd2l0aCBzcGVlZC4gCiAgICAgICAgICAgICAgICBjb25zdCBkaWZmaWN1bHR5ID0gYmFsbFNwZWVkICogMS4yOyAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGRpZmZpY3VsdHkgPiBjYSkgewogICAgICAgICAgICAgICAgICAgIGNhdGNoQ2hhbmNlID0gMC40ICsgKGNhIC8gZGlmZmljdWx0eSkgKiAwLjY7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUG9pbnQgQmxhbmsgUGVuYWx0eTogSGFyZGVyIHRvIHJlYWN0IGlmIGJhbGwgaXMgcmlnaHQgb24gdG9wIG9mIHlvdSBtb3ZpbmcgZmFzdAogICAgICAgICAgICAgICAgICAgIGlmIChlZmZEaXN0WFogPCAxLjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2F0Y2hDaGFuY2UgKj0gMC42OyAvLyBCbGFzdCB0aHJvdWdoIGxpa2VseQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoZW50aXR5LmlzRGFzaGluZykgY2F0Y2hDaGFuY2UgKz0gMC4yOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKF9iYWxsLnBvd2VyVHlwZSA9PT0gJ1NIJyAmJiBfYmFsbC5wb3dlciA+IDE1LjApIHsKICAgICAgICAgICAgICAgIC8vIFNob3QgcG93ZXIgY2hlY2sKICAgICAgICAgICAgICAgIGNvbnN0IGNhID0gZW50aXR5LmdldFN0YXQoJ0NBJyk7CiAgICAgICAgICAgICAgICBpZiAoX2JhbGwucG93ZXIgPiBjYSAqIDEuMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5jZSA9IE1hdGgubWluKDAuNywgKF9iYWxsLnBvd2VyIC0gY2EpICogMC4wNCk7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hDaGFuY2UgPSAxLjAgLSBjaGFuY2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFzc2lzdCBudWRnZXMgY2F0Y2ggb2RkcyB1cHdhcmQgKG5ldmVyIGd1YXJhbnRlZXMpCiAgICAgICAgICAgIGlmICh0eXBlb2YgY2F0Y2hBc3Npc3QgIT09ICd1bmRlZmluZWQnICYmIGNhdGNoQXNzaXN0ID4gMCkgewogICAgICAgICAgICAgICAgY2F0Y2hDaGFuY2UgPSBNYXRoLm1heCgwLjA1LCBNYXRoLm1pbigxLjAsIGNhdGNoQ2hhbmNlICogKDEuMCAtIDAuMjUgKiBjYXRjaEFzc2lzdCkgKyAoMC4yNSAqIGNhdGNoQXNzaXN0KSkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgZnVtYmxlID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gY2F0Y2hDaGFuY2UpIHsKICAgICAgICAgICAgICAgIGZ1bWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmdW1ibGUpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIGZlZWRiYWNrIGZvciBibGFzdCB0aHJvdWdoCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxBU1QgVEhST1VHSCEiLCBlbnRQb3MsICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGVmbGVjdCBzbGlnaHRseSBidXQga2VlcCBtb3ZpbmcgZmFzdCAoQmxhc3QgVGhyb3VnaCkKICAgICAgICAgICAgICAgIC8vIERvbid0IHN0b3AgaXQgY29tcGxldGVseSBsaWtlIGEgYmxvY2ssIGp1c3QgcGVydHVyYiBpdAogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC44NSk7IAogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogNS4wOwogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkueSArPSAoTWF0aC5yYW5kb20oKSkgKiA1LjA7IC8vIFBvcCB1cAogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogNS4wOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfYmFsbC5wb3dlciAqPSAwLjc7CgogICAgICAgICAgICAgICAgZW50aXR5LmNhbkNhdGNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBTdHVuIGJyaWVmbHkKICAgICAgICAgICAgICAgIGVudGl0eS5zdHVuVGltZXIgPSAwLjU7CiAgICAgICAgICAgICAgICBpZihlbnRpdHkucGxheSkgZW50aXR5LnBsYXkoJ3JlYWN0JywgMC4xKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IGVudGl0eS5jYW5DYXRjaCA9IHRydWU7IH0sIDEwMDApOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9iYWxsLm1hZ25ldGl6ZShlbnRpdHkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIFN0YXJ0CiAgICBpbml0KCk7Cn0pKCk7","./main.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgLy8gTmFtZXNwYWNlCiAgICB3aW5kb3cuZmx1eCA9IHdpbmRvdy5mbHV4IHx8IHt9OwogICAgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyA9IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgfHwgW107CgogICAgLy8gQ29uZmlnCmNvbnN0IF9jb25maWcgPSB7CiAgICAgICAgaW50ZXJuYWxXaWR0aDogMzYwLAogICAgICAgIGludGVybmFsSGVpZ2h0OiA2NDAsCiAgICAgICAgYmdDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgZm9nQ29sb3I6IDB4MDAxZTM2LAogICAgICAgIGZvZ0RlbnNpdHk6IDAuMDAwMSwgLy8gRHJhc3RpY2FsbHkgcmVkdWNlZCB0byBlbnN1cmUgdmlzaWJpbGl0eQogICAgICAgIGFyZW5hUmFkaXVzOiA0OC4wCiAgICB9OwoKICAgIC8vIEdsb2JhbHMKLy8gR2xvYmFscwogICAgY29uc3QgX2lucHV0ID0geyB4OiAwLCB5OiAwIH07IC8vIElucHV0IHN0YXRlCiAgICAKICAgIC8vIFNoYWRlciBVbmlmb3JtcwogICAgY29uc3QgX2FyZW5hVW5pZm9ybXMgPSB7CiAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICB1SW1wYWN0UG9zOiB7IHZhbHVlOiBuZXcgVEhSRUUuVmVjdG9yMygpIH0sCiAgICAgICAgdUltcGFjdFN0cjogeyB2YWx1ZTogMC4wIH0KICAgIH07CiAgICBjb25zdCBfcGFydGljbGVVbmlmb3JtcyA9IHsKICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9CiAgICB9OwoKICAgIC8vIEV4cG9zZSBJbXBhY3QgVHJpZ2dlcgogICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0ID0gZnVuY3Rpb24ocG9zLCBzdHJlbmd0aCkgewogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RQb3MudmFsdWUuY29weShwb3MpOwogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RTdHIudmFsdWUgPSBzdHJlbmd0aCAqIDIuMDsgLy8gU2NhbGUgdXAgZm9yIHZpc2liaWxpdHkKICAgIH07Ci8vIF9pbnB1dCBhbHJlYWR5IGRlY2xhcmVkIGFib3ZlCiAgICBjb25zdCBfdGVtcFZlYzEgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBSZXVzYWJsZSBmb3IgcGh5c2ljcy9sb2dpYwogICAgY29uc3QgX3RlbXBWZWMyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsgLy8gUmV1c2FibGUgZm9yIHBoeXNpY3MvbG9naWMKICAgIGNvbnN0IF90ZW1wVmVjMyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7IC8vIFJldXNhYmxlIGZvciBwcmVkaWN0aXZlIGFzc2lzdAogICAgbGV0IF9zY2VuZSwgX2NhbWVyYSwgX3JlbmRlcmVyLCBfY2xvY2s7CiAgICBsZXQgX2hvbWVUZWFtLCBfYXdheVRlYW07CiAgICBsZXQgX2JhbGw7CiAgICBsZXQgX2dhbWVNYW5hZ2VyOwogICAgbGV0IF9tZW51TWFuYWdlcjsKICAgIGxldCBfYXVkaW9NYW5hZ2VyOwoKICAgIGxldCBfY2FtZXJhTWFuYWdlcjsKICAgIGxldCBfd2F0ZXJPdmVybGF5OwogICAgbGV0IF9saWdodFNoYWZ0czsKICAgIGxldCBfc3RhZGl1bTsKICAgIGxldCBfZ2x5cGhNYW5hZ2VyOwoKICAgIC8vIElNUFJPVkVEOiBTZXR0aW5ncyBvYmplY3QKICAgIGNvbnN0IF9zZXR0aW5ncyA9IHsKICAgICAgICBqb3lzdGlja1NlbnNpdGl2aXR5OiAxLjAsCiAgICAgICAgYWltQXNzaXN0OiB0cnVlLAogICAgICAgIGNhbWVyYVNoYWtlOiB0cnVlLAogICAgICAgIGhpdFN0b3A6IHRydWUsCiAgICAgICAgaW52ZXJ0Q2FtZXJhOiBmYWxzZSwKICAgICAgICBhdXRvUmVjZW50ZXI6IHRydWUsCgogICAgICAgIC8vIC0tLSAiRkVFTFMgR09PRCIgQVNTSVNUIExBWUVSICh0dW5hYmxlIGluIERldlRvb2xzIHNuYXBzaG90cykgLS0tCiAgICAgICAgLy8gMC4wID0gb2ZmIC8gcHVyZSBza2lsbCwgMS4wID0gdmVyeSBoZWxwZnVsIGJ1dCBub3QgZnVsbCBhdXRvLXBsYXkuCiAgICAgICAgcGFzc0FpbUFzc2lzdDogMC42NSwKICAgICAgICBzaG90QWltQXNzaXN0OiAwLjM1LAogICAgICAgIGNhdGNoQXNzaXN0OiAwLjU1LAogICAgICAgIHN0ZWVyaW5nQXNzaXN0OiAwLjM1LAoKICAgICAgICAvLyBIaWdoZXIgPSBzbmFwcGllciBpbnB1dCwgbG93ZXIgPSBmbG9hdGllci4KICAgICAgICBpbnB1dFJlc3BvbnNlOiAxNC4wLAoKICAgICAgICAvLyBTZWNvbmRzIGFoZWFkIHVzZWQgZm9yIGNhdGNoIHByZWRpY3Rpb24gKGhlbHBzIHdpdGggZmFzdCBiYWxscykuCiAgICAgICAgcHJlZGljdGl2ZUNhdGNoVGltZTogMC4xMgogICAgfTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIERlYnVnIElPIEJyaWRnZSAoZXhwb3NlZCBmb3IgRGV2VG9vbHMgSlNPTiBzbmFwc2hvdHMpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IF9kZWJ1Z0lPID0gd2luZG93LmZsdXguX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyB8fCB7fTsKICAgIF9kZWJ1Z0lPLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgX2RlYnVnSU8uaW5wdXQgPSBfZGVidWdJTy5pbnB1dCB8fCB7fTsKICAgIF9kZWJ1Z0lPLnBlcmYgPSBfZGVidWdJTy5wZXJmIHx8IHsgZnJhbWU6IDAsIHJhd0R0OiAwLCBkdDogMCwgZnBzOiAwLCBhdmdGcHM6IDAgfTsKCgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBUb3VjaCBoZWxwZXJzIChtdWx0aS10b3VjaCBzYWZlKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBmdW5jdGlvbiBfZmluZFRvdWNoQnlJZCh0b3VjaExpc3QsIGlkKSB7CiAgICAgICAgaWYgKGlkID09PSBudWxsIHx8IGlkID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgICAgIGlmICghdG91Y2hMaXN0KSByZXR1cm4gbnVsbDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRvdWNoTGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCB0ID0gdG91Y2hMaXN0W2ldOwogICAgICAgICAgICBpZiAodCAmJiB0LmlkZW50aWZpZXIgPT09IGlkKSByZXR1cm4gdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gX2VuZGVkVG91Y2hCeUlkKGNoYW5nZWRUb3VjaGVzLCBpZCkgewogICAgICAgIGlmIChpZCA9PT0gbnVsbCB8fCBpZCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgICBpZiAoIWNoYW5nZWRUb3VjaGVzKSByZXR1cm4gbnVsbDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoYW5nZWRUb3VjaGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IHQgPSBjaGFuZ2VkVG91Y2hlc1tpXTsKICAgICAgICAgICAgaWYgKHQgJiYgdC5pZGVudGlmaWVyID09PSBpZCkgcmV0dXJuIHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKCiAgICBmdW5jdGlvbiBpbml0KCkgewogICAgICAgIF9jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKCiAgICAgICAgLy8gMS4gU2NlbmUKICAgICAgICBfc2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTsKICAgICAgICBfc2NlbmUuYmFja2dyb3VuZCA9IG5ldyBUSFJFRS5Db2xvcihfY29uZmlnLmJnQ29sb3IpOwogICAgICAgIF9zY2VuZS5mb2cgPSBuZXcgVEhSRUUuRm9nRXhwMihfY29uZmlnLmZvZ0NvbG9yLCBfY29uZmlnLmZvZ0RlbnNpdHkpOwoKICAgICAgICAvLyAyLiBDYW1lcmEKICAgICAgICBjb25zdCBhc3BlY3QgPSBfY29uZmlnLmludGVybmFsV2lkdGggLyBfY29uZmlnLmludGVybmFsSGVpZ2h0OwpfY2FtZXJhID0gbmV3IFRIUkVFLlBlcnNwZWN0aXZlQ2FtZXJhKDYwLCBhc3BlY3QsIDAuMSwgNTAwKTsKX2NhbWVyYS5wb3NpdGlvbi5zZXQoMCwgMTQsIDIyKTsKICAgICAgICBfY2FtZXJhLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICBfc2NlbmUuYWRkKF9jYW1lcmEpOyAvLyBFbnN1cmUgY2FtZXJhIGlzIGluIHNjZW5lIGZvciBjaGlsZHJlbiB0byByZW5kZXIKCiAgICAgICAgLy8gMy4gUmVuZGVyZXIKLy8gMy4gUmVuZGVyZXIKICAgICAgICBfcmVuZGVyZXIgPSBuZXcgVEhSRUUuV2ViR0xSZW5kZXJlcih7IAogICAgICAgICAgICBhbnRpYWxpYXM6IGZhbHNlLAogICAgICAgICAgICBwb3dlclByZWZlcmVuY2U6ICJoaWdoLXBlcmZvcm1hbmNlIiwKICAgICAgICAgICAgcHJlY2lzaW9uOiAibWVkaXVtcCIsIC8vIE1vYmlsZSBvcHRpbWl6YXRpb246IGZhc3RlciBzaGFkZXJzCiAgICAgICAgICAgIHN0ZW5jaWw6IGZhbHNlLCAgICAgICAvLyBEaXNhYmxlIHN0ZW5jaWwgYnVmZmVyIGlmIG5vdCB1c2VkCiAgICAgICAgICAgIGRlcHRoOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgX3JlbmRlcmVyLnNldFBpeGVsUmF0aW8oMSk7IC8vIEZvcmNlIDE6MSBwaXhlbCByYXRpbywgd2UgaGFuZGxlIHNjYWxpbmcgdmlhIHNldFNpemUKICAgICAgICBfcmVuZGVyZXIuYXV0b0NsZWFyID0gZmFsc2U7IC8vIFdlIG1hbmFnZSBjbGVhcmluZyB2aWEgYmFja2dyb3VuZCBvciBtYW51YWwgY2FsbHMgaWYgbmVlZGVkICh0aG91Z2ggc2NlbmUuYmFja2dyb3VuZCBoYW5kbGVzIGNvbG9yKQogICAgICAgIC8vIEV4cG9zZSByZW5kZXJlciBmb3IgRGV2VG9vbHMKICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSBfZ2FtZU1hbmFnZXIucmVuZGVyZXIgPSBfcmVuZGVyZXI7IAogICAgICAgIGVsc2Ugd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID0geyByZW5kZXJlcjogX3JlbmRlcmVyIH07IC8vIFRlbXAgaG9vawpfY29udGFpbmVyLmFwcGVuZENoaWxkKF9yZW5kZXJlci5kb21FbGVtZW50KTsKCi8vIC0tLSBWaWRlbyBPdmVybGF5IEVuZm9yY2VtZW50IC0tLQogICAgICAgIC8vIC0tLSBPdmVybGF5IFZpZGVvIExvZ2ljIFJlbW92ZWQgKFN3aXRjaGVkIHRvIEdJRikgLS0tCiAgICAgICAgLy8gNS4gRW52aXJvbm1lbnQKICAgICAgICBjcmVhdGVQYXJ0aWNsZXMoKTsKICAgICAgICBjcmVhdGVBcmVuYSgpOwoKLy8gNS41IEdhbWUgTWFuYWdlcgpfZ2FtZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguR2FtZU1hbmFnZXIoX3NjZW5lLCAndWktbGF5ZXInLCBfY2FtZXJhLCBfcmVuZGVyZXIpOwogICAgICAgIAogICAgICAgIC8vIDUuNS4xIEF1ZGlvIE1hbmFnZXIKICAgICAgICBfYXVkaW9NYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkF1ZGlvTWFuYWdlcigpOwogICAgICAgIF9nYW1lTWFuYWdlci5hdWRpb01hbmFnZXIgPSBfYXVkaW9NYW5hZ2VyOwoKICAgICAgICAvLyA1LjYgQ2FtZXJhIE1hbmFnZXIKICAgICAgICBfY2FtZXJhTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5DYW1lcmFNYW5hZ2VyKF9jYW1lcmEsIF9zY2VuZSk7CiAgICAgICAgX2dhbWVNYW5hZ2VyLmNhbWVyYU1hbmFnZXIgPSBfY2FtZXJhTWFuYWdlcjsKCiAgICAgICAgLy8gNS43IERldiBUb29scwppZiAod2luZG93LmZsdXguRGV2VG9vbHMpIHsKICAgICAgICAgICAgbmV3IHdpbmRvdy5mbHV4LkRldlRvb2xzKF9nYW1lTWFuYWdlcik7CiAgICAgICAgfQovLyA1LjggV2F0ZXIgT3ZlcmxheSwgTGlnaHQgU2hhZnRzLCBTdGFkaXVtLCBHbHlwaHMKICAgICAgICBfd2F0ZXJPdmVybGF5ID0gbmV3IHdpbmRvdy5mbHV4LldhdGVyT3ZlcmxheShfY2FtZXJhKTsKICAgICAgICBfbGlnaHRTaGFmdHMgPSBuZXcgd2luZG93LmZsdXguTGlnaHRTaGFmdHMoX3NjZW5lKTsKICAgICAgICBfc3RhZGl1bSA9IG5ldyB3aW5kb3cuZmx1eC5TdGFkaXVtKF9zY2VuZSk7CiAgICAgICAgX2dseXBoTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5HbHlwaE1hbmFnZXIoX3NjZW5lKTsKICAgICAgICAKaWYgKF9nYW1lTWFuYWdlcikgewogICAgICAgICAgICBfZ2FtZU1hbmFnZXIuZ2x5cGhNYW5hZ2VyID0gX2dseXBoTWFuYWdlcjsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLndhdGVyT3ZlcmxheSA9IF93YXRlck92ZXJsYXk7CiAgICAgICAgICAgIF9nYW1lTWFuYWdlci5saWdodFNoYWZ0cyA9IF9saWdodFNoYWZ0czsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnN0YWRpdW0gPSBfc3RhZGl1bTsKICAgICAgICB9CiAgICAgICAgLy8gNi4gVGVhbXMgU2V0dXAKICAgICAgICBfaG9tZVRlYW0gPSBuZXcgd2luZG93LmZsdXguVGVhbShfc2NlbmUsICdob21lJywgMSwgMHgwMGFhZmYsIHRydWUpOwogICAgICAgIF9hd2F5VGVhbSA9IG5ldyB3aW5kb3cuZmx1eC5UZWFtKF9zY2VuZSwgJ2F3YXknLCAtMSwgMHhmZjY2NjYsIGZhbHNlKTsKCiAgICAgICAgLy8gNy4gQmFsbAogICAgICAgIF9iYWxsID0gbmV3IHdpbmRvdy5mbHV4LkJhbGwoX3NjZW5lKTsKCiAgICAgICAgLy8gSU1QUk9WRUQ6IExpbmsgYmFsbCB0byBjYW1lcmEgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICBfY2FtZXJhTWFuYWdlci5zZXRCYWxsKF9iYWxsKTsKCiAgICAgICAgLy8gOC4gVGVhbSBSb3N0ZXIgTW9kZWxzCiAgICAgICAgY29uc3Qgcm9sZXMgPSBbJ0xGJywgJ1JGJywgJ01GJywgJ0xEJywgJ1JEJywgJ0dMJ107CiAgICAgICAgY29uc3QgaG9tZVJvc3RlciA9IHsKICAgICAgICAgICAgTEY6IHsgbmFtZTogJ1RpZHVzJywgdXJsOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2RhNzg4YmVmMjU4YzRmMGI4ZDllZjFhY2MxOWM1NTY3LmdsYicgfSwKICAgICAgICAgICAgUkY6IHsgbmFtZTogJ1dha2thJywgdXJsOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzLzU5MTE0Yzk4OTUxNjQ3YzliOGRhNzRiMGJkMzYzNmNiLmdsYicgfSwKICAgICAgICAgICAgTUY6IHsgbmFtZTogJ0xldHR5JywgdXJsOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzLzQzYWNlMzRjNmZkOTQyMTU5NjdlODQyYmY5MDlkYTVlLmdsYicgfSwKICAgICAgICAgICAgTEQ6IHsgbmFtZTogJ0RhdHRvJywgdXJsOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2U2ZDY3ZWNiMmU0YzQ3MTViZDczYTQwNzk1ZTFkM2Q1LmdsYicgfSwKICAgICAgICAgICAgUkQ6IHsgbmFtZTogJ0phc3N1JywgdXJsOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzLzgyMTY0NTk1NjczNTRlNjM5NThkNDEwOGQ4MjhkZTk4LmdsYicgfSwKICAgICAgICAgICAgR0w6IHsgbmFtZTogJ0JvdHRhJywgdXJsOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2FkMTU1ZWZlZGMwZDQ4ZmRhZDA5ZGEzZTFjYWU5Yzk3LmdsYicgfQogICAgICAgIH07CgogICAgICAgIGNvbnN0IGFwcGx5U3RhdHMgPSAocCwgcm9sZSwgaXNIb21lKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHRlYW1MZXZlbCA9IGlzSG9tZSA/IDI1IDogMjI7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LlRlYW0uZ2VuZXJhdGVTdGF0cyhwLCByb2xlLCB0ZWFtTGV2ZWwsIGlzSG9tZSk7CgogICAgICAgICAgICBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDU7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNQICs9IDM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDM7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkVOICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdCcm90aGVyJykpIHsKICAgICAgICAgICAgICAgIHAuc3RhdHMuU1AgPSA5OTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcC5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CiAgICAgICAgfTsKCiAgICAgICAgbGV0IGhvbWVMb2FkZWQgPSAwOwogICAgICAgIGNvbnN0IHJvbGVHbHRmcyA9IHt9OwoKICAgICAgICBjb25zdCBmaW5hbGl6ZVRlYW1zID0gKCkgPT4gewogICAgICAgICAgICByb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZ2x0ZiA9IHJvbGVHbHRmc1tyb2xlXSB8fCByb2xlR2x0ZnMuTEY7CgogICAgICAgICAgICAgICAgY29uc3QgcCA9IChyb2xlID09PSAnR0wnKQogICAgICAgICAgICAgICAgICAgID8gbmV3IHdpbmRvdy5mbHV4LkdvYWxpZShfc2NlbmUsIHJvbGUpCiAgICAgICAgICAgICAgICAgICAgOiBuZXcgd2luZG93LmZsdXguQUlQbGF5ZXIoX3NjZW5lLCByb2xlKTsKCiAgICAgICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgICAgICBwLmNoYXJhY3Rlck5hbWUgPSBlbnRyeSA/IGBDUFUgJHtlbnRyeS5uYW1lfWAgOiAnQ1BVJzsKICAgICAgICAgICAgICAgIGFwcGx5U3RhdHMocCwgcm9sZSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmICYmIGdsdGYuc2NlbmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjbG9uZSA9IFRIUkVFLlNrZWxldG9uVXRpbHMuY2xvbmUoZ2x0Zi5zY2VuZSk7CiAgICAgICAgICAgICAgICAgICAgcC5zZXRNZXNoKGNsb25lLCBnbHRmLmFuaW1hdGlvbnMgfHwgW10pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ01pc3NpbmcgR0xURiBmb3IgYXdheSByb2xlOicsIHJvbGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS5hZGRQbGF5ZXIocCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYWxsUGxheWVycyA9IFsuLi5faG9tZVRlYW0ucGxheWVycywgLi4uX2F3YXlUZWFtLnBsYXllcnNdOwogICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAocC5iYWxsUmVmID09PSBudWxsKSBwLmJhbGxSZWYgPSBfYmFsbDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyID0gX2hvbWVUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy50YWNrbGUgPSAndmVub20nOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy5zaG9vdCA9ICdzcGhlcmUnOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0VxdWlwcGVkIEhvbWUgTUYgd2l0aCBWZW5vbSBUYWNrbGUgJiBTcGhlcmUgU2hvdCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBhd2F5TUYgPSBfYXdheVRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgaWYgKGF3YXlNRikgewogICAgICAgICAgICAgICAgYXdheU1GLnRlY2hzLnRhY2tsZSA9ICd3aXRoZXInOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF9hd2F5VGVhbS5zZXRGb3JtYXRpb24oJ0NvdW50ZXInKTsKCiAgICAgICAgICAgIGNvbnN0IGF3YXlHTCA9IF9hd2F5VGVhbS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICBpZiAoYXdheUdMKSB7CiAgICAgICAgICAgICAgICBhd2F5R0wudGVjaHMuYWN0aXZlID0gJ3N1cGVyX2dvYWxpZSc7CiAgICAgICAgICAgICAgICBhd2F5R0wudGVjaHMucGFzc2l2ZSA9ICdncmlwX2dsb3Zlcyc7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRXF1aXBwZWQgQXdheSBHTCB3aXRoIFN1cGVyIEdvYWxpZScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfaG9tZVRlYW0uYXNzaWduTWFya3MoX2F3YXlUZWFtKTsKICAgICAgICAgICAgX2F3YXlUZWFtLmFzc2lnbk1hcmtzKF9ob21lVGVhbSk7CgogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9hZGluZycpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci5yZWdpc3RlclRlYW1zKF9ob21lVGVhbSwgX2F3YXlUZWFtLCBfYmFsbCk7CgogICAgICAgICAgICAgICAgX21lbnVNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4Lk1lbnVNYW5hZ2VyKF9nYW1lTWFuYWdlcik7CiAgICAgICAgICAgICAgICBfbWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCnJvbGVzLmZvckVhY2gocm9sZSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGVudHJ5ID0gaG9tZVJvc3Rlcltyb2xlXTsKICAgICAgICAgICAgaWYgKCFlbnRyeSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb25Db21wbGV0ZSA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGhvbWVMb2FkZWQrKzsKICAgICAgICAgICAgICAgIGlmIChob21lTG9hZGVkID49IHJvbGVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGZpbmFsaXplVGVhbXMoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbChlbnRyeS51cmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgICAgICByb2xlR2x0ZnNbcm9sZV0gPSBnbHRmOwoKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSAocm9sZSA9PT0gJ0dMJykKICAgICAgICAgICAgICAgICAgICA/IG5ldyB3aW5kb3cuZmx1eC5Hb2FsaWUoX3NjZW5lLCByb2xlKQogICAgICAgICAgICAgICAgICAgIDogbmV3IHdpbmRvdy5mbHV4LkFJUGxheWVyKF9zY2VuZSwgcm9sZSk7CgogICAgICAgICAgICAgICAgcC5jaGFyYWN0ZXJOYW1lID0gZW50cnkubmFtZTsKICAgICAgICAgICAgICAgIGFwcGx5U3RhdHMocCwgcm9sZSwgdHJ1ZSk7CgogICAgICAgICAgICAgICAgY29uc3QgY2xvbmUgPSBUSFJFRS5Ta2VsZXRvblV0aWxzLmNsb25lKGdsdGYuc2NlbmUpOwogICAgICAgICAgICAgICAgcC5zZXRNZXNoKGNsb25lLCBnbHRmLmFuaW1hdGlvbnMpOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFkZFBsYXllcihwKTsKCiAgICAgICAgICAgICAgICBvbkNvbXBsZXRlKCk7CiAgICAgICAgICAgIH0sIHVuZGVmaW5lZCwgKGVycikgPT4gewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGxvYWQgbW9kZWwnLCBlbnRyeS5uYW1lLCBlbnRyeS51cmwsIGVycik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIE1lc2ggKFJlZCBCb3gpCiAgICAgICAgICAgICAgICBjb25zdCBmYWxsYmFja0dlbyA9IG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSgxLCAyLCAxKTsKICAgICAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmYwMDAwLCB3aXJlZnJhbWU6IHRydWUgfSk7CiAgICAgICAgICAgICAgICBjb25zdCBmYWxsYmFja01lc2ggPSBuZXcgVEhSRUUuTWVzaChmYWxsYmFja0dlbywgZmFsbGJhY2tNYXQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTdG9yZSBkdW1teSBpbiByb2xlR2x0ZnMgZm9yIGF3YXkgdGVhbSBjbG9uaW5nCiAgICAgICAgICAgICAgICByb2xlR2x0ZnNbcm9sZV0gPSB7IHNjZW5lOiBmYWxsYmFja01lc2gsIGFuaW1hdGlvbnM6IFtdIH07CgogICAgICAgICAgICAgICAgY29uc3QgcCA9IChyb2xlID09PSAnR0wnKQogICAgICAgICAgICAgICAgICAgID8gbmV3IHdpbmRvdy5mbHV4LkdvYWxpZShfc2NlbmUsIHJvbGUpCiAgICAgICAgICAgICAgICAgICAgOiBuZXcgd2luZG93LmZsdXguQUlQbGF5ZXIoX3NjZW5lLCByb2xlKTsKCiAgICAgICAgICAgICAgICBwLmNoYXJhY3Rlck5hbWUgPSBlbnRyeS5uYW1lICsgIiAoRXJyb3IpIjsKICAgICAgICAgICAgICAgIGFwcGx5U3RhdHMocCwgcm9sZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHAuc2V0TWVzaChmYWxsYmFja01lc2guY2xvbmUoKSwgW10pOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFkZFBsYXllcihwKTsKCiAgICAgICAgICAgICAgICBvbkNvbXBsZXRlKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICAvLyA4LiBJbnB1dAogICAgICAgIHNldHVwSW5wdXRzKCk7CgogICAgICAgIC8vIDkuIExvb3AKICAgICAgICBfY2xvY2sgPSBuZXcgVEhSRUUuQ2xvY2soKTsKICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoYW5pbWF0ZSk7CgogICAgICAgIC8vIEhhbmRsZSByZXNpemUKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgb25SZXNpemUpOwogICAgICAgIG9uUmVzaXplKCk7CiAgICB9CgpmdW5jdGlvbiBjcmVhdGVQYXJ0aWNsZXMoKSB7CiAgICAgICAgY29uc3QgY291bnQgPSAxNTAwOyAvLyBJbmNyZWFzZWQgY291bnQKICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgIGNvbnN0IHZlcnRpY2VzID0gW107CiAgICAgICAgY29uc3Qgb2Zmc2V0cyA9IFtdOyAvLyBSYW5kb20gb2Zmc2V0cyBmb3IgaW5kZXBlbmRlbnQgYm9iYmluZwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICAgICAgdmVydGljZXMucHVzaCgKICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDgwLCAvLyBXaWRlciBzcHJlYWQgWAogICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogNTAsIC8vIFdpZGVyIHNwcmVhZCBZCiAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA4MCAgLy8gV2lkZXIgc3ByZWFkIFoKICAgICAgICAgICAgKTsKICAgICAgICAgICAgb2Zmc2V0cy5wdXNoKE1hdGgucmFuZG9tKCkgKiAxMDApOwogICAgICAgIH0KCiAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCdwb3NpdGlvbicsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKHZlcnRpY2VzLCAzKSk7CiAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCdhT2Zmc2V0JywgbmV3IFRIUkVFLkZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUob2Zmc2V0cywgMSkpOwoKICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgIHVuaWZvcm1zOiBfcGFydGljbGVVbmlmb3JtcywKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IGFPZmZzZXQ7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZBbHBoYTsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWMzIHBvcyA9IHBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgIC8vIEJvYmJpbmcgbW90aW9uOiBTaW5lIHdhdmUgYmFzZWQgb24gdGltZSArIHJhbmRvbSBvZmZzZXQKICAgICAgICAgICAgICAgICAgICBmbG9hdCBib2IgPSBzaW4odVRpbWUgKiAwLjUgKyBhT2Zmc2V0KSAqIDIuMDsKICAgICAgICAgICAgICAgICAgICBwb3MueSArPSBib2I7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdmVjNCBtdlBvc2l0aW9uID0gbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3MsIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbXZQb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTaXplIGF0dGVudWF0aW9uIC0gU21hbGwgYW5kIHNoaW1tZXJ5CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc2l6ZUJhc2UgPSAyLjAgKyBzaW4odVRpbWUgKiAzLjAgKyBhT2Zmc2V0KSAqIDEuMDsgCiAgICAgICAgICAgICAgICAgICAgZ2xfUG9pbnRTaXplID0gc2l6ZUJhc2UgKiAoMjAuMCAvIC1tdlBvc2l0aW9uLnopOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhZGUgYmFzZWQgb24gZGlzdGFuY2UvaGVpZ2h0CiAgICAgICAgICAgICAgICAgICAgdkFscGhhID0gMC41ICsgMC41ICogc2luKHVUaW1lICogMi4wICsgYU9mZnNldCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAsCiAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZBbHBoYTsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTb2Z0IGdsb3cgcGFydGljbGUgKER1c3QgbW90ZSkKICAgICAgICAgICAgICAgICAgICB2ZWMyIGNvb3JkID0gZ2xfUG9pbnRDb29yZCAtIHZlYzIoMC41KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkaXN0ID0gbGVuZ3RoKGNvb3JkKTsKICAgICAgICAgICAgICAgICAgICBpZihkaXN0ID4gMC41KSBkaXNjYXJkOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFNvZnQgZmFsbG9mZiBmb3Igc2hpbW1lcgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHN0cmVuZ3RoID0gMS4wIC0gKGRpc3QgKiAyLjApOwogICAgICAgICAgICAgICAgICAgIHN0cmVuZ3RoID0gcG93KHN0cmVuZ3RoLCAyLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEN5YW4vQmx1ZSB0aW50LCBhZGRpdGl2ZSBmZWVsCiAgICAgICAgICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNCgwLjcsIDAuOSwgMS4wLCB2QWxwaGEgKiBzdHJlbmd0aCAqIDAuOCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgcG9pbnRzID0gbmV3IFRIUkVFLlBvaW50cyhnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgIHBvaW50cy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgX3NjZW5lLmFkZChwb2ludHMpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlQXJlbmEoKSB7CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuU3BoZXJlR2VvbWV0cnkoX2NvbmZpZy5hcmVuYVJhZGl1cywgMzIsIDMyKTsKICAgICAgICAKICAgICAgICBjb25zdCB0ZXhMb2FkZXIgPSBuZXcgVEhSRUUuVGV4dHVyZUxvYWRlcigpOwogICAgICAgIGNvbnN0IGFyZW5hVGV4ID0gdGV4TG9hZGVyLmxvYWQoJ2h0dHBzOi8vaS5wb3N0aW1nLmNjL1cxTHNINjhRL2ZpbGUtMDAwMDAwMDAyM2VjNzFmNTk2NTkzODI5ZTgxMTg3NjAtKDEpLnBuZycpOwogICAgICAgIGFyZW5hVGV4Lm1hZ0ZpbHRlciA9IFRIUkVFLk5lYXJlc3RGaWx0ZXI7CiAgICAgICAgYXJlbmFUZXgubWluRmlsdGVyID0gVEhSRUUuTmVhcmVzdEZpbHRlcjsKICAgICAgICBhcmVuYVRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGFyZW5hVGV4LndyYXBUID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgYXJlbmFUZXgucmVwZWF0LnNldCg2LCA0KTsKCiAgICAgICAgLy8gLS0tIFByb2NlZHVyYWwgSGV4IFRleHR1cmUgKElubmVyIExheWVyKSAtLS0KICAgICAgICBjb25zdCBoZXhUZXggPSAoKCkgPT4gewogICAgICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgICAgIGMud2lkdGggPSA1MTI7IGMuaGVpZ2h0ID0gNTEyOwogICAgICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgIC8vIFRyYW5zcGFyZW50IGJhY2tncm91bmQKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLDAsNTEyLDUxMik7CiAgICAgICAgICAgIAogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgwLCAyNTUsIDI1NSwgMC44KSc7CiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgICAgICBjdHguc2hhZG93Qmx1ciA9IDEwOwogICAgICAgICAgICBjdHguc2hhZG93Q29sb3IgPSAnIzAwZmZmZic7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCByID0gNjQ7CiAgICAgICAgICAgIGNvbnN0IHcgPSByICogMjsKICAgICAgICAgICAgY29uc3QgaCA9IE1hdGguc3FydCgzKSAqIHI7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEcmF3IEhleGVzCiAgICAgICAgICAgIGZvcihsZXQgeSA9IC0xOyB5IDwgNTEyL2ggKyAyOyB5KyspIHsKICAgICAgICAgICAgICAgIGZvcihsZXQgeCA9IC0xOyB4IDwgNTEyLyh3KjAuNzUpICsgMjsgeCsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3ggPSB4ICogdyAqIDAuNzU7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3kgPSB5ICogaCArICh4JTI9PT0wID8gMCA6IGgvMik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDY7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmcgPSBNYXRoLlBJLzMgKiBpOwogICAgICAgICAgICAgICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYW5nKSpyLCBjeSArIE1hdGguc2luKGFuZykqcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ2VudGVyIGRvdAogICAgICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgwLCAxMDAsIDI1NSwgMC4zKSc7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKGN4LCBjeSwgNSwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICAgICAgfSkoKTsKICAgICAgICBoZXhUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBoZXhUZXgud3JhcFQgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBoZXhUZXgucmVwZWF0LnNldCg0LCAyKTsKCiAgICAgICAgLy8gLS0tIEFyZW5hIDEgKE91dGVyIEdyaWQpIC0tLQogICAgICAgIGNvbnN0IG1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiBhcmVuYVRleCwKICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLAogICAgICAgICAgICB3aXJlZnJhbWU6IGZhbHNlLAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKb3BhY2l0eTogMC4zLCAKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgY29uc3QgYXJlbmEgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgIF9zY2VuZS5hZGQoYXJlbmEpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaCA9IGFyZW5hOwoKICAgICAgICAvLyAtLS0gQXJlbmEgMiAoSW5uZXIgSGV4ICsgSW1wYWN0IFNoYWRlcikgLS0tCiAgICAgICAgLy8gV2UgdXNlIGEgY3VzdG9tIHNoYWRlciB0byB3YXJwIHZlcnRpY2VzIG9uIGltcGFjdAogICAgICAgIGNvbnN0IGFyZW5hVW5pZm9ybXMgPSBUSFJFRS5Vbmlmb3Jtc1V0aWxzLm1lcmdlKFsKICAgICAgICAgICAgVEhSRUUuVW5pZm9ybXNMaWJbJ2NvbW1vbiddLAogICAgICAgICAgICBfYXJlbmFVbmlmb3JtcywKICAgICAgICAgICAgeyAKICAgICAgICAgICAgICAgIHRNYXA6IHsgdmFsdWU6IGhleFRleCB9LAp1T3BhY2l0eTogeyB2YWx1ZTogMC4yNSB9IC8vIEV4cG9zZWQgdW5pZm9ybQogICAgICAgICAgICB9CiAgICAgICAgXSk7CgogICAgICAgIGNvbnN0IG1hdGVyaWFsMiA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgIHVuaWZvcm1zOiBhcmVuYVVuaWZvcm1zLAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgc2lkZTogVEhSRUUuQmFja1NpZGUsCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMzIHVJbXBhY3RQb3M7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVJbXBhY3RTdHI7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdlV2OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdlV2ID0gdXY7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJbXBhY3QgTG9naWMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkaXN0ID0gZGlzdGFuY2UocG9zLCB1SW1wYWN0UG9zKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYWRpdXMgPSAyMC4wOyAvLyBSYWRpdXMgb2YgZGVmb3JtYXRpb24KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHJhZGl1cykgewogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCB0ID0gZGlzdCAvIHJhZGl1czsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgYnVsZ2UgPSAoMS4wIC0gdCkgKiAoMS4wIC0gdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHJpcHBsZSA9IHNpbih0ICogMTAuMCAtIHVUaW1lICogNS4wKSAqIDAuMTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBub3JtYWwgPSBub3JtYWxpemUocG9zKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zICs9IG5vcm1hbCAqIChidWxnZSAqIHVJbXBhY3RTdHIpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3MsIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAsCiAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIHNhbXBsZXIyRCB0TWFwOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1SW1wYWN0U3RyOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWM0IHRleENvbG9yID0gdGV4dHVyZTJEKHRNYXAsIHZVdik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQmFzZSBvcGFjaXR5ICsgSW1wYWN0IEhpZ2hsaWdodAogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gdU9wYWNpdHkgKiB0ZXhDb2xvci5hOwogICAgICAgICAgICAgICAgICAgIGFscGhhICs9IHVJbXBhY3RTdHIgKiAwLjAyOyAKCiAgICAgICAgICAgICAgICAgICAgLy8gVGludCBDeWFuL0JsdWUKICAgICAgICAgICAgICAgICAgICB2ZWMzIGNvbG9yID0gdGV4Q29sb3IucmdiICogdmVjMygwLjUsIDEuMCwgMS4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTY2FubGluZSBlZmZlY3QKICAgICAgICAgICAgICAgICAgICBmbG9hdCBzY2FuID0gc2luKHZVdi55ICogMTAwLjAgKyB1SW1wYWN0U3RyKSAqIDAuMTsKICAgICAgICAgICAgICAgICAgICBjb2xvciArPSBzY2FuOwoKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbG9yLCBhbHBoYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgYXJlbmEyID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsMik7CiAgICAgICAgYXJlbmEyLnNjYWxlLnNldFNjYWxhcigwLjk4KTsgLy8gU2xpZ2h0bHkgc21hbGxlcgogICAgICAgIF9zY2VuZS5hZGQoYXJlbmEyKTsKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyID0gYXJlbmEyOwogICAgICAgIC8vIC0tLSBORVc6IEZGWCBHT0FMIE1PREVMUyAtLS0KICAgICAgICBjb25zdCBnb2FsVXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hNTE2YmQ5MGZhN2M0ZGVkYjVkY2JmZGY4MDNmMTNkNS5nbGInOwogICAgICAgIAogICAgICAgIGNvbnN0IG9uR29hbExvYWRlZCA9IChtb2RlbCwgaXNGYWxsYmFjaykgPT4gewogICAgICAgICAgICBjb25zdCBnb2FsQSA9IG1vZGVsOwogICAgICAgICAgICAvLyBNb3ZlZCBkb3duIH4xNWZ0ICg0LjVtKSB0b3RhbCBhcyByZXF1ZXN0ZWQKLy8gTW92ZWQgZG93biB+MTVmdCAoNC41bSkgdG90YWwgYXMgcmVxdWVzdGVkLCBwdXNoZWQgYmFjayB0byBlZGdlCiAgICAgICAgICAgIGdvYWxBLnBvc2l0aW9uLnNldCgwLCAtNC41LCAtNDYpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFpc0ZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBnb2FsQS5zY2FsZS5zZXRTY2FsYXIoNTQuMCk7IC8vIEluY3JlYXNlZCA1MCUgKHdhcyAzNi4wKQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFNldHVwIEdvYWwgQQogICAgICAgICAgICBnb2FsQS50cmF2ZXJzZShjID0+IHsKICAgICAgICAgICAgICAgIGlmKGMuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgYy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7IC8vIENSSVRJQ0FMOiBQcmV2ZW50IGN1bGxpbmcKICAgICAgICAgICAgICAgICAgICBjLnJlbmRlck9yZGVyID0gMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgbWF0ZXJpYWwgaXMgdmlzaWJsZQogICAgICAgICAgICAgICAgICAgIGlmIChjLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZmZmZmKTsgLy8gV2hpdGUgdG8gc2hvdyBvcmlnaW5hbCB0ZXh0dXJlL2NvbG9ycyAod2FzIGJsdWUpCiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwudHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLnNpZGUgPSBUSFJFRS5Eb3VibGVTaWRlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmRlcHRoV3JpdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmRlcHRoVGVzdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgX3NjZW5lLmFkZChnb2FsQSk7CgogICAgICAgICAgICAvLyBTZXR1cCBHb2FsIEIKICAgICAgICAgICAgY29uc3QgZ29hbEIgPSBpc0ZhbGxiYWNrID8gZ29hbEEuY2xvbmUoKSA6IFRIUkVFLlNrZWxldG9uVXRpbHMuY2xvbmUoZ29hbEEpOwoKZ29hbEIucG9zaXRpb24uc2V0KDAsIC00LjUsIDQ2KTsgLy8gTW92ZWQgY2xvc2VyICh3YXMgNDUpIGFuZCBkb3duCiAgICAgICAgICAgIGdvYWxCLnJvdGF0aW9uLnkgPSBNYXRoLlBJOwogICAgICAgICAgICAvLyBFbnN1cmUgR29hbCBCIG1lc2hlcyBhcmUgYWxzbyBwZXJzaXN0ZW50CiAgICAgICAgICAgIGdvYWxCLnRyYXZlcnNlKGMgPT4gewogICAgICAgICAgICAgICAgaWYoYy5pc01lc2gpIGMuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIF9zY2VuZS5hZGQoZ29hbEIpOwogICAgICAgIH07CgogICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbChnb2FsVXJsLCAoZ2x0ZikgPT4gewogICAgICAgICAgICBvbkdvYWxMb2FkZWQoZ2x0Zi5zY2VuZSwgZmFsc2UpOwogICAgICAgIH0sIHVuZGVmaW5lZCwgKGVycikgPT4gewogICAgICAgICAgICBjb25zb2xlLndhcm4oIkdvYWwgbW9kZWwgZmFpbGVkIHRvIGxvYWQuIFVzaW5nIGZhbGxiYWNrLiIsIGVycik7CiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSg3NSwgNDUsIDEwKTsgLy8gRmFsbGJhY2sgbWFzc2l2ZSBib3ggKFNjYWxlZCAxLjV4KQogICAgICAgICAgICBjb25zdCBmYWxsYmFja01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmZmZmZiwgd2lyZWZyYW1lOiB0cnVlIH0pOwogICAgICAgICAgICBjb25zdCBmYWxsYmFjayA9IG5ldyBUSFJFRS5NZXNoKGdlbywgZmFsbGJhY2tNYXQpOwogICAgICAgICAgICBvbkdvYWxMb2FkZWQoZmFsbGJhY2ssIHRydWUpOwogICAgICAgIH0pOwoKICAgICAgICAvLyAtLS0gTkVXOiBNQVNTSVZFIEZJRUxEIE1BUktJTkdTIC0tLQogICAgICAgIGNyZWF0ZUZpZWxkTWFya2luZ3MoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVGaWVsZE1hcmtpbmdzKCkgewogICAgICAgIGNvbnN0IHNpemUgPSAxMDI0OwogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gc2l6ZTsgYy5oZWlnaHQgPSBzaXplOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBjeCA9IHNpemUvMjsgY29uc3QgY3kgPSBzaXplLzI7CgogICAgICAgIC8vIEhlbHBlciB0byBkcmF3CiAgICAgICAgY29uc3QgZHJhdyA9ICgpID0+IHsKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBzaXplLCBzaXplKTsKCiAgICAgICAgICAgIC8vIEdsb3cgU2V0dGluZ3MKICAgICAgICAgICAgY3R4LnNoYWRvd0JsdXIgPSAyMDsKICAgICAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gJyMwMGZmZmYnOwogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgxMDAsIDI1NSwgMjU1LCAwLjkpJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDU7CiAgICAgICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKCiAgICAgICAgICAgIC8vIDEuIE1haW4gRmllbGQgQ2lyY2xlIChUaGUgU3BoZXJlIEVxdWF0b3IpCiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDQ1MCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgLy8gMi4gSW5uZXIgRGVjb3JhdGl2ZSBSaW5nCiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDQyMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDAsIDIwMCwgMjU1LCAwLjUpJzsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgLy8gMy4gQ2VudGVyIEJsaXR6b2ZmIFpvbmUgKENvbXBsZXggU3Rhci9SdW5lKQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45KSc7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDgwLCAwLCBNYXRoLlBJKjIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbm5lciBTdGFyIFBhdHRlcm4KICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw1OyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGEgPSAoaS81KSpNYXRoLlBJKjIgLSBNYXRoLlBJLzI7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gY3ggKyBNYXRoLmNvcyhhKSo2MDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjeSArIE1hdGguc2luKGEpKjYwOwogICAgICAgICAgICAgICAgaWYoaT09PTApIGN0eC5tb3ZlVG8oeCx5KTsgZWxzZSBjdHgubGluZVRvKHgseSk7CiAgICAgICAgICAgICAgICAvLyBJbm5lciBwb2ludAogICAgICAgICAgICAgICAgY29uc3QgYTIgPSAoKGkrMC41KS81KSpNYXRoLlBJKjIgLSBNYXRoLlBJLzI7CiAgICAgICAgICAgICAgICBjb25zdCB4MiA9IGN4ICsgTWF0aC5jb3MoYTIpKjI1OwogICAgICAgICAgICAgICAgY29uc3QgeTIgPSBjeSArIE1hdGguc2luKGEyKSoyNTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeDIseTIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgLy8gNC4gTWlkZmllbGQgTGluZQogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oMCwgY3kpOyBjdHgubGluZVRvKHNpemUsIGN5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgLy8gNS4gR29hbCBCb3hlcyAoVHJhcGV6b2lkcykKICAgICAgICAgICAgY29uc3QgZHJhd0dvYWxCb3ggPSAoeVBvcywgZGlyKSA9PiB7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKGN4IC0gMTUwLCB5UG9zKTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oY3ggKyAxNTAsIHlQb3MpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIDIyNSwgeVBvcyArIChkaXIgKiAxMjApKTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oY3ggLSAyMjUsIHlQb3MgKyAoZGlyICogMTIwKSk7CiAgICAgICAgICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGRyYXdHb2FsQm94KDUwLCAxKTsgLy8gVG9wIChIb21lIHNpZGUgaW4gdGV4dHVyZSBzcGFjZSkKICAgICAgICAgICAgZHJhd0dvYWxCb3goc2l6ZS01MCwgLTEpOyAvLyBCb3R0b20KCiAgICAgICAgICAgIC8vIDYuIFJ1bmVzIChQcm9jZWR1cmFsIFRleHQgUmluZykKICAgICAgICAgICAgLy8gVXNlIFNwaXJhIGZvbnQgaWYgbG9hZGVkLCBmYWxsYmFjayB0byBtb25vc3BhY2UKICAgICAgICAgICAgY3R4LmZvbnQgPSAnMzJweCBTcGlyYSwgbW9ub3NwYWNlJzsgCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgwLCAyNTUsIDI1NSwgMC43KSc7CiAgICAgICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICAgICAgY3R4LnRleHRCYXNlbGluZSA9ICdtaWRkbGUnOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcnVuZXMgPSAiQkxJVFpCQUxMIFNQSEVSRSBQT09MIFpBTkFSS0FORCBBQllTUyBFVEVSTkFMIENBTE0gIjsKICAgICAgICAgICAgY29uc3QgcnVuZUNvdW50ID0gMzI7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHJ1bmVDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gcnVuZUNvdW50KSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgY29uc3QgciA9IDQ4MDsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBjeCArIE1hdGguY29zKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gY3kgKyBNYXRoLnNpbihhbmdsZSkgKiByOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICAgICAgY3R4LnRyYW5zbGF0ZSh4LCB5KTsKICAgICAgICAgICAgICAgIGN0eC5yb3RhdGUoYW5nbGUgKyBNYXRoLlBJLzIpOwogICAgICAgICAgICAgICAgY29uc3QgY2hhciA9IHJ1bmVzW2kgJSBydW5lcy5sZW5ndGhdOwogICAgICAgICAgICAgICAgY3R4LmZpbGxUZXh0KGNoYXIsIDAsIDApOwogICAgICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdGV4ID0gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICAgICAgICAgIHRleC5hbmlzb3Ryb3B5ID0gMTY7CgogICAgICAgICAgICAvLyBGbG9vciBQbGFuZSAoRGVlcCkKLy8gRmxvb3IgUGxhbmUgKERlZXApCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDkwLCA5MCk7CiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBtYXA6IHRleCwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC44LAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjb25zdCBmaWVsZCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgbWF0KTsKICAgICAgICAgICAgZmllbGQucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICAgICAgZmllbGQucG9zaXRpb24ueSA9IC04LjA7IC8vIFN1bmsgZGVlcCBpbnRvIHRoZSBzcGhlcmUKICAgICAgICAgICAgX3NjZW5lLmFkZChmaWVsZCk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gQXR0ZW1wdCB0byBsb2FkIGZvbnQgZmlyc3QKICAgICAgICBkb2N1bWVudC5mb250cy5sb2FkKCczMnB4IFNwaXJhJykudGhlbigoKSA9PiB7CiAgICAgICAgICAgIGRyYXcoKTsKICAgICAgICB9KS5jYXRjaCgoKSA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiU3BpcmEgZm9udCBmYWlsZWQgdG8gbG9hZCBmb3IgY2FudmFzLCB1c2luZyBmYWxsYmFjay4iKTsKICAgICAgICAgICAgZHJhdygpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBGbG9hdGluZyBIb2xvZ3JhcGhpYyBSaW5ncyAoTWlkLWhlaWdodCkKICAgICAgICBjb25zdCByaW5nR2VvID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkoMjAsIDAuMSwgMTYsIDEwMCk7CiAgICAgICAgY29uc3QgcmluZ01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiwgdHJhbnNwYXJlbnQ6IHRydWUsIG9wYWNpdHk6IDAuMywgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcgfSk7CiAgICAgICAgY29uc3QgcmluZzEgPSBuZXcgVEhSRUUuTWVzaChyaW5nR2VvLCByaW5nTWF0KTsKICAgICAgICByaW5nMS5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDI7CiAgICAgICAgcmluZzEucG9zaXRpb24ueSA9IDA7CiAgICAgICAgX3NjZW5lLmFkZChyaW5nMSk7CiAgICAgICAgCiAgICAgICAgY29uc3QgcmluZzIgPSBuZXcgVEhSRUUuTWVzaChyaW5nR2VvLCByaW5nTWF0KTsKICAgICAgICByaW5nMi5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDI7CiAgICAgICAgcmluZzIuc2NhbGUuc2V0U2NhbGFyKDEuMik7CiAgICAgICAgcmluZzIucG9zaXRpb24ueSA9IDQuMDsKICAgICAgICBfc2NlbmUuYWRkKHJpbmcyKTsKCiAgICAgICAgLy8gQW5pbWF0ZSBSaW5ncyAoaW50ZWdyYXRlZCBpbnRvIG1haW4gbG9vcCB0byBhdm9pZCBhIHNlY29uZCBSQUYgb24gbW9iaWxlKQogICAgICAgIGxldCBfcmluZ1RpbWUgPSAwOwogICAgICAgIGNvbnN0IF9yaW5nVXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIF9yaW5nVGltZSArPSBkdDsKICAgICAgICAgICAgaWYgKHJpbmcxKSB7CiAgICAgICAgICAgICAgICByaW5nMS5yb3RhdGlvbi56ICs9IGR0ICogMC45OwogICAgICAgICAgICAgICAgcmluZzEuc2NhbGUuc2V0U2NhbGFyKDEuMCArIE1hdGguc2luKF9yaW5nVGltZSAqIDAuNSkgKiAwLjA1KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmluZzIpIHsKICAgICAgICAgICAgICAgIHJpbmcyLnJvdGF0aW9uLnogLT0gZHQgKiAwLjc1OwogICAgICAgICAgICAgICAgcmluZzIucG9zaXRpb24ueSA9IDQuMCArIE1hdGguY29zKF9yaW5nVGltZSAqIDAuNykgKiAxLjA7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGlmICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzKSB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLnB1c2goX3JpbmdVcGRhdGUpOwp9CgogICAgLy8gLS0tIElOUFVUIFNZU1RFTSAtLS0KLy8gLS0tIElOUFVUIFNZU1RFTSAtLS0KY29uc3QgX2tleXMgPSB7fTsKLy8gR2xvYmFscyBtb3ZlZCB0byBiZWxvdyBoZWxwZXIKCiAgICAvLyBIZWxwZXI6IEFuYWx5emUgY3VydmUgZ2VvbWV0cnkgZm9yIGFuYWxvZyBjb250cm9sCiAgICBjb25zdCBhbmFseXplU3dpcGVDdXJ2ZSA9IChwb2ludHMpID0+IHsKICAgICAgICBpZiAocG9pbnRzLmxlbmd0aCA8IDMpIHJldHVybiB7IGludGVuc2l0eTogMCwgc3BlZWQ6IDAsIGR4OiAwLCBkeTogMCB9OwogICAgICAgIAogICAgICAgIGNvbnN0IHBTdGFydCA9IHBvaW50c1swXTsKICAgICAgICBjb25zdCBwRW5kID0gcG9pbnRzW3BvaW50cy5sZW5ndGggLSAxXTsKICAgICAgICBjb25zdCBtaWRJZHggPSBNYXRoLmZsb29yKHBvaW50cy5sZW5ndGggLyAyKTsKICAgICAgICBjb25zdCBwTWlkID0gcG9pbnRzW21pZElkeF07CgogICAgICAgIGNvbnN0IGR4ID0gcEVuZC54IC0gcFN0YXJ0Lng7CiAgICAgICAgY29uc3QgZHkgPSBwRW5kLnkgLSBwU3RhcnQueTsKICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwogICAgICAgIGNvbnN0IGR0ID0gcEVuZC50IC0gcFN0YXJ0LnQ7CiAgICAgICAgY29uc3Qgc3BlZWQgPSAoZHQgPiAwKSA/IGRpc3QgLyBkdCA6IDA7IC8vIHB4L21zCgogICAgICAgIGlmIChkaXN0IDwgNTApIHJldHVybiB7IGludGVuc2l0eTogMCwgc3BlZWQ6IHNwZWVkLCBkeCwgZHkgfTsKCiAgICAgICAgY29uc3QgdlNNX3ggPSBwTWlkLnggLSBwU3RhcnQueDsKICAgICAgICBjb25zdCB2U01feSA9IHBNaWQueSAtIHBTdGFydC55OwoKICAgICAgICAvLyBDcm9zcyBwcm9kdWN0IGdpdmVzIHNpZ25lZCBhcmVhL2N1cnZhdHVyZSBkaXJlY3Rpb24KICAgICAgICBjb25zdCBjcm9zcyA9IChkeCAqIHZTTV95KSAtIChkeSAqIHZTTV94KTsKICAgICAgICAvLyBOb3JtYWxpemUgYnkgZGlzdGFuY2Ugc3F1YXJlZCB0byBnZXQgYSBjdXJ2YXR1cmUgcmF0aW8gaW5kZXBlbmRlbnQgb2Ygc2NhbGUKY29uc3QgaW50ZW5zaXR5ID0gY3Jvc3MgLyAoZGlzdCAqIGRpc3QpOwoKICAgICAgICByZXR1cm4geyBpbnRlbnNpdHksIHNwZWVkLCBkeCwgZHkgfTsKICAgIH07CiAgICBsZXQgX3N3aXBlUG9pbnRzID0gW107IC8vIFRyYWNrIHN3aXBlIGhpc3RvcnkgZm9yIGN1cnZlcwogICAgY29uc3QgX2FpbUlucHV0ID0geyB4OiAwLCB5OiAwLCBhY3RpdmU6IGZhbHNlIH07IC8vIE5FVzogQWltIGpveXN0aWNrCgogICAgY29uc3QgX2FjdGlvbkJ1ZmZlciA9IHsgYWN0aXZlOiBmYWxzZSwgdGltZXN0YW1wOiAwLCBkdXJhdGlvbjogMzAwIH07CgogICAgY29uc3QgX2NhbUZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfY2FtUmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3VwQXhpcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApOwoKICAgIGZ1bmN0aW9uIHNldHVwSW5wdXRzKCkgewogICAgICAgIC8vIEtleWJvYXJkCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICBfa2V5c1tlLmtleV0gPSB0cnVlOwogICAgICAgICAgICBpZiAoZS5jb2RlID09PSAnU3BhY2UnICYmIF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyICYmIF9iYWxsKSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLnRocm93QmFsbChfYmFsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gTkVXOiBUYWNrbGUgb24gU2hpZnQKICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ1NoaWZ0TGVmdCcgfHwgZS5jb2RlID09PSAnU2hpZnRSaWdodCcpIHsKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuZGFzaChwLmlucHV0VmVjdG9yLngsIHAuaW5wdXRWZWN0b3Iueik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CiAgICAgICAgfSk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgKGUpID0+IHsgX2tleXNbZS5rZXldID0gZmFsc2U7IHVwZGF0ZUlucHV0VmVjdG9yKCk7IH0pOwoKICAgICAgICAvLyAtLS0gRkxPQVRJTkcgSk9ZU1RJQ0sgKE1vdmVtZW50KSAtLS0KICAgICAgICBjb25zdCBoaXRab25lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2pveXN0aWNrLWhpdC16b25lJyk7CiAgICAgICAgY29uc3QgdmlzdWFscyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay12aXN1YWwtY29udGFpbmVyJyk7CiAgICAgICAgY29uc3QgYmFzZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1iYXNlJyk7CiAgICAgICAgY29uc3Qga25vYiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1rbm9iJyk7CgogICAgICAgIGxldCBzdGFydFggPSAwLCBzdGFydFkgPSAwOwogICAgICAgIGxldCBkcmFnZ2luZyA9IGZhbHNlOwogICAgICAgIGNvbnN0IG1heERpc3QgPSA0MDsKCiAgICAgICAgbGV0IG1vdmVUb3VjaElkID0gbnVsbDsKICAgICAgICBjb25zdCBtb3ZlRGVhZHpvbmVQeCA9IDY7CgogICAgICAgIC8vIEV4cG9zZSBtb3ZlIGpveXN0aWNrIHN0YXRlIGZvciBzbmFwc2hvdHMKICAgICAgICBjb25zdCBfZGJnID0gd2luZG93LmZsdXguX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyB8fCB7fTsKICAgICAgICBfZGJnLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgICAgIF9kYmcuaW5wdXQgPSBfZGJnLmlucHV0IHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQubW92ZSA9IF9kYmcuaW5wdXQubW92ZSB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUudmVjdG9yID0gX2lucHV0OwogICAgICAgIF9kYmcuaW5wdXQubW92ZS5kcmFnZ2luZyA9IGRyYWdnaW5nOwogICAgICAgIF9kYmcuaW5wdXQubW92ZS50b3VjaElkID0gbW92ZVRvdWNoSWQ7CgoKICAgICAgICBjb25zdCBoYW5kbGVTdGFydCA9IChjbGllbnRYLCBjbGllbnRZKSA9PiB7CiAgICAgICAgICAgIGRyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgc3RhcnRYID0gY2xpZW50WDsKCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5tb3ZlKSB7CiAgICAgICAgICAgICAgICBfZGJnLmlucHV0Lm1vdmUuZHJhZ2dpbmcgPSBkcmFnZ2luZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3RhcnRZID0gY2xpZW50WTsKCiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUubGVmdCA9IGAke2NsaWVudFh9cHhgOwogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLnRvcCA9IGAke2NsaWVudFl9cHhgOwoKICAgICAgICAgICAga25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKC01MCUsIC01MCUpYDsKCiAgICAgICAgICAgIGNyZWF0ZVJpcHBsZShjbGllbnRYLCBjbGllbnRZKTsKCiAgICAgICAgICAgIF9pbnB1dC54ID0gMDsKICAgICAgICAgICAgX2lucHV0LnkgPSAwOwogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGhhbmRsZU1vdmUgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CgogICAgICAgICAgICBsZXQgZHggPSBjbGllbnRYIC0gc3RhcnRYOwogICAgICAgICAgICBsZXQgZHkgPSBjbGllbnRZIC0gc3RhcnRZOwoKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCgogICAgICAgICAgICAvLyBEZWFkem9uZSB0byBwcmV2ZW50IGRyaWZ0IGZyb20gdGlueSB0aHVtYiBqaXR0ZXIKICAgICAgICAgICAgaWYgKGRpc3QgPCBtb3ZlRGVhZHpvbmVQeCkgewogICAgICAgICAgICAgICAgZHggPSAwOwogICAgICAgICAgICAgICAgZHkgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgIGR4ID0gKGR4IC8gZGlzdCkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgZHkgPSAoZHkgLyBkaXN0KSAqIG1heERpc3Q7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZShjYWxjKC01MCUgKyAke2R4fXB4KSwgY2FsYygtNTAlICsgJHtkeX1weCkpYDsKCiAgICAgICAgICAgIF9pbnB1dC54ID0gKGR4IC8gbWF4RGlzdCkgKiBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eTsKICAgICAgICAgICAgX2lucHV0LnkgPSAoZHkgLyBtYXhEaXN0KSAqIF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5OwogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGhhbmRsZUVuZCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBkcmFnZ2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgbW92ZVRvdWNoSWQgPSBudWxsOwoKICAgICAgICAgICAgdmlzdWFscy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0Lm1vdmUpIHsKICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS5kcmFnZ2luZyA9IGRyYWdnaW5nOwogICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnRvdWNoSWQgPSBtb3ZlVG91Y2hJZDsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIF9pbnB1dC54ID0gMDsKICAgICAgICAgICAgX2lucHV0LnkgPSAwOwogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH07CgogICAgICAgIGlmIChoaXRab25lKSB7CiAgICAgICAgICAgIGhpdFpvbmUuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlc1swXSkgPyBlLmNoYW5nZWRUb3VjaGVzWzBdIDogZS50b3VjaGVzWzBdOwogICAgICAgICAgICAgICAgbW92ZVRvdWNoSWQgPSB0ID8gdC5pZGVudGlmaWVyIDogbnVsbDsKICAgICAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5tb3ZlKSB7CiAgICAgICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnRvdWNoSWQgPSBtb3ZlVG91Y2hJZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhhbmRsZVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IF9maW5kVG91Y2hCeUlkKGUudG91Y2hlcywgbW92ZVRvdWNoSWQpOwogICAgICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgICAgICBoYW5kbGVNb3ZlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIG1vdmVUb3VjaElkKTsKICAgICAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOyAvLyBJZ25vcmUgb3RoZXIgZmluZ2VycyBsaWZ0aW5nCiAgICAgICAgICAgICAgICBoYW5kbGVFbmQoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIG1vdmVUb3VjaElkKTsKICAgICAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgaGFuZGxlRW5kKCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaGl0Wm9uZS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaGFuZGxlU3RhcnQoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZHJhZ2dpbmcpIGhhbmRsZU1vdmUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVFbmQpOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIE5FVzogQUlNIEpPWVNUSUNLIChSaWdodCBzaWRlKSAtLS0KICAgICAgICBzZXR1cEFpbUpveXN0aWNrKCk7CgogICAgICAgIC8vIC0tLSBORVc6IFRBQ0tMRSBCVVRUT04gLS0tCiAgICAgICAgc2V0dXBUYWNrbGVCdXR0b24oKTsKCiAgICAgICAgLy8gU3dpcGUgRGV0ZWN0aW9uCi8vIFN3aXBlIERldGVjdGlvbgogICAgICAgIGxldCBzd2lwZVN0YXJ0ID0geyB4OiAwLCB5OiAwLCB0OiAwIH07CiAgICAgICAgbGV0IHN3aXBlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgCiAgICAgICAgLy8gRXhwb3NlIHN3aXBlL3Rocm93IGdlc3R1cmUgc3RhdGUgZm9yIHNuYXBzaG90cwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUgPSBfZGJnLmlucHV0LnN3aXBlIHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUuc3RhcnQgPSBzd2lwZVN0YXJ0OwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsKICAgICAgICBfZGJnLmlucHV0LnN3aXBlLnBvaW50cyA9IF9zd2lwZVBvaW50czsKY29uc3Qgb25Td2lwZVN0YXJ0ID0gKHgsIHkpID0+IHsKICAgICAgICAgICAgc3dpcGVTdGFydC54ID0geDsKICAgICAgICAgICAgc3dpcGVTdGFydC55ID0geTsKICAgICAgICAgICAgc3dpcGVTdGFydC50ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgX3N3aXBlUG9pbnRzID0gW3t4LCB5LCB0OiBEYXRlLm5vdygpfV07CiAgICAgICAgfTsKCmNvbnN0IG9uU3dpcGVNb3ZlID0gKHgsIHkpID0+IHsKICAgICAgICAgICAgaWYgKF9zd2lwZVBvaW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBfc3dpcGVQb2ludHMucHVzaCh7eCwgeSwgdDogRGF0ZS5ub3coKX0pOwogICAgICAgICAgICAgICAgY3JlYXRlU3dpcGVUcmFpbERvdCh4LCB5KTsgLy8gVmlzdWFsIEZlZWRiYWNrCiAgICAgICAgICAgIH0KICAgICAgICB9OwoKY29uc3Qgb25Td2lwZUVuZCA9ICh4LCB5KSA9PiB7CiAgICAgICAgICAgIGlmIChfc3dpcGVQb2ludHMubGVuZ3RoIDwgMikgcmV0dXJuOwogICAgICAgICAgICBfc3dpcGVQb2ludHMucHVzaCh7eCwgeSwgdDogRGF0ZS5ub3coKX0pOwoKICAgICAgICAgICAgY29uc3QgeyBpbnRlbnNpdHksIHNwZWVkLCBkeCwgZHkgfSA9IGFuYWx5emVTd2lwZUN1cnZlKF9zd2lwZVBvaW50cyk7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIgJiYgX2NhbWVyYSkgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgICAgICAgICAgLy8gLS0tIENVUlZFIEJBTEwgREVURUNUSU9OIChJbW1lZGlhdGUgVGhyb3cpIC0tLQovLyAtLS0gQ1VSVkUgQkFMTCBERVRFQ1RJT04gKEltbWVkaWF0ZSBUaHJvdykgLS0tCiAgICAgICAgICAgICAgICBpZiAocC5oYXNCYWxsICYmICFwLmlzVGhyb3dpbmcgJiYgIXAuaXNDaGFyZ2luZykgewogICAgICAgICAgICAgICAgICAgIC8vIEFuYWxvZyBDdXJ2ZSBDaGVjazogVGhyZXNob2xkIDAuMjUgcmVxdWlyZXMgYSBkZWxpYmVyYXRlIGFyYyAoVGhlICJGZWF0IikKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoaW50ZW5zaXR5KSA+IDAuMjUgJiYgZGlzdCA+IDEwMCkgewogICAgICAgICAgICAgICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICAgICAgICAgICAgICBfY2FtRndkLnkgPSAwOyBfY2FtRndkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRYID0gKF9jYW1SaWdodC54ICogZHgpICsgKF9jYW1Gd2QueCAqIC1keSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWiA9IChfY2FtUmlnaHQueiAqIGR4KSArIChfY2FtRndkLnogKiAtZHkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0aHJvd0RpciA9IG5ldyBUSFJFRS5WZWN0b3IzKHdvcmxkWCwgMCwgd29ybGRaKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1hcCBpbnRlbnNpdHkgdG8gc3BpbiAtIERyYXN0aWNhbGx5IHJlZHVjZWQgc2Vuc2l0aXZpdHkKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF3U3BpbiA9IE1hdGguYWJzKGludGVuc2l0eSkgKiAzMDAuMDsgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkRmFjdG9yID0gTWF0aC5taW4oMS41LCBzcGVlZCAvIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5Qb3dlciA9IE1hdGgubWluKDQwMC4wLCByYXdTcGluICogc3BlZWRGYWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluU2lnbiA9IE1hdGguc2lnbihpbnRlbnNpdHkpOyAKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIHNwaW5Qb3dlciAqIHNwaW5TaWduLCAwKTsKCgogICAgICAgICAgICAgICAgICAgICAgICBwLnNldE92ZXJyaWRlQWltKHRocm93RGlyLngsIHRocm93RGlyLnopOwogICAgICAgICAgICAgICAgICAgICAgICBwLnRocm93QmFsbCh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCwgJ1NIJywgMS4wLCBzcGluVmVjKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRSIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVSaXBwbGUoeCwgeSk7CiAgICAgICAgICAgICAgICAgICAgICAgIF9zd2lwZVBvaW50cyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47IAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gU1RBTkRBUkQgREFTSCAvIEFJTSAtLS0KICAgICAgICAgICAgICAgIF9jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgICAgICBfY2FtRndkLnkgPSAwOwogICAgICAgICAgICAgICAgaWYgKF9jYW1Gd2QubGVuZ3RoU3EoKSA8IDAuMDAxKSBfY2FtRndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgICAgICBlbHNlIF9jYW1Gd2Qubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhfY2FtRndkLCBfdXBBeGlzKS5ub3JtYWxpemUoKTsKCmNvbnN0IHdvcmxkWDIgPSAoX2NhbVJpZ2h0LnggKiBkeCkgKyAoX2NhbUZ3ZC54ICogLWR5KTsKICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWjIgPSAoX2NhbVJpZ2h0LnogKiBkeCkgKyAoX2NhbUZ3ZC56ICogLWR5KTsKCiAgICAgICAgICAgICAgICBpZiAocC5pc1Rocm93aW5nKSB7CnAuc2V0T3ZlcnJpZGVBaW0od29ybGRYMiwgd29ybGRaMik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQUlNISIsIHAubWVzaC5wb3NpdGlvbiwgImRlZmF1bHQiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewppZiAoZGlzdCA+IDUwKSBwLmRhc2god29ybGRYMiwgd29ybGRaMik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY3JlYXRlUmlwcGxlKHgsIHkpOwogICAgICAgICAgICB9Cl9zd2lwZVBvaW50cyA9IFtdOwogICAgICAgIH07CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgdCA9IChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXNbMF0pID8gZS5jaGFuZ2VkVG91Y2hlc1swXSA6IGUudG91Y2hlc1swXTsKICAgICAgICAgICAgc3dpcGVUb3VjaElkID0gdCA/IHQuaWRlbnRpZmllciA6IG51bGw7Ci8vIG9uU3dpcGVTdGFydCh0LmNsaWVudFgsIHQuY2xpZW50WSk7IC8vIEZpeGVkIHN5bnRheCBlcnJvcgogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuc3dpcGUpIHsgX2RiZy5pbnB1dC5zd2lwZS50b3VjaElkID0gc3dpcGVUb3VjaElkOyB9CiAgICAgICAgICAgIG9uU3dpcGVTdGFydCh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgICAgIGNyZWF0ZVJpcHBsZSh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIHN3aXBlVG91Y2hJZCk7CiAgICAgICAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICAgICAgICBvblN3aXBlTW92ZSh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIHN3aXBlVG91Y2hJZCk7CiAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOyAvLyBJZ25vcmUgb3RoZXIgZmluZ2VycyBsaWZ0aW5nCiAgICAgICAgICAgIG9uU3dpcGVFbmQodEVuZC5jbGllbnRYLCB0RW5kLmNsaWVudFkpOwogICAgICAgICAgICBzd2lwZVRvdWNoSWQgPSBudWxsOwogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuc3dpcGUpIHsgX2RiZy5pbnB1dC5zd2lwZS50b3VjaElkID0gc3dpcGVUb3VjaElkOyB9CiAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgKGUpID0+IHsKaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIHN3aXBlVG91Y2hJZCk7CiAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOyAvLyBJZ25vcmUgb3RoZXIgZmluZ2VycyBsaWZ0aW5nCiAgICAgICAgICAgIG9uU3dpcGVFbmQodEVuZC5jbGllbnRYLCB0RW5kLmNsaWVudFkpOwogICAgICAgICAgICBzd2lwZVRvdWNoSWQgPSBudWxsOwogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuc3dpcGUpIHsgX2RiZy5pbnB1dC5zd2lwZS50b3VjaElkID0gc3dpcGVUb3VjaElkOyB9CiAgICAgICAgCiAgICAgICAgfSk7Ci8vIE1vdXNlIFN3aXBlCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKCiAgICAgICAgICAgIG9uU3dpcGVTdGFydChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgIGNyZWF0ZVJpcHBsZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSkgcmV0dXJuOwogICAgICAgICAgICAvLyBPbmx5IHRyYWNrIGlmIG1vdXNlIGlzIGRvd24gKHNpbXVsYXRpbmcgZHJhZykKICAgICAgICAgICAgaWYgKGUuYnV0dG9ucyA9PT0gMSkgewogICAgICAgICAgICAgICAgb25Td2lwZU1vdmUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKICAgICAgICAgICAgb25Td2lwZUVuZChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIEFjdGlvbiBCdXR0b24gKFNob290L1Bhc3MpCiAgICAgICAgY29uc3QgYWN0aW9uQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKCmNvbnN0IHNldHVwQnV0dG9uID0gKGJ0bikgPT4gewogICAgICAgICAgICBpZiAoIWJ0bikgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGJ0blN0YXJ0WCA9IDA7CiAgICAgICAgICAgIGxldCBidG5TdGFydFkgPSAwOwogICAgICAgICAgICBsZXQgaXNEcmFnZ2luZyA9IGZhbHNlOwogICAgICAgICAgICBsZXQgc3dpcGVQb2ludHMgPSBbXTsKICAgICAgICAgICAgbGV0IGFjdGlvblRvdWNoSWQgPSBudWxsOwoKICAgICAgICAgICAgY29uc3QgYXR0ZW1wdEFjdGlvbiA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGlmICghX2hvbWVUZWFtIHx8ICFfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgICAgICBpZiAocC5oYXNCYWxsICYmICFwLmlzQ2hhcmdpbmcgJiYgIXAuaXNUaHJvd2luZyAmJiBwLnN0YXR1cy5uYXAgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBoYW5kbGVTdGFydCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIuYXR0ZW1wdFRlY2hDb3B5KCk7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpLCAxMDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pc0RlbW9Nb2RlKSByZXR1cm47CgogICAgICAgICAgICAgICAgbGV0IGNsaWVudFggPSBlLmNsaWVudFg7CiAgICAgICAgICAgICAgICBsZXQgY2xpZW50WSA9IGUuY2xpZW50WTsKICAgICAgICAgICAgICAgIGlmIChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IGUuY2hhbmdlZFRvdWNoZXNbMF07CiAgICAgICAgICAgICAgICAgICAgYWN0aW9uVG91Y2hJZCA9IHQuaWRlbnRpZmllcjsKICAgICAgICAgICAgICAgICAgICBjbGllbnRYID0gdC5jbGllbnRYOwogICAgICAgICAgICAgICAgICAgIGNsaWVudFkgPSB0LmNsaWVudFk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGFjdGlvblRvdWNoSWQgPSBudWxsOyAvLyBtb3VzZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnRuU3RhcnRYID0gY2xpZW50WDsKICAgICAgICAgICAgICAgIGJ0blN0YXJ0WSA9IGNsaWVudFk7CiAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHN3aXBlUG9pbnRzID0gW3t4OiBjbGllbnRYLCB5OiBjbGllbnRZLCB0OiBEYXRlLm5vdygpfV07CgogICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci50aW1lc3RhbXAgPSBEYXRlLm5vdygpOwoKICAgICAgICAgICAgICAgIGlmIChhdHRlbXB0QWN0aW9uKCkpIHsKICAgICAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEF0dGFjaCBnbG9iYWwgbGlzdGVuZXJzIHRvIHRyYWNrIHN3aXBlIG91dHNpZGUgYnV0dG9uCiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgaGFuZGxlTW92ZSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIGhhbmRsZU1vdmUpOwogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgaGFuZGxlTW92ZSA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWlzRHJhZ2dpbmcpIHJldHVybjsKCiAgICAgICAgICAgICAgICAvLyBUb3VjaCBwYXRoIChtdWx0aS10b3VjaCBzYWZlKQogICAgICAgICAgICAgICAgaWYgKGUudG91Y2hlcyAmJiBhY3Rpb25Ub3VjaElkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IF9maW5kVG91Y2hCeUlkKGUudG91Y2hlcywgYWN0aW9uVG91Y2hJZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgc3dpcGVQb2ludHMucHVzaCh7eDogdC5jbGllbnRYLCB5OiB0LmNsaWVudFksIHQ6IERhdGUubm93KCl9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTW91c2UgcGF0aAogICAgICAgICAgICAgICAgY29uc3QgY2xpZW50WCA9IGUuY2xpZW50WDsKICAgICAgICAgICAgICAgIGNvbnN0IGNsaWVudFkgPSBlLmNsaWVudFk7CiAgICAgICAgICAgICAgICBzd2lwZVBvaW50cy5wdXNoKHt4OiBjbGllbnRYLCB5OiBjbGllbnRZLCB0OiBEYXRlLm5vdygpfSk7CiAgICAgICAgICAgIH07Cgpjb25zdCBoYW5kbGVFbmQgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgbGV0IGR4ID0gMDsKICAgICAgICAgICAgICAgIGxldCBkeSA9IDA7CiAgICAgICAgICAgICAgICBsZXQgdmFsaWRFbmQgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAvLyAxLiBDaGVjayBUb3VjaAogICAgICAgICAgICAgICAgaWYgKGUuY2hhbmdlZFRvdWNoZXMgJiYgYWN0aW9uVG91Y2hJZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgYWN0aW9uVG91Y2hJZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRFbmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZHggPSB0RW5kLmNsaWVudFggLSBidG5TdGFydFg7CiAgICAgICAgICAgICAgICAgICAgICAgIGR5ID0gdEVuZC5jbGllbnRZIC0gYnRuU3RhcnRZOwogICAgICAgICAgICAgICAgICAgICAgICB2YWxpZEVuZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvblRvdWNoSWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICAvLyAyLiBDaGVjayBNb3VzZQogICAgICAgICAgICAgICAgZWxzZSBpZiAoIWUuY2hhbmdlZFRvdWNoZXMgJiYgaXNEcmFnZ2luZykgewogICAgICAgICAgICAgICAgICAgIGR4ID0gZS5jbGllbnRYIC0gYnRuU3RhcnRYOwogICAgICAgICAgICAgICAgICAgIGR5ID0gZS5jbGllbnRZIC0gYnRuU3RhcnRZOwogICAgICAgICAgICAgICAgICAgIHZhbGlkRW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIXZhbGlkRW5kKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gQ2xlYW51cCBsaXN0ZW5lcnMKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBoYW5kbGVNb3ZlKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIGhhbmRsZU1vdmUpOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVFbmQpOwoKICAgICAgICAgICAgICAgIGlmICghaXNEcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgaXNEcmFnZ2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB3YXNCdWZmZXJlZCA9IF9hY3Rpb25CdWZmZXIuYWN0aXZlOwogICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDdXJ2ZSBBbmFseXNpcwogICAgICAgICAgICAgICAgICAgIGxldCBjdXJ2ZURhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIGxldCBzcGluVmVjID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGN1cnZlIGlmIHdlIGhhdmUgZW5vdWdoIGRhdGEKLy8gQ2FsY3VsYXRlIGN1cnZlIGlmIHdlIGhhdmUgZW5vdWdoIGRhdGEKICAgICAgICAgICAgICAgICAgICBpZiAoc3dpcGVQb2ludHMubGVuZ3RoID4gMikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmFseXNpcyA9IGFuYWx5emVTd2lwZUN1cnZlKHN3aXBlUG9pbnRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSGlnaCB0aHJlc2hvbGQgZm9yIGJ1dHRvbiByZWxlYXNlIHRvbwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoYW5hbHlzaXMuaW50ZW5zaXR5KSA+IDAuMjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnZlRGF0YSA9IGFuYWx5c2lzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgc3BpbiB2ZWN0b3IgZm9yIG1vdXNlL3RvdWNoIHVuaWZpZWQgKENvbnNlcnZhdGl2ZSB2YWx1ZXMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluUG93ZXIgPSBNYXRoLm1pbig0MDAuMCwgTWF0aC5hYnMoYW5hbHlzaXMuaW50ZW5zaXR5KSAqIDE1MDAuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluU2lnbiA9IE1hdGguc2lnbihhbmFseXNpcy5pbnRlbnNpdHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BpblZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIHNwaW5Qb3dlciAqIHNwaW5TaWduLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQp9CgogICAgICAgICAgICAgICAgICAgIC8vIEVYRUNVVEUKICAgICAgICAgICAgICAgICAgICBpZiAocC5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5vcm1hbCBSZWxlYXNlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcGluVmVjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBVbmlmaWVkIHNwaW4gcGFzc2luZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlQ2hhcmdlKGR4LCBkeSwgeyBpbnRlbnNpdHk6IGN1cnZlRGF0YS5pbnRlbnNpdHksIHNwZWVkOiBjdXJ2ZURhdGEuc3BlZWQgfSk7IAogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlQ2hhcmdlKGR4LCBkeSwgY3VydmVEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh3YXNCdWZmZXJlZCAmJiBwLmhhc0JhbGwgJiYgIXAuaXNUaHJvd2luZyAmJiBwLnN0YXR1cy5uYXAgPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBCdWZmZXJlZCBUYXAgKEluc3RhbnQgU2hvdCkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9yY2Ugc3RhcnQgYW5kIHJlbGVhc2UgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGFydENoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBwLnJlbGVhc2VDaGFyZ2UoZHgsIGR5LCBjdXJ2ZURhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBoYW5kbGVTdGFydCwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIGhhbmRsZVN0YXJ0KTsKICAgICAgICB9OwogICAgICAgIHNldHVwQnV0dG9uKGFjdGlvbkJ0bik7CgovLyBBdXRvIFRvZ2dsZQogICAgICAgIGNvbnN0IGF1dG9CdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXV0by10b2dnbGUnKTsKICAgICAgICBpZiAoYXV0b0J0bikgewogICAgICAgICAgICBjb25zdCBoYW5kbGVUb2dnbGUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnRvZ2dsZURlbW9Nb2RlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgYXV0b0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGhhbmRsZVRvZ2dsZSk7CmF1dG9CdG4uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBoYW5kbGVUb2dnbGUoKTsKICAgICAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogU2V0dGluZ3MgQnV0dG9uCiAgICAgICAgc2V0dXBTZXR0aW5nc0J1dHRvbigpOwogICAgfQoKICAgIC8vIE5FVzogQWltIEpveXN0aWNrIFNldHVwCi8vIE5FVzogQWltIEpveXN0aWNrIFNldHVwCmZ1bmN0aW9uIHNldHVwQWltSm95c3RpY2soKSB7CiAgICAgICAgY29uc3QgYWltS25vYiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaW0tam95c3RpY2sta25vYicpOwogICAgICAgIGNvbnN0IGFpbVZpc3VhbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWltLWpveXN0aWNrLXZpc3VhbCcpOwogICAgICAgIGNvbnN0IGFpbVpvbmUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWltLWpveXN0aWNrLXpvbmUnKTsKICAgICAgICBpZiAoIWFpbVpvbmUpIHJldHVybjsKICAgICAgICBsZXQgYWltU3RhcnRYID0gMCwgYWltU3RhcnRZID0gMDsKICAgICAgICBsZXQgYWltRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICBjb25zdCBhaW1NYXhEaXN0ID0gMzU7CiAgICAgICAgbGV0IGFpbVRvdWNoSWQgPSBudWxsOwoKICAgICAgICAKCiAgICAgICAgLy8gRXhwb3NlIGFpbSBqb3lzdGljayBzdGF0ZSBmb3Igc25hcHNob3RzCiAgICAgICAgY29uc3QgX2RiZyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPID0gd2luZG93LmZsdXguX2RlYnVnSU8gfHwge307CiAgICAgICAgX2RiZy5zZXR0aW5ncyA9IF9zZXR0aW5nczsKICAgICAgICBfZGJnLmlucHV0ID0gX2RiZy5pbnB1dCB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0LmFpbSA9IF9kYmcuaW5wdXQuYWltIHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQuYWltLnZlY3RvciA9IF9haW1JbnB1dDsKICAgICAgICBfZGJnLmlucHV0LmFpbS5kcmFnZ2luZyA9IGFpbURyYWdnaW5nOwogICAgICAgIF9kYmcuaW5wdXQuYWltLnRvdWNoSWQgPSBhaW1Ub3VjaElkOwpjb25zdCBoYW5kbGVBaW1TdGFydCA9IChjbGllbnRYLCBjbGllbnRZKSA9PiB7CiAgICAgICAgICAgIGFpbURyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgYWltU3RhcnRYID0gY2xpZW50WDsKCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5haW0pIHsgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsgfQoKICAgICAgICAgICAgYWltU3RhcnRZID0gY2xpZW50WTsKICAgICAgICAgICAgX2FpbUlucHV0LmFjdGl2ZSA9IHRydWU7CgogICAgICAgICAgICBpZiAoYWltVmlzdWFscykgewogICAgICAgICAgICAgICAgYWltVmlzdWFscy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIGFpbVZpc3VhbHMuc3R5bGUubGVmdCA9IGAke2NsaWVudFh9cHhgOwogICAgICAgICAgICAgICAgYWltVmlzdWFscy5zdHlsZS50b3AgPSBgJHtjbGllbnRZfXB4YDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYWltS25vYikgewogICAgICAgICAgICAgICAgYWltS25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKC01MCUsIC01MCUpYDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGNvbnN0IGhhbmRsZUFpbU1vdmUgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CgogICAgICAgICAgICBsZXQgZHggPSBjbGllbnRYIC0gYWltU3RhcnRYOwogICAgICAgICAgICBsZXQgZHkgPSBjbGllbnRZIC0gYWltU3RhcnRZOwoKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCiAgICAgICAgICAgIGlmIChkaXN0ID4gYWltTWF4RGlzdCkgewogICAgICAgICAgICAgICAgZHggPSAoZHggLyBkaXN0KSAqIGFpbU1heERpc3Q7CiAgICAgICAgICAgICAgICBkeSA9IChkeSAvIGRpc3QpICogYWltTWF4RGlzdDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGFpbUtub2IpIHsKICAgICAgICAgICAgICAgIGFpbUtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZShjYWxjKC01MCUgKyAke2R4fXB4KSwgY2FsYygtNTAlICsgJHtkeX1weCkpYDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTm9ybWFsaXplIGFuZCB0cmFuc2Zvcm0gdG8gd29ybGQgc3BhY2UKICAgICAgICAgICAgX2FpbUlucHV0LnggPSBkeCAvIGFpbU1heERpc3Q7CiAgICAgICAgICAgIF9haW1JbnB1dC55ID0gZHkgLyBhaW1NYXhEaXN0OwoKICAgICAgICAgICAgLy8gQXBwbHkgYWltIHRvIHBsYXllciBpZiBjaGFyZ2luZwogICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgaWYgKHAuaXNDaGFyZ2luZyB8fCBwLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUcmFuc2Zvcm0gc2NyZWVuIGFpbSB0byB3b3JsZCBzcGFjZQogICAgICAgICAgICAgICAgICAgIF9jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgICAgICAgICBlbHNlIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhfY2FtRndkLCBfdXBBeGlzKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRYID0gKF9jYW1SaWdodC54ICogX2FpbUlucHV0LngpICsgKF9jYW1Gd2QueCAqIC1fYWltSW5wdXQueSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRaID0gKF9jYW1SaWdodC56ICogX2FpbUlucHV0LngpICsgKF9jYW1Gd2QueiAqIC1fYWltSW5wdXQueSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyh3b3JsZFgpID4gMC4xIHx8IE1hdGguYWJzKHdvcmxkWikgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRPdmVycmlkZUFpbSh3b3JsZFgsIHdvcmxkWik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCmNvbnN0IGhhbmRsZUFpbUVuZCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBhaW1EcmFnZ2luZyA9IGZhbHNlOwogICAgICAgICAgICBfYWltSW5wdXQuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIF9haW1JbnB1dC54ID0gMDsKICAgICAgICAgICAgX2FpbUlucHV0LnkgPSAwOwoKICAgICAgICAgICAgaWYgKGFpbVZpc3VhbHMpIHsKICAgICAgICAgICAgICAgIGFpbVZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2xlYXIgcGxheWVyIGFpbSBvdmVycmlkZQogICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIub3ZlcnJpZGVBaW1WZWN0b3IgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgYWltWm9uZS5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBjb25zdCB0ID0gKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlc1swXSkgPyBlLmNoYW5nZWRUb3VjaGVzWzBdIDogZS50b3VjaGVzWzBdOwogICAgICAgICAgICBhaW1Ub3VjaElkID0gdCA/IHQuaWRlbnRpZmllciA6IG51bGw7CiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5haW0pIHsgX2RiZy5pbnB1dC5haW0udG91Y2hJZCA9IGFpbVRvdWNoSWQ7IH0KICAgICAgICAgICAgaGFuZGxlQWltU3RhcnQodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgY29uc3QgdCA9IF9maW5kVG91Y2hCeUlkKGUudG91Y2hlcywgYWltVG91Y2hJZCk7CiAgICAgICAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICAgICAgICBoYW5kbGVBaW1Nb3ZlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgYWltVG91Y2hJZCk7CiAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOwogICAgICAgICAgICBhaW1Ub3VjaElkID0gbnVsbDsKICAgICAgICAgICAgaGFuZGxlQWltRW5kKCk7CiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5haW0pIHsgX2RiZy5pbnB1dC5haW0udG91Y2hJZCA9IGFpbVRvdWNoSWQ7IF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7IH0KICAgICAgICAgICAgaGFuZGxlQWltRW5kKCk7CiAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIGFpbVRvdWNoSWQpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgYWltVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZUFpbUVuZCgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLnRvdWNoSWQgPSBhaW1Ub3VjaElkOyBfZGJnLmlucHV0LmFpbS5kcmFnZ2luZyA9IGFpbURyYWdnaW5nOyB9CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZUFpbUVuZCgpOwogICAgICAgIH0pOwovLyBNb3VzZSBzdXBwb3J0IGZvciBkZXNrdG9wIHRlc3RpbmcKICAgICAgICBhaW1ab25lLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgIGhhbmRsZUFpbVN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGFpbURyYWdnaW5nKSBoYW5kbGVBaW1Nb3ZlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChhaW1EcmFnZ2luZykgaGFuZGxlQWltRW5kKCk7CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gTkVXOiBUYWNrbGUgQnV0dG9uIFNldHVwCiAgICBmdW5jdGlvbiBzZXR1cFRhY2tsZUJ1dHRvbigpIHsKICAgICAgICBjb25zdCB0YWNrbGVCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGFja2xlLWJ1dHRvbicpOwogICAgICAgIGlmICghdGFja2xlQnRuKSByZXR1cm47CgogICAgICAgIGNvbnN0IGhhbmRsZVRhY2tsZSA9IChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmlzRGVtb01vZGUpIHJldHVybjsKCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgICAgICAgICAgLy8gSWYgd2UgZG9uJ3QgaGF2ZSB0aGUgYmFsbCwgZGFzaC90YWNrbGUKICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gR2V0IGN1cnJlbnQgbW92ZW1lbnQgZGlyZWN0aW9uIG9yIGZvcndhcmQKICAgICAgICAgICAgICAgICAgICBsZXQgZGFzaFggPSBwLmlucHV0VmVjdG9yLng7CiAgICAgICAgICAgICAgICAgICAgbGV0IGRhc2haID0gcC5pbnB1dFZlY3Rvci56OwoKICAgICAgICAgICAgICAgICAgICAvLyBJZiBub3QgbW92aW5nLCBkYXNoIGZvcndhcmQKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGFzaFgpIDwgMC4xICYmIE1hdGguYWJzKGRhc2haKSA8IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24ocC5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgICAgICAgICBkYXNoWCA9IGZ3ZC54OwogICAgICAgICAgICAgICAgICAgICAgICBkYXNoWiA9IGZ3ZC56OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcC5kYXNoKGRhc2hYLCBkYXNoWik7CgogICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRhY2tsZUJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSwgMjAwKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiVEFDS0xFISIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQnJlYWsgdGFja2xlIGlmIGVuZ2FnZWQKICAgICAgICAgICAgICAgICAgICBwLmRhc2gocC5pbnB1dFZlY3Rvci54LCBwLmlucHV0VmVjdG9yLnopOwogICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRhY2tsZUJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSwgMjAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlVGFja2xlLCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBoYW5kbGVUYWNrbGUpOwogICAgfQoKICAgIC8vIE5FVzogU2V0dGluZ3MgQnV0dG9uIFNldHVwCi8vIE5FVzogU2V0dGluZ3MgQnV0dG9uIFNldHVwCmZ1bmN0aW9uIHNldHVwU2V0dGluZ3NCdXR0b24oKSB7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2V0dGluZ3MtYnV0dG9uJyk7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NQYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXR0aW5ncy1wYW5lbCcpOwogICAgICAgIGNvbnN0IHNldHRpbmdzQ2xvc2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2V0dGluZ3MtY2xvc2UnKTsKCiAgICAgICAgaWYgKCFzZXR0aW5nc0J0biB8fCAhc2V0dGluZ3NQYW5lbCkgcmV0dXJuOwoKICAgICAgICBzZXR0aW5nc0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID0gc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID09PSAnbm9uZScgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIH0pOwoKICAgICAgICBpZiAoc2V0dGluZ3NDbG9zZSkgewogICAgICAgICAgICBzZXR0aW5nc0Nsb3NlLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIFNlbnNpdGl2aXR5IHNsaWRlcgogICAgICAgIGNvbnN0IHNlbnNpdGl2aXR5U2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlbnNpdGl2aXR5LXNsaWRlcicpOwogICAgICAgIGlmIChzZW5zaXRpdml0eVNsaWRlcikgewogICAgICAgICAgICBzZW5zaXRpdml0eVNsaWRlci52YWx1ZSA9IF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5ICogMTAwOwogICAgICAgICAgICBzZW5zaXRpdml0eVNsaWRlci5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eSA9IGUudGFyZ2V0LnZhbHVlIC8gMTAwOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIEFpbSBhc3Npc3QgdG9nZ2xlCiAgICAgICAgY29uc3QgYWltQXNzaXN0VG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1hc3Npc3QtdG9nZ2xlJyk7CiAgICAgICAgaWYgKGFpbUFzc2lzdFRvZ2dsZSkgewogICAgICAgICAgICBhaW1Bc3Npc3RUb2dnbGUuY2hlY2tlZCA9IF9zZXR0aW5ncy5haW1Bc3Npc3Q7CiAgICAgICAgICAgIGFpbUFzc2lzdFRvZ2dsZS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgX3NldHRpbmdzLmFpbUFzc2lzdCA9IGUudGFyZ2V0LmNoZWNrZWQ7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gQ2FtZXJhIHNoYWtlIHRvZ2dsZQogICAgICAgIGNvbnN0IHNoYWtlVG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NoYWtlLXRvZ2dsZScpOwogICAgICAgIGlmIChzaGFrZVRvZ2dsZSkgewogICAgICAgICAgICBzaGFrZVRvZ2dsZS5jaGVja2VkID0gX3NldHRpbmdzLmNhbWVyYVNoYWtlOwogICAgICAgICAgICBzaGFrZVRvZ2dsZS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgX3NldHRpbmdzLmNhbWVyYVNoYWtlID0gZS50YXJnZXQuY2hlY2tlZDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBWb2x1bWUgc2xpZGVyCiAgICAgICAgY29uc3Qgdm9sdW1lU2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ZvbHVtZS1zbGlkZXInKTsKICAgICAgICBpZiAodm9sdW1lU2xpZGVyICYmIF9hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgdm9sdW1lU2xpZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHZvbCA9IGUudGFyZ2V0LnZhbHVlIC8gMTAwOwogICAgICAgICAgICAgICAgX2F1ZGlvTWFuYWdlci5zZXRWb2x1bWUodm9sKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBFeGl0IHRvIE1lbnUKICAgICAgICBjb25zdCBleGl0QnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2V4aXQtdG8tbWVudS1idG4nKTsKICAgICAgICBpZiAoZXhpdEJ0bikgewogICAgICAgICAgICBleGl0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKF9tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIF9tZW51TWFuYWdlci5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIuc3RhdGUgPSAnbWVudSc7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgcHJhY3RpY2UgaWYgcnVubmluZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlSW5wdXRWZWN0b3IoKSB7CiAgICAgICAgbGV0IHggPSBfaW5wdXQueCB8fCAwOwogICAgICAgIGxldCB6ID0gX2lucHV0LnkgfHwgMDsKCiAgICAgICAgaWYgKF9rZXlzWyd3J10gfHwgX2tleXNbJ0Fycm93VXAnXSkgeiAtPSAxOwogICAgICAgIGlmIChfa2V5c1sncyddIHx8IF9rZXlzWydBcnJvd0Rvd24nXSkgeiArPSAxOwogICAgICAgIGlmIChfa2V5c1snYSddIHx8IF9rZXlzWydBcnJvd0xlZnQnXSkgeCAtPSAxOwogICAgICAgIGlmIChfa2V5c1snZCddIHx8IF9rZXlzWydBcnJvd1JpZ2h0J10pIHggKz0gMTsKCiAgICAgICAgY29uc3QgbGVuU3EgPSB4KnggKyB6Kno7CiAgICAgICAgaWYgKGxlblNxID4gMSkgewogICAgICAgICAgICBjb25zdCBsZW4gPSBNYXRoLnNxcnQobGVuU3EpOwogICAgICAgICAgICB4IC89IGxlbjsKICAgICAgICAgICAgeiAvPSBsZW47CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNOYU4oeCkpIHggPSAwOwogICAgICAgIGlmIChpc05hTih6KSkgeiA9IDA7CgogICAgICAgIGlmIChfY2FtZXJhKSB7CiAgICAgICAgICAgIF9jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CgogICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICBfY2FtUmlnaHQuc2V0KDEsIDAsIDApOwogICAgICAgIH0KCiAgICAgICAgbGV0IHdvcmxkWCA9IChfY2FtRndkLnggKiAteikgKyAoX2NhbVJpZ2h0LnggKiB4KTsKICAgICAgICBsZXQgd29ybGRaID0gKF9jYW1Gd2QueiAqIC16KSArIChfY2FtUmlnaHQueiAqIHgpOwoKICAgICAgICBpZiAoaXNOYU4od29ybGRYKSB8fCBpc05hTih3b3JsZFopKSB7CiAgICAgICAgICAgIHdvcmxkWCA9IDA7CiAgICAgICAgICAgIHdvcmxkWiA9IDA7CiAgICAgICAgfQoKICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiAhX2dhbWVNYW5hZ2VyLmlzRGVtb01vZGUpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQod29ybGRYLCB3b3JsZFopOwogICAgICAgICAgICB9Cgp9CiAgICB9CmZ1bmN0aW9uIGNyZWF0ZVJpcHBsZSh4LCB5KSB7CiAgICAgICAgY29uc3QgcmlwcGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgcmlwcGxlLmNsYXNzTmFtZSA9ICd0b3VjaC1yaXBwbGUnOwogICAgICAgIHJpcHBsZS5zdHlsZS5sZWZ0ID0gYCR7eH1weGA7CiAgICAgICAgcmlwcGxlLnN0eWxlLnRvcCA9IGAke3l9cHhgOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpLmFwcGVuZENoaWxkKHJpcHBsZSk7CgogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAocmlwcGxlLnBhcmVudE5vZGUpIHJpcHBsZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHJpcHBsZSk7CiAgICAgICAgfSwgNjAwKTsKCiAgICB9CgogICAgLy8gTkVXOiBWaXN1YWwgU3dpcGUgVHJhaWwKICAgIGZ1bmN0aW9uIGNyZWF0ZVN3aXBlVHJhaWxEb3QoeCwgeSkgewogICAgICAgIGNvbnN0IGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIGRvdC5jbGFzc05hbWUgPSAnc3dpcGUtdHJhaWwtZG90JzsKICAgICAgICBkb3Quc3R5bGUubGVmdCA9IGAke3ggLSA2fXB4YDsgLy8gQ2VudGVyICgxMnB4IHdpZHRoKQogICAgICAgIGRvdC5zdHlsZS50b3AgPSBgJHt5IC0gNn1weGA7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJykuYXBwZW5kQ2hpbGQoZG90KTsKICAgICAgICAKICAgICAgICAvLyBDU1MgYW5pbWF0aW9uIGhhbmRsZXMgcmVtb3ZhbCwgYnV0IHdlIGNsZWFuIHVwIERPTSB0byBiZSBzYWZlCiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGlmIChkb3QucGFyZW50Tm9kZSkgZG90LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZG90KTsKICAgICAgICB9LCA1MDApOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uUmVzaXplKCkgewogICAgICAgIGNvbnN0IHdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgIAogICAgICAgIGlmIChfY2FtZXJhKSB7CiAgICAgICAgICAgIF9jYW1lcmEuYXNwZWN0ID0gd2lkdGggLyBoZWlnaHQ7CiAgICAgICAgICAgIF9jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBTdHJpY3RseSAwLjUwIGFzIHJlcXVlc3RlZAogICAgICAgIGNvbnN0IHJlc1NjYWxlID0gMC41MDsKICAgICAgICAKICAgICAgICBfY29uZmlnLmludGVybmFsV2lkdGggPSBNYXRoLmZsb29yKHdpZHRoICogcmVzU2NhbGUpOwogICAgICAgIF9jb25maWcuaW50ZXJuYWxIZWlnaHQgPSBNYXRoLmZsb29yKGhlaWdodCAqIHJlc1NjYWxlKTsKCiAgICAgICAgaWYgKF9yZW5kZXJlcikgewogICAgICAgICAgICBfcmVuZGVyZXIuc2V0U2l6ZShfY29uZmlnLmludGVybmFsV2lkdGgsIF9jb25maWcuaW50ZXJuYWxIZWlnaHQsIGZhbHNlKTsKICAgICAgICB9CiAgICB9CgpmdW5jdGlvbiBhbmltYXRlKCkgewogICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRlKTsKCiAgICAgICAgY29uc3QgcmF3RHQgPSBfY2xvY2suZ2V0RGVsdGEoKTsKICAgICAgICAvLyBDbGFtcCBkdCB0byBwcmV2ZW50IHNwaXJhbHMgb2YgZGVhdGggKG1heCAwLjFzKQogICAgICAgIGNvbnN0IGR0ID0gTWF0aC5taW4ocmF3RHQsIDAuMSkgKiAod2luZG93LmZsdXgudGltZVNjYWxlICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC50aW1lU2NhbGUgOiAwLjgpOwoKICAgICAgICAKCiAgICAgICAgLy8gUGVyZiBzdGF0cyBmb3IgRGV2VG9vbHMgc25hcHNob3RzCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPLnBlcmYpIHsKICAgICAgICAgICAgY29uc3QgcGVyZiA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPLnBlcmY7CiAgICAgICAgICAgIHBlcmYuZnJhbWUgPSAocGVyZi5mcmFtZSB8fCAwKSArIDE7CiAgICAgICAgICAgIHBlcmYucmF3RHQgPSByYXdEdDsKICAgICAgICAgICAgcGVyZi5kdCA9IGR0OwogICAgICAgICAgICBjb25zdCBmcHMgPSBkdCA+IDAgPyAoMSAvIGR0KSA6IDA7CiAgICAgICAgICAgIHBlcmYuZnBzID0gZnBzOwogICAgICAgICAgICBwZXJmLmF2Z0ZwcyA9IChwZXJmLmF2Z0ZwcyAmJiBwZXJmLmF2Z0ZwcyA+IDApID8gKHBlcmYuYXZnRnBzICogMC45ICsgZnBzICogMC4xKSA6IGZwczsKICAgICAgICB9Ci8vIEltcGFjdCBGcmFtZXMKICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pbXBhY3RQYXVzZSA+IDApIHsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmltcGFjdFBhdXNlIC09IGR0OwogICAgICAgICAgICBpZiAoX3JlbmRlcmVyICYmIF9zY2VuZSAmJiBfY2FtZXJhKSB7CiAgICAgICAgICAgICAgICBfcmVuZGVyZXIucmVuZGVyKF9zY2VuZSwgX2NhbWVyYSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKCiAgICAgICAgLy8gQWN0aW9uIEJ1ZmZlciBQcm9jZXNzaW5nCiAgICAgICAgaWYgKF9hY3Rpb25CdWZmZXIuYWN0aXZlKSB7CiAgICAgICAgICAgIGlmIChEYXRlLm5vdygpIC0gX2FjdGlvbkJ1ZmZlci50aW1lc3RhbXAgPiBfYWN0aW9uQnVmZmVyLmR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgJiYgIXAuaXNDaGFyZ2luZyAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ0bikgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gTWVudSBTdGF0ZSBIYW5kbGluZwogICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLnN0YXRlID09PSAnbWVudScgJiYgX2NhbWVyYSkgewogICAgICAgICAgICBjb25zdCB0aW1lID0gRGF0ZS5ub3coKSAqIDAuMDAwNTsKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gNTA7CiAgICAgICAgICAgIF9jYW1lcmEucG9zaXRpb24ueCA9IE1hdGguc2luKHRpbWUpICogcmFkaXVzOwogICAgICAgICAgICBfY2FtZXJhLnBvc2l0aW9uLnogPSBNYXRoLmNvcyh0aW1lKSAqIHJhZGl1czsKICAgICAgICAgICAgX2NhbWVyYS5wb3NpdGlvbi55ID0gMjA7CiAgICAgICAgICAgIF9jYW1lcmEubG9va0F0KDAsIDAsIDApOwoKICAgICAgICAgICAgaWYgKF9yZW5kZXJlciAmJiBfc2NlbmUpIHsKICAgICAgICAgICAgICAgIF9yZW5kZXJlci5yZW5kZXIoX3NjZW5lLCBfY2FtZXJhKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKLy8gU3RhYmxlIHN1Yi1zdGVwcGluZyAocHJldmVudHMgZHQgc3Bpa2VzIGZyb20gbWFraW5nIHBoeXNpY3MvY2FtZXJhIGZlZWwgZmxvYXR5IG9uIG1vYmlsZSkKICAgICAgICBjb25zdCBfbWF4U3RlcCA9IDEgLyA2MDsKICAgICAgICBjb25zdCBfc3RlcHMgPSBNYXRoLm1pbig0LCBNYXRoLm1heCgxLCBNYXRoLmNlaWwoZHQgLyBfbWF4U3RlcCkpKTsKICAgICAgICBjb25zdCBfc3RlcER0ID0gZHQgLyBfc3RlcHM7CgogICAgICAgIGZvciAobGV0IF9zaSA9IDA7IF9zaSA8IF9zdGVwczsgX3NpKyspIHsKICAgICAgICAgICAgY29uc3QgX3NkdCA9IF9zdGVwRHQ7CgogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSBfZ2FtZU1hbmFnZXIudXBkYXRlKF9zZHQpOwoKICAgICAgICAgICAgLy8gSWYgaW4gQXNzZXQgRm9yZ2UgbW9kZSwgc2tpcCBnYW1lIGxvZ2ljIGFuZCBzdGFuZGFyZCByZW5kZXJpbmcKICAgICAgICAgICAgLy8gRGV2VG9vbHMgaGFuZGxlcyB0aGUgcmVuZGVyaW5nIGluIGl0cyBob29rZWQgdXBkYXRlIGZ1bmN0aW9uCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmlzRm9yZ2VNb2RlKSB7CiAgICAgICAgICAgICAgICAvLyBGb3JnZSBtb2RlIGhhbmRsZXMgaXRzIG93biByZW5kZXJpbmcgbG9vcCBpbiBEZXZUb29scyBob29rCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVwZGF0ZSBFbnRpdGllcwogICAgICAgICAgICBpZiAoX2hvbWVUZWFtKSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0udXBkYXRlKF9zZHQpOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IGNoZWNrQmFsbEdyYWIocCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoX2F3YXlUZWFtKSB7CiAgICAgICAgICAgICAgICBfYXdheVRlYW0udXBkYXRlKF9zZHQpOwogICAgICAgICAgICAgICAgX2F3YXlUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IGNoZWNrQmFsbEdyYWIocCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoX2JhbGwpIHsKICAgICAgICAgICAgICAgIF9iYWxsLnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmFsbCBMYWIgcnVudGltZSAodHJhamVjdG9yeSBwcmV2aWV3IC8gcmVjb3JkLXJlcGxheSkKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWIgJiYgdHlwZW9mIHdpbmRvdy5mbHV4LmJhbGxMYWIudXBkYXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5iYWxsTGFiLnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIENhbWVyYQogICAgICAgICAgICB1cGRhdGVDYW1lcmFMb2dpYyhfc2R0KTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBWaXN1YWxzCiAgICAgICAgICAgIGlmIChfd2F0ZXJPdmVybGF5KSBfd2F0ZXJPdmVybGF5LnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgaWYgKF9saWdodFNoYWZ0cykgX2xpZ2h0U2hhZnRzLnVwZGF0ZShfc2R0KTsKCiAgICAgICAgICAgIC8vIFJ1bnRpbWUgdXBkYXRlcnMgKEZYLCBhcmVuYSByaW5ncywgZXRjLikKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgJiYgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IHVpID0gMDsgdWkgPCB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLmxlbmd0aDsgdWkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZuID0gd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVyc1t1aV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJykgZm4oX3NkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVwZGF0ZSBHbG9iYWwgVW5pZm9ybXMKICAgICAgICAgICAgaWYgKF9hcmVuYVVuaWZvcm1zKSB7CiAgICAgICAgICAgICAgICBfYXJlbmFVbmlmb3Jtcy51VGltZS52YWx1ZSArPSBfc2R0OwogICAgICAgICAgICAgICAgLy8gRGVjYXkgaW1wYWN0IHN0cmVuZ3RoCiAgICAgICAgICAgICAgICBfYXJlbmFVbmlmb3Jtcy51SW1wYWN0U3RyLnZhbHVlICo9IE1hdGgubWF4KDAsIDEuMCAtIF9zZHQgKiA0LjApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChfcGFydGljbGVVbmlmb3JtcykgewogICAgICAgICAgICAgICAgX3BhcnRpY2xlVW5pZm9ybXMudVRpbWUudmFsdWUgKz0gX3NkdDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKF9zdGFkaXVtKSBfc3RhZGl1bS51cGRhdGUoX3NkdCk7CiAgICAgICAgfQoKCiAgICAgICAgaWYgKF9yZW5kZXJlciAmJiBfc2NlbmUgJiYgX2NhbWVyYSkgewogICAgICAgICAgICBfcmVuZGVyZXIucmVuZGVyKF9zY2VuZSwgX2NhbWVyYSk7CiAgICAgICAgfQogICAgICAgIC8vIFVJIFVwZGF0ZXMKICAgICAgICB1cGRhdGVVSSgpOwogICAgfQoKICAgIGZ1bmN0aW9uIHVwZGF0ZVVJKCkgewogICAgICAgIGlmICghX2hvbWVUZWFtIHx8ICFfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSByZXR1cm47CgogICAgICAgIGNvbnN0IGJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY3Rpb24tYnV0dG9uJyk7CiAgICAgICAgY29uc3QgbGJsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1sYWJlbCcpOwogICAgICAgIGNvbnN0IHRhY2tsZUJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0YWNrbGUtYnV0dG9uJyk7CiAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgIGlmIChidG4gJiYgbGJsKSB7CiAgICAgICAgICAgIGNvbnN0IGJ0blRleHQgPSBidG4ucXVlcnlTZWxlY3RvcignLmJ0bi10ZXh0Jyk7CgogICAgICAgICAgICBpZiAocC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoYnRuVGV4dCAmJiBidG5UZXh0LmlubmVyVGV4dCAhPT0gIkFDVElPTiIpIHsKICAgICAgICAgICAgICAgICAgICBidG5UZXh0LmlubmVyVGV4dCA9ICJBQ1RJT04iOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdzaG9vdC1tb2RlJyk7CiAgICAgICAgICAgICAgICAgICAgbGJsLmlubmVyVGV4dCA9ICJPRkZFTlNFIjsKICAgICAgICAgICAgICAgICAgICBsYmwuY2xhc3NMaXN0LmFkZCgnc2hvb3QtbGFiZWwnKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBpc0hpZ2hFbmVyZ3kgPSAocC5zdGF0cy5IUCAvIHAuc3RhdHMubWF4SFApID4gMC40OwogICAgICAgICAgICAgICAgaWYgKGlzSGlnaEVuZXJneSkgewogICAgICAgICAgICAgICAgICAgIGlmICghYnRuLmNsYXNzTGlzdC5jb250YWlucygnbGltaXQtcmVhZHknKSkgYnRuLmNsYXNzTGlzdC5hZGQoJ2xpbWl0LXJlYWR5Jyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChidG4uY2xhc3NMaXN0LmNvbnRhaW5zKCdsaW1pdC1yZWFkeScpKSBidG4uY2xhc3NMaXN0LnJlbW92ZSgnbGltaXQtcmVhZHknKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoYnRuVGV4dCAmJiBidG5UZXh0LmlubmVyVGV4dCAhPT0gIlNXSU0iKSB7CiAgICAgICAgICAgICAgICAgICAgYnRuVGV4dC5pbm5lclRleHQgPSAiU1dJTSI7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob290LW1vZGUnKTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnbGltaXQtcmVhZHknKTsKICAgICAgICAgICAgICAgICAgICBsYmwuaW5uZXJUZXh0ID0gIk5PUk1BTCI7CiAgICAgICAgICAgICAgICAgICAgbGJsLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob290LWxhYmVsJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFVwZGF0ZSB0YWNrbGUgYnV0dG9uIHZpc2liaWxpdHkKICAgICAgICBpZiAodGFja2xlQnRuKSB7CiAgICAgICAgICAgIGlmICghcC5oYXNCYWxsIHx8IHAuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICB0YWNrbGVCdG4uc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSB0YWNrbGUgYnV0dG9uIHRleHQgYmFzZWQgb24gY29udGV4dAogICAgICAgICAgICAgICAgY29uc3QgdGFja2xlVGV4dCA9IHRhY2tsZUJ0bi5xdWVyeVNlbGVjdG9yKCcuYnRuLXRleHQnKTsKICAgICAgICAgICAgICAgIGlmICh0YWNrbGVUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaXNFbmdhZ2VkICYmIHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVUZXh0LmlubmVyVGV4dCA9ICdCUkVBSyc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCd1cmdlbnQnKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVUZXh0LmlubmVyVGV4dCA9ICdUQUNLTEUnOwogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVCdG4uY2xhc3NMaXN0LnJlbW92ZSgndXJnZW50Jyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFja2xlQnRuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFVwZGF0ZSBkaXN0YW5jZSB0byBnb2FsIGluZGljYXRvcgogICAgICAgIGNvbnN0IGRpc3RJbmRpY2F0b3IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ29hbC1kaXN0YW5jZScpOwogICAgICAgIGlmIChkaXN0SW5kaWNhdG9yICYmIHAubWVzaCkgewogICAgICAgICAgICBjb25zdCBnb2FsWiA9IChwLnRlYW0gJiYgcC50ZWFtLnNpZGUgPT09IDEpID8gLTI4IDogMjg7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLmFicyhwLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgZGlzdEluZGljYXRvci5pbm5lclRleHQgPSBgJHtNYXRoLmZsb29yKGRpc3QpfW1gOwogICAgICAgIH0KICAgIH0KCmZ1bmN0aW9uIHVwZGF0ZUNhbWVyYUxvZ2ljKGR0KSB7CiAgICAgICAgaWYgKCFfY2FtZXJhTWFuYWdlciB8fCAhX2JhbGwpIHJldHVybjsKCiAgICAgICAgbGV0IHRhcmdldE1lc2ggPSBfYmFsbC5tZXNoOwogICAgICAgIGxldCB0YXJnZXRWZWwgPSBfYmFsbC52ZWxvY2l0eTsKICAgICAgICBsZXQgdGFyZ2V0SW5wdXQgPSBudWxsOwogICAgICAgIGxldCBpc0FpbWluZyA9IGZhbHNlOwoKICAgICAgICBpZiAoX2JhbGwuaG9sZGVyICYmIF9iYWxsLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgIHRhcmdldE1lc2ggPSBfYmFsbC5ob2xkZXIubWVzaDsKICAgICAgICAgICAgdGFyZ2V0VmVsID0gX2JhbGwuaG9sZGVyLnZlbG9jaXR5OwogICAgICAgICAgICBpZiAoX2JhbGwuaG9sZGVyLmlucHV0VmVjdG9yKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRJbnB1dCA9IF9iYWxsLmhvbGRlci5pbnB1dFZlY3RvcjsKICAgICAgICAgICAgfQovLyBDaGVjayBhaW1pbmcgc3RhdGUgKENoYXJnaW5nIG9yIFRocm93aW5nKQogICAgICAgICAgICBpZiAoX2JhbGwuaG9sZGVyLmlzQ2hhcmdpbmcgfHwgX2JhbGwuaG9sZGVyLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIGlzQWltaW5nID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KHRhcmdldE1lc2gsIHRhcmdldFZlbCwgdGFyZ2V0SW5wdXQsIGlzQWltaW5nKTsKICAgICAgICBfY2FtZXJhTWFuYWdlci51cGRhdGUoZHQpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNoZWNrQmFsbEdyYWIoZW50aXR5KSB7CiAgICAgICAgaWYgKCFlbnRpdHkuY2FuQ2F0Y2gpIHJldHVybjsKICAgICAgICBpZiAoX2JhbGwgJiYgIV9iYWxsLmlzQ2F0Y2hhYmxlKCkpIHJldHVybjsKICAgICAgICBpZiAoZW50aXR5LnN0dW5UaW1lciA+IDAgfHwgKGVudGl0eS5zdGF0dXMgJiYgZW50aXR5LnN0YXR1cy5uYXAgPiAwKSkgcmV0dXJuOwogICAgICAgIGlmIChfYmFsbC5zdGF0ZSAhPT0gJ2ZyZWUnKSByZXR1cm47CiAgICAgICAgaWYgKCFfYmFsbC5tZXNoIHx8ICFlbnRpdHkubWVzaCkgcmV0dXJuOwoKY29uc3QgYmFsbFBvcyA9IF9iYWxsLm1lc2gucG9zaXRpb247CiAgICAgICAgY29uc3QgZW50UG9zID0gZW50aXR5Lm1lc2gucG9zaXRpb247CgogICAgICAgIGNvbnN0IGR4ID0gYmFsbFBvcy54IC0gZW50UG9zLng7CiAgICAgICAgY29uc3QgZHogPSBiYWxsUG9zLnogLSBlbnRQb3MuejsKICAgICAgICBjb25zdCBkaXN0WFogPSBNYXRoLnNxcnQoZHgqZHggKyBkeipkeik7CiAgICAgICAgY29uc3QgZGlzdFkgPSBNYXRoLmFicyhiYWxsUG9zLnkgLSBlbnRQb3MueSk7CgogICAgICAgIC8vIEFzc2lzdCB0dW5pbmcgKDAuLjEpCiAgICAgICAgY29uc3QgcyA9ICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTyAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTy5zZXR0aW5ncykgPyB3aW5kb3cuZmx1eC5fZGVidWdJTy5zZXR0aW5ncyA6IG51bGw7CiAgICAgICAgY29uc3QgY2F0Y2hBc3Npc3QgPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCAocyAmJiB0eXBlb2Ygcy5jYXRjaEFzc2lzdCA9PT0gJ251bWJlcicpID8gcy5jYXRjaEFzc2lzdCA6IDAuMCkpOwogICAgICAgIGNvbnN0IHByZWRpY3RpdmVUID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMC41LCAocyAmJiB0eXBlb2Ygcy5wcmVkaWN0aXZlQ2F0Y2hUaW1lID09PSAnbnVtYmVyJykgPyBzLnByZWRpY3RpdmVDYXRjaFRpbWUgOiAwLjEyKSk7CgogICAgICAgIC8vIFByZWRpY3RpdmUgc2FtcGxlIChoZWxwcyB3aXRoIGZhc3QgYmFsbHMgdGhhdCBza2ltIGJ5KQogICAgICAgIGNvbnN0IHByZWRQb3MgPSBfdGVtcFZlYzMuY29weShiYWxsUG9zKS5hZGRTY2FsZWRWZWN0b3IoX2JhbGwudmVsb2NpdHksIHByZWRpY3RpdmVUKTsKCiAgICAgICAgY29uc3QgZHhQID0gcHJlZFBvcy54IC0gZW50UG9zLng7CiAgICAgICAgY29uc3QgZHpQID0gcHJlZFBvcy56IC0gZW50UG9zLno7CiAgICAgICAgY29uc3QgZGlzdFhaUHJlZCA9IE1hdGguc3FydChkeFAqZHhQICsgZHpQKmR6UCk7CiAgICAgICAgY29uc3QgZGlzdFlQcmVkID0gTWF0aC5hYnMocHJlZFBvcy55IC0gZW50UG9zLnkpOwoKICAgICAgICBjb25zdCBlZmZEaXN0WFogPSBNYXRoLm1pbihkaXN0WFosIGRpc3RYWlByZWQpOwogICAgICAgIGNvbnN0IGVmZkRpc3RZICA9IE1hdGgubWluKGRpc3RZLCAgZGlzdFlQcmVkKTsKCiAgICAgICAgY29uc3QgdG91Y2hSYWRpdXMgPSAxLjAgKyAoMC42ICogY2F0Y2hBc3Npc3QpOwogICAgICAgIC8vIEJhc2UgcmFkaWkgKHNsaWdodGx5IGZvcmdpdmluZyBieSBkZWZhdWx0OyBhc3Npc3Qgc2NhbGVzIHRoZW0gdXApCiAgICAgICAgbGV0IG1hZ25ldFJhZGl1cyA9IDEuOCArICgxLjYgKiBjYXRjaEFzc2lzdCk7CiAgICAgICAgbGV0IGludGVyYWN0aW9uUmFkaXVzID0gMy41ICsgKDIuMiAqIGNhdGNoQXNzaXN0KTsKICAgICAgICBsZXQgY2F0Y2hIZWlnaHQgPSAzLjAgKyAoMS42ICogY2F0Y2hBc3Npc3QpOwoKICAgICAgICBpZiAoZW50aXR5LmlzRGFzaGluZykgewogICAgICAgICAgICBtYWduZXRSYWRpdXMgPSAzLjA7CiAgICAgICAgICAgIGludGVyYWN0aW9uUmFkaXVzID0gNC41OwogICAgICAgICAgICBjYXRjaEhlaWdodCA9IDQuNTsKICAgICAgICB9CgogICAgICAgIGlmIChlZmZEaXN0WFogPiBpbnRlcmFjdGlvblJhZGl1cyB8fCBlZmZEaXN0WSA+IGNhdGNoSGVpZ2h0KSByZXR1cm47CgogICAgICAgIC8vIE9wdGltaXphdGlvbjogVXNlIHNoYXJlZCB2ZWN0b3JzIHRvIGF2b2lkIEdDCmNvbnN0IHNhbXBsZVBvcyA9IChkaXN0WFpQcmVkIDwgZGlzdFhaKSA/IHByZWRQb3MgOiBiYWxsUG9zOwogICAgICAgIF90ZW1wVmVjMS5jb3B5KHNhbXBsZVBvcykuc3ViKGVudFBvcykubm9ybWFsaXplKCk7IC8vIHRvQmFsbCAocHJlZGljdGl2ZSBpZiBjbG9zZXIpCiAgICAgICAgX3RlbXBWZWMyLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24oZW50aXR5Lm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7IC8vIHBsYXllckZvcndhcmQKCiAgICAgICAgY29uc3QgZmFjaW5nRG90ID0gX3RlbXBWZWMyLmRvdChfdGVtcFZlYzEpOwoKICAgICAgICBjb25zdCBjb25lVGhyZXNob2xkID0gLTAuMiAtICgwLjQgKiAodHlwZW9mIGNhdGNoQXNzaXN0ICE9PSAndW5kZWZpbmVkJyA/IGNhdGNoQXNzaXN0IDogMC4wKSk7CiAgICAgICAgY29uc3QgaXNJbkNvbmUgPSBmYWNpbmdEb3QgPiBjb25lVGhyZXNob2xkOwogICAgICAgIGNvbnN0IGlzSW5Ub3VjaCA9IGVmZkRpc3RYWiA8IHRvdWNoUmFkaXVzOwoKICAgICAgICBpZiAoZWZmRGlzdFhaIDwgaW50ZXJhY3Rpb25SYWRpdXMgJiYgIWlzSW5Db25lKSB7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldEFuZ2xlID0gTWF0aC5hdGFuMihfdGVtcFZlYzEueCwgX3RlbXBWZWMxLnopOwogICAgICAgICAgICBjb25zdCBxID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMSwwKSwgdGFyZ2V0QW5nbGUpOwogICAgICAgICAgICBlbnRpdHkubWVzaC5xdWF0ZXJuaW9uLnNsZXJwKHEsIDAuMSk7CiAgICAgICAgICAgIGlmIChlbnRpdHkuc3luY1JvdGF0aW9uKSBlbnRpdHkuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgfQoKLy8gKFJlbW92ZWQgZHVwbGljYXRlIGxvZ2ljIGJsb2NrKQoKICAgICAgICBpZiAoaXNJblRvdWNoIHx8IChlZmZEaXN0WFogPCBtYWduZXRSYWRpdXMgJiYgaXNJbkNvbmUpKSB7CiAgICAgICAgICAgIC8vIEJMQVNUIFRIUk9VR0ggTE9HSUMKICAgICAgICAgICAgY29uc3QgYmFsbFNwZWVkID0gX2JhbGwudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgIGxldCBjYXRjaENoYW5jZSA9IDEuMDsKCiAgICAgICAgICAgIC8vIElmIGJhbGwgaXMgbW92aW5nIGZhc3QgKGUuZy4gPiAyMCksIGNoZWNrIENBCiAgICAgICAgICAgIGlmIChiYWxsU3BlZWQgPiAyMC4wKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjYSA9IGVudGl0eS5nZXRTdGF0KCdDQScpOwogICAgICAgICAgICAgICAgLy8gRGlmZmljdWx0eSBzY2FsZXMgd2l0aCBzcGVlZC4gCiAgICAgICAgICAgICAgICBjb25zdCBkaWZmaWN1bHR5ID0gYmFsbFNwZWVkICogMS4yOyAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGRpZmZpY3VsdHkgPiBjYSkgewogICAgICAgICAgICAgICAgICAgIGNhdGNoQ2hhbmNlID0gMC40ICsgKGNhIC8gZGlmZmljdWx0eSkgKiAwLjY7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUG9pbnQgQmxhbmsgUGVuYWx0eTogSGFyZGVyIHRvIHJlYWN0IGlmIGJhbGwgaXMgcmlnaHQgb24gdG9wIG9mIHlvdSBtb3ZpbmcgZmFzdAogICAgICAgICAgICAgICAgICAgIGlmIChlZmZEaXN0WFogPCAxLjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2F0Y2hDaGFuY2UgKj0gMC42OyAvLyBCbGFzdCB0aHJvdWdoIGxpa2VseQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoZW50aXR5LmlzRGFzaGluZykgY2F0Y2hDaGFuY2UgKz0gMC4yOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKF9iYWxsLnBvd2VyVHlwZSA9PT0gJ1NIJyAmJiBfYmFsbC5wb3dlciA+IDE1LjApIHsKICAgICAgICAgICAgICAgIC8vIFNob3QgcG93ZXIgY2hlY2sKICAgICAgICAgICAgICAgIGNvbnN0IGNhID0gZW50aXR5LmdldFN0YXQoJ0NBJyk7CiAgICAgICAgICAgICAgICBpZiAoX2JhbGwucG93ZXIgPiBjYSAqIDEuMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5jZSA9IE1hdGgubWluKDAuNywgKF9iYWxsLnBvd2VyIC0gY2EpICogMC4wNCk7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hDaGFuY2UgPSAxLjAgLSBjaGFuY2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFzc2lzdCBudWRnZXMgY2F0Y2ggb2RkcyB1cHdhcmQgKG5ldmVyIGd1YXJhbnRlZXMpCiAgICAgICAgICAgIGlmICh0eXBlb2YgY2F0Y2hBc3Npc3QgIT09ICd1bmRlZmluZWQnICYmIGNhdGNoQXNzaXN0ID4gMCkgewogICAgICAgICAgICAgICAgY2F0Y2hDaGFuY2UgPSBNYXRoLm1heCgwLjA1LCBNYXRoLm1pbigxLjAsIGNhdGNoQ2hhbmNlICogKDEuMCAtIDAuMjUgKiBjYXRjaEFzc2lzdCkgKyAoMC4yNSAqIGNhdGNoQXNzaXN0KSkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgZnVtYmxlID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gY2F0Y2hDaGFuY2UpIHsKICAgICAgICAgICAgICAgIGZ1bWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmdW1ibGUpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIGZlZWRiYWNrIGZvciBibGFzdCB0aHJvdWdoCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxBU1QgVEhST1VHSCEiLCBlbnRQb3MsICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGVmbGVjdCBzbGlnaHRseSBidXQga2VlcCBtb3ZpbmcgZmFzdCAoQmxhc3QgVGhyb3VnaCkKICAgICAgICAgICAgICAgIC8vIERvbid0IHN0b3AgaXQgY29tcGxldGVseSBsaWtlIGEgYmxvY2ssIGp1c3QgcGVydHVyYiBpdAogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC44NSk7IAogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogNS4wOwogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkueSArPSAoTWF0aC5yYW5kb20oKSkgKiA1LjA7IC8vIFBvcCB1cAogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogNS4wOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfYmFsbC5wb3dlciAqPSAwLjc7CgogICAgICAgICAgICAgICAgZW50aXR5LmNhbkNhdGNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBTdHVuIGJyaWVmbHkKICAgICAgICAgICAgICAgIGVudGl0eS5zdHVuVGltZXIgPSAwLjU7CiAgICAgICAgICAgICAgICBpZihlbnRpdHkucGxheSkgZW50aXR5LnBsYXkoJ3JlYWN0JywgMC4xKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IGVudGl0eS5jYW5DYXRjaCA9IHRydWU7IH0sIDEwMDApOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9iYWxsLm1hZ25ldGl6ZShlbnRpdHkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIFN0YXJ0CiAgICBpbml0KCk7Cn0pKCk7","/main.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgLy8gTmFtZXNwYWNlCiAgICB3aW5kb3cuZmx1eCA9IHdpbmRvdy5mbHV4IHx8IHt9OwogICAgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyA9IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgfHwgW107CgogICAgLy8gQ29uZmlnCmNvbnN0IF9jb25maWcgPSB7CiAgICAgICAgaW50ZXJuYWxXaWR0aDogMzYwLAogICAgICAgIGludGVybmFsSGVpZ2h0OiA2NDAsCiAgICAgICAgYmdDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgZm9nQ29sb3I6IDB4MDAxZTM2LAogICAgICAgIGZvZ0RlbnNpdHk6IDAuMDAwMSwgLy8gRHJhc3RpY2FsbHkgcmVkdWNlZCB0byBlbnN1cmUgdmlzaWJpbGl0eQogICAgICAgIGFyZW5hUmFkaXVzOiA0OC4wCiAgICB9OwoKICAgIC8vIEdsb2JhbHMKLy8gR2xvYmFscwogICAgY29uc3QgX2lucHV0ID0geyB4OiAwLCB5OiAwIH07IC8vIElucHV0IHN0YXRlCiAgICAKICAgIC8vIFNoYWRlciBVbmlmb3JtcwogICAgY29uc3QgX2FyZW5hVW5pZm9ybXMgPSB7CiAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICB1SW1wYWN0UG9zOiB7IHZhbHVlOiBuZXcgVEhSRUUuVmVjdG9yMygpIH0sCiAgICAgICAgdUltcGFjdFN0cjogeyB2YWx1ZTogMC4wIH0KICAgIH07CiAgICBjb25zdCBfcGFydGljbGVVbmlmb3JtcyA9IHsKICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9CiAgICB9OwoKICAgIC8vIEV4cG9zZSBJbXBhY3QgVHJpZ2dlcgogICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0ID0gZnVuY3Rpb24ocG9zLCBzdHJlbmd0aCkgewogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RQb3MudmFsdWUuY29weShwb3MpOwogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RTdHIudmFsdWUgPSBzdHJlbmd0aCAqIDIuMDsgLy8gU2NhbGUgdXAgZm9yIHZpc2liaWxpdHkKICAgIH07Ci8vIF9pbnB1dCBhbHJlYWR5IGRlY2xhcmVkIGFib3ZlCiAgICBjb25zdCBfdGVtcFZlYzEgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBSZXVzYWJsZSBmb3IgcGh5c2ljcy9sb2dpYwogICAgY29uc3QgX3RlbXBWZWMyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsgLy8gUmV1c2FibGUgZm9yIHBoeXNpY3MvbG9naWMKICAgIGNvbnN0IF90ZW1wVmVjMyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7IC8vIFJldXNhYmxlIGZvciBwcmVkaWN0aXZlIGFzc2lzdAogICAgbGV0IF9zY2VuZSwgX2NhbWVyYSwgX3JlbmRlcmVyLCBfY2xvY2s7CiAgICBsZXQgX2hvbWVUZWFtLCBfYXdheVRlYW07CiAgICBsZXQgX2JhbGw7CiAgICBsZXQgX2dhbWVNYW5hZ2VyOwogICAgbGV0IF9tZW51TWFuYWdlcjsKICAgIGxldCBfYXVkaW9NYW5hZ2VyOwoKICAgIGxldCBfY2FtZXJhTWFuYWdlcjsKICAgIGxldCBfd2F0ZXJPdmVybGF5OwogICAgbGV0IF9saWdodFNoYWZ0czsKICAgIGxldCBfc3RhZGl1bTsKICAgIGxldCBfZ2x5cGhNYW5hZ2VyOwoKICAgIC8vIElNUFJPVkVEOiBTZXR0aW5ncyBvYmplY3QKICAgIGNvbnN0IF9zZXR0aW5ncyA9IHsKICAgICAgICBqb3lzdGlja1NlbnNpdGl2aXR5OiAxLjAsCiAgICAgICAgYWltQXNzaXN0OiB0cnVlLAogICAgICAgIGNhbWVyYVNoYWtlOiB0cnVlLAogICAgICAgIGhpdFN0b3A6IHRydWUsCiAgICAgICAgaW52ZXJ0Q2FtZXJhOiBmYWxzZSwKICAgICAgICBhdXRvUmVjZW50ZXI6IHRydWUsCgogICAgICAgIC8vIC0tLSAiRkVFTFMgR09PRCIgQVNTSVNUIExBWUVSICh0dW5hYmxlIGluIERldlRvb2xzIHNuYXBzaG90cykgLS0tCiAgICAgICAgLy8gMC4wID0gb2ZmIC8gcHVyZSBza2lsbCwgMS4wID0gdmVyeSBoZWxwZnVsIGJ1dCBub3QgZnVsbCBhdXRvLXBsYXkuCiAgICAgICAgcGFzc0FpbUFzc2lzdDogMC42NSwKICAgICAgICBzaG90QWltQXNzaXN0OiAwLjM1LAogICAgICAgIGNhdGNoQXNzaXN0OiAwLjU1LAogICAgICAgIHN0ZWVyaW5nQXNzaXN0OiAwLjM1LAoKICAgICAgICAvLyBIaWdoZXIgPSBzbmFwcGllciBpbnB1dCwgbG93ZXIgPSBmbG9hdGllci4KICAgICAgICBpbnB1dFJlc3BvbnNlOiAxNC4wLAoKICAgICAgICAvLyBTZWNvbmRzIGFoZWFkIHVzZWQgZm9yIGNhdGNoIHByZWRpY3Rpb24gKGhlbHBzIHdpdGggZmFzdCBiYWxscykuCiAgICAgICAgcHJlZGljdGl2ZUNhdGNoVGltZTogMC4xMgogICAgfTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIERlYnVnIElPIEJyaWRnZSAoZXhwb3NlZCBmb3IgRGV2VG9vbHMgSlNPTiBzbmFwc2hvdHMpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IF9kZWJ1Z0lPID0gd2luZG93LmZsdXguX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyB8fCB7fTsKICAgIF9kZWJ1Z0lPLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgX2RlYnVnSU8uaW5wdXQgPSBfZGVidWdJTy5pbnB1dCB8fCB7fTsKICAgIF9kZWJ1Z0lPLnBlcmYgPSBfZGVidWdJTy5wZXJmIHx8IHsgZnJhbWU6IDAsIHJhd0R0OiAwLCBkdDogMCwgZnBzOiAwLCBhdmdGcHM6IDAgfTsKCgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBUb3VjaCBoZWxwZXJzIChtdWx0aS10b3VjaCBzYWZlKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBmdW5jdGlvbiBfZmluZFRvdWNoQnlJZCh0b3VjaExpc3QsIGlkKSB7CiAgICAgICAgaWYgKGlkID09PSBudWxsIHx8IGlkID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgICAgIGlmICghdG91Y2hMaXN0KSByZXR1cm4gbnVsbDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRvdWNoTGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCB0ID0gdG91Y2hMaXN0W2ldOwogICAgICAgICAgICBpZiAodCAmJiB0LmlkZW50aWZpZXIgPT09IGlkKSByZXR1cm4gdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gX2VuZGVkVG91Y2hCeUlkKGNoYW5nZWRUb3VjaGVzLCBpZCkgewogICAgICAgIGlmIChpZCA9PT0gbnVsbCB8fCBpZCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgICBpZiAoIWNoYW5nZWRUb3VjaGVzKSByZXR1cm4gbnVsbDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoYW5nZWRUb3VjaGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IHQgPSBjaGFuZ2VkVG91Y2hlc1tpXTsKICAgICAgICAgICAgaWYgKHQgJiYgdC5pZGVudGlmaWVyID09PSBpZCkgcmV0dXJuIHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKCiAgICBmdW5jdGlvbiBpbml0KCkgewogICAgICAgIF9jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKCiAgICAgICAgLy8gMS4gU2NlbmUKICAgICAgICBfc2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTsKICAgICAgICBfc2NlbmUuYmFja2dyb3VuZCA9IG5ldyBUSFJFRS5Db2xvcihfY29uZmlnLmJnQ29sb3IpOwogICAgICAgIF9zY2VuZS5mb2cgPSBuZXcgVEhSRUUuRm9nRXhwMihfY29uZmlnLmZvZ0NvbG9yLCBfY29uZmlnLmZvZ0RlbnNpdHkpOwoKICAgICAgICAvLyAyLiBDYW1lcmEKICAgICAgICBjb25zdCBhc3BlY3QgPSBfY29uZmlnLmludGVybmFsV2lkdGggLyBfY29uZmlnLmludGVybmFsSGVpZ2h0OwpfY2FtZXJhID0gbmV3IFRIUkVFLlBlcnNwZWN0aXZlQ2FtZXJhKDYwLCBhc3BlY3QsIDAuMSwgNTAwKTsKX2NhbWVyYS5wb3NpdGlvbi5zZXQoMCwgMTQsIDIyKTsKICAgICAgICBfY2FtZXJhLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICBfc2NlbmUuYWRkKF9jYW1lcmEpOyAvLyBFbnN1cmUgY2FtZXJhIGlzIGluIHNjZW5lIGZvciBjaGlsZHJlbiB0byByZW5kZXIKCiAgICAgICAgLy8gMy4gUmVuZGVyZXIKLy8gMy4gUmVuZGVyZXIKICAgICAgICBfcmVuZGVyZXIgPSBuZXcgVEhSRUUuV2ViR0xSZW5kZXJlcih7IAogICAgICAgICAgICBhbnRpYWxpYXM6IGZhbHNlLAogICAgICAgICAgICBwb3dlclByZWZlcmVuY2U6ICJoaWdoLXBlcmZvcm1hbmNlIiwKICAgICAgICAgICAgcHJlY2lzaW9uOiAibWVkaXVtcCIsIC8vIE1vYmlsZSBvcHRpbWl6YXRpb246IGZhc3RlciBzaGFkZXJzCiAgICAgICAgICAgIHN0ZW5jaWw6IGZhbHNlLCAgICAgICAvLyBEaXNhYmxlIHN0ZW5jaWwgYnVmZmVyIGlmIG5vdCB1c2VkCiAgICAgICAgICAgIGRlcHRoOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgX3JlbmRlcmVyLnNldFBpeGVsUmF0aW8oMSk7IC8vIEZvcmNlIDE6MSBwaXhlbCByYXRpbywgd2UgaGFuZGxlIHNjYWxpbmcgdmlhIHNldFNpemUKICAgICAgICBfcmVuZGVyZXIuYXV0b0NsZWFyID0gZmFsc2U7IC8vIFdlIG1hbmFnZSBjbGVhcmluZyB2aWEgYmFja2dyb3VuZCBvciBtYW51YWwgY2FsbHMgaWYgbmVlZGVkICh0aG91Z2ggc2NlbmUuYmFja2dyb3VuZCBoYW5kbGVzIGNvbG9yKQogICAgICAgIC8vIEV4cG9zZSByZW5kZXJlciBmb3IgRGV2VG9vbHMKICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSBfZ2FtZU1hbmFnZXIucmVuZGVyZXIgPSBfcmVuZGVyZXI7IAogICAgICAgIGVsc2Ugd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID0geyByZW5kZXJlcjogX3JlbmRlcmVyIH07IC8vIFRlbXAgaG9vawpfY29udGFpbmVyLmFwcGVuZENoaWxkKF9yZW5kZXJlci5kb21FbGVtZW50KTsKCi8vIC0tLSBWaWRlbyBPdmVybGF5IEVuZm9yY2VtZW50IC0tLQogICAgICAgIC8vIC0tLSBPdmVybGF5IFZpZGVvIExvZ2ljIFJlbW92ZWQgKFN3aXRjaGVkIHRvIEdJRikgLS0tCiAgICAgICAgLy8gNS4gRW52aXJvbm1lbnQKICAgICAgICBjcmVhdGVQYXJ0aWNsZXMoKTsKICAgICAgICBjcmVhdGVBcmVuYSgpOwoKLy8gNS41IEdhbWUgTWFuYWdlcgpfZ2FtZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguR2FtZU1hbmFnZXIoX3NjZW5lLCAndWktbGF5ZXInLCBfY2FtZXJhLCBfcmVuZGVyZXIpOwogICAgICAgIAogICAgICAgIC8vIDUuNS4xIEF1ZGlvIE1hbmFnZXIKICAgICAgICBfYXVkaW9NYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkF1ZGlvTWFuYWdlcigpOwogICAgICAgIF9nYW1lTWFuYWdlci5hdWRpb01hbmFnZXIgPSBfYXVkaW9NYW5hZ2VyOwoKICAgICAgICAvLyA1LjYgQ2FtZXJhIE1hbmFnZXIKICAgICAgICBfY2FtZXJhTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5DYW1lcmFNYW5hZ2VyKF9jYW1lcmEsIF9zY2VuZSk7CiAgICAgICAgX2dhbWVNYW5hZ2VyLmNhbWVyYU1hbmFnZXIgPSBfY2FtZXJhTWFuYWdlcjsKCiAgICAgICAgLy8gNS43IERldiBUb29scwppZiAod2luZG93LmZsdXguRGV2VG9vbHMpIHsKICAgICAgICAgICAgbmV3IHdpbmRvdy5mbHV4LkRldlRvb2xzKF9nYW1lTWFuYWdlcik7CiAgICAgICAgfQovLyA1LjggV2F0ZXIgT3ZlcmxheSwgTGlnaHQgU2hhZnRzLCBTdGFkaXVtLCBHbHlwaHMKICAgICAgICBfd2F0ZXJPdmVybGF5ID0gbmV3IHdpbmRvdy5mbHV4LldhdGVyT3ZlcmxheShfY2FtZXJhKTsKICAgICAgICBfbGlnaHRTaGFmdHMgPSBuZXcgd2luZG93LmZsdXguTGlnaHRTaGFmdHMoX3NjZW5lKTsKICAgICAgICBfc3RhZGl1bSA9IG5ldyB3aW5kb3cuZmx1eC5TdGFkaXVtKF9zY2VuZSk7CiAgICAgICAgX2dseXBoTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5HbHlwaE1hbmFnZXIoX3NjZW5lKTsKICAgICAgICAKaWYgKF9nYW1lTWFuYWdlcikgewogICAgICAgICAgICBfZ2FtZU1hbmFnZXIuZ2x5cGhNYW5hZ2VyID0gX2dseXBoTWFuYWdlcjsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLndhdGVyT3ZlcmxheSA9IF93YXRlck92ZXJsYXk7CiAgICAgICAgICAgIF9nYW1lTWFuYWdlci5saWdodFNoYWZ0cyA9IF9saWdodFNoYWZ0czsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnN0YWRpdW0gPSBfc3RhZGl1bTsKICAgICAgICB9CiAgICAgICAgLy8gNi4gVGVhbXMgU2V0dXAKICAgICAgICBfaG9tZVRlYW0gPSBuZXcgd2luZG93LmZsdXguVGVhbShfc2NlbmUsICdob21lJywgMSwgMHgwMGFhZmYsIHRydWUpOwogICAgICAgIF9hd2F5VGVhbSA9IG5ldyB3aW5kb3cuZmx1eC5UZWFtKF9zY2VuZSwgJ2F3YXknLCAtMSwgMHhmZjY2NjYsIGZhbHNlKTsKCiAgICAgICAgLy8gNy4gQmFsbAogICAgICAgIF9iYWxsID0gbmV3IHdpbmRvdy5mbHV4LkJhbGwoX3NjZW5lKTsKCiAgICAgICAgLy8gSU1QUk9WRUQ6IExpbmsgYmFsbCB0byBjYW1lcmEgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICBfY2FtZXJhTWFuYWdlci5zZXRCYWxsKF9iYWxsKTsKCiAgICAgICAgLy8gOC4gVGVhbSBSb3N0ZXIgTW9kZWxzCiAgICAgICAgY29uc3Qgcm9sZXMgPSBbJ0xGJywgJ1JGJywgJ01GJywgJ0xEJywgJ1JEJywgJ0dMJ107CiAgICAgICAgY29uc3QgaG9tZVJvc3RlciA9IHsKICAgICAgICAgICAgTEY6IHsgbmFtZTogJ1RpZHVzJywgdXJsOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2RhNzg4YmVmMjU4YzRmMGI4ZDllZjFhY2MxOWM1NTY3LmdsYicgfSwKICAgICAgICAgICAgUkY6IHsgbmFtZTogJ1dha2thJywgdXJsOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzLzU5MTE0Yzk4OTUxNjQ3YzliOGRhNzRiMGJkMzYzNmNiLmdsYicgfSwKICAgICAgICAgICAgTUY6IHsgbmFtZTogJ0xldHR5JywgdXJsOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzLzQzYWNlMzRjNmZkOTQyMTU5NjdlODQyYmY5MDlkYTVlLmdsYicgfSwKICAgICAgICAgICAgTEQ6IHsgbmFtZTogJ0RhdHRvJywgdXJsOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2U2ZDY3ZWNiMmU0YzQ3MTViZDczYTQwNzk1ZTFkM2Q1LmdsYicgfSwKICAgICAgICAgICAgUkQ6IHsgbmFtZTogJ0phc3N1JywgdXJsOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzLzgyMTY0NTk1NjczNTRlNjM5NThkNDEwOGQ4MjhkZTk4LmdsYicgfSwKICAgICAgICAgICAgR0w6IHsgbmFtZTogJ0JvdHRhJywgdXJsOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2FkMTU1ZWZlZGMwZDQ4ZmRhZDA5ZGEzZTFjYWU5Yzk3LmdsYicgfQogICAgICAgIH07CgogICAgICAgIGNvbnN0IGFwcGx5U3RhdHMgPSAocCwgcm9sZSwgaXNIb21lKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHRlYW1MZXZlbCA9IGlzSG9tZSA/IDI1IDogMjI7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LlRlYW0uZ2VuZXJhdGVTdGF0cyhwLCByb2xlLCB0ZWFtTGV2ZWwsIGlzSG9tZSk7CgogICAgICAgICAgICBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDU7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNQICs9IDM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDM7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkVOICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdCcm90aGVyJykpIHsKICAgICAgICAgICAgICAgIHAuc3RhdHMuU1AgPSA5OTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcC5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CiAgICAgICAgfTsKCiAgICAgICAgbGV0IGhvbWVMb2FkZWQgPSAwOwogICAgICAgIGNvbnN0IHJvbGVHbHRmcyA9IHt9OwoKICAgICAgICBjb25zdCBmaW5hbGl6ZVRlYW1zID0gKCkgPT4gewogICAgICAgICAgICByb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZ2x0ZiA9IHJvbGVHbHRmc1tyb2xlXSB8fCByb2xlR2x0ZnMuTEY7CgogICAgICAgICAgICAgICAgY29uc3QgcCA9IChyb2xlID09PSAnR0wnKQogICAgICAgICAgICAgICAgICAgID8gbmV3IHdpbmRvdy5mbHV4LkdvYWxpZShfc2NlbmUsIHJvbGUpCiAgICAgICAgICAgICAgICAgICAgOiBuZXcgd2luZG93LmZsdXguQUlQbGF5ZXIoX3NjZW5lLCByb2xlKTsKCiAgICAgICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgICAgICBwLmNoYXJhY3Rlck5hbWUgPSBlbnRyeSA/IGBDUFUgJHtlbnRyeS5uYW1lfWAgOiAnQ1BVJzsKICAgICAgICAgICAgICAgIGFwcGx5U3RhdHMocCwgcm9sZSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmICYmIGdsdGYuc2NlbmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjbG9uZSA9IFRIUkVFLlNrZWxldG9uVXRpbHMuY2xvbmUoZ2x0Zi5zY2VuZSk7CiAgICAgICAgICAgICAgICAgICAgcC5zZXRNZXNoKGNsb25lLCBnbHRmLmFuaW1hdGlvbnMgfHwgW10pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ01pc3NpbmcgR0xURiBmb3IgYXdheSByb2xlOicsIHJvbGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS5hZGRQbGF5ZXIocCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYWxsUGxheWVycyA9IFsuLi5faG9tZVRlYW0ucGxheWVycywgLi4uX2F3YXlUZWFtLnBsYXllcnNdOwogICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAocC5iYWxsUmVmID09PSBudWxsKSBwLmJhbGxSZWYgPSBfYmFsbDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyID0gX2hvbWVUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy50YWNrbGUgPSAndmVub20nOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy5zaG9vdCA9ICdzcGhlcmUnOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0VxdWlwcGVkIEhvbWUgTUYgd2l0aCBWZW5vbSBUYWNrbGUgJiBTcGhlcmUgU2hvdCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBhd2F5TUYgPSBfYXdheVRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgaWYgKGF3YXlNRikgewogICAgICAgICAgICAgICAgYXdheU1GLnRlY2hzLnRhY2tsZSA9ICd3aXRoZXInOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF9hd2F5VGVhbS5zZXRGb3JtYXRpb24oJ0NvdW50ZXInKTsKCiAgICAgICAgICAgIGNvbnN0IGF3YXlHTCA9IF9hd2F5VGVhbS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICBpZiAoYXdheUdMKSB7CiAgICAgICAgICAgICAgICBhd2F5R0wudGVjaHMuYWN0aXZlID0gJ3N1cGVyX2dvYWxpZSc7CiAgICAgICAgICAgICAgICBhd2F5R0wudGVjaHMucGFzc2l2ZSA9ICdncmlwX2dsb3Zlcyc7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRXF1aXBwZWQgQXdheSBHTCB3aXRoIFN1cGVyIEdvYWxpZScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfaG9tZVRlYW0uYXNzaWduTWFya3MoX2F3YXlUZWFtKTsKICAgICAgICAgICAgX2F3YXlUZWFtLmFzc2lnbk1hcmtzKF9ob21lVGVhbSk7CgogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9hZGluZycpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci5yZWdpc3RlclRlYW1zKF9ob21lVGVhbSwgX2F3YXlUZWFtLCBfYmFsbCk7CgogICAgICAgICAgICAgICAgX21lbnVNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4Lk1lbnVNYW5hZ2VyKF9nYW1lTWFuYWdlcik7CiAgICAgICAgICAgICAgICBfbWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCnJvbGVzLmZvckVhY2gocm9sZSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGVudHJ5ID0gaG9tZVJvc3Rlcltyb2xlXTsKICAgICAgICAgICAgaWYgKCFlbnRyeSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb25Db21wbGV0ZSA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGhvbWVMb2FkZWQrKzsKICAgICAgICAgICAgICAgIGlmIChob21lTG9hZGVkID49IHJvbGVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGZpbmFsaXplVGVhbXMoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbChlbnRyeS51cmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgICAgICByb2xlR2x0ZnNbcm9sZV0gPSBnbHRmOwoKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSAocm9sZSA9PT0gJ0dMJykKICAgICAgICAgICAgICAgICAgICA/IG5ldyB3aW5kb3cuZmx1eC5Hb2FsaWUoX3NjZW5lLCByb2xlKQogICAgICAgICAgICAgICAgICAgIDogbmV3IHdpbmRvdy5mbHV4LkFJUGxheWVyKF9zY2VuZSwgcm9sZSk7CgogICAgICAgICAgICAgICAgcC5jaGFyYWN0ZXJOYW1lID0gZW50cnkubmFtZTsKICAgICAgICAgICAgICAgIGFwcGx5U3RhdHMocCwgcm9sZSwgdHJ1ZSk7CgogICAgICAgICAgICAgICAgY29uc3QgY2xvbmUgPSBUSFJFRS5Ta2VsZXRvblV0aWxzLmNsb25lKGdsdGYuc2NlbmUpOwogICAgICAgICAgICAgICAgcC5zZXRNZXNoKGNsb25lLCBnbHRmLmFuaW1hdGlvbnMpOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFkZFBsYXllcihwKTsKCiAgICAgICAgICAgICAgICBvbkNvbXBsZXRlKCk7CiAgICAgICAgICAgIH0sIHVuZGVmaW5lZCwgKGVycikgPT4gewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGxvYWQgbW9kZWwnLCBlbnRyeS5uYW1lLCBlbnRyeS51cmwsIGVycik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIE1lc2ggKFJlZCBCb3gpCiAgICAgICAgICAgICAgICBjb25zdCBmYWxsYmFja0dlbyA9IG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSgxLCAyLCAxKTsKICAgICAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmYwMDAwLCB3aXJlZnJhbWU6IHRydWUgfSk7CiAgICAgICAgICAgICAgICBjb25zdCBmYWxsYmFja01lc2ggPSBuZXcgVEhSRUUuTWVzaChmYWxsYmFja0dlbywgZmFsbGJhY2tNYXQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTdG9yZSBkdW1teSBpbiByb2xlR2x0ZnMgZm9yIGF3YXkgdGVhbSBjbG9uaW5nCiAgICAgICAgICAgICAgICByb2xlR2x0ZnNbcm9sZV0gPSB7IHNjZW5lOiBmYWxsYmFja01lc2gsIGFuaW1hdGlvbnM6IFtdIH07CgogICAgICAgICAgICAgICAgY29uc3QgcCA9IChyb2xlID09PSAnR0wnKQogICAgICAgICAgICAgICAgICAgID8gbmV3IHdpbmRvdy5mbHV4LkdvYWxpZShfc2NlbmUsIHJvbGUpCiAgICAgICAgICAgICAgICAgICAgOiBuZXcgd2luZG93LmZsdXguQUlQbGF5ZXIoX3NjZW5lLCByb2xlKTsKCiAgICAgICAgICAgICAgICBwLmNoYXJhY3Rlck5hbWUgPSBlbnRyeS5uYW1lICsgIiAoRXJyb3IpIjsKICAgICAgICAgICAgICAgIGFwcGx5U3RhdHMocCwgcm9sZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHAuc2V0TWVzaChmYWxsYmFja01lc2guY2xvbmUoKSwgW10pOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFkZFBsYXllcihwKTsKCiAgICAgICAgICAgICAgICBvbkNvbXBsZXRlKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICAvLyA4LiBJbnB1dAogICAgICAgIHNldHVwSW5wdXRzKCk7CgogICAgICAgIC8vIDkuIExvb3AKICAgICAgICBfY2xvY2sgPSBuZXcgVEhSRUUuQ2xvY2soKTsKICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoYW5pbWF0ZSk7CgogICAgICAgIC8vIEhhbmRsZSByZXNpemUKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgb25SZXNpemUpOwogICAgICAgIG9uUmVzaXplKCk7CiAgICB9CgpmdW5jdGlvbiBjcmVhdGVQYXJ0aWNsZXMoKSB7CiAgICAgICAgY29uc3QgY291bnQgPSAxNTAwOyAvLyBJbmNyZWFzZWQgY291bnQKICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgIGNvbnN0IHZlcnRpY2VzID0gW107CiAgICAgICAgY29uc3Qgb2Zmc2V0cyA9IFtdOyAvLyBSYW5kb20gb2Zmc2V0cyBmb3IgaW5kZXBlbmRlbnQgYm9iYmluZwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICAgICAgdmVydGljZXMucHVzaCgKICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDgwLCAvLyBXaWRlciBzcHJlYWQgWAogICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogNTAsIC8vIFdpZGVyIHNwcmVhZCBZCiAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA4MCAgLy8gV2lkZXIgc3ByZWFkIFoKICAgICAgICAgICAgKTsKICAgICAgICAgICAgb2Zmc2V0cy5wdXNoKE1hdGgucmFuZG9tKCkgKiAxMDApOwogICAgICAgIH0KCiAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCdwb3NpdGlvbicsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKHZlcnRpY2VzLCAzKSk7CiAgICAgICAgZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCdhT2Zmc2V0JywgbmV3IFRIUkVFLkZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUob2Zmc2V0cywgMSkpOwoKICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgIHVuaWZvcm1zOiBfcGFydGljbGVVbmlmb3JtcywKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IGFPZmZzZXQ7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZBbHBoYTsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWMzIHBvcyA9IHBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgIC8vIEJvYmJpbmcgbW90aW9uOiBTaW5lIHdhdmUgYmFzZWQgb24gdGltZSArIHJhbmRvbSBvZmZzZXQKICAgICAgICAgICAgICAgICAgICBmbG9hdCBib2IgPSBzaW4odVRpbWUgKiAwLjUgKyBhT2Zmc2V0KSAqIDIuMDsKICAgICAgICAgICAgICAgICAgICBwb3MueSArPSBib2I7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdmVjNCBtdlBvc2l0aW9uID0gbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3MsIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbXZQb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTaXplIGF0dGVudWF0aW9uIC0gU21hbGwgYW5kIHNoaW1tZXJ5CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc2l6ZUJhc2UgPSAyLjAgKyBzaW4odVRpbWUgKiAzLjAgKyBhT2Zmc2V0KSAqIDEuMDsgCiAgICAgICAgICAgICAgICAgICAgZ2xfUG9pbnRTaXplID0gc2l6ZUJhc2UgKiAoMjAuMCAvIC1tdlBvc2l0aW9uLnopOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhZGUgYmFzZWQgb24gZGlzdGFuY2UvaGVpZ2h0CiAgICAgICAgICAgICAgICAgICAgdkFscGhhID0gMC41ICsgMC41ICogc2luKHVUaW1lICogMi4wICsgYU9mZnNldCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAsCiAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZBbHBoYTsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTb2Z0IGdsb3cgcGFydGljbGUgKER1c3QgbW90ZSkKICAgICAgICAgICAgICAgICAgICB2ZWMyIGNvb3JkID0gZ2xfUG9pbnRDb29yZCAtIHZlYzIoMC41KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkaXN0ID0gbGVuZ3RoKGNvb3JkKTsKICAgICAgICAgICAgICAgICAgICBpZihkaXN0ID4gMC41KSBkaXNjYXJkOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFNvZnQgZmFsbG9mZiBmb3Igc2hpbW1lcgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHN0cmVuZ3RoID0gMS4wIC0gKGRpc3QgKiAyLjApOwogICAgICAgICAgICAgICAgICAgIHN0cmVuZ3RoID0gcG93KHN0cmVuZ3RoLCAyLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEN5YW4vQmx1ZSB0aW50LCBhZGRpdGl2ZSBmZWVsCiAgICAgICAgICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNCgwLjcsIDAuOSwgMS4wLCB2QWxwaGEgKiBzdHJlbmd0aCAqIDAuOCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgcG9pbnRzID0gbmV3IFRIUkVFLlBvaW50cyhnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgIHBvaW50cy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgX3NjZW5lLmFkZChwb2ludHMpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlQXJlbmEoKSB7CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuU3BoZXJlR2VvbWV0cnkoX2NvbmZpZy5hcmVuYVJhZGl1cywgMzIsIDMyKTsKICAgICAgICAKICAgICAgICBjb25zdCB0ZXhMb2FkZXIgPSBuZXcgVEhSRUUuVGV4dHVyZUxvYWRlcigpOwogICAgICAgIGNvbnN0IGFyZW5hVGV4ID0gdGV4TG9hZGVyLmxvYWQoJ2h0dHBzOi8vaS5wb3N0aW1nLmNjL1cxTHNINjhRL2ZpbGUtMDAwMDAwMDAyM2VjNzFmNTk2NTkzODI5ZTgxMTg3NjAtKDEpLnBuZycpOwogICAgICAgIGFyZW5hVGV4Lm1hZ0ZpbHRlciA9IFRIUkVFLk5lYXJlc3RGaWx0ZXI7CiAgICAgICAgYXJlbmFUZXgubWluRmlsdGVyID0gVEhSRUUuTmVhcmVzdEZpbHRlcjsKICAgICAgICBhcmVuYVRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGFyZW5hVGV4LndyYXBUID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgYXJlbmFUZXgucmVwZWF0LnNldCg2LCA0KTsKCiAgICAgICAgLy8gLS0tIFByb2NlZHVyYWwgSGV4IFRleHR1cmUgKElubmVyIExheWVyKSAtLS0KICAgICAgICBjb25zdCBoZXhUZXggPSAoKCkgPT4gewogICAgICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgICAgIGMud2lkdGggPSA1MTI7IGMuaGVpZ2h0ID0gNTEyOwogICAgICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgIC8vIFRyYW5zcGFyZW50IGJhY2tncm91bmQKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLDAsNTEyLDUxMik7CiAgICAgICAgICAgIAogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgwLCAyNTUsIDI1NSwgMC44KSc7CiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgICAgICBjdHguc2hhZG93Qmx1ciA9IDEwOwogICAgICAgICAgICBjdHguc2hhZG93Q29sb3IgPSAnIzAwZmZmZic7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCByID0gNjQ7CiAgICAgICAgICAgIGNvbnN0IHcgPSByICogMjsKICAgICAgICAgICAgY29uc3QgaCA9IE1hdGguc3FydCgzKSAqIHI7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEcmF3IEhleGVzCiAgICAgICAgICAgIGZvcihsZXQgeSA9IC0xOyB5IDwgNTEyL2ggKyAyOyB5KyspIHsKICAgICAgICAgICAgICAgIGZvcihsZXQgeCA9IC0xOyB4IDwgNTEyLyh3KjAuNzUpICsgMjsgeCsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3ggPSB4ICogdyAqIDAuNzU7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3kgPSB5ICogaCArICh4JTI9PT0wID8gMCA6IGgvMik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDY7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmcgPSBNYXRoLlBJLzMgKiBpOwogICAgICAgICAgICAgICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYW5nKSpyLCBjeSArIE1hdGguc2luKGFuZykqcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ2VudGVyIGRvdAogICAgICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgwLCAxMDAsIDI1NSwgMC4zKSc7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKGN4LCBjeSwgNSwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICAgICAgfSkoKTsKICAgICAgICBoZXhUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBoZXhUZXgud3JhcFQgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBoZXhUZXgucmVwZWF0LnNldCg0LCAyKTsKCiAgICAgICAgLy8gLS0tIEFyZW5hIDEgKE91dGVyIEdyaWQpIC0tLQogICAgICAgIGNvbnN0IG1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiBhcmVuYVRleCwKICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLAogICAgICAgICAgICB3aXJlZnJhbWU6IGZhbHNlLAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKb3BhY2l0eTogMC4zLCAKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgY29uc3QgYXJlbmEgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgIF9zY2VuZS5hZGQoYXJlbmEpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaCA9IGFyZW5hOwoKICAgICAgICAvLyAtLS0gQXJlbmEgMiAoSW5uZXIgSGV4ICsgSW1wYWN0IFNoYWRlcikgLS0tCiAgICAgICAgLy8gV2UgdXNlIGEgY3VzdG9tIHNoYWRlciB0byB3YXJwIHZlcnRpY2VzIG9uIGltcGFjdAogICAgICAgIGNvbnN0IGFyZW5hVW5pZm9ybXMgPSBUSFJFRS5Vbmlmb3Jtc1V0aWxzLm1lcmdlKFsKICAgICAgICAgICAgVEhSRUUuVW5pZm9ybXNMaWJbJ2NvbW1vbiddLAogICAgICAgICAgICBfYXJlbmFVbmlmb3JtcywKICAgICAgICAgICAgeyAKICAgICAgICAgICAgICAgIHRNYXA6IHsgdmFsdWU6IGhleFRleCB9LAp1T3BhY2l0eTogeyB2YWx1ZTogMC4yNSB9IC8vIEV4cG9zZWQgdW5pZm9ybQogICAgICAgICAgICB9CiAgICAgICAgXSk7CgogICAgICAgIGNvbnN0IG1hdGVyaWFsMiA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgIHVuaWZvcm1zOiBhcmVuYVVuaWZvcm1zLAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgc2lkZTogVEhSRUUuQmFja1NpZGUsCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMzIHVJbXBhY3RQb3M7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVJbXBhY3RTdHI7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdlV2OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdlV2ID0gdXY7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJbXBhY3QgTG9naWMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkaXN0ID0gZGlzdGFuY2UocG9zLCB1SW1wYWN0UG9zKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYWRpdXMgPSAyMC4wOyAvLyBSYWRpdXMgb2YgZGVmb3JtYXRpb24KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHJhZGl1cykgewogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCB0ID0gZGlzdCAvIHJhZGl1czsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgYnVsZ2UgPSAoMS4wIC0gdCkgKiAoMS4wIC0gdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHJpcHBsZSA9IHNpbih0ICogMTAuMCAtIHVUaW1lICogNS4wKSAqIDAuMTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBub3JtYWwgPSBub3JtYWxpemUocG9zKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zICs9IG5vcm1hbCAqIChidWxnZSAqIHVJbXBhY3RTdHIpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3MsIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAsCiAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIHNhbXBsZXIyRCB0TWFwOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1SW1wYWN0U3RyOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWM0IHRleENvbG9yID0gdGV4dHVyZTJEKHRNYXAsIHZVdik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQmFzZSBvcGFjaXR5ICsgSW1wYWN0IEhpZ2hsaWdodAogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gdU9wYWNpdHkgKiB0ZXhDb2xvci5hOwogICAgICAgICAgICAgICAgICAgIGFscGhhICs9IHVJbXBhY3RTdHIgKiAwLjAyOyAKCiAgICAgICAgICAgICAgICAgICAgLy8gVGludCBDeWFuL0JsdWUKICAgICAgICAgICAgICAgICAgICB2ZWMzIGNvbG9yID0gdGV4Q29sb3IucmdiICogdmVjMygwLjUsIDEuMCwgMS4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTY2FubGluZSBlZmZlY3QKICAgICAgICAgICAgICAgICAgICBmbG9hdCBzY2FuID0gc2luKHZVdi55ICogMTAwLjAgKyB1SW1wYWN0U3RyKSAqIDAuMTsKICAgICAgICAgICAgICAgICAgICBjb2xvciArPSBzY2FuOwoKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbG9yLCBhbHBoYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgYXJlbmEyID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsMik7CiAgICAgICAgYXJlbmEyLnNjYWxlLnNldFNjYWxhcigwLjk4KTsgLy8gU2xpZ2h0bHkgc21hbGxlcgogICAgICAgIF9zY2VuZS5hZGQoYXJlbmEyKTsKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyID0gYXJlbmEyOwogICAgICAgIC8vIC0tLSBORVc6IEZGWCBHT0FMIE1PREVMUyAtLS0KICAgICAgICBjb25zdCBnb2FsVXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hNTE2YmQ5MGZhN2M0ZGVkYjVkY2JmZGY4MDNmMTNkNS5nbGInOwogICAgICAgIAogICAgICAgIGNvbnN0IG9uR29hbExvYWRlZCA9IChtb2RlbCwgaXNGYWxsYmFjaykgPT4gewogICAgICAgICAgICBjb25zdCBnb2FsQSA9IG1vZGVsOwogICAgICAgICAgICAvLyBNb3ZlZCBkb3duIH4xNWZ0ICg0LjVtKSB0b3RhbCBhcyByZXF1ZXN0ZWQKLy8gTW92ZWQgZG93biB+MTVmdCAoNC41bSkgdG90YWwgYXMgcmVxdWVzdGVkLCBwdXNoZWQgYmFjayB0byBlZGdlCiAgICAgICAgICAgIGdvYWxBLnBvc2l0aW9uLnNldCgwLCAtNC41LCAtNDYpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFpc0ZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBnb2FsQS5zY2FsZS5zZXRTY2FsYXIoNTQuMCk7IC8vIEluY3JlYXNlZCA1MCUgKHdhcyAzNi4wKQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFNldHVwIEdvYWwgQQogICAgICAgICAgICBnb2FsQS50cmF2ZXJzZShjID0+IHsKICAgICAgICAgICAgICAgIGlmKGMuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgYy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7IC8vIENSSVRJQ0FMOiBQcmV2ZW50IGN1bGxpbmcKICAgICAgICAgICAgICAgICAgICBjLnJlbmRlck9yZGVyID0gMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgbWF0ZXJpYWwgaXMgdmlzaWJsZQogICAgICAgICAgICAgICAgICAgIGlmIChjLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZmZmZmKTsgLy8gV2hpdGUgdG8gc2hvdyBvcmlnaW5hbCB0ZXh0dXJlL2NvbG9ycyAod2FzIGJsdWUpCiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwudHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLnNpZGUgPSBUSFJFRS5Eb3VibGVTaWRlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmRlcHRoV3JpdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmRlcHRoVGVzdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgX3NjZW5lLmFkZChnb2FsQSk7CgogICAgICAgICAgICAvLyBTZXR1cCBHb2FsIEIKICAgICAgICAgICAgY29uc3QgZ29hbEIgPSBpc0ZhbGxiYWNrID8gZ29hbEEuY2xvbmUoKSA6IFRIUkVFLlNrZWxldG9uVXRpbHMuY2xvbmUoZ29hbEEpOwoKZ29hbEIucG9zaXRpb24uc2V0KDAsIC00LjUsIDQ2KTsgLy8gTW92ZWQgY2xvc2VyICh3YXMgNDUpIGFuZCBkb3duCiAgICAgICAgICAgIGdvYWxCLnJvdGF0aW9uLnkgPSBNYXRoLlBJOwogICAgICAgICAgICAvLyBFbnN1cmUgR29hbCBCIG1lc2hlcyBhcmUgYWxzbyBwZXJzaXN0ZW50CiAgICAgICAgICAgIGdvYWxCLnRyYXZlcnNlKGMgPT4gewogICAgICAgICAgICAgICAgaWYoYy5pc01lc2gpIGMuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIF9zY2VuZS5hZGQoZ29hbEIpOwogICAgICAgIH07CgogICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbChnb2FsVXJsLCAoZ2x0ZikgPT4gewogICAgICAgICAgICBvbkdvYWxMb2FkZWQoZ2x0Zi5zY2VuZSwgZmFsc2UpOwogICAgICAgIH0sIHVuZGVmaW5lZCwgKGVycikgPT4gewogICAgICAgICAgICBjb25zb2xlLndhcm4oIkdvYWwgbW9kZWwgZmFpbGVkIHRvIGxvYWQuIFVzaW5nIGZhbGxiYWNrLiIsIGVycik7CiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSg3NSwgNDUsIDEwKTsgLy8gRmFsbGJhY2sgbWFzc2l2ZSBib3ggKFNjYWxlZCAxLjV4KQogICAgICAgICAgICBjb25zdCBmYWxsYmFja01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmZmZmZiwgd2lyZWZyYW1lOiB0cnVlIH0pOwogICAgICAgICAgICBjb25zdCBmYWxsYmFjayA9IG5ldyBUSFJFRS5NZXNoKGdlbywgZmFsbGJhY2tNYXQpOwogICAgICAgICAgICBvbkdvYWxMb2FkZWQoZmFsbGJhY2ssIHRydWUpOwogICAgICAgIH0pOwoKICAgICAgICAvLyAtLS0gTkVXOiBNQVNTSVZFIEZJRUxEIE1BUktJTkdTIC0tLQogICAgICAgIGNyZWF0ZUZpZWxkTWFya2luZ3MoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVGaWVsZE1hcmtpbmdzKCkgewogICAgICAgIGNvbnN0IHNpemUgPSAxMDI0OwogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gc2l6ZTsgYy5oZWlnaHQgPSBzaXplOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBjeCA9IHNpemUvMjsgY29uc3QgY3kgPSBzaXplLzI7CgogICAgICAgIC8vIEhlbHBlciB0byBkcmF3CiAgICAgICAgY29uc3QgZHJhdyA9ICgpID0+IHsKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBzaXplLCBzaXplKTsKCiAgICAgICAgICAgIC8vIEdsb3cgU2V0dGluZ3MKICAgICAgICAgICAgY3R4LnNoYWRvd0JsdXIgPSAyMDsKICAgICAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gJyMwMGZmZmYnOwogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgxMDAsIDI1NSwgMjU1LCAwLjkpJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDU7CiAgICAgICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKCiAgICAgICAgICAgIC8vIDEuIE1haW4gRmllbGQgQ2lyY2xlIChUaGUgU3BoZXJlIEVxdWF0b3IpCiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDQ1MCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgLy8gMi4gSW5uZXIgRGVjb3JhdGl2ZSBSaW5nCiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDQyMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDAsIDIwMCwgMjU1LCAwLjUpJzsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgLy8gMy4gQ2VudGVyIEJsaXR6b2ZmIFpvbmUgKENvbXBsZXggU3Rhci9SdW5lKQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45KSc7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDgwLCAwLCBNYXRoLlBJKjIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbm5lciBTdGFyIFBhdHRlcm4KICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw1OyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGEgPSAoaS81KSpNYXRoLlBJKjIgLSBNYXRoLlBJLzI7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gY3ggKyBNYXRoLmNvcyhhKSo2MDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjeSArIE1hdGguc2luKGEpKjYwOwogICAgICAgICAgICAgICAgaWYoaT09PTApIGN0eC5tb3ZlVG8oeCx5KTsgZWxzZSBjdHgubGluZVRvKHgseSk7CiAgICAgICAgICAgICAgICAvLyBJbm5lciBwb2ludAogICAgICAgICAgICAgICAgY29uc3QgYTIgPSAoKGkrMC41KS81KSpNYXRoLlBJKjIgLSBNYXRoLlBJLzI7CiAgICAgICAgICAgICAgICBjb25zdCB4MiA9IGN4ICsgTWF0aC5jb3MoYTIpKjI1OwogICAgICAgICAgICAgICAgY29uc3QgeTIgPSBjeSArIE1hdGguc2luKGEyKSoyNTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeDIseTIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgLy8gNC4gTWlkZmllbGQgTGluZQogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oMCwgY3kpOyBjdHgubGluZVRvKHNpemUsIGN5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgLy8gNS4gR29hbCBCb3hlcyAoVHJhcGV6b2lkcykKICAgICAgICAgICAgY29uc3QgZHJhd0dvYWxCb3ggPSAoeVBvcywgZGlyKSA9PiB7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKGN4IC0gMTUwLCB5UG9zKTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oY3ggKyAxNTAsIHlQb3MpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIDIyNSwgeVBvcyArIChkaXIgKiAxMjApKTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oY3ggLSAyMjUsIHlQb3MgKyAoZGlyICogMTIwKSk7CiAgICAgICAgICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGRyYXdHb2FsQm94KDUwLCAxKTsgLy8gVG9wIChIb21lIHNpZGUgaW4gdGV4dHVyZSBzcGFjZSkKICAgICAgICAgICAgZHJhd0dvYWxCb3goc2l6ZS01MCwgLTEpOyAvLyBCb3R0b20KCiAgICAgICAgICAgIC8vIDYuIFJ1bmVzIChQcm9jZWR1cmFsIFRleHQgUmluZykKICAgICAgICAgICAgLy8gVXNlIFNwaXJhIGZvbnQgaWYgbG9hZGVkLCBmYWxsYmFjayB0byBtb25vc3BhY2UKICAgICAgICAgICAgY3R4LmZvbnQgPSAnMzJweCBTcGlyYSwgbW9ub3NwYWNlJzsgCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgwLCAyNTUsIDI1NSwgMC43KSc7CiAgICAgICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICAgICAgY3R4LnRleHRCYXNlbGluZSA9ICdtaWRkbGUnOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcnVuZXMgPSAiQkxJVFpCQUxMIFNQSEVSRSBQT09MIFpBTkFSS0FORCBBQllTUyBFVEVSTkFMIENBTE0gIjsKICAgICAgICAgICAgY29uc3QgcnVuZUNvdW50ID0gMzI7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHJ1bmVDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gcnVuZUNvdW50KSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgY29uc3QgciA9IDQ4MDsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBjeCArIE1hdGguY29zKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gY3kgKyBNYXRoLnNpbihhbmdsZSkgKiByOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICAgICAgY3R4LnRyYW5zbGF0ZSh4LCB5KTsKICAgICAgICAgICAgICAgIGN0eC5yb3RhdGUoYW5nbGUgKyBNYXRoLlBJLzIpOwogICAgICAgICAgICAgICAgY29uc3QgY2hhciA9IHJ1bmVzW2kgJSBydW5lcy5sZW5ndGhdOwogICAgICAgICAgICAgICAgY3R4LmZpbGxUZXh0KGNoYXIsIDAsIDApOwogICAgICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdGV4ID0gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICAgICAgICAgIHRleC5hbmlzb3Ryb3B5ID0gMTY7CgogICAgICAgICAgICAvLyBGbG9vciBQbGFuZSAoRGVlcCkKLy8gRmxvb3IgUGxhbmUgKERlZXApCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDkwLCA5MCk7CiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBtYXA6IHRleCwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC44LAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjb25zdCBmaWVsZCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgbWF0KTsKICAgICAgICAgICAgZmllbGQucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICAgICAgZmllbGQucG9zaXRpb24ueSA9IC04LjA7IC8vIFN1bmsgZGVlcCBpbnRvIHRoZSBzcGhlcmUKICAgICAgICAgICAgX3NjZW5lLmFkZChmaWVsZCk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gQXR0ZW1wdCB0byBsb2FkIGZvbnQgZmlyc3QKICAgICAgICBkb2N1bWVudC5mb250cy5sb2FkKCczMnB4IFNwaXJhJykudGhlbigoKSA9PiB7CiAgICAgICAgICAgIGRyYXcoKTsKICAgICAgICB9KS5jYXRjaCgoKSA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiU3BpcmEgZm9udCBmYWlsZWQgdG8gbG9hZCBmb3IgY2FudmFzLCB1c2luZyBmYWxsYmFjay4iKTsKICAgICAgICAgICAgZHJhdygpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBGbG9hdGluZyBIb2xvZ3JhcGhpYyBSaW5ncyAoTWlkLWhlaWdodCkKICAgICAgICBjb25zdCByaW5nR2VvID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkoMjAsIDAuMSwgMTYsIDEwMCk7CiAgICAgICAgY29uc3QgcmluZ01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiwgdHJhbnNwYXJlbnQ6IHRydWUsIG9wYWNpdHk6IDAuMywgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcgfSk7CiAgICAgICAgY29uc3QgcmluZzEgPSBuZXcgVEhSRUUuTWVzaChyaW5nR2VvLCByaW5nTWF0KTsKICAgICAgICByaW5nMS5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDI7CiAgICAgICAgcmluZzEucG9zaXRpb24ueSA9IDA7CiAgICAgICAgX3NjZW5lLmFkZChyaW5nMSk7CiAgICAgICAgCiAgICAgICAgY29uc3QgcmluZzIgPSBuZXcgVEhSRUUuTWVzaChyaW5nR2VvLCByaW5nTWF0KTsKICAgICAgICByaW5nMi5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDI7CiAgICAgICAgcmluZzIuc2NhbGUuc2V0U2NhbGFyKDEuMik7CiAgICAgICAgcmluZzIucG9zaXRpb24ueSA9IDQuMDsKICAgICAgICBfc2NlbmUuYWRkKHJpbmcyKTsKCiAgICAgICAgLy8gQW5pbWF0ZSBSaW5ncyAoaW50ZWdyYXRlZCBpbnRvIG1haW4gbG9vcCB0byBhdm9pZCBhIHNlY29uZCBSQUYgb24gbW9iaWxlKQogICAgICAgIGxldCBfcmluZ1RpbWUgPSAwOwogICAgICAgIGNvbnN0IF9yaW5nVXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIF9yaW5nVGltZSArPSBkdDsKICAgICAgICAgICAgaWYgKHJpbmcxKSB7CiAgICAgICAgICAgICAgICByaW5nMS5yb3RhdGlvbi56ICs9IGR0ICogMC45OwogICAgICAgICAgICAgICAgcmluZzEuc2NhbGUuc2V0U2NhbGFyKDEuMCArIE1hdGguc2luKF9yaW5nVGltZSAqIDAuNSkgKiAwLjA1KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmluZzIpIHsKICAgICAgICAgICAgICAgIHJpbmcyLnJvdGF0aW9uLnogLT0gZHQgKiAwLjc1OwogICAgICAgICAgICAgICAgcmluZzIucG9zaXRpb24ueSA9IDQuMCArIE1hdGguY29zKF9yaW5nVGltZSAqIDAuNykgKiAxLjA7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGlmICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzKSB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLnB1c2goX3JpbmdVcGRhdGUpOwp9CgogICAgLy8gLS0tIElOUFVUIFNZU1RFTSAtLS0KLy8gLS0tIElOUFVUIFNZU1RFTSAtLS0KY29uc3QgX2tleXMgPSB7fTsKLy8gR2xvYmFscyBtb3ZlZCB0byBiZWxvdyBoZWxwZXIKCiAgICAvLyBIZWxwZXI6IEFuYWx5emUgY3VydmUgZ2VvbWV0cnkgZm9yIGFuYWxvZyBjb250cm9sCiAgICBjb25zdCBhbmFseXplU3dpcGVDdXJ2ZSA9IChwb2ludHMpID0+IHsKICAgICAgICBpZiAocG9pbnRzLmxlbmd0aCA8IDMpIHJldHVybiB7IGludGVuc2l0eTogMCwgc3BlZWQ6IDAsIGR4OiAwLCBkeTogMCB9OwogICAgICAgIAogICAgICAgIGNvbnN0IHBTdGFydCA9IHBvaW50c1swXTsKICAgICAgICBjb25zdCBwRW5kID0gcG9pbnRzW3BvaW50cy5sZW5ndGggLSAxXTsKICAgICAgICBjb25zdCBtaWRJZHggPSBNYXRoLmZsb29yKHBvaW50cy5sZW5ndGggLyAyKTsKICAgICAgICBjb25zdCBwTWlkID0gcG9pbnRzW21pZElkeF07CgogICAgICAgIGNvbnN0IGR4ID0gcEVuZC54IC0gcFN0YXJ0Lng7CiAgICAgICAgY29uc3QgZHkgPSBwRW5kLnkgLSBwU3RhcnQueTsKICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwogICAgICAgIGNvbnN0IGR0ID0gcEVuZC50IC0gcFN0YXJ0LnQ7CiAgICAgICAgY29uc3Qgc3BlZWQgPSAoZHQgPiAwKSA/IGRpc3QgLyBkdCA6IDA7IC8vIHB4L21zCgogICAgICAgIGlmIChkaXN0IDwgNTApIHJldHVybiB7IGludGVuc2l0eTogMCwgc3BlZWQ6IHNwZWVkLCBkeCwgZHkgfTsKCiAgICAgICAgY29uc3QgdlNNX3ggPSBwTWlkLnggLSBwU3RhcnQueDsKICAgICAgICBjb25zdCB2U01feSA9IHBNaWQueSAtIHBTdGFydC55OwoKICAgICAgICAvLyBDcm9zcyBwcm9kdWN0IGdpdmVzIHNpZ25lZCBhcmVhL2N1cnZhdHVyZSBkaXJlY3Rpb24KICAgICAgICBjb25zdCBjcm9zcyA9IChkeCAqIHZTTV95KSAtIChkeSAqIHZTTV94KTsKICAgICAgICAvLyBOb3JtYWxpemUgYnkgZGlzdGFuY2Ugc3F1YXJlZCB0byBnZXQgYSBjdXJ2YXR1cmUgcmF0aW8gaW5kZXBlbmRlbnQgb2Ygc2NhbGUKY29uc3QgaW50ZW5zaXR5ID0gY3Jvc3MgLyAoZGlzdCAqIGRpc3QpOwoKICAgICAgICByZXR1cm4geyBpbnRlbnNpdHksIHNwZWVkLCBkeCwgZHkgfTsKICAgIH07CiAgICBsZXQgX3N3aXBlUG9pbnRzID0gW107IC8vIFRyYWNrIHN3aXBlIGhpc3RvcnkgZm9yIGN1cnZlcwogICAgY29uc3QgX2FpbUlucHV0ID0geyB4OiAwLCB5OiAwLCBhY3RpdmU6IGZhbHNlIH07IC8vIE5FVzogQWltIGpveXN0aWNrCgogICAgY29uc3QgX2FjdGlvbkJ1ZmZlciA9IHsgYWN0aXZlOiBmYWxzZSwgdGltZXN0YW1wOiAwLCBkdXJhdGlvbjogMzAwIH07CgogICAgY29uc3QgX2NhbUZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfY2FtUmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3VwQXhpcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApOwoKICAgIGZ1bmN0aW9uIHNldHVwSW5wdXRzKCkgewogICAgICAgIC8vIEtleWJvYXJkCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICBfa2V5c1tlLmtleV0gPSB0cnVlOwogICAgICAgICAgICBpZiAoZS5jb2RlID09PSAnU3BhY2UnICYmIF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyICYmIF9iYWxsKSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLnRocm93QmFsbChfYmFsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gTkVXOiBUYWNrbGUgb24gU2hpZnQKICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ1NoaWZ0TGVmdCcgfHwgZS5jb2RlID09PSAnU2hpZnRSaWdodCcpIHsKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuZGFzaChwLmlucHV0VmVjdG9yLngsIHAuaW5wdXRWZWN0b3Iueik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CiAgICAgICAgfSk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgKGUpID0+IHsgX2tleXNbZS5rZXldID0gZmFsc2U7IHVwZGF0ZUlucHV0VmVjdG9yKCk7IH0pOwoKICAgICAgICAvLyAtLS0gRkxPQVRJTkcgSk9ZU1RJQ0sgKE1vdmVtZW50KSAtLS0KICAgICAgICBjb25zdCBoaXRab25lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2pveXN0aWNrLWhpdC16b25lJyk7CiAgICAgICAgY29uc3QgdmlzdWFscyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay12aXN1YWwtY29udGFpbmVyJyk7CiAgICAgICAgY29uc3QgYmFzZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1iYXNlJyk7CiAgICAgICAgY29uc3Qga25vYiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1rbm9iJyk7CgogICAgICAgIGxldCBzdGFydFggPSAwLCBzdGFydFkgPSAwOwogICAgICAgIGxldCBkcmFnZ2luZyA9IGZhbHNlOwogICAgICAgIGNvbnN0IG1heERpc3QgPSA0MDsKCiAgICAgICAgbGV0IG1vdmVUb3VjaElkID0gbnVsbDsKICAgICAgICBjb25zdCBtb3ZlRGVhZHpvbmVQeCA9IDY7CgogICAgICAgIC8vIEV4cG9zZSBtb3ZlIGpveXN0aWNrIHN0YXRlIGZvciBzbmFwc2hvdHMKICAgICAgICBjb25zdCBfZGJnID0gd2luZG93LmZsdXguX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyB8fCB7fTsKICAgICAgICBfZGJnLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgICAgIF9kYmcuaW5wdXQgPSBfZGJnLmlucHV0IHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQubW92ZSA9IF9kYmcuaW5wdXQubW92ZSB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUudmVjdG9yID0gX2lucHV0OwogICAgICAgIF9kYmcuaW5wdXQubW92ZS5kcmFnZ2luZyA9IGRyYWdnaW5nOwogICAgICAgIF9kYmcuaW5wdXQubW92ZS50b3VjaElkID0gbW92ZVRvdWNoSWQ7CgoKICAgICAgICBjb25zdCBoYW5kbGVTdGFydCA9IChjbGllbnRYLCBjbGllbnRZKSA9PiB7CiAgICAgICAgICAgIGRyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgc3RhcnRYID0gY2xpZW50WDsKCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5tb3ZlKSB7CiAgICAgICAgICAgICAgICBfZGJnLmlucHV0Lm1vdmUuZHJhZ2dpbmcgPSBkcmFnZ2luZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3RhcnRZID0gY2xpZW50WTsKCiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUubGVmdCA9IGAke2NsaWVudFh9cHhgOwogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLnRvcCA9IGAke2NsaWVudFl9cHhgOwoKICAgICAgICAgICAga25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKC01MCUsIC01MCUpYDsKCiAgICAgICAgICAgIGNyZWF0ZVJpcHBsZShjbGllbnRYLCBjbGllbnRZKTsKCiAgICAgICAgICAgIF9pbnB1dC54ID0gMDsKICAgICAgICAgICAgX2lucHV0LnkgPSAwOwogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGhhbmRsZU1vdmUgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CgogICAgICAgICAgICBsZXQgZHggPSBjbGllbnRYIC0gc3RhcnRYOwogICAgICAgICAgICBsZXQgZHkgPSBjbGllbnRZIC0gc3RhcnRZOwoKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCgogICAgICAgICAgICAvLyBEZWFkem9uZSB0byBwcmV2ZW50IGRyaWZ0IGZyb20gdGlueSB0aHVtYiBqaXR0ZXIKICAgICAgICAgICAgaWYgKGRpc3QgPCBtb3ZlRGVhZHpvbmVQeCkgewogICAgICAgICAgICAgICAgZHggPSAwOwogICAgICAgICAgICAgICAgZHkgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgIGR4ID0gKGR4IC8gZGlzdCkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgZHkgPSAoZHkgLyBkaXN0KSAqIG1heERpc3Q7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZShjYWxjKC01MCUgKyAke2R4fXB4KSwgY2FsYygtNTAlICsgJHtkeX1weCkpYDsKCiAgICAgICAgICAgIF9pbnB1dC54ID0gKGR4IC8gbWF4RGlzdCkgKiBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eTsKICAgICAgICAgICAgX2lucHV0LnkgPSAoZHkgLyBtYXhEaXN0KSAqIF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5OwogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGhhbmRsZUVuZCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBkcmFnZ2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgbW92ZVRvdWNoSWQgPSBudWxsOwoKICAgICAgICAgICAgdmlzdWFscy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0Lm1vdmUpIHsKICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS5kcmFnZ2luZyA9IGRyYWdnaW5nOwogICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnRvdWNoSWQgPSBtb3ZlVG91Y2hJZDsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIF9pbnB1dC54ID0gMDsKICAgICAgICAgICAgX2lucHV0LnkgPSAwOwogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH07CgogICAgICAgIGlmIChoaXRab25lKSB7CiAgICAgICAgICAgIGhpdFpvbmUuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlc1swXSkgPyBlLmNoYW5nZWRUb3VjaGVzWzBdIDogZS50b3VjaGVzWzBdOwogICAgICAgICAgICAgICAgbW92ZVRvdWNoSWQgPSB0ID8gdC5pZGVudGlmaWVyIDogbnVsbDsKICAgICAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5tb3ZlKSB7CiAgICAgICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnRvdWNoSWQgPSBtb3ZlVG91Y2hJZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhhbmRsZVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IF9maW5kVG91Y2hCeUlkKGUudG91Y2hlcywgbW92ZVRvdWNoSWQpOwogICAgICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgICAgICBoYW5kbGVNb3ZlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIG1vdmVUb3VjaElkKTsKICAgICAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOyAvLyBJZ25vcmUgb3RoZXIgZmluZ2VycyBsaWZ0aW5nCiAgICAgICAgICAgICAgICBoYW5kbGVFbmQoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIG1vdmVUb3VjaElkKTsKICAgICAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgaGFuZGxlRW5kKCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaGl0Wm9uZS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaGFuZGxlU3RhcnQoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZHJhZ2dpbmcpIGhhbmRsZU1vdmUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVFbmQpOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIE5FVzogQUlNIEpPWVNUSUNLIChSaWdodCBzaWRlKSAtLS0KICAgICAgICBzZXR1cEFpbUpveXN0aWNrKCk7CgogICAgICAgIC8vIC0tLSBORVc6IFRBQ0tMRSBCVVRUT04gLS0tCiAgICAgICAgc2V0dXBUYWNrbGVCdXR0b24oKTsKCiAgICAgICAgLy8gU3dpcGUgRGV0ZWN0aW9uCi8vIFN3aXBlIERldGVjdGlvbgogICAgICAgIGxldCBzd2lwZVN0YXJ0ID0geyB4OiAwLCB5OiAwLCB0OiAwIH07CiAgICAgICAgbGV0IHN3aXBlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgCiAgICAgICAgLy8gRXhwb3NlIHN3aXBlL3Rocm93IGdlc3R1cmUgc3RhdGUgZm9yIHNuYXBzaG90cwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUgPSBfZGJnLmlucHV0LnN3aXBlIHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUuc3RhcnQgPSBzd2lwZVN0YXJ0OwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsKICAgICAgICBfZGJnLmlucHV0LnN3aXBlLnBvaW50cyA9IF9zd2lwZVBvaW50czsKY29uc3Qgb25Td2lwZVN0YXJ0ID0gKHgsIHkpID0+IHsKICAgICAgICAgICAgc3dpcGVTdGFydC54ID0geDsKICAgICAgICAgICAgc3dpcGVTdGFydC55ID0geTsKICAgICAgICAgICAgc3dpcGVTdGFydC50ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgX3N3aXBlUG9pbnRzID0gW3t4LCB5LCB0OiBEYXRlLm5vdygpfV07CiAgICAgICAgfTsKCmNvbnN0IG9uU3dpcGVNb3ZlID0gKHgsIHkpID0+IHsKICAgICAgICAgICAgaWYgKF9zd2lwZVBvaW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBfc3dpcGVQb2ludHMucHVzaCh7eCwgeSwgdDogRGF0ZS5ub3coKX0pOwogICAgICAgICAgICAgICAgY3JlYXRlU3dpcGVUcmFpbERvdCh4LCB5KTsgLy8gVmlzdWFsIEZlZWRiYWNrCiAgICAgICAgICAgIH0KICAgICAgICB9OwoKY29uc3Qgb25Td2lwZUVuZCA9ICh4LCB5KSA9PiB7CiAgICAgICAgICAgIGlmIChfc3dpcGVQb2ludHMubGVuZ3RoIDwgMikgcmV0dXJuOwogICAgICAgICAgICBfc3dpcGVQb2ludHMucHVzaCh7eCwgeSwgdDogRGF0ZS5ub3coKX0pOwoKICAgICAgICAgICAgY29uc3QgeyBpbnRlbnNpdHksIHNwZWVkLCBkeCwgZHkgfSA9IGFuYWx5emVTd2lwZUN1cnZlKF9zd2lwZVBvaW50cyk7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIgJiYgX2NhbWVyYSkgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgICAgICAgICAgLy8gLS0tIENVUlZFIEJBTEwgREVURUNUSU9OIChJbW1lZGlhdGUgVGhyb3cpIC0tLQovLyAtLS0gQ1VSVkUgQkFMTCBERVRFQ1RJT04gKEltbWVkaWF0ZSBUaHJvdykgLS0tCiAgICAgICAgICAgICAgICBpZiAocC5oYXNCYWxsICYmICFwLmlzVGhyb3dpbmcgJiYgIXAuaXNDaGFyZ2luZykgewogICAgICAgICAgICAgICAgICAgIC8vIEFuYWxvZyBDdXJ2ZSBDaGVjazogVGhyZXNob2xkIDAuMjUgcmVxdWlyZXMgYSBkZWxpYmVyYXRlIGFyYyAoVGhlICJGZWF0IikKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoaW50ZW5zaXR5KSA+IDAuMjUgJiYgZGlzdCA+IDEwMCkgewogICAgICAgICAgICAgICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICAgICAgICAgICAgICBfY2FtRndkLnkgPSAwOyBfY2FtRndkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRYID0gKF9jYW1SaWdodC54ICogZHgpICsgKF9jYW1Gd2QueCAqIC1keSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWiA9IChfY2FtUmlnaHQueiAqIGR4KSArIChfY2FtRndkLnogKiAtZHkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0aHJvd0RpciA9IG5ldyBUSFJFRS5WZWN0b3IzKHdvcmxkWCwgMCwgd29ybGRaKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1hcCBpbnRlbnNpdHkgdG8gc3BpbiAtIERyYXN0aWNhbGx5IHJlZHVjZWQgc2Vuc2l0aXZpdHkKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF3U3BpbiA9IE1hdGguYWJzKGludGVuc2l0eSkgKiAzMDAuMDsgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkRmFjdG9yID0gTWF0aC5taW4oMS41LCBzcGVlZCAvIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5Qb3dlciA9IE1hdGgubWluKDQwMC4wLCByYXdTcGluICogc3BlZWRGYWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluU2lnbiA9IE1hdGguc2lnbihpbnRlbnNpdHkpOyAKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIHNwaW5Qb3dlciAqIHNwaW5TaWduLCAwKTsKCgogICAgICAgICAgICAgICAgICAgICAgICBwLnNldE92ZXJyaWRlQWltKHRocm93RGlyLngsIHRocm93RGlyLnopOwogICAgICAgICAgICAgICAgICAgICAgICBwLnRocm93QmFsbCh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCwgJ1NIJywgMS4wLCBzcGluVmVjKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRSIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVSaXBwbGUoeCwgeSk7CiAgICAgICAgICAgICAgICAgICAgICAgIF9zd2lwZVBvaW50cyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47IAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gU1RBTkRBUkQgREFTSCAvIEFJTSAtLS0KICAgICAgICAgICAgICAgIF9jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgICAgICBfY2FtRndkLnkgPSAwOwogICAgICAgICAgICAgICAgaWYgKF9jYW1Gd2QubGVuZ3RoU3EoKSA8IDAuMDAxKSBfY2FtRndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgICAgICBlbHNlIF9jYW1Gd2Qubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhfY2FtRndkLCBfdXBBeGlzKS5ub3JtYWxpemUoKTsKCmNvbnN0IHdvcmxkWDIgPSAoX2NhbVJpZ2h0LnggKiBkeCkgKyAoX2NhbUZ3ZC54ICogLWR5KTsKICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWjIgPSAoX2NhbVJpZ2h0LnogKiBkeCkgKyAoX2NhbUZ3ZC56ICogLWR5KTsKCiAgICAgICAgICAgICAgICBpZiAocC5pc1Rocm93aW5nKSB7CnAuc2V0T3ZlcnJpZGVBaW0od29ybGRYMiwgd29ybGRaMik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQUlNISIsIHAubWVzaC5wb3NpdGlvbiwgImRlZmF1bHQiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewppZiAoZGlzdCA+IDUwKSBwLmRhc2god29ybGRYMiwgd29ybGRaMik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY3JlYXRlUmlwcGxlKHgsIHkpOwogICAgICAgICAgICB9Cl9zd2lwZVBvaW50cyA9IFtdOwogICAgICAgIH07CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgdCA9IChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXNbMF0pID8gZS5jaGFuZ2VkVG91Y2hlc1swXSA6IGUudG91Y2hlc1swXTsKICAgICAgICAgICAgc3dpcGVUb3VjaElkID0gdCA/IHQuaWRlbnRpZmllciA6IG51bGw7Ci8vIG9uU3dpcGVTdGFydCh0LmNsaWVudFgsIHQuY2xpZW50WSk7IC8vIEZpeGVkIHN5bnRheCBlcnJvcgogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuc3dpcGUpIHsgX2RiZy5pbnB1dC5zd2lwZS50b3VjaElkID0gc3dpcGVUb3VjaElkOyB9CiAgICAgICAgICAgIG9uU3dpcGVTdGFydCh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgICAgIGNyZWF0ZVJpcHBsZSh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIHN3aXBlVG91Y2hJZCk7CiAgICAgICAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICAgICAgICBvblN3aXBlTW92ZSh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIHN3aXBlVG91Y2hJZCk7CiAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOyAvLyBJZ25vcmUgb3RoZXIgZmluZ2VycyBsaWZ0aW5nCiAgICAgICAgICAgIG9uU3dpcGVFbmQodEVuZC5jbGllbnRYLCB0RW5kLmNsaWVudFkpOwogICAgICAgICAgICBzd2lwZVRvdWNoSWQgPSBudWxsOwogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuc3dpcGUpIHsgX2RiZy5pbnB1dC5zd2lwZS50b3VjaElkID0gc3dpcGVUb3VjaElkOyB9CiAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgKGUpID0+IHsKaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIHN3aXBlVG91Y2hJZCk7CiAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOyAvLyBJZ25vcmUgb3RoZXIgZmluZ2VycyBsaWZ0aW5nCiAgICAgICAgICAgIG9uU3dpcGVFbmQodEVuZC5jbGllbnRYLCB0RW5kLmNsaWVudFkpOwogICAgICAgICAgICBzd2lwZVRvdWNoSWQgPSBudWxsOwogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuc3dpcGUpIHsgX2RiZy5pbnB1dC5zd2lwZS50b3VjaElkID0gc3dpcGVUb3VjaElkOyB9CiAgICAgICAgCiAgICAgICAgfSk7Ci8vIE1vdXNlIFN3aXBlCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKCiAgICAgICAgICAgIG9uU3dpcGVTdGFydChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgIGNyZWF0ZVJpcHBsZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSkgcmV0dXJuOwogICAgICAgICAgICAvLyBPbmx5IHRyYWNrIGlmIG1vdXNlIGlzIGRvd24gKHNpbXVsYXRpbmcgZHJhZykKICAgICAgICAgICAgaWYgKGUuYnV0dG9ucyA9PT0gMSkgewogICAgICAgICAgICAgICAgb25Td2lwZU1vdmUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKICAgICAgICAgICAgb25Td2lwZUVuZChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIEFjdGlvbiBCdXR0b24gKFNob290L1Bhc3MpCiAgICAgICAgY29uc3QgYWN0aW9uQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKCmNvbnN0IHNldHVwQnV0dG9uID0gKGJ0bikgPT4gewogICAgICAgICAgICBpZiAoIWJ0bikgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGJ0blN0YXJ0WCA9IDA7CiAgICAgICAgICAgIGxldCBidG5TdGFydFkgPSAwOwogICAgICAgICAgICBsZXQgaXNEcmFnZ2luZyA9IGZhbHNlOwogICAgICAgICAgICBsZXQgc3dpcGVQb2ludHMgPSBbXTsKICAgICAgICAgICAgbGV0IGFjdGlvblRvdWNoSWQgPSBudWxsOwoKICAgICAgICAgICAgY29uc3QgYXR0ZW1wdEFjdGlvbiA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGlmICghX2hvbWVUZWFtIHx8ICFfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgICAgICBpZiAocC5oYXNCYWxsICYmICFwLmlzQ2hhcmdpbmcgJiYgIXAuaXNUaHJvd2luZyAmJiBwLnN0YXR1cy5uYXAgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBoYW5kbGVTdGFydCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIuYXR0ZW1wdFRlY2hDb3B5KCk7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpLCAxMDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pc0RlbW9Nb2RlKSByZXR1cm47CgogICAgICAgICAgICAgICAgbGV0IGNsaWVudFggPSBlLmNsaWVudFg7CiAgICAgICAgICAgICAgICBsZXQgY2xpZW50WSA9IGUuY2xpZW50WTsKICAgICAgICAgICAgICAgIGlmIChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IGUuY2hhbmdlZFRvdWNoZXNbMF07CiAgICAgICAgICAgICAgICAgICAgYWN0aW9uVG91Y2hJZCA9IHQuaWRlbnRpZmllcjsKICAgICAgICAgICAgICAgICAgICBjbGllbnRYID0gdC5jbGllbnRYOwogICAgICAgICAgICAgICAgICAgIGNsaWVudFkgPSB0LmNsaWVudFk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGFjdGlvblRvdWNoSWQgPSBudWxsOyAvLyBtb3VzZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnRuU3RhcnRYID0gY2xpZW50WDsKICAgICAgICAgICAgICAgIGJ0blN0YXJ0WSA9IGNsaWVudFk7CiAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHN3aXBlUG9pbnRzID0gW3t4OiBjbGllbnRYLCB5OiBjbGllbnRZLCB0OiBEYXRlLm5vdygpfV07CgogICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci50aW1lc3RhbXAgPSBEYXRlLm5vdygpOwoKICAgICAgICAgICAgICAgIGlmIChhdHRlbXB0QWN0aW9uKCkpIHsKICAgICAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEF0dGFjaCBnbG9iYWwgbGlzdGVuZXJzIHRvIHRyYWNrIHN3aXBlIG91dHNpZGUgYnV0dG9uCiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgaGFuZGxlTW92ZSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIGhhbmRsZU1vdmUpOwogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgaGFuZGxlTW92ZSA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWlzRHJhZ2dpbmcpIHJldHVybjsKCiAgICAgICAgICAgICAgICAvLyBUb3VjaCBwYXRoIChtdWx0aS10b3VjaCBzYWZlKQogICAgICAgICAgICAgICAgaWYgKGUudG91Y2hlcyAmJiBhY3Rpb25Ub3VjaElkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IF9maW5kVG91Y2hCeUlkKGUudG91Y2hlcywgYWN0aW9uVG91Y2hJZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgc3dpcGVQb2ludHMucHVzaCh7eDogdC5jbGllbnRYLCB5OiB0LmNsaWVudFksIHQ6IERhdGUubm93KCl9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTW91c2UgcGF0aAogICAgICAgICAgICAgICAgY29uc3QgY2xpZW50WCA9IGUuY2xpZW50WDsKICAgICAgICAgICAgICAgIGNvbnN0IGNsaWVudFkgPSBlLmNsaWVudFk7CiAgICAgICAgICAgICAgICBzd2lwZVBvaW50cy5wdXNoKHt4OiBjbGllbnRYLCB5OiBjbGllbnRZLCB0OiBEYXRlLm5vdygpfSk7CiAgICAgICAgICAgIH07Cgpjb25zdCBoYW5kbGVFbmQgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgbGV0IGR4ID0gMDsKICAgICAgICAgICAgICAgIGxldCBkeSA9IDA7CiAgICAgICAgICAgICAgICBsZXQgdmFsaWRFbmQgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAvLyAxLiBDaGVjayBUb3VjaAogICAgICAgICAgICAgICAgaWYgKGUuY2hhbmdlZFRvdWNoZXMgJiYgYWN0aW9uVG91Y2hJZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgYWN0aW9uVG91Y2hJZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRFbmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZHggPSB0RW5kLmNsaWVudFggLSBidG5TdGFydFg7CiAgICAgICAgICAgICAgICAgICAgICAgIGR5ID0gdEVuZC5jbGllbnRZIC0gYnRuU3RhcnRZOwogICAgICAgICAgICAgICAgICAgICAgICB2YWxpZEVuZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvblRvdWNoSWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICAvLyAyLiBDaGVjayBNb3VzZQogICAgICAgICAgICAgICAgZWxzZSBpZiAoIWUuY2hhbmdlZFRvdWNoZXMgJiYgaXNEcmFnZ2luZykgewogICAgICAgICAgICAgICAgICAgIGR4ID0gZS5jbGllbnRYIC0gYnRuU3RhcnRYOwogICAgICAgICAgICAgICAgICAgIGR5ID0gZS5jbGllbnRZIC0gYnRuU3RhcnRZOwogICAgICAgICAgICAgICAgICAgIHZhbGlkRW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIXZhbGlkRW5kKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gQ2xlYW51cCBsaXN0ZW5lcnMKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBoYW5kbGVNb3ZlKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIGhhbmRsZU1vdmUpOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVFbmQpOwoKICAgICAgICAgICAgICAgIGlmICghaXNEcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgaXNEcmFnZ2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB3YXNCdWZmZXJlZCA9IF9hY3Rpb25CdWZmZXIuYWN0aXZlOwogICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDdXJ2ZSBBbmFseXNpcwogICAgICAgICAgICAgICAgICAgIGxldCBjdXJ2ZURhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIGxldCBzcGluVmVjID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGN1cnZlIGlmIHdlIGhhdmUgZW5vdWdoIGRhdGEKLy8gQ2FsY3VsYXRlIGN1cnZlIGlmIHdlIGhhdmUgZW5vdWdoIGRhdGEKICAgICAgICAgICAgICAgICAgICBpZiAoc3dpcGVQb2ludHMubGVuZ3RoID4gMikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmFseXNpcyA9IGFuYWx5emVTd2lwZUN1cnZlKHN3aXBlUG9pbnRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSGlnaCB0aHJlc2hvbGQgZm9yIGJ1dHRvbiByZWxlYXNlIHRvbwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoYW5hbHlzaXMuaW50ZW5zaXR5KSA+IDAuMjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnZlRGF0YSA9IGFuYWx5c2lzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgc3BpbiB2ZWN0b3IgZm9yIG1vdXNlL3RvdWNoIHVuaWZpZWQgKENvbnNlcnZhdGl2ZSB2YWx1ZXMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluUG93ZXIgPSBNYXRoLm1pbig0MDAuMCwgTWF0aC5hYnMoYW5hbHlzaXMuaW50ZW5zaXR5KSAqIDE1MDAuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluU2lnbiA9IE1hdGguc2lnbihhbmFseXNpcy5pbnRlbnNpdHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BpblZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIHNwaW5Qb3dlciAqIHNwaW5TaWduLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQp9CgogICAgICAgICAgICAgICAgICAgIC8vIEVYRUNVVEUKICAgICAgICAgICAgICAgICAgICBpZiAocC5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5vcm1hbCBSZWxlYXNlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcGluVmVjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBVbmlmaWVkIHNwaW4gcGFzc2luZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlQ2hhcmdlKGR4LCBkeSwgeyBpbnRlbnNpdHk6IGN1cnZlRGF0YS5pbnRlbnNpdHksIHNwZWVkOiBjdXJ2ZURhdGEuc3BlZWQgfSk7IAogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlQ2hhcmdlKGR4LCBkeSwgY3VydmVEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh3YXNCdWZmZXJlZCAmJiBwLmhhc0JhbGwgJiYgIXAuaXNUaHJvd2luZyAmJiBwLnN0YXR1cy5uYXAgPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBCdWZmZXJlZCBUYXAgKEluc3RhbnQgU2hvdCkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9yY2Ugc3RhcnQgYW5kIHJlbGVhc2UgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGFydENoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBwLnJlbGVhc2VDaGFyZ2UoZHgsIGR5LCBjdXJ2ZURhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBoYW5kbGVTdGFydCwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIGhhbmRsZVN0YXJ0KTsKICAgICAgICB9OwogICAgICAgIHNldHVwQnV0dG9uKGFjdGlvbkJ0bik7CgovLyBBdXRvIFRvZ2dsZQogICAgICAgIGNvbnN0IGF1dG9CdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXV0by10b2dnbGUnKTsKICAgICAgICBpZiAoYXV0b0J0bikgewogICAgICAgICAgICBjb25zdCBoYW5kbGVUb2dnbGUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnRvZ2dsZURlbW9Nb2RlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgYXV0b0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGhhbmRsZVRvZ2dsZSk7CmF1dG9CdG4uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBoYW5kbGVUb2dnbGUoKTsKICAgICAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogU2V0dGluZ3MgQnV0dG9uCiAgICAgICAgc2V0dXBTZXR0aW5nc0J1dHRvbigpOwogICAgfQoKICAgIC8vIE5FVzogQWltIEpveXN0aWNrIFNldHVwCi8vIE5FVzogQWltIEpveXN0aWNrIFNldHVwCmZ1bmN0aW9uIHNldHVwQWltSm95c3RpY2soKSB7CiAgICAgICAgY29uc3QgYWltS25vYiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaW0tam95c3RpY2sta25vYicpOwogICAgICAgIGNvbnN0IGFpbVZpc3VhbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWltLWpveXN0aWNrLXZpc3VhbCcpOwogICAgICAgIGNvbnN0IGFpbVpvbmUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWltLWpveXN0aWNrLXpvbmUnKTsKICAgICAgICBpZiAoIWFpbVpvbmUpIHJldHVybjsKICAgICAgICBsZXQgYWltU3RhcnRYID0gMCwgYWltU3RhcnRZID0gMDsKICAgICAgICBsZXQgYWltRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICBjb25zdCBhaW1NYXhEaXN0ID0gMzU7CiAgICAgICAgbGV0IGFpbVRvdWNoSWQgPSBudWxsOwoKICAgICAgICAKCiAgICAgICAgLy8gRXhwb3NlIGFpbSBqb3lzdGljayBzdGF0ZSBmb3Igc25hcHNob3RzCiAgICAgICAgY29uc3QgX2RiZyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPID0gd2luZG93LmZsdXguX2RlYnVnSU8gfHwge307CiAgICAgICAgX2RiZy5zZXR0aW5ncyA9IF9zZXR0aW5nczsKICAgICAgICBfZGJnLmlucHV0ID0gX2RiZy5pbnB1dCB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0LmFpbSA9IF9kYmcuaW5wdXQuYWltIHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQuYWltLnZlY3RvciA9IF9haW1JbnB1dDsKICAgICAgICBfZGJnLmlucHV0LmFpbS5kcmFnZ2luZyA9IGFpbURyYWdnaW5nOwogICAgICAgIF9kYmcuaW5wdXQuYWltLnRvdWNoSWQgPSBhaW1Ub3VjaElkOwpjb25zdCBoYW5kbGVBaW1TdGFydCA9IChjbGllbnRYLCBjbGllbnRZKSA9PiB7CiAgICAgICAgICAgIGFpbURyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgYWltU3RhcnRYID0gY2xpZW50WDsKCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5haW0pIHsgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsgfQoKICAgICAgICAgICAgYWltU3RhcnRZID0gY2xpZW50WTsKICAgICAgICAgICAgX2FpbUlucHV0LmFjdGl2ZSA9IHRydWU7CgogICAgICAgICAgICBpZiAoYWltVmlzdWFscykgewogICAgICAgICAgICAgICAgYWltVmlzdWFscy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIGFpbVZpc3VhbHMuc3R5bGUubGVmdCA9IGAke2NsaWVudFh9cHhgOwogICAgICAgICAgICAgICAgYWltVmlzdWFscy5zdHlsZS50b3AgPSBgJHtjbGllbnRZfXB4YDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYWltS25vYikgewogICAgICAgICAgICAgICAgYWltS25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKC01MCUsIC01MCUpYDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGNvbnN0IGhhbmRsZUFpbU1vdmUgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CgogICAgICAgICAgICBsZXQgZHggPSBjbGllbnRYIC0gYWltU3RhcnRYOwogICAgICAgICAgICBsZXQgZHkgPSBjbGllbnRZIC0gYWltU3RhcnRZOwoKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCiAgICAgICAgICAgIGlmIChkaXN0ID4gYWltTWF4RGlzdCkgewogICAgICAgICAgICAgICAgZHggPSAoZHggLyBkaXN0KSAqIGFpbU1heERpc3Q7CiAgICAgICAgICAgICAgICBkeSA9IChkeSAvIGRpc3QpICogYWltTWF4RGlzdDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGFpbUtub2IpIHsKICAgICAgICAgICAgICAgIGFpbUtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZShjYWxjKC01MCUgKyAke2R4fXB4KSwgY2FsYygtNTAlICsgJHtkeX1weCkpYDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTm9ybWFsaXplIGFuZCB0cmFuc2Zvcm0gdG8gd29ybGQgc3BhY2UKICAgICAgICAgICAgX2FpbUlucHV0LnggPSBkeCAvIGFpbU1heERpc3Q7CiAgICAgICAgICAgIF9haW1JbnB1dC55ID0gZHkgLyBhaW1NYXhEaXN0OwoKICAgICAgICAgICAgLy8gQXBwbHkgYWltIHRvIHBsYXllciBpZiBjaGFyZ2luZwogICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgaWYgKHAuaXNDaGFyZ2luZyB8fCBwLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUcmFuc2Zvcm0gc2NyZWVuIGFpbSB0byB3b3JsZCBzcGFjZQogICAgICAgICAgICAgICAgICAgIF9jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgICAgICAgICBlbHNlIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhfY2FtRndkLCBfdXBBeGlzKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRYID0gKF9jYW1SaWdodC54ICogX2FpbUlucHV0LngpICsgKF9jYW1Gd2QueCAqIC1fYWltSW5wdXQueSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRaID0gKF9jYW1SaWdodC56ICogX2FpbUlucHV0LngpICsgKF9jYW1Gd2QueiAqIC1fYWltSW5wdXQueSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyh3b3JsZFgpID4gMC4xIHx8IE1hdGguYWJzKHdvcmxkWikgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRPdmVycmlkZUFpbSh3b3JsZFgsIHdvcmxkWik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCmNvbnN0IGhhbmRsZUFpbUVuZCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBhaW1EcmFnZ2luZyA9IGZhbHNlOwogICAgICAgICAgICBfYWltSW5wdXQuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIF9haW1JbnB1dC54ID0gMDsKICAgICAgICAgICAgX2FpbUlucHV0LnkgPSAwOwoKICAgICAgICAgICAgaWYgKGFpbVZpc3VhbHMpIHsKICAgICAgICAgICAgICAgIGFpbVZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2xlYXIgcGxheWVyIGFpbSBvdmVycmlkZQogICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIub3ZlcnJpZGVBaW1WZWN0b3IgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgYWltWm9uZS5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBjb25zdCB0ID0gKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlc1swXSkgPyBlLmNoYW5nZWRUb3VjaGVzWzBdIDogZS50b3VjaGVzWzBdOwogICAgICAgICAgICBhaW1Ub3VjaElkID0gdCA/IHQuaWRlbnRpZmllciA6IG51bGw7CiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5haW0pIHsgX2RiZy5pbnB1dC5haW0udG91Y2hJZCA9IGFpbVRvdWNoSWQ7IH0KICAgICAgICAgICAgaGFuZGxlQWltU3RhcnQodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgY29uc3QgdCA9IF9maW5kVG91Y2hCeUlkKGUudG91Y2hlcywgYWltVG91Y2hJZCk7CiAgICAgICAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICAgICAgICBoYW5kbGVBaW1Nb3ZlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgYWltVG91Y2hJZCk7CiAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOwogICAgICAgICAgICBhaW1Ub3VjaElkID0gbnVsbDsKICAgICAgICAgICAgaGFuZGxlQWltRW5kKCk7CiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5haW0pIHsgX2RiZy5pbnB1dC5haW0udG91Y2hJZCA9IGFpbVRvdWNoSWQ7IF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7IH0KICAgICAgICAgICAgaGFuZGxlQWltRW5kKCk7CiAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIGFpbVRvdWNoSWQpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgYWltVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZUFpbUVuZCgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLnRvdWNoSWQgPSBhaW1Ub3VjaElkOyBfZGJnLmlucHV0LmFpbS5kcmFnZ2luZyA9IGFpbURyYWdnaW5nOyB9CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZUFpbUVuZCgpOwogICAgICAgIH0pOwovLyBNb3VzZSBzdXBwb3J0IGZvciBkZXNrdG9wIHRlc3RpbmcKICAgICAgICBhaW1ab25lLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgIGhhbmRsZUFpbVN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGFpbURyYWdnaW5nKSBoYW5kbGVBaW1Nb3ZlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChhaW1EcmFnZ2luZykgaGFuZGxlQWltRW5kKCk7CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gTkVXOiBUYWNrbGUgQnV0dG9uIFNldHVwCiAgICBmdW5jdGlvbiBzZXR1cFRhY2tsZUJ1dHRvbigpIHsKICAgICAgICBjb25zdCB0YWNrbGVCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGFja2xlLWJ1dHRvbicpOwogICAgICAgIGlmICghdGFja2xlQnRuKSByZXR1cm47CgogICAgICAgIGNvbnN0IGhhbmRsZVRhY2tsZSA9IChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmlzRGVtb01vZGUpIHJldHVybjsKCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgICAgICAgICAgLy8gSWYgd2UgZG9uJ3QgaGF2ZSB0aGUgYmFsbCwgZGFzaC90YWNrbGUKICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gR2V0IGN1cnJlbnQgbW92ZW1lbnQgZGlyZWN0aW9uIG9yIGZvcndhcmQKICAgICAgICAgICAgICAgICAgICBsZXQgZGFzaFggPSBwLmlucHV0VmVjdG9yLng7CiAgICAgICAgICAgICAgICAgICAgbGV0IGRhc2haID0gcC5pbnB1dFZlY3Rvci56OwoKICAgICAgICAgICAgICAgICAgICAvLyBJZiBub3QgbW92aW5nLCBkYXNoIGZvcndhcmQKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGFzaFgpIDwgMC4xICYmIE1hdGguYWJzKGRhc2haKSA8IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24ocC5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgICAgICAgICBkYXNoWCA9IGZ3ZC54OwogICAgICAgICAgICAgICAgICAgICAgICBkYXNoWiA9IGZ3ZC56OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcC5kYXNoKGRhc2hYLCBkYXNoWik7CgogICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRhY2tsZUJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSwgMjAwKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiVEFDS0xFISIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQnJlYWsgdGFja2xlIGlmIGVuZ2FnZWQKICAgICAgICAgICAgICAgICAgICBwLmRhc2gocC5pbnB1dFZlY3Rvci54LCBwLmlucHV0VmVjdG9yLnopOwogICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRhY2tsZUJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSwgMjAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlVGFja2xlLCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgIHRhY2tsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBoYW5kbGVUYWNrbGUpOwogICAgfQoKICAgIC8vIE5FVzogU2V0dGluZ3MgQnV0dG9uIFNldHVwCi8vIE5FVzogU2V0dGluZ3MgQnV0dG9uIFNldHVwCmZ1bmN0aW9uIHNldHVwU2V0dGluZ3NCdXR0b24oKSB7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2V0dGluZ3MtYnV0dG9uJyk7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NQYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXR0aW5ncy1wYW5lbCcpOwogICAgICAgIGNvbnN0IHNldHRpbmdzQ2xvc2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2V0dGluZ3MtY2xvc2UnKTsKCiAgICAgICAgaWYgKCFzZXR0aW5nc0J0biB8fCAhc2V0dGluZ3NQYW5lbCkgcmV0dXJuOwoKICAgICAgICBzZXR0aW5nc0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID0gc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID09PSAnbm9uZScgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIH0pOwoKICAgICAgICBpZiAoc2V0dGluZ3NDbG9zZSkgewogICAgICAgICAgICBzZXR0aW5nc0Nsb3NlLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIFNlbnNpdGl2aXR5IHNsaWRlcgogICAgICAgIGNvbnN0IHNlbnNpdGl2aXR5U2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlbnNpdGl2aXR5LXNsaWRlcicpOwogICAgICAgIGlmIChzZW5zaXRpdml0eVNsaWRlcikgewogICAgICAgICAgICBzZW5zaXRpdml0eVNsaWRlci52YWx1ZSA9IF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5ICogMTAwOwogICAgICAgICAgICBzZW5zaXRpdml0eVNsaWRlci5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eSA9IGUudGFyZ2V0LnZhbHVlIC8gMTAwOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIEFpbSBhc3Npc3QgdG9nZ2xlCiAgICAgICAgY29uc3QgYWltQXNzaXN0VG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1hc3Npc3QtdG9nZ2xlJyk7CiAgICAgICAgaWYgKGFpbUFzc2lzdFRvZ2dsZSkgewogICAgICAgICAgICBhaW1Bc3Npc3RUb2dnbGUuY2hlY2tlZCA9IF9zZXR0aW5ncy5haW1Bc3Npc3Q7CiAgICAgICAgICAgIGFpbUFzc2lzdFRvZ2dsZS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgX3NldHRpbmdzLmFpbUFzc2lzdCA9IGUudGFyZ2V0LmNoZWNrZWQ7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gQ2FtZXJhIHNoYWtlIHRvZ2dsZQogICAgICAgIGNvbnN0IHNoYWtlVG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NoYWtlLXRvZ2dsZScpOwogICAgICAgIGlmIChzaGFrZVRvZ2dsZSkgewogICAgICAgICAgICBzaGFrZVRvZ2dsZS5jaGVja2VkID0gX3NldHRpbmdzLmNhbWVyYVNoYWtlOwogICAgICAgICAgICBzaGFrZVRvZ2dsZS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgX3NldHRpbmdzLmNhbWVyYVNoYWtlID0gZS50YXJnZXQuY2hlY2tlZDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBWb2x1bWUgc2xpZGVyCiAgICAgICAgY29uc3Qgdm9sdW1lU2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ZvbHVtZS1zbGlkZXInKTsKICAgICAgICBpZiAodm9sdW1lU2xpZGVyICYmIF9hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgdm9sdW1lU2xpZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHZvbCA9IGUudGFyZ2V0LnZhbHVlIC8gMTAwOwogICAgICAgICAgICAgICAgX2F1ZGlvTWFuYWdlci5zZXRWb2x1bWUodm9sKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBFeGl0IHRvIE1lbnUKICAgICAgICBjb25zdCBleGl0QnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2V4aXQtdG8tbWVudS1idG4nKTsKICAgICAgICBpZiAoZXhpdEJ0bikgewogICAgICAgICAgICBleGl0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKF9tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIF9tZW51TWFuYWdlci5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIuc3RhdGUgPSAnbWVudSc7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgcHJhY3RpY2UgaWYgcnVubmluZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlSW5wdXRWZWN0b3IoKSB7CiAgICAgICAgbGV0IHggPSBfaW5wdXQueCB8fCAwOwogICAgICAgIGxldCB6ID0gX2lucHV0LnkgfHwgMDsKCiAgICAgICAgaWYgKF9rZXlzWyd3J10gfHwgX2tleXNbJ0Fycm93VXAnXSkgeiAtPSAxOwogICAgICAgIGlmIChfa2V5c1sncyddIHx8IF9rZXlzWydBcnJvd0Rvd24nXSkgeiArPSAxOwogICAgICAgIGlmIChfa2V5c1snYSddIHx8IF9rZXlzWydBcnJvd0xlZnQnXSkgeCAtPSAxOwogICAgICAgIGlmIChfa2V5c1snZCddIHx8IF9rZXlzWydBcnJvd1JpZ2h0J10pIHggKz0gMTsKCiAgICAgICAgY29uc3QgbGVuU3EgPSB4KnggKyB6Kno7CiAgICAgICAgaWYgKGxlblNxID4gMSkgewogICAgICAgICAgICBjb25zdCBsZW4gPSBNYXRoLnNxcnQobGVuU3EpOwogICAgICAgICAgICB4IC89IGxlbjsKICAgICAgICAgICAgeiAvPSBsZW47CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNOYU4oeCkpIHggPSAwOwogICAgICAgIGlmIChpc05hTih6KSkgeiA9IDA7CgogICAgICAgIGlmIChfY2FtZXJhKSB7CiAgICAgICAgICAgIF9jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CgogICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICBfY2FtUmlnaHQuc2V0KDEsIDAsIDApOwogICAgICAgIH0KCiAgICAgICAgbGV0IHdvcmxkWCA9IChfY2FtRndkLnggKiAteikgKyAoX2NhbVJpZ2h0LnggKiB4KTsKICAgICAgICBsZXQgd29ybGRaID0gKF9jYW1Gd2QueiAqIC16KSArIChfY2FtUmlnaHQueiAqIHgpOwoKICAgICAgICBpZiAoaXNOYU4od29ybGRYKSB8fCBpc05hTih3b3JsZFopKSB7CiAgICAgICAgICAgIHdvcmxkWCA9IDA7CiAgICAgICAgICAgIHdvcmxkWiA9IDA7CiAgICAgICAgfQoKICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiAhX2dhbWVNYW5hZ2VyLmlzRGVtb01vZGUpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQod29ybGRYLCB3b3JsZFopOwogICAgICAgICAgICB9Cgp9CiAgICB9CmZ1bmN0aW9uIGNyZWF0ZVJpcHBsZSh4LCB5KSB7CiAgICAgICAgY29uc3QgcmlwcGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgcmlwcGxlLmNsYXNzTmFtZSA9ICd0b3VjaC1yaXBwbGUnOwogICAgICAgIHJpcHBsZS5zdHlsZS5sZWZ0ID0gYCR7eH1weGA7CiAgICAgICAgcmlwcGxlLnN0eWxlLnRvcCA9IGAke3l9cHhgOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpLmFwcGVuZENoaWxkKHJpcHBsZSk7CgogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAocmlwcGxlLnBhcmVudE5vZGUpIHJpcHBsZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHJpcHBsZSk7CiAgICAgICAgfSwgNjAwKTsKCiAgICB9CgogICAgLy8gTkVXOiBWaXN1YWwgU3dpcGUgVHJhaWwKICAgIGZ1bmN0aW9uIGNyZWF0ZVN3aXBlVHJhaWxEb3QoeCwgeSkgewogICAgICAgIGNvbnN0IGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIGRvdC5jbGFzc05hbWUgPSAnc3dpcGUtdHJhaWwtZG90JzsKICAgICAgICBkb3Quc3R5bGUubGVmdCA9IGAke3ggLSA2fXB4YDsgLy8gQ2VudGVyICgxMnB4IHdpZHRoKQogICAgICAgIGRvdC5zdHlsZS50b3AgPSBgJHt5IC0gNn1weGA7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJykuYXBwZW5kQ2hpbGQoZG90KTsKICAgICAgICAKICAgICAgICAvLyBDU1MgYW5pbWF0aW9uIGhhbmRsZXMgcmVtb3ZhbCwgYnV0IHdlIGNsZWFuIHVwIERPTSB0byBiZSBzYWZlCiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGlmIChkb3QucGFyZW50Tm9kZSkgZG90LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZG90KTsKICAgICAgICB9LCA1MDApOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uUmVzaXplKCkgewogICAgICAgIGNvbnN0IHdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgIAogICAgICAgIGlmIChfY2FtZXJhKSB7CiAgICAgICAgICAgIF9jYW1lcmEuYXNwZWN0ID0gd2lkdGggLyBoZWlnaHQ7CiAgICAgICAgICAgIF9jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBTdHJpY3RseSAwLjUwIGFzIHJlcXVlc3RlZAogICAgICAgIGNvbnN0IHJlc1NjYWxlID0gMC41MDsKICAgICAgICAKICAgICAgICBfY29uZmlnLmludGVybmFsV2lkdGggPSBNYXRoLmZsb29yKHdpZHRoICogcmVzU2NhbGUpOwogICAgICAgIF9jb25maWcuaW50ZXJuYWxIZWlnaHQgPSBNYXRoLmZsb29yKGhlaWdodCAqIHJlc1NjYWxlKTsKCiAgICAgICAgaWYgKF9yZW5kZXJlcikgewogICAgICAgICAgICBfcmVuZGVyZXIuc2V0U2l6ZShfY29uZmlnLmludGVybmFsV2lkdGgsIF9jb25maWcuaW50ZXJuYWxIZWlnaHQsIGZhbHNlKTsKICAgICAgICB9CiAgICB9CgpmdW5jdGlvbiBhbmltYXRlKCkgewogICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRlKTsKCiAgICAgICAgY29uc3QgcmF3RHQgPSBfY2xvY2suZ2V0RGVsdGEoKTsKICAgICAgICAvLyBDbGFtcCBkdCB0byBwcmV2ZW50IHNwaXJhbHMgb2YgZGVhdGggKG1heCAwLjFzKQogICAgICAgIGNvbnN0IGR0ID0gTWF0aC5taW4ocmF3RHQsIDAuMSkgKiAod2luZG93LmZsdXgudGltZVNjYWxlICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC50aW1lU2NhbGUgOiAwLjgpOwoKICAgICAgICAKCiAgICAgICAgLy8gUGVyZiBzdGF0cyBmb3IgRGV2VG9vbHMgc25hcHNob3RzCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPLnBlcmYpIHsKICAgICAgICAgICAgY29uc3QgcGVyZiA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPLnBlcmY7CiAgICAgICAgICAgIHBlcmYuZnJhbWUgPSAocGVyZi5mcmFtZSB8fCAwKSArIDE7CiAgICAgICAgICAgIHBlcmYucmF3RHQgPSByYXdEdDsKICAgICAgICAgICAgcGVyZi5kdCA9IGR0OwogICAgICAgICAgICBjb25zdCBmcHMgPSBkdCA+IDAgPyAoMSAvIGR0KSA6IDA7CiAgICAgICAgICAgIHBlcmYuZnBzID0gZnBzOwogICAgICAgICAgICBwZXJmLmF2Z0ZwcyA9IChwZXJmLmF2Z0ZwcyAmJiBwZXJmLmF2Z0ZwcyA+IDApID8gKHBlcmYuYXZnRnBzICogMC45ICsgZnBzICogMC4xKSA6IGZwczsKICAgICAgICB9Ci8vIEltcGFjdCBGcmFtZXMKICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pbXBhY3RQYXVzZSA+IDApIHsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmltcGFjdFBhdXNlIC09IGR0OwogICAgICAgICAgICBpZiAoX3JlbmRlcmVyICYmIF9zY2VuZSAmJiBfY2FtZXJhKSB7CiAgICAgICAgICAgICAgICBfcmVuZGVyZXIucmVuZGVyKF9zY2VuZSwgX2NhbWVyYSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKCiAgICAgICAgLy8gQWN0aW9uIEJ1ZmZlciBQcm9jZXNzaW5nCiAgICAgICAgaWYgKF9hY3Rpb25CdWZmZXIuYWN0aXZlKSB7CiAgICAgICAgICAgIGlmIChEYXRlLm5vdygpIC0gX2FjdGlvbkJ1ZmZlci50aW1lc3RhbXAgPiBfYWN0aW9uQnVmZmVyLmR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgJiYgIXAuaXNDaGFyZ2luZyAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ0bikgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gTWVudSBTdGF0ZSBIYW5kbGluZwogICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLnN0YXRlID09PSAnbWVudScgJiYgX2NhbWVyYSkgewogICAgICAgICAgICBjb25zdCB0aW1lID0gRGF0ZS5ub3coKSAqIDAuMDAwNTsKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gNTA7CiAgICAgICAgICAgIF9jYW1lcmEucG9zaXRpb24ueCA9IE1hdGguc2luKHRpbWUpICogcmFkaXVzOwogICAgICAgICAgICBfY2FtZXJhLnBvc2l0aW9uLnogPSBNYXRoLmNvcyh0aW1lKSAqIHJhZGl1czsKICAgICAgICAgICAgX2NhbWVyYS5wb3NpdGlvbi55ID0gMjA7CiAgICAgICAgICAgIF9jYW1lcmEubG9va0F0KDAsIDAsIDApOwoKICAgICAgICAgICAgaWYgKF9yZW5kZXJlciAmJiBfc2NlbmUpIHsKICAgICAgICAgICAgICAgIF9yZW5kZXJlci5yZW5kZXIoX3NjZW5lLCBfY2FtZXJhKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKLy8gU3RhYmxlIHN1Yi1zdGVwcGluZyAocHJldmVudHMgZHQgc3Bpa2VzIGZyb20gbWFraW5nIHBoeXNpY3MvY2FtZXJhIGZlZWwgZmxvYXR5IG9uIG1vYmlsZSkKICAgICAgICBjb25zdCBfbWF4U3RlcCA9IDEgLyA2MDsKICAgICAgICBjb25zdCBfc3RlcHMgPSBNYXRoLm1pbig0LCBNYXRoLm1heCgxLCBNYXRoLmNlaWwoZHQgLyBfbWF4U3RlcCkpKTsKICAgICAgICBjb25zdCBfc3RlcER0ID0gZHQgLyBfc3RlcHM7CgogICAgICAgIGZvciAobGV0IF9zaSA9IDA7IF9zaSA8IF9zdGVwczsgX3NpKyspIHsKICAgICAgICAgICAgY29uc3QgX3NkdCA9IF9zdGVwRHQ7CgogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSBfZ2FtZU1hbmFnZXIudXBkYXRlKF9zZHQpOwoKICAgICAgICAgICAgLy8gSWYgaW4gQXNzZXQgRm9yZ2UgbW9kZSwgc2tpcCBnYW1lIGxvZ2ljIGFuZCBzdGFuZGFyZCByZW5kZXJpbmcKICAgICAgICAgICAgLy8gRGV2VG9vbHMgaGFuZGxlcyB0aGUgcmVuZGVyaW5nIGluIGl0cyBob29rZWQgdXBkYXRlIGZ1bmN0aW9uCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmlzRm9yZ2VNb2RlKSB7CiAgICAgICAgICAgICAgICAvLyBGb3JnZSBtb2RlIGhhbmRsZXMgaXRzIG93biByZW5kZXJpbmcgbG9vcCBpbiBEZXZUb29scyBob29rCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVwZGF0ZSBFbnRpdGllcwogICAgICAgICAgICBpZiAoX2hvbWVUZWFtKSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0udXBkYXRlKF9zZHQpOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IGNoZWNrQmFsbEdyYWIocCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoX2F3YXlUZWFtKSB7CiAgICAgICAgICAgICAgICBfYXdheVRlYW0udXBkYXRlKF9zZHQpOwogICAgICAgICAgICAgICAgX2F3YXlUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IGNoZWNrQmFsbEdyYWIocCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoX2JhbGwpIHsKICAgICAgICAgICAgICAgIF9iYWxsLnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmFsbCBMYWIgcnVudGltZSAodHJhamVjdG9yeSBwcmV2aWV3IC8gcmVjb3JkLXJlcGxheSkKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWIgJiYgdHlwZW9mIHdpbmRvdy5mbHV4LmJhbGxMYWIudXBkYXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5iYWxsTGFiLnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIENhbWVyYQogICAgICAgICAgICB1cGRhdGVDYW1lcmFMb2dpYyhfc2R0KTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBWaXN1YWxzCiAgICAgICAgICAgIGlmIChfd2F0ZXJPdmVybGF5KSBfd2F0ZXJPdmVybGF5LnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgaWYgKF9saWdodFNoYWZ0cykgX2xpZ2h0U2hhZnRzLnVwZGF0ZShfc2R0KTsKCiAgICAgICAgICAgIC8vIFJ1bnRpbWUgdXBkYXRlcnMgKEZYLCBhcmVuYSByaW5ncywgZXRjLikKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgJiYgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IHVpID0gMDsgdWkgPCB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLmxlbmd0aDsgdWkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZuID0gd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVyc1t1aV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJykgZm4oX3NkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVwZGF0ZSBHbG9iYWwgVW5pZm9ybXMKICAgICAgICAgICAgaWYgKF9hcmVuYVVuaWZvcm1zKSB7CiAgICAgICAgICAgICAgICBfYXJlbmFVbmlmb3Jtcy51VGltZS52YWx1ZSArPSBfc2R0OwogICAgICAgICAgICAgICAgLy8gRGVjYXkgaW1wYWN0IHN0cmVuZ3RoCiAgICAgICAgICAgICAgICBfYXJlbmFVbmlmb3Jtcy51SW1wYWN0U3RyLnZhbHVlICo9IE1hdGgubWF4KDAsIDEuMCAtIF9zZHQgKiA0LjApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChfcGFydGljbGVVbmlmb3JtcykgewogICAgICAgICAgICAgICAgX3BhcnRpY2xlVW5pZm9ybXMudVRpbWUudmFsdWUgKz0gX3NkdDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKF9zdGFkaXVtKSBfc3RhZGl1bS51cGRhdGUoX3NkdCk7CiAgICAgICAgfQoKCiAgICAgICAgaWYgKF9yZW5kZXJlciAmJiBfc2NlbmUgJiYgX2NhbWVyYSkgewogICAgICAgICAgICBfcmVuZGVyZXIucmVuZGVyKF9zY2VuZSwgX2NhbWVyYSk7CiAgICAgICAgfQogICAgICAgIC8vIFVJIFVwZGF0ZXMKICAgICAgICB1cGRhdGVVSSgpOwogICAgfQoKICAgIGZ1bmN0aW9uIHVwZGF0ZVVJKCkgewogICAgICAgIGlmICghX2hvbWVUZWFtIHx8ICFfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSByZXR1cm47CgogICAgICAgIGNvbnN0IGJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY3Rpb24tYnV0dG9uJyk7CiAgICAgICAgY29uc3QgbGJsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1sYWJlbCcpOwogICAgICAgIGNvbnN0IHRhY2tsZUJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0YWNrbGUtYnV0dG9uJyk7CiAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgIGlmIChidG4gJiYgbGJsKSB7CiAgICAgICAgICAgIGNvbnN0IGJ0blRleHQgPSBidG4ucXVlcnlTZWxlY3RvcignLmJ0bi10ZXh0Jyk7CgogICAgICAgICAgICBpZiAocC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoYnRuVGV4dCAmJiBidG5UZXh0LmlubmVyVGV4dCAhPT0gIkFDVElPTiIpIHsKICAgICAgICAgICAgICAgICAgICBidG5UZXh0LmlubmVyVGV4dCA9ICJBQ1RJT04iOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdzaG9vdC1tb2RlJyk7CiAgICAgICAgICAgICAgICAgICAgbGJsLmlubmVyVGV4dCA9ICJPRkZFTlNFIjsKICAgICAgICAgICAgICAgICAgICBsYmwuY2xhc3NMaXN0LmFkZCgnc2hvb3QtbGFiZWwnKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBpc0hpZ2hFbmVyZ3kgPSAocC5zdGF0cy5IUCAvIHAuc3RhdHMubWF4SFApID4gMC40OwogICAgICAgICAgICAgICAgaWYgKGlzSGlnaEVuZXJneSkgewogICAgICAgICAgICAgICAgICAgIGlmICghYnRuLmNsYXNzTGlzdC5jb250YWlucygnbGltaXQtcmVhZHknKSkgYnRuLmNsYXNzTGlzdC5hZGQoJ2xpbWl0LXJlYWR5Jyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChidG4uY2xhc3NMaXN0LmNvbnRhaW5zKCdsaW1pdC1yZWFkeScpKSBidG4uY2xhc3NMaXN0LnJlbW92ZSgnbGltaXQtcmVhZHknKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoYnRuVGV4dCAmJiBidG5UZXh0LmlubmVyVGV4dCAhPT0gIlNXSU0iKSB7CiAgICAgICAgICAgICAgICAgICAgYnRuVGV4dC5pbm5lclRleHQgPSAiU1dJTSI7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob290LW1vZGUnKTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnbGltaXQtcmVhZHknKTsKICAgICAgICAgICAgICAgICAgICBsYmwuaW5uZXJUZXh0ID0gIk5PUk1BTCI7CiAgICAgICAgICAgICAgICAgICAgbGJsLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob290LWxhYmVsJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFVwZGF0ZSB0YWNrbGUgYnV0dG9uIHZpc2liaWxpdHkKICAgICAgICBpZiAodGFja2xlQnRuKSB7CiAgICAgICAgICAgIGlmICghcC5oYXNCYWxsIHx8IHAuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICB0YWNrbGVCdG4uc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSB0YWNrbGUgYnV0dG9uIHRleHQgYmFzZWQgb24gY29udGV4dAogICAgICAgICAgICAgICAgY29uc3QgdGFja2xlVGV4dCA9IHRhY2tsZUJ0bi5xdWVyeVNlbGVjdG9yKCcuYnRuLXRleHQnKTsKICAgICAgICAgICAgICAgIGlmICh0YWNrbGVUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaXNFbmdhZ2VkICYmIHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVUZXh0LmlubmVyVGV4dCA9ICdCUkVBSyc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCd1cmdlbnQnKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVUZXh0LmlubmVyVGV4dCA9ICdUQUNLTEUnOwogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVCdG4uY2xhc3NMaXN0LnJlbW92ZSgndXJnZW50Jyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFja2xlQnRuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFVwZGF0ZSBkaXN0YW5jZSB0byBnb2FsIGluZGljYXRvcgogICAgICAgIGNvbnN0IGRpc3RJbmRpY2F0b3IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ29hbC1kaXN0YW5jZScpOwogICAgICAgIGlmIChkaXN0SW5kaWNhdG9yICYmIHAubWVzaCkgewogICAgICAgICAgICBjb25zdCBnb2FsWiA9IChwLnRlYW0gJiYgcC50ZWFtLnNpZGUgPT09IDEpID8gLTI4IDogMjg7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLmFicyhwLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgZGlzdEluZGljYXRvci5pbm5lclRleHQgPSBgJHtNYXRoLmZsb29yKGRpc3QpfW1gOwogICAgICAgIH0KICAgIH0KCmZ1bmN0aW9uIHVwZGF0ZUNhbWVyYUxvZ2ljKGR0KSB7CiAgICAgICAgaWYgKCFfY2FtZXJhTWFuYWdlciB8fCAhX2JhbGwpIHJldHVybjsKCiAgICAgICAgbGV0IHRhcmdldE1lc2ggPSBfYmFsbC5tZXNoOwogICAgICAgIGxldCB0YXJnZXRWZWwgPSBfYmFsbC52ZWxvY2l0eTsKICAgICAgICBsZXQgdGFyZ2V0SW5wdXQgPSBudWxsOwogICAgICAgIGxldCBpc0FpbWluZyA9IGZhbHNlOwoKICAgICAgICBpZiAoX2JhbGwuaG9sZGVyICYmIF9iYWxsLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgIHRhcmdldE1lc2ggPSBfYmFsbC5ob2xkZXIubWVzaDsKICAgICAgICAgICAgdGFyZ2V0VmVsID0gX2JhbGwuaG9sZGVyLnZlbG9jaXR5OwogICAgICAgICAgICBpZiAoX2JhbGwuaG9sZGVyLmlucHV0VmVjdG9yKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRJbnB1dCA9IF9iYWxsLmhvbGRlci5pbnB1dFZlY3RvcjsKICAgICAgICAgICAgfQovLyBDaGVjayBhaW1pbmcgc3RhdGUgKENoYXJnaW5nIG9yIFRocm93aW5nKQogICAgICAgICAgICBpZiAoX2JhbGwuaG9sZGVyLmlzQ2hhcmdpbmcgfHwgX2JhbGwuaG9sZGVyLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIGlzQWltaW5nID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KHRhcmdldE1lc2gsIHRhcmdldFZlbCwgdGFyZ2V0SW5wdXQsIGlzQWltaW5nKTsKICAgICAgICBfY2FtZXJhTWFuYWdlci51cGRhdGUoZHQpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNoZWNrQmFsbEdyYWIoZW50aXR5KSB7CiAgICAgICAgaWYgKCFlbnRpdHkuY2FuQ2F0Y2gpIHJldHVybjsKICAgICAgICBpZiAoX2JhbGwgJiYgIV9iYWxsLmlzQ2F0Y2hhYmxlKCkpIHJldHVybjsKICAgICAgICBpZiAoZW50aXR5LnN0dW5UaW1lciA+IDAgfHwgKGVudGl0eS5zdGF0dXMgJiYgZW50aXR5LnN0YXR1cy5uYXAgPiAwKSkgcmV0dXJuOwogICAgICAgIGlmIChfYmFsbC5zdGF0ZSAhPT0gJ2ZyZWUnKSByZXR1cm47CiAgICAgICAgaWYgKCFfYmFsbC5tZXNoIHx8ICFlbnRpdHkubWVzaCkgcmV0dXJuOwoKY29uc3QgYmFsbFBvcyA9IF9iYWxsLm1lc2gucG9zaXRpb247CiAgICAgICAgY29uc3QgZW50UG9zID0gZW50aXR5Lm1lc2gucG9zaXRpb247CgogICAgICAgIGNvbnN0IGR4ID0gYmFsbFBvcy54IC0gZW50UG9zLng7CiAgICAgICAgY29uc3QgZHogPSBiYWxsUG9zLnogLSBlbnRQb3MuejsKICAgICAgICBjb25zdCBkaXN0WFogPSBNYXRoLnNxcnQoZHgqZHggKyBkeipkeik7CiAgICAgICAgY29uc3QgZGlzdFkgPSBNYXRoLmFicyhiYWxsUG9zLnkgLSBlbnRQb3MueSk7CgogICAgICAgIC8vIEFzc2lzdCB0dW5pbmcgKDAuLjEpCiAgICAgICAgY29uc3QgcyA9ICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTyAmJiB3aW5kb3cuZmx1eC5fZGVidWdJTy5zZXR0aW5ncykgPyB3aW5kb3cuZmx1eC5fZGVidWdJTy5zZXR0aW5ncyA6IG51bGw7CiAgICAgICAgY29uc3QgY2F0Y2hBc3Npc3QgPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCAocyAmJiB0eXBlb2Ygcy5jYXRjaEFzc2lzdCA9PT0gJ251bWJlcicpID8gcy5jYXRjaEFzc2lzdCA6IDAuMCkpOwogICAgICAgIGNvbnN0IHByZWRpY3RpdmVUID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMC41LCAocyAmJiB0eXBlb2Ygcy5wcmVkaWN0aXZlQ2F0Y2hUaW1lID09PSAnbnVtYmVyJykgPyBzLnByZWRpY3RpdmVDYXRjaFRpbWUgOiAwLjEyKSk7CgogICAgICAgIC8vIFByZWRpY3RpdmUgc2FtcGxlIChoZWxwcyB3aXRoIGZhc3QgYmFsbHMgdGhhdCBza2ltIGJ5KQogICAgICAgIGNvbnN0IHByZWRQb3MgPSBfdGVtcFZlYzMuY29weShiYWxsUG9zKS5hZGRTY2FsZWRWZWN0b3IoX2JhbGwudmVsb2NpdHksIHByZWRpY3RpdmVUKTsKCiAgICAgICAgY29uc3QgZHhQID0gcHJlZFBvcy54IC0gZW50UG9zLng7CiAgICAgICAgY29uc3QgZHpQID0gcHJlZFBvcy56IC0gZW50UG9zLno7CiAgICAgICAgY29uc3QgZGlzdFhaUHJlZCA9IE1hdGguc3FydChkeFAqZHhQICsgZHpQKmR6UCk7CiAgICAgICAgY29uc3QgZGlzdFlQcmVkID0gTWF0aC5hYnMocHJlZFBvcy55IC0gZW50UG9zLnkpOwoKICAgICAgICBjb25zdCBlZmZEaXN0WFogPSBNYXRoLm1pbihkaXN0WFosIGRpc3RYWlByZWQpOwogICAgICAgIGNvbnN0IGVmZkRpc3RZICA9IE1hdGgubWluKGRpc3RZLCAgZGlzdFlQcmVkKTsKCiAgICAgICAgY29uc3QgdG91Y2hSYWRpdXMgPSAxLjAgKyAoMC42ICogY2F0Y2hBc3Npc3QpOwogICAgICAgIC8vIEJhc2UgcmFkaWkgKHNsaWdodGx5IGZvcmdpdmluZyBieSBkZWZhdWx0OyBhc3Npc3Qgc2NhbGVzIHRoZW0gdXApCiAgICAgICAgbGV0IG1hZ25ldFJhZGl1cyA9IDEuOCArICgxLjYgKiBjYXRjaEFzc2lzdCk7CiAgICAgICAgbGV0IGludGVyYWN0aW9uUmFkaXVzID0gMy41ICsgKDIuMiAqIGNhdGNoQXNzaXN0KTsKICAgICAgICBsZXQgY2F0Y2hIZWlnaHQgPSAzLjAgKyAoMS42ICogY2F0Y2hBc3Npc3QpOwoKICAgICAgICBpZiAoZW50aXR5LmlzRGFzaGluZykgewogICAgICAgICAgICBtYWduZXRSYWRpdXMgPSAzLjA7CiAgICAgICAgICAgIGludGVyYWN0aW9uUmFkaXVzID0gNC41OwogICAgICAgICAgICBjYXRjaEhlaWdodCA9IDQuNTsKICAgICAgICB9CgogICAgICAgIGlmIChlZmZEaXN0WFogPiBpbnRlcmFjdGlvblJhZGl1cyB8fCBlZmZEaXN0WSA+IGNhdGNoSGVpZ2h0KSByZXR1cm47CgogICAgICAgIC8vIE9wdGltaXphdGlvbjogVXNlIHNoYXJlZCB2ZWN0b3JzIHRvIGF2b2lkIEdDCmNvbnN0IHNhbXBsZVBvcyA9IChkaXN0WFpQcmVkIDwgZGlzdFhaKSA/IHByZWRQb3MgOiBiYWxsUG9zOwogICAgICAgIF90ZW1wVmVjMS5jb3B5KHNhbXBsZVBvcykuc3ViKGVudFBvcykubm9ybWFsaXplKCk7IC8vIHRvQmFsbCAocHJlZGljdGl2ZSBpZiBjbG9zZXIpCiAgICAgICAgX3RlbXBWZWMyLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24oZW50aXR5Lm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7IC8vIHBsYXllckZvcndhcmQKCiAgICAgICAgY29uc3QgZmFjaW5nRG90ID0gX3RlbXBWZWMyLmRvdChfdGVtcFZlYzEpOwoKICAgICAgICBjb25zdCBjb25lVGhyZXNob2xkID0gLTAuMiAtICgwLjQgKiAodHlwZW9mIGNhdGNoQXNzaXN0ICE9PSAndW5kZWZpbmVkJyA/IGNhdGNoQXNzaXN0IDogMC4wKSk7CiAgICAgICAgY29uc3QgaXNJbkNvbmUgPSBmYWNpbmdEb3QgPiBjb25lVGhyZXNob2xkOwogICAgICAgIGNvbnN0IGlzSW5Ub3VjaCA9IGVmZkRpc3RYWiA8IHRvdWNoUmFkaXVzOwoKICAgICAgICBpZiAoZWZmRGlzdFhaIDwgaW50ZXJhY3Rpb25SYWRpdXMgJiYgIWlzSW5Db25lKSB7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldEFuZ2xlID0gTWF0aC5hdGFuMihfdGVtcFZlYzEueCwgX3RlbXBWZWMxLnopOwogICAgICAgICAgICBjb25zdCBxID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMSwwKSwgdGFyZ2V0QW5nbGUpOwogICAgICAgICAgICBlbnRpdHkubWVzaC5xdWF0ZXJuaW9uLnNsZXJwKHEsIDAuMSk7CiAgICAgICAgICAgIGlmIChlbnRpdHkuc3luY1JvdGF0aW9uKSBlbnRpdHkuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgfQoKLy8gKFJlbW92ZWQgZHVwbGljYXRlIGxvZ2ljIGJsb2NrKQoKICAgICAgICBpZiAoaXNJblRvdWNoIHx8IChlZmZEaXN0WFogPCBtYWduZXRSYWRpdXMgJiYgaXNJbkNvbmUpKSB7CiAgICAgICAgICAgIC8vIEJMQVNUIFRIUk9VR0ggTE9HSUMKICAgICAgICAgICAgY29uc3QgYmFsbFNwZWVkID0gX2JhbGwudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgIGxldCBjYXRjaENoYW5jZSA9IDEuMDsKCiAgICAgICAgICAgIC8vIElmIGJhbGwgaXMgbW92aW5nIGZhc3QgKGUuZy4gPiAyMCksIGNoZWNrIENBCiAgICAgICAgICAgIGlmIChiYWxsU3BlZWQgPiAyMC4wKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjYSA9IGVudGl0eS5nZXRTdGF0KCdDQScpOwogICAgICAgICAgICAgICAgLy8gRGlmZmljdWx0eSBzY2FsZXMgd2l0aCBzcGVlZC4gCiAgICAgICAgICAgICAgICBjb25zdCBkaWZmaWN1bHR5ID0gYmFsbFNwZWVkICogMS4yOyAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGRpZmZpY3VsdHkgPiBjYSkgewogICAgICAgICAgICAgICAgICAgIGNhdGNoQ2hhbmNlID0gMC40ICsgKGNhIC8gZGlmZmljdWx0eSkgKiAwLjY7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUG9pbnQgQmxhbmsgUGVuYWx0eTogSGFyZGVyIHRvIHJlYWN0IGlmIGJhbGwgaXMgcmlnaHQgb24gdG9wIG9mIHlvdSBtb3ZpbmcgZmFzdAogICAgICAgICAgICAgICAgICAgIGlmIChlZmZEaXN0WFogPCAxLjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2F0Y2hDaGFuY2UgKj0gMC42OyAvLyBCbGFzdCB0aHJvdWdoIGxpa2VseQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoZW50aXR5LmlzRGFzaGluZykgY2F0Y2hDaGFuY2UgKz0gMC4yOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKF9iYWxsLnBvd2VyVHlwZSA9PT0gJ1NIJyAmJiBfYmFsbC5wb3dlciA+IDE1LjApIHsKICAgICAgICAgICAgICAgIC8vIFNob3QgcG93ZXIgY2hlY2sKICAgICAgICAgICAgICAgIGNvbnN0IGNhID0gZW50aXR5LmdldFN0YXQoJ0NBJyk7CiAgICAgICAgICAgICAgICBpZiAoX2JhbGwucG93ZXIgPiBjYSAqIDEuMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5jZSA9IE1hdGgubWluKDAuNywgKF9iYWxsLnBvd2VyIC0gY2EpICogMC4wNCk7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hDaGFuY2UgPSAxLjAgLSBjaGFuY2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFzc2lzdCBudWRnZXMgY2F0Y2ggb2RkcyB1cHdhcmQgKG5ldmVyIGd1YXJhbnRlZXMpCiAgICAgICAgICAgIGlmICh0eXBlb2YgY2F0Y2hBc3Npc3QgIT09ICd1bmRlZmluZWQnICYmIGNhdGNoQXNzaXN0ID4gMCkgewogICAgICAgICAgICAgICAgY2F0Y2hDaGFuY2UgPSBNYXRoLm1heCgwLjA1LCBNYXRoLm1pbigxLjAsIGNhdGNoQ2hhbmNlICogKDEuMCAtIDAuMjUgKiBjYXRjaEFzc2lzdCkgKyAoMC4yNSAqIGNhdGNoQXNzaXN0KSkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgZnVtYmxlID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gY2F0Y2hDaGFuY2UpIHsKICAgICAgICAgICAgICAgIGZ1bWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmdW1ibGUpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIGZlZWRiYWNrIGZvciBibGFzdCB0aHJvdWdoCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxBU1QgVEhST1VHSCEiLCBlbnRQb3MsICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGVmbGVjdCBzbGlnaHRseSBidXQga2VlcCBtb3ZpbmcgZmFzdCAoQmxhc3QgVGhyb3VnaCkKICAgICAgICAgICAgICAgIC8vIERvbid0IHN0b3AgaXQgY29tcGxldGVseSBsaWtlIGEgYmxvY2ssIGp1c3QgcGVydHVyYiBpdAogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC44NSk7IAogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogNS4wOwogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkueSArPSAoTWF0aC5yYW5kb20oKSkgKiA1LjA7IC8vIFBvcCB1cAogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogNS4wOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfYmFsbC5wb3dlciAqPSAwLjc7CgogICAgICAgICAgICAgICAgZW50aXR5LmNhbkNhdGNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBTdHVuIGJyaWVmbHkKICAgICAgICAgICAgICAgIGVudGl0eS5zdHVuVGltZXIgPSAwLjU7CiAgICAgICAgICAgICAgICBpZihlbnRpdHkucGxheSkgZW50aXR5LnBsYXkoJ3JlYWN0JywgMC4xKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IGVudGl0eS5jYW5DYXRjaCA9IHRydWU7IH0sIDEwMDApOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9iYWxsLm1hZ25ldGl6ZShlbnRpdHkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIFN0YXJ0CiAgICBpbml0KCk7Cn0pKCk7","Ball.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIHZlY3RvcnMgdG8gYXZvaWQgR0MKY29uc3QgX2JWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2JEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2F4aXNZID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CiAgICBjb25zdCBfdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbWFnbnVzVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCi8vIFBoeXNpY3MgQ29uZmlndXJhdGlvbiAoRXhwb3NlZCBmb3IgRGV2VG9vbHMpCndpbmRvdy5mbHV4LkJhbGxDb25maWcgPSB7CiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBDb3JlIGludGVncmF0aW9uCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBTVUJTVEVQUzogMiwgICAgICAgICAgICAgICAgLy8gUGh5c2ljcyBzdWJzdGVwcyBwZXIgZnJhbWUgKHN0YWJpbGl0eSBhdCBoaWdoIHNwZWVkcykKICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLCAgICAgICAgICAgLy8gQmVsb3cgdGhpcyBzcGVlZCwgc25hcCB0byByZXN0IChwcmV2ZW50cyBlbmRsZXNzIGRyaWZ0KQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFdhdGVyIHJlc2lzdGFuY2UgKHBoeXNpY2FsIHZlbG9jaXR5IGRyYWcsIE5PVCBzdGF0IGRlY2F5KQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMTUsICAgIC8vIExpbmVhciBkcmFnIHRlcm0gKHJvdWdobHkgeW91ciBwcmV2aW91cyBXQVRFUl9EUkFHKQogICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDIsICAgICAvLyBRdWFkcmF0aWMgZHJhZyAoc3Ryb25nZXIgYXQgaGlnaCBzcGVlZCwgaGVscHMgdGFtZSByb2NrZXRzKQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFNwaW4gJiBjdXJ2ZQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgU1BJTl9EUkFHOiAwLjQwLCAgICAgICAgICAgIC8vIFNwaW4gZGVjYXkgcGVyIHNlY29uZAogICAgICAgIE1BR05VU19FTkFCTEVEOiB0cnVlLAogICAgICAgIE1BR05VU19DT0VGRjogMC4wOCwgICAgICAgICAvLyBMaWZ0IHN0cmVuZ3RoCiAgICAgICAgTUFHTlVTX0NBUDogNjAuMCwgICAgICAgICAgIC8vIE1heCBtYWdudXMgZGVsdGEtViBwZXIgc3Vic3RlcCAocHJldmVudHMgZXhwbG9zaW9ucykKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBEZXB0aCBjb25zdHJhaW50IChrZWVwcyBiYWxsIG5lYXIgcGxheSBwbGFuZSB3aXRob3V0IGZlZWxpbmcgbGlrZSBhIGhhcmQgZmxvb3IpCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBERVBUSF9UQVJHRVRfWTogMC4wLAogICAgICAgIERFUFRIX1NQUklORzogMS4wLCAgICAgICAgICAvLyBZb3VyIHByZXZpb3VzIEdSQVZJVFlfU1BSSU5HCiAgICAgICAgREVQVEhfREFNUDogMS41LCAgICAgICAgICAgIC8vIFlvdXIgcHJldmlvdXMgR1JBVklUWV9EQU1QCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gQXJlbmEgYm91bmRhcnkgKHNvZnQgd2FsbCArIGNsYW1wKQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCkJPVU5EQVJZX1JBRElVUzogNDYuMCwKICAgICAgICBCT1VOREFSWV9IRUlHSFQ6IDIwLjAsCiAgICAgICAgR09BTF9QT0NLRVRfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBHT0FMX1BPQ0tFVF9YOiAxMi4wLCAgICAgICAgLy8gSGFsZi13aWR0aCBvZiBnb2FsIHBvY2tldCBjb3JyaWRvcgogICAgICAgIEdPQUxfUE9DS0VUX1o6IDQwLjAsICAgICAgICAvLyBTdGFydCBvZiBnb2FsIHBvY2tldCBjb3JyaWRvciAoYWJzIHopIC0gUHVzaGVkIGJhY2sKICAgICAgICBHT0FMX1BPQ0tFVF9SQURJVVM6IDU1LjAsICAgLy8gRWZmZWN0aXZlIHJhZGl1cyB3aGVuIGluIGdvYWwgcG9ja2V0CiAgICAgICAgV0FMTF9TT0ZUX0JVRkZFUjogMy4wLCAgICAgIC8vIERpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMKICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDIwLjAsICAgICAgLy8gU29mdCByZXB1bHNpb24gc3RyZW5ndGgKICAgICAgICBXQUxMX0VMQVNUSUNJVFk6IDAuMzAsICAgICAgLy8gQm91bmNlIGRhbXBlbmluZyBvbiBjbGFtcAogICAgICAgIFdBTExfRlJJQ1RJT046IDAuOTUsICAgICAgICAvLyBUYW5nZW50aWFsIGRhbXBpbmcgb24gd2FsbCBjb250YWN0CgogICAgICAgIEZMT09SX0VMQVNUSUNJVFk6IDAuNDAsICAgICAvLyBCb3VuY2UgZGFtcGVuaW5nIG9uIGNlaWxpbmcvZmxvb3IgY2xhbXAKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBUaHJvdyBtYXBwaW5nIChzdGF0IGZvcmNlIC0+IHBoeXNpY2FsIGxhdW5jaCBzcGVlZCkKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIExBVU5DSF9TUEVFRF9TQ0FMRTogMS4wLCAgICAvLyBNdWx0aXBsaWVzIGZvcmNlIHdoZW4gY29udmVydGluZyB0byB2ZWxvY2l0eQogICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDg1LjAgICAgICAvLyBQaHlzaWNhbCBzcGVlZCBjYXAgKHdhcyBoYXJkY29kZWQgaW4gQmFsbC5zaG9vdCkKICAgIH07CgoKICAgIAogICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWc7IC8vIExvY2FsIGFsaWFzIGZvciBicmV2aXR5CiAgICAvLyAtLS0gVFJBSUwgUkVOREVSRVIgLS0tCi8vIC0tLSBUUkFJTCBSRU5ERVJFUiAtLS0KICAgIGNsYXNzIFRyYWlsUmVuZGVyZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5zZWdtZW50cyA9IDMwOyAvLyBNb3JlIHNlZ21lbnRzIGZvciBzbW9vdGhlciBjdXJ2ZXMKICAgICAgICAgICAgdGhpcy5wb2ludHMgPSBbXTsKdGhpcy5iYXNlV2lkdGggPSAwLjg7IC8vIEluY3JlYXNlZCB3aWR0aCBmb3IgdmlzaWJpbGl0eQogICAgICAgICAgICB0aGlzLmN1cnJlbnRXaWR0aCA9IDAuODsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJ5CiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgICAgIGNvbnN0IHBvc0RhdGEgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuc2VnbWVudHMgKiAyICogMyk7CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHBvc0RhdGEsIDMpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluZGljZXMKICAgICAgICAgICAgY29uc3QgaW5kaWNlcyA9IFtdOwogICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50cy0xOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhc2UgPSBpKjI7CiAgICAgICAgICAgICAgICBpbmRpY2VzLnB1c2goYmFzZSwgYmFzZSsxLCBiYXNlKzIpOwogICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGJhc2UrMSwgYmFzZSszLCBiYXNlKzIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEluZGV4KGluZGljZXMpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBjb2xvcjogMHgwMGFhZmYsCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLjksIC8vIEluY3JlYXNlZCBvcGFjaXR5CiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLm1lc2gpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW5pdCBwb2ludHMKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB0aGlzLnBvaW50cy5wdXNoKG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUmV1c2FibGUgdGVtcHMgKGF2b2lkIHBlci1mcmFtZSBhbGxvY2F0aW9ucyBvbiBtb2JpbGUpCiAgICAgICAgICAgIHRoaXMuX3RtcERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuX3RtcFRvQ2FtID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5fdG1wUmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXNldChwb3MpIHsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB0aGlzLnBvaW50c1tpXS5jb3B5KHBvcyk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlR2VvbWV0cnkoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgc2V0Q29sb3IoaGV4KSB7CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KGhleCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZShjdXJyZW50UG9zLCBzcGVlZFJhdGlvID0gMC4wKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXQoY3VycmVudFBvcyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCi8vIER5bmFtaWMgV2lkdGggYmFzZWQgb24gc3BlZWQgQU5EIFNQSU4gKFBvd2VyIFZpc3VhbCkKICAgICAgICAgICAgLy8gRmFzdCBiYWxsID0gVGhpY2tlci4gU3Bpbm5pbmcgYmFsbCA9IEV2ZW4gVGhpY2tlci4KICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgY29uc3Qgc3BpblJhdGlvID0gYmFsbCA/IE1hdGgubWluKDEuMCwgYmFsbC5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkgLyAzMC4wKSA6IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB0YXJnZXRXaWR0aCA9IHRoaXMuYmFzZVdpZHRoICogKDAuOCArIHNwZWVkUmF0aW8gKiAxLjIgKyBzcGluUmF0aW8gKiAyLjApOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRXaWR0aCArPSAodGFyZ2V0V2lkdGggLSB0aGlzLmN1cnJlbnRXaWR0aCkgKiAwLjI7IC8vIFNtb290aCB0cmFuc2l0aW9uCgogICAgICAgICAgICAvLyBTaGlmdCBwb2ludHMKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuc2VnbWVudHMgLSAxOyBpID4gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBvaW50c1tpXS5jb3B5KHRoaXMucG9pbnRzW2ktMV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucG9pbnRzWzBdLmNvcHkoY3VycmVudFBvcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVwZGF0ZUdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZUdlb21ldHJ5KCkgewogICAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5hcnJheTsKICAgICAgICAgICAgY29uc3QgY2FtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSA6IG51bGw7CiAgICAgICAgICAgIGlmICghY2FtKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IGNhbS5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgdGVtcERpciA9IHRoaXMuX3RtcERpcjsKICAgICAgICAgICAgY29uc3QgdGVtcFRvQ2FtID0gdGhpcy5fdG1wVG9DYW07CiAgICAgICAgICAgIGNvbnN0IHRlbXBSaWdodCA9IHRoaXMuX3RtcFJpZ2h0OwogICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5wb2ludHNbaV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRhcGVyIHdpZHRoIGFsb25nIHRyYWlsIGxlbmd0aAogICAgICAgICAgICAgICAgY29uc3QgdGFwZXIgPSAxLjAgLSBNYXRoLnBvdyhpIC8gdGhpcy5zZWdtZW50cywgMik7IC8vIFF1YWRyYXRpYyB0YXBlcgogICAgICAgICAgICAgICAgY29uc3QgdyA9IHRoaXMuY3VycmVudFdpZHRoICogdGFwZXI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIGlmIChpIDwgdGhpcy5zZWdtZW50cyAtIDEpIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wRGlyLnN1YlZlY3RvcnModGhpcy5wb2ludHNbaV0sIHRoaXMucG9pbnRzW2krMV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wRGlyLnN1YlZlY3RvcnModGhpcy5wb2ludHNbaS0xXSwgdGhpcy5wb2ludHNbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGVtcERpci5sZW5ndGhTcSgpIDwgMC4wMDAxKSB0ZW1wRGlyLnNldCgwLCAxLCAwKTsKICAgICAgICAgICAgICAgIHRlbXBEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRlbXBUb0NhbS5zdWJWZWN0b3JzKGNhbVBvcywgcCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0ZW1wUmlnaHQuY3Jvc3NWZWN0b3JzKHRlbXBEaXIsIHRlbXBUb0NhbSkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIodyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZlcnQgMQogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDBdID0gcC54IC0gdGVtcFJpZ2h0Lng7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgMV0gPSBwLnkgLSB0ZW1wUmlnaHQueTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAyXSA9IHAueiAtIHRlbXBSaWdodC56OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZXJ0IDIKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAzXSA9IHAueCArIHRlbXBSaWdodC54OwogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDRdID0gcC55ICsgdGVtcFJpZ2h0Lnk7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgNV0gPSBwLnogKyB0ZW1wUmlnaHQuejsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgfQogICAgfQpjbGFzcyBCYWxsIHsKCiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7IAogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSBudWxsOyAvLyBUcmFjayB3aG8gdGhyZXcgaXQgbGFzdCAoZm9yIEVYUC9Bc3Npc3RzKQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOyAvLyAnZnJlZScsICdoZWxkJywgJ21hZ25ldGl6ZWQnCiAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIENvbnRpbnVvdXMgU3RhdHMKICAgICAgICAgICAgdGhpcy5wb3dlciA9IDA7ICAgICAgLy8gQ3VycmVudCBQQSBvciBTSCB2YWx1ZQogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9ICdub25lJzsgLy8gJ1BBJyBvciAnU0gnCiAgICAgICAgICAgIHRoaXMuZGVjYXlSYXRlID0gMy4wOyAvLyBTdGF0IHBvaW50cyBsb3N0IHBlciBzZWNvbmQgKFdhdGVyIHJlc2lzdGFuY2UpCiAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7IC8vIFRpbWUgYmVmb3JlIGJhbGwgY2FuIGJlIGNhdWdodCBhZ2FpbgoKICAgICAgICAgICAgLy8gTWFnbmV0IFN5c3RlbQogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1hZ25ldER1cmF0aW9uID0gMC4yOyAKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gVmlzdWFscyAoU3F1YXNoICYgU3RyZXRjaCkKICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zcGluTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubW9kZWwgPSBudWxsOwoKdGhpcy5pbml0TWVzaCgpOwogICAgICAgICAgICB0aGlzLnRyYWlsID0gbmV3IFRyYWlsUmVuZGVyZXIoc2NlbmUpOwogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDA7Cn0KaW5pdE1lc2goKSB7CiAgICAgICAgICAgIC8vIEhpZXJhcmNoeTogTWVzaCAoUG9zKSAtPiBEZWZvcm0gKFNxdWFzaC9TdHJldGNoKSAtPiBTcGluIChSb3RhdGlvbikgLT4gTW9kZWwKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7CgogICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKdGhpcy5kZWZvcm1Ob2RlID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5wb3NpdGlvbi55ID0gMC4wOyAvLyBSZXNldCBvZmZzZXQgc28gYmFsbCBpcyBjZW50ZXJlZCBvbiBtZXNoIHBvc2l0aW9uCiAgICAgICAgICAgIHRoaXMubWVzaC5hZGQodGhpcy5kZWZvcm1Ob2RlKTsgLy8gRml4OiBBZGQgZGVmb3JtTm9kZSB0byBtZXNoCgogICAgICAgICAgICB0aGlzLnNwaW5Ob2RlID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5hZGQodGhpcy5zcGluTm9kZSk7CgogICAgICAgICAgICAvLyBQcm9jZWR1cmFsIFBsYWNlaG9sZGVyIFRleHR1cmUgKEJsaXR6YmFsbC1pc2gpCiAgICAgICAgICAgIGNvbnN0IHBsYWNlaG9sZGVyVGV4ID0gKCgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICAgICAgICAgIGMud2lkdGggPSAxMjg7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNlZWVlZWUnOwogICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsMCwxMjgsNjQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBCbHVlIGJ1bXBzL2RldGFpbHMKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwODhmZic7CiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw2OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmFyYyhpKjI1LCAzMiwgMTAsIDAsIE1hdGguUEkqMik7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwNDQ4OCc7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMjgsIDEyOCwgOCk7IC8vIFN0cmlwZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICAgICAgICAgIH0pKCk7CgogICAgICAgICAgICAvLyBQbGFjZWhvbGRlciBWaXN1YWwgKEltbWVkaWF0ZSBmZWVkYmFjaywgcGVyc2lzdHMgdW50aWwgdmFsaWQgbW9kZWwgbG9hZHMpCi8vIFBsYWNlaG9sZGVyIFZpc3VhbCAoSW1tZWRpYXRlIGZlZWRiYWNrLCBwZXJzaXN0cyB1bnRpbCB2YWxpZCBtb2RlbCBsb2FkcykKLy8gUGxhY2Vob2xkZXIgVmlzdWFsIChJbW1lZGlhdGUgZmVlZGJhY2ssIHBlcnNpc3RzIHVudGlsIHZhbGlkIG1vZGVsIGxvYWRzKQpjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeSgwLjMsIDE2LCAxNik7IC8vIFNjYWxlZCBkb3duIH4xNSUKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgbWFwOiBwbGFjZWhvbGRlclRleCwKICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZiwgCiAgICAgICAgICAgICAgICB3aXJlZnJhbWU6IGZhbHNlLCAvLyBTb2xpZAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IGZhbHNlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMS4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsKTsKCiAgICAgICAgICAgIC8vIExvYWQgR0xCIE1vZGVsCiAgICAgICAgICAgIGNvbnN0IHVybCA9ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTIxYWU4Nzg4ZTU4NGUzNzhhNzlkOTczMmEwNzUzNTYuZ2xiJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbCh1cmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiREVCVUc6IEJhbGwgR0xCIGxvYWRlZC4iLCBnbHRmKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgbW9kZWwgPSBnbHRmLnNjZW5lOwoKICAgICAgICAgICAgICAgIC8vIDEuIFJlc2V0IHJvb3QgdHJhbnNmb3JtcwogICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgbW9kZWwucm90YXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgbW9kZWwuc2NhbGUuc2V0KDEsIDEsIDEpOwogICAgICAgICAgICAgICAgbW9kZWwudXBkYXRlTWF0cml4V29ybGQodHJ1ZSk7CgogICAgICAgICAgICAgICAgLy8gMi4gSGFyZGVuIE1hdGVyaWFscyAmIFZpc2liaWxpdHkKICAgICAgICAgICAgICAgIG1vZGVsLnRyYXZlcnNlKChub2RlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuY2FzdFNoYWRvdyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBub2RlLnJlY2VpdmVTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7IC8vIENSSVRJQ0FMOiBQcmV2ZW50IGN1bGxpbmcgaWYgYm91bmRzIGFyZSBvZmYKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRzID0gQXJyYXkuaXNBcnJheShub2RlLm1hdGVyaWFsKSA/IG5vZGUubWF0ZXJpYWwgOiBbbm9kZS5tYXRlcmlhbF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRzLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5jb2xvci5zZXRIZXgoMHhmZmZmZmYpOyAvLyBGb3JjZSB3aGl0ZSBiYXNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5zaWRlID0gVEhSRUUuRG91YmxlU2lkZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnRyYW5zcGFyZW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5vcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uYWxwaGFUZXN0ID0gMDsgLy8gQ1JJVElDQUw6IERpc2FibGUgYWxwaGEgdGVzdCB0byBwcmV2ZW50IGN1bGxpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLmRlcHRoV3JpdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uZGVwdGhUZXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgLy8gMy4gQ29tcHV0ZSBCb3VuZGluZyBCb3gKICAgICAgICAgICAgICAgIGNvbnN0IGJveCA9IG5ldyBUSFJFRS5Cb3gzKCkuc2V0RnJvbU9iamVjdChtb2RlbCk7CiAgICAgICAgICAgICAgICBjb25zdCBzaXplID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgIGJveC5nZXRTaXplKHNpemUpOwogICAgICAgICAgICAgICAgY29uc3QgY2VudGVyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgIGJveC5nZXRDZW50ZXIoY2VudGVyKTsKCiAgICAgICAgICAgICAgICAvLyA0LiBWYWxpZGF0aW9uCiAgICAgICAgICAgICAgICBjb25zdCBtYXhEaW0gPSBNYXRoLm1heChzaXplLngsIHNpemUueSwgc2l6ZS56KTsKICAgICAgICAgICAgICAgIGlmIChtYXhEaW0gPD0gMC4wMDEgfHwgIWlzRmluaXRlKG1heERpbSkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkJhbGwgbW9kZWwgaGFzIGludmFsaWQgZGltZW5zaW9ucy4gS2VlcGluZyBwbGFjZWhvbGRlci4iKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDUuIENhbGN1bGF0ZSBTY2FsZQovLyA1LiBDYWxjdWxhdGUgU2NhbGUKY29uc3QgdGFyZ2V0RGlhbWV0ZXIgPSAwLjcyOyAvLyBSZWR1Y2VkIHNjYWxlIGJ5IH4xNSUgKHdhcyAwLjg1KQogICAgICAgICAgICAgICAgY29uc3Qgc2NhbGVGYWN0b3IgPSB0YXJnZXREaWFtZXRlciAvIG1heERpbTsKCiAgICAgICAgICAgICAgICAvLyA2LiBBcHBseSBUcmFuc2Zvcm1zCiAgICAgICAgICAgICAgICBtb2RlbC5zY2FsZS5zZXRTY2FsYXIoc2NhbGVGYWN0b3IpOwogICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uY29weShjZW50ZXIpLm11bHRpcGx5U2NhbGFyKC1zY2FsZUZhY3Rvcik7CgogICAgICAgICAgICAgICAgLy8gNy4gU3dhcCBQbGFjZWhvbGRlcgogICAgICAgICAgICAgICAgaWYgKHRoaXMucGxhY2Vob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNwaW5Ob2RlLnJlbW92ZSh0aGlzLnBsYWNlaG9sZGVyKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlci5nZW9tZXRyeSkgdGhpcy5wbGFjZWhvbGRlci5nZW9tZXRyeS5kaXNwb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGFjZWhvbGRlciA9IG51bGw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5tb2RlbCA9IG1vZGVsOwogICAgICAgICAgICAgICAgdGhpcy5zcGluTm9kZS5hZGQodGhpcy5tb2RlbCk7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgQmxpdHpiYWxsIG1vZGVsIGF0dGFjaGVkLiBTY2FsZTogJHtzY2FsZUZhY3Rvci50b0ZpeGVkKDQpfWApOwoKICAgICAgICAgICAgfSwgdW5kZWZpbmVkLCAoZXJyKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJGYWlsZWQgdG8gbG9hZCBCbGl0emJhbGwgbW9kZWw6IiwgZXJyKTsKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrOiBLZWVwIHBsYWNlaG9sZGVyIGJ1dCB0aW50IGl0IHJlZCB0byBpbmRpY2F0ZSBlcnJvcgogICAgICAgICAgICAgICAgaWYgKHRoaXMucGxhY2Vob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmYWFhYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQmFsbCBMYWIgcmVwbGF5IG92ZXJyaWRlIChsZXRzIERldlRvb2xzIGRyaXZlIHRoZSBiYWxsIGRldGVybWluaXN0aWNhbGx5KQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzICYmIHR5cGVvZiBfX2xhYi5hcHBseVJlcGxheUZyYW1lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBfX2xhYi5hcHBseVJlcGxheUZyYW1lKHRoaXMsIGR0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRyYWlsKSB0aGlzLnRyYWlsLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBpZiBwb3NpdGlvbiBjb3JydXB0ZWQKICAgICAgICAgICAgaWYgKGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi54KSB8fCBpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueSkgfHwgaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLnopKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNhZmV0eTogRml4ICJVbnBpY2thYmxlIEJhbGwiIEJ1ZwogICAgICAgICAgICAvLyBJZiBzdGF0ZSBpcyAnaGVsZCcgb3IgJ21hZ25ldGl6ZWQnIGJ1dCB0aGUgYWN0b3IgaXMgbWlzc2luZy9pbnZhbGlkLCBmb3JjZSBkcm9wIHRvICdmcmVlJy4KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdoZWxkJyAmJiAoIXRoaXMuaG9sZGVyIHx8ICF0aGlzLmhvbGRlci5tZXNoKSkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdtYWduZXRpemVkJyAmJiAoIXRoaXMubWFnbmV0VGFyZ2V0IHx8ICF0aGlzLm1hZ25ldFRhcmdldC5tZXNoKSkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgIH0KaWYgKHRoaXMudHJhaWwpIHsKICAgICAgICAgICAgICAgIC8vIFRyYWlsIGlzIGFjdGl2ZSBpZiBiYWxsIGlzIG1vdmluZyBmYXN0IGFuZCBmcmVlCiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICB0aGlzLnRyYWlsLmFjdGl2ZSA9ICh0aGlzLnN0YXRlID09PSAnZnJlZScgJiYgc3BlZWQgPiAyLjApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGaXg6IE9mZnNldCB0cmFpbCB0byBtYXRjaCB2aXN1YWwgbW9kZWwgcG9zaXRpb24gKGRlZm9ybU5vZGUgb2Zmc2V0KQogICAgICAgICAgICAgICAgX2JWZWMuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgX2JWZWMueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKCiAgICAgICAgICAgICAgICAvLyBQYXNzIHNwZWVkIHJhdGlvICgwIHRvIDEgYmFzZWQgb24gbWF4IHNwZWVkIGFwcHJveCA2MCkKICAgICAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4oc3BlZWQgLyA2MC4wLCAxLjApOwogICAgICAgICAgICAgICAgdGhpcy50cmFpbC51cGRhdGUoX2JWZWMsIHJhdGlvKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdoZWxkJyAmJiB0aGlzLmhvbGRlciAmJiB0aGlzLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUhlbGQoZHQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc3RhdGUgPT09ICdtYWduZXRpemVkJykgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVNYWduZXRpemVkKGR0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlRnJlZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgLT0gZHQ7CiAgICAgICAgICAgIH0KCnRoaXMudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTYWZldHk6IEVuc3VyZSB2aXNpYmlsaXR5IGlmIG5vdCBleHBsaWNpdGx5IGludmlzaWJsZQovLyBTYWZldHk6IEVuc3VyZSB2aXNpYmlsaXR5IGlmIG5vdCBleHBsaWNpdGx5IGludmlzaWJsZQogICAgICAgICAgICBpZiAodGhpcy5tZXNoICYmICF0aGlzLmlzSW52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBGb3JjZSBtb2RlbCB2aXNpYmlsaXR5IGlmIHByZXNlbnQgKHNvbWV0aW1lcyBHTFRGIGxvYWRlciBoaWRlcyBpdCkKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1vZGVsKSB0aGlzLm1vZGVsLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKbWFnbmV0aXplKHRhcmdldCkgewogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ21hZ25ldGl6ZWQnIHx8IHRoaXMuc3RhdGUgPT09ICdoZWxkJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtYWduZXRpemVkJzsKICAgICAgICAgICAgdGhpcy5tYWduZXRUYXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICAgIHRoaXMuaG9sZGVyID0gdGFyZ2V0OyAvLyBMb2dpY2FsIHBvc3Nlc3Npb24gc28gQUkgcmVhY3RzCiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1hZ25ldFN0YXJ0UG9zLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFZlbC5jb3B5KHRoaXMudmVsb2NpdHkpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRHluYW1pYyBEdXJhdGlvbiBiYXNlZCBvbiBkaXN0YW5jZSAoU21vb3RoZXIgZm9yIGxvbmcgcmFuZ2UsIHNuYXBweSBmb3IgY2xvc2UpCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIHRoaXMubWFnbmV0RHVyYXRpb24gPSBNYXRoLm1heCgwLjE1LCBNYXRoLm1pbigwLjQsIGRpc3QgLyAxNS4wKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBLaWxsIHBoeXNpY3MKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIE5vdGlmeSBwbGF5ZXIgaW1tZWRpYXRlbHkgc28gdGhleSBzdG9wIGNoYXNpbmcgYW5kIHBsYXkgYW5pbWF0aW9uCiAgICAgICAgICAgIGlmICh0YXJnZXQucmVjZWl2ZUJhbGwpIHsKICAgICAgICAgICAgICAgIHRhcmdldC5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnJldmVhbCgpOwogICAgICAgIH0KCnVwZGF0ZU1hZ25ldGl6ZWQoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1hZ25ldFRhcmdldCB8fCAhdGhpcy5tYWduZXRUYXJnZXQubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgKz0gZHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3JtYWxpemVkIFRpbWUKICAgICAgICAgICAgbGV0IHQgPSB0aGlzLm1hZ25ldFRpbWVyIC8gdGhpcy5tYWduZXREdXJhdGlvbjsKICAgICAgICAgICAgaWYgKHQgPiAxLjApIHQgPSAxLjA7CgogICAgICAgICAgICAvLyBUYXJnZXQgIlZpcnR1YWwgSGFuZCIgUG9zaXRpb24gKEZyb250IG9mIENoZXN0KQogICAgICAgICAgICBjb25zdCBob2xkZXJQb3MgPSB0aGlzLm1hZ25ldFRhcmdldC5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBob2xkZXJRdWF0ID0gdGhpcy5tYWduZXRUYXJnZXQubWVzaC5xdWF0ZXJuaW9uOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT2Zmc2V0OiBGb3J3YXJkIDAuNiwgVXAgMS4wIChDaGVzdCBoZWlnaHQpCiAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IF9iVmVjLnNldCgwLCAxLjAsIDAuNikuYXBwbHlRdWF0ZXJuaW9uKGhvbGRlclF1YXQpOwogICAgICAgICAgICBjb25zdCB0YXJnZXRQb3MgPSBvZmZzZXQuYWRkKGhvbGRlclBvcyk7CgogICAgICAgICAgICAvLyAtLS0gUVVBRFJBVElDIEJFWklFUiBDVVJWRSAtLS0KICAgICAgICAgICAgLy8gUDAgPSBTdGFydCwgUDIgPSBUYXJnZXQKICAgICAgICAgICAgLy8gUDEgPSBDb250cm9sIFBvaW50IChQcm9qZWN0ZWQgYWxvbmcgaW5pdGlhbCB2ZWxvY2l0eSB0byBwcmVzZXJ2ZSBtb21lbnR1bSBmZWVsKQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcDAgPSB0aGlzLm1hZ25ldFN0YXJ0UG9zOwogICAgICAgICAgICBjb25zdCBwMiA9IHRhcmdldFBvczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBQMSAoQ29udHJvbCBQb2ludCkKICAgICAgICAgICAgLy8gUHJvamVjdCBmb3J3YXJkIGZyb20gUDAgYWxvbmcgc3RhcnQgdmVsb2NpdHkgdmVjdG9yCiAgICAgICAgICAgIC8vIERpc3RhbmNlIG9mIHByb2plY3Rpb24gPSA0MCUgb2YgdG90YWwgZGlzdGFuY2UgdG8gdGFyZ2V0CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBwMC5kaXN0YW5jZVRvKHAyKTsKICAgICAgICAgICAgY29uc3QgcDEgPSBfdGVtcFZlYy5jb3B5KHAwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHZlbExlbiA9IHRoaXMubWFnbmV0U3RhcnRWZWwubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHZlbExlbiA+IDEuMCkgewogICAgICAgICAgICAgICAgLy8gVXNlIHZlbG9jaXR5IHRhbmdlbnQKLy8gVXNlIHZlbG9jaXR5IHRhbmdlbnQKICAgICAgICAgICAgICAgIF9iRGlyLmNvcHkodGhpcy5tYWduZXRTdGFydFZlbCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBwMS5hZGQoX2JEaXIubXVsdGlwbHlTY2FsYXIoZGlzdCAqIDAuNCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gTm8gdmVsb2NpdHkgKHN0YXRpb25hcnkgYmFsbCksIGFyYyB1cHdhcmRzIHNsaWdodGx5CiAgICAgICAgICAgICAgICBwMS5sZXJwKHAyLCAwLjUpOwogICAgICAgICAgICAgICAgcDEueSArPSAxLjU7IAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCZXppZXI6IEIodCkgPSAoMS10KV4yICogUDAgKyAyKDEtdCl0ICogUDEgKyB0XjIgKiBQMgogICAgICAgICAgICBjb25zdCBvbmVNaW51c1QgPSAxLjAgLSB0OwogICAgICAgICAgICBjb25zdCB3MCA9IG9uZU1pbnVzVCAqIG9uZU1pbnVzVDsKICAgICAgICAgICAgY29uc3QgdzEgPSAyLjAgKiBvbmVNaW51c1QgKiB0OwogICAgICAgICAgICBjb25zdCB3MiA9IHQgKiB0OwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnggPSAodzAgKiBwMC54KSArICh3MSAqIHAxLngpICsgKHcyICogcDIueCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gKHcwICogcDAueSkgKyAodzEgKiBwMS55KSArICh3MiAqIHAyLnkpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueiA9ICh3MCAqIHAwLnopICsgKHcxICogcDEueikgKyAodzIgKiBwMi56KTsKCiAgICAgICAgICAgIC8vIEZpbmlzaAogICAgICAgICAgICBpZiAodCA+PSAxLjApIHsKICAgICAgICAgICAgICAgIHRoaXMuZ3JhYih0aGlzLm1hZ25ldFRhcmdldCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGVIZWxkKGR0KSB7CiAgICAgICAgICAgIC8vIEFUVEFDSEVEIFNUQVRFIChWaXJ0dWFsIEF0dGFjaG1lbnQpCiAgICAgICAgICAgIGlmICghdGhpcy5ob2xkZXIgfHwgIXRoaXMuaG9sZGVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gMS4gVHJ5IHRvIHVzZSBIYW5kIEJvbmUgaWYgYXZhaWxhYmxlIChSZWFsaXNtKQogICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIuaGFuZEJvbmUpIHsKICAgICAgICAgICAgICAgIC8vIEdldCB3b3JsZCBwb3NpdGlvbiBvZiB0aGUgaGFuZCBib25lCiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlci5oYW5kQm9uZS5nZXRXb3JsZFBvc2l0aW9uKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEFkanVzdCBzbGlnaHRseSB0byBzaXQgSU4gdGhlIGhhbmQgcmF0aGVyIHRoYW4gT04gdGhlIHdyaXN0CiAgICAgICAgICAgICAgICAvLyBXZSBjYW4ndCBlYXNpbHkga25vdyAiZm9yd2FyZCIgZm9yIHRoZSBib25lIHdpdGhvdXQgbW9yZSBpbmZvLCAKICAgICAgICAgICAgICAgIC8vIGJ1dCB1c3VhbGx5IEdMVEYgYm9uZXMgYXJlIG9yaWVudGVkLiBGb3Igbm93LCBleGFjdCBib25lIHBvcyBpcyBiZXR0ZXIgdGhhbiBjaGVzdC4KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIDIuIEZhbGxiYWNrOiBDYWxjdWxhdGUgIkNhcnJ5aW5nIiBQb3NpdGlvbiAoUmlnaHQgSGFuZCBTaWRlKQogICAgICAgICAgICAgICAgLy8gUmVsYXRpdmUgdG8gcGxheWVyOiBVcCAwLjggKFdhaXN0L0NoZXN0KSwgUmlnaHQgMC40LCBGb3J3YXJkIDAuNQogICAgICAgICAgICAgICAgY29uc3QgaG9sZGVyUG9zID0gdGhpcy5ob2xkZXIubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGhvbGRlclF1YXQgPSB0aGlzLmhvbGRlci5tZXNoLnF1YXRlcm5pb247CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJldXNlIF9iVmVjCi8vIFJldXNlIF9iVmVjCiAgICAgICAgICAgICAgICAvLyBPZmZzZXQ6IHg9MC4zNSAoUmlnaHQpLCB5PTEuMyAoQ2hlc3QvSGFuZHMpLCB6PTAuNSAoRm9yd2FyZCkKICAgICAgICAgICAgICAgIF9iVmVjLnNldCgwLjM1LCAxLjMsIDAuNSkuYXBwbHlRdWF0ZXJuaW9uKGhvbGRlclF1YXQpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmNvcHkoaG9sZGVyUG9zKS5hZGQoX2JWZWMpOwogICAgICAgICAgICB9CgovLyBWaXN1YWwgRmxhaXI6IFNwaW4gdGhlIGJhbGwgc2xvd2x5CiAgICAgICAgICAgIGNvbnN0IHJvdFggPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUobmV3IFRIUkVFLlZlY3RvcjMoMSwwLDApLCAyICogZHQpOwogICAgICAgICAgICBjb25zdCByb3RZID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMSwwKSwgNSAqIGR0KTsKICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uLm11bHRpcGx5KHJvdFgpLm11bHRpcGx5KHJvdFkpOwogICAgICAgIH0KCgp1cGRhdGVGcmVlKGR0KSB7CiAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgIGNvbnN0IHN1YnN0ZXBzID0gTWF0aC5tYXgoMSwgTWF0aC5mbG9vcihDLlNVQlNURVBTIHx8IDEpKTsKICAgIGNvbnN0IHN0ZXBEdCA9IGR0IC8gc3Vic3RlcHM7CgogICAgLy8gLS0tIDEpIEludGVncmF0ZSBwaHlzaWNzIGluIHN1YnN0ZXBzIGZvciBzdGFiaWxpdHkgLS0tCiAgICBmb3IgKGxldCBzID0gMDsgcyA8IHN1YnN0ZXBzOyBzKyspIHsKICAgICAgICAvLyBBKSBNYWdudXMgZWZmZWN0IChjdXJ2ZSBmcm9tIHNwaW4pCiAgICAgICAgaWYgKEMuTUFHTlVTX0VOQUJMRUQgJiYgdGhpcy5hbmd1bGFyVmVsb2NpdHkgJiYgdGhpcy52ZWxvY2l0eSkgewogICAgICAgICAgICBjb25zdCBzcGluU3EgPSB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICBjb25zdCB2ZWxTcSA9IHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHNwaW5TcSA+IDAuMjUgJiYgdmVsU3EgPiAwLjI1KSB7CiAgICAgICAgICAgICAgICBfbWFnbnVzVmVjLmNvcHkodGhpcy5hbmd1bGFyVmVsb2NpdHkpLmNyb3NzKHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKChDLk1BR05VU19DT0VGRiB8fCAwKSAqIHN0ZXBEdCk7CgogICAgICAgICAgICAgICAgLy8gQ2FwIHRvIGF2b2lkIG51bWVyaWMgYmxvd3VwcwogICAgICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTUFHTlVTX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5NQUdOVVNfQ0FQIDogNjAuMCk7CiAgICAgICAgICAgICAgICBjb25zdCBtYWdMZW4gPSBfbWFnbnVzVmVjLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgaWYgKG1hZ0xlbiA+IGNhcCkgX21hZ251c1ZlYy5tdWx0aXBseVNjYWxhcihjYXAgLyBtYWdMZW4pOwoKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKF9tYWdudXNWZWMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBCKSBTcGluIGRlY2F5CiAgICAgICAgaWYgKHRoaXMuYW5ndWxhclZlbG9jaXR5KSB7CiAgICAgICAgICAgIGNvbnN0IHNwaW5EcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gKEMuU1BJTl9EUkFHIHx8IDApICogc3RlcER0KTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoc3BpbkRyYWcpOwogICAgICAgIH0KCiAgICAgICAgLy8gQykgRGVwdGggc3ByaW5nIChrZWVwcyBiYWxsIG5lYXIgcGxhbmUpCiAgICAgICAgY29uc3QgdGFyZ2V0WSA9IChDLkRFUFRIX1RBUkdFVF9ZICE9PSB1bmRlZmluZWQgPyBDLkRFUFRIX1RBUkdFVF9ZIDogMC4wKTsKICAgICAgICBjb25zdCB5RXJyID0gKHRoaXMubWVzaC5wb3NpdGlvbi55IC0gdGFyZ2V0WSk7CiAgICAgICAgdGhpcy52ZWxvY2l0eS55IC09IHlFcnIgKiAoQy5ERVBUSF9TUFJJTkcgfHwgMCkgKiBzdGVwRHQ7CiAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IE1hdGgubWF4KDAsIDEuMCAtIChDLkRFUFRIX0RBTVAgfHwgMCkgKiBzdGVwRHQpOwoKICAgICAgICAvLyBEKSBBcHBseSBkcmFnIChsaW5lYXIgKyBxdWFkcmF0aWMpCiAgICAgICAgY29uc3QgdkxlbiA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgaWYgKHZMZW4gPiAwLjAwMDAxKSB7CiAgICAgICAgICAgIGNvbnN0IGxpbiA9IChDLldBVEVSX0RSQUdfTElORUFSICE9PSB1bmRlZmluZWQgPyBDLldBVEVSX0RSQUdfTElORUFSIDogKEMuV0FURVJfRFJBRyB8fCAwKSkgKiBzdGVwRHQ7CiAgICAgICAgICAgIGNvbnN0IHF1YWQgPSAoQy5XQVRFUl9EUkFHX1FVQUQgfHwgMCkgKiB2TGVuICogc3RlcER0OwogICAgICAgICAgICBjb25zdCBkcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gbGluIC0gcXVhZCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoZHJhZyk7CgogICAgICAgICAgICBjb25zdCBzdG9wID0gKEMuU1RPUF9TUEVFRCB8fCAwKTsKICAgICAgICAgICAgaWYgKHN0b3AgPiAwICYmIHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKSA8IHN0b3AgKiBzdG9wKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRSkgTW92ZQogICAgICAgIF90ZW1wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoc3RlcER0KTsKICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF90ZW1wVmVjKTsKCiAgICAgICAgLy8gRikgU3RhdCBwb3dlciBkZWNheSAoZ2FtZSBsb2dpYykKICAgICAgICBpZiAodGhpcy5wb3dlciA+IDApIHsKICAgICAgICAgICAgdGhpcy5wb3dlciAtPSB0aGlzLmRlY2F5UmF0ZSAqIHN0ZXBEdDsKICAgICAgICAgICAgaWYgKHRoaXMucG93ZXIgPCAwKSB0aGlzLnBvd2VyID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIEcpIEJvdW5kYXJ5IGxvZ2ljIChzb2Z0IHdhbGwgKyBjbGFtcCkKICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1lc2gucG9zaXRpb247CiAgICAgICAgY29uc3QgZGlzdFhaID0gTWF0aC5zcXJ0KHBvcy54ICogcG9zLnggKyBwb3MueiAqIHBvcy56KTsKCiAgICAgICAgY29uc3QgYm91bmRhcnlSYWRpdXMgPSAoQy5CT1VOREFSWV9SQURJVVMgIT09IHVuZGVmaW5lZCA/IEMuQk9VTkRBUllfUkFESVVTIDogMzMuMCk7CiAgICAgICAgbGV0IGVmZmVjdGl2ZUJvdW5kYXJ5ID0gYm91bmRhcnlSYWRpdXM7CgogICAgICAgIGlmIChDLkdPQUxfUE9DS0VUX0VOQUJMRUQpIHsKICAgICAgICAgICAgY29uc3QgaW5Hb2FsUG9ja2V0ID0gKE1hdGguYWJzKHBvcy54KSA8IChDLkdPQUxfUE9DS0VUX1ggfHwgMTIuMCkgJiYgTWF0aC5hYnMocG9zLnopID4gKEMuR09BTF9QT0NLRVRfWiB8fCAyNS4wKSk7CiAgICAgICAgICAgIGlmIChpbkdvYWxQb2NrZXQpIGVmZmVjdGl2ZUJvdW5kYXJ5ID0gKEMuR09BTF9QT0NLRVRfUkFESVVTIHx8IDQ1LjApOwogICAgICAgIH0KCiAgICAgICAgY29uc3Qgc29mdEJ1ZmZlciA9IE1hdGgubWF4KDAuMDEsIChDLldBTExfU09GVF9CVUZGRVIgIT09IHVuZGVmaW5lZCA/IEMuV0FMTF9TT0ZUX0JVRkZFUiA6IDMuMCkpOwoKICAgICAgICAvLyBTb2Z0IHJlcHVsc2lvbiAoY3VydmVzIHRyYWplY3RvcnkgbmVhciB3YWxsIGluc3RlYWQgb2YgcGluZy1wb25nKQogICAgICAgIGlmIChkaXN0WFogPiBlZmZlY3RpdmVCb3VuZGFyeSAtIHNvZnRCdWZmZXIpIHsKICAgICAgICAgICAgY29uc3QgcGVuZXRyYXRpb24gPSBkaXN0WFogLSAoZWZmZWN0aXZlQm91bmRhcnkgLSBzb2Z0QnVmZmVyKTsKICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBwZW5ldHJhdGlvbiAvIHNvZnRCdWZmZXIpKTsKCiAgICAgICAgICAgIF90ZW1wVmVjLnNldCgtcG9zLngsIDAsIC1wb3Mueik7CiAgICAgICAgICAgIGlmIChfdGVtcFZlYy5sZW5ndGhTcSgpID4gMC4wMDAxKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYy5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gcmF0aW8gKiByYXRpbyAqIChDLldBTExfU09GVF9GT1JDRSB8fCAwKSAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjLCBmb3JjZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEhhcmQgY2xhbXAgaWYgaXQgc3RpbGwgaGl0cwogICAgICAgIGlmIChkaXN0WFogPiBlZmZlY3RpdmVCb3VuZGFyeSkgewogICAgICAgICAgICBfdGVtcFZlYy5zZXQoLXBvcy54LCAwLCAtcG9zLnopOwogICAgICAgICAgICBpZiAoX3RlbXBWZWMubGVuZ3RoU3EoKSA+IDAuMDAwMSkgX3RlbXBWZWMubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBvdmVybGFwID0gZGlzdFhaIC0gZWZmZWN0aXZlQm91bmRhcnk7CiAgICAgICAgICAgIHBvcy5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMsIG92ZXJsYXApOwoKY29uc3QgdkRvdE4gPSB0aGlzLnZlbG9jaXR5LmRvdChfdGVtcFZlYyk7CgogICAgICAgICAgICAvLyBPbmx5IGFkanVzdCBpZiBtb3Zpbmcgb3V0d2FyZCAoYWdhaW5zdCBpbndhcmQgbm9ybWFsKQogICAgICAgICAgICBpZiAodkRvdE4gPCAwKSB7CiAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIEFyZW5hIERlZm9ybWF0aW9uIGlmIGltcGFjdCBpcyBmb3JjZWZ1bAogICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0U3BlZWQgPSBNYXRoLmFicyh2RG90Tik7CiAgICAgICAgICAgICAgICBpZiAoaW1wYWN0U3BlZWQgPiAxMC4wICYmIHdpbmRvdy5mbHV4LnRyaWdnZXJBcmVuYUltcGFjdCkgewogICAgICAgICAgICAgICAgICAgIC8vIFBhc3MgdGhlIGNvbnRhY3QgcG9pbnQgKHBvcykgYW5kIHN0cmVuZ3RoIGJhc2VkIG9uIHNwZWVkCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KHBvcywgTWF0aC5taW4oaW1wYWN0U3BlZWQgKiAwLjUsIDE1LjApKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBlID0gKEMuV0FMTF9FTEFTVElDSVRZICE9PSB1bmRlZmluZWQgPyBDLldBTExfRUxBU1RJQ0lUWSA6IDAuMyk7CiAgICAgICAgICAgICAgICBjb25zdCBpbXB1bHNlID0gX3RlbXBWZWMuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtdkRvdE4gKiAoMS4wICsgZSkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoaW1wdWxzZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRhbmdlbnRpYWwgZnJpY3Rpb24KICAgICAgICAgICAgICAgIGNvbnN0IGZyaWN0aW9uID0gKEMuV0FMTF9GUklDVElPTiAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX0ZSSUNUSU9OIDogMC45NSk7CiAgICAgICAgICAgICAgICBjb25zdCB0YW5nZW50ID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLnByb2plY3RPblBsYW5lKF90ZW1wVmVjKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc3ViKHRhbmdlbnQubXVsdGlwbHlTY2FsYXIoMS4wIC0gZnJpY3Rpb24pKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQ2VpbGluZy9GbG9vciBjbGFtcAogICAgICAgIGNvbnN0IGJoID0gKEMuQk9VTkRBUllfSEVJR0hUICE9PSB1bmRlZmluZWQgPyBDLkJPVU5EQVJZX0hFSUdIVCA6IDE1LjApOwogICAgICAgIGlmIChNYXRoLmFicyhwb3MueSkgPiBiaCkgewogICAgICAgICAgICBjb25zdCBzaWduID0gTWF0aC5zaWduKHBvcy55KSB8fCAxOwogICAgICAgICAgICBwb3MueSA9IGJoICogc2lnbjsKICAgICAgICAgICAgY29uc3QgZmUgPSAoQy5GTE9PUl9FTEFTVElDSVRZICE9PSB1bmRlZmluZWQgPyBDLkZMT09SX0VMQVNUSUNJVFkgOiAwLjQpOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLWZlOwp9CiAgICB9CgogICAgLy8gLS0tIDIpIEZYIHRoYXQgc2hvdWxkIHJ1biBvbmNlIHBlciBmcmFtZSAobm90IHBlciBzdWJzdGVwKSAtLS0KICAgIGlmICghdGhpcy5fZ2hvc3QpIHsKICAgICAgICBjb25zdCBzcGVlZFNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgIGlmIChzcGVlZFNxID4gMi4wICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5fYnViYmxlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgY29uc3QgcG0gPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKC0wLjgpOwoKICAgICAgICAgICAgICAgIC8vIFN0YW5kYXJkIGJ1YmJsZQovLyBTdGFuZGFyZCBidWJibGUKICAgICAgICAgICAgICAgIGNvbnN0IHN0ZFBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLmFkZChfYkRpci5zZXQoKE1hdGgucmFuZG9tKCktMC41KSowLjMsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4zLCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuMykpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3RkUG9zLnkgKz0gdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlJywgc3RkUG9zLCB7IHNjYWxlOiAwLjQgKyBNYXRoLnJhbmRvbSgpICogMC40IH0pOyAvLyBJbmNyZWFzZWQgc2NhbGUKCiAgICAgICAgICAgICAgICAvLyBNaWNybyBidWJibGVzIGF0IGhpZ2ggc3BlZWQKICAgICAgICAgICAgICAgIGlmIChzcGVlZFNxID4gNTAuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gTWF0aC5taW4oNCwgTWF0aC5mbG9vcihzcGVlZFNxIC8gNjApKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKY29uc3Qgaml0dGVyID0gX2JEaXIuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC40LCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuNCwgKE1hdGgucmFuZG9tKCktMC41KSowLjQpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGF3blBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLmFkZChqaXR0ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWZvcm1Ob2RlKSBzcGF3blBvcy55ICs9IHRoaXMuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlX21pY3JvJywgc3Bhd25Qb3MsIHsgc2NhbGU6IDAuMDUgKyBNYXRoLnJhbmRvbSgpICogMC4xIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDAuMDI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gMC41KSB7CmNvbnN0IGppdHRlciA9IF9iRGlyLnNldCgoTWF0aC5yYW5kb20oKS0wLjUpKjAuMiwgKE1hdGgucmFuZG9tKCktMC41KSowLjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3Bhd25Qb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQob2Zmc2V0KS5hZGQoaml0dGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3Bhd25Qb3MueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIHNwYXduUG9zLCB7IHNjYWxlOiAwLjA0ICsgTWF0aC5yYW5kb20oKSAqIDAuMDYgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4wNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLyAtLS0gMykgVmlzdWFsIHJvdGF0aW9uIC0tLQogICAgY29uc3Qgc3BpblNwZWVkID0gdGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCk7CiAgICBpZiAoc3BpblNwZWVkID4gMC41KSB7CiAgICAgICAgY29uc3QgYXhpcyA9IF90ZW1wVmVjLmNvcHkodGhpcy5hbmd1bGFyVmVsb2NpdHkpLm5vcm1hbGl6ZSgpOwogICAgICAgIGNvbnN0IHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUoYXhpcywgc3BpblNwZWVkICogZHQpOwogICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5wcmVtdWx0aXBseShxKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgIGlmIChzcGVlZCA+IDAuMSkgewogICAgICAgICAgICBfdGVtcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLmNyb3NzKF9heGlzWSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGlmIChfdGVtcFZlYy5sZW5ndGhTcSgpID4gMC4wMSkgewogICAgICAgICAgICAgICAgY29uc3QgcSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShfdGVtcFZlYywgc3BlZWQgKiBkdCk7CiAgICAgICAgICAgICAgICB0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24ucHJlbXVsdGlwbHkocSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCmdyYWIocGxheWVyKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50OiBQb3NzZXNzaW9uIChpZiB0YWtpbmcgZnJvbSBmcmVlIHN0YXRlKQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCgiUE9TU0VTU0lPTiIsICJub3JtYWwiKTsKICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIFR1cm5vdmVyIChQb3NzZXNzaW9uIENoYW5nZSkKICAgICAgICAgICAgY29uc3QgcHJldmlvdXNUZWFtID0gdGhpcy5ob2xkZXIgPyB0aGlzLmhvbGRlci50ZWFtIDogKHRoaXMubGFzdEhvbGRlciA/IHRoaXMubGFzdEhvbGRlci50ZWFtIDogbnVsbCk7CiAgICAgICAgICAgIGlmIChwcmV2aW91c1RlYW0gJiYgcHJldmlvdXNUZWFtICE9PSBwbGF5ZXIudGVhbSkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJUVVJOT1ZFUiIsIHBsYXllci5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgc29tZW9uZSBlbHNlIGhlbGQgaXQsIHRoZXkgbG9zZSBpdAogICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIgIT09IHBsYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIubG9zZUJhbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBwbGF5ZXI7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaGVsZCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOT1RFOiBXZSBkbyBOT1QgcGFyZW50IHRoZSBtZXNoIHRvIHRoZSBwbGF5ZXIgYW55bW9yZS4KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyB0aGUgYmFsbCBmcm9tIGZseWluZyBhcm91bmQgZHVlIHRvIHN3aW0gYW5pbWF0aW9ucy4KICAgICAgICAgICAgLy8gSW5zdGVhZCwgd2UgdXBkYXRlIGl0cyBwb3NpdGlvbiBtYW51YWxseSBpbiB1cGRhdGVIZWxkKCkuCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3RpZnkgcGxheWVyCiAgICAgICAgICAgIGlmIChwbGF5ZXIucmVjZWl2ZUJhbGwpIHsKICAgICAgICAgICAgICAgIHBsYXllci5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zb2xlLmxvZygiQmFsbCBncmFiYmVkIGJ5ICIgKyBwbGF5ZXIucm9sZSk7CiAgICAgICAgfQoKICAgICAgICBkcm9wKCkgewogICAgICAgICAgICB0aGlzLnJldmVhbCgpOyAvLyBFbnN1cmUgdmlzaWJsZQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm8gbmVlZCB0byBkZXRhY2ggZnJvbSBzY2VuZSBncmFwaCBzaW5jZSB3ZSBhcmVuJ3QgcGFyZW50aW5nIHRvIHBsYXllciBhbnltb3JlLgogICAgICAgICAgICAvLyBKdXN0IGNsZWFyIGhvbGRlci4KCiAgICAgICAgICAgIGlmICh0aGlzLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmxvc2VCYWxsKSB0aGlzLmhvbGRlci5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIH0KLy8gU2hvb3QvUGFzcwovLyBTaG9vdC9QYXNzCiAgICAgICAgc2hvb3QoZGlyZWN0aW9uVmVjdG9yLCBmb3JjZSwgdHlwZSA9ICdTSCcsIHRlY2huaXF1ZSA9IG51bGwsIHNwaW5WZWN0b3IgPSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMubGFzdEhvbGRlciA9IHRoaXMuaG9sZGVyOyAvLyBSZWNvcmQgZm9yIEVYUCBhdHRyaWJ1dGlvbgogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVtYmxlIERldGVjdGlvbiAoVHlwZSAnbm9uZScgaXMgdXNlZCBieSBQbGF5ZXIuZnVtYmxlKQogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ25vbmUnKSB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNob3dBbm5vdW5jZW1lbnQoIkZVTUJMRSEiLCAic2xhbSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmRyb3AoKTsgLy8gRGV0YWNoIGZpcnN0CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXQgR3JhY2UgUGVyaW9kIHRvIHByZXZlbnQgaW5zdGFudCBpbnRlcmNlcHRpb25zL2NhdGNoZXMKICAgICAgICAgICAgLy8gMC4ycyBhbGxvd3MgYmFsbCB0byBjbGVhciB0aGUgdGhyb3dlcidzIGltbWVkaWF0ZSB2aWNpbml0eQogICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwLjI7CgogICAgICAgICAgICAvLyBQaHlzaWNhbCBWZWxvY2l0eSAoVmlzdWFsIHNwZWVkKQovLyBQaHlzaWNhbCBWZWxvY2l0eSAoVmlzdWFsIHNwZWVkKQogICAgICAgICAgICAvLyBXZSBtYXAgZm9yY2UgKHN0YXQpIHRvIHBoeXNpY2FsIHNwZWVkLCBidXQgY2xhbXAgaXQgcmVhc29uYWJsZQogICAgICAgICAgICAvLyBJbmNyZWFzZWQgY2FwIHRvIDQwLjAgdG8gYWxsb3cgZm9yIHN0cm9uZyBwYXNzZXMgYW5kIGNsZWFycwovLyBJbmNyZWFzZWQgY2FwIHRvIDg1LjAgdG8gYWxsb3cgZm9yIHN0cm9uZyBwYXNzZXMgYW5kIGNsZWFycyBhbmQgIk1heCBQb3dlciIgZmVlbApjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAoQy5MQVVOQ0hfU1BFRURfU0NBTEUgIT09IHVuZGVmaW5lZCA/IEMuTEFVTkNIX1NQRUVEX1NDQUxFIDogMS4wKTsKICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTEFVTkNIX1NQRUVEX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5MQVVOQ0hfU1BFRURfQ0FQIDogODUuMCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5taW4oZm9yY2UgKiBzY2FsZSwgY2FwKTsKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5jb3B5KGRpcmVjdGlvblZlY3Rvcikubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgU3BpbiBpZiBwcm92aWRlZAogICAgICAgICAgICBpZiAoc3BpblZlY3RvcikgewogICAgICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuY29weShzcGluVmVjdG9yKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhdCBQb3dlciAoR2FtZSBMb2dpYykKICAgICAgICAgICAgdGhpcy5wb3dlciA9IGZvcmNlOwogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9IHR5cGU7CiAgICAgICAgICAgIHRoaXMudGVjaG5pcXVlID0gdGVjaG5pcXVlOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBUcmFpbCBDb2xvcgogICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgewogICAgICAgICAgICAgICAgbGV0IGNvbG9yID0gMHgwMGFhZmY7IC8vIERlZmF1bHQgQmx1ZSAoUGFzcykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ3Zlbm9tJykgY29sb3IgPSAweGFhMDBmZjsgLy8gUHVycGxlCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICd3aXRoZXInKSBjb2xvciA9IDB4ODg4ODg4OyAvLyBHcmV5CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICduYXAnKSBjb2xvciA9IDB4MDAwMDg4OyAvLyBEYXJrIEJsdWUKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ3NwaGVyZScpIGNvbG9yID0gMHgwMGZmZmY7IC8vIEN5YW4KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ2plY2h0JykgY29sb3IgPSAweGZmMDAwMDsgLy8gUmVkCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICBjb2xvciA9IDB4ZmY0NDAwOyAvLyBPcmFuZ2UvUmVkCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwuc2V0Q29sb3IoY29sb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIYW5kbGUgSW52aXNpYmxlIFNob3QKICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSAmJiB0ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgdGhpcy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJJbnZpc2libGUgU2hvdCEiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc29sZS5sb2coYEJhbGwgJHt0eXBlfSB3aXRoIFBvd2VyOiAke3RoaXMucG93ZXIudG9GaXhlZCgxKX0gU3BpbjogJHt0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGgoKS50b0ZpeGVkKDEpfWApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrIGZvciBDdXJ2ZQogICAgICAgICAgICBpZiAodGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkgPiAxNS4wICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldmVhbCgpIHsKCiAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgdGhpcy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgICAKcmVzZXQoKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7CiAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwOwogICAgICAgICAgICB0aGlzLnBvd2VyID0gMDsKICAgICAgICB9CmlzQ2F0Y2hhYmxlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jYXRjaEdyYWNlUGVyaW9kIDw9IDA7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWxzKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5kZWZvcm1Ob2RlIHx8ICF0aGlzLnNwaW5Ob2RlKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBTcXVhc2ggJiBTdHJldGNoIGJhc2VkIG9uIHZlbG9jaXR5Ci8vIDEuIFNxdWFzaCAmIFN0cmV0Y2ggYmFzZWQgb24gdmVsb2NpdHkKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT25seSBhcHBseSBzdHJldGNoIGlmIG1vdmluZyBmYXN0IGVub3VnaAogICAgICAgICAgICBpZiAoc3BlZWQgPiAxLjAgJiYgdGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAvLyBPcmllbnQgZGVmb3JtTm9kZSB0byB2ZWxvY2l0eSBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgZm9yd2FyZCBpcyBaICgwLDAsMSkKICAgICAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLnNldEZyb21Vbml0VmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLDAsMSksIGRpcik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBzdHJldGNoIGZhY3RvcgogICAgICAgICAgICAgICAgLy8gTWF4IHN0cmV0Y2ggYXQgc3BlZWQgNDAgKGFwcHJveCBtYXggc2hvdCBwb3dlcikKICAgICAgICAgICAgICAgIGNvbnN0IGZhY3RvciA9IE1hdGgubWluKHNwZWVkIC8gNDAuMCwgMS4wKTsgCiAgICAgICAgICAgICAgICBjb25zdCBzdHJldGNoID0gMS4wICsgKGZhY3RvciAqIDAuOCk7IC8vIEluY3JlYXNlZCBzdHJldGNoIG1heCB0byAxLjh4CiAgICAgICAgICAgICAgICBjb25zdCBzcXVhc2ggPSAxLjAgLyBNYXRoLnNxcnQoc3RyZXRjaCk7IC8vIE1haW50YWluIHZvbHVtZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUuc2NhbGUuc2V0KHNxdWFzaCwgc3F1YXNoLCBzdHJldGNoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFJlc2V0IGRlZm9ybWF0aW9uCiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUucXVhdGVybmlvbi5pZGVudGl0eSgpOwogICAgICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnNjYWxlLnNldCgxLCAxLCAxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gQXBwbHkgQWNjdW11bGF0ZWQgU3BpbgogICAgICAgICAgICAvLyBTaW5jZSBkZWZvcm1Ob2RlIG1pZ2h0IGJlIHJvdGF0ZWQsIHdlIG5lZWQgdG8gYXBwbHkgc3BpbiBpbiB0aGUgY29ycmVjdCBzcGFjZS4KICAgICAgICAgICAgLy8gc3Bpbk5vZGUgcm90YXRpb24gPSBkZWZvcm1Ob2RlX2ludmVyc2UgKiBhY2N1bXVsYXRlZFJvdGF0aW9uCmNvbnN0IGludkRlZm9ybSA9IHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLmNsb25lKCkuaW52ZXJ0KCk7CiAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucXVhdGVybmlvbi5jb3B5KGludkRlZm9ybS5tdWx0aXBseSh0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24pKTsKICAgICAgICB9CiAgICB9Cgp3aW5kb3cuZmx1eC5CYWxsID0gQmFsbDsKICAgIHdpbmRvdy5mbHV4LlRyYWlsUmVuZGVyZXIgPSBUcmFpbFJlbmRlcmVyOwp9KSgpOw==","./Ball.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIHZlY3RvcnMgdG8gYXZvaWQgR0MKY29uc3QgX2JWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2JEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2F4aXNZID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CiAgICBjb25zdCBfdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbWFnbnVzVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCi8vIFBoeXNpY3MgQ29uZmlndXJhdGlvbiAoRXhwb3NlZCBmb3IgRGV2VG9vbHMpCndpbmRvdy5mbHV4LkJhbGxDb25maWcgPSB7CiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBDb3JlIGludGVncmF0aW9uCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBTVUJTVEVQUzogMiwgICAgICAgICAgICAgICAgLy8gUGh5c2ljcyBzdWJzdGVwcyBwZXIgZnJhbWUgKHN0YWJpbGl0eSBhdCBoaWdoIHNwZWVkcykKICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLCAgICAgICAgICAgLy8gQmVsb3cgdGhpcyBzcGVlZCwgc25hcCB0byByZXN0IChwcmV2ZW50cyBlbmRsZXNzIGRyaWZ0KQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFdhdGVyIHJlc2lzdGFuY2UgKHBoeXNpY2FsIHZlbG9jaXR5IGRyYWcsIE5PVCBzdGF0IGRlY2F5KQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMTUsICAgIC8vIExpbmVhciBkcmFnIHRlcm0gKHJvdWdobHkgeW91ciBwcmV2aW91cyBXQVRFUl9EUkFHKQogICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDIsICAgICAvLyBRdWFkcmF0aWMgZHJhZyAoc3Ryb25nZXIgYXQgaGlnaCBzcGVlZCwgaGVscHMgdGFtZSByb2NrZXRzKQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFNwaW4gJiBjdXJ2ZQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgU1BJTl9EUkFHOiAwLjQwLCAgICAgICAgICAgIC8vIFNwaW4gZGVjYXkgcGVyIHNlY29uZAogICAgICAgIE1BR05VU19FTkFCTEVEOiB0cnVlLAogICAgICAgIE1BR05VU19DT0VGRjogMC4wOCwgICAgICAgICAvLyBMaWZ0IHN0cmVuZ3RoCiAgICAgICAgTUFHTlVTX0NBUDogNjAuMCwgICAgICAgICAgIC8vIE1heCBtYWdudXMgZGVsdGEtViBwZXIgc3Vic3RlcCAocHJldmVudHMgZXhwbG9zaW9ucykKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBEZXB0aCBjb25zdHJhaW50IChrZWVwcyBiYWxsIG5lYXIgcGxheSBwbGFuZSB3aXRob3V0IGZlZWxpbmcgbGlrZSBhIGhhcmQgZmxvb3IpCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBERVBUSF9UQVJHRVRfWTogMC4wLAogICAgICAgIERFUFRIX1NQUklORzogMS4wLCAgICAgICAgICAvLyBZb3VyIHByZXZpb3VzIEdSQVZJVFlfU1BSSU5HCiAgICAgICAgREVQVEhfREFNUDogMS41LCAgICAgICAgICAgIC8vIFlvdXIgcHJldmlvdXMgR1JBVklUWV9EQU1QCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gQXJlbmEgYm91bmRhcnkgKHNvZnQgd2FsbCArIGNsYW1wKQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCkJPVU5EQVJZX1JBRElVUzogNDYuMCwKICAgICAgICBCT1VOREFSWV9IRUlHSFQ6IDIwLjAsCiAgICAgICAgR09BTF9QT0NLRVRfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBHT0FMX1BPQ0tFVF9YOiAxMi4wLCAgICAgICAgLy8gSGFsZi13aWR0aCBvZiBnb2FsIHBvY2tldCBjb3JyaWRvcgogICAgICAgIEdPQUxfUE9DS0VUX1o6IDQwLjAsICAgICAgICAvLyBTdGFydCBvZiBnb2FsIHBvY2tldCBjb3JyaWRvciAoYWJzIHopIC0gUHVzaGVkIGJhY2sKICAgICAgICBHT0FMX1BPQ0tFVF9SQURJVVM6IDU1LjAsICAgLy8gRWZmZWN0aXZlIHJhZGl1cyB3aGVuIGluIGdvYWwgcG9ja2V0CiAgICAgICAgV0FMTF9TT0ZUX0JVRkZFUjogMy4wLCAgICAgIC8vIERpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMKICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDIwLjAsICAgICAgLy8gU29mdCByZXB1bHNpb24gc3RyZW5ndGgKICAgICAgICBXQUxMX0VMQVNUSUNJVFk6IDAuMzAsICAgICAgLy8gQm91bmNlIGRhbXBlbmluZyBvbiBjbGFtcAogICAgICAgIFdBTExfRlJJQ1RJT046IDAuOTUsICAgICAgICAvLyBUYW5nZW50aWFsIGRhbXBpbmcgb24gd2FsbCBjb250YWN0CgogICAgICAgIEZMT09SX0VMQVNUSUNJVFk6IDAuNDAsICAgICAvLyBCb3VuY2UgZGFtcGVuaW5nIG9uIGNlaWxpbmcvZmxvb3IgY2xhbXAKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBUaHJvdyBtYXBwaW5nIChzdGF0IGZvcmNlIC0+IHBoeXNpY2FsIGxhdW5jaCBzcGVlZCkKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIExBVU5DSF9TUEVFRF9TQ0FMRTogMS4wLCAgICAvLyBNdWx0aXBsaWVzIGZvcmNlIHdoZW4gY29udmVydGluZyB0byB2ZWxvY2l0eQogICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDg1LjAgICAgICAvLyBQaHlzaWNhbCBzcGVlZCBjYXAgKHdhcyBoYXJkY29kZWQgaW4gQmFsbC5zaG9vdCkKICAgIH07CgoKICAgIAogICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWc7IC8vIExvY2FsIGFsaWFzIGZvciBicmV2aXR5CiAgICAvLyAtLS0gVFJBSUwgUkVOREVSRVIgLS0tCi8vIC0tLSBUUkFJTCBSRU5ERVJFUiAtLS0KICAgIGNsYXNzIFRyYWlsUmVuZGVyZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5zZWdtZW50cyA9IDMwOyAvLyBNb3JlIHNlZ21lbnRzIGZvciBzbW9vdGhlciBjdXJ2ZXMKICAgICAgICAgICAgdGhpcy5wb2ludHMgPSBbXTsKdGhpcy5iYXNlV2lkdGggPSAwLjg7IC8vIEluY3JlYXNlZCB3aWR0aCBmb3IgdmlzaWJpbGl0eQogICAgICAgICAgICB0aGlzLmN1cnJlbnRXaWR0aCA9IDAuODsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJ5CiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgICAgIGNvbnN0IHBvc0RhdGEgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuc2VnbWVudHMgKiAyICogMyk7CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHBvc0RhdGEsIDMpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluZGljZXMKICAgICAgICAgICAgY29uc3QgaW5kaWNlcyA9IFtdOwogICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50cy0xOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhc2UgPSBpKjI7CiAgICAgICAgICAgICAgICBpbmRpY2VzLnB1c2goYmFzZSwgYmFzZSsxLCBiYXNlKzIpOwogICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGJhc2UrMSwgYmFzZSszLCBiYXNlKzIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEluZGV4KGluZGljZXMpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBjb2xvcjogMHgwMGFhZmYsCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLjksIC8vIEluY3JlYXNlZCBvcGFjaXR5CiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLm1lc2gpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW5pdCBwb2ludHMKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB0aGlzLnBvaW50cy5wdXNoKG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUmV1c2FibGUgdGVtcHMgKGF2b2lkIHBlci1mcmFtZSBhbGxvY2F0aW9ucyBvbiBtb2JpbGUpCiAgICAgICAgICAgIHRoaXMuX3RtcERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuX3RtcFRvQ2FtID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5fdG1wUmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXNldChwb3MpIHsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB0aGlzLnBvaW50c1tpXS5jb3B5KHBvcyk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlR2VvbWV0cnkoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgc2V0Q29sb3IoaGV4KSB7CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KGhleCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZShjdXJyZW50UG9zLCBzcGVlZFJhdGlvID0gMC4wKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXQoY3VycmVudFBvcyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCi8vIER5bmFtaWMgV2lkdGggYmFzZWQgb24gc3BlZWQgQU5EIFNQSU4gKFBvd2VyIFZpc3VhbCkKICAgICAgICAgICAgLy8gRmFzdCBiYWxsID0gVGhpY2tlci4gU3Bpbm5pbmcgYmFsbCA9IEV2ZW4gVGhpY2tlci4KICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgY29uc3Qgc3BpblJhdGlvID0gYmFsbCA/IE1hdGgubWluKDEuMCwgYmFsbC5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkgLyAzMC4wKSA6IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB0YXJnZXRXaWR0aCA9IHRoaXMuYmFzZVdpZHRoICogKDAuOCArIHNwZWVkUmF0aW8gKiAxLjIgKyBzcGluUmF0aW8gKiAyLjApOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRXaWR0aCArPSAodGFyZ2V0V2lkdGggLSB0aGlzLmN1cnJlbnRXaWR0aCkgKiAwLjI7IC8vIFNtb290aCB0cmFuc2l0aW9uCgogICAgICAgICAgICAvLyBTaGlmdCBwb2ludHMKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuc2VnbWVudHMgLSAxOyBpID4gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBvaW50c1tpXS5jb3B5KHRoaXMucG9pbnRzW2ktMV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucG9pbnRzWzBdLmNvcHkoY3VycmVudFBvcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVwZGF0ZUdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZUdlb21ldHJ5KCkgewogICAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5hcnJheTsKICAgICAgICAgICAgY29uc3QgY2FtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSA6IG51bGw7CiAgICAgICAgICAgIGlmICghY2FtKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IGNhbS5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgdGVtcERpciA9IHRoaXMuX3RtcERpcjsKICAgICAgICAgICAgY29uc3QgdGVtcFRvQ2FtID0gdGhpcy5fdG1wVG9DYW07CiAgICAgICAgICAgIGNvbnN0IHRlbXBSaWdodCA9IHRoaXMuX3RtcFJpZ2h0OwogICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5wb2ludHNbaV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRhcGVyIHdpZHRoIGFsb25nIHRyYWlsIGxlbmd0aAogICAgICAgICAgICAgICAgY29uc3QgdGFwZXIgPSAxLjAgLSBNYXRoLnBvdyhpIC8gdGhpcy5zZWdtZW50cywgMik7IC8vIFF1YWRyYXRpYyB0YXBlcgogICAgICAgICAgICAgICAgY29uc3QgdyA9IHRoaXMuY3VycmVudFdpZHRoICogdGFwZXI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIGlmIChpIDwgdGhpcy5zZWdtZW50cyAtIDEpIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wRGlyLnN1YlZlY3RvcnModGhpcy5wb2ludHNbaV0sIHRoaXMucG9pbnRzW2krMV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wRGlyLnN1YlZlY3RvcnModGhpcy5wb2ludHNbaS0xXSwgdGhpcy5wb2ludHNbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGVtcERpci5sZW5ndGhTcSgpIDwgMC4wMDAxKSB0ZW1wRGlyLnNldCgwLCAxLCAwKTsKICAgICAgICAgICAgICAgIHRlbXBEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRlbXBUb0NhbS5zdWJWZWN0b3JzKGNhbVBvcywgcCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0ZW1wUmlnaHQuY3Jvc3NWZWN0b3JzKHRlbXBEaXIsIHRlbXBUb0NhbSkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIodyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZlcnQgMQogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDBdID0gcC54IC0gdGVtcFJpZ2h0Lng7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgMV0gPSBwLnkgLSB0ZW1wUmlnaHQueTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAyXSA9IHAueiAtIHRlbXBSaWdodC56OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZXJ0IDIKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAzXSA9IHAueCArIHRlbXBSaWdodC54OwogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDRdID0gcC55ICsgdGVtcFJpZ2h0Lnk7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgNV0gPSBwLnogKyB0ZW1wUmlnaHQuejsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgfQogICAgfQpjbGFzcyBCYWxsIHsKCiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7IAogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSBudWxsOyAvLyBUcmFjayB3aG8gdGhyZXcgaXQgbGFzdCAoZm9yIEVYUC9Bc3Npc3RzKQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOyAvLyAnZnJlZScsICdoZWxkJywgJ21hZ25ldGl6ZWQnCiAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIENvbnRpbnVvdXMgU3RhdHMKICAgICAgICAgICAgdGhpcy5wb3dlciA9IDA7ICAgICAgLy8gQ3VycmVudCBQQSBvciBTSCB2YWx1ZQogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9ICdub25lJzsgLy8gJ1BBJyBvciAnU0gnCiAgICAgICAgICAgIHRoaXMuZGVjYXlSYXRlID0gMy4wOyAvLyBTdGF0IHBvaW50cyBsb3N0IHBlciBzZWNvbmQgKFdhdGVyIHJlc2lzdGFuY2UpCiAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7IC8vIFRpbWUgYmVmb3JlIGJhbGwgY2FuIGJlIGNhdWdodCBhZ2FpbgoKICAgICAgICAgICAgLy8gTWFnbmV0IFN5c3RlbQogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1hZ25ldER1cmF0aW9uID0gMC4yOyAKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gVmlzdWFscyAoU3F1YXNoICYgU3RyZXRjaCkKICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zcGluTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubW9kZWwgPSBudWxsOwoKdGhpcy5pbml0TWVzaCgpOwogICAgICAgICAgICB0aGlzLnRyYWlsID0gbmV3IFRyYWlsUmVuZGVyZXIoc2NlbmUpOwogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDA7Cn0KaW5pdE1lc2goKSB7CiAgICAgICAgICAgIC8vIEhpZXJhcmNoeTogTWVzaCAoUG9zKSAtPiBEZWZvcm0gKFNxdWFzaC9TdHJldGNoKSAtPiBTcGluIChSb3RhdGlvbikgLT4gTW9kZWwKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7CgogICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKdGhpcy5kZWZvcm1Ob2RlID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5wb3NpdGlvbi55ID0gMC4wOyAvLyBSZXNldCBvZmZzZXQgc28gYmFsbCBpcyBjZW50ZXJlZCBvbiBtZXNoIHBvc2l0aW9uCiAgICAgICAgICAgIHRoaXMubWVzaC5hZGQodGhpcy5kZWZvcm1Ob2RlKTsgLy8gRml4OiBBZGQgZGVmb3JtTm9kZSB0byBtZXNoCgogICAgICAgICAgICB0aGlzLnNwaW5Ob2RlID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5hZGQodGhpcy5zcGluTm9kZSk7CgogICAgICAgICAgICAvLyBQcm9jZWR1cmFsIFBsYWNlaG9sZGVyIFRleHR1cmUgKEJsaXR6YmFsbC1pc2gpCiAgICAgICAgICAgIGNvbnN0IHBsYWNlaG9sZGVyVGV4ID0gKCgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICAgICAgICAgIGMud2lkdGggPSAxMjg7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNlZWVlZWUnOwogICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsMCwxMjgsNjQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBCbHVlIGJ1bXBzL2RldGFpbHMKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwODhmZic7CiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw2OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmFyYyhpKjI1LCAzMiwgMTAsIDAsIE1hdGguUEkqMik7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwNDQ4OCc7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMjgsIDEyOCwgOCk7IC8vIFN0cmlwZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICAgICAgICAgIH0pKCk7CgogICAgICAgICAgICAvLyBQbGFjZWhvbGRlciBWaXN1YWwgKEltbWVkaWF0ZSBmZWVkYmFjaywgcGVyc2lzdHMgdW50aWwgdmFsaWQgbW9kZWwgbG9hZHMpCi8vIFBsYWNlaG9sZGVyIFZpc3VhbCAoSW1tZWRpYXRlIGZlZWRiYWNrLCBwZXJzaXN0cyB1bnRpbCB2YWxpZCBtb2RlbCBsb2FkcykKLy8gUGxhY2Vob2xkZXIgVmlzdWFsIChJbW1lZGlhdGUgZmVlZGJhY2ssIHBlcnNpc3RzIHVudGlsIHZhbGlkIG1vZGVsIGxvYWRzKQpjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeSgwLjMsIDE2LCAxNik7IC8vIFNjYWxlZCBkb3duIH4xNSUKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgbWFwOiBwbGFjZWhvbGRlclRleCwKICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZiwgCiAgICAgICAgICAgICAgICB3aXJlZnJhbWU6IGZhbHNlLCAvLyBTb2xpZAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IGZhbHNlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMS4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsKTsKCiAgICAgICAgICAgIC8vIExvYWQgR0xCIE1vZGVsCiAgICAgICAgICAgIGNvbnN0IHVybCA9ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTIxYWU4Nzg4ZTU4NGUzNzhhNzlkOTczMmEwNzUzNTYuZ2xiJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbCh1cmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiREVCVUc6IEJhbGwgR0xCIGxvYWRlZC4iLCBnbHRmKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgbW9kZWwgPSBnbHRmLnNjZW5lOwoKICAgICAgICAgICAgICAgIC8vIDEuIFJlc2V0IHJvb3QgdHJhbnNmb3JtcwogICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgbW9kZWwucm90YXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgbW9kZWwuc2NhbGUuc2V0KDEsIDEsIDEpOwogICAgICAgICAgICAgICAgbW9kZWwudXBkYXRlTWF0cml4V29ybGQodHJ1ZSk7CgogICAgICAgICAgICAgICAgLy8gMi4gSGFyZGVuIE1hdGVyaWFscyAmIFZpc2liaWxpdHkKICAgICAgICAgICAgICAgIG1vZGVsLnRyYXZlcnNlKChub2RlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuY2FzdFNoYWRvdyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBub2RlLnJlY2VpdmVTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7IC8vIENSSVRJQ0FMOiBQcmV2ZW50IGN1bGxpbmcgaWYgYm91bmRzIGFyZSBvZmYKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRzID0gQXJyYXkuaXNBcnJheShub2RlLm1hdGVyaWFsKSA/IG5vZGUubWF0ZXJpYWwgOiBbbm9kZS5tYXRlcmlhbF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRzLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5jb2xvci5zZXRIZXgoMHhmZmZmZmYpOyAvLyBGb3JjZSB3aGl0ZSBiYXNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5zaWRlID0gVEhSRUUuRG91YmxlU2lkZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnRyYW5zcGFyZW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5vcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uYWxwaGFUZXN0ID0gMDsgLy8gQ1JJVElDQUw6IERpc2FibGUgYWxwaGEgdGVzdCB0byBwcmV2ZW50IGN1bGxpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLmRlcHRoV3JpdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uZGVwdGhUZXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgLy8gMy4gQ29tcHV0ZSBCb3VuZGluZyBCb3gKICAgICAgICAgICAgICAgIGNvbnN0IGJveCA9IG5ldyBUSFJFRS5Cb3gzKCkuc2V0RnJvbU9iamVjdChtb2RlbCk7CiAgICAgICAgICAgICAgICBjb25zdCBzaXplID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgIGJveC5nZXRTaXplKHNpemUpOwogICAgICAgICAgICAgICAgY29uc3QgY2VudGVyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgIGJveC5nZXRDZW50ZXIoY2VudGVyKTsKCiAgICAgICAgICAgICAgICAvLyA0LiBWYWxpZGF0aW9uCiAgICAgICAgICAgICAgICBjb25zdCBtYXhEaW0gPSBNYXRoLm1heChzaXplLngsIHNpemUueSwgc2l6ZS56KTsKICAgICAgICAgICAgICAgIGlmIChtYXhEaW0gPD0gMC4wMDEgfHwgIWlzRmluaXRlKG1heERpbSkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkJhbGwgbW9kZWwgaGFzIGludmFsaWQgZGltZW5zaW9ucy4gS2VlcGluZyBwbGFjZWhvbGRlci4iKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDUuIENhbGN1bGF0ZSBTY2FsZQovLyA1LiBDYWxjdWxhdGUgU2NhbGUKY29uc3QgdGFyZ2V0RGlhbWV0ZXIgPSAwLjcyOyAvLyBSZWR1Y2VkIHNjYWxlIGJ5IH4xNSUgKHdhcyAwLjg1KQogICAgICAgICAgICAgICAgY29uc3Qgc2NhbGVGYWN0b3IgPSB0YXJnZXREaWFtZXRlciAvIG1heERpbTsKCiAgICAgICAgICAgICAgICAvLyA2LiBBcHBseSBUcmFuc2Zvcm1zCiAgICAgICAgICAgICAgICBtb2RlbC5zY2FsZS5zZXRTY2FsYXIoc2NhbGVGYWN0b3IpOwogICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uY29weShjZW50ZXIpLm11bHRpcGx5U2NhbGFyKC1zY2FsZUZhY3Rvcik7CgogICAgICAgICAgICAgICAgLy8gNy4gU3dhcCBQbGFjZWhvbGRlcgogICAgICAgICAgICAgICAgaWYgKHRoaXMucGxhY2Vob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNwaW5Ob2RlLnJlbW92ZSh0aGlzLnBsYWNlaG9sZGVyKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlci5nZW9tZXRyeSkgdGhpcy5wbGFjZWhvbGRlci5nZW9tZXRyeS5kaXNwb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGFjZWhvbGRlciA9IG51bGw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5tb2RlbCA9IG1vZGVsOwogICAgICAgICAgICAgICAgdGhpcy5zcGluTm9kZS5hZGQodGhpcy5tb2RlbCk7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgQmxpdHpiYWxsIG1vZGVsIGF0dGFjaGVkLiBTY2FsZTogJHtzY2FsZUZhY3Rvci50b0ZpeGVkKDQpfWApOwoKICAgICAgICAgICAgfSwgdW5kZWZpbmVkLCAoZXJyKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJGYWlsZWQgdG8gbG9hZCBCbGl0emJhbGwgbW9kZWw6IiwgZXJyKTsKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrOiBLZWVwIHBsYWNlaG9sZGVyIGJ1dCB0aW50IGl0IHJlZCB0byBpbmRpY2F0ZSBlcnJvcgogICAgICAgICAgICAgICAgaWYgKHRoaXMucGxhY2Vob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmYWFhYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQmFsbCBMYWIgcmVwbGF5IG92ZXJyaWRlIChsZXRzIERldlRvb2xzIGRyaXZlIHRoZSBiYWxsIGRldGVybWluaXN0aWNhbGx5KQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzICYmIHR5cGVvZiBfX2xhYi5hcHBseVJlcGxheUZyYW1lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBfX2xhYi5hcHBseVJlcGxheUZyYW1lKHRoaXMsIGR0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRyYWlsKSB0aGlzLnRyYWlsLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBpZiBwb3NpdGlvbiBjb3JydXB0ZWQKICAgICAgICAgICAgaWYgKGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi54KSB8fCBpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueSkgfHwgaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLnopKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNhZmV0eTogRml4ICJVbnBpY2thYmxlIEJhbGwiIEJ1ZwogICAgICAgICAgICAvLyBJZiBzdGF0ZSBpcyAnaGVsZCcgb3IgJ21hZ25ldGl6ZWQnIGJ1dCB0aGUgYWN0b3IgaXMgbWlzc2luZy9pbnZhbGlkLCBmb3JjZSBkcm9wIHRvICdmcmVlJy4KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdoZWxkJyAmJiAoIXRoaXMuaG9sZGVyIHx8ICF0aGlzLmhvbGRlci5tZXNoKSkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdtYWduZXRpemVkJyAmJiAoIXRoaXMubWFnbmV0VGFyZ2V0IHx8ICF0aGlzLm1hZ25ldFRhcmdldC5tZXNoKSkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgIH0KaWYgKHRoaXMudHJhaWwpIHsKICAgICAgICAgICAgICAgIC8vIFRyYWlsIGlzIGFjdGl2ZSBpZiBiYWxsIGlzIG1vdmluZyBmYXN0IGFuZCBmcmVlCiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICB0aGlzLnRyYWlsLmFjdGl2ZSA9ICh0aGlzLnN0YXRlID09PSAnZnJlZScgJiYgc3BlZWQgPiAyLjApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGaXg6IE9mZnNldCB0cmFpbCB0byBtYXRjaCB2aXN1YWwgbW9kZWwgcG9zaXRpb24gKGRlZm9ybU5vZGUgb2Zmc2V0KQogICAgICAgICAgICAgICAgX2JWZWMuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgX2JWZWMueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKCiAgICAgICAgICAgICAgICAvLyBQYXNzIHNwZWVkIHJhdGlvICgwIHRvIDEgYmFzZWQgb24gbWF4IHNwZWVkIGFwcHJveCA2MCkKICAgICAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4oc3BlZWQgLyA2MC4wLCAxLjApOwogICAgICAgICAgICAgICAgdGhpcy50cmFpbC51cGRhdGUoX2JWZWMsIHJhdGlvKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdoZWxkJyAmJiB0aGlzLmhvbGRlciAmJiB0aGlzLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUhlbGQoZHQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc3RhdGUgPT09ICdtYWduZXRpemVkJykgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVNYWduZXRpemVkKGR0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlRnJlZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgLT0gZHQ7CiAgICAgICAgICAgIH0KCnRoaXMudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTYWZldHk6IEVuc3VyZSB2aXNpYmlsaXR5IGlmIG5vdCBleHBsaWNpdGx5IGludmlzaWJsZQovLyBTYWZldHk6IEVuc3VyZSB2aXNpYmlsaXR5IGlmIG5vdCBleHBsaWNpdGx5IGludmlzaWJsZQogICAgICAgICAgICBpZiAodGhpcy5tZXNoICYmICF0aGlzLmlzSW52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBGb3JjZSBtb2RlbCB2aXNpYmlsaXR5IGlmIHByZXNlbnQgKHNvbWV0aW1lcyBHTFRGIGxvYWRlciBoaWRlcyBpdCkKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1vZGVsKSB0aGlzLm1vZGVsLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKbWFnbmV0aXplKHRhcmdldCkgewogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ21hZ25ldGl6ZWQnIHx8IHRoaXMuc3RhdGUgPT09ICdoZWxkJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtYWduZXRpemVkJzsKICAgICAgICAgICAgdGhpcy5tYWduZXRUYXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICAgIHRoaXMuaG9sZGVyID0gdGFyZ2V0OyAvLyBMb2dpY2FsIHBvc3Nlc3Npb24gc28gQUkgcmVhY3RzCiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1hZ25ldFN0YXJ0UG9zLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFZlbC5jb3B5KHRoaXMudmVsb2NpdHkpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRHluYW1pYyBEdXJhdGlvbiBiYXNlZCBvbiBkaXN0YW5jZSAoU21vb3RoZXIgZm9yIGxvbmcgcmFuZ2UsIHNuYXBweSBmb3IgY2xvc2UpCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIHRoaXMubWFnbmV0RHVyYXRpb24gPSBNYXRoLm1heCgwLjE1LCBNYXRoLm1pbigwLjQsIGRpc3QgLyAxNS4wKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBLaWxsIHBoeXNpY3MKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIE5vdGlmeSBwbGF5ZXIgaW1tZWRpYXRlbHkgc28gdGhleSBzdG9wIGNoYXNpbmcgYW5kIHBsYXkgYW5pbWF0aW9uCiAgICAgICAgICAgIGlmICh0YXJnZXQucmVjZWl2ZUJhbGwpIHsKICAgICAgICAgICAgICAgIHRhcmdldC5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnJldmVhbCgpOwogICAgICAgIH0KCnVwZGF0ZU1hZ25ldGl6ZWQoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1hZ25ldFRhcmdldCB8fCAhdGhpcy5tYWduZXRUYXJnZXQubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgKz0gZHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3JtYWxpemVkIFRpbWUKICAgICAgICAgICAgbGV0IHQgPSB0aGlzLm1hZ25ldFRpbWVyIC8gdGhpcy5tYWduZXREdXJhdGlvbjsKICAgICAgICAgICAgaWYgKHQgPiAxLjApIHQgPSAxLjA7CgogICAgICAgICAgICAvLyBUYXJnZXQgIlZpcnR1YWwgSGFuZCIgUG9zaXRpb24gKEZyb250IG9mIENoZXN0KQogICAgICAgICAgICBjb25zdCBob2xkZXJQb3MgPSB0aGlzLm1hZ25ldFRhcmdldC5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBob2xkZXJRdWF0ID0gdGhpcy5tYWduZXRUYXJnZXQubWVzaC5xdWF0ZXJuaW9uOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT2Zmc2V0OiBGb3J3YXJkIDAuNiwgVXAgMS4wIChDaGVzdCBoZWlnaHQpCiAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IF9iVmVjLnNldCgwLCAxLjAsIDAuNikuYXBwbHlRdWF0ZXJuaW9uKGhvbGRlclF1YXQpOwogICAgICAgICAgICBjb25zdCB0YXJnZXRQb3MgPSBvZmZzZXQuYWRkKGhvbGRlclBvcyk7CgogICAgICAgICAgICAvLyAtLS0gUVVBRFJBVElDIEJFWklFUiBDVVJWRSAtLS0KICAgICAgICAgICAgLy8gUDAgPSBTdGFydCwgUDIgPSBUYXJnZXQKICAgICAgICAgICAgLy8gUDEgPSBDb250cm9sIFBvaW50IChQcm9qZWN0ZWQgYWxvbmcgaW5pdGlhbCB2ZWxvY2l0eSB0byBwcmVzZXJ2ZSBtb21lbnR1bSBmZWVsKQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcDAgPSB0aGlzLm1hZ25ldFN0YXJ0UG9zOwogICAgICAgICAgICBjb25zdCBwMiA9IHRhcmdldFBvczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBQMSAoQ29udHJvbCBQb2ludCkKICAgICAgICAgICAgLy8gUHJvamVjdCBmb3J3YXJkIGZyb20gUDAgYWxvbmcgc3RhcnQgdmVsb2NpdHkgdmVjdG9yCiAgICAgICAgICAgIC8vIERpc3RhbmNlIG9mIHByb2plY3Rpb24gPSA0MCUgb2YgdG90YWwgZGlzdGFuY2UgdG8gdGFyZ2V0CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBwMC5kaXN0YW5jZVRvKHAyKTsKICAgICAgICAgICAgY29uc3QgcDEgPSBfdGVtcFZlYy5jb3B5KHAwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHZlbExlbiA9IHRoaXMubWFnbmV0U3RhcnRWZWwubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHZlbExlbiA+IDEuMCkgewogICAgICAgICAgICAgICAgLy8gVXNlIHZlbG9jaXR5IHRhbmdlbnQKLy8gVXNlIHZlbG9jaXR5IHRhbmdlbnQKICAgICAgICAgICAgICAgIF9iRGlyLmNvcHkodGhpcy5tYWduZXRTdGFydFZlbCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBwMS5hZGQoX2JEaXIubXVsdGlwbHlTY2FsYXIoZGlzdCAqIDAuNCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gTm8gdmVsb2NpdHkgKHN0YXRpb25hcnkgYmFsbCksIGFyYyB1cHdhcmRzIHNsaWdodGx5CiAgICAgICAgICAgICAgICBwMS5sZXJwKHAyLCAwLjUpOwogICAgICAgICAgICAgICAgcDEueSArPSAxLjU7IAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCZXppZXI6IEIodCkgPSAoMS10KV4yICogUDAgKyAyKDEtdCl0ICogUDEgKyB0XjIgKiBQMgogICAgICAgICAgICBjb25zdCBvbmVNaW51c1QgPSAxLjAgLSB0OwogICAgICAgICAgICBjb25zdCB3MCA9IG9uZU1pbnVzVCAqIG9uZU1pbnVzVDsKICAgICAgICAgICAgY29uc3QgdzEgPSAyLjAgKiBvbmVNaW51c1QgKiB0OwogICAgICAgICAgICBjb25zdCB3MiA9IHQgKiB0OwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnggPSAodzAgKiBwMC54KSArICh3MSAqIHAxLngpICsgKHcyICogcDIueCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gKHcwICogcDAueSkgKyAodzEgKiBwMS55KSArICh3MiAqIHAyLnkpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueiA9ICh3MCAqIHAwLnopICsgKHcxICogcDEueikgKyAodzIgKiBwMi56KTsKCiAgICAgICAgICAgIC8vIEZpbmlzaAogICAgICAgICAgICBpZiAodCA+PSAxLjApIHsKICAgICAgICAgICAgICAgIHRoaXMuZ3JhYih0aGlzLm1hZ25ldFRhcmdldCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGVIZWxkKGR0KSB7CiAgICAgICAgICAgIC8vIEFUVEFDSEVEIFNUQVRFIChWaXJ0dWFsIEF0dGFjaG1lbnQpCiAgICAgICAgICAgIGlmICghdGhpcy5ob2xkZXIgfHwgIXRoaXMuaG9sZGVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gMS4gVHJ5IHRvIHVzZSBIYW5kIEJvbmUgaWYgYXZhaWxhYmxlIChSZWFsaXNtKQogICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIuaGFuZEJvbmUpIHsKICAgICAgICAgICAgICAgIC8vIEdldCB3b3JsZCBwb3NpdGlvbiBvZiB0aGUgaGFuZCBib25lCiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlci5oYW5kQm9uZS5nZXRXb3JsZFBvc2l0aW9uKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEFkanVzdCBzbGlnaHRseSB0byBzaXQgSU4gdGhlIGhhbmQgcmF0aGVyIHRoYW4gT04gdGhlIHdyaXN0CiAgICAgICAgICAgICAgICAvLyBXZSBjYW4ndCBlYXNpbHkga25vdyAiZm9yd2FyZCIgZm9yIHRoZSBib25lIHdpdGhvdXQgbW9yZSBpbmZvLCAKICAgICAgICAgICAgICAgIC8vIGJ1dCB1c3VhbGx5IEdMVEYgYm9uZXMgYXJlIG9yaWVudGVkLiBGb3Igbm93LCBleGFjdCBib25lIHBvcyBpcyBiZXR0ZXIgdGhhbiBjaGVzdC4KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIDIuIEZhbGxiYWNrOiBDYWxjdWxhdGUgIkNhcnJ5aW5nIiBQb3NpdGlvbiAoUmlnaHQgSGFuZCBTaWRlKQogICAgICAgICAgICAgICAgLy8gUmVsYXRpdmUgdG8gcGxheWVyOiBVcCAwLjggKFdhaXN0L0NoZXN0KSwgUmlnaHQgMC40LCBGb3J3YXJkIDAuNQogICAgICAgICAgICAgICAgY29uc3QgaG9sZGVyUG9zID0gdGhpcy5ob2xkZXIubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGhvbGRlclF1YXQgPSB0aGlzLmhvbGRlci5tZXNoLnF1YXRlcm5pb247CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJldXNlIF9iVmVjCi8vIFJldXNlIF9iVmVjCiAgICAgICAgICAgICAgICAvLyBPZmZzZXQ6IHg9MC4zNSAoUmlnaHQpLCB5PTEuMyAoQ2hlc3QvSGFuZHMpLCB6PTAuNSAoRm9yd2FyZCkKICAgICAgICAgICAgICAgIF9iVmVjLnNldCgwLjM1LCAxLjMsIDAuNSkuYXBwbHlRdWF0ZXJuaW9uKGhvbGRlclF1YXQpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmNvcHkoaG9sZGVyUG9zKS5hZGQoX2JWZWMpOwogICAgICAgICAgICB9CgovLyBWaXN1YWwgRmxhaXI6IFNwaW4gdGhlIGJhbGwgc2xvd2x5CiAgICAgICAgICAgIGNvbnN0IHJvdFggPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUobmV3IFRIUkVFLlZlY3RvcjMoMSwwLDApLCAyICogZHQpOwogICAgICAgICAgICBjb25zdCByb3RZID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMSwwKSwgNSAqIGR0KTsKICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uLm11bHRpcGx5KHJvdFgpLm11bHRpcGx5KHJvdFkpOwogICAgICAgIH0KCgp1cGRhdGVGcmVlKGR0KSB7CiAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgIGNvbnN0IHN1YnN0ZXBzID0gTWF0aC5tYXgoMSwgTWF0aC5mbG9vcihDLlNVQlNURVBTIHx8IDEpKTsKICAgIGNvbnN0IHN0ZXBEdCA9IGR0IC8gc3Vic3RlcHM7CgogICAgLy8gLS0tIDEpIEludGVncmF0ZSBwaHlzaWNzIGluIHN1YnN0ZXBzIGZvciBzdGFiaWxpdHkgLS0tCiAgICBmb3IgKGxldCBzID0gMDsgcyA8IHN1YnN0ZXBzOyBzKyspIHsKICAgICAgICAvLyBBKSBNYWdudXMgZWZmZWN0IChjdXJ2ZSBmcm9tIHNwaW4pCiAgICAgICAgaWYgKEMuTUFHTlVTX0VOQUJMRUQgJiYgdGhpcy5hbmd1bGFyVmVsb2NpdHkgJiYgdGhpcy52ZWxvY2l0eSkgewogICAgICAgICAgICBjb25zdCBzcGluU3EgPSB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICBjb25zdCB2ZWxTcSA9IHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHNwaW5TcSA+IDAuMjUgJiYgdmVsU3EgPiAwLjI1KSB7CiAgICAgICAgICAgICAgICBfbWFnbnVzVmVjLmNvcHkodGhpcy5hbmd1bGFyVmVsb2NpdHkpLmNyb3NzKHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKChDLk1BR05VU19DT0VGRiB8fCAwKSAqIHN0ZXBEdCk7CgogICAgICAgICAgICAgICAgLy8gQ2FwIHRvIGF2b2lkIG51bWVyaWMgYmxvd3VwcwogICAgICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTUFHTlVTX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5NQUdOVVNfQ0FQIDogNjAuMCk7CiAgICAgICAgICAgICAgICBjb25zdCBtYWdMZW4gPSBfbWFnbnVzVmVjLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgaWYgKG1hZ0xlbiA+IGNhcCkgX21hZ251c1ZlYy5tdWx0aXBseVNjYWxhcihjYXAgLyBtYWdMZW4pOwoKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKF9tYWdudXNWZWMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBCKSBTcGluIGRlY2F5CiAgICAgICAgaWYgKHRoaXMuYW5ndWxhclZlbG9jaXR5KSB7CiAgICAgICAgICAgIGNvbnN0IHNwaW5EcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gKEMuU1BJTl9EUkFHIHx8IDApICogc3RlcER0KTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoc3BpbkRyYWcpOwogICAgICAgIH0KCiAgICAgICAgLy8gQykgRGVwdGggc3ByaW5nIChrZWVwcyBiYWxsIG5lYXIgcGxhbmUpCiAgICAgICAgY29uc3QgdGFyZ2V0WSA9IChDLkRFUFRIX1RBUkdFVF9ZICE9PSB1bmRlZmluZWQgPyBDLkRFUFRIX1RBUkdFVF9ZIDogMC4wKTsKICAgICAgICBjb25zdCB5RXJyID0gKHRoaXMubWVzaC5wb3NpdGlvbi55IC0gdGFyZ2V0WSk7CiAgICAgICAgdGhpcy52ZWxvY2l0eS55IC09IHlFcnIgKiAoQy5ERVBUSF9TUFJJTkcgfHwgMCkgKiBzdGVwRHQ7CiAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IE1hdGgubWF4KDAsIDEuMCAtIChDLkRFUFRIX0RBTVAgfHwgMCkgKiBzdGVwRHQpOwoKICAgICAgICAvLyBEKSBBcHBseSBkcmFnIChsaW5lYXIgKyBxdWFkcmF0aWMpCiAgICAgICAgY29uc3QgdkxlbiA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgaWYgKHZMZW4gPiAwLjAwMDAxKSB7CiAgICAgICAgICAgIGNvbnN0IGxpbiA9IChDLldBVEVSX0RSQUdfTElORUFSICE9PSB1bmRlZmluZWQgPyBDLldBVEVSX0RSQUdfTElORUFSIDogKEMuV0FURVJfRFJBRyB8fCAwKSkgKiBzdGVwRHQ7CiAgICAgICAgICAgIGNvbnN0IHF1YWQgPSAoQy5XQVRFUl9EUkFHX1FVQUQgfHwgMCkgKiB2TGVuICogc3RlcER0OwogICAgICAgICAgICBjb25zdCBkcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gbGluIC0gcXVhZCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoZHJhZyk7CgogICAgICAgICAgICBjb25zdCBzdG9wID0gKEMuU1RPUF9TUEVFRCB8fCAwKTsKICAgICAgICAgICAgaWYgKHN0b3AgPiAwICYmIHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKSA8IHN0b3AgKiBzdG9wKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRSkgTW92ZQogICAgICAgIF90ZW1wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoc3RlcER0KTsKICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF90ZW1wVmVjKTsKCiAgICAgICAgLy8gRikgU3RhdCBwb3dlciBkZWNheSAoZ2FtZSBsb2dpYykKICAgICAgICBpZiAodGhpcy5wb3dlciA+IDApIHsKICAgICAgICAgICAgdGhpcy5wb3dlciAtPSB0aGlzLmRlY2F5UmF0ZSAqIHN0ZXBEdDsKICAgICAgICAgICAgaWYgKHRoaXMucG93ZXIgPCAwKSB0aGlzLnBvd2VyID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIEcpIEJvdW5kYXJ5IGxvZ2ljIChzb2Z0IHdhbGwgKyBjbGFtcCkKICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1lc2gucG9zaXRpb247CiAgICAgICAgY29uc3QgZGlzdFhaID0gTWF0aC5zcXJ0KHBvcy54ICogcG9zLnggKyBwb3MueiAqIHBvcy56KTsKCiAgICAgICAgY29uc3QgYm91bmRhcnlSYWRpdXMgPSAoQy5CT1VOREFSWV9SQURJVVMgIT09IHVuZGVmaW5lZCA/IEMuQk9VTkRBUllfUkFESVVTIDogMzMuMCk7CiAgICAgICAgbGV0IGVmZmVjdGl2ZUJvdW5kYXJ5ID0gYm91bmRhcnlSYWRpdXM7CgogICAgICAgIGlmIChDLkdPQUxfUE9DS0VUX0VOQUJMRUQpIHsKICAgICAgICAgICAgY29uc3QgaW5Hb2FsUG9ja2V0ID0gKE1hdGguYWJzKHBvcy54KSA8IChDLkdPQUxfUE9DS0VUX1ggfHwgMTIuMCkgJiYgTWF0aC5hYnMocG9zLnopID4gKEMuR09BTF9QT0NLRVRfWiB8fCAyNS4wKSk7CiAgICAgICAgICAgIGlmIChpbkdvYWxQb2NrZXQpIGVmZmVjdGl2ZUJvdW5kYXJ5ID0gKEMuR09BTF9QT0NLRVRfUkFESVVTIHx8IDQ1LjApOwogICAgICAgIH0KCiAgICAgICAgY29uc3Qgc29mdEJ1ZmZlciA9IE1hdGgubWF4KDAuMDEsIChDLldBTExfU09GVF9CVUZGRVIgIT09IHVuZGVmaW5lZCA/IEMuV0FMTF9TT0ZUX0JVRkZFUiA6IDMuMCkpOwoKICAgICAgICAvLyBTb2Z0IHJlcHVsc2lvbiAoY3VydmVzIHRyYWplY3RvcnkgbmVhciB3YWxsIGluc3RlYWQgb2YgcGluZy1wb25nKQogICAgICAgIGlmIChkaXN0WFogPiBlZmZlY3RpdmVCb3VuZGFyeSAtIHNvZnRCdWZmZXIpIHsKICAgICAgICAgICAgY29uc3QgcGVuZXRyYXRpb24gPSBkaXN0WFogLSAoZWZmZWN0aXZlQm91bmRhcnkgLSBzb2Z0QnVmZmVyKTsKICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBwZW5ldHJhdGlvbiAvIHNvZnRCdWZmZXIpKTsKCiAgICAgICAgICAgIF90ZW1wVmVjLnNldCgtcG9zLngsIDAsIC1wb3Mueik7CiAgICAgICAgICAgIGlmIChfdGVtcFZlYy5sZW5ndGhTcSgpID4gMC4wMDAxKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYy5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gcmF0aW8gKiByYXRpbyAqIChDLldBTExfU09GVF9GT1JDRSB8fCAwKSAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjLCBmb3JjZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEhhcmQgY2xhbXAgaWYgaXQgc3RpbGwgaGl0cwogICAgICAgIGlmIChkaXN0WFogPiBlZmZlY3RpdmVCb3VuZGFyeSkgewogICAgICAgICAgICBfdGVtcFZlYy5zZXQoLXBvcy54LCAwLCAtcG9zLnopOwogICAgICAgICAgICBpZiAoX3RlbXBWZWMubGVuZ3RoU3EoKSA+IDAuMDAwMSkgX3RlbXBWZWMubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBvdmVybGFwID0gZGlzdFhaIC0gZWZmZWN0aXZlQm91bmRhcnk7CiAgICAgICAgICAgIHBvcy5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMsIG92ZXJsYXApOwoKY29uc3QgdkRvdE4gPSB0aGlzLnZlbG9jaXR5LmRvdChfdGVtcFZlYyk7CgogICAgICAgICAgICAvLyBPbmx5IGFkanVzdCBpZiBtb3Zpbmcgb3V0d2FyZCAoYWdhaW5zdCBpbndhcmQgbm9ybWFsKQogICAgICAgICAgICBpZiAodkRvdE4gPCAwKSB7CiAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIEFyZW5hIERlZm9ybWF0aW9uIGlmIGltcGFjdCBpcyBmb3JjZWZ1bAogICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0U3BlZWQgPSBNYXRoLmFicyh2RG90Tik7CiAgICAgICAgICAgICAgICBpZiAoaW1wYWN0U3BlZWQgPiAxMC4wICYmIHdpbmRvdy5mbHV4LnRyaWdnZXJBcmVuYUltcGFjdCkgewogICAgICAgICAgICAgICAgICAgIC8vIFBhc3MgdGhlIGNvbnRhY3QgcG9pbnQgKHBvcykgYW5kIHN0cmVuZ3RoIGJhc2VkIG9uIHNwZWVkCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KHBvcywgTWF0aC5taW4oaW1wYWN0U3BlZWQgKiAwLjUsIDE1LjApKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBlID0gKEMuV0FMTF9FTEFTVElDSVRZICE9PSB1bmRlZmluZWQgPyBDLldBTExfRUxBU1RJQ0lUWSA6IDAuMyk7CiAgICAgICAgICAgICAgICBjb25zdCBpbXB1bHNlID0gX3RlbXBWZWMuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtdkRvdE4gKiAoMS4wICsgZSkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoaW1wdWxzZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRhbmdlbnRpYWwgZnJpY3Rpb24KICAgICAgICAgICAgICAgIGNvbnN0IGZyaWN0aW9uID0gKEMuV0FMTF9GUklDVElPTiAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX0ZSSUNUSU9OIDogMC45NSk7CiAgICAgICAgICAgICAgICBjb25zdCB0YW5nZW50ID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLnByb2plY3RPblBsYW5lKF90ZW1wVmVjKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc3ViKHRhbmdlbnQubXVsdGlwbHlTY2FsYXIoMS4wIC0gZnJpY3Rpb24pKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQ2VpbGluZy9GbG9vciBjbGFtcAogICAgICAgIGNvbnN0IGJoID0gKEMuQk9VTkRBUllfSEVJR0hUICE9PSB1bmRlZmluZWQgPyBDLkJPVU5EQVJZX0hFSUdIVCA6IDE1LjApOwogICAgICAgIGlmIChNYXRoLmFicyhwb3MueSkgPiBiaCkgewogICAgICAgICAgICBjb25zdCBzaWduID0gTWF0aC5zaWduKHBvcy55KSB8fCAxOwogICAgICAgICAgICBwb3MueSA9IGJoICogc2lnbjsKICAgICAgICAgICAgY29uc3QgZmUgPSAoQy5GTE9PUl9FTEFTVElDSVRZICE9PSB1bmRlZmluZWQgPyBDLkZMT09SX0VMQVNUSUNJVFkgOiAwLjQpOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLWZlOwp9CiAgICB9CgogICAgLy8gLS0tIDIpIEZYIHRoYXQgc2hvdWxkIHJ1biBvbmNlIHBlciBmcmFtZSAobm90IHBlciBzdWJzdGVwKSAtLS0KICAgIGlmICghdGhpcy5fZ2hvc3QpIHsKICAgICAgICBjb25zdCBzcGVlZFNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgIGlmIChzcGVlZFNxID4gMi4wICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5fYnViYmxlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgY29uc3QgcG0gPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKC0wLjgpOwoKICAgICAgICAgICAgICAgIC8vIFN0YW5kYXJkIGJ1YmJsZQovLyBTdGFuZGFyZCBidWJibGUKICAgICAgICAgICAgICAgIGNvbnN0IHN0ZFBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLmFkZChfYkRpci5zZXQoKE1hdGgucmFuZG9tKCktMC41KSowLjMsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4zLCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuMykpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3RkUG9zLnkgKz0gdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlJywgc3RkUG9zLCB7IHNjYWxlOiAwLjQgKyBNYXRoLnJhbmRvbSgpICogMC40IH0pOyAvLyBJbmNyZWFzZWQgc2NhbGUKCiAgICAgICAgICAgICAgICAvLyBNaWNybyBidWJibGVzIGF0IGhpZ2ggc3BlZWQKICAgICAgICAgICAgICAgIGlmIChzcGVlZFNxID4gNTAuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gTWF0aC5taW4oNCwgTWF0aC5mbG9vcihzcGVlZFNxIC8gNjApKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKY29uc3Qgaml0dGVyID0gX2JEaXIuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC40LCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuNCwgKE1hdGgucmFuZG9tKCktMC41KSowLjQpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGF3blBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLmFkZChqaXR0ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWZvcm1Ob2RlKSBzcGF3blBvcy55ICs9IHRoaXMuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlX21pY3JvJywgc3Bhd25Qb3MsIHsgc2NhbGU6IDAuMDUgKyBNYXRoLnJhbmRvbSgpICogMC4xIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDAuMDI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gMC41KSB7CmNvbnN0IGppdHRlciA9IF9iRGlyLnNldCgoTWF0aC5yYW5kb20oKS0wLjUpKjAuMiwgKE1hdGgucmFuZG9tKCktMC41KSowLjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3Bhd25Qb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQob2Zmc2V0KS5hZGQoaml0dGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3Bhd25Qb3MueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIHNwYXduUG9zLCB7IHNjYWxlOiAwLjA0ICsgTWF0aC5yYW5kb20oKSAqIDAuMDYgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4wNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLyAtLS0gMykgVmlzdWFsIHJvdGF0aW9uIC0tLQogICAgY29uc3Qgc3BpblNwZWVkID0gdGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCk7CiAgICBpZiAoc3BpblNwZWVkID4gMC41KSB7CiAgICAgICAgY29uc3QgYXhpcyA9IF90ZW1wVmVjLmNvcHkodGhpcy5hbmd1bGFyVmVsb2NpdHkpLm5vcm1hbGl6ZSgpOwogICAgICAgIGNvbnN0IHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUoYXhpcywgc3BpblNwZWVkICogZHQpOwogICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5wcmVtdWx0aXBseShxKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgIGlmIChzcGVlZCA+IDAuMSkgewogICAgICAgICAgICBfdGVtcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLmNyb3NzKF9heGlzWSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGlmIChfdGVtcFZlYy5sZW5ndGhTcSgpID4gMC4wMSkgewogICAgICAgICAgICAgICAgY29uc3QgcSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShfdGVtcFZlYywgc3BlZWQgKiBkdCk7CiAgICAgICAgICAgICAgICB0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24ucHJlbXVsdGlwbHkocSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCmdyYWIocGxheWVyKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50OiBQb3NzZXNzaW9uIChpZiB0YWtpbmcgZnJvbSBmcmVlIHN0YXRlKQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCgiUE9TU0VTU0lPTiIsICJub3JtYWwiKTsKICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIFR1cm5vdmVyIChQb3NzZXNzaW9uIENoYW5nZSkKICAgICAgICAgICAgY29uc3QgcHJldmlvdXNUZWFtID0gdGhpcy5ob2xkZXIgPyB0aGlzLmhvbGRlci50ZWFtIDogKHRoaXMubGFzdEhvbGRlciA/IHRoaXMubGFzdEhvbGRlci50ZWFtIDogbnVsbCk7CiAgICAgICAgICAgIGlmIChwcmV2aW91c1RlYW0gJiYgcHJldmlvdXNUZWFtICE9PSBwbGF5ZXIudGVhbSkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJUVVJOT1ZFUiIsIHBsYXllci5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgc29tZW9uZSBlbHNlIGhlbGQgaXQsIHRoZXkgbG9zZSBpdAogICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIgIT09IHBsYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIubG9zZUJhbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBwbGF5ZXI7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaGVsZCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOT1RFOiBXZSBkbyBOT1QgcGFyZW50IHRoZSBtZXNoIHRvIHRoZSBwbGF5ZXIgYW55bW9yZS4KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyB0aGUgYmFsbCBmcm9tIGZseWluZyBhcm91bmQgZHVlIHRvIHN3aW0gYW5pbWF0aW9ucy4KICAgICAgICAgICAgLy8gSW5zdGVhZCwgd2UgdXBkYXRlIGl0cyBwb3NpdGlvbiBtYW51YWxseSBpbiB1cGRhdGVIZWxkKCkuCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3RpZnkgcGxheWVyCiAgICAgICAgICAgIGlmIChwbGF5ZXIucmVjZWl2ZUJhbGwpIHsKICAgICAgICAgICAgICAgIHBsYXllci5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zb2xlLmxvZygiQmFsbCBncmFiYmVkIGJ5ICIgKyBwbGF5ZXIucm9sZSk7CiAgICAgICAgfQoKICAgICAgICBkcm9wKCkgewogICAgICAgICAgICB0aGlzLnJldmVhbCgpOyAvLyBFbnN1cmUgdmlzaWJsZQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm8gbmVlZCB0byBkZXRhY2ggZnJvbSBzY2VuZSBncmFwaCBzaW5jZSB3ZSBhcmVuJ3QgcGFyZW50aW5nIHRvIHBsYXllciBhbnltb3JlLgogICAgICAgICAgICAvLyBKdXN0IGNsZWFyIGhvbGRlci4KCiAgICAgICAgICAgIGlmICh0aGlzLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmxvc2VCYWxsKSB0aGlzLmhvbGRlci5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIH0KLy8gU2hvb3QvUGFzcwovLyBTaG9vdC9QYXNzCiAgICAgICAgc2hvb3QoZGlyZWN0aW9uVmVjdG9yLCBmb3JjZSwgdHlwZSA9ICdTSCcsIHRlY2huaXF1ZSA9IG51bGwsIHNwaW5WZWN0b3IgPSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMubGFzdEhvbGRlciA9IHRoaXMuaG9sZGVyOyAvLyBSZWNvcmQgZm9yIEVYUCBhdHRyaWJ1dGlvbgogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVtYmxlIERldGVjdGlvbiAoVHlwZSAnbm9uZScgaXMgdXNlZCBieSBQbGF5ZXIuZnVtYmxlKQogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ25vbmUnKSB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNob3dBbm5vdW5jZW1lbnQoIkZVTUJMRSEiLCAic2xhbSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmRyb3AoKTsgLy8gRGV0YWNoIGZpcnN0CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXQgR3JhY2UgUGVyaW9kIHRvIHByZXZlbnQgaW5zdGFudCBpbnRlcmNlcHRpb25zL2NhdGNoZXMKICAgICAgICAgICAgLy8gMC4ycyBhbGxvd3MgYmFsbCB0byBjbGVhciB0aGUgdGhyb3dlcidzIGltbWVkaWF0ZSB2aWNpbml0eQogICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwLjI7CgogICAgICAgICAgICAvLyBQaHlzaWNhbCBWZWxvY2l0eSAoVmlzdWFsIHNwZWVkKQovLyBQaHlzaWNhbCBWZWxvY2l0eSAoVmlzdWFsIHNwZWVkKQogICAgICAgICAgICAvLyBXZSBtYXAgZm9yY2UgKHN0YXQpIHRvIHBoeXNpY2FsIHNwZWVkLCBidXQgY2xhbXAgaXQgcmVhc29uYWJsZQogICAgICAgICAgICAvLyBJbmNyZWFzZWQgY2FwIHRvIDQwLjAgdG8gYWxsb3cgZm9yIHN0cm9uZyBwYXNzZXMgYW5kIGNsZWFycwovLyBJbmNyZWFzZWQgY2FwIHRvIDg1LjAgdG8gYWxsb3cgZm9yIHN0cm9uZyBwYXNzZXMgYW5kIGNsZWFycyBhbmQgIk1heCBQb3dlciIgZmVlbApjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAoQy5MQVVOQ0hfU1BFRURfU0NBTEUgIT09IHVuZGVmaW5lZCA/IEMuTEFVTkNIX1NQRUVEX1NDQUxFIDogMS4wKTsKICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTEFVTkNIX1NQRUVEX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5MQVVOQ0hfU1BFRURfQ0FQIDogODUuMCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5taW4oZm9yY2UgKiBzY2FsZSwgY2FwKTsKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5jb3B5KGRpcmVjdGlvblZlY3Rvcikubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgU3BpbiBpZiBwcm92aWRlZAogICAgICAgICAgICBpZiAoc3BpblZlY3RvcikgewogICAgICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuY29weShzcGluVmVjdG9yKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhdCBQb3dlciAoR2FtZSBMb2dpYykKICAgICAgICAgICAgdGhpcy5wb3dlciA9IGZvcmNlOwogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9IHR5cGU7CiAgICAgICAgICAgIHRoaXMudGVjaG5pcXVlID0gdGVjaG5pcXVlOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBUcmFpbCBDb2xvcgogICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgewogICAgICAgICAgICAgICAgbGV0IGNvbG9yID0gMHgwMGFhZmY7IC8vIERlZmF1bHQgQmx1ZSAoUGFzcykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ3Zlbm9tJykgY29sb3IgPSAweGFhMDBmZjsgLy8gUHVycGxlCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICd3aXRoZXInKSBjb2xvciA9IDB4ODg4ODg4OyAvLyBHcmV5CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICduYXAnKSBjb2xvciA9IDB4MDAwMDg4OyAvLyBEYXJrIEJsdWUKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ3NwaGVyZScpIGNvbG9yID0gMHgwMGZmZmY7IC8vIEN5YW4KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ2plY2h0JykgY29sb3IgPSAweGZmMDAwMDsgLy8gUmVkCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICBjb2xvciA9IDB4ZmY0NDAwOyAvLyBPcmFuZ2UvUmVkCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwuc2V0Q29sb3IoY29sb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIYW5kbGUgSW52aXNpYmxlIFNob3QKICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSAmJiB0ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgdGhpcy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJJbnZpc2libGUgU2hvdCEiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc29sZS5sb2coYEJhbGwgJHt0eXBlfSB3aXRoIFBvd2VyOiAke3RoaXMucG93ZXIudG9GaXhlZCgxKX0gU3BpbjogJHt0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGgoKS50b0ZpeGVkKDEpfWApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrIGZvciBDdXJ2ZQogICAgICAgICAgICBpZiAodGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkgPiAxNS4wICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldmVhbCgpIHsKCiAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgdGhpcy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgICAKcmVzZXQoKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7CiAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwOwogICAgICAgICAgICB0aGlzLnBvd2VyID0gMDsKICAgICAgICB9CmlzQ2F0Y2hhYmxlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jYXRjaEdyYWNlUGVyaW9kIDw9IDA7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWxzKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5kZWZvcm1Ob2RlIHx8ICF0aGlzLnNwaW5Ob2RlKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBTcXVhc2ggJiBTdHJldGNoIGJhc2VkIG9uIHZlbG9jaXR5Ci8vIDEuIFNxdWFzaCAmIFN0cmV0Y2ggYmFzZWQgb24gdmVsb2NpdHkKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT25seSBhcHBseSBzdHJldGNoIGlmIG1vdmluZyBmYXN0IGVub3VnaAogICAgICAgICAgICBpZiAoc3BlZWQgPiAxLjAgJiYgdGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAvLyBPcmllbnQgZGVmb3JtTm9kZSB0byB2ZWxvY2l0eSBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgZm9yd2FyZCBpcyBaICgwLDAsMSkKICAgICAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLnNldEZyb21Vbml0VmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLDAsMSksIGRpcik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBzdHJldGNoIGZhY3RvcgogICAgICAgICAgICAgICAgLy8gTWF4IHN0cmV0Y2ggYXQgc3BlZWQgNDAgKGFwcHJveCBtYXggc2hvdCBwb3dlcikKICAgICAgICAgICAgICAgIGNvbnN0IGZhY3RvciA9IE1hdGgubWluKHNwZWVkIC8gNDAuMCwgMS4wKTsgCiAgICAgICAgICAgICAgICBjb25zdCBzdHJldGNoID0gMS4wICsgKGZhY3RvciAqIDAuOCk7IC8vIEluY3JlYXNlZCBzdHJldGNoIG1heCB0byAxLjh4CiAgICAgICAgICAgICAgICBjb25zdCBzcXVhc2ggPSAxLjAgLyBNYXRoLnNxcnQoc3RyZXRjaCk7IC8vIE1haW50YWluIHZvbHVtZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUuc2NhbGUuc2V0KHNxdWFzaCwgc3F1YXNoLCBzdHJldGNoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFJlc2V0IGRlZm9ybWF0aW9uCiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUucXVhdGVybmlvbi5pZGVudGl0eSgpOwogICAgICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnNjYWxlLnNldCgxLCAxLCAxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gQXBwbHkgQWNjdW11bGF0ZWQgU3BpbgogICAgICAgICAgICAvLyBTaW5jZSBkZWZvcm1Ob2RlIG1pZ2h0IGJlIHJvdGF0ZWQsIHdlIG5lZWQgdG8gYXBwbHkgc3BpbiBpbiB0aGUgY29ycmVjdCBzcGFjZS4KICAgICAgICAgICAgLy8gc3Bpbk5vZGUgcm90YXRpb24gPSBkZWZvcm1Ob2RlX2ludmVyc2UgKiBhY2N1bXVsYXRlZFJvdGF0aW9uCmNvbnN0IGludkRlZm9ybSA9IHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLmNsb25lKCkuaW52ZXJ0KCk7CiAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucXVhdGVybmlvbi5jb3B5KGludkRlZm9ybS5tdWx0aXBseSh0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24pKTsKICAgICAgICB9CiAgICB9Cgp3aW5kb3cuZmx1eC5CYWxsID0gQmFsbDsKICAgIHdpbmRvdy5mbHV4LlRyYWlsUmVuZGVyZXIgPSBUcmFpbFJlbmRlcmVyOwp9KSgpOw==","/Ball.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIHZlY3RvcnMgdG8gYXZvaWQgR0MKY29uc3QgX2JWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2JEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2F4aXNZID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CiAgICBjb25zdCBfdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbWFnbnVzVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCi8vIFBoeXNpY3MgQ29uZmlndXJhdGlvbiAoRXhwb3NlZCBmb3IgRGV2VG9vbHMpCndpbmRvdy5mbHV4LkJhbGxDb25maWcgPSB7CiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBDb3JlIGludGVncmF0aW9uCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBTVUJTVEVQUzogMiwgICAgICAgICAgICAgICAgLy8gUGh5c2ljcyBzdWJzdGVwcyBwZXIgZnJhbWUgKHN0YWJpbGl0eSBhdCBoaWdoIHNwZWVkcykKICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLCAgICAgICAgICAgLy8gQmVsb3cgdGhpcyBzcGVlZCwgc25hcCB0byByZXN0IChwcmV2ZW50cyBlbmRsZXNzIGRyaWZ0KQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFdhdGVyIHJlc2lzdGFuY2UgKHBoeXNpY2FsIHZlbG9jaXR5IGRyYWcsIE5PVCBzdGF0IGRlY2F5KQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMTUsICAgIC8vIExpbmVhciBkcmFnIHRlcm0gKHJvdWdobHkgeW91ciBwcmV2aW91cyBXQVRFUl9EUkFHKQogICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDIsICAgICAvLyBRdWFkcmF0aWMgZHJhZyAoc3Ryb25nZXIgYXQgaGlnaCBzcGVlZCwgaGVscHMgdGFtZSByb2NrZXRzKQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFNwaW4gJiBjdXJ2ZQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgU1BJTl9EUkFHOiAwLjQwLCAgICAgICAgICAgIC8vIFNwaW4gZGVjYXkgcGVyIHNlY29uZAogICAgICAgIE1BR05VU19FTkFCTEVEOiB0cnVlLAogICAgICAgIE1BR05VU19DT0VGRjogMC4wOCwgICAgICAgICAvLyBMaWZ0IHN0cmVuZ3RoCiAgICAgICAgTUFHTlVTX0NBUDogNjAuMCwgICAgICAgICAgIC8vIE1heCBtYWdudXMgZGVsdGEtViBwZXIgc3Vic3RlcCAocHJldmVudHMgZXhwbG9zaW9ucykKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBEZXB0aCBjb25zdHJhaW50IChrZWVwcyBiYWxsIG5lYXIgcGxheSBwbGFuZSB3aXRob3V0IGZlZWxpbmcgbGlrZSBhIGhhcmQgZmxvb3IpCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBERVBUSF9UQVJHRVRfWTogMC4wLAogICAgICAgIERFUFRIX1NQUklORzogMS4wLCAgICAgICAgICAvLyBZb3VyIHByZXZpb3VzIEdSQVZJVFlfU1BSSU5HCiAgICAgICAgREVQVEhfREFNUDogMS41LCAgICAgICAgICAgIC8vIFlvdXIgcHJldmlvdXMgR1JBVklUWV9EQU1QCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gQXJlbmEgYm91bmRhcnkgKHNvZnQgd2FsbCArIGNsYW1wKQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCkJPVU5EQVJZX1JBRElVUzogNDYuMCwKICAgICAgICBCT1VOREFSWV9IRUlHSFQ6IDIwLjAsCiAgICAgICAgR09BTF9QT0NLRVRfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBHT0FMX1BPQ0tFVF9YOiAxMi4wLCAgICAgICAgLy8gSGFsZi13aWR0aCBvZiBnb2FsIHBvY2tldCBjb3JyaWRvcgogICAgICAgIEdPQUxfUE9DS0VUX1o6IDQwLjAsICAgICAgICAvLyBTdGFydCBvZiBnb2FsIHBvY2tldCBjb3JyaWRvciAoYWJzIHopIC0gUHVzaGVkIGJhY2sKICAgICAgICBHT0FMX1BPQ0tFVF9SQURJVVM6IDU1LjAsICAgLy8gRWZmZWN0aXZlIHJhZGl1cyB3aGVuIGluIGdvYWwgcG9ja2V0CiAgICAgICAgV0FMTF9TT0ZUX0JVRkZFUjogMy4wLCAgICAgIC8vIERpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMKICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDIwLjAsICAgICAgLy8gU29mdCByZXB1bHNpb24gc3RyZW5ndGgKICAgICAgICBXQUxMX0VMQVNUSUNJVFk6IDAuMzAsICAgICAgLy8gQm91bmNlIGRhbXBlbmluZyBvbiBjbGFtcAogICAgICAgIFdBTExfRlJJQ1RJT046IDAuOTUsICAgICAgICAvLyBUYW5nZW50aWFsIGRhbXBpbmcgb24gd2FsbCBjb250YWN0CgogICAgICAgIEZMT09SX0VMQVNUSUNJVFk6IDAuNDAsICAgICAvLyBCb3VuY2UgZGFtcGVuaW5nIG9uIGNlaWxpbmcvZmxvb3IgY2xhbXAKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBUaHJvdyBtYXBwaW5nIChzdGF0IGZvcmNlIC0+IHBoeXNpY2FsIGxhdW5jaCBzcGVlZCkKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIExBVU5DSF9TUEVFRF9TQ0FMRTogMS4wLCAgICAvLyBNdWx0aXBsaWVzIGZvcmNlIHdoZW4gY29udmVydGluZyB0byB2ZWxvY2l0eQogICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDg1LjAgICAgICAvLyBQaHlzaWNhbCBzcGVlZCBjYXAgKHdhcyBoYXJkY29kZWQgaW4gQmFsbC5zaG9vdCkKICAgIH07CgoKICAgIAogICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWc7IC8vIExvY2FsIGFsaWFzIGZvciBicmV2aXR5CiAgICAvLyAtLS0gVFJBSUwgUkVOREVSRVIgLS0tCi8vIC0tLSBUUkFJTCBSRU5ERVJFUiAtLS0KICAgIGNsYXNzIFRyYWlsUmVuZGVyZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5zZWdtZW50cyA9IDMwOyAvLyBNb3JlIHNlZ21lbnRzIGZvciBzbW9vdGhlciBjdXJ2ZXMKICAgICAgICAgICAgdGhpcy5wb2ludHMgPSBbXTsKdGhpcy5iYXNlV2lkdGggPSAwLjg7IC8vIEluY3JlYXNlZCB3aWR0aCBmb3IgdmlzaWJpbGl0eQogICAgICAgICAgICB0aGlzLmN1cnJlbnRXaWR0aCA9IDAuODsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJ5CiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgICAgIGNvbnN0IHBvc0RhdGEgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuc2VnbWVudHMgKiAyICogMyk7CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHBvc0RhdGEsIDMpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluZGljZXMKICAgICAgICAgICAgY29uc3QgaW5kaWNlcyA9IFtdOwogICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50cy0xOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhc2UgPSBpKjI7CiAgICAgICAgICAgICAgICBpbmRpY2VzLnB1c2goYmFzZSwgYmFzZSsxLCBiYXNlKzIpOwogICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGJhc2UrMSwgYmFzZSszLCBiYXNlKzIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEluZGV4KGluZGljZXMpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBjb2xvcjogMHgwMGFhZmYsCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLjksIC8vIEluY3JlYXNlZCBvcGFjaXR5CiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLm1lc2gpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW5pdCBwb2ludHMKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB0aGlzLnBvaW50cy5wdXNoKG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUmV1c2FibGUgdGVtcHMgKGF2b2lkIHBlci1mcmFtZSBhbGxvY2F0aW9ucyBvbiBtb2JpbGUpCiAgICAgICAgICAgIHRoaXMuX3RtcERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuX3RtcFRvQ2FtID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5fdG1wUmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXNldChwb3MpIHsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB0aGlzLnBvaW50c1tpXS5jb3B5KHBvcyk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlR2VvbWV0cnkoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgc2V0Q29sb3IoaGV4KSB7CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KGhleCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZShjdXJyZW50UG9zLCBzcGVlZFJhdGlvID0gMC4wKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXQoY3VycmVudFBvcyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCi8vIER5bmFtaWMgV2lkdGggYmFzZWQgb24gc3BlZWQgQU5EIFNQSU4gKFBvd2VyIFZpc3VhbCkKICAgICAgICAgICAgLy8gRmFzdCBiYWxsID0gVGhpY2tlci4gU3Bpbm5pbmcgYmFsbCA9IEV2ZW4gVGhpY2tlci4KICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgY29uc3Qgc3BpblJhdGlvID0gYmFsbCA/IE1hdGgubWluKDEuMCwgYmFsbC5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkgLyAzMC4wKSA6IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB0YXJnZXRXaWR0aCA9IHRoaXMuYmFzZVdpZHRoICogKDAuOCArIHNwZWVkUmF0aW8gKiAxLjIgKyBzcGluUmF0aW8gKiAyLjApOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRXaWR0aCArPSAodGFyZ2V0V2lkdGggLSB0aGlzLmN1cnJlbnRXaWR0aCkgKiAwLjI7IC8vIFNtb290aCB0cmFuc2l0aW9uCgogICAgICAgICAgICAvLyBTaGlmdCBwb2ludHMKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuc2VnbWVudHMgLSAxOyBpID4gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBvaW50c1tpXS5jb3B5KHRoaXMucG9pbnRzW2ktMV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucG9pbnRzWzBdLmNvcHkoY3VycmVudFBvcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVwZGF0ZUdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZUdlb21ldHJ5KCkgewogICAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5hcnJheTsKICAgICAgICAgICAgY29uc3QgY2FtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSA6IG51bGw7CiAgICAgICAgICAgIGlmICghY2FtKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IGNhbS5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgdGVtcERpciA9IHRoaXMuX3RtcERpcjsKICAgICAgICAgICAgY29uc3QgdGVtcFRvQ2FtID0gdGhpcy5fdG1wVG9DYW07CiAgICAgICAgICAgIGNvbnN0IHRlbXBSaWdodCA9IHRoaXMuX3RtcFJpZ2h0OwogICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5wb2ludHNbaV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRhcGVyIHdpZHRoIGFsb25nIHRyYWlsIGxlbmd0aAogICAgICAgICAgICAgICAgY29uc3QgdGFwZXIgPSAxLjAgLSBNYXRoLnBvdyhpIC8gdGhpcy5zZWdtZW50cywgMik7IC8vIFF1YWRyYXRpYyB0YXBlcgogICAgICAgICAgICAgICAgY29uc3QgdyA9IHRoaXMuY3VycmVudFdpZHRoICogdGFwZXI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIGlmIChpIDwgdGhpcy5zZWdtZW50cyAtIDEpIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wRGlyLnN1YlZlY3RvcnModGhpcy5wb2ludHNbaV0sIHRoaXMucG9pbnRzW2krMV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wRGlyLnN1YlZlY3RvcnModGhpcy5wb2ludHNbaS0xXSwgdGhpcy5wb2ludHNbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGVtcERpci5sZW5ndGhTcSgpIDwgMC4wMDAxKSB0ZW1wRGlyLnNldCgwLCAxLCAwKTsKICAgICAgICAgICAgICAgIHRlbXBEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRlbXBUb0NhbS5zdWJWZWN0b3JzKGNhbVBvcywgcCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0ZW1wUmlnaHQuY3Jvc3NWZWN0b3JzKHRlbXBEaXIsIHRlbXBUb0NhbSkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIodyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZlcnQgMQogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDBdID0gcC54IC0gdGVtcFJpZ2h0Lng7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgMV0gPSBwLnkgLSB0ZW1wUmlnaHQueTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAyXSA9IHAueiAtIHRlbXBSaWdodC56OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZXJ0IDIKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAzXSA9IHAueCArIHRlbXBSaWdodC54OwogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDRdID0gcC55ICsgdGVtcFJpZ2h0Lnk7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgNV0gPSBwLnogKyB0ZW1wUmlnaHQuejsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgfQogICAgfQpjbGFzcyBCYWxsIHsKCiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7IAogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSBudWxsOyAvLyBUcmFjayB3aG8gdGhyZXcgaXQgbGFzdCAoZm9yIEVYUC9Bc3Npc3RzKQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOyAvLyAnZnJlZScsICdoZWxkJywgJ21hZ25ldGl6ZWQnCiAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIENvbnRpbnVvdXMgU3RhdHMKICAgICAgICAgICAgdGhpcy5wb3dlciA9IDA7ICAgICAgLy8gQ3VycmVudCBQQSBvciBTSCB2YWx1ZQogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9ICdub25lJzsgLy8gJ1BBJyBvciAnU0gnCiAgICAgICAgICAgIHRoaXMuZGVjYXlSYXRlID0gMy4wOyAvLyBTdGF0IHBvaW50cyBsb3N0IHBlciBzZWNvbmQgKFdhdGVyIHJlc2lzdGFuY2UpCiAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7IC8vIFRpbWUgYmVmb3JlIGJhbGwgY2FuIGJlIGNhdWdodCBhZ2FpbgoKICAgICAgICAgICAgLy8gTWFnbmV0IFN5c3RlbQogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1hZ25ldER1cmF0aW9uID0gMC4yOyAKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gVmlzdWFscyAoU3F1YXNoICYgU3RyZXRjaCkKICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zcGluTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubW9kZWwgPSBudWxsOwoKdGhpcy5pbml0TWVzaCgpOwogICAgICAgICAgICB0aGlzLnRyYWlsID0gbmV3IFRyYWlsUmVuZGVyZXIoc2NlbmUpOwogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDA7Cn0KaW5pdE1lc2goKSB7CiAgICAgICAgICAgIC8vIEhpZXJhcmNoeTogTWVzaCAoUG9zKSAtPiBEZWZvcm0gKFNxdWFzaC9TdHJldGNoKSAtPiBTcGluIChSb3RhdGlvbikgLT4gTW9kZWwKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7CgogICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKdGhpcy5kZWZvcm1Ob2RlID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5wb3NpdGlvbi55ID0gMC4wOyAvLyBSZXNldCBvZmZzZXQgc28gYmFsbCBpcyBjZW50ZXJlZCBvbiBtZXNoIHBvc2l0aW9uCiAgICAgICAgICAgIHRoaXMubWVzaC5hZGQodGhpcy5kZWZvcm1Ob2RlKTsgLy8gRml4OiBBZGQgZGVmb3JtTm9kZSB0byBtZXNoCgogICAgICAgICAgICB0aGlzLnNwaW5Ob2RlID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5hZGQodGhpcy5zcGluTm9kZSk7CgogICAgICAgICAgICAvLyBQcm9jZWR1cmFsIFBsYWNlaG9sZGVyIFRleHR1cmUgKEJsaXR6YmFsbC1pc2gpCiAgICAgICAgICAgIGNvbnN0IHBsYWNlaG9sZGVyVGV4ID0gKCgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICAgICAgICAgIGMud2lkdGggPSAxMjg7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNlZWVlZWUnOwogICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsMCwxMjgsNjQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBCbHVlIGJ1bXBzL2RldGFpbHMKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwODhmZic7CiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTw2OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmFyYyhpKjI1LCAzMiwgMTAsIDAsIE1hdGguUEkqMik7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwNDQ4OCc7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMjgsIDEyOCwgOCk7IC8vIFN0cmlwZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICAgICAgICAgIH0pKCk7CgogICAgICAgICAgICAvLyBQbGFjZWhvbGRlciBWaXN1YWwgKEltbWVkaWF0ZSBmZWVkYmFjaywgcGVyc2lzdHMgdW50aWwgdmFsaWQgbW9kZWwgbG9hZHMpCi8vIFBsYWNlaG9sZGVyIFZpc3VhbCAoSW1tZWRpYXRlIGZlZWRiYWNrLCBwZXJzaXN0cyB1bnRpbCB2YWxpZCBtb2RlbCBsb2FkcykKLy8gUGxhY2Vob2xkZXIgVmlzdWFsIChJbW1lZGlhdGUgZmVlZGJhY2ssIHBlcnNpc3RzIHVudGlsIHZhbGlkIG1vZGVsIGxvYWRzKQpjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeSgwLjMsIDE2LCAxNik7IC8vIFNjYWxlZCBkb3duIH4xNSUKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgbWFwOiBwbGFjZWhvbGRlclRleCwKICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZiwgCiAgICAgICAgICAgICAgICB3aXJlZnJhbWU6IGZhbHNlLCAvLyBTb2xpZAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IGZhbHNlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMS4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsKTsKCiAgICAgICAgICAgIC8vIExvYWQgR0xCIE1vZGVsCiAgICAgICAgICAgIGNvbnN0IHVybCA9ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTIxYWU4Nzg4ZTU4NGUzNzhhNzlkOTczMmEwNzUzNTYuZ2xiJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbCh1cmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiREVCVUc6IEJhbGwgR0xCIGxvYWRlZC4iLCBnbHRmKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgbW9kZWwgPSBnbHRmLnNjZW5lOwoKICAgICAgICAgICAgICAgIC8vIDEuIFJlc2V0IHJvb3QgdHJhbnNmb3JtcwogICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgbW9kZWwucm90YXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgbW9kZWwuc2NhbGUuc2V0KDEsIDEsIDEpOwogICAgICAgICAgICAgICAgbW9kZWwudXBkYXRlTWF0cml4V29ybGQodHJ1ZSk7CgogICAgICAgICAgICAgICAgLy8gMi4gSGFyZGVuIE1hdGVyaWFscyAmIFZpc2liaWxpdHkKICAgICAgICAgICAgICAgIG1vZGVsLnRyYXZlcnNlKChub2RlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuY2FzdFNoYWRvdyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBub2RlLnJlY2VpdmVTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7IC8vIENSSVRJQ0FMOiBQcmV2ZW50IGN1bGxpbmcgaWYgYm91bmRzIGFyZSBvZmYKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRzID0gQXJyYXkuaXNBcnJheShub2RlLm1hdGVyaWFsKSA/IG5vZGUubWF0ZXJpYWwgOiBbbm9kZS5tYXRlcmlhbF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRzLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5jb2xvci5zZXRIZXgoMHhmZmZmZmYpOyAvLyBGb3JjZSB3aGl0ZSBiYXNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5zaWRlID0gVEhSRUUuRG91YmxlU2lkZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnRyYW5zcGFyZW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5vcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uYWxwaGFUZXN0ID0gMDsgLy8gQ1JJVElDQUw6IERpc2FibGUgYWxwaGEgdGVzdCB0byBwcmV2ZW50IGN1bGxpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLmRlcHRoV3JpdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uZGVwdGhUZXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgLy8gMy4gQ29tcHV0ZSBCb3VuZGluZyBCb3gKICAgICAgICAgICAgICAgIGNvbnN0IGJveCA9IG5ldyBUSFJFRS5Cb3gzKCkuc2V0RnJvbU9iamVjdChtb2RlbCk7CiAgICAgICAgICAgICAgICBjb25zdCBzaXplID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgIGJveC5nZXRTaXplKHNpemUpOwogICAgICAgICAgICAgICAgY29uc3QgY2VudGVyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgIGJveC5nZXRDZW50ZXIoY2VudGVyKTsKCiAgICAgICAgICAgICAgICAvLyA0LiBWYWxpZGF0aW9uCiAgICAgICAgICAgICAgICBjb25zdCBtYXhEaW0gPSBNYXRoLm1heChzaXplLngsIHNpemUueSwgc2l6ZS56KTsKICAgICAgICAgICAgICAgIGlmIChtYXhEaW0gPD0gMC4wMDEgfHwgIWlzRmluaXRlKG1heERpbSkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkJhbGwgbW9kZWwgaGFzIGludmFsaWQgZGltZW5zaW9ucy4gS2VlcGluZyBwbGFjZWhvbGRlci4iKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDUuIENhbGN1bGF0ZSBTY2FsZQovLyA1LiBDYWxjdWxhdGUgU2NhbGUKY29uc3QgdGFyZ2V0RGlhbWV0ZXIgPSAwLjcyOyAvLyBSZWR1Y2VkIHNjYWxlIGJ5IH4xNSUgKHdhcyAwLjg1KQogICAgICAgICAgICAgICAgY29uc3Qgc2NhbGVGYWN0b3IgPSB0YXJnZXREaWFtZXRlciAvIG1heERpbTsKCiAgICAgICAgICAgICAgICAvLyA2LiBBcHBseSBUcmFuc2Zvcm1zCiAgICAgICAgICAgICAgICBtb2RlbC5zY2FsZS5zZXRTY2FsYXIoc2NhbGVGYWN0b3IpOwogICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uY29weShjZW50ZXIpLm11bHRpcGx5U2NhbGFyKC1zY2FsZUZhY3Rvcik7CgogICAgICAgICAgICAgICAgLy8gNy4gU3dhcCBQbGFjZWhvbGRlcgogICAgICAgICAgICAgICAgaWYgKHRoaXMucGxhY2Vob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNwaW5Ob2RlLnJlbW92ZSh0aGlzLnBsYWNlaG9sZGVyKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlci5nZW9tZXRyeSkgdGhpcy5wbGFjZWhvbGRlci5nZW9tZXRyeS5kaXNwb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGFjZWhvbGRlciA9IG51bGw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5tb2RlbCA9IG1vZGVsOwogICAgICAgICAgICAgICAgdGhpcy5zcGluTm9kZS5hZGQodGhpcy5tb2RlbCk7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgQmxpdHpiYWxsIG1vZGVsIGF0dGFjaGVkLiBTY2FsZTogJHtzY2FsZUZhY3Rvci50b0ZpeGVkKDQpfWApOwoKICAgICAgICAgICAgfSwgdW5kZWZpbmVkLCAoZXJyKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJGYWlsZWQgdG8gbG9hZCBCbGl0emJhbGwgbW9kZWw6IiwgZXJyKTsKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrOiBLZWVwIHBsYWNlaG9sZGVyIGJ1dCB0aW50IGl0IHJlZCB0byBpbmRpY2F0ZSBlcnJvcgogICAgICAgICAgICAgICAgaWYgKHRoaXMucGxhY2Vob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmYWFhYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQmFsbCBMYWIgcmVwbGF5IG92ZXJyaWRlIChsZXRzIERldlRvb2xzIGRyaXZlIHRoZSBiYWxsIGRldGVybWluaXN0aWNhbGx5KQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzICYmIHR5cGVvZiBfX2xhYi5hcHBseVJlcGxheUZyYW1lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBfX2xhYi5hcHBseVJlcGxheUZyYW1lKHRoaXMsIGR0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRyYWlsKSB0aGlzLnRyYWlsLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBpZiBwb3NpdGlvbiBjb3JydXB0ZWQKICAgICAgICAgICAgaWYgKGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi54KSB8fCBpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueSkgfHwgaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLnopKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNhZmV0eTogRml4ICJVbnBpY2thYmxlIEJhbGwiIEJ1ZwogICAgICAgICAgICAvLyBJZiBzdGF0ZSBpcyAnaGVsZCcgb3IgJ21hZ25ldGl6ZWQnIGJ1dCB0aGUgYWN0b3IgaXMgbWlzc2luZy9pbnZhbGlkLCBmb3JjZSBkcm9wIHRvICdmcmVlJy4KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdoZWxkJyAmJiAoIXRoaXMuaG9sZGVyIHx8ICF0aGlzLmhvbGRlci5tZXNoKSkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdtYWduZXRpemVkJyAmJiAoIXRoaXMubWFnbmV0VGFyZ2V0IHx8ICF0aGlzLm1hZ25ldFRhcmdldC5tZXNoKSkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgIH0KaWYgKHRoaXMudHJhaWwpIHsKICAgICAgICAgICAgICAgIC8vIFRyYWlsIGlzIGFjdGl2ZSBpZiBiYWxsIGlzIG1vdmluZyBmYXN0IGFuZCBmcmVlCiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICB0aGlzLnRyYWlsLmFjdGl2ZSA9ICh0aGlzLnN0YXRlID09PSAnZnJlZScgJiYgc3BlZWQgPiAyLjApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGaXg6IE9mZnNldCB0cmFpbCB0byBtYXRjaCB2aXN1YWwgbW9kZWwgcG9zaXRpb24gKGRlZm9ybU5vZGUgb2Zmc2V0KQogICAgICAgICAgICAgICAgX2JWZWMuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgX2JWZWMueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKCiAgICAgICAgICAgICAgICAvLyBQYXNzIHNwZWVkIHJhdGlvICgwIHRvIDEgYmFzZWQgb24gbWF4IHNwZWVkIGFwcHJveCA2MCkKICAgICAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4oc3BlZWQgLyA2MC4wLCAxLjApOwogICAgICAgICAgICAgICAgdGhpcy50cmFpbC51cGRhdGUoX2JWZWMsIHJhdGlvKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdoZWxkJyAmJiB0aGlzLmhvbGRlciAmJiB0aGlzLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUhlbGQoZHQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc3RhdGUgPT09ICdtYWduZXRpemVkJykgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVNYWduZXRpemVkKGR0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlRnJlZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgLT0gZHQ7CiAgICAgICAgICAgIH0KCnRoaXMudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTYWZldHk6IEVuc3VyZSB2aXNpYmlsaXR5IGlmIG5vdCBleHBsaWNpdGx5IGludmlzaWJsZQovLyBTYWZldHk6IEVuc3VyZSB2aXNpYmlsaXR5IGlmIG5vdCBleHBsaWNpdGx5IGludmlzaWJsZQogICAgICAgICAgICBpZiAodGhpcy5tZXNoICYmICF0aGlzLmlzSW52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBGb3JjZSBtb2RlbCB2aXNpYmlsaXR5IGlmIHByZXNlbnQgKHNvbWV0aW1lcyBHTFRGIGxvYWRlciBoaWRlcyBpdCkKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1vZGVsKSB0aGlzLm1vZGVsLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKbWFnbmV0aXplKHRhcmdldCkgewogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ21hZ25ldGl6ZWQnIHx8IHRoaXMuc3RhdGUgPT09ICdoZWxkJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtYWduZXRpemVkJzsKICAgICAgICAgICAgdGhpcy5tYWduZXRUYXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICAgIHRoaXMuaG9sZGVyID0gdGFyZ2V0OyAvLyBMb2dpY2FsIHBvc3Nlc3Npb24gc28gQUkgcmVhY3RzCiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1hZ25ldFN0YXJ0UG9zLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFZlbC5jb3B5KHRoaXMudmVsb2NpdHkpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRHluYW1pYyBEdXJhdGlvbiBiYXNlZCBvbiBkaXN0YW5jZSAoU21vb3RoZXIgZm9yIGxvbmcgcmFuZ2UsIHNuYXBweSBmb3IgY2xvc2UpCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIHRoaXMubWFnbmV0RHVyYXRpb24gPSBNYXRoLm1heCgwLjE1LCBNYXRoLm1pbigwLjQsIGRpc3QgLyAxNS4wKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBLaWxsIHBoeXNpY3MKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIE5vdGlmeSBwbGF5ZXIgaW1tZWRpYXRlbHkgc28gdGhleSBzdG9wIGNoYXNpbmcgYW5kIHBsYXkgYW5pbWF0aW9uCiAgICAgICAgICAgIGlmICh0YXJnZXQucmVjZWl2ZUJhbGwpIHsKICAgICAgICAgICAgICAgIHRhcmdldC5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnJldmVhbCgpOwogICAgICAgIH0KCnVwZGF0ZU1hZ25ldGl6ZWQoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1hZ25ldFRhcmdldCB8fCAhdGhpcy5tYWduZXRUYXJnZXQubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgKz0gZHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3JtYWxpemVkIFRpbWUKICAgICAgICAgICAgbGV0IHQgPSB0aGlzLm1hZ25ldFRpbWVyIC8gdGhpcy5tYWduZXREdXJhdGlvbjsKICAgICAgICAgICAgaWYgKHQgPiAxLjApIHQgPSAxLjA7CgogICAgICAgICAgICAvLyBUYXJnZXQgIlZpcnR1YWwgSGFuZCIgUG9zaXRpb24gKEZyb250IG9mIENoZXN0KQogICAgICAgICAgICBjb25zdCBob2xkZXJQb3MgPSB0aGlzLm1hZ25ldFRhcmdldC5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBob2xkZXJRdWF0ID0gdGhpcy5tYWduZXRUYXJnZXQubWVzaC5xdWF0ZXJuaW9uOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT2Zmc2V0OiBGb3J3YXJkIDAuNiwgVXAgMS4wIChDaGVzdCBoZWlnaHQpCiAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IF9iVmVjLnNldCgwLCAxLjAsIDAuNikuYXBwbHlRdWF0ZXJuaW9uKGhvbGRlclF1YXQpOwogICAgICAgICAgICBjb25zdCB0YXJnZXRQb3MgPSBvZmZzZXQuYWRkKGhvbGRlclBvcyk7CgogICAgICAgICAgICAvLyAtLS0gUVVBRFJBVElDIEJFWklFUiBDVVJWRSAtLS0KICAgICAgICAgICAgLy8gUDAgPSBTdGFydCwgUDIgPSBUYXJnZXQKICAgICAgICAgICAgLy8gUDEgPSBDb250cm9sIFBvaW50IChQcm9qZWN0ZWQgYWxvbmcgaW5pdGlhbCB2ZWxvY2l0eSB0byBwcmVzZXJ2ZSBtb21lbnR1bSBmZWVsKQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcDAgPSB0aGlzLm1hZ25ldFN0YXJ0UG9zOwogICAgICAgICAgICBjb25zdCBwMiA9IHRhcmdldFBvczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBQMSAoQ29udHJvbCBQb2ludCkKICAgICAgICAgICAgLy8gUHJvamVjdCBmb3J3YXJkIGZyb20gUDAgYWxvbmcgc3RhcnQgdmVsb2NpdHkgdmVjdG9yCiAgICAgICAgICAgIC8vIERpc3RhbmNlIG9mIHByb2plY3Rpb24gPSA0MCUgb2YgdG90YWwgZGlzdGFuY2UgdG8gdGFyZ2V0CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBwMC5kaXN0YW5jZVRvKHAyKTsKICAgICAgICAgICAgY29uc3QgcDEgPSBfdGVtcFZlYy5jb3B5KHAwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHZlbExlbiA9IHRoaXMubWFnbmV0U3RhcnRWZWwubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHZlbExlbiA+IDEuMCkgewogICAgICAgICAgICAgICAgLy8gVXNlIHZlbG9jaXR5IHRhbmdlbnQKLy8gVXNlIHZlbG9jaXR5IHRhbmdlbnQKICAgICAgICAgICAgICAgIF9iRGlyLmNvcHkodGhpcy5tYWduZXRTdGFydFZlbCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBwMS5hZGQoX2JEaXIubXVsdGlwbHlTY2FsYXIoZGlzdCAqIDAuNCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gTm8gdmVsb2NpdHkgKHN0YXRpb25hcnkgYmFsbCksIGFyYyB1cHdhcmRzIHNsaWdodGx5CiAgICAgICAgICAgICAgICBwMS5sZXJwKHAyLCAwLjUpOwogICAgICAgICAgICAgICAgcDEueSArPSAxLjU7IAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCZXppZXI6IEIodCkgPSAoMS10KV4yICogUDAgKyAyKDEtdCl0ICogUDEgKyB0XjIgKiBQMgogICAgICAgICAgICBjb25zdCBvbmVNaW51c1QgPSAxLjAgLSB0OwogICAgICAgICAgICBjb25zdCB3MCA9IG9uZU1pbnVzVCAqIG9uZU1pbnVzVDsKICAgICAgICAgICAgY29uc3QgdzEgPSAyLjAgKiBvbmVNaW51c1QgKiB0OwogICAgICAgICAgICBjb25zdCB3MiA9IHQgKiB0OwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnggPSAodzAgKiBwMC54KSArICh3MSAqIHAxLngpICsgKHcyICogcDIueCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gKHcwICogcDAueSkgKyAodzEgKiBwMS55KSArICh3MiAqIHAyLnkpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueiA9ICh3MCAqIHAwLnopICsgKHcxICogcDEueikgKyAodzIgKiBwMi56KTsKCiAgICAgICAgICAgIC8vIEZpbmlzaAogICAgICAgICAgICBpZiAodCA+PSAxLjApIHsKICAgICAgICAgICAgICAgIHRoaXMuZ3JhYih0aGlzLm1hZ25ldFRhcmdldCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGVIZWxkKGR0KSB7CiAgICAgICAgICAgIC8vIEFUVEFDSEVEIFNUQVRFIChWaXJ0dWFsIEF0dGFjaG1lbnQpCiAgICAgICAgICAgIGlmICghdGhpcy5ob2xkZXIgfHwgIXRoaXMuaG9sZGVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gMS4gVHJ5IHRvIHVzZSBIYW5kIEJvbmUgaWYgYXZhaWxhYmxlIChSZWFsaXNtKQogICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIuaGFuZEJvbmUpIHsKICAgICAgICAgICAgICAgIC8vIEdldCB3b3JsZCBwb3NpdGlvbiBvZiB0aGUgaGFuZCBib25lCiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlci5oYW5kQm9uZS5nZXRXb3JsZFBvc2l0aW9uKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEFkanVzdCBzbGlnaHRseSB0byBzaXQgSU4gdGhlIGhhbmQgcmF0aGVyIHRoYW4gT04gdGhlIHdyaXN0CiAgICAgICAgICAgICAgICAvLyBXZSBjYW4ndCBlYXNpbHkga25vdyAiZm9yd2FyZCIgZm9yIHRoZSBib25lIHdpdGhvdXQgbW9yZSBpbmZvLCAKICAgICAgICAgICAgICAgIC8vIGJ1dCB1c3VhbGx5IEdMVEYgYm9uZXMgYXJlIG9yaWVudGVkLiBGb3Igbm93LCBleGFjdCBib25lIHBvcyBpcyBiZXR0ZXIgdGhhbiBjaGVzdC4KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIDIuIEZhbGxiYWNrOiBDYWxjdWxhdGUgIkNhcnJ5aW5nIiBQb3NpdGlvbiAoUmlnaHQgSGFuZCBTaWRlKQogICAgICAgICAgICAgICAgLy8gUmVsYXRpdmUgdG8gcGxheWVyOiBVcCAwLjggKFdhaXN0L0NoZXN0KSwgUmlnaHQgMC40LCBGb3J3YXJkIDAuNQogICAgICAgICAgICAgICAgY29uc3QgaG9sZGVyUG9zID0gdGhpcy5ob2xkZXIubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGhvbGRlclF1YXQgPSB0aGlzLmhvbGRlci5tZXNoLnF1YXRlcm5pb247CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJldXNlIF9iVmVjCi8vIFJldXNlIF9iVmVjCiAgICAgICAgICAgICAgICAvLyBPZmZzZXQ6IHg9MC4zNSAoUmlnaHQpLCB5PTEuMyAoQ2hlc3QvSGFuZHMpLCB6PTAuNSAoRm9yd2FyZCkKICAgICAgICAgICAgICAgIF9iVmVjLnNldCgwLjM1LCAxLjMsIDAuNSkuYXBwbHlRdWF0ZXJuaW9uKGhvbGRlclF1YXQpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmNvcHkoaG9sZGVyUG9zKS5hZGQoX2JWZWMpOwogICAgICAgICAgICB9CgovLyBWaXN1YWwgRmxhaXI6IFNwaW4gdGhlIGJhbGwgc2xvd2x5CiAgICAgICAgICAgIGNvbnN0IHJvdFggPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUobmV3IFRIUkVFLlZlY3RvcjMoMSwwLDApLCAyICogZHQpOwogICAgICAgICAgICBjb25zdCByb3RZID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMSwwKSwgNSAqIGR0KTsKICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uLm11bHRpcGx5KHJvdFgpLm11bHRpcGx5KHJvdFkpOwogICAgICAgIH0KCgp1cGRhdGVGcmVlKGR0KSB7CiAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgIGNvbnN0IHN1YnN0ZXBzID0gTWF0aC5tYXgoMSwgTWF0aC5mbG9vcihDLlNVQlNURVBTIHx8IDEpKTsKICAgIGNvbnN0IHN0ZXBEdCA9IGR0IC8gc3Vic3RlcHM7CgogICAgLy8gLS0tIDEpIEludGVncmF0ZSBwaHlzaWNzIGluIHN1YnN0ZXBzIGZvciBzdGFiaWxpdHkgLS0tCiAgICBmb3IgKGxldCBzID0gMDsgcyA8IHN1YnN0ZXBzOyBzKyspIHsKICAgICAgICAvLyBBKSBNYWdudXMgZWZmZWN0IChjdXJ2ZSBmcm9tIHNwaW4pCiAgICAgICAgaWYgKEMuTUFHTlVTX0VOQUJMRUQgJiYgdGhpcy5hbmd1bGFyVmVsb2NpdHkgJiYgdGhpcy52ZWxvY2l0eSkgewogICAgICAgICAgICBjb25zdCBzcGluU3EgPSB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICBjb25zdCB2ZWxTcSA9IHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHNwaW5TcSA+IDAuMjUgJiYgdmVsU3EgPiAwLjI1KSB7CiAgICAgICAgICAgICAgICBfbWFnbnVzVmVjLmNvcHkodGhpcy5hbmd1bGFyVmVsb2NpdHkpLmNyb3NzKHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKChDLk1BR05VU19DT0VGRiB8fCAwKSAqIHN0ZXBEdCk7CgogICAgICAgICAgICAgICAgLy8gQ2FwIHRvIGF2b2lkIG51bWVyaWMgYmxvd3VwcwogICAgICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTUFHTlVTX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5NQUdOVVNfQ0FQIDogNjAuMCk7CiAgICAgICAgICAgICAgICBjb25zdCBtYWdMZW4gPSBfbWFnbnVzVmVjLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgaWYgKG1hZ0xlbiA+IGNhcCkgX21hZ251c1ZlYy5tdWx0aXBseVNjYWxhcihjYXAgLyBtYWdMZW4pOwoKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKF9tYWdudXNWZWMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBCKSBTcGluIGRlY2F5CiAgICAgICAgaWYgKHRoaXMuYW5ndWxhclZlbG9jaXR5KSB7CiAgICAgICAgICAgIGNvbnN0IHNwaW5EcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gKEMuU1BJTl9EUkFHIHx8IDApICogc3RlcER0KTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoc3BpbkRyYWcpOwogICAgICAgIH0KCiAgICAgICAgLy8gQykgRGVwdGggc3ByaW5nIChrZWVwcyBiYWxsIG5lYXIgcGxhbmUpCiAgICAgICAgY29uc3QgdGFyZ2V0WSA9IChDLkRFUFRIX1RBUkdFVF9ZICE9PSB1bmRlZmluZWQgPyBDLkRFUFRIX1RBUkdFVF9ZIDogMC4wKTsKICAgICAgICBjb25zdCB5RXJyID0gKHRoaXMubWVzaC5wb3NpdGlvbi55IC0gdGFyZ2V0WSk7CiAgICAgICAgdGhpcy52ZWxvY2l0eS55IC09IHlFcnIgKiAoQy5ERVBUSF9TUFJJTkcgfHwgMCkgKiBzdGVwRHQ7CiAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IE1hdGgubWF4KDAsIDEuMCAtIChDLkRFUFRIX0RBTVAgfHwgMCkgKiBzdGVwRHQpOwoKICAgICAgICAvLyBEKSBBcHBseSBkcmFnIChsaW5lYXIgKyBxdWFkcmF0aWMpCiAgICAgICAgY29uc3QgdkxlbiA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgaWYgKHZMZW4gPiAwLjAwMDAxKSB7CiAgICAgICAgICAgIGNvbnN0IGxpbiA9IChDLldBVEVSX0RSQUdfTElORUFSICE9PSB1bmRlZmluZWQgPyBDLldBVEVSX0RSQUdfTElORUFSIDogKEMuV0FURVJfRFJBRyB8fCAwKSkgKiBzdGVwRHQ7CiAgICAgICAgICAgIGNvbnN0IHF1YWQgPSAoQy5XQVRFUl9EUkFHX1FVQUQgfHwgMCkgKiB2TGVuICogc3RlcER0OwogICAgICAgICAgICBjb25zdCBkcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gbGluIC0gcXVhZCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoZHJhZyk7CgogICAgICAgICAgICBjb25zdCBzdG9wID0gKEMuU1RPUF9TUEVFRCB8fCAwKTsKICAgICAgICAgICAgaWYgKHN0b3AgPiAwICYmIHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKSA8IHN0b3AgKiBzdG9wKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRSkgTW92ZQogICAgICAgIF90ZW1wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoc3RlcER0KTsKICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF90ZW1wVmVjKTsKCiAgICAgICAgLy8gRikgU3RhdCBwb3dlciBkZWNheSAoZ2FtZSBsb2dpYykKICAgICAgICBpZiAodGhpcy5wb3dlciA+IDApIHsKICAgICAgICAgICAgdGhpcy5wb3dlciAtPSB0aGlzLmRlY2F5UmF0ZSAqIHN0ZXBEdDsKICAgICAgICAgICAgaWYgKHRoaXMucG93ZXIgPCAwKSB0aGlzLnBvd2VyID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIEcpIEJvdW5kYXJ5IGxvZ2ljIChzb2Z0IHdhbGwgKyBjbGFtcCkKICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1lc2gucG9zaXRpb247CiAgICAgICAgY29uc3QgZGlzdFhaID0gTWF0aC5zcXJ0KHBvcy54ICogcG9zLnggKyBwb3MueiAqIHBvcy56KTsKCiAgICAgICAgY29uc3QgYm91bmRhcnlSYWRpdXMgPSAoQy5CT1VOREFSWV9SQURJVVMgIT09IHVuZGVmaW5lZCA/IEMuQk9VTkRBUllfUkFESVVTIDogMzMuMCk7CiAgICAgICAgbGV0IGVmZmVjdGl2ZUJvdW5kYXJ5ID0gYm91bmRhcnlSYWRpdXM7CgogICAgICAgIGlmIChDLkdPQUxfUE9DS0VUX0VOQUJMRUQpIHsKICAgICAgICAgICAgY29uc3QgaW5Hb2FsUG9ja2V0ID0gKE1hdGguYWJzKHBvcy54KSA8IChDLkdPQUxfUE9DS0VUX1ggfHwgMTIuMCkgJiYgTWF0aC5hYnMocG9zLnopID4gKEMuR09BTF9QT0NLRVRfWiB8fCAyNS4wKSk7CiAgICAgICAgICAgIGlmIChpbkdvYWxQb2NrZXQpIGVmZmVjdGl2ZUJvdW5kYXJ5ID0gKEMuR09BTF9QT0NLRVRfUkFESVVTIHx8IDQ1LjApOwogICAgICAgIH0KCiAgICAgICAgY29uc3Qgc29mdEJ1ZmZlciA9IE1hdGgubWF4KDAuMDEsIChDLldBTExfU09GVF9CVUZGRVIgIT09IHVuZGVmaW5lZCA/IEMuV0FMTF9TT0ZUX0JVRkZFUiA6IDMuMCkpOwoKICAgICAgICAvLyBTb2Z0IHJlcHVsc2lvbiAoY3VydmVzIHRyYWplY3RvcnkgbmVhciB3YWxsIGluc3RlYWQgb2YgcGluZy1wb25nKQogICAgICAgIGlmIChkaXN0WFogPiBlZmZlY3RpdmVCb3VuZGFyeSAtIHNvZnRCdWZmZXIpIHsKICAgICAgICAgICAgY29uc3QgcGVuZXRyYXRpb24gPSBkaXN0WFogLSAoZWZmZWN0aXZlQm91bmRhcnkgLSBzb2Z0QnVmZmVyKTsKICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBwZW5ldHJhdGlvbiAvIHNvZnRCdWZmZXIpKTsKCiAgICAgICAgICAgIF90ZW1wVmVjLnNldCgtcG9zLngsIDAsIC1wb3Mueik7CiAgICAgICAgICAgIGlmIChfdGVtcFZlYy5sZW5ndGhTcSgpID4gMC4wMDAxKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYy5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gcmF0aW8gKiByYXRpbyAqIChDLldBTExfU09GVF9GT1JDRSB8fCAwKSAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjLCBmb3JjZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEhhcmQgY2xhbXAgaWYgaXQgc3RpbGwgaGl0cwogICAgICAgIGlmIChkaXN0WFogPiBlZmZlY3RpdmVCb3VuZGFyeSkgewogICAgICAgICAgICBfdGVtcFZlYy5zZXQoLXBvcy54LCAwLCAtcG9zLnopOwogICAgICAgICAgICBpZiAoX3RlbXBWZWMubGVuZ3RoU3EoKSA+IDAuMDAwMSkgX3RlbXBWZWMubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBvdmVybGFwID0gZGlzdFhaIC0gZWZmZWN0aXZlQm91bmRhcnk7CiAgICAgICAgICAgIHBvcy5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMsIG92ZXJsYXApOwoKY29uc3QgdkRvdE4gPSB0aGlzLnZlbG9jaXR5LmRvdChfdGVtcFZlYyk7CgogICAgICAgICAgICAvLyBPbmx5IGFkanVzdCBpZiBtb3Zpbmcgb3V0d2FyZCAoYWdhaW5zdCBpbndhcmQgbm9ybWFsKQogICAgICAgICAgICBpZiAodkRvdE4gPCAwKSB7CiAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIEFyZW5hIERlZm9ybWF0aW9uIGlmIGltcGFjdCBpcyBmb3JjZWZ1bAogICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0U3BlZWQgPSBNYXRoLmFicyh2RG90Tik7CiAgICAgICAgICAgICAgICBpZiAoaW1wYWN0U3BlZWQgPiAxMC4wICYmIHdpbmRvdy5mbHV4LnRyaWdnZXJBcmVuYUltcGFjdCkgewogICAgICAgICAgICAgICAgICAgIC8vIFBhc3MgdGhlIGNvbnRhY3QgcG9pbnQgKHBvcykgYW5kIHN0cmVuZ3RoIGJhc2VkIG9uIHNwZWVkCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KHBvcywgTWF0aC5taW4oaW1wYWN0U3BlZWQgKiAwLjUsIDE1LjApKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBlID0gKEMuV0FMTF9FTEFTVElDSVRZICE9PSB1bmRlZmluZWQgPyBDLldBTExfRUxBU1RJQ0lUWSA6IDAuMyk7CiAgICAgICAgICAgICAgICBjb25zdCBpbXB1bHNlID0gX3RlbXBWZWMuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtdkRvdE4gKiAoMS4wICsgZSkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoaW1wdWxzZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRhbmdlbnRpYWwgZnJpY3Rpb24KICAgICAgICAgICAgICAgIGNvbnN0IGZyaWN0aW9uID0gKEMuV0FMTF9GUklDVElPTiAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX0ZSSUNUSU9OIDogMC45NSk7CiAgICAgICAgICAgICAgICBjb25zdCB0YW5nZW50ID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLnByb2plY3RPblBsYW5lKF90ZW1wVmVjKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc3ViKHRhbmdlbnQubXVsdGlwbHlTY2FsYXIoMS4wIC0gZnJpY3Rpb24pKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQ2VpbGluZy9GbG9vciBjbGFtcAogICAgICAgIGNvbnN0IGJoID0gKEMuQk9VTkRBUllfSEVJR0hUICE9PSB1bmRlZmluZWQgPyBDLkJPVU5EQVJZX0hFSUdIVCA6IDE1LjApOwogICAgICAgIGlmIChNYXRoLmFicyhwb3MueSkgPiBiaCkgewogICAgICAgICAgICBjb25zdCBzaWduID0gTWF0aC5zaWduKHBvcy55KSB8fCAxOwogICAgICAgICAgICBwb3MueSA9IGJoICogc2lnbjsKICAgICAgICAgICAgY29uc3QgZmUgPSAoQy5GTE9PUl9FTEFTVElDSVRZICE9PSB1bmRlZmluZWQgPyBDLkZMT09SX0VMQVNUSUNJVFkgOiAwLjQpOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLWZlOwp9CiAgICB9CgogICAgLy8gLS0tIDIpIEZYIHRoYXQgc2hvdWxkIHJ1biBvbmNlIHBlciBmcmFtZSAobm90IHBlciBzdWJzdGVwKSAtLS0KICAgIGlmICghdGhpcy5fZ2hvc3QpIHsKICAgICAgICBjb25zdCBzcGVlZFNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgIGlmIChzcGVlZFNxID4gMi4wICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5fYnViYmxlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgY29uc3QgcG0gPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKC0wLjgpOwoKICAgICAgICAgICAgICAgIC8vIFN0YW5kYXJkIGJ1YmJsZQovLyBTdGFuZGFyZCBidWJibGUKICAgICAgICAgICAgICAgIGNvbnN0IHN0ZFBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLmFkZChfYkRpci5zZXQoKE1hdGgucmFuZG9tKCktMC41KSowLjMsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4zLCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuMykpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3RkUG9zLnkgKz0gdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlJywgc3RkUG9zLCB7IHNjYWxlOiAwLjQgKyBNYXRoLnJhbmRvbSgpICogMC40IH0pOyAvLyBJbmNyZWFzZWQgc2NhbGUKCiAgICAgICAgICAgICAgICAvLyBNaWNybyBidWJibGVzIGF0IGhpZ2ggc3BlZWQKICAgICAgICAgICAgICAgIGlmIChzcGVlZFNxID4gNTAuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gTWF0aC5taW4oNCwgTWF0aC5mbG9vcihzcGVlZFNxIC8gNjApKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKY29uc3Qgaml0dGVyID0gX2JEaXIuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC40LCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuNCwgKE1hdGgucmFuZG9tKCktMC41KSowLjQpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGF3blBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLmFkZChqaXR0ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWZvcm1Ob2RlKSBzcGF3blBvcy55ICs9IHRoaXMuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlX21pY3JvJywgc3Bhd25Qb3MsIHsgc2NhbGU6IDAuMDUgKyBNYXRoLnJhbmRvbSgpICogMC4xIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDAuMDI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gMC41KSB7CmNvbnN0IGppdHRlciA9IF9iRGlyLnNldCgoTWF0aC5yYW5kb20oKS0wLjUpKjAuMiwgKE1hdGgucmFuZG9tKCktMC41KSowLjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3Bhd25Qb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQob2Zmc2V0KS5hZGQoaml0dGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3Bhd25Qb3MueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIHNwYXduUG9zLCB7IHNjYWxlOiAwLjA0ICsgTWF0aC5yYW5kb20oKSAqIDAuMDYgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4wNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLyAtLS0gMykgVmlzdWFsIHJvdGF0aW9uIC0tLQogICAgY29uc3Qgc3BpblNwZWVkID0gdGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCk7CiAgICBpZiAoc3BpblNwZWVkID4gMC41KSB7CiAgICAgICAgY29uc3QgYXhpcyA9IF90ZW1wVmVjLmNvcHkodGhpcy5hbmd1bGFyVmVsb2NpdHkpLm5vcm1hbGl6ZSgpOwogICAgICAgIGNvbnN0IHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUoYXhpcywgc3BpblNwZWVkICogZHQpOwogICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5wcmVtdWx0aXBseShxKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgIGlmIChzcGVlZCA+IDAuMSkgewogICAgICAgICAgICBfdGVtcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLmNyb3NzKF9heGlzWSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGlmIChfdGVtcFZlYy5sZW5ndGhTcSgpID4gMC4wMSkgewogICAgICAgICAgICAgICAgY29uc3QgcSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShfdGVtcFZlYywgc3BlZWQgKiBkdCk7CiAgICAgICAgICAgICAgICB0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24ucHJlbXVsdGlwbHkocSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCmdyYWIocGxheWVyKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50OiBQb3NzZXNzaW9uIChpZiB0YWtpbmcgZnJvbSBmcmVlIHN0YXRlKQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCgiUE9TU0VTU0lPTiIsICJub3JtYWwiKTsKICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIFR1cm5vdmVyIChQb3NzZXNzaW9uIENoYW5nZSkKICAgICAgICAgICAgY29uc3QgcHJldmlvdXNUZWFtID0gdGhpcy5ob2xkZXIgPyB0aGlzLmhvbGRlci50ZWFtIDogKHRoaXMubGFzdEhvbGRlciA/IHRoaXMubGFzdEhvbGRlci50ZWFtIDogbnVsbCk7CiAgICAgICAgICAgIGlmIChwcmV2aW91c1RlYW0gJiYgcHJldmlvdXNUZWFtICE9PSBwbGF5ZXIudGVhbSkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJUVVJOT1ZFUiIsIHBsYXllci5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgc29tZW9uZSBlbHNlIGhlbGQgaXQsIHRoZXkgbG9zZSBpdAogICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIgIT09IHBsYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIubG9zZUJhbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBwbGF5ZXI7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaGVsZCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOT1RFOiBXZSBkbyBOT1QgcGFyZW50IHRoZSBtZXNoIHRvIHRoZSBwbGF5ZXIgYW55bW9yZS4KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyB0aGUgYmFsbCBmcm9tIGZseWluZyBhcm91bmQgZHVlIHRvIHN3aW0gYW5pbWF0aW9ucy4KICAgICAgICAgICAgLy8gSW5zdGVhZCwgd2UgdXBkYXRlIGl0cyBwb3NpdGlvbiBtYW51YWxseSBpbiB1cGRhdGVIZWxkKCkuCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3RpZnkgcGxheWVyCiAgICAgICAgICAgIGlmIChwbGF5ZXIucmVjZWl2ZUJhbGwpIHsKICAgICAgICAgICAgICAgIHBsYXllci5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zb2xlLmxvZygiQmFsbCBncmFiYmVkIGJ5ICIgKyBwbGF5ZXIucm9sZSk7CiAgICAgICAgfQoKICAgICAgICBkcm9wKCkgewogICAgICAgICAgICB0aGlzLnJldmVhbCgpOyAvLyBFbnN1cmUgdmlzaWJsZQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm8gbmVlZCB0byBkZXRhY2ggZnJvbSBzY2VuZSBncmFwaCBzaW5jZSB3ZSBhcmVuJ3QgcGFyZW50aW5nIHRvIHBsYXllciBhbnltb3JlLgogICAgICAgICAgICAvLyBKdXN0IGNsZWFyIGhvbGRlci4KCiAgICAgICAgICAgIGlmICh0aGlzLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmxvc2VCYWxsKSB0aGlzLmhvbGRlci5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIH0KLy8gU2hvb3QvUGFzcwovLyBTaG9vdC9QYXNzCiAgICAgICAgc2hvb3QoZGlyZWN0aW9uVmVjdG9yLCBmb3JjZSwgdHlwZSA9ICdTSCcsIHRlY2huaXF1ZSA9IG51bGwsIHNwaW5WZWN0b3IgPSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMubGFzdEhvbGRlciA9IHRoaXMuaG9sZGVyOyAvLyBSZWNvcmQgZm9yIEVYUCBhdHRyaWJ1dGlvbgogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVtYmxlIERldGVjdGlvbiAoVHlwZSAnbm9uZScgaXMgdXNlZCBieSBQbGF5ZXIuZnVtYmxlKQogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ25vbmUnKSB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNob3dBbm5vdW5jZW1lbnQoIkZVTUJMRSEiLCAic2xhbSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmRyb3AoKTsgLy8gRGV0YWNoIGZpcnN0CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXQgR3JhY2UgUGVyaW9kIHRvIHByZXZlbnQgaW5zdGFudCBpbnRlcmNlcHRpb25zL2NhdGNoZXMKICAgICAgICAgICAgLy8gMC4ycyBhbGxvd3MgYmFsbCB0byBjbGVhciB0aGUgdGhyb3dlcidzIGltbWVkaWF0ZSB2aWNpbml0eQogICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwLjI7CgogICAgICAgICAgICAvLyBQaHlzaWNhbCBWZWxvY2l0eSAoVmlzdWFsIHNwZWVkKQovLyBQaHlzaWNhbCBWZWxvY2l0eSAoVmlzdWFsIHNwZWVkKQogICAgICAgICAgICAvLyBXZSBtYXAgZm9yY2UgKHN0YXQpIHRvIHBoeXNpY2FsIHNwZWVkLCBidXQgY2xhbXAgaXQgcmVhc29uYWJsZQogICAgICAgICAgICAvLyBJbmNyZWFzZWQgY2FwIHRvIDQwLjAgdG8gYWxsb3cgZm9yIHN0cm9uZyBwYXNzZXMgYW5kIGNsZWFycwovLyBJbmNyZWFzZWQgY2FwIHRvIDg1LjAgdG8gYWxsb3cgZm9yIHN0cm9uZyBwYXNzZXMgYW5kIGNsZWFycyBhbmQgIk1heCBQb3dlciIgZmVlbApjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAoQy5MQVVOQ0hfU1BFRURfU0NBTEUgIT09IHVuZGVmaW5lZCA/IEMuTEFVTkNIX1NQRUVEX1NDQUxFIDogMS4wKTsKICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTEFVTkNIX1NQRUVEX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5MQVVOQ0hfU1BFRURfQ0FQIDogODUuMCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5taW4oZm9yY2UgKiBzY2FsZSwgY2FwKTsKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5jb3B5KGRpcmVjdGlvblZlY3Rvcikubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgU3BpbiBpZiBwcm92aWRlZAogICAgICAgICAgICBpZiAoc3BpblZlY3RvcikgewogICAgICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuY29weShzcGluVmVjdG9yKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhdCBQb3dlciAoR2FtZSBMb2dpYykKICAgICAgICAgICAgdGhpcy5wb3dlciA9IGZvcmNlOwogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9IHR5cGU7CiAgICAgICAgICAgIHRoaXMudGVjaG5pcXVlID0gdGVjaG5pcXVlOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBUcmFpbCBDb2xvcgogICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgewogICAgICAgICAgICAgICAgbGV0IGNvbG9yID0gMHgwMGFhZmY7IC8vIERlZmF1bHQgQmx1ZSAoUGFzcykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ3Zlbm9tJykgY29sb3IgPSAweGFhMDBmZjsgLy8gUHVycGxlCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICd3aXRoZXInKSBjb2xvciA9IDB4ODg4ODg4OyAvLyBHcmV5CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICduYXAnKSBjb2xvciA9IDB4MDAwMDg4OyAvLyBEYXJrIEJsdWUKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ3NwaGVyZScpIGNvbG9yID0gMHgwMGZmZmY7IC8vIEN5YW4KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ2plY2h0JykgY29sb3IgPSAweGZmMDAwMDsgLy8gUmVkCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICBjb2xvciA9IDB4ZmY0NDAwOyAvLyBPcmFuZ2UvUmVkCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwuc2V0Q29sb3IoY29sb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIYW5kbGUgSW52aXNpYmxlIFNob3QKICAgICAgICAgICAgaWYgKHRlY2huaXF1ZSAmJiB0ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgdGhpcy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJJbnZpc2libGUgU2hvdCEiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc29sZS5sb2coYEJhbGwgJHt0eXBlfSB3aXRoIFBvd2VyOiAke3RoaXMucG93ZXIudG9GaXhlZCgxKX0gU3BpbjogJHt0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGgoKS50b0ZpeGVkKDEpfWApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrIGZvciBDdXJ2ZQogICAgICAgICAgICBpZiAodGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkgPiAxNS4wICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldmVhbCgpIHsKCiAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXMubWVzaCkgdGhpcy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgICAKcmVzZXQoKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7CiAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwOwogICAgICAgICAgICB0aGlzLnBvd2VyID0gMDsKICAgICAgICB9CmlzQ2F0Y2hhYmxlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jYXRjaEdyYWNlUGVyaW9kIDw9IDA7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWxzKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5kZWZvcm1Ob2RlIHx8ICF0aGlzLnNwaW5Ob2RlKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBTcXVhc2ggJiBTdHJldGNoIGJhc2VkIG9uIHZlbG9jaXR5Ci8vIDEuIFNxdWFzaCAmIFN0cmV0Y2ggYmFzZWQgb24gdmVsb2NpdHkKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT25seSBhcHBseSBzdHJldGNoIGlmIG1vdmluZyBmYXN0IGVub3VnaAogICAgICAgICAgICBpZiAoc3BlZWQgPiAxLjAgJiYgdGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAvLyBPcmllbnQgZGVmb3JtTm9kZSB0byB2ZWxvY2l0eSBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgZm9yd2FyZCBpcyBaICgwLDAsMSkKICAgICAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLnNldEZyb21Vbml0VmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLDAsMSksIGRpcik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBzdHJldGNoIGZhY3RvcgogICAgICAgICAgICAgICAgLy8gTWF4IHN0cmV0Y2ggYXQgc3BlZWQgNDAgKGFwcHJveCBtYXggc2hvdCBwb3dlcikKICAgICAgICAgICAgICAgIGNvbnN0IGZhY3RvciA9IE1hdGgubWluKHNwZWVkIC8gNDAuMCwgMS4wKTsgCiAgICAgICAgICAgICAgICBjb25zdCBzdHJldGNoID0gMS4wICsgKGZhY3RvciAqIDAuOCk7IC8vIEluY3JlYXNlZCBzdHJldGNoIG1heCB0byAxLjh4CiAgICAgICAgICAgICAgICBjb25zdCBzcXVhc2ggPSAxLjAgLyBNYXRoLnNxcnQoc3RyZXRjaCk7IC8vIE1haW50YWluIHZvbHVtZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUuc2NhbGUuc2V0KHNxdWFzaCwgc3F1YXNoLCBzdHJldGNoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFJlc2V0IGRlZm9ybWF0aW9uCiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUucXVhdGVybmlvbi5pZGVudGl0eSgpOwogICAgICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnNjYWxlLnNldCgxLCAxLCAxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gQXBwbHkgQWNjdW11bGF0ZWQgU3BpbgogICAgICAgICAgICAvLyBTaW5jZSBkZWZvcm1Ob2RlIG1pZ2h0IGJlIHJvdGF0ZWQsIHdlIG5lZWQgdG8gYXBwbHkgc3BpbiBpbiB0aGUgY29ycmVjdCBzcGFjZS4KICAgICAgICAgICAgLy8gc3Bpbk5vZGUgcm90YXRpb24gPSBkZWZvcm1Ob2RlX2ludmVyc2UgKiBhY2N1bXVsYXRlZFJvdGF0aW9uCmNvbnN0IGludkRlZm9ybSA9IHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLmNsb25lKCkuaW52ZXJ0KCk7CiAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucXVhdGVybmlvbi5jb3B5KGludkRlZm9ybS5tdWx0aXBseSh0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24pKTsKICAgICAgICB9CiAgICB9Cgp3aW5kb3cuZmx1eC5CYWxsID0gQmFsbDsKICAgIHdpbmRvdy5mbHV4LlRyYWlsUmVuZGVyZXIgPSBUcmFpbFJlbmRlcmVyOwp9KSgpOw==","GameManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFNwYXJrIFRleHR1cmUgKFByb2NlZHVyYWwgQnVyc3QpCiAgICBjb25zdCBfc3BhcmtUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw2NCw2NCk7CiAgICAgICAgCiAgICAgICAgLy8gQnVyc3Qgc2hhcGUKICAgICAgICBjb25zdCBjeCA9IDMyLCBjeSA9IDMyOwogICAgICAgIGNvbnN0IHNwaWtlcyA9IDg7CiAgICAgICAgY29uc3Qgb3V0ZXIgPSAzMDsKICAgICAgICBjb25zdCBpbm5lciA9IDEwOwogICAgICAgIAogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBmb3IobGV0IGk9MDsgaTxzcGlrZXMqMjsgaSsrKXsKICAgICAgICAgICAgY29uc3QgciA9IChpJTI9PT0wKT8gb3V0ZXIgOiBpbm5lcjsKICAgICAgICAgICAgY29uc3QgYSA9IChNYXRoLlBJKmkpL3NwaWtlczsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKnIsIGN5ICsgTWF0aC5zaW4oYSkqcik7CiAgICAgICAgfQogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmNjMDAnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgLy8gV2hpdGUgQ29yZQogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHguYXJjKGN4LCBjeSwgOCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjb25zdCBfc3BhcmtNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IAogICAgICAgIG1hcDogX3NwYXJrVGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBHYW1lTWFuYWdlciB7CgogICAgICAgIApjb25zdHJ1Y3RvcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEsIHJlbmRlcmVyKSB7CndpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIgPSByZW5kZXJlcjsgLy8gU3RvcmUgcmVuZGVyZXIKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmNhbWVyYSA9IGNhbWVyYTsKICAgICAgICAgICAgdGhpcy51aUxheWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodWlMYXllcklkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc2NvcmUgPSB7IGhvbWU6IDAsIGF3YXk6IDAgfTsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5oYWxmID0gMTsKICAgICAgICAgICAgdGhpcy5oYWxmRHVyYXRpb24gPSAzMDA7IC8vIDUgbWludXRlcyAoc2Vjb25kcykKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNEZW1vTW9kZSA9IGZhbHNlOwp0aGlzLmdhbWVNb2RlID0gJ25vcm1hbCc7IC8vICdub3JtYWwnIG9yICdwcmFjdGljZScKICAgICAgICAgICAgdGhpcy5pc0ZvcmdlTW9kZSA9IGZhbHNlOyAvLyBBc3NldCBGb3JnZSBTdGF0ZQogICAgICAgICAgICAvLyBJbXBhY3QgRnJhbWVzCiAgICAgICAgICAgIHRoaXMuaW1wYWN0UGF1c2UgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsgLy8gU3RhcnQgaW4gbWVudQp0aGlzLnRlYW1zID0gewogICAgICAgICAgICAgICAgaG9tZTogbnVsbCwKICAgICAgICAgICAgICAgIGF3YXk6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZW50aXRpZXMgPSB7CiAgICAgICAgICAgICAgICBiYWxsOiBudWxsCiAgICAgICAgICAgIH07Cgp0aGlzLnVpID0gewogICAgICAgICAgICAgICAgc2NvcmVQbGF5ZXI6IG51bGwsCiAgICAgICAgICAgICAgICBzY29yZUNwdTogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWVyOiBudWxsLAogICAgICAgICAgICAgICAgaGFsZjogbnVsbCwKICAgICAgICAgICAgICAgIGFubm91bmNlbWVudDogbnVsbCwKICAgICAgICAgICAgICAgIC8vIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgICAgIHN0YXR1c1BhbmVsOiB7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyOiBudWxsLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBCYXI6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBUZXh0OiBudWxsLAogICAgICAgICAgICAgICAgICAgIGV4cEJhcjogbnVsbAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVGVjaGNvcHkgU3RhdGUKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHRpbWVyOiAwLAogICAgICAgICAgICAgICAgdGVjaDogbnVsbCwKICAgICAgICAgICAgICAgIGxlYXJuZXJzOiBbXQogICAgICAgICAgICB9OwoKdGhpcy5taW5pTWFwID0gbmV3IHdpbmRvdy5mbHV4Lk1pbmlNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgRmxvYXRpbmcgVGV4dAovLyBJbml0aWFsaXplIEZsb2F0aW5nIFRleHQKdGhpcy5mbG9hdGluZ1RleHQgPSBuZXcgd2luZG93LmZsdXguRmxvYXRpbmdUZXh0TWFuYWdlcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBVSSBjYWxjdWxhdGlvbnMKICAgICAgICAgICAgdGhpcy5fdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIFBhcnRpY2xlIE1hbmFnZXIgKFN0YXR1cyBFZmZlY3RzKQogICAgICAgICAgICAKLy8gSW5pdGlhbGl6ZSBQYXJ0aWNsZSBNYW5hZ2VyIChTdGF0dXMgRWZmZWN0cykKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyKHNjZW5lKTsKdGhpcy5nbHlwaE1hbmFnZXIgPSBudWxsOyAvLyBJbmplY3RlZCBieSBtYWluLmpzCiAgICAgICAgICAgIHRoaXMuX2luaXRQYXJ0aWNsZXMoKTsgLy8gM0QgU3BhcmsgU3lzdGVtIChMZWdhY3kvSW1wYWN0KQoKdGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIgPSBuZXcgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyKHNjZW5lKTsKICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyKHRoaXMpOyAvLyBJbml0aWFsaXplIFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgdGhpcy5faW5qZWN0U3R5bGVzKCk7CnRoaXMuX2luaXRVSSgpOwogICAgICAgIH0KCl9pbml0Q2luZW1hdGljcygpIHsKICAgICAgICAgICAgdGhpcy5tZW51U2hvdEluZGV4ID0gMDsKICAgICAgICAgICAgdGhpcy5tZW51U2hvdFRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5tZW51U2hvdHMgPSBbCiAgICAgICAgICAgICAgICAvLyAxLiAiVGhlIEFyZW5hIiAtIFdpZGUgRXN0YWJsaXNoaW5nIFNob3QgKFNsb3cgZG9sbHkgaW4pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDEwLjAsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoNjAsIDM1LCA2MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAyID0gbmV3IFRIUkVFLlZlY3RvcjMoNDAsIDI1LCA0MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNtb290aHN0ZXAgaW50ZXJwb2xhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdCA9IHQgKiB0ICogKDMgLSAyICogdCk7IAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCBzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIDIuICJUaGUgVGVhbSIgLSBUcmFja2luZyBTaG90IGFsb25nIHRoZSBmb3JtYXRpb24KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogOC4wLAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBNb3ZlIGFsb25nIHRoZSBzaWRlIG9mIHRoZSBob21lIHRlYW0gZm9ybWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHpTdGFydCA9IC0yNTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgekVuZCA9IDI1OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50WiA9IHpTdGFydCArICh6RW5kIC0gelN0YXJ0KSAqIHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24uc2V0KC0yNSwgNiwgY3VycmVudFopOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KDAsIDIsIGN1cnJlbnRaICogMC44KTsgLy8gTG9vayBzbGlnaHRseSBhaGVhZCBvZiBjZW50ZXIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gMy4gIlRoZSBTdHJpa2VyIiAtIENsb3NlIHVwIG9yYml0IG9uIGEga2V5IHBvc2l0aW9uCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDguMCwKICAgICAgICAgICAgICAgICAgICB1cGRhdGU6ICh0LCBjYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9jdXMgb24gd2hlcmUgdGhlIExGL1JGIHVzdWFsbHkgc3RhbmRzIChhcHByb3ggKy8tIDEwLCAtMTApCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IG5ldyBUSFJFRS5WZWN0b3IzKC0xMCwgMCwgLTEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSB0ICogMS4wICsgMy41OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gMTAuMDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5wb3NpdGlvbi5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQueCArIE1hdGguY29zKGFuZ2xlKSAqIGRpc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQueSArIDQuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC56ICsgTWF0aC5zaW4oYW5nbGUpICogZGlzdAogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KHRhcmdldC54LCB0YXJnZXQueSArIDEuNSwgdGFyZ2V0LnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyA0LiAiVGhlIEdvYWwiIC0gTG93IEFuZ2xlIGxvb2tpbmcgdXAgYXQgdGhlIG5ldAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiA3LjAsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgLTUsIDMyKTsgLy8gTG93IG5lYXIgZ29hbAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwMiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDgsIDIwKTsgIC8vIFJpc2luZyB1cAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdCgwLCAxNSwgNDUpOyAvLyBMb29rIHVwIGF0IHRoZSBzdHJ1Y3R1cmUKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnJvdGF0aW9uLnogPSAodCAtIDAuNSkgKiAwLjE1OyAvLyBTbGlnaHQgY2luZW1hdGljIHRpbHQKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gNS4gIlRoZSBEaXZlIiAtIFZlcnRpY2FsIGRyb3AgaW50byB0aGUgcG9vbAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiA4LjAsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgNTAsIDApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwMiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEwLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3QgPSB0ICogdCAqICgzIC0gMiAqIHQpOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCBzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5yb3RhdGlvbi56ID0gdCAqIDAuODsgLy8gU3BpcmFsIGRvd24KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9Cl07CiAgICAgICAgfQoKICAgICAgICBfaW5qZWN0U3R5bGVzKCkgewogICAgICAgICAgICBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZsdXgtZHluYW1pYy1zdHlsZXMnKSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgICAgICAgICAgIHN0eWxlLmlkID0gJ2ZsdXgtZHluYW1pYy1zdHlsZXMnOwpzdHlsZS50ZXh0Q29udGVudCA9IGAKICAgICAgICAgICAgICAgIEBrZXlmcmFtZXMgdGV4dFNsYW0gewogICAgICAgICAgICAgICAgICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoNCk7IG9wYWNpdHk6IDA7IGxldHRlci1zcGFjaW5nOiA1MHB4OyB9CiAgICAgICAgICAgICAgICAgICAgMTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IG9wYWNpdHk6IDE7IGxldHRlci1zcGFjaW5nOiA1cHg7IH0KICAgICAgICAgICAgICAgICAgICAxNSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjEpOyB9CiAgICAgICAgICAgICAgICAgICAgMjAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IH0KICAgICAgICAgICAgICAgICAgICA4MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxKTsgb3BhY2l0eTogMTsgZmlsdGVyOiBibHVyKDBweCk7IH0KICAgICAgICAgICAgICAgICAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS41KTsgb3BhY2l0eTogMDsgZmlsdGVyOiBibHVyKDEwcHgpOyB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC5hbm5vdW5jZW1lbnQtc2xhbSB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICAgICAgICAgIHRvcDogNDUlOyBsZWZ0OiA1MCU7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDEwMCU7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnSW1wYWN0Jywgc2Fucy1zZXJpZjsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDk2cHg7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgICAgICAgICAgICAgICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZmZmZiAwJSwgI2ZmZGQwMCA0NSUsICNmZjg4MDAgMTAwJSk7CiAgICAgICAgICAgICAgICAgICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAgICAgICAgICAgICAgICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgICAgICAgICAgICAgICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggcmdiYSgwLDAsMCwxKSkgZHJvcC1zaGFkb3coMCAwIDMwcHggcmdiYSgyNTUsIDEwMCwgMCwgMC42KSk7CiAgICAgICAgICAgICAgICAgICAgei1pbmRleDogMjAwMDsKICAgICAgICAgICAgICAgICAgICBhbmltYXRpb246IHRleHRTbGFtIDEuOHMgY3ViaWMtYmV6aWVyKDAuMSwgMC44LCAwLjEsIDEpIGZvcndhcmRzOwogICAgICAgICAgICAgICAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICAgICAgICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLm1vZGFsLW92ZXJsYXkgewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgY2VudGVyLCByZ2JhKDEwLCAyNSwgNjAsIDAuOTUpIDAlLCByZ2JhKDAsIDAsIDAsIDAuOTgpIDEwMCUpOwogICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7IGp1c3RpZnktY29udGVudDogY2VudGVyOyBhbGlnbi1pdGVtczogY2VudGVyOyBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDE5MDA7CiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMDsgcG9pbnRlci1ldmVudHM6IG5vbmU7IHRyYW5zaXRpb246IG9wYWNpdHkgMC44czsKICAgICAgICAgICAgICAgICAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoOHB4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5tb2RhbC1vdmVybGF5LmFjdGl2ZSB7IG9wYWNpdHk6IDE7IHBvaW50ZXItZXZlbnRzOiBhdXRvOyB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC5tb2RhbC10aXRsZSB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdHYXJhbW9uZCcsIHNlcmlmOwogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogNTJweDsgY29sb3I6ICNmZmY7CiAgICAgICAgICAgICAgICAgICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwYWFmZiwgMCAwIDQwcHggIzAwNDRhYTsKICAgICAgICAgICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAzMHB4OwogICAgICAgICAgICAgICAgICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCAjMDBhYWZmOwogICAgICAgICAgICAgICAgICAgIHBhZGRpbmctYm90dG9tOiAxMHB4OwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiA4MCU7IHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgICAgICAgICBsZXR0ZXItc3BhY2luZzogNXB4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAubW9kYWwtc2NvcmUtY29udGFpbmVyIHsKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBnYXA6IDQwcHg7CiAgICAgICAgICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogNDBweDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5tb2RhbC1zY29yZSB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdJbXBhY3QnLCBzYW5zLXNlcmlmOwogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogODBweDsgY29sb3I6ICNmZmQ3MDA7CiAgICAgICAgICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggI2I4ODYwYjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5tb2RhbC12cyB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdDb3VyaWVyIE5ldycsIG1vbm9zcGFjZTsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDI0cHg7IGNvbG9yOiAjMDBhYWZmOyBvcGFjaXR5OiAwLjc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLmZsYXNoLW92ZXJsYXkgewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDIxMDA7CiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMDsgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjFzIGVhc2Utb3V0OwogICAgICAgICAgICAgICAgICAgIG1peC1ibGVuZC1tb2RlOiBvdmVybGF5OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIEBrZXlmcmFtZXMgY2xhc2hQb3AgewogICAgICAgICAgICAgICAgICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMC41KTsgb3BhY2l0eTogMTsgfQogICAgICAgICAgICAgICAgICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuNSk7IG9wYWNpdHk6IDAuODsgfQogICAgICAgICAgICAgICAgICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgyLjApOyBvcGFjaXR5OiAwOyB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLmNsYXNoLXNwYXJrIHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDYwcHg7IGhlaWdodDogNjBweDsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAjZmZmZmZmIDAlLCAjZmZmZjAwIDQwJSwgdHJhbnNwYXJlbnQgNzAlKTsKICAgICAgICAgICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgICAgICAgICAgICAgICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgICAgICAgICAgICAgei1pbmRleDogMTUwMDsKICAgICAgICAgICAgICAgICAgICBtaXgtYmxlbmQtbW9kZTogc2NyZWVuOwogICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbjogY2xhc2hQb3AgMC4zcyBlYXNlLW91dCBmb3J3YXJkczsKICAgICAgICAgICAgICAgICAgICBib3gtc2hhZG93OiAwIDAgMjBweCAjZmZhYTAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwogICAgICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHN0eWxlKTsKICAgICAgICB9CgogICAgICAgIHJlZ2lzdGVyVGVhbXMoaG9tZVRlYW0sIGF3YXlUZWFtLCBiYWxsKSB7CiAgICAgICAgICAgIHRoaXMudGVhbXMuaG9tZSA9IGhvbWVUZWFtOwogICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkgPSBhd2F5VGVhbTsKdGhpcy5lbnRpdGllcy5iYWxsID0gYmFsbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgTWluaU1hcAogICAgICAgICAgICBpZiAodGhpcy5taW5pTWFwKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1pbmlNYXAuaW5pdChob21lVGVhbSwgYXdheVRlYW0sIGJhbGwpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2luaXRVSSgpIHsKICAgICAgICAgICAgLy8gQmluZCB0byBleGlzdGluZyBIVE1MIGVsZW1lbnRzCiAgICAgICAgICAgIHRoaXMudWkuc2NvcmVQbGF5ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NvcmUtcGxheWVyJyk7CiAgICAgICAgICAgIHRoaXMudWkuc2NvcmVDcHUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NvcmUtY3B1Jyk7CiAgICAgICAgICAgIHRoaXMudWkudGltZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGltZXItZGlzcGxheScpOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGFsZi1pbmRpY2F0b3InKTsKICAgICAgICAgICAgdGhpcy51aS5hbm5vdW5jZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYW5ub3VuY2VtZW50Jyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZWNoLWZsYXNoLW92ZXJsYXknKTsKICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaEZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hTdWIgPSB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC1zdWItdGV4dCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50ZWNoLXRpbWVyLWZpbGwnKTsKdGhpcy51aS50ZWNoVGltZXJGaWxsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnRlY2gtdGltZXItZmlsbCcpOwoKICAgICAgICAgICAgLy8gQmluZCBQbGF5ZXIgU3RhdHVzIFBhbmVsCiAgICAgICAgICAgIC8vIEJpbmQgUGxheWVyIFN0YXR1cyBQYW5lbAogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJyk7CiAgICAgICAgICAgIHRoaXMudWkuc3RhdHVzUGFuZWwubmFtZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC5jaGFyLW5hbWUnKTsKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5ocEJhciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC5ocC1iYXItZmlsbCcpOwogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmhwVGV4dCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC5ocC12YWx1ZScpOwogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmV4cEJhciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC50ZWNoLWJhci1maWxsJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDcmVhdGUgTW9kYWwgT3ZlcmxheQogICAgICAgICAgICB0aGlzLnVpLm1vZGFsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwuY2xhc3NOYW1lID0gJ21vZGFsLW92ZXJsYXknOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmlubmVySFRNTCA9IGAKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXRpdGxlIj5IQUxGIFRJTUU8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXNjb3JlLWNvbnRhaW5lciI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtc2NvcmUiIGlkPSJtb2RhbC1zY29yZS1ob21lIj4wPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtdnMiPi08L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC1zY29yZSIgaWQ9Im1vZGFsLXNjb3JlLWF3YXkiPjA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBpZD0ibW9kYWwtbXNnIiBzdHlsZT0iY29sb3I6ICMwMGFhZmY7IGZvbnQtc2l6ZTogMTRweDsgbGV0dGVyLXNwYWNpbmc6IDJweDsiPlBSRVBBUklORyAyTkQgSEFMRi4uLjwvZGl2PgogICAgICAgICAgICBgOwogICAgICAgICAgICB0aGlzLnVpTGF5ZXIuYXBwZW5kQ2hpbGQodGhpcy51aS5tb2RhbCk7CgogICAgICAgICAgICAvLyBDcmVhdGUgRmxhc2ggT3ZlcmxheQogICAgICAgICAgICB0aGlzLnVpLmZsYXNoID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHRoaXMudWkuZmxhc2guY2xhc3NOYW1lID0gJ2ZsYXNoLW92ZXJsYXknOwogICAgICAgICAgICB0aGlzLnVpTGF5ZXIuYXBwZW5kQ2hpbGQodGhpcy51aS5mbGFzaCk7CgogICAgICAgICAgICAvLyBJbml0aWFsIFN0YXRlCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoKTsKICAgICAgICAgICAgaWYgKHRoaXMudWkudGltZXIpIHRoaXMudWkudGltZXIuaW5uZXJUZXh0ID0gIjAwOjAwIjsKICAgICAgICB9CiAgICAgICAgX3VwZGF0ZVNjb3JlVUkoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnNjb3JlUGxheWVyKSB0aGlzLnVpLnNjb3JlUGxheWVyLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuaG9tZTsKICAgICAgICAgICAgaWYgKHRoaXMudWkuc2NvcmVDcHUpIHRoaXMudWkuc2NvcmVDcHUuaW5uZXJUZXh0ID0gdGhpcy5zY29yZS5hd2F5OwogICAgICAgIH0KCnVwZGF0ZVByYWN0aWNlKGR0KSB7CiAgICAgICAgICAgIC8vIERlbGVnYXRlIGxvZ2ljIHRvIFByYWN0aWNlTWFuYWdlcgogICAgICAgICAgICBpZiAodGhpcy5wcmFjdGljZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewoKaWYgKHRoaXMuc3RhdGUgPT09ICdtZW51JykgewogICAgICAgICAgICAgICAgLy8gLS0tIFBPUFVMQVRFIEFSRU5BIEZPUiBCLVJPTEwgLS0tCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgcGxheWVycyBhcmUgdmlzaWJsZSBhbmQgYW5pbWF0ZWQKICAgICAgICAgICAgICAgIGNvbnN0IGFuaW1hdGVUZWFtID0gKHRlYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRlYW0pIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB0ZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gR2VudGxlIGJvYmJpbmcgdG8gc2ltdWxhdGUgdHJlYWRpbmcgd2F0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi55ID0gcC5ob21lUG9zaXRpb24ueSArIE1hdGguc2luKERhdGUubm93KCkgKiAwLjAwMiArIHAubWVzaC5pZCkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgaWRsZSBhbmltYXRpb24gaXMgcGxheWluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAuc3RhdGUgIT09ICdpZGxlJykgcC5wbGF5KCdpZGxlJywgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLm1peGVyKSBwLm1peGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBhbmltYXRlVGVhbSh0aGlzLnRlYW1zLmhvbWUpOwogICAgICAgICAgICAgICAgYW5pbWF0ZVRlYW0odGhpcy50ZWFtcy5hd2F5KTsKCiAgICAgICAgICAgICAgICAvLyAtLS0gQ0lORU1BVElDIEItUk9MTCAtLS0KICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lbnVTaG90cyAmJiB0aGlzLm1lbnVTaG90cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hvdCA9IHRoaXMubWVudVNob3RzW3RoaXMubWVudVNob3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U2hvdFRpbWVyICs9IGR0OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lbnVTaG90VGltZXIgPj0gc2hvdC5kdXJhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lbnVTaG90VGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lbnVTaG90SW5kZXggPSAodGhpcy5tZW51U2hvdEluZGV4ICsgMSkgJSB0aGlzLm1lbnVTaG90cy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSB0aW1lICgwIHRvIDEpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMubWVudVNob3RUaW1lciAvIHNob3QuZHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3QudXBkYXRlKHQsIHRoaXMuY2FtZXJhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW1iaWVudCBGWCBpbiBNZW51CiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIgJiYgTWF0aC5yYW5kb20oKSA8IDAuMikgewogICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIHJhbmRvbSBidWJibGVzIGZvciBhdG1vc3BoZXJlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFuZ2UgPSA2MDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSpyYW5nZSwgCiAgICAgICAgICAgICAgICAgICAgICAgIC0xMCArIE1hdGgucmFuZG9tKCkqMjAsIAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKnJhbmdlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgcG9zLCB7IGxpZmU6IDMuMCArIE1hdGgucmFuZG9tKCkqMi4wLCBzY2FsZTogMC4zICsgTWF0aC5yYW5kb20oKSowLjQgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVXBkYXRlIEJhY2tncm91bmQgU3lzdGVtcwogICAgICAgICAgICAgICAgaWYgKHRoaXMud2F0ZXJPdmVybGF5KSB0aGlzLndhdGVyT3ZlcmxheS51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubGlnaHRTaGFmdHMpIHRoaXMubGlnaHRTaGFmdHMudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB0aGlzLnBhcnRpY2xlTWFuYWdlci51cGRhdGUoZHQpOwoKICAgICAgICAgICAgICAgIC8vIFJlbmRlcgogICAgICAgICAgICAgICAgaWYgKHRoaXMucmVuZGVyZXIgJiYgdGhpcy5zY2VuZSAmJiB0aGlzLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIucmVuZGVyKHRoaXMuc2NlbmUsIHRoaXMuY2FtZXJhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdhY3RpdmUnKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lTW9kZSA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlUHJhY3RpY2UoZHQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRpbWUgKz0gZHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVGltZXIoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jaGVja0hhbGZUaW1lKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tHb2FscygpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5taW5pTWFwKSB0aGlzLm1pbmlNYXAudXBkYXRlKCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5mbG9hdGluZ1RleHQpIHRoaXMuZmxvYXRpbmdUZXh0LnVwZGF0ZShkdCk7CmlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgdGhpcy5wYXJ0aWNsZU1hbmFnZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIC8vIEdseXBoTWFuYWdlciB1cGRhdGVkIGJ5IG1haW4uanMKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXBkYXRlIFRlY2hjb3B5IFdpbmRvdwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIFVJIEJhcgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hUaW1lckZpbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGN0ID0gTWF0aC5tYXgoMCwgKHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciAvIHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lKSAqIDEwMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9IGAke3BjdH0lYDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbG9yIHNoaWZ0IGJhc2VkIG9uIHVyZ2VuY3kKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBjdCA8IDMwKSB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICcjZmYwMDAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZmZmZmYsICMwMGZmZmYpJzsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZFRlY2hDb3B5V2luZG93KGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBhcnRpY2xlcyhkdCk7CnRoaXMuX3VwZGF0ZVBhcnRpY2xlcyhkdCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIpIHRoaXMuZGVidWdWaXN1YWxpemVyLnVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICBfdXBkYXRlT2Zmc2NyZWVuSW5kaWNhdG9yKCkgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy50ZWFtcy5ob21lID8gdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciA6IG51bGw7CiAgICAgICAgICAgIGNvbnN0IGluZGljYXRvciA9IHRoaXMudWkub2Zmc2NyZWVuSW5kaWNhdG9yOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFwIHx8ICFwLm1lc2ggfHwgIXRoaXMuY2FtZXJhIHx8ICFpbmRpY2F0b3IpIHJldHVybjsKCiAgICAgICAgICAgIC8vIDEuIEdldCBQbGF5ZXIgUG9zaXRpb24gKENlbnRlciBNYXNzKQogICAgICAgICAgICBjb25zdCBwb3MgPSBwLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgcG9zLnkgKz0gMS4wOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDIuIFByb2plY3QgdG8gTm9ybWFsaXplZCBEZXZpY2UgQ29vcmRpbmF0ZXMgKE5EQykgWy0xLCAxXQogICAgICAgICAgICB0aGlzLl90ZW1wVmVjLmNvcHkocG9zKS5wcm9qZWN0KHRoaXMuY2FtZXJhKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDMuIENoZWNrIGlmIEJlaGluZCBDYW1lcmEKICAgICAgICAgICAgY29uc3QgY2FtRndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oY2FtRndkKTsKICAgICAgICAgICAgY29uc3QgdG9QbGF5ZXIgPSBwb3MuY2xvbmUoKS5zdWIodGhpcy5jYW1lcmEucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBjb25zdCBkb3QgPSBjYW1Gd2QuZG90KHRvUGxheWVyKTsKICAgICAgICAgICAgY29uc3QgaXNCZWhpbmQgPSBkb3QgPCAwLjI7IC8vIEJ1ZmZlciB0byBwcmV2ZW50IGZsaXBwaW5nIGF0IGVkZ2UKCiAgICAgICAgICAgIC8vIDQuIENoZWNrIEJvdW5kcwogICAgICAgICAgICBjb25zdCBpc09mZlNjcmVlbiA9ICgKICAgICAgICAgICAgICAgIHRoaXMuX3RlbXBWZWMueCA8IC0wLjkgfHwgdGhpcy5fdGVtcFZlYy54ID4gMC45IHx8CiAgICAgICAgICAgICAgICB0aGlzLl90ZW1wVmVjLnkgPCAtMC45IHx8IHRoaXMuX3RlbXBWZWMueSA+IDAuOSB8fAogICAgICAgICAgICAgICAgaXNCZWhpbmQKICAgICAgICAgICAgKTsKCiAgICAgICAgICAgIGlmIChpc09mZlNjcmVlbikgewogICAgICAgICAgICAgICAgaW5kaWNhdG9yLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgeCA9IHRoaXMuX3RlbXBWZWMueDsKICAgICAgICAgICAgICAgIGxldCB5ID0gdGhpcy5fdGVtcFZlYy55OwoKICAgICAgICAgICAgICAgIC8vIElmIGJlaGluZCwgaW52ZXJ0IGNvb3JkaW5hdGVzIHRvIHBvaW50IGNvcnJlY3RseQogICAgICAgICAgICAgICAgaWYgKGlzQmVoaW5kKSB7CiAgICAgICAgICAgICAgICAgICAgeCA9IC14OwogICAgICAgICAgICAgICAgICAgIHkgPSAteTsKICAgICAgICAgICAgICAgICAgICAvLyBGaXggc2luZ3VsYXJpdHkgaWYgZXhhY3RseSBiZWhpbmQgY2VudGVyCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHgpIDwgMC4wMSAmJiBNYXRoLmFicyh5KSA8IDAuMDEpIHkgPSAtMTsgCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2xhbXAgdG8gc2NyZWVuIGVkZ2VzCiAgICAgICAgICAgICAgICAvLyBXZSB3YW50IHRvIGZpbmQgdGhlIGludGVyc2VjdGlvbiBvZiB0aGUgdmVjdG9yICh4LHkpIHdpdGggdGhlIGJveCBbLTAuOSwgMC45XQogICAgICAgICAgICAgICAgY29uc3QgcGFkZGluZyA9IDAuOTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gTm9ybWFsaXplIHRvIGdldCBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIGNvbnN0IG1hZyA9IE1hdGguc3FydCh4KnggKyB5KnkpOwogICAgICAgICAgICAgICAgY29uc3QgbnggPSB4IC8gbWFnOwogICAgICAgICAgICAgICAgY29uc3QgbnkgPSB5IC8gbWFnOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSYXljYXN0IHRvIGJveCBlZGdlcwogICAgICAgICAgICAgICAgLy8gVmVydGljYWwgZWRnZXM6IHggPSArLy0gcGFkZGluZwogICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCBlZGdlczogeSA9ICsvLSBwYWRkaW5nCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEF2b2lkIGRpdmlkZSBieSB6ZXJvCiAgICAgICAgICAgICAgICBjb25zdCB0eCA9IChNYXRoLmFicyhueCkgPiAwLjAwMSkgPyAobnggPiAwID8gcGFkZGluZyA6IC1wYWRkaW5nKSAvIG54IDogOTk5OwogICAgICAgICAgICAgICAgY29uc3QgdHkgPSAoTWF0aC5hYnMobnkpID4gMC4wMDEpID8gKG55ID4gMCA/IHBhZGRpbmcgOiAtcGFkZGluZykgLyBueSA6IDk5OTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXNlIHRoZSBuZWFyZXN0IGludGVyc2VjdGlvbiAoc21hbGxlc3QgcG9zaXRpdmUgdCkKICAgICAgICAgICAgICAgIC8vIFNpbmNlIHdlIGFyZSBwcm9qZWN0aW5nIGZyb20gY2VudGVyICgwLDApIHRvIChueCxueSksIHQgbXVzdCBiZSBwb3NpdGl2ZS4KICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBNYXRoLm1pbihNYXRoLmFicyh0eCksIE1hdGguYWJzKHR5KSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHNjcmVlblggPSBueCAqIHQ7CiAgICAgICAgICAgICAgICBjb25zdCBzY3JlZW5ZID0gbnkgKiB0OwoKICAgICAgICAgICAgICAgIC8vIENvbnZlcnQgTkRDIHRvIFBpeGVscwogICAgICAgICAgICAgICAgY29uc3Qgd2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICAgICAgICAgIGNvbnN0IGhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgcHggPSAoc2NyZWVuWCAqIDAuNSArIDAuNSkgKiB3aWR0aDsKICAgICAgICAgICAgICAgIGNvbnN0IHB5ID0gKC0oc2NyZWVuWSkgKiAwLjUgKyAwLjUpICogaGVpZ2h0OwoKICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBSb3RhdGlvbgogICAgICAgICAgICAgICAgLy8gQXJyb3cgcG9pbnRzIFVQIGJ5IGRlZmF1bHQuCiAgICAgICAgICAgICAgICAvLyBXZSB3YW50IGl0IHRvIHBvaW50IGluIGRpcmVjdGlvbiAobngsIG55KSBvbiBzY3JlZW4uCiAgICAgICAgICAgICAgICAvLyBTY3JlZW4gWSBpcyBkb3duIChpbnZlcnRlZCBmcm9tIFdlYkdMIFkpLgogICAgICAgICAgICAgICAgLy8gU28gKDAsIDEpIGluIE5EQyBpcyBVUC4gKDAsIC0xKSBpbiBOREMgaXMgRE9XTi4KICAgICAgICAgICAgICAgIC8vIGF0YW4yKHksIHgpIGdpdmVzIGFuZ2xlIGZyb20gK1guCiAgICAgICAgICAgICAgICAvLyBXZSB3YW50IGFuZ2xlIGZyb20gK1kgKFVwKS4KICAgICAgICAgICAgICAgIC8vIFJvdGF0aW9uID0gUEkvMiAtIGFuZ2xlLgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguYXRhbjIobnksIG54KTsKICAgICAgICAgICAgICAgIGNvbnN0IHJvdCA9IChNYXRoLlBJIC8gMikgLSBhbmdsZTsKCiAgICAgICAgICAgICAgICBpbmRpY2F0b3Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgke3B4fXB4LCAke3B5fXB4KSByb3RhdGUoJHtyb3R9cmFkKWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICBpbmRpY2F0b3Iuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVRpbWVyKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkudGltZXIpIHJldHVybjsKICAgICAgICAgICAgLy8gQ2xhbXAgdG8gaGFsZiBkdXJhdGlvbiBmb3IgZGlzcGxheSBpZiB3ZSBnbyBzbGlnaHRseSBvdmVyIGJlZm9yZSB0aWNrCiAgICAgICAgICAgIGNvbnN0IHQgPSBNYXRoLm1pbih0aGlzLnRpbWUsIHRoaXMuaGFsZkR1cmF0aW9uKTsKICAgICAgICAgICAgY29uc3QgbWludXRlcyA9IE1hdGguZmxvb3IodCAvIDYwKTsKICAgICAgICAgICAgY29uc3Qgc2Vjb25kcyA9IE1hdGguZmxvb3IodCAlIDYwKTsKICAgICAgICAgICAgdGhpcy51aS50aW1lci5pbm5lclRleHQgPSBgJHttaW51dGVzLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKX06JHtzZWNvbmRzLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKX1gOwogICAgICAgIH0KICAgICAgICBfY2hlY2tIYWxmVGltZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudGltZSA+PSB0aGlzLmhhbGZEdXJhdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5lbmRIYWxmKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgplbmRIYWxmKCkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2hhbGZ0aW1lJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmhhbGYgPT09IDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dNb2RhbCgiSEFMRiBUSU1FIiwgIlBSRVBBUklORyAyTkQgSEFMRi4uLiIpOwogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZU1vZGFsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydFNlY29uZEhhbGYoKTsKICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRW5kIG9mIDJuZCBIYWxmIG9yIE92ZXJ0aW1lIFBlcmlvZAogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuaG9tZSA9PT0gdGhpcy5zY29yZS5hd2F5KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVElFRCAtIEdvIHRvIE92ZXJ0aW1lIChHb2xkZW4gR29hbCkKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93TW9kYWwoIk9WRVJUSU1FIiwgIkdPTERFTiBHT0FMIFJVTEUgQUNUSVZFIik7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVNb2RhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0T3ZlcnRpbWUoKTsKICAgICAgICAgICAgICAgICAgICB9LCA0MDAwKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV2lubmVyIGRlY2lkZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3RhcnRTZWNvbmRIYWxmKCkgewogICAgICAgICAgICB0aGlzLmhhbGYgPSAyOwogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYuaW5uZXJUZXh0ID0gIjJuZCBIQUxGIjsKICAgICAgICAgICAgdGhpcy5yZXNldFJvdW5kKG51bGwpOyAvLyBOZXV0cmFsIEJsaXR6LW9mZiBmb3IgMm5kIGhhbGYgc3RhcnQKICAgICAgICB9CgogICAgICAgIHN0YXJ0T3ZlcnRpbWUoKSB7CiAgICAgICAgICAgIHRoaXMuaGFsZisrOwogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmlzT3ZlcnRpbWUgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYuaW5uZXJUZXh0ID0gIk9WRVJUSU1FIjsKICAgICAgICAgICAgdGhpcy5yZXNldFJvdW5kKG51bGwpOyAvLyBOZXV0cmFsIEJsaXR6LW9mZgogICAgICAgIH0KCiAgICAgICAgZW5kR2FtZSgpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdnYW1lb3Zlcic7CiAgICAgICAgICAgIGxldCBtc2cgPSAiRFJBVyI7CiAgICAgICAgICAgIGlmICh0aGlzLnNjb3JlLmhvbWUgPiB0aGlzLnNjb3JlLmF3YXkpIG1zZyA9ICJWSUNUT1JZIjsKICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuYXdheSA+IHRoaXMuc2NvcmUuaG9tZSkgbXNnID0gIkRFRkVBVCI7CiAgICAgICAgICAgIAp0aGlzLl9zaG93TW9kYWwobXNnLCAiUFJFU1MgUkVGUkVTSCBUTyBQTEFZIEFHQUlOIik7CiAgICAgICAgICAgIC8vIFN0b3AgTXVzaWMgb24gR2FtZSBPdmVyCiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIuc3RvcEJHTSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE5vIHJlc2V0LCBqdXN0IHN0b3AuCiAgICAgICAgfQoKICAgICAgICBfc2hvd01vZGFsKHRpdGxlLCBzdWJ0ZXh0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy51aS5tb2RhbCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5xdWVyeVNlbGVjdG9yKCcubW9kYWwtdGl0bGUnKS5pbm5lclRleHQgPSB0aXRsZTsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5xdWVyeVNlbGVjdG9yKCcjbW9kYWwtc2NvcmUtaG9tZScpLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuaG9tZTsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5xdWVyeVNlbGVjdG9yKCcjbW9kYWwtc2NvcmUtYXdheScpLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuYXdheTsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5xdWVyeVNlbGVjdG9yKCcjbW9kYWwtbXNnJykuaW5uZXJUZXh0ID0gc3VidGV4dDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudWkubW9kYWwuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIaWRlIEhVRCBlbGVtZW50cwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaHVkLXRvcCcpLnN0eWxlLm9wYWNpdHkgPSAnMCc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJykuc3R5bGUub3BhY2l0eSA9ICcwJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlTW9kYWwoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy51aS5tb2RhbCkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2hvdyBIVUQgZWxlbWVudHMKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKS5zdHlsZS5vcGFjaXR5ID0gJzEnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpLnN0eWxlLm9wYWNpdHkgPSAnMSc7CiAgICAgICAgfQoKX2NoZWNrR29hbHMoKSB7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBwb3MgPSBiYWxsLm1lc2gucG9zaXRpb247CgogICAgICAgICAgICAvLyBQcmVjaXNlIEdvYWwgRGV0ZWN0aW9uCiAgICAgICAgICAgIC8vIFZpc3VhbCBHb2FsIGlzIGF0IFogPSArLy0gMjguCiAgICAgICAgICAgIC8vIFdlIGRlZmluZSBhICJHb2FsIE1vdXRoIiBib3ggbWF0Y2hpbmcgR29hbGllLmpzIChXaWR0aCAxNCwgSGVpZ2h0IDgpLgovLyBXZSBkZWZpbmUgYSAiR29hbCBNb3V0aCIgYm94IG1hdGNoaW5nIHRoZSB2aXN1YWwgbmV0LgogICAgICAgICAgICAvLyBBcmVuYSBSYWRpdXMgaXMgMzIuIEdvYWwgaXMgcm91Z2hseSAyMm0gd2lkZSwgMThtIGhpZ2guCi8vIEFyZW5hIFJhZGl1cyBpcyAzMi4gR29hbCBpcyByb3VnaGx5IDIybSB3aWRlLCAxOG0gaGlnaC4KICAgICAgICAgICAgY29uc3QgaGFsZldpZHRoID0gMTEuMDsgLy8gSW5jcmVhc2VkIHRvIDExIChXaWR0aCAyMikgdG8gY2F0Y2ggY29ybmVycwogICAgICAgICAgICBjb25zdCBoYWxmSGVpZ2h0ID0gOS4wOyAvLyBJbmNyZWFzZWQgdG8gOSAoSGVpZ2h0IDE4KSB0byBjYXRjaCBoaWdoIHNob3RzCiAgICAgICAgICAgIGNvbnN0IGdvYWxZT2Zmc2V0ID0gLTQuNTsgLy8gTW92ZWQgZG93biB0byBtYXRjaCB2aXN1YWwgbW9kZWwgKC00LjVtKQoKICAgICAgICAgICAgY29uc3QgdHJpZ2dlclogPSA0NS4wOyAvLyBUcmlnZ2VyIGVhcmxpZXIgKHdhcyAzMCkgdG8gZW5zdXJlIHJlZ2lzdHJhdGlvbiBiZWZvcmUgYm91bmNlCgogICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnopID4gdHJpZ2dlclopIHsKICAgICAgICAgICAgICAgIC8vIFBSRVZFTlQgT1dOIEdPQUwgQlkgQ0FSUklFUiAoVXNlciBSZXF1ZXN0KQogICAgICAgICAgICAgICAgLy8gSWYgdGhlIGJhbGwgaXMgaGVsZCBieSB0aGUgdGVhbSBkZWZlbmRpbmcgdGhpcyBnb2FsLCBkbyBub3QgY291bnQgaXQuCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIb21lIChTaWRlIDEpIGRlZmVuZHMgK1ouIElmIHBvcy56ID4gMCAoSG9tZSBHb2FsKSBhbmQgaG9sZGVyIGlzIEhvbWUsIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPiAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gMSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIC8vIEF3YXkgKFNpZGUgLTEpIGRlZmVuZHMgLVouIElmIHBvcy56IDwgMCAoQXdheSBHb2FsKSBhbmQgaG9sZGVyIGlzIEF3YXksIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gLTEpIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyLiBDaGVjayBGcmFtZSAoTXVzdCBiZSB3aXRoaW4gd2lkdGgvaGVpZ2h0KQovLyAyLiBDaGVjayBGcmFtZSAoTXVzdCBiZSB3aXRoaW4gd2lkdGgvaGVpZ2h0LCBhY2NvdW50aW5nIGZvciBZIG9mZnNldCkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueCkgPD0gaGFsZldpZHRoICYmIE1hdGguYWJzKHBvcy55IC0gZ29hbFlPZmZzZXQpIDw9IGhhbGZIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ29hbFNjb3JlZCgnaG9tZScpOyAvLyBIb21lIGF0dGFja3MgLVoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdvYWxTY29yZWQoJ2F3YXknKTsgLy8gQXdheSBhdHRhY2tzICtaCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKZ29hbFNjb3JlZChzY29yZXIpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJTVBBQ1QgRlJBTUU6IEdPQUwKdGhpcy50cmlnZ2VySW1wYWN0KDAuNCwgJ3NoYXR0ZXInKTsgLy8gTWFzc2l2ZSBmcmVlemUgZm9yIGdvYWwKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFWFAgUkVXQVJEOiBHb2FsCiAgICAgICAgICAgIC8vIEZpbmQgd2hvIHNjb3JlZCAoTGFzdCBob2xkZXIgb2YgYmFsbCkKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5sYXN0SG9sZGVyICYmIGJhbGwubGFzdEhvbGRlci50ZWFtLmlkID09PSBzY29yZXIpIHsKICAgICAgICAgICAgICAgIGJhbGwubGFzdEhvbGRlci5nYWluRXhwKDEwKTsKICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBBc3Npc3QgbG9naWMgY291bGQgZ28gaGVyZSAodHJhY2sgbGFzdEhvbGRlci5sYXN0UGFzc2VyPykKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdnb2FsJzsKICAgICAgICAgICAgdGhpcy5zY29yZVtzY29yZXJdKys7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoKTsKICAgICAgICAgICAgCi8vIDEuIFZJU0NFUkFMIFNIQUtFICYgUEFSVElDTEVTCiAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgyLjApOyAvLyBIZWF2eSBzaGFrZQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlciAmJiB0aGlzLmVudGl0aWVzLmJhbGwgJiYgdGhpcy5lbnRpdGllcy5iYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxQb3MgPSB0aGlzLmVudGl0aWVzLmJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgLy8gTWFzc2l2ZSBHb2FsIEV4cGxvc2lvbgogICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIGdvYWxQb3MsIHsgc2NhbGU6IDE1LjAsIGxpZmU6IDAuOCB9KTsKICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIGdvYWxQb3MsIHsgc2NhbGU6IDEwLjAgfSk7CiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzMDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2RlYnJpcycsIGdvYWxQb3MsIHsgc2NhbGU6IDAuOCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyAyLiBTQ1JFRU4gRkxBU0gKICAgICAgICAgICAgaWYgKHRoaXMudWkuZmxhc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuZmxhc2guc3R5bGUub3BhY2l0eSA9ICcwLjgnOwogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IHRoaXMudWkuZmxhc2guc3R5bGUub3BhY2l0eSA9ICcwJzsgfSwgMTAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gR09MREVOIEdPQUwgQ0hFQ0sKICAgICAgICAgICAgaWYgKHRoaXMuaXNPdmVydGltZSkgewogICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJHT0xERU4gR09BTCEiLCAnc2xhbScpOwogICAgICAgICAgICAgICAgLy8gRW5kIGdhbWUgYWZ0ZXIgc2hvcnQgZGVsYXkKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuZW5kR2FtZSgpOwogICAgICAgICAgICAgICAgfSwgMzAwMCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIFNMQU0gQU5OT1VOQ0VNRU5UIChOb3JtYWwpCiAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiR09BTCEiLCAnc2xhbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgc2VxdWVuY2UKICAgICAgICAgICAgLy8gU2NvcmVkLXVwb24gdGVhbSBnZXRzIGJhbGwKICAgICAgICAgICAgY29uc3QgbG9zZXIgPSBzY29yZXIgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZBU1RFUiBGTE9XOiBSZWR1Y2VkIGRlbGF5IGZyb20gMzAwMG1zIHRvIDEyMDBtcwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChsb3Nlcik7CiAgICAgICAgICAgIH0sIDIwMDApOyAvLyBTbGlnaHRseSBsb25nZXIgdG8gYXBwcmVjaWF0ZSB0aGUgIkdPQUwiIHNsYW0KICAgICAgICB9CgpzaG93QW5ub3VuY2VtZW50KHRleHQsIHR5cGUgPSAnbm9ybWFsJywgZHVyYXRpb24gPSAyMDAwKSB7CiAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5hbm5vdW5jZW1lbnQ7CiAgICAgICAgICAgIGlmICghZWwpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENsZWFyIHByZXZpb3VzIHRpbWVvdXQKICAgICAgICAgICAgaWYgKHRoaXMuX2Fubm91bmNlVGltZW91dCkgewogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX2Fubm91bmNlVGltZW91dCk7CiAgICAgICAgICAgICAgICB0aGlzLl9hbm5vdW5jZVRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBBbmltYXRpb24gYnkgY2xvbmluZwogICAgICAgICAgICBjb25zdCBuZXdFbCA9IGVsLmNsb25lTm9kZSh0cnVlKTsKICAgICAgICAgICAgZWwucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQobmV3RWwsIGVsKTsKICAgICAgICAgICAgdGhpcy51aS5hbm5vdW5jZW1lbnQgPSBuZXdFbDsKCiAgICAgICAgICAgIG5ld0VsLmlubmVyVGV4dCA9IHRleHQ7CiAgICAgICAgICAgIG5ld0VsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgQ2xhc3MgYmFzZWQgb24gdHlwZQogICAgICAgICAgICBuZXdFbC5jbGFzc05hbWUgPSAnJzsgLy8gUmVzZXQgY2xhc3NlcwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3NsYW0nKSB7CiAgICAgICAgICAgICAgICBuZXdFbC5jbGFzc0xpc3QuYWRkKCdhbm5vdW5jZW1lbnQtc2xhbScpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRGVmYXVsdCBzdHlsZQogICAgICAgICAgICAgICAgbmV3RWwuc3R5bGUuYW5pbWF0aW9uID0gJ25vbmUnOwogICAgICAgICAgICAgICAgbmV3RWwub2Zmc2V0SGVpZ2h0OyAvKiB0cmlnZ2VyIHJlZmxvdyAqLwogICAgICAgICAgICAgICAgbmV3RWwuc3R5bGUuYW5pbWF0aW9uID0gJ2Fubm91bmNlU2xpZGUgMC41cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSknOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBdXRvLWhpZGUKICAgICAgICAgICAgaWYgKGR1cmF0aW9uID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fYW5ub3VuY2VUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlQW5ub3VuY2VtZW50KCk7CiAgICAgICAgICAgICAgICB9LCBkdXJhdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGhpZGVBbm5vdW5jZW1lbnQoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLmFubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgdGhpcy51aS5hbm5vdW5jZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCnJlc2V0Um91bmQocG9zc2Vzc2lvblRlYW1JZCkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ3Jlc2V0JzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IEJhbGwKICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCkgdGhpcy5lbnRpdGllcy5iYWxsLnJlc2V0KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCBUZWFtcwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBiYWxsIGhvbGRlcgogICAgICAgICAgICBpZiAodGhpcy5lbnRpdGllcy5iYWxsKSB0aGlzLmVudGl0aWVzLmJhbGwuZHJvcCgpOwoKICAgICAgICAgICAgLy8gQ1JJVElDQUw6IFNuYXAgY2FtZXJhIHRvIHByZXZlbnQgZGlzb3JpZW50YXRpb24KICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gRm9yY2UgdXBkYXRlIHRhcmdldCBmaXJzdCAodXN1YWxseSBiYWxsKQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCAmJiB0aGlzLmVudGl0aWVzLmJhbGwubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQodGhpcy5lbnRpdGllcy5iYWxsLm1lc2gsIHRoaXMuZW50aXRpZXMuYmFsbC52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGQVNURVIgRkxPVzogUmVkdWNlZCBkZWxheSBmcm9tIDIwMDBtcyB0byAxMDBtcwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRLaWNrb2ZmKHBvc3Nlc3Npb25UZWFtSWQpOwp9LCAxMDApOwogICAgICAgIH0KCiAgICAgICAgc3RhcnRLaWNrb2ZmKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdraWNrb2ZmJzsKICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJCTElUWiBPRkYhIiwgJ3NsYW0nKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElmIGEgdGVhbSBoYXMgcG9zc2Vzc2lvbiAoYWZ0ZXIgZ29hbCksIGdpdmUgdG8gTUYKICAgICAgICAgICAgaWYgKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRlYW0gPSB0aGlzLnRlYW1zW3Bvc3Nlc3Npb25UZWFtSWRdOwogICAgICAgICAgICAgICAgaWYgKHRlYW0pIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtZiA9IHRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgICAgICAgICBpZiAobWYgJiYgdGhpcy5lbnRpdGllcy5iYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW50aXRpZXMuYmFsbC5ncmFiKG1mKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENSSVRJQ0FMOiBTbmFwIGNhbWVyYSB0byBuZXcgaG9sZGVyIHRvIHByZXZlbnQgc3dpbmcvZGlzb3JpZW50YXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldChtZi5tZXNoLCBtZi52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOZXV0cmFsIGtpY2tvZmYgLSBlbnN1cmUgY2FtZXJhIGlzIHNuYXBwZWQgdG8gY2VudGVyIGJhbGwKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIgJiYgdGhpcy5lbnRpdGllcy5iYWxsICYmIHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldCh0aGlzLmVudGl0aWVzLmJhbGwubWVzaCwgdGhpcy5lbnRpdGllcy5iYWxsLnZlbG9jaXR5KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZBU1RFUiBGTE9XOiBSZWR1Y2VkIGRlbGF5IGZyb20gMTAwMG1zIHRvIDgwMG1zCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5oaWRlQW5ub3VuY2VtZW50KCk7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2FjdGl2ZSc7CiAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgfQogICAgICAgIAovLyBJbml0aWFsIHN0YXJ0CiAgICAgICAgc3RhcnRNYXRjaChtb2RlID0gJ25vcm1hbCcpIHsKICAgICAgICAgICAgdGhpcy5nYW1lTW9kZSA9IG1vZGU7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJTdGFydGluZyBNYXRjaCBpbiBtb2RlOiIsIG1vZGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhcnQgTXVzaWMKICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IFNjb3JlCnRoaXMuc2NvcmUuaG9tZSA9IDA7CiAgICAgICAgICAgIHRoaXMuc2NvcmUuYXdheSA9IDA7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IFRpbWUKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5oYWxmID0gMTsKICAgICAgICAgICAgaWYgKHRoaXMudWkuaGFsZikgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICIxc3QiOwogICAgICAgICAgICAKaWYgKG1vZGUgPT09ICdwcmFjdGljZScpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiUFJBQyI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyLnN0YXJ0KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSW4gcHJhY3RpY2UsIGVuc3VyZSBBSSBpcyBlbmFibGVkIGZvciBzcGFycmluZwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5haUVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBQcmFjdGljZSBNYW5hZ2VyIGlzIHN0b3BwZWQgaWYgbm9ybWFsIGdhbWUKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgdGhpcy5wcmFjdGljZU1hbmFnZXIuc3RvcCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTYWZldHk6IEVuc3VyZSBhbGwgcGxheWVycyBhcmUgdmlzaWJsZSAoaW4gY2FzZSBQcmFjdGljZSBoaWQgdGhlbSkKICAgICAgICAgICAgICAgIC8vIEFuZCBGT1JDRSBBSSBFTkFCTEVEIChGaXggZm9yICJab21iaWVzIiBpZiBjb21pbmcgZnJvbSBQcmFjdGljZSBNb2RlKQogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7IGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSB0cnVlOyB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gdHJ1ZTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7IH0pOwogICAgICAgICAgICAgICAgfQoKdGhpcy5yZXNldFJvdW5kKCk7CiAgICAgICAgICAgIH0KfQoKc2V0TWVudU1vZGUoaXNBY3RpdmUpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGlzQWN0aXZlID8gJ21lbnUnIDogJ2FjdGl2ZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaXNBY3RpdmUgJiYgdGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnN0b3BCR00oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBIVUQgaW4gbWVudQogICAgICAgICAgICBjb25zdCBodWRUb3AgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaHVkLXRvcCcpOwogICAgICAgICAgICBjb25zdCBzdGF0dXNQYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJyk7CiAgICAgICAgICAgIGNvbnN0IGNvbnRyb2xzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1jb250YWluZXInKTsKICAgICAgICAgICAgY29uc3Qgam95c3RpY2sgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2staGl0LXpvbmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRpc3BsYXkgPSBpc0FjdGl2ZSA/ICdub25lJyA6ICdmbGV4JzsgLy8gb3IgYmxvY2svZXRjCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaHVkVG9wKSBodWRUb3Auc3R5bGUuZGlzcGxheSA9IGRpc3BsYXk7CiAgICAgICAgICAgIGlmIChzdGF0dXNQYW5lbCkgc3RhdHVzUGFuZWwuc3R5bGUuZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2Jsb2NrJzsgLy8gU3RhdHVzIHBhbmVsIGhhcyBzcGVjaWZpYyBsb2dpYwogICAgICAgICAgICBpZiAoY29udHJvbHMpIGNvbnRyb2xzLnN0eWxlLmRpc3BsYXkgPSBpc0FjdGl2ZSA/ICdub25lJyA6ICdmbGV4JzsKICAgICAgICAgICAgaWYgKGpveXN0aWNrKSBqb3lzdGljay5zdHlsZS5kaXNwbGF5ID0gaXNBY3RpdmUgPyAnbm9uZScgOiAnYmxvY2snOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgZW50ZXJpbmcgbWVudSwgcmVzZXQgY2FtZXJhIHRvIGEgbmljZSBhbmdsZT8KICAgICAgICAgICAgLy8gSGFuZGxlZCBieSB1cGRhdGUgbG9vcAogICAgICAgIH0KdG9nZ2xlRGVtb01vZGUoKSB7CiAgICAgICAgICAgIHRoaXMuaXNEZW1vTW9kZSA9ICF0aGlzLmlzRGVtb01vZGU7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJEZW1vIE1vZGU6IiwgdGhpcy5pc0RlbW9Nb2RlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBVSSBCdXR0b24KICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F1dG8tdG9nZ2xlJyk7CiAgICAgICAgICAgIGlmIChidG4pIHsKICAgICAgICAgICAgICAgIGJ0bi5pbm5lclRleHQgPSB0aGlzLmlzRGVtb01vZGUgPyAiQVVUTyBQSUxPVCIgOiAiTUFOVUFMIjsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzRGVtb01vZGUpIHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSB0aGlzLmlzRGVtb01vZGUgPyAiQVVUTyBQSUxPVCIgOiAiTUFOVUFMIjsKICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KHRleHQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIEZsYWlyOiBTcGF3biB0ZXh0IGFib3ZlIGFjdGl2ZSBwbGF5ZXIKICAgICAgICAgICAgaWYgKHRoaXMuaXNEZW1vTW9kZSAmJiB0aGlzLmZsb2F0aW5nVGV4dCAmJiB0aGlzLnRlYW1zLmhvbWUgJiYgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciAmJiB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKCJBSSBFTkdBR0VEIiwgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllci5tZXNoLnBvc2l0aW9uLCAiZ29hbCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBdXRvLWhpZGUgYW5ub3VuY2VtZW50CnNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkuYW5ub3VuY2VtZW50ICYmIHRoaXMudWkuYW5ub3VuY2VtZW50LmlubmVyVGV4dCA9PT0gdGV4dCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBURUNIQ09QWSBTWVNURU0gLS0tCgogICAgICAgIHRyaWdnZXJUZWNoRXZlbnQoc291cmNlUGxheWVyLCB0ZWNoTmFtZSkgewogICAgICAgICAgICBpZiAoIXNvdXJjZVBsYXllciB8fCAhc291cmNlUGxheWVyLnRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIC8vIEZpbmQgb3Bwb3NpbmcgdGVhbQogICAgICAgICAgICBjb25zdCBvcHBUZWFtSWQgPSBzb3VyY2VQbGF5ZXIudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gdGhpcy50ZWFtc1tvcHBUZWFtSWRdOwogICAgICAgICAgICBpZiAoIW9wcFRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIC8vIEZpbmQgd2hvIGlzIG1hcmtpbmcgdGhpcyBzb3VyY2UKICAgICAgICAgICAgY29uc3QgbGVhcm5lcnMgPSBvcHBUZWFtLnBsYXllcnMuZmlsdGVyKHAgPT4gcC5tYXJraW5nID09PSBzb3VyY2VQbGF5ZXIpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGxlYXJuZXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gT25seSBzaG93IFVJIGlmIHRoZSBsZWFybmluZyB0ZWFtIGlzIEh1bWFuIChIb21lKQogICAgICAgICAgICAvLyAoT3IgaWYgd2UgYXJlIGluIERlbW8gbW9kZSBhbmQgd2FudCB0byBzZWUgaXQgaGFwcGVuIGZvciBIb21lIHRlYW0pCiAgICAgICAgICAgIGlmIChvcHBUZWFtLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIC8vIEZpbHRlciBvdXQgdGhvc2Ugd2hvIGFscmVhZHkga25vdyBpdAogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRMZWFybmVycyA9IGxlYXJuZXJzLmZpbHRlcihwID0+ICFwLmxlYXJuZWRUZWNocy5pbmNsdWRlcyh0ZWNoTmFtZSkpOwogICAgICAgICAgICAgICAgaWYgKHZhbGlkTGVhcm5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRUZWNoQ29weVdpbmRvdyh0ZWNoTmFtZSwgdmFsaWRMZWFybmVycyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzdGFydFRlY2hDb3B5V2luZG93KHRlY2hOYW1lLCBsZWFybmVycykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLm1heFRpbWUgPSAwLjY7IC8vIDAuNnMgd2luZG93CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciA9IHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUudGVjaCA9IHRlY2hOYW1lOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUubGVhcm5lcnMgPSBsZWFybmVyczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNob3cgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaEZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoRmxhc2guc3R5bGUuYmFja2dyb3VuZCA9ICIiOyAvLyBSZXNldCBiYWNrZ3JvdW5kCiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlRFQ0hDT1BZISI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hTdWIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hTdWIuaW5uZXJUZXh0ID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IGJhcgogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaFRpbWVyRmlsbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9ICcxMDAlJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmF0dGVtcHRUZWNoQ29weSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdWNjZXNzIQogICAgICAgICAgICBjb25zdCB0ZWNoID0gdGhpcy50ZWNoQ29weVN0YXRlLnRlY2g7CiAgICAgICAgICAgIGNvbnN0IGxlYXJuZXJzID0gdGhpcy50ZWNoQ29weVN0YXRlLmxlYXJuZXJzOwogICAgICAgICAgICAKICAgICAgICAgICAgbGVhcm5lcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIC8vIERvdWJsZSBjaGVjayB0byBwcmV2ZW50IGR1cGxpY2F0ZXMKICAgICAgICAgICAgICAgIGlmICghcC5sZWFybmVkVGVjaHMuaW5jbHVkZXModGVjaCkpIHsKICAgICAgICAgICAgICAgICAgICBwLmxlYXJuZWRUZWNocy5wdXNoKHRlY2gpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3Aucm9sZX0gbGVhcm5lZCAke3RlY2h9IWApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDEuIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5mbG9hdGluZ1RleHQgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKGBMRUFSTkVEIWAsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gUGFydGljbGUgRWZmZWN0IChTcGlyYWwpCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biBtdWx0aXBsZSBwYXJ0aWNsZXMgZm9yIGEgc3dpcmwgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDEwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGkgKiA1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5lbmRUZWNoQ29weVdpbmRvdyh0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKZW5kVGVjaENvcHlXaW5kb3coc3VjY2VzcykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlNVQ0NFU1MhIjsKICAgICAgICAgICAgICAgICAgICAvLyBGbGFzaCBzdWNjZXNzIGNvbG9yIChXaGl0ZSBmbGFzaCkKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5iYWNrZ3JvdW5kID0gInJnYmEoMjU1LCAyNTUsIDI1NSwgMC44KSI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSGlkZSBhZnRlciBzaG9ydCBkZWxheSB0byBzaG93IHRoZSBzdWNjZXNzIGZsYXNoCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOyAKICAgICAgICAgICAgICAgICAgICB9LCAzMDApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBGYWlsZWQgLyBNaXNzZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQpfdXBkYXRlUGxheWVyU3RhdHVzVUkoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtcy5ob21lIHx8ICF0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBwID0gdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgdWkgPSB0aGlzLnVpLnN0YXR1c1BhbmVsOwogICAgICAgICAgICAKLy8gVUkgVXBkYXRlcyAoQWN0aW9uIEJ1dHRvbiBDb250ZXh0KQogICAgICAgICAgICAgICAgdWkuY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOYW1lICYgTGV2ZWwKICAgICAgICAgICAgICAgIGlmICh1aS5uYW1lKSB1aS5uYW1lLmlubmVyVGV4dCA9IGAke3AuY2hhcmFjdGVyTmFtZSB8fCBwLnJvbGV9IExWJHtwLmxldmVsfWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEhQCiAgICAgICAgICAgICAgICBpZiAodWkuaHBCYXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBocFBjdCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEwMCwgKHAuc3RhdHMuSFAgLyBwLnN0YXRzLm1heEhQKSAqIDEwMCkpOwogICAgICAgICAgICAgICAgICAgIHVpLmhwQmFyLnN0eWxlLndpZHRoID0gYCR7aHBQY3R9JWA7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29sb3Igc2hpZnQKICAgICAgICAgICAgICAgICAgICBpZiAoaHBQY3QgPCAyNSkgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAwMDAsICNmZjQ0NDQpJzsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChocFBjdCA8IDUwKSB1aS5ocEJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmYwMCwgI2ZmZmY4OCknOwogICAgICAgICAgICAgICAgICAgIGVsc2UgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwMGZmMDAsICNjY2ZmY2MpJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1aS5ocFRleHQpIHVpLmhwVGV4dC5pbm5lclRleHQgPSBgJHtNYXRoLmZsb29yKHAuc3RhdHMuSFApfS8ke3Auc3RhdHMubWF4SFB9YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRVhQCiAgICAgICAgICAgICAgICBpZiAodWkuZXhwQmFyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwUGN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMTAwLCAocC5leHAgLyBwLm5leHRMZXZlbEV4cCkgKiAxMDApKTsKICAgICAgICAgICAgICAgICAgICB1aS5leHBCYXIuc3R5bGUud2lkdGggPSBgJHtleHBQY3R9JWA7CnVpLmV4cEJhci5zdHlsZS53aWR0aCA9IGAke2V4cFBjdH0lYDsKICAgICAgICAgICAgICAgIH0KICAgICAgICB9CgpfaW5pdFBhcnRpY2xlcygpIHsKICAgICAgICAgICAgdGhpcy5hY3RpdmVTcGFya3MgPSBbXTsKICAgICAgICAgICAgdGhpcy5zcGFya1Bvb2wgPSBbXTsKICAgICAgICAgICAgY29uc3QgcG9vbFNpemUgPSA0MDsgLy8gU3VmZmljaWVudCBmb3IgY29udGludW91cyBncmluZGluZwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb29sU2l6ZTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSBuZXcgVEhSRUUuU3ByaXRlKF9zcGFya01hdGVyaWFsLmNsb25lKCkpOwogICAgICAgICAgICAgICAgc3ByaXRlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHNwcml0ZSk7CiAgICAgICAgICAgICAgICB0aGlzLnNwYXJrUG9vbC5wdXNoKHNwcml0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNwYXduQ2xhc2gocG9zLCBpbnRlbnNpdHkgPSAxLjApIHsKICAgICAgICAgICAgLy8gRmluZCBmcmVlIHNwYXJrCiAgICAgICAgICAgIGNvbnN0IHNwYXJrID0gdGhpcy5zcGFya1Bvb2wuZmluZChzID0+ICFzLnZpc2libGUpOwogICAgICAgICAgICBpZiAoIXNwYXJrKSByZXR1cm47IC8vIFBvb2wgZXhoYXVzdGVkCiAgICAgICAgICAgIAogICAgICAgICAgICBzcGFyay5wb3NpdGlvbi5jb3B5KHBvcyk7CiAgICAgICAgICAgIHNwYXJrLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmFuZG9taXplIHJvdGF0aW9uCiAgICAgICAgICAgIHNwYXJrLm1hdGVyaWFsLnJvdGF0aW9uID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsaXplIEFjdGl2ZSBTdGF0ZQogICAgICAgICAgICB0aGlzLmFjdGl2ZVNwYXJrcy5wdXNoKHsKICAgICAgICAgICAgICAgIG1lc2g6IHNwYXJrLAogICAgICAgICAgICAgICAgYWdlOiAwLAogICAgICAgICAgICAgICAgbGlmZTogMC4xNSArIE1hdGgucmFuZG9tKCkgKiAwLjE1LCAvLyBGYXN0LCBwdW5jaHkgc3BhcmtzCiAgICAgICAgICAgICAgICBtYXhTY2FsZTogMi41ICogaW50ZW5zaXR5LAogICAgICAgICAgICAgICAgdmVsb2NpdHk6IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqOCwgCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSo4LCAKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKjgKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlUGFydGljbGVzKGR0KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmFjdGl2ZVNwYXJrcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuYWN0aXZlU3BhcmtzW2ldOwogICAgICAgICAgICAgICAgcC5hZ2UgKz0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChwLmFnZSA+PSBwLmxpZmUpIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlU3BhcmtzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgdCA9IHAuYWdlIC8gcC5saWZlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBFeHBhbmQKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRTY2FsZSA9IDAuNSArIChwLm1heFNjYWxlIC0gMC41KSAqIHQ7CiAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKGN1cnJlbnRTY2FsZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZhZGUgb3V0CiAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IDEuMCAtICh0ICogdCk7IC8vIFF1YWRyYXRpYyBmYWRlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE1vdmUKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5hZGRTY2FsZWRWZWN0b3IocC52ZWxvY2l0eSwgZHQpOwogICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLnJvdGF0aW9uICs9IDEwLjAgKiBkdDsKICAgICAgICAgICAgfQogICAgICAgIH0KCi8vIEhlbHBlciBmb3IgaW1wYWN0IGZyYW1lcwoKdHJpZ2dlckltcGFjdChkdXJhdGlvbiwgdHlwZSA9ICdkZWZhdWx0JykgewogICAgICAgICAgICB0aGlzLmltcGFjdFBhdXNlID0gZHVyYXRpb247CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKICAgICAgICAgICAgaWYgKCFjb250YWluZXIpIHJldHVybjsKCiAgICAgICAgICAgIC8vIFJlc2V0IGNsYXNzZXMgdG8gZW5zdXJlIGFuaW1hdGlvbiByZXN0YXJ0cwogICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZSgnaW1wYWN0LWZ4JywgJ2ltcGFjdC1oZWF2eScsICdpbXBhY3Qtc2hhdHRlcicpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRm9yY2UgcmVmbG93CiAgICAgICAgICAgIHZvaWQgY29udGFpbmVyLm9mZnNldFdpZHRoOwoKICAgICAgICAgICAgbGV0IGNsYXNzTmFtZSA9ICdpbXBhY3QtZngnOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2hlYXZ5JykgY2xhc3NOYW1lID0gJ2ltcGFjdC1oZWF2eSc7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnc2hhdHRlcicpIGNsYXNzTmFtZSA9ICdpbXBhY3Qtc2hhdHRlcic7CgogICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LmFkZChjbGFzc05hbWUpOwoKICAgICAgICAgICAgLy8gQXV0by1yZW1vdmUgY2xhc3MgYWZ0ZXIgZHVyYXRpb24KICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpOwogICAgICAgICAgICB9LCBkdXJhdGlvbiAqIDEwMDAgKyAxMDApOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5HYW1lTWFuYWdlciA9IEdhbWVNYW5hZ2VyOwp9KSgpOw==","./GameManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFNwYXJrIFRleHR1cmUgKFByb2NlZHVyYWwgQnVyc3QpCiAgICBjb25zdCBfc3BhcmtUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw2NCw2NCk7CiAgICAgICAgCiAgICAgICAgLy8gQnVyc3Qgc2hhcGUKICAgICAgICBjb25zdCBjeCA9IDMyLCBjeSA9IDMyOwogICAgICAgIGNvbnN0IHNwaWtlcyA9IDg7CiAgICAgICAgY29uc3Qgb3V0ZXIgPSAzMDsKICAgICAgICBjb25zdCBpbm5lciA9IDEwOwogICAgICAgIAogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBmb3IobGV0IGk9MDsgaTxzcGlrZXMqMjsgaSsrKXsKICAgICAgICAgICAgY29uc3QgciA9IChpJTI9PT0wKT8gb3V0ZXIgOiBpbm5lcjsKICAgICAgICAgICAgY29uc3QgYSA9IChNYXRoLlBJKmkpL3NwaWtlczsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKnIsIGN5ICsgTWF0aC5zaW4oYSkqcik7CiAgICAgICAgfQogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmNjMDAnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgLy8gV2hpdGUgQ29yZQogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHguYXJjKGN4LCBjeSwgOCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjb25zdCBfc3BhcmtNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IAogICAgICAgIG1hcDogX3NwYXJrVGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBHYW1lTWFuYWdlciB7CgogICAgICAgIApjb25zdHJ1Y3RvcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEsIHJlbmRlcmVyKSB7CndpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIgPSByZW5kZXJlcjsgLy8gU3RvcmUgcmVuZGVyZXIKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmNhbWVyYSA9IGNhbWVyYTsKICAgICAgICAgICAgdGhpcy51aUxheWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodWlMYXllcklkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc2NvcmUgPSB7IGhvbWU6IDAsIGF3YXk6IDAgfTsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5oYWxmID0gMTsKICAgICAgICAgICAgdGhpcy5oYWxmRHVyYXRpb24gPSAzMDA7IC8vIDUgbWludXRlcyAoc2Vjb25kcykKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNEZW1vTW9kZSA9IGZhbHNlOwp0aGlzLmdhbWVNb2RlID0gJ25vcm1hbCc7IC8vICdub3JtYWwnIG9yICdwcmFjdGljZScKICAgICAgICAgICAgdGhpcy5pc0ZvcmdlTW9kZSA9IGZhbHNlOyAvLyBBc3NldCBGb3JnZSBTdGF0ZQogICAgICAgICAgICAvLyBJbXBhY3QgRnJhbWVzCiAgICAgICAgICAgIHRoaXMuaW1wYWN0UGF1c2UgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsgLy8gU3RhcnQgaW4gbWVudQp0aGlzLnRlYW1zID0gewogICAgICAgICAgICAgICAgaG9tZTogbnVsbCwKICAgICAgICAgICAgICAgIGF3YXk6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZW50aXRpZXMgPSB7CiAgICAgICAgICAgICAgICBiYWxsOiBudWxsCiAgICAgICAgICAgIH07Cgp0aGlzLnVpID0gewogICAgICAgICAgICAgICAgc2NvcmVQbGF5ZXI6IG51bGwsCiAgICAgICAgICAgICAgICBzY29yZUNwdTogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWVyOiBudWxsLAogICAgICAgICAgICAgICAgaGFsZjogbnVsbCwKICAgICAgICAgICAgICAgIGFubm91bmNlbWVudDogbnVsbCwKICAgICAgICAgICAgICAgIC8vIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgICAgIHN0YXR1c1BhbmVsOiB7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyOiBudWxsLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBCYXI6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBUZXh0OiBudWxsLAogICAgICAgICAgICAgICAgICAgIGV4cEJhcjogbnVsbAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVGVjaGNvcHkgU3RhdGUKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHRpbWVyOiAwLAogICAgICAgICAgICAgICAgdGVjaDogbnVsbCwKICAgICAgICAgICAgICAgIGxlYXJuZXJzOiBbXQogICAgICAgICAgICB9OwoKdGhpcy5taW5pTWFwID0gbmV3IHdpbmRvdy5mbHV4Lk1pbmlNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgRmxvYXRpbmcgVGV4dAovLyBJbml0aWFsaXplIEZsb2F0aW5nIFRleHQKdGhpcy5mbG9hdGluZ1RleHQgPSBuZXcgd2luZG93LmZsdXguRmxvYXRpbmdUZXh0TWFuYWdlcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBVSSBjYWxjdWxhdGlvbnMKICAgICAgICAgICAgdGhpcy5fdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIFBhcnRpY2xlIE1hbmFnZXIgKFN0YXR1cyBFZmZlY3RzKQogICAgICAgICAgICAKLy8gSW5pdGlhbGl6ZSBQYXJ0aWNsZSBNYW5hZ2VyIChTdGF0dXMgRWZmZWN0cykKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyKHNjZW5lKTsKdGhpcy5nbHlwaE1hbmFnZXIgPSBudWxsOyAvLyBJbmplY3RlZCBieSBtYWluLmpzCiAgICAgICAgICAgIHRoaXMuX2luaXRQYXJ0aWNsZXMoKTsgLy8gM0QgU3BhcmsgU3lzdGVtIChMZWdhY3kvSW1wYWN0KQoKdGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIgPSBuZXcgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyKHNjZW5lKTsKICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyKHRoaXMpOyAvLyBJbml0aWFsaXplIFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgdGhpcy5faW5qZWN0U3R5bGVzKCk7CnRoaXMuX2luaXRVSSgpOwogICAgICAgIH0KCl9pbml0Q2luZW1hdGljcygpIHsKICAgICAgICAgICAgdGhpcy5tZW51U2hvdEluZGV4ID0gMDsKICAgICAgICAgICAgdGhpcy5tZW51U2hvdFRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5tZW51U2hvdHMgPSBbCiAgICAgICAgICAgICAgICAvLyAxLiAiVGhlIEFyZW5hIiAtIFdpZGUgRXN0YWJsaXNoaW5nIFNob3QgKFNsb3cgZG9sbHkgaW4pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDEwLjAsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoNjAsIDM1LCA2MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAyID0gbmV3IFRIUkVFLlZlY3RvcjMoNDAsIDI1LCA0MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNtb290aHN0ZXAgaW50ZXJwb2xhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdCA9IHQgKiB0ICogKDMgLSAyICogdCk7IAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCBzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIDIuICJUaGUgVGVhbSIgLSBUcmFja2luZyBTaG90IGFsb25nIHRoZSBmb3JtYXRpb24KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogOC4wLAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBNb3ZlIGFsb25nIHRoZSBzaWRlIG9mIHRoZSBob21lIHRlYW0gZm9ybWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHpTdGFydCA9IC0yNTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgekVuZCA9IDI1OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50WiA9IHpTdGFydCArICh6RW5kIC0gelN0YXJ0KSAqIHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24uc2V0KC0yNSwgNiwgY3VycmVudFopOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KDAsIDIsIGN1cnJlbnRaICogMC44KTsgLy8gTG9vayBzbGlnaHRseSBhaGVhZCBvZiBjZW50ZXIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gMy4gIlRoZSBTdHJpa2VyIiAtIENsb3NlIHVwIG9yYml0IG9uIGEga2V5IHBvc2l0aW9uCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDguMCwKICAgICAgICAgICAgICAgICAgICB1cGRhdGU6ICh0LCBjYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9jdXMgb24gd2hlcmUgdGhlIExGL1JGIHVzdWFsbHkgc3RhbmRzIChhcHByb3ggKy8tIDEwLCAtMTApCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IG5ldyBUSFJFRS5WZWN0b3IzKC0xMCwgMCwgLTEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSB0ICogMS4wICsgMy41OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gMTAuMDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5wb3NpdGlvbi5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQueCArIE1hdGguY29zKGFuZ2xlKSAqIGRpc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQueSArIDQuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC56ICsgTWF0aC5zaW4oYW5nbGUpICogZGlzdAogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KHRhcmdldC54LCB0YXJnZXQueSArIDEuNSwgdGFyZ2V0LnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyA0LiAiVGhlIEdvYWwiIC0gTG93IEFuZ2xlIGxvb2tpbmcgdXAgYXQgdGhlIG5ldAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiA3LjAsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgLTUsIDMyKTsgLy8gTG93IG5lYXIgZ29hbAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwMiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDgsIDIwKTsgIC8vIFJpc2luZyB1cAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdCgwLCAxNSwgNDUpOyAvLyBMb29rIHVwIGF0IHRoZSBzdHJ1Y3R1cmUKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnJvdGF0aW9uLnogPSAodCAtIDAuNSkgKiAwLjE1OyAvLyBTbGlnaHQgY2luZW1hdGljIHRpbHQKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gNS4gIlRoZSBEaXZlIiAtIFZlcnRpY2FsIGRyb3AgaW50byB0aGUgcG9vbAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiA4LjAsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgNTAsIDApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwMiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEwLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3QgPSB0ICogdCAqICgzIC0gMiAqIHQpOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCBzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5yb3RhdGlvbi56ID0gdCAqIDAuODsgLy8gU3BpcmFsIGRvd24KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9Cl07CiAgICAgICAgfQoKICAgICAgICBfaW5qZWN0U3R5bGVzKCkgewogICAgICAgICAgICBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZsdXgtZHluYW1pYy1zdHlsZXMnKSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgICAgICAgICAgIHN0eWxlLmlkID0gJ2ZsdXgtZHluYW1pYy1zdHlsZXMnOwpzdHlsZS50ZXh0Q29udGVudCA9IGAKICAgICAgICAgICAgICAgIEBrZXlmcmFtZXMgdGV4dFNsYW0gewogICAgICAgICAgICAgICAgICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoNCk7IG9wYWNpdHk6IDA7IGxldHRlci1zcGFjaW5nOiA1MHB4OyB9CiAgICAgICAgICAgICAgICAgICAgMTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IG9wYWNpdHk6IDE7IGxldHRlci1zcGFjaW5nOiA1cHg7IH0KICAgICAgICAgICAgICAgICAgICAxNSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjEpOyB9CiAgICAgICAgICAgICAgICAgICAgMjAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IH0KICAgICAgICAgICAgICAgICAgICA4MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxKTsgb3BhY2l0eTogMTsgZmlsdGVyOiBibHVyKDBweCk7IH0KICAgICAgICAgICAgICAgICAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS41KTsgb3BhY2l0eTogMDsgZmlsdGVyOiBibHVyKDEwcHgpOyB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC5hbm5vdW5jZW1lbnQtc2xhbSB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICAgICAgICAgIHRvcDogNDUlOyBsZWZ0OiA1MCU7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDEwMCU7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnSW1wYWN0Jywgc2Fucy1zZXJpZjsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDk2cHg7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgICAgICAgICAgICAgICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZmZmZiAwJSwgI2ZmZGQwMCA0NSUsICNmZjg4MDAgMTAwJSk7CiAgICAgICAgICAgICAgICAgICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAgICAgICAgICAgICAgICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgICAgICAgICAgICAgICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggcmdiYSgwLDAsMCwxKSkgZHJvcC1zaGFkb3coMCAwIDMwcHggcmdiYSgyNTUsIDEwMCwgMCwgMC42KSk7CiAgICAgICAgICAgICAgICAgICAgei1pbmRleDogMjAwMDsKICAgICAgICAgICAgICAgICAgICBhbmltYXRpb246IHRleHRTbGFtIDEuOHMgY3ViaWMtYmV6aWVyKDAuMSwgMC44LCAwLjEsIDEpIGZvcndhcmRzOwogICAgICAgICAgICAgICAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICAgICAgICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLm1vZGFsLW92ZXJsYXkgewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgY2VudGVyLCByZ2JhKDEwLCAyNSwgNjAsIDAuOTUpIDAlLCByZ2JhKDAsIDAsIDAsIDAuOTgpIDEwMCUpOwogICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7IGp1c3RpZnktY29udGVudDogY2VudGVyOyBhbGlnbi1pdGVtczogY2VudGVyOyBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDE5MDA7CiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMDsgcG9pbnRlci1ldmVudHM6IG5vbmU7IHRyYW5zaXRpb246IG9wYWNpdHkgMC44czsKICAgICAgICAgICAgICAgICAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoOHB4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5tb2RhbC1vdmVybGF5LmFjdGl2ZSB7IG9wYWNpdHk6IDE7IHBvaW50ZXItZXZlbnRzOiBhdXRvOyB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC5tb2RhbC10aXRsZSB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdHYXJhbW9uZCcsIHNlcmlmOwogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogNTJweDsgY29sb3I6ICNmZmY7CiAgICAgICAgICAgICAgICAgICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwYWFmZiwgMCAwIDQwcHggIzAwNDRhYTsKICAgICAgICAgICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAzMHB4OwogICAgICAgICAgICAgICAgICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCAjMDBhYWZmOwogICAgICAgICAgICAgICAgICAgIHBhZGRpbmctYm90dG9tOiAxMHB4OwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiA4MCU7IHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgICAgICAgICBsZXR0ZXItc3BhY2luZzogNXB4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAubW9kYWwtc2NvcmUtY29udGFpbmVyIHsKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBnYXA6IDQwcHg7CiAgICAgICAgICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogNDBweDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5tb2RhbC1zY29yZSB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdJbXBhY3QnLCBzYW5zLXNlcmlmOwogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogODBweDsgY29sb3I6ICNmZmQ3MDA7CiAgICAgICAgICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggI2I4ODYwYjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5tb2RhbC12cyB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdDb3VyaWVyIE5ldycsIG1vbm9zcGFjZTsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDI0cHg7IGNvbG9yOiAjMDBhYWZmOyBvcGFjaXR5OiAwLjc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLmZsYXNoLW92ZXJsYXkgewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDIxMDA7CiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMDsgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjFzIGVhc2Utb3V0OwogICAgICAgICAgICAgICAgICAgIG1peC1ibGVuZC1tb2RlOiBvdmVybGF5OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIEBrZXlmcmFtZXMgY2xhc2hQb3AgewogICAgICAgICAgICAgICAgICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMC41KTsgb3BhY2l0eTogMTsgfQogICAgICAgICAgICAgICAgICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuNSk7IG9wYWNpdHk6IDAuODsgfQogICAgICAgICAgICAgICAgICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgyLjApOyBvcGFjaXR5OiAwOyB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLmNsYXNoLXNwYXJrIHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDYwcHg7IGhlaWdodDogNjBweDsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAjZmZmZmZmIDAlLCAjZmZmZjAwIDQwJSwgdHJhbnNwYXJlbnQgNzAlKTsKICAgICAgICAgICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgICAgICAgICAgICAgICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgICAgICAgICAgICAgei1pbmRleDogMTUwMDsKICAgICAgICAgICAgICAgICAgICBtaXgtYmxlbmQtbW9kZTogc2NyZWVuOwogICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbjogY2xhc2hQb3AgMC4zcyBlYXNlLW91dCBmb3J3YXJkczsKICAgICAgICAgICAgICAgICAgICBib3gtc2hhZG93OiAwIDAgMjBweCAjZmZhYTAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwogICAgICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHN0eWxlKTsKICAgICAgICB9CgogICAgICAgIHJlZ2lzdGVyVGVhbXMoaG9tZVRlYW0sIGF3YXlUZWFtLCBiYWxsKSB7CiAgICAgICAgICAgIHRoaXMudGVhbXMuaG9tZSA9IGhvbWVUZWFtOwogICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkgPSBhd2F5VGVhbTsKdGhpcy5lbnRpdGllcy5iYWxsID0gYmFsbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgTWluaU1hcAogICAgICAgICAgICBpZiAodGhpcy5taW5pTWFwKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1pbmlNYXAuaW5pdChob21lVGVhbSwgYXdheVRlYW0sIGJhbGwpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2luaXRVSSgpIHsKICAgICAgICAgICAgLy8gQmluZCB0byBleGlzdGluZyBIVE1MIGVsZW1lbnRzCiAgICAgICAgICAgIHRoaXMudWkuc2NvcmVQbGF5ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NvcmUtcGxheWVyJyk7CiAgICAgICAgICAgIHRoaXMudWkuc2NvcmVDcHUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NvcmUtY3B1Jyk7CiAgICAgICAgICAgIHRoaXMudWkudGltZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGltZXItZGlzcGxheScpOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGFsZi1pbmRpY2F0b3InKTsKICAgICAgICAgICAgdGhpcy51aS5hbm5vdW5jZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYW5ub3VuY2VtZW50Jyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZWNoLWZsYXNoLW92ZXJsYXknKTsKICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaEZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hTdWIgPSB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC1zdWItdGV4dCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50ZWNoLXRpbWVyLWZpbGwnKTsKdGhpcy51aS50ZWNoVGltZXJGaWxsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnRlY2gtdGltZXItZmlsbCcpOwoKICAgICAgICAgICAgLy8gQmluZCBQbGF5ZXIgU3RhdHVzIFBhbmVsCiAgICAgICAgICAgIC8vIEJpbmQgUGxheWVyIFN0YXR1cyBQYW5lbAogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJyk7CiAgICAgICAgICAgIHRoaXMudWkuc3RhdHVzUGFuZWwubmFtZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC5jaGFyLW5hbWUnKTsKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5ocEJhciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC5ocC1iYXItZmlsbCcpOwogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmhwVGV4dCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC5ocC12YWx1ZScpOwogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmV4cEJhciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC50ZWNoLWJhci1maWxsJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDcmVhdGUgTW9kYWwgT3ZlcmxheQogICAgICAgICAgICB0aGlzLnVpLm1vZGFsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwuY2xhc3NOYW1lID0gJ21vZGFsLW92ZXJsYXknOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmlubmVySFRNTCA9IGAKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXRpdGxlIj5IQUxGIFRJTUU8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXNjb3JlLWNvbnRhaW5lciI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtc2NvcmUiIGlkPSJtb2RhbC1zY29yZS1ob21lIj4wPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtdnMiPi08L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC1zY29yZSIgaWQ9Im1vZGFsLXNjb3JlLWF3YXkiPjA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBpZD0ibW9kYWwtbXNnIiBzdHlsZT0iY29sb3I6ICMwMGFhZmY7IGZvbnQtc2l6ZTogMTRweDsgbGV0dGVyLXNwYWNpbmc6IDJweDsiPlBSRVBBUklORyAyTkQgSEFMRi4uLjwvZGl2PgogICAgICAgICAgICBgOwogICAgICAgICAgICB0aGlzLnVpTGF5ZXIuYXBwZW5kQ2hpbGQodGhpcy51aS5tb2RhbCk7CgogICAgICAgICAgICAvLyBDcmVhdGUgRmxhc2ggT3ZlcmxheQogICAgICAgICAgICB0aGlzLnVpLmZsYXNoID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHRoaXMudWkuZmxhc2guY2xhc3NOYW1lID0gJ2ZsYXNoLW92ZXJsYXknOwogICAgICAgICAgICB0aGlzLnVpTGF5ZXIuYXBwZW5kQ2hpbGQodGhpcy51aS5mbGFzaCk7CgogICAgICAgICAgICAvLyBJbml0aWFsIFN0YXRlCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoKTsKICAgICAgICAgICAgaWYgKHRoaXMudWkudGltZXIpIHRoaXMudWkudGltZXIuaW5uZXJUZXh0ID0gIjAwOjAwIjsKICAgICAgICB9CiAgICAgICAgX3VwZGF0ZVNjb3JlVUkoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnNjb3JlUGxheWVyKSB0aGlzLnVpLnNjb3JlUGxheWVyLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuaG9tZTsKICAgICAgICAgICAgaWYgKHRoaXMudWkuc2NvcmVDcHUpIHRoaXMudWkuc2NvcmVDcHUuaW5uZXJUZXh0ID0gdGhpcy5zY29yZS5hd2F5OwogICAgICAgIH0KCnVwZGF0ZVByYWN0aWNlKGR0KSB7CiAgICAgICAgICAgIC8vIERlbGVnYXRlIGxvZ2ljIHRvIFByYWN0aWNlTWFuYWdlcgogICAgICAgICAgICBpZiAodGhpcy5wcmFjdGljZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewoKaWYgKHRoaXMuc3RhdGUgPT09ICdtZW51JykgewogICAgICAgICAgICAgICAgLy8gLS0tIFBPUFVMQVRFIEFSRU5BIEZPUiBCLVJPTEwgLS0tCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgcGxheWVycyBhcmUgdmlzaWJsZSBhbmQgYW5pbWF0ZWQKICAgICAgICAgICAgICAgIGNvbnN0IGFuaW1hdGVUZWFtID0gKHRlYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRlYW0pIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB0ZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gR2VudGxlIGJvYmJpbmcgdG8gc2ltdWxhdGUgdHJlYWRpbmcgd2F0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi55ID0gcC5ob21lUG9zaXRpb24ueSArIE1hdGguc2luKERhdGUubm93KCkgKiAwLjAwMiArIHAubWVzaC5pZCkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgaWRsZSBhbmltYXRpb24gaXMgcGxheWluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAuc3RhdGUgIT09ICdpZGxlJykgcC5wbGF5KCdpZGxlJywgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLm1peGVyKSBwLm1peGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBhbmltYXRlVGVhbSh0aGlzLnRlYW1zLmhvbWUpOwogICAgICAgICAgICAgICAgYW5pbWF0ZVRlYW0odGhpcy50ZWFtcy5hd2F5KTsKCiAgICAgICAgICAgICAgICAvLyAtLS0gQ0lORU1BVElDIEItUk9MTCAtLS0KICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lbnVTaG90cyAmJiB0aGlzLm1lbnVTaG90cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hvdCA9IHRoaXMubWVudVNob3RzW3RoaXMubWVudVNob3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U2hvdFRpbWVyICs9IGR0OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lbnVTaG90VGltZXIgPj0gc2hvdC5kdXJhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lbnVTaG90VGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lbnVTaG90SW5kZXggPSAodGhpcy5tZW51U2hvdEluZGV4ICsgMSkgJSB0aGlzLm1lbnVTaG90cy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSB0aW1lICgwIHRvIDEpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMubWVudVNob3RUaW1lciAvIHNob3QuZHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3QudXBkYXRlKHQsIHRoaXMuY2FtZXJhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW1iaWVudCBGWCBpbiBNZW51CiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIgJiYgTWF0aC5yYW5kb20oKSA8IDAuMikgewogICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIHJhbmRvbSBidWJibGVzIGZvciBhdG1vc3BoZXJlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFuZ2UgPSA2MDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSpyYW5nZSwgCiAgICAgICAgICAgICAgICAgICAgICAgIC0xMCArIE1hdGgucmFuZG9tKCkqMjAsIAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKnJhbmdlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgcG9zLCB7IGxpZmU6IDMuMCArIE1hdGgucmFuZG9tKCkqMi4wLCBzY2FsZTogMC4zICsgTWF0aC5yYW5kb20oKSowLjQgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVXBkYXRlIEJhY2tncm91bmQgU3lzdGVtcwogICAgICAgICAgICAgICAgaWYgKHRoaXMud2F0ZXJPdmVybGF5KSB0aGlzLndhdGVyT3ZlcmxheS51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubGlnaHRTaGFmdHMpIHRoaXMubGlnaHRTaGFmdHMudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB0aGlzLnBhcnRpY2xlTWFuYWdlci51cGRhdGUoZHQpOwoKICAgICAgICAgICAgICAgIC8vIFJlbmRlcgogICAgICAgICAgICAgICAgaWYgKHRoaXMucmVuZGVyZXIgJiYgdGhpcy5zY2VuZSAmJiB0aGlzLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIucmVuZGVyKHRoaXMuc2NlbmUsIHRoaXMuY2FtZXJhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdhY3RpdmUnKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lTW9kZSA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlUHJhY3RpY2UoZHQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRpbWUgKz0gZHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVGltZXIoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jaGVja0hhbGZUaW1lKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tHb2FscygpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5taW5pTWFwKSB0aGlzLm1pbmlNYXAudXBkYXRlKCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5mbG9hdGluZ1RleHQpIHRoaXMuZmxvYXRpbmdUZXh0LnVwZGF0ZShkdCk7CmlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgdGhpcy5wYXJ0aWNsZU1hbmFnZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIC8vIEdseXBoTWFuYWdlciB1cGRhdGVkIGJ5IG1haW4uanMKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXBkYXRlIFRlY2hjb3B5IFdpbmRvdwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIFVJIEJhcgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hUaW1lckZpbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGN0ID0gTWF0aC5tYXgoMCwgKHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciAvIHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lKSAqIDEwMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9IGAke3BjdH0lYDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbG9yIHNoaWZ0IGJhc2VkIG9uIHVyZ2VuY3kKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBjdCA8IDMwKSB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICcjZmYwMDAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZmZmZmYsICMwMGZmZmYpJzsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZFRlY2hDb3B5V2luZG93KGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBhcnRpY2xlcyhkdCk7CnRoaXMuX3VwZGF0ZVBhcnRpY2xlcyhkdCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIpIHRoaXMuZGVidWdWaXN1YWxpemVyLnVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICBfdXBkYXRlT2Zmc2NyZWVuSW5kaWNhdG9yKCkgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy50ZWFtcy5ob21lID8gdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciA6IG51bGw7CiAgICAgICAgICAgIGNvbnN0IGluZGljYXRvciA9IHRoaXMudWkub2Zmc2NyZWVuSW5kaWNhdG9yOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFwIHx8ICFwLm1lc2ggfHwgIXRoaXMuY2FtZXJhIHx8ICFpbmRpY2F0b3IpIHJldHVybjsKCiAgICAgICAgICAgIC8vIDEuIEdldCBQbGF5ZXIgUG9zaXRpb24gKENlbnRlciBNYXNzKQogICAgICAgICAgICBjb25zdCBwb3MgPSBwLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgcG9zLnkgKz0gMS4wOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDIuIFByb2plY3QgdG8gTm9ybWFsaXplZCBEZXZpY2UgQ29vcmRpbmF0ZXMgKE5EQykgWy0xLCAxXQogICAgICAgICAgICB0aGlzLl90ZW1wVmVjLmNvcHkocG9zKS5wcm9qZWN0KHRoaXMuY2FtZXJhKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDMuIENoZWNrIGlmIEJlaGluZCBDYW1lcmEKICAgICAgICAgICAgY29uc3QgY2FtRndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oY2FtRndkKTsKICAgICAgICAgICAgY29uc3QgdG9QbGF5ZXIgPSBwb3MuY2xvbmUoKS5zdWIodGhpcy5jYW1lcmEucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBjb25zdCBkb3QgPSBjYW1Gd2QuZG90KHRvUGxheWVyKTsKICAgICAgICAgICAgY29uc3QgaXNCZWhpbmQgPSBkb3QgPCAwLjI7IC8vIEJ1ZmZlciB0byBwcmV2ZW50IGZsaXBwaW5nIGF0IGVkZ2UKCiAgICAgICAgICAgIC8vIDQuIENoZWNrIEJvdW5kcwogICAgICAgICAgICBjb25zdCBpc09mZlNjcmVlbiA9ICgKICAgICAgICAgICAgICAgIHRoaXMuX3RlbXBWZWMueCA8IC0wLjkgfHwgdGhpcy5fdGVtcFZlYy54ID4gMC45IHx8CiAgICAgICAgICAgICAgICB0aGlzLl90ZW1wVmVjLnkgPCAtMC45IHx8IHRoaXMuX3RlbXBWZWMueSA+IDAuOSB8fAogICAgICAgICAgICAgICAgaXNCZWhpbmQKICAgICAgICAgICAgKTsKCiAgICAgICAgICAgIGlmIChpc09mZlNjcmVlbikgewogICAgICAgICAgICAgICAgaW5kaWNhdG9yLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgeCA9IHRoaXMuX3RlbXBWZWMueDsKICAgICAgICAgICAgICAgIGxldCB5ID0gdGhpcy5fdGVtcFZlYy55OwoKICAgICAgICAgICAgICAgIC8vIElmIGJlaGluZCwgaW52ZXJ0IGNvb3JkaW5hdGVzIHRvIHBvaW50IGNvcnJlY3RseQogICAgICAgICAgICAgICAgaWYgKGlzQmVoaW5kKSB7CiAgICAgICAgICAgICAgICAgICAgeCA9IC14OwogICAgICAgICAgICAgICAgICAgIHkgPSAteTsKICAgICAgICAgICAgICAgICAgICAvLyBGaXggc2luZ3VsYXJpdHkgaWYgZXhhY3RseSBiZWhpbmQgY2VudGVyCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHgpIDwgMC4wMSAmJiBNYXRoLmFicyh5KSA8IDAuMDEpIHkgPSAtMTsgCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2xhbXAgdG8gc2NyZWVuIGVkZ2VzCiAgICAgICAgICAgICAgICAvLyBXZSB3YW50IHRvIGZpbmQgdGhlIGludGVyc2VjdGlvbiBvZiB0aGUgdmVjdG9yICh4LHkpIHdpdGggdGhlIGJveCBbLTAuOSwgMC45XQogICAgICAgICAgICAgICAgY29uc3QgcGFkZGluZyA9IDAuOTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gTm9ybWFsaXplIHRvIGdldCBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIGNvbnN0IG1hZyA9IE1hdGguc3FydCh4KnggKyB5KnkpOwogICAgICAgICAgICAgICAgY29uc3QgbnggPSB4IC8gbWFnOwogICAgICAgICAgICAgICAgY29uc3QgbnkgPSB5IC8gbWFnOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSYXljYXN0IHRvIGJveCBlZGdlcwogICAgICAgICAgICAgICAgLy8gVmVydGljYWwgZWRnZXM6IHggPSArLy0gcGFkZGluZwogICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCBlZGdlczogeSA9ICsvLSBwYWRkaW5nCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEF2b2lkIGRpdmlkZSBieSB6ZXJvCiAgICAgICAgICAgICAgICBjb25zdCB0eCA9IChNYXRoLmFicyhueCkgPiAwLjAwMSkgPyAobnggPiAwID8gcGFkZGluZyA6IC1wYWRkaW5nKSAvIG54IDogOTk5OwogICAgICAgICAgICAgICAgY29uc3QgdHkgPSAoTWF0aC5hYnMobnkpID4gMC4wMDEpID8gKG55ID4gMCA/IHBhZGRpbmcgOiAtcGFkZGluZykgLyBueSA6IDk5OTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXNlIHRoZSBuZWFyZXN0IGludGVyc2VjdGlvbiAoc21hbGxlc3QgcG9zaXRpdmUgdCkKICAgICAgICAgICAgICAgIC8vIFNpbmNlIHdlIGFyZSBwcm9qZWN0aW5nIGZyb20gY2VudGVyICgwLDApIHRvIChueCxueSksIHQgbXVzdCBiZSBwb3NpdGl2ZS4KICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBNYXRoLm1pbihNYXRoLmFicyh0eCksIE1hdGguYWJzKHR5KSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHNjcmVlblggPSBueCAqIHQ7CiAgICAgICAgICAgICAgICBjb25zdCBzY3JlZW5ZID0gbnkgKiB0OwoKICAgICAgICAgICAgICAgIC8vIENvbnZlcnQgTkRDIHRvIFBpeGVscwogICAgICAgICAgICAgICAgY29uc3Qgd2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICAgICAgICAgIGNvbnN0IGhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgcHggPSAoc2NyZWVuWCAqIDAuNSArIDAuNSkgKiB3aWR0aDsKICAgICAgICAgICAgICAgIGNvbnN0IHB5ID0gKC0oc2NyZWVuWSkgKiAwLjUgKyAwLjUpICogaGVpZ2h0OwoKICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBSb3RhdGlvbgogICAgICAgICAgICAgICAgLy8gQXJyb3cgcG9pbnRzIFVQIGJ5IGRlZmF1bHQuCiAgICAgICAgICAgICAgICAvLyBXZSB3YW50IGl0IHRvIHBvaW50IGluIGRpcmVjdGlvbiAobngsIG55KSBvbiBzY3JlZW4uCiAgICAgICAgICAgICAgICAvLyBTY3JlZW4gWSBpcyBkb3duIChpbnZlcnRlZCBmcm9tIFdlYkdMIFkpLgogICAgICAgICAgICAgICAgLy8gU28gKDAsIDEpIGluIE5EQyBpcyBVUC4gKDAsIC0xKSBpbiBOREMgaXMgRE9XTi4KICAgICAgICAgICAgICAgIC8vIGF0YW4yKHksIHgpIGdpdmVzIGFuZ2xlIGZyb20gK1guCiAgICAgICAgICAgICAgICAvLyBXZSB3YW50IGFuZ2xlIGZyb20gK1kgKFVwKS4KICAgICAgICAgICAgICAgIC8vIFJvdGF0aW9uID0gUEkvMiAtIGFuZ2xlLgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguYXRhbjIobnksIG54KTsKICAgICAgICAgICAgICAgIGNvbnN0IHJvdCA9IChNYXRoLlBJIC8gMikgLSBhbmdsZTsKCiAgICAgICAgICAgICAgICBpbmRpY2F0b3Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgke3B4fXB4LCAke3B5fXB4KSByb3RhdGUoJHtyb3R9cmFkKWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICBpbmRpY2F0b3Iuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVRpbWVyKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkudGltZXIpIHJldHVybjsKICAgICAgICAgICAgLy8gQ2xhbXAgdG8gaGFsZiBkdXJhdGlvbiBmb3IgZGlzcGxheSBpZiB3ZSBnbyBzbGlnaHRseSBvdmVyIGJlZm9yZSB0aWNrCiAgICAgICAgICAgIGNvbnN0IHQgPSBNYXRoLm1pbih0aGlzLnRpbWUsIHRoaXMuaGFsZkR1cmF0aW9uKTsKICAgICAgICAgICAgY29uc3QgbWludXRlcyA9IE1hdGguZmxvb3IodCAvIDYwKTsKICAgICAgICAgICAgY29uc3Qgc2Vjb25kcyA9IE1hdGguZmxvb3IodCAlIDYwKTsKICAgICAgICAgICAgdGhpcy51aS50aW1lci5pbm5lclRleHQgPSBgJHttaW51dGVzLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKX06JHtzZWNvbmRzLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKX1gOwogICAgICAgIH0KICAgICAgICBfY2hlY2tIYWxmVGltZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudGltZSA+PSB0aGlzLmhhbGZEdXJhdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5lbmRIYWxmKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgplbmRIYWxmKCkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2hhbGZ0aW1lJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmhhbGYgPT09IDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dNb2RhbCgiSEFMRiBUSU1FIiwgIlBSRVBBUklORyAyTkQgSEFMRi4uLiIpOwogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZU1vZGFsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydFNlY29uZEhhbGYoKTsKICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRW5kIG9mIDJuZCBIYWxmIG9yIE92ZXJ0aW1lIFBlcmlvZAogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuaG9tZSA9PT0gdGhpcy5zY29yZS5hd2F5KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVElFRCAtIEdvIHRvIE92ZXJ0aW1lIChHb2xkZW4gR29hbCkKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93TW9kYWwoIk9WRVJUSU1FIiwgIkdPTERFTiBHT0FMIFJVTEUgQUNUSVZFIik7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVNb2RhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0T3ZlcnRpbWUoKTsKICAgICAgICAgICAgICAgICAgICB9LCA0MDAwKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV2lubmVyIGRlY2lkZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3RhcnRTZWNvbmRIYWxmKCkgewogICAgICAgICAgICB0aGlzLmhhbGYgPSAyOwogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYuaW5uZXJUZXh0ID0gIjJuZCBIQUxGIjsKICAgICAgICAgICAgdGhpcy5yZXNldFJvdW5kKG51bGwpOyAvLyBOZXV0cmFsIEJsaXR6LW9mZiBmb3IgMm5kIGhhbGYgc3RhcnQKICAgICAgICB9CgogICAgICAgIHN0YXJ0T3ZlcnRpbWUoKSB7CiAgICAgICAgICAgIHRoaXMuaGFsZisrOwogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmlzT3ZlcnRpbWUgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYuaW5uZXJUZXh0ID0gIk9WRVJUSU1FIjsKICAgICAgICAgICAgdGhpcy5yZXNldFJvdW5kKG51bGwpOyAvLyBOZXV0cmFsIEJsaXR6LW9mZgogICAgICAgIH0KCiAgICAgICAgZW5kR2FtZSgpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdnYW1lb3Zlcic7CiAgICAgICAgICAgIGxldCBtc2cgPSAiRFJBVyI7CiAgICAgICAgICAgIGlmICh0aGlzLnNjb3JlLmhvbWUgPiB0aGlzLnNjb3JlLmF3YXkpIG1zZyA9ICJWSUNUT1JZIjsKICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuYXdheSA+IHRoaXMuc2NvcmUuaG9tZSkgbXNnID0gIkRFRkVBVCI7CiAgICAgICAgICAgIAp0aGlzLl9zaG93TW9kYWwobXNnLCAiUFJFU1MgUkVGUkVTSCBUTyBQTEFZIEFHQUlOIik7CiAgICAgICAgICAgIC8vIFN0b3AgTXVzaWMgb24gR2FtZSBPdmVyCiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIuc3RvcEJHTSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE5vIHJlc2V0LCBqdXN0IHN0b3AuCiAgICAgICAgfQoKICAgICAgICBfc2hvd01vZGFsKHRpdGxlLCBzdWJ0ZXh0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy51aS5tb2RhbCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5xdWVyeVNlbGVjdG9yKCcubW9kYWwtdGl0bGUnKS5pbm5lclRleHQgPSB0aXRsZTsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5xdWVyeVNlbGVjdG9yKCcjbW9kYWwtc2NvcmUtaG9tZScpLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuaG9tZTsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5xdWVyeVNlbGVjdG9yKCcjbW9kYWwtc2NvcmUtYXdheScpLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuYXdheTsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5xdWVyeVNlbGVjdG9yKCcjbW9kYWwtbXNnJykuaW5uZXJUZXh0ID0gc3VidGV4dDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudWkubW9kYWwuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIaWRlIEhVRCBlbGVtZW50cwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaHVkLXRvcCcpLnN0eWxlLm9wYWNpdHkgPSAnMCc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJykuc3R5bGUub3BhY2l0eSA9ICcwJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlTW9kYWwoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy51aS5tb2RhbCkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2hvdyBIVUQgZWxlbWVudHMKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKS5zdHlsZS5vcGFjaXR5ID0gJzEnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpLnN0eWxlLm9wYWNpdHkgPSAnMSc7CiAgICAgICAgfQoKX2NoZWNrR29hbHMoKSB7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBwb3MgPSBiYWxsLm1lc2gucG9zaXRpb247CgogICAgICAgICAgICAvLyBQcmVjaXNlIEdvYWwgRGV0ZWN0aW9uCiAgICAgICAgICAgIC8vIFZpc3VhbCBHb2FsIGlzIGF0IFogPSArLy0gMjguCiAgICAgICAgICAgIC8vIFdlIGRlZmluZSBhICJHb2FsIE1vdXRoIiBib3ggbWF0Y2hpbmcgR29hbGllLmpzIChXaWR0aCAxNCwgSGVpZ2h0IDgpLgovLyBXZSBkZWZpbmUgYSAiR29hbCBNb3V0aCIgYm94IG1hdGNoaW5nIHRoZSB2aXN1YWwgbmV0LgogICAgICAgICAgICAvLyBBcmVuYSBSYWRpdXMgaXMgMzIuIEdvYWwgaXMgcm91Z2hseSAyMm0gd2lkZSwgMThtIGhpZ2guCi8vIEFyZW5hIFJhZGl1cyBpcyAzMi4gR29hbCBpcyByb3VnaGx5IDIybSB3aWRlLCAxOG0gaGlnaC4KICAgICAgICAgICAgY29uc3QgaGFsZldpZHRoID0gMTEuMDsgLy8gSW5jcmVhc2VkIHRvIDExIChXaWR0aCAyMikgdG8gY2F0Y2ggY29ybmVycwogICAgICAgICAgICBjb25zdCBoYWxmSGVpZ2h0ID0gOS4wOyAvLyBJbmNyZWFzZWQgdG8gOSAoSGVpZ2h0IDE4KSB0byBjYXRjaCBoaWdoIHNob3RzCiAgICAgICAgICAgIGNvbnN0IGdvYWxZT2Zmc2V0ID0gLTQuNTsgLy8gTW92ZWQgZG93biB0byBtYXRjaCB2aXN1YWwgbW9kZWwgKC00LjVtKQoKICAgICAgICAgICAgY29uc3QgdHJpZ2dlclogPSA0NS4wOyAvLyBUcmlnZ2VyIGVhcmxpZXIgKHdhcyAzMCkgdG8gZW5zdXJlIHJlZ2lzdHJhdGlvbiBiZWZvcmUgYm91bmNlCgogICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnopID4gdHJpZ2dlclopIHsKICAgICAgICAgICAgICAgIC8vIFBSRVZFTlQgT1dOIEdPQUwgQlkgQ0FSUklFUiAoVXNlciBSZXF1ZXN0KQogICAgICAgICAgICAgICAgLy8gSWYgdGhlIGJhbGwgaXMgaGVsZCBieSB0aGUgdGVhbSBkZWZlbmRpbmcgdGhpcyBnb2FsLCBkbyBub3QgY291bnQgaXQuCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIb21lIChTaWRlIDEpIGRlZmVuZHMgK1ouIElmIHBvcy56ID4gMCAoSG9tZSBHb2FsKSBhbmQgaG9sZGVyIGlzIEhvbWUsIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPiAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gMSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIC8vIEF3YXkgKFNpZGUgLTEpIGRlZmVuZHMgLVouIElmIHBvcy56IDwgMCAoQXdheSBHb2FsKSBhbmQgaG9sZGVyIGlzIEF3YXksIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gLTEpIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyLiBDaGVjayBGcmFtZSAoTXVzdCBiZSB3aXRoaW4gd2lkdGgvaGVpZ2h0KQovLyAyLiBDaGVjayBGcmFtZSAoTXVzdCBiZSB3aXRoaW4gd2lkdGgvaGVpZ2h0LCBhY2NvdW50aW5nIGZvciBZIG9mZnNldCkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueCkgPD0gaGFsZldpZHRoICYmIE1hdGguYWJzKHBvcy55IC0gZ29hbFlPZmZzZXQpIDw9IGhhbGZIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ29hbFNjb3JlZCgnaG9tZScpOyAvLyBIb21lIGF0dGFja3MgLVoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdvYWxTY29yZWQoJ2F3YXknKTsgLy8gQXdheSBhdHRhY2tzICtaCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKZ29hbFNjb3JlZChzY29yZXIpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJTVBBQ1QgRlJBTUU6IEdPQUwKdGhpcy50cmlnZ2VySW1wYWN0KDAuNCwgJ3NoYXR0ZXInKTsgLy8gTWFzc2l2ZSBmcmVlemUgZm9yIGdvYWwKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFWFAgUkVXQVJEOiBHb2FsCiAgICAgICAgICAgIC8vIEZpbmQgd2hvIHNjb3JlZCAoTGFzdCBob2xkZXIgb2YgYmFsbCkKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5sYXN0SG9sZGVyICYmIGJhbGwubGFzdEhvbGRlci50ZWFtLmlkID09PSBzY29yZXIpIHsKICAgICAgICAgICAgICAgIGJhbGwubGFzdEhvbGRlci5nYWluRXhwKDEwKTsKICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBBc3Npc3QgbG9naWMgY291bGQgZ28gaGVyZSAodHJhY2sgbGFzdEhvbGRlci5sYXN0UGFzc2VyPykKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdnb2FsJzsKICAgICAgICAgICAgdGhpcy5zY29yZVtzY29yZXJdKys7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoKTsKICAgICAgICAgICAgCi8vIDEuIFZJU0NFUkFMIFNIQUtFICYgUEFSVElDTEVTCiAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgyLjApOyAvLyBIZWF2eSBzaGFrZQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlciAmJiB0aGlzLmVudGl0aWVzLmJhbGwgJiYgdGhpcy5lbnRpdGllcy5iYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxQb3MgPSB0aGlzLmVudGl0aWVzLmJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgLy8gTWFzc2l2ZSBHb2FsIEV4cGxvc2lvbgogICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIGdvYWxQb3MsIHsgc2NhbGU6IDE1LjAsIGxpZmU6IDAuOCB9KTsKICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIGdvYWxQb3MsIHsgc2NhbGU6IDEwLjAgfSk7CiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzMDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2RlYnJpcycsIGdvYWxQb3MsIHsgc2NhbGU6IDAuOCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyAyLiBTQ1JFRU4gRkxBU0gKICAgICAgICAgICAgaWYgKHRoaXMudWkuZmxhc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuZmxhc2guc3R5bGUub3BhY2l0eSA9ICcwLjgnOwogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IHRoaXMudWkuZmxhc2guc3R5bGUub3BhY2l0eSA9ICcwJzsgfSwgMTAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gR09MREVOIEdPQUwgQ0hFQ0sKICAgICAgICAgICAgaWYgKHRoaXMuaXNPdmVydGltZSkgewogICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJHT0xERU4gR09BTCEiLCAnc2xhbScpOwogICAgICAgICAgICAgICAgLy8gRW5kIGdhbWUgYWZ0ZXIgc2hvcnQgZGVsYXkKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuZW5kR2FtZSgpOwogICAgICAgICAgICAgICAgfSwgMzAwMCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIFNMQU0gQU5OT1VOQ0VNRU5UIChOb3JtYWwpCiAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiR09BTCEiLCAnc2xhbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgc2VxdWVuY2UKICAgICAgICAgICAgLy8gU2NvcmVkLXVwb24gdGVhbSBnZXRzIGJhbGwKICAgICAgICAgICAgY29uc3QgbG9zZXIgPSBzY29yZXIgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZBU1RFUiBGTE9XOiBSZWR1Y2VkIGRlbGF5IGZyb20gMzAwMG1zIHRvIDEyMDBtcwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChsb3Nlcik7CiAgICAgICAgICAgIH0sIDIwMDApOyAvLyBTbGlnaHRseSBsb25nZXIgdG8gYXBwcmVjaWF0ZSB0aGUgIkdPQUwiIHNsYW0KICAgICAgICB9CgpzaG93QW5ub3VuY2VtZW50KHRleHQsIHR5cGUgPSAnbm9ybWFsJywgZHVyYXRpb24gPSAyMDAwKSB7CiAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5hbm5vdW5jZW1lbnQ7CiAgICAgICAgICAgIGlmICghZWwpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENsZWFyIHByZXZpb3VzIHRpbWVvdXQKICAgICAgICAgICAgaWYgKHRoaXMuX2Fubm91bmNlVGltZW91dCkgewogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX2Fubm91bmNlVGltZW91dCk7CiAgICAgICAgICAgICAgICB0aGlzLl9hbm5vdW5jZVRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBBbmltYXRpb24gYnkgY2xvbmluZwogICAgICAgICAgICBjb25zdCBuZXdFbCA9IGVsLmNsb25lTm9kZSh0cnVlKTsKICAgICAgICAgICAgZWwucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQobmV3RWwsIGVsKTsKICAgICAgICAgICAgdGhpcy51aS5hbm5vdW5jZW1lbnQgPSBuZXdFbDsKCiAgICAgICAgICAgIG5ld0VsLmlubmVyVGV4dCA9IHRleHQ7CiAgICAgICAgICAgIG5ld0VsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgQ2xhc3MgYmFzZWQgb24gdHlwZQogICAgICAgICAgICBuZXdFbC5jbGFzc05hbWUgPSAnJzsgLy8gUmVzZXQgY2xhc3NlcwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3NsYW0nKSB7CiAgICAgICAgICAgICAgICBuZXdFbC5jbGFzc0xpc3QuYWRkKCdhbm5vdW5jZW1lbnQtc2xhbScpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRGVmYXVsdCBzdHlsZQogICAgICAgICAgICAgICAgbmV3RWwuc3R5bGUuYW5pbWF0aW9uID0gJ25vbmUnOwogICAgICAgICAgICAgICAgbmV3RWwub2Zmc2V0SGVpZ2h0OyAvKiB0cmlnZ2VyIHJlZmxvdyAqLwogICAgICAgICAgICAgICAgbmV3RWwuc3R5bGUuYW5pbWF0aW9uID0gJ2Fubm91bmNlU2xpZGUgMC41cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSknOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBdXRvLWhpZGUKICAgICAgICAgICAgaWYgKGR1cmF0aW9uID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fYW5ub3VuY2VUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlQW5ub3VuY2VtZW50KCk7CiAgICAgICAgICAgICAgICB9LCBkdXJhdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGhpZGVBbm5vdW5jZW1lbnQoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLmFubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgdGhpcy51aS5hbm5vdW5jZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCnJlc2V0Um91bmQocG9zc2Vzc2lvblRlYW1JZCkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ3Jlc2V0JzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IEJhbGwKICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCkgdGhpcy5lbnRpdGllcy5iYWxsLnJlc2V0KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCBUZWFtcwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBiYWxsIGhvbGRlcgogICAgICAgICAgICBpZiAodGhpcy5lbnRpdGllcy5iYWxsKSB0aGlzLmVudGl0aWVzLmJhbGwuZHJvcCgpOwoKICAgICAgICAgICAgLy8gQ1JJVElDQUw6IFNuYXAgY2FtZXJhIHRvIHByZXZlbnQgZGlzb3JpZW50YXRpb24KICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gRm9yY2UgdXBkYXRlIHRhcmdldCBmaXJzdCAodXN1YWxseSBiYWxsKQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCAmJiB0aGlzLmVudGl0aWVzLmJhbGwubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQodGhpcy5lbnRpdGllcy5iYWxsLm1lc2gsIHRoaXMuZW50aXRpZXMuYmFsbC52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGQVNURVIgRkxPVzogUmVkdWNlZCBkZWxheSBmcm9tIDIwMDBtcyB0byAxMDBtcwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRLaWNrb2ZmKHBvc3Nlc3Npb25UZWFtSWQpOwp9LCAxMDApOwogICAgICAgIH0KCiAgICAgICAgc3RhcnRLaWNrb2ZmKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdraWNrb2ZmJzsKICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJCTElUWiBPRkYhIiwgJ3NsYW0nKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElmIGEgdGVhbSBoYXMgcG9zc2Vzc2lvbiAoYWZ0ZXIgZ29hbCksIGdpdmUgdG8gTUYKICAgICAgICAgICAgaWYgKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRlYW0gPSB0aGlzLnRlYW1zW3Bvc3Nlc3Npb25UZWFtSWRdOwogICAgICAgICAgICAgICAgaWYgKHRlYW0pIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtZiA9IHRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgICAgICAgICBpZiAobWYgJiYgdGhpcy5lbnRpdGllcy5iYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW50aXRpZXMuYmFsbC5ncmFiKG1mKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENSSVRJQ0FMOiBTbmFwIGNhbWVyYSB0byBuZXcgaG9sZGVyIHRvIHByZXZlbnQgc3dpbmcvZGlzb3JpZW50YXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldChtZi5tZXNoLCBtZi52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOZXV0cmFsIGtpY2tvZmYgLSBlbnN1cmUgY2FtZXJhIGlzIHNuYXBwZWQgdG8gY2VudGVyIGJhbGwKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIgJiYgdGhpcy5lbnRpdGllcy5iYWxsICYmIHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldCh0aGlzLmVudGl0aWVzLmJhbGwubWVzaCwgdGhpcy5lbnRpdGllcy5iYWxsLnZlbG9jaXR5KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZBU1RFUiBGTE9XOiBSZWR1Y2VkIGRlbGF5IGZyb20gMTAwMG1zIHRvIDgwMG1zCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5oaWRlQW5ub3VuY2VtZW50KCk7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2FjdGl2ZSc7CiAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgfQogICAgICAgIAovLyBJbml0aWFsIHN0YXJ0CiAgICAgICAgc3RhcnRNYXRjaChtb2RlID0gJ25vcm1hbCcpIHsKICAgICAgICAgICAgdGhpcy5nYW1lTW9kZSA9IG1vZGU7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJTdGFydGluZyBNYXRjaCBpbiBtb2RlOiIsIG1vZGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhcnQgTXVzaWMKICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IFNjb3JlCnRoaXMuc2NvcmUuaG9tZSA9IDA7CiAgICAgICAgICAgIHRoaXMuc2NvcmUuYXdheSA9IDA7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IFRpbWUKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5oYWxmID0gMTsKICAgICAgICAgICAgaWYgKHRoaXMudWkuaGFsZikgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICIxc3QiOwogICAgICAgICAgICAKaWYgKG1vZGUgPT09ICdwcmFjdGljZScpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiUFJBQyI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyLnN0YXJ0KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSW4gcHJhY3RpY2UsIGVuc3VyZSBBSSBpcyBlbmFibGVkIGZvciBzcGFycmluZwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5haUVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBQcmFjdGljZSBNYW5hZ2VyIGlzIHN0b3BwZWQgaWYgbm9ybWFsIGdhbWUKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgdGhpcy5wcmFjdGljZU1hbmFnZXIuc3RvcCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTYWZldHk6IEVuc3VyZSBhbGwgcGxheWVycyBhcmUgdmlzaWJsZSAoaW4gY2FzZSBQcmFjdGljZSBoaWQgdGhlbSkKICAgICAgICAgICAgICAgIC8vIEFuZCBGT1JDRSBBSSBFTkFCTEVEIChGaXggZm9yICJab21iaWVzIiBpZiBjb21pbmcgZnJvbSBQcmFjdGljZSBNb2RlKQogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7IGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSB0cnVlOyB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gdHJ1ZTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7IH0pOwogICAgICAgICAgICAgICAgfQoKdGhpcy5yZXNldFJvdW5kKCk7CiAgICAgICAgICAgIH0KfQoKc2V0TWVudU1vZGUoaXNBY3RpdmUpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGlzQWN0aXZlID8gJ21lbnUnIDogJ2FjdGl2ZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaXNBY3RpdmUgJiYgdGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnN0b3BCR00oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBIVUQgaW4gbWVudQogICAgICAgICAgICBjb25zdCBodWRUb3AgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaHVkLXRvcCcpOwogICAgICAgICAgICBjb25zdCBzdGF0dXNQYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJyk7CiAgICAgICAgICAgIGNvbnN0IGNvbnRyb2xzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1jb250YWluZXInKTsKICAgICAgICAgICAgY29uc3Qgam95c3RpY2sgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2staGl0LXpvbmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRpc3BsYXkgPSBpc0FjdGl2ZSA/ICdub25lJyA6ICdmbGV4JzsgLy8gb3IgYmxvY2svZXRjCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaHVkVG9wKSBodWRUb3Auc3R5bGUuZGlzcGxheSA9IGRpc3BsYXk7CiAgICAgICAgICAgIGlmIChzdGF0dXNQYW5lbCkgc3RhdHVzUGFuZWwuc3R5bGUuZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2Jsb2NrJzsgLy8gU3RhdHVzIHBhbmVsIGhhcyBzcGVjaWZpYyBsb2dpYwogICAgICAgICAgICBpZiAoY29udHJvbHMpIGNvbnRyb2xzLnN0eWxlLmRpc3BsYXkgPSBpc0FjdGl2ZSA/ICdub25lJyA6ICdmbGV4JzsKICAgICAgICAgICAgaWYgKGpveXN0aWNrKSBqb3lzdGljay5zdHlsZS5kaXNwbGF5ID0gaXNBY3RpdmUgPyAnbm9uZScgOiAnYmxvY2snOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgZW50ZXJpbmcgbWVudSwgcmVzZXQgY2FtZXJhIHRvIGEgbmljZSBhbmdsZT8KICAgICAgICAgICAgLy8gSGFuZGxlZCBieSB1cGRhdGUgbG9vcAogICAgICAgIH0KdG9nZ2xlRGVtb01vZGUoKSB7CiAgICAgICAgICAgIHRoaXMuaXNEZW1vTW9kZSA9ICF0aGlzLmlzRGVtb01vZGU7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJEZW1vIE1vZGU6IiwgdGhpcy5pc0RlbW9Nb2RlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBVSSBCdXR0b24KICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F1dG8tdG9nZ2xlJyk7CiAgICAgICAgICAgIGlmIChidG4pIHsKICAgICAgICAgICAgICAgIGJ0bi5pbm5lclRleHQgPSB0aGlzLmlzRGVtb01vZGUgPyAiQVVUTyBQSUxPVCIgOiAiTUFOVUFMIjsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzRGVtb01vZGUpIHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSB0aGlzLmlzRGVtb01vZGUgPyAiQVVUTyBQSUxPVCIgOiAiTUFOVUFMIjsKICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KHRleHQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIEZsYWlyOiBTcGF3biB0ZXh0IGFib3ZlIGFjdGl2ZSBwbGF5ZXIKICAgICAgICAgICAgaWYgKHRoaXMuaXNEZW1vTW9kZSAmJiB0aGlzLmZsb2F0aW5nVGV4dCAmJiB0aGlzLnRlYW1zLmhvbWUgJiYgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciAmJiB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKCJBSSBFTkdBR0VEIiwgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllci5tZXNoLnBvc2l0aW9uLCAiZ29hbCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBdXRvLWhpZGUgYW5ub3VuY2VtZW50CnNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkuYW5ub3VuY2VtZW50ICYmIHRoaXMudWkuYW5ub3VuY2VtZW50LmlubmVyVGV4dCA9PT0gdGV4dCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBURUNIQ09QWSBTWVNURU0gLS0tCgogICAgICAgIHRyaWdnZXJUZWNoRXZlbnQoc291cmNlUGxheWVyLCB0ZWNoTmFtZSkgewogICAgICAgICAgICBpZiAoIXNvdXJjZVBsYXllciB8fCAhc291cmNlUGxheWVyLnRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIC8vIEZpbmQgb3Bwb3NpbmcgdGVhbQogICAgICAgICAgICBjb25zdCBvcHBUZWFtSWQgPSBzb3VyY2VQbGF5ZXIudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gdGhpcy50ZWFtc1tvcHBUZWFtSWRdOwogICAgICAgICAgICBpZiAoIW9wcFRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIC8vIEZpbmQgd2hvIGlzIG1hcmtpbmcgdGhpcyBzb3VyY2UKICAgICAgICAgICAgY29uc3QgbGVhcm5lcnMgPSBvcHBUZWFtLnBsYXllcnMuZmlsdGVyKHAgPT4gcC5tYXJraW5nID09PSBzb3VyY2VQbGF5ZXIpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGxlYXJuZXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gT25seSBzaG93IFVJIGlmIHRoZSBsZWFybmluZyB0ZWFtIGlzIEh1bWFuIChIb21lKQogICAgICAgICAgICAvLyAoT3IgaWYgd2UgYXJlIGluIERlbW8gbW9kZSBhbmQgd2FudCB0byBzZWUgaXQgaGFwcGVuIGZvciBIb21lIHRlYW0pCiAgICAgICAgICAgIGlmIChvcHBUZWFtLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIC8vIEZpbHRlciBvdXQgdGhvc2Ugd2hvIGFscmVhZHkga25vdyBpdAogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRMZWFybmVycyA9IGxlYXJuZXJzLmZpbHRlcihwID0+ICFwLmxlYXJuZWRUZWNocy5pbmNsdWRlcyh0ZWNoTmFtZSkpOwogICAgICAgICAgICAgICAgaWYgKHZhbGlkTGVhcm5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRUZWNoQ29weVdpbmRvdyh0ZWNoTmFtZSwgdmFsaWRMZWFybmVycyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzdGFydFRlY2hDb3B5V2luZG93KHRlY2hOYW1lLCBsZWFybmVycykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLm1heFRpbWUgPSAwLjY7IC8vIDAuNnMgd2luZG93CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciA9IHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUudGVjaCA9IHRlY2hOYW1lOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUubGVhcm5lcnMgPSBsZWFybmVyczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNob3cgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaEZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoRmxhc2guc3R5bGUuYmFja2dyb3VuZCA9ICIiOyAvLyBSZXNldCBiYWNrZ3JvdW5kCiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlRFQ0hDT1BZISI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hTdWIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hTdWIuaW5uZXJUZXh0ID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IGJhcgogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaFRpbWVyRmlsbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9ICcxMDAlJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmF0dGVtcHRUZWNoQ29weSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdWNjZXNzIQogICAgICAgICAgICBjb25zdCB0ZWNoID0gdGhpcy50ZWNoQ29weVN0YXRlLnRlY2g7CiAgICAgICAgICAgIGNvbnN0IGxlYXJuZXJzID0gdGhpcy50ZWNoQ29weVN0YXRlLmxlYXJuZXJzOwogICAgICAgICAgICAKICAgICAgICAgICAgbGVhcm5lcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIC8vIERvdWJsZSBjaGVjayB0byBwcmV2ZW50IGR1cGxpY2F0ZXMKICAgICAgICAgICAgICAgIGlmICghcC5sZWFybmVkVGVjaHMuaW5jbHVkZXModGVjaCkpIHsKICAgICAgICAgICAgICAgICAgICBwLmxlYXJuZWRUZWNocy5wdXNoKHRlY2gpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3Aucm9sZX0gbGVhcm5lZCAke3RlY2h9IWApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDEuIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5mbG9hdGluZ1RleHQgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKGBMRUFSTkVEIWAsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gUGFydGljbGUgRWZmZWN0IChTcGlyYWwpCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biBtdWx0aXBsZSBwYXJ0aWNsZXMgZm9yIGEgc3dpcmwgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDEwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGkgKiA1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5lbmRUZWNoQ29weVdpbmRvdyh0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKZW5kVGVjaENvcHlXaW5kb3coc3VjY2VzcykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlNVQ0NFU1MhIjsKICAgICAgICAgICAgICAgICAgICAvLyBGbGFzaCBzdWNjZXNzIGNvbG9yIChXaGl0ZSBmbGFzaCkKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5iYWNrZ3JvdW5kID0gInJnYmEoMjU1LCAyNTUsIDI1NSwgMC44KSI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSGlkZSBhZnRlciBzaG9ydCBkZWxheSB0byBzaG93IHRoZSBzdWNjZXNzIGZsYXNoCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOyAKICAgICAgICAgICAgICAgICAgICB9LCAzMDApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBGYWlsZWQgLyBNaXNzZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQpfdXBkYXRlUGxheWVyU3RhdHVzVUkoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtcy5ob21lIHx8ICF0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBwID0gdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgdWkgPSB0aGlzLnVpLnN0YXR1c1BhbmVsOwogICAgICAgICAgICAKLy8gVUkgVXBkYXRlcyAoQWN0aW9uIEJ1dHRvbiBDb250ZXh0KQogICAgICAgICAgICAgICAgdWkuY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOYW1lICYgTGV2ZWwKICAgICAgICAgICAgICAgIGlmICh1aS5uYW1lKSB1aS5uYW1lLmlubmVyVGV4dCA9IGAke3AuY2hhcmFjdGVyTmFtZSB8fCBwLnJvbGV9IExWJHtwLmxldmVsfWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEhQCiAgICAgICAgICAgICAgICBpZiAodWkuaHBCYXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBocFBjdCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEwMCwgKHAuc3RhdHMuSFAgLyBwLnN0YXRzLm1heEhQKSAqIDEwMCkpOwogICAgICAgICAgICAgICAgICAgIHVpLmhwQmFyLnN0eWxlLndpZHRoID0gYCR7aHBQY3R9JWA7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29sb3Igc2hpZnQKICAgICAgICAgICAgICAgICAgICBpZiAoaHBQY3QgPCAyNSkgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAwMDAsICNmZjQ0NDQpJzsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChocFBjdCA8IDUwKSB1aS5ocEJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmYwMCwgI2ZmZmY4OCknOwogICAgICAgICAgICAgICAgICAgIGVsc2UgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwMGZmMDAsICNjY2ZmY2MpJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1aS5ocFRleHQpIHVpLmhwVGV4dC5pbm5lclRleHQgPSBgJHtNYXRoLmZsb29yKHAuc3RhdHMuSFApfS8ke3Auc3RhdHMubWF4SFB9YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRVhQCiAgICAgICAgICAgICAgICBpZiAodWkuZXhwQmFyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwUGN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMTAwLCAocC5leHAgLyBwLm5leHRMZXZlbEV4cCkgKiAxMDApKTsKICAgICAgICAgICAgICAgICAgICB1aS5leHBCYXIuc3R5bGUud2lkdGggPSBgJHtleHBQY3R9JWA7CnVpLmV4cEJhci5zdHlsZS53aWR0aCA9IGAke2V4cFBjdH0lYDsKICAgICAgICAgICAgICAgIH0KICAgICAgICB9CgpfaW5pdFBhcnRpY2xlcygpIHsKICAgICAgICAgICAgdGhpcy5hY3RpdmVTcGFya3MgPSBbXTsKICAgICAgICAgICAgdGhpcy5zcGFya1Bvb2wgPSBbXTsKICAgICAgICAgICAgY29uc3QgcG9vbFNpemUgPSA0MDsgLy8gU3VmZmljaWVudCBmb3IgY29udGludW91cyBncmluZGluZwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb29sU2l6ZTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSBuZXcgVEhSRUUuU3ByaXRlKF9zcGFya01hdGVyaWFsLmNsb25lKCkpOwogICAgICAgICAgICAgICAgc3ByaXRlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHNwcml0ZSk7CiAgICAgICAgICAgICAgICB0aGlzLnNwYXJrUG9vbC5wdXNoKHNwcml0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNwYXduQ2xhc2gocG9zLCBpbnRlbnNpdHkgPSAxLjApIHsKICAgICAgICAgICAgLy8gRmluZCBmcmVlIHNwYXJrCiAgICAgICAgICAgIGNvbnN0IHNwYXJrID0gdGhpcy5zcGFya1Bvb2wuZmluZChzID0+ICFzLnZpc2libGUpOwogICAgICAgICAgICBpZiAoIXNwYXJrKSByZXR1cm47IC8vIFBvb2wgZXhoYXVzdGVkCiAgICAgICAgICAgIAogICAgICAgICAgICBzcGFyay5wb3NpdGlvbi5jb3B5KHBvcyk7CiAgICAgICAgICAgIHNwYXJrLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmFuZG9taXplIHJvdGF0aW9uCiAgICAgICAgICAgIHNwYXJrLm1hdGVyaWFsLnJvdGF0aW9uID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsaXplIEFjdGl2ZSBTdGF0ZQogICAgICAgICAgICB0aGlzLmFjdGl2ZVNwYXJrcy5wdXNoKHsKICAgICAgICAgICAgICAgIG1lc2g6IHNwYXJrLAogICAgICAgICAgICAgICAgYWdlOiAwLAogICAgICAgICAgICAgICAgbGlmZTogMC4xNSArIE1hdGgucmFuZG9tKCkgKiAwLjE1LCAvLyBGYXN0LCBwdW5jaHkgc3BhcmtzCiAgICAgICAgICAgICAgICBtYXhTY2FsZTogMi41ICogaW50ZW5zaXR5LAogICAgICAgICAgICAgICAgdmVsb2NpdHk6IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqOCwgCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSo4LCAKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKjgKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlUGFydGljbGVzKGR0KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmFjdGl2ZVNwYXJrcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuYWN0aXZlU3BhcmtzW2ldOwogICAgICAgICAgICAgICAgcC5hZ2UgKz0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChwLmFnZSA+PSBwLmxpZmUpIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlU3BhcmtzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgdCA9IHAuYWdlIC8gcC5saWZlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBFeHBhbmQKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRTY2FsZSA9IDAuNSArIChwLm1heFNjYWxlIC0gMC41KSAqIHQ7CiAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKGN1cnJlbnRTY2FsZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZhZGUgb3V0CiAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IDEuMCAtICh0ICogdCk7IC8vIFF1YWRyYXRpYyBmYWRlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE1vdmUKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5hZGRTY2FsZWRWZWN0b3IocC52ZWxvY2l0eSwgZHQpOwogICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLnJvdGF0aW9uICs9IDEwLjAgKiBkdDsKICAgICAgICAgICAgfQogICAgICAgIH0KCi8vIEhlbHBlciBmb3IgaW1wYWN0IGZyYW1lcwoKdHJpZ2dlckltcGFjdChkdXJhdGlvbiwgdHlwZSA9ICdkZWZhdWx0JykgewogICAgICAgICAgICB0aGlzLmltcGFjdFBhdXNlID0gZHVyYXRpb247CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKICAgICAgICAgICAgaWYgKCFjb250YWluZXIpIHJldHVybjsKCiAgICAgICAgICAgIC8vIFJlc2V0IGNsYXNzZXMgdG8gZW5zdXJlIGFuaW1hdGlvbiByZXN0YXJ0cwogICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZSgnaW1wYWN0LWZ4JywgJ2ltcGFjdC1oZWF2eScsICdpbXBhY3Qtc2hhdHRlcicpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRm9yY2UgcmVmbG93CiAgICAgICAgICAgIHZvaWQgY29udGFpbmVyLm9mZnNldFdpZHRoOwoKICAgICAgICAgICAgbGV0IGNsYXNzTmFtZSA9ICdpbXBhY3QtZngnOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2hlYXZ5JykgY2xhc3NOYW1lID0gJ2ltcGFjdC1oZWF2eSc7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnc2hhdHRlcicpIGNsYXNzTmFtZSA9ICdpbXBhY3Qtc2hhdHRlcic7CgogICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LmFkZChjbGFzc05hbWUpOwoKICAgICAgICAgICAgLy8gQXV0by1yZW1vdmUgY2xhc3MgYWZ0ZXIgZHVyYXRpb24KICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpOwogICAgICAgICAgICB9LCBkdXJhdGlvbiAqIDEwMDAgKyAxMDApOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5HYW1lTWFuYWdlciA9IEdhbWVNYW5hZ2VyOwp9KSgpOw==","/GameManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFNwYXJrIFRleHR1cmUgKFByb2NlZHVyYWwgQnVyc3QpCiAgICBjb25zdCBfc3BhcmtUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw2NCw2NCk7CiAgICAgICAgCiAgICAgICAgLy8gQnVyc3Qgc2hhcGUKICAgICAgICBjb25zdCBjeCA9IDMyLCBjeSA9IDMyOwogICAgICAgIGNvbnN0IHNwaWtlcyA9IDg7CiAgICAgICAgY29uc3Qgb3V0ZXIgPSAzMDsKICAgICAgICBjb25zdCBpbm5lciA9IDEwOwogICAgICAgIAogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBmb3IobGV0IGk9MDsgaTxzcGlrZXMqMjsgaSsrKXsKICAgICAgICAgICAgY29uc3QgciA9IChpJTI9PT0wKT8gb3V0ZXIgOiBpbm5lcjsKICAgICAgICAgICAgY29uc3QgYSA9IChNYXRoLlBJKmkpL3NwaWtlczsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKnIsIGN5ICsgTWF0aC5zaW4oYSkqcik7CiAgICAgICAgfQogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmNjMDAnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgLy8gV2hpdGUgQ29yZQogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHguYXJjKGN4LCBjeSwgOCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjb25zdCBfc3BhcmtNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IAogICAgICAgIG1hcDogX3NwYXJrVGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBHYW1lTWFuYWdlciB7CgogICAgICAgIApjb25zdHJ1Y3RvcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEsIHJlbmRlcmVyKSB7CndpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIgPSByZW5kZXJlcjsgLy8gU3RvcmUgcmVuZGVyZXIKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmNhbWVyYSA9IGNhbWVyYTsKICAgICAgICAgICAgdGhpcy51aUxheWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodWlMYXllcklkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc2NvcmUgPSB7IGhvbWU6IDAsIGF3YXk6IDAgfTsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5oYWxmID0gMTsKICAgICAgICAgICAgdGhpcy5oYWxmRHVyYXRpb24gPSAzMDA7IC8vIDUgbWludXRlcyAoc2Vjb25kcykKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNEZW1vTW9kZSA9IGZhbHNlOwp0aGlzLmdhbWVNb2RlID0gJ25vcm1hbCc7IC8vICdub3JtYWwnIG9yICdwcmFjdGljZScKICAgICAgICAgICAgdGhpcy5pc0ZvcmdlTW9kZSA9IGZhbHNlOyAvLyBBc3NldCBGb3JnZSBTdGF0ZQogICAgICAgICAgICAvLyBJbXBhY3QgRnJhbWVzCiAgICAgICAgICAgIHRoaXMuaW1wYWN0UGF1c2UgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsgLy8gU3RhcnQgaW4gbWVudQp0aGlzLnRlYW1zID0gewogICAgICAgICAgICAgICAgaG9tZTogbnVsbCwKICAgICAgICAgICAgICAgIGF3YXk6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZW50aXRpZXMgPSB7CiAgICAgICAgICAgICAgICBiYWxsOiBudWxsCiAgICAgICAgICAgIH07Cgp0aGlzLnVpID0gewogICAgICAgICAgICAgICAgc2NvcmVQbGF5ZXI6IG51bGwsCiAgICAgICAgICAgICAgICBzY29yZUNwdTogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWVyOiBudWxsLAogICAgICAgICAgICAgICAgaGFsZjogbnVsbCwKICAgICAgICAgICAgICAgIGFubm91bmNlbWVudDogbnVsbCwKICAgICAgICAgICAgICAgIC8vIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgICAgIHN0YXR1c1BhbmVsOiB7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyOiBudWxsLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBCYXI6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBUZXh0OiBudWxsLAogICAgICAgICAgICAgICAgICAgIGV4cEJhcjogbnVsbAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVGVjaGNvcHkgU3RhdGUKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHRpbWVyOiAwLAogICAgICAgICAgICAgICAgdGVjaDogbnVsbCwKICAgICAgICAgICAgICAgIGxlYXJuZXJzOiBbXQogICAgICAgICAgICB9OwoKdGhpcy5taW5pTWFwID0gbmV3IHdpbmRvdy5mbHV4Lk1pbmlNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgRmxvYXRpbmcgVGV4dAovLyBJbml0aWFsaXplIEZsb2F0aW5nIFRleHQKdGhpcy5mbG9hdGluZ1RleHQgPSBuZXcgd2luZG93LmZsdXguRmxvYXRpbmdUZXh0TWFuYWdlcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBVSSBjYWxjdWxhdGlvbnMKICAgICAgICAgICAgdGhpcy5fdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIFBhcnRpY2xlIE1hbmFnZXIgKFN0YXR1cyBFZmZlY3RzKQogICAgICAgICAgICAKLy8gSW5pdGlhbGl6ZSBQYXJ0aWNsZSBNYW5hZ2VyIChTdGF0dXMgRWZmZWN0cykKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyKHNjZW5lKTsKdGhpcy5nbHlwaE1hbmFnZXIgPSBudWxsOyAvLyBJbmplY3RlZCBieSBtYWluLmpzCiAgICAgICAgICAgIHRoaXMuX2luaXRQYXJ0aWNsZXMoKTsgLy8gM0QgU3BhcmsgU3lzdGVtIChMZWdhY3kvSW1wYWN0KQoKdGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIgPSBuZXcgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyKHNjZW5lKTsKICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyKHRoaXMpOyAvLyBJbml0aWFsaXplIFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgdGhpcy5faW5qZWN0U3R5bGVzKCk7CnRoaXMuX2luaXRVSSgpOwogICAgICAgIH0KCl9pbml0Q2luZW1hdGljcygpIHsKICAgICAgICAgICAgdGhpcy5tZW51U2hvdEluZGV4ID0gMDsKICAgICAgICAgICAgdGhpcy5tZW51U2hvdFRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5tZW51U2hvdHMgPSBbCiAgICAgICAgICAgICAgICAvLyAxLiAiVGhlIEFyZW5hIiAtIFdpZGUgRXN0YWJsaXNoaW5nIFNob3QgKFNsb3cgZG9sbHkgaW4pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDEwLjAsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoNjAsIDM1LCA2MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAyID0gbmV3IFRIUkVFLlZlY3RvcjMoNDAsIDI1LCA0MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNtb290aHN0ZXAgaW50ZXJwb2xhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdCA9IHQgKiB0ICogKDMgLSAyICogdCk7IAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCBzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIDIuICJUaGUgVGVhbSIgLSBUcmFja2luZyBTaG90IGFsb25nIHRoZSBmb3JtYXRpb24KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogOC4wLAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBNb3ZlIGFsb25nIHRoZSBzaWRlIG9mIHRoZSBob21lIHRlYW0gZm9ybWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHpTdGFydCA9IC0yNTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgekVuZCA9IDI1OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50WiA9IHpTdGFydCArICh6RW5kIC0gelN0YXJ0KSAqIHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24uc2V0KC0yNSwgNiwgY3VycmVudFopOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KDAsIDIsIGN1cnJlbnRaICogMC44KTsgLy8gTG9vayBzbGlnaHRseSBhaGVhZCBvZiBjZW50ZXIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gMy4gIlRoZSBTdHJpa2VyIiAtIENsb3NlIHVwIG9yYml0IG9uIGEga2V5IHBvc2l0aW9uCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDguMCwKICAgICAgICAgICAgICAgICAgICB1cGRhdGU6ICh0LCBjYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9jdXMgb24gd2hlcmUgdGhlIExGL1JGIHVzdWFsbHkgc3RhbmRzIChhcHByb3ggKy8tIDEwLCAtMTApCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IG5ldyBUSFJFRS5WZWN0b3IzKC0xMCwgMCwgLTEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSB0ICogMS4wICsgMy41OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gMTAuMDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5wb3NpdGlvbi5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQueCArIE1hdGguY29zKGFuZ2xlKSAqIGRpc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQueSArIDQuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC56ICsgTWF0aC5zaW4oYW5nbGUpICogZGlzdAogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KHRhcmdldC54LCB0YXJnZXQueSArIDEuNSwgdGFyZ2V0LnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyA0LiAiVGhlIEdvYWwiIC0gTG93IEFuZ2xlIGxvb2tpbmcgdXAgYXQgdGhlIG5ldAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiA3LjAsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgLTUsIDMyKTsgLy8gTG93IG5lYXIgZ29hbAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwMiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDgsIDIwKTsgIC8vIFJpc2luZyB1cAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdCgwLCAxNSwgNDUpOyAvLyBMb29rIHVwIGF0IHRoZSBzdHJ1Y3R1cmUKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnJvdGF0aW9uLnogPSAodCAtIDAuNSkgKiAwLjE1OyAvLyBTbGlnaHQgY2luZW1hdGljIHRpbHQKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gNS4gIlRoZSBEaXZlIiAtIFZlcnRpY2FsIGRyb3AgaW50byB0aGUgcG9vbAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiA4LjAsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgNTAsIDApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwMiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEwLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3QgPSB0ICogdCAqICgzIC0gMiAqIHQpOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCBzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5yb3RhdGlvbi56ID0gdCAqIDAuODsgLy8gU3BpcmFsIGRvd24KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9Cl07CiAgICAgICAgfQoKICAgICAgICBfaW5qZWN0U3R5bGVzKCkgewogICAgICAgICAgICBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZsdXgtZHluYW1pYy1zdHlsZXMnKSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgICAgICAgICAgIHN0eWxlLmlkID0gJ2ZsdXgtZHluYW1pYy1zdHlsZXMnOwpzdHlsZS50ZXh0Q29udGVudCA9IGAKICAgICAgICAgICAgICAgIEBrZXlmcmFtZXMgdGV4dFNsYW0gewogICAgICAgICAgICAgICAgICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoNCk7IG9wYWNpdHk6IDA7IGxldHRlci1zcGFjaW5nOiA1MHB4OyB9CiAgICAgICAgICAgICAgICAgICAgMTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IG9wYWNpdHk6IDE7IGxldHRlci1zcGFjaW5nOiA1cHg7IH0KICAgICAgICAgICAgICAgICAgICAxNSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjEpOyB9CiAgICAgICAgICAgICAgICAgICAgMjAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IH0KICAgICAgICAgICAgICAgICAgICA4MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxKTsgb3BhY2l0eTogMTsgZmlsdGVyOiBibHVyKDBweCk7IH0KICAgICAgICAgICAgICAgICAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS41KTsgb3BhY2l0eTogMDsgZmlsdGVyOiBibHVyKDEwcHgpOyB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC5hbm5vdW5jZW1lbnQtc2xhbSB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICAgICAgICAgIHRvcDogNDUlOyBsZWZ0OiA1MCU7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDEwMCU7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnSW1wYWN0Jywgc2Fucy1zZXJpZjsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDk2cHg7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgICAgICAgICAgICAgICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZmZmZiAwJSwgI2ZmZGQwMCA0NSUsICNmZjg4MDAgMTAwJSk7CiAgICAgICAgICAgICAgICAgICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAgICAgICAgICAgICAgICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgICAgICAgICAgICAgICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggcmdiYSgwLDAsMCwxKSkgZHJvcC1zaGFkb3coMCAwIDMwcHggcmdiYSgyNTUsIDEwMCwgMCwgMC42KSk7CiAgICAgICAgICAgICAgICAgICAgei1pbmRleDogMjAwMDsKICAgICAgICAgICAgICAgICAgICBhbmltYXRpb246IHRleHRTbGFtIDEuOHMgY3ViaWMtYmV6aWVyKDAuMSwgMC44LCAwLjEsIDEpIGZvcndhcmRzOwogICAgICAgICAgICAgICAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICAgICAgICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLm1vZGFsLW92ZXJsYXkgewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgY2VudGVyLCByZ2JhKDEwLCAyNSwgNjAsIDAuOTUpIDAlLCByZ2JhKDAsIDAsIDAsIDAuOTgpIDEwMCUpOwogICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7IGp1c3RpZnktY29udGVudDogY2VudGVyOyBhbGlnbi1pdGVtczogY2VudGVyOyBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDE5MDA7CiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMDsgcG9pbnRlci1ldmVudHM6IG5vbmU7IHRyYW5zaXRpb246IG9wYWNpdHkgMC44czsKICAgICAgICAgICAgICAgICAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoOHB4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5tb2RhbC1vdmVybGF5LmFjdGl2ZSB7IG9wYWNpdHk6IDE7IHBvaW50ZXItZXZlbnRzOiBhdXRvOyB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC5tb2RhbC10aXRsZSB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdHYXJhbW9uZCcsIHNlcmlmOwogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogNTJweDsgY29sb3I6ICNmZmY7CiAgICAgICAgICAgICAgICAgICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwYWFmZiwgMCAwIDQwcHggIzAwNDRhYTsKICAgICAgICAgICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAzMHB4OwogICAgICAgICAgICAgICAgICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCAjMDBhYWZmOwogICAgICAgICAgICAgICAgICAgIHBhZGRpbmctYm90dG9tOiAxMHB4OwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiA4MCU7IHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgICAgICAgICBsZXR0ZXItc3BhY2luZzogNXB4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAubW9kYWwtc2NvcmUtY29udGFpbmVyIHsKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBnYXA6IDQwcHg7CiAgICAgICAgICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogNDBweDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5tb2RhbC1zY29yZSB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdJbXBhY3QnLCBzYW5zLXNlcmlmOwogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogODBweDsgY29sb3I6ICNmZmQ3MDA7CiAgICAgICAgICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggI2I4ODYwYjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5tb2RhbC12cyB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdDb3VyaWVyIE5ldycsIG1vbm9zcGFjZTsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDI0cHg7IGNvbG9yOiAjMDBhYWZmOyBvcGFjaXR5OiAwLjc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLmZsYXNoLW92ZXJsYXkgewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDIxMDA7CiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMDsgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjFzIGVhc2Utb3V0OwogICAgICAgICAgICAgICAgICAgIG1peC1ibGVuZC1tb2RlOiBvdmVybGF5OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIEBrZXlmcmFtZXMgY2xhc2hQb3AgewogICAgICAgICAgICAgICAgICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMC41KTsgb3BhY2l0eTogMTsgfQogICAgICAgICAgICAgICAgICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuNSk7IG9wYWNpdHk6IDAuODsgfQogICAgICAgICAgICAgICAgICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgyLjApOyBvcGFjaXR5OiAwOyB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLmNsYXNoLXNwYXJrIHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDYwcHg7IGhlaWdodDogNjBweDsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAjZmZmZmZmIDAlLCAjZmZmZjAwIDQwJSwgdHJhbnNwYXJlbnQgNzAlKTsKICAgICAgICAgICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgICAgICAgICAgICAgICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgICAgICAgICAgICAgei1pbmRleDogMTUwMDsKICAgICAgICAgICAgICAgICAgICBtaXgtYmxlbmQtbW9kZTogc2NyZWVuOwogICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbjogY2xhc2hQb3AgMC4zcyBlYXNlLW91dCBmb3J3YXJkczsKICAgICAgICAgICAgICAgICAgICBib3gtc2hhZG93OiAwIDAgMjBweCAjZmZhYTAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwogICAgICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHN0eWxlKTsKICAgICAgICB9CgogICAgICAgIHJlZ2lzdGVyVGVhbXMoaG9tZVRlYW0sIGF3YXlUZWFtLCBiYWxsKSB7CiAgICAgICAgICAgIHRoaXMudGVhbXMuaG9tZSA9IGhvbWVUZWFtOwogICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkgPSBhd2F5VGVhbTsKdGhpcy5lbnRpdGllcy5iYWxsID0gYmFsbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgTWluaU1hcAogICAgICAgICAgICBpZiAodGhpcy5taW5pTWFwKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1pbmlNYXAuaW5pdChob21lVGVhbSwgYXdheVRlYW0sIGJhbGwpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2luaXRVSSgpIHsKICAgICAgICAgICAgLy8gQmluZCB0byBleGlzdGluZyBIVE1MIGVsZW1lbnRzCiAgICAgICAgICAgIHRoaXMudWkuc2NvcmVQbGF5ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NvcmUtcGxheWVyJyk7CiAgICAgICAgICAgIHRoaXMudWkuc2NvcmVDcHUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NvcmUtY3B1Jyk7CiAgICAgICAgICAgIHRoaXMudWkudGltZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGltZXItZGlzcGxheScpOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGFsZi1pbmRpY2F0b3InKTsKICAgICAgICAgICAgdGhpcy51aS5hbm5vdW5jZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYW5ub3VuY2VtZW50Jyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZWNoLWZsYXNoLW92ZXJsYXknKTsKICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaEZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hTdWIgPSB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC1zdWItdGV4dCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50ZWNoLXRpbWVyLWZpbGwnKTsKdGhpcy51aS50ZWNoVGltZXJGaWxsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnRlY2gtdGltZXItZmlsbCcpOwoKICAgICAgICAgICAgLy8gQmluZCBQbGF5ZXIgU3RhdHVzIFBhbmVsCiAgICAgICAgICAgIC8vIEJpbmQgUGxheWVyIFN0YXR1cyBQYW5lbAogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJyk7CiAgICAgICAgICAgIHRoaXMudWkuc3RhdHVzUGFuZWwubmFtZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC5jaGFyLW5hbWUnKTsKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5ocEJhciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC5ocC1iYXItZmlsbCcpOwogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmhwVGV4dCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC5ocC12YWx1ZScpOwogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmV4cEJhciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC50ZWNoLWJhci1maWxsJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDcmVhdGUgTW9kYWwgT3ZlcmxheQogICAgICAgICAgICB0aGlzLnVpLm1vZGFsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwuY2xhc3NOYW1lID0gJ21vZGFsLW92ZXJsYXknOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmlubmVySFRNTCA9IGAKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXRpdGxlIj5IQUxGIFRJTUU8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXNjb3JlLWNvbnRhaW5lciI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtc2NvcmUiIGlkPSJtb2RhbC1zY29yZS1ob21lIj4wPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtdnMiPi08L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC1zY29yZSIgaWQ9Im1vZGFsLXNjb3JlLWF3YXkiPjA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBpZD0ibW9kYWwtbXNnIiBzdHlsZT0iY29sb3I6ICMwMGFhZmY7IGZvbnQtc2l6ZTogMTRweDsgbGV0dGVyLXNwYWNpbmc6IDJweDsiPlBSRVBBUklORyAyTkQgSEFMRi4uLjwvZGl2PgogICAgICAgICAgICBgOwogICAgICAgICAgICB0aGlzLnVpTGF5ZXIuYXBwZW5kQ2hpbGQodGhpcy51aS5tb2RhbCk7CgogICAgICAgICAgICAvLyBDcmVhdGUgRmxhc2ggT3ZlcmxheQogICAgICAgICAgICB0aGlzLnVpLmZsYXNoID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHRoaXMudWkuZmxhc2guY2xhc3NOYW1lID0gJ2ZsYXNoLW92ZXJsYXknOwogICAgICAgICAgICB0aGlzLnVpTGF5ZXIuYXBwZW5kQ2hpbGQodGhpcy51aS5mbGFzaCk7CgogICAgICAgICAgICAvLyBJbml0aWFsIFN0YXRlCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoKTsKICAgICAgICAgICAgaWYgKHRoaXMudWkudGltZXIpIHRoaXMudWkudGltZXIuaW5uZXJUZXh0ID0gIjAwOjAwIjsKICAgICAgICB9CiAgICAgICAgX3VwZGF0ZVNjb3JlVUkoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnNjb3JlUGxheWVyKSB0aGlzLnVpLnNjb3JlUGxheWVyLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuaG9tZTsKICAgICAgICAgICAgaWYgKHRoaXMudWkuc2NvcmVDcHUpIHRoaXMudWkuc2NvcmVDcHUuaW5uZXJUZXh0ID0gdGhpcy5zY29yZS5hd2F5OwogICAgICAgIH0KCnVwZGF0ZVByYWN0aWNlKGR0KSB7CiAgICAgICAgICAgIC8vIERlbGVnYXRlIGxvZ2ljIHRvIFByYWN0aWNlTWFuYWdlcgogICAgICAgICAgICBpZiAodGhpcy5wcmFjdGljZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewoKaWYgKHRoaXMuc3RhdGUgPT09ICdtZW51JykgewogICAgICAgICAgICAgICAgLy8gLS0tIFBPUFVMQVRFIEFSRU5BIEZPUiBCLVJPTEwgLS0tCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgcGxheWVycyBhcmUgdmlzaWJsZSBhbmQgYW5pbWF0ZWQKICAgICAgICAgICAgICAgIGNvbnN0IGFuaW1hdGVUZWFtID0gKHRlYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRlYW0pIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB0ZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gR2VudGxlIGJvYmJpbmcgdG8gc2ltdWxhdGUgdHJlYWRpbmcgd2F0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi55ID0gcC5ob21lUG9zaXRpb24ueSArIE1hdGguc2luKERhdGUubm93KCkgKiAwLjAwMiArIHAubWVzaC5pZCkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgaWRsZSBhbmltYXRpb24gaXMgcGxheWluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAuc3RhdGUgIT09ICdpZGxlJykgcC5wbGF5KCdpZGxlJywgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLm1peGVyKSBwLm1peGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBhbmltYXRlVGVhbSh0aGlzLnRlYW1zLmhvbWUpOwogICAgICAgICAgICAgICAgYW5pbWF0ZVRlYW0odGhpcy50ZWFtcy5hd2F5KTsKCiAgICAgICAgICAgICAgICAvLyAtLS0gQ0lORU1BVElDIEItUk9MTCAtLS0KICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lbnVTaG90cyAmJiB0aGlzLm1lbnVTaG90cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hvdCA9IHRoaXMubWVudVNob3RzW3RoaXMubWVudVNob3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U2hvdFRpbWVyICs9IGR0OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lbnVTaG90VGltZXIgPj0gc2hvdC5kdXJhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lbnVTaG90VGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lbnVTaG90SW5kZXggPSAodGhpcy5tZW51U2hvdEluZGV4ICsgMSkgJSB0aGlzLm1lbnVTaG90cy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSB0aW1lICgwIHRvIDEpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMubWVudVNob3RUaW1lciAvIHNob3QuZHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3QudXBkYXRlKHQsIHRoaXMuY2FtZXJhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW1iaWVudCBGWCBpbiBNZW51CiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIgJiYgTWF0aC5yYW5kb20oKSA8IDAuMikgewogICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIHJhbmRvbSBidWJibGVzIGZvciBhdG1vc3BoZXJlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFuZ2UgPSA2MDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSpyYW5nZSwgCiAgICAgICAgICAgICAgICAgICAgICAgIC0xMCArIE1hdGgucmFuZG9tKCkqMjAsIAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKnJhbmdlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgcG9zLCB7IGxpZmU6IDMuMCArIE1hdGgucmFuZG9tKCkqMi4wLCBzY2FsZTogMC4zICsgTWF0aC5yYW5kb20oKSowLjQgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVXBkYXRlIEJhY2tncm91bmQgU3lzdGVtcwogICAgICAgICAgICAgICAgaWYgKHRoaXMud2F0ZXJPdmVybGF5KSB0aGlzLndhdGVyT3ZlcmxheS51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubGlnaHRTaGFmdHMpIHRoaXMubGlnaHRTaGFmdHMudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB0aGlzLnBhcnRpY2xlTWFuYWdlci51cGRhdGUoZHQpOwoKICAgICAgICAgICAgICAgIC8vIFJlbmRlcgogICAgICAgICAgICAgICAgaWYgKHRoaXMucmVuZGVyZXIgJiYgdGhpcy5zY2VuZSAmJiB0aGlzLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIucmVuZGVyKHRoaXMuc2NlbmUsIHRoaXMuY2FtZXJhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdhY3RpdmUnKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lTW9kZSA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlUHJhY3RpY2UoZHQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRpbWUgKz0gZHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVGltZXIoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jaGVja0hhbGZUaW1lKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tHb2FscygpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5taW5pTWFwKSB0aGlzLm1pbmlNYXAudXBkYXRlKCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5mbG9hdGluZ1RleHQpIHRoaXMuZmxvYXRpbmdUZXh0LnVwZGF0ZShkdCk7CmlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgdGhpcy5wYXJ0aWNsZU1hbmFnZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIC8vIEdseXBoTWFuYWdlciB1cGRhdGVkIGJ5IG1haW4uanMKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXBkYXRlIFRlY2hjb3B5IFdpbmRvdwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIFVJIEJhcgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hUaW1lckZpbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGN0ID0gTWF0aC5tYXgoMCwgKHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciAvIHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lKSAqIDEwMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9IGAke3BjdH0lYDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbG9yIHNoaWZ0IGJhc2VkIG9uIHVyZ2VuY3kKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBjdCA8IDMwKSB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICcjZmYwMDAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZmZmZmYsICMwMGZmZmYpJzsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZFRlY2hDb3B5V2luZG93KGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBhcnRpY2xlcyhkdCk7CnRoaXMuX3VwZGF0ZVBhcnRpY2xlcyhkdCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIpIHRoaXMuZGVidWdWaXN1YWxpemVyLnVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICBfdXBkYXRlT2Zmc2NyZWVuSW5kaWNhdG9yKCkgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy50ZWFtcy5ob21lID8gdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciA6IG51bGw7CiAgICAgICAgICAgIGNvbnN0IGluZGljYXRvciA9IHRoaXMudWkub2Zmc2NyZWVuSW5kaWNhdG9yOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFwIHx8ICFwLm1lc2ggfHwgIXRoaXMuY2FtZXJhIHx8ICFpbmRpY2F0b3IpIHJldHVybjsKCiAgICAgICAgICAgIC8vIDEuIEdldCBQbGF5ZXIgUG9zaXRpb24gKENlbnRlciBNYXNzKQogICAgICAgICAgICBjb25zdCBwb3MgPSBwLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgcG9zLnkgKz0gMS4wOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDIuIFByb2plY3QgdG8gTm9ybWFsaXplZCBEZXZpY2UgQ29vcmRpbmF0ZXMgKE5EQykgWy0xLCAxXQogICAgICAgICAgICB0aGlzLl90ZW1wVmVjLmNvcHkocG9zKS5wcm9qZWN0KHRoaXMuY2FtZXJhKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDMuIENoZWNrIGlmIEJlaGluZCBDYW1lcmEKICAgICAgICAgICAgY29uc3QgY2FtRndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oY2FtRndkKTsKICAgICAgICAgICAgY29uc3QgdG9QbGF5ZXIgPSBwb3MuY2xvbmUoKS5zdWIodGhpcy5jYW1lcmEucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBjb25zdCBkb3QgPSBjYW1Gd2QuZG90KHRvUGxheWVyKTsKICAgICAgICAgICAgY29uc3QgaXNCZWhpbmQgPSBkb3QgPCAwLjI7IC8vIEJ1ZmZlciB0byBwcmV2ZW50IGZsaXBwaW5nIGF0IGVkZ2UKCiAgICAgICAgICAgIC8vIDQuIENoZWNrIEJvdW5kcwogICAgICAgICAgICBjb25zdCBpc09mZlNjcmVlbiA9ICgKICAgICAgICAgICAgICAgIHRoaXMuX3RlbXBWZWMueCA8IC0wLjkgfHwgdGhpcy5fdGVtcFZlYy54ID4gMC45IHx8CiAgICAgICAgICAgICAgICB0aGlzLl90ZW1wVmVjLnkgPCAtMC45IHx8IHRoaXMuX3RlbXBWZWMueSA+IDAuOSB8fAogICAgICAgICAgICAgICAgaXNCZWhpbmQKICAgICAgICAgICAgKTsKCiAgICAgICAgICAgIGlmIChpc09mZlNjcmVlbikgewogICAgICAgICAgICAgICAgaW5kaWNhdG9yLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgeCA9IHRoaXMuX3RlbXBWZWMueDsKICAgICAgICAgICAgICAgIGxldCB5ID0gdGhpcy5fdGVtcFZlYy55OwoKICAgICAgICAgICAgICAgIC8vIElmIGJlaGluZCwgaW52ZXJ0IGNvb3JkaW5hdGVzIHRvIHBvaW50IGNvcnJlY3RseQogICAgICAgICAgICAgICAgaWYgKGlzQmVoaW5kKSB7CiAgICAgICAgICAgICAgICAgICAgeCA9IC14OwogICAgICAgICAgICAgICAgICAgIHkgPSAteTsKICAgICAgICAgICAgICAgICAgICAvLyBGaXggc2luZ3VsYXJpdHkgaWYgZXhhY3RseSBiZWhpbmQgY2VudGVyCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHgpIDwgMC4wMSAmJiBNYXRoLmFicyh5KSA8IDAuMDEpIHkgPSAtMTsgCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2xhbXAgdG8gc2NyZWVuIGVkZ2VzCiAgICAgICAgICAgICAgICAvLyBXZSB3YW50IHRvIGZpbmQgdGhlIGludGVyc2VjdGlvbiBvZiB0aGUgdmVjdG9yICh4LHkpIHdpdGggdGhlIGJveCBbLTAuOSwgMC45XQogICAgICAgICAgICAgICAgY29uc3QgcGFkZGluZyA9IDAuOTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gTm9ybWFsaXplIHRvIGdldCBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIGNvbnN0IG1hZyA9IE1hdGguc3FydCh4KnggKyB5KnkpOwogICAgICAgICAgICAgICAgY29uc3QgbnggPSB4IC8gbWFnOwogICAgICAgICAgICAgICAgY29uc3QgbnkgPSB5IC8gbWFnOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSYXljYXN0IHRvIGJveCBlZGdlcwogICAgICAgICAgICAgICAgLy8gVmVydGljYWwgZWRnZXM6IHggPSArLy0gcGFkZGluZwogICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCBlZGdlczogeSA9ICsvLSBwYWRkaW5nCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEF2b2lkIGRpdmlkZSBieSB6ZXJvCiAgICAgICAgICAgICAgICBjb25zdCB0eCA9IChNYXRoLmFicyhueCkgPiAwLjAwMSkgPyAobnggPiAwID8gcGFkZGluZyA6IC1wYWRkaW5nKSAvIG54IDogOTk5OwogICAgICAgICAgICAgICAgY29uc3QgdHkgPSAoTWF0aC5hYnMobnkpID4gMC4wMDEpID8gKG55ID4gMCA/IHBhZGRpbmcgOiAtcGFkZGluZykgLyBueSA6IDk5OTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXNlIHRoZSBuZWFyZXN0IGludGVyc2VjdGlvbiAoc21hbGxlc3QgcG9zaXRpdmUgdCkKICAgICAgICAgICAgICAgIC8vIFNpbmNlIHdlIGFyZSBwcm9qZWN0aW5nIGZyb20gY2VudGVyICgwLDApIHRvIChueCxueSksIHQgbXVzdCBiZSBwb3NpdGl2ZS4KICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBNYXRoLm1pbihNYXRoLmFicyh0eCksIE1hdGguYWJzKHR5KSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHNjcmVlblggPSBueCAqIHQ7CiAgICAgICAgICAgICAgICBjb25zdCBzY3JlZW5ZID0gbnkgKiB0OwoKICAgICAgICAgICAgICAgIC8vIENvbnZlcnQgTkRDIHRvIFBpeGVscwogICAgICAgICAgICAgICAgY29uc3Qgd2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICAgICAgICAgIGNvbnN0IGhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgcHggPSAoc2NyZWVuWCAqIDAuNSArIDAuNSkgKiB3aWR0aDsKICAgICAgICAgICAgICAgIGNvbnN0IHB5ID0gKC0oc2NyZWVuWSkgKiAwLjUgKyAwLjUpICogaGVpZ2h0OwoKICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBSb3RhdGlvbgogICAgICAgICAgICAgICAgLy8gQXJyb3cgcG9pbnRzIFVQIGJ5IGRlZmF1bHQuCiAgICAgICAgICAgICAgICAvLyBXZSB3YW50IGl0IHRvIHBvaW50IGluIGRpcmVjdGlvbiAobngsIG55KSBvbiBzY3JlZW4uCiAgICAgICAgICAgICAgICAvLyBTY3JlZW4gWSBpcyBkb3duIChpbnZlcnRlZCBmcm9tIFdlYkdMIFkpLgogICAgICAgICAgICAgICAgLy8gU28gKDAsIDEpIGluIE5EQyBpcyBVUC4gKDAsIC0xKSBpbiBOREMgaXMgRE9XTi4KICAgICAgICAgICAgICAgIC8vIGF0YW4yKHksIHgpIGdpdmVzIGFuZ2xlIGZyb20gK1guCiAgICAgICAgICAgICAgICAvLyBXZSB3YW50IGFuZ2xlIGZyb20gK1kgKFVwKS4KICAgICAgICAgICAgICAgIC8vIFJvdGF0aW9uID0gUEkvMiAtIGFuZ2xlLgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguYXRhbjIobnksIG54KTsKICAgICAgICAgICAgICAgIGNvbnN0IHJvdCA9IChNYXRoLlBJIC8gMikgLSBhbmdsZTsKCiAgICAgICAgICAgICAgICBpbmRpY2F0b3Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgke3B4fXB4LCAke3B5fXB4KSByb3RhdGUoJHtyb3R9cmFkKWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICBpbmRpY2F0b3Iuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVRpbWVyKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkudGltZXIpIHJldHVybjsKICAgICAgICAgICAgLy8gQ2xhbXAgdG8gaGFsZiBkdXJhdGlvbiBmb3IgZGlzcGxheSBpZiB3ZSBnbyBzbGlnaHRseSBvdmVyIGJlZm9yZSB0aWNrCiAgICAgICAgICAgIGNvbnN0IHQgPSBNYXRoLm1pbih0aGlzLnRpbWUsIHRoaXMuaGFsZkR1cmF0aW9uKTsKICAgICAgICAgICAgY29uc3QgbWludXRlcyA9IE1hdGguZmxvb3IodCAvIDYwKTsKICAgICAgICAgICAgY29uc3Qgc2Vjb25kcyA9IE1hdGguZmxvb3IodCAlIDYwKTsKICAgICAgICAgICAgdGhpcy51aS50aW1lci5pbm5lclRleHQgPSBgJHttaW51dGVzLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKX06JHtzZWNvbmRzLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKX1gOwogICAgICAgIH0KICAgICAgICBfY2hlY2tIYWxmVGltZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudGltZSA+PSB0aGlzLmhhbGZEdXJhdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5lbmRIYWxmKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgplbmRIYWxmKCkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2hhbGZ0aW1lJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmhhbGYgPT09IDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dNb2RhbCgiSEFMRiBUSU1FIiwgIlBSRVBBUklORyAyTkQgSEFMRi4uLiIpOwogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZU1vZGFsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydFNlY29uZEhhbGYoKTsKICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRW5kIG9mIDJuZCBIYWxmIG9yIE92ZXJ0aW1lIFBlcmlvZAogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuaG9tZSA9PT0gdGhpcy5zY29yZS5hd2F5KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVElFRCAtIEdvIHRvIE92ZXJ0aW1lIChHb2xkZW4gR29hbCkKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93TW9kYWwoIk9WRVJUSU1FIiwgIkdPTERFTiBHT0FMIFJVTEUgQUNUSVZFIik7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVNb2RhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0T3ZlcnRpbWUoKTsKICAgICAgICAgICAgICAgICAgICB9LCA0MDAwKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV2lubmVyIGRlY2lkZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3RhcnRTZWNvbmRIYWxmKCkgewogICAgICAgICAgICB0aGlzLmhhbGYgPSAyOwogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYuaW5uZXJUZXh0ID0gIjJuZCBIQUxGIjsKICAgICAgICAgICAgdGhpcy5yZXNldFJvdW5kKG51bGwpOyAvLyBOZXV0cmFsIEJsaXR6LW9mZiBmb3IgMm5kIGhhbGYgc3RhcnQKICAgICAgICB9CgogICAgICAgIHN0YXJ0T3ZlcnRpbWUoKSB7CiAgICAgICAgICAgIHRoaXMuaGFsZisrOwogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmlzT3ZlcnRpbWUgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYuaW5uZXJUZXh0ID0gIk9WRVJUSU1FIjsKICAgICAgICAgICAgdGhpcy5yZXNldFJvdW5kKG51bGwpOyAvLyBOZXV0cmFsIEJsaXR6LW9mZgogICAgICAgIH0KCiAgICAgICAgZW5kR2FtZSgpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdnYW1lb3Zlcic7CiAgICAgICAgICAgIGxldCBtc2cgPSAiRFJBVyI7CiAgICAgICAgICAgIGlmICh0aGlzLnNjb3JlLmhvbWUgPiB0aGlzLnNjb3JlLmF3YXkpIG1zZyA9ICJWSUNUT1JZIjsKICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuYXdheSA+IHRoaXMuc2NvcmUuaG9tZSkgbXNnID0gIkRFRkVBVCI7CiAgICAgICAgICAgIAp0aGlzLl9zaG93TW9kYWwobXNnLCAiUFJFU1MgUkVGUkVTSCBUTyBQTEFZIEFHQUlOIik7CiAgICAgICAgICAgIC8vIFN0b3AgTXVzaWMgb24gR2FtZSBPdmVyCiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIuc3RvcEJHTSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE5vIHJlc2V0LCBqdXN0IHN0b3AuCiAgICAgICAgfQoKICAgICAgICBfc2hvd01vZGFsKHRpdGxlLCBzdWJ0ZXh0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy51aS5tb2RhbCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5xdWVyeVNlbGVjdG9yKCcubW9kYWwtdGl0bGUnKS5pbm5lclRleHQgPSB0aXRsZTsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5xdWVyeVNlbGVjdG9yKCcjbW9kYWwtc2NvcmUtaG9tZScpLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuaG9tZTsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5xdWVyeVNlbGVjdG9yKCcjbW9kYWwtc2NvcmUtYXdheScpLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuYXdheTsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5xdWVyeVNlbGVjdG9yKCcjbW9kYWwtbXNnJykuaW5uZXJUZXh0ID0gc3VidGV4dDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudWkubW9kYWwuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIaWRlIEhVRCBlbGVtZW50cwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaHVkLXRvcCcpLnN0eWxlLm9wYWNpdHkgPSAnMCc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJykuc3R5bGUub3BhY2l0eSA9ICcwJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlTW9kYWwoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy51aS5tb2RhbCkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2hvdyBIVUQgZWxlbWVudHMKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKS5zdHlsZS5vcGFjaXR5ID0gJzEnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpLnN0eWxlLm9wYWNpdHkgPSAnMSc7CiAgICAgICAgfQoKX2NoZWNrR29hbHMoKSB7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBwb3MgPSBiYWxsLm1lc2gucG9zaXRpb247CgogICAgICAgICAgICAvLyBQcmVjaXNlIEdvYWwgRGV0ZWN0aW9uCiAgICAgICAgICAgIC8vIFZpc3VhbCBHb2FsIGlzIGF0IFogPSArLy0gMjguCiAgICAgICAgICAgIC8vIFdlIGRlZmluZSBhICJHb2FsIE1vdXRoIiBib3ggbWF0Y2hpbmcgR29hbGllLmpzIChXaWR0aCAxNCwgSGVpZ2h0IDgpLgovLyBXZSBkZWZpbmUgYSAiR29hbCBNb3V0aCIgYm94IG1hdGNoaW5nIHRoZSB2aXN1YWwgbmV0LgogICAgICAgICAgICAvLyBBcmVuYSBSYWRpdXMgaXMgMzIuIEdvYWwgaXMgcm91Z2hseSAyMm0gd2lkZSwgMThtIGhpZ2guCi8vIEFyZW5hIFJhZGl1cyBpcyAzMi4gR29hbCBpcyByb3VnaGx5IDIybSB3aWRlLCAxOG0gaGlnaC4KICAgICAgICAgICAgY29uc3QgaGFsZldpZHRoID0gMTEuMDsgLy8gSW5jcmVhc2VkIHRvIDExIChXaWR0aCAyMikgdG8gY2F0Y2ggY29ybmVycwogICAgICAgICAgICBjb25zdCBoYWxmSGVpZ2h0ID0gOS4wOyAvLyBJbmNyZWFzZWQgdG8gOSAoSGVpZ2h0IDE4KSB0byBjYXRjaCBoaWdoIHNob3RzCiAgICAgICAgICAgIGNvbnN0IGdvYWxZT2Zmc2V0ID0gLTQuNTsgLy8gTW92ZWQgZG93biB0byBtYXRjaCB2aXN1YWwgbW9kZWwgKC00LjVtKQoKICAgICAgICAgICAgY29uc3QgdHJpZ2dlclogPSA0NS4wOyAvLyBUcmlnZ2VyIGVhcmxpZXIgKHdhcyAzMCkgdG8gZW5zdXJlIHJlZ2lzdHJhdGlvbiBiZWZvcmUgYm91bmNlCgogICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnopID4gdHJpZ2dlclopIHsKICAgICAgICAgICAgICAgIC8vIFBSRVZFTlQgT1dOIEdPQUwgQlkgQ0FSUklFUiAoVXNlciBSZXF1ZXN0KQogICAgICAgICAgICAgICAgLy8gSWYgdGhlIGJhbGwgaXMgaGVsZCBieSB0aGUgdGVhbSBkZWZlbmRpbmcgdGhpcyBnb2FsLCBkbyBub3QgY291bnQgaXQuCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIb21lIChTaWRlIDEpIGRlZmVuZHMgK1ouIElmIHBvcy56ID4gMCAoSG9tZSBHb2FsKSBhbmQgaG9sZGVyIGlzIEhvbWUsIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPiAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gMSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIC8vIEF3YXkgKFNpZGUgLTEpIGRlZmVuZHMgLVouIElmIHBvcy56IDwgMCAoQXdheSBHb2FsKSBhbmQgaG9sZGVyIGlzIEF3YXksIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gLTEpIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyLiBDaGVjayBGcmFtZSAoTXVzdCBiZSB3aXRoaW4gd2lkdGgvaGVpZ2h0KQovLyAyLiBDaGVjayBGcmFtZSAoTXVzdCBiZSB3aXRoaW4gd2lkdGgvaGVpZ2h0LCBhY2NvdW50aW5nIGZvciBZIG9mZnNldCkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueCkgPD0gaGFsZldpZHRoICYmIE1hdGguYWJzKHBvcy55IC0gZ29hbFlPZmZzZXQpIDw9IGhhbGZIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ29hbFNjb3JlZCgnaG9tZScpOyAvLyBIb21lIGF0dGFja3MgLVoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdvYWxTY29yZWQoJ2F3YXknKTsgLy8gQXdheSBhdHRhY2tzICtaCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKZ29hbFNjb3JlZChzY29yZXIpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJTVBBQ1QgRlJBTUU6IEdPQUwKdGhpcy50cmlnZ2VySW1wYWN0KDAuNCwgJ3NoYXR0ZXInKTsgLy8gTWFzc2l2ZSBmcmVlemUgZm9yIGdvYWwKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFWFAgUkVXQVJEOiBHb2FsCiAgICAgICAgICAgIC8vIEZpbmQgd2hvIHNjb3JlZCAoTGFzdCBob2xkZXIgb2YgYmFsbCkKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5sYXN0SG9sZGVyICYmIGJhbGwubGFzdEhvbGRlci50ZWFtLmlkID09PSBzY29yZXIpIHsKICAgICAgICAgICAgICAgIGJhbGwubGFzdEhvbGRlci5nYWluRXhwKDEwKTsKICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBBc3Npc3QgbG9naWMgY291bGQgZ28gaGVyZSAodHJhY2sgbGFzdEhvbGRlci5sYXN0UGFzc2VyPykKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdnb2FsJzsKICAgICAgICAgICAgdGhpcy5zY29yZVtzY29yZXJdKys7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoKTsKICAgICAgICAgICAgCi8vIDEuIFZJU0NFUkFMIFNIQUtFICYgUEFSVElDTEVTCiAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgyLjApOyAvLyBIZWF2eSBzaGFrZQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlciAmJiB0aGlzLmVudGl0aWVzLmJhbGwgJiYgdGhpcy5lbnRpdGllcy5iYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxQb3MgPSB0aGlzLmVudGl0aWVzLmJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgLy8gTWFzc2l2ZSBHb2FsIEV4cGxvc2lvbgogICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIGdvYWxQb3MsIHsgc2NhbGU6IDE1LjAsIGxpZmU6IDAuOCB9KTsKICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIGdvYWxQb3MsIHsgc2NhbGU6IDEwLjAgfSk7CiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzMDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2RlYnJpcycsIGdvYWxQb3MsIHsgc2NhbGU6IDAuOCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyAyLiBTQ1JFRU4gRkxBU0gKICAgICAgICAgICAgaWYgKHRoaXMudWkuZmxhc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuZmxhc2guc3R5bGUub3BhY2l0eSA9ICcwLjgnOwogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IHRoaXMudWkuZmxhc2guc3R5bGUub3BhY2l0eSA9ICcwJzsgfSwgMTAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gR09MREVOIEdPQUwgQ0hFQ0sKICAgICAgICAgICAgaWYgKHRoaXMuaXNPdmVydGltZSkgewogICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJHT0xERU4gR09BTCEiLCAnc2xhbScpOwogICAgICAgICAgICAgICAgLy8gRW5kIGdhbWUgYWZ0ZXIgc2hvcnQgZGVsYXkKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuZW5kR2FtZSgpOwogICAgICAgICAgICAgICAgfSwgMzAwMCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIFNMQU0gQU5OT1VOQ0VNRU5UIChOb3JtYWwpCiAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiR09BTCEiLCAnc2xhbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgc2VxdWVuY2UKICAgICAgICAgICAgLy8gU2NvcmVkLXVwb24gdGVhbSBnZXRzIGJhbGwKICAgICAgICAgICAgY29uc3QgbG9zZXIgPSBzY29yZXIgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZBU1RFUiBGTE9XOiBSZWR1Y2VkIGRlbGF5IGZyb20gMzAwMG1zIHRvIDEyMDBtcwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChsb3Nlcik7CiAgICAgICAgICAgIH0sIDIwMDApOyAvLyBTbGlnaHRseSBsb25nZXIgdG8gYXBwcmVjaWF0ZSB0aGUgIkdPQUwiIHNsYW0KICAgICAgICB9CgpzaG93QW5ub3VuY2VtZW50KHRleHQsIHR5cGUgPSAnbm9ybWFsJywgZHVyYXRpb24gPSAyMDAwKSB7CiAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5hbm5vdW5jZW1lbnQ7CiAgICAgICAgICAgIGlmICghZWwpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENsZWFyIHByZXZpb3VzIHRpbWVvdXQKICAgICAgICAgICAgaWYgKHRoaXMuX2Fubm91bmNlVGltZW91dCkgewogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX2Fubm91bmNlVGltZW91dCk7CiAgICAgICAgICAgICAgICB0aGlzLl9hbm5vdW5jZVRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBBbmltYXRpb24gYnkgY2xvbmluZwogICAgICAgICAgICBjb25zdCBuZXdFbCA9IGVsLmNsb25lTm9kZSh0cnVlKTsKICAgICAgICAgICAgZWwucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQobmV3RWwsIGVsKTsKICAgICAgICAgICAgdGhpcy51aS5hbm5vdW5jZW1lbnQgPSBuZXdFbDsKCiAgICAgICAgICAgIG5ld0VsLmlubmVyVGV4dCA9IHRleHQ7CiAgICAgICAgICAgIG5ld0VsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgQ2xhc3MgYmFzZWQgb24gdHlwZQogICAgICAgICAgICBuZXdFbC5jbGFzc05hbWUgPSAnJzsgLy8gUmVzZXQgY2xhc3NlcwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3NsYW0nKSB7CiAgICAgICAgICAgICAgICBuZXdFbC5jbGFzc0xpc3QuYWRkKCdhbm5vdW5jZW1lbnQtc2xhbScpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRGVmYXVsdCBzdHlsZQogICAgICAgICAgICAgICAgbmV3RWwuc3R5bGUuYW5pbWF0aW9uID0gJ25vbmUnOwogICAgICAgICAgICAgICAgbmV3RWwub2Zmc2V0SGVpZ2h0OyAvKiB0cmlnZ2VyIHJlZmxvdyAqLwogICAgICAgICAgICAgICAgbmV3RWwuc3R5bGUuYW5pbWF0aW9uID0gJ2Fubm91bmNlU2xpZGUgMC41cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSknOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBdXRvLWhpZGUKICAgICAgICAgICAgaWYgKGR1cmF0aW9uID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fYW5ub3VuY2VUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlQW5ub3VuY2VtZW50KCk7CiAgICAgICAgICAgICAgICB9LCBkdXJhdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGhpZGVBbm5vdW5jZW1lbnQoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLmFubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgdGhpcy51aS5hbm5vdW5jZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCnJlc2V0Um91bmQocG9zc2Vzc2lvblRlYW1JZCkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ3Jlc2V0JzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IEJhbGwKICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCkgdGhpcy5lbnRpdGllcy5iYWxsLnJlc2V0KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCBUZWFtcwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBiYWxsIGhvbGRlcgogICAgICAgICAgICBpZiAodGhpcy5lbnRpdGllcy5iYWxsKSB0aGlzLmVudGl0aWVzLmJhbGwuZHJvcCgpOwoKICAgICAgICAgICAgLy8gQ1JJVElDQUw6IFNuYXAgY2FtZXJhIHRvIHByZXZlbnQgZGlzb3JpZW50YXRpb24KICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gRm9yY2UgdXBkYXRlIHRhcmdldCBmaXJzdCAodXN1YWxseSBiYWxsKQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCAmJiB0aGlzLmVudGl0aWVzLmJhbGwubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQodGhpcy5lbnRpdGllcy5iYWxsLm1lc2gsIHRoaXMuZW50aXRpZXMuYmFsbC52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGQVNURVIgRkxPVzogUmVkdWNlZCBkZWxheSBmcm9tIDIwMDBtcyB0byAxMDBtcwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRLaWNrb2ZmKHBvc3Nlc3Npb25UZWFtSWQpOwp9LCAxMDApOwogICAgICAgIH0KCiAgICAgICAgc3RhcnRLaWNrb2ZmKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdraWNrb2ZmJzsKICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJCTElUWiBPRkYhIiwgJ3NsYW0nKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElmIGEgdGVhbSBoYXMgcG9zc2Vzc2lvbiAoYWZ0ZXIgZ29hbCksIGdpdmUgdG8gTUYKICAgICAgICAgICAgaWYgKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRlYW0gPSB0aGlzLnRlYW1zW3Bvc3Nlc3Npb25UZWFtSWRdOwogICAgICAgICAgICAgICAgaWYgKHRlYW0pIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtZiA9IHRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgICAgICAgICBpZiAobWYgJiYgdGhpcy5lbnRpdGllcy5iYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW50aXRpZXMuYmFsbC5ncmFiKG1mKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENSSVRJQ0FMOiBTbmFwIGNhbWVyYSB0byBuZXcgaG9sZGVyIHRvIHByZXZlbnQgc3dpbmcvZGlzb3JpZW50YXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldChtZi5tZXNoLCBtZi52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOZXV0cmFsIGtpY2tvZmYgLSBlbnN1cmUgY2FtZXJhIGlzIHNuYXBwZWQgdG8gY2VudGVyIGJhbGwKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIgJiYgdGhpcy5lbnRpdGllcy5iYWxsICYmIHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldCh0aGlzLmVudGl0aWVzLmJhbGwubWVzaCwgdGhpcy5lbnRpdGllcy5iYWxsLnZlbG9jaXR5KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZBU1RFUiBGTE9XOiBSZWR1Y2VkIGRlbGF5IGZyb20gMTAwMG1zIHRvIDgwMG1zCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5oaWRlQW5ub3VuY2VtZW50KCk7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2FjdGl2ZSc7CiAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgfQogICAgICAgIAovLyBJbml0aWFsIHN0YXJ0CiAgICAgICAgc3RhcnRNYXRjaChtb2RlID0gJ25vcm1hbCcpIHsKICAgICAgICAgICAgdGhpcy5nYW1lTW9kZSA9IG1vZGU7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJTdGFydGluZyBNYXRjaCBpbiBtb2RlOiIsIG1vZGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhcnQgTXVzaWMKICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IFNjb3JlCnRoaXMuc2NvcmUuaG9tZSA9IDA7CiAgICAgICAgICAgIHRoaXMuc2NvcmUuYXdheSA9IDA7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IFRpbWUKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5oYWxmID0gMTsKICAgICAgICAgICAgaWYgKHRoaXMudWkuaGFsZikgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICIxc3QiOwogICAgICAgICAgICAKaWYgKG1vZGUgPT09ICdwcmFjdGljZScpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiUFJBQyI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyLnN0YXJ0KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSW4gcHJhY3RpY2UsIGVuc3VyZSBBSSBpcyBlbmFibGVkIGZvciBzcGFycmluZwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5haUVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBQcmFjdGljZSBNYW5hZ2VyIGlzIHN0b3BwZWQgaWYgbm9ybWFsIGdhbWUKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgdGhpcy5wcmFjdGljZU1hbmFnZXIuc3RvcCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTYWZldHk6IEVuc3VyZSBhbGwgcGxheWVycyBhcmUgdmlzaWJsZSAoaW4gY2FzZSBQcmFjdGljZSBoaWQgdGhlbSkKICAgICAgICAgICAgICAgIC8vIEFuZCBGT1JDRSBBSSBFTkFCTEVEIChGaXggZm9yICJab21iaWVzIiBpZiBjb21pbmcgZnJvbSBQcmFjdGljZSBNb2RlKQogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7IGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSB0cnVlOyB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gdHJ1ZTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7IH0pOwogICAgICAgICAgICAgICAgfQoKdGhpcy5yZXNldFJvdW5kKCk7CiAgICAgICAgICAgIH0KfQoKc2V0TWVudU1vZGUoaXNBY3RpdmUpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGlzQWN0aXZlID8gJ21lbnUnIDogJ2FjdGl2ZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaXNBY3RpdmUgJiYgdGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnN0b3BCR00oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBIVUQgaW4gbWVudQogICAgICAgICAgICBjb25zdCBodWRUb3AgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaHVkLXRvcCcpOwogICAgICAgICAgICBjb25zdCBzdGF0dXNQYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJyk7CiAgICAgICAgICAgIGNvbnN0IGNvbnRyb2xzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1jb250YWluZXInKTsKICAgICAgICAgICAgY29uc3Qgam95c3RpY2sgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2staGl0LXpvbmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRpc3BsYXkgPSBpc0FjdGl2ZSA/ICdub25lJyA6ICdmbGV4JzsgLy8gb3IgYmxvY2svZXRjCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaHVkVG9wKSBodWRUb3Auc3R5bGUuZGlzcGxheSA9IGRpc3BsYXk7CiAgICAgICAgICAgIGlmIChzdGF0dXNQYW5lbCkgc3RhdHVzUGFuZWwuc3R5bGUuZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2Jsb2NrJzsgLy8gU3RhdHVzIHBhbmVsIGhhcyBzcGVjaWZpYyBsb2dpYwogICAgICAgICAgICBpZiAoY29udHJvbHMpIGNvbnRyb2xzLnN0eWxlLmRpc3BsYXkgPSBpc0FjdGl2ZSA/ICdub25lJyA6ICdmbGV4JzsKICAgICAgICAgICAgaWYgKGpveXN0aWNrKSBqb3lzdGljay5zdHlsZS5kaXNwbGF5ID0gaXNBY3RpdmUgPyAnbm9uZScgOiAnYmxvY2snOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgZW50ZXJpbmcgbWVudSwgcmVzZXQgY2FtZXJhIHRvIGEgbmljZSBhbmdsZT8KICAgICAgICAgICAgLy8gSGFuZGxlZCBieSB1cGRhdGUgbG9vcAogICAgICAgIH0KdG9nZ2xlRGVtb01vZGUoKSB7CiAgICAgICAgICAgIHRoaXMuaXNEZW1vTW9kZSA9ICF0aGlzLmlzRGVtb01vZGU7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJEZW1vIE1vZGU6IiwgdGhpcy5pc0RlbW9Nb2RlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBVSSBCdXR0b24KICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F1dG8tdG9nZ2xlJyk7CiAgICAgICAgICAgIGlmIChidG4pIHsKICAgICAgICAgICAgICAgIGJ0bi5pbm5lclRleHQgPSB0aGlzLmlzRGVtb01vZGUgPyAiQVVUTyBQSUxPVCIgOiAiTUFOVUFMIjsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzRGVtb01vZGUpIHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSB0aGlzLmlzRGVtb01vZGUgPyAiQVVUTyBQSUxPVCIgOiAiTUFOVUFMIjsKICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KHRleHQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIEZsYWlyOiBTcGF3biB0ZXh0IGFib3ZlIGFjdGl2ZSBwbGF5ZXIKICAgICAgICAgICAgaWYgKHRoaXMuaXNEZW1vTW9kZSAmJiB0aGlzLmZsb2F0aW5nVGV4dCAmJiB0aGlzLnRlYW1zLmhvbWUgJiYgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciAmJiB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKCJBSSBFTkdBR0VEIiwgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllci5tZXNoLnBvc2l0aW9uLCAiZ29hbCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBdXRvLWhpZGUgYW5ub3VuY2VtZW50CnNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkuYW5ub3VuY2VtZW50ICYmIHRoaXMudWkuYW5ub3VuY2VtZW50LmlubmVyVGV4dCA9PT0gdGV4dCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBURUNIQ09QWSBTWVNURU0gLS0tCgogICAgICAgIHRyaWdnZXJUZWNoRXZlbnQoc291cmNlUGxheWVyLCB0ZWNoTmFtZSkgewogICAgICAgICAgICBpZiAoIXNvdXJjZVBsYXllciB8fCAhc291cmNlUGxheWVyLnRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIC8vIEZpbmQgb3Bwb3NpbmcgdGVhbQogICAgICAgICAgICBjb25zdCBvcHBUZWFtSWQgPSBzb3VyY2VQbGF5ZXIudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gdGhpcy50ZWFtc1tvcHBUZWFtSWRdOwogICAgICAgICAgICBpZiAoIW9wcFRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIC8vIEZpbmQgd2hvIGlzIG1hcmtpbmcgdGhpcyBzb3VyY2UKICAgICAgICAgICAgY29uc3QgbGVhcm5lcnMgPSBvcHBUZWFtLnBsYXllcnMuZmlsdGVyKHAgPT4gcC5tYXJraW5nID09PSBzb3VyY2VQbGF5ZXIpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGxlYXJuZXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gT25seSBzaG93IFVJIGlmIHRoZSBsZWFybmluZyB0ZWFtIGlzIEh1bWFuIChIb21lKQogICAgICAgICAgICAvLyAoT3IgaWYgd2UgYXJlIGluIERlbW8gbW9kZSBhbmQgd2FudCB0byBzZWUgaXQgaGFwcGVuIGZvciBIb21lIHRlYW0pCiAgICAgICAgICAgIGlmIChvcHBUZWFtLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIC8vIEZpbHRlciBvdXQgdGhvc2Ugd2hvIGFscmVhZHkga25vdyBpdAogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRMZWFybmVycyA9IGxlYXJuZXJzLmZpbHRlcihwID0+ICFwLmxlYXJuZWRUZWNocy5pbmNsdWRlcyh0ZWNoTmFtZSkpOwogICAgICAgICAgICAgICAgaWYgKHZhbGlkTGVhcm5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRUZWNoQ29weVdpbmRvdyh0ZWNoTmFtZSwgdmFsaWRMZWFybmVycyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzdGFydFRlY2hDb3B5V2luZG93KHRlY2hOYW1lLCBsZWFybmVycykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLm1heFRpbWUgPSAwLjY7IC8vIDAuNnMgd2luZG93CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciA9IHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUudGVjaCA9IHRlY2hOYW1lOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUubGVhcm5lcnMgPSBsZWFybmVyczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNob3cgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaEZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoRmxhc2guc3R5bGUuYmFja2dyb3VuZCA9ICIiOyAvLyBSZXNldCBiYWNrZ3JvdW5kCiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlRFQ0hDT1BZISI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hTdWIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hTdWIuaW5uZXJUZXh0ID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IGJhcgogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaFRpbWVyRmlsbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9ICcxMDAlJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmF0dGVtcHRUZWNoQ29weSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdWNjZXNzIQogICAgICAgICAgICBjb25zdCB0ZWNoID0gdGhpcy50ZWNoQ29weVN0YXRlLnRlY2g7CiAgICAgICAgICAgIGNvbnN0IGxlYXJuZXJzID0gdGhpcy50ZWNoQ29weVN0YXRlLmxlYXJuZXJzOwogICAgICAgICAgICAKICAgICAgICAgICAgbGVhcm5lcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIC8vIERvdWJsZSBjaGVjayB0byBwcmV2ZW50IGR1cGxpY2F0ZXMKICAgICAgICAgICAgICAgIGlmICghcC5sZWFybmVkVGVjaHMuaW5jbHVkZXModGVjaCkpIHsKICAgICAgICAgICAgICAgICAgICBwLmxlYXJuZWRUZWNocy5wdXNoKHRlY2gpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3Aucm9sZX0gbGVhcm5lZCAke3RlY2h9IWApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDEuIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5mbG9hdGluZ1RleHQgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKGBMRUFSTkVEIWAsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gUGFydGljbGUgRWZmZWN0IChTcGlyYWwpCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biBtdWx0aXBsZSBwYXJ0aWNsZXMgZm9yIGEgc3dpcmwgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDEwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGkgKiA1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5lbmRUZWNoQ29weVdpbmRvdyh0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKZW5kVGVjaENvcHlXaW5kb3coc3VjY2VzcykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlNVQ0NFU1MhIjsKICAgICAgICAgICAgICAgICAgICAvLyBGbGFzaCBzdWNjZXNzIGNvbG9yIChXaGl0ZSBmbGFzaCkKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5iYWNrZ3JvdW5kID0gInJnYmEoMjU1LCAyNTUsIDI1NSwgMC44KSI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSGlkZSBhZnRlciBzaG9ydCBkZWxheSB0byBzaG93IHRoZSBzdWNjZXNzIGZsYXNoCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOyAKICAgICAgICAgICAgICAgICAgICB9LCAzMDApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBGYWlsZWQgLyBNaXNzZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQpfdXBkYXRlUGxheWVyU3RhdHVzVUkoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtcy5ob21lIHx8ICF0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBwID0gdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgdWkgPSB0aGlzLnVpLnN0YXR1c1BhbmVsOwogICAgICAgICAgICAKLy8gVUkgVXBkYXRlcyAoQWN0aW9uIEJ1dHRvbiBDb250ZXh0KQogICAgICAgICAgICAgICAgdWkuY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOYW1lICYgTGV2ZWwKICAgICAgICAgICAgICAgIGlmICh1aS5uYW1lKSB1aS5uYW1lLmlubmVyVGV4dCA9IGAke3AuY2hhcmFjdGVyTmFtZSB8fCBwLnJvbGV9IExWJHtwLmxldmVsfWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEhQCiAgICAgICAgICAgICAgICBpZiAodWkuaHBCYXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBocFBjdCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEwMCwgKHAuc3RhdHMuSFAgLyBwLnN0YXRzLm1heEhQKSAqIDEwMCkpOwogICAgICAgICAgICAgICAgICAgIHVpLmhwQmFyLnN0eWxlLndpZHRoID0gYCR7aHBQY3R9JWA7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29sb3Igc2hpZnQKICAgICAgICAgICAgICAgICAgICBpZiAoaHBQY3QgPCAyNSkgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAwMDAsICNmZjQ0NDQpJzsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChocFBjdCA8IDUwKSB1aS5ocEJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmYwMCwgI2ZmZmY4OCknOwogICAgICAgICAgICAgICAgICAgIGVsc2UgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwMGZmMDAsICNjY2ZmY2MpJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1aS5ocFRleHQpIHVpLmhwVGV4dC5pbm5lclRleHQgPSBgJHtNYXRoLmZsb29yKHAuc3RhdHMuSFApfS8ke3Auc3RhdHMubWF4SFB9YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRVhQCiAgICAgICAgICAgICAgICBpZiAodWkuZXhwQmFyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwUGN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMTAwLCAocC5leHAgLyBwLm5leHRMZXZlbEV4cCkgKiAxMDApKTsKICAgICAgICAgICAgICAgICAgICB1aS5leHBCYXIuc3R5bGUud2lkdGggPSBgJHtleHBQY3R9JWA7CnVpLmV4cEJhci5zdHlsZS53aWR0aCA9IGAke2V4cFBjdH0lYDsKICAgICAgICAgICAgICAgIH0KICAgICAgICB9CgpfaW5pdFBhcnRpY2xlcygpIHsKICAgICAgICAgICAgdGhpcy5hY3RpdmVTcGFya3MgPSBbXTsKICAgICAgICAgICAgdGhpcy5zcGFya1Bvb2wgPSBbXTsKICAgICAgICAgICAgY29uc3QgcG9vbFNpemUgPSA0MDsgLy8gU3VmZmljaWVudCBmb3IgY29udGludW91cyBncmluZGluZwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb29sU2l6ZTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSBuZXcgVEhSRUUuU3ByaXRlKF9zcGFya01hdGVyaWFsLmNsb25lKCkpOwogICAgICAgICAgICAgICAgc3ByaXRlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHNwcml0ZSk7CiAgICAgICAgICAgICAgICB0aGlzLnNwYXJrUG9vbC5wdXNoKHNwcml0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNwYXduQ2xhc2gocG9zLCBpbnRlbnNpdHkgPSAxLjApIHsKICAgICAgICAgICAgLy8gRmluZCBmcmVlIHNwYXJrCiAgICAgICAgICAgIGNvbnN0IHNwYXJrID0gdGhpcy5zcGFya1Bvb2wuZmluZChzID0+ICFzLnZpc2libGUpOwogICAgICAgICAgICBpZiAoIXNwYXJrKSByZXR1cm47IC8vIFBvb2wgZXhoYXVzdGVkCiAgICAgICAgICAgIAogICAgICAgICAgICBzcGFyay5wb3NpdGlvbi5jb3B5KHBvcyk7CiAgICAgICAgICAgIHNwYXJrLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmFuZG9taXplIHJvdGF0aW9uCiAgICAgICAgICAgIHNwYXJrLm1hdGVyaWFsLnJvdGF0aW9uID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsaXplIEFjdGl2ZSBTdGF0ZQogICAgICAgICAgICB0aGlzLmFjdGl2ZVNwYXJrcy5wdXNoKHsKICAgICAgICAgICAgICAgIG1lc2g6IHNwYXJrLAogICAgICAgICAgICAgICAgYWdlOiAwLAogICAgICAgICAgICAgICAgbGlmZTogMC4xNSArIE1hdGgucmFuZG9tKCkgKiAwLjE1LCAvLyBGYXN0LCBwdW5jaHkgc3BhcmtzCiAgICAgICAgICAgICAgICBtYXhTY2FsZTogMi41ICogaW50ZW5zaXR5LAogICAgICAgICAgICAgICAgdmVsb2NpdHk6IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqOCwgCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSo4LCAKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKjgKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlUGFydGljbGVzKGR0KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmFjdGl2ZVNwYXJrcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuYWN0aXZlU3BhcmtzW2ldOwogICAgICAgICAgICAgICAgcC5hZ2UgKz0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChwLmFnZSA+PSBwLmxpZmUpIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlU3BhcmtzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgdCA9IHAuYWdlIC8gcC5saWZlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBFeHBhbmQKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRTY2FsZSA9IDAuNSArIChwLm1heFNjYWxlIC0gMC41KSAqIHQ7CiAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKGN1cnJlbnRTY2FsZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZhZGUgb3V0CiAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IDEuMCAtICh0ICogdCk7IC8vIFF1YWRyYXRpYyBmYWRlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE1vdmUKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5hZGRTY2FsZWRWZWN0b3IocC52ZWxvY2l0eSwgZHQpOwogICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLnJvdGF0aW9uICs9IDEwLjAgKiBkdDsKICAgICAgICAgICAgfQogICAgICAgIH0KCi8vIEhlbHBlciBmb3IgaW1wYWN0IGZyYW1lcwoKdHJpZ2dlckltcGFjdChkdXJhdGlvbiwgdHlwZSA9ICdkZWZhdWx0JykgewogICAgICAgICAgICB0aGlzLmltcGFjdFBhdXNlID0gZHVyYXRpb247CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKICAgICAgICAgICAgaWYgKCFjb250YWluZXIpIHJldHVybjsKCiAgICAgICAgICAgIC8vIFJlc2V0IGNsYXNzZXMgdG8gZW5zdXJlIGFuaW1hdGlvbiByZXN0YXJ0cwogICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZSgnaW1wYWN0LWZ4JywgJ2ltcGFjdC1oZWF2eScsICdpbXBhY3Qtc2hhdHRlcicpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRm9yY2UgcmVmbG93CiAgICAgICAgICAgIHZvaWQgY29udGFpbmVyLm9mZnNldFdpZHRoOwoKICAgICAgICAgICAgbGV0IGNsYXNzTmFtZSA9ICdpbXBhY3QtZngnOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2hlYXZ5JykgY2xhc3NOYW1lID0gJ2ltcGFjdC1oZWF2eSc7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnc2hhdHRlcicpIGNsYXNzTmFtZSA9ICdpbXBhY3Qtc2hhdHRlcic7CgogICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LmFkZChjbGFzc05hbWUpOwoKICAgICAgICAgICAgLy8gQXV0by1yZW1vdmUgY2xhc3MgYWZ0ZXIgZHVyYXRpb24KICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpOwogICAgICAgICAgICB9LCBkdXJhdGlvbiAqIDEwMDAgKyAxMDApOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5HYW1lTWFuYWdlciA9IEdhbWVNYW5hZ2VyOwp9KSgpOw==","AIPlayer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFJldXNhYmxlIHZlY3RvcnMKY29uc3QgX2FpVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF90YXJnZXRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3NjYW5EaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3NjYW5Ub09wcCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlYzEgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3RlbXBWZWMyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF90ZW1wVmVjMyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgpjbGFzcyBBSVBsYXllciBleHRlbmRzIHdpbmRvdy5mbHV4LlBsYXllciB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUsIHJvbGUpIHsKICAgICAgICAgICAgc3VwZXIoc2NlbmUsIHJvbGUpOwogICAgICAgICAgICB0aGlzLmJhbGxSZWYgPSBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhdHMgYXJlIG1hbmFnZWQgYnkgVGVhbS9NYWluIG9yIGRlZmF1bHQgUGxheWVyIHZhbHVlcy4KICAgICAgICAgICAgLy8gTm8gY29uc3RydWN0b3Igb3ZlcnJpZGVzIHRvIGVuc3VyZSBmYWlyIHNjYWxpbmcgYW5kIGRlbW8gY29uc2lzdGVuY3kuCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgLy8gU3RhdGUgTWFjaGluZQogICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnSURMRSc7CiAgICAgICAgICAgIHRoaXMuZGVjaXNpb25UaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuZGVjaXNpb25JbnRlcnZhbCA9IDAuMTsgLy8gSU1QUk9WRUQ6IEZhc3RlciBkZWNpc2lvbnMgKHdhcyAwLjIpCgogICAgICAgICAgICAvLyAtLS0gUEVSQ0VQVElPTiBTWVNURU0gKFJlYWN0aW9uIFRpbWUpIC0tLQogICAgICAgICAgICAvLyBUaGUgQUkgdHJhY2tzIGEgImdob3N0IiB0YXJnZXQgdGhhdCBsYWdzIGJlaGluZCByZWFsaXR5LgogICAgICAgICAgICAvLyBUaGlzIGFsbG93cyBodW1hbiBwbGF5ZXJzIHRvIGp1a2UvZmFrZSBvdXQgdGhlIEFJLgogICAgICAgICAgICB0aGlzLnBlcmNlaXZlZFRhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMucmVhY3Rpb25TcGVlZCA9IDguMDsgLy8gSU1QUk9WRUQ6IEZhc3RlciByZWFjdGlvbiAod2FzIDUuMCkKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBCZXR0ZXIgYW50aWNpcGF0aW9uCiAgICAgICAgICAgIHRoaXMuYW50aWNpcGF0aW9uVGltZSA9IDAuNDsgLy8gTGVhZCB0YXJnZXQgYnkgdGhpcyBtYW55IHNlY29uZHMKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJvbGUgQ29uZmlnCiAgICAgICAgICAgIHRoaXMuaXNGb3J3YXJkID0gWydMRicsICdSRiddLmluY2x1ZGVzKHJvbGUpOwogICAgICAgICAgICB0aGlzLmlzTWlkZmllbGRlciA9IHJvbGUgPT09ICdNRic7CiAgICAgICAgICAgIHRoaXMuaXNEZWZlbmRlciA9IFsnTEQnLCAnUkQnXS5pbmNsdWRlcyhyb2xlKTsKCiAgICAgICAgICAgIC8vIEFzc2lnbiBkZWZhdWx0IHRlY2huaXF1ZXMgc28gQUkgaXMgYSB0aHJlYXQKICAgICAgICAgICAgdGhpcy5fYXNzaWduRGVmYXVsdFRlY2hzKCk7CiAgICAgICAgfQoKICAgICAgICBfYXNzaWduRGVmYXVsdFRlY2hzKCkgewogICAgICAgICAgICAvLyBSYW5kb21seSBhc3NpZ24gdGVjaHMgYmFzZWQgb24gcm9sZQpjb25zdCB0YWNrbGVUZWNocyA9IFsndmVub20nLCAnd2l0aGVyJywgJ2RyYWluJ107CiAgICAgICAgICAgIGNvbnN0IHNob290VGVjaHMgPSBbJ3Zlbm9tJywgJ3NwaGVyZScsICdpbnZpc2libGUnXTsKICAgICAgICAgICAgY29uc3QgcGFzc1RlY2hzID0gWyd2ZW5vbScsICd3aXRoZXInLCAnbmFwJ107CiAgICAgICAgICAgIGNvbnN0IHBhc3NpdmVUZWNocyA9IFsnYnJhd2xlcicsICdlbGl0ZV9kZWZlbnNlJ107CgogICAgICAgICAgICAvLyBIZWxwZXIgdG8gcGljayByYW5kb20KICAgICAgICAgICAgY29uc3QgcGljayA9IChhcnIpID0+IGFycltNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBhcnIubGVuZ3RoKV07CiAgICAgICAgICAgIGNvbnN0IGNoYW5jZSA9IChwcm9iKSA9PiBNYXRoLnJhbmRvbSgpIDwgcHJvYjsKCmlmICh0aGlzLmlzRGVmZW5kZXIpIHsKICAgICAgICAgICAgICAgIC8vIERlZmVuZGVycyBsb3ZlIHN0YXR1cyB0YWNrbGVzIGFuZCBwYXNzaXZlcwogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjgpKSB0aGlzLnRlY2hzLnRhY2tsZSA9IHBpY2sodGFja2xlVGVjaHMpOwogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjMpKSB0aGlzLnRlY2hzLnBhc3MgPSBwaWNrKHBhc3NUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuNSkpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzTWlkZmllbGRlcikgewogICAgICAgICAgICAgICAgLy8gTWlkZmllbGRlcnMgYXJlIGJhbGFuY2VkCiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuNikpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuNikpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4zKSkgdGhpcy50ZWNocy5zaG9vdCA9IHBpY2soc2hvb3RUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMykpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgLy8gRm9yd2FyZHMgZm9jdXMgb24gc2hvb3RpbmcKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC45KSkgdGhpcy50ZWNocy5zaG9vdCA9IHBpY2soc2hvb3RUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuNCkpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7IC8vIEZyb250bGluZSBwcmVzc3VyZQogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjIpKSB0aGlzLnRlY2hzLnBhc3NpdmUgPSBwaWNrKHBhc3NpdmVUZWNocyk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgLy8gU2FmZXR5OiBBdXRvLWxpbmsgYmFsbCBpZiBtaXNzaW5nIChTZWxmLWhlYWxpbmcpCiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFsbFJlZiA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAwLiBDaGVjayBpZiBBSSBsb2dpYyBzaG91bGQgcnVuCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGlzRGVtbyA9IGdhbWUgJiYgZ2FtZS5pc0RlbW9Nb2RlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2hlY2sgaW5jYXBhY2l0YXRpb24gKFN0dW4gb3IgTmFwKQogICAgICAgICAgICBjb25zdCBpc0luY2FwYWNpdGF0ZWQgPSAodGhpcy5zdHVuVGltZXIgPiAwKSB8fCAodGhpcy5zdGF0dXMubmFwID4gMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBSSBydW5zIGlmOgogICAgICAgICAgICAvLyAxLiBJdCdzIGFuIEFJIHRlYW0gKG5vdCBodW1hbikKICAgICAgICAgICAgLy8gMi4gSXQncyBhIEh1bWFuIHRlYW0gQlVUIERlbW8gTW9kZSBpcyBPTgogICAgICAgICAgICAvLyAzLiBJdCdzIGEgSHVtYW4gdGVhbSwgRGVtbyBpcyBPRkYsIGJ1dCB0aGlzIHBsYXllciBpcyBOT1QgdGhlIGFjdGl2ZSBjb250cm9sbGVkIHBsYXllcgogICAgICAgICAgICBjb25zdCBpc0h1bWFuVGVhbSA9IHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uaXNIdW1hbjsKICAgICAgICAgICAgY29uc3QgaXNBY3RpdmVQbGF5ZXIgPSB0aGlzLnRlYW0gJiYgKHRoaXMudGVhbS5hY3RpdmVQbGF5ZXIgPT09IHRoaXMpOwogICAgICAgICAgICBjb25zdCBzaG91bGRSdW5BSSA9ICghaXNIdW1hblRlYW0gfHwgaXNEZW1vIHx8IChpc0h1bWFuVGVhbSAmJiAhaXNBY3RpdmVQbGF5ZXIpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hc3RlciBBSSBTd2l0Y2ggZm9yIHRoZSB0ZWFtCiAgICAgICAgICAgIGNvbnN0IGlzVGVhbUFJRW5hYmxlZCA9IHRoaXMudGVhbSA/IHRoaXMudGVhbS5haUVuYWJsZWQgOiB0cnVlOwoKICAgICAgICAgICAgaWYgKGlzSW5jYXBhY2l0YXRlZCkgewogICAgICAgICAgICAgICAgLy8gSWYgc3R1bm5lZC9zbGVlcGluZywgZG8gbm90aGluZy4KICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2hvdWxkUnVuQUkgJiYgaXNUZWFtQUlFbmFibGVkKSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gSU1QUk9WRUQgUEVSQ0VQVElPTiBVUERBVEUgLS0tCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgcGVyY2VpdmVkIHBvc2l0aW9uIHRvd2FyZHMgcmVhbCB0YXJnZXQgKEJhbGwgb3IgQmFsbCBIb2xkZXIpCiAgICAgICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmICYmIHRoaXMuYmFsbFJlZi5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHJlYWxUYXJnZXQgPSB0aGlzLmJhbGxSZWYubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBJZiBiYWxsIGlzIGhlbGQsIHRyYWNrIHRoZSBob2xkZXIgd2l0aCBhbnRpY2lwYXRpb24KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmLmhvbGRlciAmJiB0aGlzLmJhbGxSZWYuaG9sZGVyLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVhbFRhcmdldCA9IHRoaXMuYmFsbFJlZi5ob2xkZXIubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IExlYWQgdGhlIHRhcmdldCBiYXNlZCBvbiB0aGVpciB2ZWxvY2l0eQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmLmhvbGRlci52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhbFRhcmdldC5hZGRTY2FsZWRWZWN0b3IodGhpcy5iYWxsUmVmLmhvbGRlci52ZWxvY2l0eSwgdGhpcy5hbnRpY2lwYXRpb25UaW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5iYWxsUmVmLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvciBsb29zZSBiYWxsLCBhbnRpY2lwYXRlIGJhc2VkIG9uIGJhbGwgdmVsb2NpdHkKICAgICAgICAgICAgICAgICAgICAgICAgcmVhbFRhcmdldC5hZGRTY2FsZWRWZWN0b3IodGhpcy5iYWxsUmVmLnZlbG9jaXR5LCB0aGlzLmFudGljaXBhdGlvblRpbWUgKiAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gTGVycCBwZXJjZXB0aW9uIHRvd2FyZHMgYW50aWNpcGF0ZWQgcmVhbGl0eQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFscGhhID0gTWF0aC5taW4oMS4wLCBkdCAqIHRoaXMucmVhY3Rpb25TcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJjZWl2ZWRUYXJnZXRQb3MubGVycChyZWFsVGFyZ2V0LCBhbHBoYSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMS4gRGVjaXNpb24gTWFraW5nCiAgICAgICAgICAgICAgICB0aGlzLmRlY2lzaW9uVGltZXIgKz0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWNpc2lvblRpbWVyID4gdGhpcy5kZWNpc2lvbkludGVydmFsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWNpc2lvblRpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9ldmFsdWF0ZVN0YXRlKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMi4gRXhlY3V0ZSBTdGF0ZSAoU2V0cyBpbnB1dFZlY3RvcikKICAgICAgICAgICAgICAgIHRoaXMuX2V4ZWN1dGVTdGF0ZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDMuIEludGVyY2VwdGlvbiBMb2dpYwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnRlcmNlcHRpb25QcmVzc3VyZShkdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBIZXJlIGlmOgogICAgICAgICAgICAgICAgLy8gMS4gQ29udHJvbGxlZCBieSBIdW1hbiAoc2hvdWxkUnVuQUkgPT0gZmFsc2UpCiAgICAgICAgICAgICAgICAvLyAyLiBBSSBMb2dpYyBpcyBEaXNhYmxlZCAoaXNUZWFtQUlFbmFibGVkID09IGZhbHNlKQoKICAgICAgICAgICAgICAgIC8vIElmIEFJIGlzIGRpc2FibGVkLCB3ZSBtdXN0IHN0b3AgdGhlIGJvdCBVTkxFU1MgaXQgaXMgYmVpbmcgZHJpdmVuIGJ5IGh1bWFuIGlucHV0LgogICAgICAgICAgICAgICAgLy8gSHVtYW4gaW5wdXQgZHJpdmVzIHRoZSBwbGF5ZXIgaWY6IGlzSHVtYW5UZWFtIEFORCBpc0FjdGl2ZVBsYXllciBBTkQgIWlzRGVtbwogICAgICAgICAgICAgICAgY29uc3QgaXNEcml2ZW5CeUh1bWFuID0gaXNIdW1hblRlYW0gJiYgaXNBY3RpdmVQbGF5ZXIgJiYgIWlzRGVtbzsKCiAgICAgICAgICAgICAgICBpZiAoIWlzVGVhbUFJRW5hYmxlZCAmJiAhaXNEcml2ZW5CeUh1bWFuKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBXZSBzdGlsbCBhcHBseSBwYXNzaXZlIGludGVyY2VwdGlvbiBpZiBpbiB0aGUgd2F5LgogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnRlcmNlcHRpb25QcmVzc3VyZShkdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIEJhc2UgVXBkYXRlCiAgICAgICAgICAgIHN1cGVyLnVwZGF0ZShkdCk7CiAgICAgICAgfQoKX2V2YWx1YXRlU3RhdGUoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CgogICAgICAgICAgICAvLyAxLiBJIGhhdmUgdGhlIGJhbGwKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0FUVEFDS19DQVJSWSc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIExvb3NlIEJhbGwgTG9naWMgKEFudGktRmxvY2tpbmcpCiAgICAgICAgICAgIGlmICghYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQ6IFJldHVybiB0byBmb3JtYXRpb24uIE9ubHkgY2hhc2UgaWYgd2UgYXJlIHRoZSBiZXN0IGNhbmRpZGF0ZS4KICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdSRVRVUk5fSE9NRSc7CgovLyBIeXN0ZXJlc2lzOiBJZiBJIHdhcyBhbHJlYWR5IGNoYXNpbmcsIEknbSBlZmZlY3RpdmVseSAiY2xvc2VyIiB0byBwcmV2ZW50IGppdHRlcnkgc3dpdGNoaW5nCiAgICAgICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIHR3byBwbGF5ZXJzIGZyb20gc3dhcHBpbmcgcm9sZXMgcmFwaWRseSB3aGVuIGVxdWlkaXN0YW50LgogICAgICAgICAgICAgICAgY29uc3QgYmlhcyA9ICh0aGlzLmFpU3RhdGUgPT09ICdDSEFTRScpID8gMC44IDogMS4wOwogICAgICAgICAgICAgICAgY29uc3QgbXlEaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKSAqIGJpYXM7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBpc0Nsb3Nlc3QgPSB0cnVlOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAgPT09IHRoaXMpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgR29hbGllIChHb2FsaWUgaGFuZGxlcyB0aGVpciBvd24gYXJlYTsgZmllbGQgcGxheWVycyBzaG91bGRuJ3QgcmVseSBvbiB0aGVtKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5yb2xlID09PSAnR0wnKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSBpbmNhcGFjaXRhdGVkIHRlYW1tYXRlcwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29udGludWU7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgdGVhbW1hdGUgZGlzdGFuY2UKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTm90ZTogV2UgZG9uJ3QgYXBwbHkgYmlhcyB0byBvdGhlcnMsIGVmZmVjdGl2ZWx5IG1ha2luZyAibWUiIHN0aWNraWVyIGlmIEknbSBhbHJlYWR5IGNoYXNpbmcKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcERpc3QgPSBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgYSB0ZWFtbWF0ZSBpcyBjbG9zZXIsIHlpZWxkIHRvIHRoZW0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBEaXN0IDwgbXlEaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0Nsb3Nlc3QgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQp9CgogICAgICAgICAgICAgICAgaWYgKGlzQ2xvc2VzdCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdDSEFTRSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIFRlYW1tYXRlIGhhcyBiYWxsCiAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlci50ZWFtID09PSB0aGlzLnRlYW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdTVVBQT1JUJzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNC4gT3Bwb25lbnQgaGFzIGJhbGwKICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0RFRkVORCc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9leGVjdXRlU3RhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmJhbGxSZWYpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN3aXRjaCAodGhpcy5haVN0YXRlKSB7CiAgICAgICAgICAgICAgICBjYXNlICdBVFRBQ0tfQ0FSUlknOiB0aGlzLl9zdGF0ZUF0dGFja0NhcnJ5KGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdTVVBQT1JUJzogdGhpcy5fc3RhdGVTdXBwb3J0KGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdERUZFTkQnOiB0aGlzLl9zdGF0ZURlZmVuZChkdCk7IGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnQ0hBU0UnOiB0aGlzLl9zdGF0ZUNoYXNlKGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdSRVRVUk5fSE9NRSc6IAogICAgICAgICAgICAgICAgZGVmYXVsdDogdGhpcy5fc3RhdGVSZXR1cm5Ib21lKGR0KTsgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIC0tLSBTVEFURVMgLS0tCgpfc3RhdGVBdHRhY2tDYXJyeShkdCkgewogICAgICAgICAgICAvLyBEcml2ZSB0byBnb2FsCiAgICAgICAgICAgIC8vIEhvbWUgKFNpZGUgMSkgYXR0YWNrcyAtWi4gQXdheSAoU2lkZSAtMSkgYXR0YWNrcyArWi4KICAgICAgICAgICAgY29uc3QgYXR0YWNrRGlyID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKY29uc3QgZ29hbFogPSA0NiAqIGF0dGFja0RpcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRhcmdldDogR29hbCAoYnV0IHJlc3BlY3QgY3JlYXNlKQogICAgICAgICAgICBfdGFyZ2V0UG9zLnNldCgwLCAwLCBnb2FsWik7CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwoKICAgICAgICAgICAgLy8gRGVjaXNpb246IFNob290IG9yIFBhc3M/CiAgICAgICAgICAgIGNvbnN0IGRpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDEuIFNob290IGlmIGNsb3NlIGFuZCBjbGVhcgogICAgICAgICAgICBpZiAoZGlzdFRvR29hbCA8IDIwLjAgJiYgIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdTSCcpOyAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMi4gUGFzcyBMb2dpYwogICAgICAgICAgICAvLyBDaGVjayBwYXNzIGlmOiBTdXJyb3VuZGVkLCBMb3cgRU4sIG9yIFBsYXltYWtlciAoTWlkZmllbGRlcikgc2VlcyBvcHBvcnR1bml0eQogICAgICAgICAgICBjb25zdCBpc1N1cnJvdW5kZWQgPSB0aGlzLl9pc1N1cnJvdW5kZWQoKTsKICAgICAgICAgICAgY29uc3QgbG93RU4gPSB0aGlzLmN1cnJlbnRFTiA8IDEwOwogICAgICAgICAgICBjb25zdCBpc1BsYXltYWtlciA9IHRoaXMuaXNNaWRmaWVsZGVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKChpc1N1cnJvdW5kZWQgfHwgbG93RU4gfHwgaXNQbGF5bWFrZXIpICYmICF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJlc3RNYXRlID0gdGhpcy5fZmluZEJlc3RQYXNzVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChiZXN0TWF0ZSkgewogICAgICAgICAgICAgICAgICAgIC8vIEV2YWx1YXRlIGlmIHBhc3MgaXMgd29ydGggaXQKICAgICAgICAgICAgICAgICAgICAvLyBJZiBQbGF5bWFrZXIsIHBhc3MgaWYgbWF0ZSBpcyBjbG9zZXIgdG8gZ29hbAogICAgICAgICAgICAgICAgICAgIC8vIElmIFBhbmljIChTdXJyb3VuZGVkL0xvd0VOKSwgcGFzcyB0byBhbnlvbmUgb3BlbgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxldCBzaG91bGRQYXNzID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3Vycm91bmRlZCB8fCBsb3dFTikgewogICAgICAgICAgICAgICAgICAgICAgICBzaG91bGRQYXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzUGxheW1ha2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG15RGlzdCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRlRGlzdCA9IE1hdGguYWJzKGJlc3RNYXRlLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGVEaXN0IDwgbXlEaXN0IC0gNS4wKSBzaG91bGRQYXNzID0gdHJ1ZTsgLy8gTWF0ZSBpcyA1bSBjbG9zZXIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHNob3VsZFBhc3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmFjZSB0YXJnZXQKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdChiZXN0TWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRXhlY3V0ZSBQYXNzCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3NtYXJ0VGhyb3codGhpcy5iYWxsUmVmLCAnUEEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gUGFuaWMgQ2xlYXIgKElmIHN1cnJvdW5kZWQgYW5kIG5vIHBhc3MpCiAgICAgICAgICAgIGlmIChpc1N1cnJvdW5kZWQgJiYgIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgLy8gSnVzdCBzaG9vdC9jbGVhcgogICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdTSCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfaXNTdXJyb3VuZGVkKCkgewogICAgICAgICAgICAvLyBTaW1wbGUgY2hlY2s6IGNvdW50IGVuZW1pZXMgbmVhcmJ5CiAgICAgICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmIChwLm1lc2ggJiYgcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5tZXNoLnBvc2l0aW9uKSA8IDQuMCkgewogICAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvdW50ID49IDI7CiAgICAgICAgfQoKX3NtYXJ0VGhyb3coYmFsbCwgZm9yY2VkVHlwZSA9IG51bGwpIHsKICAgICAgICAgICAgLy8gV3JhcHBlciBhcm91bmQgdGhyb3dCYWxsIHRvIG1hbmFnZSBIUCBhbmQgVGVjaHMKICAgICAgICAgICAgLy8gMS4gRGV0ZXJtaW5lIGludGVuZGVkIGFjdGlvbiB0eXBlCiAgICAgICAgICAgIGxldCB0eXBlID0gZm9yY2VkVHlwZTsKICAgICAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICBjb25zdCBhdHRhY2tEaXIgPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKICAgICAgICAgICAgICAgIGNvbnN0IGlzQWltaW5nR29hbCA9IChfdGVtcFZlYzEueiAqIGF0dGFja0RpciA+IDAuNSk7CiAgICAgICAgICAgICAgICB0eXBlID0gaXNBaW1pbmdHb2FsID8gJ1NIJyA6ICdQQSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIEdldCBUZWNoCiAgICAgICAgICAgIGNvbnN0IHRlY2hOYW1lID0gKHR5cGUgPT09ICdTSCcpID8gdGhpcy50ZWNocy5zaG9vdCA6IHRoaXMudGVjaHMucGFzczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDMuIEVzdGltYXRlIENvc3QKICAgICAgICAgICAgbGV0IGJhc2VDb3N0ID0gKHR5cGUgPT09ICdTSCcpID8gMjAgOiAxMDsKICAgICAgICAgICAgbGV0IHRlY2hDb3N0ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgLy8gUm91Z2ggZXN0aW1hdGVzIGJhc2VkIG9uIFBsYXllci5qcwogICAgICAgICAgICAgICAgaWYgKHRlY2hOYW1lLmluY2x1ZGVzKCduYXAnKSkgdGVjaENvc3QgPSAzMDsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2hOYW1lLmluY2x1ZGVzKCdzcGhlcmUnKSB8fCB0ZWNoTmFtZS5pbmNsdWRlcygnaW52aXNpYmxlJykpIHRlY2hDb3N0ID0gMjU7CiAgICAgICAgICAgICAgICBlbHNlIHRlY2hDb3N0ID0gMjA7IC8vIFZlbm9tL1dpdGhlcgogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCB0b3RhbENvc3QgPSBiYXNlQ29zdCArIHRlY2hDb3N0OwoKICAgICAgICAgICAgLy8gNC4gRGVjaXNpb24KICAgICAgICAgICAgLy8gSWYgd2UgaGF2ZSBhIHRlY2ggYnV0IG5vdCBlbm91Z2ggSFAgZm9yIGl0LCBCVVQgZW5vdWdoIEhQIGZvciBub3JtYWwuLi4KICAgICAgICAgICAgLy8gRGlzYWJsZSB0ZWNoIHRlbXBvcmFyaWx5IHRvIGF2b2lkICJUaXJlZCIgcGVuYWx0eSAoMC41eCBzdGF0cykKICAgICAgICAgICAgbGV0IHRlbXBUZWNoID0gbnVsbDsKICAgICAgICAgICAgaWYgKHRlY2hOYW1lICYmIHRoaXMuc3RhdHMuSFAgPCB0b3RhbENvc3QgJiYgdGhpcy5zdGF0cy5IUCA+PSBiYXNlQ29zdCkgewogICAgICAgICAgICAgICAgLy8gVW5lcXVpcAogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wVGVjaCA9IHRoaXMudGVjaHMuc2hvb3Q7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWNocy5zaG9vdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRlbXBUZWNoID0gdGhpcy50ZWNocy5wYXNzOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGVjaHMucGFzcyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEV4ZWN1dGUKICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgdHlwZSk7CgogICAgICAgICAgICAvLyBSZXN0b3JlCiAgICAgICAgICAgIGlmICh0ZW1wVGVjaCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHRoaXMudGVjaHMuc2hvb3QgPSB0ZW1wVGVjaDsKICAgICAgICAgICAgICAgIGVsc2UgdGhpcy50ZWNocy5wYXNzID0gdGVtcFRlY2g7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpfc3RhdGVDaGFzZShkdCkgewogICAgICAgICAgICAvLyBJbnRlcmNlcHRpb246IENoYXNlIHRoZSBQRVJDRUlWRUQgcG9zaXRpb24sIG5vdCB0aGUgcmVhbCBvbmUuCiAgICAgICAgICAgIC8vIFRoaXMgYWxsb3dzIGp1a2VzIHRvIHdvcmsgYmVjYXVzZSB0aGUgQUkgaXMgY2hhc2luZyB3aGVyZSB5b3UgV0VSRS4KICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElmIGJhbGwgaGFzIHZlbG9jaXR5LCBsZWFkIGl0IHNsaWdodGx5IGJhc2VkIG9uIHBlcmNlcHRpb24KICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKICAgICAgICAgICAgaWYgKGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDEuMCkgewogICAgICAgICAgICAgICAgX3RhcmdldFBvcy5hZGRTY2FsZWRWZWN0b3IoYmFsbC52ZWxvY2l0eSwgMC4zKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CiAgICAgICAgfQoKX3N0YXRlUmV0dXJuSG9tZShkdCkgewogICAgICAgICAgICAvLyBSZXR1cm4gdG8gZm9ybWF0aW9uIHBvc2l0aW9uCiAgICAgICAgICAgIF90YXJnZXRQb3MuY29weSh0aGlzLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwogICAgICAgIH0KCl9zdGF0ZVN1cHBvcnQoZHQpIHsKICAgICAgICAgICAgLy8gT0ZGRU5TRSAoVGVhbW1hdGUgaGFzIGJhbGwpCiAgICAgICAgICAgIC8vIEdvYWw6IEZpbmQgb3BlbiBzcGFjZSB0byByZWNlaXZlIGEgcGFzcwogICAgICAgICAgICBjb25zdCBiYWxsUG9zID0gdGhpcy5iYWxsUmVmLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IGF0dGFja0RpciA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtMSA6IDE7CmNvbnN0IGdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC00NiA6IDQ2OwoKICAgICAgICAgICAgLy8gMS4gRGV0ZXJtaW5lICJJZGVhbCIgU3VwcG9ydCBQb3NpdGlvbgogICAgICAgICAgICAvLyBTdGFydCB3aXRoIGZvcm1hdGlvbiBob21lCiAgICAgICAgICAgIF90YXJnZXRQb3MuY29weSh0aGlzLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAyLiBEeW5hbWljIEFkanVzdG1lbnQKICAgICAgICAgICAgaWYgKHRoaXMuaXNGb3J3YXJkKSB7CiAgICAgICAgICAgICAgICAvLyBGb3J3YXJkczogTWFrZSBydW5zIHRvd2FyZHMgdGhlIGdvYWwvYm94CiAgICAgICAgICAgICAgICAvLyBJZiBiYWxsIGlzIGRlZXAsIGN1dCB0byBjZW50ZXIuIElmIGJhbGwgaXMgYmFjaywgcHVzaCBsaW5lLgogICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gYmFsbFBvcy56ICsgKGF0dGFja0RpciAqIDEwLjApOyAvLyBTdGF5IGFoZWFkIG9mIGJhbGwKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gWmlnLXphZyBydW4gcGF0dGVybiBiYXNlZCBvbiB0aW1lIHRvIGxvb2sgImFsaXZlIgogICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IERhdGUubm93KCkgKiAwLjAwMTsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueCArPSBNYXRoLnNpbih0aW1lICsgdGhpcy5tZXNoLmlkKSAqIDUuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNNaWRmaWVsZGVyKSB7CiAgICAgICAgICAgICAgICAvLyBNaWRmaWVsZGVyczogRmluZCBwb2NrZXQgYmV0d2VlbiBiYWxsIGFuZCBnb2FsCiAgICAgICAgICAgICAgICBfdGVtcFZlYzEuc2V0KDAsIDAsIGdvYWxaKTsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MubGVycFZlY3RvcnMoYmFsbFBvcywgX3RlbXBWZWMxLCAwLjQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTdGF5IHdpZGUgaWYgYmFsbCBpcyBjZW50cmFsLCBjb21lIGNlbnRyYWwgaWYgYmFsbCBpcyB3aWRlCiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoYmFsbFBvcy54KSA8IDUpIF90YXJnZXRQb3MueCA9ICh0aGlzLmhvbWVQb3NpdGlvbi54ID4gMCA/IDEwIDogLTEwKTsKICAgICAgICAgICAgICAgIGVsc2UgX3RhcmdldFBvcy54ID0gMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIERlZmVuZGVyczogU3VwcG9ydCBmcm9tIGJlaGluZCAoc2FmZXR5IHZhbHZlKQogICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gYmFsbFBvcy56IC0gKGF0dGFja0RpciAqIDguMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIEF2b2lkIERlZmVuZGVycyAoUmF5Y2FzdC1pc2ggY2hlY2spCiAgICAgICAgICAgIC8vIElmIGEgZGVmZW5kZXIgaXMgbmVhciBteSB0YXJnZXQsIHNoaWZ0IGF3YXkKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKGdhbWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAodGhpcy50ZWFtLmlkID09PSAnaG9tZScpID8gZ2FtZS50ZWFtcy5hd2F5IDogZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wcC5tZXNoICYmIG9wcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oX3RhcmdldFBvcykgPCA0LjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVmZW5kZXIgaXMgY2xvZ2dpbmcgbXkgc3BvdC4gU2hpZnQgYXdheSBmcm9tIHRoZW0uCiAgICAgICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMi5jb3B5KF90YXJnZXRQb3MpLnN1YihvcHAubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjMiwgNS4wKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIENsYW1wIHRvIEFyZW5hICYgQ3JlYXNlCiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKCiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICB9Cgpfc3RhdGVEZWZlbmQoZHQpIHsKICAgICAgICAgICAgLy8gREVGRU5TRSAoT3Bwb25lbnQgaGFzIGJhbGwpCiAgICAgICAgICAgIC8vIFVzZSBQZXJjZWl2ZWQgUG9zaXRpb24gZm9yIGRpc3RhbmNlIGNoZWNrcyBhbmQgbW92ZW1lbnQKICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9zID0gdGhpcy5wZXJjZWl2ZWRUYXJnZXRQb3M7CiAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXRQb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMS4gRGV0ZXJtaW5lIFByZXNzIFJhbmdlCiAgICAgICAgICAgIC8vIEJhc2UgcmFuZ2UKLy8gQmFzZSByYW5nZQogICAgICAgICAgICBsZXQgcHJlc3NSYW5nZSA9IHRoaXMuaXNEZWZlbmRlciA/IDIwLjAgOiAxNS4wOyAvLyBJbmNyZWFzZWQgYWdncmVzc2lvbiByYW5nZQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQWdncmVzc2l2ZSBUZWNoIFVzYWdlCiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnRhY2tsZSAmJiB0aGlzLnN0YXRzLkhQID4gMjApIHsKICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgKz0gNS4wOyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIEFOVEktU1dBUk0gTE9HSUMgJiBBR0dSRVNTSU9OIC0tLQogICAgICAgICAgICAvLyBPbmx5IHRoZSBjbG9zZXN0IGRlZmVuZGVyIHNob3VsZCBoYXJkLXByZXNzIGZyb20gZGlzdGFuY2UuCiAgICAgICAgICAgIC8vIE90aGVycyBzaG91bGQgc3RpY2sgdG8gdGhlaXIgem9uZXMvbWFya3MgdW5sZXNzIHRoZSBiYWxsIGVudGVycyB0aGVpciBwZXJzb25hbCBzcGFjZS4KICAgICAgICAgICAgbGV0IGFtSUNsb3Nlc3QgPSB0cnVlOwogICAgICAgICAgICBjb25zdCBteURpc3RTcSA9IGRpc3RUb0JhbGwgKiBkaXN0VG9CYWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgZm9yKGNvbnN0IG1hdGUgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcyB8fCAhbWF0ZS5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgR29hbGllIGFuZCBpbmNhcGFjaXRhdGVkIHRlYW1tYXRlcwogICAgICAgICAgICAgICAgICAgIGlmIChtYXRlLnJvbGUgPT09ICdHTCcgfHwgbWF0ZS5zdGF0dXMubmFwID4gMCB8fCBtYXRlLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFVzZSByZWFsIHBvc2l0aW9ucyBmb3IgdGVhbW1hdGUgY29tcGFyaXNvbiAoQUkga25vd3Mgd2hlcmUgdGVhbW1hdGVzIGFyZSkKICAgICAgICAgICAgICAgICAgICBjb25zdCBkU3EgPSBtYXRlLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUb1NxdWFyZWQodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZFNxIDwgbXlEaXN0U3EpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYW1JQ2xvc2VzdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFpPTUJJRSBGSVg6IElmIEkgYW0gdGhlIGNsb3Nlc3QsIEkgTVVTVCBDSEFTRS4KICAgICAgICAgICAgLy8gU2V0IHByZXNzUmFuZ2UgdG8gZXNzZW50aWFsbHkgaW5maW5pdGUgaWYgY2xvc2VzdCwgc28gdGhleSBkb24ndCBqdXN0IHN0YW5kIHRoZXJlLgovLyBaT01CSUUgRklYOiBJZiBJIGFtIHRoZSBjbG9zZXN0LCBJIE1VU1QgQ0hBU0UuCiAgICAgICAgICAgIC8vIFNldCBwcmVzc1JhbmdlIHRvIGVzc2VudGlhbGx5IGluZmluaXRlIGlmIGNsb3Nlc3QsIHNvIHRoZXkgZG9uJ3QganVzdCBzdGFuZCB0aGVyZS4KICAgICAgICAgICAgaWYgKGFtSUNsb3Nlc3QpIHsKICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgPSAxMDAuMDsgLy8gSW5maW5pdGUgY2hhc2UKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb015R29hbCA9IE1hdGguYWJzKHRhcmdldFBvcy56IC0gKHRoaXMudGVhbS5zaWRlID09PSAxID8gNDYgOiAtNDYpKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9NeUdvYWwgPCA0MC4wKSB7CiAgICAgICAgICAgICAgICAgICAgcHJlc3NSYW5nZSA9IDI1LjA7IC8vIEFnZ3Jlc3NpdmUgem9uZSBkZWZlbnNlCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgPSAxMC4wOyAvLyBMb29zZXIgbWFya2luZyBpbiBtaWRmaWVsZAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIElmIGJhbGwgaXMgY2xvc2UgZW5vdWdoIChiYXNlZCBvbiBjb250ZXh0KSwgUFJFU1MgSVQKICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCBwcmVzc1JhbmdlKSB7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gTWFyayBNb2RlIChNYW4tdG8tTWFuKQogICAgICAgICAgICAvLyBJZiBJIGhhdmUgYSBtYXJrIGFzc2lnbmVkLCBzdGljayB0byB0aGVtIHVubGVzcyBwcmVzc2luZyBiYWxsCiAgICAgICAgICAgIGlmICh0aGlzLm1hcmtpbmcgJiYgdGhpcy5tYXJraW5nLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG1hcmtQb3MgPSB0aGlzLm1hcmtpbmcubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUG9zaXRpb246IEJldHdlZW4gbWFyayBhbmQgbXkgZ29hbCAoR29hbCBTaWRlKQpjb25zdCBteUdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IDQ2IDogLTQ2OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZWN0b3IgZnJvbSBNYXJrIHRvIEdvYWwKICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5zZXQoMCwgMCwgbXlHb2FsWiAtIG1hcmtQb3Mueik7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gX3RlbXBWZWMxLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgX3RlbXBWZWMxLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTdGFuZCAzLjUgdW5pdHMgdG93YXJkcyBnb2FsIGZyb20gdGhlIG1hcmsgKEluY3JlYXNlZCBmcm9tIDIuMCB0byBnaXZlIGJyZWF0aGluZyByb29tKQogICAgICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KG1hcmtQb3MpLmFkZFNjYWxlZFZlY3RvcihfdGVtcFZlYzEsIDMuNSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gWm9uZSBEZWZlbnNlIChGb3JtYXRpb24gKyBTbGlkZSkKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNsaWRlIGxvZ2ljIChTaGlmdCBmb3JtYXRpb24gdG93YXJkcyBiYWxsIHNpZGUpCiAgICAgICAgICAgIF90YXJnZXRQb3MueiArPSBiYWxsUG9zLnogKiAwLjY7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEZWZlbmRlciBPdmVycmlkZTogQWx3YXlzIHN0YXkgYmV0d2VlbiBiYWxsIGFuZCBnb2FsCi8vIERlZmVuZGVyIE92ZXJyaWRlOiBBbHdheXMgc3RheSBiZXR3ZWVuIGJhbGwgYW5kIGdvYWwKICAgICAgICAgICAgaWYgKHRoaXMuaXNEZWZlbmRlcikgewogICAgICAgICAgICAgICAgY29uc3QgbXlHb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyA0NiA6IC00NjsKICAgICAgICAgICAgICAgIGNvbnN0IG1pZHBvaW50ID0gKGJhbGxQb3MueiArIG15R29hbFopICogMC41OwogICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gKF90YXJnZXRQb3MueiArIG1pZHBvaW50KSAqIDAuNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2xhbXAKLy8gQ2xhbXAKICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gTWF0aC5tYXgoLTQ0LjAsIE1hdGgubWluKDQ0LjAsIF90YXJnZXRQb3MueikpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CiAgICAgICAgfQoKX2F2b2lkR29hbENyZWFzZSh0YXJnZXRQb3MpIHsKICAgICAgICAgICAgLy8gMS4gR29hbCBDcmVhc2UgQXZvaWRhbmNlIChSYWRpdXMgMTAgYXJvdW5kIGdvYWxzIGF0ICsvLSAyOCkKICAgICAgICAgICAgLy8gTWF0Y2hlcyBQbGF5ZXIuanMgX2FwcGx5R29hbENyZWFzZSBwaHlzaWNzIHRvIHByZXZlbnQgc3R1dHRlcmluZwovLyAxLiBHb2FsIENyZWFzZSBBdm9pZGFuY2UgKFJhZGl1cyAxMCBhcm91bmQgZ29hbHMgYXQgKy8tIDI4KQogICAgICAgICAgICAvLyBNYXRjaGVzIFBsYXllci5qcyBfYXBwbHlHb2FsQ3JlYXNlIHBoeXNpY3MgdG8gcHJldmVudCBzdHV0dGVyaW5nCi8vIE1hdGNoZXMgUGxheWVyLmpzIF9hcHBseUdvYWxDcmVhc2UgcGh5c2ljcyB0byBwcmV2ZW50IHN0dXR0ZXJpbmcKICAgICAgICAgICAgY29uc3QgY3JlYXNlUmFkaXVzID0gMTAuMDsKICAgICAgICAgICAgY29uc3QgZ29hbHMgPSBbCiAgICAgICAgICAgICAgICB7IHg6IDAsIHo6IC00NiB9CiAgICAgICAgICAgIF07CgogICAgICAgICAgICBnb2Fscy5mb3JFYWNoKGdvYWwgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZHggPSB0YXJnZXRQb3MueCAtIGdvYWwueDsKICAgICAgICAgICAgICAgIGNvbnN0IGR6ID0gdGFyZ2V0UG9zLnogLSBnb2FsLno7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR6KmR6OwoKICAgICAgICAgICAgICAgIGlmIChkaXN0U3EgPCBjcmVhc2VSYWRpdXMgKiBjcmVhc2VSYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJbnNpZGUgY3JlYXNlLCBwcm9qZWN0IHRvIGVkZ2UKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPiAwLjAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IGNyZWFzZVJhZGl1cyAvIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy54ID0gZ29hbC54ICsgZHggKiByYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnogPSBnb2FsLnogKyBkeiAqIHJhdGlvOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEV4YWN0IGNlbnRlciwgcHVzaCBvdXQgdG93YXJkcyBjZW50ZXIgZmllbGQKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnogPSBnb2FsLnogKyAoZ29hbC56ID4gMCA/IC1jcmVhc2VSYWRpdXMgOiBjcmVhc2VSYWRpdXMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgovLyAyLiBBcmVuYSBCb3VuZGFyeSBDbGFtcAogICAgICAgICAgICBjb25zdCBhcmVuYVJhZGl1cyA9IDQ1LjA7IC8vIEtlZXAgc2xpZ2h0bHkgaW5zaWRlIHZpc3VhbC9waHlzaWNzIHdhbGwKICAgICAgICAgICAgY29uc3QgZFNxID0gdGFyZ2V0UG9zLnggKiB0YXJnZXRQb3MueCArIHRhcmdldFBvcy56ICogdGFyZ2V0UG9zLno7CgogICAgICAgICAgICBpZiAoZFNxID4gYXJlbmFSYWRpdXMqYXJlbmFSYWRpdXMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGQgPSBNYXRoLnNxcnQoZFNxKTsKICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBhcmVuYVJhZGl1cyAvIGQ7CiAgICAgICAgICAgICAgICB0YXJnZXRQb3MueCAqPSByOwogICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnogKj0gcjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2ZpbmRCZXN0UGFzc1RhcmdldCgpIHsKICAgICAgICAgICAgbGV0IGJlc3RUYXJnZXQgPSBudWxsOwogICAgICAgICAgICBsZXQgbWF4U2NvcmUgPSAtSW5maW5pdHk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBdHRhY2sgZGlyZWN0aW9uICYgR29hbCBaCiAgICAgICAgICAgIGNvbnN0IGF0dGFja0RpciA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtMSA6IDE7IC8vIEhvbWUgYXR0YWNrcyAtWgpjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtNDYgOiA0NjsKCiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKG1hdGUgPT09IHRoaXMpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKCFtYXRlLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKG1hdGUuc3RhdHVzLm5hcCA+IDApIGNvbnRpbnVlOyAvLyBEb24ndCBwYXNzIHRvIHNsZWVwZXJzCiAgICAgICAgICAgICAgICBpZiAobWF0ZS5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsgIC8vIERvbid0IHBhc3MgdG8gc3R1bm5lZCBwbGF5ZXJzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhtYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA0LjApIGNvbnRpbnVlOyAgLy8gVG9vIGNsb3NlIChSZWR1Y2VkIGZvciB0aWtpLXRha2EpCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IDMwLjApIGNvbnRpbnVlOyAvLyBUb28gZmFyIChJbmNyZWFzZWQgcmFuZ2UpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDEuIFJheWNhc3QgQ2hlY2sgKElzIHRoZSBsYW5lIGNsZWFyPykKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9pc1BhdGhCbG9ja2VkKG1hdGUubWVzaC5wb3NpdGlvbikpIGNvbnRpbnVlOyAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMi4gQ2FsY3VsYXRlIFN0cmF0ZWdpYyBTY29yZQogICAgICAgICAgICAgICAgbGV0IHNjb3JlID0gMDsKCiAgICAgICAgICAgICAgICAvLyBBLiBGb3J3YXJkIFByb2dyZXNzIChWZXJ0aWNhbGl0eSkKICAgICAgICAgICAgICAgIGNvbnN0IG15RGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgY29uc3QgbWF0ZURpc3RUb0dvYWwgPSBNYXRoLmFicyhtYXRlLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gbXlEaXN0VG9Hb2FsIC0gbWF0ZURpc3RUb0dvYWw7IC8vIFBvc2l0aXZlIGlmIG1vdmluZyBjbG9zZXIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2NvcmUgKz0gcHJvZ3Jlc3MgKiAxLjU7IAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBCLiBHb2FsIFByb3hpbWl0eSAoQWJzb2x1dGUpCiAgICAgICAgICAgICAgICBpZiAobWF0ZURpc3RUb0dvYWwgPCAxNS4wKSBzY29yZSArPSAxMC4wOwogICAgICAgICAgICAgICAgaWYgKG1hdGVEaXN0VG9Hb2FsIDwgOC4wKSBzY29yZSArPSAxNS4wOwoKICAgICAgICAgICAgICAgIC8vIEMuIE9wZW5uZXNzIChTcGFjZSBhcm91bmQgcmVjZWl2ZXIpCiAgICAgICAgICAgICAgICBjb25zdCBvcGVubmVzcyA9IHRoaXMuX2NhbGN1bGF0ZU9wZW5uZXNzKG1hdGUpOwogICAgICAgICAgICAgICAgc2NvcmUgKz0gb3Blbm5lc3MgKiAzLjA7IC8vIEhpZ2ggd2VpZ2h0IG9uIHNhZmV0eQoKICAgICAgICAgICAgICAgIC8vIEQuIFJvbGUgQmlhcyAoRm9yd2FyZHMgYXJlIHByaW1lIHRhcmdldHMpCiAgICAgICAgICAgICAgICBpZiAobWF0ZS5pc0ZvcndhcmQpIHNjb3JlICs9IDUuMDsKCiAgICAgICAgICAgICAgICAvLyBFLiBEaXN0YW5jZSBQZW5hbHR5IChMb25nIHBhc3NlcyBhcmUgcmlza3kpCiAgICAgICAgICAgICAgICBzY29yZSAtPSBkaXN0ICogMC41OwoKICAgICAgICAgICAgICAgIGlmIChzY29yZSA+IG1heFNjb3JlKSB7CiAgICAgICAgICAgICAgICAgICAgbWF4U2NvcmUgPSBzY29yZTsKICAgICAgICAgICAgICAgICAgICBiZXN0VGFyZ2V0ID0gbWF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGJlc3RUYXJnZXQ7CiAgICAgICAgfQoKICAgICAgICBfY2FsY3VsYXRlT3Blbm5lc3MocGxheWVyKSB7CiAgICAgICAgICAgIGxldCBtaW5EZWZEaXN0ID0gOTk5OwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiAwOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKCiAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCB8fCBvcHAuc3RhdHVzLm5hcCA+IDAgfHwgb3BwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZCA9IHBsYXllci5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGQgPCBtaW5EZWZEaXN0KSBtaW5EZWZEaXN0ID0gZDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2xhbXA6IEFueXRoaW5nIGJleW9uZCA4bSBpcyAiV2lkZSBPcGVuIgogICAgICAgICAgICByZXR1cm4gTWF0aC5taW4obWluRGVmRGlzdCwgOC4wKTsKICAgICAgICB9CgogICAgICAgIF9pc1BhdGhCbG9ja2VkKHRhcmdldFBvcykgewogICAgICAgICAgICBjb25zdCBzdGFydCA9IHRoaXMubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgZW5kID0gdGFyZ2V0UG9zOwogICAgICAgICAgICBjb25zdCBkaXN0ID0gc3RhcnQuZGlzdGFuY2VUbyhlbmQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUHJlcGFyZSBSYXkgRGlyZWN0aW9uCiAgICAgICAgICAgIF9zY2FuRGlyLnN1YlZlY3RvcnMoZW5kLCBzdGFydCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9ICh0aGlzLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbnRlcmNlcHRpb24gcmFkaXVzCiAgICAgICAgICAgIGNvbnN0IHNhZmV0eVJhZGl1cyA9IDIuNTsgCgogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2ggfHwgb3BwLnN0YXR1cy5uYXAgPiAwIHx8IG9wcC5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmVjdG9yIGZyb20gc3RhcnQgdG8gb3Bwb25lbnQKICAgICAgICAgICAgICAgIF9zY2FuVG9PcHAuc3ViVmVjdG9ycyhvcHAubWVzaC5wb3NpdGlvbiwgc3RhcnQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQcm9qZWN0IG9udG8gcGF0aAogICAgICAgICAgICAgICAgY29uc3QgcHJvamVjdGlvbiA9IF9zY2FuVG9PcHAuZG90KF9zY2FuRGlyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgcHJvamVjdGlvbiBpcyB3aXRoaW4gdGhlIHNlZ21lbnQKICAgICAgICAgICAgICAgIGlmIChwcm9qZWN0aW9uID4gMCAmJiBwcm9qZWN0aW9uIDwgZGlzdCkgewogICAgICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBwZXJwZW5kaWN1bGFyIGRpc3RhbmNlIHNxdWFyZWQKICAgICAgICAgICAgICAgICAgICAvLyBkaXN0U3EgPSB8dG9PcHB8XjIgLSBwcm9qZWN0aW9uXjIKICAgICAgICAgICAgICAgICAgICBjb25zdCBwZXJwRGlzdFNxID0gX3NjYW5Ub09wcC5sZW5ndGhTcSgpIC0gKHByb2plY3Rpb24gKiBwcm9qZWN0aW9uKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAocGVycERpc3RTcSA8IChzYWZldHlSYWRpdXMgKiBzYWZldHlSYWRpdXMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBCbG9ja2VkCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgpfbW92ZVRvKHRhcmdldCkgewogICAgICAgICAgICBfYWlWZWMuc3ViVmVjdG9ycyh0YXJnZXQsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIF9haVZlYy55ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IF9haVZlYy5sZW5ndGhTcSgpOwoKICAgICAgICAgICAgLy8gRGVhZHpvbmU6IElmIHdpdGhpbiAxLjBtICgxLjAgc3EpLCBzdG9wLgogICAgICAgICAgICAvLyBJbmNyZWFzZWQgZnJvbSAwLjEgKDAuM20pIHRvIHByZXZlbnQgbWljcm8tYWRqdXN0bWVudCBzcGlubmluZyBhdCBkZXN0aW5hdGlvbi4KICAgICAgICAgICAgLy8gVGhpcyBpcyBjcnVjaWFsIHdoZW4gdGFyZ2V0cyBhcmUgZHluYW1pYyAoZS5nLiByZWxhdGl2ZSB0byBiYWxsIGhvbGRlcikuCiAgICAgICAgICAgIGlmIChkaXN0U3EgPiAxLjApIHsKICAgICAgICAgICAgICAgIF9haVZlYy5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoX2FpVmVjLngsIF9haVZlYy56KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICAvLyBCcmFraW5nIGZyaWN0aW9uIHRvIHN0b3AgZHJpZnQgaW1tZWRpYXRlbHkgdXBvbiByZWFjaGluZyB0YXJnZXQKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC44KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9hcHBseUludGVyY2VwdGlvblByZXNzdXJlKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47IC8vIFNhZmV0eSBjaGVjawoKICAgICAgICAgICAgLy8gMS4gQmFzaWMgRWxpZ2liaWxpdHkgQ2hlY2tzCiAgICAgICAgICAgIC8vIE11c3QgYmUgZnJlZSBhbmQgbW92aW5nCiAgICAgICAgICAgIGlmIChiYWxsLnN0YXRlICE9PSAnZnJlZScgfHwgYmFsbC52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMS4wKSByZXR1cm47CiAgICAgICAgICAgIC8vIENhbm5vdCBpbnRlcmNlcHQgaW52aXNpYmxlIGJhbGwKICAgICAgICAgICAgaWYgKGJhbGwuaXNJbnZpc2libGUpIHJldHVybjsKICAgICAgICAgICAgLy8gU2tpcCBpZiBzbGVlcGluZyBvciBzdHVubmVkCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMi4gUmFuZ2UgQ2FsY3VsYXRpb24gKFRoZSAiRmllbGQiIFJhZGl1cykKICAgICAgICAgICAgbGV0IHJhbmdlID0gMi4wOyAvLyBSZWR1Y2VkIGZyb20gMy41IHRvIHByZXZlbnQgImZvcmNlIGZpZWxkIiBmZWVsaW5nCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQYXNzaXZlIFRlY2hzOiBCcmF3bGVyIC8gRWxpdGUgRGVmZW5zZQogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5wYXNzaXZlID09PSAnYnJhd2xlcicgfHwgdGhpcy50ZWNocy5wYXNzaXZlID09PSAnZWxpdGVfZGVmZW5zZScpIHsKICAgICAgICAgICAgICAgIHJhbmdlICs9IDEuNTsgLy8gUmVkdWNlZCBib29zdAogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgaWYgKGRpc3QgPiByYW5nZSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMy4gRGlyZWN0aW9uYWwgRmFjdG9yIChUaGUgIkNvbmUiKQogICAgICAgICAgICAvLyBWZWN0b3IgZnJvbSBCYWxsIHRvIERlZmVuZGVyCiAgICAgICAgICAgIF9zY2FuVG9PcHAuc3ViVmVjdG9ycyh0aGlzLm1lc2gucG9zaXRpb24sIGJhbGwubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIF90ZW1wVmVjMS5jb3B5KGJhbGwudmVsb2NpdHkpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRG90IFByb2R1Y3Q6IAogICAgICAgICAgICAvLyAxLjAgPSBCYWxsIGhlYWRpbmcgc3RyYWlnaHQgZm9yIGRlZmVuZGVyCiAgICAgICAgICAgIC8vIDAuMCA9IFBhc3NpbmcgYnkgc2lkZSAoUGVycGVuZGljdWxhcikKICAgICAgICAgICAgY29uc3QgaGVhZGluZ0RvdCA9IF90ZW1wVmVjMS5kb3QoX3NjYW5Ub09wcCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBPbmx5IGFwcGx5IGRyYWcgaWYgYmFsbCBpcyBhcHByb2FjaGluZyBESVJFQ1RMWSAoU3RyaWN0ZXIgY29uZSkKICAgICAgICAgICAgLy8gSW5jcmVhc2VkIHRocmVzaG9sZCBmcm9tIDAuMCB0byAwLjcgKE11c3QgYmUgd2l0aGluIH40NSBkZWdyZWVzKQogICAgICAgICAgICBpZiAoaGVhZGluZ0RvdCA8IDAuNykgcmV0dXJuOwoKICAgICAgICAgICAgLy8gNC4gQ2FsY3VsYXRlIFByZXNzdXJlIEludGVuc2l0eQogICAgICAgICAgICAvLyBEaXN0YW5jZSBGYWN0b3I6IENsb3NlciA9IFN0cm9uZ2VyIChMaW5lYXIgZmFsbG9mZikKICAgICAgICAgICAgY29uc3QgZGlzdEZhY3RvciA9IE1hdGgubWF4KDAsIDEuMCAtIChkaXN0IC8gcmFuZ2UpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFuZ2xlIEZhY3RvcjogRGlyZWN0IGhpdCA9IDEuMCwgR2xhbmNpbmcgPSAwLjQKICAgICAgICAgICAgY29uc3QgYW5nbGVGYWN0b3IgPSBNYXRoLm1heCgwLjMsIGhlYWRpbmdEb3QpOwoKICAgICAgICAgICAgLy8gQkwgU3RhdAogICAgICAgICAgICBjb25zdCBibCA9IHRoaXMuZ2V0U3RhdCgnQkwnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvdGFsIFByZXNzdXJlIChQQS9TSCBkcmFpbiBwZXIgc2Vjb25kKQogICAgICAgICAgICAvLyBCYXNlIG11bHRpcGxpZXIgZm9yIHN0YXRzIChSZWR1Y2VkIGZyb20gNi4wIHRvIDMuMCkKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmVNdWx0aXBsaWVyID0gMy4wOyAKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSBibCAqIGRpc3RGYWN0b3IgKiBhbmdsZUZhY3RvciAqIHByZXNzdXJlTXVsdGlwbGllciAqIGR0OwoKICAgICAgICAgICAgLy8gNS4gQXBwbHkgdG8gQmFsbCBTdGF0cyAoUEEvU0gpCiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlciAtPSBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrIChBY2N1bXVsYXRvcikKICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgPSAodGhpcy5fYWNjdW11bGF0ZWRCbG9jayB8fCAwKSArIHByZXNzdXJlOwogICAgICAgICAgICAgICAgLy8gU2hvdyBmbG9hdGluZyB0ZXh0IGV2ZXJ5IDUgcG9pbnRzIGRyYWluZWQKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hY2N1bXVsYXRlZEJsb2NrID49IDUuMCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBNYXRoLmZsb29yKHRoaXMuX2FjY3VtdWxhdGVkQmxvY2spOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgLT0gdmFsOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7IAogICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3Bhd24gb24gYmFsbCwgYXR0YWNoIHRvIGJhbGwKICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oYC0ke3ZhbH1gLCBiYWxsLm1lc2gucG9zaXRpb24sICJibG9jayIsIGJhbGwubWVzaCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA3LiBWaXN1YWxzOiBUaGUgIlRldGhlciIgLyBJbnRlcmZlcmVuY2UgRmllbGQKICAgICAgICAgICAgLy8gU3Bhd24gc3BhcmtzIGJldHdlZW4gYmFsbCBhbmQgZGVmZW5kZXIgdG8gc2hvdyB0aGUgZmllbGQgZWZmZWN0CiAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgKGRpc3RGYWN0b3IgKiAwLjgpKSB7IAogICAgICAgICAgICAgICAgX3RlbXBWZWMyLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKS5sZXJwKGJhbGwubWVzaC5wb3NpdGlvbiwgMC41ICsgKE1hdGgucmFuZG9tKCktMC41KSowLjIpOwogICAgICAgICAgICAgICAgLy8gSml0dGVyCiAgICAgICAgICAgICAgICBfdGVtcFZlYzIueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLnkgKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zcGF3bkNsYXNoKF90ZW1wVmVjMiwgMC42KTsgLy8gU3BhcmsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gOC4gU2hvdCBTdG9wIC8gQmxvY2sgTG9naWMKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCAmJiBiYWxsLnBvd2VyVHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlclR5cGUgPSAnbm9uZSc7IC8vIE5ldXRyYWxpemUgc2hvdAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOTyBERUZMRUNUSU9OOiBUaGUgYmFsbCBjb250aW51ZXMgb24gaXRzIHBhdGguCiAgICAgICAgICAgICAgICAvLyBJdCBpcyBub3cgYSAiZGVhZCBiYWxsIiAobm8gcG93ZXIpIGJ1dCBrZWVwcyBtb3ZpbmcuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7IAogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLRUQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIE5vIGltcGFjdCBmcmVlemUgdG8ga2VlcCBmbG93IHNtb290aAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA5LiBTdGF0dXMgUmlzayAoVmVub20vTmFwL1dpdGhlciBvbiBCYWxsKQogICAgICAgICAgICBpZiAoYmFsbC50ZWNobmlxdWUgJiYgIXRoaXMuX3RlY2hBcHBsaWVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLl90ZWNoQXBwbGllZCA9IHRydWU7CiAgICAgICAgICAgICAgICBjb25zdCB0ZWNoID0gYmFsbC50ZWNobmlxdWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZWNoLnR5cGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDE1LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICduYXAnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseVN0YXR1cygnbmFwJywgOC4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGVjaC50eXBlID09PSAnd2l0aGVyJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDE1LjAsICdCTCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy5fdGVjaEFwcGxpZWQgPSBmYWxzZTsgfSwgMjAwMCk7CiAgICAgICAgICAgIH0KfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkFJUGxheWVyID0gQUlQbGF5ZXI7Cn0pKCk7","./AIPlayer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFJldXNhYmxlIHZlY3RvcnMKY29uc3QgX2FpVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF90YXJnZXRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3NjYW5EaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3NjYW5Ub09wcCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlYzEgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3RlbXBWZWMyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF90ZW1wVmVjMyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgpjbGFzcyBBSVBsYXllciBleHRlbmRzIHdpbmRvdy5mbHV4LlBsYXllciB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUsIHJvbGUpIHsKICAgICAgICAgICAgc3VwZXIoc2NlbmUsIHJvbGUpOwogICAgICAgICAgICB0aGlzLmJhbGxSZWYgPSBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhdHMgYXJlIG1hbmFnZWQgYnkgVGVhbS9NYWluIG9yIGRlZmF1bHQgUGxheWVyIHZhbHVlcy4KICAgICAgICAgICAgLy8gTm8gY29uc3RydWN0b3Igb3ZlcnJpZGVzIHRvIGVuc3VyZSBmYWlyIHNjYWxpbmcgYW5kIGRlbW8gY29uc2lzdGVuY3kuCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgLy8gU3RhdGUgTWFjaGluZQogICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnSURMRSc7CiAgICAgICAgICAgIHRoaXMuZGVjaXNpb25UaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuZGVjaXNpb25JbnRlcnZhbCA9IDAuMTsgLy8gSU1QUk9WRUQ6IEZhc3RlciBkZWNpc2lvbnMgKHdhcyAwLjIpCgogICAgICAgICAgICAvLyAtLS0gUEVSQ0VQVElPTiBTWVNURU0gKFJlYWN0aW9uIFRpbWUpIC0tLQogICAgICAgICAgICAvLyBUaGUgQUkgdHJhY2tzIGEgImdob3N0IiB0YXJnZXQgdGhhdCBsYWdzIGJlaGluZCByZWFsaXR5LgogICAgICAgICAgICAvLyBUaGlzIGFsbG93cyBodW1hbiBwbGF5ZXJzIHRvIGp1a2UvZmFrZSBvdXQgdGhlIEFJLgogICAgICAgICAgICB0aGlzLnBlcmNlaXZlZFRhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMucmVhY3Rpb25TcGVlZCA9IDguMDsgLy8gSU1QUk9WRUQ6IEZhc3RlciByZWFjdGlvbiAod2FzIDUuMCkKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBCZXR0ZXIgYW50aWNpcGF0aW9uCiAgICAgICAgICAgIHRoaXMuYW50aWNpcGF0aW9uVGltZSA9IDAuNDsgLy8gTGVhZCB0YXJnZXQgYnkgdGhpcyBtYW55IHNlY29uZHMKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJvbGUgQ29uZmlnCiAgICAgICAgICAgIHRoaXMuaXNGb3J3YXJkID0gWydMRicsICdSRiddLmluY2x1ZGVzKHJvbGUpOwogICAgICAgICAgICB0aGlzLmlzTWlkZmllbGRlciA9IHJvbGUgPT09ICdNRic7CiAgICAgICAgICAgIHRoaXMuaXNEZWZlbmRlciA9IFsnTEQnLCAnUkQnXS5pbmNsdWRlcyhyb2xlKTsKCiAgICAgICAgICAgIC8vIEFzc2lnbiBkZWZhdWx0IHRlY2huaXF1ZXMgc28gQUkgaXMgYSB0aHJlYXQKICAgICAgICAgICAgdGhpcy5fYXNzaWduRGVmYXVsdFRlY2hzKCk7CiAgICAgICAgfQoKICAgICAgICBfYXNzaWduRGVmYXVsdFRlY2hzKCkgewogICAgICAgICAgICAvLyBSYW5kb21seSBhc3NpZ24gdGVjaHMgYmFzZWQgb24gcm9sZQpjb25zdCB0YWNrbGVUZWNocyA9IFsndmVub20nLCAnd2l0aGVyJywgJ2RyYWluJ107CiAgICAgICAgICAgIGNvbnN0IHNob290VGVjaHMgPSBbJ3Zlbm9tJywgJ3NwaGVyZScsICdpbnZpc2libGUnXTsKICAgICAgICAgICAgY29uc3QgcGFzc1RlY2hzID0gWyd2ZW5vbScsICd3aXRoZXInLCAnbmFwJ107CiAgICAgICAgICAgIGNvbnN0IHBhc3NpdmVUZWNocyA9IFsnYnJhd2xlcicsICdlbGl0ZV9kZWZlbnNlJ107CgogICAgICAgICAgICAvLyBIZWxwZXIgdG8gcGljayByYW5kb20KICAgICAgICAgICAgY29uc3QgcGljayA9IChhcnIpID0+IGFycltNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBhcnIubGVuZ3RoKV07CiAgICAgICAgICAgIGNvbnN0IGNoYW5jZSA9IChwcm9iKSA9PiBNYXRoLnJhbmRvbSgpIDwgcHJvYjsKCmlmICh0aGlzLmlzRGVmZW5kZXIpIHsKICAgICAgICAgICAgICAgIC8vIERlZmVuZGVycyBsb3ZlIHN0YXR1cyB0YWNrbGVzIGFuZCBwYXNzaXZlcwogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjgpKSB0aGlzLnRlY2hzLnRhY2tsZSA9IHBpY2sodGFja2xlVGVjaHMpOwogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjMpKSB0aGlzLnRlY2hzLnBhc3MgPSBwaWNrKHBhc3NUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuNSkpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzTWlkZmllbGRlcikgewogICAgICAgICAgICAgICAgLy8gTWlkZmllbGRlcnMgYXJlIGJhbGFuY2VkCiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuNikpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuNikpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4zKSkgdGhpcy50ZWNocy5zaG9vdCA9IHBpY2soc2hvb3RUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMykpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgLy8gRm9yd2FyZHMgZm9jdXMgb24gc2hvb3RpbmcKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC45KSkgdGhpcy50ZWNocy5zaG9vdCA9IHBpY2soc2hvb3RUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuNCkpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7IC8vIEZyb250bGluZSBwcmVzc3VyZQogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjIpKSB0aGlzLnRlY2hzLnBhc3NpdmUgPSBwaWNrKHBhc3NpdmVUZWNocyk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgLy8gU2FmZXR5OiBBdXRvLWxpbmsgYmFsbCBpZiBtaXNzaW5nIChTZWxmLWhlYWxpbmcpCiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFsbFJlZiA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAwLiBDaGVjayBpZiBBSSBsb2dpYyBzaG91bGQgcnVuCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGlzRGVtbyA9IGdhbWUgJiYgZ2FtZS5pc0RlbW9Nb2RlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2hlY2sgaW5jYXBhY2l0YXRpb24gKFN0dW4gb3IgTmFwKQogICAgICAgICAgICBjb25zdCBpc0luY2FwYWNpdGF0ZWQgPSAodGhpcy5zdHVuVGltZXIgPiAwKSB8fCAodGhpcy5zdGF0dXMubmFwID4gMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBSSBydW5zIGlmOgogICAgICAgICAgICAvLyAxLiBJdCdzIGFuIEFJIHRlYW0gKG5vdCBodW1hbikKICAgICAgICAgICAgLy8gMi4gSXQncyBhIEh1bWFuIHRlYW0gQlVUIERlbW8gTW9kZSBpcyBPTgogICAgICAgICAgICAvLyAzLiBJdCdzIGEgSHVtYW4gdGVhbSwgRGVtbyBpcyBPRkYsIGJ1dCB0aGlzIHBsYXllciBpcyBOT1QgdGhlIGFjdGl2ZSBjb250cm9sbGVkIHBsYXllcgogICAgICAgICAgICBjb25zdCBpc0h1bWFuVGVhbSA9IHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uaXNIdW1hbjsKICAgICAgICAgICAgY29uc3QgaXNBY3RpdmVQbGF5ZXIgPSB0aGlzLnRlYW0gJiYgKHRoaXMudGVhbS5hY3RpdmVQbGF5ZXIgPT09IHRoaXMpOwogICAgICAgICAgICBjb25zdCBzaG91bGRSdW5BSSA9ICghaXNIdW1hblRlYW0gfHwgaXNEZW1vIHx8IChpc0h1bWFuVGVhbSAmJiAhaXNBY3RpdmVQbGF5ZXIpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hc3RlciBBSSBTd2l0Y2ggZm9yIHRoZSB0ZWFtCiAgICAgICAgICAgIGNvbnN0IGlzVGVhbUFJRW5hYmxlZCA9IHRoaXMudGVhbSA/IHRoaXMudGVhbS5haUVuYWJsZWQgOiB0cnVlOwoKICAgICAgICAgICAgaWYgKGlzSW5jYXBhY2l0YXRlZCkgewogICAgICAgICAgICAgICAgLy8gSWYgc3R1bm5lZC9zbGVlcGluZywgZG8gbm90aGluZy4KICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2hvdWxkUnVuQUkgJiYgaXNUZWFtQUlFbmFibGVkKSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gSU1QUk9WRUQgUEVSQ0VQVElPTiBVUERBVEUgLS0tCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgcGVyY2VpdmVkIHBvc2l0aW9uIHRvd2FyZHMgcmVhbCB0YXJnZXQgKEJhbGwgb3IgQmFsbCBIb2xkZXIpCiAgICAgICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmICYmIHRoaXMuYmFsbFJlZi5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHJlYWxUYXJnZXQgPSB0aGlzLmJhbGxSZWYubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBJZiBiYWxsIGlzIGhlbGQsIHRyYWNrIHRoZSBob2xkZXIgd2l0aCBhbnRpY2lwYXRpb24KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmLmhvbGRlciAmJiB0aGlzLmJhbGxSZWYuaG9sZGVyLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVhbFRhcmdldCA9IHRoaXMuYmFsbFJlZi5ob2xkZXIubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IExlYWQgdGhlIHRhcmdldCBiYXNlZCBvbiB0aGVpciB2ZWxvY2l0eQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmLmhvbGRlci52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhbFRhcmdldC5hZGRTY2FsZWRWZWN0b3IodGhpcy5iYWxsUmVmLmhvbGRlci52ZWxvY2l0eSwgdGhpcy5hbnRpY2lwYXRpb25UaW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5iYWxsUmVmLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvciBsb29zZSBiYWxsLCBhbnRpY2lwYXRlIGJhc2VkIG9uIGJhbGwgdmVsb2NpdHkKICAgICAgICAgICAgICAgICAgICAgICAgcmVhbFRhcmdldC5hZGRTY2FsZWRWZWN0b3IodGhpcy5iYWxsUmVmLnZlbG9jaXR5LCB0aGlzLmFudGljaXBhdGlvblRpbWUgKiAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gTGVycCBwZXJjZXB0aW9uIHRvd2FyZHMgYW50aWNpcGF0ZWQgcmVhbGl0eQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFscGhhID0gTWF0aC5taW4oMS4wLCBkdCAqIHRoaXMucmVhY3Rpb25TcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJjZWl2ZWRUYXJnZXRQb3MubGVycChyZWFsVGFyZ2V0LCBhbHBoYSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMS4gRGVjaXNpb24gTWFraW5nCiAgICAgICAgICAgICAgICB0aGlzLmRlY2lzaW9uVGltZXIgKz0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWNpc2lvblRpbWVyID4gdGhpcy5kZWNpc2lvbkludGVydmFsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWNpc2lvblRpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9ldmFsdWF0ZVN0YXRlKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMi4gRXhlY3V0ZSBTdGF0ZSAoU2V0cyBpbnB1dFZlY3RvcikKICAgICAgICAgICAgICAgIHRoaXMuX2V4ZWN1dGVTdGF0ZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDMuIEludGVyY2VwdGlvbiBMb2dpYwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnRlcmNlcHRpb25QcmVzc3VyZShkdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBIZXJlIGlmOgogICAgICAgICAgICAgICAgLy8gMS4gQ29udHJvbGxlZCBieSBIdW1hbiAoc2hvdWxkUnVuQUkgPT0gZmFsc2UpCiAgICAgICAgICAgICAgICAvLyAyLiBBSSBMb2dpYyBpcyBEaXNhYmxlZCAoaXNUZWFtQUlFbmFibGVkID09IGZhbHNlKQoKICAgICAgICAgICAgICAgIC8vIElmIEFJIGlzIGRpc2FibGVkLCB3ZSBtdXN0IHN0b3AgdGhlIGJvdCBVTkxFU1MgaXQgaXMgYmVpbmcgZHJpdmVuIGJ5IGh1bWFuIGlucHV0LgogICAgICAgICAgICAgICAgLy8gSHVtYW4gaW5wdXQgZHJpdmVzIHRoZSBwbGF5ZXIgaWY6IGlzSHVtYW5UZWFtIEFORCBpc0FjdGl2ZVBsYXllciBBTkQgIWlzRGVtbwogICAgICAgICAgICAgICAgY29uc3QgaXNEcml2ZW5CeUh1bWFuID0gaXNIdW1hblRlYW0gJiYgaXNBY3RpdmVQbGF5ZXIgJiYgIWlzRGVtbzsKCiAgICAgICAgICAgICAgICBpZiAoIWlzVGVhbUFJRW5hYmxlZCAmJiAhaXNEcml2ZW5CeUh1bWFuKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBXZSBzdGlsbCBhcHBseSBwYXNzaXZlIGludGVyY2VwdGlvbiBpZiBpbiB0aGUgd2F5LgogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnRlcmNlcHRpb25QcmVzc3VyZShkdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIEJhc2UgVXBkYXRlCiAgICAgICAgICAgIHN1cGVyLnVwZGF0ZShkdCk7CiAgICAgICAgfQoKX2V2YWx1YXRlU3RhdGUoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CgogICAgICAgICAgICAvLyAxLiBJIGhhdmUgdGhlIGJhbGwKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0FUVEFDS19DQVJSWSc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIExvb3NlIEJhbGwgTG9naWMgKEFudGktRmxvY2tpbmcpCiAgICAgICAgICAgIGlmICghYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQ6IFJldHVybiB0byBmb3JtYXRpb24uIE9ubHkgY2hhc2UgaWYgd2UgYXJlIHRoZSBiZXN0IGNhbmRpZGF0ZS4KICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdSRVRVUk5fSE9NRSc7CgovLyBIeXN0ZXJlc2lzOiBJZiBJIHdhcyBhbHJlYWR5IGNoYXNpbmcsIEknbSBlZmZlY3RpdmVseSAiY2xvc2VyIiB0byBwcmV2ZW50IGppdHRlcnkgc3dpdGNoaW5nCiAgICAgICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIHR3byBwbGF5ZXJzIGZyb20gc3dhcHBpbmcgcm9sZXMgcmFwaWRseSB3aGVuIGVxdWlkaXN0YW50LgogICAgICAgICAgICAgICAgY29uc3QgYmlhcyA9ICh0aGlzLmFpU3RhdGUgPT09ICdDSEFTRScpID8gMC44IDogMS4wOwogICAgICAgICAgICAgICAgY29uc3QgbXlEaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKSAqIGJpYXM7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBpc0Nsb3Nlc3QgPSB0cnVlOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAgPT09IHRoaXMpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgR29hbGllIChHb2FsaWUgaGFuZGxlcyB0aGVpciBvd24gYXJlYTsgZmllbGQgcGxheWVycyBzaG91bGRuJ3QgcmVseSBvbiB0aGVtKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5yb2xlID09PSAnR0wnKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSBpbmNhcGFjaXRhdGVkIHRlYW1tYXRlcwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29udGludWU7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgdGVhbW1hdGUgZGlzdGFuY2UKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTm90ZTogV2UgZG9uJ3QgYXBwbHkgYmlhcyB0byBvdGhlcnMsIGVmZmVjdGl2ZWx5IG1ha2luZyAibWUiIHN0aWNraWVyIGlmIEknbSBhbHJlYWR5IGNoYXNpbmcKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcERpc3QgPSBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgYSB0ZWFtbWF0ZSBpcyBjbG9zZXIsIHlpZWxkIHRvIHRoZW0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBEaXN0IDwgbXlEaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0Nsb3Nlc3QgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQp9CgogICAgICAgICAgICAgICAgaWYgKGlzQ2xvc2VzdCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdDSEFTRSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIFRlYW1tYXRlIGhhcyBiYWxsCiAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlci50ZWFtID09PSB0aGlzLnRlYW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdTVVBQT1JUJzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNC4gT3Bwb25lbnQgaGFzIGJhbGwKICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0RFRkVORCc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9leGVjdXRlU3RhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmJhbGxSZWYpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN3aXRjaCAodGhpcy5haVN0YXRlKSB7CiAgICAgICAgICAgICAgICBjYXNlICdBVFRBQ0tfQ0FSUlknOiB0aGlzLl9zdGF0ZUF0dGFja0NhcnJ5KGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdTVVBQT1JUJzogdGhpcy5fc3RhdGVTdXBwb3J0KGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdERUZFTkQnOiB0aGlzLl9zdGF0ZURlZmVuZChkdCk7IGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnQ0hBU0UnOiB0aGlzLl9zdGF0ZUNoYXNlKGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdSRVRVUk5fSE9NRSc6IAogICAgICAgICAgICAgICAgZGVmYXVsdDogdGhpcy5fc3RhdGVSZXR1cm5Ib21lKGR0KTsgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIC0tLSBTVEFURVMgLS0tCgpfc3RhdGVBdHRhY2tDYXJyeShkdCkgewogICAgICAgICAgICAvLyBEcml2ZSB0byBnb2FsCiAgICAgICAgICAgIC8vIEhvbWUgKFNpZGUgMSkgYXR0YWNrcyAtWi4gQXdheSAoU2lkZSAtMSkgYXR0YWNrcyArWi4KICAgICAgICAgICAgY29uc3QgYXR0YWNrRGlyID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKY29uc3QgZ29hbFogPSA0NiAqIGF0dGFja0RpcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRhcmdldDogR29hbCAoYnV0IHJlc3BlY3QgY3JlYXNlKQogICAgICAgICAgICBfdGFyZ2V0UG9zLnNldCgwLCAwLCBnb2FsWik7CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwoKICAgICAgICAgICAgLy8gRGVjaXNpb246IFNob290IG9yIFBhc3M/CiAgICAgICAgICAgIGNvbnN0IGRpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDEuIFNob290IGlmIGNsb3NlIGFuZCBjbGVhcgogICAgICAgICAgICBpZiAoZGlzdFRvR29hbCA8IDIwLjAgJiYgIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdTSCcpOyAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMi4gUGFzcyBMb2dpYwogICAgICAgICAgICAvLyBDaGVjayBwYXNzIGlmOiBTdXJyb3VuZGVkLCBMb3cgRU4sIG9yIFBsYXltYWtlciAoTWlkZmllbGRlcikgc2VlcyBvcHBvcnR1bml0eQogICAgICAgICAgICBjb25zdCBpc1N1cnJvdW5kZWQgPSB0aGlzLl9pc1N1cnJvdW5kZWQoKTsKICAgICAgICAgICAgY29uc3QgbG93RU4gPSB0aGlzLmN1cnJlbnRFTiA8IDEwOwogICAgICAgICAgICBjb25zdCBpc1BsYXltYWtlciA9IHRoaXMuaXNNaWRmaWVsZGVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKChpc1N1cnJvdW5kZWQgfHwgbG93RU4gfHwgaXNQbGF5bWFrZXIpICYmICF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJlc3RNYXRlID0gdGhpcy5fZmluZEJlc3RQYXNzVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChiZXN0TWF0ZSkgewogICAgICAgICAgICAgICAgICAgIC8vIEV2YWx1YXRlIGlmIHBhc3MgaXMgd29ydGggaXQKICAgICAgICAgICAgICAgICAgICAvLyBJZiBQbGF5bWFrZXIsIHBhc3MgaWYgbWF0ZSBpcyBjbG9zZXIgdG8gZ29hbAogICAgICAgICAgICAgICAgICAgIC8vIElmIFBhbmljIChTdXJyb3VuZGVkL0xvd0VOKSwgcGFzcyB0byBhbnlvbmUgb3BlbgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxldCBzaG91bGRQYXNzID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3Vycm91bmRlZCB8fCBsb3dFTikgewogICAgICAgICAgICAgICAgICAgICAgICBzaG91bGRQYXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzUGxheW1ha2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG15RGlzdCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRlRGlzdCA9IE1hdGguYWJzKGJlc3RNYXRlLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGVEaXN0IDwgbXlEaXN0IC0gNS4wKSBzaG91bGRQYXNzID0gdHJ1ZTsgLy8gTWF0ZSBpcyA1bSBjbG9zZXIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHNob3VsZFBhc3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmFjZSB0YXJnZXQKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdChiZXN0TWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRXhlY3V0ZSBQYXNzCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3NtYXJ0VGhyb3codGhpcy5iYWxsUmVmLCAnUEEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gUGFuaWMgQ2xlYXIgKElmIHN1cnJvdW5kZWQgYW5kIG5vIHBhc3MpCiAgICAgICAgICAgIGlmIChpc1N1cnJvdW5kZWQgJiYgIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgLy8gSnVzdCBzaG9vdC9jbGVhcgogICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdTSCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfaXNTdXJyb3VuZGVkKCkgewogICAgICAgICAgICAvLyBTaW1wbGUgY2hlY2s6IGNvdW50IGVuZW1pZXMgbmVhcmJ5CiAgICAgICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmIChwLm1lc2ggJiYgcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5tZXNoLnBvc2l0aW9uKSA8IDQuMCkgewogICAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvdW50ID49IDI7CiAgICAgICAgfQoKX3NtYXJ0VGhyb3coYmFsbCwgZm9yY2VkVHlwZSA9IG51bGwpIHsKICAgICAgICAgICAgLy8gV3JhcHBlciBhcm91bmQgdGhyb3dCYWxsIHRvIG1hbmFnZSBIUCBhbmQgVGVjaHMKICAgICAgICAgICAgLy8gMS4gRGV0ZXJtaW5lIGludGVuZGVkIGFjdGlvbiB0eXBlCiAgICAgICAgICAgIGxldCB0eXBlID0gZm9yY2VkVHlwZTsKICAgICAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICBjb25zdCBhdHRhY2tEaXIgPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKICAgICAgICAgICAgICAgIGNvbnN0IGlzQWltaW5nR29hbCA9IChfdGVtcFZlYzEueiAqIGF0dGFja0RpciA+IDAuNSk7CiAgICAgICAgICAgICAgICB0eXBlID0gaXNBaW1pbmdHb2FsID8gJ1NIJyA6ICdQQSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIEdldCBUZWNoCiAgICAgICAgICAgIGNvbnN0IHRlY2hOYW1lID0gKHR5cGUgPT09ICdTSCcpID8gdGhpcy50ZWNocy5zaG9vdCA6IHRoaXMudGVjaHMucGFzczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDMuIEVzdGltYXRlIENvc3QKICAgICAgICAgICAgbGV0IGJhc2VDb3N0ID0gKHR5cGUgPT09ICdTSCcpID8gMjAgOiAxMDsKICAgICAgICAgICAgbGV0IHRlY2hDb3N0ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgLy8gUm91Z2ggZXN0aW1hdGVzIGJhc2VkIG9uIFBsYXllci5qcwogICAgICAgICAgICAgICAgaWYgKHRlY2hOYW1lLmluY2x1ZGVzKCduYXAnKSkgdGVjaENvc3QgPSAzMDsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2hOYW1lLmluY2x1ZGVzKCdzcGhlcmUnKSB8fCB0ZWNoTmFtZS5pbmNsdWRlcygnaW52aXNpYmxlJykpIHRlY2hDb3N0ID0gMjU7CiAgICAgICAgICAgICAgICBlbHNlIHRlY2hDb3N0ID0gMjA7IC8vIFZlbm9tL1dpdGhlcgogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCB0b3RhbENvc3QgPSBiYXNlQ29zdCArIHRlY2hDb3N0OwoKICAgICAgICAgICAgLy8gNC4gRGVjaXNpb24KICAgICAgICAgICAgLy8gSWYgd2UgaGF2ZSBhIHRlY2ggYnV0IG5vdCBlbm91Z2ggSFAgZm9yIGl0LCBCVVQgZW5vdWdoIEhQIGZvciBub3JtYWwuLi4KICAgICAgICAgICAgLy8gRGlzYWJsZSB0ZWNoIHRlbXBvcmFyaWx5IHRvIGF2b2lkICJUaXJlZCIgcGVuYWx0eSAoMC41eCBzdGF0cykKICAgICAgICAgICAgbGV0IHRlbXBUZWNoID0gbnVsbDsKICAgICAgICAgICAgaWYgKHRlY2hOYW1lICYmIHRoaXMuc3RhdHMuSFAgPCB0b3RhbENvc3QgJiYgdGhpcy5zdGF0cy5IUCA+PSBiYXNlQ29zdCkgewogICAgICAgICAgICAgICAgLy8gVW5lcXVpcAogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wVGVjaCA9IHRoaXMudGVjaHMuc2hvb3Q7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWNocy5zaG9vdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRlbXBUZWNoID0gdGhpcy50ZWNocy5wYXNzOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGVjaHMucGFzcyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEV4ZWN1dGUKICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgdHlwZSk7CgogICAgICAgICAgICAvLyBSZXN0b3JlCiAgICAgICAgICAgIGlmICh0ZW1wVGVjaCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHRoaXMudGVjaHMuc2hvb3QgPSB0ZW1wVGVjaDsKICAgICAgICAgICAgICAgIGVsc2UgdGhpcy50ZWNocy5wYXNzID0gdGVtcFRlY2g7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpfc3RhdGVDaGFzZShkdCkgewogICAgICAgICAgICAvLyBJbnRlcmNlcHRpb246IENoYXNlIHRoZSBQRVJDRUlWRUQgcG9zaXRpb24sIG5vdCB0aGUgcmVhbCBvbmUuCiAgICAgICAgICAgIC8vIFRoaXMgYWxsb3dzIGp1a2VzIHRvIHdvcmsgYmVjYXVzZSB0aGUgQUkgaXMgY2hhc2luZyB3aGVyZSB5b3UgV0VSRS4KICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElmIGJhbGwgaGFzIHZlbG9jaXR5LCBsZWFkIGl0IHNsaWdodGx5IGJhc2VkIG9uIHBlcmNlcHRpb24KICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKICAgICAgICAgICAgaWYgKGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDEuMCkgewogICAgICAgICAgICAgICAgX3RhcmdldFBvcy5hZGRTY2FsZWRWZWN0b3IoYmFsbC52ZWxvY2l0eSwgMC4zKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CiAgICAgICAgfQoKX3N0YXRlUmV0dXJuSG9tZShkdCkgewogICAgICAgICAgICAvLyBSZXR1cm4gdG8gZm9ybWF0aW9uIHBvc2l0aW9uCiAgICAgICAgICAgIF90YXJnZXRQb3MuY29weSh0aGlzLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwogICAgICAgIH0KCl9zdGF0ZVN1cHBvcnQoZHQpIHsKICAgICAgICAgICAgLy8gT0ZGRU5TRSAoVGVhbW1hdGUgaGFzIGJhbGwpCiAgICAgICAgICAgIC8vIEdvYWw6IEZpbmQgb3BlbiBzcGFjZSB0byByZWNlaXZlIGEgcGFzcwogICAgICAgICAgICBjb25zdCBiYWxsUG9zID0gdGhpcy5iYWxsUmVmLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IGF0dGFja0RpciA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtMSA6IDE7CmNvbnN0IGdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC00NiA6IDQ2OwoKICAgICAgICAgICAgLy8gMS4gRGV0ZXJtaW5lICJJZGVhbCIgU3VwcG9ydCBQb3NpdGlvbgogICAgICAgICAgICAvLyBTdGFydCB3aXRoIGZvcm1hdGlvbiBob21lCiAgICAgICAgICAgIF90YXJnZXRQb3MuY29weSh0aGlzLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAyLiBEeW5hbWljIEFkanVzdG1lbnQKICAgICAgICAgICAgaWYgKHRoaXMuaXNGb3J3YXJkKSB7CiAgICAgICAgICAgICAgICAvLyBGb3J3YXJkczogTWFrZSBydW5zIHRvd2FyZHMgdGhlIGdvYWwvYm94CiAgICAgICAgICAgICAgICAvLyBJZiBiYWxsIGlzIGRlZXAsIGN1dCB0byBjZW50ZXIuIElmIGJhbGwgaXMgYmFjaywgcHVzaCBsaW5lLgogICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gYmFsbFBvcy56ICsgKGF0dGFja0RpciAqIDEwLjApOyAvLyBTdGF5IGFoZWFkIG9mIGJhbGwKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gWmlnLXphZyBydW4gcGF0dGVybiBiYXNlZCBvbiB0aW1lIHRvIGxvb2sgImFsaXZlIgogICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IERhdGUubm93KCkgKiAwLjAwMTsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueCArPSBNYXRoLnNpbih0aW1lICsgdGhpcy5tZXNoLmlkKSAqIDUuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNNaWRmaWVsZGVyKSB7CiAgICAgICAgICAgICAgICAvLyBNaWRmaWVsZGVyczogRmluZCBwb2NrZXQgYmV0d2VlbiBiYWxsIGFuZCBnb2FsCiAgICAgICAgICAgICAgICBfdGVtcFZlYzEuc2V0KDAsIDAsIGdvYWxaKTsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MubGVycFZlY3RvcnMoYmFsbFBvcywgX3RlbXBWZWMxLCAwLjQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTdGF5IHdpZGUgaWYgYmFsbCBpcyBjZW50cmFsLCBjb21lIGNlbnRyYWwgaWYgYmFsbCBpcyB3aWRlCiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoYmFsbFBvcy54KSA8IDUpIF90YXJnZXRQb3MueCA9ICh0aGlzLmhvbWVQb3NpdGlvbi54ID4gMCA/IDEwIDogLTEwKTsKICAgICAgICAgICAgICAgIGVsc2UgX3RhcmdldFBvcy54ID0gMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIERlZmVuZGVyczogU3VwcG9ydCBmcm9tIGJlaGluZCAoc2FmZXR5IHZhbHZlKQogICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gYmFsbFBvcy56IC0gKGF0dGFja0RpciAqIDguMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIEF2b2lkIERlZmVuZGVycyAoUmF5Y2FzdC1pc2ggY2hlY2spCiAgICAgICAgICAgIC8vIElmIGEgZGVmZW5kZXIgaXMgbmVhciBteSB0YXJnZXQsIHNoaWZ0IGF3YXkKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKGdhbWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAodGhpcy50ZWFtLmlkID09PSAnaG9tZScpID8gZ2FtZS50ZWFtcy5hd2F5IDogZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wcC5tZXNoICYmIG9wcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oX3RhcmdldFBvcykgPCA0LjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVmZW5kZXIgaXMgY2xvZ2dpbmcgbXkgc3BvdC4gU2hpZnQgYXdheSBmcm9tIHRoZW0uCiAgICAgICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMi5jb3B5KF90YXJnZXRQb3MpLnN1YihvcHAubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjMiwgNS4wKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIENsYW1wIHRvIEFyZW5hICYgQ3JlYXNlCiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKCiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICB9Cgpfc3RhdGVEZWZlbmQoZHQpIHsKICAgICAgICAgICAgLy8gREVGRU5TRSAoT3Bwb25lbnQgaGFzIGJhbGwpCiAgICAgICAgICAgIC8vIFVzZSBQZXJjZWl2ZWQgUG9zaXRpb24gZm9yIGRpc3RhbmNlIGNoZWNrcyBhbmQgbW92ZW1lbnQKICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9zID0gdGhpcy5wZXJjZWl2ZWRUYXJnZXRQb3M7CiAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXRQb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMS4gRGV0ZXJtaW5lIFByZXNzIFJhbmdlCiAgICAgICAgICAgIC8vIEJhc2UgcmFuZ2UKLy8gQmFzZSByYW5nZQogICAgICAgICAgICBsZXQgcHJlc3NSYW5nZSA9IHRoaXMuaXNEZWZlbmRlciA/IDIwLjAgOiAxNS4wOyAvLyBJbmNyZWFzZWQgYWdncmVzc2lvbiByYW5nZQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQWdncmVzc2l2ZSBUZWNoIFVzYWdlCiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnRhY2tsZSAmJiB0aGlzLnN0YXRzLkhQID4gMjApIHsKICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgKz0gNS4wOyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIEFOVEktU1dBUk0gTE9HSUMgJiBBR0dSRVNTSU9OIC0tLQogICAgICAgICAgICAvLyBPbmx5IHRoZSBjbG9zZXN0IGRlZmVuZGVyIHNob3VsZCBoYXJkLXByZXNzIGZyb20gZGlzdGFuY2UuCiAgICAgICAgICAgIC8vIE90aGVycyBzaG91bGQgc3RpY2sgdG8gdGhlaXIgem9uZXMvbWFya3MgdW5sZXNzIHRoZSBiYWxsIGVudGVycyB0aGVpciBwZXJzb25hbCBzcGFjZS4KICAgICAgICAgICAgbGV0IGFtSUNsb3Nlc3QgPSB0cnVlOwogICAgICAgICAgICBjb25zdCBteURpc3RTcSA9IGRpc3RUb0JhbGwgKiBkaXN0VG9CYWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgZm9yKGNvbnN0IG1hdGUgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcyB8fCAhbWF0ZS5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgR29hbGllIGFuZCBpbmNhcGFjaXRhdGVkIHRlYW1tYXRlcwogICAgICAgICAgICAgICAgICAgIGlmIChtYXRlLnJvbGUgPT09ICdHTCcgfHwgbWF0ZS5zdGF0dXMubmFwID4gMCB8fCBtYXRlLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFVzZSByZWFsIHBvc2l0aW9ucyBmb3IgdGVhbW1hdGUgY29tcGFyaXNvbiAoQUkga25vd3Mgd2hlcmUgdGVhbW1hdGVzIGFyZSkKICAgICAgICAgICAgICAgICAgICBjb25zdCBkU3EgPSBtYXRlLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUb1NxdWFyZWQodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZFNxIDwgbXlEaXN0U3EpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYW1JQ2xvc2VzdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFpPTUJJRSBGSVg6IElmIEkgYW0gdGhlIGNsb3Nlc3QsIEkgTVVTVCBDSEFTRS4KICAgICAgICAgICAgLy8gU2V0IHByZXNzUmFuZ2UgdG8gZXNzZW50aWFsbHkgaW5maW5pdGUgaWYgY2xvc2VzdCwgc28gdGhleSBkb24ndCBqdXN0IHN0YW5kIHRoZXJlLgovLyBaT01CSUUgRklYOiBJZiBJIGFtIHRoZSBjbG9zZXN0LCBJIE1VU1QgQ0hBU0UuCiAgICAgICAgICAgIC8vIFNldCBwcmVzc1JhbmdlIHRvIGVzc2VudGlhbGx5IGluZmluaXRlIGlmIGNsb3Nlc3QsIHNvIHRoZXkgZG9uJ3QganVzdCBzdGFuZCB0aGVyZS4KICAgICAgICAgICAgaWYgKGFtSUNsb3Nlc3QpIHsKICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgPSAxMDAuMDsgLy8gSW5maW5pdGUgY2hhc2UKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb015R29hbCA9IE1hdGguYWJzKHRhcmdldFBvcy56IC0gKHRoaXMudGVhbS5zaWRlID09PSAxID8gNDYgOiAtNDYpKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9NeUdvYWwgPCA0MC4wKSB7CiAgICAgICAgICAgICAgICAgICAgcHJlc3NSYW5nZSA9IDI1LjA7IC8vIEFnZ3Jlc3NpdmUgem9uZSBkZWZlbnNlCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgPSAxMC4wOyAvLyBMb29zZXIgbWFya2luZyBpbiBtaWRmaWVsZAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIElmIGJhbGwgaXMgY2xvc2UgZW5vdWdoIChiYXNlZCBvbiBjb250ZXh0KSwgUFJFU1MgSVQKICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCBwcmVzc1JhbmdlKSB7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gTWFyayBNb2RlIChNYW4tdG8tTWFuKQogICAgICAgICAgICAvLyBJZiBJIGhhdmUgYSBtYXJrIGFzc2lnbmVkLCBzdGljayB0byB0aGVtIHVubGVzcyBwcmVzc2luZyBiYWxsCiAgICAgICAgICAgIGlmICh0aGlzLm1hcmtpbmcgJiYgdGhpcy5tYXJraW5nLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG1hcmtQb3MgPSB0aGlzLm1hcmtpbmcubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUG9zaXRpb246IEJldHdlZW4gbWFyayBhbmQgbXkgZ29hbCAoR29hbCBTaWRlKQpjb25zdCBteUdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IDQ2IDogLTQ2OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZWN0b3IgZnJvbSBNYXJrIHRvIEdvYWwKICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5zZXQoMCwgMCwgbXlHb2FsWiAtIG1hcmtQb3Mueik7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gX3RlbXBWZWMxLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgX3RlbXBWZWMxLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTdGFuZCAzLjUgdW5pdHMgdG93YXJkcyBnb2FsIGZyb20gdGhlIG1hcmsgKEluY3JlYXNlZCBmcm9tIDIuMCB0byBnaXZlIGJyZWF0aGluZyByb29tKQogICAgICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KG1hcmtQb3MpLmFkZFNjYWxlZFZlY3RvcihfdGVtcFZlYzEsIDMuNSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gWm9uZSBEZWZlbnNlIChGb3JtYXRpb24gKyBTbGlkZSkKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNsaWRlIGxvZ2ljIChTaGlmdCBmb3JtYXRpb24gdG93YXJkcyBiYWxsIHNpZGUpCiAgICAgICAgICAgIF90YXJnZXRQb3MueiArPSBiYWxsUG9zLnogKiAwLjY7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEZWZlbmRlciBPdmVycmlkZTogQWx3YXlzIHN0YXkgYmV0d2VlbiBiYWxsIGFuZCBnb2FsCi8vIERlZmVuZGVyIE92ZXJyaWRlOiBBbHdheXMgc3RheSBiZXR3ZWVuIGJhbGwgYW5kIGdvYWwKICAgICAgICAgICAgaWYgKHRoaXMuaXNEZWZlbmRlcikgewogICAgICAgICAgICAgICAgY29uc3QgbXlHb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyA0NiA6IC00NjsKICAgICAgICAgICAgICAgIGNvbnN0IG1pZHBvaW50ID0gKGJhbGxQb3MueiArIG15R29hbFopICogMC41OwogICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gKF90YXJnZXRQb3MueiArIG1pZHBvaW50KSAqIDAuNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2xhbXAKLy8gQ2xhbXAKICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gTWF0aC5tYXgoLTQ0LjAsIE1hdGgubWluKDQ0LjAsIF90YXJnZXRQb3MueikpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CiAgICAgICAgfQoKX2F2b2lkR29hbENyZWFzZSh0YXJnZXRQb3MpIHsKICAgICAgICAgICAgLy8gMS4gR29hbCBDcmVhc2UgQXZvaWRhbmNlIChSYWRpdXMgMTAgYXJvdW5kIGdvYWxzIGF0ICsvLSAyOCkKICAgICAgICAgICAgLy8gTWF0Y2hlcyBQbGF5ZXIuanMgX2FwcGx5R29hbENyZWFzZSBwaHlzaWNzIHRvIHByZXZlbnQgc3R1dHRlcmluZwovLyAxLiBHb2FsIENyZWFzZSBBdm9pZGFuY2UgKFJhZGl1cyAxMCBhcm91bmQgZ29hbHMgYXQgKy8tIDI4KQogICAgICAgICAgICAvLyBNYXRjaGVzIFBsYXllci5qcyBfYXBwbHlHb2FsQ3JlYXNlIHBoeXNpY3MgdG8gcHJldmVudCBzdHV0dGVyaW5nCi8vIE1hdGNoZXMgUGxheWVyLmpzIF9hcHBseUdvYWxDcmVhc2UgcGh5c2ljcyB0byBwcmV2ZW50IHN0dXR0ZXJpbmcKICAgICAgICAgICAgY29uc3QgY3JlYXNlUmFkaXVzID0gMTAuMDsKICAgICAgICAgICAgY29uc3QgZ29hbHMgPSBbCiAgICAgICAgICAgICAgICB7IHg6IDAsIHo6IC00NiB9CiAgICAgICAgICAgIF07CgogICAgICAgICAgICBnb2Fscy5mb3JFYWNoKGdvYWwgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZHggPSB0YXJnZXRQb3MueCAtIGdvYWwueDsKICAgICAgICAgICAgICAgIGNvbnN0IGR6ID0gdGFyZ2V0UG9zLnogLSBnb2FsLno7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR6KmR6OwoKICAgICAgICAgICAgICAgIGlmIChkaXN0U3EgPCBjcmVhc2VSYWRpdXMgKiBjcmVhc2VSYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJbnNpZGUgY3JlYXNlLCBwcm9qZWN0IHRvIGVkZ2UKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPiAwLjAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IGNyZWFzZVJhZGl1cyAvIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy54ID0gZ29hbC54ICsgZHggKiByYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnogPSBnb2FsLnogKyBkeiAqIHJhdGlvOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEV4YWN0IGNlbnRlciwgcHVzaCBvdXQgdG93YXJkcyBjZW50ZXIgZmllbGQKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnogPSBnb2FsLnogKyAoZ29hbC56ID4gMCA/IC1jcmVhc2VSYWRpdXMgOiBjcmVhc2VSYWRpdXMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgovLyAyLiBBcmVuYSBCb3VuZGFyeSBDbGFtcAogICAgICAgICAgICBjb25zdCBhcmVuYVJhZGl1cyA9IDQ1LjA7IC8vIEtlZXAgc2xpZ2h0bHkgaW5zaWRlIHZpc3VhbC9waHlzaWNzIHdhbGwKICAgICAgICAgICAgY29uc3QgZFNxID0gdGFyZ2V0UG9zLnggKiB0YXJnZXRQb3MueCArIHRhcmdldFBvcy56ICogdGFyZ2V0UG9zLno7CgogICAgICAgICAgICBpZiAoZFNxID4gYXJlbmFSYWRpdXMqYXJlbmFSYWRpdXMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGQgPSBNYXRoLnNxcnQoZFNxKTsKICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBhcmVuYVJhZGl1cyAvIGQ7CiAgICAgICAgICAgICAgICB0YXJnZXRQb3MueCAqPSByOwogICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnogKj0gcjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2ZpbmRCZXN0UGFzc1RhcmdldCgpIHsKICAgICAgICAgICAgbGV0IGJlc3RUYXJnZXQgPSBudWxsOwogICAgICAgICAgICBsZXQgbWF4U2NvcmUgPSAtSW5maW5pdHk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBdHRhY2sgZGlyZWN0aW9uICYgR29hbCBaCiAgICAgICAgICAgIGNvbnN0IGF0dGFja0RpciA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtMSA6IDE7IC8vIEhvbWUgYXR0YWNrcyAtWgpjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtNDYgOiA0NjsKCiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKG1hdGUgPT09IHRoaXMpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKCFtYXRlLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKG1hdGUuc3RhdHVzLm5hcCA+IDApIGNvbnRpbnVlOyAvLyBEb24ndCBwYXNzIHRvIHNsZWVwZXJzCiAgICAgICAgICAgICAgICBpZiAobWF0ZS5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsgIC8vIERvbid0IHBhc3MgdG8gc3R1bm5lZCBwbGF5ZXJzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhtYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA0LjApIGNvbnRpbnVlOyAgLy8gVG9vIGNsb3NlIChSZWR1Y2VkIGZvciB0aWtpLXRha2EpCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IDMwLjApIGNvbnRpbnVlOyAvLyBUb28gZmFyIChJbmNyZWFzZWQgcmFuZ2UpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDEuIFJheWNhc3QgQ2hlY2sgKElzIHRoZSBsYW5lIGNsZWFyPykKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9pc1BhdGhCbG9ja2VkKG1hdGUubWVzaC5wb3NpdGlvbikpIGNvbnRpbnVlOyAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMi4gQ2FsY3VsYXRlIFN0cmF0ZWdpYyBTY29yZQogICAgICAgICAgICAgICAgbGV0IHNjb3JlID0gMDsKCiAgICAgICAgICAgICAgICAvLyBBLiBGb3J3YXJkIFByb2dyZXNzIChWZXJ0aWNhbGl0eSkKICAgICAgICAgICAgICAgIGNvbnN0IG15RGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgY29uc3QgbWF0ZURpc3RUb0dvYWwgPSBNYXRoLmFicyhtYXRlLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gbXlEaXN0VG9Hb2FsIC0gbWF0ZURpc3RUb0dvYWw7IC8vIFBvc2l0aXZlIGlmIG1vdmluZyBjbG9zZXIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2NvcmUgKz0gcHJvZ3Jlc3MgKiAxLjU7IAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBCLiBHb2FsIFByb3hpbWl0eSAoQWJzb2x1dGUpCiAgICAgICAgICAgICAgICBpZiAobWF0ZURpc3RUb0dvYWwgPCAxNS4wKSBzY29yZSArPSAxMC4wOwogICAgICAgICAgICAgICAgaWYgKG1hdGVEaXN0VG9Hb2FsIDwgOC4wKSBzY29yZSArPSAxNS4wOwoKICAgICAgICAgICAgICAgIC8vIEMuIE9wZW5uZXNzIChTcGFjZSBhcm91bmQgcmVjZWl2ZXIpCiAgICAgICAgICAgICAgICBjb25zdCBvcGVubmVzcyA9IHRoaXMuX2NhbGN1bGF0ZU9wZW5uZXNzKG1hdGUpOwogICAgICAgICAgICAgICAgc2NvcmUgKz0gb3Blbm5lc3MgKiAzLjA7IC8vIEhpZ2ggd2VpZ2h0IG9uIHNhZmV0eQoKICAgICAgICAgICAgICAgIC8vIEQuIFJvbGUgQmlhcyAoRm9yd2FyZHMgYXJlIHByaW1lIHRhcmdldHMpCiAgICAgICAgICAgICAgICBpZiAobWF0ZS5pc0ZvcndhcmQpIHNjb3JlICs9IDUuMDsKCiAgICAgICAgICAgICAgICAvLyBFLiBEaXN0YW5jZSBQZW5hbHR5IChMb25nIHBhc3NlcyBhcmUgcmlza3kpCiAgICAgICAgICAgICAgICBzY29yZSAtPSBkaXN0ICogMC41OwoKICAgICAgICAgICAgICAgIGlmIChzY29yZSA+IG1heFNjb3JlKSB7CiAgICAgICAgICAgICAgICAgICAgbWF4U2NvcmUgPSBzY29yZTsKICAgICAgICAgICAgICAgICAgICBiZXN0VGFyZ2V0ID0gbWF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGJlc3RUYXJnZXQ7CiAgICAgICAgfQoKICAgICAgICBfY2FsY3VsYXRlT3Blbm5lc3MocGxheWVyKSB7CiAgICAgICAgICAgIGxldCBtaW5EZWZEaXN0ID0gOTk5OwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiAwOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKCiAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCB8fCBvcHAuc3RhdHVzLm5hcCA+IDAgfHwgb3BwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZCA9IHBsYXllci5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGQgPCBtaW5EZWZEaXN0KSBtaW5EZWZEaXN0ID0gZDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2xhbXA6IEFueXRoaW5nIGJleW9uZCA4bSBpcyAiV2lkZSBPcGVuIgogICAgICAgICAgICByZXR1cm4gTWF0aC5taW4obWluRGVmRGlzdCwgOC4wKTsKICAgICAgICB9CgogICAgICAgIF9pc1BhdGhCbG9ja2VkKHRhcmdldFBvcykgewogICAgICAgICAgICBjb25zdCBzdGFydCA9IHRoaXMubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgZW5kID0gdGFyZ2V0UG9zOwogICAgICAgICAgICBjb25zdCBkaXN0ID0gc3RhcnQuZGlzdGFuY2VUbyhlbmQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUHJlcGFyZSBSYXkgRGlyZWN0aW9uCiAgICAgICAgICAgIF9zY2FuRGlyLnN1YlZlY3RvcnMoZW5kLCBzdGFydCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9ICh0aGlzLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbnRlcmNlcHRpb24gcmFkaXVzCiAgICAgICAgICAgIGNvbnN0IHNhZmV0eVJhZGl1cyA9IDIuNTsgCgogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2ggfHwgb3BwLnN0YXR1cy5uYXAgPiAwIHx8IG9wcC5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmVjdG9yIGZyb20gc3RhcnQgdG8gb3Bwb25lbnQKICAgICAgICAgICAgICAgIF9zY2FuVG9PcHAuc3ViVmVjdG9ycyhvcHAubWVzaC5wb3NpdGlvbiwgc3RhcnQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQcm9qZWN0IG9udG8gcGF0aAogICAgICAgICAgICAgICAgY29uc3QgcHJvamVjdGlvbiA9IF9zY2FuVG9PcHAuZG90KF9zY2FuRGlyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgcHJvamVjdGlvbiBpcyB3aXRoaW4gdGhlIHNlZ21lbnQKICAgICAgICAgICAgICAgIGlmIChwcm9qZWN0aW9uID4gMCAmJiBwcm9qZWN0aW9uIDwgZGlzdCkgewogICAgICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBwZXJwZW5kaWN1bGFyIGRpc3RhbmNlIHNxdWFyZWQKICAgICAgICAgICAgICAgICAgICAvLyBkaXN0U3EgPSB8dG9PcHB8XjIgLSBwcm9qZWN0aW9uXjIKICAgICAgICAgICAgICAgICAgICBjb25zdCBwZXJwRGlzdFNxID0gX3NjYW5Ub09wcC5sZW5ndGhTcSgpIC0gKHByb2plY3Rpb24gKiBwcm9qZWN0aW9uKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAocGVycERpc3RTcSA8IChzYWZldHlSYWRpdXMgKiBzYWZldHlSYWRpdXMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBCbG9ja2VkCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgpfbW92ZVRvKHRhcmdldCkgewogICAgICAgICAgICBfYWlWZWMuc3ViVmVjdG9ycyh0YXJnZXQsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIF9haVZlYy55ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IF9haVZlYy5sZW5ndGhTcSgpOwoKICAgICAgICAgICAgLy8gRGVhZHpvbmU6IElmIHdpdGhpbiAxLjBtICgxLjAgc3EpLCBzdG9wLgogICAgICAgICAgICAvLyBJbmNyZWFzZWQgZnJvbSAwLjEgKDAuM20pIHRvIHByZXZlbnQgbWljcm8tYWRqdXN0bWVudCBzcGlubmluZyBhdCBkZXN0aW5hdGlvbi4KICAgICAgICAgICAgLy8gVGhpcyBpcyBjcnVjaWFsIHdoZW4gdGFyZ2V0cyBhcmUgZHluYW1pYyAoZS5nLiByZWxhdGl2ZSB0byBiYWxsIGhvbGRlcikuCiAgICAgICAgICAgIGlmIChkaXN0U3EgPiAxLjApIHsKICAgICAgICAgICAgICAgIF9haVZlYy5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoX2FpVmVjLngsIF9haVZlYy56KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICAvLyBCcmFraW5nIGZyaWN0aW9uIHRvIHN0b3AgZHJpZnQgaW1tZWRpYXRlbHkgdXBvbiByZWFjaGluZyB0YXJnZXQKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC44KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9hcHBseUludGVyY2VwdGlvblByZXNzdXJlKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47IC8vIFNhZmV0eSBjaGVjawoKICAgICAgICAgICAgLy8gMS4gQmFzaWMgRWxpZ2liaWxpdHkgQ2hlY2tzCiAgICAgICAgICAgIC8vIE11c3QgYmUgZnJlZSBhbmQgbW92aW5nCiAgICAgICAgICAgIGlmIChiYWxsLnN0YXRlICE9PSAnZnJlZScgfHwgYmFsbC52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMS4wKSByZXR1cm47CiAgICAgICAgICAgIC8vIENhbm5vdCBpbnRlcmNlcHQgaW52aXNpYmxlIGJhbGwKICAgICAgICAgICAgaWYgKGJhbGwuaXNJbnZpc2libGUpIHJldHVybjsKICAgICAgICAgICAgLy8gU2tpcCBpZiBzbGVlcGluZyBvciBzdHVubmVkCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMi4gUmFuZ2UgQ2FsY3VsYXRpb24gKFRoZSAiRmllbGQiIFJhZGl1cykKICAgICAgICAgICAgbGV0IHJhbmdlID0gMi4wOyAvLyBSZWR1Y2VkIGZyb20gMy41IHRvIHByZXZlbnQgImZvcmNlIGZpZWxkIiBmZWVsaW5nCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQYXNzaXZlIFRlY2hzOiBCcmF3bGVyIC8gRWxpdGUgRGVmZW5zZQogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5wYXNzaXZlID09PSAnYnJhd2xlcicgfHwgdGhpcy50ZWNocy5wYXNzaXZlID09PSAnZWxpdGVfZGVmZW5zZScpIHsKICAgICAgICAgICAgICAgIHJhbmdlICs9IDEuNTsgLy8gUmVkdWNlZCBib29zdAogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgaWYgKGRpc3QgPiByYW5nZSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMy4gRGlyZWN0aW9uYWwgRmFjdG9yIChUaGUgIkNvbmUiKQogICAgICAgICAgICAvLyBWZWN0b3IgZnJvbSBCYWxsIHRvIERlZmVuZGVyCiAgICAgICAgICAgIF9zY2FuVG9PcHAuc3ViVmVjdG9ycyh0aGlzLm1lc2gucG9zaXRpb24sIGJhbGwubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIF90ZW1wVmVjMS5jb3B5KGJhbGwudmVsb2NpdHkpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRG90IFByb2R1Y3Q6IAogICAgICAgICAgICAvLyAxLjAgPSBCYWxsIGhlYWRpbmcgc3RyYWlnaHQgZm9yIGRlZmVuZGVyCiAgICAgICAgICAgIC8vIDAuMCA9IFBhc3NpbmcgYnkgc2lkZSAoUGVycGVuZGljdWxhcikKICAgICAgICAgICAgY29uc3QgaGVhZGluZ0RvdCA9IF90ZW1wVmVjMS5kb3QoX3NjYW5Ub09wcCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBPbmx5IGFwcGx5IGRyYWcgaWYgYmFsbCBpcyBhcHByb2FjaGluZyBESVJFQ1RMWSAoU3RyaWN0ZXIgY29uZSkKICAgICAgICAgICAgLy8gSW5jcmVhc2VkIHRocmVzaG9sZCBmcm9tIDAuMCB0byAwLjcgKE11c3QgYmUgd2l0aGluIH40NSBkZWdyZWVzKQogICAgICAgICAgICBpZiAoaGVhZGluZ0RvdCA8IDAuNykgcmV0dXJuOwoKICAgICAgICAgICAgLy8gNC4gQ2FsY3VsYXRlIFByZXNzdXJlIEludGVuc2l0eQogICAgICAgICAgICAvLyBEaXN0YW5jZSBGYWN0b3I6IENsb3NlciA9IFN0cm9uZ2VyIChMaW5lYXIgZmFsbG9mZikKICAgICAgICAgICAgY29uc3QgZGlzdEZhY3RvciA9IE1hdGgubWF4KDAsIDEuMCAtIChkaXN0IC8gcmFuZ2UpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFuZ2xlIEZhY3RvcjogRGlyZWN0IGhpdCA9IDEuMCwgR2xhbmNpbmcgPSAwLjQKICAgICAgICAgICAgY29uc3QgYW5nbGVGYWN0b3IgPSBNYXRoLm1heCgwLjMsIGhlYWRpbmdEb3QpOwoKICAgICAgICAgICAgLy8gQkwgU3RhdAogICAgICAgICAgICBjb25zdCBibCA9IHRoaXMuZ2V0U3RhdCgnQkwnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvdGFsIFByZXNzdXJlIChQQS9TSCBkcmFpbiBwZXIgc2Vjb25kKQogICAgICAgICAgICAvLyBCYXNlIG11bHRpcGxpZXIgZm9yIHN0YXRzIChSZWR1Y2VkIGZyb20gNi4wIHRvIDMuMCkKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmVNdWx0aXBsaWVyID0gMy4wOyAKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSBibCAqIGRpc3RGYWN0b3IgKiBhbmdsZUZhY3RvciAqIHByZXNzdXJlTXVsdGlwbGllciAqIGR0OwoKICAgICAgICAgICAgLy8gNS4gQXBwbHkgdG8gQmFsbCBTdGF0cyAoUEEvU0gpCiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlciAtPSBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrIChBY2N1bXVsYXRvcikKICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgPSAodGhpcy5fYWNjdW11bGF0ZWRCbG9jayB8fCAwKSArIHByZXNzdXJlOwogICAgICAgICAgICAgICAgLy8gU2hvdyBmbG9hdGluZyB0ZXh0IGV2ZXJ5IDUgcG9pbnRzIGRyYWluZWQKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hY2N1bXVsYXRlZEJsb2NrID49IDUuMCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBNYXRoLmZsb29yKHRoaXMuX2FjY3VtdWxhdGVkQmxvY2spOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgLT0gdmFsOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7IAogICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3Bhd24gb24gYmFsbCwgYXR0YWNoIHRvIGJhbGwKICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oYC0ke3ZhbH1gLCBiYWxsLm1lc2gucG9zaXRpb24sICJibG9jayIsIGJhbGwubWVzaCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA3LiBWaXN1YWxzOiBUaGUgIlRldGhlciIgLyBJbnRlcmZlcmVuY2UgRmllbGQKICAgICAgICAgICAgLy8gU3Bhd24gc3BhcmtzIGJldHdlZW4gYmFsbCBhbmQgZGVmZW5kZXIgdG8gc2hvdyB0aGUgZmllbGQgZWZmZWN0CiAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgKGRpc3RGYWN0b3IgKiAwLjgpKSB7IAogICAgICAgICAgICAgICAgX3RlbXBWZWMyLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKS5sZXJwKGJhbGwubWVzaC5wb3NpdGlvbiwgMC41ICsgKE1hdGgucmFuZG9tKCktMC41KSowLjIpOwogICAgICAgICAgICAgICAgLy8gSml0dGVyCiAgICAgICAgICAgICAgICBfdGVtcFZlYzIueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLnkgKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zcGF3bkNsYXNoKF90ZW1wVmVjMiwgMC42KTsgLy8gU3BhcmsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gOC4gU2hvdCBTdG9wIC8gQmxvY2sgTG9naWMKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCAmJiBiYWxsLnBvd2VyVHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlclR5cGUgPSAnbm9uZSc7IC8vIE5ldXRyYWxpemUgc2hvdAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOTyBERUZMRUNUSU9OOiBUaGUgYmFsbCBjb250aW51ZXMgb24gaXRzIHBhdGguCiAgICAgICAgICAgICAgICAvLyBJdCBpcyBub3cgYSAiZGVhZCBiYWxsIiAobm8gcG93ZXIpIGJ1dCBrZWVwcyBtb3ZpbmcuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7IAogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLRUQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIE5vIGltcGFjdCBmcmVlemUgdG8ga2VlcCBmbG93IHNtb290aAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA5LiBTdGF0dXMgUmlzayAoVmVub20vTmFwL1dpdGhlciBvbiBCYWxsKQogICAgICAgICAgICBpZiAoYmFsbC50ZWNobmlxdWUgJiYgIXRoaXMuX3RlY2hBcHBsaWVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLl90ZWNoQXBwbGllZCA9IHRydWU7CiAgICAgICAgICAgICAgICBjb25zdCB0ZWNoID0gYmFsbC50ZWNobmlxdWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZWNoLnR5cGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDE1LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICduYXAnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseVN0YXR1cygnbmFwJywgOC4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGVjaC50eXBlID09PSAnd2l0aGVyJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDE1LjAsICdCTCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy5fdGVjaEFwcGxpZWQgPSBmYWxzZTsgfSwgMjAwMCk7CiAgICAgICAgICAgIH0KfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkFJUGxheWVyID0gQUlQbGF5ZXI7Cn0pKCk7","/AIPlayer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFJldXNhYmxlIHZlY3RvcnMKY29uc3QgX2FpVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF90YXJnZXRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3NjYW5EaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3NjYW5Ub09wcCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlYzEgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3RlbXBWZWMyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF90ZW1wVmVjMyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgpjbGFzcyBBSVBsYXllciBleHRlbmRzIHdpbmRvdy5mbHV4LlBsYXllciB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUsIHJvbGUpIHsKICAgICAgICAgICAgc3VwZXIoc2NlbmUsIHJvbGUpOwogICAgICAgICAgICB0aGlzLmJhbGxSZWYgPSBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhdHMgYXJlIG1hbmFnZWQgYnkgVGVhbS9NYWluIG9yIGRlZmF1bHQgUGxheWVyIHZhbHVlcy4KICAgICAgICAgICAgLy8gTm8gY29uc3RydWN0b3Igb3ZlcnJpZGVzIHRvIGVuc3VyZSBmYWlyIHNjYWxpbmcgYW5kIGRlbW8gY29uc2lzdGVuY3kuCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgLy8gU3RhdGUgTWFjaGluZQogICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnSURMRSc7CiAgICAgICAgICAgIHRoaXMuZGVjaXNpb25UaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuZGVjaXNpb25JbnRlcnZhbCA9IDAuMTsgLy8gSU1QUk9WRUQ6IEZhc3RlciBkZWNpc2lvbnMgKHdhcyAwLjIpCgogICAgICAgICAgICAvLyAtLS0gUEVSQ0VQVElPTiBTWVNURU0gKFJlYWN0aW9uIFRpbWUpIC0tLQogICAgICAgICAgICAvLyBUaGUgQUkgdHJhY2tzIGEgImdob3N0IiB0YXJnZXQgdGhhdCBsYWdzIGJlaGluZCByZWFsaXR5LgogICAgICAgICAgICAvLyBUaGlzIGFsbG93cyBodW1hbiBwbGF5ZXJzIHRvIGp1a2UvZmFrZSBvdXQgdGhlIEFJLgogICAgICAgICAgICB0aGlzLnBlcmNlaXZlZFRhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMucmVhY3Rpb25TcGVlZCA9IDguMDsgLy8gSU1QUk9WRUQ6IEZhc3RlciByZWFjdGlvbiAod2FzIDUuMCkKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBCZXR0ZXIgYW50aWNpcGF0aW9uCiAgICAgICAgICAgIHRoaXMuYW50aWNpcGF0aW9uVGltZSA9IDAuNDsgLy8gTGVhZCB0YXJnZXQgYnkgdGhpcyBtYW55IHNlY29uZHMKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJvbGUgQ29uZmlnCiAgICAgICAgICAgIHRoaXMuaXNGb3J3YXJkID0gWydMRicsICdSRiddLmluY2x1ZGVzKHJvbGUpOwogICAgICAgICAgICB0aGlzLmlzTWlkZmllbGRlciA9IHJvbGUgPT09ICdNRic7CiAgICAgICAgICAgIHRoaXMuaXNEZWZlbmRlciA9IFsnTEQnLCAnUkQnXS5pbmNsdWRlcyhyb2xlKTsKCiAgICAgICAgICAgIC8vIEFzc2lnbiBkZWZhdWx0IHRlY2huaXF1ZXMgc28gQUkgaXMgYSB0aHJlYXQKICAgICAgICAgICAgdGhpcy5fYXNzaWduRGVmYXVsdFRlY2hzKCk7CiAgICAgICAgfQoKICAgICAgICBfYXNzaWduRGVmYXVsdFRlY2hzKCkgewogICAgICAgICAgICAvLyBSYW5kb21seSBhc3NpZ24gdGVjaHMgYmFzZWQgb24gcm9sZQpjb25zdCB0YWNrbGVUZWNocyA9IFsndmVub20nLCAnd2l0aGVyJywgJ2RyYWluJ107CiAgICAgICAgICAgIGNvbnN0IHNob290VGVjaHMgPSBbJ3Zlbm9tJywgJ3NwaGVyZScsICdpbnZpc2libGUnXTsKICAgICAgICAgICAgY29uc3QgcGFzc1RlY2hzID0gWyd2ZW5vbScsICd3aXRoZXInLCAnbmFwJ107CiAgICAgICAgICAgIGNvbnN0IHBhc3NpdmVUZWNocyA9IFsnYnJhd2xlcicsICdlbGl0ZV9kZWZlbnNlJ107CgogICAgICAgICAgICAvLyBIZWxwZXIgdG8gcGljayByYW5kb20KICAgICAgICAgICAgY29uc3QgcGljayA9IChhcnIpID0+IGFycltNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBhcnIubGVuZ3RoKV07CiAgICAgICAgICAgIGNvbnN0IGNoYW5jZSA9IChwcm9iKSA9PiBNYXRoLnJhbmRvbSgpIDwgcHJvYjsKCmlmICh0aGlzLmlzRGVmZW5kZXIpIHsKICAgICAgICAgICAgICAgIC8vIERlZmVuZGVycyBsb3ZlIHN0YXR1cyB0YWNrbGVzIGFuZCBwYXNzaXZlcwogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjgpKSB0aGlzLnRlY2hzLnRhY2tsZSA9IHBpY2sodGFja2xlVGVjaHMpOwogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjMpKSB0aGlzLnRlY2hzLnBhc3MgPSBwaWNrKHBhc3NUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuNSkpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzTWlkZmllbGRlcikgewogICAgICAgICAgICAgICAgLy8gTWlkZmllbGRlcnMgYXJlIGJhbGFuY2VkCiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuNikpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuNikpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4zKSkgdGhpcy50ZWNocy5zaG9vdCA9IHBpY2soc2hvb3RUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMykpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgLy8gRm9yd2FyZHMgZm9jdXMgb24gc2hvb3RpbmcKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC45KSkgdGhpcy50ZWNocy5zaG9vdCA9IHBpY2soc2hvb3RUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuNCkpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7IC8vIEZyb250bGluZSBwcmVzc3VyZQogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjIpKSB0aGlzLnRlY2hzLnBhc3NpdmUgPSBwaWNrKHBhc3NpdmVUZWNocyk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgLy8gU2FmZXR5OiBBdXRvLWxpbmsgYmFsbCBpZiBtaXNzaW5nIChTZWxmLWhlYWxpbmcpCiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFsbFJlZiA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAwLiBDaGVjayBpZiBBSSBsb2dpYyBzaG91bGQgcnVuCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGlzRGVtbyA9IGdhbWUgJiYgZ2FtZS5pc0RlbW9Nb2RlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2hlY2sgaW5jYXBhY2l0YXRpb24gKFN0dW4gb3IgTmFwKQogICAgICAgICAgICBjb25zdCBpc0luY2FwYWNpdGF0ZWQgPSAodGhpcy5zdHVuVGltZXIgPiAwKSB8fCAodGhpcy5zdGF0dXMubmFwID4gMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBSSBydW5zIGlmOgogICAgICAgICAgICAvLyAxLiBJdCdzIGFuIEFJIHRlYW0gKG5vdCBodW1hbikKICAgICAgICAgICAgLy8gMi4gSXQncyBhIEh1bWFuIHRlYW0gQlVUIERlbW8gTW9kZSBpcyBPTgogICAgICAgICAgICAvLyAzLiBJdCdzIGEgSHVtYW4gdGVhbSwgRGVtbyBpcyBPRkYsIGJ1dCB0aGlzIHBsYXllciBpcyBOT1QgdGhlIGFjdGl2ZSBjb250cm9sbGVkIHBsYXllcgogICAgICAgICAgICBjb25zdCBpc0h1bWFuVGVhbSA9IHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uaXNIdW1hbjsKICAgICAgICAgICAgY29uc3QgaXNBY3RpdmVQbGF5ZXIgPSB0aGlzLnRlYW0gJiYgKHRoaXMudGVhbS5hY3RpdmVQbGF5ZXIgPT09IHRoaXMpOwogICAgICAgICAgICBjb25zdCBzaG91bGRSdW5BSSA9ICghaXNIdW1hblRlYW0gfHwgaXNEZW1vIHx8IChpc0h1bWFuVGVhbSAmJiAhaXNBY3RpdmVQbGF5ZXIpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hc3RlciBBSSBTd2l0Y2ggZm9yIHRoZSB0ZWFtCiAgICAgICAgICAgIGNvbnN0IGlzVGVhbUFJRW5hYmxlZCA9IHRoaXMudGVhbSA/IHRoaXMudGVhbS5haUVuYWJsZWQgOiB0cnVlOwoKICAgICAgICAgICAgaWYgKGlzSW5jYXBhY2l0YXRlZCkgewogICAgICAgICAgICAgICAgLy8gSWYgc3R1bm5lZC9zbGVlcGluZywgZG8gbm90aGluZy4KICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2hvdWxkUnVuQUkgJiYgaXNUZWFtQUlFbmFibGVkKSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gSU1QUk9WRUQgUEVSQ0VQVElPTiBVUERBVEUgLS0tCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgcGVyY2VpdmVkIHBvc2l0aW9uIHRvd2FyZHMgcmVhbCB0YXJnZXQgKEJhbGwgb3IgQmFsbCBIb2xkZXIpCiAgICAgICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmICYmIHRoaXMuYmFsbFJlZi5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHJlYWxUYXJnZXQgPSB0aGlzLmJhbGxSZWYubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBJZiBiYWxsIGlzIGhlbGQsIHRyYWNrIHRoZSBob2xkZXIgd2l0aCBhbnRpY2lwYXRpb24KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmLmhvbGRlciAmJiB0aGlzLmJhbGxSZWYuaG9sZGVyLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVhbFRhcmdldCA9IHRoaXMuYmFsbFJlZi5ob2xkZXIubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IExlYWQgdGhlIHRhcmdldCBiYXNlZCBvbiB0aGVpciB2ZWxvY2l0eQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmLmhvbGRlci52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhbFRhcmdldC5hZGRTY2FsZWRWZWN0b3IodGhpcy5iYWxsUmVmLmhvbGRlci52ZWxvY2l0eSwgdGhpcy5hbnRpY2lwYXRpb25UaW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5iYWxsUmVmLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvciBsb29zZSBiYWxsLCBhbnRpY2lwYXRlIGJhc2VkIG9uIGJhbGwgdmVsb2NpdHkKICAgICAgICAgICAgICAgICAgICAgICAgcmVhbFRhcmdldC5hZGRTY2FsZWRWZWN0b3IodGhpcy5iYWxsUmVmLnZlbG9jaXR5LCB0aGlzLmFudGljaXBhdGlvblRpbWUgKiAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gTGVycCBwZXJjZXB0aW9uIHRvd2FyZHMgYW50aWNpcGF0ZWQgcmVhbGl0eQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFscGhhID0gTWF0aC5taW4oMS4wLCBkdCAqIHRoaXMucmVhY3Rpb25TcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJjZWl2ZWRUYXJnZXRQb3MubGVycChyZWFsVGFyZ2V0LCBhbHBoYSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMS4gRGVjaXNpb24gTWFraW5nCiAgICAgICAgICAgICAgICB0aGlzLmRlY2lzaW9uVGltZXIgKz0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWNpc2lvblRpbWVyID4gdGhpcy5kZWNpc2lvbkludGVydmFsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWNpc2lvblRpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9ldmFsdWF0ZVN0YXRlKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMi4gRXhlY3V0ZSBTdGF0ZSAoU2V0cyBpbnB1dFZlY3RvcikKICAgICAgICAgICAgICAgIHRoaXMuX2V4ZWN1dGVTdGF0ZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDMuIEludGVyY2VwdGlvbiBMb2dpYwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnRlcmNlcHRpb25QcmVzc3VyZShkdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBIZXJlIGlmOgogICAgICAgICAgICAgICAgLy8gMS4gQ29udHJvbGxlZCBieSBIdW1hbiAoc2hvdWxkUnVuQUkgPT0gZmFsc2UpCiAgICAgICAgICAgICAgICAvLyAyLiBBSSBMb2dpYyBpcyBEaXNhYmxlZCAoaXNUZWFtQUlFbmFibGVkID09IGZhbHNlKQoKICAgICAgICAgICAgICAgIC8vIElmIEFJIGlzIGRpc2FibGVkLCB3ZSBtdXN0IHN0b3AgdGhlIGJvdCBVTkxFU1MgaXQgaXMgYmVpbmcgZHJpdmVuIGJ5IGh1bWFuIGlucHV0LgogICAgICAgICAgICAgICAgLy8gSHVtYW4gaW5wdXQgZHJpdmVzIHRoZSBwbGF5ZXIgaWY6IGlzSHVtYW5UZWFtIEFORCBpc0FjdGl2ZVBsYXllciBBTkQgIWlzRGVtbwogICAgICAgICAgICAgICAgY29uc3QgaXNEcml2ZW5CeUh1bWFuID0gaXNIdW1hblRlYW0gJiYgaXNBY3RpdmVQbGF5ZXIgJiYgIWlzRGVtbzsKCiAgICAgICAgICAgICAgICBpZiAoIWlzVGVhbUFJRW5hYmxlZCAmJiAhaXNEcml2ZW5CeUh1bWFuKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBXZSBzdGlsbCBhcHBseSBwYXNzaXZlIGludGVyY2VwdGlvbiBpZiBpbiB0aGUgd2F5LgogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnRlcmNlcHRpb25QcmVzc3VyZShkdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIEJhc2UgVXBkYXRlCiAgICAgICAgICAgIHN1cGVyLnVwZGF0ZShkdCk7CiAgICAgICAgfQoKX2V2YWx1YXRlU3RhdGUoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CgogICAgICAgICAgICAvLyAxLiBJIGhhdmUgdGhlIGJhbGwKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0FUVEFDS19DQVJSWSc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIExvb3NlIEJhbGwgTG9naWMgKEFudGktRmxvY2tpbmcpCiAgICAgICAgICAgIGlmICghYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQ6IFJldHVybiB0byBmb3JtYXRpb24uIE9ubHkgY2hhc2UgaWYgd2UgYXJlIHRoZSBiZXN0IGNhbmRpZGF0ZS4KICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdSRVRVUk5fSE9NRSc7CgovLyBIeXN0ZXJlc2lzOiBJZiBJIHdhcyBhbHJlYWR5IGNoYXNpbmcsIEknbSBlZmZlY3RpdmVseSAiY2xvc2VyIiB0byBwcmV2ZW50IGppdHRlcnkgc3dpdGNoaW5nCiAgICAgICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIHR3byBwbGF5ZXJzIGZyb20gc3dhcHBpbmcgcm9sZXMgcmFwaWRseSB3aGVuIGVxdWlkaXN0YW50LgogICAgICAgICAgICAgICAgY29uc3QgYmlhcyA9ICh0aGlzLmFpU3RhdGUgPT09ICdDSEFTRScpID8gMC44IDogMS4wOwogICAgICAgICAgICAgICAgY29uc3QgbXlEaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKSAqIGJpYXM7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBpc0Nsb3Nlc3QgPSB0cnVlOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAgPT09IHRoaXMpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgR29hbGllIChHb2FsaWUgaGFuZGxlcyB0aGVpciBvd24gYXJlYTsgZmllbGQgcGxheWVycyBzaG91bGRuJ3QgcmVseSBvbiB0aGVtKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5yb2xlID09PSAnR0wnKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSBpbmNhcGFjaXRhdGVkIHRlYW1tYXRlcwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29udGludWU7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgdGVhbW1hdGUgZGlzdGFuY2UKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTm90ZTogV2UgZG9uJ3QgYXBwbHkgYmlhcyB0byBvdGhlcnMsIGVmZmVjdGl2ZWx5IG1ha2luZyAibWUiIHN0aWNraWVyIGlmIEknbSBhbHJlYWR5IGNoYXNpbmcKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcERpc3QgPSBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgYSB0ZWFtbWF0ZSBpcyBjbG9zZXIsIHlpZWxkIHRvIHRoZW0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBEaXN0IDwgbXlEaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0Nsb3Nlc3QgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQp9CgogICAgICAgICAgICAgICAgaWYgKGlzQ2xvc2VzdCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdDSEFTRSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIFRlYW1tYXRlIGhhcyBiYWxsCiAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlci50ZWFtID09PSB0aGlzLnRlYW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdTVVBQT1JUJzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNC4gT3Bwb25lbnQgaGFzIGJhbGwKICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0RFRkVORCc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9leGVjdXRlU3RhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmJhbGxSZWYpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN3aXRjaCAodGhpcy5haVN0YXRlKSB7CiAgICAgICAgICAgICAgICBjYXNlICdBVFRBQ0tfQ0FSUlknOiB0aGlzLl9zdGF0ZUF0dGFja0NhcnJ5KGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdTVVBQT1JUJzogdGhpcy5fc3RhdGVTdXBwb3J0KGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdERUZFTkQnOiB0aGlzLl9zdGF0ZURlZmVuZChkdCk7IGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnQ0hBU0UnOiB0aGlzLl9zdGF0ZUNoYXNlKGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdSRVRVUk5fSE9NRSc6IAogICAgICAgICAgICAgICAgZGVmYXVsdDogdGhpcy5fc3RhdGVSZXR1cm5Ib21lKGR0KTsgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIC0tLSBTVEFURVMgLS0tCgpfc3RhdGVBdHRhY2tDYXJyeShkdCkgewogICAgICAgICAgICAvLyBEcml2ZSB0byBnb2FsCiAgICAgICAgICAgIC8vIEhvbWUgKFNpZGUgMSkgYXR0YWNrcyAtWi4gQXdheSAoU2lkZSAtMSkgYXR0YWNrcyArWi4KICAgICAgICAgICAgY29uc3QgYXR0YWNrRGlyID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKY29uc3QgZ29hbFogPSA0NiAqIGF0dGFja0RpcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRhcmdldDogR29hbCAoYnV0IHJlc3BlY3QgY3JlYXNlKQogICAgICAgICAgICBfdGFyZ2V0UG9zLnNldCgwLCAwLCBnb2FsWik7CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwoKICAgICAgICAgICAgLy8gRGVjaXNpb246IFNob290IG9yIFBhc3M/CiAgICAgICAgICAgIGNvbnN0IGRpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDEuIFNob290IGlmIGNsb3NlIGFuZCBjbGVhcgogICAgICAgICAgICBpZiAoZGlzdFRvR29hbCA8IDIwLjAgJiYgIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdTSCcpOyAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMi4gUGFzcyBMb2dpYwogICAgICAgICAgICAvLyBDaGVjayBwYXNzIGlmOiBTdXJyb3VuZGVkLCBMb3cgRU4sIG9yIFBsYXltYWtlciAoTWlkZmllbGRlcikgc2VlcyBvcHBvcnR1bml0eQogICAgICAgICAgICBjb25zdCBpc1N1cnJvdW5kZWQgPSB0aGlzLl9pc1N1cnJvdW5kZWQoKTsKICAgICAgICAgICAgY29uc3QgbG93RU4gPSB0aGlzLmN1cnJlbnRFTiA8IDEwOwogICAgICAgICAgICBjb25zdCBpc1BsYXltYWtlciA9IHRoaXMuaXNNaWRmaWVsZGVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKChpc1N1cnJvdW5kZWQgfHwgbG93RU4gfHwgaXNQbGF5bWFrZXIpICYmICF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJlc3RNYXRlID0gdGhpcy5fZmluZEJlc3RQYXNzVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChiZXN0TWF0ZSkgewogICAgICAgICAgICAgICAgICAgIC8vIEV2YWx1YXRlIGlmIHBhc3MgaXMgd29ydGggaXQKICAgICAgICAgICAgICAgICAgICAvLyBJZiBQbGF5bWFrZXIsIHBhc3MgaWYgbWF0ZSBpcyBjbG9zZXIgdG8gZ29hbAogICAgICAgICAgICAgICAgICAgIC8vIElmIFBhbmljIChTdXJyb3VuZGVkL0xvd0VOKSwgcGFzcyB0byBhbnlvbmUgb3BlbgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxldCBzaG91bGRQYXNzID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3Vycm91bmRlZCB8fCBsb3dFTikgewogICAgICAgICAgICAgICAgICAgICAgICBzaG91bGRQYXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzUGxheW1ha2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG15RGlzdCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRlRGlzdCA9IE1hdGguYWJzKGJlc3RNYXRlLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGVEaXN0IDwgbXlEaXN0IC0gNS4wKSBzaG91bGRQYXNzID0gdHJ1ZTsgLy8gTWF0ZSBpcyA1bSBjbG9zZXIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHNob3VsZFBhc3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmFjZSB0YXJnZXQKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdChiZXN0TWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRXhlY3V0ZSBQYXNzCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3NtYXJ0VGhyb3codGhpcy5iYWxsUmVmLCAnUEEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMy4gUGFuaWMgQ2xlYXIgKElmIHN1cnJvdW5kZWQgYW5kIG5vIHBhc3MpCiAgICAgICAgICAgIGlmIChpc1N1cnJvdW5kZWQgJiYgIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgLy8gSnVzdCBzaG9vdC9jbGVhcgogICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdTSCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfaXNTdXJyb3VuZGVkKCkgewogICAgICAgICAgICAvLyBTaW1wbGUgY2hlY2s6IGNvdW50IGVuZW1pZXMgbmVhcmJ5CiAgICAgICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmIChwLm1lc2ggJiYgcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5tZXNoLnBvc2l0aW9uKSA8IDQuMCkgewogICAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvdW50ID49IDI7CiAgICAgICAgfQoKX3NtYXJ0VGhyb3coYmFsbCwgZm9yY2VkVHlwZSA9IG51bGwpIHsKICAgICAgICAgICAgLy8gV3JhcHBlciBhcm91bmQgdGhyb3dCYWxsIHRvIG1hbmFnZSBIUCBhbmQgVGVjaHMKICAgICAgICAgICAgLy8gMS4gRGV0ZXJtaW5lIGludGVuZGVkIGFjdGlvbiB0eXBlCiAgICAgICAgICAgIGxldCB0eXBlID0gZm9yY2VkVHlwZTsKICAgICAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICBjb25zdCBhdHRhY2tEaXIgPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKICAgICAgICAgICAgICAgIGNvbnN0IGlzQWltaW5nR29hbCA9IChfdGVtcFZlYzEueiAqIGF0dGFja0RpciA+IDAuNSk7CiAgICAgICAgICAgICAgICB0eXBlID0gaXNBaW1pbmdHb2FsID8gJ1NIJyA6ICdQQSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIEdldCBUZWNoCiAgICAgICAgICAgIGNvbnN0IHRlY2hOYW1lID0gKHR5cGUgPT09ICdTSCcpID8gdGhpcy50ZWNocy5zaG9vdCA6IHRoaXMudGVjaHMucGFzczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDMuIEVzdGltYXRlIENvc3QKICAgICAgICAgICAgbGV0IGJhc2VDb3N0ID0gKHR5cGUgPT09ICdTSCcpID8gMjAgOiAxMDsKICAgICAgICAgICAgbGV0IHRlY2hDb3N0ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgLy8gUm91Z2ggZXN0aW1hdGVzIGJhc2VkIG9uIFBsYXllci5qcwogICAgICAgICAgICAgICAgaWYgKHRlY2hOYW1lLmluY2x1ZGVzKCduYXAnKSkgdGVjaENvc3QgPSAzMDsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2hOYW1lLmluY2x1ZGVzKCdzcGhlcmUnKSB8fCB0ZWNoTmFtZS5pbmNsdWRlcygnaW52aXNpYmxlJykpIHRlY2hDb3N0ID0gMjU7CiAgICAgICAgICAgICAgICBlbHNlIHRlY2hDb3N0ID0gMjA7IC8vIFZlbm9tL1dpdGhlcgogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCB0b3RhbENvc3QgPSBiYXNlQ29zdCArIHRlY2hDb3N0OwoKICAgICAgICAgICAgLy8gNC4gRGVjaXNpb24KICAgICAgICAgICAgLy8gSWYgd2UgaGF2ZSBhIHRlY2ggYnV0IG5vdCBlbm91Z2ggSFAgZm9yIGl0LCBCVVQgZW5vdWdoIEhQIGZvciBub3JtYWwuLi4KICAgICAgICAgICAgLy8gRGlzYWJsZSB0ZWNoIHRlbXBvcmFyaWx5IHRvIGF2b2lkICJUaXJlZCIgcGVuYWx0eSAoMC41eCBzdGF0cykKICAgICAgICAgICAgbGV0IHRlbXBUZWNoID0gbnVsbDsKICAgICAgICAgICAgaWYgKHRlY2hOYW1lICYmIHRoaXMuc3RhdHMuSFAgPCB0b3RhbENvc3QgJiYgdGhpcy5zdGF0cy5IUCA+PSBiYXNlQ29zdCkgewogICAgICAgICAgICAgICAgLy8gVW5lcXVpcAogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wVGVjaCA9IHRoaXMudGVjaHMuc2hvb3Q7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWNocy5zaG9vdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRlbXBUZWNoID0gdGhpcy50ZWNocy5wYXNzOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGVjaHMucGFzcyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEV4ZWN1dGUKICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgdHlwZSk7CgogICAgICAgICAgICAvLyBSZXN0b3JlCiAgICAgICAgICAgIGlmICh0ZW1wVGVjaCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHRoaXMudGVjaHMuc2hvb3QgPSB0ZW1wVGVjaDsKICAgICAgICAgICAgICAgIGVsc2UgdGhpcy50ZWNocy5wYXNzID0gdGVtcFRlY2g7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpfc3RhdGVDaGFzZShkdCkgewogICAgICAgICAgICAvLyBJbnRlcmNlcHRpb246IENoYXNlIHRoZSBQRVJDRUlWRUQgcG9zaXRpb24sIG5vdCB0aGUgcmVhbCBvbmUuCiAgICAgICAgICAgIC8vIFRoaXMgYWxsb3dzIGp1a2VzIHRvIHdvcmsgYmVjYXVzZSB0aGUgQUkgaXMgY2hhc2luZyB3aGVyZSB5b3UgV0VSRS4KICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElmIGJhbGwgaGFzIHZlbG9jaXR5LCBsZWFkIGl0IHNsaWdodGx5IGJhc2VkIG9uIHBlcmNlcHRpb24KICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKICAgICAgICAgICAgaWYgKGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDEuMCkgewogICAgICAgICAgICAgICAgX3RhcmdldFBvcy5hZGRTY2FsZWRWZWN0b3IoYmFsbC52ZWxvY2l0eSwgMC4zKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CiAgICAgICAgfQoKX3N0YXRlUmV0dXJuSG9tZShkdCkgewogICAgICAgICAgICAvLyBSZXR1cm4gdG8gZm9ybWF0aW9uIHBvc2l0aW9uCiAgICAgICAgICAgIF90YXJnZXRQb3MuY29weSh0aGlzLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwogICAgICAgIH0KCl9zdGF0ZVN1cHBvcnQoZHQpIHsKICAgICAgICAgICAgLy8gT0ZGRU5TRSAoVGVhbW1hdGUgaGFzIGJhbGwpCiAgICAgICAgICAgIC8vIEdvYWw6IEZpbmQgb3BlbiBzcGFjZSB0byByZWNlaXZlIGEgcGFzcwogICAgICAgICAgICBjb25zdCBiYWxsUG9zID0gdGhpcy5iYWxsUmVmLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IGF0dGFja0RpciA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtMSA6IDE7CmNvbnN0IGdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC00NiA6IDQ2OwoKICAgICAgICAgICAgLy8gMS4gRGV0ZXJtaW5lICJJZGVhbCIgU3VwcG9ydCBQb3NpdGlvbgogICAgICAgICAgICAvLyBTdGFydCB3aXRoIGZvcm1hdGlvbiBob21lCiAgICAgICAgICAgIF90YXJnZXRQb3MuY29weSh0aGlzLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAyLiBEeW5hbWljIEFkanVzdG1lbnQKICAgICAgICAgICAgaWYgKHRoaXMuaXNGb3J3YXJkKSB7CiAgICAgICAgICAgICAgICAvLyBGb3J3YXJkczogTWFrZSBydW5zIHRvd2FyZHMgdGhlIGdvYWwvYm94CiAgICAgICAgICAgICAgICAvLyBJZiBiYWxsIGlzIGRlZXAsIGN1dCB0byBjZW50ZXIuIElmIGJhbGwgaXMgYmFjaywgcHVzaCBsaW5lLgogICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gYmFsbFBvcy56ICsgKGF0dGFja0RpciAqIDEwLjApOyAvLyBTdGF5IGFoZWFkIG9mIGJhbGwKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gWmlnLXphZyBydW4gcGF0dGVybiBiYXNlZCBvbiB0aW1lIHRvIGxvb2sgImFsaXZlIgogICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IERhdGUubm93KCkgKiAwLjAwMTsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueCArPSBNYXRoLnNpbih0aW1lICsgdGhpcy5tZXNoLmlkKSAqIDUuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNNaWRmaWVsZGVyKSB7CiAgICAgICAgICAgICAgICAvLyBNaWRmaWVsZGVyczogRmluZCBwb2NrZXQgYmV0d2VlbiBiYWxsIGFuZCBnb2FsCiAgICAgICAgICAgICAgICBfdGVtcFZlYzEuc2V0KDAsIDAsIGdvYWxaKTsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MubGVycFZlY3RvcnMoYmFsbFBvcywgX3RlbXBWZWMxLCAwLjQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTdGF5IHdpZGUgaWYgYmFsbCBpcyBjZW50cmFsLCBjb21lIGNlbnRyYWwgaWYgYmFsbCBpcyB3aWRlCiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoYmFsbFBvcy54KSA8IDUpIF90YXJnZXRQb3MueCA9ICh0aGlzLmhvbWVQb3NpdGlvbi54ID4gMCA/IDEwIDogLTEwKTsKICAgICAgICAgICAgICAgIGVsc2UgX3RhcmdldFBvcy54ID0gMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIERlZmVuZGVyczogU3VwcG9ydCBmcm9tIGJlaGluZCAoc2FmZXR5IHZhbHZlKQogICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gYmFsbFBvcy56IC0gKGF0dGFja0RpciAqIDguMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIEF2b2lkIERlZmVuZGVycyAoUmF5Y2FzdC1pc2ggY2hlY2spCiAgICAgICAgICAgIC8vIElmIGEgZGVmZW5kZXIgaXMgbmVhciBteSB0YXJnZXQsIHNoaWZ0IGF3YXkKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKGdhbWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAodGhpcy50ZWFtLmlkID09PSAnaG9tZScpID8gZ2FtZS50ZWFtcy5hd2F5IDogZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wcC5tZXNoICYmIG9wcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oX3RhcmdldFBvcykgPCA0LjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVmZW5kZXIgaXMgY2xvZ2dpbmcgbXkgc3BvdC4gU2hpZnQgYXdheSBmcm9tIHRoZW0uCiAgICAgICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjMi5jb3B5KF90YXJnZXRQb3MpLnN1YihvcHAubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjMiwgNS4wKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIENsYW1wIHRvIEFyZW5hICYgQ3JlYXNlCiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKCiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICB9Cgpfc3RhdGVEZWZlbmQoZHQpIHsKICAgICAgICAgICAgLy8gREVGRU5TRSAoT3Bwb25lbnQgaGFzIGJhbGwpCiAgICAgICAgICAgIC8vIFVzZSBQZXJjZWl2ZWQgUG9zaXRpb24gZm9yIGRpc3RhbmNlIGNoZWNrcyBhbmQgbW92ZW1lbnQKICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9zID0gdGhpcy5wZXJjZWl2ZWRUYXJnZXRQb3M7CiAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXRQb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMS4gRGV0ZXJtaW5lIFByZXNzIFJhbmdlCiAgICAgICAgICAgIC8vIEJhc2UgcmFuZ2UKLy8gQmFzZSByYW5nZQogICAgICAgICAgICBsZXQgcHJlc3NSYW5nZSA9IHRoaXMuaXNEZWZlbmRlciA/IDIwLjAgOiAxNS4wOyAvLyBJbmNyZWFzZWQgYWdncmVzc2lvbiByYW5nZQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQWdncmVzc2l2ZSBUZWNoIFVzYWdlCiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnRhY2tsZSAmJiB0aGlzLnN0YXRzLkhQID4gMjApIHsKICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgKz0gNS4wOyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIEFOVEktU1dBUk0gTE9HSUMgJiBBR0dSRVNTSU9OIC0tLQogICAgICAgICAgICAvLyBPbmx5IHRoZSBjbG9zZXN0IGRlZmVuZGVyIHNob3VsZCBoYXJkLXByZXNzIGZyb20gZGlzdGFuY2UuCiAgICAgICAgICAgIC8vIE90aGVycyBzaG91bGQgc3RpY2sgdG8gdGhlaXIgem9uZXMvbWFya3MgdW5sZXNzIHRoZSBiYWxsIGVudGVycyB0aGVpciBwZXJzb25hbCBzcGFjZS4KICAgICAgICAgICAgbGV0IGFtSUNsb3Nlc3QgPSB0cnVlOwogICAgICAgICAgICBjb25zdCBteURpc3RTcSA9IGRpc3RUb0JhbGwgKiBkaXN0VG9CYWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgZm9yKGNvbnN0IG1hdGUgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcyB8fCAhbWF0ZS5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgR29hbGllIGFuZCBpbmNhcGFjaXRhdGVkIHRlYW1tYXRlcwogICAgICAgICAgICAgICAgICAgIGlmIChtYXRlLnJvbGUgPT09ICdHTCcgfHwgbWF0ZS5zdGF0dXMubmFwID4gMCB8fCBtYXRlLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFVzZSByZWFsIHBvc2l0aW9ucyBmb3IgdGVhbW1hdGUgY29tcGFyaXNvbiAoQUkga25vd3Mgd2hlcmUgdGVhbW1hdGVzIGFyZSkKICAgICAgICAgICAgICAgICAgICBjb25zdCBkU3EgPSBtYXRlLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUb1NxdWFyZWQodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZFNxIDwgbXlEaXN0U3EpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYW1JQ2xvc2VzdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFpPTUJJRSBGSVg6IElmIEkgYW0gdGhlIGNsb3Nlc3QsIEkgTVVTVCBDSEFTRS4KICAgICAgICAgICAgLy8gU2V0IHByZXNzUmFuZ2UgdG8gZXNzZW50aWFsbHkgaW5maW5pdGUgaWYgY2xvc2VzdCwgc28gdGhleSBkb24ndCBqdXN0IHN0YW5kIHRoZXJlLgovLyBaT01CSUUgRklYOiBJZiBJIGFtIHRoZSBjbG9zZXN0LCBJIE1VU1QgQ0hBU0UuCiAgICAgICAgICAgIC8vIFNldCBwcmVzc1JhbmdlIHRvIGVzc2VudGlhbGx5IGluZmluaXRlIGlmIGNsb3Nlc3QsIHNvIHRoZXkgZG9uJ3QganVzdCBzdGFuZCB0aGVyZS4KICAgICAgICAgICAgaWYgKGFtSUNsb3Nlc3QpIHsKICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgPSAxMDAuMDsgLy8gSW5maW5pdGUgY2hhc2UKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb015R29hbCA9IE1hdGguYWJzKHRhcmdldFBvcy56IC0gKHRoaXMudGVhbS5zaWRlID09PSAxID8gNDYgOiAtNDYpKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9NeUdvYWwgPCA0MC4wKSB7CiAgICAgICAgICAgICAgICAgICAgcHJlc3NSYW5nZSA9IDI1LjA7IC8vIEFnZ3Jlc3NpdmUgem9uZSBkZWZlbnNlCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgPSAxMC4wOyAvLyBMb29zZXIgbWFya2luZyBpbiBtaWRmaWVsZAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIElmIGJhbGwgaXMgY2xvc2UgZW5vdWdoIChiYXNlZCBvbiBjb250ZXh0KSwgUFJFU1MgSVQKICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCBwcmVzc1JhbmdlKSB7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gTWFyayBNb2RlIChNYW4tdG8tTWFuKQogICAgICAgICAgICAvLyBJZiBJIGhhdmUgYSBtYXJrIGFzc2lnbmVkLCBzdGljayB0byB0aGVtIHVubGVzcyBwcmVzc2luZyBiYWxsCiAgICAgICAgICAgIGlmICh0aGlzLm1hcmtpbmcgJiYgdGhpcy5tYXJraW5nLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG1hcmtQb3MgPSB0aGlzLm1hcmtpbmcubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUG9zaXRpb246IEJldHdlZW4gbWFyayBhbmQgbXkgZ29hbCAoR29hbCBTaWRlKQpjb25zdCBteUdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IDQ2IDogLTQ2OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZWN0b3IgZnJvbSBNYXJrIHRvIEdvYWwKICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5zZXQoMCwgMCwgbXlHb2FsWiAtIG1hcmtQb3Mueik7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gX3RlbXBWZWMxLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgX3RlbXBWZWMxLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTdGFuZCAzLjUgdW5pdHMgdG93YXJkcyBnb2FsIGZyb20gdGhlIG1hcmsgKEluY3JlYXNlZCBmcm9tIDIuMCB0byBnaXZlIGJyZWF0aGluZyByb29tKQogICAgICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KG1hcmtQb3MpLmFkZFNjYWxlZFZlY3RvcihfdGVtcFZlYzEsIDMuNSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gWm9uZSBEZWZlbnNlIChGb3JtYXRpb24gKyBTbGlkZSkKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNsaWRlIGxvZ2ljIChTaGlmdCBmb3JtYXRpb24gdG93YXJkcyBiYWxsIHNpZGUpCiAgICAgICAgICAgIF90YXJnZXRQb3MueiArPSBiYWxsUG9zLnogKiAwLjY7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEZWZlbmRlciBPdmVycmlkZTogQWx3YXlzIHN0YXkgYmV0d2VlbiBiYWxsIGFuZCBnb2FsCi8vIERlZmVuZGVyIE92ZXJyaWRlOiBBbHdheXMgc3RheSBiZXR3ZWVuIGJhbGwgYW5kIGdvYWwKICAgICAgICAgICAgaWYgKHRoaXMuaXNEZWZlbmRlcikgewogICAgICAgICAgICAgICAgY29uc3QgbXlHb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyA0NiA6IC00NjsKICAgICAgICAgICAgICAgIGNvbnN0IG1pZHBvaW50ID0gKGJhbGxQb3MueiArIG15R29hbFopICogMC41OwogICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gKF90YXJnZXRQb3MueiArIG1pZHBvaW50KSAqIDAuNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2xhbXAKLy8gQ2xhbXAKICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gTWF0aC5tYXgoLTQ0LjAsIE1hdGgubWluKDQ0LjAsIF90YXJnZXRQb3MueikpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CiAgICAgICAgfQoKX2F2b2lkR29hbENyZWFzZSh0YXJnZXRQb3MpIHsKICAgICAgICAgICAgLy8gMS4gR29hbCBDcmVhc2UgQXZvaWRhbmNlIChSYWRpdXMgMTAgYXJvdW5kIGdvYWxzIGF0ICsvLSAyOCkKICAgICAgICAgICAgLy8gTWF0Y2hlcyBQbGF5ZXIuanMgX2FwcGx5R29hbENyZWFzZSBwaHlzaWNzIHRvIHByZXZlbnQgc3R1dHRlcmluZwovLyAxLiBHb2FsIENyZWFzZSBBdm9pZGFuY2UgKFJhZGl1cyAxMCBhcm91bmQgZ29hbHMgYXQgKy8tIDI4KQogICAgICAgICAgICAvLyBNYXRjaGVzIFBsYXllci5qcyBfYXBwbHlHb2FsQ3JlYXNlIHBoeXNpY3MgdG8gcHJldmVudCBzdHV0dGVyaW5nCi8vIE1hdGNoZXMgUGxheWVyLmpzIF9hcHBseUdvYWxDcmVhc2UgcGh5c2ljcyB0byBwcmV2ZW50IHN0dXR0ZXJpbmcKICAgICAgICAgICAgY29uc3QgY3JlYXNlUmFkaXVzID0gMTAuMDsKICAgICAgICAgICAgY29uc3QgZ29hbHMgPSBbCiAgICAgICAgICAgICAgICB7IHg6IDAsIHo6IC00NiB9CiAgICAgICAgICAgIF07CgogICAgICAgICAgICBnb2Fscy5mb3JFYWNoKGdvYWwgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZHggPSB0YXJnZXRQb3MueCAtIGdvYWwueDsKICAgICAgICAgICAgICAgIGNvbnN0IGR6ID0gdGFyZ2V0UG9zLnogLSBnb2FsLno7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR6KmR6OwoKICAgICAgICAgICAgICAgIGlmIChkaXN0U3EgPCBjcmVhc2VSYWRpdXMgKiBjcmVhc2VSYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJbnNpZGUgY3JlYXNlLCBwcm9qZWN0IHRvIGVkZ2UKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPiAwLjAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IGNyZWFzZVJhZGl1cyAvIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy54ID0gZ29hbC54ICsgZHggKiByYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnogPSBnb2FsLnogKyBkeiAqIHJhdGlvOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEV4YWN0IGNlbnRlciwgcHVzaCBvdXQgdG93YXJkcyBjZW50ZXIgZmllbGQKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnogPSBnb2FsLnogKyAoZ29hbC56ID4gMCA/IC1jcmVhc2VSYWRpdXMgOiBjcmVhc2VSYWRpdXMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgovLyAyLiBBcmVuYSBCb3VuZGFyeSBDbGFtcAogICAgICAgICAgICBjb25zdCBhcmVuYVJhZGl1cyA9IDQ1LjA7IC8vIEtlZXAgc2xpZ2h0bHkgaW5zaWRlIHZpc3VhbC9waHlzaWNzIHdhbGwKICAgICAgICAgICAgY29uc3QgZFNxID0gdGFyZ2V0UG9zLnggKiB0YXJnZXRQb3MueCArIHRhcmdldFBvcy56ICogdGFyZ2V0UG9zLno7CgogICAgICAgICAgICBpZiAoZFNxID4gYXJlbmFSYWRpdXMqYXJlbmFSYWRpdXMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGQgPSBNYXRoLnNxcnQoZFNxKTsKICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBhcmVuYVJhZGl1cyAvIGQ7CiAgICAgICAgICAgICAgICB0YXJnZXRQb3MueCAqPSByOwogICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnogKj0gcjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2ZpbmRCZXN0UGFzc1RhcmdldCgpIHsKICAgICAgICAgICAgbGV0IGJlc3RUYXJnZXQgPSBudWxsOwogICAgICAgICAgICBsZXQgbWF4U2NvcmUgPSAtSW5maW5pdHk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBdHRhY2sgZGlyZWN0aW9uICYgR29hbCBaCiAgICAgICAgICAgIGNvbnN0IGF0dGFja0RpciA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtMSA6IDE7IC8vIEhvbWUgYXR0YWNrcyAtWgpjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtNDYgOiA0NjsKCiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKG1hdGUgPT09IHRoaXMpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKCFtYXRlLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKG1hdGUuc3RhdHVzLm5hcCA+IDApIGNvbnRpbnVlOyAvLyBEb24ndCBwYXNzIHRvIHNsZWVwZXJzCiAgICAgICAgICAgICAgICBpZiAobWF0ZS5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsgIC8vIERvbid0IHBhc3MgdG8gc3R1bm5lZCBwbGF5ZXJzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhtYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA0LjApIGNvbnRpbnVlOyAgLy8gVG9vIGNsb3NlIChSZWR1Y2VkIGZvciB0aWtpLXRha2EpCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IDMwLjApIGNvbnRpbnVlOyAvLyBUb28gZmFyIChJbmNyZWFzZWQgcmFuZ2UpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDEuIFJheWNhc3QgQ2hlY2sgKElzIHRoZSBsYW5lIGNsZWFyPykKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9pc1BhdGhCbG9ja2VkKG1hdGUubWVzaC5wb3NpdGlvbikpIGNvbnRpbnVlOyAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMi4gQ2FsY3VsYXRlIFN0cmF0ZWdpYyBTY29yZQogICAgICAgICAgICAgICAgbGV0IHNjb3JlID0gMDsKCiAgICAgICAgICAgICAgICAvLyBBLiBGb3J3YXJkIFByb2dyZXNzIChWZXJ0aWNhbGl0eSkKICAgICAgICAgICAgICAgIGNvbnN0IG15RGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgY29uc3QgbWF0ZURpc3RUb0dvYWwgPSBNYXRoLmFicyhtYXRlLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gbXlEaXN0VG9Hb2FsIC0gbWF0ZURpc3RUb0dvYWw7IC8vIFBvc2l0aXZlIGlmIG1vdmluZyBjbG9zZXIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2NvcmUgKz0gcHJvZ3Jlc3MgKiAxLjU7IAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBCLiBHb2FsIFByb3hpbWl0eSAoQWJzb2x1dGUpCiAgICAgICAgICAgICAgICBpZiAobWF0ZURpc3RUb0dvYWwgPCAxNS4wKSBzY29yZSArPSAxMC4wOwogICAgICAgICAgICAgICAgaWYgKG1hdGVEaXN0VG9Hb2FsIDwgOC4wKSBzY29yZSArPSAxNS4wOwoKICAgICAgICAgICAgICAgIC8vIEMuIE9wZW5uZXNzIChTcGFjZSBhcm91bmQgcmVjZWl2ZXIpCiAgICAgICAgICAgICAgICBjb25zdCBvcGVubmVzcyA9IHRoaXMuX2NhbGN1bGF0ZU9wZW5uZXNzKG1hdGUpOwogICAgICAgICAgICAgICAgc2NvcmUgKz0gb3Blbm5lc3MgKiAzLjA7IC8vIEhpZ2ggd2VpZ2h0IG9uIHNhZmV0eQoKICAgICAgICAgICAgICAgIC8vIEQuIFJvbGUgQmlhcyAoRm9yd2FyZHMgYXJlIHByaW1lIHRhcmdldHMpCiAgICAgICAgICAgICAgICBpZiAobWF0ZS5pc0ZvcndhcmQpIHNjb3JlICs9IDUuMDsKCiAgICAgICAgICAgICAgICAvLyBFLiBEaXN0YW5jZSBQZW5hbHR5IChMb25nIHBhc3NlcyBhcmUgcmlza3kpCiAgICAgICAgICAgICAgICBzY29yZSAtPSBkaXN0ICogMC41OwoKICAgICAgICAgICAgICAgIGlmIChzY29yZSA+IG1heFNjb3JlKSB7CiAgICAgICAgICAgICAgICAgICAgbWF4U2NvcmUgPSBzY29yZTsKICAgICAgICAgICAgICAgICAgICBiZXN0VGFyZ2V0ID0gbWF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGJlc3RUYXJnZXQ7CiAgICAgICAgfQoKICAgICAgICBfY2FsY3VsYXRlT3Blbm5lc3MocGxheWVyKSB7CiAgICAgICAgICAgIGxldCBtaW5EZWZEaXN0ID0gOTk5OwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiAwOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKCiAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCB8fCBvcHAuc3RhdHVzLm5hcCA+IDAgfHwgb3BwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZCA9IHBsYXllci5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGQgPCBtaW5EZWZEaXN0KSBtaW5EZWZEaXN0ID0gZDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2xhbXA6IEFueXRoaW5nIGJleW9uZCA4bSBpcyAiV2lkZSBPcGVuIgogICAgICAgICAgICByZXR1cm4gTWF0aC5taW4obWluRGVmRGlzdCwgOC4wKTsKICAgICAgICB9CgogICAgICAgIF9pc1BhdGhCbG9ja2VkKHRhcmdldFBvcykgewogICAgICAgICAgICBjb25zdCBzdGFydCA9IHRoaXMubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgZW5kID0gdGFyZ2V0UG9zOwogICAgICAgICAgICBjb25zdCBkaXN0ID0gc3RhcnQuZGlzdGFuY2VUbyhlbmQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUHJlcGFyZSBSYXkgRGlyZWN0aW9uCiAgICAgICAgICAgIF9zY2FuRGlyLnN1YlZlY3RvcnMoZW5kLCBzdGFydCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9ICh0aGlzLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbnRlcmNlcHRpb24gcmFkaXVzCiAgICAgICAgICAgIGNvbnN0IHNhZmV0eVJhZGl1cyA9IDIuNTsgCgogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2ggfHwgb3BwLnN0YXR1cy5uYXAgPiAwIHx8IG9wcC5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmVjdG9yIGZyb20gc3RhcnQgdG8gb3Bwb25lbnQKICAgICAgICAgICAgICAgIF9zY2FuVG9PcHAuc3ViVmVjdG9ycyhvcHAubWVzaC5wb3NpdGlvbiwgc3RhcnQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQcm9qZWN0IG9udG8gcGF0aAogICAgICAgICAgICAgICAgY29uc3QgcHJvamVjdGlvbiA9IF9zY2FuVG9PcHAuZG90KF9zY2FuRGlyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgcHJvamVjdGlvbiBpcyB3aXRoaW4gdGhlIHNlZ21lbnQKICAgICAgICAgICAgICAgIGlmIChwcm9qZWN0aW9uID4gMCAmJiBwcm9qZWN0aW9uIDwgZGlzdCkgewogICAgICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBwZXJwZW5kaWN1bGFyIGRpc3RhbmNlIHNxdWFyZWQKICAgICAgICAgICAgICAgICAgICAvLyBkaXN0U3EgPSB8dG9PcHB8XjIgLSBwcm9qZWN0aW9uXjIKICAgICAgICAgICAgICAgICAgICBjb25zdCBwZXJwRGlzdFNxID0gX3NjYW5Ub09wcC5sZW5ndGhTcSgpIC0gKHByb2plY3Rpb24gKiBwcm9qZWN0aW9uKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAocGVycERpc3RTcSA8IChzYWZldHlSYWRpdXMgKiBzYWZldHlSYWRpdXMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBCbG9ja2VkCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgpfbW92ZVRvKHRhcmdldCkgewogICAgICAgICAgICBfYWlWZWMuc3ViVmVjdG9ycyh0YXJnZXQsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIF9haVZlYy55ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IF9haVZlYy5sZW5ndGhTcSgpOwoKICAgICAgICAgICAgLy8gRGVhZHpvbmU6IElmIHdpdGhpbiAxLjBtICgxLjAgc3EpLCBzdG9wLgogICAgICAgICAgICAvLyBJbmNyZWFzZWQgZnJvbSAwLjEgKDAuM20pIHRvIHByZXZlbnQgbWljcm8tYWRqdXN0bWVudCBzcGlubmluZyBhdCBkZXN0aW5hdGlvbi4KICAgICAgICAgICAgLy8gVGhpcyBpcyBjcnVjaWFsIHdoZW4gdGFyZ2V0cyBhcmUgZHluYW1pYyAoZS5nLiByZWxhdGl2ZSB0byBiYWxsIGhvbGRlcikuCiAgICAgICAgICAgIGlmIChkaXN0U3EgPiAxLjApIHsKICAgICAgICAgICAgICAgIF9haVZlYy5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoX2FpVmVjLngsIF9haVZlYy56KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICAvLyBCcmFraW5nIGZyaWN0aW9uIHRvIHN0b3AgZHJpZnQgaW1tZWRpYXRlbHkgdXBvbiByZWFjaGluZyB0YXJnZXQKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC44KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9hcHBseUludGVyY2VwdGlvblByZXNzdXJlKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47IC8vIFNhZmV0eSBjaGVjawoKICAgICAgICAgICAgLy8gMS4gQmFzaWMgRWxpZ2liaWxpdHkgQ2hlY2tzCiAgICAgICAgICAgIC8vIE11c3QgYmUgZnJlZSBhbmQgbW92aW5nCiAgICAgICAgICAgIGlmIChiYWxsLnN0YXRlICE9PSAnZnJlZScgfHwgYmFsbC52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMS4wKSByZXR1cm47CiAgICAgICAgICAgIC8vIENhbm5vdCBpbnRlcmNlcHQgaW52aXNpYmxlIGJhbGwKICAgICAgICAgICAgaWYgKGJhbGwuaXNJbnZpc2libGUpIHJldHVybjsKICAgICAgICAgICAgLy8gU2tpcCBpZiBzbGVlcGluZyBvciBzdHVubmVkCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMi4gUmFuZ2UgQ2FsY3VsYXRpb24gKFRoZSAiRmllbGQiIFJhZGl1cykKICAgICAgICAgICAgbGV0IHJhbmdlID0gMi4wOyAvLyBSZWR1Y2VkIGZyb20gMy41IHRvIHByZXZlbnQgImZvcmNlIGZpZWxkIiBmZWVsaW5nCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQYXNzaXZlIFRlY2hzOiBCcmF3bGVyIC8gRWxpdGUgRGVmZW5zZQogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5wYXNzaXZlID09PSAnYnJhd2xlcicgfHwgdGhpcy50ZWNocy5wYXNzaXZlID09PSAnZWxpdGVfZGVmZW5zZScpIHsKICAgICAgICAgICAgICAgIHJhbmdlICs9IDEuNTsgLy8gUmVkdWNlZCBib29zdAogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgaWYgKGRpc3QgPiByYW5nZSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMy4gRGlyZWN0aW9uYWwgRmFjdG9yIChUaGUgIkNvbmUiKQogICAgICAgICAgICAvLyBWZWN0b3IgZnJvbSBCYWxsIHRvIERlZmVuZGVyCiAgICAgICAgICAgIF9zY2FuVG9PcHAuc3ViVmVjdG9ycyh0aGlzLm1lc2gucG9zaXRpb24sIGJhbGwubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIF90ZW1wVmVjMS5jb3B5KGJhbGwudmVsb2NpdHkpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRG90IFByb2R1Y3Q6IAogICAgICAgICAgICAvLyAxLjAgPSBCYWxsIGhlYWRpbmcgc3RyYWlnaHQgZm9yIGRlZmVuZGVyCiAgICAgICAgICAgIC8vIDAuMCA9IFBhc3NpbmcgYnkgc2lkZSAoUGVycGVuZGljdWxhcikKICAgICAgICAgICAgY29uc3QgaGVhZGluZ0RvdCA9IF90ZW1wVmVjMS5kb3QoX3NjYW5Ub09wcCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBPbmx5IGFwcGx5IGRyYWcgaWYgYmFsbCBpcyBhcHByb2FjaGluZyBESVJFQ1RMWSAoU3RyaWN0ZXIgY29uZSkKICAgICAgICAgICAgLy8gSW5jcmVhc2VkIHRocmVzaG9sZCBmcm9tIDAuMCB0byAwLjcgKE11c3QgYmUgd2l0aGluIH40NSBkZWdyZWVzKQogICAgICAgICAgICBpZiAoaGVhZGluZ0RvdCA8IDAuNykgcmV0dXJuOwoKICAgICAgICAgICAgLy8gNC4gQ2FsY3VsYXRlIFByZXNzdXJlIEludGVuc2l0eQogICAgICAgICAgICAvLyBEaXN0YW5jZSBGYWN0b3I6IENsb3NlciA9IFN0cm9uZ2VyIChMaW5lYXIgZmFsbG9mZikKICAgICAgICAgICAgY29uc3QgZGlzdEZhY3RvciA9IE1hdGgubWF4KDAsIDEuMCAtIChkaXN0IC8gcmFuZ2UpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFuZ2xlIEZhY3RvcjogRGlyZWN0IGhpdCA9IDEuMCwgR2xhbmNpbmcgPSAwLjQKICAgICAgICAgICAgY29uc3QgYW5nbGVGYWN0b3IgPSBNYXRoLm1heCgwLjMsIGhlYWRpbmdEb3QpOwoKICAgICAgICAgICAgLy8gQkwgU3RhdAogICAgICAgICAgICBjb25zdCBibCA9IHRoaXMuZ2V0U3RhdCgnQkwnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvdGFsIFByZXNzdXJlIChQQS9TSCBkcmFpbiBwZXIgc2Vjb25kKQogICAgICAgICAgICAvLyBCYXNlIG11bHRpcGxpZXIgZm9yIHN0YXRzIChSZWR1Y2VkIGZyb20gNi4wIHRvIDMuMCkKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmVNdWx0aXBsaWVyID0gMy4wOyAKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSBibCAqIGRpc3RGYWN0b3IgKiBhbmdsZUZhY3RvciAqIHByZXNzdXJlTXVsdGlwbGllciAqIGR0OwoKICAgICAgICAgICAgLy8gNS4gQXBwbHkgdG8gQmFsbCBTdGF0cyAoUEEvU0gpCiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlciAtPSBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrIChBY2N1bXVsYXRvcikKICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgPSAodGhpcy5fYWNjdW11bGF0ZWRCbG9jayB8fCAwKSArIHByZXNzdXJlOwogICAgICAgICAgICAgICAgLy8gU2hvdyBmbG9hdGluZyB0ZXh0IGV2ZXJ5IDUgcG9pbnRzIGRyYWluZWQKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hY2N1bXVsYXRlZEJsb2NrID49IDUuMCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBNYXRoLmZsb29yKHRoaXMuX2FjY3VtdWxhdGVkQmxvY2spOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgLT0gdmFsOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7IAogICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3Bhd24gb24gYmFsbCwgYXR0YWNoIHRvIGJhbGwKICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oYC0ke3ZhbH1gLCBiYWxsLm1lc2gucG9zaXRpb24sICJibG9jayIsIGJhbGwubWVzaCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA3LiBWaXN1YWxzOiBUaGUgIlRldGhlciIgLyBJbnRlcmZlcmVuY2UgRmllbGQKICAgICAgICAgICAgLy8gU3Bhd24gc3BhcmtzIGJldHdlZW4gYmFsbCBhbmQgZGVmZW5kZXIgdG8gc2hvdyB0aGUgZmllbGQgZWZmZWN0CiAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgKGRpc3RGYWN0b3IgKiAwLjgpKSB7IAogICAgICAgICAgICAgICAgX3RlbXBWZWMyLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKS5sZXJwKGJhbGwubWVzaC5wb3NpdGlvbiwgMC41ICsgKE1hdGgucmFuZG9tKCktMC41KSowLjIpOwogICAgICAgICAgICAgICAgLy8gSml0dGVyCiAgICAgICAgICAgICAgICBfdGVtcFZlYzIueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLnkgKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zcGF3bkNsYXNoKF90ZW1wVmVjMiwgMC42KTsgLy8gU3BhcmsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gOC4gU2hvdCBTdG9wIC8gQmxvY2sgTG9naWMKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCAmJiBiYWxsLnBvd2VyVHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlclR5cGUgPSAnbm9uZSc7IC8vIE5ldXRyYWxpemUgc2hvdAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOTyBERUZMRUNUSU9OOiBUaGUgYmFsbCBjb250aW51ZXMgb24gaXRzIHBhdGguCiAgICAgICAgICAgICAgICAvLyBJdCBpcyBub3cgYSAiZGVhZCBiYWxsIiAobm8gcG93ZXIpIGJ1dCBrZWVwcyBtb3ZpbmcuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7IAogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLRUQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIE5vIGltcGFjdCBmcmVlemUgdG8ga2VlcCBmbG93IHNtb290aAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA5LiBTdGF0dXMgUmlzayAoVmVub20vTmFwL1dpdGhlciBvbiBCYWxsKQogICAgICAgICAgICBpZiAoYmFsbC50ZWNobmlxdWUgJiYgIXRoaXMuX3RlY2hBcHBsaWVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLl90ZWNoQXBwbGllZCA9IHRydWU7CiAgICAgICAgICAgICAgICBjb25zdCB0ZWNoID0gYmFsbC50ZWNobmlxdWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZWNoLnR5cGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDE1LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICduYXAnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseVN0YXR1cygnbmFwJywgOC4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGVjaC50eXBlID09PSAnd2l0aGVyJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDE1LjAsICdCTCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy5fdGVjaEFwcGxpZWQgPSBmYWxzZTsgfSwgMjAwMCk7CiAgICAgICAgICAgIH0KfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkFJUGxheWVyID0gQUlQbGF5ZXI7Cn0pKCk7","Team.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIEZvcm1hdGlvbiBEZWZpbml0aW9ucyAoQ29vcmRpbmF0ZXMgZm9yIFNpZGUgMTogRGVmZW5kcyArWiwgQXR0YWNrcyAtWikKICAgIC8vIFg6IExlZnQoLSkvUmlnaHQoKyksIFo6IEZvcndhcmQoLSkvQmFjaygrKQogICAgY29uc3QgRk9STUFUSU9OUyA9IHsKICAgICAgICAnTm9ybWFsJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiA1IH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTEwLCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxMCwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdDZW50ZXIgQXR0YWNrJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAwIH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTQsIHo6IC0xNSB9LCAnUkYnOiB7IHg6IDQsIHo6IC0xNSB9CiAgICAgICAgfSwKICAgICAgICAnUmlnaHQgU2lkZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IDAsIHo6IDE1IH0sICdSRCc6IHsgeDogMTIsIHo6IDE1IH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiA1LCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxNSwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdMZWZ0IFNpZGUnOiB7CiAgICAgICAgICAgICdHTCc6IHsgeDogMCwgejogMjUgfSwKICAgICAgICAgICAgJ0xEJzogeyB4OiAtMTIsIHo6IDE1IH0sICdSRCc6IHsgeDogMCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAtMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTUsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IC01LCB6OiAtMTAgfQogICAgICAgIH0sCiAgICAgICAgJ0FsbC1PdXQgRGVmZW5zZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IC02LCB6OiAyMCB9LCAnUkQnOiB7IHg6IDYsIHo6IDIwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMTAgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTAsIHo6IDUgfSwgJ1JGJzogeyB4OiAxMCwgejogNSB9CiAgICAgICAgfSwKICAgICAgICAnRmxhdCBMaW5lJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDAgfSwgJ1JEJzogeyB4OiA4LCB6OiAwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMCB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xNSwgejogMCB9LCAnUkYnOiB7IHg6IDE1LCB6OiAwIH0KICAgICAgICB9LAogICAgICAgICdDb3VudGVyJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDIwIH0sICdSRCc6IHsgeDogOCwgejogMjAgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAxNSB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xMiwgejogLTIwIH0sICdSRic6IHsgeDogMTIsIHo6IC0yMCB9CiAgICAgICAgfSwKICAgICAgICAnRG91YmxlIFNpZGVzJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTE4LCB6OiAxNSB9LCAnUkQnOiB7IHg6IDE4LCB6OiAxNSB9LAogICAgICAgICAgICAnTUYnOiB7IHg6IDAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTgsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IDE4LCB6OiAtMTAgfQogICAgICAgIH0KICAgIH07CgoKCiAgICAvLyAtLS0gRW5lbXkgSW5kaWNhdG9yIChSZWQgQXJyb3cgU3ByaXRlKSAtLS0KICAgIC8vIFNoYXJlZCB0ZXh0dXJlL21hdGVyaWFsIHNvIHdlIGRvbid0IGNyZWF0ZSA2IGNhbnZhc2VzLgpjb25zdCBfZW5lbXlBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7CiAgICAgICAgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBjLndpZHRoLCBjLmhlaWdodCk7CiAgICAgICAgCiAgICAgICAgLy8gQXJyb3cgcG9pbnRpbmcgRE9XTgogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDYsIDEyKTsgICAKICAgICAgICBjdHgubGluZVRvKDU4LCAxMik7ICAKICAgICAgICBjdHgubGluZVRvKDMyLCA1Mik7ICAKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmYwMDAwJzsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpJzsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCmNvbnN0IF9wbGF5ZXJBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgYy53aWR0aCwgYy5oZWlnaHQpOwogICAgICAgIAogICAgICAgIC8vIEFycm93IHBvaW50aW5nIERPV04KICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyg2LCAxMik7ICAgCiAgICAgICAgY3R4LmxpbmVUbyg1OCwgMTIpOyAgCiAgICAgICAgY3R4LmxpbmVUbygzMiwgNTIpOyAgCiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwZmYwMCc7IC8vIEdyZWVuCiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsMjU1LDI1NSwwLjk1KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGMud2lkdGgsIGMuaGVpZ2h0KTsKICAgICAgICAKICAgICAgICAvLyBBcnJvdyBwb2ludGluZyBET1dOCiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oNiwgMTIpOyAgIAogICAgICAgIGN0eC5saW5lVG8oNTgsIDEyKTsgIAogICAgICAgIGN0eC5saW5lVG8oMzIsIDUyKTsgIAogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOyAvLyBXaGl0ZQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX2VuZW15QXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2VuZW15QXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CiAgICBjb25zdCBfcGxheWVyQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3BsYXllckFycm93VGV4dHVyZSwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoVGVzdDogZmFsc2UsIGRlcHRoV3JpdGU6IGZhbHNlIH0pOwogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3RlYW1tYXRlQXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CmNsYXNzIFRlYW0gewogICAgICAgIC8qKgogICAgICAgICAqIEdlbmVyYXRlcyBhbmQgYXBwbGllcyBzdGF0cyB0byBhIHBsYXllciBiYXNlZCBvbiByb2xlIGFuZCBsZXZlbC4KICAgICAgICAgKiBDZW50cmFsaXplcyBiYWxhbmNpbmcgdG8gZW5zdXJlIGhpZ2gtbGV2ZWwgcGxheSBmZWVscyBkaXN0aW5jdC4KICAgICAgICAgKi8KICAgICAgICBzdGF0aWMgZ2VuZXJhdGVTdGF0cyhwbGF5ZXIsIHJvbGUsIGxldmVsID0gMSwgaXNIdW1hbiA9IGZhbHNlKSB7CiAgICAgICAgICAgIC8vIDEuIERlZmluZSBSb2xlIEJhc2VsaW5lcyAoTGV2ZWwgMSkKICAgICAgICAgICAgLy8gQmFsYW5jZWQgdG8gYmUgd2VhayBidXQgZnVuY3Rpb25hbCBhdCBMZXZlbCAxCiAgICAgICAgICAgIGNvbnN0IGJhc2UgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLCBTUDogNTUsIEVOOiAxMCwgQVQ6IDUsIFBBOiA1LCBCTDogNSwgU0g6IDUsIENBOiA1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBSb2xlIFNwZWNpYWxpemF0aW9ucwogICAgICAgICAgICBzd2l0Y2gocm9sZSkgewogICAgICAgICAgICAgICAgY2FzZSAnTEYnOiBjYXNlICdSRic6IC8vIFN0cmlrZXJzCiAgICAgICAgICAgICAgICAgICAgYmFzZS5TSCArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLkVOICs9IDU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdNRic6IC8vIFBsYXltYWtlcnMKICAgICAgICAgICAgICAgICAgICBiYXNlLlBBICs9IDEwOyBiYXNlLkFUICs9IDg7IGJhc2UuRU4gKz0gODsgYmFzZS5TUCArPSAyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnTEQnOiBjYXNlICdSRCc6IC8vIERlZmVuZGVycwogICAgICAgICAgICAgICAgICAgIGJhc2UuQVQgKz0gMTI7IGJhc2UuQkwgKz0gMTA7IGJhc2UuUEEgKz0gNTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogLy8gR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFzZS5DQSArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLlBBICs9IDE1OyAvLyBTdHJvbmcgYXJtCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFNjYWxpbmcgRmFjdG9ycyAoUGVyIExldmVsKQogICAgICAgICAgICAvLyBEZXNpZ25lZCBzbyBMZXZlbCA1MCBpcyAiR29kIFRpZXIiIGFuZCBMZXZlbCAxIGlzICJSb29raWUiCiAgICAgICAgICAgIGNvbnN0IGdyb3d0aCA9IHsKICAgICAgICAgICAgICAgIEhQOiAxNSwgICAgLy8gKzE1MDAgSFAgYXQgTHZsIDk5CiAgICAgICAgICAgICAgICBTUDogMC41LCAgIC8vICs1MCBTUCBhdCBMdmwgOTkgKFNwZWVkIGRlbW9uKQogICAgICAgICAgICAgICAgUHJpbWFyeTogMC44LCAvLyArODAgU3RhdCBhdCBMdmwgOTkKICAgICAgICAgICAgICAgIFNlY29uZGFyeTogMC41IC8vICs1MCBTdGF0IGF0IEx2bCA5OQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIHNjYWxlCiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHZhbCwgcmF0ZSkgPT4gTWF0aC5mbG9vcih2YWwgKyAoKGxldmVsIC0gMSkgKiByYXRlKSk7CgogICAgICAgICAgICAvLyBBcHBseSBTY2FsaW5nCiAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCA9IHNjYWxlKGJhc2UuSFAsIGdyb3d0aC5IUCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTUDogQ2FwIGF0IDk5LCBidXQgZW5zdXJlIGhpZ2ggbGV2ZWxzIGZlZWwgRkFTVAogICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TUCwgZ3Jvd3RoLlNQKSk7CgogICAgICAgICAgICAvLyBTdGF0IGRpc3RyaWJ1dGlvbiBiYXNlZCBvbiByb2xlIHByaW9yaXRpZXMKICAgICAgICAgICAgaWYgKFsnTEYnLCAnUkYnXS5pbmNsdWRlcyhyb2xlKSkgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlNIID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuU0gsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5FTiwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguU2Vjb25kYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb2xlID09PSAnTUYnKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU0ggPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TSCwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChbJ0xEJywgJ1JEJ10uaW5jbHVkZXMocm9sZSkpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjIpKTsgLy8gRGVmZW5kZXJzIGJhZCBhdCBzaG9vdGluZwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGUgPT09ICdHTCcpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5DQSA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkNBLCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlBBID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuUEEsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjMpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSHVtYW4gUGxheWVyIEJvbnVzIChUaGUgIkhlcm8iIEZlZWwpCiAgICAgICAgICAgIC8vIEdpdmVzIHRoZSBwbGF5ZXIgYSBzbGlnaHQgZWRnZSB0byBtYWtlIGdhbWVwbGF5IGZlZWwgcHVuY2h5CiAgICAgICAgICAgIGlmIChpc0h1bWFuKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuSFAgKz0gMTUwOyAvLyBUYW5raWVyCiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgKz0gNTsgICAvLyBGYXN0ZXIKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5FTiArPSA1OyAgIC8vIEhhcmRlciB0byB0YWNrbGUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gS2V5IFN0YXQgQm9vc3QKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnTEYnIHx8IHJvbGUgPT09ICdSRicpIHBsYXllci5zdGF0cy5TSCArPSA1OwogICAgICAgICAgICAgICAgaWYgKHJvbGUgPT09ICdNRicpIHBsYXllci5zdGF0cy5QQSArPSA1OwogICAgICAgICAgICAgICAgaWYgKHJvbGUgPT09ICdMRCcgfHwgcm9sZSA9PT0gJ1JEJykgcGxheWVyLnN0YXRzLkFUICs9IDU7CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ0dMJykgcGxheWVyLnN0YXRzLkNBICs9IDU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIEZpbmFsaXplCiAgICAgICAgICAgIHBsYXllci5zdGF0cy5tYXhIUCA9IHBsYXllci5zdGF0cy5IUDsKICAgICAgICAgICAgcGxheWVyLmxldmVsID0gbGV2ZWw7CiAgICAgICAgICAgIHBsYXllci5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CiAgICAgICAgfQoKY29uc3RydWN0b3Ioc2NlbmUsIGlkLCBzaWRlLCBjb2xvciwgaXNIdW1hbikgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuaWQgPSBpZDsgLy8gJ2hvbWUnIG9yICdhd2F5JwogICAgICAgICAgICB0aGlzLnNpZGUgPSBzaWRlOyAvLyAxIChEZWZlbmRzICtaKSBvciAtMSAoRGVmZW5kcyAtWikKICAgICAgICAgICAgdGhpcy5jb2xvciA9IGNvbG9yOwogICAgICAgICAgICB0aGlzLmlzSHVtYW4gPSBpc0h1bWFuOwogICAgICAgICAgICB0aGlzLmFpRW5hYmxlZCA9IHRydWU7IC8vIE1hc3RlciBzd2l0Y2ggZm9yIEFJIGxvZ2ljCiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnBsYXllcnMgPSBbXTsKICAgICAgICAgICAgdGhpcy5hY3RpdmVQbGF5ZXIgPSBudWxsOyAvLyBUaGUgcGxheWVyIGN1cnJlbnRseSBjb250cm9sbGVkL2ZvY3VzZWQKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZvcm1hdGlvbiBBbmNob3JzCiAgICAgICAgICAgIHRoaXMuY3VycmVudEZvcm1hdGlvbiA9ICdOb3JtYWwnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUGxheWVyIEluZGljYXRvciAoR3JlZW4gQXJyb3cpCiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF9wbGF5ZXJBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cuc2NhbGUuc2V0KDAuOCwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJBcnJvdy5yZW5kZXJPcmRlciA9IDEwMDA7IC8vIE9uIHRvcAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBhc3NpZ25NYXJrcyhvcHBvc2luZ1RlYW0pIHsKICAgICAgICAgICAgLy8gU2ltcGxlIGF1dG8tYXNzaWduIGxvZ2ljOiBNYXJrIHRoZSBwbGF5ZXIgaW4gdGhlICJtYXRjaGluZyIgcG9zaXRpb24KICAgICAgICAgICAgLy8gTEY8LT5SRCwgUkY8LT5MRCwgTUY8LT5NRiwgTEQ8LT5SRiwgUkQ8LT5MRiwgR0w8LT5MRgogICAgICAgICAgICB0aGlzLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGxldCB0YXJnZXRSb2xlID0gJ01GJzsKICAgICAgICAgICAgICAgIHN3aXRjaCAocC5yb2xlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTEYnOiB0YXJnZXRSb2xlID0gJ1JEJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkYnOiB0YXJnZXRSb2xlID0gJ0xEJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTUYnOiB0YXJnZXRSb2xlID0gJ01GJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTEQnOiB0YXJnZXRSb2xlID0gJ1JGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkQnOiB0YXJnZXRSb2xlID0gJ0xGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnR0wnOiB0YXJnZXRSb2xlID0gJ0xGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gb3Bwb3NpbmdUZWFtLnBsYXllcnMuZmluZChvcCA9PiBvcC5yb2xlID09PSB0YXJnZXRSb2xlKTsKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICBwLm1hcmtpbmcgPSB0YXJnZXQ7CiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYCR7dGhpcy5pZH0gJHtwLnJvbGV9IG1hcmtlZCAke3RhcmdldC5yb2xlfWApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGFkZFBsYXllcihwbGF5ZXIpIHsKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLnB1c2gocGxheWVyKTsKICAgICAgICAgICAgcGxheWVyLnRlYW0gPSB0aGlzOwoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIEhvbWUgUG9zaXRpb24gYmFzZWQgb24gRm9ybWF0aW9uCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBsYXllckhvbWVQb3NpdGlvbihwbGF5ZXIpOwoKICAgICAgICAgICAgLy8gRW5lbXkgaW5kaWNhdG9yOiByZWQgYXJyb3dzIG92ZXIgdGhlIEF3YXkgdGVhbSAoc28gZW5lbWllcyBhcmUgcmVhZGFibGUpCi8vIEVuZW15IGluZGljYXRvcjogcmVkIGFycm93cyBvdmVyIHRoZSBBd2F5IHRlYW0KICAgICAgICAgICAgaWYgKHRoaXMuaWQgPT09ICdhd2F5JyAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF9lbmVteUFycm93TWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgYXJyb3cuc2NhbGUuc2V0KDAuOCwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgYXJyb3cucG9zaXRpb24uc2V0KDAsIDMuMiwgMCk7IC8vIGFib3ZlIGhlYWQKICAgICAgICAgICAgICAgIGFycm93LnJlbmRlck9yZGVyID0gOTk5OwogICAgICAgICAgICAgICAgcGxheWVyLm1lc2guYWRkKGFycm93KTsKICAgICAgICAgICAgICAgIHBsYXllci5lbmVteUFycm93ID0gYXJyb3c7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFRlYW1tYXRlIGluZGljYXRvcjogV2hpdGUgYXJyb3dzIGZvciBpbmFjdGl2ZSBodW1hbnMKICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbiAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF90ZWFtbWF0ZUFycm93TWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgYXJyb3cuc2NhbGUuc2V0KDAuNiwgMC42LCAxLjApOwogICAgICAgICAgICAgICAgYXJyb3cucG9zaXRpb24uc2V0KDAsIDMuMiwgMCk7CiAgICAgICAgICAgICAgICBhcnJvdy5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICAgICAgICAgIGFycm93LnZpc2libGUgPSBmYWxzZTsgLy8gSGlkZGVuIGJ5IGRlZmF1bHQsIG1hbmFnZWQgYnkgc2V0QWN0aXZlUGxheWVyCiAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5hZGQoYXJyb3cpOwogICAgICAgICAgICAgICAgcGxheWVyLnRlYW1tYXRlQXJyb3cgPSBhcnJvdzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2V0Rm9ybWF0aW9uKG5hbWUpIHsKICAgICAgICAgICAgaWYgKCFGT1JNQVRJT05TW25hbWVdKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuY3VycmVudEZvcm1hdGlvbiA9IG5hbWU7CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBUZWFtICR7dGhpcy5pZH0gc3dpdGNoZWQgdG8gJHtuYW1lfWApOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocGxheWVyKSB7CiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBGT1JNQVRJT05TW3RoaXMuY3VycmVudEZvcm1hdGlvbl07CiAgICAgICAgICAgIGlmICghZGF0YSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZGF0YVtwbGF5ZXIucm9sZV07CiAgICAgICAgICAgIGlmIChvZmZzZXQpIHsKICAgICAgICAgICAgICAgIC8vIFggUG9zaXRpb246CiAgICAgICAgICAgICAgICAvLyBGb3JtYXRpb25zOiAtWCBpcyBMZWZ0LCArWCBpcyBSaWdodC4KICAgICAgICAgICAgICAgIC8vIEhvbWUgVGVhbSAoU2lkZSAxKSBmYWNlcyAtWi4gTGVmdCBpcyAtWC4gVXNlIG9mZnNldC54IGFzIGlzLgogICAgICAgICAgICAgICAgbGV0IHhQb3MgPSBvZmZzZXQueDsKICAgICAgICAgICAgICAgIGxldCB6UG9zID0gb2Zmc2V0LnogKiB0aGlzLnNpZGU7CgogICAgICAgICAgICAgICAgcGxheWVyLmhvbWVQb3NpdGlvbi5zZXQoeFBvcywgMCwgelBvcyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEF3YXkgVGVhbSAoU2lkZSAtMSkgZmFjZXMgK1ouIExlZnQgaXMgK1guIEZsaXAgWC4KICAgICAgICAgICAgICAgIGlmICh0aGlzLnNpZGUgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgcGxheWVyLmhvbWVQb3NpdGlvbi54ICo9IC0xOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0IGluaXRpYWwgcG9zaXRpb24KICAgICAgICAgICAgaWYgKHBsYXllci5tZXNoKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5wb3NpdGlvbi5jb3B5KHBsYXllci5ob21lUG9zaXRpb24pOwogICAgICAgICAgICAgICAgLy8gRmFjZSBjZW50ZXIgKDAsMCwwKQogICAgICAgICAgICAgICAgcGxheWVyLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgLy8gVXBkYXRlIGFsbCBwbGF5ZXJzCiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXllcnNbaV0udXBkYXRlKGR0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXV0by1zd2l0Y2ggYWN0aXZlIHBsYXllciBpZiBIdW1hbgogICAgICAgICAgICBpZiAodGhpcy5pc0h1bWFuKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUFjdGl2ZVBsYXllclNlbGVjdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVBY3RpdmVQbGF5ZXJTZWxlY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKCFiYWxsKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBPRkZFTlNFOiBJZiB3ZSBoYXZlIHRoZSBiYWxsLCBhY3RpdmUgcGxheWVyIGlzIHRoZSBob2xkZXIKICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVBsYXllciAhPT0gYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihiYWxsLmhvbGRlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIERFRkVOU0U6IFNlbGVjdCBjbG9zZXN0IHRvIGJhbGwKICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBPbmx5IGNoZWNrIGV2ZXJ5IGZldyBmcmFtZXMgb3IgaWYgZGlzdGFuY2UgaXMgc2lnbmlmaWNhbnQKICAgICAgICAgICAgbGV0IGNsb3Nlc3QgPSBudWxsOwogICAgICAgICAgICBsZXQgbWluRHN0ID0gSW5maW5pdHk7CgogICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocC5yb2xlID09PSAnR0wnKSBjb250aW51ZTsgLy8gRG9uJ3QgYXV0by1zd2l0Y2ggdG8gZ29hbGllIHVzdWFsbHkKICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICBjb25zdCBkID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkIDwgbWluRHN0KSB7CiAgICAgICAgICAgICAgICAgICAgbWluRHN0ID0gZDsKICAgICAgICAgICAgICAgICAgICBjbG9zZXN0ID0gcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNsb3Nlc3QgJiYgY2xvc2VzdCAhPT0gdGhpcy5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0QWN0aXZlUGxheWVyKGNsb3Nlc3QpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKc2V0QWN0aXZlUGxheWVyKHBsYXllcikgewogICAgICAgICAgICAvLyBSZXNldCBpbnB1dCBvbiBwcmV2aW91cwogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlUGxheWVyLnNldElucHV0KDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYWN0aXZlUGxheWVyID0gcGxheWVyOwoKICAgICAgICAgICAgLy8gVmlzdWFsIEluZGljYXRvcnMKICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbikgewogICAgICAgICAgICAgICAgLy8gMS4gR3JlZW4gQXJyb3cgZm9yIEFjdGl2ZQogICAgICAgICAgICAgICAgaWYgKHRoaXMucGxheWVyQXJyb3cgJiYgcGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5hZGQodGhpcy5wbGF5ZXJBcnJvdyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJBcnJvdy5wb3NpdGlvbi5zZXQoMCwgMy41LCAwKTsgLy8gRmxvYXQgYWJvdmUgaGVhZAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDIuIFdoaXRlIEFycm93cyBmb3IgT3RoZXJzCiAgICAgICAgICAgICAgICB0aGlzLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAocC50ZWFtbWF0ZUFycm93KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAudGVhbW1hdGVBcnJvdy52aXNpYmxlID0gKHAgIT09IHBsYXllcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpyZXNldFBvc2l0aW9ucygpIHsKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHRoaXMucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5jb3B5KHAuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBQaHlzaWNzCiAgICAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgcC5pbnB1dFZlY3Rvci5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgcC5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBwLmlzVGhyb3dpbmcgPSBmYWxzZTsKcC5sb3NlQmFsbCgpOyAvLyBEcm9wIGJhbGwgaWYgaG9sZGluZwogICAgICAgICAgICAgICAgICAgIHAuY2FuQ2F0Y2ggPSB0cnVlOyAvLyBGb3JjZSByZXNldCBjYXBhYmlsaXR5CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgU3RhdHMKICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgICAgICAgICAgCi8vIE9yaWVudGF0aW9uOiBGYWNlIENlbnRlcgogICAgICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuc3luY1JvdGF0aW9uKSBwLnN5bmNSb3RhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IEFuaW1hdGlvbgogICAgICAgICAgICAgICAgICAgIHAucGxheSgnaWRsZScsIDAuMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUmVzZXQgYWN0aXZlIHBsYXllciB0byBNRgogICAgICAgICAgICBjb25zdCBtZiA9IHRoaXMucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgaWYgKG1mKSB0aGlzLnNldEFjdGl2ZVBsYXllcihtZik7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LlRlYW0gPSBUZWFtOwp9KSgpOw==","./Team.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIEZvcm1hdGlvbiBEZWZpbml0aW9ucyAoQ29vcmRpbmF0ZXMgZm9yIFNpZGUgMTogRGVmZW5kcyArWiwgQXR0YWNrcyAtWikKICAgIC8vIFg6IExlZnQoLSkvUmlnaHQoKyksIFo6IEZvcndhcmQoLSkvQmFjaygrKQogICAgY29uc3QgRk9STUFUSU9OUyA9IHsKICAgICAgICAnTm9ybWFsJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiA1IH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTEwLCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxMCwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdDZW50ZXIgQXR0YWNrJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAwIH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTQsIHo6IC0xNSB9LCAnUkYnOiB7IHg6IDQsIHo6IC0xNSB9CiAgICAgICAgfSwKICAgICAgICAnUmlnaHQgU2lkZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IDAsIHo6IDE1IH0sICdSRCc6IHsgeDogMTIsIHo6IDE1IH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiA1LCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxNSwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdMZWZ0IFNpZGUnOiB7CiAgICAgICAgICAgICdHTCc6IHsgeDogMCwgejogMjUgfSwKICAgICAgICAgICAgJ0xEJzogeyB4OiAtMTIsIHo6IDE1IH0sICdSRCc6IHsgeDogMCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAtMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTUsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IC01LCB6OiAtMTAgfQogICAgICAgIH0sCiAgICAgICAgJ0FsbC1PdXQgRGVmZW5zZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IC02LCB6OiAyMCB9LCAnUkQnOiB7IHg6IDYsIHo6IDIwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMTAgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTAsIHo6IDUgfSwgJ1JGJzogeyB4OiAxMCwgejogNSB9CiAgICAgICAgfSwKICAgICAgICAnRmxhdCBMaW5lJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDAgfSwgJ1JEJzogeyB4OiA4LCB6OiAwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMCB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xNSwgejogMCB9LCAnUkYnOiB7IHg6IDE1LCB6OiAwIH0KICAgICAgICB9LAogICAgICAgICdDb3VudGVyJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDIwIH0sICdSRCc6IHsgeDogOCwgejogMjAgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAxNSB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xMiwgejogLTIwIH0sICdSRic6IHsgeDogMTIsIHo6IC0yMCB9CiAgICAgICAgfSwKICAgICAgICAnRG91YmxlIFNpZGVzJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTE4LCB6OiAxNSB9LCAnUkQnOiB7IHg6IDE4LCB6OiAxNSB9LAogICAgICAgICAgICAnTUYnOiB7IHg6IDAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTgsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IDE4LCB6OiAtMTAgfQogICAgICAgIH0KICAgIH07CgoKCiAgICAvLyAtLS0gRW5lbXkgSW5kaWNhdG9yIChSZWQgQXJyb3cgU3ByaXRlKSAtLS0KICAgIC8vIFNoYXJlZCB0ZXh0dXJlL21hdGVyaWFsIHNvIHdlIGRvbid0IGNyZWF0ZSA2IGNhbnZhc2VzLgpjb25zdCBfZW5lbXlBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7CiAgICAgICAgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBjLndpZHRoLCBjLmhlaWdodCk7CiAgICAgICAgCiAgICAgICAgLy8gQXJyb3cgcG9pbnRpbmcgRE9XTgogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDYsIDEyKTsgICAKICAgICAgICBjdHgubGluZVRvKDU4LCAxMik7ICAKICAgICAgICBjdHgubGluZVRvKDMyLCA1Mik7ICAKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmYwMDAwJzsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpJzsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCmNvbnN0IF9wbGF5ZXJBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgYy53aWR0aCwgYy5oZWlnaHQpOwogICAgICAgIAogICAgICAgIC8vIEFycm93IHBvaW50aW5nIERPV04KICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyg2LCAxMik7ICAgCiAgICAgICAgY3R4LmxpbmVUbyg1OCwgMTIpOyAgCiAgICAgICAgY3R4LmxpbmVUbygzMiwgNTIpOyAgCiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwZmYwMCc7IC8vIEdyZWVuCiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsMjU1LDI1NSwwLjk1KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGMud2lkdGgsIGMuaGVpZ2h0KTsKICAgICAgICAKICAgICAgICAvLyBBcnJvdyBwb2ludGluZyBET1dOCiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oNiwgMTIpOyAgIAogICAgICAgIGN0eC5saW5lVG8oNTgsIDEyKTsgIAogICAgICAgIGN0eC5saW5lVG8oMzIsIDUyKTsgIAogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOyAvLyBXaGl0ZQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX2VuZW15QXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2VuZW15QXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CiAgICBjb25zdCBfcGxheWVyQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3BsYXllckFycm93VGV4dHVyZSwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoVGVzdDogZmFsc2UsIGRlcHRoV3JpdGU6IGZhbHNlIH0pOwogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3RlYW1tYXRlQXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CmNsYXNzIFRlYW0gewogICAgICAgIC8qKgogICAgICAgICAqIEdlbmVyYXRlcyBhbmQgYXBwbGllcyBzdGF0cyB0byBhIHBsYXllciBiYXNlZCBvbiByb2xlIGFuZCBsZXZlbC4KICAgICAgICAgKiBDZW50cmFsaXplcyBiYWxhbmNpbmcgdG8gZW5zdXJlIGhpZ2gtbGV2ZWwgcGxheSBmZWVscyBkaXN0aW5jdC4KICAgICAgICAgKi8KICAgICAgICBzdGF0aWMgZ2VuZXJhdGVTdGF0cyhwbGF5ZXIsIHJvbGUsIGxldmVsID0gMSwgaXNIdW1hbiA9IGZhbHNlKSB7CiAgICAgICAgICAgIC8vIDEuIERlZmluZSBSb2xlIEJhc2VsaW5lcyAoTGV2ZWwgMSkKICAgICAgICAgICAgLy8gQmFsYW5jZWQgdG8gYmUgd2VhayBidXQgZnVuY3Rpb25hbCBhdCBMZXZlbCAxCiAgICAgICAgICAgIGNvbnN0IGJhc2UgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLCBTUDogNTUsIEVOOiAxMCwgQVQ6IDUsIFBBOiA1LCBCTDogNSwgU0g6IDUsIENBOiA1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBSb2xlIFNwZWNpYWxpemF0aW9ucwogICAgICAgICAgICBzd2l0Y2gocm9sZSkgewogICAgICAgICAgICAgICAgY2FzZSAnTEYnOiBjYXNlICdSRic6IC8vIFN0cmlrZXJzCiAgICAgICAgICAgICAgICAgICAgYmFzZS5TSCArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLkVOICs9IDU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdNRic6IC8vIFBsYXltYWtlcnMKICAgICAgICAgICAgICAgICAgICBiYXNlLlBBICs9IDEwOyBiYXNlLkFUICs9IDg7IGJhc2UuRU4gKz0gODsgYmFzZS5TUCArPSAyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnTEQnOiBjYXNlICdSRCc6IC8vIERlZmVuZGVycwogICAgICAgICAgICAgICAgICAgIGJhc2UuQVQgKz0gMTI7IGJhc2UuQkwgKz0gMTA7IGJhc2UuUEEgKz0gNTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogLy8gR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFzZS5DQSArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLlBBICs9IDE1OyAvLyBTdHJvbmcgYXJtCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFNjYWxpbmcgRmFjdG9ycyAoUGVyIExldmVsKQogICAgICAgICAgICAvLyBEZXNpZ25lZCBzbyBMZXZlbCA1MCBpcyAiR29kIFRpZXIiIGFuZCBMZXZlbCAxIGlzICJSb29raWUiCiAgICAgICAgICAgIGNvbnN0IGdyb3d0aCA9IHsKICAgICAgICAgICAgICAgIEhQOiAxNSwgICAgLy8gKzE1MDAgSFAgYXQgTHZsIDk5CiAgICAgICAgICAgICAgICBTUDogMC41LCAgIC8vICs1MCBTUCBhdCBMdmwgOTkgKFNwZWVkIGRlbW9uKQogICAgICAgICAgICAgICAgUHJpbWFyeTogMC44LCAvLyArODAgU3RhdCBhdCBMdmwgOTkKICAgICAgICAgICAgICAgIFNlY29uZGFyeTogMC41IC8vICs1MCBTdGF0IGF0IEx2bCA5OQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIHNjYWxlCiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHZhbCwgcmF0ZSkgPT4gTWF0aC5mbG9vcih2YWwgKyAoKGxldmVsIC0gMSkgKiByYXRlKSk7CgogICAgICAgICAgICAvLyBBcHBseSBTY2FsaW5nCiAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCA9IHNjYWxlKGJhc2UuSFAsIGdyb3d0aC5IUCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTUDogQ2FwIGF0IDk5LCBidXQgZW5zdXJlIGhpZ2ggbGV2ZWxzIGZlZWwgRkFTVAogICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TUCwgZ3Jvd3RoLlNQKSk7CgogICAgICAgICAgICAvLyBTdGF0IGRpc3RyaWJ1dGlvbiBiYXNlZCBvbiByb2xlIHByaW9yaXRpZXMKICAgICAgICAgICAgaWYgKFsnTEYnLCAnUkYnXS5pbmNsdWRlcyhyb2xlKSkgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlNIID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuU0gsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5FTiwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguU2Vjb25kYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb2xlID09PSAnTUYnKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU0ggPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TSCwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChbJ0xEJywgJ1JEJ10uaW5jbHVkZXMocm9sZSkpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjIpKTsgLy8gRGVmZW5kZXJzIGJhZCBhdCBzaG9vdGluZwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGUgPT09ICdHTCcpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5DQSA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkNBLCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlBBID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuUEEsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjMpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSHVtYW4gUGxheWVyIEJvbnVzIChUaGUgIkhlcm8iIEZlZWwpCiAgICAgICAgICAgIC8vIEdpdmVzIHRoZSBwbGF5ZXIgYSBzbGlnaHQgZWRnZSB0byBtYWtlIGdhbWVwbGF5IGZlZWwgcHVuY2h5CiAgICAgICAgICAgIGlmIChpc0h1bWFuKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuSFAgKz0gMTUwOyAvLyBUYW5raWVyCiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgKz0gNTsgICAvLyBGYXN0ZXIKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5FTiArPSA1OyAgIC8vIEhhcmRlciB0byB0YWNrbGUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gS2V5IFN0YXQgQm9vc3QKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnTEYnIHx8IHJvbGUgPT09ICdSRicpIHBsYXllci5zdGF0cy5TSCArPSA1OwogICAgICAgICAgICAgICAgaWYgKHJvbGUgPT09ICdNRicpIHBsYXllci5zdGF0cy5QQSArPSA1OwogICAgICAgICAgICAgICAgaWYgKHJvbGUgPT09ICdMRCcgfHwgcm9sZSA9PT0gJ1JEJykgcGxheWVyLnN0YXRzLkFUICs9IDU7CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ0dMJykgcGxheWVyLnN0YXRzLkNBICs9IDU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIEZpbmFsaXplCiAgICAgICAgICAgIHBsYXllci5zdGF0cy5tYXhIUCA9IHBsYXllci5zdGF0cy5IUDsKICAgICAgICAgICAgcGxheWVyLmxldmVsID0gbGV2ZWw7CiAgICAgICAgICAgIHBsYXllci5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CiAgICAgICAgfQoKY29uc3RydWN0b3Ioc2NlbmUsIGlkLCBzaWRlLCBjb2xvciwgaXNIdW1hbikgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuaWQgPSBpZDsgLy8gJ2hvbWUnIG9yICdhd2F5JwogICAgICAgICAgICB0aGlzLnNpZGUgPSBzaWRlOyAvLyAxIChEZWZlbmRzICtaKSBvciAtMSAoRGVmZW5kcyAtWikKICAgICAgICAgICAgdGhpcy5jb2xvciA9IGNvbG9yOwogICAgICAgICAgICB0aGlzLmlzSHVtYW4gPSBpc0h1bWFuOwogICAgICAgICAgICB0aGlzLmFpRW5hYmxlZCA9IHRydWU7IC8vIE1hc3RlciBzd2l0Y2ggZm9yIEFJIGxvZ2ljCiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnBsYXllcnMgPSBbXTsKICAgICAgICAgICAgdGhpcy5hY3RpdmVQbGF5ZXIgPSBudWxsOyAvLyBUaGUgcGxheWVyIGN1cnJlbnRseSBjb250cm9sbGVkL2ZvY3VzZWQKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZvcm1hdGlvbiBBbmNob3JzCiAgICAgICAgICAgIHRoaXMuY3VycmVudEZvcm1hdGlvbiA9ICdOb3JtYWwnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUGxheWVyIEluZGljYXRvciAoR3JlZW4gQXJyb3cpCiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF9wbGF5ZXJBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cuc2NhbGUuc2V0KDAuOCwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJBcnJvdy5yZW5kZXJPcmRlciA9IDEwMDA7IC8vIE9uIHRvcAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBhc3NpZ25NYXJrcyhvcHBvc2luZ1RlYW0pIHsKICAgICAgICAgICAgLy8gU2ltcGxlIGF1dG8tYXNzaWduIGxvZ2ljOiBNYXJrIHRoZSBwbGF5ZXIgaW4gdGhlICJtYXRjaGluZyIgcG9zaXRpb24KICAgICAgICAgICAgLy8gTEY8LT5SRCwgUkY8LT5MRCwgTUY8LT5NRiwgTEQ8LT5SRiwgUkQ8LT5MRiwgR0w8LT5MRgogICAgICAgICAgICB0aGlzLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGxldCB0YXJnZXRSb2xlID0gJ01GJzsKICAgICAgICAgICAgICAgIHN3aXRjaCAocC5yb2xlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTEYnOiB0YXJnZXRSb2xlID0gJ1JEJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkYnOiB0YXJnZXRSb2xlID0gJ0xEJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTUYnOiB0YXJnZXRSb2xlID0gJ01GJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTEQnOiB0YXJnZXRSb2xlID0gJ1JGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkQnOiB0YXJnZXRSb2xlID0gJ0xGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnR0wnOiB0YXJnZXRSb2xlID0gJ0xGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gb3Bwb3NpbmdUZWFtLnBsYXllcnMuZmluZChvcCA9PiBvcC5yb2xlID09PSB0YXJnZXRSb2xlKTsKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICBwLm1hcmtpbmcgPSB0YXJnZXQ7CiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYCR7dGhpcy5pZH0gJHtwLnJvbGV9IG1hcmtlZCAke3RhcmdldC5yb2xlfWApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGFkZFBsYXllcihwbGF5ZXIpIHsKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLnB1c2gocGxheWVyKTsKICAgICAgICAgICAgcGxheWVyLnRlYW0gPSB0aGlzOwoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIEhvbWUgUG9zaXRpb24gYmFzZWQgb24gRm9ybWF0aW9uCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBsYXllckhvbWVQb3NpdGlvbihwbGF5ZXIpOwoKICAgICAgICAgICAgLy8gRW5lbXkgaW5kaWNhdG9yOiByZWQgYXJyb3dzIG92ZXIgdGhlIEF3YXkgdGVhbSAoc28gZW5lbWllcyBhcmUgcmVhZGFibGUpCi8vIEVuZW15IGluZGljYXRvcjogcmVkIGFycm93cyBvdmVyIHRoZSBBd2F5IHRlYW0KICAgICAgICAgICAgaWYgKHRoaXMuaWQgPT09ICdhd2F5JyAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF9lbmVteUFycm93TWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgYXJyb3cuc2NhbGUuc2V0KDAuOCwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgYXJyb3cucG9zaXRpb24uc2V0KDAsIDMuMiwgMCk7IC8vIGFib3ZlIGhlYWQKICAgICAgICAgICAgICAgIGFycm93LnJlbmRlck9yZGVyID0gOTk5OwogICAgICAgICAgICAgICAgcGxheWVyLm1lc2guYWRkKGFycm93KTsKICAgICAgICAgICAgICAgIHBsYXllci5lbmVteUFycm93ID0gYXJyb3c7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFRlYW1tYXRlIGluZGljYXRvcjogV2hpdGUgYXJyb3dzIGZvciBpbmFjdGl2ZSBodW1hbnMKICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbiAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF90ZWFtbWF0ZUFycm93TWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgYXJyb3cuc2NhbGUuc2V0KDAuNiwgMC42LCAxLjApOwogICAgICAgICAgICAgICAgYXJyb3cucG9zaXRpb24uc2V0KDAsIDMuMiwgMCk7CiAgICAgICAgICAgICAgICBhcnJvdy5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICAgICAgICAgIGFycm93LnZpc2libGUgPSBmYWxzZTsgLy8gSGlkZGVuIGJ5IGRlZmF1bHQsIG1hbmFnZWQgYnkgc2V0QWN0aXZlUGxheWVyCiAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5hZGQoYXJyb3cpOwogICAgICAgICAgICAgICAgcGxheWVyLnRlYW1tYXRlQXJyb3cgPSBhcnJvdzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2V0Rm9ybWF0aW9uKG5hbWUpIHsKICAgICAgICAgICAgaWYgKCFGT1JNQVRJT05TW25hbWVdKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuY3VycmVudEZvcm1hdGlvbiA9IG5hbWU7CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBUZWFtICR7dGhpcy5pZH0gc3dpdGNoZWQgdG8gJHtuYW1lfWApOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocGxheWVyKSB7CiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBGT1JNQVRJT05TW3RoaXMuY3VycmVudEZvcm1hdGlvbl07CiAgICAgICAgICAgIGlmICghZGF0YSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZGF0YVtwbGF5ZXIucm9sZV07CiAgICAgICAgICAgIGlmIChvZmZzZXQpIHsKICAgICAgICAgICAgICAgIC8vIFggUG9zaXRpb246CiAgICAgICAgICAgICAgICAvLyBGb3JtYXRpb25zOiAtWCBpcyBMZWZ0LCArWCBpcyBSaWdodC4KICAgICAgICAgICAgICAgIC8vIEhvbWUgVGVhbSAoU2lkZSAxKSBmYWNlcyAtWi4gTGVmdCBpcyAtWC4gVXNlIG9mZnNldC54IGFzIGlzLgogICAgICAgICAgICAgICAgbGV0IHhQb3MgPSBvZmZzZXQueDsKICAgICAgICAgICAgICAgIGxldCB6UG9zID0gb2Zmc2V0LnogKiB0aGlzLnNpZGU7CgogICAgICAgICAgICAgICAgcGxheWVyLmhvbWVQb3NpdGlvbi5zZXQoeFBvcywgMCwgelBvcyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEF3YXkgVGVhbSAoU2lkZSAtMSkgZmFjZXMgK1ouIExlZnQgaXMgK1guIEZsaXAgWC4KICAgICAgICAgICAgICAgIGlmICh0aGlzLnNpZGUgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgcGxheWVyLmhvbWVQb3NpdGlvbi54ICo9IC0xOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0IGluaXRpYWwgcG9zaXRpb24KICAgICAgICAgICAgaWYgKHBsYXllci5tZXNoKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5wb3NpdGlvbi5jb3B5KHBsYXllci5ob21lUG9zaXRpb24pOwogICAgICAgICAgICAgICAgLy8gRmFjZSBjZW50ZXIgKDAsMCwwKQogICAgICAgICAgICAgICAgcGxheWVyLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgLy8gVXBkYXRlIGFsbCBwbGF5ZXJzCiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXllcnNbaV0udXBkYXRlKGR0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXV0by1zd2l0Y2ggYWN0aXZlIHBsYXllciBpZiBIdW1hbgogICAgICAgICAgICBpZiAodGhpcy5pc0h1bWFuKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUFjdGl2ZVBsYXllclNlbGVjdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVBY3RpdmVQbGF5ZXJTZWxlY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKCFiYWxsKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBPRkZFTlNFOiBJZiB3ZSBoYXZlIHRoZSBiYWxsLCBhY3RpdmUgcGxheWVyIGlzIHRoZSBob2xkZXIKICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVBsYXllciAhPT0gYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihiYWxsLmhvbGRlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIERFRkVOU0U6IFNlbGVjdCBjbG9zZXN0IHRvIGJhbGwKICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBPbmx5IGNoZWNrIGV2ZXJ5IGZldyBmcmFtZXMgb3IgaWYgZGlzdGFuY2UgaXMgc2lnbmlmaWNhbnQKICAgICAgICAgICAgbGV0IGNsb3Nlc3QgPSBudWxsOwogICAgICAgICAgICBsZXQgbWluRHN0ID0gSW5maW5pdHk7CgogICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocC5yb2xlID09PSAnR0wnKSBjb250aW51ZTsgLy8gRG9uJ3QgYXV0by1zd2l0Y2ggdG8gZ29hbGllIHVzdWFsbHkKICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICBjb25zdCBkID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkIDwgbWluRHN0KSB7CiAgICAgICAgICAgICAgICAgICAgbWluRHN0ID0gZDsKICAgICAgICAgICAgICAgICAgICBjbG9zZXN0ID0gcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNsb3Nlc3QgJiYgY2xvc2VzdCAhPT0gdGhpcy5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0QWN0aXZlUGxheWVyKGNsb3Nlc3QpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKc2V0QWN0aXZlUGxheWVyKHBsYXllcikgewogICAgICAgICAgICAvLyBSZXNldCBpbnB1dCBvbiBwcmV2aW91cwogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlUGxheWVyLnNldElucHV0KDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYWN0aXZlUGxheWVyID0gcGxheWVyOwoKICAgICAgICAgICAgLy8gVmlzdWFsIEluZGljYXRvcnMKICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbikgewogICAgICAgICAgICAgICAgLy8gMS4gR3JlZW4gQXJyb3cgZm9yIEFjdGl2ZQogICAgICAgICAgICAgICAgaWYgKHRoaXMucGxheWVyQXJyb3cgJiYgcGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5hZGQodGhpcy5wbGF5ZXJBcnJvdyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJBcnJvdy5wb3NpdGlvbi5zZXQoMCwgMy41LCAwKTsgLy8gRmxvYXQgYWJvdmUgaGVhZAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDIuIFdoaXRlIEFycm93cyBmb3IgT3RoZXJzCiAgICAgICAgICAgICAgICB0aGlzLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAocC50ZWFtbWF0ZUFycm93KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAudGVhbW1hdGVBcnJvdy52aXNpYmxlID0gKHAgIT09IHBsYXllcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpyZXNldFBvc2l0aW9ucygpIHsKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHRoaXMucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5jb3B5KHAuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBQaHlzaWNzCiAgICAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgcC5pbnB1dFZlY3Rvci5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgcC5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBwLmlzVGhyb3dpbmcgPSBmYWxzZTsKcC5sb3NlQmFsbCgpOyAvLyBEcm9wIGJhbGwgaWYgaG9sZGluZwogICAgICAgICAgICAgICAgICAgIHAuY2FuQ2F0Y2ggPSB0cnVlOyAvLyBGb3JjZSByZXNldCBjYXBhYmlsaXR5CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgU3RhdHMKICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgICAgICAgICAgCi8vIE9yaWVudGF0aW9uOiBGYWNlIENlbnRlcgogICAgICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuc3luY1JvdGF0aW9uKSBwLnN5bmNSb3RhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IEFuaW1hdGlvbgogICAgICAgICAgICAgICAgICAgIHAucGxheSgnaWRsZScsIDAuMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUmVzZXQgYWN0aXZlIHBsYXllciB0byBNRgogICAgICAgICAgICBjb25zdCBtZiA9IHRoaXMucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgaWYgKG1mKSB0aGlzLnNldEFjdGl2ZVBsYXllcihtZik7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LlRlYW0gPSBUZWFtOwp9KSgpOw==","/Team.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIEZvcm1hdGlvbiBEZWZpbml0aW9ucyAoQ29vcmRpbmF0ZXMgZm9yIFNpZGUgMTogRGVmZW5kcyArWiwgQXR0YWNrcyAtWikKICAgIC8vIFg6IExlZnQoLSkvUmlnaHQoKyksIFo6IEZvcndhcmQoLSkvQmFjaygrKQogICAgY29uc3QgRk9STUFUSU9OUyA9IHsKICAgICAgICAnTm9ybWFsJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiA1IH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTEwLCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxMCwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdDZW50ZXIgQXR0YWNrJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAwIH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTQsIHo6IC0xNSB9LCAnUkYnOiB7IHg6IDQsIHo6IC0xNSB9CiAgICAgICAgfSwKICAgICAgICAnUmlnaHQgU2lkZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IDAsIHo6IDE1IH0sICdSRCc6IHsgeDogMTIsIHo6IDE1IH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiA1LCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxNSwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdMZWZ0IFNpZGUnOiB7CiAgICAgICAgICAgICdHTCc6IHsgeDogMCwgejogMjUgfSwKICAgICAgICAgICAgJ0xEJzogeyB4OiAtMTIsIHo6IDE1IH0sICdSRCc6IHsgeDogMCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAtMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTUsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IC01LCB6OiAtMTAgfQogICAgICAgIH0sCiAgICAgICAgJ0FsbC1PdXQgRGVmZW5zZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IC02LCB6OiAyMCB9LCAnUkQnOiB7IHg6IDYsIHo6IDIwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMTAgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTAsIHo6IDUgfSwgJ1JGJzogeyB4OiAxMCwgejogNSB9CiAgICAgICAgfSwKICAgICAgICAnRmxhdCBMaW5lJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDAgfSwgJ1JEJzogeyB4OiA4LCB6OiAwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMCB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xNSwgejogMCB9LCAnUkYnOiB7IHg6IDE1LCB6OiAwIH0KICAgICAgICB9LAogICAgICAgICdDb3VudGVyJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDIwIH0sICdSRCc6IHsgeDogOCwgejogMjAgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAxNSB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xMiwgejogLTIwIH0sICdSRic6IHsgeDogMTIsIHo6IC0yMCB9CiAgICAgICAgfSwKICAgICAgICAnRG91YmxlIFNpZGVzJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTE4LCB6OiAxNSB9LCAnUkQnOiB7IHg6IDE4LCB6OiAxNSB9LAogICAgICAgICAgICAnTUYnOiB7IHg6IDAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTgsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IDE4LCB6OiAtMTAgfQogICAgICAgIH0KICAgIH07CgoKCiAgICAvLyAtLS0gRW5lbXkgSW5kaWNhdG9yIChSZWQgQXJyb3cgU3ByaXRlKSAtLS0KICAgIC8vIFNoYXJlZCB0ZXh0dXJlL21hdGVyaWFsIHNvIHdlIGRvbid0IGNyZWF0ZSA2IGNhbnZhc2VzLgpjb25zdCBfZW5lbXlBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7CiAgICAgICAgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBjLndpZHRoLCBjLmhlaWdodCk7CiAgICAgICAgCiAgICAgICAgLy8gQXJyb3cgcG9pbnRpbmcgRE9XTgogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDYsIDEyKTsgICAKICAgICAgICBjdHgubGluZVRvKDU4LCAxMik7ICAKICAgICAgICBjdHgubGluZVRvKDMyLCA1Mik7ICAKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmYwMDAwJzsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpJzsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCmNvbnN0IF9wbGF5ZXJBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgYy53aWR0aCwgYy5oZWlnaHQpOwogICAgICAgIAogICAgICAgIC8vIEFycm93IHBvaW50aW5nIERPV04KICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyg2LCAxMik7ICAgCiAgICAgICAgY3R4LmxpbmVUbyg1OCwgMTIpOyAgCiAgICAgICAgY3R4LmxpbmVUbygzMiwgNTIpOyAgCiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwZmYwMCc7IC8vIEdyZWVuCiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsMjU1LDI1NSwwLjk1KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGMud2lkdGgsIGMuaGVpZ2h0KTsKICAgICAgICAKICAgICAgICAvLyBBcnJvdyBwb2ludGluZyBET1dOCiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oNiwgMTIpOyAgIAogICAgICAgIGN0eC5saW5lVG8oNTgsIDEyKTsgIAogICAgICAgIGN0eC5saW5lVG8oMzIsIDUyKTsgIAogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOyAvLyBXaGl0ZQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX2VuZW15QXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2VuZW15QXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CiAgICBjb25zdCBfcGxheWVyQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3BsYXllckFycm93VGV4dHVyZSwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoVGVzdDogZmFsc2UsIGRlcHRoV3JpdGU6IGZhbHNlIH0pOwogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3RlYW1tYXRlQXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CmNsYXNzIFRlYW0gewogICAgICAgIC8qKgogICAgICAgICAqIEdlbmVyYXRlcyBhbmQgYXBwbGllcyBzdGF0cyB0byBhIHBsYXllciBiYXNlZCBvbiByb2xlIGFuZCBsZXZlbC4KICAgICAgICAgKiBDZW50cmFsaXplcyBiYWxhbmNpbmcgdG8gZW5zdXJlIGhpZ2gtbGV2ZWwgcGxheSBmZWVscyBkaXN0aW5jdC4KICAgICAgICAgKi8KICAgICAgICBzdGF0aWMgZ2VuZXJhdGVTdGF0cyhwbGF5ZXIsIHJvbGUsIGxldmVsID0gMSwgaXNIdW1hbiA9IGZhbHNlKSB7CiAgICAgICAgICAgIC8vIDEuIERlZmluZSBSb2xlIEJhc2VsaW5lcyAoTGV2ZWwgMSkKICAgICAgICAgICAgLy8gQmFsYW5jZWQgdG8gYmUgd2VhayBidXQgZnVuY3Rpb25hbCBhdCBMZXZlbCAxCiAgICAgICAgICAgIGNvbnN0IGJhc2UgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLCBTUDogNTUsIEVOOiAxMCwgQVQ6IDUsIFBBOiA1LCBCTDogNSwgU0g6IDUsIENBOiA1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBSb2xlIFNwZWNpYWxpemF0aW9ucwogICAgICAgICAgICBzd2l0Y2gocm9sZSkgewogICAgICAgICAgICAgICAgY2FzZSAnTEYnOiBjYXNlICdSRic6IC8vIFN0cmlrZXJzCiAgICAgICAgICAgICAgICAgICAgYmFzZS5TSCArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLkVOICs9IDU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdNRic6IC8vIFBsYXltYWtlcnMKICAgICAgICAgICAgICAgICAgICBiYXNlLlBBICs9IDEwOyBiYXNlLkFUICs9IDg7IGJhc2UuRU4gKz0gODsgYmFzZS5TUCArPSAyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnTEQnOiBjYXNlICdSRCc6IC8vIERlZmVuZGVycwogICAgICAgICAgICAgICAgICAgIGJhc2UuQVQgKz0gMTI7IGJhc2UuQkwgKz0gMTA7IGJhc2UuUEEgKz0gNTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogLy8gR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFzZS5DQSArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLlBBICs9IDE1OyAvLyBTdHJvbmcgYXJtCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFNjYWxpbmcgRmFjdG9ycyAoUGVyIExldmVsKQogICAgICAgICAgICAvLyBEZXNpZ25lZCBzbyBMZXZlbCA1MCBpcyAiR29kIFRpZXIiIGFuZCBMZXZlbCAxIGlzICJSb29raWUiCiAgICAgICAgICAgIGNvbnN0IGdyb3d0aCA9IHsKICAgICAgICAgICAgICAgIEhQOiAxNSwgICAgLy8gKzE1MDAgSFAgYXQgTHZsIDk5CiAgICAgICAgICAgICAgICBTUDogMC41LCAgIC8vICs1MCBTUCBhdCBMdmwgOTkgKFNwZWVkIGRlbW9uKQogICAgICAgICAgICAgICAgUHJpbWFyeTogMC44LCAvLyArODAgU3RhdCBhdCBMdmwgOTkKICAgICAgICAgICAgICAgIFNlY29uZGFyeTogMC41IC8vICs1MCBTdGF0IGF0IEx2bCA5OQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIHNjYWxlCiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHZhbCwgcmF0ZSkgPT4gTWF0aC5mbG9vcih2YWwgKyAoKGxldmVsIC0gMSkgKiByYXRlKSk7CgogICAgICAgICAgICAvLyBBcHBseSBTY2FsaW5nCiAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCA9IHNjYWxlKGJhc2UuSFAsIGdyb3d0aC5IUCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTUDogQ2FwIGF0IDk5LCBidXQgZW5zdXJlIGhpZ2ggbGV2ZWxzIGZlZWwgRkFTVAogICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TUCwgZ3Jvd3RoLlNQKSk7CgogICAgICAgICAgICAvLyBTdGF0IGRpc3RyaWJ1dGlvbiBiYXNlZCBvbiByb2xlIHByaW9yaXRpZXMKICAgICAgICAgICAgaWYgKFsnTEYnLCAnUkYnXS5pbmNsdWRlcyhyb2xlKSkgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlNIID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuU0gsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5FTiwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguU2Vjb25kYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb2xlID09PSAnTUYnKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU0ggPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TSCwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChbJ0xEJywgJ1JEJ10uaW5jbHVkZXMocm9sZSkpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjIpKTsgLy8gRGVmZW5kZXJzIGJhZCBhdCBzaG9vdGluZwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGUgPT09ICdHTCcpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5DQSA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkNBLCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlBBID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuUEEsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjMpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSHVtYW4gUGxheWVyIEJvbnVzIChUaGUgIkhlcm8iIEZlZWwpCiAgICAgICAgICAgIC8vIEdpdmVzIHRoZSBwbGF5ZXIgYSBzbGlnaHQgZWRnZSB0byBtYWtlIGdhbWVwbGF5IGZlZWwgcHVuY2h5CiAgICAgICAgICAgIGlmIChpc0h1bWFuKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuSFAgKz0gMTUwOyAvLyBUYW5raWVyCiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgKz0gNTsgICAvLyBGYXN0ZXIKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5FTiArPSA1OyAgIC8vIEhhcmRlciB0byB0YWNrbGUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gS2V5IFN0YXQgQm9vc3QKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnTEYnIHx8IHJvbGUgPT09ICdSRicpIHBsYXllci5zdGF0cy5TSCArPSA1OwogICAgICAgICAgICAgICAgaWYgKHJvbGUgPT09ICdNRicpIHBsYXllci5zdGF0cy5QQSArPSA1OwogICAgICAgICAgICAgICAgaWYgKHJvbGUgPT09ICdMRCcgfHwgcm9sZSA9PT0gJ1JEJykgcGxheWVyLnN0YXRzLkFUICs9IDU7CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ0dMJykgcGxheWVyLnN0YXRzLkNBICs9IDU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDQuIEZpbmFsaXplCiAgICAgICAgICAgIHBsYXllci5zdGF0cy5tYXhIUCA9IHBsYXllci5zdGF0cy5IUDsKICAgICAgICAgICAgcGxheWVyLmxldmVsID0gbGV2ZWw7CiAgICAgICAgICAgIHBsYXllci5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CiAgICAgICAgfQoKY29uc3RydWN0b3Ioc2NlbmUsIGlkLCBzaWRlLCBjb2xvciwgaXNIdW1hbikgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuaWQgPSBpZDsgLy8gJ2hvbWUnIG9yICdhd2F5JwogICAgICAgICAgICB0aGlzLnNpZGUgPSBzaWRlOyAvLyAxIChEZWZlbmRzICtaKSBvciAtMSAoRGVmZW5kcyAtWikKICAgICAgICAgICAgdGhpcy5jb2xvciA9IGNvbG9yOwogICAgICAgICAgICB0aGlzLmlzSHVtYW4gPSBpc0h1bWFuOwogICAgICAgICAgICB0aGlzLmFpRW5hYmxlZCA9IHRydWU7IC8vIE1hc3RlciBzd2l0Y2ggZm9yIEFJIGxvZ2ljCiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnBsYXllcnMgPSBbXTsKICAgICAgICAgICAgdGhpcy5hY3RpdmVQbGF5ZXIgPSBudWxsOyAvLyBUaGUgcGxheWVyIGN1cnJlbnRseSBjb250cm9sbGVkL2ZvY3VzZWQKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZvcm1hdGlvbiBBbmNob3JzCiAgICAgICAgICAgIHRoaXMuY3VycmVudEZvcm1hdGlvbiA9ICdOb3JtYWwnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUGxheWVyIEluZGljYXRvciAoR3JlZW4gQXJyb3cpCiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF9wbGF5ZXJBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cuc2NhbGUuc2V0KDAuOCwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJBcnJvdy5yZW5kZXJPcmRlciA9IDEwMDA7IC8vIE9uIHRvcAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBhc3NpZ25NYXJrcyhvcHBvc2luZ1RlYW0pIHsKICAgICAgICAgICAgLy8gU2ltcGxlIGF1dG8tYXNzaWduIGxvZ2ljOiBNYXJrIHRoZSBwbGF5ZXIgaW4gdGhlICJtYXRjaGluZyIgcG9zaXRpb24KICAgICAgICAgICAgLy8gTEY8LT5SRCwgUkY8LT5MRCwgTUY8LT5NRiwgTEQ8LT5SRiwgUkQ8LT5MRiwgR0w8LT5MRgogICAgICAgICAgICB0aGlzLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGxldCB0YXJnZXRSb2xlID0gJ01GJzsKICAgICAgICAgICAgICAgIHN3aXRjaCAocC5yb2xlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTEYnOiB0YXJnZXRSb2xlID0gJ1JEJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkYnOiB0YXJnZXRSb2xlID0gJ0xEJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTUYnOiB0YXJnZXRSb2xlID0gJ01GJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTEQnOiB0YXJnZXRSb2xlID0gJ1JGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkQnOiB0YXJnZXRSb2xlID0gJ0xGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnR0wnOiB0YXJnZXRSb2xlID0gJ0xGJzsgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gb3Bwb3NpbmdUZWFtLnBsYXllcnMuZmluZChvcCA9PiBvcC5yb2xlID09PSB0YXJnZXRSb2xlKTsKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICBwLm1hcmtpbmcgPSB0YXJnZXQ7CiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYCR7dGhpcy5pZH0gJHtwLnJvbGV9IG1hcmtlZCAke3RhcmdldC5yb2xlfWApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGFkZFBsYXllcihwbGF5ZXIpIHsKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLnB1c2gocGxheWVyKTsKICAgICAgICAgICAgcGxheWVyLnRlYW0gPSB0aGlzOwoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIEhvbWUgUG9zaXRpb24gYmFzZWQgb24gRm9ybWF0aW9uCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBsYXllckhvbWVQb3NpdGlvbihwbGF5ZXIpOwoKICAgICAgICAgICAgLy8gRW5lbXkgaW5kaWNhdG9yOiByZWQgYXJyb3dzIG92ZXIgdGhlIEF3YXkgdGVhbSAoc28gZW5lbWllcyBhcmUgcmVhZGFibGUpCi8vIEVuZW15IGluZGljYXRvcjogcmVkIGFycm93cyBvdmVyIHRoZSBBd2F5IHRlYW0KICAgICAgICAgICAgaWYgKHRoaXMuaWQgPT09ICdhd2F5JyAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF9lbmVteUFycm93TWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgYXJyb3cuc2NhbGUuc2V0KDAuOCwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgYXJyb3cucG9zaXRpb24uc2V0KDAsIDMuMiwgMCk7IC8vIGFib3ZlIGhlYWQKICAgICAgICAgICAgICAgIGFycm93LnJlbmRlck9yZGVyID0gOTk5OwogICAgICAgICAgICAgICAgcGxheWVyLm1lc2guYWRkKGFycm93KTsKICAgICAgICAgICAgICAgIHBsYXllci5lbmVteUFycm93ID0gYXJyb3c7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFRlYW1tYXRlIGluZGljYXRvcjogV2hpdGUgYXJyb3dzIGZvciBpbmFjdGl2ZSBodW1hbnMKICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbiAmJiBwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBuZXcgVEhSRUUuU3ByaXRlKF90ZWFtbWF0ZUFycm93TWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgYXJyb3cuc2NhbGUuc2V0KDAuNiwgMC42LCAxLjApOwogICAgICAgICAgICAgICAgYXJyb3cucG9zaXRpb24uc2V0KDAsIDMuMiwgMCk7CiAgICAgICAgICAgICAgICBhcnJvdy5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICAgICAgICAgIGFycm93LnZpc2libGUgPSBmYWxzZTsgLy8gSGlkZGVuIGJ5IGRlZmF1bHQsIG1hbmFnZWQgYnkgc2V0QWN0aXZlUGxheWVyCiAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5hZGQoYXJyb3cpOwogICAgICAgICAgICAgICAgcGxheWVyLnRlYW1tYXRlQXJyb3cgPSBhcnJvdzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2V0Rm9ybWF0aW9uKG5hbWUpIHsKICAgICAgICAgICAgaWYgKCFGT1JNQVRJT05TW25hbWVdKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuY3VycmVudEZvcm1hdGlvbiA9IG5hbWU7CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBUZWFtICR7dGhpcy5pZH0gc3dpdGNoZWQgdG8gJHtuYW1lfWApOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocGxheWVyKSB7CiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBGT1JNQVRJT05TW3RoaXMuY3VycmVudEZvcm1hdGlvbl07CiAgICAgICAgICAgIGlmICghZGF0YSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZGF0YVtwbGF5ZXIucm9sZV07CiAgICAgICAgICAgIGlmIChvZmZzZXQpIHsKICAgICAgICAgICAgICAgIC8vIFggUG9zaXRpb246CiAgICAgICAgICAgICAgICAvLyBGb3JtYXRpb25zOiAtWCBpcyBMZWZ0LCArWCBpcyBSaWdodC4KICAgICAgICAgICAgICAgIC8vIEhvbWUgVGVhbSAoU2lkZSAxKSBmYWNlcyAtWi4gTGVmdCBpcyAtWC4gVXNlIG9mZnNldC54IGFzIGlzLgogICAgICAgICAgICAgICAgbGV0IHhQb3MgPSBvZmZzZXQueDsKICAgICAgICAgICAgICAgIGxldCB6UG9zID0gb2Zmc2V0LnogKiB0aGlzLnNpZGU7CgogICAgICAgICAgICAgICAgcGxheWVyLmhvbWVQb3NpdGlvbi5zZXQoeFBvcywgMCwgelBvcyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEF3YXkgVGVhbSAoU2lkZSAtMSkgZmFjZXMgK1ouIExlZnQgaXMgK1guIEZsaXAgWC4KICAgICAgICAgICAgICAgIGlmICh0aGlzLnNpZGUgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgcGxheWVyLmhvbWVQb3NpdGlvbi54ICo9IC0xOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0IGluaXRpYWwgcG9zaXRpb24KICAgICAgICAgICAgaWYgKHBsYXllci5tZXNoKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5wb3NpdGlvbi5jb3B5KHBsYXllci5ob21lUG9zaXRpb24pOwogICAgICAgICAgICAgICAgLy8gRmFjZSBjZW50ZXIgKDAsMCwwKQogICAgICAgICAgICAgICAgcGxheWVyLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgLy8gVXBkYXRlIGFsbCBwbGF5ZXJzCiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXllcnNbaV0udXBkYXRlKGR0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXV0by1zd2l0Y2ggYWN0aXZlIHBsYXllciBpZiBIdW1hbgogICAgICAgICAgICBpZiAodGhpcy5pc0h1bWFuKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUFjdGl2ZVBsYXllclNlbGVjdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVBY3RpdmVQbGF5ZXJTZWxlY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKCFiYWxsKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBPRkZFTlNFOiBJZiB3ZSBoYXZlIHRoZSBiYWxsLCBhY3RpdmUgcGxheWVyIGlzIHRoZSBob2xkZXIKICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVBsYXllciAhPT0gYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihiYWxsLmhvbGRlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIERFRkVOU0U6IFNlbGVjdCBjbG9zZXN0IHRvIGJhbGwKICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBPbmx5IGNoZWNrIGV2ZXJ5IGZldyBmcmFtZXMgb3IgaWYgZGlzdGFuY2UgaXMgc2lnbmlmaWNhbnQKICAgICAgICAgICAgbGV0IGNsb3Nlc3QgPSBudWxsOwogICAgICAgICAgICBsZXQgbWluRHN0ID0gSW5maW5pdHk7CgogICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocC5yb2xlID09PSAnR0wnKSBjb250aW51ZTsgLy8gRG9uJ3QgYXV0by1zd2l0Y2ggdG8gZ29hbGllIHVzdWFsbHkKICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICBjb25zdCBkID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkIDwgbWluRHN0KSB7CiAgICAgICAgICAgICAgICAgICAgbWluRHN0ID0gZDsKICAgICAgICAgICAgICAgICAgICBjbG9zZXN0ID0gcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNsb3Nlc3QgJiYgY2xvc2VzdCAhPT0gdGhpcy5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0QWN0aXZlUGxheWVyKGNsb3Nlc3QpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKc2V0QWN0aXZlUGxheWVyKHBsYXllcikgewogICAgICAgICAgICAvLyBSZXNldCBpbnB1dCBvbiBwcmV2aW91cwogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlUGxheWVyLnNldElucHV0KDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYWN0aXZlUGxheWVyID0gcGxheWVyOwoKICAgICAgICAgICAgLy8gVmlzdWFsIEluZGljYXRvcnMKICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbikgewogICAgICAgICAgICAgICAgLy8gMS4gR3JlZW4gQXJyb3cgZm9yIEFjdGl2ZQogICAgICAgICAgICAgICAgaWYgKHRoaXMucGxheWVyQXJyb3cgJiYgcGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5hZGQodGhpcy5wbGF5ZXJBcnJvdyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJBcnJvdy5wb3NpdGlvbi5zZXQoMCwgMy41LCAwKTsgLy8gRmxvYXQgYWJvdmUgaGVhZAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDIuIFdoaXRlIEFycm93cyBmb3IgT3RoZXJzCiAgICAgICAgICAgICAgICB0aGlzLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAocC50ZWFtbWF0ZUFycm93KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAudGVhbW1hdGVBcnJvdy52aXNpYmxlID0gKHAgIT09IHBsYXllcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpyZXNldFBvc2l0aW9ucygpIHsKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHRoaXMucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5jb3B5KHAuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBQaHlzaWNzCiAgICAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgcC5pbnB1dFZlY3Rvci5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgcC5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBwLmlzVGhyb3dpbmcgPSBmYWxzZTsKcC5sb3NlQmFsbCgpOyAvLyBEcm9wIGJhbGwgaWYgaG9sZGluZwogICAgICAgICAgICAgICAgICAgIHAuY2FuQ2F0Y2ggPSB0cnVlOyAvLyBGb3JjZSByZXNldCBjYXBhYmlsaXR5CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgU3RhdHMKICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgICAgICAgICAgCi8vIE9yaWVudGF0aW9uOiBGYWNlIENlbnRlcgogICAgICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuc3luY1JvdGF0aW9uKSBwLnN5bmNSb3RhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IEFuaW1hdGlvbgogICAgICAgICAgICAgICAgICAgIHAucGxheSgnaWRsZScsIDAuMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUmVzZXQgYWN0aXZlIHBsYXllciB0byBNRgogICAgICAgICAgICBjb25zdCBtZiA9IHRoaXMucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgaWYgKG1mKSB0aGlzLnNldEFjdGl2ZVBsYXllcihtZik7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LlRlYW0gPSBUZWFtOwp9KSgpOw==","Goalie.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgIAogICAgLy8gUmV1c2FibGUgdmVjdG9ycyB0byBhdm9pZCBHQwpjb25zdCBfZ1ZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ1BvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfYmFsbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZmFjZVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ29hbENlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlY0cgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEdvYWxpZSBleHRlbmRzIHdpbmRvdy5mbHV4LlBsYXllciB7CmNvbnN0cnVjdG9yKHNjZW5lLCByb2xlKSB7CiAgICAgICAgICAgIHN1cGVyKHNjZW5lLCByb2xlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdvYWxpZSBTcGVjaWZpYyBTdGF0cyAoQnVmZmVkIGZvciBQbGF5YWJpbGl0eSkKICAgICAgICAgICAgdGhpcy5zdGF0cy5DQSA9IDMwOyAvLyBDYXRjaAogICAgICAgICAgICB0aGlzLnN0YXRzLlNQID0gNDA7IC8vIFNwZWVkCiAgICAgICAgICAgIHRoaXMuc3RhdHMuRU4gPSA1MDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJVRkZFRDogU3Ryb25nIGFybSBmb3IgY2xlYXJpbmcgdGhlIHpvbmUKICAgICAgICAgICAgdGhpcy5zdGF0cy5QQSA9IDQ1OyAvLyBXYXMgMjAgLSBOb3cgc3Ryb25nIGVub3VnaCB0byByZWFjaCBtaWRmaWVsZAogICAgICAgICAgICB0aGlzLnN0YXRzLlNIID0gMzU7IC8vIFdhcyAxMCAtIERlY2VudCBjbGVhcmFuY2Uga2ljawogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CgogICAgICAgICAgICAvLyBHb2FsIERpbWVuc2lvbnMgKFNhdmUgQm94KQovLyBHb2FsIERpbWVuc2lvbnMgKFNhdmUgQm94KSAtIE1hdGNoZXMgR2FtZU1hbmFnZXIgZGV0ZWN0aW9uCi8vIEdvYWwgRGltZW5zaW9ucyAoU2F2ZSBCb3gpIC0gTWF0Y2hlcyBHYW1lTWFuYWdlciBkZXRlY3Rpb24KICAgICAgICAgICAgdGhpcy5nb2FsV2lkdGggPSAyMi4wOyAvLyBJbmNyZWFzZWQgdG8gbWF0Y2ggbmV3IGRldGVjdGlvbiBib3gKICAgICAgICAgICAgdGhpcy5nb2FsSGVpZ2h0ID0gMTguMDsgLy8gSW5jcmVhc2VkIHRvIG1hdGNoIG5ldyBkZXRlY3Rpb24gYm94CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTYXZlIE1lY2hhbmljcwogICAgICAgICAgICB0aGlzLnNhdmVSYWRpdXMgPSA2LjA7IAogICAgICAgICAgICB0aGlzLnByZXNzdXJlTXVsdGlwbGllciA9IDUuMDsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUZWNocwogICAgICAgICAgICB0aGlzLnRlY2hzID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBudWxsLCAKICAgICAgICAgICAgICAgIHBhc3NpdmU6IG51bGwgCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBSSBTdGF0ZQogICAgICAgICAgICB0aGlzLnRocm93VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZFNhdmUgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3VwZXIgR29hbGllIFN0YXRlCiAgICAgICAgICAgIHRoaXMuaXNTdXBlckdvYWxpZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnN1cGVyR29hbGllVGltZXIgPSAwOwogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICAvLyAxLiBTdXBlciBHb2FsaWUgVGltZXIKICAgICAgICAgICAgaWYgKHRoaXMuaXNTdXBlckdvYWxpZSkgewogICAgICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3VwZXJHb2FsaWVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1N1cGVyR29hbGllID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDIuIFBvc3Nlc3Npb24gTG9naWMgKEJhbGwgSGVsZCkKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVQcmVzc3VyZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBpc0h1bWFuQ29udHJvbGxlZCA9IHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uaXNIdW1hbiAmJiB0aGlzLnRlYW0uYWN0aXZlUGxheWVyID09PSB0aGlzICYmICFnYW1lLmlzRGVtb01vZGU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChpc0h1bWFuQ29udHJvbGxlZCkgewogICAgICAgICAgICAgICAgICAgIC8vIEh1bWFuOiBGdWxsIGNvbnRyb2wgKFJvdGF0aW9uLCBDaGFyZ2luZywgZXRjIHZpYSBQbGF5ZXIudXBkYXRlKQogICAgICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIEFJOiBMb2dpYyB0aGVuIHVwZGF0ZQogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2FpUG9zc2Vzc2lvbkxvZ2ljKGR0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIEFJIGRvZXNuJ3QgZHJpZnQKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIERlZmVuc2UgLyBTYXZlIExvZ2ljIChObyBCYWxsKQogICAgICAgICAgICAvLyBXZSBtdXN0IGhhbmRsZSB0aW1lcnMgYW5kIHN0YXR1cyBtYW51YWxseSBiZWNhdXNlIHdlIHNraXAgc3VwZXIudXBkYXRlKCkgdG8gdXNlIGN1c3RvbSBtb3ZlbWVudAogICAgICAgICAgICBpZiAodGhpcy5kYXNoQ29vbGRvd24gPiAwKSB0aGlzLmRhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuY2xhc2hDb29sZG93biA+IDApIHRoaXMuY2xhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCkgdGhpcy5zdHVuVGltZXIgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmltbXVuaXR5VGltZXIgPiAwKSB0aGlzLmltbXVuaXR5VGltZXIgLT0gZHQ7CgogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXMoZHQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5taXhlcikgdGhpcy5taXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlSFBCYXIoKTsKICAgICAgICAgICAgICAgIHRoaXMuX2NvbnN0cmFpbkJvdW5kcygpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDdXN0b20gTW92ZW1lbnQKICAgICAgICAgICAgdGhpcy5fZGVmZW5zZUxvZ2ljKGR0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBBbmltYXRpb24KICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlSFBCYXIoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuX2NvbnN0cmFpbkJvdW5kcygpOwogICAgICAgIH0KCl9jb25zdHJhaW5Cb3VuZHMoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3Qgc2lkZSA9IHRoaXMudGVhbSA/IHRoaXMudGVhbS5zaWRlIDogMTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFggQm91bmRzIChXaWR0aCBvZiBwZW5hbHR5IGFyZWEgKy8tIDEwbSkgLT4gSW5jcmVhc2VkIGZvciBtYXNzaXZlIGdvYWwKY29uc3QgeExpbWl0ID0gMjAuMDsgLy8gUmVkdWNlZCB3aWR0aCBvZiBnb2FsaWUgbW92ZW1lbnQKICAgICAgICAgICAgaWYgKHBvcy54ID4geExpbWl0KSB7IHBvcy54ID0geExpbWl0OyB0aGlzLnZlbG9jaXR5LnggPSAwOyB9CiAgICAgICAgICAgIGlmIChwb3MueCA8IC14TGltaXQpIHsgcG9zLnggPSAteExpbWl0OyB0aGlzLnZlbG9jaXR5LnggPSAwOyB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBZIEJvdW5kcwogICAgICAgICAgICBjb25zdCB5TGltaXQgPSAxMi4wOyAvLyBSZWR1Y2VkIGhlaWdodCBjZWlsaW5nCiAgICAgICAgICAgIGlmIChwb3MueSA+IHlMaW1pdCkgeyBwb3MueSA9IHlMaW1pdDsgdGhpcy52ZWxvY2l0eS55ID0gMDsgfQogICAgICAgICAgICBpZiAocG9zLnkgPCAteUxpbWl0KSB7IHBvcy55ID0gLXlMaW1pdDsgdGhpcy52ZWxvY2l0eS55ID0gMDsgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gWiBCb3VuZHMgKERlcHRoKQovLyBaIEJvdW5kcyAoRGVwdGgpCiAgICAgICAgICAgIC8vIEhvbWUgKFNpZGUgMSk6IEdvYWwgYXQgKzQ2LiBUcmlnZ2VyIGF0IDQ1LiBMaW1pdCB0byA0NS41LgogICAgICAgICAgICAvLyBBd2F5IChTaWRlIC0xKTogR29hbCBhdCAtNDYuIFRyaWdnZXIgYXQgLTQ1LiBMaW1pdCB0byAtNDUuNS4KICAgICAgICAgICAgaWYgKHNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IDQ1LjUpIHsgcG9zLnogPSA0NS41OyB0aGlzLnZlbG9jaXR5LnogPSAwOyB9CiAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAyMC4wKSB7IHBvcy56ID0gMjAuMDsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHBvcy56IDwgLTQ1LjUpIHsgcG9zLnogPSAtNDUuNTsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICAgICAgaWYgKHBvcy56ID4gLTIwLjApIHsgcG9zLnogPSAtMjAuMDsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKLy8gT3ZlcnJpZGUgdGhyb3dCYWxsIHRvIGZpeCAid2VhayB0aHJvdyIgaXNzdWUKLy8gT3ZlcnJpZGUgdGhyb3dCYWxsIHRvIGZpeCAid2VhayB0aHJvdyIgaXNzdWUKICAgICAgICB0aHJvd0JhbGwoYmFsbCwgZm9yY2VkVHlwZSA9IG51bGwsIHBvd2VyTXVsdGlwbGllciA9IDEuMCkgewogICAgICAgICAgICAvLyBHb2FsaWVzIGFsbW9zdCBhbHdheXMgUEFTUywgZXZlbiB3aGVuICJjbGVhcmluZyIgZm9yd2FyZC4KICAgICAgICAgICAgLy8gVGhlIGRlZmF1bHQgUGxheWVyIGxvZ2ljIHN3aXRjaGVzIHRvICdTSCcgKFNob290KSBpZiBhaW1pbmcgZm9yd2FyZCwgCiAgICAgICAgICAgIC8vIHdoaWNoIHVzZXMgdGhlIEdvYWxpZSdzIGxvd2VyIFNIIHN0YXQuIFdlIGZvcmNlIFBBIHVubGVzcyBzcGVjaWZpZWQuCiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBmb3JjZWRUeXBlIHx8ICdQQSc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBCT09TVDogQXBwbHkgYSBtdWx0aXBsaWVyIHRvIGVuc3VyZSB0aGUgZ29hbGllIGNhbiBjbGVhciB0aGUgYmFsbCB0byBtaWRmaWVsZC4KICAgICAgICAgICAgLy8gTkVSRkVEOiBSZWR1Y2VkIGZyb20gMS42IHRvIDEuMiB0byBwcmV2ZW50IGNyb3NzLW1hcCB0aHJvd3MgYXMgcGVyIHVzZXIgZmVlZGJhY2suCiAgICAgICAgICAgIGNvbnN0IGJvb3N0ID0gMS4yOwoKICAgICAgICAgICAgc3VwZXIudGhyb3dCYWxsKGJhbGwsIHR5cGUsIHBvd2VyTXVsdGlwbGllciAqIGJvb3N0KTsKICAgICAgICB9CgpfZGVmZW5zZUxvZ2ljKGR0KSB7CiAgICAgICAgICAgIC8vIDAuIEdhbWUgU3RhdGUgQ2hlY2sKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSAhPT0gJ2FjdGl2ZScpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIERldGVybWluZSBUaHJlYXQgU291cmNlCiAgICAgICAgICAgIGxldCB0aHJlYXRQb3MgPSBfYmFsbFBvczsKICAgICAgICAgICAgbGV0IGlzVGhyZWF0ID0gZmFsc2U7CmNvbnN0IG15R29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gNDYgOiAtNDY7CgogICAgICAgICAgICAvLyBDYXNlIEE6IEJhbGwgaXMgSGVsZCAoUHJlLXRocm93KQogICAgICAgICAgICBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2hlbGQnICYmIGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgdGhyZWF0UG9zID0gYmFsbC5ob2xkZXIubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgaG9sZGVyIGlzIGluIGF0dGFja2luZyBoYWxmIG9yIG5lYXIgZW5vdWdoCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5hYnModGhyZWF0UG9zLnogLSBteUdvYWxaKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9Hb2FsIDwgNDAuMCkgeyAvLyBJZiB0aGV5IGFyZSB3aXRoaW4gNDBtLCB0cmFjayB0aGVtCiAgICAgICAgICAgICAgICAgICAgaXNUaHJlYXQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IAogICAgICAgICAgICAvLyBDYXNlIEI6IEJhbGwgaXMgRnJlZSAoU2hvdC9QYXNzKQogICAgICAgICAgICBlbHNlIGlmIChiYWxsLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIHRocmVhdFBvcyA9IGJhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlyZWN0aW9uIENoZWNrCiAgICAgICAgICAgICAgICBjb25zdCBtb3ZpbmdUb3dhcmRzID0gKHRoaXMudGVhbS5zaWRlID09PSAxICYmIGJhbGwudmVsb2NpdHkueiA+IDApIHx8IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLnRlYW0uc2lkZSA9PT0gLTEgJiYgYmFsbC52ZWxvY2l0eS56IDwgMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFBvc2l0aW9uIENoZWNrCi8vIFBvc2l0aW9uIENoZWNrCiAgICAgICAgICAgICAgICBjb25zdCBpbkZyb250T2ZHb2FsID0gKHRoaXMudGVhbS5zaWRlID09PSAxICYmIHRocmVhdFBvcy56IDwgNDUuMCkgfHwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHRoaXMudGVhbS5zaWRlID09PSAtMSAmJiB0aHJlYXRQb3MueiA+IC00NS4wKTsKCiAgICAgICAgICAgICAgICBpc1RocmVhdCA9IG1vdmluZ1Rvd2FyZHMgJiYgaW5Gcm9udE9mR29hbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGlzVGhyZWF0KSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gUE9TSVRJT05JTkc6IEFOR0xFIENVVFRJTkcgLS0tCiAgICAgICAgICAgICAgICBfYmFsbFBvcy5jb3B5KHRocmVhdFBvcyk7IC8vIFVwZGF0ZSByZWZlcmVuY2UgZm9yIGxvb2tBdAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAxLiBDYWxjdWxhdGUgR29hbCBDZW50ZXIKLy8gMS4gQ2FsY3VsYXRlIEdvYWwgQ2VudGVyIChBZGp1c3RlZCBmb3IgWSBvZmZzZXQpCl9nb2FsQ2VudGVyLnNldCgwLCAtNC41LCBteUdvYWxaKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMi4gVmVjdG9yIGZyb20gR29hbCB0byBCYWxsCiAgICAgICAgICAgICAgICBfdGVtcFZlY0cuc3ViVmVjdG9ycyhfYmFsbFBvcywgX2dvYWxDZW50ZXIpOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IF90ZW1wVmVjRy5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjRy5ub3JtYWxpemUoKTsgLy8gTm93IGhvbGRzIGRpcmVjdGlvbgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAzLiBEZXRlcm1pbmUgRXh0ZW5zaW9uIChIb3cgZmFyIG91dCB0byBzdGVwKQogICAgICAgICAgICAgICAgLy8gQmFzZTogMS41bSBvZmYgbGluZS4KICAgICAgICAgICAgICAgIC8vIE1heDogNi4wbSBvZmYgbGluZSAoQ3V0dGluZyBhbmdsZSkuCiAgICAgICAgICAgICAgICAvLyBTY2FsZSBiYXNlZCBvbiBiYWxsIHByb3hpbWl0eTogQ2xvc2VyIGJhbGwgPSBNb3JlIGV4dGVuc2lvbiAodG8gYSBwb2ludCkKbGV0IGV4dGVuc2lvbiA9IDEuNTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMzAuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gMS4wIC0gKE1hdGgubWF4KDAsIGRpc3RUb0JhbGwgLSA1LjApIC8gMjUuMCk7IAogICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbiA9IDEuNSArICg0LjUgKiByYXRpbyk7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCi8vIFNhZmV0eTogRG9uJ3QgZ28gcGFzdCB0aGUgYmFsbCAoa2VlcCAxbSBidWZmZXIpCiAgICAgICAgICAgICAgICBleHRlbnNpb24gPSBNYXRoLm1pbihleHRlbnNpb24sIGRpc3RUb0JhbGwgLSAxLjApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyA0LiBDYWxjdWxhdGUgVGFyZ2V0IFBvc2l0aW9uIChCYXNlIEludGVyY2VwdGlvbikKICAgICAgICAgICAgICAgIF9nUG9zLmNvcHkoX2dvYWxDZW50ZXIpLmFkZChfdGVtcFZlY0cubXVsdGlwbHlTY2FsYXIoZXh0ZW5zaW9uKSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDUuIFZlcnRpY2FsIE92ZXJyaWRlIChKdW1wIHRvIG1lZXQgYmFsbCkKICAgICAgICAgICAgICAgIC8vIEV4cGxpY2l0bHkgc2V0IFkgdG8gbWF0Y2ggYmFsbCBoZWlnaHQgaWYgaXQncyBoaWdoCiAgICAgICAgICAgICAgICBpZiAoX2JhbGxQb3MueSA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIF9nUG9zLnkgPSBfYmFsbFBvcy55OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gMC41OyAvLyBEZWZhdWx0IHN0YW5jZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDYuIENsYW1wIHRvIEdvYWwgQm94IERpbWVuc2lvbnMgKExhdGVyYWwvVmVydGljYWwgTGltaXRzKQogICAgICAgICAgICAgICAgLy8gR29hbCBXaWR0aCAyMiAoKy8tIDExKSwgSGVpZ2h0IDE4ICgrLy0gOSkuCiAgICAgICAgICAgICAgICAvLyBBbGxvdyBzbGlnaHRseSBvdXRzaWRlIHBvc3RzIHRvIGNvdmVyIGFuZ2xlcy4KICAgICAgICAgICAgICAgIGNvbnN0IGNsYW1wWCA9IHRoaXMuZ29hbFdpZHRoICogMC42OyAvLyArLy0gMTMuMgpjb25zdCBjbGFtcFkgPSAxMi4wOyAvLyBSZWR1Y2VkIG1heCBqdW1wIGhlaWdodAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfZ1Bvcy54ID0gTWF0aC5tYXgoLWNsYW1wWCwgTWF0aC5taW4oY2xhbXBYLCBfZ1Bvcy54KSk7CiAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gTWF0aC5tYXgoLWNsYW1wWSwgTWF0aC5taW4oY2xhbXBZLCBfZ1Bvcy55KSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDYuIExlYWQgdGhlIGJhbGwgc2xpZ2h0bHkgaWYgaXQgaGFzIGxhdGVyYWwgdmVsb2NpdHkgKEFudGljaXBhdGlvbikKaWYgKGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDEuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFudGljaXBhdGlvbiA9IGJhbGwudmVsb2NpdHkuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigwLjI1KTsgLy8gMC4yNXMgbGVhZAogICAgICAgICAgICAgICAgICAgIGFudGljaXBhdGlvbi56ID0gMDsgLy8gT25seSBsYXRlcmFsIGxlYWQKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy5hZGQoYW50aWNpcGF0aW9uKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAppZiAodGhpcy50ZWFtLnNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy56ID0gTWF0aC5taW4oNDUuNSwgX2dQb3Mueik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9nUG9zLnogPSBNYXRoLm1heCgtNDUuNSwgX2dQb3Mueik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTW92ZSB0b3dhcmRzIHRhcmdldAogICAgICAgICAgICAgICAgY29uc3QgbW92ZURpciA9IF9nVmVjLnN1YlZlY3RvcnMoX2dQb3MsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9UYXJnZXQgPSBtb3ZlRGlyLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvVGFyZ2V0ID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgbW92ZURpci5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAvLyBCdXJzdCBzcGVlZCBmb3Igc2F2ZXMgaWYgYmFsbCBpcyBjbG9zZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHVyZ2VuY3kgPSAoZGlzdFRvQmFsbCA8IDEwLjApID8gMS41IDogMS4wOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gdGhpcy5tYXhTcGVlZCAqIHVyZ2VuY3k7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChtb3ZlRGlyLm11bHRpcGx5U2NhbGFyKHNwZWVkICogZHQpKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBGYWNlIGJhbGwKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KF9iYWxsUG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ3N3aW0nKSB0aGlzLnBsYXkoJ3N3aW0nLCAwLjIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ2lkbGUnKSB0aGlzLnBsYXkoJ2lkbGUnLCAwLjIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoX2JhbGxQb3MpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIC0tLSBTQVZFIE1FQ0hBTklDIC0tLQogICAgICAgICAgICAgICAgLy8gSWYgYmFsbCBpcyB3aXRoaW4gcmFuZ2UsIGFwcGx5IENBIHByZXNzdXJlCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgdGhpcy5zYXZlUmFkaXVzKSB7IAogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5U2F2ZVByZXNzdXJlKGJhbGwsIGR0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBJRExFIC8gUkVUVVJOIFRPIFBPU1QgLS0tCiAgICAgICAgICAgICAgICAvLyBSZXR1cm4gdG8gaG9tZSBwb3NpdGlvbiAodXN1YWxseSBjZW50ZXIgb2YgZ29hbCkKICAgICAgICAgICAgICAgIF9nUG9zLmNvcHkodGhpcy5ob21lUG9zaXRpb24pOwogICAgICAgICAgICAgICAgY29uc3QgbW92ZURpciA9IF9nVmVjLnN1YlZlY3RvcnMoX2dQb3MsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChtb3ZlRGlyLmxlbmd0aCgpID4gMC41KSB7CiAgICAgICAgICAgICAgICAgICAgbW92ZURpci5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKG1vdmVEaXIubXVsdGlwbHlTY2FsYXIodGhpcy5tYXhTcGVlZCAqIDAuNiAqIGR0KSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdzd2ltJykgdGhpcy5wbGF5KCdzd2ltJywgMC4yKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpZGxlJykgdGhpcy5wbGF5KCdpZGxlJywgMC4yKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmFjZSBjZW50ZXIgZmllbGQKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9hcHBseVNhdmVQcmVzc3VyZShiYWxsLCBkdCkgewogICAgICAgICAgICAvLyBJZiBHb2FsaWUgaXMgQXNsZWVwLCB0aGV5IGNhbm5vdCBzYXZlLgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gLS0tIFNVUEVSIEdPQUxJRSBUUklHR0VSIC0tLQogICAgICAgICAgICAvLyBUcmlnZ2VyIGlmOiBUZWNoIGVxdWlwcGVkLCBOb3QgYWN0aXZlLCBCYWxsIGhhcyBwb3dlciwgQmFsbCBpcyBjbG9zZQogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5hY3RpdmUgPT09ICdzdXBlcl9nb2FsaWUnICYmICF0aGlzLmlzU3VwZXJHb2FsaWUgJiYgYmFsbC5wb3dlciA+IDUuMCkgewogICAgICAgICAgICAgICAgLy8gQ2hhbmNlIHRvIHRyaWdnZXIgKEhpZ2ggY2hhbmNlIGZvciBBSSwgb3IgY2hlY2sgSFApCiAgICAgICAgICAgICAgICAvLyBDb3N0OiAxMCBIUAogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPj0gMTApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IDEwOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNTdXBlckdvYWxpZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyID0gMS41OyAvLyBMYXN0cyAxLjVzCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSB1c2VkIFNVUEVSIEdPQUxJRSFgKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTVVBFUiBHT0FMSUUhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic2F2ZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIFRlY2hjb3B5IEV2ZW50CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCh0aGlzLCAnc3VwZXJfZ29hbGllJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDYWxjdWxhdGUgRWZmZWN0aXZlIENBCiAgICAgICAgICAgIGxldCBjYSA9IHRoaXMuZ2V0U3RhdCgnQ0EnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IFN1cGVyIEdvYWxpZSBCb251cyAoZS5nLiArNTAlICsgRmxhdCAxMCkKICAgICAgICAgICAgaWYgKHRoaXMuaXNTdXBlckdvYWxpZSkgewogICAgICAgICAgICAgICAgY2EgPSAoY2EgKiAxLjUpICsgMTA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IEdyaXAgR2xvdmVzIChQYXNzaXZlKQogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5wYXNzaXZlID09PSAnZ3JpcF9nbG92ZXMnKSB7CiAgICAgICAgICAgICAgICBjYSArPSA1OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDYWxjdWxhdGUgUHJlc3N1cmUKICAgICAgICAgICAgLy8gUHJlc3N1cmUgPSBDQSAqIGR0ICogTXVsdGlwbGllcgogICAgICAgICAgICBjb25zdCBwcmVzc3VyZSA9IGNhICogZHQgKiB0aGlzLnByZXNzdXJlTXVsdGlwbGllcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlciAtPSBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrCiAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZFNhdmUgKz0gcHJlc3N1cmU7CiAgICAgICAgICAgICAgICAvLyBUSFJPVFRMRTogSW5jcmVhc2VkIHRocmVzaG9sZCB0byAxMi4wCiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYWNjdW11bGF0ZWRTYXZlID49IDEyLjApIHsgCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0shIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkU2F2ZSA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFwcGx5IEJhbGwgVGVjaG5pcXVlIHRvIEdvYWxpZSAoUmlzayBvZiBjYXRjaGluZyBzcGVjaWFsIHNob3RzKQogICAgICAgICAgICBpZiAoYmFsbC50ZWNobmlxdWUgJiYgIXRoaXMuX3RlY2hBcHBsaWVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLl90ZWNoQXBwbGllZCA9IHRydWU7CiAgICAgICAgICAgICAgICBjb25zdCB0ZWNoID0gYmFsbC50ZWNobmlxdWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZWNoLnR5cGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDE1LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICduYXAnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseVN0YXR1cygnbmFwJywgOC4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGVjaC50eXBlID09PSAnd2l0aGVyJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDE1LjAsICdDQScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IHRoaXMuX3RlY2hBcHBsaWVkID0gZmFsc2U7IH0sIDIwMDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayBSZXN1bHQKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCkgewogICAgICAgICAgICAgICAgLy8gQ0FUQ0gKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hCYWxsKGJhbGwpOwogICAgICAgICAgICB9IAogICAgICAgIH0KCiAgICAgICAgY2F0Y2hCYWxsKGJhbGwpIHsKICAgICAgICAgICAgYmFsbC5ncmFiKHRoaXMpOwogICAgICAgICAgICB0aGlzLnBsYXkoJ2NhdGNoJywgMC4xKTsKICAgICAgICAgICAgY29uc29sZS5sb2coIlNBVkVEIGJ5ICIgKyB0aGlzLnJvbGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRVhQIFJFV0FSRDogU2F2ZQogICAgICAgICAgICB0aGlzLmdhaW5FeHAoNSk7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0FWRUQhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjE1LCAnaGVhdnknKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IHRocm93IHRpbWVyCiAgICAgICAgICAgIHRoaXMudGhyb3dUaW1lciA9IDA7CiAgICAgICAgfQoKX2FpUG9zc2Vzc2lvbkxvZ2ljKGR0KSB7CiAgICAgICAgICAgIHRoaXMudGhyb3dUaW1lciArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhvbGQgZm9yIGEgbW9tZW50ICgxLjVzKSB0aGVuIHRocm93CiAgICAgICAgICAgIGlmICh0aGlzLnRocm93VGltZXIgPiAxLjUpIHsKICAgICAgICAgICAgICAgIC8vIEZpbmQgYmVzdCB0YXJnZXQ6IFByZWZlciBNRiBvciBEZWZlbmRlcnMsIGJ1dCBtdXN0IGJlIHNvbWV3aGF0IGRpc3RhbnQgdG8gYXZvaWQgImhhbmRvZmYiIGxvb2sKICAgICAgICAgICAgICAgIC8vIEZpbHRlciBmb3IgdGVhbW1hdGVzID4gOCB1bml0cyBhd2F5IGlmIHBvc3NpYmxlCiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZE1hdGVzID0gdGhpcy50ZWFtLnBsYXllcnMuZmlsdGVyKHAgPT4gCiAgICAgICAgICAgICAgICAgICAgcCAhPT0gdGhpcyAmJiAKICAgICAgICAgICAgICAgICAgICBwLm1lc2ggJiYgCiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5tZXNoLnBvc2l0aW9uKSA+IDguMAogICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eSAxOiBNaWRmaWVsZGVyIChQbGF5bWFrZXIpCiAgICAgICAgICAgICAgICB0YXJnZXQgPSB2YWxpZE1hdGVzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eSAyOiBEZWZlbmRlcnMKICAgICAgICAgICAgICAgIGlmICghdGFyZ2V0KSB0YXJnZXQgPSB2YWxpZE1hdGVzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdMRCcgfHwgcC5yb2xlID09PSAnUkQnKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUHJpb3JpdHkgMzogQW55b25lIG9wZW4gKGZhbGxiYWNrIHRvIGNsb3NlIHJhbmdlIGlmIG5vIG9uZSBpcyBmYXIpCiAgICAgICAgICAgICAgICBpZiAoIXRhcmdldCkgdGFyZ2V0ID0gdGhpcy50ZWFtLnBsYXllcnMuZmluZChwID0+IHAgIT09IHRoaXMgJiYgcC5yb2xlICE9PSAnR0wnKTsKCiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQUlNSU5HIExPR0lDOiBMb2Z0IHRoZSBwYXNzCiAgICAgICAgICAgICAgICAgICAgLy8gTG9vayBhdCB0YXJnZXQsIGJ1dCBhaW0gc2xpZ2h0bHkgdXAgdG8gY3JlYXRlIGFuIGFyYwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFBvcyA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGRpc3RhbmNlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldFBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gTG9mdCBmYWN0b3I6IFRoZSBmdXJ0aGVyIGF3YXksIHRoZSBoaWdoZXIgd2UgYWltCiAgICAgICAgICAgICAgICAgICAgLy8gMjAgdW5pdHMgYXdheSAtPiBBaW0gNSB1bml0cyBhYm92ZSBoZWFkCiAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9mdCA9IE1hdGgubWF4KDEuMCwgZGlzdCAqIDAuMjUpOwogICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy55ICs9IGxvZnQ7CgogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBUaHJvdwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCAnUEEnKTsgCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSB0aHJvd3MgdG8gJHt0YXJnZXQucm9sZX0gKERpc3Q6ICR7ZGlzdC50b0ZpeGVkKDEpfSlgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2xlYXIgaXQgZm9yd2FyZAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoMCwgNSwgMCk7IC8vIEFpbSB1cC1jZW50ZXIKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgJ1NIJyk7IC8vIEhhcmQgY2xlYXIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Hb2FsaWUgPSBHb2FsaWU7Cn0pKCk7","./Goalie.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgIAogICAgLy8gUmV1c2FibGUgdmVjdG9ycyB0byBhdm9pZCBHQwpjb25zdCBfZ1ZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ1BvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfYmFsbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZmFjZVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ29hbENlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlY0cgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEdvYWxpZSBleHRlbmRzIHdpbmRvdy5mbHV4LlBsYXllciB7CmNvbnN0cnVjdG9yKHNjZW5lLCByb2xlKSB7CiAgICAgICAgICAgIHN1cGVyKHNjZW5lLCByb2xlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdvYWxpZSBTcGVjaWZpYyBTdGF0cyAoQnVmZmVkIGZvciBQbGF5YWJpbGl0eSkKICAgICAgICAgICAgdGhpcy5zdGF0cy5DQSA9IDMwOyAvLyBDYXRjaAogICAgICAgICAgICB0aGlzLnN0YXRzLlNQID0gNDA7IC8vIFNwZWVkCiAgICAgICAgICAgIHRoaXMuc3RhdHMuRU4gPSA1MDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJVRkZFRDogU3Ryb25nIGFybSBmb3IgY2xlYXJpbmcgdGhlIHpvbmUKICAgICAgICAgICAgdGhpcy5zdGF0cy5QQSA9IDQ1OyAvLyBXYXMgMjAgLSBOb3cgc3Ryb25nIGVub3VnaCB0byByZWFjaCBtaWRmaWVsZAogICAgICAgICAgICB0aGlzLnN0YXRzLlNIID0gMzU7IC8vIFdhcyAxMCAtIERlY2VudCBjbGVhcmFuY2Uga2ljawogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CgogICAgICAgICAgICAvLyBHb2FsIERpbWVuc2lvbnMgKFNhdmUgQm94KQovLyBHb2FsIERpbWVuc2lvbnMgKFNhdmUgQm94KSAtIE1hdGNoZXMgR2FtZU1hbmFnZXIgZGV0ZWN0aW9uCi8vIEdvYWwgRGltZW5zaW9ucyAoU2F2ZSBCb3gpIC0gTWF0Y2hlcyBHYW1lTWFuYWdlciBkZXRlY3Rpb24KICAgICAgICAgICAgdGhpcy5nb2FsV2lkdGggPSAyMi4wOyAvLyBJbmNyZWFzZWQgdG8gbWF0Y2ggbmV3IGRldGVjdGlvbiBib3gKICAgICAgICAgICAgdGhpcy5nb2FsSGVpZ2h0ID0gMTguMDsgLy8gSW5jcmVhc2VkIHRvIG1hdGNoIG5ldyBkZXRlY3Rpb24gYm94CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTYXZlIE1lY2hhbmljcwogICAgICAgICAgICB0aGlzLnNhdmVSYWRpdXMgPSA2LjA7IAogICAgICAgICAgICB0aGlzLnByZXNzdXJlTXVsdGlwbGllciA9IDUuMDsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUZWNocwogICAgICAgICAgICB0aGlzLnRlY2hzID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBudWxsLCAKICAgICAgICAgICAgICAgIHBhc3NpdmU6IG51bGwgCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBSSBTdGF0ZQogICAgICAgICAgICB0aGlzLnRocm93VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZFNhdmUgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3VwZXIgR29hbGllIFN0YXRlCiAgICAgICAgICAgIHRoaXMuaXNTdXBlckdvYWxpZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnN1cGVyR29hbGllVGltZXIgPSAwOwogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICAvLyAxLiBTdXBlciBHb2FsaWUgVGltZXIKICAgICAgICAgICAgaWYgKHRoaXMuaXNTdXBlckdvYWxpZSkgewogICAgICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3VwZXJHb2FsaWVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1N1cGVyR29hbGllID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDIuIFBvc3Nlc3Npb24gTG9naWMgKEJhbGwgSGVsZCkKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVQcmVzc3VyZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBpc0h1bWFuQ29udHJvbGxlZCA9IHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uaXNIdW1hbiAmJiB0aGlzLnRlYW0uYWN0aXZlUGxheWVyID09PSB0aGlzICYmICFnYW1lLmlzRGVtb01vZGU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChpc0h1bWFuQ29udHJvbGxlZCkgewogICAgICAgICAgICAgICAgICAgIC8vIEh1bWFuOiBGdWxsIGNvbnRyb2wgKFJvdGF0aW9uLCBDaGFyZ2luZywgZXRjIHZpYSBQbGF5ZXIudXBkYXRlKQogICAgICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIEFJOiBMb2dpYyB0aGVuIHVwZGF0ZQogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2FpUG9zc2Vzc2lvbkxvZ2ljKGR0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIEFJIGRvZXNuJ3QgZHJpZnQKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIERlZmVuc2UgLyBTYXZlIExvZ2ljIChObyBCYWxsKQogICAgICAgICAgICAvLyBXZSBtdXN0IGhhbmRsZSB0aW1lcnMgYW5kIHN0YXR1cyBtYW51YWxseSBiZWNhdXNlIHdlIHNraXAgc3VwZXIudXBkYXRlKCkgdG8gdXNlIGN1c3RvbSBtb3ZlbWVudAogICAgICAgICAgICBpZiAodGhpcy5kYXNoQ29vbGRvd24gPiAwKSB0aGlzLmRhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuY2xhc2hDb29sZG93biA+IDApIHRoaXMuY2xhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCkgdGhpcy5zdHVuVGltZXIgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmltbXVuaXR5VGltZXIgPiAwKSB0aGlzLmltbXVuaXR5VGltZXIgLT0gZHQ7CgogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXMoZHQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5taXhlcikgdGhpcy5taXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlSFBCYXIoKTsKICAgICAgICAgICAgICAgIHRoaXMuX2NvbnN0cmFpbkJvdW5kcygpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDdXN0b20gTW92ZW1lbnQKICAgICAgICAgICAgdGhpcy5fZGVmZW5zZUxvZ2ljKGR0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBBbmltYXRpb24KICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlSFBCYXIoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuX2NvbnN0cmFpbkJvdW5kcygpOwogICAgICAgIH0KCl9jb25zdHJhaW5Cb3VuZHMoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3Qgc2lkZSA9IHRoaXMudGVhbSA/IHRoaXMudGVhbS5zaWRlIDogMTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFggQm91bmRzIChXaWR0aCBvZiBwZW5hbHR5IGFyZWEgKy8tIDEwbSkgLT4gSW5jcmVhc2VkIGZvciBtYXNzaXZlIGdvYWwKY29uc3QgeExpbWl0ID0gMjAuMDsgLy8gUmVkdWNlZCB3aWR0aCBvZiBnb2FsaWUgbW92ZW1lbnQKICAgICAgICAgICAgaWYgKHBvcy54ID4geExpbWl0KSB7IHBvcy54ID0geExpbWl0OyB0aGlzLnZlbG9jaXR5LnggPSAwOyB9CiAgICAgICAgICAgIGlmIChwb3MueCA8IC14TGltaXQpIHsgcG9zLnggPSAteExpbWl0OyB0aGlzLnZlbG9jaXR5LnggPSAwOyB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBZIEJvdW5kcwogICAgICAgICAgICBjb25zdCB5TGltaXQgPSAxMi4wOyAvLyBSZWR1Y2VkIGhlaWdodCBjZWlsaW5nCiAgICAgICAgICAgIGlmIChwb3MueSA+IHlMaW1pdCkgeyBwb3MueSA9IHlMaW1pdDsgdGhpcy52ZWxvY2l0eS55ID0gMDsgfQogICAgICAgICAgICBpZiAocG9zLnkgPCAteUxpbWl0KSB7IHBvcy55ID0gLXlMaW1pdDsgdGhpcy52ZWxvY2l0eS55ID0gMDsgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gWiBCb3VuZHMgKERlcHRoKQovLyBaIEJvdW5kcyAoRGVwdGgpCiAgICAgICAgICAgIC8vIEhvbWUgKFNpZGUgMSk6IEdvYWwgYXQgKzQ2LiBUcmlnZ2VyIGF0IDQ1LiBMaW1pdCB0byA0NS41LgogICAgICAgICAgICAvLyBBd2F5IChTaWRlIC0xKTogR29hbCBhdCAtNDYuIFRyaWdnZXIgYXQgLTQ1LiBMaW1pdCB0byAtNDUuNS4KICAgICAgICAgICAgaWYgKHNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IDQ1LjUpIHsgcG9zLnogPSA0NS41OyB0aGlzLnZlbG9jaXR5LnogPSAwOyB9CiAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAyMC4wKSB7IHBvcy56ID0gMjAuMDsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHBvcy56IDwgLTQ1LjUpIHsgcG9zLnogPSAtNDUuNTsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICAgICAgaWYgKHBvcy56ID4gLTIwLjApIHsgcG9zLnogPSAtMjAuMDsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKLy8gT3ZlcnJpZGUgdGhyb3dCYWxsIHRvIGZpeCAid2VhayB0aHJvdyIgaXNzdWUKLy8gT3ZlcnJpZGUgdGhyb3dCYWxsIHRvIGZpeCAid2VhayB0aHJvdyIgaXNzdWUKICAgICAgICB0aHJvd0JhbGwoYmFsbCwgZm9yY2VkVHlwZSA9IG51bGwsIHBvd2VyTXVsdGlwbGllciA9IDEuMCkgewogICAgICAgICAgICAvLyBHb2FsaWVzIGFsbW9zdCBhbHdheXMgUEFTUywgZXZlbiB3aGVuICJjbGVhcmluZyIgZm9yd2FyZC4KICAgICAgICAgICAgLy8gVGhlIGRlZmF1bHQgUGxheWVyIGxvZ2ljIHN3aXRjaGVzIHRvICdTSCcgKFNob290KSBpZiBhaW1pbmcgZm9yd2FyZCwgCiAgICAgICAgICAgIC8vIHdoaWNoIHVzZXMgdGhlIEdvYWxpZSdzIGxvd2VyIFNIIHN0YXQuIFdlIGZvcmNlIFBBIHVubGVzcyBzcGVjaWZpZWQuCiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBmb3JjZWRUeXBlIHx8ICdQQSc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBCT09TVDogQXBwbHkgYSBtdWx0aXBsaWVyIHRvIGVuc3VyZSB0aGUgZ29hbGllIGNhbiBjbGVhciB0aGUgYmFsbCB0byBtaWRmaWVsZC4KICAgICAgICAgICAgLy8gTkVSRkVEOiBSZWR1Y2VkIGZyb20gMS42IHRvIDEuMiB0byBwcmV2ZW50IGNyb3NzLW1hcCB0aHJvd3MgYXMgcGVyIHVzZXIgZmVlZGJhY2suCiAgICAgICAgICAgIGNvbnN0IGJvb3N0ID0gMS4yOwoKICAgICAgICAgICAgc3VwZXIudGhyb3dCYWxsKGJhbGwsIHR5cGUsIHBvd2VyTXVsdGlwbGllciAqIGJvb3N0KTsKICAgICAgICB9CgpfZGVmZW5zZUxvZ2ljKGR0KSB7CiAgICAgICAgICAgIC8vIDAuIEdhbWUgU3RhdGUgQ2hlY2sKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSAhPT0gJ2FjdGl2ZScpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIERldGVybWluZSBUaHJlYXQgU291cmNlCiAgICAgICAgICAgIGxldCB0aHJlYXRQb3MgPSBfYmFsbFBvczsKICAgICAgICAgICAgbGV0IGlzVGhyZWF0ID0gZmFsc2U7CmNvbnN0IG15R29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gNDYgOiAtNDY7CgogICAgICAgICAgICAvLyBDYXNlIEE6IEJhbGwgaXMgSGVsZCAoUHJlLXRocm93KQogICAgICAgICAgICBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2hlbGQnICYmIGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgdGhyZWF0UG9zID0gYmFsbC5ob2xkZXIubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgaG9sZGVyIGlzIGluIGF0dGFja2luZyBoYWxmIG9yIG5lYXIgZW5vdWdoCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5hYnModGhyZWF0UG9zLnogLSBteUdvYWxaKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9Hb2FsIDwgNDAuMCkgeyAvLyBJZiB0aGV5IGFyZSB3aXRoaW4gNDBtLCB0cmFjayB0aGVtCiAgICAgICAgICAgICAgICAgICAgaXNUaHJlYXQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IAogICAgICAgICAgICAvLyBDYXNlIEI6IEJhbGwgaXMgRnJlZSAoU2hvdC9QYXNzKQogICAgICAgICAgICBlbHNlIGlmIChiYWxsLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIHRocmVhdFBvcyA9IGJhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlyZWN0aW9uIENoZWNrCiAgICAgICAgICAgICAgICBjb25zdCBtb3ZpbmdUb3dhcmRzID0gKHRoaXMudGVhbS5zaWRlID09PSAxICYmIGJhbGwudmVsb2NpdHkueiA+IDApIHx8IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLnRlYW0uc2lkZSA9PT0gLTEgJiYgYmFsbC52ZWxvY2l0eS56IDwgMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFBvc2l0aW9uIENoZWNrCi8vIFBvc2l0aW9uIENoZWNrCiAgICAgICAgICAgICAgICBjb25zdCBpbkZyb250T2ZHb2FsID0gKHRoaXMudGVhbS5zaWRlID09PSAxICYmIHRocmVhdFBvcy56IDwgNDUuMCkgfHwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHRoaXMudGVhbS5zaWRlID09PSAtMSAmJiB0aHJlYXRQb3MueiA+IC00NS4wKTsKCiAgICAgICAgICAgICAgICBpc1RocmVhdCA9IG1vdmluZ1Rvd2FyZHMgJiYgaW5Gcm9udE9mR29hbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGlzVGhyZWF0KSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gUE9TSVRJT05JTkc6IEFOR0xFIENVVFRJTkcgLS0tCiAgICAgICAgICAgICAgICBfYmFsbFBvcy5jb3B5KHRocmVhdFBvcyk7IC8vIFVwZGF0ZSByZWZlcmVuY2UgZm9yIGxvb2tBdAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAxLiBDYWxjdWxhdGUgR29hbCBDZW50ZXIKLy8gMS4gQ2FsY3VsYXRlIEdvYWwgQ2VudGVyIChBZGp1c3RlZCBmb3IgWSBvZmZzZXQpCl9nb2FsQ2VudGVyLnNldCgwLCAtNC41LCBteUdvYWxaKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMi4gVmVjdG9yIGZyb20gR29hbCB0byBCYWxsCiAgICAgICAgICAgICAgICBfdGVtcFZlY0cuc3ViVmVjdG9ycyhfYmFsbFBvcywgX2dvYWxDZW50ZXIpOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IF90ZW1wVmVjRy5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjRy5ub3JtYWxpemUoKTsgLy8gTm93IGhvbGRzIGRpcmVjdGlvbgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAzLiBEZXRlcm1pbmUgRXh0ZW5zaW9uIChIb3cgZmFyIG91dCB0byBzdGVwKQogICAgICAgICAgICAgICAgLy8gQmFzZTogMS41bSBvZmYgbGluZS4KICAgICAgICAgICAgICAgIC8vIE1heDogNi4wbSBvZmYgbGluZSAoQ3V0dGluZyBhbmdsZSkuCiAgICAgICAgICAgICAgICAvLyBTY2FsZSBiYXNlZCBvbiBiYWxsIHByb3hpbWl0eTogQ2xvc2VyIGJhbGwgPSBNb3JlIGV4dGVuc2lvbiAodG8gYSBwb2ludCkKbGV0IGV4dGVuc2lvbiA9IDEuNTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMzAuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gMS4wIC0gKE1hdGgubWF4KDAsIGRpc3RUb0JhbGwgLSA1LjApIC8gMjUuMCk7IAogICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbiA9IDEuNSArICg0LjUgKiByYXRpbyk7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCi8vIFNhZmV0eTogRG9uJ3QgZ28gcGFzdCB0aGUgYmFsbCAoa2VlcCAxbSBidWZmZXIpCiAgICAgICAgICAgICAgICBleHRlbnNpb24gPSBNYXRoLm1pbihleHRlbnNpb24sIGRpc3RUb0JhbGwgLSAxLjApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyA0LiBDYWxjdWxhdGUgVGFyZ2V0IFBvc2l0aW9uIChCYXNlIEludGVyY2VwdGlvbikKICAgICAgICAgICAgICAgIF9nUG9zLmNvcHkoX2dvYWxDZW50ZXIpLmFkZChfdGVtcFZlY0cubXVsdGlwbHlTY2FsYXIoZXh0ZW5zaW9uKSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDUuIFZlcnRpY2FsIE92ZXJyaWRlIChKdW1wIHRvIG1lZXQgYmFsbCkKICAgICAgICAgICAgICAgIC8vIEV4cGxpY2l0bHkgc2V0IFkgdG8gbWF0Y2ggYmFsbCBoZWlnaHQgaWYgaXQncyBoaWdoCiAgICAgICAgICAgICAgICBpZiAoX2JhbGxQb3MueSA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIF9nUG9zLnkgPSBfYmFsbFBvcy55OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gMC41OyAvLyBEZWZhdWx0IHN0YW5jZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDYuIENsYW1wIHRvIEdvYWwgQm94IERpbWVuc2lvbnMgKExhdGVyYWwvVmVydGljYWwgTGltaXRzKQogICAgICAgICAgICAgICAgLy8gR29hbCBXaWR0aCAyMiAoKy8tIDExKSwgSGVpZ2h0IDE4ICgrLy0gOSkuCiAgICAgICAgICAgICAgICAvLyBBbGxvdyBzbGlnaHRseSBvdXRzaWRlIHBvc3RzIHRvIGNvdmVyIGFuZ2xlcy4KICAgICAgICAgICAgICAgIGNvbnN0IGNsYW1wWCA9IHRoaXMuZ29hbFdpZHRoICogMC42OyAvLyArLy0gMTMuMgpjb25zdCBjbGFtcFkgPSAxMi4wOyAvLyBSZWR1Y2VkIG1heCBqdW1wIGhlaWdodAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfZ1Bvcy54ID0gTWF0aC5tYXgoLWNsYW1wWCwgTWF0aC5taW4oY2xhbXBYLCBfZ1Bvcy54KSk7CiAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gTWF0aC5tYXgoLWNsYW1wWSwgTWF0aC5taW4oY2xhbXBZLCBfZ1Bvcy55KSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDYuIExlYWQgdGhlIGJhbGwgc2xpZ2h0bHkgaWYgaXQgaGFzIGxhdGVyYWwgdmVsb2NpdHkgKEFudGljaXBhdGlvbikKaWYgKGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDEuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFudGljaXBhdGlvbiA9IGJhbGwudmVsb2NpdHkuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigwLjI1KTsgLy8gMC4yNXMgbGVhZAogICAgICAgICAgICAgICAgICAgIGFudGljaXBhdGlvbi56ID0gMDsgLy8gT25seSBsYXRlcmFsIGxlYWQKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy5hZGQoYW50aWNpcGF0aW9uKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAppZiAodGhpcy50ZWFtLnNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy56ID0gTWF0aC5taW4oNDUuNSwgX2dQb3Mueik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9nUG9zLnogPSBNYXRoLm1heCgtNDUuNSwgX2dQb3Mueik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTW92ZSB0b3dhcmRzIHRhcmdldAogICAgICAgICAgICAgICAgY29uc3QgbW92ZURpciA9IF9nVmVjLnN1YlZlY3RvcnMoX2dQb3MsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9UYXJnZXQgPSBtb3ZlRGlyLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvVGFyZ2V0ID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgbW92ZURpci5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAvLyBCdXJzdCBzcGVlZCBmb3Igc2F2ZXMgaWYgYmFsbCBpcyBjbG9zZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHVyZ2VuY3kgPSAoZGlzdFRvQmFsbCA8IDEwLjApID8gMS41IDogMS4wOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gdGhpcy5tYXhTcGVlZCAqIHVyZ2VuY3k7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChtb3ZlRGlyLm11bHRpcGx5U2NhbGFyKHNwZWVkICogZHQpKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBGYWNlIGJhbGwKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KF9iYWxsUG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ3N3aW0nKSB0aGlzLnBsYXkoJ3N3aW0nLCAwLjIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ2lkbGUnKSB0aGlzLnBsYXkoJ2lkbGUnLCAwLjIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoX2JhbGxQb3MpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIC0tLSBTQVZFIE1FQ0hBTklDIC0tLQogICAgICAgICAgICAgICAgLy8gSWYgYmFsbCBpcyB3aXRoaW4gcmFuZ2UsIGFwcGx5IENBIHByZXNzdXJlCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgdGhpcy5zYXZlUmFkaXVzKSB7IAogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5U2F2ZVByZXNzdXJlKGJhbGwsIGR0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBJRExFIC8gUkVUVVJOIFRPIFBPU1QgLS0tCiAgICAgICAgICAgICAgICAvLyBSZXR1cm4gdG8gaG9tZSBwb3NpdGlvbiAodXN1YWxseSBjZW50ZXIgb2YgZ29hbCkKICAgICAgICAgICAgICAgIF9nUG9zLmNvcHkodGhpcy5ob21lUG9zaXRpb24pOwogICAgICAgICAgICAgICAgY29uc3QgbW92ZURpciA9IF9nVmVjLnN1YlZlY3RvcnMoX2dQb3MsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChtb3ZlRGlyLmxlbmd0aCgpID4gMC41KSB7CiAgICAgICAgICAgICAgICAgICAgbW92ZURpci5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKG1vdmVEaXIubXVsdGlwbHlTY2FsYXIodGhpcy5tYXhTcGVlZCAqIDAuNiAqIGR0KSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdzd2ltJykgdGhpcy5wbGF5KCdzd2ltJywgMC4yKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpZGxlJykgdGhpcy5wbGF5KCdpZGxlJywgMC4yKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmFjZSBjZW50ZXIgZmllbGQKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9hcHBseVNhdmVQcmVzc3VyZShiYWxsLCBkdCkgewogICAgICAgICAgICAvLyBJZiBHb2FsaWUgaXMgQXNsZWVwLCB0aGV5IGNhbm5vdCBzYXZlLgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gLS0tIFNVUEVSIEdPQUxJRSBUUklHR0VSIC0tLQogICAgICAgICAgICAvLyBUcmlnZ2VyIGlmOiBUZWNoIGVxdWlwcGVkLCBOb3QgYWN0aXZlLCBCYWxsIGhhcyBwb3dlciwgQmFsbCBpcyBjbG9zZQogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5hY3RpdmUgPT09ICdzdXBlcl9nb2FsaWUnICYmICF0aGlzLmlzU3VwZXJHb2FsaWUgJiYgYmFsbC5wb3dlciA+IDUuMCkgewogICAgICAgICAgICAgICAgLy8gQ2hhbmNlIHRvIHRyaWdnZXIgKEhpZ2ggY2hhbmNlIGZvciBBSSwgb3IgY2hlY2sgSFApCiAgICAgICAgICAgICAgICAvLyBDb3N0OiAxMCBIUAogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPj0gMTApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IDEwOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNTdXBlckdvYWxpZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyID0gMS41OyAvLyBMYXN0cyAxLjVzCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSB1c2VkIFNVUEVSIEdPQUxJRSFgKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTVVBFUiBHT0FMSUUhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic2F2ZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIFRlY2hjb3B5IEV2ZW50CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCh0aGlzLCAnc3VwZXJfZ29hbGllJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDYWxjdWxhdGUgRWZmZWN0aXZlIENBCiAgICAgICAgICAgIGxldCBjYSA9IHRoaXMuZ2V0U3RhdCgnQ0EnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IFN1cGVyIEdvYWxpZSBCb251cyAoZS5nLiArNTAlICsgRmxhdCAxMCkKICAgICAgICAgICAgaWYgKHRoaXMuaXNTdXBlckdvYWxpZSkgewogICAgICAgICAgICAgICAgY2EgPSAoY2EgKiAxLjUpICsgMTA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IEdyaXAgR2xvdmVzIChQYXNzaXZlKQogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5wYXNzaXZlID09PSAnZ3JpcF9nbG92ZXMnKSB7CiAgICAgICAgICAgICAgICBjYSArPSA1OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDYWxjdWxhdGUgUHJlc3N1cmUKICAgICAgICAgICAgLy8gUHJlc3N1cmUgPSBDQSAqIGR0ICogTXVsdGlwbGllcgogICAgICAgICAgICBjb25zdCBwcmVzc3VyZSA9IGNhICogZHQgKiB0aGlzLnByZXNzdXJlTXVsdGlwbGllcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlciAtPSBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrCiAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZFNhdmUgKz0gcHJlc3N1cmU7CiAgICAgICAgICAgICAgICAvLyBUSFJPVFRMRTogSW5jcmVhc2VkIHRocmVzaG9sZCB0byAxMi4wCiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYWNjdW11bGF0ZWRTYXZlID49IDEyLjApIHsgCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0shIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkU2F2ZSA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFwcGx5IEJhbGwgVGVjaG5pcXVlIHRvIEdvYWxpZSAoUmlzayBvZiBjYXRjaGluZyBzcGVjaWFsIHNob3RzKQogICAgICAgICAgICBpZiAoYmFsbC50ZWNobmlxdWUgJiYgIXRoaXMuX3RlY2hBcHBsaWVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLl90ZWNoQXBwbGllZCA9IHRydWU7CiAgICAgICAgICAgICAgICBjb25zdCB0ZWNoID0gYmFsbC50ZWNobmlxdWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZWNoLnR5cGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDE1LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICduYXAnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseVN0YXR1cygnbmFwJywgOC4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGVjaC50eXBlID09PSAnd2l0aGVyJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDE1LjAsICdDQScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IHRoaXMuX3RlY2hBcHBsaWVkID0gZmFsc2U7IH0sIDIwMDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayBSZXN1bHQKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCkgewogICAgICAgICAgICAgICAgLy8gQ0FUQ0gKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hCYWxsKGJhbGwpOwogICAgICAgICAgICB9IAogICAgICAgIH0KCiAgICAgICAgY2F0Y2hCYWxsKGJhbGwpIHsKICAgICAgICAgICAgYmFsbC5ncmFiKHRoaXMpOwogICAgICAgICAgICB0aGlzLnBsYXkoJ2NhdGNoJywgMC4xKTsKICAgICAgICAgICAgY29uc29sZS5sb2coIlNBVkVEIGJ5ICIgKyB0aGlzLnJvbGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRVhQIFJFV0FSRDogU2F2ZQogICAgICAgICAgICB0aGlzLmdhaW5FeHAoNSk7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0FWRUQhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjE1LCAnaGVhdnknKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IHRocm93IHRpbWVyCiAgICAgICAgICAgIHRoaXMudGhyb3dUaW1lciA9IDA7CiAgICAgICAgfQoKX2FpUG9zc2Vzc2lvbkxvZ2ljKGR0KSB7CiAgICAgICAgICAgIHRoaXMudGhyb3dUaW1lciArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhvbGQgZm9yIGEgbW9tZW50ICgxLjVzKSB0aGVuIHRocm93CiAgICAgICAgICAgIGlmICh0aGlzLnRocm93VGltZXIgPiAxLjUpIHsKICAgICAgICAgICAgICAgIC8vIEZpbmQgYmVzdCB0YXJnZXQ6IFByZWZlciBNRiBvciBEZWZlbmRlcnMsIGJ1dCBtdXN0IGJlIHNvbWV3aGF0IGRpc3RhbnQgdG8gYXZvaWQgImhhbmRvZmYiIGxvb2sKICAgICAgICAgICAgICAgIC8vIEZpbHRlciBmb3IgdGVhbW1hdGVzID4gOCB1bml0cyBhd2F5IGlmIHBvc3NpYmxlCiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZE1hdGVzID0gdGhpcy50ZWFtLnBsYXllcnMuZmlsdGVyKHAgPT4gCiAgICAgICAgICAgICAgICAgICAgcCAhPT0gdGhpcyAmJiAKICAgICAgICAgICAgICAgICAgICBwLm1lc2ggJiYgCiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5tZXNoLnBvc2l0aW9uKSA+IDguMAogICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eSAxOiBNaWRmaWVsZGVyIChQbGF5bWFrZXIpCiAgICAgICAgICAgICAgICB0YXJnZXQgPSB2YWxpZE1hdGVzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eSAyOiBEZWZlbmRlcnMKICAgICAgICAgICAgICAgIGlmICghdGFyZ2V0KSB0YXJnZXQgPSB2YWxpZE1hdGVzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdMRCcgfHwgcC5yb2xlID09PSAnUkQnKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUHJpb3JpdHkgMzogQW55b25lIG9wZW4gKGZhbGxiYWNrIHRvIGNsb3NlIHJhbmdlIGlmIG5vIG9uZSBpcyBmYXIpCiAgICAgICAgICAgICAgICBpZiAoIXRhcmdldCkgdGFyZ2V0ID0gdGhpcy50ZWFtLnBsYXllcnMuZmluZChwID0+IHAgIT09IHRoaXMgJiYgcC5yb2xlICE9PSAnR0wnKTsKCiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQUlNSU5HIExPR0lDOiBMb2Z0IHRoZSBwYXNzCiAgICAgICAgICAgICAgICAgICAgLy8gTG9vayBhdCB0YXJnZXQsIGJ1dCBhaW0gc2xpZ2h0bHkgdXAgdG8gY3JlYXRlIGFuIGFyYwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFBvcyA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGRpc3RhbmNlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldFBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gTG9mdCBmYWN0b3I6IFRoZSBmdXJ0aGVyIGF3YXksIHRoZSBoaWdoZXIgd2UgYWltCiAgICAgICAgICAgICAgICAgICAgLy8gMjAgdW5pdHMgYXdheSAtPiBBaW0gNSB1bml0cyBhYm92ZSBoZWFkCiAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9mdCA9IE1hdGgubWF4KDEuMCwgZGlzdCAqIDAuMjUpOwogICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy55ICs9IGxvZnQ7CgogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBUaHJvdwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCAnUEEnKTsgCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSB0aHJvd3MgdG8gJHt0YXJnZXQucm9sZX0gKERpc3Q6ICR7ZGlzdC50b0ZpeGVkKDEpfSlgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2xlYXIgaXQgZm9yd2FyZAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoMCwgNSwgMCk7IC8vIEFpbSB1cC1jZW50ZXIKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgJ1NIJyk7IC8vIEhhcmQgY2xlYXIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Hb2FsaWUgPSBHb2FsaWU7Cn0pKCk7","/Goalie.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgIAogICAgLy8gUmV1c2FibGUgdmVjdG9ycyB0byBhdm9pZCBHQwpjb25zdCBfZ1ZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ1BvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfYmFsbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZmFjZVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ29hbENlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlY0cgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEdvYWxpZSBleHRlbmRzIHdpbmRvdy5mbHV4LlBsYXllciB7CmNvbnN0cnVjdG9yKHNjZW5lLCByb2xlKSB7CiAgICAgICAgICAgIHN1cGVyKHNjZW5lLCByb2xlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdvYWxpZSBTcGVjaWZpYyBTdGF0cyAoQnVmZmVkIGZvciBQbGF5YWJpbGl0eSkKICAgICAgICAgICAgdGhpcy5zdGF0cy5DQSA9IDMwOyAvLyBDYXRjaAogICAgICAgICAgICB0aGlzLnN0YXRzLlNQID0gNDA7IC8vIFNwZWVkCiAgICAgICAgICAgIHRoaXMuc3RhdHMuRU4gPSA1MDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJVRkZFRDogU3Ryb25nIGFybSBmb3IgY2xlYXJpbmcgdGhlIHpvbmUKICAgICAgICAgICAgdGhpcy5zdGF0cy5QQSA9IDQ1OyAvLyBXYXMgMjAgLSBOb3cgc3Ryb25nIGVub3VnaCB0byByZWFjaCBtaWRmaWVsZAogICAgICAgICAgICB0aGlzLnN0YXRzLlNIID0gMzU7IC8vIFdhcyAxMCAtIERlY2VudCBjbGVhcmFuY2Uga2ljawogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CgogICAgICAgICAgICAvLyBHb2FsIERpbWVuc2lvbnMgKFNhdmUgQm94KQovLyBHb2FsIERpbWVuc2lvbnMgKFNhdmUgQm94KSAtIE1hdGNoZXMgR2FtZU1hbmFnZXIgZGV0ZWN0aW9uCi8vIEdvYWwgRGltZW5zaW9ucyAoU2F2ZSBCb3gpIC0gTWF0Y2hlcyBHYW1lTWFuYWdlciBkZXRlY3Rpb24KICAgICAgICAgICAgdGhpcy5nb2FsV2lkdGggPSAyMi4wOyAvLyBJbmNyZWFzZWQgdG8gbWF0Y2ggbmV3IGRldGVjdGlvbiBib3gKICAgICAgICAgICAgdGhpcy5nb2FsSGVpZ2h0ID0gMTguMDsgLy8gSW5jcmVhc2VkIHRvIG1hdGNoIG5ldyBkZXRlY3Rpb24gYm94CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTYXZlIE1lY2hhbmljcwogICAgICAgICAgICB0aGlzLnNhdmVSYWRpdXMgPSA2LjA7IAogICAgICAgICAgICB0aGlzLnByZXNzdXJlTXVsdGlwbGllciA9IDUuMDsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUZWNocwogICAgICAgICAgICB0aGlzLnRlY2hzID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBudWxsLCAKICAgICAgICAgICAgICAgIHBhc3NpdmU6IG51bGwgCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBSSBTdGF0ZQogICAgICAgICAgICB0aGlzLnRocm93VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZFNhdmUgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3VwZXIgR29hbGllIFN0YXRlCiAgICAgICAgICAgIHRoaXMuaXNTdXBlckdvYWxpZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnN1cGVyR29hbGllVGltZXIgPSAwOwogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICAvLyAxLiBTdXBlciBHb2FsaWUgVGltZXIKICAgICAgICAgICAgaWYgKHRoaXMuaXNTdXBlckdvYWxpZSkgewogICAgICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3VwZXJHb2FsaWVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1N1cGVyR29hbGllID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDIuIFBvc3Nlc3Npb24gTG9naWMgKEJhbGwgSGVsZCkKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVQcmVzc3VyZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBpc0h1bWFuQ29udHJvbGxlZCA9IHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uaXNIdW1hbiAmJiB0aGlzLnRlYW0uYWN0aXZlUGxheWVyID09PSB0aGlzICYmICFnYW1lLmlzRGVtb01vZGU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChpc0h1bWFuQ29udHJvbGxlZCkgewogICAgICAgICAgICAgICAgICAgIC8vIEh1bWFuOiBGdWxsIGNvbnRyb2wgKFJvdGF0aW9uLCBDaGFyZ2luZywgZXRjIHZpYSBQbGF5ZXIudXBkYXRlKQogICAgICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIEFJOiBMb2dpYyB0aGVuIHVwZGF0ZQogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2FpUG9zc2Vzc2lvbkxvZ2ljKGR0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIEFJIGRvZXNuJ3QgZHJpZnQKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIERlZmVuc2UgLyBTYXZlIExvZ2ljIChObyBCYWxsKQogICAgICAgICAgICAvLyBXZSBtdXN0IGhhbmRsZSB0aW1lcnMgYW5kIHN0YXR1cyBtYW51YWxseSBiZWNhdXNlIHdlIHNraXAgc3VwZXIudXBkYXRlKCkgdG8gdXNlIGN1c3RvbSBtb3ZlbWVudAogICAgICAgICAgICBpZiAodGhpcy5kYXNoQ29vbGRvd24gPiAwKSB0aGlzLmRhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuY2xhc2hDb29sZG93biA+IDApIHRoaXMuY2xhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCkgdGhpcy5zdHVuVGltZXIgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmltbXVuaXR5VGltZXIgPiAwKSB0aGlzLmltbXVuaXR5VGltZXIgLT0gZHQ7CgogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXMoZHQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5taXhlcikgdGhpcy5taXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlSFBCYXIoKTsKICAgICAgICAgICAgICAgIHRoaXMuX2NvbnN0cmFpbkJvdW5kcygpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDdXN0b20gTW92ZW1lbnQKICAgICAgICAgICAgdGhpcy5fZGVmZW5zZUxvZ2ljKGR0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBBbmltYXRpb24KICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlSFBCYXIoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuX2NvbnN0cmFpbkJvdW5kcygpOwogICAgICAgIH0KCl9jb25zdHJhaW5Cb3VuZHMoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3Qgc2lkZSA9IHRoaXMudGVhbSA/IHRoaXMudGVhbS5zaWRlIDogMTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFggQm91bmRzIChXaWR0aCBvZiBwZW5hbHR5IGFyZWEgKy8tIDEwbSkgLT4gSW5jcmVhc2VkIGZvciBtYXNzaXZlIGdvYWwKY29uc3QgeExpbWl0ID0gMjAuMDsgLy8gUmVkdWNlZCB3aWR0aCBvZiBnb2FsaWUgbW92ZW1lbnQKICAgICAgICAgICAgaWYgKHBvcy54ID4geExpbWl0KSB7IHBvcy54ID0geExpbWl0OyB0aGlzLnZlbG9jaXR5LnggPSAwOyB9CiAgICAgICAgICAgIGlmIChwb3MueCA8IC14TGltaXQpIHsgcG9zLnggPSAteExpbWl0OyB0aGlzLnZlbG9jaXR5LnggPSAwOyB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBZIEJvdW5kcwogICAgICAgICAgICBjb25zdCB5TGltaXQgPSAxMi4wOyAvLyBSZWR1Y2VkIGhlaWdodCBjZWlsaW5nCiAgICAgICAgICAgIGlmIChwb3MueSA+IHlMaW1pdCkgeyBwb3MueSA9IHlMaW1pdDsgdGhpcy52ZWxvY2l0eS55ID0gMDsgfQogICAgICAgICAgICBpZiAocG9zLnkgPCAteUxpbWl0KSB7IHBvcy55ID0gLXlMaW1pdDsgdGhpcy52ZWxvY2l0eS55ID0gMDsgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gWiBCb3VuZHMgKERlcHRoKQovLyBaIEJvdW5kcyAoRGVwdGgpCiAgICAgICAgICAgIC8vIEhvbWUgKFNpZGUgMSk6IEdvYWwgYXQgKzQ2LiBUcmlnZ2VyIGF0IDQ1LiBMaW1pdCB0byA0NS41LgogICAgICAgICAgICAvLyBBd2F5IChTaWRlIC0xKTogR29hbCBhdCAtNDYuIFRyaWdnZXIgYXQgLTQ1LiBMaW1pdCB0byAtNDUuNS4KICAgICAgICAgICAgaWYgKHNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IDQ1LjUpIHsgcG9zLnogPSA0NS41OyB0aGlzLnZlbG9jaXR5LnogPSAwOyB9CiAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAyMC4wKSB7IHBvcy56ID0gMjAuMDsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHBvcy56IDwgLTQ1LjUpIHsgcG9zLnogPSAtNDUuNTsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICAgICAgaWYgKHBvcy56ID4gLTIwLjApIHsgcG9zLnogPSAtMjAuMDsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKLy8gT3ZlcnJpZGUgdGhyb3dCYWxsIHRvIGZpeCAid2VhayB0aHJvdyIgaXNzdWUKLy8gT3ZlcnJpZGUgdGhyb3dCYWxsIHRvIGZpeCAid2VhayB0aHJvdyIgaXNzdWUKICAgICAgICB0aHJvd0JhbGwoYmFsbCwgZm9yY2VkVHlwZSA9IG51bGwsIHBvd2VyTXVsdGlwbGllciA9IDEuMCkgewogICAgICAgICAgICAvLyBHb2FsaWVzIGFsbW9zdCBhbHdheXMgUEFTUywgZXZlbiB3aGVuICJjbGVhcmluZyIgZm9yd2FyZC4KICAgICAgICAgICAgLy8gVGhlIGRlZmF1bHQgUGxheWVyIGxvZ2ljIHN3aXRjaGVzIHRvICdTSCcgKFNob290KSBpZiBhaW1pbmcgZm9yd2FyZCwgCiAgICAgICAgICAgIC8vIHdoaWNoIHVzZXMgdGhlIEdvYWxpZSdzIGxvd2VyIFNIIHN0YXQuIFdlIGZvcmNlIFBBIHVubGVzcyBzcGVjaWZpZWQuCiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBmb3JjZWRUeXBlIHx8ICdQQSc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBCT09TVDogQXBwbHkgYSBtdWx0aXBsaWVyIHRvIGVuc3VyZSB0aGUgZ29hbGllIGNhbiBjbGVhciB0aGUgYmFsbCB0byBtaWRmaWVsZC4KICAgICAgICAgICAgLy8gTkVSRkVEOiBSZWR1Y2VkIGZyb20gMS42IHRvIDEuMiB0byBwcmV2ZW50IGNyb3NzLW1hcCB0aHJvd3MgYXMgcGVyIHVzZXIgZmVlZGJhY2suCiAgICAgICAgICAgIGNvbnN0IGJvb3N0ID0gMS4yOwoKICAgICAgICAgICAgc3VwZXIudGhyb3dCYWxsKGJhbGwsIHR5cGUsIHBvd2VyTXVsdGlwbGllciAqIGJvb3N0KTsKICAgICAgICB9CgpfZGVmZW5zZUxvZ2ljKGR0KSB7CiAgICAgICAgICAgIC8vIDAuIEdhbWUgU3RhdGUgQ2hlY2sKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSAhPT0gJ2FjdGl2ZScpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIERldGVybWluZSBUaHJlYXQgU291cmNlCiAgICAgICAgICAgIGxldCB0aHJlYXRQb3MgPSBfYmFsbFBvczsKICAgICAgICAgICAgbGV0IGlzVGhyZWF0ID0gZmFsc2U7CmNvbnN0IG15R29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gNDYgOiAtNDY7CgogICAgICAgICAgICAvLyBDYXNlIEE6IEJhbGwgaXMgSGVsZCAoUHJlLXRocm93KQogICAgICAgICAgICBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2hlbGQnICYmIGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgdGhyZWF0UG9zID0gYmFsbC5ob2xkZXIubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgaG9sZGVyIGlzIGluIGF0dGFja2luZyBoYWxmIG9yIG5lYXIgZW5vdWdoCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5hYnModGhyZWF0UG9zLnogLSBteUdvYWxaKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9Hb2FsIDwgNDAuMCkgeyAvLyBJZiB0aGV5IGFyZSB3aXRoaW4gNDBtLCB0cmFjayB0aGVtCiAgICAgICAgICAgICAgICAgICAgaXNUaHJlYXQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IAogICAgICAgICAgICAvLyBDYXNlIEI6IEJhbGwgaXMgRnJlZSAoU2hvdC9QYXNzKQogICAgICAgICAgICBlbHNlIGlmIChiYWxsLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIHRocmVhdFBvcyA9IGJhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlyZWN0aW9uIENoZWNrCiAgICAgICAgICAgICAgICBjb25zdCBtb3ZpbmdUb3dhcmRzID0gKHRoaXMudGVhbS5zaWRlID09PSAxICYmIGJhbGwudmVsb2NpdHkueiA+IDApIHx8IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLnRlYW0uc2lkZSA9PT0gLTEgJiYgYmFsbC52ZWxvY2l0eS56IDwgMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFBvc2l0aW9uIENoZWNrCi8vIFBvc2l0aW9uIENoZWNrCiAgICAgICAgICAgICAgICBjb25zdCBpbkZyb250T2ZHb2FsID0gKHRoaXMudGVhbS5zaWRlID09PSAxICYmIHRocmVhdFBvcy56IDwgNDUuMCkgfHwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHRoaXMudGVhbS5zaWRlID09PSAtMSAmJiB0aHJlYXRQb3MueiA+IC00NS4wKTsKCiAgICAgICAgICAgICAgICBpc1RocmVhdCA9IG1vdmluZ1Rvd2FyZHMgJiYgaW5Gcm9udE9mR29hbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGlzVGhyZWF0KSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gUE9TSVRJT05JTkc6IEFOR0xFIENVVFRJTkcgLS0tCiAgICAgICAgICAgICAgICBfYmFsbFBvcy5jb3B5KHRocmVhdFBvcyk7IC8vIFVwZGF0ZSByZWZlcmVuY2UgZm9yIGxvb2tBdAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAxLiBDYWxjdWxhdGUgR29hbCBDZW50ZXIKLy8gMS4gQ2FsY3VsYXRlIEdvYWwgQ2VudGVyIChBZGp1c3RlZCBmb3IgWSBvZmZzZXQpCl9nb2FsQ2VudGVyLnNldCgwLCAtNC41LCBteUdvYWxaKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMi4gVmVjdG9yIGZyb20gR29hbCB0byBCYWxsCiAgICAgICAgICAgICAgICBfdGVtcFZlY0cuc3ViVmVjdG9ycyhfYmFsbFBvcywgX2dvYWxDZW50ZXIpOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IF90ZW1wVmVjRy5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjRy5ub3JtYWxpemUoKTsgLy8gTm93IGhvbGRzIGRpcmVjdGlvbgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAzLiBEZXRlcm1pbmUgRXh0ZW5zaW9uIChIb3cgZmFyIG91dCB0byBzdGVwKQogICAgICAgICAgICAgICAgLy8gQmFzZTogMS41bSBvZmYgbGluZS4KICAgICAgICAgICAgICAgIC8vIE1heDogNi4wbSBvZmYgbGluZSAoQ3V0dGluZyBhbmdsZSkuCiAgICAgICAgICAgICAgICAvLyBTY2FsZSBiYXNlZCBvbiBiYWxsIHByb3hpbWl0eTogQ2xvc2VyIGJhbGwgPSBNb3JlIGV4dGVuc2lvbiAodG8gYSBwb2ludCkKbGV0IGV4dGVuc2lvbiA9IDEuNTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMzAuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gMS4wIC0gKE1hdGgubWF4KDAsIGRpc3RUb0JhbGwgLSA1LjApIC8gMjUuMCk7IAogICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbiA9IDEuNSArICg0LjUgKiByYXRpbyk7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCi8vIFNhZmV0eTogRG9uJ3QgZ28gcGFzdCB0aGUgYmFsbCAoa2VlcCAxbSBidWZmZXIpCiAgICAgICAgICAgICAgICBleHRlbnNpb24gPSBNYXRoLm1pbihleHRlbnNpb24sIGRpc3RUb0JhbGwgLSAxLjApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyA0LiBDYWxjdWxhdGUgVGFyZ2V0IFBvc2l0aW9uIChCYXNlIEludGVyY2VwdGlvbikKICAgICAgICAgICAgICAgIF9nUG9zLmNvcHkoX2dvYWxDZW50ZXIpLmFkZChfdGVtcFZlY0cubXVsdGlwbHlTY2FsYXIoZXh0ZW5zaW9uKSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDUuIFZlcnRpY2FsIE92ZXJyaWRlIChKdW1wIHRvIG1lZXQgYmFsbCkKICAgICAgICAgICAgICAgIC8vIEV4cGxpY2l0bHkgc2V0IFkgdG8gbWF0Y2ggYmFsbCBoZWlnaHQgaWYgaXQncyBoaWdoCiAgICAgICAgICAgICAgICBpZiAoX2JhbGxQb3MueSA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIF9nUG9zLnkgPSBfYmFsbFBvcy55OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gMC41OyAvLyBEZWZhdWx0IHN0YW5jZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDYuIENsYW1wIHRvIEdvYWwgQm94IERpbWVuc2lvbnMgKExhdGVyYWwvVmVydGljYWwgTGltaXRzKQogICAgICAgICAgICAgICAgLy8gR29hbCBXaWR0aCAyMiAoKy8tIDExKSwgSGVpZ2h0IDE4ICgrLy0gOSkuCiAgICAgICAgICAgICAgICAvLyBBbGxvdyBzbGlnaHRseSBvdXRzaWRlIHBvc3RzIHRvIGNvdmVyIGFuZ2xlcy4KICAgICAgICAgICAgICAgIGNvbnN0IGNsYW1wWCA9IHRoaXMuZ29hbFdpZHRoICogMC42OyAvLyArLy0gMTMuMgpjb25zdCBjbGFtcFkgPSAxMi4wOyAvLyBSZWR1Y2VkIG1heCBqdW1wIGhlaWdodAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfZ1Bvcy54ID0gTWF0aC5tYXgoLWNsYW1wWCwgTWF0aC5taW4oY2xhbXBYLCBfZ1Bvcy54KSk7CiAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gTWF0aC5tYXgoLWNsYW1wWSwgTWF0aC5taW4oY2xhbXBZLCBfZ1Bvcy55KSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDYuIExlYWQgdGhlIGJhbGwgc2xpZ2h0bHkgaWYgaXQgaGFzIGxhdGVyYWwgdmVsb2NpdHkgKEFudGljaXBhdGlvbikKaWYgKGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDEuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFudGljaXBhdGlvbiA9IGJhbGwudmVsb2NpdHkuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigwLjI1KTsgLy8gMC4yNXMgbGVhZAogICAgICAgICAgICAgICAgICAgIGFudGljaXBhdGlvbi56ID0gMDsgLy8gT25seSBsYXRlcmFsIGxlYWQKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy5hZGQoYW50aWNpcGF0aW9uKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAppZiAodGhpcy50ZWFtLnNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy56ID0gTWF0aC5taW4oNDUuNSwgX2dQb3Mueik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9nUG9zLnogPSBNYXRoLm1heCgtNDUuNSwgX2dQb3Mueik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTW92ZSB0b3dhcmRzIHRhcmdldAogICAgICAgICAgICAgICAgY29uc3QgbW92ZURpciA9IF9nVmVjLnN1YlZlY3RvcnMoX2dQb3MsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9UYXJnZXQgPSBtb3ZlRGlyLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvVGFyZ2V0ID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgbW92ZURpci5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAvLyBCdXJzdCBzcGVlZCBmb3Igc2F2ZXMgaWYgYmFsbCBpcyBjbG9zZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHVyZ2VuY3kgPSAoZGlzdFRvQmFsbCA8IDEwLjApID8gMS41IDogMS4wOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gdGhpcy5tYXhTcGVlZCAqIHVyZ2VuY3k7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChtb3ZlRGlyLm11bHRpcGx5U2NhbGFyKHNwZWVkICogZHQpKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBGYWNlIGJhbGwKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KF9iYWxsUG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ3N3aW0nKSB0aGlzLnBsYXkoJ3N3aW0nLCAwLjIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ2lkbGUnKSB0aGlzLnBsYXkoJ2lkbGUnLCAwLjIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoX2JhbGxQb3MpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIC0tLSBTQVZFIE1FQ0hBTklDIC0tLQogICAgICAgICAgICAgICAgLy8gSWYgYmFsbCBpcyB3aXRoaW4gcmFuZ2UsIGFwcGx5IENBIHByZXNzdXJlCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgdGhpcy5zYXZlUmFkaXVzKSB7IAogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5U2F2ZVByZXNzdXJlKGJhbGwsIGR0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBJRExFIC8gUkVUVVJOIFRPIFBPU1QgLS0tCiAgICAgICAgICAgICAgICAvLyBSZXR1cm4gdG8gaG9tZSBwb3NpdGlvbiAodXN1YWxseSBjZW50ZXIgb2YgZ29hbCkKICAgICAgICAgICAgICAgIF9nUG9zLmNvcHkodGhpcy5ob21lUG9zaXRpb24pOwogICAgICAgICAgICAgICAgY29uc3QgbW92ZURpciA9IF9nVmVjLnN1YlZlY3RvcnMoX2dQb3MsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChtb3ZlRGlyLmxlbmd0aCgpID4gMC41KSB7CiAgICAgICAgICAgICAgICAgICAgbW92ZURpci5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKG1vdmVEaXIubXVsdGlwbHlTY2FsYXIodGhpcy5tYXhTcGVlZCAqIDAuNiAqIGR0KSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdzd2ltJykgdGhpcy5wbGF5KCdzd2ltJywgMC4yKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpZGxlJykgdGhpcy5wbGF5KCdpZGxlJywgMC4yKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmFjZSBjZW50ZXIgZmllbGQKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9hcHBseVNhdmVQcmVzc3VyZShiYWxsLCBkdCkgewogICAgICAgICAgICAvLyBJZiBHb2FsaWUgaXMgQXNsZWVwLCB0aGV5IGNhbm5vdCBzYXZlLgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gLS0tIFNVUEVSIEdPQUxJRSBUUklHR0VSIC0tLQogICAgICAgICAgICAvLyBUcmlnZ2VyIGlmOiBUZWNoIGVxdWlwcGVkLCBOb3QgYWN0aXZlLCBCYWxsIGhhcyBwb3dlciwgQmFsbCBpcyBjbG9zZQogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5hY3RpdmUgPT09ICdzdXBlcl9nb2FsaWUnICYmICF0aGlzLmlzU3VwZXJHb2FsaWUgJiYgYmFsbC5wb3dlciA+IDUuMCkgewogICAgICAgICAgICAgICAgLy8gQ2hhbmNlIHRvIHRyaWdnZXIgKEhpZ2ggY2hhbmNlIGZvciBBSSwgb3IgY2hlY2sgSFApCiAgICAgICAgICAgICAgICAvLyBDb3N0OiAxMCBIUAogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPj0gMTApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IDEwOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNTdXBlckdvYWxpZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyID0gMS41OyAvLyBMYXN0cyAxLjVzCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSB1c2VkIFNVUEVSIEdPQUxJRSFgKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTVVBFUiBHT0FMSUUhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic2F2ZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIFRlY2hjb3B5IEV2ZW50CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCh0aGlzLCAnc3VwZXJfZ29hbGllJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDYWxjdWxhdGUgRWZmZWN0aXZlIENBCiAgICAgICAgICAgIGxldCBjYSA9IHRoaXMuZ2V0U3RhdCgnQ0EnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IFN1cGVyIEdvYWxpZSBCb251cyAoZS5nLiArNTAlICsgRmxhdCAxMCkKICAgICAgICAgICAgaWYgKHRoaXMuaXNTdXBlckdvYWxpZSkgewogICAgICAgICAgICAgICAgY2EgPSAoY2EgKiAxLjUpICsgMTA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IEdyaXAgR2xvdmVzIChQYXNzaXZlKQogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5wYXNzaXZlID09PSAnZ3JpcF9nbG92ZXMnKSB7CiAgICAgICAgICAgICAgICBjYSArPSA1OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDYWxjdWxhdGUgUHJlc3N1cmUKICAgICAgICAgICAgLy8gUHJlc3N1cmUgPSBDQSAqIGR0ICogTXVsdGlwbGllcgogICAgICAgICAgICBjb25zdCBwcmVzc3VyZSA9IGNhICogZHQgKiB0aGlzLnByZXNzdXJlTXVsdGlwbGllcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlciAtPSBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrCiAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZFNhdmUgKz0gcHJlc3N1cmU7CiAgICAgICAgICAgICAgICAvLyBUSFJPVFRMRTogSW5jcmVhc2VkIHRocmVzaG9sZCB0byAxMi4wCiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYWNjdW11bGF0ZWRTYXZlID49IDEyLjApIHsgCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0shIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkU2F2ZSA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFwcGx5IEJhbGwgVGVjaG5pcXVlIHRvIEdvYWxpZSAoUmlzayBvZiBjYXRjaGluZyBzcGVjaWFsIHNob3RzKQogICAgICAgICAgICBpZiAoYmFsbC50ZWNobmlxdWUgJiYgIXRoaXMuX3RlY2hBcHBsaWVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLl90ZWNoQXBwbGllZCA9IHRydWU7CiAgICAgICAgICAgICAgICBjb25zdCB0ZWNoID0gYmFsbC50ZWNobmlxdWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZWNoLnR5cGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDE1LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICduYXAnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseVN0YXR1cygnbmFwJywgOC4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGVjaC50eXBlID09PSAnd2l0aGVyJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDE1LjAsICdDQScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IHRoaXMuX3RlY2hBcHBsaWVkID0gZmFsc2U7IH0sIDIwMDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayBSZXN1bHQKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCkgewogICAgICAgICAgICAgICAgLy8gQ0FUQ0gKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hCYWxsKGJhbGwpOwogICAgICAgICAgICB9IAogICAgICAgIH0KCiAgICAgICAgY2F0Y2hCYWxsKGJhbGwpIHsKICAgICAgICAgICAgYmFsbC5ncmFiKHRoaXMpOwogICAgICAgICAgICB0aGlzLnBsYXkoJ2NhdGNoJywgMC4xKTsKICAgICAgICAgICAgY29uc29sZS5sb2coIlNBVkVEIGJ5ICIgKyB0aGlzLnJvbGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRVhQIFJFV0FSRDogU2F2ZQogICAgICAgICAgICB0aGlzLmdhaW5FeHAoNSk7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0FWRUQhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjE1LCAnaGVhdnknKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IHRocm93IHRpbWVyCiAgICAgICAgICAgIHRoaXMudGhyb3dUaW1lciA9IDA7CiAgICAgICAgfQoKX2FpUG9zc2Vzc2lvbkxvZ2ljKGR0KSB7CiAgICAgICAgICAgIHRoaXMudGhyb3dUaW1lciArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhvbGQgZm9yIGEgbW9tZW50ICgxLjVzKSB0aGVuIHRocm93CiAgICAgICAgICAgIGlmICh0aGlzLnRocm93VGltZXIgPiAxLjUpIHsKICAgICAgICAgICAgICAgIC8vIEZpbmQgYmVzdCB0YXJnZXQ6IFByZWZlciBNRiBvciBEZWZlbmRlcnMsIGJ1dCBtdXN0IGJlIHNvbWV3aGF0IGRpc3RhbnQgdG8gYXZvaWQgImhhbmRvZmYiIGxvb2sKICAgICAgICAgICAgICAgIC8vIEZpbHRlciBmb3IgdGVhbW1hdGVzID4gOCB1bml0cyBhd2F5IGlmIHBvc3NpYmxlCiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZE1hdGVzID0gdGhpcy50ZWFtLnBsYXllcnMuZmlsdGVyKHAgPT4gCiAgICAgICAgICAgICAgICAgICAgcCAhPT0gdGhpcyAmJiAKICAgICAgICAgICAgICAgICAgICBwLm1lc2ggJiYgCiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5tZXNoLnBvc2l0aW9uKSA+IDguMAogICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eSAxOiBNaWRmaWVsZGVyIChQbGF5bWFrZXIpCiAgICAgICAgICAgICAgICB0YXJnZXQgPSB2YWxpZE1hdGVzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eSAyOiBEZWZlbmRlcnMKICAgICAgICAgICAgICAgIGlmICghdGFyZ2V0KSB0YXJnZXQgPSB2YWxpZE1hdGVzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdMRCcgfHwgcC5yb2xlID09PSAnUkQnKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUHJpb3JpdHkgMzogQW55b25lIG9wZW4gKGZhbGxiYWNrIHRvIGNsb3NlIHJhbmdlIGlmIG5vIG9uZSBpcyBmYXIpCiAgICAgICAgICAgICAgICBpZiAoIXRhcmdldCkgdGFyZ2V0ID0gdGhpcy50ZWFtLnBsYXllcnMuZmluZChwID0+IHAgIT09IHRoaXMgJiYgcC5yb2xlICE9PSAnR0wnKTsKCiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQUlNSU5HIExPR0lDOiBMb2Z0IHRoZSBwYXNzCiAgICAgICAgICAgICAgICAgICAgLy8gTG9vayBhdCB0YXJnZXQsIGJ1dCBhaW0gc2xpZ2h0bHkgdXAgdG8gY3JlYXRlIGFuIGFyYwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFBvcyA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGRpc3RhbmNlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldFBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gTG9mdCBmYWN0b3I6IFRoZSBmdXJ0aGVyIGF3YXksIHRoZSBoaWdoZXIgd2UgYWltCiAgICAgICAgICAgICAgICAgICAgLy8gMjAgdW5pdHMgYXdheSAtPiBBaW0gNSB1bml0cyBhYm92ZSBoZWFkCiAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9mdCA9IE1hdGgubWF4KDEuMCwgZGlzdCAqIDAuMjUpOwogICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy55ICs9IGxvZnQ7CgogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBUaHJvdwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCAnUEEnKTsgCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSB0aHJvd3MgdG8gJHt0YXJnZXQucm9sZX0gKERpc3Q6ICR7ZGlzdC50b0ZpeGVkKDEpfSlgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2xlYXIgaXQgZm9yd2FyZAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoMCwgNSwgMCk7IC8vIEFpbSB1cC1jZW50ZXIKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgJ1NIJyk7IC8vIEhhcmQgY2xlYXIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Hb2FsaWUgPSBHb2FsaWU7Cn0pKCk7","MiniMap.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNaW5pTWFwIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcCcpOwogICAgICAgICAgICB0aGlzLmRvdHMgPSBuZXcgTWFwKCk7IC8vIE1hcCBlbnRpdHkgdG8gRE9NIGVsZW1lbnQKICAgICAgICAgICAgdGhpcy53aWR0aCA9IDEwMDsgLy8gTWF0Y2hlcyBDU1Mgd2lkdGgKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSAxMDA7IC8vIE1hdGNoZXMgQ1NTIGhlaWdodAogICAgICAgICAgICB0aGlzLndvcmxkUmFkaXVzID0gMzA7IC8vIEFyZW5hIHJhZGl1cwogICAgICAgIH0KCiAgICAgICAgcmVnaXN0ZXIoZW50aXR5LCB0eXBlKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICBkb3QuY2xhc3NOYW1lID0gYG1hcC1kb3QgJHt0eXBlfWA7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZENoaWxkKGRvdCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmRvdHMuc2V0KGVudGl0eSwgZG90KTsKICAgICAgICB9CgogICAgICAgIGluaXQoaG9tZVRlYW0sIGF3YXlUZWFtLCBiYWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuaW5uZXJIVE1MID0gJyc7IC8vIENsZWFyIGV4aXN0aW5nCiAgICAgICAgICAgIHRoaXMuZG90cy5jbGVhcigpOwoKICAgICAgICAgICAgLy8gUmVnaXN0ZXIgSG9tZSBUZWFtCiAgICAgICAgICAgIGhvbWVUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHRoaXMucmVnaXN0ZXIocCwgJ2hvbWUnKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZWdpc3RlciBBd2F5IFRlYW0KICAgICAgICAgICAgYXdheVRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gdGhpcy5yZWdpc3RlcihwLCAnYXdheScpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlZ2lzdGVyIEJhbGwKICAgICAgICAgICAgdGhpcy5yZWdpc3RlcihiYWxsLCAnYmFsbCcpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBoYWxmVyA9IHRoaXMud2lkdGggLyAyOwogICAgICAgICAgICBjb25zdCBoYWxmSCA9IHRoaXMuaGVpZ2h0IC8gMjsKICAgICAgICAgICAgLy8gU2NhbGU6IE1hcCBSYWRpdXMgKDUwcHgpIC8gV29ybGQgUmFkaXVzICgzMCB1bml0cykKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSBoYWxmVyAvIHRoaXMud29ybGRSYWRpdXM7IAoKZm9yIChjb25zdCBbZW50aXR5LCBkb3RdIG9mIHRoaXMuZG90cykgewogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgLy8gSW52aXNpYmxlIEJhbGwgTG9naWMKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuaXNJbnZpc2libGUpIHsKICAgICAgICAgICAgICAgICAgICBkb3Quc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZG90LnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gZW50aXR5Lm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE1hcCBMb2dpYzoKICAgICAgICAgICAgICAgIC8vIFdvcmxkIFogaXMgVXAvRG93bi4gLVogaXMgVG9wIChBdHRhY2sgRGlyZWN0aW9uIGZvciBIb21lKSwgK1ogaXMgQm90dG9tLgogICAgICAgICAgICAgICAgLy8gV29ybGQgWCBpcyBMZWZ0L1JpZ2h0LgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgcmF3IHBvc2l0aW9uIHJlbGF0aXZlIHRvIGNlbnRlcgogICAgICAgICAgICAgICAgbGV0IGR4ID0gcG9zLnggKiBzY2FsZTsKICAgICAgICAgICAgICAgIGxldCBkeSA9IHBvcy56ICogc2NhbGU7CgogICAgICAgICAgICAgICAgLy8gQ2xhbXAgdG8gY2lyY2xlIChrZWVwIGRvdHMgaW5zaWRlIHRoZSBtYXApCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwogICAgICAgICAgICAgICAgY29uc3QgbWF4RGlzdCA9IGhhbGZXIC0gMjsgLy8gLTIgZm9yIGRvdCByYWRpdXMgcGFkZGluZwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguYXRhbjIoZHksIGR4KTsKICAgICAgICAgICAgICAgICAgICBkeCA9IE1hdGguY29zKGFuZ2xlKSAqIG1heERpc3Q7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBNYXRoLnNpbihhbmdsZSkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENvbnZlcnQgdG8gQ1NTIGNvb3JkaW5hdGVzICgwLDAgaXMgVG9wLUxlZnQpCiAgICAgICAgICAgICAgICAvLyBDZW50ZXIgaXMgKDUwLCA1MCkKICAgICAgICAgICAgICAgIGNvbnN0IGNzc1ggPSBoYWxmVyArIGR4OwogICAgICAgICAgICAgICAgY29uc3QgY3NzWSA9IGhhbGZIICsgZHk7CgogICAgICAgICAgICAgICAgZG90LnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHtjc3NYfXB4LCAke2Nzc1l9cHgpYDsKICAgICAgICAgICAgICAgIAovLyBTdGF0dXMgVXBkYXRlcwogICAgICAgICAgICAgICAgaWYgKGVudGl0eS5zdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgICAvLyBOYXAgKFNsZWVwKSB0dXJucyBkb3QgZGFyay9ibGFjawogICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkb3QuY2xhc3NMaXN0LmNvbnRhaW5zKCduYXAnKSkgZG90LmNsYXNzTGlzdC5hZGQoJ25hcCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb3QuY2xhc3NMaXN0LmNvbnRhaW5zKCduYXAnKSkgZG90LmNsYXNzTGlzdC5yZW1vdmUoJ25hcCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBY3RpdmUgUGxheWVyIE1hcmtlciAoR3JlZW4pCi8vIEFjdGl2ZSBQbGF5ZXIgTWFya2VyIChHcmVlbikKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IChnYW1lICYmIGdhbWUudGVhbXMuaG9tZSAmJiBnYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyID09PSBlbnRpdHkpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWRvdC5jbGFzc0xpc3QuY29udGFpbnMoJ2FjdGl2ZS1wbGF5ZXInKSkgZG90LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZS1wbGF5ZXInKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvdC5jbGFzc0xpc3QuY29udGFpbnMoJ2FjdGl2ZS1wbGF5ZXInKSkgZG90LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZS1wbGF5ZXInKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBCYWxsIENhcnJpZXIgTWFya2VyIChHbG93KQogICAgICAgICAgICAgICAgaWYgKGVudGl0eS5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFkb3QuY2xhc3NMaXN0LmNvbnRhaW5zKCdiYWxsLWNhcnJpZXInKSkgZG90LmNsYXNzTGlzdC5hZGQoJ2JhbGwtY2FycmllcicpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZG90LmNsYXNzTGlzdC5jb250YWlucygnYmFsbC1jYXJyaWVyJykpIGRvdC5jbGFzc0xpc3QucmVtb3ZlKCdiYWxsLWNhcnJpZXInKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgICAgICAgICAgCgogICAgCgogICAgd2luZG93LmZsdXguTWluaU1hcCA9IE1pbmlNYXA7Cn0pKCk7","./MiniMap.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNaW5pTWFwIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcCcpOwogICAgICAgICAgICB0aGlzLmRvdHMgPSBuZXcgTWFwKCk7IC8vIE1hcCBlbnRpdHkgdG8gRE9NIGVsZW1lbnQKICAgICAgICAgICAgdGhpcy53aWR0aCA9IDEwMDsgLy8gTWF0Y2hlcyBDU1Mgd2lkdGgKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSAxMDA7IC8vIE1hdGNoZXMgQ1NTIGhlaWdodAogICAgICAgICAgICB0aGlzLndvcmxkUmFkaXVzID0gMzA7IC8vIEFyZW5hIHJhZGl1cwogICAgICAgIH0KCiAgICAgICAgcmVnaXN0ZXIoZW50aXR5LCB0eXBlKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICBkb3QuY2xhc3NOYW1lID0gYG1hcC1kb3QgJHt0eXBlfWA7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZENoaWxkKGRvdCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmRvdHMuc2V0KGVudGl0eSwgZG90KTsKICAgICAgICB9CgogICAgICAgIGluaXQoaG9tZVRlYW0sIGF3YXlUZWFtLCBiYWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuaW5uZXJIVE1MID0gJyc7IC8vIENsZWFyIGV4aXN0aW5nCiAgICAgICAgICAgIHRoaXMuZG90cy5jbGVhcigpOwoKICAgICAgICAgICAgLy8gUmVnaXN0ZXIgSG9tZSBUZWFtCiAgICAgICAgICAgIGhvbWVUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHRoaXMucmVnaXN0ZXIocCwgJ2hvbWUnKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZWdpc3RlciBBd2F5IFRlYW0KICAgICAgICAgICAgYXdheVRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gdGhpcy5yZWdpc3RlcihwLCAnYXdheScpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlZ2lzdGVyIEJhbGwKICAgICAgICAgICAgdGhpcy5yZWdpc3RlcihiYWxsLCAnYmFsbCcpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBoYWxmVyA9IHRoaXMud2lkdGggLyAyOwogICAgICAgICAgICBjb25zdCBoYWxmSCA9IHRoaXMuaGVpZ2h0IC8gMjsKICAgICAgICAgICAgLy8gU2NhbGU6IE1hcCBSYWRpdXMgKDUwcHgpIC8gV29ybGQgUmFkaXVzICgzMCB1bml0cykKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSBoYWxmVyAvIHRoaXMud29ybGRSYWRpdXM7IAoKZm9yIChjb25zdCBbZW50aXR5LCBkb3RdIG9mIHRoaXMuZG90cykgewogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgLy8gSW52aXNpYmxlIEJhbGwgTG9naWMKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuaXNJbnZpc2libGUpIHsKICAgICAgICAgICAgICAgICAgICBkb3Quc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZG90LnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gZW50aXR5Lm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE1hcCBMb2dpYzoKICAgICAgICAgICAgICAgIC8vIFdvcmxkIFogaXMgVXAvRG93bi4gLVogaXMgVG9wIChBdHRhY2sgRGlyZWN0aW9uIGZvciBIb21lKSwgK1ogaXMgQm90dG9tLgogICAgICAgICAgICAgICAgLy8gV29ybGQgWCBpcyBMZWZ0L1JpZ2h0LgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgcmF3IHBvc2l0aW9uIHJlbGF0aXZlIHRvIGNlbnRlcgogICAgICAgICAgICAgICAgbGV0IGR4ID0gcG9zLnggKiBzY2FsZTsKICAgICAgICAgICAgICAgIGxldCBkeSA9IHBvcy56ICogc2NhbGU7CgogICAgICAgICAgICAgICAgLy8gQ2xhbXAgdG8gY2lyY2xlIChrZWVwIGRvdHMgaW5zaWRlIHRoZSBtYXApCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwogICAgICAgICAgICAgICAgY29uc3QgbWF4RGlzdCA9IGhhbGZXIC0gMjsgLy8gLTIgZm9yIGRvdCByYWRpdXMgcGFkZGluZwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguYXRhbjIoZHksIGR4KTsKICAgICAgICAgICAgICAgICAgICBkeCA9IE1hdGguY29zKGFuZ2xlKSAqIG1heERpc3Q7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBNYXRoLnNpbihhbmdsZSkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENvbnZlcnQgdG8gQ1NTIGNvb3JkaW5hdGVzICgwLDAgaXMgVG9wLUxlZnQpCiAgICAgICAgICAgICAgICAvLyBDZW50ZXIgaXMgKDUwLCA1MCkKICAgICAgICAgICAgICAgIGNvbnN0IGNzc1ggPSBoYWxmVyArIGR4OwogICAgICAgICAgICAgICAgY29uc3QgY3NzWSA9IGhhbGZIICsgZHk7CgogICAgICAgICAgICAgICAgZG90LnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHtjc3NYfXB4LCAke2Nzc1l9cHgpYDsKICAgICAgICAgICAgICAgIAovLyBTdGF0dXMgVXBkYXRlcwogICAgICAgICAgICAgICAgaWYgKGVudGl0eS5zdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgICAvLyBOYXAgKFNsZWVwKSB0dXJucyBkb3QgZGFyay9ibGFjawogICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkb3QuY2xhc3NMaXN0LmNvbnRhaW5zKCduYXAnKSkgZG90LmNsYXNzTGlzdC5hZGQoJ25hcCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb3QuY2xhc3NMaXN0LmNvbnRhaW5zKCduYXAnKSkgZG90LmNsYXNzTGlzdC5yZW1vdmUoJ25hcCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBY3RpdmUgUGxheWVyIE1hcmtlciAoR3JlZW4pCi8vIEFjdGl2ZSBQbGF5ZXIgTWFya2VyIChHcmVlbikKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IChnYW1lICYmIGdhbWUudGVhbXMuaG9tZSAmJiBnYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyID09PSBlbnRpdHkpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWRvdC5jbGFzc0xpc3QuY29udGFpbnMoJ2FjdGl2ZS1wbGF5ZXInKSkgZG90LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZS1wbGF5ZXInKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvdC5jbGFzc0xpc3QuY29udGFpbnMoJ2FjdGl2ZS1wbGF5ZXInKSkgZG90LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZS1wbGF5ZXInKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBCYWxsIENhcnJpZXIgTWFya2VyIChHbG93KQogICAgICAgICAgICAgICAgaWYgKGVudGl0eS5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFkb3QuY2xhc3NMaXN0LmNvbnRhaW5zKCdiYWxsLWNhcnJpZXInKSkgZG90LmNsYXNzTGlzdC5hZGQoJ2JhbGwtY2FycmllcicpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZG90LmNsYXNzTGlzdC5jb250YWlucygnYmFsbC1jYXJyaWVyJykpIGRvdC5jbGFzc0xpc3QucmVtb3ZlKCdiYWxsLWNhcnJpZXInKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgICAgICAgICAgCgogICAgCgogICAgd2luZG93LmZsdXguTWluaU1hcCA9IE1pbmlNYXA7Cn0pKCk7","/MiniMap.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNaW5pTWFwIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcCcpOwogICAgICAgICAgICB0aGlzLmRvdHMgPSBuZXcgTWFwKCk7IC8vIE1hcCBlbnRpdHkgdG8gRE9NIGVsZW1lbnQKICAgICAgICAgICAgdGhpcy53aWR0aCA9IDEwMDsgLy8gTWF0Y2hlcyBDU1Mgd2lkdGgKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSAxMDA7IC8vIE1hdGNoZXMgQ1NTIGhlaWdodAogICAgICAgICAgICB0aGlzLndvcmxkUmFkaXVzID0gMzA7IC8vIEFyZW5hIHJhZGl1cwogICAgICAgIH0KCiAgICAgICAgcmVnaXN0ZXIoZW50aXR5LCB0eXBlKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICBkb3QuY2xhc3NOYW1lID0gYG1hcC1kb3QgJHt0eXBlfWA7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZENoaWxkKGRvdCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmRvdHMuc2V0KGVudGl0eSwgZG90KTsKICAgICAgICB9CgogICAgICAgIGluaXQoaG9tZVRlYW0sIGF3YXlUZWFtLCBiYWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuaW5uZXJIVE1MID0gJyc7IC8vIENsZWFyIGV4aXN0aW5nCiAgICAgICAgICAgIHRoaXMuZG90cy5jbGVhcigpOwoKICAgICAgICAgICAgLy8gUmVnaXN0ZXIgSG9tZSBUZWFtCiAgICAgICAgICAgIGhvbWVUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHRoaXMucmVnaXN0ZXIocCwgJ2hvbWUnKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZWdpc3RlciBBd2F5IFRlYW0KICAgICAgICAgICAgYXdheVRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gdGhpcy5yZWdpc3RlcihwLCAnYXdheScpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlZ2lzdGVyIEJhbGwKICAgICAgICAgICAgdGhpcy5yZWdpc3RlcihiYWxsLCAnYmFsbCcpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBoYWxmVyA9IHRoaXMud2lkdGggLyAyOwogICAgICAgICAgICBjb25zdCBoYWxmSCA9IHRoaXMuaGVpZ2h0IC8gMjsKICAgICAgICAgICAgLy8gU2NhbGU6IE1hcCBSYWRpdXMgKDUwcHgpIC8gV29ybGQgUmFkaXVzICgzMCB1bml0cykKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSBoYWxmVyAvIHRoaXMud29ybGRSYWRpdXM7IAoKZm9yIChjb25zdCBbZW50aXR5LCBkb3RdIG9mIHRoaXMuZG90cykgewogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgLy8gSW52aXNpYmxlIEJhbGwgTG9naWMKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuaXNJbnZpc2libGUpIHsKICAgICAgICAgICAgICAgICAgICBkb3Quc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZG90LnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gZW50aXR5Lm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE1hcCBMb2dpYzoKICAgICAgICAgICAgICAgIC8vIFdvcmxkIFogaXMgVXAvRG93bi4gLVogaXMgVG9wIChBdHRhY2sgRGlyZWN0aW9uIGZvciBIb21lKSwgK1ogaXMgQm90dG9tLgogICAgICAgICAgICAgICAgLy8gV29ybGQgWCBpcyBMZWZ0L1JpZ2h0LgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgcmF3IHBvc2l0aW9uIHJlbGF0aXZlIHRvIGNlbnRlcgogICAgICAgICAgICAgICAgbGV0IGR4ID0gcG9zLnggKiBzY2FsZTsKICAgICAgICAgICAgICAgIGxldCBkeSA9IHBvcy56ICogc2NhbGU7CgogICAgICAgICAgICAgICAgLy8gQ2xhbXAgdG8gY2lyY2xlIChrZWVwIGRvdHMgaW5zaWRlIHRoZSBtYXApCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwogICAgICAgICAgICAgICAgY29uc3QgbWF4RGlzdCA9IGhhbGZXIC0gMjsgLy8gLTIgZm9yIGRvdCByYWRpdXMgcGFkZGluZwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguYXRhbjIoZHksIGR4KTsKICAgICAgICAgICAgICAgICAgICBkeCA9IE1hdGguY29zKGFuZ2xlKSAqIG1heERpc3Q7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBNYXRoLnNpbihhbmdsZSkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENvbnZlcnQgdG8gQ1NTIGNvb3JkaW5hdGVzICgwLDAgaXMgVG9wLUxlZnQpCiAgICAgICAgICAgICAgICAvLyBDZW50ZXIgaXMgKDUwLCA1MCkKICAgICAgICAgICAgICAgIGNvbnN0IGNzc1ggPSBoYWxmVyArIGR4OwogICAgICAgICAgICAgICAgY29uc3QgY3NzWSA9IGhhbGZIICsgZHk7CgogICAgICAgICAgICAgICAgZG90LnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHtjc3NYfXB4LCAke2Nzc1l9cHgpYDsKICAgICAgICAgICAgICAgIAovLyBTdGF0dXMgVXBkYXRlcwogICAgICAgICAgICAgICAgaWYgKGVudGl0eS5zdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgICAvLyBOYXAgKFNsZWVwKSB0dXJucyBkb3QgZGFyay9ibGFjawogICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkb3QuY2xhc3NMaXN0LmNvbnRhaW5zKCduYXAnKSkgZG90LmNsYXNzTGlzdC5hZGQoJ25hcCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb3QuY2xhc3NMaXN0LmNvbnRhaW5zKCduYXAnKSkgZG90LmNsYXNzTGlzdC5yZW1vdmUoJ25hcCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBY3RpdmUgUGxheWVyIE1hcmtlciAoR3JlZW4pCi8vIEFjdGl2ZSBQbGF5ZXIgTWFya2VyIChHcmVlbikKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IChnYW1lICYmIGdhbWUudGVhbXMuaG9tZSAmJiBnYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyID09PSBlbnRpdHkpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWRvdC5jbGFzc0xpc3QuY29udGFpbnMoJ2FjdGl2ZS1wbGF5ZXInKSkgZG90LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZS1wbGF5ZXInKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvdC5jbGFzc0xpc3QuY29udGFpbnMoJ2FjdGl2ZS1wbGF5ZXInKSkgZG90LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZS1wbGF5ZXInKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBCYWxsIENhcnJpZXIgTWFya2VyIChHbG93KQogICAgICAgICAgICAgICAgaWYgKGVudGl0eS5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFkb3QuY2xhc3NMaXN0LmNvbnRhaW5zKCdiYWxsLWNhcnJpZXInKSkgZG90LmNsYXNzTGlzdC5hZGQoJ2JhbGwtY2FycmllcicpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZG90LmNsYXNzTGlzdC5jb250YWlucygnYmFsbC1jYXJyaWVyJykpIGRvdC5jbGFzc0xpc3QucmVtb3ZlKCdiYWxsLWNhcnJpZXInKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgICAgICAgICAgCgogICAgCgogICAgd2luZG93LmZsdXguTWluaU1hcCA9IE1pbmlNYXA7Cn0pKCk7","FloatingTextManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBGbG9hdGluZ1RleHRNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgY29udGFpbmVySWQsIGNhbWVyYSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKTsKICAgICAgICAgICAgdGhpcy50ZXh0cyA9IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBwcm9qZWN0aW9uCiAgICAgICAgICAgIHRoaXMuX3RlbXBWID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICB9CgpzcGF3bih0ZXh0LCB3b3JsZFBvcywgdHlwZSA9ICdkZWZhdWx0JywgdGFyZ2V0ID0gbnVsbCkgewogICAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyIHx8ICF0aGlzLmNhbWVyYSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIFdyYXBwZXIgKFBvc2l0aW9uaW5nKQogICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHdyYXBwZXIuY2xhc3NOYW1lID0gJ2Zsb2F0aW5nLXRleHQtd3JhcHBlcic7CgogICAgICAgICAgICAvLyBDcmVhdGUgSW5uZXIgKEFuaW1hdGlvbi9TdHlsaW5nKQogICAgICAgICAgICBjb25zdCBpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgaW5uZXIuaW5uZXJUZXh0ID0gdGV4dDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNtYXJ0IENsYXNzIEFzc2lnbm1lbnQKICAgICAgICAgICAgbGV0IGNsYXNzZXMgPSBbJ2Zsb2F0aW5nLXRleHQtaW5uZXInXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFkZCBiYXNlIHR5cGUKICAgICAgICAgICAgY2xhc3Nlcy5wdXNoKHR5cGUpOwoKICAgICAgICAgICAgLy8gS2V5d29yZCBEZXRlY3Rpb24gZm9yIEF1dG8tU3R5bGluZwogICAgICAgICAgICBjb25zdCB1cHBlciA9IHRleHQudG9TdHJpbmcoKS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICAKaWYgKHVwcGVyLmluY2x1ZGVzKCdQT0lTT04nKSB8fCB1cHBlci5pbmNsdWRlcygnVkVOT00nKSkgY2xhc3Nlcy5wdXNoKCd2ZW5vbScpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnU0xFRVAnKSB8fCB1cHBlci5pbmNsdWRlcygnTkFQJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1paWicpKSBjbGFzc2VzLnB1c2goJ3NsZWVwJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHVwcGVyLmluY2x1ZGVzKCdXSVRIRVInKSkgY2xhc3Nlcy5wdXNoKCd3aXRoZXInKTsKICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ3RlY2gnIHx8IHVwcGVyLmluY2x1ZGVzKCdTSE9UJykgfHwgdXBwZXIuaW5jbHVkZXMoJ0pFQ0hUJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1RBQ0tMRScpKSBjbGFzc2VzLnB1c2goJ3RlY2gnKTsKICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ2NvbWljLWltcGFjdCcpIGNsYXNzZXMucHVzaCgnY29taWMtaW1wYWN0Jyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdjb21pYy1hY3Rpb24nKSBjbGFzc2VzLnB1c2goJ2NvbWljLWFjdGlvbicpOwogICAgICAgICAgICBlbHNlIGlmICghaXNOYU4ocGFyc2VJbnQodGV4dCkpICYmIHR5cGUgIT09ICdzY29yZScpIGNsYXNzZXMucHVzaCgnZGFtYWdlJyk7IC8vIE51bWVyaWMgaXMgdXN1YWxseSBkYW1hZ2UKICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ3NhdmUnIHx8IHR5cGUgPT09ICdibG9jaycpIGNsYXNzZXMucHVzaCgnc2F2ZScpOwoKICAgICAgICAgICAgaW5uZXIuY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCcgJyk7CiAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaW5uZXIpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hcHBlbmRDaGlsZCh3cmFwcGVyKTsKCiAgICAgICAgICAgIC8vIFBoeXNpY3MgSW5zdGFuY2UKICAgICAgICAgICAgY29uc3QgaW5zdGFuY2UgPSB7CiAgICAgICAgICAgICAgICBlbDogd3JhcHBlciwgCiAgICAgICAgICAgICAgICB3b3JsZFBvczogd29ybGRQb3MuY2xvbmUoKSwKICAgICAgICAgICAgICAgIG9mZnNldDogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksCiAgICAgICAgICAgICAgICBncmF2aXR5OiAwLAogICAgICAgICAgICAgICAgZHJhZzogMCwKICAgICAgICAgICAgICAgIGVsYXN0aWNpdHk6IDAuNiwKICAgICAgICAgICAgICAgIGZsb29yWTogLTk5OSwgLy8gVmlydHVhbCBmbG9vciByZWxhdGl2ZSB0byBzdGFydAogICAgICAgICAgICAgICAgCmxpZmU6IDEuMCwgIC8vIFJlZHVjZWQgZnJvbSAxLjUKICAgICAgICAgICAgICAgIG1heExpZmU6IDEuMCwKICAgICAgICAgICAgICAgIHRhcmdldDogdGFyZ2V0CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBDdXN0b21pemUgUGh5c2ljcyBiYXNlZCBvbiBUeXBlCmlmIChjbGFzc2VzLmluY2x1ZGVzKCdkYW1hZ2UnKSB8fCBjbGFzc2VzLmluY2x1ZGVzKCdzYXZlJykgfHwgY2xhc3Nlcy5pbmNsdWRlcygnYmxvY2snKSkgewogICAgICAgICAgICAgICAgLy8gREVCUklTIFBIWVNJQ1MgKFBvcCwgQXJjLCBCb3VuY2UpCiAgICAgICAgICAgICAgICBpbnN0YW5jZS50YXJnZXQgPSBudWxsOyAvLyBEZXRhY2ggZnJvbSBlbnRpdHkgc28gaXQgZmFsbHMgbmF0dXJhbGx5CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gNDAuMDsgLy8gSGVhdnkgZ3Jhdml0eSBmb3Igc25hcHB5IGZlZWwKICAgICAgICAgICAgICAgIGluc3RhbmNlLmRyYWcgPSAwLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5mbG9vclkgPSAtNC4wOyAvLyBCb3VuY2Ugb2ZmIGEgdmlydHVhbCBmbG9vciBiZWxvdyBpbXBhY3QKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRXhwbG9zaXZlIEJ1cnN0CiAgICAgICAgICAgICAgICBjb25zdCBzcHJlYWQgPSA2LjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc3ByZWFkLAogICAgICAgICAgICAgICAgICAgIDE1LjAgKyBNYXRoLnJhbmRvbSgpICogNS4wLCAvLyBIaWdoIGluaXRpYWwgcG9wCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc3ByZWFkCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuMDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnY29taWMtaW1wYWN0JykpIHsKICAgICAgICAgICAgICAgIC8vIENPTUlDIFBPUCAoU3RheSBpbiBwbGFjZSBtb3N0bHksIHNsaWdodCBkcmlmdCkKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMiwgMS4wLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIpOwppbnN0YW5jZS5saWZlID0gMC41OyAvLyBSZWR1Y2VkIGZyb20gMC44CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMC41OwoKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdjb21pYy1hY3Rpb24nKSkgewogICAgICAgICAgICAgICAgLy8gQ09NSUMgWklQIChGYXN0IG1vdmVtZW50KQogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMi4wLCAwKTsKaW5zdGFuY2UubGlmZSA9IDAuNDsgLy8gUmVkdWNlZCBmcm9tIDAuNgogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDAuNDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygndGVjaCcpKSB7CiAgICAgICAgICAgICAgICAvLyBURUNIIEZMT0FUIChTbG93IHJpc2UpCiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAyLjAsIDApOyAvLyBTdGVhZHkgcmlzZQogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDIuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAyLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5vZmZzZXQueSA9IDIuMDsgLy8gU3RhcnQgaGlnaGVyCgogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3NsZWVwJykpIHsKICAgICAgICAgICAgICAgIC8vIFNMRUVQIERSSUZUIChTbG93IG1lYW5kZXJpbmcpCiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gLTAuNTsgLy8gU2xpZ2h0IGFudGktZ3Jhdml0eQogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAuNSwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMy4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDMuMDsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBERUZBVUxUIChTdGF0dXMsIGV0YykKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAzLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDUuMDsgLy8gU2xpZ2h0IGFyYwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYW5kb21pemUgc3RhcnQgcG9zIHNsaWdodGx5IHRvIHByZXZlbnQgc3RhY2tpbmcKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLndvcmxkUG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgIH0KaW5zdGFuY2Uud29ybGRQb3MueSArPSAxLjA7CiAgICAgICAgICAgIHRoaXMudGV4dHMucHVzaChpbnN0YW5jZSk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUG9zaXRpb24oaW5zdGFuY2UpOwogICAgICAgIH0KCi8vIHNwYXduVmVyc3VzIHJlbW92ZWQKCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLnRleHRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gdGhpcy50ZXh0c1tpXTsKICAgICAgICAgICAgICAgIHQubGlmZSAtPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSWYgYXR0YWNoZWQgdG8gYSB0YXJnZXQsIHVwZGF0ZSBiYXNlIHBvc2l0aW9uIChvbmx5IGZvciBub24tZGVicmlzKQogICAgICAgICAgICAgICAgaWYgKHQudGFyZ2V0ICYmIHQudGFyZ2V0LnBhcmVudCkgeyAKICAgICAgICAgICAgICAgICAgICB0LndvcmxkUG9zLmNvcHkodC50YXJnZXQucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHQud29ybGRQb3MueSArPSAxLjA7IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFBoeXNpY3MgSW50ZWdyYXRpb24KICAgICAgICAgICAgICAgIGlmICh0LmdyYXZpdHkgIT09IDAgfHwgdC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMCkgewogICAgICAgICAgICAgICAgICAgIC8vIEdyYXZpdHkKICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnkgLT0gdC5ncmF2aXR5ICogZHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRHJhZyAoQWlyIHJlc2lzdGFuY2UpCiAgICAgICAgICAgICAgICAgICAgaWYgKHQuZHJhZyA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihNYXRoLm1heCgwLCAxLjAgLSAodC5kcmFnICogZHQpKSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBNb3ZlCiAgICAgICAgICAgICAgICAgICAgdC5vZmZzZXQuYWRkU2NhbGVkVmVjdG9yKHQudmVsb2NpdHksIGR0KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQm91bmNlIExvZ2ljCiAgICAgICAgICAgICAgICAgICAgaWYgKHQub2Zmc2V0LnkgPCB0LmZsb29yWSkgewogICAgICAgICAgICAgICAgICAgICAgICB0Lm9mZnNldC55ID0gdC5mbG9vclk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJvdW5jZSB2ZWxvY2l0eQogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnkgKj0gLXQuZWxhc3RpY2l0eTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR3JvdW5kIGZyaWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueCAqPSAwLjc7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueiAqPSAwLjc7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9wIGJvdW5jaW5nIGlmIGVuZXJneSBpcyBsb3cKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHQudmVsb2NpdHkueSkgPCAyLjApIHQudmVsb2NpdHkueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0LmxpZmUgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0LmVsLnBhcmVudE5vZGUpIHQuZWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0LmVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRleHRzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVQb3NpdGlvbih0KTsKICAgICAgICAgICAgICAgICAgICAvLyBGYWRlIG91dCBpbiBsYXN0IDMwJQogICAgICAgICAgICAgICAgICAgIGlmICh0LmxpZmUgPCB0Lm1heExpZmUgKiAwLjMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5lbC5zdHlsZS5vcGFjaXR5ID0gdC5saWZlIC8gKHQubWF4TGlmZSAqIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQb3NpdGlvbih0KSB7CiAgICAgICAgICAgIC8vIFByb2plY3Qgd29ybGQgcG9zICsgb2Zmc2V0IHRvIHNjcmVlbgogICAgICAgICAgICB0aGlzLl90ZW1wVi5jb3B5KHQud29ybGRQb3MpLmFkZCh0Lm9mZnNldCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFuZGFyZCBUaHJlZS5qcyBwcm9qZWN0aW9uCiAgICAgICAgICAgIHRoaXMuX3RlbXBWLnByb2plY3QodGhpcy5jYW1lcmEpOwoKICAgICAgICAgICAgY29uc3QgeCA9ICh0aGlzLl90ZW1wVi54ICogLjUgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRXaWR0aDsKICAgICAgICAgICAgY29uc3QgeSA9ICgtKHRoaXMuX3RlbXBWLnkgKiAuNSkgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRIZWlnaHQ7CgogICAgICAgICAgICAvLyBIaWRlIGlmIGJlaGluZCBjYW1lcmEKICAgICAgICAgICAgaWYgKHRoaXMuX3RlbXBWLnogPiAxKSB7CiAgICAgICAgICAgICAgICB0LmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0LmVsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgdC5lbC5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKCR7eH1weCwgJHt5fXB4KWA7CiAgICAgICAgICAgIH0KfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkZsb2F0aW5nVGV4dE1hbmFnZXIgPSBGbG9hdGluZ1RleHRNYW5hZ2VyOwp9KSgpOw==","./FloatingTextManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBGbG9hdGluZ1RleHRNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgY29udGFpbmVySWQsIGNhbWVyYSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKTsKICAgICAgICAgICAgdGhpcy50ZXh0cyA9IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBwcm9qZWN0aW9uCiAgICAgICAgICAgIHRoaXMuX3RlbXBWID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICB9CgpzcGF3bih0ZXh0LCB3b3JsZFBvcywgdHlwZSA9ICdkZWZhdWx0JywgdGFyZ2V0ID0gbnVsbCkgewogICAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyIHx8ICF0aGlzLmNhbWVyYSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIFdyYXBwZXIgKFBvc2l0aW9uaW5nKQogICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHdyYXBwZXIuY2xhc3NOYW1lID0gJ2Zsb2F0aW5nLXRleHQtd3JhcHBlcic7CgogICAgICAgICAgICAvLyBDcmVhdGUgSW5uZXIgKEFuaW1hdGlvbi9TdHlsaW5nKQogICAgICAgICAgICBjb25zdCBpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgaW5uZXIuaW5uZXJUZXh0ID0gdGV4dDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNtYXJ0IENsYXNzIEFzc2lnbm1lbnQKICAgICAgICAgICAgbGV0IGNsYXNzZXMgPSBbJ2Zsb2F0aW5nLXRleHQtaW5uZXInXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFkZCBiYXNlIHR5cGUKICAgICAgICAgICAgY2xhc3Nlcy5wdXNoKHR5cGUpOwoKICAgICAgICAgICAgLy8gS2V5d29yZCBEZXRlY3Rpb24gZm9yIEF1dG8tU3R5bGluZwogICAgICAgICAgICBjb25zdCB1cHBlciA9IHRleHQudG9TdHJpbmcoKS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICAKaWYgKHVwcGVyLmluY2x1ZGVzKCdQT0lTT04nKSB8fCB1cHBlci5pbmNsdWRlcygnVkVOT00nKSkgY2xhc3Nlcy5wdXNoKCd2ZW5vbScpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnU0xFRVAnKSB8fCB1cHBlci5pbmNsdWRlcygnTkFQJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1paWicpKSBjbGFzc2VzLnB1c2goJ3NsZWVwJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHVwcGVyLmluY2x1ZGVzKCdXSVRIRVInKSkgY2xhc3Nlcy5wdXNoKCd3aXRoZXInKTsKICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ3RlY2gnIHx8IHVwcGVyLmluY2x1ZGVzKCdTSE9UJykgfHwgdXBwZXIuaW5jbHVkZXMoJ0pFQ0hUJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1RBQ0tMRScpKSBjbGFzc2VzLnB1c2goJ3RlY2gnKTsKICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ2NvbWljLWltcGFjdCcpIGNsYXNzZXMucHVzaCgnY29taWMtaW1wYWN0Jyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdjb21pYy1hY3Rpb24nKSBjbGFzc2VzLnB1c2goJ2NvbWljLWFjdGlvbicpOwogICAgICAgICAgICBlbHNlIGlmICghaXNOYU4ocGFyc2VJbnQodGV4dCkpICYmIHR5cGUgIT09ICdzY29yZScpIGNsYXNzZXMucHVzaCgnZGFtYWdlJyk7IC8vIE51bWVyaWMgaXMgdXN1YWxseSBkYW1hZ2UKICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ3NhdmUnIHx8IHR5cGUgPT09ICdibG9jaycpIGNsYXNzZXMucHVzaCgnc2F2ZScpOwoKICAgICAgICAgICAgaW5uZXIuY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCcgJyk7CiAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaW5uZXIpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hcHBlbmRDaGlsZCh3cmFwcGVyKTsKCiAgICAgICAgICAgIC8vIFBoeXNpY3MgSW5zdGFuY2UKICAgICAgICAgICAgY29uc3QgaW5zdGFuY2UgPSB7CiAgICAgICAgICAgICAgICBlbDogd3JhcHBlciwgCiAgICAgICAgICAgICAgICB3b3JsZFBvczogd29ybGRQb3MuY2xvbmUoKSwKICAgICAgICAgICAgICAgIG9mZnNldDogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksCiAgICAgICAgICAgICAgICBncmF2aXR5OiAwLAogICAgICAgICAgICAgICAgZHJhZzogMCwKICAgICAgICAgICAgICAgIGVsYXN0aWNpdHk6IDAuNiwKICAgICAgICAgICAgICAgIGZsb29yWTogLTk5OSwgLy8gVmlydHVhbCBmbG9vciByZWxhdGl2ZSB0byBzdGFydAogICAgICAgICAgICAgICAgCmxpZmU6IDEuMCwgIC8vIFJlZHVjZWQgZnJvbSAxLjUKICAgICAgICAgICAgICAgIG1heExpZmU6IDEuMCwKICAgICAgICAgICAgICAgIHRhcmdldDogdGFyZ2V0CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBDdXN0b21pemUgUGh5c2ljcyBiYXNlZCBvbiBUeXBlCmlmIChjbGFzc2VzLmluY2x1ZGVzKCdkYW1hZ2UnKSB8fCBjbGFzc2VzLmluY2x1ZGVzKCdzYXZlJykgfHwgY2xhc3Nlcy5pbmNsdWRlcygnYmxvY2snKSkgewogICAgICAgICAgICAgICAgLy8gREVCUklTIFBIWVNJQ1MgKFBvcCwgQXJjLCBCb3VuY2UpCiAgICAgICAgICAgICAgICBpbnN0YW5jZS50YXJnZXQgPSBudWxsOyAvLyBEZXRhY2ggZnJvbSBlbnRpdHkgc28gaXQgZmFsbHMgbmF0dXJhbGx5CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gNDAuMDsgLy8gSGVhdnkgZ3Jhdml0eSBmb3Igc25hcHB5IGZlZWwKICAgICAgICAgICAgICAgIGluc3RhbmNlLmRyYWcgPSAwLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5mbG9vclkgPSAtNC4wOyAvLyBCb3VuY2Ugb2ZmIGEgdmlydHVhbCBmbG9vciBiZWxvdyBpbXBhY3QKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRXhwbG9zaXZlIEJ1cnN0CiAgICAgICAgICAgICAgICBjb25zdCBzcHJlYWQgPSA2LjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc3ByZWFkLAogICAgICAgICAgICAgICAgICAgIDE1LjAgKyBNYXRoLnJhbmRvbSgpICogNS4wLCAvLyBIaWdoIGluaXRpYWwgcG9wCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc3ByZWFkCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuMDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnY29taWMtaW1wYWN0JykpIHsKICAgICAgICAgICAgICAgIC8vIENPTUlDIFBPUCAoU3RheSBpbiBwbGFjZSBtb3N0bHksIHNsaWdodCBkcmlmdCkKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMiwgMS4wLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIpOwppbnN0YW5jZS5saWZlID0gMC41OyAvLyBSZWR1Y2VkIGZyb20gMC44CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMC41OwoKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdjb21pYy1hY3Rpb24nKSkgewogICAgICAgICAgICAgICAgLy8gQ09NSUMgWklQIChGYXN0IG1vdmVtZW50KQogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMi4wLCAwKTsKaW5zdGFuY2UubGlmZSA9IDAuNDsgLy8gUmVkdWNlZCBmcm9tIDAuNgogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDAuNDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygndGVjaCcpKSB7CiAgICAgICAgICAgICAgICAvLyBURUNIIEZMT0FUIChTbG93IHJpc2UpCiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAyLjAsIDApOyAvLyBTdGVhZHkgcmlzZQogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDIuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAyLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5vZmZzZXQueSA9IDIuMDsgLy8gU3RhcnQgaGlnaGVyCgogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3NsZWVwJykpIHsKICAgICAgICAgICAgICAgIC8vIFNMRUVQIERSSUZUIChTbG93IG1lYW5kZXJpbmcpCiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gLTAuNTsgLy8gU2xpZ2h0IGFudGktZ3Jhdml0eQogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAuNSwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMy4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDMuMDsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBERUZBVUxUIChTdGF0dXMsIGV0YykKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAzLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDUuMDsgLy8gU2xpZ2h0IGFyYwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYW5kb21pemUgc3RhcnQgcG9zIHNsaWdodGx5IHRvIHByZXZlbnQgc3RhY2tpbmcKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLndvcmxkUG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgIH0KaW5zdGFuY2Uud29ybGRQb3MueSArPSAxLjA7CiAgICAgICAgICAgIHRoaXMudGV4dHMucHVzaChpbnN0YW5jZSk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUG9zaXRpb24oaW5zdGFuY2UpOwogICAgICAgIH0KCi8vIHNwYXduVmVyc3VzIHJlbW92ZWQKCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLnRleHRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gdGhpcy50ZXh0c1tpXTsKICAgICAgICAgICAgICAgIHQubGlmZSAtPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSWYgYXR0YWNoZWQgdG8gYSB0YXJnZXQsIHVwZGF0ZSBiYXNlIHBvc2l0aW9uIChvbmx5IGZvciBub24tZGVicmlzKQogICAgICAgICAgICAgICAgaWYgKHQudGFyZ2V0ICYmIHQudGFyZ2V0LnBhcmVudCkgeyAKICAgICAgICAgICAgICAgICAgICB0LndvcmxkUG9zLmNvcHkodC50YXJnZXQucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHQud29ybGRQb3MueSArPSAxLjA7IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFBoeXNpY3MgSW50ZWdyYXRpb24KICAgICAgICAgICAgICAgIGlmICh0LmdyYXZpdHkgIT09IDAgfHwgdC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMCkgewogICAgICAgICAgICAgICAgICAgIC8vIEdyYXZpdHkKICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnkgLT0gdC5ncmF2aXR5ICogZHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRHJhZyAoQWlyIHJlc2lzdGFuY2UpCiAgICAgICAgICAgICAgICAgICAgaWYgKHQuZHJhZyA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihNYXRoLm1heCgwLCAxLjAgLSAodC5kcmFnICogZHQpKSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBNb3ZlCiAgICAgICAgICAgICAgICAgICAgdC5vZmZzZXQuYWRkU2NhbGVkVmVjdG9yKHQudmVsb2NpdHksIGR0KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQm91bmNlIExvZ2ljCiAgICAgICAgICAgICAgICAgICAgaWYgKHQub2Zmc2V0LnkgPCB0LmZsb29yWSkgewogICAgICAgICAgICAgICAgICAgICAgICB0Lm9mZnNldC55ID0gdC5mbG9vclk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJvdW5jZSB2ZWxvY2l0eQogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnkgKj0gLXQuZWxhc3RpY2l0eTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR3JvdW5kIGZyaWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueCAqPSAwLjc7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueiAqPSAwLjc7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9wIGJvdW5jaW5nIGlmIGVuZXJneSBpcyBsb3cKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHQudmVsb2NpdHkueSkgPCAyLjApIHQudmVsb2NpdHkueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0LmxpZmUgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0LmVsLnBhcmVudE5vZGUpIHQuZWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0LmVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRleHRzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVQb3NpdGlvbih0KTsKICAgICAgICAgICAgICAgICAgICAvLyBGYWRlIG91dCBpbiBsYXN0IDMwJQogICAgICAgICAgICAgICAgICAgIGlmICh0LmxpZmUgPCB0Lm1heExpZmUgKiAwLjMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5lbC5zdHlsZS5vcGFjaXR5ID0gdC5saWZlIC8gKHQubWF4TGlmZSAqIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQb3NpdGlvbih0KSB7CiAgICAgICAgICAgIC8vIFByb2plY3Qgd29ybGQgcG9zICsgb2Zmc2V0IHRvIHNjcmVlbgogICAgICAgICAgICB0aGlzLl90ZW1wVi5jb3B5KHQud29ybGRQb3MpLmFkZCh0Lm9mZnNldCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFuZGFyZCBUaHJlZS5qcyBwcm9qZWN0aW9uCiAgICAgICAgICAgIHRoaXMuX3RlbXBWLnByb2plY3QodGhpcy5jYW1lcmEpOwoKICAgICAgICAgICAgY29uc3QgeCA9ICh0aGlzLl90ZW1wVi54ICogLjUgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRXaWR0aDsKICAgICAgICAgICAgY29uc3QgeSA9ICgtKHRoaXMuX3RlbXBWLnkgKiAuNSkgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRIZWlnaHQ7CgogICAgICAgICAgICAvLyBIaWRlIGlmIGJlaGluZCBjYW1lcmEKICAgICAgICAgICAgaWYgKHRoaXMuX3RlbXBWLnogPiAxKSB7CiAgICAgICAgICAgICAgICB0LmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0LmVsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgdC5lbC5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKCR7eH1weCwgJHt5fXB4KWA7CiAgICAgICAgICAgIH0KfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkZsb2F0aW5nVGV4dE1hbmFnZXIgPSBGbG9hdGluZ1RleHRNYW5hZ2VyOwp9KSgpOw==","/FloatingTextManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBGbG9hdGluZ1RleHRNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgY29udGFpbmVySWQsIGNhbWVyYSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKTsKICAgICAgICAgICAgdGhpcy50ZXh0cyA9IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBwcm9qZWN0aW9uCiAgICAgICAgICAgIHRoaXMuX3RlbXBWID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICB9CgpzcGF3bih0ZXh0LCB3b3JsZFBvcywgdHlwZSA9ICdkZWZhdWx0JywgdGFyZ2V0ID0gbnVsbCkgewogICAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyIHx8ICF0aGlzLmNhbWVyYSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIFdyYXBwZXIgKFBvc2l0aW9uaW5nKQogICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHdyYXBwZXIuY2xhc3NOYW1lID0gJ2Zsb2F0aW5nLXRleHQtd3JhcHBlcic7CgogICAgICAgICAgICAvLyBDcmVhdGUgSW5uZXIgKEFuaW1hdGlvbi9TdHlsaW5nKQogICAgICAgICAgICBjb25zdCBpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgaW5uZXIuaW5uZXJUZXh0ID0gdGV4dDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNtYXJ0IENsYXNzIEFzc2lnbm1lbnQKICAgICAgICAgICAgbGV0IGNsYXNzZXMgPSBbJ2Zsb2F0aW5nLXRleHQtaW5uZXInXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFkZCBiYXNlIHR5cGUKICAgICAgICAgICAgY2xhc3Nlcy5wdXNoKHR5cGUpOwoKICAgICAgICAgICAgLy8gS2V5d29yZCBEZXRlY3Rpb24gZm9yIEF1dG8tU3R5bGluZwogICAgICAgICAgICBjb25zdCB1cHBlciA9IHRleHQudG9TdHJpbmcoKS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICAKaWYgKHVwcGVyLmluY2x1ZGVzKCdQT0lTT04nKSB8fCB1cHBlci5pbmNsdWRlcygnVkVOT00nKSkgY2xhc3Nlcy5wdXNoKCd2ZW5vbScpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnU0xFRVAnKSB8fCB1cHBlci5pbmNsdWRlcygnTkFQJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1paWicpKSBjbGFzc2VzLnB1c2goJ3NsZWVwJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHVwcGVyLmluY2x1ZGVzKCdXSVRIRVInKSkgY2xhc3Nlcy5wdXNoKCd3aXRoZXInKTsKICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ3RlY2gnIHx8IHVwcGVyLmluY2x1ZGVzKCdTSE9UJykgfHwgdXBwZXIuaW5jbHVkZXMoJ0pFQ0hUJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1RBQ0tMRScpKSBjbGFzc2VzLnB1c2goJ3RlY2gnKTsKICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ2NvbWljLWltcGFjdCcpIGNsYXNzZXMucHVzaCgnY29taWMtaW1wYWN0Jyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdjb21pYy1hY3Rpb24nKSBjbGFzc2VzLnB1c2goJ2NvbWljLWFjdGlvbicpOwogICAgICAgICAgICBlbHNlIGlmICghaXNOYU4ocGFyc2VJbnQodGV4dCkpICYmIHR5cGUgIT09ICdzY29yZScpIGNsYXNzZXMucHVzaCgnZGFtYWdlJyk7IC8vIE51bWVyaWMgaXMgdXN1YWxseSBkYW1hZ2UKICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ3NhdmUnIHx8IHR5cGUgPT09ICdibG9jaycpIGNsYXNzZXMucHVzaCgnc2F2ZScpOwoKICAgICAgICAgICAgaW5uZXIuY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCcgJyk7CiAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaW5uZXIpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hcHBlbmRDaGlsZCh3cmFwcGVyKTsKCiAgICAgICAgICAgIC8vIFBoeXNpY3MgSW5zdGFuY2UKICAgICAgICAgICAgY29uc3QgaW5zdGFuY2UgPSB7CiAgICAgICAgICAgICAgICBlbDogd3JhcHBlciwgCiAgICAgICAgICAgICAgICB3b3JsZFBvczogd29ybGRQb3MuY2xvbmUoKSwKICAgICAgICAgICAgICAgIG9mZnNldDogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksCiAgICAgICAgICAgICAgICBncmF2aXR5OiAwLAogICAgICAgICAgICAgICAgZHJhZzogMCwKICAgICAgICAgICAgICAgIGVsYXN0aWNpdHk6IDAuNiwKICAgICAgICAgICAgICAgIGZsb29yWTogLTk5OSwgLy8gVmlydHVhbCBmbG9vciByZWxhdGl2ZSB0byBzdGFydAogICAgICAgICAgICAgICAgCmxpZmU6IDEuMCwgIC8vIFJlZHVjZWQgZnJvbSAxLjUKICAgICAgICAgICAgICAgIG1heExpZmU6IDEuMCwKICAgICAgICAgICAgICAgIHRhcmdldDogdGFyZ2V0CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBDdXN0b21pemUgUGh5c2ljcyBiYXNlZCBvbiBUeXBlCmlmIChjbGFzc2VzLmluY2x1ZGVzKCdkYW1hZ2UnKSB8fCBjbGFzc2VzLmluY2x1ZGVzKCdzYXZlJykgfHwgY2xhc3Nlcy5pbmNsdWRlcygnYmxvY2snKSkgewogICAgICAgICAgICAgICAgLy8gREVCUklTIFBIWVNJQ1MgKFBvcCwgQXJjLCBCb3VuY2UpCiAgICAgICAgICAgICAgICBpbnN0YW5jZS50YXJnZXQgPSBudWxsOyAvLyBEZXRhY2ggZnJvbSBlbnRpdHkgc28gaXQgZmFsbHMgbmF0dXJhbGx5CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gNDAuMDsgLy8gSGVhdnkgZ3Jhdml0eSBmb3Igc25hcHB5IGZlZWwKICAgICAgICAgICAgICAgIGluc3RhbmNlLmRyYWcgPSAwLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5mbG9vclkgPSAtNC4wOyAvLyBCb3VuY2Ugb2ZmIGEgdmlydHVhbCBmbG9vciBiZWxvdyBpbXBhY3QKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRXhwbG9zaXZlIEJ1cnN0CiAgICAgICAgICAgICAgICBjb25zdCBzcHJlYWQgPSA2LjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc3ByZWFkLAogICAgICAgICAgICAgICAgICAgIDE1LjAgKyBNYXRoLnJhbmRvbSgpICogNS4wLCAvLyBIaWdoIGluaXRpYWwgcG9wCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc3ByZWFkCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuMDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnY29taWMtaW1wYWN0JykpIHsKICAgICAgICAgICAgICAgIC8vIENPTUlDIFBPUCAoU3RheSBpbiBwbGFjZSBtb3N0bHksIHNsaWdodCBkcmlmdCkKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMiwgMS4wLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIpOwppbnN0YW5jZS5saWZlID0gMC41OyAvLyBSZWR1Y2VkIGZyb20gMC44CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMC41OwoKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdjb21pYy1hY3Rpb24nKSkgewogICAgICAgICAgICAgICAgLy8gQ09NSUMgWklQIChGYXN0IG1vdmVtZW50KQogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMi4wLCAwKTsKaW5zdGFuY2UubGlmZSA9IDAuNDsgLy8gUmVkdWNlZCBmcm9tIDAuNgogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDAuNDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygndGVjaCcpKSB7CiAgICAgICAgICAgICAgICAvLyBURUNIIEZMT0FUIChTbG93IHJpc2UpCiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAyLjAsIDApOyAvLyBTdGVhZHkgcmlzZQogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDIuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAyLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5vZmZzZXQueSA9IDIuMDsgLy8gU3RhcnQgaGlnaGVyCgogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3NsZWVwJykpIHsKICAgICAgICAgICAgICAgIC8vIFNMRUVQIERSSUZUIChTbG93IG1lYW5kZXJpbmcpCiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gLTAuNTsgLy8gU2xpZ2h0IGFudGktZ3Jhdml0eQogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAuNSwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMy4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDMuMDsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBERUZBVUxUIChTdGF0dXMsIGV0YykKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAzLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDUuMDsgLy8gU2xpZ2h0IGFyYwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYW5kb21pemUgc3RhcnQgcG9zIHNsaWdodGx5IHRvIHByZXZlbnQgc3RhY2tpbmcKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLndvcmxkUG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgIH0KaW5zdGFuY2Uud29ybGRQb3MueSArPSAxLjA7CiAgICAgICAgICAgIHRoaXMudGV4dHMucHVzaChpbnN0YW5jZSk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUG9zaXRpb24oaW5zdGFuY2UpOwogICAgICAgIH0KCi8vIHNwYXduVmVyc3VzIHJlbW92ZWQKCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLnRleHRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gdGhpcy50ZXh0c1tpXTsKICAgICAgICAgICAgICAgIHQubGlmZSAtPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSWYgYXR0YWNoZWQgdG8gYSB0YXJnZXQsIHVwZGF0ZSBiYXNlIHBvc2l0aW9uIChvbmx5IGZvciBub24tZGVicmlzKQogICAgICAgICAgICAgICAgaWYgKHQudGFyZ2V0ICYmIHQudGFyZ2V0LnBhcmVudCkgeyAKICAgICAgICAgICAgICAgICAgICB0LndvcmxkUG9zLmNvcHkodC50YXJnZXQucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHQud29ybGRQb3MueSArPSAxLjA7IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFBoeXNpY3MgSW50ZWdyYXRpb24KICAgICAgICAgICAgICAgIGlmICh0LmdyYXZpdHkgIT09IDAgfHwgdC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMCkgewogICAgICAgICAgICAgICAgICAgIC8vIEdyYXZpdHkKICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnkgLT0gdC5ncmF2aXR5ICogZHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRHJhZyAoQWlyIHJlc2lzdGFuY2UpCiAgICAgICAgICAgICAgICAgICAgaWYgKHQuZHJhZyA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihNYXRoLm1heCgwLCAxLjAgLSAodC5kcmFnICogZHQpKSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBNb3ZlCiAgICAgICAgICAgICAgICAgICAgdC5vZmZzZXQuYWRkU2NhbGVkVmVjdG9yKHQudmVsb2NpdHksIGR0KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQm91bmNlIExvZ2ljCiAgICAgICAgICAgICAgICAgICAgaWYgKHQub2Zmc2V0LnkgPCB0LmZsb29yWSkgewogICAgICAgICAgICAgICAgICAgICAgICB0Lm9mZnNldC55ID0gdC5mbG9vclk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJvdW5jZSB2ZWxvY2l0eQogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnkgKj0gLXQuZWxhc3RpY2l0eTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR3JvdW5kIGZyaWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueCAqPSAwLjc7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueiAqPSAwLjc7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9wIGJvdW5jaW5nIGlmIGVuZXJneSBpcyBsb3cKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHQudmVsb2NpdHkueSkgPCAyLjApIHQudmVsb2NpdHkueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0LmxpZmUgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0LmVsLnBhcmVudE5vZGUpIHQuZWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0LmVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRleHRzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVQb3NpdGlvbih0KTsKICAgICAgICAgICAgICAgICAgICAvLyBGYWRlIG91dCBpbiBsYXN0IDMwJQogICAgICAgICAgICAgICAgICAgIGlmICh0LmxpZmUgPCB0Lm1heExpZmUgKiAwLjMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5lbC5zdHlsZS5vcGFjaXR5ID0gdC5saWZlIC8gKHQubWF4TGlmZSAqIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQb3NpdGlvbih0KSB7CiAgICAgICAgICAgIC8vIFByb2plY3Qgd29ybGQgcG9zICsgb2Zmc2V0IHRvIHNjcmVlbgogICAgICAgICAgICB0aGlzLl90ZW1wVi5jb3B5KHQud29ybGRQb3MpLmFkZCh0Lm9mZnNldCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFuZGFyZCBUaHJlZS5qcyBwcm9qZWN0aW9uCiAgICAgICAgICAgIHRoaXMuX3RlbXBWLnByb2plY3QodGhpcy5jYW1lcmEpOwoKICAgICAgICAgICAgY29uc3QgeCA9ICh0aGlzLl90ZW1wVi54ICogLjUgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRXaWR0aDsKICAgICAgICAgICAgY29uc3QgeSA9ICgtKHRoaXMuX3RlbXBWLnkgKiAuNSkgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRIZWlnaHQ7CgogICAgICAgICAgICAvLyBIaWRlIGlmIGJlaGluZCBjYW1lcmEKICAgICAgICAgICAgaWYgKHRoaXMuX3RlbXBWLnogPiAxKSB7CiAgICAgICAgICAgICAgICB0LmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0LmVsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgdC5lbC5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKCR7eH1weCwgJHt5fXB4KWA7CiAgICAgICAgICAgIH0KfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkZsb2F0aW5nVGV4dE1hbmFnZXIgPSBGbG9hdGluZ1RleHRNYW5hZ2VyOwp9KSgpOw==","CameraManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzIHRvIGF2b2lkIEdhcmJhZ2UgQ29sbGVjdGlvbgogICAgY29uc3QgX2lkZWFsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9pZGVhbExvb2sgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF92ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGFyZ2V0V29ybGRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9nb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICBjbGFzcyBDYW1lcmFNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihjYW1lcmEsIHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CgogICAgICAgICAgICAvLyAtLS0gSU1QUk9WRUQgQ09ORklHVVJBVElPTiAtLS0KICAgICAgICAgICAgdGhpcy5jb25maWcgPSB7CiAgICAgICAgICAgICAgICAvLyBGSVhFRCBQRVJTUEVDVElWRSBTRVRUSU5HUwogICAgICAgICAgICAgICAgYmFzZURpc3RhbmNlOiAyMi4wLAogICAgICAgICAgICAgICAgYmFzZUhlaWdodDogMTQuMCwKCiAgICAgICAgICAgICAgICAvLyBJTVBST1ZFRDogRmFzdGVyLCBtb3JlIHJlc3BvbnNpdmUgc21vb3RoaW5nCi8vIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKICAgICAgICAgICAgICAgIGZvbGxvd1NwZWVkOiA0LjAsICAgICAKICAgICAgICAgICAgICAgIGxvb2tTcGVlZDogMS41LCAgICAgICAvLyBSRURVQ0VEOiBMYXppZXIgbG9vayB0byByZXZlYWwgY3VydmUKCiAgICAgICAgICAgICAgICAvLyBEeW5hbWljIEZPVgogICAgICAgICAgICAgICAgZm92QmFzZTogNTAsCiAgICAgICAgICAgICAgICBmb3ZNYXg6IDYwLAoKICAgICAgICAgICAgICAgIC8vIElNUFJPVkVEOiBMb29rLWFoZWFkIHNldHRpbmdzCiAgICAgICAgICAgICAgICBsb29rQWhlYWREaXN0YW5jZTogNi4wLAogICAgICAgICAgICAgICAgbG9va0FoZWFkU21vb3RoaW5nOiAzLjAsCgogICAgICAgICAgICAgICAgLy8gU21hcnQgZnJhbWluZwpiYWxsVHJhY2tXZWlnaHQ6IDAuMSwgLy8gUkVEVUNFRDogRG9uJ3QgdHJhY2sgYmFsbCBsYXRlcmFsbHkgdG9vIG11Y2gKICAgICAgICAgICAgICAgIHRocmVhdEF3YXJlbmVzczogdHJ1ZQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gU3RhdGUKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmJhbGwgPSBudWxsOyAvLyBEaXJlY3QgYmFsbCByZWZlcmVuY2UgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICAgICAgdGhpcy50YXJnZXRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnRhcmdldElucHV0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZElucHV0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZExvb2tBaGVhZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBDYW1lcmEgU3RhdGUKICAgICAgICAgICAgdGhpcy5wb3MgPSBjYW1lcmEucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIE9yYml0IFN0YXRlCiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IE1hdGguUEk7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0WWF3ID0gTWF0aC5QSTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBNYW51YWwgb3JiaXQgZnJvbSB0b3VjaCAocmlnaHQgc2lkZSBvZiBzY3JlZW4pCiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSAwOwogICAgICAgICAgICB0aGlzLm9yYml0U2Vuc2l0aXZpdHkgPSAwLjAwNDsKICAgICAgICAgICAgdGhpcy5hdXRvUmVjZW50ZXJUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyRGVsYXkgPSAzLjA7CgovLyBTaGFrZQogICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gMDsKICAgICAgICAgICAgdGhpcy5zaGFrZVJvbGwgPSAwOyAvLyBORVc6IFJvdGF0aW9uYWwgc2hha2UKdGhpcy5zaGFrZU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSA9IDA7CiAgICAgICAgICAgIHRoaXMucm9sbEltcHVsc2UgPSAwOyAvLyBORVc6IER5bmFtaWMgdGlsdCBmb3IgY3VydmVzCgogICAgICAgICAgICAvLyBDaW5lbWF0aWMgU3RhdGUKICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVHlwZSA9ICdkZWZhdWx0JzsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNFbmRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IER5bmFtaWMgcHVsbC1iYWNrIGJhc2VkIG9uIGFjdGlvbgogICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4UHVsbEJhY2sgPSA4OwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBTZXQgYmFsbCByZWZlcmVuY2UgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICBzZXRCYWxsKGJhbGwpIHsKICAgICAgICAgICAgdGhpcy5iYWxsID0gYmFsbDsKICAgICAgICB9CgogICAgICAgIC8vIElNUFJPVkVEOiBHZXQgY2FtZXJhLXJlbGF0aXZlIGlucHV0IHRyYW5zZm9ybWF0aW9uCiAgICAgICAgZ2V0Q2FtZXJhUmVsYXRpdmVJbnB1dChpbnB1dFgsIGlucHV0WikgewogICAgICAgICAgICB0aGlzLmNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKCiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKSwgX2NhbUZ3ZCkubm9ybWFsaXplKCk7CgogICAgICAgICAgICAvLyBUcmFuc2Zvcm0gaW5wdXQgdG8gd29ybGQgc3BhY2UKICAgICAgICAgICAgY29uc3Qgd29ybGRYID0gKGlucHV0WCAqIF9jYW1SaWdodC54KSArIChpbnB1dFogKiBfY2FtRndkLngpOwogICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoaW5wdXRYICogX2NhbVJpZ2h0LnopICsgKGlucHV0WiAqIF9jYW1Gd2Queik7CgogICAgICAgICAgICByZXR1cm4geyB4OiB3b3JsZFgsIHo6IHdvcmxkWiB9OwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBNYW51YWwgb3JiaXQgaW5wdXQgZnJvbSB0b3VjaAogICAgICAgIGhhbmRsZU9yYml0SW5wdXQoZHgsIGR5KSB7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgKz0gZHggKiB0aGlzLm9yYml0U2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCArPSBkeSAqIHRoaXMub3JiaXRTZW5zaXRpdml0eSAqIDAuNTsKCiAgICAgICAgICAgIC8vIENsYW1wIHBpdGNoCiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IE1hdGgubWF4KC0wLjMsIE1hdGgubWluKDAuNSwgdGhpcy5tYW51YWxPcmJpdFBpdGNoKSk7CgogICAgICAgICAgICAvLyBSZXNldCBhdXRvLXJlY2VudGVyIHRpbWVyCiAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyVGltZXIgPSAwOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBSZWNlbnRlciBjYW1lcmEKICAgICAgICByZWNlbnRlcigpIHsKICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyA9IDA7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IDA7CiAgICAgICAgfQoKICAgICAgICBwbGF5Q2luZW1hdGljKHR5cGUsIHRhcmdldCwgZHVyYXRpb24gPSAxLjUpIHsKICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY0R1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1R5cGUgPSB0eXBlOwoKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydFBvcy5jb3B5KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydExvb2suY29weSh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLmFkZEZvdkltcHVsc2UoLTE1KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVDaW5lbWF0aWMoZHQpIHsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUaW1lciArPSBkdDsKICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBNYXRoLm1pbigxLjAsIHRoaXMuY2luZW1hdGljVGltZXIgLyB0aGlzLmNpbmVtYXRpY0R1cmF0aW9uKTsKCiAgICAgICAgICAgIGNvbnN0IHQgPSAxIC0gTWF0aC5wb3coMSAtIHByb2dyZXNzLCAzKTsKCiAgICAgICAgICAgIGxldCBhY3RpdmVUYXJnZXQgPSB0aGlzLnRhcmdldDsKICAgICAgICAgICAgbGV0IGlzQmFsbFRyYWNraW5nID0gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCA6IG51bGw7CgogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2ggJiYgYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnICYmIGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDIuMCkgewogICAgICAgICAgICAgICAgYWN0aXZlVGFyZ2V0ID0gYmFsbC5tZXNoOwogICAgICAgICAgICAgICAgaXNCYWxsVHJhY2tpbmcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWFjdGl2ZVRhcmdldCkgewogICAgICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhY3RpdmVUYXJnZXQuZ2V0V29ybGRQb3NpdGlvbihfdGFyZ2V0V29ybGRQb3MpOwoKICAgICAgICAgICAgY29uc3QgZW5kTG9vayA9IF90YXJnZXRXb3JsZFBvcy5jbG9uZSgpOwogICAgICAgICAgICBsZXQgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgbGV0IHJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIGlmIChpc0JhbGxUcmFja2luZykgewogICAgICAgICAgICAgICAgZW5kTG9vay5hZGRTY2FsZWRWZWN0b3IoYmFsbC52ZWxvY2l0eSwgMC4zKTsKCiAgICAgICAgICAgICAgICBmd2QuY29weShiYWxsLnZlbG9jaXR5KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgIGlmIChmd2QubGVuZ3RoU3EoKSA8IDAuMDEpIGZ3ZC5zZXQoMCwwLDEpOwogICAgICAgICAgICAgICAgZndkLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgIHJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIGZ3ZCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbmRMb29rLnkgKz0gMS41OwogICAgICAgICAgICAgICAgZndkLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24oYWN0aXZlVGFyZ2V0LnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgcmlnaHQuc2V0KDEsIDAsIDApLmFwcGx5UXVhdGVybmlvbihhY3RpdmVUYXJnZXQucXVhdGVybmlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGVuZFBvcyA9IF90YXJnZXRXb3JsZFBvcy5jbG9uZSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ2plY2h0JykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGlzQmFsbFRyYWNraW5nID8gMTQuMCA6IDEwLjA7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmd2QuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtZGlzdCkuYWRkKHJpZ2h0LmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMy4wKSk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSA2LjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5jaW5lbWF0aWNUeXBlID09PSAnc3BoZXJlJykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGlzQmFsbFRyYWNraW5nID8gMTYuMCA6IDEyLjA7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmd2QuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtZGlzdCk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSAxMC4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ2ludmlzaWJsZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSAxMi4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QgKiAwLjUpLmFkZChyaWdodC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKGRpc3QpKTsKICAgICAgICAgICAgICAgIGVuZFBvcy5hZGQob2Zmc2V0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy55ICs9IDUuMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE0LjAgOiAxMC4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gNS4wOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnBvcy5sZXJwKGVuZFBvcywgZHQgKiA0LjApOwogICAgICAgICAgICB0aGlzLmxvb2tBdC5sZXJwKGVuZExvb2ssIGR0ICogNi4wKTsKCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLmNvcHkodGhpcy5wb3MpOwogICAgICAgICAgICB0aGlzLmNhbWVyYS5sb29rQXQodGhpcy5sb29rQXQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2luZW1hdGljVGltZXIgPj0gdGhpcy5jaW5lbWF0aWNEdXJhdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKc2V0VGFyZ2V0KG1lc2gsIHZlbG9jaXR5LCBpbnB1dCwgaXNBaW1pbmcgPSBmYWxzZSkgewogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG1lc2g7CiAgICAgICAgICAgIGlmICh2ZWxvY2l0eSkgdGhpcy50YXJnZXRWZWwuY29weSh2ZWxvY2l0eSk7CiAgICAgICAgICAgIGlmIChpbnB1dCkgdGhpcy50YXJnZXRJbnB1dC5jb3B5KGlucHV0KTsKICAgICAgICAgICAgZWxzZSB0aGlzLnRhcmdldElucHV0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5pc0FpbWluZyA9IGlzQWltaW5nOwogICAgICAgIH0KCiAgICAgICAgLy8gS2VlcCBmb3IgY29tcGF0aWJpbGl0eQogICAgICAgIGhhbmRsZUlucHV0KGR4LCBkeSkgewogICAgICAgICAgICB0aGlzLmhhbmRsZU9yYml0SW5wdXQoZHgsIGR5KTsKICAgICAgICB9CgogICAgICAgIGdldFlhdygpIHsgcmV0dXJuIHRoaXMuY3VycmVudFlhdzsgfQoKICAgICAgICBhZGRTaGFrZShhbW91bnQpIHsKCiAgICAgICAgICAgIHRoaXMuc2hha2VJbnRlbnNpdHkgPSBNYXRoLm1pbih0aGlzLnNoYWtlSW50ZW5zaXR5ICsgYW1vdW50LCA0LjApOyAvLyBJbmNyZWFzZWQgY2FwCiAgICAgICAgICAgIHRoaXMuc2hha2VSb2xsID0gTWF0aC5taW4odGhpcy5zaGFrZVJvbGwgKyBhbW91bnQgKiAwLjIsIDAuOCk7IC8vIEFkZCByb2xsCiAgICAgICAgfQogICAgICAgIGFkZEZvdkltcHVsc2UoYW1vdW50KSB7CiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSA9IE1hdGgubWluKHRoaXMuZm92SW1wdWxzZSArIGFtb3VudCwgMzApOwoKICAgICAgICB9CiAgICAgICAgYWRkUm9sbEltcHVsc2UoYW1vdW50KSB7CiAgICAgICAgICAgIHRoaXMucm9sbEltcHVsc2UgKz0gYW1vdW50OwogICAgICAgICAgICAvLyBDbGFtcAogICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlID0gTWF0aC5tYXgoLTAuNSwgTWF0aC5taW4oMC41LCB0aGlzLnJvbGxJbXB1bHNlKSk7Cn0KCiAgICAgICAgc25hcFRvVGFyZ2V0KCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGFyZ2V0KSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIHRoaXMuX2NhbGN1bGF0ZUlkZWFsU3RhdGUoMCk7CgogICAgICAgICAgICB0aGlzLnBvcy5jb3B5KF9pZGVhbFBvcyk7CiAgICAgICAgICAgIHRoaXMubG9va0F0LmNvcHkoX2lkZWFsTG9vayk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IHRoaXMudGFyZ2V0WWF3OwoKICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uY29weSh0aGlzLnBvcyk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmxvb2tBdCh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLnNtb290aGVkSW5wdXQuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLCAwLCAwKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0NpbmVtYXRpYykgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQ2luZW1hdGljKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLnRhcmdldCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgc2FmZUR0ID0gTWF0aC5taW4oZHQsIDAuMDUpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEF1dG8tcmVjZW50ZXIgbG9naWMgKE9ubHkgaWYgbm90IGFpbWluZykKICAgICAgICAgICAgaWYgKCF0aGlzLmlzQWltaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyICs9IHNhZmVEdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1dG9SZWNlbnRlclRpbWVyID4gdGhpcy5hdXRvUmVjZW50ZXJEZWxheSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY2VudGVyU3BlZWQgPSAyLjAgKiBzYWZlRHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyAqPSAoMS4wIC0gcmVjZW50ZXJTcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFBpdGNoICo9ICgxLjAgLSByZWNlbnRlclNwZWVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IFNtYXJ0IHB1bGwtYmFjayBiYXNlZCBvbiBiYWxsIHNwZWVkCiAgICAgICAgICAgIGlmICh0aGlzLmJhbGwgJiYgdGhpcy5iYWxsLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsU3BlZWQgPSB0aGlzLmJhbGwudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRQdWxsQmFjayA9IE1hdGgubWluKHRoaXMubWF4UHVsbEJhY2ssIGJhbGxTcGVlZCAqIDAuMyk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayArPSAodGFyZ2V0UHVsbEJhY2sgLSB0aGlzLmN1cnJlbnRQdWxsQmFjaykgKiBzYWZlRHQgKiAzLjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayAqPSAoMS4wIC0gc2FmZUR0ICogMi4wKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMS4gVXBkYXRlIFRhcmdldCBJbmZvCiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBTdGF0ZQogICAgICAgICAgICB0aGlzLl9jYWxjdWxhdGVJZGVhbFN0YXRlKHNhZmVEdCk7CgogICAgICAgICAgICAvLyAzLiBJTVBST1ZFRDogRmFzdGVyLCBtb3JlIHJlc3BvbnNpdmUgc21vb3RoaW5nCiAgICAgICAgICAgIC8vIElmIGFpbWluZywgc25hcCBmYXN0ZXIgdG8gcHJldmVudCAiamFuayIKLy8gSWYgYWltaW5nLCBzbGlnaHRseSBmYXN0ZXIgZm9sbG93IGJ1dCBub3QgaW5zdGFudCBzbmFwCmNvbnN0IHNwZWVkTXVsdCA9IHRoaXMuaXNBaW1pbmcgPyAxLjUgOiAxLjA7CiAgICAgICAgICAgIGNvbnN0IGxvb2tGYWN0b3IgPSAxLjAgLSBNYXRoLmV4cCgtdGhpcy5jb25maWcubG9va1NwZWVkICogc3BlZWRNdWx0ICogc2FmZUR0KTsKICAgICAgICAgICAgY29uc3QgcG9zRmFjdG9yID0gMS4wIC0gTWF0aC5leHAoLXRoaXMuY29uZmlnLmZvbGxvd1NwZWVkICogc3BlZWRNdWx0ICogc2FmZUR0KTsKCiAgICAgICAgICAgIHRoaXMucG9zLmxlcnAoX2lkZWFsUG9zLCBwb3NGYWN0b3IpOwogICAgICAgICAgICB0aGlzLmxvb2tBdC5sZXJwKF9pZGVhbExvb2ssIGxvb2tGYWN0b3IpOwoKICAgICAgICAgICAgLy8gNC4gU2NyZWVuIFNoYWtlIChQb3NpdGlvbiAmIFJvdGF0aW9uKQogICAgICAgICAgICBpZiAodGhpcy5zaGFrZUludGVuc2l0eSA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRlY2F5ID0gOC4wICogc2FmZUR0OyAvLyBGYXN0IGRlY2F5IGZvciBzbmFwcHkgZmVlbAogICAgICAgICAgICAgICAgdGhpcy5zaGFrZUludGVuc2l0eSAtPSBkZWNheTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlSW50ZW5zaXR5IDwgMCkgdGhpcy5zaGFrZUludGVuc2l0eSA9IDA7CgogICAgICAgICAgICAgICAgY29uc3Qgc2hha2VNYWcgPSB0aGlzLnNoYWtlSW50ZW5zaXR5ICogMC41OwogICAgICAgICAgICAgICAgdGhpcy5zaGFrZU9mZnNldC5zZXQoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2VNYWcsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2VNYWcsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2VNYWcKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlT2Zmc2V0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUm9sbCBTaGFrZQogICAgICAgICAgICBpZiAodGhpcy5zaGFrZVJvbGwgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlUm9sbCAtPSA1LjAgKiBzYWZlRHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaGFrZVJvbGwgPCAwKSB0aGlzLnNoYWtlUm9sbCA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5yb3RhdGlvbi56ID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogdGhpcy5zaGFrZVJvbGw7Cn0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5yb3RhdGlvbi56ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgQ3VydmUgVGlsdCAoUm9sbCBJbXB1bHNlKQogICAgICAgICAgICBpZiAoTWF0aC5hYnModGhpcy5yb2xsSW1wdWxzZSkgPiAwLjAwMSkgewogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmEucm90YXRpb24ueiArPSB0aGlzLnJvbGxJbXB1bHNlOwogICAgICAgICAgICAgICAgdGhpcy5yb2xsSW1wdWxzZSAqPSAoMS4wIC0gNC4wICogc2FmZUR0KTsgLy8gRGVjYXkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNS4gRHluYW1pYyBGT1YKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnRhcmdldFZlbC5sZW5ndGgoKTsKICAgICAgICAgICAgY29uc3Qgc3BlZWRSYXRpbyA9IE1hdGgubWluKHNwZWVkIC8gMjAuMCwgMS4wKTsKICAgICAgICAgICAgY29uc3Qgd2FycCA9IHNwZWVkUmF0aW8gKiBzcGVlZFJhdGlvOwoKICAgICAgICAgICAgLy8gWm9vbSBpbiBzbGlnaHRseSB3aGVuIGFpbWluZwogICAgICAgICAgICBjb25zdCBhaW1ab29tID0gdGhpcy5pc0FpbWluZyA/IC01IDogMDsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0Rm92ID0gdGhpcy5jb25maWcuZm92QmFzZSArICh0aGlzLmNvbmZpZy5mb3ZNYXggLSB0aGlzLmNvbmZpZy5mb3ZCYXNlKSAqIHdhcnAgKyB0aGlzLmZvdkltcHVsc2UgKyBhaW1ab29tOwoKICAgICAgICAgICAgdGhpcy5mb3ZJbXB1bHNlICo9IE1hdGgubWF4KDAsIDEuMCAtICg1LjAgKiBzYWZlRHQpKTsKCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmZvdiArPSAodGFyZ2V0Rm92IC0gdGhpcy5jYW1lcmEuZm92KSAqIDMuMCAqIHNhZmVEdDsKICAgICAgICAgICAgdGhpcy5jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwoKICAgICAgICAgICAgLy8gNi4gQXBwbHkgdG8gQ2FtZXJhCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLmNvcHkodGhpcy5wb3MpLmFkZCh0aGlzLnNoYWtlT2Zmc2V0KTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKICAgICAgICB9CgogICAgICAgIF9jYWxjdWxhdGVJZGVhbFN0YXRlKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IHRQb3MgPSBfdGFyZ2V0V29ybGRQb3M7CgovLyAtLS0gQUlNIE1PREUgT1ZFUlJJREUgLS0tCiAgICAgICAgICAgIGlmICh0aGlzLmlzQWltaW5nKSB7CiAgICAgICAgICAgICAgICAvLyBSZWxheGVkIEFpbSBNb2RlOiBab29tIGluIGJ1dCBtYWludGFpbiBvcmllbnRhdGlvbgogICAgICAgICAgICAgICAgY29uc3QgYWltRGlzdCA9IDE2LjA7IAogICAgICAgICAgICAgICAgY29uc3QgYWltSGVpZ2h0ID0gOC4wOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVc2UgTWFudWFsIE9yYml0IExvZ2ljIChDb25zaXN0ZW50IHdpdGggU3RhbmRhcmQgTW9kZSkKICAgICAgICAgICAgICAgIC8vIFRoaXMgcHJldmVudHMgdGhlIGNhbWVyYSBmcm9tIHNuYXBwaW5nICJiZWhpbmQiIHRoZSBwbGF5ZXIgaWYgdGhleSBhcmUgbW92aW5nIHNpZGV3YXlzCiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVEaXN0YW5jZSA9IGFpbURpc3Q7CiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVIZWlnaHQgPSBhaW1IZWlnaHQgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmFzZSBaIG9mZnNldCAoQ2FtZXJhIGRlZmF1bHRzIHRvICtaKQogICAgICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBcHBseSBPcmJpdCBSb3RhdGlvbgogICAgICAgICAgICAgICAgY29uc3QgZmluYWxYID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgY29uc3QgZmluYWxaID0gY2FtWiAqIE1hdGguY29zKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbFopOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmNvcHkodFBvcyk7CiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLnkgKz0gMS4wOyAvLyBMb29rIGF0IHBsYXllciBjZW50ZXIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzYWJsZSBsb29rLWFoZWFkIHRvIGtlZXAgZnJhbWluZyBzdGFibGUgd2hpbGUgYWltaW5nCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFNUQU5EQVJEIE1PREUgLS0tCgogICAgICAgICAgICAvLyBJTVBST1ZFRDogQXBwbHkgbWFudWFsIG9yYml0CiAgICAgICAgICAgIC8vIDEuIENhbGN1bGF0ZSBJZGVhbCBQb3NpdGlvbiB3aXRoIHB1bGwtYmFjawogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVEaXN0YW5jZSA9IHRoaXMuY29uZmlnLmJhc2VEaXN0YW5jZSArIHRoaXMuY3VycmVudFB1bGxCYWNrOwogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVIZWlnaHQgPSB0aGlzLmNvbmZpZy5iYXNlSGVpZ2h0ICsgdGhpcy5jdXJyZW50UHVsbEJhY2sgKiAwLjMgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKCiAgICAgICAgICAgIC8vIEJhc2Ugb2Zmc2V0IChDYW1lcmEgdXN1YWxseSBzaXRzIGF0ICtaIHJlbGF0aXZlIHRvIHRhcmdldCkKICAgICAgICAgICAgY29uc3QgY2FtWCA9IDA7IAogICAgICAgICAgICBjb25zdCBjYW1aID0gZWZmZWN0aXZlRGlzdGFuY2U7CgogICAgICAgICAgICAvLyBBcHBseSBPcmJpdCBSb3RhdGlvbgogICAgICAgICAgICAvLyB4JyA9IHgqY29zKHQpIC0geipzaW4odCkKICAgICAgICAgICAgLy8geicgPSB4KnNpbih0KSArIHoqY29zKHQpCiAgICAgICAgICAgIC8vIE5vdGU6IFRoZSBwcmV2aW91cyBtYXRoIHdhcyBzbGlnaHRseSB3ZWlyZCwgc3RhbmRhcmRpemluZyBoZXJlOgogICAgICAgICAgICAvLyBXZSB3YW50IFlhdyAwIHRvIGJlICtaLiAKICAgICAgICAgICAgY29uc3QgZmluYWxDYW1YID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICBjb25zdCBmaW5hbENhbVogPSBjYW1aICogTWF0aC5jb3ModGhpcy5tYW51YWxPcmJpdFlhdyk7CgogICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsQ2FtWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbENhbVopOwoKICAgICAgICAgICAgLy8gQ2xhbXAgdG8gYXJlbmEgYm91bmRzIChyb3VnaGx5KSB0byBwcmV2ZW50IGNsaXBwaW5nIHRocm91Z2ggd2FsbHMKICAgICAgICAgICAgaWYgKF9pZGVhbFBvcy56ID4gNDUuMCkgX2lkZWFsUG9zLnogPSA0NS4wOwogICAgICAgICAgICBpZiAoX2lkZWFsUG9zLnogPCAtNDUuMCkgX2lkZWFsUG9zLnogPSAtNDUuMDsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBMb29rQXQgd2l0aCBJTVBST1ZFRCBsb29rLWFoZWFkCiAgICAgICAgICAgIF9pZGVhbExvb2suY29weSh0UG9zKTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBWZWxvY2l0eS1iYXNlZCBsb29rLWFoZWFkCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFZlbC5sZW5ndGhTcSgpID4gMC41KSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudGFyZ2V0VmVsLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3QgbG9va0FoZWFkRmFjdG9yID0gTWF0aC5taW4oMS4wLCBzcGVlZCAvIDEwLjApICogdGhpcy5jb25maWcubG9va0FoZWFkRGlzdGFuY2U7CgogICAgICAgICAgICAgICAgY29uc3QgdmVsRGlyID0gdGhpcy50YXJnZXRWZWwuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIF9sb29rQWhlYWQuY29weSh2ZWxEaXIpLm11bHRpcGx5U2NhbGFyKGxvb2tBaGVhZEZhY3Rvcik7CgogICAgICAgICAgICAgICAgLy8gU21vb3RoIHRoZSBsb29rLWFoZWFkCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLmxlcnAoX2xvb2tBaGVhZCwgZHQgKiB0aGlzLmNvbmZpZy5sb29rQWhlYWRTbW9vdGhpbmcpOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay5hZGQodGhpcy5zbW9vdGhlZExvb2tBaGVhZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLm11bHRpcGx5U2NhbGFyKDEuMCAtIGR0ICogMi4wKTsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2suYWRkKHRoaXMuc21vb3RoZWRMb29rQWhlYWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfaWRlYWxMb29rLnkgKj0gMC41OyAvLyBMb29rIHNsaWdodGx5IGxvd2VyIHRoYW4gYWN0dWFsIHRhcmdldCBoZWlnaHQKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBJbmNsdWRlIGJhbGwgaW4gZnJhbWluZyB3aGVuIG5lYXJieQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5tZXNoICYmIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxQb3MgPSB0aGlzLmJhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSB0UG9zLmRpc3RhbmNlVG8oYmFsbFBvcyk7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCAyMCAmJiBkaXN0VG9CYWxsID4gMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxXZWlnaHQgPSBNYXRoLm1heCgwLCAxIC0gZGlzdFRvQmFsbCAvIDIwKSAqIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodDsKICAgICAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmxlcnAoYmFsbFBvcywgYmFsbFdlaWdodCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIElucHV0IEFudGljaXBhdGlvbiAoU21vb3RoZWQpCiAgICAgICAgICAgIHRoaXMuc21vb3RoZWRJbnB1dC5sZXJwKHRoaXMudGFyZ2V0SW5wdXQsIGR0ICogMi4wKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnNtb290aGVkSW5wdXQubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueCArPSB0aGlzLnNtb290aGVkSW5wdXQueCAqIDMuMDsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueiArPSB0aGlzLnNtb290aGVkSW5wdXQueiAqIDMuMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBHZXQgZm9yd2FyZCBkaXJlY3Rpb24gZm9yIFVJIHJlZmVyZW5jZQogICAgICAgIGdldEZvcndhcmREaXJlY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICBfY2FtRndkLnkgPSAwOwogICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIF9jYW1Gd2QuY2xvbmUoKTsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogR2V0IHJpZ2h0IGRpcmVjdGlvbgogICAgICAgIGdldFJpZ2h0RGlyZWN0aW9uKCkgewogICAgICAgICAgICBjb25zdCBmd2QgPSB0aGlzLmdldEZvcndhcmREaXJlY3Rpb24oKTsKICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKSwgZndkKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgcmV0dXJuIF9jYW1SaWdodC5jbG9uZSgpOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5DYW1lcmFNYW5hZ2VyID0gQ2FtZXJhTWFuYWdlcjsKfSkoKTsK","./CameraManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzIHRvIGF2b2lkIEdhcmJhZ2UgQ29sbGVjdGlvbgogICAgY29uc3QgX2lkZWFsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9pZGVhbExvb2sgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF92ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGFyZ2V0V29ybGRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9nb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICBjbGFzcyBDYW1lcmFNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihjYW1lcmEsIHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CgogICAgICAgICAgICAvLyAtLS0gSU1QUk9WRUQgQ09ORklHVVJBVElPTiAtLS0KICAgICAgICAgICAgdGhpcy5jb25maWcgPSB7CiAgICAgICAgICAgICAgICAvLyBGSVhFRCBQRVJTUEVDVElWRSBTRVRUSU5HUwogICAgICAgICAgICAgICAgYmFzZURpc3RhbmNlOiAyMi4wLAogICAgICAgICAgICAgICAgYmFzZUhlaWdodDogMTQuMCwKCiAgICAgICAgICAgICAgICAvLyBJTVBST1ZFRDogRmFzdGVyLCBtb3JlIHJlc3BvbnNpdmUgc21vb3RoaW5nCi8vIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKICAgICAgICAgICAgICAgIGZvbGxvd1NwZWVkOiA0LjAsICAgICAKICAgICAgICAgICAgICAgIGxvb2tTcGVlZDogMS41LCAgICAgICAvLyBSRURVQ0VEOiBMYXppZXIgbG9vayB0byByZXZlYWwgY3VydmUKCiAgICAgICAgICAgICAgICAvLyBEeW5hbWljIEZPVgogICAgICAgICAgICAgICAgZm92QmFzZTogNTAsCiAgICAgICAgICAgICAgICBmb3ZNYXg6IDYwLAoKICAgICAgICAgICAgICAgIC8vIElNUFJPVkVEOiBMb29rLWFoZWFkIHNldHRpbmdzCiAgICAgICAgICAgICAgICBsb29rQWhlYWREaXN0YW5jZTogNi4wLAogICAgICAgICAgICAgICAgbG9va0FoZWFkU21vb3RoaW5nOiAzLjAsCgogICAgICAgICAgICAgICAgLy8gU21hcnQgZnJhbWluZwpiYWxsVHJhY2tXZWlnaHQ6IDAuMSwgLy8gUkVEVUNFRDogRG9uJ3QgdHJhY2sgYmFsbCBsYXRlcmFsbHkgdG9vIG11Y2gKICAgICAgICAgICAgICAgIHRocmVhdEF3YXJlbmVzczogdHJ1ZQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gU3RhdGUKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmJhbGwgPSBudWxsOyAvLyBEaXJlY3QgYmFsbCByZWZlcmVuY2UgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICAgICAgdGhpcy50YXJnZXRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnRhcmdldElucHV0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZElucHV0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZExvb2tBaGVhZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBDYW1lcmEgU3RhdGUKICAgICAgICAgICAgdGhpcy5wb3MgPSBjYW1lcmEucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIE9yYml0IFN0YXRlCiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IE1hdGguUEk7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0WWF3ID0gTWF0aC5QSTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBNYW51YWwgb3JiaXQgZnJvbSB0b3VjaCAocmlnaHQgc2lkZSBvZiBzY3JlZW4pCiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSAwOwogICAgICAgICAgICB0aGlzLm9yYml0U2Vuc2l0aXZpdHkgPSAwLjAwNDsKICAgICAgICAgICAgdGhpcy5hdXRvUmVjZW50ZXJUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyRGVsYXkgPSAzLjA7CgovLyBTaGFrZQogICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gMDsKICAgICAgICAgICAgdGhpcy5zaGFrZVJvbGwgPSAwOyAvLyBORVc6IFJvdGF0aW9uYWwgc2hha2UKdGhpcy5zaGFrZU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSA9IDA7CiAgICAgICAgICAgIHRoaXMucm9sbEltcHVsc2UgPSAwOyAvLyBORVc6IER5bmFtaWMgdGlsdCBmb3IgY3VydmVzCgogICAgICAgICAgICAvLyBDaW5lbWF0aWMgU3RhdGUKICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVHlwZSA9ICdkZWZhdWx0JzsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNFbmRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IER5bmFtaWMgcHVsbC1iYWNrIGJhc2VkIG9uIGFjdGlvbgogICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4UHVsbEJhY2sgPSA4OwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBTZXQgYmFsbCByZWZlcmVuY2UgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICBzZXRCYWxsKGJhbGwpIHsKICAgICAgICAgICAgdGhpcy5iYWxsID0gYmFsbDsKICAgICAgICB9CgogICAgICAgIC8vIElNUFJPVkVEOiBHZXQgY2FtZXJhLXJlbGF0aXZlIGlucHV0IHRyYW5zZm9ybWF0aW9uCiAgICAgICAgZ2V0Q2FtZXJhUmVsYXRpdmVJbnB1dChpbnB1dFgsIGlucHV0WikgewogICAgICAgICAgICB0aGlzLmNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKCiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKSwgX2NhbUZ3ZCkubm9ybWFsaXplKCk7CgogICAgICAgICAgICAvLyBUcmFuc2Zvcm0gaW5wdXQgdG8gd29ybGQgc3BhY2UKICAgICAgICAgICAgY29uc3Qgd29ybGRYID0gKGlucHV0WCAqIF9jYW1SaWdodC54KSArIChpbnB1dFogKiBfY2FtRndkLngpOwogICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoaW5wdXRYICogX2NhbVJpZ2h0LnopICsgKGlucHV0WiAqIF9jYW1Gd2Queik7CgogICAgICAgICAgICByZXR1cm4geyB4OiB3b3JsZFgsIHo6IHdvcmxkWiB9OwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBNYW51YWwgb3JiaXQgaW5wdXQgZnJvbSB0b3VjaAogICAgICAgIGhhbmRsZU9yYml0SW5wdXQoZHgsIGR5KSB7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgKz0gZHggKiB0aGlzLm9yYml0U2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCArPSBkeSAqIHRoaXMub3JiaXRTZW5zaXRpdml0eSAqIDAuNTsKCiAgICAgICAgICAgIC8vIENsYW1wIHBpdGNoCiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IE1hdGgubWF4KC0wLjMsIE1hdGgubWluKDAuNSwgdGhpcy5tYW51YWxPcmJpdFBpdGNoKSk7CgogICAgICAgICAgICAvLyBSZXNldCBhdXRvLXJlY2VudGVyIHRpbWVyCiAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyVGltZXIgPSAwOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBSZWNlbnRlciBjYW1lcmEKICAgICAgICByZWNlbnRlcigpIHsKICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyA9IDA7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IDA7CiAgICAgICAgfQoKICAgICAgICBwbGF5Q2luZW1hdGljKHR5cGUsIHRhcmdldCwgZHVyYXRpb24gPSAxLjUpIHsKICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY0R1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1R5cGUgPSB0eXBlOwoKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydFBvcy5jb3B5KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydExvb2suY29weSh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLmFkZEZvdkltcHVsc2UoLTE1KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVDaW5lbWF0aWMoZHQpIHsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUaW1lciArPSBkdDsKICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBNYXRoLm1pbigxLjAsIHRoaXMuY2luZW1hdGljVGltZXIgLyB0aGlzLmNpbmVtYXRpY0R1cmF0aW9uKTsKCiAgICAgICAgICAgIGNvbnN0IHQgPSAxIC0gTWF0aC5wb3coMSAtIHByb2dyZXNzLCAzKTsKCiAgICAgICAgICAgIGxldCBhY3RpdmVUYXJnZXQgPSB0aGlzLnRhcmdldDsKICAgICAgICAgICAgbGV0IGlzQmFsbFRyYWNraW5nID0gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCA6IG51bGw7CgogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2ggJiYgYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnICYmIGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDIuMCkgewogICAgICAgICAgICAgICAgYWN0aXZlVGFyZ2V0ID0gYmFsbC5tZXNoOwogICAgICAgICAgICAgICAgaXNCYWxsVHJhY2tpbmcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWFjdGl2ZVRhcmdldCkgewogICAgICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhY3RpdmVUYXJnZXQuZ2V0V29ybGRQb3NpdGlvbihfdGFyZ2V0V29ybGRQb3MpOwoKICAgICAgICAgICAgY29uc3QgZW5kTG9vayA9IF90YXJnZXRXb3JsZFBvcy5jbG9uZSgpOwogICAgICAgICAgICBsZXQgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgbGV0IHJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIGlmIChpc0JhbGxUcmFja2luZykgewogICAgICAgICAgICAgICAgZW5kTG9vay5hZGRTY2FsZWRWZWN0b3IoYmFsbC52ZWxvY2l0eSwgMC4zKTsKCiAgICAgICAgICAgICAgICBmd2QuY29weShiYWxsLnZlbG9jaXR5KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgIGlmIChmd2QubGVuZ3RoU3EoKSA8IDAuMDEpIGZ3ZC5zZXQoMCwwLDEpOwogICAgICAgICAgICAgICAgZndkLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgIHJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIGZ3ZCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbmRMb29rLnkgKz0gMS41OwogICAgICAgICAgICAgICAgZndkLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24oYWN0aXZlVGFyZ2V0LnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgcmlnaHQuc2V0KDEsIDAsIDApLmFwcGx5UXVhdGVybmlvbihhY3RpdmVUYXJnZXQucXVhdGVybmlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGVuZFBvcyA9IF90YXJnZXRXb3JsZFBvcy5jbG9uZSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ2plY2h0JykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGlzQmFsbFRyYWNraW5nID8gMTQuMCA6IDEwLjA7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmd2QuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtZGlzdCkuYWRkKHJpZ2h0LmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMy4wKSk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSA2LjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5jaW5lbWF0aWNUeXBlID09PSAnc3BoZXJlJykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGlzQmFsbFRyYWNraW5nID8gMTYuMCA6IDEyLjA7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmd2QuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtZGlzdCk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSAxMC4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ2ludmlzaWJsZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSAxMi4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QgKiAwLjUpLmFkZChyaWdodC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKGRpc3QpKTsKICAgICAgICAgICAgICAgIGVuZFBvcy5hZGQob2Zmc2V0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy55ICs9IDUuMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE0LjAgOiAxMC4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gNS4wOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnBvcy5sZXJwKGVuZFBvcywgZHQgKiA0LjApOwogICAgICAgICAgICB0aGlzLmxvb2tBdC5sZXJwKGVuZExvb2ssIGR0ICogNi4wKTsKCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLmNvcHkodGhpcy5wb3MpOwogICAgICAgICAgICB0aGlzLmNhbWVyYS5sb29rQXQodGhpcy5sb29rQXQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2luZW1hdGljVGltZXIgPj0gdGhpcy5jaW5lbWF0aWNEdXJhdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKc2V0VGFyZ2V0KG1lc2gsIHZlbG9jaXR5LCBpbnB1dCwgaXNBaW1pbmcgPSBmYWxzZSkgewogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG1lc2g7CiAgICAgICAgICAgIGlmICh2ZWxvY2l0eSkgdGhpcy50YXJnZXRWZWwuY29weSh2ZWxvY2l0eSk7CiAgICAgICAgICAgIGlmIChpbnB1dCkgdGhpcy50YXJnZXRJbnB1dC5jb3B5KGlucHV0KTsKICAgICAgICAgICAgZWxzZSB0aGlzLnRhcmdldElucHV0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5pc0FpbWluZyA9IGlzQWltaW5nOwogICAgICAgIH0KCiAgICAgICAgLy8gS2VlcCBmb3IgY29tcGF0aWJpbGl0eQogICAgICAgIGhhbmRsZUlucHV0KGR4LCBkeSkgewogICAgICAgICAgICB0aGlzLmhhbmRsZU9yYml0SW5wdXQoZHgsIGR5KTsKICAgICAgICB9CgogICAgICAgIGdldFlhdygpIHsgcmV0dXJuIHRoaXMuY3VycmVudFlhdzsgfQoKICAgICAgICBhZGRTaGFrZShhbW91bnQpIHsKCiAgICAgICAgICAgIHRoaXMuc2hha2VJbnRlbnNpdHkgPSBNYXRoLm1pbih0aGlzLnNoYWtlSW50ZW5zaXR5ICsgYW1vdW50LCA0LjApOyAvLyBJbmNyZWFzZWQgY2FwCiAgICAgICAgICAgIHRoaXMuc2hha2VSb2xsID0gTWF0aC5taW4odGhpcy5zaGFrZVJvbGwgKyBhbW91bnQgKiAwLjIsIDAuOCk7IC8vIEFkZCByb2xsCiAgICAgICAgfQogICAgICAgIGFkZEZvdkltcHVsc2UoYW1vdW50KSB7CiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSA9IE1hdGgubWluKHRoaXMuZm92SW1wdWxzZSArIGFtb3VudCwgMzApOwoKICAgICAgICB9CiAgICAgICAgYWRkUm9sbEltcHVsc2UoYW1vdW50KSB7CiAgICAgICAgICAgIHRoaXMucm9sbEltcHVsc2UgKz0gYW1vdW50OwogICAgICAgICAgICAvLyBDbGFtcAogICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlID0gTWF0aC5tYXgoLTAuNSwgTWF0aC5taW4oMC41LCB0aGlzLnJvbGxJbXB1bHNlKSk7Cn0KCiAgICAgICAgc25hcFRvVGFyZ2V0KCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGFyZ2V0KSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIHRoaXMuX2NhbGN1bGF0ZUlkZWFsU3RhdGUoMCk7CgogICAgICAgICAgICB0aGlzLnBvcy5jb3B5KF9pZGVhbFBvcyk7CiAgICAgICAgICAgIHRoaXMubG9va0F0LmNvcHkoX2lkZWFsTG9vayk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IHRoaXMudGFyZ2V0WWF3OwoKICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uY29weSh0aGlzLnBvcyk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmxvb2tBdCh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLnNtb290aGVkSW5wdXQuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLCAwLCAwKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0NpbmVtYXRpYykgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQ2luZW1hdGljKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLnRhcmdldCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgc2FmZUR0ID0gTWF0aC5taW4oZHQsIDAuMDUpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEF1dG8tcmVjZW50ZXIgbG9naWMgKE9ubHkgaWYgbm90IGFpbWluZykKICAgICAgICAgICAgaWYgKCF0aGlzLmlzQWltaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyICs9IHNhZmVEdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1dG9SZWNlbnRlclRpbWVyID4gdGhpcy5hdXRvUmVjZW50ZXJEZWxheSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY2VudGVyU3BlZWQgPSAyLjAgKiBzYWZlRHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyAqPSAoMS4wIC0gcmVjZW50ZXJTcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFBpdGNoICo9ICgxLjAgLSByZWNlbnRlclNwZWVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IFNtYXJ0IHB1bGwtYmFjayBiYXNlZCBvbiBiYWxsIHNwZWVkCiAgICAgICAgICAgIGlmICh0aGlzLmJhbGwgJiYgdGhpcy5iYWxsLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsU3BlZWQgPSB0aGlzLmJhbGwudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRQdWxsQmFjayA9IE1hdGgubWluKHRoaXMubWF4UHVsbEJhY2ssIGJhbGxTcGVlZCAqIDAuMyk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayArPSAodGFyZ2V0UHVsbEJhY2sgLSB0aGlzLmN1cnJlbnRQdWxsQmFjaykgKiBzYWZlRHQgKiAzLjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayAqPSAoMS4wIC0gc2FmZUR0ICogMi4wKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMS4gVXBkYXRlIFRhcmdldCBJbmZvCiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBTdGF0ZQogICAgICAgICAgICB0aGlzLl9jYWxjdWxhdGVJZGVhbFN0YXRlKHNhZmVEdCk7CgogICAgICAgICAgICAvLyAzLiBJTVBST1ZFRDogRmFzdGVyLCBtb3JlIHJlc3BvbnNpdmUgc21vb3RoaW5nCiAgICAgICAgICAgIC8vIElmIGFpbWluZywgc25hcCBmYXN0ZXIgdG8gcHJldmVudCAiamFuayIKLy8gSWYgYWltaW5nLCBzbGlnaHRseSBmYXN0ZXIgZm9sbG93IGJ1dCBub3QgaW5zdGFudCBzbmFwCmNvbnN0IHNwZWVkTXVsdCA9IHRoaXMuaXNBaW1pbmcgPyAxLjUgOiAxLjA7CiAgICAgICAgICAgIGNvbnN0IGxvb2tGYWN0b3IgPSAxLjAgLSBNYXRoLmV4cCgtdGhpcy5jb25maWcubG9va1NwZWVkICogc3BlZWRNdWx0ICogc2FmZUR0KTsKICAgICAgICAgICAgY29uc3QgcG9zRmFjdG9yID0gMS4wIC0gTWF0aC5leHAoLXRoaXMuY29uZmlnLmZvbGxvd1NwZWVkICogc3BlZWRNdWx0ICogc2FmZUR0KTsKCiAgICAgICAgICAgIHRoaXMucG9zLmxlcnAoX2lkZWFsUG9zLCBwb3NGYWN0b3IpOwogICAgICAgICAgICB0aGlzLmxvb2tBdC5sZXJwKF9pZGVhbExvb2ssIGxvb2tGYWN0b3IpOwoKICAgICAgICAgICAgLy8gNC4gU2NyZWVuIFNoYWtlIChQb3NpdGlvbiAmIFJvdGF0aW9uKQogICAgICAgICAgICBpZiAodGhpcy5zaGFrZUludGVuc2l0eSA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRlY2F5ID0gOC4wICogc2FmZUR0OyAvLyBGYXN0IGRlY2F5IGZvciBzbmFwcHkgZmVlbAogICAgICAgICAgICAgICAgdGhpcy5zaGFrZUludGVuc2l0eSAtPSBkZWNheTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlSW50ZW5zaXR5IDwgMCkgdGhpcy5zaGFrZUludGVuc2l0eSA9IDA7CgogICAgICAgICAgICAgICAgY29uc3Qgc2hha2VNYWcgPSB0aGlzLnNoYWtlSW50ZW5zaXR5ICogMC41OwogICAgICAgICAgICAgICAgdGhpcy5zaGFrZU9mZnNldC5zZXQoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2VNYWcsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2VNYWcsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2VNYWcKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlT2Zmc2V0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUm9sbCBTaGFrZQogICAgICAgICAgICBpZiAodGhpcy5zaGFrZVJvbGwgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlUm9sbCAtPSA1LjAgKiBzYWZlRHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaGFrZVJvbGwgPCAwKSB0aGlzLnNoYWtlUm9sbCA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5yb3RhdGlvbi56ID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogdGhpcy5zaGFrZVJvbGw7Cn0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5yb3RhdGlvbi56ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgQ3VydmUgVGlsdCAoUm9sbCBJbXB1bHNlKQogICAgICAgICAgICBpZiAoTWF0aC5hYnModGhpcy5yb2xsSW1wdWxzZSkgPiAwLjAwMSkgewogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmEucm90YXRpb24ueiArPSB0aGlzLnJvbGxJbXB1bHNlOwogICAgICAgICAgICAgICAgdGhpcy5yb2xsSW1wdWxzZSAqPSAoMS4wIC0gNC4wICogc2FmZUR0KTsgLy8gRGVjYXkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNS4gRHluYW1pYyBGT1YKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnRhcmdldFZlbC5sZW5ndGgoKTsKICAgICAgICAgICAgY29uc3Qgc3BlZWRSYXRpbyA9IE1hdGgubWluKHNwZWVkIC8gMjAuMCwgMS4wKTsKICAgICAgICAgICAgY29uc3Qgd2FycCA9IHNwZWVkUmF0aW8gKiBzcGVlZFJhdGlvOwoKICAgICAgICAgICAgLy8gWm9vbSBpbiBzbGlnaHRseSB3aGVuIGFpbWluZwogICAgICAgICAgICBjb25zdCBhaW1ab29tID0gdGhpcy5pc0FpbWluZyA/IC01IDogMDsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0Rm92ID0gdGhpcy5jb25maWcuZm92QmFzZSArICh0aGlzLmNvbmZpZy5mb3ZNYXggLSB0aGlzLmNvbmZpZy5mb3ZCYXNlKSAqIHdhcnAgKyB0aGlzLmZvdkltcHVsc2UgKyBhaW1ab29tOwoKICAgICAgICAgICAgdGhpcy5mb3ZJbXB1bHNlICo9IE1hdGgubWF4KDAsIDEuMCAtICg1LjAgKiBzYWZlRHQpKTsKCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmZvdiArPSAodGFyZ2V0Rm92IC0gdGhpcy5jYW1lcmEuZm92KSAqIDMuMCAqIHNhZmVEdDsKICAgICAgICAgICAgdGhpcy5jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwoKICAgICAgICAgICAgLy8gNi4gQXBwbHkgdG8gQ2FtZXJhCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLmNvcHkodGhpcy5wb3MpLmFkZCh0aGlzLnNoYWtlT2Zmc2V0KTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKICAgICAgICB9CgogICAgICAgIF9jYWxjdWxhdGVJZGVhbFN0YXRlKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IHRQb3MgPSBfdGFyZ2V0V29ybGRQb3M7CgovLyAtLS0gQUlNIE1PREUgT1ZFUlJJREUgLS0tCiAgICAgICAgICAgIGlmICh0aGlzLmlzQWltaW5nKSB7CiAgICAgICAgICAgICAgICAvLyBSZWxheGVkIEFpbSBNb2RlOiBab29tIGluIGJ1dCBtYWludGFpbiBvcmllbnRhdGlvbgogICAgICAgICAgICAgICAgY29uc3QgYWltRGlzdCA9IDE2LjA7IAogICAgICAgICAgICAgICAgY29uc3QgYWltSGVpZ2h0ID0gOC4wOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVc2UgTWFudWFsIE9yYml0IExvZ2ljIChDb25zaXN0ZW50IHdpdGggU3RhbmRhcmQgTW9kZSkKICAgICAgICAgICAgICAgIC8vIFRoaXMgcHJldmVudHMgdGhlIGNhbWVyYSBmcm9tIHNuYXBwaW5nICJiZWhpbmQiIHRoZSBwbGF5ZXIgaWYgdGhleSBhcmUgbW92aW5nIHNpZGV3YXlzCiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVEaXN0YW5jZSA9IGFpbURpc3Q7CiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVIZWlnaHQgPSBhaW1IZWlnaHQgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmFzZSBaIG9mZnNldCAoQ2FtZXJhIGRlZmF1bHRzIHRvICtaKQogICAgICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBcHBseSBPcmJpdCBSb3RhdGlvbgogICAgICAgICAgICAgICAgY29uc3QgZmluYWxYID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgY29uc3QgZmluYWxaID0gY2FtWiAqIE1hdGguY29zKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbFopOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmNvcHkodFBvcyk7CiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLnkgKz0gMS4wOyAvLyBMb29rIGF0IHBsYXllciBjZW50ZXIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzYWJsZSBsb29rLWFoZWFkIHRvIGtlZXAgZnJhbWluZyBzdGFibGUgd2hpbGUgYWltaW5nCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFNUQU5EQVJEIE1PREUgLS0tCgogICAgICAgICAgICAvLyBJTVBST1ZFRDogQXBwbHkgbWFudWFsIG9yYml0CiAgICAgICAgICAgIC8vIDEuIENhbGN1bGF0ZSBJZGVhbCBQb3NpdGlvbiB3aXRoIHB1bGwtYmFjawogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVEaXN0YW5jZSA9IHRoaXMuY29uZmlnLmJhc2VEaXN0YW5jZSArIHRoaXMuY3VycmVudFB1bGxCYWNrOwogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVIZWlnaHQgPSB0aGlzLmNvbmZpZy5iYXNlSGVpZ2h0ICsgdGhpcy5jdXJyZW50UHVsbEJhY2sgKiAwLjMgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKCiAgICAgICAgICAgIC8vIEJhc2Ugb2Zmc2V0IChDYW1lcmEgdXN1YWxseSBzaXRzIGF0ICtaIHJlbGF0aXZlIHRvIHRhcmdldCkKICAgICAgICAgICAgY29uc3QgY2FtWCA9IDA7IAogICAgICAgICAgICBjb25zdCBjYW1aID0gZWZmZWN0aXZlRGlzdGFuY2U7CgogICAgICAgICAgICAvLyBBcHBseSBPcmJpdCBSb3RhdGlvbgogICAgICAgICAgICAvLyB4JyA9IHgqY29zKHQpIC0geipzaW4odCkKICAgICAgICAgICAgLy8geicgPSB4KnNpbih0KSArIHoqY29zKHQpCiAgICAgICAgICAgIC8vIE5vdGU6IFRoZSBwcmV2aW91cyBtYXRoIHdhcyBzbGlnaHRseSB3ZWlyZCwgc3RhbmRhcmRpemluZyBoZXJlOgogICAgICAgICAgICAvLyBXZSB3YW50IFlhdyAwIHRvIGJlICtaLiAKICAgICAgICAgICAgY29uc3QgZmluYWxDYW1YID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICBjb25zdCBmaW5hbENhbVogPSBjYW1aICogTWF0aC5jb3ModGhpcy5tYW51YWxPcmJpdFlhdyk7CgogICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsQ2FtWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbENhbVopOwoKICAgICAgICAgICAgLy8gQ2xhbXAgdG8gYXJlbmEgYm91bmRzIChyb3VnaGx5KSB0byBwcmV2ZW50IGNsaXBwaW5nIHRocm91Z2ggd2FsbHMKICAgICAgICAgICAgaWYgKF9pZGVhbFBvcy56ID4gNDUuMCkgX2lkZWFsUG9zLnogPSA0NS4wOwogICAgICAgICAgICBpZiAoX2lkZWFsUG9zLnogPCAtNDUuMCkgX2lkZWFsUG9zLnogPSAtNDUuMDsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBMb29rQXQgd2l0aCBJTVBST1ZFRCBsb29rLWFoZWFkCiAgICAgICAgICAgIF9pZGVhbExvb2suY29weSh0UG9zKTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBWZWxvY2l0eS1iYXNlZCBsb29rLWFoZWFkCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFZlbC5sZW5ndGhTcSgpID4gMC41KSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudGFyZ2V0VmVsLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3QgbG9va0FoZWFkRmFjdG9yID0gTWF0aC5taW4oMS4wLCBzcGVlZCAvIDEwLjApICogdGhpcy5jb25maWcubG9va0FoZWFkRGlzdGFuY2U7CgogICAgICAgICAgICAgICAgY29uc3QgdmVsRGlyID0gdGhpcy50YXJnZXRWZWwuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIF9sb29rQWhlYWQuY29weSh2ZWxEaXIpLm11bHRpcGx5U2NhbGFyKGxvb2tBaGVhZEZhY3Rvcik7CgogICAgICAgICAgICAgICAgLy8gU21vb3RoIHRoZSBsb29rLWFoZWFkCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLmxlcnAoX2xvb2tBaGVhZCwgZHQgKiB0aGlzLmNvbmZpZy5sb29rQWhlYWRTbW9vdGhpbmcpOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay5hZGQodGhpcy5zbW9vdGhlZExvb2tBaGVhZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLm11bHRpcGx5U2NhbGFyKDEuMCAtIGR0ICogMi4wKTsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2suYWRkKHRoaXMuc21vb3RoZWRMb29rQWhlYWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfaWRlYWxMb29rLnkgKj0gMC41OyAvLyBMb29rIHNsaWdodGx5IGxvd2VyIHRoYW4gYWN0dWFsIHRhcmdldCBoZWlnaHQKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBJbmNsdWRlIGJhbGwgaW4gZnJhbWluZyB3aGVuIG5lYXJieQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5tZXNoICYmIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxQb3MgPSB0aGlzLmJhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSB0UG9zLmRpc3RhbmNlVG8oYmFsbFBvcyk7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCAyMCAmJiBkaXN0VG9CYWxsID4gMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxXZWlnaHQgPSBNYXRoLm1heCgwLCAxIC0gZGlzdFRvQmFsbCAvIDIwKSAqIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodDsKICAgICAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmxlcnAoYmFsbFBvcywgYmFsbFdlaWdodCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIElucHV0IEFudGljaXBhdGlvbiAoU21vb3RoZWQpCiAgICAgICAgICAgIHRoaXMuc21vb3RoZWRJbnB1dC5sZXJwKHRoaXMudGFyZ2V0SW5wdXQsIGR0ICogMi4wKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnNtb290aGVkSW5wdXQubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueCArPSB0aGlzLnNtb290aGVkSW5wdXQueCAqIDMuMDsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueiArPSB0aGlzLnNtb290aGVkSW5wdXQueiAqIDMuMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBHZXQgZm9yd2FyZCBkaXJlY3Rpb24gZm9yIFVJIHJlZmVyZW5jZQogICAgICAgIGdldEZvcndhcmREaXJlY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICBfY2FtRndkLnkgPSAwOwogICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIF9jYW1Gd2QuY2xvbmUoKTsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogR2V0IHJpZ2h0IGRpcmVjdGlvbgogICAgICAgIGdldFJpZ2h0RGlyZWN0aW9uKCkgewogICAgICAgICAgICBjb25zdCBmd2QgPSB0aGlzLmdldEZvcndhcmREaXJlY3Rpb24oKTsKICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKSwgZndkKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgcmV0dXJuIF9jYW1SaWdodC5jbG9uZSgpOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5DYW1lcmFNYW5hZ2VyID0gQ2FtZXJhTWFuYWdlcjsKfSkoKTsK","/CameraManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzIHRvIGF2b2lkIEdhcmJhZ2UgQ29sbGVjdGlvbgogICAgY29uc3QgX2lkZWFsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9pZGVhbExvb2sgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF92ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGFyZ2V0V29ybGRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9nb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICBjbGFzcyBDYW1lcmFNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihjYW1lcmEsIHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CgogICAgICAgICAgICAvLyAtLS0gSU1QUk9WRUQgQ09ORklHVVJBVElPTiAtLS0KICAgICAgICAgICAgdGhpcy5jb25maWcgPSB7CiAgICAgICAgICAgICAgICAvLyBGSVhFRCBQRVJTUEVDVElWRSBTRVRUSU5HUwogICAgICAgICAgICAgICAgYmFzZURpc3RhbmNlOiAyMi4wLAogICAgICAgICAgICAgICAgYmFzZUhlaWdodDogMTQuMCwKCiAgICAgICAgICAgICAgICAvLyBJTVBST1ZFRDogRmFzdGVyLCBtb3JlIHJlc3BvbnNpdmUgc21vb3RoaW5nCi8vIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKICAgICAgICAgICAgICAgIGZvbGxvd1NwZWVkOiA0LjAsICAgICAKICAgICAgICAgICAgICAgIGxvb2tTcGVlZDogMS41LCAgICAgICAvLyBSRURVQ0VEOiBMYXppZXIgbG9vayB0byByZXZlYWwgY3VydmUKCiAgICAgICAgICAgICAgICAvLyBEeW5hbWljIEZPVgogICAgICAgICAgICAgICAgZm92QmFzZTogNTAsCiAgICAgICAgICAgICAgICBmb3ZNYXg6IDYwLAoKICAgICAgICAgICAgICAgIC8vIElNUFJPVkVEOiBMb29rLWFoZWFkIHNldHRpbmdzCiAgICAgICAgICAgICAgICBsb29rQWhlYWREaXN0YW5jZTogNi4wLAogICAgICAgICAgICAgICAgbG9va0FoZWFkU21vb3RoaW5nOiAzLjAsCgogICAgICAgICAgICAgICAgLy8gU21hcnQgZnJhbWluZwpiYWxsVHJhY2tXZWlnaHQ6IDAuMSwgLy8gUkVEVUNFRDogRG9uJ3QgdHJhY2sgYmFsbCBsYXRlcmFsbHkgdG9vIG11Y2gKICAgICAgICAgICAgICAgIHRocmVhdEF3YXJlbmVzczogdHJ1ZQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gU3RhdGUKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmJhbGwgPSBudWxsOyAvLyBEaXJlY3QgYmFsbCByZWZlcmVuY2UgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICAgICAgdGhpcy50YXJnZXRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnRhcmdldElucHV0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZElucHV0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZExvb2tBaGVhZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBDYW1lcmEgU3RhdGUKICAgICAgICAgICAgdGhpcy5wb3MgPSBjYW1lcmEucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIE9yYml0IFN0YXRlCiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IE1hdGguUEk7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0WWF3ID0gTWF0aC5QSTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBNYW51YWwgb3JiaXQgZnJvbSB0b3VjaCAocmlnaHQgc2lkZSBvZiBzY3JlZW4pCiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSAwOwogICAgICAgICAgICB0aGlzLm9yYml0U2Vuc2l0aXZpdHkgPSAwLjAwNDsKICAgICAgICAgICAgdGhpcy5hdXRvUmVjZW50ZXJUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyRGVsYXkgPSAzLjA7CgovLyBTaGFrZQogICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gMDsKICAgICAgICAgICAgdGhpcy5zaGFrZVJvbGwgPSAwOyAvLyBORVc6IFJvdGF0aW9uYWwgc2hha2UKdGhpcy5zaGFrZU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSA9IDA7CiAgICAgICAgICAgIHRoaXMucm9sbEltcHVsc2UgPSAwOyAvLyBORVc6IER5bmFtaWMgdGlsdCBmb3IgY3VydmVzCgogICAgICAgICAgICAvLyBDaW5lbWF0aWMgU3RhdGUKICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVHlwZSA9ICdkZWZhdWx0JzsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNFbmRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IER5bmFtaWMgcHVsbC1iYWNrIGJhc2VkIG9uIGFjdGlvbgogICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4UHVsbEJhY2sgPSA4OwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBTZXQgYmFsbCByZWZlcmVuY2UgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICBzZXRCYWxsKGJhbGwpIHsKICAgICAgICAgICAgdGhpcy5iYWxsID0gYmFsbDsKICAgICAgICB9CgogICAgICAgIC8vIElNUFJPVkVEOiBHZXQgY2FtZXJhLXJlbGF0aXZlIGlucHV0IHRyYW5zZm9ybWF0aW9uCiAgICAgICAgZ2V0Q2FtZXJhUmVsYXRpdmVJbnB1dChpbnB1dFgsIGlucHV0WikgewogICAgICAgICAgICB0aGlzLmNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKCiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKSwgX2NhbUZ3ZCkubm9ybWFsaXplKCk7CgogICAgICAgICAgICAvLyBUcmFuc2Zvcm0gaW5wdXQgdG8gd29ybGQgc3BhY2UKICAgICAgICAgICAgY29uc3Qgd29ybGRYID0gKGlucHV0WCAqIF9jYW1SaWdodC54KSArIChpbnB1dFogKiBfY2FtRndkLngpOwogICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoaW5wdXRYICogX2NhbVJpZ2h0LnopICsgKGlucHV0WiAqIF9jYW1Gd2Queik7CgogICAgICAgICAgICByZXR1cm4geyB4OiB3b3JsZFgsIHo6IHdvcmxkWiB9OwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBNYW51YWwgb3JiaXQgaW5wdXQgZnJvbSB0b3VjaAogICAgICAgIGhhbmRsZU9yYml0SW5wdXQoZHgsIGR5KSB7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgKz0gZHggKiB0aGlzLm9yYml0U2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCArPSBkeSAqIHRoaXMub3JiaXRTZW5zaXRpdml0eSAqIDAuNTsKCiAgICAgICAgICAgIC8vIENsYW1wIHBpdGNoCiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IE1hdGgubWF4KC0wLjMsIE1hdGgubWluKDAuNSwgdGhpcy5tYW51YWxPcmJpdFBpdGNoKSk7CgogICAgICAgICAgICAvLyBSZXNldCBhdXRvLXJlY2VudGVyIHRpbWVyCiAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyVGltZXIgPSAwOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBSZWNlbnRlciBjYW1lcmEKICAgICAgICByZWNlbnRlcigpIHsKICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyA9IDA7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IDA7CiAgICAgICAgfQoKICAgICAgICBwbGF5Q2luZW1hdGljKHR5cGUsIHRhcmdldCwgZHVyYXRpb24gPSAxLjUpIHsKICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY0R1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1R5cGUgPSB0eXBlOwoKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydFBvcy5jb3B5KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydExvb2suY29weSh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLmFkZEZvdkltcHVsc2UoLTE1KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVDaW5lbWF0aWMoZHQpIHsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUaW1lciArPSBkdDsKICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBNYXRoLm1pbigxLjAsIHRoaXMuY2luZW1hdGljVGltZXIgLyB0aGlzLmNpbmVtYXRpY0R1cmF0aW9uKTsKCiAgICAgICAgICAgIGNvbnN0IHQgPSAxIC0gTWF0aC5wb3coMSAtIHByb2dyZXNzLCAzKTsKCiAgICAgICAgICAgIGxldCBhY3RpdmVUYXJnZXQgPSB0aGlzLnRhcmdldDsKICAgICAgICAgICAgbGV0IGlzQmFsbFRyYWNraW5nID0gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCA6IG51bGw7CgogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2ggJiYgYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnICYmIGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDIuMCkgewogICAgICAgICAgICAgICAgYWN0aXZlVGFyZ2V0ID0gYmFsbC5tZXNoOwogICAgICAgICAgICAgICAgaXNCYWxsVHJhY2tpbmcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWFjdGl2ZVRhcmdldCkgewogICAgICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhY3RpdmVUYXJnZXQuZ2V0V29ybGRQb3NpdGlvbihfdGFyZ2V0V29ybGRQb3MpOwoKICAgICAgICAgICAgY29uc3QgZW5kTG9vayA9IF90YXJnZXRXb3JsZFBvcy5jbG9uZSgpOwogICAgICAgICAgICBsZXQgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgbGV0IHJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIGlmIChpc0JhbGxUcmFja2luZykgewogICAgICAgICAgICAgICAgZW5kTG9vay5hZGRTY2FsZWRWZWN0b3IoYmFsbC52ZWxvY2l0eSwgMC4zKTsKCiAgICAgICAgICAgICAgICBmd2QuY29weShiYWxsLnZlbG9jaXR5KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgIGlmIChmd2QubGVuZ3RoU3EoKSA8IDAuMDEpIGZ3ZC5zZXQoMCwwLDEpOwogICAgICAgICAgICAgICAgZndkLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgIHJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIGZ3ZCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbmRMb29rLnkgKz0gMS41OwogICAgICAgICAgICAgICAgZndkLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24oYWN0aXZlVGFyZ2V0LnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgcmlnaHQuc2V0KDEsIDAsIDApLmFwcGx5UXVhdGVybmlvbihhY3RpdmVUYXJnZXQucXVhdGVybmlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGVuZFBvcyA9IF90YXJnZXRXb3JsZFBvcy5jbG9uZSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ2plY2h0JykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGlzQmFsbFRyYWNraW5nID8gMTQuMCA6IDEwLjA7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmd2QuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtZGlzdCkuYWRkKHJpZ2h0LmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMy4wKSk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSA2LjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5jaW5lbWF0aWNUeXBlID09PSAnc3BoZXJlJykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGlzQmFsbFRyYWNraW5nID8gMTYuMCA6IDEyLjA7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmd2QuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtZGlzdCk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSAxMC4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ2ludmlzaWJsZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSAxMi4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QgKiAwLjUpLmFkZChyaWdodC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKGRpc3QpKTsKICAgICAgICAgICAgICAgIGVuZFBvcy5hZGQob2Zmc2V0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy55ICs9IDUuMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE0LjAgOiAxMC4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gNS4wOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnBvcy5sZXJwKGVuZFBvcywgZHQgKiA0LjApOwogICAgICAgICAgICB0aGlzLmxvb2tBdC5sZXJwKGVuZExvb2ssIGR0ICogNi4wKTsKCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLmNvcHkodGhpcy5wb3MpOwogICAgICAgICAgICB0aGlzLmNhbWVyYS5sb29rQXQodGhpcy5sb29rQXQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2luZW1hdGljVGltZXIgPj0gdGhpcy5jaW5lbWF0aWNEdXJhdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKc2V0VGFyZ2V0KG1lc2gsIHZlbG9jaXR5LCBpbnB1dCwgaXNBaW1pbmcgPSBmYWxzZSkgewogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG1lc2g7CiAgICAgICAgICAgIGlmICh2ZWxvY2l0eSkgdGhpcy50YXJnZXRWZWwuY29weSh2ZWxvY2l0eSk7CiAgICAgICAgICAgIGlmIChpbnB1dCkgdGhpcy50YXJnZXRJbnB1dC5jb3B5KGlucHV0KTsKICAgICAgICAgICAgZWxzZSB0aGlzLnRhcmdldElucHV0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5pc0FpbWluZyA9IGlzQWltaW5nOwogICAgICAgIH0KCiAgICAgICAgLy8gS2VlcCBmb3IgY29tcGF0aWJpbGl0eQogICAgICAgIGhhbmRsZUlucHV0KGR4LCBkeSkgewogICAgICAgICAgICB0aGlzLmhhbmRsZU9yYml0SW5wdXQoZHgsIGR5KTsKICAgICAgICB9CgogICAgICAgIGdldFlhdygpIHsgcmV0dXJuIHRoaXMuY3VycmVudFlhdzsgfQoKICAgICAgICBhZGRTaGFrZShhbW91bnQpIHsKCiAgICAgICAgICAgIHRoaXMuc2hha2VJbnRlbnNpdHkgPSBNYXRoLm1pbih0aGlzLnNoYWtlSW50ZW5zaXR5ICsgYW1vdW50LCA0LjApOyAvLyBJbmNyZWFzZWQgY2FwCiAgICAgICAgICAgIHRoaXMuc2hha2VSb2xsID0gTWF0aC5taW4odGhpcy5zaGFrZVJvbGwgKyBhbW91bnQgKiAwLjIsIDAuOCk7IC8vIEFkZCByb2xsCiAgICAgICAgfQogICAgICAgIGFkZEZvdkltcHVsc2UoYW1vdW50KSB7CiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSA9IE1hdGgubWluKHRoaXMuZm92SW1wdWxzZSArIGFtb3VudCwgMzApOwoKICAgICAgICB9CiAgICAgICAgYWRkUm9sbEltcHVsc2UoYW1vdW50KSB7CiAgICAgICAgICAgIHRoaXMucm9sbEltcHVsc2UgKz0gYW1vdW50OwogICAgICAgICAgICAvLyBDbGFtcAogICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlID0gTWF0aC5tYXgoLTAuNSwgTWF0aC5taW4oMC41LCB0aGlzLnJvbGxJbXB1bHNlKSk7Cn0KCiAgICAgICAgc25hcFRvVGFyZ2V0KCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGFyZ2V0KSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIHRoaXMuX2NhbGN1bGF0ZUlkZWFsU3RhdGUoMCk7CgogICAgICAgICAgICB0aGlzLnBvcy5jb3B5KF9pZGVhbFBvcyk7CiAgICAgICAgICAgIHRoaXMubG9va0F0LmNvcHkoX2lkZWFsTG9vayk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IHRoaXMudGFyZ2V0WWF3OwoKICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uY29weSh0aGlzLnBvcyk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmxvb2tBdCh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLnNtb290aGVkSW5wdXQuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLCAwLCAwKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0NpbmVtYXRpYykgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQ2luZW1hdGljKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLnRhcmdldCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgc2FmZUR0ID0gTWF0aC5taW4oZHQsIDAuMDUpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEF1dG8tcmVjZW50ZXIgbG9naWMgKE9ubHkgaWYgbm90IGFpbWluZykKICAgICAgICAgICAgaWYgKCF0aGlzLmlzQWltaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyICs9IHNhZmVEdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1dG9SZWNlbnRlclRpbWVyID4gdGhpcy5hdXRvUmVjZW50ZXJEZWxheSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY2VudGVyU3BlZWQgPSAyLjAgKiBzYWZlRHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyAqPSAoMS4wIC0gcmVjZW50ZXJTcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFBpdGNoICo9ICgxLjAgLSByZWNlbnRlclNwZWVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IFNtYXJ0IHB1bGwtYmFjayBiYXNlZCBvbiBiYWxsIHNwZWVkCiAgICAgICAgICAgIGlmICh0aGlzLmJhbGwgJiYgdGhpcy5iYWxsLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsU3BlZWQgPSB0aGlzLmJhbGwudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRQdWxsQmFjayA9IE1hdGgubWluKHRoaXMubWF4UHVsbEJhY2ssIGJhbGxTcGVlZCAqIDAuMyk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayArPSAodGFyZ2V0UHVsbEJhY2sgLSB0aGlzLmN1cnJlbnRQdWxsQmFjaykgKiBzYWZlRHQgKiAzLjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayAqPSAoMS4wIC0gc2FmZUR0ICogMi4wKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMS4gVXBkYXRlIFRhcmdldCBJbmZvCiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBTdGF0ZQogICAgICAgICAgICB0aGlzLl9jYWxjdWxhdGVJZGVhbFN0YXRlKHNhZmVEdCk7CgogICAgICAgICAgICAvLyAzLiBJTVBST1ZFRDogRmFzdGVyLCBtb3JlIHJlc3BvbnNpdmUgc21vb3RoaW5nCiAgICAgICAgICAgIC8vIElmIGFpbWluZywgc25hcCBmYXN0ZXIgdG8gcHJldmVudCAiamFuayIKLy8gSWYgYWltaW5nLCBzbGlnaHRseSBmYXN0ZXIgZm9sbG93IGJ1dCBub3QgaW5zdGFudCBzbmFwCmNvbnN0IHNwZWVkTXVsdCA9IHRoaXMuaXNBaW1pbmcgPyAxLjUgOiAxLjA7CiAgICAgICAgICAgIGNvbnN0IGxvb2tGYWN0b3IgPSAxLjAgLSBNYXRoLmV4cCgtdGhpcy5jb25maWcubG9va1NwZWVkICogc3BlZWRNdWx0ICogc2FmZUR0KTsKICAgICAgICAgICAgY29uc3QgcG9zRmFjdG9yID0gMS4wIC0gTWF0aC5leHAoLXRoaXMuY29uZmlnLmZvbGxvd1NwZWVkICogc3BlZWRNdWx0ICogc2FmZUR0KTsKCiAgICAgICAgICAgIHRoaXMucG9zLmxlcnAoX2lkZWFsUG9zLCBwb3NGYWN0b3IpOwogICAgICAgICAgICB0aGlzLmxvb2tBdC5sZXJwKF9pZGVhbExvb2ssIGxvb2tGYWN0b3IpOwoKICAgICAgICAgICAgLy8gNC4gU2NyZWVuIFNoYWtlIChQb3NpdGlvbiAmIFJvdGF0aW9uKQogICAgICAgICAgICBpZiAodGhpcy5zaGFrZUludGVuc2l0eSA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRlY2F5ID0gOC4wICogc2FmZUR0OyAvLyBGYXN0IGRlY2F5IGZvciBzbmFwcHkgZmVlbAogICAgICAgICAgICAgICAgdGhpcy5zaGFrZUludGVuc2l0eSAtPSBkZWNheTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlSW50ZW5zaXR5IDwgMCkgdGhpcy5zaGFrZUludGVuc2l0eSA9IDA7CgogICAgICAgICAgICAgICAgY29uc3Qgc2hha2VNYWcgPSB0aGlzLnNoYWtlSW50ZW5zaXR5ICogMC41OwogICAgICAgICAgICAgICAgdGhpcy5zaGFrZU9mZnNldC5zZXQoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2VNYWcsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2VNYWcsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2VNYWcKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlT2Zmc2V0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUm9sbCBTaGFrZQogICAgICAgICAgICBpZiAodGhpcy5zaGFrZVJvbGwgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlUm9sbCAtPSA1LjAgKiBzYWZlRHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaGFrZVJvbGwgPCAwKSB0aGlzLnNoYWtlUm9sbCA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5yb3RhdGlvbi56ID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogdGhpcy5zaGFrZVJvbGw7Cn0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5yb3RhdGlvbi56ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgQ3VydmUgVGlsdCAoUm9sbCBJbXB1bHNlKQogICAgICAgICAgICBpZiAoTWF0aC5hYnModGhpcy5yb2xsSW1wdWxzZSkgPiAwLjAwMSkgewogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmEucm90YXRpb24ueiArPSB0aGlzLnJvbGxJbXB1bHNlOwogICAgICAgICAgICAgICAgdGhpcy5yb2xsSW1wdWxzZSAqPSAoMS4wIC0gNC4wICogc2FmZUR0KTsgLy8gRGVjYXkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNS4gRHluYW1pYyBGT1YKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnRhcmdldFZlbC5sZW5ndGgoKTsKICAgICAgICAgICAgY29uc3Qgc3BlZWRSYXRpbyA9IE1hdGgubWluKHNwZWVkIC8gMjAuMCwgMS4wKTsKICAgICAgICAgICAgY29uc3Qgd2FycCA9IHNwZWVkUmF0aW8gKiBzcGVlZFJhdGlvOwoKICAgICAgICAgICAgLy8gWm9vbSBpbiBzbGlnaHRseSB3aGVuIGFpbWluZwogICAgICAgICAgICBjb25zdCBhaW1ab29tID0gdGhpcy5pc0FpbWluZyA/IC01IDogMDsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0Rm92ID0gdGhpcy5jb25maWcuZm92QmFzZSArICh0aGlzLmNvbmZpZy5mb3ZNYXggLSB0aGlzLmNvbmZpZy5mb3ZCYXNlKSAqIHdhcnAgKyB0aGlzLmZvdkltcHVsc2UgKyBhaW1ab29tOwoKICAgICAgICAgICAgdGhpcy5mb3ZJbXB1bHNlICo9IE1hdGgubWF4KDAsIDEuMCAtICg1LjAgKiBzYWZlRHQpKTsKCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmZvdiArPSAodGFyZ2V0Rm92IC0gdGhpcy5jYW1lcmEuZm92KSAqIDMuMCAqIHNhZmVEdDsKICAgICAgICAgICAgdGhpcy5jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwoKICAgICAgICAgICAgLy8gNi4gQXBwbHkgdG8gQ2FtZXJhCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLmNvcHkodGhpcy5wb3MpLmFkZCh0aGlzLnNoYWtlT2Zmc2V0KTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKICAgICAgICB9CgogICAgICAgIF9jYWxjdWxhdGVJZGVhbFN0YXRlKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IHRQb3MgPSBfdGFyZ2V0V29ybGRQb3M7CgovLyAtLS0gQUlNIE1PREUgT1ZFUlJJREUgLS0tCiAgICAgICAgICAgIGlmICh0aGlzLmlzQWltaW5nKSB7CiAgICAgICAgICAgICAgICAvLyBSZWxheGVkIEFpbSBNb2RlOiBab29tIGluIGJ1dCBtYWludGFpbiBvcmllbnRhdGlvbgogICAgICAgICAgICAgICAgY29uc3QgYWltRGlzdCA9IDE2LjA7IAogICAgICAgICAgICAgICAgY29uc3QgYWltSGVpZ2h0ID0gOC4wOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVc2UgTWFudWFsIE9yYml0IExvZ2ljIChDb25zaXN0ZW50IHdpdGggU3RhbmRhcmQgTW9kZSkKICAgICAgICAgICAgICAgIC8vIFRoaXMgcHJldmVudHMgdGhlIGNhbWVyYSBmcm9tIHNuYXBwaW5nICJiZWhpbmQiIHRoZSBwbGF5ZXIgaWYgdGhleSBhcmUgbW92aW5nIHNpZGV3YXlzCiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVEaXN0YW5jZSA9IGFpbURpc3Q7CiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVIZWlnaHQgPSBhaW1IZWlnaHQgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmFzZSBaIG9mZnNldCAoQ2FtZXJhIGRlZmF1bHRzIHRvICtaKQogICAgICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBcHBseSBPcmJpdCBSb3RhdGlvbgogICAgICAgICAgICAgICAgY29uc3QgZmluYWxYID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgY29uc3QgZmluYWxaID0gY2FtWiAqIE1hdGguY29zKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbFopOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmNvcHkodFBvcyk7CiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLnkgKz0gMS4wOyAvLyBMb29rIGF0IHBsYXllciBjZW50ZXIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzYWJsZSBsb29rLWFoZWFkIHRvIGtlZXAgZnJhbWluZyBzdGFibGUgd2hpbGUgYWltaW5nCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFNUQU5EQVJEIE1PREUgLS0tCgogICAgICAgICAgICAvLyBJTVBST1ZFRDogQXBwbHkgbWFudWFsIG9yYml0CiAgICAgICAgICAgIC8vIDEuIENhbGN1bGF0ZSBJZGVhbCBQb3NpdGlvbiB3aXRoIHB1bGwtYmFjawogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVEaXN0YW5jZSA9IHRoaXMuY29uZmlnLmJhc2VEaXN0YW5jZSArIHRoaXMuY3VycmVudFB1bGxCYWNrOwogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVIZWlnaHQgPSB0aGlzLmNvbmZpZy5iYXNlSGVpZ2h0ICsgdGhpcy5jdXJyZW50UHVsbEJhY2sgKiAwLjMgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKCiAgICAgICAgICAgIC8vIEJhc2Ugb2Zmc2V0IChDYW1lcmEgdXN1YWxseSBzaXRzIGF0ICtaIHJlbGF0aXZlIHRvIHRhcmdldCkKICAgICAgICAgICAgY29uc3QgY2FtWCA9IDA7IAogICAgICAgICAgICBjb25zdCBjYW1aID0gZWZmZWN0aXZlRGlzdGFuY2U7CgogICAgICAgICAgICAvLyBBcHBseSBPcmJpdCBSb3RhdGlvbgogICAgICAgICAgICAvLyB4JyA9IHgqY29zKHQpIC0geipzaW4odCkKICAgICAgICAgICAgLy8geicgPSB4KnNpbih0KSArIHoqY29zKHQpCiAgICAgICAgICAgIC8vIE5vdGU6IFRoZSBwcmV2aW91cyBtYXRoIHdhcyBzbGlnaHRseSB3ZWlyZCwgc3RhbmRhcmRpemluZyBoZXJlOgogICAgICAgICAgICAvLyBXZSB3YW50IFlhdyAwIHRvIGJlICtaLiAKICAgICAgICAgICAgY29uc3QgZmluYWxDYW1YID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICBjb25zdCBmaW5hbENhbVogPSBjYW1aICogTWF0aC5jb3ModGhpcy5tYW51YWxPcmJpdFlhdyk7CgogICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsQ2FtWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbENhbVopOwoKICAgICAgICAgICAgLy8gQ2xhbXAgdG8gYXJlbmEgYm91bmRzIChyb3VnaGx5KSB0byBwcmV2ZW50IGNsaXBwaW5nIHRocm91Z2ggd2FsbHMKICAgICAgICAgICAgaWYgKF9pZGVhbFBvcy56ID4gNDUuMCkgX2lkZWFsUG9zLnogPSA0NS4wOwogICAgICAgICAgICBpZiAoX2lkZWFsUG9zLnogPCAtNDUuMCkgX2lkZWFsUG9zLnogPSAtNDUuMDsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBMb29rQXQgd2l0aCBJTVBST1ZFRCBsb29rLWFoZWFkCiAgICAgICAgICAgIF9pZGVhbExvb2suY29weSh0UG9zKTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBWZWxvY2l0eS1iYXNlZCBsb29rLWFoZWFkCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFZlbC5sZW5ndGhTcSgpID4gMC41KSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudGFyZ2V0VmVsLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3QgbG9va0FoZWFkRmFjdG9yID0gTWF0aC5taW4oMS4wLCBzcGVlZCAvIDEwLjApICogdGhpcy5jb25maWcubG9va0FoZWFkRGlzdGFuY2U7CgogICAgICAgICAgICAgICAgY29uc3QgdmVsRGlyID0gdGhpcy50YXJnZXRWZWwuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIF9sb29rQWhlYWQuY29weSh2ZWxEaXIpLm11bHRpcGx5U2NhbGFyKGxvb2tBaGVhZEZhY3Rvcik7CgogICAgICAgICAgICAgICAgLy8gU21vb3RoIHRoZSBsb29rLWFoZWFkCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLmxlcnAoX2xvb2tBaGVhZCwgZHQgKiB0aGlzLmNvbmZpZy5sb29rQWhlYWRTbW9vdGhpbmcpOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay5hZGQodGhpcy5zbW9vdGhlZExvb2tBaGVhZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLm11bHRpcGx5U2NhbGFyKDEuMCAtIGR0ICogMi4wKTsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2suYWRkKHRoaXMuc21vb3RoZWRMb29rQWhlYWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfaWRlYWxMb29rLnkgKj0gMC41OyAvLyBMb29rIHNsaWdodGx5IGxvd2VyIHRoYW4gYWN0dWFsIHRhcmdldCBoZWlnaHQKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBJbmNsdWRlIGJhbGwgaW4gZnJhbWluZyB3aGVuIG5lYXJieQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5tZXNoICYmIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxQb3MgPSB0aGlzLmJhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSB0UG9zLmRpc3RhbmNlVG8oYmFsbFBvcyk7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCAyMCAmJiBkaXN0VG9CYWxsID4gMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxXZWlnaHQgPSBNYXRoLm1heCgwLCAxIC0gZGlzdFRvQmFsbCAvIDIwKSAqIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodDsKICAgICAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmxlcnAoYmFsbFBvcywgYmFsbFdlaWdodCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIElucHV0IEFudGljaXBhdGlvbiAoU21vb3RoZWQpCiAgICAgICAgICAgIHRoaXMuc21vb3RoZWRJbnB1dC5sZXJwKHRoaXMudGFyZ2V0SW5wdXQsIGR0ICogMi4wKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnNtb290aGVkSW5wdXQubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueCArPSB0aGlzLnNtb290aGVkSW5wdXQueCAqIDMuMDsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueiArPSB0aGlzLnNtb290aGVkSW5wdXQueiAqIDMuMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBHZXQgZm9yd2FyZCBkaXJlY3Rpb24gZm9yIFVJIHJlZmVyZW5jZQogICAgICAgIGdldEZvcndhcmREaXJlY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICBfY2FtRndkLnkgPSAwOwogICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIF9jYW1Gd2QuY2xvbmUoKTsKICAgICAgICB9CgogICAgICAgIC8vIE5FVzogR2V0IHJpZ2h0IGRpcmVjdGlvbgogICAgICAgIGdldFJpZ2h0RGlyZWN0aW9uKCkgewogICAgICAgICAgICBjb25zdCBmd2QgPSB0aGlzLmdldEZvcndhcmREaXJlY3Rpb24oKTsKICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKSwgZndkKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgcmV0dXJuIF9jYW1SaWdodC5jbG9uZSgpOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5DYW1lcmFNYW5hZ2VyID0gQ2FtZXJhTWFuYWdlcjsKfSkoKTsK","ParticleManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUT1JTIC0tLQogICAgCiAgICAvLyAxLiBWZW5vbSBCdWJibGUgKEdyZWVuLCBzaGlueSwgc2hhcnApCiAgICBjb25zdCBfdmVub21UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMzIsIDMyLCA0LCAzMiwgMzIsIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgxNTAsIDI1NSwgMTAwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgwLCAyMDAsIDAsIDAuNSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCA1MCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45KSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDIwLCAyMCwgNiwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDIuIFNsZWVwIFp6egogICAgY29uc3QgX25hcFRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZvbnQgPSAnYm9sZCBpdGFsaWMgNDhweCBzYW5zLXNlcmlmJzsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gJyMwMDAwZmYnOwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gNDsKICAgICAgICBjdHguZmlsbFRleHQoJ1onLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gMy4gV2l0aGVyIFNtb2tlCi8vIDMuIFdpdGhlciBTbW9rZSAoT3B0aW1pemVkIHRvIDMyeDMyKQogICAgY29uc3QgX3dpdGhlclRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSAzMjsgYy5oZWlnaHQgPSAzMjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgxNiwgMTYsIDAsIDE2LCAxNiwgMTYpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDgwLCA4MCwgODAsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjUsICdyZ2JhKDQwLCA0MCwgNDAsIDAuNCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCAwLCAwLCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNC4gU2hvY2t3YXZlIFJpbmcgKE9wdGltaXplZCB0byA2NHg2NCkKICAgIGNvbnN0IF9zaG9ja3dhdmVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGN4ID0gMzIsIGN5ID0gMzI7CiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChjeCwgY3ksIDIwLCBjeCwgY3ksIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCA2NCwgNjQpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNS4gRmxhc2ggU3RhciAoT3B0aW1pemVkIHRvIDMyeDMyKQogICAgY29uc3QgX2ZsYXNoVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBjeCA9IDE2LCBjeSA9IDE2OwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmZmZic7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGZvcihsZXQgaT0wOyBpPDQ7IGkrKykgewogICAgICAgICAgICBjb25zdCBhID0gKGkgKiBNYXRoLlBJIC8gMik7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3gsIGN5KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKjE1LCBjeSArIE1hdGguc2luKGEpKjE1KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEgKyAwLjIpKjUsIGN5ICsgTWF0aC5zaW4oYSArIDAuMikqNSk7CiAgICAgICAgfQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChjeCwgY3ksIDAsIGN4LCBjeSwgMTApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDEpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoY3gsIGN5LCAxMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDYuIERlYnJpcyBTaGFyZCAoTmV3KQogICAgY29uc3QgX2RlYnJpc1RleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSAzMjsgYy5oZWlnaHQgPSAzMjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbygxNiwgMCk7IGN0eC5saW5lVG8oMzIsIDE2KTsgY3R4LmxpbmVUbygxNiwgMzIpOyBjdHgubGluZVRvKDAsIDE2KTsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNy4gQnViYmxlIFRleHR1cmUgKE5ldzogQWVzdGhldGljICYgU3VidGxlKQogICAgY29uc3QgX2J1YmJsZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgCiAgICAgICAgLy8gQ2xlYXIKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIDY0LCA2NCk7CgogICAgICAgIC8vIE1haW4gQnViYmxlIEJvZHkgKFNvZnQgR3JhZGllbnQpCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgyOCwgMjgsIDAsIDMyLCAzMiwgMzApOwoKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjQpJyk7IC8vIEJyaWdodGVyIGNvcmUKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjUsICdyZ2JhKDEwMCwgMjIwLCAyNTUsIDAuNiknKTsgLy8gTW9yZSBvcGFxdWUgYm9keQogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuOSwgJ3JnYmEoNTAsIDE1MCwgMjU1LCAwLjgpJyk7IC8vIFN0cm9uZyBlZGdlCiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoNTAsIDE1MCwgMjU1LCAwLjApJyk7IC8vIFNvZnQgZWRnZQogICAgICAgIAogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYygzMiwgMzIsIDMwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIC8vIFNoYXJwIFNwZWN1bGFyIEhpZ2hsaWdodCAoUmVmbGVjdGlvbikKICAgICAgICBjb25zdCBnMiA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgyMCwgMjAsIDAsIDIwLCAyMCwgMTIpOwogICAgICAgIGcyLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjkpJyk7CiAgICAgICAgZzIuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMCknKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzI7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyAKICAgICAgICBjdHguZWxsaXBzZSgyMiwgMjIsIDEwLCA2LCAtTWF0aC5QSSAvIDQsIDAsIE1hdGguUEkgKiAyKTsgCiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAKICAgICAgICAvLyBCb3R0b20gUmltIExpZ2h0Ci8vIEJvdHRvbSBSaW0gTGlnaHQKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyMDAsIDI1NSwgMjU1LCAwLjgpJzsgLy8gQnJpZ2h0ZXIgcmltCiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDM7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDMyLCAzMiwgMjgsIDAuMiAqIE1hdGguUEksIDAuOCAqIE1hdGguUEkpOyBjdHguc3Ryb2tlKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA4LiBNaWNybyBCdWJibGUgKE5ldzogU2hhcnAsIGhpZ2gtdmlzIGNhdml0YXRpb24pCiAgICBjb25zdCBfbWljcm9CdWJibGVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgMzIsIDMyKTsKICAgICAgICAKICAgICAgICAvLyBJbnRlbnNlIGJyaWdodCBjb3JlCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgxNiwgMTYsIDAsIDE2LCAxNiwgMTYpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDEuMCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjMsICdyZ2JhKDIyMCwgMjU1LCAyNTUsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjYsICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLjAsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDE2LCAxNiwgMTYsIDAsIE1hdGguUEkqMik7IGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA5LiBEYXNoIFN0cmVhbSAoTmV3OiBTcGVlZCBsaW5lKQogICAgY29uc3QgX2Rhc2hTdHJlYW1UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gMTY7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlTGluZWFyR3JhZGllbnQoMCwgMCwgNjQsIDApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDAsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoMjAwLCAyNTUsIDI1NSwgMC44KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDAsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIAogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCA0LCA2NCwgOCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjbGFzcyBQYXJ0aWNsZU1hbmFnZXIgewoKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMucGFydGljbGVzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNb2JpbGUgT3B0aW1pemF0aW9uOiBDaGVjayBzY3JlZW4gd2lkdGgKICAgICAgICAgICAgY29uc3QgaXNNb2JpbGUgPSB3aW5kb3cuaW5uZXJXaWR0aCA8IDgwMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNoYXJlZCBNYXRlcmlhbHMKICAgICAgICAgICAgLy8gTm90ZTogYWxwaGFUZXN0IGFkZGVkIHRvIE5vcm1hbEJsZW5kaW5nIG1hdGVyaWFscyB0byBoZWxwIEdQVSBkaXNjYXJkIHRyYW5zcGFyZW50IHBpeGVscwogICAgICAgICAgICB0aGlzLm1hdGVyaWFscyA9IHsKICAgICAgICAgICAgICAgIHZlbm9tOiBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyBtYXA6IF92ZW5vbVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIG5hcDogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfbmFwVGV4LCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhXcml0ZTogZmFsc2UsIGJsZW5kaW5nOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywgYWxwaGFUZXN0OiAwLjEgfSksCiAgICAgICAgICAgICAgICB3aXRoZXI6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3dpdGhlclRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsIGFscGhhVGVzdDogMC4wNSB9KSwKICAgICAgICAgICAgICAgIGxlYXJuZWQ6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3Zlbm9tVGV4LCBjb2xvcjogMHgwMGZmZmYsIHRyYW5zcGFyZW50OiB0cnVlLCBkZXB0aFdyaXRlOiBmYWxzZSwgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcgfSksCiAgICAgICAgICAgICAgICBzaG9ja3dhdmU6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3Nob2Nrd2F2ZVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIGZsYXNoOiBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyBtYXA6IF9mbGFzaFRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIGRlYnJpczogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfZGVicmlzVGV4LCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhXcml0ZTogZmFsc2UsIGJsZW5kaW5nOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywgYWxwaGFUZXN0OiAwLjEgfSksCiAgICAgICAgICAgICAgICBidWJibGU6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2J1YmJsZVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIGJ1YmJsZV9taWNybzogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfbWljcm9CdWJibGVUZXgsIHRyYW5zcGFyZW50OiB0cnVlLCBkZXB0aFdyaXRlOiBmYWxzZSwgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcgfSksCiAgICAgICAgICAgICAgICBkYXNoX3N0cmVhbTogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfZGFzaFN0cmVhbVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gT2JqZWN0IFBvb2wKICAgICAgICAgICAgdGhpcy5wb29sID0gW107CiAgICAgICAgICAgIC8vIFJlZHVjZSBwb29sIHNpemUgb24gbW9iaWxlIHRvIHByZXZlbnQgZXhjZXNzaXZlIG92ZXJkcmF3CiAgICAgICAgICAgIHRoaXMucG9vbFNpemUgPSBpc01vYmlsZSA/IDEyMCA6IDMwMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgLy8gQ2xvbmUgbWF0ZXJpYWwgdG8gYWxsb3cgaW5kaXZpZHVhbCBvcGFjaXR5L3JvdGF0aW9uCiAgICAgICAgICAgICAgICAvLyBXZSBjbG9uZSAndmVub20nIGFzIGEgcGxhY2Vob2xkZXIsIGl0IGdldHMgb3ZlcndyaXR0ZW4gaW4gc3Bhd24oKQogICAgICAgICAgICAgICAgY29uc3QgbWF0ID0gdGhpcy5tYXRlcmlhbHMudmVub20uY2xvbmUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUobWF0KTsgCiAgICAgICAgICAgICAgICBzcHJpdGUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgc3ByaXRlLnNjYWxlLnNldCgwLDAsMCk7IAogICAgICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBEaXNhYmxlIGZydXN0dW0gY3VsbGluZyBmb3IgcGFydGljbGVzIHRvIGF2b2lkIENQVSBvdmVyaGVhZCBvZiBib3VuZGluZyBib3ggY2FsYwogICAgICAgICAgICAgICAgLy8gc2luY2UgdGhleSBhcmUgYWx3YXlzIGluIGZyb250IG9mIGNhbWVyYSB1c3VhbGx5LCBvciBjaGVhcCB0byBkcmF3LgogICAgICAgICAgICAgICAgLy8gQWN0dWFsbHksIGtlZXBpbmcgY3VsbGluZyBpcyBiZXR0ZXIgaWYgdGhleSBnbyBvZmYgc2NyZWVuLgogICAgICAgICAgICAgICAgLy8gc3ByaXRlLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsgCiAgICAgICAgICAgICAgICB0aGlzLnNjZW5lLmFkZChzcHJpdGUpOwogICAgICAgICAgICAgICAgdGhpcy5wb29sLnB1c2goc3ByaXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMucG9vbC5maW5kKHMgPT4gIXMudmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghcCkgcmV0dXJuOwoKICAgICAgICAgICAgcC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHRlbXBsYXRlID0gdGhpcy5tYXRlcmlhbHNbdHlwZV0gfHwgdGhpcy5tYXRlcmlhbHMudmVub207CiAgICAgICAgICAgIHAubWF0ZXJpYWwubWFwID0gdGVtcGxhdGUubWFwOwogICAgICAgICAgICBwLm1hdGVyaWFsLmJsZW5kaW5nID0gdGVtcGxhdGUuYmxlbmRpbmc7CiAgICAgICAgICAgIHAubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRlbXBsYXRlLmRlcHRoV3JpdGU7CiAgICAgICAgICAgIHAubWF0ZXJpYWwudHJhbnNwYXJlbnQgPSB0ZW1wbGF0ZS50cmFuc3BhcmVudDsKCiAgICAgICAgICAgIHAucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgcC5tYXRlcmlhbC5yb3RhdGlvbiA9IDA7CiAgICAgICAgICAgIHAubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZmZmZmKTsKICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwoKICAgICAgICAgICAgY29uc3QgZGF0YSA9IHsKICAgICAgICAgICAgICAgIG1lc2g6IHAsCiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgICAgICAgYWdlOiAwLAogICAgICAgICAgICAgICAgbGlmZTogb3B0aW9ucy5saWZlIHx8IDEuMCwKICAgICAgICAgICAgICAgIG1heExpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksCiAgICAgICAgICAgICAgICBzdGFydFNjYWxlOiBvcHRpb25zLnNjYWxlIHx8IDEuMCwKICAgICAgICAgICAgICAgIGdyYXZpdHk6IDAsCiAgICAgICAgICAgICAgICBkcmFnOiAwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBDb25maWd1cmF0aW9uIHBlciB0eXBlCiAgICAgICAgICAgIGlmICh0eXBlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICBkYXRhLmxpZmUgPSAxLjAgKyBNYXRoLnJhbmRvbSgpICogMC41OwogICAgICAgICAgICAgICAgZGF0YS52ZWxvY2l0eS5zZXQoMCwgMS4wICsgTWF0aC5yYW5kb20oKSwgMCk7CiAgICAgICAgICAgICAgICBkYXRhLnN0YXJ0U2NhbGUgPSAwLjMgKyBNYXRoLnJhbmRvbSgpICogMC4yOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMC44OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ25hcCcpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgIGRhdGEudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yLCAwLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yKTsKICAgICAgICAgICAgICAgIGRhdGEuc3RhcnRTY2FsZSA9IDAuNDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDEuNTsKICAgICAgICAgICAgICAgIGRhdGEudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC41LCAwLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC41KTsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDAuNjsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3Nob2Nrd2F2ZScpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IG9wdGlvbnMubGlmZSB8fCAwLjQ7CiAgICAgICAgICAgICAgICBkYXRhLm1heExpZmUgPSBkYXRhLmxpZmU7CiAgICAgICAgICAgICAgICBkYXRhLnN0YXJ0U2NhbGUgPSBvcHRpb25zLnNjYWxlIHx8IDIuMDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdmbGFzaCcpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDAuMjsKICAgICAgICAgICAgICAgIGRhdGEubWF4TGlmZSA9IDAuMjsKICAgICAgICAgICAgICAgIGRhdGEuc3RhcnRTY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMy4wOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwoKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZGVicmlzJykgewogICAgICAgICAgICAgICAgZGF0YS5saWZlID0gMS41OwogICAgICAgICAgICAgICAgZGF0YS5tYXhMaWZlID0gMS41OwogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSA1LjAgKyBNYXRoLnJhbmRvbSgpICogMTAuMDsKICAgICAgICAgICAgICAgIGRhdGEudmVsb2NpdHkuc2V0KAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcGVlZCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAqIHNwZWVkICogMC41KSArIDIuMCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogc3BlZWQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBkYXRhLmdyYXZpdHkgPSAyMC4wOwogICAgICAgICAgICAgICAgZGF0YS5kcmFnID0gMS4wOwogICAgICAgICAgICAgICAgZGF0YS5zdGFydFNjYWxlID0gKG9wdGlvbnMuc2NhbGUgfHwgMC4zKSAqICgwLjUgKyBNYXRoLnJhbmRvbSgpKTsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2J1YmJsZScpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDEuMCArIE1hdGgucmFuZG9tKCkgKiAxLjA7CiAgICAgICAgICAgICAgICBkYXRhLm1heExpZmUgPSBkYXRhLmxpZmU7CiAgICAgICAgICAgICAgICBkYXRhLnZlbG9jaXR5LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjUsCiAgICAgICAgICAgICAgICAgICAgMC41ICsgTWF0aC5yYW5kb20oKSAqIDEuMCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjUKICAgICAgICAgICAgICAgICk7CmRhdGEuc3RhcnRTY2FsZSA9IChvcHRpb25zLnNjYWxlIHx8IDAuMykgKiAoMC44ICsgTWF0aC5yYW5kb20oKSAqIDAuNCk7IC8vIExhcmdlciBiYXNlIHNjYWxlCiAgICAgICAgICAgICAgICBwLm1hdGVyaWFsLm9wYWNpdHkgPSAwLjk7IC8vIE1vcmUgb3BhcXVlCiAgICAgICAgICAgICAgICBwLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGFhY2NmZik7CgogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdidWJibGVfbWljcm8nKSB7CiAgICAgICAgICAgICAgICBkYXRhLmxpZmUgPSAwLjQgKyBNYXRoLnJhbmRvbSgpICogMC40OwogICAgICAgICAgICAgICAgZGF0YS5tYXhMaWZlID0gZGF0YS5saWZlOwogICAgICAgICAgICAgICAgZGF0YS52ZWxvY2l0eS5zZXQoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMS41LAogICAgICAgICAgICAgICAgICAgIDEuNSArIE1hdGgucmFuZG9tKCkgKiAyLjAsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMS41CiAgICAgICAgICAgICAgICApOwpkYXRhLnN0YXJ0U2NhbGUgPSAob3B0aW9ucy5zY2FsZSB8fCAwLjE1KSAqICgwLjggKyBNYXRoLnJhbmRvbSgpICogMC41KTsgLy8gTGFyZ2VyIG1pY3JvIGJ1YmJsZXMKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZmZmZmKTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Rhc2hfc3RyZWFtJykgewogICAgICAgICAgICAgICAgZGF0YS5saWZlID0gMC4zOwogICAgICAgICAgICAgICAgZGF0YS5tYXhMaWZlID0gMC4zOwogICAgICAgICAgICAgICAgZGF0YS5zdGFydFNjYWxlID0gb3B0aW9ucy5zY2FsZSB8fCAyLjA7CiAgICAgICAgICAgICAgICBwLm1hdGVyaWFsLm9wYWNpdHkgPSAwLjg7CiAgICAgICAgICAgICAgICBwLm1hdGVyaWFsLnJvdGF0aW9uID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0eXBlICE9PSAnc2hvY2t3YXZlJykgewogICAgICAgICAgICAgICAgcC5zY2FsZS5zZXRTY2FsYXIoZGF0YS5zdGFydFNjYWxlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHAuc2NhbGUuc2V0U2NhbGFyKDAuMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMucGFydGljbGVzLnB1c2goZGF0YSk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMucGFydGljbGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5wYXJ0aWNsZXNbaV07CiAgICAgICAgICAgICAgICBwLmFnZSArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAocC5hZ2UgPj0gcC5saWZlKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlcy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IHAuYWdlIC8gcC5saWZlOwoKICAgICAgICAgICAgICAgIGlmIChwLmdyYXZpdHkgPiAwKSBwLnZlbG9jaXR5LnkgLT0gcC5ncmF2aXR5ICogZHQ7CiAgICAgICAgICAgICAgICBpZiAocC5kcmFnID4gMCkgcC52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihNYXRoLm1heCgwLCAxLjAgLSAocC5kcmFnICogZHQpKSk7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uYWRkU2NhbGVkVmVjdG9yKHAudmVsb2NpdHksIGR0KTsKCiAgICAgICAgICAgICAgICBpZiAocC50eXBlID09PSAnc2hvY2t3YXZlJykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBwLnN0YXJ0U2NhbGUgKiBNYXRoLnBvdyh0LCAwLjUpICogNS4wOyAKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKHMpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wIC0gTWF0aC5wb3codCwgMik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAudHlwZSA9PT0gJ2ZsYXNoJykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wIC0gdCk7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnNjYWxlLnNldFNjYWxhcihzKTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwucm90YXRpb24gKz0gNS4wICogZHQ7CgogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLnR5cGUgPT09ICdkZWJyaXMnKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLnJvdGF0aW9uICs9IDEwLjAgKiBkdDsKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAudHlwZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi54ICs9IE1hdGguc2luKHAuYWdlICogMTAgKyBwLm1lc2guaWQpICogZHQgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAwLjggKiAoMS4wIC0gTWF0aC5wb3codCwgMykpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLnR5cGUgPT09ICduYXAnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcyA9IHAuc3RhcnRTY2FsZSAqICgwLjUgKyB0ICogMS41KTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKHMpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wIC0gTWF0aC5wb3codCwgMik7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnggKz0gTWF0aC5zaW4ocC5hZ2UgKiAyKSAqIGR0ICogMC4zOwoKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocC50eXBlID09PSAnYnViYmxlJykgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi54ICs9IE1hdGguc2luKHAuYWdlICogNS4wICsgcC5tZXNoLmlkKSAqIGR0ICogMC4yOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi56ICs9IE1hdGguY29zKHAuYWdlICogNC4wICsgcC5tZXNoLmlkKSAqIGR0ICogMC4yOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wICsgdCAqIDAuMik7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnNjYWxlLnNldFNjYWxhcihzKTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IDAuNiAqICgxLjAgLSBNYXRoLnBvdyh0LCAyKSk7CgogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLnR5cGUgPT09ICdidWJibGVfbWljcm8nKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogZHQgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogZHQgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcyA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKHMpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMC45ICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMyID0gcC5zdGFydFNjYWxlOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXQoczIgKiAoMS4wICsgdCksIHMyICogMC4yLCAxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyID0gUGFydGljbGVNYW5hZ2VyOwp9KSgpOw==","./ParticleManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUT1JTIC0tLQogICAgCiAgICAvLyAxLiBWZW5vbSBCdWJibGUgKEdyZWVuLCBzaGlueSwgc2hhcnApCiAgICBjb25zdCBfdmVub21UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMzIsIDMyLCA0LCAzMiwgMzIsIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgxNTAsIDI1NSwgMTAwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgwLCAyMDAsIDAsIDAuNSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCA1MCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45KSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDIwLCAyMCwgNiwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDIuIFNsZWVwIFp6egogICAgY29uc3QgX25hcFRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZvbnQgPSAnYm9sZCBpdGFsaWMgNDhweCBzYW5zLXNlcmlmJzsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gJyMwMDAwZmYnOwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gNDsKICAgICAgICBjdHguZmlsbFRleHQoJ1onLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gMy4gV2l0aGVyIFNtb2tlCi8vIDMuIFdpdGhlciBTbW9rZSAoT3B0aW1pemVkIHRvIDMyeDMyKQogICAgY29uc3QgX3dpdGhlclRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSAzMjsgYy5oZWlnaHQgPSAzMjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgxNiwgMTYsIDAsIDE2LCAxNiwgMTYpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDgwLCA4MCwgODAsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjUsICdyZ2JhKDQwLCA0MCwgNDAsIDAuNCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCAwLCAwLCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNC4gU2hvY2t3YXZlIFJpbmcgKE9wdGltaXplZCB0byA2NHg2NCkKICAgIGNvbnN0IF9zaG9ja3dhdmVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGN4ID0gMzIsIGN5ID0gMzI7CiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChjeCwgY3ksIDIwLCBjeCwgY3ksIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCA2NCwgNjQpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNS4gRmxhc2ggU3RhciAoT3B0aW1pemVkIHRvIDMyeDMyKQogICAgY29uc3QgX2ZsYXNoVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBjeCA9IDE2LCBjeSA9IDE2OwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmZmZic7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGZvcihsZXQgaT0wOyBpPDQ7IGkrKykgewogICAgICAgICAgICBjb25zdCBhID0gKGkgKiBNYXRoLlBJIC8gMik7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3gsIGN5KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKjE1LCBjeSArIE1hdGguc2luKGEpKjE1KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEgKyAwLjIpKjUsIGN5ICsgTWF0aC5zaW4oYSArIDAuMikqNSk7CiAgICAgICAgfQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChjeCwgY3ksIDAsIGN4LCBjeSwgMTApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDEpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoY3gsIGN5LCAxMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDYuIERlYnJpcyBTaGFyZCAoTmV3KQogICAgY29uc3QgX2RlYnJpc1RleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSAzMjsgYy5oZWlnaHQgPSAzMjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbygxNiwgMCk7IGN0eC5saW5lVG8oMzIsIDE2KTsgY3R4LmxpbmVUbygxNiwgMzIpOyBjdHgubGluZVRvKDAsIDE2KTsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNy4gQnViYmxlIFRleHR1cmUgKE5ldzogQWVzdGhldGljICYgU3VidGxlKQogICAgY29uc3QgX2J1YmJsZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgCiAgICAgICAgLy8gQ2xlYXIKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIDY0LCA2NCk7CgogICAgICAgIC8vIE1haW4gQnViYmxlIEJvZHkgKFNvZnQgR3JhZGllbnQpCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgyOCwgMjgsIDAsIDMyLCAzMiwgMzApOwoKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjQpJyk7IC8vIEJyaWdodGVyIGNvcmUKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjUsICdyZ2JhKDEwMCwgMjIwLCAyNTUsIDAuNiknKTsgLy8gTW9yZSBvcGFxdWUgYm9keQogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuOSwgJ3JnYmEoNTAsIDE1MCwgMjU1LCAwLjgpJyk7IC8vIFN0cm9uZyBlZGdlCiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoNTAsIDE1MCwgMjU1LCAwLjApJyk7IC8vIFNvZnQgZWRnZQogICAgICAgIAogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYygzMiwgMzIsIDMwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIC8vIFNoYXJwIFNwZWN1bGFyIEhpZ2hsaWdodCAoUmVmbGVjdGlvbikKICAgICAgICBjb25zdCBnMiA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgyMCwgMjAsIDAsIDIwLCAyMCwgMTIpOwogICAgICAgIGcyLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjkpJyk7CiAgICAgICAgZzIuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMCknKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzI7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyAKICAgICAgICBjdHguZWxsaXBzZSgyMiwgMjIsIDEwLCA2LCAtTWF0aC5QSSAvIDQsIDAsIE1hdGguUEkgKiAyKTsgCiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAKICAgICAgICAvLyBCb3R0b20gUmltIExpZ2h0Ci8vIEJvdHRvbSBSaW0gTGlnaHQKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyMDAsIDI1NSwgMjU1LCAwLjgpJzsgLy8gQnJpZ2h0ZXIgcmltCiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDM7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDMyLCAzMiwgMjgsIDAuMiAqIE1hdGguUEksIDAuOCAqIE1hdGguUEkpOyBjdHguc3Ryb2tlKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA4LiBNaWNybyBCdWJibGUgKE5ldzogU2hhcnAsIGhpZ2gtdmlzIGNhdml0YXRpb24pCiAgICBjb25zdCBfbWljcm9CdWJibGVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgMzIsIDMyKTsKICAgICAgICAKICAgICAgICAvLyBJbnRlbnNlIGJyaWdodCBjb3JlCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgxNiwgMTYsIDAsIDE2LCAxNiwgMTYpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDEuMCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjMsICdyZ2JhKDIyMCwgMjU1LCAyNTUsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjYsICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLjAsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDE2LCAxNiwgMTYsIDAsIE1hdGguUEkqMik7IGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA5LiBEYXNoIFN0cmVhbSAoTmV3OiBTcGVlZCBsaW5lKQogICAgY29uc3QgX2Rhc2hTdHJlYW1UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gMTY7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlTGluZWFyR3JhZGllbnQoMCwgMCwgNjQsIDApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDAsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoMjAwLCAyNTUsIDI1NSwgMC44KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDAsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIAogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCA0LCA2NCwgOCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjbGFzcyBQYXJ0aWNsZU1hbmFnZXIgewoKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMucGFydGljbGVzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNb2JpbGUgT3B0aW1pemF0aW9uOiBDaGVjayBzY3JlZW4gd2lkdGgKICAgICAgICAgICAgY29uc3QgaXNNb2JpbGUgPSB3aW5kb3cuaW5uZXJXaWR0aCA8IDgwMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNoYXJlZCBNYXRlcmlhbHMKICAgICAgICAgICAgLy8gTm90ZTogYWxwaGFUZXN0IGFkZGVkIHRvIE5vcm1hbEJsZW5kaW5nIG1hdGVyaWFscyB0byBoZWxwIEdQVSBkaXNjYXJkIHRyYW5zcGFyZW50IHBpeGVscwogICAgICAgICAgICB0aGlzLm1hdGVyaWFscyA9IHsKICAgICAgICAgICAgICAgIHZlbm9tOiBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyBtYXA6IF92ZW5vbVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIG5hcDogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfbmFwVGV4LCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhXcml0ZTogZmFsc2UsIGJsZW5kaW5nOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywgYWxwaGFUZXN0OiAwLjEgfSksCiAgICAgICAgICAgICAgICB3aXRoZXI6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3dpdGhlclRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsIGFscGhhVGVzdDogMC4wNSB9KSwKICAgICAgICAgICAgICAgIGxlYXJuZWQ6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3Zlbm9tVGV4LCBjb2xvcjogMHgwMGZmZmYsIHRyYW5zcGFyZW50OiB0cnVlLCBkZXB0aFdyaXRlOiBmYWxzZSwgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcgfSksCiAgICAgICAgICAgICAgICBzaG9ja3dhdmU6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3Nob2Nrd2F2ZVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIGZsYXNoOiBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyBtYXA6IF9mbGFzaFRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIGRlYnJpczogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfZGVicmlzVGV4LCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhXcml0ZTogZmFsc2UsIGJsZW5kaW5nOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywgYWxwaGFUZXN0OiAwLjEgfSksCiAgICAgICAgICAgICAgICBidWJibGU6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2J1YmJsZVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIGJ1YmJsZV9taWNybzogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfbWljcm9CdWJibGVUZXgsIHRyYW5zcGFyZW50OiB0cnVlLCBkZXB0aFdyaXRlOiBmYWxzZSwgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcgfSksCiAgICAgICAgICAgICAgICBkYXNoX3N0cmVhbTogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfZGFzaFN0cmVhbVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gT2JqZWN0IFBvb2wKICAgICAgICAgICAgdGhpcy5wb29sID0gW107CiAgICAgICAgICAgIC8vIFJlZHVjZSBwb29sIHNpemUgb24gbW9iaWxlIHRvIHByZXZlbnQgZXhjZXNzaXZlIG92ZXJkcmF3CiAgICAgICAgICAgIHRoaXMucG9vbFNpemUgPSBpc01vYmlsZSA/IDEyMCA6IDMwMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgLy8gQ2xvbmUgbWF0ZXJpYWwgdG8gYWxsb3cgaW5kaXZpZHVhbCBvcGFjaXR5L3JvdGF0aW9uCiAgICAgICAgICAgICAgICAvLyBXZSBjbG9uZSAndmVub20nIGFzIGEgcGxhY2Vob2xkZXIsIGl0IGdldHMgb3ZlcndyaXR0ZW4gaW4gc3Bhd24oKQogICAgICAgICAgICAgICAgY29uc3QgbWF0ID0gdGhpcy5tYXRlcmlhbHMudmVub20uY2xvbmUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUobWF0KTsgCiAgICAgICAgICAgICAgICBzcHJpdGUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgc3ByaXRlLnNjYWxlLnNldCgwLDAsMCk7IAogICAgICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBEaXNhYmxlIGZydXN0dW0gY3VsbGluZyBmb3IgcGFydGljbGVzIHRvIGF2b2lkIENQVSBvdmVyaGVhZCBvZiBib3VuZGluZyBib3ggY2FsYwogICAgICAgICAgICAgICAgLy8gc2luY2UgdGhleSBhcmUgYWx3YXlzIGluIGZyb250IG9mIGNhbWVyYSB1c3VhbGx5LCBvciBjaGVhcCB0byBkcmF3LgogICAgICAgICAgICAgICAgLy8gQWN0dWFsbHksIGtlZXBpbmcgY3VsbGluZyBpcyBiZXR0ZXIgaWYgdGhleSBnbyBvZmYgc2NyZWVuLgogICAgICAgICAgICAgICAgLy8gc3ByaXRlLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsgCiAgICAgICAgICAgICAgICB0aGlzLnNjZW5lLmFkZChzcHJpdGUpOwogICAgICAgICAgICAgICAgdGhpcy5wb29sLnB1c2goc3ByaXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMucG9vbC5maW5kKHMgPT4gIXMudmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghcCkgcmV0dXJuOwoKICAgICAgICAgICAgcC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHRlbXBsYXRlID0gdGhpcy5tYXRlcmlhbHNbdHlwZV0gfHwgdGhpcy5tYXRlcmlhbHMudmVub207CiAgICAgICAgICAgIHAubWF0ZXJpYWwubWFwID0gdGVtcGxhdGUubWFwOwogICAgICAgICAgICBwLm1hdGVyaWFsLmJsZW5kaW5nID0gdGVtcGxhdGUuYmxlbmRpbmc7CiAgICAgICAgICAgIHAubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRlbXBsYXRlLmRlcHRoV3JpdGU7CiAgICAgICAgICAgIHAubWF0ZXJpYWwudHJhbnNwYXJlbnQgPSB0ZW1wbGF0ZS50cmFuc3BhcmVudDsKCiAgICAgICAgICAgIHAucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgcC5tYXRlcmlhbC5yb3RhdGlvbiA9IDA7CiAgICAgICAgICAgIHAubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZmZmZmKTsKICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwoKICAgICAgICAgICAgY29uc3QgZGF0YSA9IHsKICAgICAgICAgICAgICAgIG1lc2g6IHAsCiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgICAgICAgYWdlOiAwLAogICAgICAgICAgICAgICAgbGlmZTogb3B0aW9ucy5saWZlIHx8IDEuMCwKICAgICAgICAgICAgICAgIG1heExpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksCiAgICAgICAgICAgICAgICBzdGFydFNjYWxlOiBvcHRpb25zLnNjYWxlIHx8IDEuMCwKICAgICAgICAgICAgICAgIGdyYXZpdHk6IDAsCiAgICAgICAgICAgICAgICBkcmFnOiAwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBDb25maWd1cmF0aW9uIHBlciB0eXBlCiAgICAgICAgICAgIGlmICh0eXBlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICBkYXRhLmxpZmUgPSAxLjAgKyBNYXRoLnJhbmRvbSgpICogMC41OwogICAgICAgICAgICAgICAgZGF0YS52ZWxvY2l0eS5zZXQoMCwgMS4wICsgTWF0aC5yYW5kb20oKSwgMCk7CiAgICAgICAgICAgICAgICBkYXRhLnN0YXJ0U2NhbGUgPSAwLjMgKyBNYXRoLnJhbmRvbSgpICogMC4yOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMC44OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ25hcCcpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgIGRhdGEudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yLCAwLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yKTsKICAgICAgICAgICAgICAgIGRhdGEuc3RhcnRTY2FsZSA9IDAuNDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDEuNTsKICAgICAgICAgICAgICAgIGRhdGEudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC41LCAwLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC41KTsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDAuNjsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3Nob2Nrd2F2ZScpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IG9wdGlvbnMubGlmZSB8fCAwLjQ7CiAgICAgICAgICAgICAgICBkYXRhLm1heExpZmUgPSBkYXRhLmxpZmU7CiAgICAgICAgICAgICAgICBkYXRhLnN0YXJ0U2NhbGUgPSBvcHRpb25zLnNjYWxlIHx8IDIuMDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdmbGFzaCcpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDAuMjsKICAgICAgICAgICAgICAgIGRhdGEubWF4TGlmZSA9IDAuMjsKICAgICAgICAgICAgICAgIGRhdGEuc3RhcnRTY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMy4wOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwoKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZGVicmlzJykgewogICAgICAgICAgICAgICAgZGF0YS5saWZlID0gMS41OwogICAgICAgICAgICAgICAgZGF0YS5tYXhMaWZlID0gMS41OwogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSA1LjAgKyBNYXRoLnJhbmRvbSgpICogMTAuMDsKICAgICAgICAgICAgICAgIGRhdGEudmVsb2NpdHkuc2V0KAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcGVlZCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAqIHNwZWVkICogMC41KSArIDIuMCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogc3BlZWQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBkYXRhLmdyYXZpdHkgPSAyMC4wOwogICAgICAgICAgICAgICAgZGF0YS5kcmFnID0gMS4wOwogICAgICAgICAgICAgICAgZGF0YS5zdGFydFNjYWxlID0gKG9wdGlvbnMuc2NhbGUgfHwgMC4zKSAqICgwLjUgKyBNYXRoLnJhbmRvbSgpKTsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2J1YmJsZScpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDEuMCArIE1hdGgucmFuZG9tKCkgKiAxLjA7CiAgICAgICAgICAgICAgICBkYXRhLm1heExpZmUgPSBkYXRhLmxpZmU7CiAgICAgICAgICAgICAgICBkYXRhLnZlbG9jaXR5LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjUsCiAgICAgICAgICAgICAgICAgICAgMC41ICsgTWF0aC5yYW5kb20oKSAqIDEuMCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjUKICAgICAgICAgICAgICAgICk7CmRhdGEuc3RhcnRTY2FsZSA9IChvcHRpb25zLnNjYWxlIHx8IDAuMykgKiAoMC44ICsgTWF0aC5yYW5kb20oKSAqIDAuNCk7IC8vIExhcmdlciBiYXNlIHNjYWxlCiAgICAgICAgICAgICAgICBwLm1hdGVyaWFsLm9wYWNpdHkgPSAwLjk7IC8vIE1vcmUgb3BhcXVlCiAgICAgICAgICAgICAgICBwLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGFhY2NmZik7CgogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdidWJibGVfbWljcm8nKSB7CiAgICAgICAgICAgICAgICBkYXRhLmxpZmUgPSAwLjQgKyBNYXRoLnJhbmRvbSgpICogMC40OwogICAgICAgICAgICAgICAgZGF0YS5tYXhMaWZlID0gZGF0YS5saWZlOwogICAgICAgICAgICAgICAgZGF0YS52ZWxvY2l0eS5zZXQoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMS41LAogICAgICAgICAgICAgICAgICAgIDEuNSArIE1hdGgucmFuZG9tKCkgKiAyLjAsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMS41CiAgICAgICAgICAgICAgICApOwpkYXRhLnN0YXJ0U2NhbGUgPSAob3B0aW9ucy5zY2FsZSB8fCAwLjE1KSAqICgwLjggKyBNYXRoLnJhbmRvbSgpICogMC41KTsgLy8gTGFyZ2VyIG1pY3JvIGJ1YmJsZXMKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZmZmZmKTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Rhc2hfc3RyZWFtJykgewogICAgICAgICAgICAgICAgZGF0YS5saWZlID0gMC4zOwogICAgICAgICAgICAgICAgZGF0YS5tYXhMaWZlID0gMC4zOwogICAgICAgICAgICAgICAgZGF0YS5zdGFydFNjYWxlID0gb3B0aW9ucy5zY2FsZSB8fCAyLjA7CiAgICAgICAgICAgICAgICBwLm1hdGVyaWFsLm9wYWNpdHkgPSAwLjg7CiAgICAgICAgICAgICAgICBwLm1hdGVyaWFsLnJvdGF0aW9uID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0eXBlICE9PSAnc2hvY2t3YXZlJykgewogICAgICAgICAgICAgICAgcC5zY2FsZS5zZXRTY2FsYXIoZGF0YS5zdGFydFNjYWxlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHAuc2NhbGUuc2V0U2NhbGFyKDAuMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMucGFydGljbGVzLnB1c2goZGF0YSk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMucGFydGljbGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5wYXJ0aWNsZXNbaV07CiAgICAgICAgICAgICAgICBwLmFnZSArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAocC5hZ2UgPj0gcC5saWZlKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlcy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IHAuYWdlIC8gcC5saWZlOwoKICAgICAgICAgICAgICAgIGlmIChwLmdyYXZpdHkgPiAwKSBwLnZlbG9jaXR5LnkgLT0gcC5ncmF2aXR5ICogZHQ7CiAgICAgICAgICAgICAgICBpZiAocC5kcmFnID4gMCkgcC52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihNYXRoLm1heCgwLCAxLjAgLSAocC5kcmFnICogZHQpKSk7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uYWRkU2NhbGVkVmVjdG9yKHAudmVsb2NpdHksIGR0KTsKCiAgICAgICAgICAgICAgICBpZiAocC50eXBlID09PSAnc2hvY2t3YXZlJykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBwLnN0YXJ0U2NhbGUgKiBNYXRoLnBvdyh0LCAwLjUpICogNS4wOyAKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKHMpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wIC0gTWF0aC5wb3codCwgMik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAudHlwZSA9PT0gJ2ZsYXNoJykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wIC0gdCk7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnNjYWxlLnNldFNjYWxhcihzKTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwucm90YXRpb24gKz0gNS4wICogZHQ7CgogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLnR5cGUgPT09ICdkZWJyaXMnKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLnJvdGF0aW9uICs9IDEwLjAgKiBkdDsKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAudHlwZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi54ICs9IE1hdGguc2luKHAuYWdlICogMTAgKyBwLm1lc2guaWQpICogZHQgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAwLjggKiAoMS4wIC0gTWF0aC5wb3codCwgMykpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLnR5cGUgPT09ICduYXAnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcyA9IHAuc3RhcnRTY2FsZSAqICgwLjUgKyB0ICogMS41KTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKHMpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wIC0gTWF0aC5wb3codCwgMik7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnggKz0gTWF0aC5zaW4ocC5hZ2UgKiAyKSAqIGR0ICogMC4zOwoKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocC50eXBlID09PSAnYnViYmxlJykgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi54ICs9IE1hdGguc2luKHAuYWdlICogNS4wICsgcC5tZXNoLmlkKSAqIGR0ICogMC4yOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi56ICs9IE1hdGguY29zKHAuYWdlICogNC4wICsgcC5tZXNoLmlkKSAqIGR0ICogMC4yOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wICsgdCAqIDAuMik7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnNjYWxlLnNldFNjYWxhcihzKTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IDAuNiAqICgxLjAgLSBNYXRoLnBvdyh0LCAyKSk7CgogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLnR5cGUgPT09ICdidWJibGVfbWljcm8nKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogZHQgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogZHQgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcyA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKHMpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMC45ICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMyID0gcC5zdGFydFNjYWxlOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXQoczIgKiAoMS4wICsgdCksIHMyICogMC4yLCAxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyID0gUGFydGljbGVNYW5hZ2VyOwp9KSgpOw==","/ParticleManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUT1JTIC0tLQogICAgCiAgICAvLyAxLiBWZW5vbSBCdWJibGUgKEdyZWVuLCBzaGlueSwgc2hhcnApCiAgICBjb25zdCBfdmVub21UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMzIsIDMyLCA0LCAzMiwgMzIsIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgxNTAsIDI1NSwgMTAwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgwLCAyMDAsIDAsIDAuNSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCA1MCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45KSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDIwLCAyMCwgNiwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDIuIFNsZWVwIFp6egogICAgY29uc3QgX25hcFRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZvbnQgPSAnYm9sZCBpdGFsaWMgNDhweCBzYW5zLXNlcmlmJzsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gJyMwMDAwZmYnOwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gNDsKICAgICAgICBjdHguZmlsbFRleHQoJ1onLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gMy4gV2l0aGVyIFNtb2tlCi8vIDMuIFdpdGhlciBTbW9rZSAoT3B0aW1pemVkIHRvIDMyeDMyKQogICAgY29uc3QgX3dpdGhlclRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSAzMjsgYy5oZWlnaHQgPSAzMjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgxNiwgMTYsIDAsIDE2LCAxNiwgMTYpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDgwLCA4MCwgODAsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjUsICdyZ2JhKDQwLCA0MCwgNDAsIDAuNCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCAwLCAwLCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNC4gU2hvY2t3YXZlIFJpbmcgKE9wdGltaXplZCB0byA2NHg2NCkKICAgIGNvbnN0IF9zaG9ja3dhdmVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGN4ID0gMzIsIGN5ID0gMzI7CiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChjeCwgY3ksIDIwLCBjeCwgY3ksIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCA2NCwgNjQpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNS4gRmxhc2ggU3RhciAoT3B0aW1pemVkIHRvIDMyeDMyKQogICAgY29uc3QgX2ZsYXNoVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBjeCA9IDE2LCBjeSA9IDE2OwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmZmZic7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGZvcihsZXQgaT0wOyBpPDQ7IGkrKykgewogICAgICAgICAgICBjb25zdCBhID0gKGkgKiBNYXRoLlBJIC8gMik7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3gsIGN5KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKjE1LCBjeSArIE1hdGguc2luKGEpKjE1KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEgKyAwLjIpKjUsIGN5ICsgTWF0aC5zaW4oYSArIDAuMikqNSk7CiAgICAgICAgfQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChjeCwgY3ksIDAsIGN4LCBjeSwgMTApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDEpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoY3gsIGN5LCAxMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDYuIERlYnJpcyBTaGFyZCAoTmV3KQogICAgY29uc3QgX2RlYnJpc1RleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSAzMjsgYy5oZWlnaHQgPSAzMjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbygxNiwgMCk7IGN0eC5saW5lVG8oMzIsIDE2KTsgY3R4LmxpbmVUbygxNiwgMzIpOyBjdHgubGluZVRvKDAsIDE2KTsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNy4gQnViYmxlIFRleHR1cmUgKE5ldzogQWVzdGhldGljICYgU3VidGxlKQogICAgY29uc3QgX2J1YmJsZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgCiAgICAgICAgLy8gQ2xlYXIKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIDY0LCA2NCk7CgogICAgICAgIC8vIE1haW4gQnViYmxlIEJvZHkgKFNvZnQgR3JhZGllbnQpCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgyOCwgMjgsIDAsIDMyLCAzMiwgMzApOwoKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjQpJyk7IC8vIEJyaWdodGVyIGNvcmUKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjUsICdyZ2JhKDEwMCwgMjIwLCAyNTUsIDAuNiknKTsgLy8gTW9yZSBvcGFxdWUgYm9keQogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuOSwgJ3JnYmEoNTAsIDE1MCwgMjU1LCAwLjgpJyk7IC8vIFN0cm9uZyBlZGdlCiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoNTAsIDE1MCwgMjU1LCAwLjApJyk7IC8vIFNvZnQgZWRnZQogICAgICAgIAogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYygzMiwgMzIsIDMwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIC8vIFNoYXJwIFNwZWN1bGFyIEhpZ2hsaWdodCAoUmVmbGVjdGlvbikKICAgICAgICBjb25zdCBnMiA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgyMCwgMjAsIDAsIDIwLCAyMCwgMTIpOwogICAgICAgIGcyLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjkpJyk7CiAgICAgICAgZzIuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMCknKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzI7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyAKICAgICAgICBjdHguZWxsaXBzZSgyMiwgMjIsIDEwLCA2LCAtTWF0aC5QSSAvIDQsIDAsIE1hdGguUEkgKiAyKTsgCiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAKICAgICAgICAvLyBCb3R0b20gUmltIExpZ2h0Ci8vIEJvdHRvbSBSaW0gTGlnaHQKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyMDAsIDI1NSwgMjU1LCAwLjgpJzsgLy8gQnJpZ2h0ZXIgcmltCiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDM7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDMyLCAzMiwgMjgsIDAuMiAqIE1hdGguUEksIDAuOCAqIE1hdGguUEkpOyBjdHguc3Ryb2tlKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA4LiBNaWNybyBCdWJibGUgKE5ldzogU2hhcnAsIGhpZ2gtdmlzIGNhdml0YXRpb24pCiAgICBjb25zdCBfbWljcm9CdWJibGVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgMzIsIDMyKTsKICAgICAgICAKICAgICAgICAvLyBJbnRlbnNlIGJyaWdodCBjb3JlCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgxNiwgMTYsIDAsIDE2LCAxNiwgMTYpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDEuMCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjMsICdyZ2JhKDIyMCwgMjU1LCAyNTUsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjYsICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLjAsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDE2LCAxNiwgMTYsIDAsIE1hdGguUEkqMik7IGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA5LiBEYXNoIFN0cmVhbSAoTmV3OiBTcGVlZCBsaW5lKQogICAgY29uc3QgX2Rhc2hTdHJlYW1UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gMTY7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlTGluZWFyR3JhZGllbnQoMCwgMCwgNjQsIDApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDAsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoMjAwLCAyNTUsIDI1NSwgMC44KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDAsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIAogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCA0LCA2NCwgOCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjbGFzcyBQYXJ0aWNsZU1hbmFnZXIgewoKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMucGFydGljbGVzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNb2JpbGUgT3B0aW1pemF0aW9uOiBDaGVjayBzY3JlZW4gd2lkdGgKICAgICAgICAgICAgY29uc3QgaXNNb2JpbGUgPSB3aW5kb3cuaW5uZXJXaWR0aCA8IDgwMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNoYXJlZCBNYXRlcmlhbHMKICAgICAgICAgICAgLy8gTm90ZTogYWxwaGFUZXN0IGFkZGVkIHRvIE5vcm1hbEJsZW5kaW5nIG1hdGVyaWFscyB0byBoZWxwIEdQVSBkaXNjYXJkIHRyYW5zcGFyZW50IHBpeGVscwogICAgICAgICAgICB0aGlzLm1hdGVyaWFscyA9IHsKICAgICAgICAgICAgICAgIHZlbm9tOiBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyBtYXA6IF92ZW5vbVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIG5hcDogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfbmFwVGV4LCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhXcml0ZTogZmFsc2UsIGJsZW5kaW5nOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywgYWxwaGFUZXN0OiAwLjEgfSksCiAgICAgICAgICAgICAgICB3aXRoZXI6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3dpdGhlclRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsIGFscGhhVGVzdDogMC4wNSB9KSwKICAgICAgICAgICAgICAgIGxlYXJuZWQ6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3Zlbm9tVGV4LCBjb2xvcjogMHgwMGZmZmYsIHRyYW5zcGFyZW50OiB0cnVlLCBkZXB0aFdyaXRlOiBmYWxzZSwgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcgfSksCiAgICAgICAgICAgICAgICBzaG9ja3dhdmU6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3Nob2Nrd2F2ZVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIGZsYXNoOiBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyBtYXA6IF9mbGFzaFRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIGRlYnJpczogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfZGVicmlzVGV4LCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhXcml0ZTogZmFsc2UsIGJsZW5kaW5nOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywgYWxwaGFUZXN0OiAwLjEgfSksCiAgICAgICAgICAgICAgICBidWJibGU6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2J1YmJsZVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIGJ1YmJsZV9taWNybzogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfbWljcm9CdWJibGVUZXgsIHRyYW5zcGFyZW50OiB0cnVlLCBkZXB0aFdyaXRlOiBmYWxzZSwgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcgfSksCiAgICAgICAgICAgICAgICBkYXNoX3N0cmVhbTogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfZGFzaFN0cmVhbVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gT2JqZWN0IFBvb2wKICAgICAgICAgICAgdGhpcy5wb29sID0gW107CiAgICAgICAgICAgIC8vIFJlZHVjZSBwb29sIHNpemUgb24gbW9iaWxlIHRvIHByZXZlbnQgZXhjZXNzaXZlIG92ZXJkcmF3CiAgICAgICAgICAgIHRoaXMucG9vbFNpemUgPSBpc01vYmlsZSA/IDEyMCA6IDMwMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgLy8gQ2xvbmUgbWF0ZXJpYWwgdG8gYWxsb3cgaW5kaXZpZHVhbCBvcGFjaXR5L3JvdGF0aW9uCiAgICAgICAgICAgICAgICAvLyBXZSBjbG9uZSAndmVub20nIGFzIGEgcGxhY2Vob2xkZXIsIGl0IGdldHMgb3ZlcndyaXR0ZW4gaW4gc3Bhd24oKQogICAgICAgICAgICAgICAgY29uc3QgbWF0ID0gdGhpcy5tYXRlcmlhbHMudmVub20uY2xvbmUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUobWF0KTsgCiAgICAgICAgICAgICAgICBzcHJpdGUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgc3ByaXRlLnNjYWxlLnNldCgwLDAsMCk7IAogICAgICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBEaXNhYmxlIGZydXN0dW0gY3VsbGluZyBmb3IgcGFydGljbGVzIHRvIGF2b2lkIENQVSBvdmVyaGVhZCBvZiBib3VuZGluZyBib3ggY2FsYwogICAgICAgICAgICAgICAgLy8gc2luY2UgdGhleSBhcmUgYWx3YXlzIGluIGZyb250IG9mIGNhbWVyYSB1c3VhbGx5LCBvciBjaGVhcCB0byBkcmF3LgogICAgICAgICAgICAgICAgLy8gQWN0dWFsbHksIGtlZXBpbmcgY3VsbGluZyBpcyBiZXR0ZXIgaWYgdGhleSBnbyBvZmYgc2NyZWVuLgogICAgICAgICAgICAgICAgLy8gc3ByaXRlLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsgCiAgICAgICAgICAgICAgICB0aGlzLnNjZW5lLmFkZChzcHJpdGUpOwogICAgICAgICAgICAgICAgdGhpcy5wb29sLnB1c2goc3ByaXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMucG9vbC5maW5kKHMgPT4gIXMudmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghcCkgcmV0dXJuOwoKICAgICAgICAgICAgcC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHRlbXBsYXRlID0gdGhpcy5tYXRlcmlhbHNbdHlwZV0gfHwgdGhpcy5tYXRlcmlhbHMudmVub207CiAgICAgICAgICAgIHAubWF0ZXJpYWwubWFwID0gdGVtcGxhdGUubWFwOwogICAgICAgICAgICBwLm1hdGVyaWFsLmJsZW5kaW5nID0gdGVtcGxhdGUuYmxlbmRpbmc7CiAgICAgICAgICAgIHAubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRlbXBsYXRlLmRlcHRoV3JpdGU7CiAgICAgICAgICAgIHAubWF0ZXJpYWwudHJhbnNwYXJlbnQgPSB0ZW1wbGF0ZS50cmFuc3BhcmVudDsKCiAgICAgICAgICAgIHAucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgcC5tYXRlcmlhbC5yb3RhdGlvbiA9IDA7CiAgICAgICAgICAgIHAubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZmZmZmKTsKICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwoKICAgICAgICAgICAgY29uc3QgZGF0YSA9IHsKICAgICAgICAgICAgICAgIG1lc2g6IHAsCiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgICAgICAgYWdlOiAwLAogICAgICAgICAgICAgICAgbGlmZTogb3B0aW9ucy5saWZlIHx8IDEuMCwKICAgICAgICAgICAgICAgIG1heExpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksCiAgICAgICAgICAgICAgICBzdGFydFNjYWxlOiBvcHRpb25zLnNjYWxlIHx8IDEuMCwKICAgICAgICAgICAgICAgIGdyYXZpdHk6IDAsCiAgICAgICAgICAgICAgICBkcmFnOiAwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBDb25maWd1cmF0aW9uIHBlciB0eXBlCiAgICAgICAgICAgIGlmICh0eXBlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICBkYXRhLmxpZmUgPSAxLjAgKyBNYXRoLnJhbmRvbSgpICogMC41OwogICAgICAgICAgICAgICAgZGF0YS52ZWxvY2l0eS5zZXQoMCwgMS4wICsgTWF0aC5yYW5kb20oKSwgMCk7CiAgICAgICAgICAgICAgICBkYXRhLnN0YXJ0U2NhbGUgPSAwLjMgKyBNYXRoLnJhbmRvbSgpICogMC4yOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMC44OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ25hcCcpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgIGRhdGEudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yLCAwLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yKTsKICAgICAgICAgICAgICAgIGRhdGEuc3RhcnRTY2FsZSA9IDAuNDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDEuNTsKICAgICAgICAgICAgICAgIGRhdGEudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC41LCAwLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC41KTsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDAuNjsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3Nob2Nrd2F2ZScpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IG9wdGlvbnMubGlmZSB8fCAwLjQ7CiAgICAgICAgICAgICAgICBkYXRhLm1heExpZmUgPSBkYXRhLmxpZmU7CiAgICAgICAgICAgICAgICBkYXRhLnN0YXJ0U2NhbGUgPSBvcHRpb25zLnNjYWxlIHx8IDIuMDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdmbGFzaCcpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDAuMjsKICAgICAgICAgICAgICAgIGRhdGEubWF4TGlmZSA9IDAuMjsKICAgICAgICAgICAgICAgIGRhdGEuc3RhcnRTY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMy4wOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwoKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZGVicmlzJykgewogICAgICAgICAgICAgICAgZGF0YS5saWZlID0gMS41OwogICAgICAgICAgICAgICAgZGF0YS5tYXhMaWZlID0gMS41OwogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSA1LjAgKyBNYXRoLnJhbmRvbSgpICogMTAuMDsKICAgICAgICAgICAgICAgIGRhdGEudmVsb2NpdHkuc2V0KAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcGVlZCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAqIHNwZWVkICogMC41KSArIDIuMCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogc3BlZWQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBkYXRhLmdyYXZpdHkgPSAyMC4wOwogICAgICAgICAgICAgICAgZGF0YS5kcmFnID0gMS4wOwogICAgICAgICAgICAgICAgZGF0YS5zdGFydFNjYWxlID0gKG9wdGlvbnMuc2NhbGUgfHwgMC4zKSAqICgwLjUgKyBNYXRoLnJhbmRvbSgpKTsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2J1YmJsZScpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDEuMCArIE1hdGgucmFuZG9tKCkgKiAxLjA7CiAgICAgICAgICAgICAgICBkYXRhLm1heExpZmUgPSBkYXRhLmxpZmU7CiAgICAgICAgICAgICAgICBkYXRhLnZlbG9jaXR5LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjUsCiAgICAgICAgICAgICAgICAgICAgMC41ICsgTWF0aC5yYW5kb20oKSAqIDEuMCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjUKICAgICAgICAgICAgICAgICk7CmRhdGEuc3RhcnRTY2FsZSA9IChvcHRpb25zLnNjYWxlIHx8IDAuMykgKiAoMC44ICsgTWF0aC5yYW5kb20oKSAqIDAuNCk7IC8vIExhcmdlciBiYXNlIHNjYWxlCiAgICAgICAgICAgICAgICBwLm1hdGVyaWFsLm9wYWNpdHkgPSAwLjk7IC8vIE1vcmUgb3BhcXVlCiAgICAgICAgICAgICAgICBwLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGFhY2NmZik7CgogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdidWJibGVfbWljcm8nKSB7CiAgICAgICAgICAgICAgICBkYXRhLmxpZmUgPSAwLjQgKyBNYXRoLnJhbmRvbSgpICogMC40OwogICAgICAgICAgICAgICAgZGF0YS5tYXhMaWZlID0gZGF0YS5saWZlOwogICAgICAgICAgICAgICAgZGF0YS52ZWxvY2l0eS5zZXQoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMS41LAogICAgICAgICAgICAgICAgICAgIDEuNSArIE1hdGgucmFuZG9tKCkgKiAyLjAsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMS41CiAgICAgICAgICAgICAgICApOwpkYXRhLnN0YXJ0U2NhbGUgPSAob3B0aW9ucy5zY2FsZSB8fCAwLjE1KSAqICgwLjggKyBNYXRoLnJhbmRvbSgpICogMC41KTsgLy8gTGFyZ2VyIG1pY3JvIGJ1YmJsZXMKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZmZmZmKTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Rhc2hfc3RyZWFtJykgewogICAgICAgICAgICAgICAgZGF0YS5saWZlID0gMC4zOwogICAgICAgICAgICAgICAgZGF0YS5tYXhMaWZlID0gMC4zOwogICAgICAgICAgICAgICAgZGF0YS5zdGFydFNjYWxlID0gb3B0aW9ucy5zY2FsZSB8fCAyLjA7CiAgICAgICAgICAgICAgICBwLm1hdGVyaWFsLm9wYWNpdHkgPSAwLjg7CiAgICAgICAgICAgICAgICBwLm1hdGVyaWFsLnJvdGF0aW9uID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0eXBlICE9PSAnc2hvY2t3YXZlJykgewogICAgICAgICAgICAgICAgcC5zY2FsZS5zZXRTY2FsYXIoZGF0YS5zdGFydFNjYWxlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHAuc2NhbGUuc2V0U2NhbGFyKDAuMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMucGFydGljbGVzLnB1c2goZGF0YSk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMucGFydGljbGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5wYXJ0aWNsZXNbaV07CiAgICAgICAgICAgICAgICBwLmFnZSArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAocC5hZ2UgPj0gcC5saWZlKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlcy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IHAuYWdlIC8gcC5saWZlOwoKICAgICAgICAgICAgICAgIGlmIChwLmdyYXZpdHkgPiAwKSBwLnZlbG9jaXR5LnkgLT0gcC5ncmF2aXR5ICogZHQ7CiAgICAgICAgICAgICAgICBpZiAocC5kcmFnID4gMCkgcC52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihNYXRoLm1heCgwLCAxLjAgLSAocC5kcmFnICogZHQpKSk7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uYWRkU2NhbGVkVmVjdG9yKHAudmVsb2NpdHksIGR0KTsKCiAgICAgICAgICAgICAgICBpZiAocC50eXBlID09PSAnc2hvY2t3YXZlJykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBwLnN0YXJ0U2NhbGUgKiBNYXRoLnBvdyh0LCAwLjUpICogNS4wOyAKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKHMpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wIC0gTWF0aC5wb3codCwgMik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAudHlwZSA9PT0gJ2ZsYXNoJykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wIC0gdCk7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnNjYWxlLnNldFNjYWxhcihzKTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwucm90YXRpb24gKz0gNS4wICogZHQ7CgogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLnR5cGUgPT09ICdkZWJyaXMnKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLnJvdGF0aW9uICs9IDEwLjAgKiBkdDsKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAudHlwZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi54ICs9IE1hdGguc2luKHAuYWdlICogMTAgKyBwLm1lc2guaWQpICogZHQgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAwLjggKiAoMS4wIC0gTWF0aC5wb3codCwgMykpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLnR5cGUgPT09ICduYXAnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcyA9IHAuc3RhcnRTY2FsZSAqICgwLjUgKyB0ICogMS41KTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKHMpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wIC0gTWF0aC5wb3codCwgMik7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnggKz0gTWF0aC5zaW4ocC5hZ2UgKiAyKSAqIGR0ICogMC4zOwoKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocC50eXBlID09PSAnYnViYmxlJykgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi54ICs9IE1hdGguc2luKHAuYWdlICogNS4wICsgcC5tZXNoLmlkKSAqIGR0ICogMC4yOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi56ICs9IE1hdGguY29zKHAuYWdlICogNC4wICsgcC5tZXNoLmlkKSAqIGR0ICogMC4yOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wICsgdCAqIDAuMik7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnNjYWxlLnNldFNjYWxhcihzKTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IDAuNiAqICgxLjAgLSBNYXRoLnBvdyh0LCAyKSk7CgogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLnR5cGUgPT09ICdidWJibGVfbWljcm8nKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogZHQgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogZHQgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcyA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKHMpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMC45ICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMyID0gcC5zdGFydFNjYWxlOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXQoczIgKiAoMS4wICsgdCksIHMyICogMC4yLCAxLjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyID0gUGFydGljbGVNYW5hZ2VyOwp9KSgpOw==","DevTools.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFRvb2x0aXAgRGVzY3JpcHRpb25zIGZvciBMb25nLVByZXNzCiAgICBjb25zdCBUT09MVElQX0RFU0NSSVBUSU9OUyA9IHsKICAgICAgICAnU1VCU1RFUFMnOiAiUGh5c2ljcyBpdGVyYXRpb25zIHBlciBmcmFtZS4gSGlnaGVyID0gbW9yZSBzdGFibGUsIG1vcmUgQ1BVLiIsCiAgICAgICAgJ1NUT1BfU1BFRUQnOiAiVmVsb2NpdHkgdGhyZXNob2xkIGJlbG93IHdoaWNoIHRoZSBiYWxsIHNuYXBzIHRvIGEgaGFsdC4iLAogICAgICAgICdXQVRFUl9EUkFHX0xJTkVBUic6ICJCYXNlIHdhdGVyIHJlc2lzdGFuY2UuIFNsb3dzIGJhbGwgbGluZWFybHkuIiwKICAgICAgICAnV0FURVJfRFJBR19RVUFEJzogIlF1YWRyYXRpYyBkcmFnLiBTbG93cyBoaWdoLXNwZWVkIGJhbGxzIHNpZ25pZmljYW50bHkuIiwKICAgICAgICAnU1BJTl9EUkFHJzogIkhvdyBmYXN0IHRoZSBiYWxsJ3Mgc3BpbiBkZWNheXMgb3ZlciB0aW1lLiIsCiAgICAgICAgJ01BR05VU19FTkFCTEVEJzogIkVuYWJsZXMgdGhlIE1hZ251cyBlZmZlY3QgKGN1cnZlIGZyb20gc3BpbikuIiwKICAgICAgICAnTUFHTlVTX0NPRUZGJzogIlN0cmVuZ3RoIG9mIHRoZSBjdXJ2ZSBmb3JjZSByZWxhdGl2ZSB0byBzcGluL3NwZWVkLiIsCiAgICAgICAgJ01BR05VU19DQVAnOiAiTWF4aW11bSBjdXJ2ZSBmb3JjZSBhbGxvd2VkIChwcmV2ZW50cyBwaHlzaWNzIGV4cGxvc2lvbnMpLiIsCiAgICAgICAgJ0RFUFRIX1RBUkdFVF9ZJzogIklkZWFsIFkgaGVpZ2h0IHRoZSBiYWxsIHRyaWVzIHRvIGZsb2F0IGF0LiIsCiAgICAgICAgJ0RFUFRIX1NQUklORyc6ICJTdHJlbmd0aCBvZiB0aGUgZm9yY2UgcHVsbGluZyBiYWxsIHRvIFRhcmdldCBZLiIsCiAgICAgICAgJ0RFUFRIX0RBTVAnOiAiRGFtcGluZyBvbiB2ZXJ0aWNhbCBtb3ZlbWVudCB0byBwcmV2ZW50IG9zY2lsbGF0aW9uLiIsCiAgICAgICAgJ0JPVU5EQVJZX1JBRElVUyc6ICJSYWRpdXMgb2YgdGhlIGNpcmN1bGFyIGFyZW5hIHdhbGwuIiwKICAgICAgICAnQk9VTkRBUllfSEVJR0hUJzogIkhlaWdodCBvZiB0aGUgYXJlbmEgY2VpbGluZy9mbG9vci4iLAogICAgICAgICdXQUxMX1NPRlRfQlVGRkVSJzogIkRpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMuIiwKICAgICAgICAnV0FMTF9TT0ZUX0ZPUkNFJzogIkZvcmNlIHB1c2hpbmcgYmFsbCBhd2F5IGZyb20gd2FsbCBiZWZvcmUgaW1wYWN0LiIsCiAgICAgICAgJ1dBTExfRUxBU1RJQ0lUWSc6ICJCb3VuY2luZXNzIG9mIHRoZSB3YWxsICgwID0gZGVhZCB0aHVkLCAxID0gcGVyZmVjdCBib3VuY2UpLiIsCiAgICAgICAgJ1dBTExfRlJJQ1RJT04nOiAiRnJpY3Rpb24gd2hlbiBzbGlkaW5nIGFsb25nIHRoZSB3YWxsLiIsCiAgICAgICAgJ0ZMT09SX0VMQVNUSUNJVFknOiAiQm91bmNpbmVzcyBvZiB0aGUgZmxvb3IvY2VpbGluZy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9FTkFCTEVEJzogIkVuYWJsZXMgdGhlIGV4dGVuZGVkIGNvcnJpZG9yIGZvciB0aGUgZ29hbC4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9YJzogIkhhbGYtd2lkdGggb2YgdGhlIGdvYWwgcG9ja2V0IGNvcnJpZG9yLiIsCiAgICAgICAgJ0dPQUxfUE9DS0VUX1onOiAiWi1kZXB0aCB3aGVyZSB0aGUgcG9ja2V0IHN0YXJ0cy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9SQURJVVMnOiAiRWZmZWN0aXZlIHJhZGl1cyBpbnNpZGUgdGhlIHBvY2tldC4iLAogICAgICAgICdMQVVOQ0hfU1BFRURfU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBTdGF0IFBvd2VyIHRvIFBoeXNpY3MgVmVsb2NpdHkuIiwKICAgICAgICAnTEFVTkNIX1NQRUVEX0NBUCc6ICJNYXhpbXVtIHBoeXNpY2FsIHNwZWVkIHRoZSBiYWxsIGNhbiBiZSB0aHJvd24uIiwKICAgICAgICAnU1dJUEVfTUlOX1BYJzogIk1pbmltdW0gc3dpcGUgZGlzdGFuY2UgdG8gcmVnaXN0ZXIgYSB0aHJvdy4iLAogICAgICAgICdBSU1fRFhfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgaG9yaXpvbnRhbCBhaW0gZnJvbSBzd2lwZS4iLAogICAgICAgICdBSU1fRFlfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgdmVydGljYWwgYWltIGZyb20gc3dpcGUuIiwKICAgICAgICAnUE9XRVJfQkFTRSc6ICJCYXNlIHBvd2VyIG11bHRpcGxpZXIgZm9yIGEgcXVpY2sgdGFwLiIsCiAgICAgICAgJ1BPV0VSX1JBTkdFJzogIkFkZGl0aW9uYWwgcG93ZXIgbXVsdGlwbGllciBhdCBmdWxsIGNoYXJnZS4iLAogICAgICAgICdQT1dFUl9NQVhfQk9OVVNfUkFUSU8nOiAiQ2hhcmdlIHRocmVzaG9sZCBmb3IgJ01heCBQb3dlcicgYm9udXMuIiwKICAgICAgICAnUE9XRVJfTUFYX01VTFRJUExJRVInOiAiTXVsdGlwbGllciBhcHBsaWVkIHdoZW4gaGl0dGluZyBNYXggUG93ZXIuIiwKICAgICAgICAnQ1VSVkVfRU5BQkxFRCc6ICJFbmFibGVzIGN1cnZlIHNob3RzIHZpYSBjdXJ2ZWQgc3dpcGVzLiIsCiAgICAgICAgJ0NVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQnOiAiSG93IGN1cnZlZCBhIHN3aXBlIG11c3QgYmUgdG8gdHJpZ2dlciBzcGluLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBzd2lwZSBjdXJ2ZSB0byBiYWxsIHNwaW4uIiwKICAgICAgICAnQ1VSVkVfU1BFRURfTVVMVCc6ICJNdWx0aXBsaWVyIGZvciBzcGluIGJhc2VkIG9uIHN3aXBlIHNwZWVkLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fQ0FQJzogIk1heGltdW0gc3BpbiBhbGxvd2VkIGZyb20gYSBjdXJ2ZSB0aHJvdy4iLAogICAgICAgICdDVVJWRV9QRVJGRUNUX1NQSU4nOiAiU3BpbiB0aHJlc2hvbGQgdG8gdHJpZ2dlciAnUGVyZmVjdCBDdXJ2ZScgRlguIiwKICAgICAgICAndGltZVNjYWxlJzogIkdsb2JhbCBnYW1lIHNwZWVkIG11bHRpcGxpZXIuIiwKICAgICAgICAnZGVtb01vZGUnOiAiVG9nZ2xlIEFJIHZzIEFJIGF1dG8tcGxheS4iLAogICAgICAgICdyZXNvbHV0aW9uJzogIkludGVybmFsIHJlbmRlciByZXNvbHV0aW9uIHNjYWxlICgwLjUgPSBoYWxmIHJlcykuIiwKICAgICAgICAnYXJlbmFPcGFjaXR5JzogIk9wYWNpdHkgb2YgdGhlIG91dGVyIGFyZW5hIGdyaWQuIiwKICAgICAgICAnYXJlbmEyT3BhY2l0eSc6ICJPcGFjaXR5IG9mIHRoZSBpbm5lciBoZXggZ3JpZC4iCiAgICB9OwoKICAgIGNsYXNzIERldlRvb2xzIHsKICAgICAgICBjb25zdHJ1Y3RvcihnYW1lTWFuYWdlcikgewogICAgICAgICAgICB0aGlzLmdhbWUgPSBnYW1lTWFuYWdlcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIGxpbC1ndWkgYXR0YWNoZXMgdG8gd2luZG93LmxpbCBieSBkZWZhdWx0IGluIFVNRCBidWlsZAogICAgICAgICAgICBpZiAoIXdpbmRvdy5saWwgfHwgIXdpbmRvdy5saWwuR1VJKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkRldlRvb2xzOiBsaWwtZ3VpIG5vdCBmb3VuZC4iKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dhbWUtY29udGFpbmVyJyk7CiAgICAgICAgICAgIHRoaXMuZ3VpID0gbmV3IHdpbmRvdy5saWwuR1VJKHsgdGl0bGU6ICdGbHV4IERldlRvb2xzJywgY29udGFpbmVyOiBjb250YWluZXIgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQb3NpdGlvbiBhcyBhIGNvbGxhcHNlZCB0YWIgb24gdGhlIHJpZ2h0IGZyYW1lCi8vIFBvc2l0aW9uIGFzIGEgc2xpZGluZyB0YWIgb24gdGhlIHJpZ2h0IGZyYW1lCi8vIFBvc2l0aW9uIGFzIGEgc2xpZGluZyB0YWIgb24gdGhlIHJpZ2h0IGZyYW1lCi8vIFdyYXBwZXIgZm9yIHNsaWRpbmcgYW5pbWF0aW9uCiAgICAgICAgICAgIGNvbnN0IHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUudG9wID0gJzEwMHB4JzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5yaWdodCA9ICctMjYwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLndpZHRoID0gJzI2MHB4JzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS50cmFuc2l0aW9uID0gJ3JpZ2h0IDAuM3MgY3ViaWMtYmV6aWVyKDAuMiwgMC44LCAwLjIsIDEuMCknOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnpJbmRleCA9ICc5OTk5JzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLmZsZXhEaXJlY3Rpb24gPSAnY29sdW1uJzsKICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHdyYXBwZXIpOwoKICAgICAgICAgICAgY29uc3QgZG9tID0gdGhpcy5ndWkuZG9tRWxlbWVudDsKICAgICAgICAgICAgZG9tLnN0eWxlLndpZHRoID0gJzEwMCUnOwogICAgICAgICAgICBkb20uc3R5bGUuc2V0UHJvcGVydHkoJy0td2lkdGgnLCAnMTAwJScpOwogICAgICAgICAgICBkb20uc3R5bGUubWF4SGVpZ2h0ID0gJzgwdmgnOwogICAgICAgICAgICBkb20uc3R5bGUub3ZlcmZsb3dZID0gJ2F1dG8nOwogICAgICAgICAgICBkb20uc3R5bGUub3ZlcmZsb3dYID0gJ2hpZGRlbic7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNb3ZlIEdVSSBpbnRvIHdyYXBwZXIKICAgICAgICAgICAgd3JhcHBlci5hcHBlbmRDaGlsZChkb20pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ3JlYXRlIFRvZ2dsZSBIYW5kbGUKICAgICAgICAgICAgY29uc3QgaGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5sZWZ0ID0gJy00MHB4JzsgLy8gUHJvdHJ1ZGUgdG8gdGhlIGxlZnQKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLnRvcCA9ICcwJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLndpZHRoID0gJzQwcHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuaGVpZ2h0ID0gJzQwcHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gJ3JnYmEoMCwgMjAsIDQwLCAwLjkpJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlciA9ICcxcHggc29saWQgIzAwZmZmZic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5ib3JkZXJSaWdodCA9ICdub25lJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlclRvcExlZnRSYWRpdXMgPSAnOHB4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlckJvdHRvbUxlZnRSYWRpdXMgPSAnOHB4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmN1cnNvciA9ICdwb2ludGVyJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5qdXN0aWZ5Q29udGVudCA9ICdjZW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYWxpZ25JdGVtcyA9ICdjZW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuY29sb3IgPSAnIzAwZmZmZic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5mb250U2l6ZSA9ICcyMHB4JzsKICAgICAgICAgICAgaGFuZGxlLmlubmVySFRNTCA9ICfimpknOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm94U2hhZG93ID0gJy01cHggMCAxMHB4IHJnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgICAgIAogICAgICAgICAgICB3cmFwcGVyLmFwcGVuZENoaWxkKGhhbmRsZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUb2dnbGUgTG9naWMKICAgICAgICAgICAgbGV0IGlzT3BlbiA9IGZhbHNlOwogICAgICAgICAgICBoYW5kbGUuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsgLy8gUHJldmVudCBnYW1lIGlucHV0cwogICAgICAgICAgICAgICAgaXNPcGVuID0gIWlzT3BlbjsKICAgICAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUucmlnaHQgPSBpc09wZW4gPyAnMHB4JyA6ICctMjYwcHgnOwogICAgICAgICAgICAgICAgaGFuZGxlLmlubmVySFRNTCA9IGlzT3BlbiA/ICfCuycgOiAn4pqZJzsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIERlZmF1bHQgZ2xvYmFsIHRpbWVTY2FsZSBpZiBub3Qgc2V0CmlmICh3aW5kb3cuZmx1eC50aW1lU2NhbGUgPT09IHVuZGVmaW5lZCkgd2luZG93LmZsdXgudGltZVNjYWxlID0gMC44OwoKdGhpcy5fc2V0dXBHZW5lcmFsKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwQ29udHJvbHNGZWVsKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwR2FtZVN0YXRlKCk7CnRoaXMuX3NldHVwT3ZlcmxheXMoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBUZWFtcygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFBsYXllckluc3BlY3RvcigpOwogICAgICAgICAgICB0aGlzLl9zZXR1cEJhbGxTYW5kYm94KCk7CnRoaXMuX3NldHVwRlhMYWIoKTsKdGhpcy5fc2V0dXBGWExhYigpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFZpc3VhbHMoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBUb29sdGlwcygpOwogICAgICAgIH0KCiAgICAgICAgX3NldHVwVG9vbHRpcHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBUb29sdGlwIERPTQogICAgICAgICAgICB0aGlzLnRvb2x0aXBFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMudG9vbHRpcEVsLnN0eWxlLCB7CiAgICAgICAgICAgICAgICBwb3NpdGlvbjogJ2ZpeGVkJywKICAgICAgICAgICAgICAgIHRvcDogJzUwJScsCiAgICAgICAgICAgICAgICBsZWZ0OiAnNTAlJywKICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogJ3RyYW5zbGF0ZSgtNTAlLCAtNTAlKScsCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICdyZ2JhKDAsIDEwLCAzMCwgMC45NSknLAogICAgICAgICAgICAgICAgYm9yZGVyOiAnMnB4IHNvbGlkICMwMGZmZmYnLAogICAgICAgICAgICAgICAgcGFkZGluZzogJzIwcHgnLAogICAgICAgICAgICAgICAgY29sb3I6ICcjZmZmJywKICAgICAgICAgICAgICAgIGZvbnRGYW1pbHk6ICdtb25vc3BhY2UnLAogICAgICAgICAgICAgICAgZm9udFNpemU6ICcxNHB4JywKICAgICAgICAgICAgICAgIG1heFdpZHRoOiAnMzAwcHgnLAogICAgICAgICAgICAgICAgekluZGV4OiAnMTAwMDAnLAogICAgICAgICAgICAgICAgZGlzcGxheTogJ25vbmUnLAogICAgICAgICAgICAgICAgcG9pbnRlckV2ZW50czogJ25vbmUnLAogICAgICAgICAgICAgICAgYm94U2hhZG93OiAnMCAwIDIwcHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKScsCiAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6ICc4cHgnLAogICAgICAgICAgICAgICAgdGV4dEFsaWduOiAnY2VudGVyJwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLnRvb2x0aXBFbCk7CgogICAgICAgICAgICAvLyBSZWN1cnNpdmUgZnVuY3Rpb24gdG8gYXR0YWNoIGxpc3RlbmVycwogICAgICAgICAgICBjb25zdCBhdHRhY2ggPSAoZ3VpKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBDb250cm9sbGVycwogICAgICAgICAgICAgICAgaWYgKGd1aS5jb250cm9sbGVycykgewogICAgICAgICAgICAgICAgICAgIGd1aS5jb250cm9sbGVycy5mb3JFYWNoKGMgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkb20gPSBjLmRvbUVsZW1lbnQuY2xvc2VzdCgnLmNvbnRyb2xsZXInKTsgLy8gbGlsLWd1aSBzdHJ1Y3R1cmUKICAgICAgICAgICAgICAgICAgICAgICAgaWYoZG9tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IGRvbS5xdWVyeVNlbGVjdG9yKCcubmFtZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobGFiZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hZGRMb25nUHJlc3MobGFiZWwsIGMucHJvcGVydHksIGMuX25hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBTdWItZm9sZGVycwogICAgICAgICAgICAgICAgaWYoZ3VpLmZvbGRlcnMpIHsKICAgICAgICAgICAgICAgICAgICBndWkuZm9sZGVycy5mb3JFYWNoKGYgPT4gYXR0YWNoKGYpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFdhaXQgYSB0aWNrIGZvciBHVUkgdG8gZnVsbHkgcmVuZGVyIERPTQogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGF0dGFjaCh0aGlzLmd1aSksIDEwMCk7CiAgICAgICAgfQoKICAgICAgICBfYWRkTG9uZ1ByZXNzKGVsZW1lbnQsIHByb3BlcnR5LCBuYW1lKSB7CiAgICAgICAgICAgIGxldCB0aW1lciA9IG51bGw7CiAgICAgICAgICAgIGNvbnN0IGR1cmF0aW9uID0gNTAwOyAvLyAwLjVzCgogICAgICAgICAgICBjb25zdCBzdGFydCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dUb29sdGlwKHByb3BlcnR5LCBuYW1lKTsKICAgICAgICAgICAgICAgIH0sIGR1cmF0aW9uKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGNvbnN0IGVuZCA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGlmKHRpbWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTsKICAgICAgICAgICAgICAgICAgICB0aW1lciA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9oaWRlVG9vbHRpcCgpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBzdGFydCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHN0YXJ0LCB7cGFzc2l2ZTogdHJ1ZX0pOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgZW5kKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgZW5kKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGVuZCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCBlbmQpOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dUb29sdGlwKHByb3AsIG5hbWUpIHsKICAgICAgICAgICAgY29uc3QgZGVzYyA9IFRPT0xUSVBfREVTQ1JJUFRJT05TW3Byb3BdOwogICAgICAgICAgICBpZihkZXNjKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRvb2x0aXBFbC5pbm5lckhUTUwgPSBgPHN0cm9uZyBzdHlsZT0iY29sb3I6IzAwZmZmZjsgZm9udC1zaXplOjE2cHg7Ij4ke25hbWUgfHwgcHJvcH08L3N0cm9uZz48YnI+PGJyPiR7ZGVzY31gOwogICAgICAgICAgICAgICAgdGhpcy50b29sdGlwRWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9oaWRlVG9vbHRpcCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudG9vbHRpcEVsKSB0aGlzLnRvb2x0aXBFbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KCgpfc2V0dXBHZW5lcmFsKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0dlbmVyYWwnKTsKICAgICAgICAgICAgCmNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIHRpbWVTY2FsZTogd2luZG93LmZsdXgudGltZVNjYWxlLAogICAgICAgICAgICAgICAgZGVtb01vZGU6IHRoaXMuZ2FtZS5pc0RlbW9Nb2RlLAogICAgICAgICAgICAgICAgdG9nZ2xlSFVEOiB0cnVlLAogICAgICAgICAgICAgICAgcmVzb2x1dGlvbjogMC41MCwKYXJlbmFPcGFjaXR5OiAwLjMsCiAgICAgICAgICAgICAgICBhcmVuYTJPcGFjaXR5OiAwLjI1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3RpbWVTY2FsZScsIDAuMCwgNS4wKS5uYW1lKCdHYW1lIFNwZWVkJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSB2OwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZGVtb01vZGUnKS5uYW1lKCdEZW1vIE1vZGUnKS5saXN0ZW4oKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuaXNEZW1vTW9kZSAhPT0gdikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS50b2dnbGVEZW1vTW9kZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndG9nZ2xlSFVEJykubmFtZSgnU2hvdyBIVUQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGh1ZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpOwogICAgICAgICAgICAgICAgaWYgKGh1ZCkgewogICAgICAgICAgICAgICAgICAgIGh1ZC5zdHlsZS52aXNpYmlsaXR5ID0gdiA/ICd2aXNpYmxlJyA6ICdoaWRkZW4nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAncmVzb2x1dGlvbicsIDAuMSwgMi4wKS5uYW1lKCdSZXNvbHV0aW9uIFNjYWxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB3ID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBoID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgY29uc3QgcmVuZGVyZXIgPSB0aGlzLmdhbWUucmVuZGVyZXI7CiAgICAgICAgICAgICAgICBpZiAocmVuZGVyZXIpIHsKICAgICAgICAgICAgICAgICAgICByZW5kZXJlci5zZXRTaXplKHcgKiB2LCBoICogdiwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCmZvbGRlci5hZGQocGFyYW1zLCAnYXJlbmFPcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ0FyZW5hIDEgT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IHY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYmxlbmRNb2RlcyA9IHsKICAgICAgICAgICAgICAgICdOb3JtYWwnOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywKICAgICAgICAgICAgICAgICdBZGRpdGl2ZSc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnTXVsdGlwbHknOiBUSFJFRS5NdWx0aXBseUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICdOb0JsZW5kaW5nJzogVEhSRUUuTm9CbGVuZGluZwogICAgICAgICAgICB9OwpwYXJhbXMuYXJlbmFCbGVuZCA9ICdOb3JtYWwnOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYUJsZW5kJywgT2JqZWN0LmtleXMoYmxlbmRNb2RlcykpLm5hbWUoJ0FyZW5hIDEgQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2ggJiYgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsLmJsZW5kaW5nID0gYmxlbmRNb2Rlc1t2XTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEFyZW5hIDIgQ29udHJvbHMKZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYTJPcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ0FyZW5hIDIgT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIgJiYgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eS52YWx1ZSA9IHY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKcGFyYW1zLmFyZW5hMkJsZW5kID0gJ0FkZGl0aXZlJzsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYTJCbGVuZCcsIE9iamVjdC5rZXlzKGJsZW5kTW9kZXMpKS5uYW1lKCdBcmVuYSAyIEJsZW5kJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoMiAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC5ibGVuZGluZyA9IGJsZW5kTW9kZXNbdl07CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgZGVmYXVsdHMKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gcGFyYW1zLmFyZW5hT3BhY2l0eTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoMiAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLm9wYWNpdHkgPSBwYXJhbXMuYXJlbmEyT3BhY2l0eTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3NldHVwQ29udHJvbHNGZWVsKCkgewogICAgICAgICAgICBjb25zdCBkZWJ1Z0lPID0gKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPKSA/IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIDogbnVsbDsKICAgICAgICAgICAgaWYgKCFkZWJ1Z0lPIHx8ICFkZWJ1Z0lPLnNldHRpbmdzKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBzID0gZGVidWdJTy5zZXR0aW5nczsKCiAgICAgICAgICAgIC8vIEVuc3VyZSBkZWZhdWx0cyBleGlzdCAob2xkZXIgcHJvamVjdHMgbWF5IG5vdCBoYXZlIHRoZXNlIGtleXMgeWV0KQogICAgICAgICAgICBpZiAocy5wYXNzQWltQXNzaXN0ID09PSB1bmRlZmluZWQpIHMucGFzc0FpbUFzc2lzdCA9IDAuNjU7CiAgICAgICAgICAgIGlmIChzLnNob3RBaW1Bc3Npc3QgPT09IHVuZGVmaW5lZCkgcy5zaG90QWltQXNzaXN0ID0gMC4zNTsKICAgICAgICAgICAgaWYgKHMuY2F0Y2hBc3Npc3QgPT09IHVuZGVmaW5lZCkgcy5jYXRjaEFzc2lzdCA9IDAuNTU7CiAgICAgICAgICAgIGlmIChzLnN0ZWVyaW5nQXNzaXN0ID09PSB1bmRlZmluZWQpIHMuc3RlZXJpbmdBc3Npc3QgPSAwLjM1OwogICAgICAgICAgICBpZiAocy5pbnB1dFJlc3BvbnNlID09PSB1bmRlZmluZWQpIHMuaW5wdXRSZXNwb25zZSA9IDE0LjA7CiAgICAgICAgICAgIGlmIChzLnByZWRpY3RpdmVDYXRjaFRpbWUgPT09IHVuZGVmaW5lZCkgcy5wcmVkaWN0aXZlQ2F0Y2hUaW1lID0gMC4xMjsKCiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignQ29udHJvbHMgJiBGZWVsJyk7CgogICAgICAgICAgICAvLyBDb3JlIHRvZ2dsZXMKICAgICAgICAgICAgZm9sZGVyLmFkZChzLCAnam95c3RpY2tTZW5zaXRpdml0eScsIDAuMywgMi4wLCAwLjAxKS5uYW1lKCdNb3ZlIFNlbnNpdGl2aXR5Jyk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocywgJ2ludmVydENhbWVyYScpLm5hbWUoJ0ludmVydCBDYW1lcmEnKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChzLCAnYXV0b1JlY2VudGVyJykubmFtZSgnQXV0byBSZWNlbnRlcicpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHMsICdhaW1Bc3Npc3QnKS5uYW1lKCdBaW0gQXNzaXN0Jyk7CgogICAgICAgICAgICAvLyBBc3Npc3QgbGF5ZXIgKDAuLjEpCiAgICAgICAgICAgIGNvbnN0IGEgPSBmb2xkZXIuYWRkRm9sZGVyKCdBc3Npc3QgU3RyZW5ndGhzJyk7CiAgICAgICAgICAgIGEuYWRkKHMsICdwYXNzQWltQXNzaXN0JywgMC4wLCAxLjAsIDAuMDEpLm5hbWUoJ1Bhc3MgQXNzaXN0Jyk7CiAgICAgICAgICAgIGEuYWRkKHMsICdzaG90QWltQXNzaXN0JywgMC4wLCAxLjAsIDAuMDEpLm5hbWUoJ1Nob3QgQXNzaXN0Jyk7CiAgICAgICAgICAgIGEuYWRkKHMsICdjYXRjaEFzc2lzdCcsIDAuMCwgMS4wLCAwLjAxKS5uYW1lKCdDYXRjaCBBc3Npc3QnKTsKICAgICAgICAgICAgYS5hZGQocywgJ3N0ZWVyaW5nQXNzaXN0JywgMC4wLCAxLjAsIDAuMDEpLm5hbWUoJ1N0ZWVyaW5nIEFzc2lzdCcpOwoKICAgICAgICAgICAgY29uc3QgZiA9IGZvbGRlci5hZGRGb2xkZXIoJ1Jlc3BvbnNpdmVuZXNzJyk7CiAgICAgICAgICAgIGYuYWRkKHMsICdpbnB1dFJlc3BvbnNlJywgNC4wLCAyNC4wLCAwLjEpLm5hbWUoJ0lucHV0IFJlc3BvbnNlJyk7CiAgICAgICAgICAgIGYuYWRkKHMsICdwcmVkaWN0aXZlQ2F0Y2hUaW1lJywgMC4wLCAwLjM1LCAwLjAxKS5uYW1lKCdQcmVkaWN0IENhdGNoIChzKScpOwogICAgICAgIH0KCgpfc2V0dXBPdmVybGF5cygpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdPdmVybGF5cyAmIEZYJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAxLiBHSUYgT3ZlcmxheQogICAgICAgICAgICBjb25zdCBnaWZFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzY3JlZW4tb3ZlcmxheS1naWYnKTsKICAgICAgICAgICAgaWYgKGdpZkVsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnaWZQYXJhbXMgPSB7CiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogdHJ1ZSwKb3BhY2l0eTogMC42MiwKICAgICAgICAgICAgICAgICAgICBibGVuZDogJ292ZXJsYXknCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBnRm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignU2NyZWVuIEdJRicpOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAndmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gZ2lmRWwuc3R5bGUuZGlzcGxheSA9IHYgPyAnYmxvY2snIDogJ25vbmUnKTsKICAgICAgICAgICAgICAgIGdGb2xkZXIuYWRkKGdpZlBhcmFtcywgJ29wYWNpdHknLCAwLjAsIDEuMCkub25DaGFuZ2UodiA9PiBnaWZFbC5zdHlsZS5vcGFjaXR5ID0gdik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGJsZW5kTW9kZXMgPSBbCiAgICAgICAgICAgICAgICAgICAgJ25vcm1hbCcsICdtdWx0aXBseScsICdzY3JlZW4nLCAnb3ZlcmxheScsIAogICAgICAgICAgICAgICAgICAgICdkYXJrZW4nLCAnbGlnaHRlbicsICdjb2xvci1kb2RnZScsICdjb2xvci1idXJuJywgCiAgICAgICAgICAgICAgICAgICAgJ2hhcmQtbGlnaHQnLCAnc29mdC1saWdodCcsICdkaWZmZXJlbmNlJywgJ2V4Y2x1c2lvbicsIAogICAgICAgICAgICAgICAgICAgICdodWUnLCAnc2F0dXJhdGlvbicsICdjb2xvcicsICdsdW1pbm9zaXR5JwogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgIGdGb2xkZXIuYWRkKGdpZlBhcmFtcywgJ2JsZW5kJywgYmxlbmRNb2Rlcykub25DaGFuZ2UodiA9PiBnaWZFbC5zdHlsZS5taXhCbGVuZE1vZGUgPSB2KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gV2F0ZXIgT3ZlcmxheQogICAgICAgICAgICBjb25zdCB3byA9IHRoaXMuZ2FtZS53YXRlck92ZXJsYXk7CiAgICAgICAgICAgIGlmICh3byAmJiB3by5tZXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCB3Rm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignV2F0ZXIgU2hhZGVyJyk7CiAgICAgICAgICAgICAgICBjb25zdCB3UGFyYW1zID0geyAKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHdvLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5ID8gd28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkudmFsdWUgOiAwLjUsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdBZGRpdGl2ZScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHdGb2xkZXIuYWRkKHdQYXJhbXMsICd2aXNpYmxlJykub25DaGFuZ2UodiA9PiB3by5tZXNoLnZpc2libGUgPSB2KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHdvLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ29wYWNpdHknLCAwLjAsIDIuMCkub25DaGFuZ2UodiA9PiB3by5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eS52YWx1ZSA9IHYpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHRocmVlQmxlbmRzID0gewogICAgICAgICAgICAgICAgICAgICdOb3JtYWwnOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICAnQWRkaXRpdmUnOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdTdWJ0cmFjdGl2ZSc6IFRIUkVFLlN1YnRyYWN0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgJ011bHRpcGx5JzogVEhSRUUuTXVsdGlwbHlCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICAnTm9CbGVuZGluZyc6IFRIUkVFLk5vQmxlbmRpbmcKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHdGb2xkZXIuYWRkKHdQYXJhbXMsICdibGVuZCcsIE9iamVjdC5rZXlzKHRocmVlQmxlbmRzKSkub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgd28ubWF0ZXJpYWwuYmxlbmRpbmcgPSB0aHJlZUJsZW5kc1t2XTsKICAgICAgICAgICAgICAgICAgICB3by5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gTGlnaHQgU2hhZnRzCiAgICAgICAgICAgIGNvbnN0IGxzID0gdGhpcy5nYW1lLmxpZ2h0U2hhZnRzOwogICAgICAgICAgICBpZiAobHMgJiYgbHMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBsUGFyYW1zID0geyB2aXNpYmxlOiB0cnVlIH07CiAgICAgICAgICAgICAgICBmb2xkZXIuYWRkKGxQYXJhbXMsICd2aXNpYmxlJykubmFtZSgnTGlnaHQgU2hhZnRzJykub25DaGFuZ2UodiA9PiBscy5jb250YWluZXIudmlzaWJsZSA9IHYpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX3NldHVwR2FtZVN0YXRlKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0dhbWUgU3RhdGUnKTsKICAgICAgICAgICAgY29uc3QgZ20gPSB0aGlzLmdhbWU7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgICAgICBmb3JjZUhvbWVHb2FsOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGlmKGdtLnN0YXRlID09PSAnYWN0aXZlJykgZ20uZ29hbFNjb3JlZCgnaG9tZScpOyAKICAgICAgICAgICAgICAgICAgICBlbHNlIGNvbnNvbGUud2FybigiR2FtZSBtdXN0IGJlIGFjdGl2ZSB0byB0cmlnZ2VyIGdvYWwiKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBmb3JjZUF3YXlHb2FsOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGlmKGdtLnN0YXRlID09PSAnYWN0aXZlJykgZ20uZ29hbFNjb3JlZCgnYXdheScpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgY29uc29sZS53YXJuKCJHYW1lIG11c3QgYmUgYWN0aXZlIHRvIHRyaWdnZXIgZ29hbCIpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGZvcmNlSGFsZnRpbWU6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZihnbS5zdGF0ZSA9PT0gJ2FjdGl2ZScpIGdtLmVuZEhhbGYoKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICByZXNldFJvdW5kOiAoKSA9PiBnbS5yZXNldFJvdW5kKCksCiAgICAgICAgICAgICAgICBleGl0VG9NZW51OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnN0YXRlID0gJ21lbnUnOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9wIHByYWN0aWNlIGlmIHJ1bm5pbmcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wcmFjdGljZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wcmFjdGljZU1hbmFnZXIuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdmb3JjZUhvbWVHb2FsJykubmFtZSgnVHJpZ2dlciBIb21lIEdvYWwnKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdmb3JjZUF3YXlHb2FsJykubmFtZSgnVHJpZ2dlciBBd2F5IEdvYWwnKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdmb3JjZUhhbGZ0aW1lJykubmFtZSgnRm9yY2UgSGFsZnRpbWUnKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdyZXNldFJvdW5kJykubmFtZSgnUmVzZXQgUm91bmQnKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdleGl0VG9NZW51JykubmFtZSgnRXhpdCB0byBNZW51Jyk7CiAgICAgICAgfQoKICAgICAgICBfc2V0dXBUZWFtcygpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdUZWFtcycpOwogICAgICAgICAgICBpZiAoIXRoaXMuZ2FtZS50ZWFtcy5ob21lIHx8ICF0aGlzLmdhbWUudGVhbXMuYXdheSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgaG9tZSA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBjb25zdCBhd2F5ID0gdGhpcy5nYW1lLnRlYW1zLmF3YXk7CgogICAgICAgICAgICAvLyBIb21lCiAgICAgICAgICAgIGNvbnN0IGhGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdIb21lIFRlYW0nKTsKICAgICAgICAgICAgaEZvbGRlci5hZGQoaG9tZSwgJ2lzSHVtYW4nKS5uYW1lKCdJcyBIdW1hbiBDb250cm9sbGVkJykubGlzdGVuKCk7CiAgICAgICAgICAgIGhGb2xkZXIuYWRkKGhvbWUsICdhaUVuYWJsZWQnKS5uYW1lKCdBSSBMb2dpYyBFbmFibGVkJykubGlzdGVuKCk7CgogICAgICAgICAgICAvLyBBd2F5CiAgICAgICAgICAgIGNvbnN0IGFGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdBd2F5IFRlYW0nKTsKICAgICAgICAgICAgYUZvbGRlci5hZGQoYXdheSwgJ2lzSHVtYW4nKS5uYW1lKCdJcyBIdW1hbiBDb250cm9sbGVkJykubGlzdGVuKCk7CiAgICAgICAgICAgIGFGb2xkZXIuYWRkKGF3YXksICdhaUVuYWJsZWQnKS5uYW1lKCdBSSBMb2dpYyBFbmFibGVkJykubGlzdGVuKCk7CgogICAgICAgIH0KCl9zZXR1cFBsYXllckluc3BlY3RvcigpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdQbGF5ZXIgSW5zcGVjdG9yIChIb21lIEFjdGl2ZSknKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhlbHBlciB0byBnZXQgY3VycmVudCBhY3RpdmUgcGxheWVyIHNhZmVseQogICAgICAgICAgICBjb25zdCBnZXRBY3RpdmUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICByZXR1cm4gKHRoaXMuZ2FtZS50ZWFtcy5ob21lICYmIHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcikgCiAgICAgICAgICAgICAgICAgICAgPyB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIgCiAgICAgICAgICAgICAgICAgICAgOiBudWxsOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUHJveHkgb2JqZWN0IHRvIGJpbmQgR1VJIHRvIGR5bmFtaWMgdGFyZ2V0CiAgICAgICAgICAgIGNvbnN0IHByb3h5ID0gewogICAgICAgICAgICAgICAgZ2V0IFJvbGUoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAucm9sZSA6ICctJzsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBnZXQgR29kTW9kZSgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5pc0dvZE1vZGUgOiBmYWxzZTsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEdvZE1vZGUodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5pc0dvZE1vZGUgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLy8gUnVudGltZSBWYWx1ZXMKICAgICAgICAgICAgICAgIGdldCBIUCgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5IUCA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBIUCh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLkhQID0gdjsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBnZXQgQ3VycmVudEVOKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLmN1cnJlbnRFTiA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBDdXJyZW50RU4odikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5jdXJyZW50RU4gPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLy8gQmFzZSBTdGF0cwogICAgICAgICAgICAgICAgZ2V0IE1heEhQKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLm1heEhQIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IE1heEhQKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMubWF4SFAgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFNQKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlNQIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFNQKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHMuU1AgPSB2OyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7IAogICAgICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBFTigpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5FTiA6IDA7IAogICAgICAgICAgICAgICAgfSwgCiAgICAgICAgICAgICAgICBzZXQgRU4odikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgewogICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXRzLkVOID0gdjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBBVCgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5BVCA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBBVCh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLkFUID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBQQSgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5QQSA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBQQSh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLlBBID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBCTCgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5CTCA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBCTCh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLkJMID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBTSCgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5TSCA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBTSCh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLlNIID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBDQSgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5DQSA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBDQSh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLkNBID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIC8vIEFjdGlvbnMKICAgICAgICAgICAgICAgIExldmVsVXA6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAubGV2ZWxVcCgpOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBGdWxsSGVhbDogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7IAogICAgICAgICAgICAgICAgICAgIGlmKHApIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSBwLmdldFN0YXQoJ0VOJyk7IAogICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXR1cy52ZW5vbSA9IDA7IAogICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXR1cy5uYXAgPSAwOyAKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBrIGluIHAuc3RhdHVzLndpdGhlcikgcC5zdGF0dXMud2l0aGVyW2tdID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiRlVMTCBIRUFMIiwgcC5tZXNoLnBvc2l0aW9uLCAiaGVhbCIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBEcmFpbkVOOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuY3VycmVudEVOID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgcC5mdW1ibGUoKTsgLy8gVHJpZ2dlciBmdW1ibGUgbG9naWMKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHByb3h5LCAnUm9sZScpLmxpc3RlbigpLmRpc2FibGUoKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwcm94eSwgJ0dvZE1vZGUnKS5uYW1lKCdHb2QgTW9kZSAoSW5mIEhQL0VOKScpLmxpc3RlbigpOwoKICAgICAgICAgICAgY29uc3QgcnRGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdSdW50aW1lIFN0YXR1cycpOwogICAgICAgICAgICBydEZvbGRlci5hZGQocHJveHksICdIUCcsIDAsIDk5OTkpLmxpc3RlbigpOwogICAgICAgICAgICBydEZvbGRlci5hZGQocHJveHksICdDdXJyZW50RU4nLCAwLCAxMDApLm5hbWUoJ0N1cnJlbnQgRU4nKS5saXN0ZW4oKTsKCiAgICAgICAgICAgIGNvbnN0IHN0YXRGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdCYXNlIFN0YXRzJyk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnTWF4SFAnLCAxMDAsIDk5OTkpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ0VOJywgMCwgOTkpLm5hbWUoJ01heCBFTicpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ1NQJywgMCwgOTkpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ0FUJywgMCwgOTkpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ1BBJywgMCwgOTkpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ0JMJywgMCwgOTkpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ1NIJywgMCwgOTkpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ0NBJywgMCwgOTkpLmxpc3RlbigpOwoKICAgICAgICAgICAgY29uc3QgYWN0aW9uRm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignQWN0aW9ucycpOwogICAgICAgICAgICBhY3Rpb25Gb2xkZXIuYWRkKHByb3h5LCAnTGV2ZWxVcCcpLm5hbWUoJ0luc3RhbnQgTGV2ZWwgVXAnKTsKICAgICAgICAgICAgYWN0aW9uRm9sZGVyLmFkZChwcm94eSwgJ0Z1bGxIZWFsJykubmFtZSgnRnVsbCBIZWFsICYgQ3VyZScpOwogICAgICAgICAgICBhY3Rpb25Gb2xkZXIuYWRkKHByb3h5LCAnRHJhaW5FTicpLm5hbWUoJ0RyYWluIEVOIChGdW1ibGUpJyk7CiAgICAgICAgfQoKX3NldHVwQmFsbFNhbmRib3goKSB7CiAgICBjb25zdCByb290ID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdCYWxsIExhYiAoVGhyb3cgJiBQaHlzaWNzKScpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gU2hhcmVkIHN0YXRlIG9iamVjdCAobGl2ZXMgb24gd2luZG93LmZsdXggc28gaXQgc3Vydml2ZXMgcmVsb2FkcykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgbGFiID0gd2luZG93LmZsdXguYmFsbExhYiA9IHdpbmRvdy5mbHV4LmJhbGxMYWIgfHwge307CiAgICBsYWIuZ2FtZSA9IHRoaXMuZ2FtZTsKCiAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZzsKICAgIGNvbnN0IFRDID0gd2luZG93LmZsdXguVGhyb3dDb25maWc7CgogICAgaWYgKCFDIHx8ICFUQykgewogICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBMYWI6IE1pc3NpbmcgQmFsbENvbmZpZyBvciBUaHJvd0NvbmZpZy4iKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBIZWxwZXJzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IGdldEJhbGwgPSAoKSA9PiB0aGlzLmdhbWUgJiYgdGhpcy5nYW1lLmVudGl0aWVzID8gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgY29uc3QgZ2V0QWN0aXZlID0gKCkgPT4gdGhpcy5nYW1lICYmIHRoaXMuZ2FtZS50ZWFtcyAmJiB0aGlzLmdhbWUudGVhbXMuaG9tZSA/IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciA6IG51bGw7CgogICAgY29uc3QgZW5zdXJlUHJldmlld0xpbmUgPSAoKSA9PiB7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3TGluZSkgcmV0dXJuOwogICAgICAgIGlmICghdGhpcy5nYW1lIHx8ICF0aGlzLmdhbWUuc2NlbmUpIHJldHVybjsKCiAgICAgICAgY29uc3QgZ2VvbSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5MaW5lQmFzaWNNYXRlcmlhbCh7IHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjk1IH0pOwogICAgICAgIGNvbnN0IGxpbmUgPSBuZXcgVEhSRUUuTGluZShnZW9tLCBtYXQpOwogICAgICAgIGxpbmUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgIGxpbmUucmVuZGVyT3JkZXIgPSA5OTk7CiAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZChsaW5lKTsKICAgICAgICBsYWIucHJldmlld0xpbmUgPSBsaW5lOwogICAgfTsKCiAgICBjb25zdCBjbGVhclByZXZpZXdMaW5lID0gKCkgPT4gewogICAgICAgIGlmIChsYWIucHJldmlld0xpbmUgJiYgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5KSB7CiAgICAgICAgICAgIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeS5kaXNwb3NlKCk7CiAgICAgICAgICAgIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gQSBzYWZlICJnaG9zdCBiYWxsIiB0aGF0IGNhbiB1c2UgQmFsbC51cGRhdGVGcmVlIHdpdGhvdXQgc3Bhd25pbmcgRlgKICAgIGNvbnN0IG1ha2VHaG9zdEJhbGwgPSAocG9zLCB2ZWwsIHNwaW4pID0+IHsKICAgICAgICBjb25zdCBnYiA9IHsKICAgICAgICAgICAgbWVzaDogeyBwb3NpdGlvbjogcG9zLmNsb25lKCkgfSwKICAgICAgICAgICAgdmVsb2NpdHk6IHZlbC5jbG9uZSgpLAogICAgICAgICAgICBhbmd1bGFyVmVsb2NpdHk6IChzcGluID8gc3Bpbi5jbG9uZSgpIDogbmV3IFRIUkVFLlZlY3RvcjMoKSksCiAgICAgICAgICAgIGFjY3VtdWxhdGVkUm90YXRpb246IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCksCiAgICAgICAgICAgIHBvd2VyOiAwLAogICAgICAgICAgICBkZWNheVJhdGU6IDAsCiAgICAgICAgICAgIF9idWJibGVUaW1lcjogOTk5LAogICAgICAgICAgICBfZ2hvc3Q6IHRydWUsCiAgICAgICAgICAgIGRlZm9ybU5vZGU6IG51bGwKICAgICAgICB9OwogICAgICAgIHJldHVybiBnYjsKICAgIH07CgogICAgLy8gVXNlIEJhbGwudXBkYXRlRnJlZSBmb3IgZmFpdGhmdWwgdHJhamVjdG9yeSBwcmVkaWN0aW9uCiAgICBjb25zdCBzaW11bGF0ZSA9IChnaG9zdEJhbGwsIHN0ZXBzLCBzdGVwRHQpID0+IHsKICAgICAgICBjb25zdCBwdHMgPSBbXTsKICAgICAgICBwdHMucHVzaChnaG9zdEJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpKTsKICAgICAgICBjb25zdCBwcm90byA9IHdpbmRvdy5mbHV4LkJhbGwgJiYgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGU7CiAgICAgICAgaWYgKCFwcm90byB8fCB0eXBlb2YgcHJvdG8udXBkYXRlRnJlZSAhPT0gJ2Z1bmN0aW9uJykgcmV0dXJuIHB0czsKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdGVwczsgaSsrKSB7CiAgICAgICAgICAgIHByb3RvLnVwZGF0ZUZyZWUuY2FsbChnaG9zdEJhbGwsIHN0ZXBEdCk7CiAgICAgICAgICAgIHB0cy5wdXNoKGdob3N0QmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcHRzOwogICAgfTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIFByZXZpZXcgKyByZWNvcmQvcmVwbGF5IHJ1bnRpbWUgbG9vcAogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmxhYi5wcmV2aWV3ID0gbGFiLnByZXZpZXcgfHwgewogICAgICAgIGVuYWJsZWQ6IGZhbHNlLAogICAgICAgIHNvdXJjZTogJ0Nhbm5vbicsCiAgICAgICAgc3RlcHM6IDEyMCwKICAgICAgICBzdGVwRHQ6IDEvNjAsCiAgICAgICAgcmVmcmVzaEh6OiAxMCwKICAgICAgICBzaG93T25IZWxkT25seTogZmFsc2UKICAgIH07CgogICAgbGFiLmNhbm5vbiA9IGxhYi5jYW5ub24gfHwgewogICAgICAgIHlhdzogMCwKICAgICAgICBwaXRjaDogMCwKICAgICAgICBwb3dlcjogMjAsCiAgICAgICAgdHlwZTogJ1NIJywKICAgICAgICBzcGluWDogMCwKICAgICAgICBzcGluWTogMCwKICAgICAgICBzcGluWjogMCwKICAgICAgICBmaXJlQnVyc3Q6IDEsCiAgICAgICAgc3ByZWFkRGVnOiAwCiAgICB9OwoKICAgIGxhYi5yZWNvcmRpbmcgPSBsYWIucmVjb3JkaW5nIHx8IHsKICAgICAgICBpc1JlY29yZGluZzogZmFsc2UsCiAgICAgICAgZnJhbWVzOiBbXSwKICAgICAgICBtYXhTZWNvbmRzOiAxMgogICAgfTsKCiAgICBsYWIucmVwbGF5ID0gbGFiLnJlcGxheSB8fCB7CiAgICAgICAgaXNSZXBsYXlpbmc6IGZhbHNlLAogICAgICAgIGZyYW1lczogW10sCiAgICAgICAgaWR4OiAwLAogICAgICAgIGxvb3A6IHRydWUsCiAgICAgICAgc3BlZWQ6IDEuMAogICAgfTsKCiAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgIGxhYi50YXJnZXRCYWxsID0gbnVsbDsKCiAgICBsYWIuYXBwbHlSZXBsYXlGcmFtZSA9IChiYWxsLCBkdCkgPT4gewogICAgICAgIGNvbnN0IHJlcCA9IGxhYi5yZXBsYXk7CiAgICAgICAgaWYgKCFyZXAgfHwgIXJlcC5pc1JlcGxheWluZyB8fCAhcmVwLmZyYW1lcyB8fCByZXAuZnJhbWVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gQWR2YW5jZSB0aW1lIGJ5IHN0ZXBwaW5nIGluZGljZXMgKGZyYW1lLWJhc2VkKQogICAgICAgIGNvbnN0IHN0ZXAgPSBNYXRoLm1heCgxLCBNYXRoLmZsb29yKHJlcC5zcGVlZCkpOwogICAgICAgIHJlcC5pZHggKz0gc3RlcDsKCiAgICAgICAgaWYgKHJlcC5pZHggPj0gcmVwLmZyYW1lcy5sZW5ndGgpIHsKICAgICAgICAgICAgaWYgKHJlcC5sb29wKSByZXAuaWR4ID0gMDsKICAgICAgICAgICAgZWxzZSB7IHJlcC5pc1JlcGxheWluZyA9IGZhbHNlOyBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsgcmV0dXJuOyB9CiAgICAgICAgfQoKICAgICAgICBjb25zdCBmID0gcmVwLmZyYW1lc1tyZXAuaWR4XTsKICAgICAgICBpZiAoIWYpIHJldHVybjsKCiAgICAgICAgYmFsbC5kcm9wKCk7IC8vIGVuc3VyZSBubyBob2xkZXIgbG9naWMgZmlnaHRzIHVzCiAgICAgICAgYmFsbC5zdGF0ZSA9ICdmcmVlJzsKICAgICAgICBiYWxsLm1lc2gucG9zaXRpb24uc2V0KGYucHgsIGYucHksIGYucHopOwogICAgICAgIGJhbGwudmVsb2NpdHkuc2V0KGYudngsIGYudnksIGYudnopOwogICAgICAgIGJhbGwuYW5ndWxhclZlbG9jaXR5LnNldChmLnN4LCBmLnN5LCBmLnN6KTsKICAgIH07CgogICAgbGFiLl9wcmV2aWV3VGltZXIgPSBsYWIuX3ByZXZpZXdUaW1lciB8fCAwOwoKICAgIGxhYi51cGRhdGUgPSAoZHQpID0+IHsKICAgICAgICAvLyAtLS0gcmVjb3JkaW5nIC0tLQogICAgICAgIGNvbnN0IGIgPSBnZXRCYWxsKCk7CiAgICAgICAgaWYgKGIgJiYgbGFiLnJlY29yZGluZyAmJiBsYWIucmVjb3JkaW5nLmlzUmVjb3JkaW5nKSB7CiAgICAgICAgICAgIGNvbnN0IHIgPSBsYWIucmVjb3JkaW5nOwogICAgICAgICAgICBjb25zdCBtYXhGcmFtZXMgPSBNYXRoLmZsb29yKChyLm1heFNlY29uZHMgfHwgMTIpIC8gKGR0IHx8ICgxLzYwKSkpOwogICAgICAgICAgICBpZiAoci5mcmFtZXMubGVuZ3RoID4gbWF4RnJhbWVzKSByLmZyYW1lcy5zaGlmdCgpOwogICAgICAgICAgICByLmZyYW1lcy5wdXNoKHsKICAgICAgICAgICAgICAgIHB4OiBiLm1lc2gucG9zaXRpb24ueCwgcHk6IGIubWVzaC5wb3NpdGlvbi55LCBwejogYi5tZXNoLnBvc2l0aW9uLnosCiAgICAgICAgICAgICAgICB2eDogYi52ZWxvY2l0eS54LCB2eTogYi52ZWxvY2l0eS55LCB2ejogYi52ZWxvY2l0eS56LAogICAgICAgICAgICAgICAgc3g6IGIuYW5ndWxhclZlbG9jaXR5LngsIHN5OiBiLmFuZ3VsYXJWZWxvY2l0eS55LCBzejogYi5hbmd1bGFyVmVsb2NpdHkuegogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBwcmV2aWV3IHJlZnJlc2ggLS0tCiAgICAgICAgbGFiLl9wcmV2aWV3VGltZXIgKz0gZHQ7CiAgICAgICAgY29uc3QgcmVmcmVzaEludGVydmFsID0gMS4wIC8gTWF0aC5tYXgoMSwgKGxhYi5wcmV2aWV3LnJlZnJlc2hIeiB8fCAxMCkpOwogICAgICAgIGlmIChsYWIucHJldmlldy5lbmFibGVkICYmIGxhYi5fcHJldmlld1RpbWVyID49IHJlZnJlc2hJbnRlcnZhbCkgewogICAgICAgICAgICBsYWIuX3ByZXZpZXdUaW1lciA9IDA7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0KICAgIH07CgogICAgbGFiLnJlZnJlc2hQcmV2aWV3ID0gKCkgPT4gewogICAgICAgIGlmICghbGFiLnByZXZpZXcuZW5hYmxlZCkgeyBjbGVhclByZXZpZXdMaW5lKCk7IHJldHVybjsgfQogICAgICAgIGVuc3VyZVByZXZpZXdMaW5lKCk7CgogICAgICAgIGNvbnN0IGIgPSBnZXRCYWxsKCk7CiAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgIGlmICghYiB8fCAhYi5tZXNoKSByZXR1cm47CgogICAgICAgIGlmIChsYWIucHJldmlldy5zaG93T25IZWxkT25seSAmJiBiLnN0YXRlICE9PSAnaGVsZCcpIHsKICAgICAgICAgICAgY2xlYXJQcmV2aWV3TGluZSgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBEZWNpZGUgcHJldmlldyBzb3VyY2UKICAgICAgICBsZXQgc3RhcnRQb3MgPSBiLm1lc2gucG9zaXRpb247CiAgICAgICAgbGV0IHN0YXJ0VmVsID0gYi52ZWxvY2l0eTsKICAgICAgICBsZXQgc3RhcnRTcGluID0gYi5hbmd1bGFyVmVsb2NpdHk7CgogICAgICAgIGlmIChsYWIucHJldmlldy5zb3VyY2UgPT09ICdDYW5ub24nKSB7CiAgICAgICAgICAgIC8vIENhbm5vbiBhbHdheXMgbGF1bmNoZXMgZnJvbSBiYWxsIHBvc2l0aW9uIChvciBwbGF5ZXIgaWYgaGVsZCkKICAgICAgICAgICAgY29uc3QgeWF3UmFkID0gKGxhYi5jYW5ub24ueWF3IHx8IDApICogTWF0aC5QSSAvIDE4MDsKICAgICAgICAgICAgY29uc3QgcGl0Y2hSYWQgPSAobGFiLmNhbm5vbi5waXRjaCB8fCAwKSAqIE1hdGguUEkgLyAxODA7CgogICAgICAgICAgICBjb25zdCBkaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgIE1hdGguc2luKHlhd1JhZCkgKiBNYXRoLmNvcyhwaXRjaFJhZCksCiAgICAgICAgICAgICAgICBNYXRoLnNpbihwaXRjaFJhZCksCiAgICAgICAgICAgICAgICAtTWF0aC5jb3MoeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKQogICAgICAgICAgICApLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgY29uc3QgY2FwID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX0NBUCAhPT0gdW5kZWZpbmVkID8gd2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfQ0FQIDogODUuMCk7CiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX1NDQUxFICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkxBVU5DSF9TUEVFRF9TQ0FMRSA6IDEuMCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5taW4oKGxhYi5jYW5ub24ucG93ZXIgfHwgMjApICogc2NhbGUsIGNhcCk7CgogICAgICAgICAgICBzdGFydFBvcyA9IChiLnN0YXRlID09PSAnaGVsZCcgJiYgcCAmJiBwLm1lc2gpID8gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEuMiwgMCkpIDogYi5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgIHN0YXJ0VmVsID0gZGlyLm11bHRpcGx5U2NhbGFyKHNwZWVkKTsKICAgICAgICAgICAgc3RhcnRTcGluID0gbmV3IFRIUkVFLlZlY3RvcjMobGFiLmNhbm5vbi5zcGluWCB8fCAwLCBsYWIuY2Fubm9uLnNwaW5ZIHx8IDAsIGxhYi5jYW5ub24uc3BpblogfHwgMCk7CiAgICAgICAgfQoKICAgICAgICBjb25zdCBnaG9zdCA9IG1ha2VHaG9zdEJhbGwoc3RhcnRQb3MuY2xvbmUoKSwgc3RhcnRWZWwuY2xvbmUoKSwgc3RhcnRTcGluKTsKICAgICAgICBjb25zdCBwdHMgPSBzaW11bGF0ZShnaG9zdCwgTWF0aC5mbG9vcihsYWIucHJldmlldy5zdGVwcyB8fCAxMjApLCAobGFiLnByZXZpZXcuc3RlcER0IHx8ICgxLzYwKSkpOwoKICAgICAgICBpZiAobGFiLnByZXZpZXdMaW5lKSB7CiAgICAgICAgICAgIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeS5kaXNwb3NlKCk7CiAgICAgICAgICAgIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpLnNldEZyb21Qb2ludHMocHRzKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBCYWxsIFBoeXNpY3MgKEJhbGxDb25maWcpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHBoeXMgPSByb290LmFkZEZvbGRlcignQmFsbCBQaHlzaWNzIChCYWxsQ29uZmlnKScpOwoKICAgIGNvbnN0IGludGVnID0gcGh5cy5hZGRGb2xkZXIoJ0ludGVncmF0aW9uJyk7CiAgICBpbnRlZy5hZGQoQywgJ1NVQlNURVBTJywgMSwgMTIsIDEpLm5hbWUoJ1N1YnN0ZXBzJyk7CiAgICBpbnRlZy5hZGQoQywgJ1NUT1BfU1BFRUQnLCAwLjAsIDAuMikubmFtZSgnU3RvcCBTcGVlZCcpOwoKICAgIGNvbnN0IGRyYWcgPSBwaHlzLmFkZEZvbGRlcignV2F0ZXIgRHJhZycpOwogICAgZHJhZy5hZGQoQywgJ1dBVEVSX0RSQUdfTElORUFSJywgMC4wLCAyLjApLm5hbWUoJ0xpbmVhciBEcmFnJyk7CiAgICBkcmFnLmFkZChDLCAnV0FURVJfRFJBR19RVUFEJywgMC4wLCAwLjA1KS5uYW1lKCdRdWFkcmF0aWMgRHJhZycpOwoKICAgIGNvbnN0IHNwaW4gPSBwaHlzLmFkZEZvbGRlcignU3BpbicpOwogICAgc3Bpbi5hZGQoQywgJ1NQSU5fRFJBRycsIDAuMCwgMy4wKS5uYW1lKCdTcGluIERlY2F5Jyk7CgogICAgY29uc3QgbWFnbnVzID0gcGh5cy5hZGRGb2xkZXIoJ01hZ251cycpOwogICAgbWFnbnVzLmFkZChDLCAnTUFHTlVTX0VOQUJMRUQnKS5uYW1lKCdFbmFibGVkJyk7CiAgICBtYWdudXMuYWRkKEMsICdNQUdOVVNfQ09FRkYnLCAwLjAsIDAuNSkubmFtZSgnQ29lZmYnKTsKICAgIG1hZ251cy5hZGQoQywgJ01BR05VU19DQVAnLCAwLjAsIDIwMC4wKS5uYW1lKCdDYXAnKTsKCiAgICBjb25zdCBkZXB0aCA9IHBoeXMuYWRkRm9sZGVyKCdEZXB0aCBDb25zdHJhaW50Jyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX1RBUkdFVF9ZJywgLTUuMCwgNS4wKS5uYW1lKCdUYXJnZXQgWScpOwogICAgZGVwdGguYWRkKEMsICdERVBUSF9TUFJJTkcnLCAwLjAsIDEwLjApLm5hbWUoJ1NwcmluZycpOwogICAgZGVwdGguYWRkKEMsICdERVBUSF9EQU1QJywgMC4wLCA2LjApLm5hbWUoJ0RhbXAnKTsKCiAgICBjb25zdCBhcmVuYSA9IHBoeXMuYWRkRm9sZGVyKCdBcmVuYSBCb3VuZGFyeScpOwogICAgYXJlbmEuYWRkKEMsICdCT1VOREFSWV9SQURJVVMnLCAxMC4wLCAxMjAuMCkubmFtZSgnUmFkaXVzJyk7CiAgICBhcmVuYS5hZGQoQywgJ0JPVU5EQVJZX0hFSUdIVCcsIDIuMCwgNDAuMCkubmFtZSgnSGVpZ2h0Jyk7CiAgICBhcmVuYS5hZGQoQywgJ1dBTExfU09GVF9CVUZGRVInLCAwLjAsIDIwLjApLm5hbWUoJ1NvZnQgQnVmZmVyJyk7CiAgICBhcmVuYS5hZGQoQywgJ1dBTExfU09GVF9GT1JDRScsIDAuMCwgMjAwLjApLm5hbWUoJ1NvZnQgRm9yY2UnKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9FTEFTVElDSVRZJywgMC4wLCAxLjApLm5hbWUoJ1dhbGwgQm91bmNlJyk7CiAgICBhcmVuYS5hZGQoQywgJ1dBTExfRlJJQ1RJT04nLCAwLjAsIDEuMCkubmFtZSgnV2FsbCBGcmljdGlvbicpOwogICAgYXJlbmEuYWRkKEMsICdGTE9PUl9FTEFTVElDSVRZJywgMC4wLCAxLjApLm5hbWUoJ0NlaWwvRmxvb3IgQm91bmNlJyk7CgogICAgY29uc3QgcG9ja2V0ID0gYXJlbmEuYWRkRm9sZGVyKCdHb2FsIFBvY2tldCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfRU5BQkxFRCcpLm5hbWUoJ0VuYWJsZWQnKTsKICAgIHBvY2tldC5hZGQoQywgJ0dPQUxfUE9DS0VUX1gnLCAwLjAsIDQwLjApLm5hbWUoJ1BvY2tldCBIYWxmLVgnKTsKICAgIHBvY2tldC5hZGQoQywgJ0dPQUxfUE9DS0VUX1onLCAwLjAsIDUwLjApLm5hbWUoJ1BvY2tldCBTdGFydCB8WnwnKTsKICAgIHBvY2tldC5hZGQoQywgJ0dPQUxfUE9DS0VUX1JBRElVUycsIDEwLjAsIDEyMC4wKS5uYW1lKCdQb2NrZXQgUmFkaXVzJyk7CgogICAgY29uc3QgbGF1bmNoID0gcGh5cy5hZGRGb2xkZXIoJ0xhdW5jaCBNYXBwaW5nJyk7CiAgICBsYXVuY2guYWRkKEMsICdMQVVOQ0hfU1BFRURfU0NBTEUnLCAwLjEsIDUuMCkubmFtZSgnU3BlZWQgU2NhbGUnKTsKICAgIGxhdW5jaC5hZGQoQywgJ0xBVU5DSF9TUEVFRF9DQVAnLCAxMC4wLCAyMDAuMCkubmFtZSgnU3BlZWQgQ2FwJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFRocm93IG1hcHBpbmcgKFBsYXllci5yZWxlYXNlQ2hhcmdlIC0+IEJhbGwuc2hvb3QpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHRocm93TWFwID0gcm9vdC5hZGRGb2xkZXIoJ1Rocm93IE1hcHBpbmcgKFRocm93Q29uZmlnKScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnU1dJUEVfTUlOX1BYJywgMCwgMTIwLCAxKS5uYW1lKCdTd2lwZSBNaW4gUFgnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ0FJTV9EWF9TQ0FMRScsIDAuMSwgNS4wKS5uYW1lKCdBaW0gWCBTY2FsZScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnQUlNX0RZX1NDQUxFJywgMC4xLCA1LjApLm5hbWUoJ0FpbSBZIFNjYWxlJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdQT1dFUl9CQVNFJywgMC4xLCAzLjApLm5hbWUoJ1Bvd2VyIEJhc2UnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX1JBTkdFJywgMC4wLCAzLjApLm5hbWUoJ1Bvd2VyIFJhbmdlJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdQT1dFUl9NQVhfQk9OVVNfUkFUSU8nLCAwLjAsIDEuMCkubmFtZSgnTWF4IEJvbnVzIFJhdGlvJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdQT1dFUl9NQVhfTVVMVElQTElFUicsIDEuMCwgNi4wKS5uYW1lKCdNYXggTXVsdGlwbGllcicpOwoKICAgIGNvbnN0IGN1cnZlTWFwID0gdGhyb3dNYXAuYWRkRm9sZGVyKCdDdXJ2ZScpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfRU5BQkxFRCcpLm5hbWUoJ0VuYWJsZWQnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQnLCAwLjAsIDEuMCkubmFtZSgnSW5wdXQgVGhyZXNob2xkJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9TUElOX1NDQUxFJywgMC4wLCA0MDAwLjApLm5hbWUoJ1NwaW4gU2NhbGUnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX1NQRUVEX01VTFQnLCAwLjAsIDUuMCkubmFtZSgnU3dpcGUgU3BlZWQgTXVsdCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfU1BJTl9DQVAnLCAwLjAsIDYwMDAuMCkubmFtZSgnU3BpbiBDYXAnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX1BFUkZFQ1RfU1BJTicsIDAuMCwgMjAwMC4wKS5uYW1lKCdQZXJmZWN0IFRocmVzaG9sZCcpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBUZWxlcG9ydCAvIFN0YXRlIHRvb2xzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHRwID0gcm9vdC5hZGRGb2xkZXIoJ1RlbGVwb3J0IC8gUmVzZXQnKTsKICAgIGNvbnN0IHRwUGFyYW1zID0gewogICAgICAgIFRvQ2VudGVyOiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGlmIChiKSBiLnJlc2V0KCk7IH0sCiAgICAgICAgVG9BY3RpdmVQbGF5ZXI6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgY29uc3QgcCA9IGdldEFjdGl2ZSgpOyBpZiAoYiAmJiBwKSBiLmdyYWIocCk7IH0sCiAgICAgICAgVG9Ib21lR29hbDogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAyNSk7IGIudmVsb2NpdHkuc2V0KDAsMCwwKTsgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsgfSB9LAogICAgICAgIFRvQXdheUdvYWw6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgaWYgKGIpIHsgYi5kcm9wKCk7IGIubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTI1KTsgYi52ZWxvY2l0eS5zZXQoMCwwLDApOyBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOyB9IH0sCiAgICAgICAgVG9Ta3k6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgaWYgKGIpIHsgYi5kcm9wKCk7IGIubWVzaC5wb3NpdGlvbi5zZXQoMCwgMTAsIDApOyBiLnZlbG9jaXR5LnNldCgwLDAsMCk7IGIuYW5ndWxhclZlbG9jaXR5LnNldCgwLDAsMCk7IH0gfSwKICAgICAgICBDbGVhclByZXZpZXc6ICgpID0+IGNsZWFyUHJldmlld0xpbmUoKQogICAgfTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvQ2VudGVyJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0FjdGl2ZVBsYXllcicpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9Ib21lR29hbCcpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9Bd2F5R29hbCcpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9Ta3knKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ0NsZWFyUHJldmlldycpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBTaG90IENhbm5vbiAoZm9yY2UgZmlyZSB3aXRoIHBhcmFtcykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgY2Fubm9uID0gcm9vdC5hZGRGb2xkZXIoJ1Nob3QgQ2Fubm9uJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICd5YXcnLCAtMTgwLCAxODAsIDEpLm5hbWUoJ1lhdyAoZGVnKScpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAncGl0Y2gnLCAtODksIDg5LCAxKS5uYW1lKCdQaXRjaCAoZGVnKScpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAncG93ZXInLCAwLCAxMjAsIDAuMSkubmFtZSgnUG93ZXInKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3R5cGUnLCBbJ1BBJywnU0gnXSkubmFtZSgnVHlwZScpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnc3BpblgnLCAtMzAwMCwgMzAwMCwgMSkubmFtZSgnU3BpbiBYJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcGluWScsIC0zMDAwLCAzMDAwLCAxKS5uYW1lKCdTcGluIFknKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwaW5aJywgLTMwMDAsIDMwMDAsIDEpLm5hbWUoJ1NwaW4gWicpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnZmlyZUJ1cnN0JywgMSwgMTAsIDEpLm5hbWUoJ0J1cnN0IENvdW50Jyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcHJlYWREZWcnLCAwLCAzMCwgMC41KS5uYW1lKCdTcHJlYWQgKGRlZyknKTsKCiAgICBjb25zdCBmaXJlUGFyYW1zID0gewogICAgICAgIEZpcmU6ICgpID0+IHsKICAgICAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICBpZiAoIWIpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHlhd1JhZCA9IChsYWIuY2Fubm9uLnlhdyB8fCAwKSAqIE1hdGguUEkgLyAxODA7CiAgICAgICAgICAgIGNvbnN0IHBpdGNoUmFkID0gKGxhYi5jYW5ub24ucGl0Y2ggfHwgMCkgKiBNYXRoLlBJIC8gMTgwOwoKICAgICAgICAgICAgY29uc3QgYmFzZURpciA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgTWF0aC5zaW4oeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIE1hdGguc2luKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIC1NYXRoLmNvcyh5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpCiAgICAgICAgICAgICkubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBzdGFydCA9IChiLnN0YXRlID09PSAnaGVsZCcgJiYgcCAmJiBwLm1lc2gpID8gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEuMiwgMCkpIDogYi5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CgogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IChsYWIuY2Fubm9uLmZpcmVCdXJzdCB8fCAxKTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBiYXNlRGlyLmNsb25lKCk7CiAgICAgICAgICAgICAgICBpZiAobGFiLmNhbm5vbi5zcHJlYWREZWcgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3ByZWFkID0gKGxhYi5jYW5ub24uc3ByZWFkRGVnICogTWF0aC5QSSAvIDE4MCk7CiAgICAgICAgICAgICAgICAgICAgZGlyLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIHNwcmVhZDsKICAgICAgICAgICAgICAgICAgICBkaXIueSArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogc3ByZWFkOwogICAgICAgICAgICAgICAgICAgIGRpci56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcHJlYWQ7CiAgICAgICAgICAgICAgICAgICAgZGlyLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGIuZHJvcCgpOwogICAgICAgICAgICAgICAgYi5tZXNoLnBvc2l0aW9uLmNvcHkoc3RhcnQpOwogICAgICAgICAgICAgICAgYi52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsKCiAgICAgICAgICAgICAgICBjb25zdCBzcGluID0gbmV3IFRIUkVFLlZlY3RvcjMobGFiLmNhbm5vbi5zcGluWCB8fCAwLCBsYWIuY2Fubm9uLnNwaW5ZIHx8IDAsIGxhYi5jYW5ub24uc3BpblogfHwgMCk7CiAgICAgICAgICAgICAgICBiLnNob290KGRpciwgbGFiLmNhbm5vbi5wb3dlciB8fCAyMCwgbGFiLmNhbm5vbi50eXBlIHx8ICdTSCcsIG51bGwsIHNwaW4pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGNhbm5vbi5hZGQoZmlyZVBhcmFtcywgJ0ZpcmUnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogVHJhamVjdG9yeSBQcmV2aWV3CiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHByZXZpZXcgPSByb290LmFkZEZvbGRlcignVHJhamVjdG9yeSBQcmV2aWV3Jyk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ2VuYWJsZWQnKS5uYW1lKCdFbmFibGVkJykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdzb3VyY2UnLCBbJ0Nhbm5vbicsICdMaXZlIEJhbGwnXSkubmFtZSgnU291cmNlJykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdzdGVwcycsIDEwLCA2MDAsIDEpLm5hbWUoJ1N0ZXBzJykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdzdGVwRHQnLCAxLzI0MCwgMS8xNSwgMS8yNDApLm5hbWUoJ1N0ZXAgZHQnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3JlZnJlc2hIeicsIDEsIDYwLCAxKS5uYW1lKCdSZWZyZXNoIEh6Jyk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3Nob3dPbkhlbGRPbmx5JykubmFtZSgnT25seSB3aGVuIEhlbGQnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CgogICAgY29uc3QgcHJldmlld0J0bnMgPSB7CiAgICAgICAgUmVmcmVzaDogKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCksCiAgICAgICAgSGlkZTogKCkgPT4geyBsYWIucHJldmlldy5lbmFibGVkID0gZmFsc2U7IGNsZWFyUHJldmlld0xpbmUoKTsgfQogICAgfTsKICAgIHByZXZpZXcuYWRkKHByZXZpZXdCdG5zLCAnUmVmcmVzaCcpOwogICAgcHJldmlldy5hZGQocHJldmlld0J0bnMsICdIaWRlJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFJlY29yZCAvIFJlcGxheQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCByciA9IHJvb3QuYWRkRm9sZGVyKCdSZWNvcmQgLyBSZXBsYXknKTsKICAgIGNvbnN0IHJyUGFyYW1zID0gewogICAgICAgIFJlY29yZDogKCkgPT4gewogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmlzUmVjb3JkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgbGFiLnJlY29yZGluZy5mcmFtZXMgPSBbXTsKICAgICAgICB9LAogICAgICAgIFN0b3A6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlY29yZGluZy5pc1JlY29yZGluZyA9IGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgVXNlUmVjb3JkaW5nRm9yUmVwbGF5OiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuZnJhbWVzID0gKGxhYi5yZWNvcmRpbmcuZnJhbWVzIHx8IFtdKS5zbGljZSgpOwogICAgICAgICAgICBsYWIucmVwbGF5LmlkeCA9IDA7CiAgICAgICAgfSwKICAgICAgICBQbGF5OiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGIgPSBnZXRCYWxsKCk7CiAgICAgICAgICAgIGlmICghYikgcmV0dXJuOwogICAgICAgICAgICBsYWIucmVwbGF5LmlzUmVwbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgbGFiLmlzUmVwbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgbGFiLnRhcmdldEJhbGwgPSBiOwogICAgICAgICAgICBsYWIucmVwbGF5LmlkeCA9IDA7CiAgICAgICAgfSwKICAgICAgICBQYXVzZTogKCkgPT4gewogICAgICAgICAgICBsYWIucmVwbGF5LmlzUmVwbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgQ2xlYXI6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlY29yZGluZy5mcmFtZXMgPSBbXTsKICAgICAgICAgICAgbGFiLnJlcGxheS5mcmFtZXMgPSBbXTsKICAgICAgICAgICAgbGFiLnJlcGxheS5pZHggPSAwOwogICAgICAgICAgICBsYWIucmVwbGF5LmlzUmVwbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgIH0KICAgIH07CiAgICByci5hZGQocnJQYXJhbXMsICdSZWNvcmQnKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1N0b3AnKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1VzZVJlY29yZGluZ0ZvclJlcGxheScpLm5hbWUoJ0NvcHkgUmVjIC0+IFJlcGxheScpOwogICAgcnIuYWRkKGxhYi5yZXBsYXksICdsb29wJykubmFtZSgnTG9vcCcpOwogICAgcnIuYWRkKGxhYi5yZXBsYXksICdzcGVlZCcsIDAuMjUsIDYuMCwgMC4yNSkubmFtZSgnUmVwbGF5IFNwZWVkJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdQbGF5Jyk7CiAgICByci5hZGQocnJQYXJhbXMsICdQYXVzZScpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnQ2xlYXInKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogUHJlc2V0cwogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBwcmVzZXRzID0gcm9vdC5hZGRGb2xkZXIoJ1ByZXNldHMnKTsKICAgIGNvbnN0IFAgPSB7CiAgICAgICAgVmFuaWxsYTogKCkgPT4gewogICAgICAgICAgICBPYmplY3QuYXNzaWduKEMsIHsKICAgICAgICAgICAgICAgIFNVQlNURVBTOiAyLAogICAgICAgICAgICAgICAgU1RPUF9TUEVFRDogMC4wMiwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfTElORUFSOiAwLjE1LAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19RVUFEOiAwLjAwMiwKICAgICAgICAgICAgICAgIFNQSU5fRFJBRzogMC40MCwKICAgICAgICAgICAgICAgIE1BR05VU19FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgTUFHTlVTX0NPRUZGOiAwLjA4LAogICAgICAgICAgICAgICAgTUFHTlVTX0NBUDogNjAuMCwKICAgICAgICAgICAgICAgIERFUFRIX1RBUkdFVF9ZOiAwLjAsCiAgICAgICAgICAgICAgICBERVBUSF9TUFJJTkc6IDEuMCwKICAgICAgICAgICAgICAgIERFUFRIX0RBTVA6IDEuNSwKICAgICAgICAgICAgICAgIEJPVU5EQVJZX1JBRElVUzogMzMuMCwKICAgICAgICAgICAgICAgIEJPVU5EQVJZX0hFSUdIVDogMTUuMCwKICAgICAgICAgICAgICAgIFdBTExfU09GVF9CVUZGRVI6IDMuMCwKICAgICAgICAgICAgICAgIFdBTExfU09GVF9GT1JDRTogMjAuMCwKICAgICAgICAgICAgICAgIFdBTExfRUxBU1RJQ0lUWTogMC4zMCwKICAgICAgICAgICAgICAgIFdBTExfRlJJQ1RJT046IDAuOTUsCiAgICAgICAgICAgICAgICBGTE9PUl9FTEFTVElDSVRZOiAwLjQwLAogICAgICAgICAgICAgICAgR09BTF9QT0NLRVRfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX1g6IDEyLjAsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9aOiAyNS4wLAogICAgICAgICAgICAgICAgR09BTF9QT0NLRVRfUkFESVVTOiA0NS4wLAogICAgICAgICAgICAgICAgTEFVTkNIX1NQRUVEX1NDQUxFOiAxLjAsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfQ0FQOiA4NS4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsYWIucmVmcmVzaFByZXZpZXcoKTsKICAgICAgICB9LAogICAgICAgIEFyY2FkZUN1cnZlOiAoKSA9PiB7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oQywgewogICAgICAgICAgICAgICAgTUFHTlVTX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ09FRkY6IDAuMTYsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ0FQOiA5MC4wLAogICAgICAgICAgICAgICAgU1BJTl9EUkFHOiAwLjI1LAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMTIsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX1FVQUQ6IDAuMDAxLAogICAgICAgICAgICAgICAgV0FMTF9TT0ZUX0ZPUkNFOiAzNS4wLAogICAgICAgICAgICAgICAgTEFVTkNIX1NQRUVEX0NBUDogMTEwLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oVEMsIHsKICAgICAgICAgICAgICAgIENVUlZFX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgICAgICAgICBDVVJWRV9TUElOX1NDQUxFOiAxNTAwLjAsCiAgICAgICAgICAgICAgICBDVVJWRV9TUElOX0NBUDogMzAwMC4wLAogICAgICAgICAgICAgICAgQ1VSVkVfUEVSRkVDVF9TUElOOiA3MDAuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfSwKICAgICAgICBTbmFwcHlSZWFsaXN0aWM6ICgpID0+IHsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihDLCB7CiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX0xJTkVBUjogMC4yNSwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDYsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ09FRkY6IDAuMDUsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ0FQOiA0MC4wLAogICAgICAgICAgICAgICAgU1BJTl9EUkFHOiAwLjc1LAogICAgICAgICAgICAgICAgU1RPUF9TUEVFRDogMC4wNSwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDcwLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0KICAgIH07CiAgICBwcmVzZXRzLmFkZChQLCAnVmFuaWxsYScpOwogICAgcHJlc2V0cy5hZGQoUCwgJ0FyY2FkZUN1cnZlJyk7CiAgICBwcmVzZXRzLmFkZChQLCAnU25hcHB5UmVhbGlzdGljJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFNuYXBzaG90IC8gRXhwb3J0CiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHNuYXBzaG90ID0gcm9vdC5hZGRGb2xkZXIoJ1NuYXBzaG90IC8gRXhwb3J0Jyk7CgogICAgY29uc3QgX3JvdW5kID0gKG4sIHBsYWNlcyA9IDQpID0+IHsKICAgICAgICBpZiAoIU51bWJlci5pc0Zpbml0ZShuKSkgcmV0dXJuIG51bGw7CiAgICAgICAgY29uc3QgcCA9IE1hdGgucG93KDEwLCBwbGFjZXMpOwogICAgICAgIHJldHVybiBNYXRoLnJvdW5kKG4gKiBwKSAvIHA7CiAgICB9OwoKICAgIGNvbnN0IF92MyA9ICh2LCBwbGFjZXMgPSA0KSA9PiB7CiAgICAgICAgaWYgKCF2KSByZXR1cm4gbnVsbDsKICAgICAgICByZXR1cm4gW19yb3VuZCh2LngsIHBsYWNlcyksIF9yb3VuZCh2LnksIHBsYWNlcyksIF9yb3VuZCh2LnosIHBsYWNlcyldOwogICAgfTsKCiAgICBjb25zdCBfY2xvbmVKc29uID0gKG9iaikgPT4gewogICAgICAgIGlmICghb2JqKSByZXR1cm4gbnVsbDsKICAgICAgICB0cnkgeyByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShvYmopKTsgfSBjYXRjaCAoZSkgeyByZXR1cm4gbnVsbDsgfQogICAgfTsKCiAgICBjb25zdCBfcGxheWVyU25hcCA9IChwKSA9PiB7CiAgICAgICAgaWYgKCFwKSByZXR1cm4gbnVsbDsKICAgICAgICBjb25zdCBhbmltID0gKHAuYWN0aXZlQWN0aW9uICYmIHAuYWN0aXZlQWN0aW9uLl9jbGlwKSA/IHAuYWN0aXZlQWN0aW9uLl9jbGlwLm5hbWUgOiAocC5zdGF0ZSB8fCBudWxsKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBuYW1lOiBwLmNoYXJhY3Rlck5hbWUgfHwgcC5uYW1lIHx8IG51bGwsCiAgICAgICAgICAgIHJvbGU6IHAucm9sZSB8fCBudWxsLAogICAgICAgICAgICBzdGF0ZTogcC5zdGF0ZSB8fCBudWxsLAogICAgICAgICAgICBoYXNCYWxsOiAhIXAuaGFzQmFsbCwKICAgICAgICAgICAgaXNUaHJvd2luZzogISFwLmlzVGhyb3dpbmcsCiAgICAgICAgICAgIGlzQ2hhcmdpbmc6ICEhcC5pc0NoYXJnaW5nLAogICAgICAgICAgICBpc0Rhc2hpbmc6ICEhcC5pc0Rhc2hpbmcsCiAgICAgICAgICAgIGRhc2hDb29sZG93bjogX3JvdW5kKHAuZGFzaENvb2xkb3duLCA0KSwKICAgICAgICAgICAgcG9zOiBfdjMocC5tZXNoICYmIHAubWVzaC5wb3NpdGlvbiksCiAgICAgICAgICAgIHZlbDogX3YzKHAudmVsb2NpdHkpLAogICAgICAgICAgICBpbnB1dDogX3YzKHAuaW5wdXRWZWN0b3IpLAogICAgICAgICAgICBzdGF0czogcC5zdGF0cyA/IF9jbG9uZUpzb24ocC5zdGF0cykgOiBudWxsLAogICAgICAgICAgICBhbmltCiAgICAgICAgfTsKICAgIH07CgogICAgY29uc3QgX3RlYW1TbmFwID0gKHQpID0+IHsKICAgICAgICBpZiAoIXQpIHJldHVybiBudWxsOwogICAgICAgIGNvbnN0IGFjdGl2ZSA9IHQuYWN0aXZlUGxheWVyID8gX3BsYXllclNuYXAodC5hY3RpdmVQbGF5ZXIpIDogbnVsbDsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBpZDogdC5pZCB8fCBudWxsLAogICAgICAgICAgICBzaWRlOiB0LnNpZGUsCiAgICAgICAgICAgIGlzSHVtYW46ICEhdC5pc0h1bWFuLAogICAgICAgICAgICBhaUVuYWJsZWQ6ICEhdC5haUVuYWJsZWQsCiAgICAgICAgICAgIGN1cnJlbnRGb3JtYXRpb246IHQuY3VycmVudEZvcm1hdGlvbiB8fCBudWxsLAogICAgICAgICAgICBhY3RpdmVQbGF5ZXI6IGFjdGl2ZSwKICAgICAgICAgICAgcGxheWVyczogQXJyYXkuaXNBcnJheSh0LnBsYXllcnMpID8gdC5wbGF5ZXJzLm1hcChfcGxheWVyU25hcCkgOiBbXQogICAgICAgIH07CiAgICB9OwoKICAgIGNvbnN0IGJ1aWxkU25hcHNob3QgPSAoKSA9PiB7CiAgICAgICAgY29uc3QgZ2FtZSA9IHRoaXMuZ2FtZSB8fCB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgfHwgbnVsbDsKICAgICAgICBjb25zdCBiYWxsID0gZ2FtZSAmJiBnYW1lLmVudGl0aWVzID8gZ2FtZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICBjb25zdCBjYW1NZ3IgPSBnYW1lID8gZ2FtZS5jYW1lcmFNYW5hZ2VyIDogbnVsbDsKICAgICAgICBjb25zdCBjYW0gPSAoY2FtTWdyICYmIGNhbU1nci5jYW1lcmEpID8gY2FtTWdyLmNhbWVyYSA6IChnYW1lID8gZ2FtZS5jYW1lcmEgOiBudWxsKTsKCiAgICAgICAgY29uc3QgYmFsbFNuYXAgPSBiYWxsID8gewogICAgICAgICAgICBzdGF0ZTogYmFsbC5zdGF0ZSB8fCBudWxsLAogICAgICAgICAgICBpc0ludmlzaWJsZTogISFiYWxsLmlzSW52aXNpYmxlLAogICAgICAgICAgICBob2xkZXI6IGJhbGwuaG9sZGVyID8gKGJhbGwuaG9sZGVyLmNoYXJhY3Rlck5hbWUgfHwgYmFsbC5ob2xkZXIubmFtZSB8fCBudWxsKSA6IG51bGwsCiAgICAgICAgICAgIGxhc3RIb2xkZXI6IGJhbGwubGFzdEhvbGRlciA/IChiYWxsLmxhc3RIb2xkZXIuY2hhcmFjdGVyTmFtZSB8fCBiYWxsLmxhc3RIb2xkZXIubmFtZSB8fCBudWxsKSA6IG51bGwsCiAgICAgICAgICAgIHBvczogX3YzKGJhbGwubWVzaCAmJiBiYWxsLm1lc2gucG9zaXRpb24pLAogICAgICAgICAgICB2ZWw6IF92MyhiYWxsLnZlbG9jaXR5KSwKICAgICAgICAgICAgYW5nVmVsOiBfdjMoYmFsbC5hbmd1bGFyVmVsb2NpdHkpLAogICAgICAgICAgICBwb3dlcjogX3JvdW5kKGJhbGwucG93ZXIsIDQpLAogICAgICAgICAgICBzaG90VHlwZTogYmFsbC5zaG90VHlwZSB8fCBudWxsCiAgICAgICAgfSA6IG51bGw7CgogICAgICAgIGNvbnN0IGNhbWVyYVNuYXAgPSBjYW0gPyB7CiAgICAgICAgICAgIHBvczogX3YzKGNhbS5wb3NpdGlvbiksCiAgICAgICAgICAgIHJvdDogY2FtLnJvdGF0aW9uID8gW19yb3VuZChjYW0ucm90YXRpb24ueCwgNCksIF9yb3VuZChjYW0ucm90YXRpb24ueSwgNCksIF9yb3VuZChjYW0ucm90YXRpb24ueiwgNCldIDogbnVsbCwKICAgICAgICAgICAgZm92OiBfcm91bmQoY2FtLmZvdiwgNCksCiAgICAgICAgICAgIG5lYXI6IF9yb3VuZChjYW0ubmVhciwgNiksCiAgICAgICAgICAgIGZhcjogX3JvdW5kKGNhbS5mYXIsIDQpCiAgICAgICAgfSA6IG51bGw7CgogICAgICAgIGNvbnN0IGNhbU1nclNuYXAgPSBjYW1NZ3IgPyB7CiAgICAgICAgICAgIG1vZGU6IGNhbU1nci5tb2RlIHx8IG51bGwsCiAgICAgICAgICAgIHRhcmdldE5hbWU6IChjYW1NZ3IudGFyZ2V0ICYmIChjYW1NZ3IudGFyZ2V0LmNoYXJhY3Rlck5hbWUgfHwgY2FtTWdyLnRhcmdldC5uYW1lKSkgfHwgbnVsbCwKICAgICAgICAgICAgc2V0dGluZ3M6IGNhbU1nci5zZXR0aW5ncyA/IF9jbG9uZUpzb24oY2FtTWdyLnNldHRpbmdzKSA6IG51bGwKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgY29uc3QgZGVidWdJTyA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPID8gd2luZG93LmZsdXguX2RlYnVnSU8gOiBudWxsOwogICAgICAgIGNvbnN0IGlucHV0U25hcCA9IGRlYnVnSU8gPyB7CiAgICAgICAgICAgIHNldHRpbmdzOiBkZWJ1Z0lPLnNldHRpbmdzID8gX2Nsb25lSnNvbihkZWJ1Z0lPLnNldHRpbmdzKSA6IG51bGwsCiAgICAgICAgICAgIHBlcmY6IGRlYnVnSU8ucGVyZiA/IF9jbG9uZUpzb24oZGVidWdJTy5wZXJmKSA6IG51bGwsCiAgICAgICAgICAgIG1vdmU6IChkZWJ1Z0lPLmlucHV0ICYmIGRlYnVnSU8uaW5wdXQubW92ZSkgPyB7CiAgICAgICAgICAgICAgICB0b3VjaElkOiBkZWJ1Z0lPLmlucHV0Lm1vdmUudG91Y2hJZCA/PyBudWxsLAogICAgICAgICAgICAgICAgZHJhZ2dpbmc6ICEhZGVidWdJTy5pbnB1dC5tb3ZlLmRyYWdnaW5nLAogICAgICAgICAgICAgICAgdmVjdG9yOiBkZWJ1Z0lPLmlucHV0Lm1vdmUudmVjdG9yID8gX2Nsb25lSnNvbihkZWJ1Z0lPLmlucHV0Lm1vdmUudmVjdG9yKSA6IG51bGwKICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgIGFpbTogKGRlYnVnSU8uaW5wdXQgJiYgZGVidWdJTy5pbnB1dC5haW0pID8gewogICAgICAgICAgICAgICAgdG91Y2hJZDogZGVidWdJTy5pbnB1dC5haW0udG91Y2hJZCA/PyBudWxsLAogICAgICAgICAgICAgICAgZHJhZ2dpbmc6ICEhZGVidWdJTy5pbnB1dC5haW0uZHJhZ2dpbmcsCiAgICAgICAgICAgICAgICB2ZWN0b3I6IGRlYnVnSU8uaW5wdXQuYWltLnZlY3RvciA/IF9jbG9uZUpzb24oZGVidWdJTy5pbnB1dC5haW0udmVjdG9yKSA6IG51bGwKICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgIHN3aXBlOiAoZGVidWdJTy5pbnB1dCAmJiBkZWJ1Z0lPLmlucHV0LnN3aXBlKSA/IHsKICAgICAgICAgICAgICAgIHRvdWNoSWQ6IGRlYnVnSU8uaW5wdXQuc3dpcGUudG91Y2hJZCA/PyBudWxsLAogICAgICAgICAgICAgICAgc3RhcnQ6IGRlYnVnSU8uaW5wdXQuc3dpcGUuc3RhcnQgPyBfY2xvbmVKc29uKGRlYnVnSU8uaW5wdXQuc3dpcGUuc3RhcnQpIDogbnVsbCwKICAgICAgICAgICAgICAgIHBvaW50czogQXJyYXkuaXNBcnJheShkZWJ1Z0lPLmlucHV0LnN3aXBlLnBvaW50cykgPyBkZWJ1Z0lPLmlucHV0LnN3aXBlLnBvaW50cy5zbGljZSgtMzIpLm1hcChfY2xvbmVKc29uKSA6IFtdCiAgICAgICAgICAgIH0gOiBudWxsCiAgICAgICAgfSA6IG51bGw7CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG1ldGE6IHsKICAgICAgICAgICAgICAgIHRpbWVzdGFtcElTTzogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLAogICAgICAgICAgICAgICAgaHJlZjogKHR5cGVvZiBsb2NhdGlvbiAhPT0gJ3VuZGVmaW5lZCcgJiYgbG9jYXRpb24uaHJlZikgPyBsb2NhdGlvbi5ocmVmIDogbnVsbCwKICAgICAgICAgICAgICAgIHVzZXJBZ2VudDogKHR5cGVvZiBuYXZpZ2F0b3IgIT09ICd1bmRlZmluZWQnICYmIG5hdmlnYXRvci51c2VyQWdlbnQpID8gbmF2aWdhdG9yLnVzZXJBZ2VudCA6IG51bGwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2FtZTogZ2FtZSA/IHsKICAgICAgICAgICAgICAgIHNjb3JlOiBnYW1lLnNjb3JlID8gX2Nsb25lSnNvbihnYW1lLnNjb3JlKSA6IG51bGwsCiAgICAgICAgICAgICAgICB0aW1lOiBfcm91bmQoZ2FtZS50aW1lLCA0KSwKICAgICAgICAgICAgICAgIGhhbGY6IGdhbWUuaGFsZiA/PyBudWxsLAogICAgICAgICAgICAgICAgaGFsZkR1cmF0aW9uOiBfcm91bmQoZ2FtZS5oYWxmRHVyYXRpb24sIDQpLAogICAgICAgICAgICAgICAgaXNPdmVydGltZTogISFnYW1lLmlzT3ZlcnRpbWUsCiAgICAgICAgICAgICAgICBpc0RlbW9Nb2RlOiAhIWdhbWUuaXNEZW1vTW9kZQogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgY29uZmlnOiB7CiAgICAgICAgICAgICAgICBCYWxsQ29uZmlnOiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguQmFsbENvbmZpZykgPyBfY2xvbmVKc29uKHdpbmRvdy5mbHV4LkJhbGxDb25maWcpIDogbnVsbCwKICAgICAgICAgICAgICAgIFRocm93Q29uZmlnOiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguVGhyb3dDb25maWcpID8gX2Nsb25lSnNvbih3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZykgOiBudWxsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNhbWVyYTogY2FtZXJhU25hcCwKICAgICAgICAgICAgY2FtZXJhTWFuYWdlcjogY2FtTWdyU25hcCwKICAgICAgICAgICAgYmFsbDogYmFsbFNuYXAsCiAgICAgICAgICAgIHRlYW1zOiBnYW1lID8gewogICAgICAgICAgICAgICAgaG9tZTogX3RlYW1TbmFwKGdhbWUudGVhbXMgJiYgZ2FtZS50ZWFtcy5ob21lKSwKICAgICAgICAgICAgICAgIGF3YXk6IF90ZWFtU25hcChnYW1lLnRlYW1zICYmIGdhbWUudGVhbXMuYXdheSkKICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgIGlucHV0OiBpbnB1dFNuYXAKICAgICAgICB9OwogICAgfTsKCiAgICBjb25zdCBfY29weVRleHQgPSBhc3luYyAodGV4dCkgPT4gewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChuYXZpZ2F0b3IuY2xpcGJvYXJkICYmIG5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KSB7CiAgICAgICAgICAgICAgICBhd2FpdCBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dCh0ZXh0KTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAvLyBGYWxsYmFjawogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IHRhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGV4dGFyZWEnKTsKICAgICAgICAgICAgdGEudmFsdWUgPSB0ZXh0OwogICAgICAgICAgICB0YS5zdHlsZS5wb3NpdGlvbiA9ICdmaXhlZCc7CiAgICAgICAgICAgIHRhLnN0eWxlLmxlZnQgPSAnLTk5OTlweCc7CiAgICAgICAgICAgIHRhLnN0eWxlLnRvcCA9ICctOTk5OXB4JzsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0YSk7CiAgICAgICAgICAgIHRhLmZvY3VzKCk7CiAgICAgICAgICAgIHRhLnNlbGVjdCgpOwogICAgICAgICAgICBjb25zdCBvayA9IGRvY3VtZW50LmV4ZWNDb21tYW5kKCdjb3B5Jyk7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGEpOwogICAgICAgICAgICByZXR1cm4gb2s7CiAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwoKICAgIGNvbnN0IF9kb3dubG9hZFRleHQgPSAoZmlsZW5hbWUsIHRleHQpID0+IHsKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCBibG9iID0gbmV3IEJsb2IoW3RleHRdLCB7IHR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJyB9KTsKICAgICAgICAgICAgY29uc3QgdXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTsKICAgICAgICAgICAgY29uc3QgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICAgICAgYS5ocmVmID0gdXJsOwogICAgICAgICAgICBhLmRvd25sb2FkID0gZmlsZW5hbWU7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoYSk7CiAgICAgICAgICAgIGEuY2xpY2soKTsKICAgICAgICAgICAgYS5yZW1vdmUoKTsKICAgICAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTCh1cmwpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdTbmFwc2hvdCBkb3dubG9hZCBmYWlsZWQ6JywgZSk7CiAgICAgICAgfQogICAgfTsKCiAgICBjb25zdCBzbmFwc2hvdEFjdGlvbnMgPSB7CiAgICAgICAgQ29weVNuYXBzaG90OiBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNuYXAgPSBidWlsZFNuYXBzaG90KCk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnN0cmluZ2lmeShzbmFwLCBudWxsLCAyKTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBhd2FpdCBfY29weVRleHQodGV4dCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbU25hcHNob3RdJywgc25hcCk7CiAgICAgICAgICAgIGlmICghb2spIGNvbnNvbGUud2FybignU25hcHNob3Q6IGNvcHkgZmFpbGVkIChzZWUgY29uc29sZSkuJyk7CiAgICAgICAgfSwKICAgICAgICBEb3dubG9hZFNuYXBzaG90OiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNuYXAgPSBidWlsZFNuYXBzaG90KCk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnN0cmluZ2lmeShzbmFwLCBudWxsLCAyKTsKICAgICAgICAgICAgX2Rvd25sb2FkVGV4dCgnc25hcHNob3QuanNvbicsIHRleHQpOwogICAgICAgICAgICBjb25zb2xlLmxvZygnW1NuYXBzaG90XScsIHNuYXApOwogICAgICAgIH0KICAgIH07CgogICAgc25hcHNob3QuYWRkKHNuYXBzaG90QWN0aW9ucywgJ0NvcHlTbmFwc2hvdCcpLm5hbWUoJ0NvcHkgSlNPTiBTbmFwc2hvdCcpOwogICAgc25hcHNob3QuYWRkKHNuYXBzaG90QWN0aW9ucywgJ0Rvd25sb2FkU25hcHNob3QnKS5uYW1lKCdEb3dubG9hZCBzbmFwc2hvdC5qc29uJyk7Cgp9CiAgICB9Cgp3aW5kb3cuZmx1eC5EZXZUb29scyA9IERldlRvb2xzOwoKICAgIERldlRvb2xzLnByb3RvdHlwZS5fc2V0dXBWaXN1YWxEZWJ1ZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignVmlzdWFsIERlYnVnZ2luZycpOwogICAgICAgIGNvbnN0IGR2ID0gdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcjsKICAgICAgICBpZiAoIWR2KSByZXR1cm47CgogICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgZW5hYmxlZDogZHYuZW5hYmxlZCwKICAgICAgICAgICAgaGl0Ym94ZXM6IGR2LnNob3dIaXRib3hlcywKICAgICAgICAgICAgdmVjdG9yczogZHYuc2hvd1ZlY3RvcnMsCiAgICAgICAgICAgIGFpOiBkdi5zaG93QUkKICAgICAgICB9OwoKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2VuYWJsZWQnKS5uYW1lKCdFbmFibGUgVmlzdWFsaXplcicpLm9uQ2hhbmdlKHYgPT4gZHYuZW5hYmxlZCA9IHYpOwogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnaGl0Ym94ZXMnKS5uYW1lKCdTaG93IEhpdGJveGVzJykub25DaGFuZ2UodiA9PiBkdi5zaG93SGl0Ym94ZXMgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3ZlY3RvcnMnKS5uYW1lKCdTaG93IFZlY3RvcnMnKS5vbkNoYW5nZSh2ID0+IGR2LnNob3dWZWN0b3JzID0gdik7CiAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhaScpLm5hbWUoJ1Nob3cgQUkgUGVyY2VwdGlvbicpLm9uQ2hhbmdlKHYgPT4gZHYuc2hvd0FJID0gdik7CiAgICB9OwoKICAgIERldlRvb2xzLnByb3RvdHlwZS5fc2V0dXBGWExhYiA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignRlggTGFiICYgVUkgVGVzdCcpOwogICAgICAgIAogICAgICAgIGNvbnN0IGdldFRhcmdldFBvcyA9ICgpID0+IHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgcmV0dXJuIHAgJiYgcC5tZXNoID8gcC5tZXNoLnBvc2l0aW9uIDogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMiwgMCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgZnhQYXJhbXMgPSB7CiAgICAgICAgICAgIFNwYXduVmVub206ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Zlbm9tJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bk5hcDogKCkgPT4gdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignbmFwJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bldpdGhlcjogKCkgPT4gdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignd2l0aGVyJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bkxlYXJuZWQ6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2xlYXJuZWQnLCBnZXRUYXJnZXRQb3MoKSksCiAgICAgICAgICAgIFNwYXduQ2xhc2g6ICgpID0+IHRoaXMuZ2FtZS5zcGF3bkNsYXNoKGdldFRhcmdldFBvcygpKSwKICAgICAgICB9OwoKICAgICAgICBjb25zdCBmeFN1YiA9IGZvbGRlci5hZGRGb2xkZXIoJ1BhcnRpY2xlcycpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduVmVub20nKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3bk5hcCcpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduV2l0aGVyJyk7CiAgICAgICAgZnhTdWIuYWRkKGZ4UGFyYW1zLCAnU3Bhd25MZWFybmVkJyk7CiAgICAgICAgZnhTdWIuYWRkKGZ4UGFyYW1zLCAnU3Bhd25DbGFzaCcpOwoKICAgICAgICBjb25zdCB0eHRQYXJhbXMgPSB7CiAgICAgICAgICAgIFRleHQ6ICJURVNUIiwKICAgICAgICAgICAgVHlwZTogImRhbWFnZSIsCiAgICAgICAgICAgIFNwYXduOiAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZih0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSAKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKHR4dFBhcmFtcy5UZXh0LCBnZXRUYXJnZXRQb3MoKSwgdHh0UGFyYW1zLlR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICAKICAgICAgICBjb25zdCB0eHRTdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdGbG9hdGluZyBUZXh0Jyk7CiAgICAgICAgdHh0U3ViLmFkZCh0eHRQYXJhbXMsICdUZXh0Jyk7CiAgICAgICAgdHh0U3ViLmFkZCh0eHRQYXJhbXMsICdUeXBlJywgWydkYW1hZ2UnLCAnaGVhbCcsICdzdGF0dXMnLCAndGVjaCcsICdjb21pYy1pbXBhY3QnLCAnY29taWMtYWN0aW9uJywgJ3NhdmUnLCAnYmxvY2snLCAnZGVmYXVsdCddKTsKICAgICAgICB0eHRTdWIuYWRkKHR4dFBhcmFtcywgJ1NwYXduJykubmFtZSgnU3Bhd24gVGV4dCcpOwoKICAgICAgICBjb25zdCBjYW1QYXJhbXMgPSB7CiAgICAgICAgICAgIFNoYWtlU21hbGw6ICgpID0+IHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuNSksCiAgICAgICAgICAgIFNoYWtlQmlnOiAoKSA9PiB0aGlzLmdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgyLjApLAogICAgICAgICAgICBJbXBhY3RMaWdodDogKCkgPT4gdGhpcy5nYW1lLnRyaWdnZXJJbXBhY3QoMC4xLCAnZGVmYXVsdCcpLAogICAgICAgICAgICBJbXBhY3RIZWF2eTogKCkgPT4gdGhpcy5nYW1lLnRyaWdnZXJJbXBhY3QoMC4yLCAnaGVhdnknKSwKICAgICAgICAgICAgSW1wYWN0U2hhdHRlcjogKCkgPT4gdGhpcy5nYW1lLnRyaWdnZXJJbXBhY3QoMC40LCAnc2hhdHRlcicpLAogICAgICAgIH07CgogICAgICAgIGNvbnN0IGNhbVN1YiA9IGZvbGRlci5hZGRGb2xkZXIoJ0NhbWVyYSAmIEltcGFjdCcpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnU2hha2VTbWFsbCcpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnU2hha2VCaWcnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ0ltcGFjdExpZ2h0Jyk7CiAgICAgICAgY2FtU3ViLmFkZChjYW1QYXJhbXMsICdJbXBhY3RIZWF2eScpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnSW1wYWN0U2hhdHRlcicpOwogICAgfTsKCgpEZXZUb29scy5wcm90b3R5cGUuX3NldHVwVmlzdWFscyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignQXNzZXQgRm9yZ2UnKTsKICAgICAgICAKICAgICAgICBjb25zdCBmb3JnZVN0YXRlID0gewogICAgICAgICAgICBhY3RpdmU6IGZhbHNlLAogICAgICAgICAgICBhc3NldE5hbWU6ICdUaWR1cycsCiAgICAgICAgICAgIGFuaW1OYW1lOiAnaWRsZScsCiAgICAgICAgICAgIHBvc1g6IDAsIHBvc1k6IDAsIHBvc1o6IDAsCiAgICAgICAgICAgIHJvdFg6IDAsIHJvdFk6IDAsIHJvdFo6IDAsCiAgICAgICAgICAgIHNjYWxlOiAxLjAsCiAgICAgICAgICAgIGNhbURpc3Q6IDUsIGNhbUhlaWdodDogMS41LCBjYW1Sb3Q6IDAKICAgICAgICB9OwoKICAgICAgICBjb25zdCBhc3NldHMgPSB7CiAgICAgICAgICAgICdUaWR1cyc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZGE3ODhiZWYyNThjNGYwYjhkOWVmMWFjYzE5YzU1NjcuZ2xiJywKICAgICAgICAgICAgJ1dha2thJzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy81OTExNGM5ODk1MTY0N2M5YjhkYTc0YjBiZDM2MzZjYi5nbGInLAogICAgICAgICAgICAnTGV0dHknOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzLzQzYWNlMzRjNmZkOTQyMTU5NjdlODQyYmY5MDlkYTVlLmdsYicsCiAgICAgICAgICAgICdEYXR0byc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZTZkNjdlY2IyZTRjNDcxNWJkNzNhNDA3OTVlMWQzZDUuZ2xiJywKICAgICAgICAgICAgJ0phc3N1JzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy84MjE2NDU5NTY3MzU0ZTYzOTU4ZDQxMDhkODI4ZGU5OC5nbGInLAogICAgICAgICAgICAnQm90dGEnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2FkMTU1ZWZlZGMwZDQ4ZmRhZDA5ZGEzZTFjYWU5Yzk3LmdsYicsCiAgICAgICAgICAgICdCYWxsJzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy81MjFhZTg3ODhlNTg0ZTM3OGE3OWQ5NzMyYTA3NTM1Ni5nbGInLAogICAgICAgICAgICAnR29hbCc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvYTUxNmJkOTBmYTdjNGRlZGI1ZGNiZmRmODAzZjEzZDUuZ2xiJwogICAgICAgIH07CgogICAgICAgIGxldCBjdXJyZW50QXNzZXQgPSBudWxsOwoKICAgICAgICBjb25zdCB1cGRhdGVUcmFuc2Zvcm0gPSAoKSA9PiB7CiAgICAgICAgICAgIGlmIChjdXJyZW50QXNzZXQpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRBc3NldC5wb3NpdGlvbi5zZXQoZm9yZ2VTdGF0ZS5wb3NYLCBmb3JnZVN0YXRlLnBvc1ksIGZvcmdlU3RhdGUucG9zWik7CiAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQucm90YXRpb24uc2V0KGZvcmdlU3RhdGUucm90WCwgZm9yZ2VTdGF0ZS5yb3RZLCBmb3JnZVN0YXRlLnJvdFopOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0LnNjYWxlLnNldFNjYWxhcihmb3JnZVN0YXRlLnNjYWxlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGNvbnN0IHVwZGF0ZUNhbWVyYSA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCFmb3JnZVN0YXRlLmFjdGl2ZSkgcmV0dXJuOwogICAgICAgICAgICAvLyBPcmJpdCBhcm91bmQgKDEwMDAsIFksIDEwMDApCiAgICAgICAgICAgIGNvbnN0IGN4ID0gMTAwMCArIE1hdGguc2luKGZvcmdlU3RhdGUuY2FtUm90KSAqIGZvcmdlU3RhdGUuY2FtRGlzdDsKICAgICAgICAgICAgY29uc3QgY3ogPSAxMDAwICsgTWF0aC5jb3MoZm9yZ2VTdGF0ZS5jYW1Sb3QpICogZm9yZ2VTdGF0ZS5jYW1EaXN0OwogICAgICAgICAgICB0aGlzLmdhbWUuY2FtZXJhLnBvc2l0aW9uLnNldChjeCwgZm9yZ2VTdGF0ZS5jYW1IZWlnaHQsIGN6KTsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhbWVyYS5sb29rQXQoMTAwMCwgZm9yZ2VTdGF0ZS5wb3NZICsgMSwgMTAwMCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgcGxheUFuaW1hdGlvbiA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aGlzLnZpek1peGVyIHx8ICF0aGlzLnZpekNsaXBzKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudml6TWl4ZXIuc3RvcEFsbEFjdGlvbigpOwogICAgICAgICAgICBpZiAoZm9yZ2VTdGF0ZS5hbmltTmFtZSA9PT0gJ25vbmUnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgY2xpcCA9IHRoaXMudml6Q2xpcHMuZmluZChjID0+IGMubmFtZSA9PT0gZm9yZ2VTdGF0ZS5hbmltTmFtZSk7CiAgICAgICAgICAgIGlmICghY2xpcCkgY2xpcCA9IHRoaXMudml6Q2xpcHMuZmluZChjID0+IGMubmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKGZvcmdlU3RhdGUuYW5pbU5hbWUudG9Mb3dlckNhc2UoKSkpOwogICAgICAgICAgICBpZiAoY2xpcCkgdGhpcy52aXpNaXhlci5jbGlwQWN0aW9uKGNsaXApLnBsYXkoKTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBzcGF3bkFzc2V0ID0gKCkgPT4gewogICAgICAgICAgICBpZiAoIXRoaXMudml6R3JvdXApIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENsZWFyIHByZXZpb3VzCiAgICAgICAgICAgIHdoaWxlKHRoaXMudml6R3JvdXAuY2hpbGRyZW4ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgY2hpbGQgPSB0aGlzLnZpekdyb3VwLmNoaWxkcmVuWzBdOwogICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cC5yZW1vdmUoY2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnZpek1peGVyID0gbnVsbDsKICAgICAgICAgICAgY3VycmVudEFzc2V0ID0gbnVsbDsKCiAgICAgICAgICAgIGNvbnN0IHVybCA9IGFzc2V0c1tmb3JnZVN0YXRlLmFzc2V0TmFtZV07CiAgICAgICAgICAgIGlmICghdXJsKSByZXR1cm47CgogICAgICAgICAgICBjb25zb2xlLmxvZygiRm9yZ2U6IFNwYXduaW5nIiwgZm9yZ2VTdGF0ZS5hc3NldE5hbWUpOwoKICAgICAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKHVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHdlIGFyZSBzdGlsbCBpbiBmb3JnZSBtb2RlIGJlZm9yZSBhZGRpbmcKICAgICAgICAgICAgICAgIGlmICghZm9yZ2VTdGF0ZS5hY3RpdmUpIHJldHVybjsKCiAgICAgICAgICAgICAgICBjb25zdCBtb2RlbCA9IGdsdGYuc2NlbmU7CiAgICAgICAgICAgICAgICB0aGlzLnZpekdyb3VwLmFkZChtb2RlbCk7CiAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQgPSBtb2RlbDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVzZXQgbW9kZWwgdHJhbnNmb3JtIHJlbGF0aXZlIHRvIGdyb3VwCiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgbW9kZWwucm90YXRpb24uc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdXBkYXRlVHJhbnNmb3JtKCk7CgogICAgICAgICAgICAgICAgaWYgKGdsdGYuYW5pbWF0aW9ucyAmJiBnbHRmLmFuaW1hdGlvbnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudml6TWl4ZXIgPSBuZXcgVEhSRUUuQW5pbWF0aW9uTWl4ZXIobW9kZWwpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudml6Q2xpcHMgPSBnbHRmLmFuaW1hdGlvbnM7CiAgICAgICAgICAgICAgICAgICAgcGxheUFuaW1hdGlvbigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCB0b2dnbGVGb3JnZSA9IChpc0FjdGl2ZSkgPT4gewogICAgICAgICAgICBmb3JnZVN0YXRlLmFjdGl2ZSA9IGlzQWN0aXZlOwogICAgICAgICAgICB0aGlzLmdhbWUuaXNGb3JnZU1vZGUgPSBpc0FjdGl2ZTsgLy8gQ3JpdGljYWw6IFRlbGwgbWFpbi5qcyB0byBzdG9wIGdhbWUgbG9vcAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVG9nZ2xlIEdhbWUgVmlzaWJpbGl0eSAoSGlkZSBldmVyeXRoaW5nIGluIHRoZSBtYWluIGFyZW5hKQogICAgICAgICAgICBjb25zdCBnYW1lTGF5ZXIgPSBbdGhpcy5nYW1lLnRlYW1zLmhvbWUsIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LCB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbF07CiAgICAgICAgICAgIGdhbWVMYXllci5mb3JFYWNoKHQgPT4gewogICAgICAgICAgICAgICAgaWYodCAmJiB0LnBsYXllcnMpIHQucGxheWVycy5mb3JFYWNoKHAgPT4geyBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gIWlzQWN0aXZlOyB9KTsKICAgICAgICAgICAgICAgIGVsc2UgaWYodCAmJiB0Lm1lc2gpIHQubWVzaC52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYod2luZG93LmZsdXguYXJlbmFNZXNoKSB3aW5kb3cuZmx1eC5hcmVuYU1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYod2luZG93LmZsdXguYXJlbmFNZXNoMikgd2luZG93LmZsdXguYXJlbmFNZXNoMi52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICBpZih0aGlzLmdhbWUuc3RhZGl1bSAmJiB0aGlzLmdhbWUuc3RhZGl1bS5jb250YWluZXIpIHRoaXMuZ2FtZS5zdGFkaXVtLmNvbnRhaW5lci52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICBpZih0aGlzLmdhbWUud2F0ZXJPdmVybGF5ICYmIHRoaXMuZ2FtZS53YXRlck92ZXJsYXkubWVzaCkgdGhpcy5nYW1lLndhdGVyT3ZlcmxheS5tZXNoLnZpc2libGUgPSAhaXNBY3RpdmU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIaWRlIFVJCiAgICAgICAgICAgIGNvbnN0IHVpID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJyk7CiAgICAgICAgICAgIGlmKHVpKSB1aS5zdHlsZS5kaXNwbGF5ID0gaXNBY3RpdmUgPyAnbm9uZScgOiAnZmxleCc7CgogICAgICAgICAgICBpZiAoaXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgIC8vIEluaXRpYWxpemUgRm9yZ2UgU2NlbmUgaWYgbmVlZGVkCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMudml6R3JvdXBQYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekdyb3VwUGFyZW50ID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZCh0aGlzLnZpekdyb3VwUGFyZW50KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekdyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cC5wb3NpdGlvbi5zZXQoMTAwMCwgMCwgMTAwMCk7IC8vIEZhciBhd2F5IGZyb20gYXJlbmEKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekdyb3VwUGFyZW50LmFkZCh0aGlzLnZpekdyb3VwKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ3JpZCA9IG5ldyBUSFJFRS5HcmlkSGVscGVyKDIwLCAyMCwgMHgwMGZmZmYsIDB4NDQ0NDQ0KTsKICAgICAgICAgICAgICAgICAgICBncmlkLnBvc2l0aW9uLnNldCgxMDAwLCAwLCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekdyb3VwUGFyZW50LmFkZChncmlkKTsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpMaWdodCA9IG5ldyBUSFJFRS5EaXJlY3Rpb25hbExpZ2h0KDB4ZmZmZmZmLCAxLjApOwogICAgICAgICAgICAgICAgICAgIHRoaXMudml6TGlnaHQucG9zaXRpb24uc2V0KDEwMDUsIDEwLCAxMDA1KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKHRoaXMudml6TGlnaHQpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMudml6QW1iaWVudCA9IG5ldyBUSFJFRS5BbWJpZW50TGlnaHQoMHg0MDQwNDApOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy52aXpBbWJpZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudml6TGlnaHQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnZpekFtYmllbnQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNwYXduQXNzZXQoKTsKICAgICAgICAgICAgICAgIHVwZGF0ZUNhbWVyYSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBSZXN0b3JlIEdhbWUKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZpekdyb3VwUGFyZW50KSB0aGlzLnZpekdyb3VwUGFyZW50LnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZpekxpZ2h0KSB0aGlzLnZpekxpZ2h0LnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZpekFtYmllbnQpIHRoaXMudml6QW1iaWVudC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNuYXAgY2FtZXJhIGJhY2sgdG8gZ2FtZSB0YXJnZXQKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FtZXJhTWFuYWdlcikgdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmb2xkZXIuYWRkKGZvcmdlU3RhdGUsICdhY3RpdmUnKS5uYW1lKCdFbmFibGUgRm9yZ2UnKS5vbkNoYW5nZSh0b2dnbGVGb3JnZSk7CiAgICAgICAgZm9sZGVyLmFkZChmb3JnZVN0YXRlLCAnYXNzZXROYW1lJywgT2JqZWN0LmtleXMoYXNzZXRzKSkubmFtZSgnU2VsZWN0IEFzc2V0Jykub25DaGFuZ2Uoc3Bhd25Bc3NldCk7CiAgICAgICAgCiAgICAgICAgY29uc3QgdGYgPSBmb2xkZXIuYWRkRm9sZGVyKCdUcmFuc2Zvcm0nKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3Bvc1gnLCAtNSwgNSkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3Bvc1knLCAtNSwgNSkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3Bvc1onLCAtNSwgNSkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3JvdFgnLCAwLCA2LjI4KS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwogICAgICAgIHRmLmFkZChmb3JnZVN0YXRlLCAncm90WScsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdyb3RaJywgMCwgNi4yOCkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3NjYWxlJywgMC4xLCAzLjApLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CgogICAgICAgIGZvbGRlci5hZGQoZm9yZ2VTdGF0ZSwgJ2FuaW1OYW1lJywgWydub25lJywgJ2lkbGUnLCAnc3dpbScsICd0aHJvdycsICdjYXRjaCcsICdyZWFjdCddKS5uYW1lKCdBbmltYXRpb24nKS5vbkNoYW5nZShwbGF5QW5pbWF0aW9uKTsKCiAgICAgICAgY29uc3QgY2YgPSBmb2xkZXIuYWRkRm9sZGVyKCdDYW1lcmEnKTsKICAgICAgICBjZi5hZGQoZm9yZ2VTdGF0ZSwgJ2NhbURpc3QnLCAyLCAxNSkub25DaGFuZ2UodXBkYXRlQ2FtZXJhKTsKICAgICAgICBjZi5hZGQoZm9yZ2VTdGF0ZSwgJ2NhbUhlaWdodCcsIDAsIDEwKS5vbkNoYW5nZSh1cGRhdGVDYW1lcmEpOwogICAgICAgIGNmLmFkZChmb3JnZVN0YXRlLCAnY2FtUm90JywgMCwgNi4yOCkub25DaGFuZ2UodXBkYXRlQ2FtZXJhKTsKCiAgICAgICAgLy8gSG9vayBHYW1lIExvb3AKICAgICAgICBjb25zdCBvcmlnaW5hbFVwZGF0ZSA9IHRoaXMuZ2FtZS51cGRhdGUuYmluZCh0aGlzLmdhbWUpOwogICAgICAgIHRoaXMuZ2FtZS51cGRhdGUgPSAoZHQpID0+IHsKICAgICAgICAgICAgaWYgKGZvcmdlU3RhdGUuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBGb3JnZSBNb2RlOiBPbmx5IHVwZGF0ZSBmb3JnZSBjb21wb25lbnRzIGFuZCByZW5kZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZpek1peGVyKSB0aGlzLnZpek1peGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZvcmNlIENhbWVyYSBVcGRhdGUgaGVyZSBzaW5jZSBtYWluLmpzIGxvb3AgaXMgc2tpcHBlZAogICAgICAgICAgICAgICAgdXBkYXRlQ2FtZXJhKCk7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5yZW5kZXJlciAmJiB0aGlzLmdhbWUuc2NlbmUgJiYgdGhpcy5nYW1lLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5yZW5kZXJlci5yZW5kZXIodGhpcy5nYW1lLnNjZW5lLCB0aGlzLmdhbWUuY2FtZXJhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE5vcm1hbCBNb2RlOiBSdW4gc3RhbmRhcmQgZ2FtZSB1cGRhdGUKICAgICAgICAgICAgICAgIG9yaWdpbmFsVXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9Owp9KSgpOw==","./DevTools.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFRvb2x0aXAgRGVzY3JpcHRpb25zIGZvciBMb25nLVByZXNzCiAgICBjb25zdCBUT09MVElQX0RFU0NSSVBUSU9OUyA9IHsKICAgICAgICAnU1VCU1RFUFMnOiAiUGh5c2ljcyBpdGVyYXRpb25zIHBlciBmcmFtZS4gSGlnaGVyID0gbW9yZSBzdGFibGUsIG1vcmUgQ1BVLiIsCiAgICAgICAgJ1NUT1BfU1BFRUQnOiAiVmVsb2NpdHkgdGhyZXNob2xkIGJlbG93IHdoaWNoIHRoZSBiYWxsIHNuYXBzIHRvIGEgaGFsdC4iLAogICAgICAgICdXQVRFUl9EUkFHX0xJTkVBUic6ICJCYXNlIHdhdGVyIHJlc2lzdGFuY2UuIFNsb3dzIGJhbGwgbGluZWFybHkuIiwKICAgICAgICAnV0FURVJfRFJBR19RVUFEJzogIlF1YWRyYXRpYyBkcmFnLiBTbG93cyBoaWdoLXNwZWVkIGJhbGxzIHNpZ25pZmljYW50bHkuIiwKICAgICAgICAnU1BJTl9EUkFHJzogIkhvdyBmYXN0IHRoZSBiYWxsJ3Mgc3BpbiBkZWNheXMgb3ZlciB0aW1lLiIsCiAgICAgICAgJ01BR05VU19FTkFCTEVEJzogIkVuYWJsZXMgdGhlIE1hZ251cyBlZmZlY3QgKGN1cnZlIGZyb20gc3BpbikuIiwKICAgICAgICAnTUFHTlVTX0NPRUZGJzogIlN0cmVuZ3RoIG9mIHRoZSBjdXJ2ZSBmb3JjZSByZWxhdGl2ZSB0byBzcGluL3NwZWVkLiIsCiAgICAgICAgJ01BR05VU19DQVAnOiAiTWF4aW11bSBjdXJ2ZSBmb3JjZSBhbGxvd2VkIChwcmV2ZW50cyBwaHlzaWNzIGV4cGxvc2lvbnMpLiIsCiAgICAgICAgJ0RFUFRIX1RBUkdFVF9ZJzogIklkZWFsIFkgaGVpZ2h0IHRoZSBiYWxsIHRyaWVzIHRvIGZsb2F0IGF0LiIsCiAgICAgICAgJ0RFUFRIX1NQUklORyc6ICJTdHJlbmd0aCBvZiB0aGUgZm9yY2UgcHVsbGluZyBiYWxsIHRvIFRhcmdldCBZLiIsCiAgICAgICAgJ0RFUFRIX0RBTVAnOiAiRGFtcGluZyBvbiB2ZXJ0aWNhbCBtb3ZlbWVudCB0byBwcmV2ZW50IG9zY2lsbGF0aW9uLiIsCiAgICAgICAgJ0JPVU5EQVJZX1JBRElVUyc6ICJSYWRpdXMgb2YgdGhlIGNpcmN1bGFyIGFyZW5hIHdhbGwuIiwKICAgICAgICAnQk9VTkRBUllfSEVJR0hUJzogIkhlaWdodCBvZiB0aGUgYXJlbmEgY2VpbGluZy9mbG9vci4iLAogICAgICAgICdXQUxMX1NPRlRfQlVGRkVSJzogIkRpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMuIiwKICAgICAgICAnV0FMTF9TT0ZUX0ZPUkNFJzogIkZvcmNlIHB1c2hpbmcgYmFsbCBhd2F5IGZyb20gd2FsbCBiZWZvcmUgaW1wYWN0LiIsCiAgICAgICAgJ1dBTExfRUxBU1RJQ0lUWSc6ICJCb3VuY2luZXNzIG9mIHRoZSB3YWxsICgwID0gZGVhZCB0aHVkLCAxID0gcGVyZmVjdCBib3VuY2UpLiIsCiAgICAgICAgJ1dBTExfRlJJQ1RJT04nOiAiRnJpY3Rpb24gd2hlbiBzbGlkaW5nIGFsb25nIHRoZSB3YWxsLiIsCiAgICAgICAgJ0ZMT09SX0VMQVNUSUNJVFknOiAiQm91bmNpbmVzcyBvZiB0aGUgZmxvb3IvY2VpbGluZy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9FTkFCTEVEJzogIkVuYWJsZXMgdGhlIGV4dGVuZGVkIGNvcnJpZG9yIGZvciB0aGUgZ29hbC4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9YJzogIkhhbGYtd2lkdGggb2YgdGhlIGdvYWwgcG9ja2V0IGNvcnJpZG9yLiIsCiAgICAgICAgJ0dPQUxfUE9DS0VUX1onOiAiWi1kZXB0aCB3aGVyZSB0aGUgcG9ja2V0IHN0YXJ0cy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9SQURJVVMnOiAiRWZmZWN0aXZlIHJhZGl1cyBpbnNpZGUgdGhlIHBvY2tldC4iLAogICAgICAgICdMQVVOQ0hfU1BFRURfU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBTdGF0IFBvd2VyIHRvIFBoeXNpY3MgVmVsb2NpdHkuIiwKICAgICAgICAnTEFVTkNIX1NQRUVEX0NBUCc6ICJNYXhpbXVtIHBoeXNpY2FsIHNwZWVkIHRoZSBiYWxsIGNhbiBiZSB0aHJvd24uIiwKICAgICAgICAnU1dJUEVfTUlOX1BYJzogIk1pbmltdW0gc3dpcGUgZGlzdGFuY2UgdG8gcmVnaXN0ZXIgYSB0aHJvdy4iLAogICAgICAgICdBSU1fRFhfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgaG9yaXpvbnRhbCBhaW0gZnJvbSBzd2lwZS4iLAogICAgICAgICdBSU1fRFlfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgdmVydGljYWwgYWltIGZyb20gc3dpcGUuIiwKICAgICAgICAnUE9XRVJfQkFTRSc6ICJCYXNlIHBvd2VyIG11bHRpcGxpZXIgZm9yIGEgcXVpY2sgdGFwLiIsCiAgICAgICAgJ1BPV0VSX1JBTkdFJzogIkFkZGl0aW9uYWwgcG93ZXIgbXVsdGlwbGllciBhdCBmdWxsIGNoYXJnZS4iLAogICAgICAgICdQT1dFUl9NQVhfQk9OVVNfUkFUSU8nOiAiQ2hhcmdlIHRocmVzaG9sZCBmb3IgJ01heCBQb3dlcicgYm9udXMuIiwKICAgICAgICAnUE9XRVJfTUFYX01VTFRJUExJRVInOiAiTXVsdGlwbGllciBhcHBsaWVkIHdoZW4gaGl0dGluZyBNYXggUG93ZXIuIiwKICAgICAgICAnQ1VSVkVfRU5BQkxFRCc6ICJFbmFibGVzIGN1cnZlIHNob3RzIHZpYSBjdXJ2ZWQgc3dpcGVzLiIsCiAgICAgICAgJ0NVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQnOiAiSG93IGN1cnZlZCBhIHN3aXBlIG11c3QgYmUgdG8gdHJpZ2dlciBzcGluLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBzd2lwZSBjdXJ2ZSB0byBiYWxsIHNwaW4uIiwKICAgICAgICAnQ1VSVkVfU1BFRURfTVVMVCc6ICJNdWx0aXBsaWVyIGZvciBzcGluIGJhc2VkIG9uIHN3aXBlIHNwZWVkLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fQ0FQJzogIk1heGltdW0gc3BpbiBhbGxvd2VkIGZyb20gYSBjdXJ2ZSB0aHJvdy4iLAogICAgICAgICdDVVJWRV9QRVJGRUNUX1NQSU4nOiAiU3BpbiB0aHJlc2hvbGQgdG8gdHJpZ2dlciAnUGVyZmVjdCBDdXJ2ZScgRlguIiwKICAgICAgICAndGltZVNjYWxlJzogIkdsb2JhbCBnYW1lIHNwZWVkIG11bHRpcGxpZXIuIiwKICAgICAgICAnZGVtb01vZGUnOiAiVG9nZ2xlIEFJIHZzIEFJIGF1dG8tcGxheS4iLAogICAgICAgICdyZXNvbHV0aW9uJzogIkludGVybmFsIHJlbmRlciByZXNvbHV0aW9uIHNjYWxlICgwLjUgPSBoYWxmIHJlcykuIiwKICAgICAgICAnYXJlbmFPcGFjaXR5JzogIk9wYWNpdHkgb2YgdGhlIG91dGVyIGFyZW5hIGdyaWQuIiwKICAgICAgICAnYXJlbmEyT3BhY2l0eSc6ICJPcGFjaXR5IG9mIHRoZSBpbm5lciBoZXggZ3JpZC4iCiAgICB9OwoKICAgIGNsYXNzIERldlRvb2xzIHsKICAgICAgICBjb25zdHJ1Y3RvcihnYW1lTWFuYWdlcikgewogICAgICAgICAgICB0aGlzLmdhbWUgPSBnYW1lTWFuYWdlcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIGxpbC1ndWkgYXR0YWNoZXMgdG8gd2luZG93LmxpbCBieSBkZWZhdWx0IGluIFVNRCBidWlsZAogICAgICAgICAgICBpZiAoIXdpbmRvdy5saWwgfHwgIXdpbmRvdy5saWwuR1VJKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkRldlRvb2xzOiBsaWwtZ3VpIG5vdCBmb3VuZC4iKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dhbWUtY29udGFpbmVyJyk7CiAgICAgICAgICAgIHRoaXMuZ3VpID0gbmV3IHdpbmRvdy5saWwuR1VJKHsgdGl0bGU6ICdGbHV4IERldlRvb2xzJywgY29udGFpbmVyOiBjb250YWluZXIgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQb3NpdGlvbiBhcyBhIGNvbGxhcHNlZCB0YWIgb24gdGhlIHJpZ2h0IGZyYW1lCi8vIFBvc2l0aW9uIGFzIGEgc2xpZGluZyB0YWIgb24gdGhlIHJpZ2h0IGZyYW1lCi8vIFBvc2l0aW9uIGFzIGEgc2xpZGluZyB0YWIgb24gdGhlIHJpZ2h0IGZyYW1lCi8vIFdyYXBwZXIgZm9yIHNsaWRpbmcgYW5pbWF0aW9uCiAgICAgICAgICAgIGNvbnN0IHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUudG9wID0gJzEwMHB4JzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5yaWdodCA9ICctMjYwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLndpZHRoID0gJzI2MHB4JzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS50cmFuc2l0aW9uID0gJ3JpZ2h0IDAuM3MgY3ViaWMtYmV6aWVyKDAuMiwgMC44LCAwLjIsIDEuMCknOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnpJbmRleCA9ICc5OTk5JzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLmZsZXhEaXJlY3Rpb24gPSAnY29sdW1uJzsKICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHdyYXBwZXIpOwoKICAgICAgICAgICAgY29uc3QgZG9tID0gdGhpcy5ndWkuZG9tRWxlbWVudDsKICAgICAgICAgICAgZG9tLnN0eWxlLndpZHRoID0gJzEwMCUnOwogICAgICAgICAgICBkb20uc3R5bGUuc2V0UHJvcGVydHkoJy0td2lkdGgnLCAnMTAwJScpOwogICAgICAgICAgICBkb20uc3R5bGUubWF4SGVpZ2h0ID0gJzgwdmgnOwogICAgICAgICAgICBkb20uc3R5bGUub3ZlcmZsb3dZID0gJ2F1dG8nOwogICAgICAgICAgICBkb20uc3R5bGUub3ZlcmZsb3dYID0gJ2hpZGRlbic7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNb3ZlIEdVSSBpbnRvIHdyYXBwZXIKICAgICAgICAgICAgd3JhcHBlci5hcHBlbmRDaGlsZChkb20pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ3JlYXRlIFRvZ2dsZSBIYW5kbGUKICAgICAgICAgICAgY29uc3QgaGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5sZWZ0ID0gJy00MHB4JzsgLy8gUHJvdHJ1ZGUgdG8gdGhlIGxlZnQKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLnRvcCA9ICcwJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLndpZHRoID0gJzQwcHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuaGVpZ2h0ID0gJzQwcHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gJ3JnYmEoMCwgMjAsIDQwLCAwLjkpJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlciA9ICcxcHggc29saWQgIzAwZmZmZic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5ib3JkZXJSaWdodCA9ICdub25lJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlclRvcExlZnRSYWRpdXMgPSAnOHB4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlckJvdHRvbUxlZnRSYWRpdXMgPSAnOHB4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmN1cnNvciA9ICdwb2ludGVyJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5qdXN0aWZ5Q29udGVudCA9ICdjZW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYWxpZ25JdGVtcyA9ICdjZW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuY29sb3IgPSAnIzAwZmZmZic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5mb250U2l6ZSA9ICcyMHB4JzsKICAgICAgICAgICAgaGFuZGxlLmlubmVySFRNTCA9ICfimpknOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm94U2hhZG93ID0gJy01cHggMCAxMHB4IHJnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgICAgIAogICAgICAgICAgICB3cmFwcGVyLmFwcGVuZENoaWxkKGhhbmRsZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUb2dnbGUgTG9naWMKICAgICAgICAgICAgbGV0IGlzT3BlbiA9IGZhbHNlOwogICAgICAgICAgICBoYW5kbGUuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsgLy8gUHJldmVudCBnYW1lIGlucHV0cwogICAgICAgICAgICAgICAgaXNPcGVuID0gIWlzT3BlbjsKICAgICAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUucmlnaHQgPSBpc09wZW4gPyAnMHB4JyA6ICctMjYwcHgnOwogICAgICAgICAgICAgICAgaGFuZGxlLmlubmVySFRNTCA9IGlzT3BlbiA/ICfCuycgOiAn4pqZJzsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIERlZmF1bHQgZ2xvYmFsIHRpbWVTY2FsZSBpZiBub3Qgc2V0CmlmICh3aW5kb3cuZmx1eC50aW1lU2NhbGUgPT09IHVuZGVmaW5lZCkgd2luZG93LmZsdXgudGltZVNjYWxlID0gMC44OwoKdGhpcy5fc2V0dXBHZW5lcmFsKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwQ29udHJvbHNGZWVsKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwR2FtZVN0YXRlKCk7CnRoaXMuX3NldHVwT3ZlcmxheXMoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBUZWFtcygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFBsYXllckluc3BlY3RvcigpOwogICAgICAgICAgICB0aGlzLl9zZXR1cEJhbGxTYW5kYm94KCk7CnRoaXMuX3NldHVwRlhMYWIoKTsKdGhpcy5fc2V0dXBGWExhYigpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFZpc3VhbHMoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBUb29sdGlwcygpOwogICAgICAgIH0KCiAgICAgICAgX3NldHVwVG9vbHRpcHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBUb29sdGlwIERPTQogICAgICAgICAgICB0aGlzLnRvb2x0aXBFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMudG9vbHRpcEVsLnN0eWxlLCB7CiAgICAgICAgICAgICAgICBwb3NpdGlvbjogJ2ZpeGVkJywKICAgICAgICAgICAgICAgIHRvcDogJzUwJScsCiAgICAgICAgICAgICAgICBsZWZ0OiAnNTAlJywKICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogJ3RyYW5zbGF0ZSgtNTAlLCAtNTAlKScsCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICdyZ2JhKDAsIDEwLCAzMCwgMC45NSknLAogICAgICAgICAgICAgICAgYm9yZGVyOiAnMnB4IHNvbGlkICMwMGZmZmYnLAogICAgICAgICAgICAgICAgcGFkZGluZzogJzIwcHgnLAogICAgICAgICAgICAgICAgY29sb3I6ICcjZmZmJywKICAgICAgICAgICAgICAgIGZvbnRGYW1pbHk6ICdtb25vc3BhY2UnLAogICAgICAgICAgICAgICAgZm9udFNpemU6ICcxNHB4JywKICAgICAgICAgICAgICAgIG1heFdpZHRoOiAnMzAwcHgnLAogICAgICAgICAgICAgICAgekluZGV4OiAnMTAwMDAnLAogICAgICAgICAgICAgICAgZGlzcGxheTogJ25vbmUnLAogICAgICAgICAgICAgICAgcG9pbnRlckV2ZW50czogJ25vbmUnLAogICAgICAgICAgICAgICAgYm94U2hhZG93OiAnMCAwIDIwcHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKScsCiAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6ICc4cHgnLAogICAgICAgICAgICAgICAgdGV4dEFsaWduOiAnY2VudGVyJwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLnRvb2x0aXBFbCk7CgogICAgICAgICAgICAvLyBSZWN1cnNpdmUgZnVuY3Rpb24gdG8gYXR0YWNoIGxpc3RlbmVycwogICAgICAgICAgICBjb25zdCBhdHRhY2ggPSAoZ3VpKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBDb250cm9sbGVycwogICAgICAgICAgICAgICAgaWYgKGd1aS5jb250cm9sbGVycykgewogICAgICAgICAgICAgICAgICAgIGd1aS5jb250cm9sbGVycy5mb3JFYWNoKGMgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkb20gPSBjLmRvbUVsZW1lbnQuY2xvc2VzdCgnLmNvbnRyb2xsZXInKTsgLy8gbGlsLWd1aSBzdHJ1Y3R1cmUKICAgICAgICAgICAgICAgICAgICAgICAgaWYoZG9tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IGRvbS5xdWVyeVNlbGVjdG9yKCcubmFtZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobGFiZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hZGRMb25nUHJlc3MobGFiZWwsIGMucHJvcGVydHksIGMuX25hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBTdWItZm9sZGVycwogICAgICAgICAgICAgICAgaWYoZ3VpLmZvbGRlcnMpIHsKICAgICAgICAgICAgICAgICAgICBndWkuZm9sZGVycy5mb3JFYWNoKGYgPT4gYXR0YWNoKGYpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFdhaXQgYSB0aWNrIGZvciBHVUkgdG8gZnVsbHkgcmVuZGVyIERPTQogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGF0dGFjaCh0aGlzLmd1aSksIDEwMCk7CiAgICAgICAgfQoKICAgICAgICBfYWRkTG9uZ1ByZXNzKGVsZW1lbnQsIHByb3BlcnR5LCBuYW1lKSB7CiAgICAgICAgICAgIGxldCB0aW1lciA9IG51bGw7CiAgICAgICAgICAgIGNvbnN0IGR1cmF0aW9uID0gNTAwOyAvLyAwLjVzCgogICAgICAgICAgICBjb25zdCBzdGFydCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dUb29sdGlwKHByb3BlcnR5LCBuYW1lKTsKICAgICAgICAgICAgICAgIH0sIGR1cmF0aW9uKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGNvbnN0IGVuZCA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGlmKHRpbWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTsKICAgICAgICAgICAgICAgICAgICB0aW1lciA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9oaWRlVG9vbHRpcCgpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBzdGFydCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHN0YXJ0LCB7cGFzc2l2ZTogdHJ1ZX0pOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgZW5kKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgZW5kKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGVuZCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCBlbmQpOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dUb29sdGlwKHByb3AsIG5hbWUpIHsKICAgICAgICAgICAgY29uc3QgZGVzYyA9IFRPT0xUSVBfREVTQ1JJUFRJT05TW3Byb3BdOwogICAgICAgICAgICBpZihkZXNjKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRvb2x0aXBFbC5pbm5lckhUTUwgPSBgPHN0cm9uZyBzdHlsZT0iY29sb3I6IzAwZmZmZjsgZm9udC1zaXplOjE2cHg7Ij4ke25hbWUgfHwgcHJvcH08L3N0cm9uZz48YnI+PGJyPiR7ZGVzY31gOwogICAgICAgICAgICAgICAgdGhpcy50b29sdGlwRWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9oaWRlVG9vbHRpcCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudG9vbHRpcEVsKSB0aGlzLnRvb2x0aXBFbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KCgpfc2V0dXBHZW5lcmFsKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0dlbmVyYWwnKTsKICAgICAgICAgICAgCmNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIHRpbWVTY2FsZTogd2luZG93LmZsdXgudGltZVNjYWxlLAogICAgICAgICAgICAgICAgZGVtb01vZGU6IHRoaXMuZ2FtZS5pc0RlbW9Nb2RlLAogICAgICAgICAgICAgICAgdG9nZ2xlSFVEOiB0cnVlLAogICAgICAgICAgICAgICAgcmVzb2x1dGlvbjogMC41MCwKYXJlbmFPcGFjaXR5OiAwLjMsCiAgICAgICAgICAgICAgICBhcmVuYTJPcGFjaXR5OiAwLjI1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3RpbWVTY2FsZScsIDAuMCwgNS4wKS5uYW1lKCdHYW1lIFNwZWVkJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSB2OwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZGVtb01vZGUnKS5uYW1lKCdEZW1vIE1vZGUnKS5saXN0ZW4oKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuaXNEZW1vTW9kZSAhPT0gdikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS50b2dnbGVEZW1vTW9kZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndG9nZ2xlSFVEJykubmFtZSgnU2hvdyBIVUQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGh1ZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpOwogICAgICAgICAgICAgICAgaWYgKGh1ZCkgewogICAgICAgICAgICAgICAgICAgIGh1ZC5zdHlsZS52aXNpYmlsaXR5ID0gdiA/ICd2aXNpYmxlJyA6ICdoaWRkZW4nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAncmVzb2x1dGlvbicsIDAuMSwgMi4wKS5uYW1lKCdSZXNvbHV0aW9uIFNjYWxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB3ID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBoID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgY29uc3QgcmVuZGVyZXIgPSB0aGlzLmdhbWUucmVuZGVyZXI7CiAgICAgICAgICAgICAgICBpZiAocmVuZGVyZXIpIHsKICAgICAgICAgICAgICAgICAgICByZW5kZXJlci5zZXRTaXplKHcgKiB2LCBoICogdiwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCmZvbGRlci5hZGQocGFyYW1zLCAnYXJlbmFPcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ0FyZW5hIDEgT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IHY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYmxlbmRNb2RlcyA9IHsKICAgICAgICAgICAgICAgICdOb3JtYWwnOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywKICAgICAgICAgICAgICAgICdBZGRpdGl2ZSc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnTXVsdGlwbHknOiBUSFJFRS5NdWx0aXBseUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICdOb0JsZW5kaW5nJzogVEhSRUUuTm9CbGVuZGluZwogICAgICAgICAgICB9OwpwYXJhbXMuYXJlbmFCbGVuZCA9ICdOb3JtYWwnOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYUJsZW5kJywgT2JqZWN0LmtleXMoYmxlbmRNb2RlcykpLm5hbWUoJ0FyZW5hIDEgQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2ggJiYgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsLmJsZW5kaW5nID0gYmxlbmRNb2Rlc1t2XTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEFyZW5hIDIgQ29udHJvbHMKZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYTJPcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ0FyZW5hIDIgT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIgJiYgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eS52YWx1ZSA9IHY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKcGFyYW1zLmFyZW5hMkJsZW5kID0gJ0FkZGl0aXZlJzsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYTJCbGVuZCcsIE9iamVjdC5rZXlzKGJsZW5kTW9kZXMpKS5uYW1lKCdBcmVuYSAyIEJsZW5kJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoMiAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC5ibGVuZGluZyA9IGJsZW5kTW9kZXNbdl07CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgZGVmYXVsdHMKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gcGFyYW1zLmFyZW5hT3BhY2l0eTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoMiAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLm9wYWNpdHkgPSBwYXJhbXMuYXJlbmEyT3BhY2l0eTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3NldHVwQ29udHJvbHNGZWVsKCkgewogICAgICAgICAgICBjb25zdCBkZWJ1Z0lPID0gKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPKSA/IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIDogbnVsbDsKICAgICAgICAgICAgaWYgKCFkZWJ1Z0lPIHx8ICFkZWJ1Z0lPLnNldHRpbmdzKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBzID0gZGVidWdJTy5zZXR0aW5nczsKCiAgICAgICAgICAgIC8vIEVuc3VyZSBkZWZhdWx0cyBleGlzdCAob2xkZXIgcHJvamVjdHMgbWF5IG5vdCBoYXZlIHRoZXNlIGtleXMgeWV0KQogICAgICAgICAgICBpZiAocy5wYXNzQWltQXNzaXN0ID09PSB1bmRlZmluZWQpIHMucGFzc0FpbUFzc2lzdCA9IDAuNjU7CiAgICAgICAgICAgIGlmIChzLnNob3RBaW1Bc3Npc3QgPT09IHVuZGVmaW5lZCkgcy5zaG90QWltQXNzaXN0ID0gMC4zNTsKICAgICAgICAgICAgaWYgKHMuY2F0Y2hBc3Npc3QgPT09IHVuZGVmaW5lZCkgcy5jYXRjaEFzc2lzdCA9IDAuNTU7CiAgICAgICAgICAgIGlmIChzLnN0ZWVyaW5nQXNzaXN0ID09PSB1bmRlZmluZWQpIHMuc3RlZXJpbmdBc3Npc3QgPSAwLjM1OwogICAgICAgICAgICBpZiAocy5pbnB1dFJlc3BvbnNlID09PSB1bmRlZmluZWQpIHMuaW5wdXRSZXNwb25zZSA9IDE0LjA7CiAgICAgICAgICAgIGlmIChzLnByZWRpY3RpdmVDYXRjaFRpbWUgPT09IHVuZGVmaW5lZCkgcy5wcmVkaWN0aXZlQ2F0Y2hUaW1lID0gMC4xMjsKCiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignQ29udHJvbHMgJiBGZWVsJyk7CgogICAgICAgICAgICAvLyBDb3JlIHRvZ2dsZXMKICAgICAgICAgICAgZm9sZGVyLmFkZChzLCAnam95c3RpY2tTZW5zaXRpdml0eScsIDAuMywgMi4wLCAwLjAxKS5uYW1lKCdNb3ZlIFNlbnNpdGl2aXR5Jyk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocywgJ2ludmVydENhbWVyYScpLm5hbWUoJ0ludmVydCBDYW1lcmEnKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChzLCAnYXV0b1JlY2VudGVyJykubmFtZSgnQXV0byBSZWNlbnRlcicpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHMsICdhaW1Bc3Npc3QnKS5uYW1lKCdBaW0gQXNzaXN0Jyk7CgogICAgICAgICAgICAvLyBBc3Npc3QgbGF5ZXIgKDAuLjEpCiAgICAgICAgICAgIGNvbnN0IGEgPSBmb2xkZXIuYWRkRm9sZGVyKCdBc3Npc3QgU3RyZW5ndGhzJyk7CiAgICAgICAgICAgIGEuYWRkKHMsICdwYXNzQWltQXNzaXN0JywgMC4wLCAxLjAsIDAuMDEpLm5hbWUoJ1Bhc3MgQXNzaXN0Jyk7CiAgICAgICAgICAgIGEuYWRkKHMsICdzaG90QWltQXNzaXN0JywgMC4wLCAxLjAsIDAuMDEpLm5hbWUoJ1Nob3QgQXNzaXN0Jyk7CiAgICAgICAgICAgIGEuYWRkKHMsICdjYXRjaEFzc2lzdCcsIDAuMCwgMS4wLCAwLjAxKS5uYW1lKCdDYXRjaCBBc3Npc3QnKTsKICAgICAgICAgICAgYS5hZGQocywgJ3N0ZWVyaW5nQXNzaXN0JywgMC4wLCAxLjAsIDAuMDEpLm5hbWUoJ1N0ZWVyaW5nIEFzc2lzdCcpOwoKICAgICAgICAgICAgY29uc3QgZiA9IGZvbGRlci5hZGRGb2xkZXIoJ1Jlc3BvbnNpdmVuZXNzJyk7CiAgICAgICAgICAgIGYuYWRkKHMsICdpbnB1dFJlc3BvbnNlJywgNC4wLCAyNC4wLCAwLjEpLm5hbWUoJ0lucHV0IFJlc3BvbnNlJyk7CiAgICAgICAgICAgIGYuYWRkKHMsICdwcmVkaWN0aXZlQ2F0Y2hUaW1lJywgMC4wLCAwLjM1LCAwLjAxKS5uYW1lKCdQcmVkaWN0IENhdGNoIChzKScpOwogICAgICAgIH0KCgpfc2V0dXBPdmVybGF5cygpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdPdmVybGF5cyAmIEZYJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAxLiBHSUYgT3ZlcmxheQogICAgICAgICAgICBjb25zdCBnaWZFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzY3JlZW4tb3ZlcmxheS1naWYnKTsKICAgICAgICAgICAgaWYgKGdpZkVsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnaWZQYXJhbXMgPSB7CiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogdHJ1ZSwKb3BhY2l0eTogMC42MiwKICAgICAgICAgICAgICAgICAgICBibGVuZDogJ292ZXJsYXknCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBnRm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignU2NyZWVuIEdJRicpOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAndmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gZ2lmRWwuc3R5bGUuZGlzcGxheSA9IHYgPyAnYmxvY2snIDogJ25vbmUnKTsKICAgICAgICAgICAgICAgIGdGb2xkZXIuYWRkKGdpZlBhcmFtcywgJ29wYWNpdHknLCAwLjAsIDEuMCkub25DaGFuZ2UodiA9PiBnaWZFbC5zdHlsZS5vcGFjaXR5ID0gdik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGJsZW5kTW9kZXMgPSBbCiAgICAgICAgICAgICAgICAgICAgJ25vcm1hbCcsICdtdWx0aXBseScsICdzY3JlZW4nLCAnb3ZlcmxheScsIAogICAgICAgICAgICAgICAgICAgICdkYXJrZW4nLCAnbGlnaHRlbicsICdjb2xvci1kb2RnZScsICdjb2xvci1idXJuJywgCiAgICAgICAgICAgICAgICAgICAgJ2hhcmQtbGlnaHQnLCAnc29mdC1saWdodCcsICdkaWZmZXJlbmNlJywgJ2V4Y2x1c2lvbicsIAogICAgICAgICAgICAgICAgICAgICdodWUnLCAnc2F0dXJhdGlvbicsICdjb2xvcicsICdsdW1pbm9zaXR5JwogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgIGdGb2xkZXIuYWRkKGdpZlBhcmFtcywgJ2JsZW5kJywgYmxlbmRNb2Rlcykub25DaGFuZ2UodiA9PiBnaWZFbC5zdHlsZS5taXhCbGVuZE1vZGUgPSB2KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gV2F0ZXIgT3ZlcmxheQogICAgICAgICAgICBjb25zdCB3byA9IHRoaXMuZ2FtZS53YXRlck92ZXJsYXk7CiAgICAgICAgICAgIGlmICh3byAmJiB3by5tZXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCB3Rm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignV2F0ZXIgU2hhZGVyJyk7CiAgICAgICAgICAgICAgICBjb25zdCB3UGFyYW1zID0geyAKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHdvLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5ID8gd28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkudmFsdWUgOiAwLjUsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdBZGRpdGl2ZScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHdGb2xkZXIuYWRkKHdQYXJhbXMsICd2aXNpYmxlJykub25DaGFuZ2UodiA9PiB3by5tZXNoLnZpc2libGUgPSB2KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHdvLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ29wYWNpdHknLCAwLjAsIDIuMCkub25DaGFuZ2UodiA9PiB3by5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eS52YWx1ZSA9IHYpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHRocmVlQmxlbmRzID0gewogICAgICAgICAgICAgICAgICAgICdOb3JtYWwnOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICAnQWRkaXRpdmUnOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdTdWJ0cmFjdGl2ZSc6IFRIUkVFLlN1YnRyYWN0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgJ011bHRpcGx5JzogVEhSRUUuTXVsdGlwbHlCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICAnTm9CbGVuZGluZyc6IFRIUkVFLk5vQmxlbmRpbmcKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHdGb2xkZXIuYWRkKHdQYXJhbXMsICdibGVuZCcsIE9iamVjdC5rZXlzKHRocmVlQmxlbmRzKSkub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgd28ubWF0ZXJpYWwuYmxlbmRpbmcgPSB0aHJlZUJsZW5kc1t2XTsKICAgICAgICAgICAgICAgICAgICB3by5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gTGlnaHQgU2hhZnRzCiAgICAgICAgICAgIGNvbnN0IGxzID0gdGhpcy5nYW1lLmxpZ2h0U2hhZnRzOwogICAgICAgICAgICBpZiAobHMgJiYgbHMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBsUGFyYW1zID0geyB2aXNpYmxlOiB0cnVlIH07CiAgICAgICAgICAgICAgICBmb2xkZXIuYWRkKGxQYXJhbXMsICd2aXNpYmxlJykubmFtZSgnTGlnaHQgU2hhZnRzJykub25DaGFuZ2UodiA9PiBscy5jb250YWluZXIudmlzaWJsZSA9IHYpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX3NldHVwR2FtZVN0YXRlKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0dhbWUgU3RhdGUnKTsKICAgICAgICAgICAgY29uc3QgZ20gPSB0aGlzLmdhbWU7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgICAgICBmb3JjZUhvbWVHb2FsOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGlmKGdtLnN0YXRlID09PSAnYWN0aXZlJykgZ20uZ29hbFNjb3JlZCgnaG9tZScpOyAKICAgICAgICAgICAgICAgICAgICBlbHNlIGNvbnNvbGUud2FybigiR2FtZSBtdXN0IGJlIGFjdGl2ZSB0byB0cmlnZ2VyIGdvYWwiKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBmb3JjZUF3YXlHb2FsOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGlmKGdtLnN0YXRlID09PSAnYWN0aXZlJykgZ20uZ29hbFNjb3JlZCgnYXdheScpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgY29uc29sZS53YXJuKCJHYW1lIG11c3QgYmUgYWN0aXZlIHRvIHRyaWdnZXIgZ29hbCIpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGZvcmNlSGFsZnRpbWU6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZihnbS5zdGF0ZSA9PT0gJ2FjdGl2ZScpIGdtLmVuZEhhbGYoKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICByZXNldFJvdW5kOiAoKSA9PiBnbS5yZXNldFJvdW5kKCksCiAgICAgICAgICAgICAgICBleGl0VG9NZW51OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnN0YXRlID0gJ21lbnUnOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9wIHByYWN0aWNlIGlmIHJ1bm5pbmcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wcmFjdGljZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wcmFjdGljZU1hbmFnZXIuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdmb3JjZUhvbWVHb2FsJykubmFtZSgnVHJpZ2dlciBIb21lIEdvYWwnKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdmb3JjZUF3YXlHb2FsJykubmFtZSgnVHJpZ2dlciBBd2F5IEdvYWwnKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdmb3JjZUhhbGZ0aW1lJykubmFtZSgnRm9yY2UgSGFsZnRpbWUnKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdyZXNldFJvdW5kJykubmFtZSgnUmVzZXQgUm91bmQnKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdleGl0VG9NZW51JykubmFtZSgnRXhpdCB0byBNZW51Jyk7CiAgICAgICAgfQoKICAgICAgICBfc2V0dXBUZWFtcygpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdUZWFtcycpOwogICAgICAgICAgICBpZiAoIXRoaXMuZ2FtZS50ZWFtcy5ob21lIHx8ICF0aGlzLmdhbWUudGVhbXMuYXdheSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgaG9tZSA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBjb25zdCBhd2F5ID0gdGhpcy5nYW1lLnRlYW1zLmF3YXk7CgogICAgICAgICAgICAvLyBIb21lCiAgICAgICAgICAgIGNvbnN0IGhGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdIb21lIFRlYW0nKTsKICAgICAgICAgICAgaEZvbGRlci5hZGQoaG9tZSwgJ2lzSHVtYW4nKS5uYW1lKCdJcyBIdW1hbiBDb250cm9sbGVkJykubGlzdGVuKCk7CiAgICAgICAgICAgIGhGb2xkZXIuYWRkKGhvbWUsICdhaUVuYWJsZWQnKS5uYW1lKCdBSSBMb2dpYyBFbmFibGVkJykubGlzdGVuKCk7CgogICAgICAgICAgICAvLyBBd2F5CiAgICAgICAgICAgIGNvbnN0IGFGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdBd2F5IFRlYW0nKTsKICAgICAgICAgICAgYUZvbGRlci5hZGQoYXdheSwgJ2lzSHVtYW4nKS5uYW1lKCdJcyBIdW1hbiBDb250cm9sbGVkJykubGlzdGVuKCk7CiAgICAgICAgICAgIGFGb2xkZXIuYWRkKGF3YXksICdhaUVuYWJsZWQnKS5uYW1lKCdBSSBMb2dpYyBFbmFibGVkJykubGlzdGVuKCk7CgogICAgICAgIH0KCl9zZXR1cFBsYXllckluc3BlY3RvcigpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdQbGF5ZXIgSW5zcGVjdG9yIChIb21lIEFjdGl2ZSknKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhlbHBlciB0byBnZXQgY3VycmVudCBhY3RpdmUgcGxheWVyIHNhZmVseQogICAgICAgICAgICBjb25zdCBnZXRBY3RpdmUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICByZXR1cm4gKHRoaXMuZ2FtZS50ZWFtcy5ob21lICYmIHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcikgCiAgICAgICAgICAgICAgICAgICAgPyB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIgCiAgICAgICAgICAgICAgICAgICAgOiBudWxsOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUHJveHkgb2JqZWN0IHRvIGJpbmQgR1VJIHRvIGR5bmFtaWMgdGFyZ2V0CiAgICAgICAgICAgIGNvbnN0IHByb3h5ID0gewogICAgICAgICAgICAgICAgZ2V0IFJvbGUoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAucm9sZSA6ICctJzsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBnZXQgR29kTW9kZSgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5pc0dvZE1vZGUgOiBmYWxzZTsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEdvZE1vZGUodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5pc0dvZE1vZGUgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLy8gUnVudGltZSBWYWx1ZXMKICAgICAgICAgICAgICAgIGdldCBIUCgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5IUCA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBIUCh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLkhQID0gdjsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBnZXQgQ3VycmVudEVOKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLmN1cnJlbnRFTiA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBDdXJyZW50RU4odikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5jdXJyZW50RU4gPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLy8gQmFzZSBTdGF0cwogICAgICAgICAgICAgICAgZ2V0IE1heEhQKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLm1heEhQIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IE1heEhQKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMubWF4SFAgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFNQKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlNQIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFNQKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHMuU1AgPSB2OyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7IAogICAgICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBFTigpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5FTiA6IDA7IAogICAgICAgICAgICAgICAgfSwgCiAgICAgICAgICAgICAgICBzZXQgRU4odikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgewogICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXRzLkVOID0gdjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBBVCgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5BVCA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBBVCh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLkFUID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBQQSgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5QQSA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBQQSh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLlBBID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBCTCgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5CTCA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBCTCh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLkJMID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBTSCgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5TSCA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBTSCh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLlNIID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBDQSgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5DQSA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBDQSh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLkNBID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIC8vIEFjdGlvbnMKICAgICAgICAgICAgICAgIExldmVsVXA6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAubGV2ZWxVcCgpOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBGdWxsSGVhbDogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7IAogICAgICAgICAgICAgICAgICAgIGlmKHApIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSBwLmdldFN0YXQoJ0VOJyk7IAogICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXR1cy52ZW5vbSA9IDA7IAogICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXR1cy5uYXAgPSAwOyAKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBrIGluIHAuc3RhdHVzLndpdGhlcikgcC5zdGF0dXMud2l0aGVyW2tdID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiRlVMTCBIRUFMIiwgcC5tZXNoLnBvc2l0aW9uLCAiaGVhbCIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBEcmFpbkVOOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuY3VycmVudEVOID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgcC5mdW1ibGUoKTsgLy8gVHJpZ2dlciBmdW1ibGUgbG9naWMKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHByb3h5LCAnUm9sZScpLmxpc3RlbigpLmRpc2FibGUoKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwcm94eSwgJ0dvZE1vZGUnKS5uYW1lKCdHb2QgTW9kZSAoSW5mIEhQL0VOKScpLmxpc3RlbigpOwoKICAgICAgICAgICAgY29uc3QgcnRGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdSdW50aW1lIFN0YXR1cycpOwogICAgICAgICAgICBydEZvbGRlci5hZGQocHJveHksICdIUCcsIDAsIDk5OTkpLmxpc3RlbigpOwogICAgICAgICAgICBydEZvbGRlci5hZGQocHJveHksICdDdXJyZW50RU4nLCAwLCAxMDApLm5hbWUoJ0N1cnJlbnQgRU4nKS5saXN0ZW4oKTsKCiAgICAgICAgICAgIGNvbnN0IHN0YXRGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdCYXNlIFN0YXRzJyk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnTWF4SFAnLCAxMDAsIDk5OTkpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ0VOJywgMCwgOTkpLm5hbWUoJ01heCBFTicpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ1NQJywgMCwgOTkpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ0FUJywgMCwgOTkpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ1BBJywgMCwgOTkpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ0JMJywgMCwgOTkpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ1NIJywgMCwgOTkpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ0NBJywgMCwgOTkpLmxpc3RlbigpOwoKICAgICAgICAgICAgY29uc3QgYWN0aW9uRm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignQWN0aW9ucycpOwogICAgICAgICAgICBhY3Rpb25Gb2xkZXIuYWRkKHByb3h5LCAnTGV2ZWxVcCcpLm5hbWUoJ0luc3RhbnQgTGV2ZWwgVXAnKTsKICAgICAgICAgICAgYWN0aW9uRm9sZGVyLmFkZChwcm94eSwgJ0Z1bGxIZWFsJykubmFtZSgnRnVsbCBIZWFsICYgQ3VyZScpOwogICAgICAgICAgICBhY3Rpb25Gb2xkZXIuYWRkKHByb3h5LCAnRHJhaW5FTicpLm5hbWUoJ0RyYWluIEVOIChGdW1ibGUpJyk7CiAgICAgICAgfQoKX3NldHVwQmFsbFNhbmRib3goKSB7CiAgICBjb25zdCByb290ID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdCYWxsIExhYiAoVGhyb3cgJiBQaHlzaWNzKScpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gU2hhcmVkIHN0YXRlIG9iamVjdCAobGl2ZXMgb24gd2luZG93LmZsdXggc28gaXQgc3Vydml2ZXMgcmVsb2FkcykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgbGFiID0gd2luZG93LmZsdXguYmFsbExhYiA9IHdpbmRvdy5mbHV4LmJhbGxMYWIgfHwge307CiAgICBsYWIuZ2FtZSA9IHRoaXMuZ2FtZTsKCiAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZzsKICAgIGNvbnN0IFRDID0gd2luZG93LmZsdXguVGhyb3dDb25maWc7CgogICAgaWYgKCFDIHx8ICFUQykgewogICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBMYWI6IE1pc3NpbmcgQmFsbENvbmZpZyBvciBUaHJvd0NvbmZpZy4iKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBIZWxwZXJzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IGdldEJhbGwgPSAoKSA9PiB0aGlzLmdhbWUgJiYgdGhpcy5nYW1lLmVudGl0aWVzID8gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgY29uc3QgZ2V0QWN0aXZlID0gKCkgPT4gdGhpcy5nYW1lICYmIHRoaXMuZ2FtZS50ZWFtcyAmJiB0aGlzLmdhbWUudGVhbXMuaG9tZSA/IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciA6IG51bGw7CgogICAgY29uc3QgZW5zdXJlUHJldmlld0xpbmUgPSAoKSA9PiB7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3TGluZSkgcmV0dXJuOwogICAgICAgIGlmICghdGhpcy5nYW1lIHx8ICF0aGlzLmdhbWUuc2NlbmUpIHJldHVybjsKCiAgICAgICAgY29uc3QgZ2VvbSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5MaW5lQmFzaWNNYXRlcmlhbCh7IHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjk1IH0pOwogICAgICAgIGNvbnN0IGxpbmUgPSBuZXcgVEhSRUUuTGluZShnZW9tLCBtYXQpOwogICAgICAgIGxpbmUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgIGxpbmUucmVuZGVyT3JkZXIgPSA5OTk7CiAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZChsaW5lKTsKICAgICAgICBsYWIucHJldmlld0xpbmUgPSBsaW5lOwogICAgfTsKCiAgICBjb25zdCBjbGVhclByZXZpZXdMaW5lID0gKCkgPT4gewogICAgICAgIGlmIChsYWIucHJldmlld0xpbmUgJiYgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5KSB7CiAgICAgICAgICAgIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeS5kaXNwb3NlKCk7CiAgICAgICAgICAgIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gQSBzYWZlICJnaG9zdCBiYWxsIiB0aGF0IGNhbiB1c2UgQmFsbC51cGRhdGVGcmVlIHdpdGhvdXQgc3Bhd25pbmcgRlgKICAgIGNvbnN0IG1ha2VHaG9zdEJhbGwgPSAocG9zLCB2ZWwsIHNwaW4pID0+IHsKICAgICAgICBjb25zdCBnYiA9IHsKICAgICAgICAgICAgbWVzaDogeyBwb3NpdGlvbjogcG9zLmNsb25lKCkgfSwKICAgICAgICAgICAgdmVsb2NpdHk6IHZlbC5jbG9uZSgpLAogICAgICAgICAgICBhbmd1bGFyVmVsb2NpdHk6IChzcGluID8gc3Bpbi5jbG9uZSgpIDogbmV3IFRIUkVFLlZlY3RvcjMoKSksCiAgICAgICAgICAgIGFjY3VtdWxhdGVkUm90YXRpb246IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCksCiAgICAgICAgICAgIHBvd2VyOiAwLAogICAgICAgICAgICBkZWNheVJhdGU6IDAsCiAgICAgICAgICAgIF9idWJibGVUaW1lcjogOTk5LAogICAgICAgICAgICBfZ2hvc3Q6IHRydWUsCiAgICAgICAgICAgIGRlZm9ybU5vZGU6IG51bGwKICAgICAgICB9OwogICAgICAgIHJldHVybiBnYjsKICAgIH07CgogICAgLy8gVXNlIEJhbGwudXBkYXRlRnJlZSBmb3IgZmFpdGhmdWwgdHJhamVjdG9yeSBwcmVkaWN0aW9uCiAgICBjb25zdCBzaW11bGF0ZSA9IChnaG9zdEJhbGwsIHN0ZXBzLCBzdGVwRHQpID0+IHsKICAgICAgICBjb25zdCBwdHMgPSBbXTsKICAgICAgICBwdHMucHVzaChnaG9zdEJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpKTsKICAgICAgICBjb25zdCBwcm90byA9IHdpbmRvdy5mbHV4LkJhbGwgJiYgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGU7CiAgICAgICAgaWYgKCFwcm90byB8fCB0eXBlb2YgcHJvdG8udXBkYXRlRnJlZSAhPT0gJ2Z1bmN0aW9uJykgcmV0dXJuIHB0czsKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdGVwczsgaSsrKSB7CiAgICAgICAgICAgIHByb3RvLnVwZGF0ZUZyZWUuY2FsbChnaG9zdEJhbGwsIHN0ZXBEdCk7CiAgICAgICAgICAgIHB0cy5wdXNoKGdob3N0QmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcHRzOwogICAgfTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIFByZXZpZXcgKyByZWNvcmQvcmVwbGF5IHJ1bnRpbWUgbG9vcAogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmxhYi5wcmV2aWV3ID0gbGFiLnByZXZpZXcgfHwgewogICAgICAgIGVuYWJsZWQ6IGZhbHNlLAogICAgICAgIHNvdXJjZTogJ0Nhbm5vbicsCiAgICAgICAgc3RlcHM6IDEyMCwKICAgICAgICBzdGVwRHQ6IDEvNjAsCiAgICAgICAgcmVmcmVzaEh6OiAxMCwKICAgICAgICBzaG93T25IZWxkT25seTogZmFsc2UKICAgIH07CgogICAgbGFiLmNhbm5vbiA9IGxhYi5jYW5ub24gfHwgewogICAgICAgIHlhdzogMCwKICAgICAgICBwaXRjaDogMCwKICAgICAgICBwb3dlcjogMjAsCiAgICAgICAgdHlwZTogJ1NIJywKICAgICAgICBzcGluWDogMCwKICAgICAgICBzcGluWTogMCwKICAgICAgICBzcGluWjogMCwKICAgICAgICBmaXJlQnVyc3Q6IDEsCiAgICAgICAgc3ByZWFkRGVnOiAwCiAgICB9OwoKICAgIGxhYi5yZWNvcmRpbmcgPSBsYWIucmVjb3JkaW5nIHx8IHsKICAgICAgICBpc1JlY29yZGluZzogZmFsc2UsCiAgICAgICAgZnJhbWVzOiBbXSwKICAgICAgICBtYXhTZWNvbmRzOiAxMgogICAgfTsKCiAgICBsYWIucmVwbGF5ID0gbGFiLnJlcGxheSB8fCB7CiAgICAgICAgaXNSZXBsYXlpbmc6IGZhbHNlLAogICAgICAgIGZyYW1lczogW10sCiAgICAgICAgaWR4OiAwLAogICAgICAgIGxvb3A6IHRydWUsCiAgICAgICAgc3BlZWQ6IDEuMAogICAgfTsKCiAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgIGxhYi50YXJnZXRCYWxsID0gbnVsbDsKCiAgICBsYWIuYXBwbHlSZXBsYXlGcmFtZSA9IChiYWxsLCBkdCkgPT4gewogICAgICAgIGNvbnN0IHJlcCA9IGxhYi5yZXBsYXk7CiAgICAgICAgaWYgKCFyZXAgfHwgIXJlcC5pc1JlcGxheWluZyB8fCAhcmVwLmZyYW1lcyB8fCByZXAuZnJhbWVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gQWR2YW5jZSB0aW1lIGJ5IHN0ZXBwaW5nIGluZGljZXMgKGZyYW1lLWJhc2VkKQogICAgICAgIGNvbnN0IHN0ZXAgPSBNYXRoLm1heCgxLCBNYXRoLmZsb29yKHJlcC5zcGVlZCkpOwogICAgICAgIHJlcC5pZHggKz0gc3RlcDsKCiAgICAgICAgaWYgKHJlcC5pZHggPj0gcmVwLmZyYW1lcy5sZW5ndGgpIHsKICAgICAgICAgICAgaWYgKHJlcC5sb29wKSByZXAuaWR4ID0gMDsKICAgICAgICAgICAgZWxzZSB7IHJlcC5pc1JlcGxheWluZyA9IGZhbHNlOyBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsgcmV0dXJuOyB9CiAgICAgICAgfQoKICAgICAgICBjb25zdCBmID0gcmVwLmZyYW1lc1tyZXAuaWR4XTsKICAgICAgICBpZiAoIWYpIHJldHVybjsKCiAgICAgICAgYmFsbC5kcm9wKCk7IC8vIGVuc3VyZSBubyBob2xkZXIgbG9naWMgZmlnaHRzIHVzCiAgICAgICAgYmFsbC5zdGF0ZSA9ICdmcmVlJzsKICAgICAgICBiYWxsLm1lc2gucG9zaXRpb24uc2V0KGYucHgsIGYucHksIGYucHopOwogICAgICAgIGJhbGwudmVsb2NpdHkuc2V0KGYudngsIGYudnksIGYudnopOwogICAgICAgIGJhbGwuYW5ndWxhclZlbG9jaXR5LnNldChmLnN4LCBmLnN5LCBmLnN6KTsKICAgIH07CgogICAgbGFiLl9wcmV2aWV3VGltZXIgPSBsYWIuX3ByZXZpZXdUaW1lciB8fCAwOwoKICAgIGxhYi51cGRhdGUgPSAoZHQpID0+IHsKICAgICAgICAvLyAtLS0gcmVjb3JkaW5nIC0tLQogICAgICAgIGNvbnN0IGIgPSBnZXRCYWxsKCk7CiAgICAgICAgaWYgKGIgJiYgbGFiLnJlY29yZGluZyAmJiBsYWIucmVjb3JkaW5nLmlzUmVjb3JkaW5nKSB7CiAgICAgICAgICAgIGNvbnN0IHIgPSBsYWIucmVjb3JkaW5nOwogICAgICAgICAgICBjb25zdCBtYXhGcmFtZXMgPSBNYXRoLmZsb29yKChyLm1heFNlY29uZHMgfHwgMTIpIC8gKGR0IHx8ICgxLzYwKSkpOwogICAgICAgICAgICBpZiAoci5mcmFtZXMubGVuZ3RoID4gbWF4RnJhbWVzKSByLmZyYW1lcy5zaGlmdCgpOwogICAgICAgICAgICByLmZyYW1lcy5wdXNoKHsKICAgICAgICAgICAgICAgIHB4OiBiLm1lc2gucG9zaXRpb24ueCwgcHk6IGIubWVzaC5wb3NpdGlvbi55LCBwejogYi5tZXNoLnBvc2l0aW9uLnosCiAgICAgICAgICAgICAgICB2eDogYi52ZWxvY2l0eS54LCB2eTogYi52ZWxvY2l0eS55LCB2ejogYi52ZWxvY2l0eS56LAogICAgICAgICAgICAgICAgc3g6IGIuYW5ndWxhclZlbG9jaXR5LngsIHN5OiBiLmFuZ3VsYXJWZWxvY2l0eS55LCBzejogYi5hbmd1bGFyVmVsb2NpdHkuegogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBwcmV2aWV3IHJlZnJlc2ggLS0tCiAgICAgICAgbGFiLl9wcmV2aWV3VGltZXIgKz0gZHQ7CiAgICAgICAgY29uc3QgcmVmcmVzaEludGVydmFsID0gMS4wIC8gTWF0aC5tYXgoMSwgKGxhYi5wcmV2aWV3LnJlZnJlc2hIeiB8fCAxMCkpOwogICAgICAgIGlmIChsYWIucHJldmlldy5lbmFibGVkICYmIGxhYi5fcHJldmlld1RpbWVyID49IHJlZnJlc2hJbnRlcnZhbCkgewogICAgICAgICAgICBsYWIuX3ByZXZpZXdUaW1lciA9IDA7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0KICAgIH07CgogICAgbGFiLnJlZnJlc2hQcmV2aWV3ID0gKCkgPT4gewogICAgICAgIGlmICghbGFiLnByZXZpZXcuZW5hYmxlZCkgeyBjbGVhclByZXZpZXdMaW5lKCk7IHJldHVybjsgfQogICAgICAgIGVuc3VyZVByZXZpZXdMaW5lKCk7CgogICAgICAgIGNvbnN0IGIgPSBnZXRCYWxsKCk7CiAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgIGlmICghYiB8fCAhYi5tZXNoKSByZXR1cm47CgogICAgICAgIGlmIChsYWIucHJldmlldy5zaG93T25IZWxkT25seSAmJiBiLnN0YXRlICE9PSAnaGVsZCcpIHsKICAgICAgICAgICAgY2xlYXJQcmV2aWV3TGluZSgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBEZWNpZGUgcHJldmlldyBzb3VyY2UKICAgICAgICBsZXQgc3RhcnRQb3MgPSBiLm1lc2gucG9zaXRpb247CiAgICAgICAgbGV0IHN0YXJ0VmVsID0gYi52ZWxvY2l0eTsKICAgICAgICBsZXQgc3RhcnRTcGluID0gYi5hbmd1bGFyVmVsb2NpdHk7CgogICAgICAgIGlmIChsYWIucHJldmlldy5zb3VyY2UgPT09ICdDYW5ub24nKSB7CiAgICAgICAgICAgIC8vIENhbm5vbiBhbHdheXMgbGF1bmNoZXMgZnJvbSBiYWxsIHBvc2l0aW9uIChvciBwbGF5ZXIgaWYgaGVsZCkKICAgICAgICAgICAgY29uc3QgeWF3UmFkID0gKGxhYi5jYW5ub24ueWF3IHx8IDApICogTWF0aC5QSSAvIDE4MDsKICAgICAgICAgICAgY29uc3QgcGl0Y2hSYWQgPSAobGFiLmNhbm5vbi5waXRjaCB8fCAwKSAqIE1hdGguUEkgLyAxODA7CgogICAgICAgICAgICBjb25zdCBkaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgIE1hdGguc2luKHlhd1JhZCkgKiBNYXRoLmNvcyhwaXRjaFJhZCksCiAgICAgICAgICAgICAgICBNYXRoLnNpbihwaXRjaFJhZCksCiAgICAgICAgICAgICAgICAtTWF0aC5jb3MoeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKQogICAgICAgICAgICApLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgY29uc3QgY2FwID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX0NBUCAhPT0gdW5kZWZpbmVkID8gd2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfQ0FQIDogODUuMCk7CiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX1NDQUxFICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkxBVU5DSF9TUEVFRF9TQ0FMRSA6IDEuMCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5taW4oKGxhYi5jYW5ub24ucG93ZXIgfHwgMjApICogc2NhbGUsIGNhcCk7CgogICAgICAgICAgICBzdGFydFBvcyA9IChiLnN0YXRlID09PSAnaGVsZCcgJiYgcCAmJiBwLm1lc2gpID8gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEuMiwgMCkpIDogYi5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgIHN0YXJ0VmVsID0gZGlyLm11bHRpcGx5U2NhbGFyKHNwZWVkKTsKICAgICAgICAgICAgc3RhcnRTcGluID0gbmV3IFRIUkVFLlZlY3RvcjMobGFiLmNhbm5vbi5zcGluWCB8fCAwLCBsYWIuY2Fubm9uLnNwaW5ZIHx8IDAsIGxhYi5jYW5ub24uc3BpblogfHwgMCk7CiAgICAgICAgfQoKICAgICAgICBjb25zdCBnaG9zdCA9IG1ha2VHaG9zdEJhbGwoc3RhcnRQb3MuY2xvbmUoKSwgc3RhcnRWZWwuY2xvbmUoKSwgc3RhcnRTcGluKTsKICAgICAgICBjb25zdCBwdHMgPSBzaW11bGF0ZShnaG9zdCwgTWF0aC5mbG9vcihsYWIucHJldmlldy5zdGVwcyB8fCAxMjApLCAobGFiLnByZXZpZXcuc3RlcER0IHx8ICgxLzYwKSkpOwoKICAgICAgICBpZiAobGFiLnByZXZpZXdMaW5lKSB7CiAgICAgICAgICAgIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeS5kaXNwb3NlKCk7CiAgICAgICAgICAgIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpLnNldEZyb21Qb2ludHMocHRzKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBCYWxsIFBoeXNpY3MgKEJhbGxDb25maWcpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHBoeXMgPSByb290LmFkZEZvbGRlcignQmFsbCBQaHlzaWNzIChCYWxsQ29uZmlnKScpOwoKICAgIGNvbnN0IGludGVnID0gcGh5cy5hZGRGb2xkZXIoJ0ludGVncmF0aW9uJyk7CiAgICBpbnRlZy5hZGQoQywgJ1NVQlNURVBTJywgMSwgMTIsIDEpLm5hbWUoJ1N1YnN0ZXBzJyk7CiAgICBpbnRlZy5hZGQoQywgJ1NUT1BfU1BFRUQnLCAwLjAsIDAuMikubmFtZSgnU3RvcCBTcGVlZCcpOwoKICAgIGNvbnN0IGRyYWcgPSBwaHlzLmFkZEZvbGRlcignV2F0ZXIgRHJhZycpOwogICAgZHJhZy5hZGQoQywgJ1dBVEVSX0RSQUdfTElORUFSJywgMC4wLCAyLjApLm5hbWUoJ0xpbmVhciBEcmFnJyk7CiAgICBkcmFnLmFkZChDLCAnV0FURVJfRFJBR19RVUFEJywgMC4wLCAwLjA1KS5uYW1lKCdRdWFkcmF0aWMgRHJhZycpOwoKICAgIGNvbnN0IHNwaW4gPSBwaHlzLmFkZEZvbGRlcignU3BpbicpOwogICAgc3Bpbi5hZGQoQywgJ1NQSU5fRFJBRycsIDAuMCwgMy4wKS5uYW1lKCdTcGluIERlY2F5Jyk7CgogICAgY29uc3QgbWFnbnVzID0gcGh5cy5hZGRGb2xkZXIoJ01hZ251cycpOwogICAgbWFnbnVzLmFkZChDLCAnTUFHTlVTX0VOQUJMRUQnKS5uYW1lKCdFbmFibGVkJyk7CiAgICBtYWdudXMuYWRkKEMsICdNQUdOVVNfQ09FRkYnLCAwLjAsIDAuNSkubmFtZSgnQ29lZmYnKTsKICAgIG1hZ251cy5hZGQoQywgJ01BR05VU19DQVAnLCAwLjAsIDIwMC4wKS5uYW1lKCdDYXAnKTsKCiAgICBjb25zdCBkZXB0aCA9IHBoeXMuYWRkRm9sZGVyKCdEZXB0aCBDb25zdHJhaW50Jyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX1RBUkdFVF9ZJywgLTUuMCwgNS4wKS5uYW1lKCdUYXJnZXQgWScpOwogICAgZGVwdGguYWRkKEMsICdERVBUSF9TUFJJTkcnLCAwLjAsIDEwLjApLm5hbWUoJ1NwcmluZycpOwogICAgZGVwdGguYWRkKEMsICdERVBUSF9EQU1QJywgMC4wLCA2LjApLm5hbWUoJ0RhbXAnKTsKCiAgICBjb25zdCBhcmVuYSA9IHBoeXMuYWRkRm9sZGVyKCdBcmVuYSBCb3VuZGFyeScpOwogICAgYXJlbmEuYWRkKEMsICdCT1VOREFSWV9SQURJVVMnLCAxMC4wLCAxMjAuMCkubmFtZSgnUmFkaXVzJyk7CiAgICBhcmVuYS5hZGQoQywgJ0JPVU5EQVJZX0hFSUdIVCcsIDIuMCwgNDAuMCkubmFtZSgnSGVpZ2h0Jyk7CiAgICBhcmVuYS5hZGQoQywgJ1dBTExfU09GVF9CVUZGRVInLCAwLjAsIDIwLjApLm5hbWUoJ1NvZnQgQnVmZmVyJyk7CiAgICBhcmVuYS5hZGQoQywgJ1dBTExfU09GVF9GT1JDRScsIDAuMCwgMjAwLjApLm5hbWUoJ1NvZnQgRm9yY2UnKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9FTEFTVElDSVRZJywgMC4wLCAxLjApLm5hbWUoJ1dhbGwgQm91bmNlJyk7CiAgICBhcmVuYS5hZGQoQywgJ1dBTExfRlJJQ1RJT04nLCAwLjAsIDEuMCkubmFtZSgnV2FsbCBGcmljdGlvbicpOwogICAgYXJlbmEuYWRkKEMsICdGTE9PUl9FTEFTVElDSVRZJywgMC4wLCAxLjApLm5hbWUoJ0NlaWwvRmxvb3IgQm91bmNlJyk7CgogICAgY29uc3QgcG9ja2V0ID0gYXJlbmEuYWRkRm9sZGVyKCdHb2FsIFBvY2tldCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfRU5BQkxFRCcpLm5hbWUoJ0VuYWJsZWQnKTsKICAgIHBvY2tldC5hZGQoQywgJ0dPQUxfUE9DS0VUX1gnLCAwLjAsIDQwLjApLm5hbWUoJ1BvY2tldCBIYWxmLVgnKTsKICAgIHBvY2tldC5hZGQoQywgJ0dPQUxfUE9DS0VUX1onLCAwLjAsIDUwLjApLm5hbWUoJ1BvY2tldCBTdGFydCB8WnwnKTsKICAgIHBvY2tldC5hZGQoQywgJ0dPQUxfUE9DS0VUX1JBRElVUycsIDEwLjAsIDEyMC4wKS5uYW1lKCdQb2NrZXQgUmFkaXVzJyk7CgogICAgY29uc3QgbGF1bmNoID0gcGh5cy5hZGRGb2xkZXIoJ0xhdW5jaCBNYXBwaW5nJyk7CiAgICBsYXVuY2guYWRkKEMsICdMQVVOQ0hfU1BFRURfU0NBTEUnLCAwLjEsIDUuMCkubmFtZSgnU3BlZWQgU2NhbGUnKTsKICAgIGxhdW5jaC5hZGQoQywgJ0xBVU5DSF9TUEVFRF9DQVAnLCAxMC4wLCAyMDAuMCkubmFtZSgnU3BlZWQgQ2FwJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFRocm93IG1hcHBpbmcgKFBsYXllci5yZWxlYXNlQ2hhcmdlIC0+IEJhbGwuc2hvb3QpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHRocm93TWFwID0gcm9vdC5hZGRGb2xkZXIoJ1Rocm93IE1hcHBpbmcgKFRocm93Q29uZmlnKScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnU1dJUEVfTUlOX1BYJywgMCwgMTIwLCAxKS5uYW1lKCdTd2lwZSBNaW4gUFgnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ0FJTV9EWF9TQ0FMRScsIDAuMSwgNS4wKS5uYW1lKCdBaW0gWCBTY2FsZScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnQUlNX0RZX1NDQUxFJywgMC4xLCA1LjApLm5hbWUoJ0FpbSBZIFNjYWxlJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdQT1dFUl9CQVNFJywgMC4xLCAzLjApLm5hbWUoJ1Bvd2VyIEJhc2UnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX1JBTkdFJywgMC4wLCAzLjApLm5hbWUoJ1Bvd2VyIFJhbmdlJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdQT1dFUl9NQVhfQk9OVVNfUkFUSU8nLCAwLjAsIDEuMCkubmFtZSgnTWF4IEJvbnVzIFJhdGlvJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdQT1dFUl9NQVhfTVVMVElQTElFUicsIDEuMCwgNi4wKS5uYW1lKCdNYXggTXVsdGlwbGllcicpOwoKICAgIGNvbnN0IGN1cnZlTWFwID0gdGhyb3dNYXAuYWRkRm9sZGVyKCdDdXJ2ZScpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfRU5BQkxFRCcpLm5hbWUoJ0VuYWJsZWQnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQnLCAwLjAsIDEuMCkubmFtZSgnSW5wdXQgVGhyZXNob2xkJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9TUElOX1NDQUxFJywgMC4wLCA0MDAwLjApLm5hbWUoJ1NwaW4gU2NhbGUnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX1NQRUVEX01VTFQnLCAwLjAsIDUuMCkubmFtZSgnU3dpcGUgU3BlZWQgTXVsdCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfU1BJTl9DQVAnLCAwLjAsIDYwMDAuMCkubmFtZSgnU3BpbiBDYXAnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX1BFUkZFQ1RfU1BJTicsIDAuMCwgMjAwMC4wKS5uYW1lKCdQZXJmZWN0IFRocmVzaG9sZCcpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBUZWxlcG9ydCAvIFN0YXRlIHRvb2xzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHRwID0gcm9vdC5hZGRGb2xkZXIoJ1RlbGVwb3J0IC8gUmVzZXQnKTsKICAgIGNvbnN0IHRwUGFyYW1zID0gewogICAgICAgIFRvQ2VudGVyOiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGlmIChiKSBiLnJlc2V0KCk7IH0sCiAgICAgICAgVG9BY3RpdmVQbGF5ZXI6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgY29uc3QgcCA9IGdldEFjdGl2ZSgpOyBpZiAoYiAmJiBwKSBiLmdyYWIocCk7IH0sCiAgICAgICAgVG9Ib21lR29hbDogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAyNSk7IGIudmVsb2NpdHkuc2V0KDAsMCwwKTsgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsgfSB9LAogICAgICAgIFRvQXdheUdvYWw6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgaWYgKGIpIHsgYi5kcm9wKCk7IGIubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTI1KTsgYi52ZWxvY2l0eS5zZXQoMCwwLDApOyBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOyB9IH0sCiAgICAgICAgVG9Ta3k6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgaWYgKGIpIHsgYi5kcm9wKCk7IGIubWVzaC5wb3NpdGlvbi5zZXQoMCwgMTAsIDApOyBiLnZlbG9jaXR5LnNldCgwLDAsMCk7IGIuYW5ndWxhclZlbG9jaXR5LnNldCgwLDAsMCk7IH0gfSwKICAgICAgICBDbGVhclByZXZpZXc6ICgpID0+IGNsZWFyUHJldmlld0xpbmUoKQogICAgfTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvQ2VudGVyJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0FjdGl2ZVBsYXllcicpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9Ib21lR29hbCcpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9Bd2F5R29hbCcpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9Ta3knKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ0NsZWFyUHJldmlldycpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBTaG90IENhbm5vbiAoZm9yY2UgZmlyZSB3aXRoIHBhcmFtcykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgY2Fubm9uID0gcm9vdC5hZGRGb2xkZXIoJ1Nob3QgQ2Fubm9uJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICd5YXcnLCAtMTgwLCAxODAsIDEpLm5hbWUoJ1lhdyAoZGVnKScpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAncGl0Y2gnLCAtODksIDg5LCAxKS5uYW1lKCdQaXRjaCAoZGVnKScpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAncG93ZXInLCAwLCAxMjAsIDAuMSkubmFtZSgnUG93ZXInKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3R5cGUnLCBbJ1BBJywnU0gnXSkubmFtZSgnVHlwZScpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnc3BpblgnLCAtMzAwMCwgMzAwMCwgMSkubmFtZSgnU3BpbiBYJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcGluWScsIC0zMDAwLCAzMDAwLCAxKS5uYW1lKCdTcGluIFknKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwaW5aJywgLTMwMDAsIDMwMDAsIDEpLm5hbWUoJ1NwaW4gWicpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnZmlyZUJ1cnN0JywgMSwgMTAsIDEpLm5hbWUoJ0J1cnN0IENvdW50Jyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcHJlYWREZWcnLCAwLCAzMCwgMC41KS5uYW1lKCdTcHJlYWQgKGRlZyknKTsKCiAgICBjb25zdCBmaXJlUGFyYW1zID0gewogICAgICAgIEZpcmU6ICgpID0+IHsKICAgICAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICBpZiAoIWIpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHlhd1JhZCA9IChsYWIuY2Fubm9uLnlhdyB8fCAwKSAqIE1hdGguUEkgLyAxODA7CiAgICAgICAgICAgIGNvbnN0IHBpdGNoUmFkID0gKGxhYi5jYW5ub24ucGl0Y2ggfHwgMCkgKiBNYXRoLlBJIC8gMTgwOwoKICAgICAgICAgICAgY29uc3QgYmFzZURpciA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgTWF0aC5zaW4oeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIE1hdGguc2luKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIC1NYXRoLmNvcyh5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpCiAgICAgICAgICAgICkubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBzdGFydCA9IChiLnN0YXRlID09PSAnaGVsZCcgJiYgcCAmJiBwLm1lc2gpID8gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEuMiwgMCkpIDogYi5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CgogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IChsYWIuY2Fubm9uLmZpcmVCdXJzdCB8fCAxKTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBiYXNlRGlyLmNsb25lKCk7CiAgICAgICAgICAgICAgICBpZiAobGFiLmNhbm5vbi5zcHJlYWREZWcgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3ByZWFkID0gKGxhYi5jYW5ub24uc3ByZWFkRGVnICogTWF0aC5QSSAvIDE4MCk7CiAgICAgICAgICAgICAgICAgICAgZGlyLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIHNwcmVhZDsKICAgICAgICAgICAgICAgICAgICBkaXIueSArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogc3ByZWFkOwogICAgICAgICAgICAgICAgICAgIGRpci56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcHJlYWQ7CiAgICAgICAgICAgICAgICAgICAgZGlyLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGIuZHJvcCgpOwogICAgICAgICAgICAgICAgYi5tZXNoLnBvc2l0aW9uLmNvcHkoc3RhcnQpOwogICAgICAgICAgICAgICAgYi52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsKCiAgICAgICAgICAgICAgICBjb25zdCBzcGluID0gbmV3IFRIUkVFLlZlY3RvcjMobGFiLmNhbm5vbi5zcGluWCB8fCAwLCBsYWIuY2Fubm9uLnNwaW5ZIHx8IDAsIGxhYi5jYW5ub24uc3BpblogfHwgMCk7CiAgICAgICAgICAgICAgICBiLnNob290KGRpciwgbGFiLmNhbm5vbi5wb3dlciB8fCAyMCwgbGFiLmNhbm5vbi50eXBlIHx8ICdTSCcsIG51bGwsIHNwaW4pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGNhbm5vbi5hZGQoZmlyZVBhcmFtcywgJ0ZpcmUnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogVHJhamVjdG9yeSBQcmV2aWV3CiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHByZXZpZXcgPSByb290LmFkZEZvbGRlcignVHJhamVjdG9yeSBQcmV2aWV3Jyk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ2VuYWJsZWQnKS5uYW1lKCdFbmFibGVkJykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdzb3VyY2UnLCBbJ0Nhbm5vbicsICdMaXZlIEJhbGwnXSkubmFtZSgnU291cmNlJykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdzdGVwcycsIDEwLCA2MDAsIDEpLm5hbWUoJ1N0ZXBzJykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdzdGVwRHQnLCAxLzI0MCwgMS8xNSwgMS8yNDApLm5hbWUoJ1N0ZXAgZHQnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3JlZnJlc2hIeicsIDEsIDYwLCAxKS5uYW1lKCdSZWZyZXNoIEh6Jyk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3Nob3dPbkhlbGRPbmx5JykubmFtZSgnT25seSB3aGVuIEhlbGQnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CgogICAgY29uc3QgcHJldmlld0J0bnMgPSB7CiAgICAgICAgUmVmcmVzaDogKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCksCiAgICAgICAgSGlkZTogKCkgPT4geyBsYWIucHJldmlldy5lbmFibGVkID0gZmFsc2U7IGNsZWFyUHJldmlld0xpbmUoKTsgfQogICAgfTsKICAgIHByZXZpZXcuYWRkKHByZXZpZXdCdG5zLCAnUmVmcmVzaCcpOwogICAgcHJldmlldy5hZGQocHJldmlld0J0bnMsICdIaWRlJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFJlY29yZCAvIFJlcGxheQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCByciA9IHJvb3QuYWRkRm9sZGVyKCdSZWNvcmQgLyBSZXBsYXknKTsKICAgIGNvbnN0IHJyUGFyYW1zID0gewogICAgICAgIFJlY29yZDogKCkgPT4gewogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmlzUmVjb3JkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgbGFiLnJlY29yZGluZy5mcmFtZXMgPSBbXTsKICAgICAgICB9LAogICAgICAgIFN0b3A6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlY29yZGluZy5pc1JlY29yZGluZyA9IGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgVXNlUmVjb3JkaW5nRm9yUmVwbGF5OiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuZnJhbWVzID0gKGxhYi5yZWNvcmRpbmcuZnJhbWVzIHx8IFtdKS5zbGljZSgpOwogICAgICAgICAgICBsYWIucmVwbGF5LmlkeCA9IDA7CiAgICAgICAgfSwKICAgICAgICBQbGF5OiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGIgPSBnZXRCYWxsKCk7CiAgICAgICAgICAgIGlmICghYikgcmV0dXJuOwogICAgICAgICAgICBsYWIucmVwbGF5LmlzUmVwbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgbGFiLmlzUmVwbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgbGFiLnRhcmdldEJhbGwgPSBiOwogICAgICAgICAgICBsYWIucmVwbGF5LmlkeCA9IDA7CiAgICAgICAgfSwKICAgICAgICBQYXVzZTogKCkgPT4gewogICAgICAgICAgICBsYWIucmVwbGF5LmlzUmVwbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgQ2xlYXI6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlY29yZGluZy5mcmFtZXMgPSBbXTsKICAgICAgICAgICAgbGFiLnJlcGxheS5mcmFtZXMgPSBbXTsKICAgICAgICAgICAgbGFiLnJlcGxheS5pZHggPSAwOwogICAgICAgICAgICBsYWIucmVwbGF5LmlzUmVwbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgIH0KICAgIH07CiAgICByci5hZGQocnJQYXJhbXMsICdSZWNvcmQnKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1N0b3AnKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1VzZVJlY29yZGluZ0ZvclJlcGxheScpLm5hbWUoJ0NvcHkgUmVjIC0+IFJlcGxheScpOwogICAgcnIuYWRkKGxhYi5yZXBsYXksICdsb29wJykubmFtZSgnTG9vcCcpOwogICAgcnIuYWRkKGxhYi5yZXBsYXksICdzcGVlZCcsIDAuMjUsIDYuMCwgMC4yNSkubmFtZSgnUmVwbGF5IFNwZWVkJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdQbGF5Jyk7CiAgICByci5hZGQocnJQYXJhbXMsICdQYXVzZScpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnQ2xlYXInKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogUHJlc2V0cwogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBwcmVzZXRzID0gcm9vdC5hZGRGb2xkZXIoJ1ByZXNldHMnKTsKICAgIGNvbnN0IFAgPSB7CiAgICAgICAgVmFuaWxsYTogKCkgPT4gewogICAgICAgICAgICBPYmplY3QuYXNzaWduKEMsIHsKICAgICAgICAgICAgICAgIFNVQlNURVBTOiAyLAogICAgICAgICAgICAgICAgU1RPUF9TUEVFRDogMC4wMiwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfTElORUFSOiAwLjE1LAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19RVUFEOiAwLjAwMiwKICAgICAgICAgICAgICAgIFNQSU5fRFJBRzogMC40MCwKICAgICAgICAgICAgICAgIE1BR05VU19FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgTUFHTlVTX0NPRUZGOiAwLjA4LAogICAgICAgICAgICAgICAgTUFHTlVTX0NBUDogNjAuMCwKICAgICAgICAgICAgICAgIERFUFRIX1RBUkdFVF9ZOiAwLjAsCiAgICAgICAgICAgICAgICBERVBUSF9TUFJJTkc6IDEuMCwKICAgICAgICAgICAgICAgIERFUFRIX0RBTVA6IDEuNSwKICAgICAgICAgICAgICAgIEJPVU5EQVJZX1JBRElVUzogMzMuMCwKICAgICAgICAgICAgICAgIEJPVU5EQVJZX0hFSUdIVDogMTUuMCwKICAgICAgICAgICAgICAgIFdBTExfU09GVF9CVUZGRVI6IDMuMCwKICAgICAgICAgICAgICAgIFdBTExfU09GVF9GT1JDRTogMjAuMCwKICAgICAgICAgICAgICAgIFdBTExfRUxBU1RJQ0lUWTogMC4zMCwKICAgICAgICAgICAgICAgIFdBTExfRlJJQ1RJT046IDAuOTUsCiAgICAgICAgICAgICAgICBGTE9PUl9FTEFTVElDSVRZOiAwLjQwLAogICAgICAgICAgICAgICAgR09BTF9QT0NLRVRfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX1g6IDEyLjAsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9aOiAyNS4wLAogICAgICAgICAgICAgICAgR09BTF9QT0NLRVRfUkFESVVTOiA0NS4wLAogICAgICAgICAgICAgICAgTEFVTkNIX1NQRUVEX1NDQUxFOiAxLjAsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfQ0FQOiA4NS4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsYWIucmVmcmVzaFByZXZpZXcoKTsKICAgICAgICB9LAogICAgICAgIEFyY2FkZUN1cnZlOiAoKSA9PiB7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oQywgewogICAgICAgICAgICAgICAgTUFHTlVTX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ09FRkY6IDAuMTYsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ0FQOiA5MC4wLAogICAgICAgICAgICAgICAgU1BJTl9EUkFHOiAwLjI1LAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMTIsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX1FVQUQ6IDAuMDAxLAogICAgICAgICAgICAgICAgV0FMTF9TT0ZUX0ZPUkNFOiAzNS4wLAogICAgICAgICAgICAgICAgTEFVTkNIX1NQRUVEX0NBUDogMTEwLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oVEMsIHsKICAgICAgICAgICAgICAgIENVUlZFX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgICAgICAgICBDVVJWRV9TUElOX1NDQUxFOiAxNTAwLjAsCiAgICAgICAgICAgICAgICBDVVJWRV9TUElOX0NBUDogMzAwMC4wLAogICAgICAgICAgICAgICAgQ1VSVkVfUEVSRkVDVF9TUElOOiA3MDAuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfSwKICAgICAgICBTbmFwcHlSZWFsaXN0aWM6ICgpID0+IHsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihDLCB7CiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX0xJTkVBUjogMC4yNSwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDYsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ09FRkY6IDAuMDUsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ0FQOiA0MC4wLAogICAgICAgICAgICAgICAgU1BJTl9EUkFHOiAwLjc1LAogICAgICAgICAgICAgICAgU1RPUF9TUEVFRDogMC4wNSwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDcwLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0KICAgIH07CiAgICBwcmVzZXRzLmFkZChQLCAnVmFuaWxsYScpOwogICAgcHJlc2V0cy5hZGQoUCwgJ0FyY2FkZUN1cnZlJyk7CiAgICBwcmVzZXRzLmFkZChQLCAnU25hcHB5UmVhbGlzdGljJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFNuYXBzaG90IC8gRXhwb3J0CiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHNuYXBzaG90ID0gcm9vdC5hZGRGb2xkZXIoJ1NuYXBzaG90IC8gRXhwb3J0Jyk7CgogICAgY29uc3QgX3JvdW5kID0gKG4sIHBsYWNlcyA9IDQpID0+IHsKICAgICAgICBpZiAoIU51bWJlci5pc0Zpbml0ZShuKSkgcmV0dXJuIG51bGw7CiAgICAgICAgY29uc3QgcCA9IE1hdGgucG93KDEwLCBwbGFjZXMpOwogICAgICAgIHJldHVybiBNYXRoLnJvdW5kKG4gKiBwKSAvIHA7CiAgICB9OwoKICAgIGNvbnN0IF92MyA9ICh2LCBwbGFjZXMgPSA0KSA9PiB7CiAgICAgICAgaWYgKCF2KSByZXR1cm4gbnVsbDsKICAgICAgICByZXR1cm4gW19yb3VuZCh2LngsIHBsYWNlcyksIF9yb3VuZCh2LnksIHBsYWNlcyksIF9yb3VuZCh2LnosIHBsYWNlcyldOwogICAgfTsKCiAgICBjb25zdCBfY2xvbmVKc29uID0gKG9iaikgPT4gewogICAgICAgIGlmICghb2JqKSByZXR1cm4gbnVsbDsKICAgICAgICB0cnkgeyByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShvYmopKTsgfSBjYXRjaCAoZSkgeyByZXR1cm4gbnVsbDsgfQogICAgfTsKCiAgICBjb25zdCBfcGxheWVyU25hcCA9IChwKSA9PiB7CiAgICAgICAgaWYgKCFwKSByZXR1cm4gbnVsbDsKICAgICAgICBjb25zdCBhbmltID0gKHAuYWN0aXZlQWN0aW9uICYmIHAuYWN0aXZlQWN0aW9uLl9jbGlwKSA/IHAuYWN0aXZlQWN0aW9uLl9jbGlwLm5hbWUgOiAocC5zdGF0ZSB8fCBudWxsKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBuYW1lOiBwLmNoYXJhY3Rlck5hbWUgfHwgcC5uYW1lIHx8IG51bGwsCiAgICAgICAgICAgIHJvbGU6IHAucm9sZSB8fCBudWxsLAogICAgICAgICAgICBzdGF0ZTogcC5zdGF0ZSB8fCBudWxsLAogICAgICAgICAgICBoYXNCYWxsOiAhIXAuaGFzQmFsbCwKICAgICAgICAgICAgaXNUaHJvd2luZzogISFwLmlzVGhyb3dpbmcsCiAgICAgICAgICAgIGlzQ2hhcmdpbmc6ICEhcC5pc0NoYXJnaW5nLAogICAgICAgICAgICBpc0Rhc2hpbmc6ICEhcC5pc0Rhc2hpbmcsCiAgICAgICAgICAgIGRhc2hDb29sZG93bjogX3JvdW5kKHAuZGFzaENvb2xkb3duLCA0KSwKICAgICAgICAgICAgcG9zOiBfdjMocC5tZXNoICYmIHAubWVzaC5wb3NpdGlvbiksCiAgICAgICAgICAgIHZlbDogX3YzKHAudmVsb2NpdHkpLAogICAgICAgICAgICBpbnB1dDogX3YzKHAuaW5wdXRWZWN0b3IpLAogICAgICAgICAgICBzdGF0czogcC5zdGF0cyA/IF9jbG9uZUpzb24ocC5zdGF0cykgOiBudWxsLAogICAgICAgICAgICBhbmltCiAgICAgICAgfTsKICAgIH07CgogICAgY29uc3QgX3RlYW1TbmFwID0gKHQpID0+IHsKICAgICAgICBpZiAoIXQpIHJldHVybiBudWxsOwogICAgICAgIGNvbnN0IGFjdGl2ZSA9IHQuYWN0aXZlUGxheWVyID8gX3BsYXllclNuYXAodC5hY3RpdmVQbGF5ZXIpIDogbnVsbDsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBpZDogdC5pZCB8fCBudWxsLAogICAgICAgICAgICBzaWRlOiB0LnNpZGUsCiAgICAgICAgICAgIGlzSHVtYW46ICEhdC5pc0h1bWFuLAogICAgICAgICAgICBhaUVuYWJsZWQ6ICEhdC5haUVuYWJsZWQsCiAgICAgICAgICAgIGN1cnJlbnRGb3JtYXRpb246IHQuY3VycmVudEZvcm1hdGlvbiB8fCBudWxsLAogICAgICAgICAgICBhY3RpdmVQbGF5ZXI6IGFjdGl2ZSwKICAgICAgICAgICAgcGxheWVyczogQXJyYXkuaXNBcnJheSh0LnBsYXllcnMpID8gdC5wbGF5ZXJzLm1hcChfcGxheWVyU25hcCkgOiBbXQogICAgICAgIH07CiAgICB9OwoKICAgIGNvbnN0IGJ1aWxkU25hcHNob3QgPSAoKSA9PiB7CiAgICAgICAgY29uc3QgZ2FtZSA9IHRoaXMuZ2FtZSB8fCB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgfHwgbnVsbDsKICAgICAgICBjb25zdCBiYWxsID0gZ2FtZSAmJiBnYW1lLmVudGl0aWVzID8gZ2FtZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICBjb25zdCBjYW1NZ3IgPSBnYW1lID8gZ2FtZS5jYW1lcmFNYW5hZ2VyIDogbnVsbDsKICAgICAgICBjb25zdCBjYW0gPSAoY2FtTWdyICYmIGNhbU1nci5jYW1lcmEpID8gY2FtTWdyLmNhbWVyYSA6IChnYW1lID8gZ2FtZS5jYW1lcmEgOiBudWxsKTsKCiAgICAgICAgY29uc3QgYmFsbFNuYXAgPSBiYWxsID8gewogICAgICAgICAgICBzdGF0ZTogYmFsbC5zdGF0ZSB8fCBudWxsLAogICAgICAgICAgICBpc0ludmlzaWJsZTogISFiYWxsLmlzSW52aXNpYmxlLAogICAgICAgICAgICBob2xkZXI6IGJhbGwuaG9sZGVyID8gKGJhbGwuaG9sZGVyLmNoYXJhY3Rlck5hbWUgfHwgYmFsbC5ob2xkZXIubmFtZSB8fCBudWxsKSA6IG51bGwsCiAgICAgICAgICAgIGxhc3RIb2xkZXI6IGJhbGwubGFzdEhvbGRlciA/IChiYWxsLmxhc3RIb2xkZXIuY2hhcmFjdGVyTmFtZSB8fCBiYWxsLmxhc3RIb2xkZXIubmFtZSB8fCBudWxsKSA6IG51bGwsCiAgICAgICAgICAgIHBvczogX3YzKGJhbGwubWVzaCAmJiBiYWxsLm1lc2gucG9zaXRpb24pLAogICAgICAgICAgICB2ZWw6IF92MyhiYWxsLnZlbG9jaXR5KSwKICAgICAgICAgICAgYW5nVmVsOiBfdjMoYmFsbC5hbmd1bGFyVmVsb2NpdHkpLAogICAgICAgICAgICBwb3dlcjogX3JvdW5kKGJhbGwucG93ZXIsIDQpLAogICAgICAgICAgICBzaG90VHlwZTogYmFsbC5zaG90VHlwZSB8fCBudWxsCiAgICAgICAgfSA6IG51bGw7CgogICAgICAgIGNvbnN0IGNhbWVyYVNuYXAgPSBjYW0gPyB7CiAgICAgICAgICAgIHBvczogX3YzKGNhbS5wb3NpdGlvbiksCiAgICAgICAgICAgIHJvdDogY2FtLnJvdGF0aW9uID8gW19yb3VuZChjYW0ucm90YXRpb24ueCwgNCksIF9yb3VuZChjYW0ucm90YXRpb24ueSwgNCksIF9yb3VuZChjYW0ucm90YXRpb24ueiwgNCldIDogbnVsbCwKICAgICAgICAgICAgZm92OiBfcm91bmQoY2FtLmZvdiwgNCksCiAgICAgICAgICAgIG5lYXI6IF9yb3VuZChjYW0ubmVhciwgNiksCiAgICAgICAgICAgIGZhcjogX3JvdW5kKGNhbS5mYXIsIDQpCiAgICAgICAgfSA6IG51bGw7CgogICAgICAgIGNvbnN0IGNhbU1nclNuYXAgPSBjYW1NZ3IgPyB7CiAgICAgICAgICAgIG1vZGU6IGNhbU1nci5tb2RlIHx8IG51bGwsCiAgICAgICAgICAgIHRhcmdldE5hbWU6IChjYW1NZ3IudGFyZ2V0ICYmIChjYW1NZ3IudGFyZ2V0LmNoYXJhY3Rlck5hbWUgfHwgY2FtTWdyLnRhcmdldC5uYW1lKSkgfHwgbnVsbCwKICAgICAgICAgICAgc2V0dGluZ3M6IGNhbU1nci5zZXR0aW5ncyA/IF9jbG9uZUpzb24oY2FtTWdyLnNldHRpbmdzKSA6IG51bGwKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgY29uc3QgZGVidWdJTyA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPID8gd2luZG93LmZsdXguX2RlYnVnSU8gOiBudWxsOwogICAgICAgIGNvbnN0IGlucHV0U25hcCA9IGRlYnVnSU8gPyB7CiAgICAgICAgICAgIHNldHRpbmdzOiBkZWJ1Z0lPLnNldHRpbmdzID8gX2Nsb25lSnNvbihkZWJ1Z0lPLnNldHRpbmdzKSA6IG51bGwsCiAgICAgICAgICAgIHBlcmY6IGRlYnVnSU8ucGVyZiA/IF9jbG9uZUpzb24oZGVidWdJTy5wZXJmKSA6IG51bGwsCiAgICAgICAgICAgIG1vdmU6IChkZWJ1Z0lPLmlucHV0ICYmIGRlYnVnSU8uaW5wdXQubW92ZSkgPyB7CiAgICAgICAgICAgICAgICB0b3VjaElkOiBkZWJ1Z0lPLmlucHV0Lm1vdmUudG91Y2hJZCA/PyBudWxsLAogICAgICAgICAgICAgICAgZHJhZ2dpbmc6ICEhZGVidWdJTy5pbnB1dC5tb3ZlLmRyYWdnaW5nLAogICAgICAgICAgICAgICAgdmVjdG9yOiBkZWJ1Z0lPLmlucHV0Lm1vdmUudmVjdG9yID8gX2Nsb25lSnNvbihkZWJ1Z0lPLmlucHV0Lm1vdmUudmVjdG9yKSA6IG51bGwKICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgIGFpbTogKGRlYnVnSU8uaW5wdXQgJiYgZGVidWdJTy5pbnB1dC5haW0pID8gewogICAgICAgICAgICAgICAgdG91Y2hJZDogZGVidWdJTy5pbnB1dC5haW0udG91Y2hJZCA/PyBudWxsLAogICAgICAgICAgICAgICAgZHJhZ2dpbmc6ICEhZGVidWdJTy5pbnB1dC5haW0uZHJhZ2dpbmcsCiAgICAgICAgICAgICAgICB2ZWN0b3I6IGRlYnVnSU8uaW5wdXQuYWltLnZlY3RvciA/IF9jbG9uZUpzb24oZGVidWdJTy5pbnB1dC5haW0udmVjdG9yKSA6IG51bGwKICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgIHN3aXBlOiAoZGVidWdJTy5pbnB1dCAmJiBkZWJ1Z0lPLmlucHV0LnN3aXBlKSA/IHsKICAgICAgICAgICAgICAgIHRvdWNoSWQ6IGRlYnVnSU8uaW5wdXQuc3dpcGUudG91Y2hJZCA/PyBudWxsLAogICAgICAgICAgICAgICAgc3RhcnQ6IGRlYnVnSU8uaW5wdXQuc3dpcGUuc3RhcnQgPyBfY2xvbmVKc29uKGRlYnVnSU8uaW5wdXQuc3dpcGUuc3RhcnQpIDogbnVsbCwKICAgICAgICAgICAgICAgIHBvaW50czogQXJyYXkuaXNBcnJheShkZWJ1Z0lPLmlucHV0LnN3aXBlLnBvaW50cykgPyBkZWJ1Z0lPLmlucHV0LnN3aXBlLnBvaW50cy5zbGljZSgtMzIpLm1hcChfY2xvbmVKc29uKSA6IFtdCiAgICAgICAgICAgIH0gOiBudWxsCiAgICAgICAgfSA6IG51bGw7CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG1ldGE6IHsKICAgICAgICAgICAgICAgIHRpbWVzdGFtcElTTzogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLAogICAgICAgICAgICAgICAgaHJlZjogKHR5cGVvZiBsb2NhdGlvbiAhPT0gJ3VuZGVmaW5lZCcgJiYgbG9jYXRpb24uaHJlZikgPyBsb2NhdGlvbi5ocmVmIDogbnVsbCwKICAgICAgICAgICAgICAgIHVzZXJBZ2VudDogKHR5cGVvZiBuYXZpZ2F0b3IgIT09ICd1bmRlZmluZWQnICYmIG5hdmlnYXRvci51c2VyQWdlbnQpID8gbmF2aWdhdG9yLnVzZXJBZ2VudCA6IG51bGwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2FtZTogZ2FtZSA/IHsKICAgICAgICAgICAgICAgIHNjb3JlOiBnYW1lLnNjb3JlID8gX2Nsb25lSnNvbihnYW1lLnNjb3JlKSA6IG51bGwsCiAgICAgICAgICAgICAgICB0aW1lOiBfcm91bmQoZ2FtZS50aW1lLCA0KSwKICAgICAgICAgICAgICAgIGhhbGY6IGdhbWUuaGFsZiA/PyBudWxsLAogICAgICAgICAgICAgICAgaGFsZkR1cmF0aW9uOiBfcm91bmQoZ2FtZS5oYWxmRHVyYXRpb24sIDQpLAogICAgICAgICAgICAgICAgaXNPdmVydGltZTogISFnYW1lLmlzT3ZlcnRpbWUsCiAgICAgICAgICAgICAgICBpc0RlbW9Nb2RlOiAhIWdhbWUuaXNEZW1vTW9kZQogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgY29uZmlnOiB7CiAgICAgICAgICAgICAgICBCYWxsQ29uZmlnOiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguQmFsbENvbmZpZykgPyBfY2xvbmVKc29uKHdpbmRvdy5mbHV4LkJhbGxDb25maWcpIDogbnVsbCwKICAgICAgICAgICAgICAgIFRocm93Q29uZmlnOiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguVGhyb3dDb25maWcpID8gX2Nsb25lSnNvbih3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZykgOiBudWxsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNhbWVyYTogY2FtZXJhU25hcCwKICAgICAgICAgICAgY2FtZXJhTWFuYWdlcjogY2FtTWdyU25hcCwKICAgICAgICAgICAgYmFsbDogYmFsbFNuYXAsCiAgICAgICAgICAgIHRlYW1zOiBnYW1lID8gewogICAgICAgICAgICAgICAgaG9tZTogX3RlYW1TbmFwKGdhbWUudGVhbXMgJiYgZ2FtZS50ZWFtcy5ob21lKSwKICAgICAgICAgICAgICAgIGF3YXk6IF90ZWFtU25hcChnYW1lLnRlYW1zICYmIGdhbWUudGVhbXMuYXdheSkKICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgIGlucHV0OiBpbnB1dFNuYXAKICAgICAgICB9OwogICAgfTsKCiAgICBjb25zdCBfY29weVRleHQgPSBhc3luYyAodGV4dCkgPT4gewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChuYXZpZ2F0b3IuY2xpcGJvYXJkICYmIG5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KSB7CiAgICAgICAgICAgICAgICBhd2FpdCBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dCh0ZXh0KTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAvLyBGYWxsYmFjawogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IHRhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGV4dGFyZWEnKTsKICAgICAgICAgICAgdGEudmFsdWUgPSB0ZXh0OwogICAgICAgICAgICB0YS5zdHlsZS5wb3NpdGlvbiA9ICdmaXhlZCc7CiAgICAgICAgICAgIHRhLnN0eWxlLmxlZnQgPSAnLTk5OTlweCc7CiAgICAgICAgICAgIHRhLnN0eWxlLnRvcCA9ICctOTk5OXB4JzsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0YSk7CiAgICAgICAgICAgIHRhLmZvY3VzKCk7CiAgICAgICAgICAgIHRhLnNlbGVjdCgpOwogICAgICAgICAgICBjb25zdCBvayA9IGRvY3VtZW50LmV4ZWNDb21tYW5kKCdjb3B5Jyk7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGEpOwogICAgICAgICAgICByZXR1cm4gb2s7CiAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwoKICAgIGNvbnN0IF9kb3dubG9hZFRleHQgPSAoZmlsZW5hbWUsIHRleHQpID0+IHsKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCBibG9iID0gbmV3IEJsb2IoW3RleHRdLCB7IHR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJyB9KTsKICAgICAgICAgICAgY29uc3QgdXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTsKICAgICAgICAgICAgY29uc3QgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICAgICAgYS5ocmVmID0gdXJsOwogICAgICAgICAgICBhLmRvd25sb2FkID0gZmlsZW5hbWU7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoYSk7CiAgICAgICAgICAgIGEuY2xpY2soKTsKICAgICAgICAgICAgYS5yZW1vdmUoKTsKICAgICAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTCh1cmwpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdTbmFwc2hvdCBkb3dubG9hZCBmYWlsZWQ6JywgZSk7CiAgICAgICAgfQogICAgfTsKCiAgICBjb25zdCBzbmFwc2hvdEFjdGlvbnMgPSB7CiAgICAgICAgQ29weVNuYXBzaG90OiBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNuYXAgPSBidWlsZFNuYXBzaG90KCk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnN0cmluZ2lmeShzbmFwLCBudWxsLCAyKTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBhd2FpdCBfY29weVRleHQodGV4dCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbU25hcHNob3RdJywgc25hcCk7CiAgICAgICAgICAgIGlmICghb2spIGNvbnNvbGUud2FybignU25hcHNob3Q6IGNvcHkgZmFpbGVkIChzZWUgY29uc29sZSkuJyk7CiAgICAgICAgfSwKICAgICAgICBEb3dubG9hZFNuYXBzaG90OiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNuYXAgPSBidWlsZFNuYXBzaG90KCk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnN0cmluZ2lmeShzbmFwLCBudWxsLCAyKTsKICAgICAgICAgICAgX2Rvd25sb2FkVGV4dCgnc25hcHNob3QuanNvbicsIHRleHQpOwogICAgICAgICAgICBjb25zb2xlLmxvZygnW1NuYXBzaG90XScsIHNuYXApOwogICAgICAgIH0KICAgIH07CgogICAgc25hcHNob3QuYWRkKHNuYXBzaG90QWN0aW9ucywgJ0NvcHlTbmFwc2hvdCcpLm5hbWUoJ0NvcHkgSlNPTiBTbmFwc2hvdCcpOwogICAgc25hcHNob3QuYWRkKHNuYXBzaG90QWN0aW9ucywgJ0Rvd25sb2FkU25hcHNob3QnKS5uYW1lKCdEb3dubG9hZCBzbmFwc2hvdC5qc29uJyk7Cgp9CiAgICB9Cgp3aW5kb3cuZmx1eC5EZXZUb29scyA9IERldlRvb2xzOwoKICAgIERldlRvb2xzLnByb3RvdHlwZS5fc2V0dXBWaXN1YWxEZWJ1ZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignVmlzdWFsIERlYnVnZ2luZycpOwogICAgICAgIGNvbnN0IGR2ID0gdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcjsKICAgICAgICBpZiAoIWR2KSByZXR1cm47CgogICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgZW5hYmxlZDogZHYuZW5hYmxlZCwKICAgICAgICAgICAgaGl0Ym94ZXM6IGR2LnNob3dIaXRib3hlcywKICAgICAgICAgICAgdmVjdG9yczogZHYuc2hvd1ZlY3RvcnMsCiAgICAgICAgICAgIGFpOiBkdi5zaG93QUkKICAgICAgICB9OwoKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2VuYWJsZWQnKS5uYW1lKCdFbmFibGUgVmlzdWFsaXplcicpLm9uQ2hhbmdlKHYgPT4gZHYuZW5hYmxlZCA9IHYpOwogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnaGl0Ym94ZXMnKS5uYW1lKCdTaG93IEhpdGJveGVzJykub25DaGFuZ2UodiA9PiBkdi5zaG93SGl0Ym94ZXMgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3ZlY3RvcnMnKS5uYW1lKCdTaG93IFZlY3RvcnMnKS5vbkNoYW5nZSh2ID0+IGR2LnNob3dWZWN0b3JzID0gdik7CiAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhaScpLm5hbWUoJ1Nob3cgQUkgUGVyY2VwdGlvbicpLm9uQ2hhbmdlKHYgPT4gZHYuc2hvd0FJID0gdik7CiAgICB9OwoKICAgIERldlRvb2xzLnByb3RvdHlwZS5fc2V0dXBGWExhYiA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignRlggTGFiICYgVUkgVGVzdCcpOwogICAgICAgIAogICAgICAgIGNvbnN0IGdldFRhcmdldFBvcyA9ICgpID0+IHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgcmV0dXJuIHAgJiYgcC5tZXNoID8gcC5tZXNoLnBvc2l0aW9uIDogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMiwgMCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgZnhQYXJhbXMgPSB7CiAgICAgICAgICAgIFNwYXduVmVub206ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Zlbm9tJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bk5hcDogKCkgPT4gdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignbmFwJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bldpdGhlcjogKCkgPT4gdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignd2l0aGVyJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bkxlYXJuZWQ6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2xlYXJuZWQnLCBnZXRUYXJnZXRQb3MoKSksCiAgICAgICAgICAgIFNwYXduQ2xhc2g6ICgpID0+IHRoaXMuZ2FtZS5zcGF3bkNsYXNoKGdldFRhcmdldFBvcygpKSwKICAgICAgICB9OwoKICAgICAgICBjb25zdCBmeFN1YiA9IGZvbGRlci5hZGRGb2xkZXIoJ1BhcnRpY2xlcycpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduVmVub20nKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3bk5hcCcpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduV2l0aGVyJyk7CiAgICAgICAgZnhTdWIuYWRkKGZ4UGFyYW1zLCAnU3Bhd25MZWFybmVkJyk7CiAgICAgICAgZnhTdWIuYWRkKGZ4UGFyYW1zLCAnU3Bhd25DbGFzaCcpOwoKICAgICAgICBjb25zdCB0eHRQYXJhbXMgPSB7CiAgICAgICAgICAgIFRleHQ6ICJURVNUIiwKICAgICAgICAgICAgVHlwZTogImRhbWFnZSIsCiAgICAgICAgICAgIFNwYXduOiAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZih0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSAKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKHR4dFBhcmFtcy5UZXh0LCBnZXRUYXJnZXRQb3MoKSwgdHh0UGFyYW1zLlR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICAKICAgICAgICBjb25zdCB0eHRTdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdGbG9hdGluZyBUZXh0Jyk7CiAgICAgICAgdHh0U3ViLmFkZCh0eHRQYXJhbXMsICdUZXh0Jyk7CiAgICAgICAgdHh0U3ViLmFkZCh0eHRQYXJhbXMsICdUeXBlJywgWydkYW1hZ2UnLCAnaGVhbCcsICdzdGF0dXMnLCAndGVjaCcsICdjb21pYy1pbXBhY3QnLCAnY29taWMtYWN0aW9uJywgJ3NhdmUnLCAnYmxvY2snLCAnZGVmYXVsdCddKTsKICAgICAgICB0eHRTdWIuYWRkKHR4dFBhcmFtcywgJ1NwYXduJykubmFtZSgnU3Bhd24gVGV4dCcpOwoKICAgICAgICBjb25zdCBjYW1QYXJhbXMgPSB7CiAgICAgICAgICAgIFNoYWtlU21hbGw6ICgpID0+IHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuNSksCiAgICAgICAgICAgIFNoYWtlQmlnOiAoKSA9PiB0aGlzLmdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgyLjApLAogICAgICAgICAgICBJbXBhY3RMaWdodDogKCkgPT4gdGhpcy5nYW1lLnRyaWdnZXJJbXBhY3QoMC4xLCAnZGVmYXVsdCcpLAogICAgICAgICAgICBJbXBhY3RIZWF2eTogKCkgPT4gdGhpcy5nYW1lLnRyaWdnZXJJbXBhY3QoMC4yLCAnaGVhdnknKSwKICAgICAgICAgICAgSW1wYWN0U2hhdHRlcjogKCkgPT4gdGhpcy5nYW1lLnRyaWdnZXJJbXBhY3QoMC40LCAnc2hhdHRlcicpLAogICAgICAgIH07CgogICAgICAgIGNvbnN0IGNhbVN1YiA9IGZvbGRlci5hZGRGb2xkZXIoJ0NhbWVyYSAmIEltcGFjdCcpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnU2hha2VTbWFsbCcpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnU2hha2VCaWcnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ0ltcGFjdExpZ2h0Jyk7CiAgICAgICAgY2FtU3ViLmFkZChjYW1QYXJhbXMsICdJbXBhY3RIZWF2eScpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnSW1wYWN0U2hhdHRlcicpOwogICAgfTsKCgpEZXZUb29scy5wcm90b3R5cGUuX3NldHVwVmlzdWFscyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignQXNzZXQgRm9yZ2UnKTsKICAgICAgICAKICAgICAgICBjb25zdCBmb3JnZVN0YXRlID0gewogICAgICAgICAgICBhY3RpdmU6IGZhbHNlLAogICAgICAgICAgICBhc3NldE5hbWU6ICdUaWR1cycsCiAgICAgICAgICAgIGFuaW1OYW1lOiAnaWRsZScsCiAgICAgICAgICAgIHBvc1g6IDAsIHBvc1k6IDAsIHBvc1o6IDAsCiAgICAgICAgICAgIHJvdFg6IDAsIHJvdFk6IDAsIHJvdFo6IDAsCiAgICAgICAgICAgIHNjYWxlOiAxLjAsCiAgICAgICAgICAgIGNhbURpc3Q6IDUsIGNhbUhlaWdodDogMS41LCBjYW1Sb3Q6IDAKICAgICAgICB9OwoKICAgICAgICBjb25zdCBhc3NldHMgPSB7CiAgICAgICAgICAgICdUaWR1cyc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZGE3ODhiZWYyNThjNGYwYjhkOWVmMWFjYzE5YzU1NjcuZ2xiJywKICAgICAgICAgICAgJ1dha2thJzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy81OTExNGM5ODk1MTY0N2M5YjhkYTc0YjBiZDM2MzZjYi5nbGInLAogICAgICAgICAgICAnTGV0dHknOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzLzQzYWNlMzRjNmZkOTQyMTU5NjdlODQyYmY5MDlkYTVlLmdsYicsCiAgICAgICAgICAgICdEYXR0byc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZTZkNjdlY2IyZTRjNDcxNWJkNzNhNDA3OTVlMWQzZDUuZ2xiJywKICAgICAgICAgICAgJ0phc3N1JzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy84MjE2NDU5NTY3MzU0ZTYzOTU4ZDQxMDhkODI4ZGU5OC5nbGInLAogICAgICAgICAgICAnQm90dGEnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2FkMTU1ZWZlZGMwZDQ4ZmRhZDA5ZGEzZTFjYWU5Yzk3LmdsYicsCiAgICAgICAgICAgICdCYWxsJzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy81MjFhZTg3ODhlNTg0ZTM3OGE3OWQ5NzMyYTA3NTM1Ni5nbGInLAogICAgICAgICAgICAnR29hbCc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvYTUxNmJkOTBmYTdjNGRlZGI1ZGNiZmRmODAzZjEzZDUuZ2xiJwogICAgICAgIH07CgogICAgICAgIGxldCBjdXJyZW50QXNzZXQgPSBudWxsOwoKICAgICAgICBjb25zdCB1cGRhdGVUcmFuc2Zvcm0gPSAoKSA9PiB7CiAgICAgICAgICAgIGlmIChjdXJyZW50QXNzZXQpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRBc3NldC5wb3NpdGlvbi5zZXQoZm9yZ2VTdGF0ZS5wb3NYLCBmb3JnZVN0YXRlLnBvc1ksIGZvcmdlU3RhdGUucG9zWik7CiAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQucm90YXRpb24uc2V0KGZvcmdlU3RhdGUucm90WCwgZm9yZ2VTdGF0ZS5yb3RZLCBmb3JnZVN0YXRlLnJvdFopOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0LnNjYWxlLnNldFNjYWxhcihmb3JnZVN0YXRlLnNjYWxlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGNvbnN0IHVwZGF0ZUNhbWVyYSA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCFmb3JnZVN0YXRlLmFjdGl2ZSkgcmV0dXJuOwogICAgICAgICAgICAvLyBPcmJpdCBhcm91bmQgKDEwMDAsIFksIDEwMDApCiAgICAgICAgICAgIGNvbnN0IGN4ID0gMTAwMCArIE1hdGguc2luKGZvcmdlU3RhdGUuY2FtUm90KSAqIGZvcmdlU3RhdGUuY2FtRGlzdDsKICAgICAgICAgICAgY29uc3QgY3ogPSAxMDAwICsgTWF0aC5jb3MoZm9yZ2VTdGF0ZS5jYW1Sb3QpICogZm9yZ2VTdGF0ZS5jYW1EaXN0OwogICAgICAgICAgICB0aGlzLmdhbWUuY2FtZXJhLnBvc2l0aW9uLnNldChjeCwgZm9yZ2VTdGF0ZS5jYW1IZWlnaHQsIGN6KTsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhbWVyYS5sb29rQXQoMTAwMCwgZm9yZ2VTdGF0ZS5wb3NZICsgMSwgMTAwMCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgcGxheUFuaW1hdGlvbiA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aGlzLnZpek1peGVyIHx8ICF0aGlzLnZpekNsaXBzKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudml6TWl4ZXIuc3RvcEFsbEFjdGlvbigpOwogICAgICAgICAgICBpZiAoZm9yZ2VTdGF0ZS5hbmltTmFtZSA9PT0gJ25vbmUnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgY2xpcCA9IHRoaXMudml6Q2xpcHMuZmluZChjID0+IGMubmFtZSA9PT0gZm9yZ2VTdGF0ZS5hbmltTmFtZSk7CiAgICAgICAgICAgIGlmICghY2xpcCkgY2xpcCA9IHRoaXMudml6Q2xpcHMuZmluZChjID0+IGMubmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKGZvcmdlU3RhdGUuYW5pbU5hbWUudG9Mb3dlckNhc2UoKSkpOwogICAgICAgICAgICBpZiAoY2xpcCkgdGhpcy52aXpNaXhlci5jbGlwQWN0aW9uKGNsaXApLnBsYXkoKTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBzcGF3bkFzc2V0ID0gKCkgPT4gewogICAgICAgICAgICBpZiAoIXRoaXMudml6R3JvdXApIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENsZWFyIHByZXZpb3VzCiAgICAgICAgICAgIHdoaWxlKHRoaXMudml6R3JvdXAuY2hpbGRyZW4ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgY2hpbGQgPSB0aGlzLnZpekdyb3VwLmNoaWxkcmVuWzBdOwogICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cC5yZW1vdmUoY2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnZpek1peGVyID0gbnVsbDsKICAgICAgICAgICAgY3VycmVudEFzc2V0ID0gbnVsbDsKCiAgICAgICAgICAgIGNvbnN0IHVybCA9IGFzc2V0c1tmb3JnZVN0YXRlLmFzc2V0TmFtZV07CiAgICAgICAgICAgIGlmICghdXJsKSByZXR1cm47CgogICAgICAgICAgICBjb25zb2xlLmxvZygiRm9yZ2U6IFNwYXduaW5nIiwgZm9yZ2VTdGF0ZS5hc3NldE5hbWUpOwoKICAgICAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKHVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHdlIGFyZSBzdGlsbCBpbiBmb3JnZSBtb2RlIGJlZm9yZSBhZGRpbmcKICAgICAgICAgICAgICAgIGlmICghZm9yZ2VTdGF0ZS5hY3RpdmUpIHJldHVybjsKCiAgICAgICAgICAgICAgICBjb25zdCBtb2RlbCA9IGdsdGYuc2NlbmU7CiAgICAgICAgICAgICAgICB0aGlzLnZpekdyb3VwLmFkZChtb2RlbCk7CiAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQgPSBtb2RlbDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVzZXQgbW9kZWwgdHJhbnNmb3JtIHJlbGF0aXZlIHRvIGdyb3VwCiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgbW9kZWwucm90YXRpb24uc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdXBkYXRlVHJhbnNmb3JtKCk7CgogICAgICAgICAgICAgICAgaWYgKGdsdGYuYW5pbWF0aW9ucyAmJiBnbHRmLmFuaW1hdGlvbnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudml6TWl4ZXIgPSBuZXcgVEhSRUUuQW5pbWF0aW9uTWl4ZXIobW9kZWwpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudml6Q2xpcHMgPSBnbHRmLmFuaW1hdGlvbnM7CiAgICAgICAgICAgICAgICAgICAgcGxheUFuaW1hdGlvbigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCB0b2dnbGVGb3JnZSA9IChpc0FjdGl2ZSkgPT4gewogICAgICAgICAgICBmb3JnZVN0YXRlLmFjdGl2ZSA9IGlzQWN0aXZlOwogICAgICAgICAgICB0aGlzLmdhbWUuaXNGb3JnZU1vZGUgPSBpc0FjdGl2ZTsgLy8gQ3JpdGljYWw6IFRlbGwgbWFpbi5qcyB0byBzdG9wIGdhbWUgbG9vcAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVG9nZ2xlIEdhbWUgVmlzaWJpbGl0eSAoSGlkZSBldmVyeXRoaW5nIGluIHRoZSBtYWluIGFyZW5hKQogICAgICAgICAgICBjb25zdCBnYW1lTGF5ZXIgPSBbdGhpcy5nYW1lLnRlYW1zLmhvbWUsIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LCB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbF07CiAgICAgICAgICAgIGdhbWVMYXllci5mb3JFYWNoKHQgPT4gewogICAgICAgICAgICAgICAgaWYodCAmJiB0LnBsYXllcnMpIHQucGxheWVycy5mb3JFYWNoKHAgPT4geyBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gIWlzQWN0aXZlOyB9KTsKICAgICAgICAgICAgICAgIGVsc2UgaWYodCAmJiB0Lm1lc2gpIHQubWVzaC52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYod2luZG93LmZsdXguYXJlbmFNZXNoKSB3aW5kb3cuZmx1eC5hcmVuYU1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYod2luZG93LmZsdXguYXJlbmFNZXNoMikgd2luZG93LmZsdXguYXJlbmFNZXNoMi52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICBpZih0aGlzLmdhbWUuc3RhZGl1bSAmJiB0aGlzLmdhbWUuc3RhZGl1bS5jb250YWluZXIpIHRoaXMuZ2FtZS5zdGFkaXVtLmNvbnRhaW5lci52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICBpZih0aGlzLmdhbWUud2F0ZXJPdmVybGF5ICYmIHRoaXMuZ2FtZS53YXRlck92ZXJsYXkubWVzaCkgdGhpcy5nYW1lLndhdGVyT3ZlcmxheS5tZXNoLnZpc2libGUgPSAhaXNBY3RpdmU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIaWRlIFVJCiAgICAgICAgICAgIGNvbnN0IHVpID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJyk7CiAgICAgICAgICAgIGlmKHVpKSB1aS5zdHlsZS5kaXNwbGF5ID0gaXNBY3RpdmUgPyAnbm9uZScgOiAnZmxleCc7CgogICAgICAgICAgICBpZiAoaXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgIC8vIEluaXRpYWxpemUgRm9yZ2UgU2NlbmUgaWYgbmVlZGVkCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMudml6R3JvdXBQYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekdyb3VwUGFyZW50ID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZCh0aGlzLnZpekdyb3VwUGFyZW50KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekdyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cC5wb3NpdGlvbi5zZXQoMTAwMCwgMCwgMTAwMCk7IC8vIEZhciBhd2F5IGZyb20gYXJlbmEKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekdyb3VwUGFyZW50LmFkZCh0aGlzLnZpekdyb3VwKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ3JpZCA9IG5ldyBUSFJFRS5HcmlkSGVscGVyKDIwLCAyMCwgMHgwMGZmZmYsIDB4NDQ0NDQ0KTsKICAgICAgICAgICAgICAgICAgICBncmlkLnBvc2l0aW9uLnNldCgxMDAwLCAwLCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekdyb3VwUGFyZW50LmFkZChncmlkKTsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpMaWdodCA9IG5ldyBUSFJFRS5EaXJlY3Rpb25hbExpZ2h0KDB4ZmZmZmZmLCAxLjApOwogICAgICAgICAgICAgICAgICAgIHRoaXMudml6TGlnaHQucG9zaXRpb24uc2V0KDEwMDUsIDEwLCAxMDA1KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKHRoaXMudml6TGlnaHQpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMudml6QW1iaWVudCA9IG5ldyBUSFJFRS5BbWJpZW50TGlnaHQoMHg0MDQwNDApOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy52aXpBbWJpZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudml6TGlnaHQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnZpekFtYmllbnQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNwYXduQXNzZXQoKTsKICAgICAgICAgICAgICAgIHVwZGF0ZUNhbWVyYSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBSZXN0b3JlIEdhbWUKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZpekdyb3VwUGFyZW50KSB0aGlzLnZpekdyb3VwUGFyZW50LnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZpekxpZ2h0KSB0aGlzLnZpekxpZ2h0LnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZpekFtYmllbnQpIHRoaXMudml6QW1iaWVudC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNuYXAgY2FtZXJhIGJhY2sgdG8gZ2FtZSB0YXJnZXQKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FtZXJhTWFuYWdlcikgdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmb2xkZXIuYWRkKGZvcmdlU3RhdGUsICdhY3RpdmUnKS5uYW1lKCdFbmFibGUgRm9yZ2UnKS5vbkNoYW5nZSh0b2dnbGVGb3JnZSk7CiAgICAgICAgZm9sZGVyLmFkZChmb3JnZVN0YXRlLCAnYXNzZXROYW1lJywgT2JqZWN0LmtleXMoYXNzZXRzKSkubmFtZSgnU2VsZWN0IEFzc2V0Jykub25DaGFuZ2Uoc3Bhd25Bc3NldCk7CiAgICAgICAgCiAgICAgICAgY29uc3QgdGYgPSBmb2xkZXIuYWRkRm9sZGVyKCdUcmFuc2Zvcm0nKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3Bvc1gnLCAtNSwgNSkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3Bvc1knLCAtNSwgNSkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3Bvc1onLCAtNSwgNSkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3JvdFgnLCAwLCA2LjI4KS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwogICAgICAgIHRmLmFkZChmb3JnZVN0YXRlLCAncm90WScsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdyb3RaJywgMCwgNi4yOCkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3NjYWxlJywgMC4xLCAzLjApLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CgogICAgICAgIGZvbGRlci5hZGQoZm9yZ2VTdGF0ZSwgJ2FuaW1OYW1lJywgWydub25lJywgJ2lkbGUnLCAnc3dpbScsICd0aHJvdycsICdjYXRjaCcsICdyZWFjdCddKS5uYW1lKCdBbmltYXRpb24nKS5vbkNoYW5nZShwbGF5QW5pbWF0aW9uKTsKCiAgICAgICAgY29uc3QgY2YgPSBmb2xkZXIuYWRkRm9sZGVyKCdDYW1lcmEnKTsKICAgICAgICBjZi5hZGQoZm9yZ2VTdGF0ZSwgJ2NhbURpc3QnLCAyLCAxNSkub25DaGFuZ2UodXBkYXRlQ2FtZXJhKTsKICAgICAgICBjZi5hZGQoZm9yZ2VTdGF0ZSwgJ2NhbUhlaWdodCcsIDAsIDEwKS5vbkNoYW5nZSh1cGRhdGVDYW1lcmEpOwogICAgICAgIGNmLmFkZChmb3JnZVN0YXRlLCAnY2FtUm90JywgMCwgNi4yOCkub25DaGFuZ2UodXBkYXRlQ2FtZXJhKTsKCiAgICAgICAgLy8gSG9vayBHYW1lIExvb3AKICAgICAgICBjb25zdCBvcmlnaW5hbFVwZGF0ZSA9IHRoaXMuZ2FtZS51cGRhdGUuYmluZCh0aGlzLmdhbWUpOwogICAgICAgIHRoaXMuZ2FtZS51cGRhdGUgPSAoZHQpID0+IHsKICAgICAgICAgICAgaWYgKGZvcmdlU3RhdGUuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBGb3JnZSBNb2RlOiBPbmx5IHVwZGF0ZSBmb3JnZSBjb21wb25lbnRzIGFuZCByZW5kZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZpek1peGVyKSB0aGlzLnZpek1peGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZvcmNlIENhbWVyYSBVcGRhdGUgaGVyZSBzaW5jZSBtYWluLmpzIGxvb3AgaXMgc2tpcHBlZAogICAgICAgICAgICAgICAgdXBkYXRlQ2FtZXJhKCk7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5yZW5kZXJlciAmJiB0aGlzLmdhbWUuc2NlbmUgJiYgdGhpcy5nYW1lLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5yZW5kZXJlci5yZW5kZXIodGhpcy5nYW1lLnNjZW5lLCB0aGlzLmdhbWUuY2FtZXJhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE5vcm1hbCBNb2RlOiBSdW4gc3RhbmRhcmQgZ2FtZSB1cGRhdGUKICAgICAgICAgICAgICAgIG9yaWdpbmFsVXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9Owp9KSgpOw==","/DevTools.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFRvb2x0aXAgRGVzY3JpcHRpb25zIGZvciBMb25nLVByZXNzCiAgICBjb25zdCBUT09MVElQX0RFU0NSSVBUSU9OUyA9IHsKICAgICAgICAnU1VCU1RFUFMnOiAiUGh5c2ljcyBpdGVyYXRpb25zIHBlciBmcmFtZS4gSGlnaGVyID0gbW9yZSBzdGFibGUsIG1vcmUgQ1BVLiIsCiAgICAgICAgJ1NUT1BfU1BFRUQnOiAiVmVsb2NpdHkgdGhyZXNob2xkIGJlbG93IHdoaWNoIHRoZSBiYWxsIHNuYXBzIHRvIGEgaGFsdC4iLAogICAgICAgICdXQVRFUl9EUkFHX0xJTkVBUic6ICJCYXNlIHdhdGVyIHJlc2lzdGFuY2UuIFNsb3dzIGJhbGwgbGluZWFybHkuIiwKICAgICAgICAnV0FURVJfRFJBR19RVUFEJzogIlF1YWRyYXRpYyBkcmFnLiBTbG93cyBoaWdoLXNwZWVkIGJhbGxzIHNpZ25pZmljYW50bHkuIiwKICAgICAgICAnU1BJTl9EUkFHJzogIkhvdyBmYXN0IHRoZSBiYWxsJ3Mgc3BpbiBkZWNheXMgb3ZlciB0aW1lLiIsCiAgICAgICAgJ01BR05VU19FTkFCTEVEJzogIkVuYWJsZXMgdGhlIE1hZ251cyBlZmZlY3QgKGN1cnZlIGZyb20gc3BpbikuIiwKICAgICAgICAnTUFHTlVTX0NPRUZGJzogIlN0cmVuZ3RoIG9mIHRoZSBjdXJ2ZSBmb3JjZSByZWxhdGl2ZSB0byBzcGluL3NwZWVkLiIsCiAgICAgICAgJ01BR05VU19DQVAnOiAiTWF4aW11bSBjdXJ2ZSBmb3JjZSBhbGxvd2VkIChwcmV2ZW50cyBwaHlzaWNzIGV4cGxvc2lvbnMpLiIsCiAgICAgICAgJ0RFUFRIX1RBUkdFVF9ZJzogIklkZWFsIFkgaGVpZ2h0IHRoZSBiYWxsIHRyaWVzIHRvIGZsb2F0IGF0LiIsCiAgICAgICAgJ0RFUFRIX1NQUklORyc6ICJTdHJlbmd0aCBvZiB0aGUgZm9yY2UgcHVsbGluZyBiYWxsIHRvIFRhcmdldCBZLiIsCiAgICAgICAgJ0RFUFRIX0RBTVAnOiAiRGFtcGluZyBvbiB2ZXJ0aWNhbCBtb3ZlbWVudCB0byBwcmV2ZW50IG9zY2lsbGF0aW9uLiIsCiAgICAgICAgJ0JPVU5EQVJZX1JBRElVUyc6ICJSYWRpdXMgb2YgdGhlIGNpcmN1bGFyIGFyZW5hIHdhbGwuIiwKICAgICAgICAnQk9VTkRBUllfSEVJR0hUJzogIkhlaWdodCBvZiB0aGUgYXJlbmEgY2VpbGluZy9mbG9vci4iLAogICAgICAgICdXQUxMX1NPRlRfQlVGRkVSJzogIkRpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMuIiwKICAgICAgICAnV0FMTF9TT0ZUX0ZPUkNFJzogIkZvcmNlIHB1c2hpbmcgYmFsbCBhd2F5IGZyb20gd2FsbCBiZWZvcmUgaW1wYWN0LiIsCiAgICAgICAgJ1dBTExfRUxBU1RJQ0lUWSc6ICJCb3VuY2luZXNzIG9mIHRoZSB3YWxsICgwID0gZGVhZCB0aHVkLCAxID0gcGVyZmVjdCBib3VuY2UpLiIsCiAgICAgICAgJ1dBTExfRlJJQ1RJT04nOiAiRnJpY3Rpb24gd2hlbiBzbGlkaW5nIGFsb25nIHRoZSB3YWxsLiIsCiAgICAgICAgJ0ZMT09SX0VMQVNUSUNJVFknOiAiQm91bmNpbmVzcyBvZiB0aGUgZmxvb3IvY2VpbGluZy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9FTkFCTEVEJzogIkVuYWJsZXMgdGhlIGV4dGVuZGVkIGNvcnJpZG9yIGZvciB0aGUgZ29hbC4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9YJzogIkhhbGYtd2lkdGggb2YgdGhlIGdvYWwgcG9ja2V0IGNvcnJpZG9yLiIsCiAgICAgICAgJ0dPQUxfUE9DS0VUX1onOiAiWi1kZXB0aCB3aGVyZSB0aGUgcG9ja2V0IHN0YXJ0cy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9SQURJVVMnOiAiRWZmZWN0aXZlIHJhZGl1cyBpbnNpZGUgdGhlIHBvY2tldC4iLAogICAgICAgICdMQVVOQ0hfU1BFRURfU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBTdGF0IFBvd2VyIHRvIFBoeXNpY3MgVmVsb2NpdHkuIiwKICAgICAgICAnTEFVTkNIX1NQRUVEX0NBUCc6ICJNYXhpbXVtIHBoeXNpY2FsIHNwZWVkIHRoZSBiYWxsIGNhbiBiZSB0aHJvd24uIiwKICAgICAgICAnU1dJUEVfTUlOX1BYJzogIk1pbmltdW0gc3dpcGUgZGlzdGFuY2UgdG8gcmVnaXN0ZXIgYSB0aHJvdy4iLAogICAgICAgICdBSU1fRFhfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgaG9yaXpvbnRhbCBhaW0gZnJvbSBzd2lwZS4iLAogICAgICAgICdBSU1fRFlfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgdmVydGljYWwgYWltIGZyb20gc3dpcGUuIiwKICAgICAgICAnUE9XRVJfQkFTRSc6ICJCYXNlIHBvd2VyIG11bHRpcGxpZXIgZm9yIGEgcXVpY2sgdGFwLiIsCiAgICAgICAgJ1BPV0VSX1JBTkdFJzogIkFkZGl0aW9uYWwgcG93ZXIgbXVsdGlwbGllciBhdCBmdWxsIGNoYXJnZS4iLAogICAgICAgICdQT1dFUl9NQVhfQk9OVVNfUkFUSU8nOiAiQ2hhcmdlIHRocmVzaG9sZCBmb3IgJ01heCBQb3dlcicgYm9udXMuIiwKICAgICAgICAnUE9XRVJfTUFYX01VTFRJUExJRVInOiAiTXVsdGlwbGllciBhcHBsaWVkIHdoZW4gaGl0dGluZyBNYXggUG93ZXIuIiwKICAgICAgICAnQ1VSVkVfRU5BQkxFRCc6ICJFbmFibGVzIGN1cnZlIHNob3RzIHZpYSBjdXJ2ZWQgc3dpcGVzLiIsCiAgICAgICAgJ0NVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQnOiAiSG93IGN1cnZlZCBhIHN3aXBlIG11c3QgYmUgdG8gdHJpZ2dlciBzcGluLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBzd2lwZSBjdXJ2ZSB0byBiYWxsIHNwaW4uIiwKICAgICAgICAnQ1VSVkVfU1BFRURfTVVMVCc6ICJNdWx0aXBsaWVyIGZvciBzcGluIGJhc2VkIG9uIHN3aXBlIHNwZWVkLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fQ0FQJzogIk1heGltdW0gc3BpbiBhbGxvd2VkIGZyb20gYSBjdXJ2ZSB0aHJvdy4iLAogICAgICAgICdDVVJWRV9QRVJGRUNUX1NQSU4nOiAiU3BpbiB0aHJlc2hvbGQgdG8gdHJpZ2dlciAnUGVyZmVjdCBDdXJ2ZScgRlguIiwKICAgICAgICAndGltZVNjYWxlJzogIkdsb2JhbCBnYW1lIHNwZWVkIG11bHRpcGxpZXIuIiwKICAgICAgICAnZGVtb01vZGUnOiAiVG9nZ2xlIEFJIHZzIEFJIGF1dG8tcGxheS4iLAogICAgICAgICdyZXNvbHV0aW9uJzogIkludGVybmFsIHJlbmRlciByZXNvbHV0aW9uIHNjYWxlICgwLjUgPSBoYWxmIHJlcykuIiwKICAgICAgICAnYXJlbmFPcGFjaXR5JzogIk9wYWNpdHkgb2YgdGhlIG91dGVyIGFyZW5hIGdyaWQuIiwKICAgICAgICAnYXJlbmEyT3BhY2l0eSc6ICJPcGFjaXR5IG9mIHRoZSBpbm5lciBoZXggZ3JpZC4iCiAgICB9OwoKICAgIGNsYXNzIERldlRvb2xzIHsKICAgICAgICBjb25zdHJ1Y3RvcihnYW1lTWFuYWdlcikgewogICAgICAgICAgICB0aGlzLmdhbWUgPSBnYW1lTWFuYWdlcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIGxpbC1ndWkgYXR0YWNoZXMgdG8gd2luZG93LmxpbCBieSBkZWZhdWx0IGluIFVNRCBidWlsZAogICAgICAgICAgICBpZiAoIXdpbmRvdy5saWwgfHwgIXdpbmRvdy5saWwuR1VJKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkRldlRvb2xzOiBsaWwtZ3VpIG5vdCBmb3VuZC4iKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dhbWUtY29udGFpbmVyJyk7CiAgICAgICAgICAgIHRoaXMuZ3VpID0gbmV3IHdpbmRvdy5saWwuR1VJKHsgdGl0bGU6ICdGbHV4IERldlRvb2xzJywgY29udGFpbmVyOiBjb250YWluZXIgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQb3NpdGlvbiBhcyBhIGNvbGxhcHNlZCB0YWIgb24gdGhlIHJpZ2h0IGZyYW1lCi8vIFBvc2l0aW9uIGFzIGEgc2xpZGluZyB0YWIgb24gdGhlIHJpZ2h0IGZyYW1lCi8vIFBvc2l0aW9uIGFzIGEgc2xpZGluZyB0YWIgb24gdGhlIHJpZ2h0IGZyYW1lCi8vIFdyYXBwZXIgZm9yIHNsaWRpbmcgYW5pbWF0aW9uCiAgICAgICAgICAgIGNvbnN0IHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUudG9wID0gJzEwMHB4JzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5yaWdodCA9ICctMjYwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLndpZHRoID0gJzI2MHB4JzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS50cmFuc2l0aW9uID0gJ3JpZ2h0IDAuM3MgY3ViaWMtYmV6aWVyKDAuMiwgMC44LCAwLjIsIDEuMCknOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnpJbmRleCA9ICc5OTk5JzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLmZsZXhEaXJlY3Rpb24gPSAnY29sdW1uJzsKICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHdyYXBwZXIpOwoKICAgICAgICAgICAgY29uc3QgZG9tID0gdGhpcy5ndWkuZG9tRWxlbWVudDsKICAgICAgICAgICAgZG9tLnN0eWxlLndpZHRoID0gJzEwMCUnOwogICAgICAgICAgICBkb20uc3R5bGUuc2V0UHJvcGVydHkoJy0td2lkdGgnLCAnMTAwJScpOwogICAgICAgICAgICBkb20uc3R5bGUubWF4SGVpZ2h0ID0gJzgwdmgnOwogICAgICAgICAgICBkb20uc3R5bGUub3ZlcmZsb3dZID0gJ2F1dG8nOwogICAgICAgICAgICBkb20uc3R5bGUub3ZlcmZsb3dYID0gJ2hpZGRlbic7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNb3ZlIEdVSSBpbnRvIHdyYXBwZXIKICAgICAgICAgICAgd3JhcHBlci5hcHBlbmRDaGlsZChkb20pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ3JlYXRlIFRvZ2dsZSBIYW5kbGUKICAgICAgICAgICAgY29uc3QgaGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5sZWZ0ID0gJy00MHB4JzsgLy8gUHJvdHJ1ZGUgdG8gdGhlIGxlZnQKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLnRvcCA9ICcwJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLndpZHRoID0gJzQwcHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuaGVpZ2h0ID0gJzQwcHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gJ3JnYmEoMCwgMjAsIDQwLCAwLjkpJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlciA9ICcxcHggc29saWQgIzAwZmZmZic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5ib3JkZXJSaWdodCA9ICdub25lJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlclRvcExlZnRSYWRpdXMgPSAnOHB4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlckJvdHRvbUxlZnRSYWRpdXMgPSAnOHB4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmN1cnNvciA9ICdwb2ludGVyJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5qdXN0aWZ5Q29udGVudCA9ICdjZW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYWxpZ25JdGVtcyA9ICdjZW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuY29sb3IgPSAnIzAwZmZmZic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5mb250U2l6ZSA9ICcyMHB4JzsKICAgICAgICAgICAgaGFuZGxlLmlubmVySFRNTCA9ICfimpknOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm94U2hhZG93ID0gJy01cHggMCAxMHB4IHJnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgICAgIAogICAgICAgICAgICB3cmFwcGVyLmFwcGVuZENoaWxkKGhhbmRsZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUb2dnbGUgTG9naWMKICAgICAgICAgICAgbGV0IGlzT3BlbiA9IGZhbHNlOwogICAgICAgICAgICBoYW5kbGUuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsgLy8gUHJldmVudCBnYW1lIGlucHV0cwogICAgICAgICAgICAgICAgaXNPcGVuID0gIWlzT3BlbjsKICAgICAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUucmlnaHQgPSBpc09wZW4gPyAnMHB4JyA6ICctMjYwcHgnOwogICAgICAgICAgICAgICAgaGFuZGxlLmlubmVySFRNTCA9IGlzT3BlbiA/ICfCuycgOiAn4pqZJzsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIERlZmF1bHQgZ2xvYmFsIHRpbWVTY2FsZSBpZiBub3Qgc2V0CmlmICh3aW5kb3cuZmx1eC50aW1lU2NhbGUgPT09IHVuZGVmaW5lZCkgd2luZG93LmZsdXgudGltZVNjYWxlID0gMC44OwoKdGhpcy5fc2V0dXBHZW5lcmFsKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwQ29udHJvbHNGZWVsKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwR2FtZVN0YXRlKCk7CnRoaXMuX3NldHVwT3ZlcmxheXMoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBUZWFtcygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFBsYXllckluc3BlY3RvcigpOwogICAgICAgICAgICB0aGlzLl9zZXR1cEJhbGxTYW5kYm94KCk7CnRoaXMuX3NldHVwRlhMYWIoKTsKdGhpcy5fc2V0dXBGWExhYigpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFZpc3VhbHMoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBUb29sdGlwcygpOwogICAgICAgIH0KCiAgICAgICAgX3NldHVwVG9vbHRpcHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBUb29sdGlwIERPTQogICAgICAgICAgICB0aGlzLnRvb2x0aXBFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMudG9vbHRpcEVsLnN0eWxlLCB7CiAgICAgICAgICAgICAgICBwb3NpdGlvbjogJ2ZpeGVkJywKICAgICAgICAgICAgICAgIHRvcDogJzUwJScsCiAgICAgICAgICAgICAgICBsZWZ0OiAnNTAlJywKICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogJ3RyYW5zbGF0ZSgtNTAlLCAtNTAlKScsCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICdyZ2JhKDAsIDEwLCAzMCwgMC45NSknLAogICAgICAgICAgICAgICAgYm9yZGVyOiAnMnB4IHNvbGlkICMwMGZmZmYnLAogICAgICAgICAgICAgICAgcGFkZGluZzogJzIwcHgnLAogICAgICAgICAgICAgICAgY29sb3I6ICcjZmZmJywKICAgICAgICAgICAgICAgIGZvbnRGYW1pbHk6ICdtb25vc3BhY2UnLAogICAgICAgICAgICAgICAgZm9udFNpemU6ICcxNHB4JywKICAgICAgICAgICAgICAgIG1heFdpZHRoOiAnMzAwcHgnLAogICAgICAgICAgICAgICAgekluZGV4OiAnMTAwMDAnLAogICAgICAgICAgICAgICAgZGlzcGxheTogJ25vbmUnLAogICAgICAgICAgICAgICAgcG9pbnRlckV2ZW50czogJ25vbmUnLAogICAgICAgICAgICAgICAgYm94U2hhZG93OiAnMCAwIDIwcHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKScsCiAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6ICc4cHgnLAogICAgICAgICAgICAgICAgdGV4dEFsaWduOiAnY2VudGVyJwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLnRvb2x0aXBFbCk7CgogICAgICAgICAgICAvLyBSZWN1cnNpdmUgZnVuY3Rpb24gdG8gYXR0YWNoIGxpc3RlbmVycwogICAgICAgICAgICBjb25zdCBhdHRhY2ggPSAoZ3VpKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBDb250cm9sbGVycwogICAgICAgICAgICAgICAgaWYgKGd1aS5jb250cm9sbGVycykgewogICAgICAgICAgICAgICAgICAgIGd1aS5jb250cm9sbGVycy5mb3JFYWNoKGMgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkb20gPSBjLmRvbUVsZW1lbnQuY2xvc2VzdCgnLmNvbnRyb2xsZXInKTsgLy8gbGlsLWd1aSBzdHJ1Y3R1cmUKICAgICAgICAgICAgICAgICAgICAgICAgaWYoZG9tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IGRvbS5xdWVyeVNlbGVjdG9yKCcubmFtZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobGFiZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hZGRMb25nUHJlc3MobGFiZWwsIGMucHJvcGVydHksIGMuX25hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBTdWItZm9sZGVycwogICAgICAgICAgICAgICAgaWYoZ3VpLmZvbGRlcnMpIHsKICAgICAgICAgICAgICAgICAgICBndWkuZm9sZGVycy5mb3JFYWNoKGYgPT4gYXR0YWNoKGYpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFdhaXQgYSB0aWNrIGZvciBHVUkgdG8gZnVsbHkgcmVuZGVyIERPTQogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGF0dGFjaCh0aGlzLmd1aSksIDEwMCk7CiAgICAgICAgfQoKICAgICAgICBfYWRkTG9uZ1ByZXNzKGVsZW1lbnQsIHByb3BlcnR5LCBuYW1lKSB7CiAgICAgICAgICAgIGxldCB0aW1lciA9IG51bGw7CiAgICAgICAgICAgIGNvbnN0IGR1cmF0aW9uID0gNTAwOyAvLyAwLjVzCgogICAgICAgICAgICBjb25zdCBzdGFydCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dUb29sdGlwKHByb3BlcnR5LCBuYW1lKTsKICAgICAgICAgICAgICAgIH0sIGR1cmF0aW9uKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGNvbnN0IGVuZCA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGlmKHRpbWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTsKICAgICAgICAgICAgICAgICAgICB0aW1lciA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9oaWRlVG9vbHRpcCgpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBzdGFydCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHN0YXJ0LCB7cGFzc2l2ZTogdHJ1ZX0pOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgZW5kKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgZW5kKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGVuZCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCBlbmQpOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dUb29sdGlwKHByb3AsIG5hbWUpIHsKICAgICAgICAgICAgY29uc3QgZGVzYyA9IFRPT0xUSVBfREVTQ1JJUFRJT05TW3Byb3BdOwogICAgICAgICAgICBpZihkZXNjKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRvb2x0aXBFbC5pbm5lckhUTUwgPSBgPHN0cm9uZyBzdHlsZT0iY29sb3I6IzAwZmZmZjsgZm9udC1zaXplOjE2cHg7Ij4ke25hbWUgfHwgcHJvcH08L3N0cm9uZz48YnI+PGJyPiR7ZGVzY31gOwogICAgICAgICAgICAgICAgdGhpcy50b29sdGlwRWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9oaWRlVG9vbHRpcCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudG9vbHRpcEVsKSB0aGlzLnRvb2x0aXBFbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KCgpfc2V0dXBHZW5lcmFsKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0dlbmVyYWwnKTsKICAgICAgICAgICAgCmNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIHRpbWVTY2FsZTogd2luZG93LmZsdXgudGltZVNjYWxlLAogICAgICAgICAgICAgICAgZGVtb01vZGU6IHRoaXMuZ2FtZS5pc0RlbW9Nb2RlLAogICAgICAgICAgICAgICAgdG9nZ2xlSFVEOiB0cnVlLAogICAgICAgICAgICAgICAgcmVzb2x1dGlvbjogMC41MCwKYXJlbmFPcGFjaXR5OiAwLjMsCiAgICAgICAgICAgICAgICBhcmVuYTJPcGFjaXR5OiAwLjI1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3RpbWVTY2FsZScsIDAuMCwgNS4wKS5uYW1lKCdHYW1lIFNwZWVkJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSB2OwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZGVtb01vZGUnKS5uYW1lKCdEZW1vIE1vZGUnKS5saXN0ZW4oKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuaXNEZW1vTW9kZSAhPT0gdikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS50b2dnbGVEZW1vTW9kZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndG9nZ2xlSFVEJykubmFtZSgnU2hvdyBIVUQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGh1ZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpOwogICAgICAgICAgICAgICAgaWYgKGh1ZCkgewogICAgICAgICAgICAgICAgICAgIGh1ZC5zdHlsZS52aXNpYmlsaXR5ID0gdiA/ICd2aXNpYmxlJyA6ICdoaWRkZW4nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAncmVzb2x1dGlvbicsIDAuMSwgMi4wKS5uYW1lKCdSZXNvbHV0aW9uIFNjYWxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB3ID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBoID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgY29uc3QgcmVuZGVyZXIgPSB0aGlzLmdhbWUucmVuZGVyZXI7CiAgICAgICAgICAgICAgICBpZiAocmVuZGVyZXIpIHsKICAgICAgICAgICAgICAgICAgICByZW5kZXJlci5zZXRTaXplKHcgKiB2LCBoICogdiwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCmZvbGRlci5hZGQocGFyYW1zLCAnYXJlbmFPcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ0FyZW5hIDEgT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IHY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYmxlbmRNb2RlcyA9IHsKICAgICAgICAgICAgICAgICdOb3JtYWwnOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywKICAgICAgICAgICAgICAgICdBZGRpdGl2ZSc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnTXVsdGlwbHknOiBUSFJFRS5NdWx0aXBseUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICdOb0JsZW5kaW5nJzogVEhSRUUuTm9CbGVuZGluZwogICAgICAgICAgICB9OwpwYXJhbXMuYXJlbmFCbGVuZCA9ICdOb3JtYWwnOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYUJsZW5kJywgT2JqZWN0LmtleXMoYmxlbmRNb2RlcykpLm5hbWUoJ0FyZW5hIDEgQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2ggJiYgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsLmJsZW5kaW5nID0gYmxlbmRNb2Rlc1t2XTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEFyZW5hIDIgQ29udHJvbHMKZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYTJPcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ0FyZW5hIDIgT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIgJiYgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eS52YWx1ZSA9IHY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKcGFyYW1zLmFyZW5hMkJsZW5kID0gJ0FkZGl0aXZlJzsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYTJCbGVuZCcsIE9iamVjdC5rZXlzKGJsZW5kTW9kZXMpKS5uYW1lKCdBcmVuYSAyIEJsZW5kJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoMiAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC5ibGVuZGluZyA9IGJsZW5kTW9kZXNbdl07CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgZGVmYXVsdHMKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gcGFyYW1zLmFyZW5hT3BhY2l0eTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoMiAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLm9wYWNpdHkgPSBwYXJhbXMuYXJlbmEyT3BhY2l0eTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3NldHVwQ29udHJvbHNGZWVsKCkgewogICAgICAgICAgICBjb25zdCBkZWJ1Z0lPID0gKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPKSA/IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIDogbnVsbDsKICAgICAgICAgICAgaWYgKCFkZWJ1Z0lPIHx8ICFkZWJ1Z0lPLnNldHRpbmdzKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBzID0gZGVidWdJTy5zZXR0aW5nczsKCiAgICAgICAgICAgIC8vIEVuc3VyZSBkZWZhdWx0cyBleGlzdCAob2xkZXIgcHJvamVjdHMgbWF5IG5vdCBoYXZlIHRoZXNlIGtleXMgeWV0KQogICAgICAgICAgICBpZiAocy5wYXNzQWltQXNzaXN0ID09PSB1bmRlZmluZWQpIHMucGFzc0FpbUFzc2lzdCA9IDAuNjU7CiAgICAgICAgICAgIGlmIChzLnNob3RBaW1Bc3Npc3QgPT09IHVuZGVmaW5lZCkgcy5zaG90QWltQXNzaXN0ID0gMC4zNTsKICAgICAgICAgICAgaWYgKHMuY2F0Y2hBc3Npc3QgPT09IHVuZGVmaW5lZCkgcy5jYXRjaEFzc2lzdCA9IDAuNTU7CiAgICAgICAgICAgIGlmIChzLnN0ZWVyaW5nQXNzaXN0ID09PSB1bmRlZmluZWQpIHMuc3RlZXJpbmdBc3Npc3QgPSAwLjM1OwogICAgICAgICAgICBpZiAocy5pbnB1dFJlc3BvbnNlID09PSB1bmRlZmluZWQpIHMuaW5wdXRSZXNwb25zZSA9IDE0LjA7CiAgICAgICAgICAgIGlmIChzLnByZWRpY3RpdmVDYXRjaFRpbWUgPT09IHVuZGVmaW5lZCkgcy5wcmVkaWN0aXZlQ2F0Y2hUaW1lID0gMC4xMjsKCiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignQ29udHJvbHMgJiBGZWVsJyk7CgogICAgICAgICAgICAvLyBDb3JlIHRvZ2dsZXMKICAgICAgICAgICAgZm9sZGVyLmFkZChzLCAnam95c3RpY2tTZW5zaXRpdml0eScsIDAuMywgMi4wLCAwLjAxKS5uYW1lKCdNb3ZlIFNlbnNpdGl2aXR5Jyk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocywgJ2ludmVydENhbWVyYScpLm5hbWUoJ0ludmVydCBDYW1lcmEnKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChzLCAnYXV0b1JlY2VudGVyJykubmFtZSgnQXV0byBSZWNlbnRlcicpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHMsICdhaW1Bc3Npc3QnKS5uYW1lKCdBaW0gQXNzaXN0Jyk7CgogICAgICAgICAgICAvLyBBc3Npc3QgbGF5ZXIgKDAuLjEpCiAgICAgICAgICAgIGNvbnN0IGEgPSBmb2xkZXIuYWRkRm9sZGVyKCdBc3Npc3QgU3RyZW5ndGhzJyk7CiAgICAgICAgICAgIGEuYWRkKHMsICdwYXNzQWltQXNzaXN0JywgMC4wLCAxLjAsIDAuMDEpLm5hbWUoJ1Bhc3MgQXNzaXN0Jyk7CiAgICAgICAgICAgIGEuYWRkKHMsICdzaG90QWltQXNzaXN0JywgMC4wLCAxLjAsIDAuMDEpLm5hbWUoJ1Nob3QgQXNzaXN0Jyk7CiAgICAgICAgICAgIGEuYWRkKHMsICdjYXRjaEFzc2lzdCcsIDAuMCwgMS4wLCAwLjAxKS5uYW1lKCdDYXRjaCBBc3Npc3QnKTsKICAgICAgICAgICAgYS5hZGQocywgJ3N0ZWVyaW5nQXNzaXN0JywgMC4wLCAxLjAsIDAuMDEpLm5hbWUoJ1N0ZWVyaW5nIEFzc2lzdCcpOwoKICAgICAgICAgICAgY29uc3QgZiA9IGZvbGRlci5hZGRGb2xkZXIoJ1Jlc3BvbnNpdmVuZXNzJyk7CiAgICAgICAgICAgIGYuYWRkKHMsICdpbnB1dFJlc3BvbnNlJywgNC4wLCAyNC4wLCAwLjEpLm5hbWUoJ0lucHV0IFJlc3BvbnNlJyk7CiAgICAgICAgICAgIGYuYWRkKHMsICdwcmVkaWN0aXZlQ2F0Y2hUaW1lJywgMC4wLCAwLjM1LCAwLjAxKS5uYW1lKCdQcmVkaWN0IENhdGNoIChzKScpOwogICAgICAgIH0KCgpfc2V0dXBPdmVybGF5cygpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdPdmVybGF5cyAmIEZYJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAxLiBHSUYgT3ZlcmxheQogICAgICAgICAgICBjb25zdCBnaWZFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzY3JlZW4tb3ZlcmxheS1naWYnKTsKICAgICAgICAgICAgaWYgKGdpZkVsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnaWZQYXJhbXMgPSB7CiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogdHJ1ZSwKb3BhY2l0eTogMC42MiwKICAgICAgICAgICAgICAgICAgICBibGVuZDogJ292ZXJsYXknCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBnRm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignU2NyZWVuIEdJRicpOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAndmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gZ2lmRWwuc3R5bGUuZGlzcGxheSA9IHYgPyAnYmxvY2snIDogJ25vbmUnKTsKICAgICAgICAgICAgICAgIGdGb2xkZXIuYWRkKGdpZlBhcmFtcywgJ29wYWNpdHknLCAwLjAsIDEuMCkub25DaGFuZ2UodiA9PiBnaWZFbC5zdHlsZS5vcGFjaXR5ID0gdik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGJsZW5kTW9kZXMgPSBbCiAgICAgICAgICAgICAgICAgICAgJ25vcm1hbCcsICdtdWx0aXBseScsICdzY3JlZW4nLCAnb3ZlcmxheScsIAogICAgICAgICAgICAgICAgICAgICdkYXJrZW4nLCAnbGlnaHRlbicsICdjb2xvci1kb2RnZScsICdjb2xvci1idXJuJywgCiAgICAgICAgICAgICAgICAgICAgJ2hhcmQtbGlnaHQnLCAnc29mdC1saWdodCcsICdkaWZmZXJlbmNlJywgJ2V4Y2x1c2lvbicsIAogICAgICAgICAgICAgICAgICAgICdodWUnLCAnc2F0dXJhdGlvbicsICdjb2xvcicsICdsdW1pbm9zaXR5JwogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgIGdGb2xkZXIuYWRkKGdpZlBhcmFtcywgJ2JsZW5kJywgYmxlbmRNb2Rlcykub25DaGFuZ2UodiA9PiBnaWZFbC5zdHlsZS5taXhCbGVuZE1vZGUgPSB2KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gV2F0ZXIgT3ZlcmxheQogICAgICAgICAgICBjb25zdCB3byA9IHRoaXMuZ2FtZS53YXRlck92ZXJsYXk7CiAgICAgICAgICAgIGlmICh3byAmJiB3by5tZXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCB3Rm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignV2F0ZXIgU2hhZGVyJyk7CiAgICAgICAgICAgICAgICBjb25zdCB3UGFyYW1zID0geyAKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHdvLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5ID8gd28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkudmFsdWUgOiAwLjUsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdBZGRpdGl2ZScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHdGb2xkZXIuYWRkKHdQYXJhbXMsICd2aXNpYmxlJykub25DaGFuZ2UodiA9PiB3by5tZXNoLnZpc2libGUgPSB2KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHdvLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ29wYWNpdHknLCAwLjAsIDIuMCkub25DaGFuZ2UodiA9PiB3by5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eS52YWx1ZSA9IHYpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHRocmVlQmxlbmRzID0gewogICAgICAgICAgICAgICAgICAgICdOb3JtYWwnOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICAnQWRkaXRpdmUnOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdTdWJ0cmFjdGl2ZSc6IFRIUkVFLlN1YnRyYWN0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgJ011bHRpcGx5JzogVEhSRUUuTXVsdGlwbHlCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICAnTm9CbGVuZGluZyc6IFRIUkVFLk5vQmxlbmRpbmcKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHdGb2xkZXIuYWRkKHdQYXJhbXMsICdibGVuZCcsIE9iamVjdC5rZXlzKHRocmVlQmxlbmRzKSkub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgd28ubWF0ZXJpYWwuYmxlbmRpbmcgPSB0aHJlZUJsZW5kc1t2XTsKICAgICAgICAgICAgICAgICAgICB3by5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gTGlnaHQgU2hhZnRzCiAgICAgICAgICAgIGNvbnN0IGxzID0gdGhpcy5nYW1lLmxpZ2h0U2hhZnRzOwogICAgICAgICAgICBpZiAobHMgJiYgbHMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBsUGFyYW1zID0geyB2aXNpYmxlOiB0cnVlIH07CiAgICAgICAgICAgICAgICBmb2xkZXIuYWRkKGxQYXJhbXMsICd2aXNpYmxlJykubmFtZSgnTGlnaHQgU2hhZnRzJykub25DaGFuZ2UodiA9PiBscy5jb250YWluZXIudmlzaWJsZSA9IHYpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX3NldHVwR2FtZVN0YXRlKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0dhbWUgU3RhdGUnKTsKICAgICAgICAgICAgY29uc3QgZ20gPSB0aGlzLmdhbWU7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgICAgICBmb3JjZUhvbWVHb2FsOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGlmKGdtLnN0YXRlID09PSAnYWN0aXZlJykgZ20uZ29hbFNjb3JlZCgnaG9tZScpOyAKICAgICAgICAgICAgICAgICAgICBlbHNlIGNvbnNvbGUud2FybigiR2FtZSBtdXN0IGJlIGFjdGl2ZSB0byB0cmlnZ2VyIGdvYWwiKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBmb3JjZUF3YXlHb2FsOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGlmKGdtLnN0YXRlID09PSAnYWN0aXZlJykgZ20uZ29hbFNjb3JlZCgnYXdheScpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgY29uc29sZS53YXJuKCJHYW1lIG11c3QgYmUgYWN0aXZlIHRvIHRyaWdnZXIgZ29hbCIpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGZvcmNlSGFsZnRpbWU6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZihnbS5zdGF0ZSA9PT0gJ2FjdGl2ZScpIGdtLmVuZEhhbGYoKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICByZXNldFJvdW5kOiAoKSA9PiBnbS5yZXNldFJvdW5kKCksCiAgICAgICAgICAgICAgICBleGl0VG9NZW51OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnN0YXRlID0gJ21lbnUnOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9wIHByYWN0aWNlIGlmIHJ1bm5pbmcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wcmFjdGljZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wcmFjdGljZU1hbmFnZXIuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdmb3JjZUhvbWVHb2FsJykubmFtZSgnVHJpZ2dlciBIb21lIEdvYWwnKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdmb3JjZUF3YXlHb2FsJykubmFtZSgnVHJpZ2dlciBBd2F5IEdvYWwnKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdmb3JjZUhhbGZ0aW1lJykubmFtZSgnRm9yY2UgSGFsZnRpbWUnKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdyZXNldFJvdW5kJykubmFtZSgnUmVzZXQgUm91bmQnKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdleGl0VG9NZW51JykubmFtZSgnRXhpdCB0byBNZW51Jyk7CiAgICAgICAgfQoKICAgICAgICBfc2V0dXBUZWFtcygpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdUZWFtcycpOwogICAgICAgICAgICBpZiAoIXRoaXMuZ2FtZS50ZWFtcy5ob21lIHx8ICF0aGlzLmdhbWUudGVhbXMuYXdheSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgaG9tZSA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBjb25zdCBhd2F5ID0gdGhpcy5nYW1lLnRlYW1zLmF3YXk7CgogICAgICAgICAgICAvLyBIb21lCiAgICAgICAgICAgIGNvbnN0IGhGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdIb21lIFRlYW0nKTsKICAgICAgICAgICAgaEZvbGRlci5hZGQoaG9tZSwgJ2lzSHVtYW4nKS5uYW1lKCdJcyBIdW1hbiBDb250cm9sbGVkJykubGlzdGVuKCk7CiAgICAgICAgICAgIGhGb2xkZXIuYWRkKGhvbWUsICdhaUVuYWJsZWQnKS5uYW1lKCdBSSBMb2dpYyBFbmFibGVkJykubGlzdGVuKCk7CgogICAgICAgICAgICAvLyBBd2F5CiAgICAgICAgICAgIGNvbnN0IGFGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdBd2F5IFRlYW0nKTsKICAgICAgICAgICAgYUZvbGRlci5hZGQoYXdheSwgJ2lzSHVtYW4nKS5uYW1lKCdJcyBIdW1hbiBDb250cm9sbGVkJykubGlzdGVuKCk7CiAgICAgICAgICAgIGFGb2xkZXIuYWRkKGF3YXksICdhaUVuYWJsZWQnKS5uYW1lKCdBSSBMb2dpYyBFbmFibGVkJykubGlzdGVuKCk7CgogICAgICAgIH0KCl9zZXR1cFBsYXllckluc3BlY3RvcigpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdQbGF5ZXIgSW5zcGVjdG9yIChIb21lIEFjdGl2ZSknKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhlbHBlciB0byBnZXQgY3VycmVudCBhY3RpdmUgcGxheWVyIHNhZmVseQogICAgICAgICAgICBjb25zdCBnZXRBY3RpdmUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICByZXR1cm4gKHRoaXMuZ2FtZS50ZWFtcy5ob21lICYmIHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcikgCiAgICAgICAgICAgICAgICAgICAgPyB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIgCiAgICAgICAgICAgICAgICAgICAgOiBudWxsOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUHJveHkgb2JqZWN0IHRvIGJpbmQgR1VJIHRvIGR5bmFtaWMgdGFyZ2V0CiAgICAgICAgICAgIGNvbnN0IHByb3h5ID0gewogICAgICAgICAgICAgICAgZ2V0IFJvbGUoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAucm9sZSA6ICctJzsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBnZXQgR29kTW9kZSgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5pc0dvZE1vZGUgOiBmYWxzZTsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEdvZE1vZGUodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5pc0dvZE1vZGUgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLy8gUnVudGltZSBWYWx1ZXMKICAgICAgICAgICAgICAgIGdldCBIUCgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5IUCA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBIUCh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLkhQID0gdjsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBnZXQgQ3VycmVudEVOKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLmN1cnJlbnRFTiA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBDdXJyZW50RU4odikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5jdXJyZW50RU4gPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLy8gQmFzZSBTdGF0cwogICAgICAgICAgICAgICAgZ2V0IE1heEhQKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLm1heEhQIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IE1heEhQKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMubWF4SFAgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFNQKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlNQIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFNQKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHMuU1AgPSB2OyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7IAogICAgICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBFTigpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5FTiA6IDA7IAogICAgICAgICAgICAgICAgfSwgCiAgICAgICAgICAgICAgICBzZXQgRU4odikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgewogICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXRzLkVOID0gdjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBBVCgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5BVCA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBBVCh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLkFUID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBQQSgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5QQSA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBQQSh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLlBBID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBCTCgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5CTCA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBCTCh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLkJMID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBTSCgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5TSCA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBTSCh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLlNIID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGdldCBDQSgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5zdGF0cy5DQSA6IDA7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldCBDQSh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLnN0YXRzLkNBID0gdjsgCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIC8vIEFjdGlvbnMKICAgICAgICAgICAgICAgIExldmVsVXA6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAubGV2ZWxVcCgpOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBGdWxsSGVhbDogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7IAogICAgICAgICAgICAgICAgICAgIGlmKHApIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSBwLmdldFN0YXQoJ0VOJyk7IAogICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXR1cy52ZW5vbSA9IDA7IAogICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXR1cy5uYXAgPSAwOyAKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBrIGluIHAuc3RhdHVzLndpdGhlcikgcC5zdGF0dXMud2l0aGVyW2tdID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiRlVMTCBIRUFMIiwgcC5tZXNoLnBvc2l0aW9uLCAiaGVhbCIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBEcmFpbkVOOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuY3VycmVudEVOID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgcC5mdW1ibGUoKTsgLy8gVHJpZ2dlciBmdW1ibGUgbG9naWMKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHByb3h5LCAnUm9sZScpLmxpc3RlbigpLmRpc2FibGUoKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwcm94eSwgJ0dvZE1vZGUnKS5uYW1lKCdHb2QgTW9kZSAoSW5mIEhQL0VOKScpLmxpc3RlbigpOwoKICAgICAgICAgICAgY29uc3QgcnRGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdSdW50aW1lIFN0YXR1cycpOwogICAgICAgICAgICBydEZvbGRlci5hZGQocHJveHksICdIUCcsIDAsIDk5OTkpLmxpc3RlbigpOwogICAgICAgICAgICBydEZvbGRlci5hZGQocHJveHksICdDdXJyZW50RU4nLCAwLCAxMDApLm5hbWUoJ0N1cnJlbnQgRU4nKS5saXN0ZW4oKTsKCiAgICAgICAgICAgIGNvbnN0IHN0YXRGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdCYXNlIFN0YXRzJyk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnTWF4SFAnLCAxMDAsIDk5OTkpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ0VOJywgMCwgOTkpLm5hbWUoJ01heCBFTicpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ1NQJywgMCwgOTkpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ0FUJywgMCwgOTkpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ1BBJywgMCwgOTkpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ0JMJywgMCwgOTkpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ1NIJywgMCwgOTkpLmxpc3RlbigpOwogICAgICAgICAgICBzdGF0Rm9sZGVyLmFkZChwcm94eSwgJ0NBJywgMCwgOTkpLmxpc3RlbigpOwoKICAgICAgICAgICAgY29uc3QgYWN0aW9uRm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignQWN0aW9ucycpOwogICAgICAgICAgICBhY3Rpb25Gb2xkZXIuYWRkKHByb3h5LCAnTGV2ZWxVcCcpLm5hbWUoJ0luc3RhbnQgTGV2ZWwgVXAnKTsKICAgICAgICAgICAgYWN0aW9uRm9sZGVyLmFkZChwcm94eSwgJ0Z1bGxIZWFsJykubmFtZSgnRnVsbCBIZWFsICYgQ3VyZScpOwogICAgICAgICAgICBhY3Rpb25Gb2xkZXIuYWRkKHByb3h5LCAnRHJhaW5FTicpLm5hbWUoJ0RyYWluIEVOIChGdW1ibGUpJyk7CiAgICAgICAgfQoKX3NldHVwQmFsbFNhbmRib3goKSB7CiAgICBjb25zdCByb290ID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdCYWxsIExhYiAoVGhyb3cgJiBQaHlzaWNzKScpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gU2hhcmVkIHN0YXRlIG9iamVjdCAobGl2ZXMgb24gd2luZG93LmZsdXggc28gaXQgc3Vydml2ZXMgcmVsb2FkcykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgbGFiID0gd2luZG93LmZsdXguYmFsbExhYiA9IHdpbmRvdy5mbHV4LmJhbGxMYWIgfHwge307CiAgICBsYWIuZ2FtZSA9IHRoaXMuZ2FtZTsKCiAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZzsKICAgIGNvbnN0IFRDID0gd2luZG93LmZsdXguVGhyb3dDb25maWc7CgogICAgaWYgKCFDIHx8ICFUQykgewogICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBMYWI6IE1pc3NpbmcgQmFsbENvbmZpZyBvciBUaHJvd0NvbmZpZy4iKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBIZWxwZXJzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IGdldEJhbGwgPSAoKSA9PiB0aGlzLmdhbWUgJiYgdGhpcy5nYW1lLmVudGl0aWVzID8gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgY29uc3QgZ2V0QWN0aXZlID0gKCkgPT4gdGhpcy5nYW1lICYmIHRoaXMuZ2FtZS50ZWFtcyAmJiB0aGlzLmdhbWUudGVhbXMuaG9tZSA/IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciA6IG51bGw7CgogICAgY29uc3QgZW5zdXJlUHJldmlld0xpbmUgPSAoKSA9PiB7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3TGluZSkgcmV0dXJuOwogICAgICAgIGlmICghdGhpcy5nYW1lIHx8ICF0aGlzLmdhbWUuc2NlbmUpIHJldHVybjsKCiAgICAgICAgY29uc3QgZ2VvbSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5MaW5lQmFzaWNNYXRlcmlhbCh7IHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjk1IH0pOwogICAgICAgIGNvbnN0IGxpbmUgPSBuZXcgVEhSRUUuTGluZShnZW9tLCBtYXQpOwogICAgICAgIGxpbmUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgIGxpbmUucmVuZGVyT3JkZXIgPSA5OTk7CiAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZChsaW5lKTsKICAgICAgICBsYWIucHJldmlld0xpbmUgPSBsaW5lOwogICAgfTsKCiAgICBjb25zdCBjbGVhclByZXZpZXdMaW5lID0gKCkgPT4gewogICAgICAgIGlmIChsYWIucHJldmlld0xpbmUgJiYgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5KSB7CiAgICAgICAgICAgIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeS5kaXNwb3NlKCk7CiAgICAgICAgICAgIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gQSBzYWZlICJnaG9zdCBiYWxsIiB0aGF0IGNhbiB1c2UgQmFsbC51cGRhdGVGcmVlIHdpdGhvdXQgc3Bhd25pbmcgRlgKICAgIGNvbnN0IG1ha2VHaG9zdEJhbGwgPSAocG9zLCB2ZWwsIHNwaW4pID0+IHsKICAgICAgICBjb25zdCBnYiA9IHsKICAgICAgICAgICAgbWVzaDogeyBwb3NpdGlvbjogcG9zLmNsb25lKCkgfSwKICAgICAgICAgICAgdmVsb2NpdHk6IHZlbC5jbG9uZSgpLAogICAgICAgICAgICBhbmd1bGFyVmVsb2NpdHk6IChzcGluID8gc3Bpbi5jbG9uZSgpIDogbmV3IFRIUkVFLlZlY3RvcjMoKSksCiAgICAgICAgICAgIGFjY3VtdWxhdGVkUm90YXRpb246IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCksCiAgICAgICAgICAgIHBvd2VyOiAwLAogICAgICAgICAgICBkZWNheVJhdGU6IDAsCiAgICAgICAgICAgIF9idWJibGVUaW1lcjogOTk5LAogICAgICAgICAgICBfZ2hvc3Q6IHRydWUsCiAgICAgICAgICAgIGRlZm9ybU5vZGU6IG51bGwKICAgICAgICB9OwogICAgICAgIHJldHVybiBnYjsKICAgIH07CgogICAgLy8gVXNlIEJhbGwudXBkYXRlRnJlZSBmb3IgZmFpdGhmdWwgdHJhamVjdG9yeSBwcmVkaWN0aW9uCiAgICBjb25zdCBzaW11bGF0ZSA9IChnaG9zdEJhbGwsIHN0ZXBzLCBzdGVwRHQpID0+IHsKICAgICAgICBjb25zdCBwdHMgPSBbXTsKICAgICAgICBwdHMucHVzaChnaG9zdEJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpKTsKICAgICAgICBjb25zdCBwcm90byA9IHdpbmRvdy5mbHV4LkJhbGwgJiYgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGU7CiAgICAgICAgaWYgKCFwcm90byB8fCB0eXBlb2YgcHJvdG8udXBkYXRlRnJlZSAhPT0gJ2Z1bmN0aW9uJykgcmV0dXJuIHB0czsKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdGVwczsgaSsrKSB7CiAgICAgICAgICAgIHByb3RvLnVwZGF0ZUZyZWUuY2FsbChnaG9zdEJhbGwsIHN0ZXBEdCk7CiAgICAgICAgICAgIHB0cy5wdXNoKGdob3N0QmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcHRzOwogICAgfTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIFByZXZpZXcgKyByZWNvcmQvcmVwbGF5IHJ1bnRpbWUgbG9vcAogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmxhYi5wcmV2aWV3ID0gbGFiLnByZXZpZXcgfHwgewogICAgICAgIGVuYWJsZWQ6IGZhbHNlLAogICAgICAgIHNvdXJjZTogJ0Nhbm5vbicsCiAgICAgICAgc3RlcHM6IDEyMCwKICAgICAgICBzdGVwRHQ6IDEvNjAsCiAgICAgICAgcmVmcmVzaEh6OiAxMCwKICAgICAgICBzaG93T25IZWxkT25seTogZmFsc2UKICAgIH07CgogICAgbGFiLmNhbm5vbiA9IGxhYi5jYW5ub24gfHwgewogICAgICAgIHlhdzogMCwKICAgICAgICBwaXRjaDogMCwKICAgICAgICBwb3dlcjogMjAsCiAgICAgICAgdHlwZTogJ1NIJywKICAgICAgICBzcGluWDogMCwKICAgICAgICBzcGluWTogMCwKICAgICAgICBzcGluWjogMCwKICAgICAgICBmaXJlQnVyc3Q6IDEsCiAgICAgICAgc3ByZWFkRGVnOiAwCiAgICB9OwoKICAgIGxhYi5yZWNvcmRpbmcgPSBsYWIucmVjb3JkaW5nIHx8IHsKICAgICAgICBpc1JlY29yZGluZzogZmFsc2UsCiAgICAgICAgZnJhbWVzOiBbXSwKICAgICAgICBtYXhTZWNvbmRzOiAxMgogICAgfTsKCiAgICBsYWIucmVwbGF5ID0gbGFiLnJlcGxheSB8fCB7CiAgICAgICAgaXNSZXBsYXlpbmc6IGZhbHNlLAogICAgICAgIGZyYW1lczogW10sCiAgICAgICAgaWR4OiAwLAogICAgICAgIGxvb3A6IHRydWUsCiAgICAgICAgc3BlZWQ6IDEuMAogICAgfTsKCiAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgIGxhYi50YXJnZXRCYWxsID0gbnVsbDsKCiAgICBsYWIuYXBwbHlSZXBsYXlGcmFtZSA9IChiYWxsLCBkdCkgPT4gewogICAgICAgIGNvbnN0IHJlcCA9IGxhYi5yZXBsYXk7CiAgICAgICAgaWYgKCFyZXAgfHwgIXJlcC5pc1JlcGxheWluZyB8fCAhcmVwLmZyYW1lcyB8fCByZXAuZnJhbWVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gQWR2YW5jZSB0aW1lIGJ5IHN0ZXBwaW5nIGluZGljZXMgKGZyYW1lLWJhc2VkKQogICAgICAgIGNvbnN0IHN0ZXAgPSBNYXRoLm1heCgxLCBNYXRoLmZsb29yKHJlcC5zcGVlZCkpOwogICAgICAgIHJlcC5pZHggKz0gc3RlcDsKCiAgICAgICAgaWYgKHJlcC5pZHggPj0gcmVwLmZyYW1lcy5sZW5ndGgpIHsKICAgICAgICAgICAgaWYgKHJlcC5sb29wKSByZXAuaWR4ID0gMDsKICAgICAgICAgICAgZWxzZSB7IHJlcC5pc1JlcGxheWluZyA9IGZhbHNlOyBsYWIuaXNSZXBsYXlpbmcgPSBmYWxzZTsgcmV0dXJuOyB9CiAgICAgICAgfQoKICAgICAgICBjb25zdCBmID0gcmVwLmZyYW1lc1tyZXAuaWR4XTsKICAgICAgICBpZiAoIWYpIHJldHVybjsKCiAgICAgICAgYmFsbC5kcm9wKCk7IC8vIGVuc3VyZSBubyBob2xkZXIgbG9naWMgZmlnaHRzIHVzCiAgICAgICAgYmFsbC5zdGF0ZSA9ICdmcmVlJzsKICAgICAgICBiYWxsLm1lc2gucG9zaXRpb24uc2V0KGYucHgsIGYucHksIGYucHopOwogICAgICAgIGJhbGwudmVsb2NpdHkuc2V0KGYudngsIGYudnksIGYudnopOwogICAgICAgIGJhbGwuYW5ndWxhclZlbG9jaXR5LnNldChmLnN4LCBmLnN5LCBmLnN6KTsKICAgIH07CgogICAgbGFiLl9wcmV2aWV3VGltZXIgPSBsYWIuX3ByZXZpZXdUaW1lciB8fCAwOwoKICAgIGxhYi51cGRhdGUgPSAoZHQpID0+IHsKICAgICAgICAvLyAtLS0gcmVjb3JkaW5nIC0tLQogICAgICAgIGNvbnN0IGIgPSBnZXRCYWxsKCk7CiAgICAgICAgaWYgKGIgJiYgbGFiLnJlY29yZGluZyAmJiBsYWIucmVjb3JkaW5nLmlzUmVjb3JkaW5nKSB7CiAgICAgICAgICAgIGNvbnN0IHIgPSBsYWIucmVjb3JkaW5nOwogICAgICAgICAgICBjb25zdCBtYXhGcmFtZXMgPSBNYXRoLmZsb29yKChyLm1heFNlY29uZHMgfHwgMTIpIC8gKGR0IHx8ICgxLzYwKSkpOwogICAgICAgICAgICBpZiAoci5mcmFtZXMubGVuZ3RoID4gbWF4RnJhbWVzKSByLmZyYW1lcy5zaGlmdCgpOwogICAgICAgICAgICByLmZyYW1lcy5wdXNoKHsKICAgICAgICAgICAgICAgIHB4OiBiLm1lc2gucG9zaXRpb24ueCwgcHk6IGIubWVzaC5wb3NpdGlvbi55LCBwejogYi5tZXNoLnBvc2l0aW9uLnosCiAgICAgICAgICAgICAgICB2eDogYi52ZWxvY2l0eS54LCB2eTogYi52ZWxvY2l0eS55LCB2ejogYi52ZWxvY2l0eS56LAogICAgICAgICAgICAgICAgc3g6IGIuYW5ndWxhclZlbG9jaXR5LngsIHN5OiBiLmFuZ3VsYXJWZWxvY2l0eS55LCBzejogYi5hbmd1bGFyVmVsb2NpdHkuegogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBwcmV2aWV3IHJlZnJlc2ggLS0tCiAgICAgICAgbGFiLl9wcmV2aWV3VGltZXIgKz0gZHQ7CiAgICAgICAgY29uc3QgcmVmcmVzaEludGVydmFsID0gMS4wIC8gTWF0aC5tYXgoMSwgKGxhYi5wcmV2aWV3LnJlZnJlc2hIeiB8fCAxMCkpOwogICAgICAgIGlmIChsYWIucHJldmlldy5lbmFibGVkICYmIGxhYi5fcHJldmlld1RpbWVyID49IHJlZnJlc2hJbnRlcnZhbCkgewogICAgICAgICAgICBsYWIuX3ByZXZpZXdUaW1lciA9IDA7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0KICAgIH07CgogICAgbGFiLnJlZnJlc2hQcmV2aWV3ID0gKCkgPT4gewogICAgICAgIGlmICghbGFiLnByZXZpZXcuZW5hYmxlZCkgeyBjbGVhclByZXZpZXdMaW5lKCk7IHJldHVybjsgfQogICAgICAgIGVuc3VyZVByZXZpZXdMaW5lKCk7CgogICAgICAgIGNvbnN0IGIgPSBnZXRCYWxsKCk7CiAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgIGlmICghYiB8fCAhYi5tZXNoKSByZXR1cm47CgogICAgICAgIGlmIChsYWIucHJldmlldy5zaG93T25IZWxkT25seSAmJiBiLnN0YXRlICE9PSAnaGVsZCcpIHsKICAgICAgICAgICAgY2xlYXJQcmV2aWV3TGluZSgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBEZWNpZGUgcHJldmlldyBzb3VyY2UKICAgICAgICBsZXQgc3RhcnRQb3MgPSBiLm1lc2gucG9zaXRpb247CiAgICAgICAgbGV0IHN0YXJ0VmVsID0gYi52ZWxvY2l0eTsKICAgICAgICBsZXQgc3RhcnRTcGluID0gYi5hbmd1bGFyVmVsb2NpdHk7CgogICAgICAgIGlmIChsYWIucHJldmlldy5zb3VyY2UgPT09ICdDYW5ub24nKSB7CiAgICAgICAgICAgIC8vIENhbm5vbiBhbHdheXMgbGF1bmNoZXMgZnJvbSBiYWxsIHBvc2l0aW9uIChvciBwbGF5ZXIgaWYgaGVsZCkKICAgICAgICAgICAgY29uc3QgeWF3UmFkID0gKGxhYi5jYW5ub24ueWF3IHx8IDApICogTWF0aC5QSSAvIDE4MDsKICAgICAgICAgICAgY29uc3QgcGl0Y2hSYWQgPSAobGFiLmNhbm5vbi5waXRjaCB8fCAwKSAqIE1hdGguUEkgLyAxODA7CgogICAgICAgICAgICBjb25zdCBkaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgIE1hdGguc2luKHlhd1JhZCkgKiBNYXRoLmNvcyhwaXRjaFJhZCksCiAgICAgICAgICAgICAgICBNYXRoLnNpbihwaXRjaFJhZCksCiAgICAgICAgICAgICAgICAtTWF0aC5jb3MoeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKQogICAgICAgICAgICApLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgY29uc3QgY2FwID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX0NBUCAhPT0gdW5kZWZpbmVkID8gd2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfQ0FQIDogODUuMCk7CiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX1NDQUxFICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkxBVU5DSF9TUEVFRF9TQ0FMRSA6IDEuMCk7CiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gTWF0aC5taW4oKGxhYi5jYW5ub24ucG93ZXIgfHwgMjApICogc2NhbGUsIGNhcCk7CgogICAgICAgICAgICBzdGFydFBvcyA9IChiLnN0YXRlID09PSAnaGVsZCcgJiYgcCAmJiBwLm1lc2gpID8gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEuMiwgMCkpIDogYi5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgIHN0YXJ0VmVsID0gZGlyLm11bHRpcGx5U2NhbGFyKHNwZWVkKTsKICAgICAgICAgICAgc3RhcnRTcGluID0gbmV3IFRIUkVFLlZlY3RvcjMobGFiLmNhbm5vbi5zcGluWCB8fCAwLCBsYWIuY2Fubm9uLnNwaW5ZIHx8IDAsIGxhYi5jYW5ub24uc3BpblogfHwgMCk7CiAgICAgICAgfQoKICAgICAgICBjb25zdCBnaG9zdCA9IG1ha2VHaG9zdEJhbGwoc3RhcnRQb3MuY2xvbmUoKSwgc3RhcnRWZWwuY2xvbmUoKSwgc3RhcnRTcGluKTsKICAgICAgICBjb25zdCBwdHMgPSBzaW11bGF0ZShnaG9zdCwgTWF0aC5mbG9vcihsYWIucHJldmlldy5zdGVwcyB8fCAxMjApLCAobGFiLnByZXZpZXcuc3RlcER0IHx8ICgxLzYwKSkpOwoKICAgICAgICBpZiAobGFiLnByZXZpZXdMaW5lKSB7CiAgICAgICAgICAgIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeS5kaXNwb3NlKCk7CiAgICAgICAgICAgIGxhYi5wcmV2aWV3TGluZS5nZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpLnNldEZyb21Qb2ludHMocHRzKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBCYWxsIFBoeXNpY3MgKEJhbGxDb25maWcpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHBoeXMgPSByb290LmFkZEZvbGRlcignQmFsbCBQaHlzaWNzIChCYWxsQ29uZmlnKScpOwoKICAgIGNvbnN0IGludGVnID0gcGh5cy5hZGRGb2xkZXIoJ0ludGVncmF0aW9uJyk7CiAgICBpbnRlZy5hZGQoQywgJ1NVQlNURVBTJywgMSwgMTIsIDEpLm5hbWUoJ1N1YnN0ZXBzJyk7CiAgICBpbnRlZy5hZGQoQywgJ1NUT1BfU1BFRUQnLCAwLjAsIDAuMikubmFtZSgnU3RvcCBTcGVlZCcpOwoKICAgIGNvbnN0IGRyYWcgPSBwaHlzLmFkZEZvbGRlcignV2F0ZXIgRHJhZycpOwogICAgZHJhZy5hZGQoQywgJ1dBVEVSX0RSQUdfTElORUFSJywgMC4wLCAyLjApLm5hbWUoJ0xpbmVhciBEcmFnJyk7CiAgICBkcmFnLmFkZChDLCAnV0FURVJfRFJBR19RVUFEJywgMC4wLCAwLjA1KS5uYW1lKCdRdWFkcmF0aWMgRHJhZycpOwoKICAgIGNvbnN0IHNwaW4gPSBwaHlzLmFkZEZvbGRlcignU3BpbicpOwogICAgc3Bpbi5hZGQoQywgJ1NQSU5fRFJBRycsIDAuMCwgMy4wKS5uYW1lKCdTcGluIERlY2F5Jyk7CgogICAgY29uc3QgbWFnbnVzID0gcGh5cy5hZGRGb2xkZXIoJ01hZ251cycpOwogICAgbWFnbnVzLmFkZChDLCAnTUFHTlVTX0VOQUJMRUQnKS5uYW1lKCdFbmFibGVkJyk7CiAgICBtYWdudXMuYWRkKEMsICdNQUdOVVNfQ09FRkYnLCAwLjAsIDAuNSkubmFtZSgnQ29lZmYnKTsKICAgIG1hZ251cy5hZGQoQywgJ01BR05VU19DQVAnLCAwLjAsIDIwMC4wKS5uYW1lKCdDYXAnKTsKCiAgICBjb25zdCBkZXB0aCA9IHBoeXMuYWRkRm9sZGVyKCdEZXB0aCBDb25zdHJhaW50Jyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX1RBUkdFVF9ZJywgLTUuMCwgNS4wKS5uYW1lKCdUYXJnZXQgWScpOwogICAgZGVwdGguYWRkKEMsICdERVBUSF9TUFJJTkcnLCAwLjAsIDEwLjApLm5hbWUoJ1NwcmluZycpOwogICAgZGVwdGguYWRkKEMsICdERVBUSF9EQU1QJywgMC4wLCA2LjApLm5hbWUoJ0RhbXAnKTsKCiAgICBjb25zdCBhcmVuYSA9IHBoeXMuYWRkRm9sZGVyKCdBcmVuYSBCb3VuZGFyeScpOwogICAgYXJlbmEuYWRkKEMsICdCT1VOREFSWV9SQURJVVMnLCAxMC4wLCAxMjAuMCkubmFtZSgnUmFkaXVzJyk7CiAgICBhcmVuYS5hZGQoQywgJ0JPVU5EQVJZX0hFSUdIVCcsIDIuMCwgNDAuMCkubmFtZSgnSGVpZ2h0Jyk7CiAgICBhcmVuYS5hZGQoQywgJ1dBTExfU09GVF9CVUZGRVInLCAwLjAsIDIwLjApLm5hbWUoJ1NvZnQgQnVmZmVyJyk7CiAgICBhcmVuYS5hZGQoQywgJ1dBTExfU09GVF9GT1JDRScsIDAuMCwgMjAwLjApLm5hbWUoJ1NvZnQgRm9yY2UnKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9FTEFTVElDSVRZJywgMC4wLCAxLjApLm5hbWUoJ1dhbGwgQm91bmNlJyk7CiAgICBhcmVuYS5hZGQoQywgJ1dBTExfRlJJQ1RJT04nLCAwLjAsIDEuMCkubmFtZSgnV2FsbCBGcmljdGlvbicpOwogICAgYXJlbmEuYWRkKEMsICdGTE9PUl9FTEFTVElDSVRZJywgMC4wLCAxLjApLm5hbWUoJ0NlaWwvRmxvb3IgQm91bmNlJyk7CgogICAgY29uc3QgcG9ja2V0ID0gYXJlbmEuYWRkRm9sZGVyKCdHb2FsIFBvY2tldCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfRU5BQkxFRCcpLm5hbWUoJ0VuYWJsZWQnKTsKICAgIHBvY2tldC5hZGQoQywgJ0dPQUxfUE9DS0VUX1gnLCAwLjAsIDQwLjApLm5hbWUoJ1BvY2tldCBIYWxmLVgnKTsKICAgIHBvY2tldC5hZGQoQywgJ0dPQUxfUE9DS0VUX1onLCAwLjAsIDUwLjApLm5hbWUoJ1BvY2tldCBTdGFydCB8WnwnKTsKICAgIHBvY2tldC5hZGQoQywgJ0dPQUxfUE9DS0VUX1JBRElVUycsIDEwLjAsIDEyMC4wKS5uYW1lKCdQb2NrZXQgUmFkaXVzJyk7CgogICAgY29uc3QgbGF1bmNoID0gcGh5cy5hZGRGb2xkZXIoJ0xhdW5jaCBNYXBwaW5nJyk7CiAgICBsYXVuY2guYWRkKEMsICdMQVVOQ0hfU1BFRURfU0NBTEUnLCAwLjEsIDUuMCkubmFtZSgnU3BlZWQgU2NhbGUnKTsKICAgIGxhdW5jaC5hZGQoQywgJ0xBVU5DSF9TUEVFRF9DQVAnLCAxMC4wLCAyMDAuMCkubmFtZSgnU3BlZWQgQ2FwJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFRocm93IG1hcHBpbmcgKFBsYXllci5yZWxlYXNlQ2hhcmdlIC0+IEJhbGwuc2hvb3QpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHRocm93TWFwID0gcm9vdC5hZGRGb2xkZXIoJ1Rocm93IE1hcHBpbmcgKFRocm93Q29uZmlnKScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnU1dJUEVfTUlOX1BYJywgMCwgMTIwLCAxKS5uYW1lKCdTd2lwZSBNaW4gUFgnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ0FJTV9EWF9TQ0FMRScsIDAuMSwgNS4wKS5uYW1lKCdBaW0gWCBTY2FsZScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnQUlNX0RZX1NDQUxFJywgMC4xLCA1LjApLm5hbWUoJ0FpbSBZIFNjYWxlJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdQT1dFUl9CQVNFJywgMC4xLCAzLjApLm5hbWUoJ1Bvd2VyIEJhc2UnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX1JBTkdFJywgMC4wLCAzLjApLm5hbWUoJ1Bvd2VyIFJhbmdlJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdQT1dFUl9NQVhfQk9OVVNfUkFUSU8nLCAwLjAsIDEuMCkubmFtZSgnTWF4IEJvbnVzIFJhdGlvJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdQT1dFUl9NQVhfTVVMVElQTElFUicsIDEuMCwgNi4wKS5uYW1lKCdNYXggTXVsdGlwbGllcicpOwoKICAgIGNvbnN0IGN1cnZlTWFwID0gdGhyb3dNYXAuYWRkRm9sZGVyKCdDdXJ2ZScpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfRU5BQkxFRCcpLm5hbWUoJ0VuYWJsZWQnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQnLCAwLjAsIDEuMCkubmFtZSgnSW5wdXQgVGhyZXNob2xkJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9TUElOX1NDQUxFJywgMC4wLCA0MDAwLjApLm5hbWUoJ1NwaW4gU2NhbGUnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX1NQRUVEX01VTFQnLCAwLjAsIDUuMCkubmFtZSgnU3dpcGUgU3BlZWQgTXVsdCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfU1BJTl9DQVAnLCAwLjAsIDYwMDAuMCkubmFtZSgnU3BpbiBDYXAnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX1BFUkZFQ1RfU1BJTicsIDAuMCwgMjAwMC4wKS5uYW1lKCdQZXJmZWN0IFRocmVzaG9sZCcpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBUZWxlcG9ydCAvIFN0YXRlIHRvb2xzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHRwID0gcm9vdC5hZGRGb2xkZXIoJ1RlbGVwb3J0IC8gUmVzZXQnKTsKICAgIGNvbnN0IHRwUGFyYW1zID0gewogICAgICAgIFRvQ2VudGVyOiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGlmIChiKSBiLnJlc2V0KCk7IH0sCiAgICAgICAgVG9BY3RpdmVQbGF5ZXI6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgY29uc3QgcCA9IGdldEFjdGl2ZSgpOyBpZiAoYiAmJiBwKSBiLmdyYWIocCk7IH0sCiAgICAgICAgVG9Ib21lR29hbDogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAyNSk7IGIudmVsb2NpdHkuc2V0KDAsMCwwKTsgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsgfSB9LAogICAgICAgIFRvQXdheUdvYWw6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgaWYgKGIpIHsgYi5kcm9wKCk7IGIubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTI1KTsgYi52ZWxvY2l0eS5zZXQoMCwwLDApOyBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOyB9IH0sCiAgICAgICAgVG9Ta3k6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgaWYgKGIpIHsgYi5kcm9wKCk7IGIubWVzaC5wb3NpdGlvbi5zZXQoMCwgMTAsIDApOyBiLnZlbG9jaXR5LnNldCgwLDAsMCk7IGIuYW5ndWxhclZlbG9jaXR5LnNldCgwLDAsMCk7IH0gfSwKICAgICAgICBDbGVhclByZXZpZXc6ICgpID0+IGNsZWFyUHJldmlld0xpbmUoKQogICAgfTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvQ2VudGVyJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0FjdGl2ZVBsYXllcicpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9Ib21lR29hbCcpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9Bd2F5R29hbCcpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9Ta3knKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ0NsZWFyUHJldmlldycpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBTaG90IENhbm5vbiAoZm9yY2UgZmlyZSB3aXRoIHBhcmFtcykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgY2Fubm9uID0gcm9vdC5hZGRGb2xkZXIoJ1Nob3QgQ2Fubm9uJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICd5YXcnLCAtMTgwLCAxODAsIDEpLm5hbWUoJ1lhdyAoZGVnKScpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAncGl0Y2gnLCAtODksIDg5LCAxKS5uYW1lKCdQaXRjaCAoZGVnKScpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAncG93ZXInLCAwLCAxMjAsIDAuMSkubmFtZSgnUG93ZXInKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3R5cGUnLCBbJ1BBJywnU0gnXSkubmFtZSgnVHlwZScpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnc3BpblgnLCAtMzAwMCwgMzAwMCwgMSkubmFtZSgnU3BpbiBYJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcGluWScsIC0zMDAwLCAzMDAwLCAxKS5uYW1lKCdTcGluIFknKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwaW5aJywgLTMwMDAsIDMwMDAsIDEpLm5hbWUoJ1NwaW4gWicpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnZmlyZUJ1cnN0JywgMSwgMTAsIDEpLm5hbWUoJ0J1cnN0IENvdW50Jyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcHJlYWREZWcnLCAwLCAzMCwgMC41KS5uYW1lKCdTcHJlYWQgKGRlZyknKTsKCiAgICBjb25zdCBmaXJlUGFyYW1zID0gewogICAgICAgIEZpcmU6ICgpID0+IHsKICAgICAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICBpZiAoIWIpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHlhd1JhZCA9IChsYWIuY2Fubm9uLnlhdyB8fCAwKSAqIE1hdGguUEkgLyAxODA7CiAgICAgICAgICAgIGNvbnN0IHBpdGNoUmFkID0gKGxhYi5jYW5ub24ucGl0Y2ggfHwgMCkgKiBNYXRoLlBJIC8gMTgwOwoKICAgICAgICAgICAgY29uc3QgYmFzZURpciA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgTWF0aC5zaW4oeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIE1hdGguc2luKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIC1NYXRoLmNvcyh5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpCiAgICAgICAgICAgICkubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBzdGFydCA9IChiLnN0YXRlID09PSAnaGVsZCcgJiYgcCAmJiBwLm1lc2gpID8gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEuMiwgMCkpIDogYi5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CgogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IChsYWIuY2Fubm9uLmZpcmVCdXJzdCB8fCAxKTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBiYXNlRGlyLmNsb25lKCk7CiAgICAgICAgICAgICAgICBpZiAobGFiLmNhbm5vbi5zcHJlYWREZWcgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3ByZWFkID0gKGxhYi5jYW5ub24uc3ByZWFkRGVnICogTWF0aC5QSSAvIDE4MCk7CiAgICAgICAgICAgICAgICAgICAgZGlyLnggKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIHNwcmVhZDsKICAgICAgICAgICAgICAgICAgICBkaXIueSArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogc3ByZWFkOwogICAgICAgICAgICAgICAgICAgIGRpci56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcHJlYWQ7CiAgICAgICAgICAgICAgICAgICAgZGlyLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGIuZHJvcCgpOwogICAgICAgICAgICAgICAgYi5tZXNoLnBvc2l0aW9uLmNvcHkoc3RhcnQpOwogICAgICAgICAgICAgICAgYi52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsKCiAgICAgICAgICAgICAgICBjb25zdCBzcGluID0gbmV3IFRIUkVFLlZlY3RvcjMobGFiLmNhbm5vbi5zcGluWCB8fCAwLCBsYWIuY2Fubm9uLnNwaW5ZIHx8IDAsIGxhYi5jYW5ub24uc3BpblogfHwgMCk7CiAgICAgICAgICAgICAgICBiLnNob290KGRpciwgbGFiLmNhbm5vbi5wb3dlciB8fCAyMCwgbGFiLmNhbm5vbi50eXBlIHx8ICdTSCcsIG51bGwsIHNwaW4pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGNhbm5vbi5hZGQoZmlyZVBhcmFtcywgJ0ZpcmUnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogVHJhamVjdG9yeSBQcmV2aWV3CiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHByZXZpZXcgPSByb290LmFkZEZvbGRlcignVHJhamVjdG9yeSBQcmV2aWV3Jyk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ2VuYWJsZWQnKS5uYW1lKCdFbmFibGVkJykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdzb3VyY2UnLCBbJ0Nhbm5vbicsICdMaXZlIEJhbGwnXSkubmFtZSgnU291cmNlJykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdzdGVwcycsIDEwLCA2MDAsIDEpLm5hbWUoJ1N0ZXBzJykub25DaGFuZ2UoKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCkpOwogICAgcHJldmlldy5hZGQobGFiLnByZXZpZXcsICdzdGVwRHQnLCAxLzI0MCwgMS8xNSwgMS8yNDApLm5hbWUoJ1N0ZXAgZHQnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3JlZnJlc2hIeicsIDEsIDYwLCAxKS5uYW1lKCdSZWZyZXNoIEh6Jyk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3Nob3dPbkhlbGRPbmx5JykubmFtZSgnT25seSB3aGVuIEhlbGQnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CgogICAgY29uc3QgcHJldmlld0J0bnMgPSB7CiAgICAgICAgUmVmcmVzaDogKCkgPT4gbGFiLnJlZnJlc2hQcmV2aWV3KCksCiAgICAgICAgSGlkZTogKCkgPT4geyBsYWIucHJldmlldy5lbmFibGVkID0gZmFsc2U7IGNsZWFyUHJldmlld0xpbmUoKTsgfQogICAgfTsKICAgIHByZXZpZXcuYWRkKHByZXZpZXdCdG5zLCAnUmVmcmVzaCcpOwogICAgcHJldmlldy5hZGQocHJldmlld0J0bnMsICdIaWRlJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFJlY29yZCAvIFJlcGxheQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCByciA9IHJvb3QuYWRkRm9sZGVyKCdSZWNvcmQgLyBSZXBsYXknKTsKICAgIGNvbnN0IHJyUGFyYW1zID0gewogICAgICAgIFJlY29yZDogKCkgPT4gewogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmlzUmVjb3JkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgbGFiLnJlY29yZGluZy5mcmFtZXMgPSBbXTsKICAgICAgICB9LAogICAgICAgIFN0b3A6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlY29yZGluZy5pc1JlY29yZGluZyA9IGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgVXNlUmVjb3JkaW5nRm9yUmVwbGF5OiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuZnJhbWVzID0gKGxhYi5yZWNvcmRpbmcuZnJhbWVzIHx8IFtdKS5zbGljZSgpOwogICAgICAgICAgICBsYWIucmVwbGF5LmlkeCA9IDA7CiAgICAgICAgfSwKICAgICAgICBQbGF5OiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGIgPSBnZXRCYWxsKCk7CiAgICAgICAgICAgIGlmICghYikgcmV0dXJuOwogICAgICAgICAgICBsYWIucmVwbGF5LmlzUmVwbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgbGFiLmlzUmVwbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgbGFiLnRhcmdldEJhbGwgPSBiOwogICAgICAgICAgICBsYWIucmVwbGF5LmlkeCA9IDA7CiAgICAgICAgfSwKICAgICAgICBQYXVzZTogKCkgPT4gewogICAgICAgICAgICBsYWIucmVwbGF5LmlzUmVwbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgQ2xlYXI6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlY29yZGluZy5mcmFtZXMgPSBbXTsKICAgICAgICAgICAgbGFiLnJlcGxheS5mcmFtZXMgPSBbXTsKICAgICAgICAgICAgbGFiLnJlcGxheS5pZHggPSAwOwogICAgICAgICAgICBsYWIucmVwbGF5LmlzUmVwbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgIH0KICAgIH07CiAgICByci5hZGQocnJQYXJhbXMsICdSZWNvcmQnKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1N0b3AnKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1VzZVJlY29yZGluZ0ZvclJlcGxheScpLm5hbWUoJ0NvcHkgUmVjIC0+IFJlcGxheScpOwogICAgcnIuYWRkKGxhYi5yZXBsYXksICdsb29wJykubmFtZSgnTG9vcCcpOwogICAgcnIuYWRkKGxhYi5yZXBsYXksICdzcGVlZCcsIDAuMjUsIDYuMCwgMC4yNSkubmFtZSgnUmVwbGF5IFNwZWVkJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdQbGF5Jyk7CiAgICByci5hZGQocnJQYXJhbXMsICdQYXVzZScpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnQ2xlYXInKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogUHJlc2V0cwogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBwcmVzZXRzID0gcm9vdC5hZGRGb2xkZXIoJ1ByZXNldHMnKTsKICAgIGNvbnN0IFAgPSB7CiAgICAgICAgVmFuaWxsYTogKCkgPT4gewogICAgICAgICAgICBPYmplY3QuYXNzaWduKEMsIHsKICAgICAgICAgICAgICAgIFNVQlNURVBTOiAyLAogICAgICAgICAgICAgICAgU1RPUF9TUEVFRDogMC4wMiwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfTElORUFSOiAwLjE1LAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19RVUFEOiAwLjAwMiwKICAgICAgICAgICAgICAgIFNQSU5fRFJBRzogMC40MCwKICAgICAgICAgICAgICAgIE1BR05VU19FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgTUFHTlVTX0NPRUZGOiAwLjA4LAogICAgICAgICAgICAgICAgTUFHTlVTX0NBUDogNjAuMCwKICAgICAgICAgICAgICAgIERFUFRIX1RBUkdFVF9ZOiAwLjAsCiAgICAgICAgICAgICAgICBERVBUSF9TUFJJTkc6IDEuMCwKICAgICAgICAgICAgICAgIERFUFRIX0RBTVA6IDEuNSwKICAgICAgICAgICAgICAgIEJPVU5EQVJZX1JBRElVUzogMzMuMCwKICAgICAgICAgICAgICAgIEJPVU5EQVJZX0hFSUdIVDogMTUuMCwKICAgICAgICAgICAgICAgIFdBTExfU09GVF9CVUZGRVI6IDMuMCwKICAgICAgICAgICAgICAgIFdBTExfU09GVF9GT1JDRTogMjAuMCwKICAgICAgICAgICAgICAgIFdBTExfRUxBU1RJQ0lUWTogMC4zMCwKICAgICAgICAgICAgICAgIFdBTExfRlJJQ1RJT046IDAuOTUsCiAgICAgICAgICAgICAgICBGTE9PUl9FTEFTVElDSVRZOiAwLjQwLAogICAgICAgICAgICAgICAgR09BTF9QT0NLRVRfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX1g6IDEyLjAsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9aOiAyNS4wLAogICAgICAgICAgICAgICAgR09BTF9QT0NLRVRfUkFESVVTOiA0NS4wLAogICAgICAgICAgICAgICAgTEFVTkNIX1NQRUVEX1NDQUxFOiAxLjAsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfQ0FQOiA4NS4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsYWIucmVmcmVzaFByZXZpZXcoKTsKICAgICAgICB9LAogICAgICAgIEFyY2FkZUN1cnZlOiAoKSA9PiB7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oQywgewogICAgICAgICAgICAgICAgTUFHTlVTX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ09FRkY6IDAuMTYsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ0FQOiA5MC4wLAogICAgICAgICAgICAgICAgU1BJTl9EUkFHOiAwLjI1LAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMTIsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX1FVQUQ6IDAuMDAxLAogICAgICAgICAgICAgICAgV0FMTF9TT0ZUX0ZPUkNFOiAzNS4wLAogICAgICAgICAgICAgICAgTEFVTkNIX1NQRUVEX0NBUDogMTEwLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oVEMsIHsKICAgICAgICAgICAgICAgIENVUlZFX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgICAgICAgICBDVVJWRV9TUElOX1NDQUxFOiAxNTAwLjAsCiAgICAgICAgICAgICAgICBDVVJWRV9TUElOX0NBUDogMzAwMC4wLAogICAgICAgICAgICAgICAgQ1VSVkVfUEVSRkVDVF9TUElOOiA3MDAuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfSwKICAgICAgICBTbmFwcHlSZWFsaXN0aWM6ICgpID0+IHsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihDLCB7CiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX0xJTkVBUjogMC4yNSwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDYsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ09FRkY6IDAuMDUsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ0FQOiA0MC4wLAogICAgICAgICAgICAgICAgU1BJTl9EUkFHOiAwLjc1LAogICAgICAgICAgICAgICAgU1RPUF9TUEVFRDogMC4wNSwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDcwLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0KICAgIH07CiAgICBwcmVzZXRzLmFkZChQLCAnVmFuaWxsYScpOwogICAgcHJlc2V0cy5hZGQoUCwgJ0FyY2FkZUN1cnZlJyk7CiAgICBwcmVzZXRzLmFkZChQLCAnU25hcHB5UmVhbGlzdGljJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFNuYXBzaG90IC8gRXhwb3J0CiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHNuYXBzaG90ID0gcm9vdC5hZGRGb2xkZXIoJ1NuYXBzaG90IC8gRXhwb3J0Jyk7CgogICAgY29uc3QgX3JvdW5kID0gKG4sIHBsYWNlcyA9IDQpID0+IHsKICAgICAgICBpZiAoIU51bWJlci5pc0Zpbml0ZShuKSkgcmV0dXJuIG51bGw7CiAgICAgICAgY29uc3QgcCA9IE1hdGgucG93KDEwLCBwbGFjZXMpOwogICAgICAgIHJldHVybiBNYXRoLnJvdW5kKG4gKiBwKSAvIHA7CiAgICB9OwoKICAgIGNvbnN0IF92MyA9ICh2LCBwbGFjZXMgPSA0KSA9PiB7CiAgICAgICAgaWYgKCF2KSByZXR1cm4gbnVsbDsKICAgICAgICByZXR1cm4gW19yb3VuZCh2LngsIHBsYWNlcyksIF9yb3VuZCh2LnksIHBsYWNlcyksIF9yb3VuZCh2LnosIHBsYWNlcyldOwogICAgfTsKCiAgICBjb25zdCBfY2xvbmVKc29uID0gKG9iaikgPT4gewogICAgICAgIGlmICghb2JqKSByZXR1cm4gbnVsbDsKICAgICAgICB0cnkgeyByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShvYmopKTsgfSBjYXRjaCAoZSkgeyByZXR1cm4gbnVsbDsgfQogICAgfTsKCiAgICBjb25zdCBfcGxheWVyU25hcCA9IChwKSA9PiB7CiAgICAgICAgaWYgKCFwKSByZXR1cm4gbnVsbDsKICAgICAgICBjb25zdCBhbmltID0gKHAuYWN0aXZlQWN0aW9uICYmIHAuYWN0aXZlQWN0aW9uLl9jbGlwKSA/IHAuYWN0aXZlQWN0aW9uLl9jbGlwLm5hbWUgOiAocC5zdGF0ZSB8fCBudWxsKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBuYW1lOiBwLmNoYXJhY3Rlck5hbWUgfHwgcC5uYW1lIHx8IG51bGwsCiAgICAgICAgICAgIHJvbGU6IHAucm9sZSB8fCBudWxsLAogICAgICAgICAgICBzdGF0ZTogcC5zdGF0ZSB8fCBudWxsLAogICAgICAgICAgICBoYXNCYWxsOiAhIXAuaGFzQmFsbCwKICAgICAgICAgICAgaXNUaHJvd2luZzogISFwLmlzVGhyb3dpbmcsCiAgICAgICAgICAgIGlzQ2hhcmdpbmc6ICEhcC5pc0NoYXJnaW5nLAogICAgICAgICAgICBpc0Rhc2hpbmc6ICEhcC5pc0Rhc2hpbmcsCiAgICAgICAgICAgIGRhc2hDb29sZG93bjogX3JvdW5kKHAuZGFzaENvb2xkb3duLCA0KSwKICAgICAgICAgICAgcG9zOiBfdjMocC5tZXNoICYmIHAubWVzaC5wb3NpdGlvbiksCiAgICAgICAgICAgIHZlbDogX3YzKHAudmVsb2NpdHkpLAogICAgICAgICAgICBpbnB1dDogX3YzKHAuaW5wdXRWZWN0b3IpLAogICAgICAgICAgICBzdGF0czogcC5zdGF0cyA/IF9jbG9uZUpzb24ocC5zdGF0cykgOiBudWxsLAogICAgICAgICAgICBhbmltCiAgICAgICAgfTsKICAgIH07CgogICAgY29uc3QgX3RlYW1TbmFwID0gKHQpID0+IHsKICAgICAgICBpZiAoIXQpIHJldHVybiBudWxsOwogICAgICAgIGNvbnN0IGFjdGl2ZSA9IHQuYWN0aXZlUGxheWVyID8gX3BsYXllclNuYXAodC5hY3RpdmVQbGF5ZXIpIDogbnVsbDsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBpZDogdC5pZCB8fCBudWxsLAogICAgICAgICAgICBzaWRlOiB0LnNpZGUsCiAgICAgICAgICAgIGlzSHVtYW46ICEhdC5pc0h1bWFuLAogICAgICAgICAgICBhaUVuYWJsZWQ6ICEhdC5haUVuYWJsZWQsCiAgICAgICAgICAgIGN1cnJlbnRGb3JtYXRpb246IHQuY3VycmVudEZvcm1hdGlvbiB8fCBudWxsLAogICAgICAgICAgICBhY3RpdmVQbGF5ZXI6IGFjdGl2ZSwKICAgICAgICAgICAgcGxheWVyczogQXJyYXkuaXNBcnJheSh0LnBsYXllcnMpID8gdC5wbGF5ZXJzLm1hcChfcGxheWVyU25hcCkgOiBbXQogICAgICAgIH07CiAgICB9OwoKICAgIGNvbnN0IGJ1aWxkU25hcHNob3QgPSAoKSA9PiB7CiAgICAgICAgY29uc3QgZ2FtZSA9IHRoaXMuZ2FtZSB8fCB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgfHwgbnVsbDsKICAgICAgICBjb25zdCBiYWxsID0gZ2FtZSAmJiBnYW1lLmVudGl0aWVzID8gZ2FtZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICBjb25zdCBjYW1NZ3IgPSBnYW1lID8gZ2FtZS5jYW1lcmFNYW5hZ2VyIDogbnVsbDsKICAgICAgICBjb25zdCBjYW0gPSAoY2FtTWdyICYmIGNhbU1nci5jYW1lcmEpID8gY2FtTWdyLmNhbWVyYSA6IChnYW1lID8gZ2FtZS5jYW1lcmEgOiBudWxsKTsKCiAgICAgICAgY29uc3QgYmFsbFNuYXAgPSBiYWxsID8gewogICAgICAgICAgICBzdGF0ZTogYmFsbC5zdGF0ZSB8fCBudWxsLAogICAgICAgICAgICBpc0ludmlzaWJsZTogISFiYWxsLmlzSW52aXNpYmxlLAogICAgICAgICAgICBob2xkZXI6IGJhbGwuaG9sZGVyID8gKGJhbGwuaG9sZGVyLmNoYXJhY3Rlck5hbWUgfHwgYmFsbC5ob2xkZXIubmFtZSB8fCBudWxsKSA6IG51bGwsCiAgICAgICAgICAgIGxhc3RIb2xkZXI6IGJhbGwubGFzdEhvbGRlciA/IChiYWxsLmxhc3RIb2xkZXIuY2hhcmFjdGVyTmFtZSB8fCBiYWxsLmxhc3RIb2xkZXIubmFtZSB8fCBudWxsKSA6IG51bGwsCiAgICAgICAgICAgIHBvczogX3YzKGJhbGwubWVzaCAmJiBiYWxsLm1lc2gucG9zaXRpb24pLAogICAgICAgICAgICB2ZWw6IF92MyhiYWxsLnZlbG9jaXR5KSwKICAgICAgICAgICAgYW5nVmVsOiBfdjMoYmFsbC5hbmd1bGFyVmVsb2NpdHkpLAogICAgICAgICAgICBwb3dlcjogX3JvdW5kKGJhbGwucG93ZXIsIDQpLAogICAgICAgICAgICBzaG90VHlwZTogYmFsbC5zaG90VHlwZSB8fCBudWxsCiAgICAgICAgfSA6IG51bGw7CgogICAgICAgIGNvbnN0IGNhbWVyYVNuYXAgPSBjYW0gPyB7CiAgICAgICAgICAgIHBvczogX3YzKGNhbS5wb3NpdGlvbiksCiAgICAgICAgICAgIHJvdDogY2FtLnJvdGF0aW9uID8gW19yb3VuZChjYW0ucm90YXRpb24ueCwgNCksIF9yb3VuZChjYW0ucm90YXRpb24ueSwgNCksIF9yb3VuZChjYW0ucm90YXRpb24ueiwgNCldIDogbnVsbCwKICAgICAgICAgICAgZm92OiBfcm91bmQoY2FtLmZvdiwgNCksCiAgICAgICAgICAgIG5lYXI6IF9yb3VuZChjYW0ubmVhciwgNiksCiAgICAgICAgICAgIGZhcjogX3JvdW5kKGNhbS5mYXIsIDQpCiAgICAgICAgfSA6IG51bGw7CgogICAgICAgIGNvbnN0IGNhbU1nclNuYXAgPSBjYW1NZ3IgPyB7CiAgICAgICAgICAgIG1vZGU6IGNhbU1nci5tb2RlIHx8IG51bGwsCiAgICAgICAgICAgIHRhcmdldE5hbWU6IChjYW1NZ3IudGFyZ2V0ICYmIChjYW1NZ3IudGFyZ2V0LmNoYXJhY3Rlck5hbWUgfHwgY2FtTWdyLnRhcmdldC5uYW1lKSkgfHwgbnVsbCwKICAgICAgICAgICAgc2V0dGluZ3M6IGNhbU1nci5zZXR0aW5ncyA/IF9jbG9uZUpzb24oY2FtTWdyLnNldHRpbmdzKSA6IG51bGwKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgY29uc3QgZGVidWdJTyA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPID8gd2luZG93LmZsdXguX2RlYnVnSU8gOiBudWxsOwogICAgICAgIGNvbnN0IGlucHV0U25hcCA9IGRlYnVnSU8gPyB7CiAgICAgICAgICAgIHNldHRpbmdzOiBkZWJ1Z0lPLnNldHRpbmdzID8gX2Nsb25lSnNvbihkZWJ1Z0lPLnNldHRpbmdzKSA6IG51bGwsCiAgICAgICAgICAgIHBlcmY6IGRlYnVnSU8ucGVyZiA/IF9jbG9uZUpzb24oZGVidWdJTy5wZXJmKSA6IG51bGwsCiAgICAgICAgICAgIG1vdmU6IChkZWJ1Z0lPLmlucHV0ICYmIGRlYnVnSU8uaW5wdXQubW92ZSkgPyB7CiAgICAgICAgICAgICAgICB0b3VjaElkOiBkZWJ1Z0lPLmlucHV0Lm1vdmUudG91Y2hJZCA/PyBudWxsLAogICAgICAgICAgICAgICAgZHJhZ2dpbmc6ICEhZGVidWdJTy5pbnB1dC5tb3ZlLmRyYWdnaW5nLAogICAgICAgICAgICAgICAgdmVjdG9yOiBkZWJ1Z0lPLmlucHV0Lm1vdmUudmVjdG9yID8gX2Nsb25lSnNvbihkZWJ1Z0lPLmlucHV0Lm1vdmUudmVjdG9yKSA6IG51bGwKICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgIGFpbTogKGRlYnVnSU8uaW5wdXQgJiYgZGVidWdJTy5pbnB1dC5haW0pID8gewogICAgICAgICAgICAgICAgdG91Y2hJZDogZGVidWdJTy5pbnB1dC5haW0udG91Y2hJZCA/PyBudWxsLAogICAgICAgICAgICAgICAgZHJhZ2dpbmc6ICEhZGVidWdJTy5pbnB1dC5haW0uZHJhZ2dpbmcsCiAgICAgICAgICAgICAgICB2ZWN0b3I6IGRlYnVnSU8uaW5wdXQuYWltLnZlY3RvciA/IF9jbG9uZUpzb24oZGVidWdJTy5pbnB1dC5haW0udmVjdG9yKSA6IG51bGwKICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgIHN3aXBlOiAoZGVidWdJTy5pbnB1dCAmJiBkZWJ1Z0lPLmlucHV0LnN3aXBlKSA/IHsKICAgICAgICAgICAgICAgIHRvdWNoSWQ6IGRlYnVnSU8uaW5wdXQuc3dpcGUudG91Y2hJZCA/PyBudWxsLAogICAgICAgICAgICAgICAgc3RhcnQ6IGRlYnVnSU8uaW5wdXQuc3dpcGUuc3RhcnQgPyBfY2xvbmVKc29uKGRlYnVnSU8uaW5wdXQuc3dpcGUuc3RhcnQpIDogbnVsbCwKICAgICAgICAgICAgICAgIHBvaW50czogQXJyYXkuaXNBcnJheShkZWJ1Z0lPLmlucHV0LnN3aXBlLnBvaW50cykgPyBkZWJ1Z0lPLmlucHV0LnN3aXBlLnBvaW50cy5zbGljZSgtMzIpLm1hcChfY2xvbmVKc29uKSA6IFtdCiAgICAgICAgICAgIH0gOiBudWxsCiAgICAgICAgfSA6IG51bGw7CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG1ldGE6IHsKICAgICAgICAgICAgICAgIHRpbWVzdGFtcElTTzogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLAogICAgICAgICAgICAgICAgaHJlZjogKHR5cGVvZiBsb2NhdGlvbiAhPT0gJ3VuZGVmaW5lZCcgJiYgbG9jYXRpb24uaHJlZikgPyBsb2NhdGlvbi5ocmVmIDogbnVsbCwKICAgICAgICAgICAgICAgIHVzZXJBZ2VudDogKHR5cGVvZiBuYXZpZ2F0b3IgIT09ICd1bmRlZmluZWQnICYmIG5hdmlnYXRvci51c2VyQWdlbnQpID8gbmF2aWdhdG9yLnVzZXJBZ2VudCA6IG51bGwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2FtZTogZ2FtZSA/IHsKICAgICAgICAgICAgICAgIHNjb3JlOiBnYW1lLnNjb3JlID8gX2Nsb25lSnNvbihnYW1lLnNjb3JlKSA6IG51bGwsCiAgICAgICAgICAgICAgICB0aW1lOiBfcm91bmQoZ2FtZS50aW1lLCA0KSwKICAgICAgICAgICAgICAgIGhhbGY6IGdhbWUuaGFsZiA/PyBudWxsLAogICAgICAgICAgICAgICAgaGFsZkR1cmF0aW9uOiBfcm91bmQoZ2FtZS5oYWxmRHVyYXRpb24sIDQpLAogICAgICAgICAgICAgICAgaXNPdmVydGltZTogISFnYW1lLmlzT3ZlcnRpbWUsCiAgICAgICAgICAgICAgICBpc0RlbW9Nb2RlOiAhIWdhbWUuaXNEZW1vTW9kZQogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgY29uZmlnOiB7CiAgICAgICAgICAgICAgICBCYWxsQ29uZmlnOiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguQmFsbENvbmZpZykgPyBfY2xvbmVKc29uKHdpbmRvdy5mbHV4LkJhbGxDb25maWcpIDogbnVsbCwKICAgICAgICAgICAgICAgIFRocm93Q29uZmlnOiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguVGhyb3dDb25maWcpID8gX2Nsb25lSnNvbih3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZykgOiBudWxsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNhbWVyYTogY2FtZXJhU25hcCwKICAgICAgICAgICAgY2FtZXJhTWFuYWdlcjogY2FtTWdyU25hcCwKICAgICAgICAgICAgYmFsbDogYmFsbFNuYXAsCiAgICAgICAgICAgIHRlYW1zOiBnYW1lID8gewogICAgICAgICAgICAgICAgaG9tZTogX3RlYW1TbmFwKGdhbWUudGVhbXMgJiYgZ2FtZS50ZWFtcy5ob21lKSwKICAgICAgICAgICAgICAgIGF3YXk6IF90ZWFtU25hcChnYW1lLnRlYW1zICYmIGdhbWUudGVhbXMuYXdheSkKICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgIGlucHV0OiBpbnB1dFNuYXAKICAgICAgICB9OwogICAgfTsKCiAgICBjb25zdCBfY29weVRleHQgPSBhc3luYyAodGV4dCkgPT4gewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChuYXZpZ2F0b3IuY2xpcGJvYXJkICYmIG5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KSB7CiAgICAgICAgICAgICAgICBhd2FpdCBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dCh0ZXh0KTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAvLyBGYWxsYmFjawogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IHRhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGV4dGFyZWEnKTsKICAgICAgICAgICAgdGEudmFsdWUgPSB0ZXh0OwogICAgICAgICAgICB0YS5zdHlsZS5wb3NpdGlvbiA9ICdmaXhlZCc7CiAgICAgICAgICAgIHRhLnN0eWxlLmxlZnQgPSAnLTk5OTlweCc7CiAgICAgICAgICAgIHRhLnN0eWxlLnRvcCA9ICctOTk5OXB4JzsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0YSk7CiAgICAgICAgICAgIHRhLmZvY3VzKCk7CiAgICAgICAgICAgIHRhLnNlbGVjdCgpOwogICAgICAgICAgICBjb25zdCBvayA9IGRvY3VtZW50LmV4ZWNDb21tYW5kKCdjb3B5Jyk7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGEpOwogICAgICAgICAgICByZXR1cm4gb2s7CiAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwoKICAgIGNvbnN0IF9kb3dubG9hZFRleHQgPSAoZmlsZW5hbWUsIHRleHQpID0+IHsKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCBibG9iID0gbmV3IEJsb2IoW3RleHRdLCB7IHR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJyB9KTsKICAgICAgICAgICAgY29uc3QgdXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTsKICAgICAgICAgICAgY29uc3QgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICAgICAgYS5ocmVmID0gdXJsOwogICAgICAgICAgICBhLmRvd25sb2FkID0gZmlsZW5hbWU7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoYSk7CiAgICAgICAgICAgIGEuY2xpY2soKTsKICAgICAgICAgICAgYS5yZW1vdmUoKTsKICAgICAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTCh1cmwpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdTbmFwc2hvdCBkb3dubG9hZCBmYWlsZWQ6JywgZSk7CiAgICAgICAgfQogICAgfTsKCiAgICBjb25zdCBzbmFwc2hvdEFjdGlvbnMgPSB7CiAgICAgICAgQ29weVNuYXBzaG90OiBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNuYXAgPSBidWlsZFNuYXBzaG90KCk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnN0cmluZ2lmeShzbmFwLCBudWxsLCAyKTsKICAgICAgICAgICAgY29uc3Qgb2sgPSBhd2FpdCBfY29weVRleHQodGV4dCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbU25hcHNob3RdJywgc25hcCk7CiAgICAgICAgICAgIGlmICghb2spIGNvbnNvbGUud2FybignU25hcHNob3Q6IGNvcHkgZmFpbGVkIChzZWUgY29uc29sZSkuJyk7CiAgICAgICAgfSwKICAgICAgICBEb3dubG9hZFNuYXBzaG90OiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHNuYXAgPSBidWlsZFNuYXBzaG90KCk7CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBKU09OLnN0cmluZ2lmeShzbmFwLCBudWxsLCAyKTsKICAgICAgICAgICAgX2Rvd25sb2FkVGV4dCgnc25hcHNob3QuanNvbicsIHRleHQpOwogICAgICAgICAgICBjb25zb2xlLmxvZygnW1NuYXBzaG90XScsIHNuYXApOwogICAgICAgIH0KICAgIH07CgogICAgc25hcHNob3QuYWRkKHNuYXBzaG90QWN0aW9ucywgJ0NvcHlTbmFwc2hvdCcpLm5hbWUoJ0NvcHkgSlNPTiBTbmFwc2hvdCcpOwogICAgc25hcHNob3QuYWRkKHNuYXBzaG90QWN0aW9ucywgJ0Rvd25sb2FkU25hcHNob3QnKS5uYW1lKCdEb3dubG9hZCBzbmFwc2hvdC5qc29uJyk7Cgp9CiAgICB9Cgp3aW5kb3cuZmx1eC5EZXZUb29scyA9IERldlRvb2xzOwoKICAgIERldlRvb2xzLnByb3RvdHlwZS5fc2V0dXBWaXN1YWxEZWJ1ZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignVmlzdWFsIERlYnVnZ2luZycpOwogICAgICAgIGNvbnN0IGR2ID0gdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcjsKICAgICAgICBpZiAoIWR2KSByZXR1cm47CgogICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgZW5hYmxlZDogZHYuZW5hYmxlZCwKICAgICAgICAgICAgaGl0Ym94ZXM6IGR2LnNob3dIaXRib3hlcywKICAgICAgICAgICAgdmVjdG9yczogZHYuc2hvd1ZlY3RvcnMsCiAgICAgICAgICAgIGFpOiBkdi5zaG93QUkKICAgICAgICB9OwoKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2VuYWJsZWQnKS5uYW1lKCdFbmFibGUgVmlzdWFsaXplcicpLm9uQ2hhbmdlKHYgPT4gZHYuZW5hYmxlZCA9IHYpOwogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnaGl0Ym94ZXMnKS5uYW1lKCdTaG93IEhpdGJveGVzJykub25DaGFuZ2UodiA9PiBkdi5zaG93SGl0Ym94ZXMgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3ZlY3RvcnMnKS5uYW1lKCdTaG93IFZlY3RvcnMnKS5vbkNoYW5nZSh2ID0+IGR2LnNob3dWZWN0b3JzID0gdik7CiAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhaScpLm5hbWUoJ1Nob3cgQUkgUGVyY2VwdGlvbicpLm9uQ2hhbmdlKHYgPT4gZHYuc2hvd0FJID0gdik7CiAgICB9OwoKICAgIERldlRvb2xzLnByb3RvdHlwZS5fc2V0dXBGWExhYiA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignRlggTGFiICYgVUkgVGVzdCcpOwogICAgICAgIAogICAgICAgIGNvbnN0IGdldFRhcmdldFBvcyA9ICgpID0+IHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgcmV0dXJuIHAgJiYgcC5tZXNoID8gcC5tZXNoLnBvc2l0aW9uIDogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMiwgMCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgZnhQYXJhbXMgPSB7CiAgICAgICAgICAgIFNwYXduVmVub206ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Zlbm9tJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bk5hcDogKCkgPT4gdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignbmFwJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bldpdGhlcjogKCkgPT4gdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignd2l0aGVyJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bkxlYXJuZWQ6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2xlYXJuZWQnLCBnZXRUYXJnZXRQb3MoKSksCiAgICAgICAgICAgIFNwYXduQ2xhc2g6ICgpID0+IHRoaXMuZ2FtZS5zcGF3bkNsYXNoKGdldFRhcmdldFBvcygpKSwKICAgICAgICB9OwoKICAgICAgICBjb25zdCBmeFN1YiA9IGZvbGRlci5hZGRGb2xkZXIoJ1BhcnRpY2xlcycpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduVmVub20nKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3bk5hcCcpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduV2l0aGVyJyk7CiAgICAgICAgZnhTdWIuYWRkKGZ4UGFyYW1zLCAnU3Bhd25MZWFybmVkJyk7CiAgICAgICAgZnhTdWIuYWRkKGZ4UGFyYW1zLCAnU3Bhd25DbGFzaCcpOwoKICAgICAgICBjb25zdCB0eHRQYXJhbXMgPSB7CiAgICAgICAgICAgIFRleHQ6ICJURVNUIiwKICAgICAgICAgICAgVHlwZTogImRhbWFnZSIsCiAgICAgICAgICAgIFNwYXduOiAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZih0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSAKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKHR4dFBhcmFtcy5UZXh0LCBnZXRUYXJnZXRQb3MoKSwgdHh0UGFyYW1zLlR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICAKICAgICAgICBjb25zdCB0eHRTdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdGbG9hdGluZyBUZXh0Jyk7CiAgICAgICAgdHh0U3ViLmFkZCh0eHRQYXJhbXMsICdUZXh0Jyk7CiAgICAgICAgdHh0U3ViLmFkZCh0eHRQYXJhbXMsICdUeXBlJywgWydkYW1hZ2UnLCAnaGVhbCcsICdzdGF0dXMnLCAndGVjaCcsICdjb21pYy1pbXBhY3QnLCAnY29taWMtYWN0aW9uJywgJ3NhdmUnLCAnYmxvY2snLCAnZGVmYXVsdCddKTsKICAgICAgICB0eHRTdWIuYWRkKHR4dFBhcmFtcywgJ1NwYXduJykubmFtZSgnU3Bhd24gVGV4dCcpOwoKICAgICAgICBjb25zdCBjYW1QYXJhbXMgPSB7CiAgICAgICAgICAgIFNoYWtlU21hbGw6ICgpID0+IHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuNSksCiAgICAgICAgICAgIFNoYWtlQmlnOiAoKSA9PiB0aGlzLmdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgyLjApLAogICAgICAgICAgICBJbXBhY3RMaWdodDogKCkgPT4gdGhpcy5nYW1lLnRyaWdnZXJJbXBhY3QoMC4xLCAnZGVmYXVsdCcpLAogICAgICAgICAgICBJbXBhY3RIZWF2eTogKCkgPT4gdGhpcy5nYW1lLnRyaWdnZXJJbXBhY3QoMC4yLCAnaGVhdnknKSwKICAgICAgICAgICAgSW1wYWN0U2hhdHRlcjogKCkgPT4gdGhpcy5nYW1lLnRyaWdnZXJJbXBhY3QoMC40LCAnc2hhdHRlcicpLAogICAgICAgIH07CgogICAgICAgIGNvbnN0IGNhbVN1YiA9IGZvbGRlci5hZGRGb2xkZXIoJ0NhbWVyYSAmIEltcGFjdCcpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnU2hha2VTbWFsbCcpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnU2hha2VCaWcnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ0ltcGFjdExpZ2h0Jyk7CiAgICAgICAgY2FtU3ViLmFkZChjYW1QYXJhbXMsICdJbXBhY3RIZWF2eScpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnSW1wYWN0U2hhdHRlcicpOwogICAgfTsKCgpEZXZUb29scy5wcm90b3R5cGUuX3NldHVwVmlzdWFscyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignQXNzZXQgRm9yZ2UnKTsKICAgICAgICAKICAgICAgICBjb25zdCBmb3JnZVN0YXRlID0gewogICAgICAgICAgICBhY3RpdmU6IGZhbHNlLAogICAgICAgICAgICBhc3NldE5hbWU6ICdUaWR1cycsCiAgICAgICAgICAgIGFuaW1OYW1lOiAnaWRsZScsCiAgICAgICAgICAgIHBvc1g6IDAsIHBvc1k6IDAsIHBvc1o6IDAsCiAgICAgICAgICAgIHJvdFg6IDAsIHJvdFk6IDAsIHJvdFo6IDAsCiAgICAgICAgICAgIHNjYWxlOiAxLjAsCiAgICAgICAgICAgIGNhbURpc3Q6IDUsIGNhbUhlaWdodDogMS41LCBjYW1Sb3Q6IDAKICAgICAgICB9OwoKICAgICAgICBjb25zdCBhc3NldHMgPSB7CiAgICAgICAgICAgICdUaWR1cyc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZGE3ODhiZWYyNThjNGYwYjhkOWVmMWFjYzE5YzU1NjcuZ2xiJywKICAgICAgICAgICAgJ1dha2thJzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy81OTExNGM5ODk1MTY0N2M5YjhkYTc0YjBiZDM2MzZjYi5nbGInLAogICAgICAgICAgICAnTGV0dHknOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzLzQzYWNlMzRjNmZkOTQyMTU5NjdlODQyYmY5MDlkYTVlLmdsYicsCiAgICAgICAgICAgICdEYXR0byc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZTZkNjdlY2IyZTRjNDcxNWJkNzNhNDA3OTVlMWQzZDUuZ2xiJywKICAgICAgICAgICAgJ0phc3N1JzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy84MjE2NDU5NTY3MzU0ZTYzOTU4ZDQxMDhkODI4ZGU5OC5nbGInLAogICAgICAgICAgICAnQm90dGEnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2FkMTU1ZWZlZGMwZDQ4ZmRhZDA5ZGEzZTFjYWU5Yzk3LmdsYicsCiAgICAgICAgICAgICdCYWxsJzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy81MjFhZTg3ODhlNTg0ZTM3OGE3OWQ5NzMyYTA3NTM1Ni5nbGInLAogICAgICAgICAgICAnR29hbCc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvYTUxNmJkOTBmYTdjNGRlZGI1ZGNiZmRmODAzZjEzZDUuZ2xiJwogICAgICAgIH07CgogICAgICAgIGxldCBjdXJyZW50QXNzZXQgPSBudWxsOwoKICAgICAgICBjb25zdCB1cGRhdGVUcmFuc2Zvcm0gPSAoKSA9PiB7CiAgICAgICAgICAgIGlmIChjdXJyZW50QXNzZXQpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRBc3NldC5wb3NpdGlvbi5zZXQoZm9yZ2VTdGF0ZS5wb3NYLCBmb3JnZVN0YXRlLnBvc1ksIGZvcmdlU3RhdGUucG9zWik7CiAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQucm90YXRpb24uc2V0KGZvcmdlU3RhdGUucm90WCwgZm9yZ2VTdGF0ZS5yb3RZLCBmb3JnZVN0YXRlLnJvdFopOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0LnNjYWxlLnNldFNjYWxhcihmb3JnZVN0YXRlLnNjYWxlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGNvbnN0IHVwZGF0ZUNhbWVyYSA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCFmb3JnZVN0YXRlLmFjdGl2ZSkgcmV0dXJuOwogICAgICAgICAgICAvLyBPcmJpdCBhcm91bmQgKDEwMDAsIFksIDEwMDApCiAgICAgICAgICAgIGNvbnN0IGN4ID0gMTAwMCArIE1hdGguc2luKGZvcmdlU3RhdGUuY2FtUm90KSAqIGZvcmdlU3RhdGUuY2FtRGlzdDsKICAgICAgICAgICAgY29uc3QgY3ogPSAxMDAwICsgTWF0aC5jb3MoZm9yZ2VTdGF0ZS5jYW1Sb3QpICogZm9yZ2VTdGF0ZS5jYW1EaXN0OwogICAgICAgICAgICB0aGlzLmdhbWUuY2FtZXJhLnBvc2l0aW9uLnNldChjeCwgZm9yZ2VTdGF0ZS5jYW1IZWlnaHQsIGN6KTsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhbWVyYS5sb29rQXQoMTAwMCwgZm9yZ2VTdGF0ZS5wb3NZICsgMSwgMTAwMCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgcGxheUFuaW1hdGlvbiA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aGlzLnZpek1peGVyIHx8ICF0aGlzLnZpekNsaXBzKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudml6TWl4ZXIuc3RvcEFsbEFjdGlvbigpOwogICAgICAgICAgICBpZiAoZm9yZ2VTdGF0ZS5hbmltTmFtZSA9PT0gJ25vbmUnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgY2xpcCA9IHRoaXMudml6Q2xpcHMuZmluZChjID0+IGMubmFtZSA9PT0gZm9yZ2VTdGF0ZS5hbmltTmFtZSk7CiAgICAgICAgICAgIGlmICghY2xpcCkgY2xpcCA9IHRoaXMudml6Q2xpcHMuZmluZChjID0+IGMubmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKGZvcmdlU3RhdGUuYW5pbU5hbWUudG9Mb3dlckNhc2UoKSkpOwogICAgICAgICAgICBpZiAoY2xpcCkgdGhpcy52aXpNaXhlci5jbGlwQWN0aW9uKGNsaXApLnBsYXkoKTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBzcGF3bkFzc2V0ID0gKCkgPT4gewogICAgICAgICAgICBpZiAoIXRoaXMudml6R3JvdXApIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENsZWFyIHByZXZpb3VzCiAgICAgICAgICAgIHdoaWxlKHRoaXMudml6R3JvdXAuY2hpbGRyZW4ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgY2hpbGQgPSB0aGlzLnZpekdyb3VwLmNoaWxkcmVuWzBdOwogICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cC5yZW1vdmUoY2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnZpek1peGVyID0gbnVsbDsKICAgICAgICAgICAgY3VycmVudEFzc2V0ID0gbnVsbDsKCiAgICAgICAgICAgIGNvbnN0IHVybCA9IGFzc2V0c1tmb3JnZVN0YXRlLmFzc2V0TmFtZV07CiAgICAgICAgICAgIGlmICghdXJsKSByZXR1cm47CgogICAgICAgICAgICBjb25zb2xlLmxvZygiRm9yZ2U6IFNwYXduaW5nIiwgZm9yZ2VTdGF0ZS5hc3NldE5hbWUpOwoKICAgICAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKHVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHdlIGFyZSBzdGlsbCBpbiBmb3JnZSBtb2RlIGJlZm9yZSBhZGRpbmcKICAgICAgICAgICAgICAgIGlmICghZm9yZ2VTdGF0ZS5hY3RpdmUpIHJldHVybjsKCiAgICAgICAgICAgICAgICBjb25zdCBtb2RlbCA9IGdsdGYuc2NlbmU7CiAgICAgICAgICAgICAgICB0aGlzLnZpekdyb3VwLmFkZChtb2RlbCk7CiAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQgPSBtb2RlbDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVzZXQgbW9kZWwgdHJhbnNmb3JtIHJlbGF0aXZlIHRvIGdyb3VwCiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgbW9kZWwucm90YXRpb24uc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdXBkYXRlVHJhbnNmb3JtKCk7CgogICAgICAgICAgICAgICAgaWYgKGdsdGYuYW5pbWF0aW9ucyAmJiBnbHRmLmFuaW1hdGlvbnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudml6TWl4ZXIgPSBuZXcgVEhSRUUuQW5pbWF0aW9uTWl4ZXIobW9kZWwpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudml6Q2xpcHMgPSBnbHRmLmFuaW1hdGlvbnM7CiAgICAgICAgICAgICAgICAgICAgcGxheUFuaW1hdGlvbigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCB0b2dnbGVGb3JnZSA9IChpc0FjdGl2ZSkgPT4gewogICAgICAgICAgICBmb3JnZVN0YXRlLmFjdGl2ZSA9IGlzQWN0aXZlOwogICAgICAgICAgICB0aGlzLmdhbWUuaXNGb3JnZU1vZGUgPSBpc0FjdGl2ZTsgLy8gQ3JpdGljYWw6IFRlbGwgbWFpbi5qcyB0byBzdG9wIGdhbWUgbG9vcAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVG9nZ2xlIEdhbWUgVmlzaWJpbGl0eSAoSGlkZSBldmVyeXRoaW5nIGluIHRoZSBtYWluIGFyZW5hKQogICAgICAgICAgICBjb25zdCBnYW1lTGF5ZXIgPSBbdGhpcy5nYW1lLnRlYW1zLmhvbWUsIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LCB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbF07CiAgICAgICAgICAgIGdhbWVMYXllci5mb3JFYWNoKHQgPT4gewogICAgICAgICAgICAgICAgaWYodCAmJiB0LnBsYXllcnMpIHQucGxheWVycy5mb3JFYWNoKHAgPT4geyBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gIWlzQWN0aXZlOyB9KTsKICAgICAgICAgICAgICAgIGVsc2UgaWYodCAmJiB0Lm1lc2gpIHQubWVzaC52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYod2luZG93LmZsdXguYXJlbmFNZXNoKSB3aW5kb3cuZmx1eC5hcmVuYU1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYod2luZG93LmZsdXguYXJlbmFNZXNoMikgd2luZG93LmZsdXguYXJlbmFNZXNoMi52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICBpZih0aGlzLmdhbWUuc3RhZGl1bSAmJiB0aGlzLmdhbWUuc3RhZGl1bS5jb250YWluZXIpIHRoaXMuZ2FtZS5zdGFkaXVtLmNvbnRhaW5lci52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICBpZih0aGlzLmdhbWUud2F0ZXJPdmVybGF5ICYmIHRoaXMuZ2FtZS53YXRlck92ZXJsYXkubWVzaCkgdGhpcy5nYW1lLndhdGVyT3ZlcmxheS5tZXNoLnZpc2libGUgPSAhaXNBY3RpdmU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIaWRlIFVJCiAgICAgICAgICAgIGNvbnN0IHVpID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJyk7CiAgICAgICAgICAgIGlmKHVpKSB1aS5zdHlsZS5kaXNwbGF5ID0gaXNBY3RpdmUgPyAnbm9uZScgOiAnZmxleCc7CgogICAgICAgICAgICBpZiAoaXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgIC8vIEluaXRpYWxpemUgRm9yZ2UgU2NlbmUgaWYgbmVlZGVkCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMudml6R3JvdXBQYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekdyb3VwUGFyZW50ID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZCh0aGlzLnZpekdyb3VwUGFyZW50KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekdyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cC5wb3NpdGlvbi5zZXQoMTAwMCwgMCwgMTAwMCk7IC8vIEZhciBhd2F5IGZyb20gYXJlbmEKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekdyb3VwUGFyZW50LmFkZCh0aGlzLnZpekdyb3VwKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ3JpZCA9IG5ldyBUSFJFRS5HcmlkSGVscGVyKDIwLCAyMCwgMHgwMGZmZmYsIDB4NDQ0NDQ0KTsKICAgICAgICAgICAgICAgICAgICBncmlkLnBvc2l0aW9uLnNldCgxMDAwLCAwLCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekdyb3VwUGFyZW50LmFkZChncmlkKTsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpMaWdodCA9IG5ldyBUSFJFRS5EaXJlY3Rpb25hbExpZ2h0KDB4ZmZmZmZmLCAxLjApOwogICAgICAgICAgICAgICAgICAgIHRoaXMudml6TGlnaHQucG9zaXRpb24uc2V0KDEwMDUsIDEwLCAxMDA1KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKHRoaXMudml6TGlnaHQpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMudml6QW1iaWVudCA9IG5ldyBUSFJFRS5BbWJpZW50TGlnaHQoMHg0MDQwNDApOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy52aXpBbWJpZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudml6TGlnaHQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnZpekFtYmllbnQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNwYXduQXNzZXQoKTsKICAgICAgICAgICAgICAgIHVwZGF0ZUNhbWVyYSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBSZXN0b3JlIEdhbWUKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZpekdyb3VwUGFyZW50KSB0aGlzLnZpekdyb3VwUGFyZW50LnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZpekxpZ2h0KSB0aGlzLnZpekxpZ2h0LnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZpekFtYmllbnQpIHRoaXMudml6QW1iaWVudC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNuYXAgY2FtZXJhIGJhY2sgdG8gZ2FtZSB0YXJnZXQKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FtZXJhTWFuYWdlcikgdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmb2xkZXIuYWRkKGZvcmdlU3RhdGUsICdhY3RpdmUnKS5uYW1lKCdFbmFibGUgRm9yZ2UnKS5vbkNoYW5nZSh0b2dnbGVGb3JnZSk7CiAgICAgICAgZm9sZGVyLmFkZChmb3JnZVN0YXRlLCAnYXNzZXROYW1lJywgT2JqZWN0LmtleXMoYXNzZXRzKSkubmFtZSgnU2VsZWN0IEFzc2V0Jykub25DaGFuZ2Uoc3Bhd25Bc3NldCk7CiAgICAgICAgCiAgICAgICAgY29uc3QgdGYgPSBmb2xkZXIuYWRkRm9sZGVyKCdUcmFuc2Zvcm0nKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3Bvc1gnLCAtNSwgNSkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3Bvc1knLCAtNSwgNSkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3Bvc1onLCAtNSwgNSkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3JvdFgnLCAwLCA2LjI4KS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwogICAgICAgIHRmLmFkZChmb3JnZVN0YXRlLCAncm90WScsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdyb3RaJywgMCwgNi4yOCkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3NjYWxlJywgMC4xLCAzLjApLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CgogICAgICAgIGZvbGRlci5hZGQoZm9yZ2VTdGF0ZSwgJ2FuaW1OYW1lJywgWydub25lJywgJ2lkbGUnLCAnc3dpbScsICd0aHJvdycsICdjYXRjaCcsICdyZWFjdCddKS5uYW1lKCdBbmltYXRpb24nKS5vbkNoYW5nZShwbGF5QW5pbWF0aW9uKTsKCiAgICAgICAgY29uc3QgY2YgPSBmb2xkZXIuYWRkRm9sZGVyKCdDYW1lcmEnKTsKICAgICAgICBjZi5hZGQoZm9yZ2VTdGF0ZSwgJ2NhbURpc3QnLCAyLCAxNSkub25DaGFuZ2UodXBkYXRlQ2FtZXJhKTsKICAgICAgICBjZi5hZGQoZm9yZ2VTdGF0ZSwgJ2NhbUhlaWdodCcsIDAsIDEwKS5vbkNoYW5nZSh1cGRhdGVDYW1lcmEpOwogICAgICAgIGNmLmFkZChmb3JnZVN0YXRlLCAnY2FtUm90JywgMCwgNi4yOCkub25DaGFuZ2UodXBkYXRlQ2FtZXJhKTsKCiAgICAgICAgLy8gSG9vayBHYW1lIExvb3AKICAgICAgICBjb25zdCBvcmlnaW5hbFVwZGF0ZSA9IHRoaXMuZ2FtZS51cGRhdGUuYmluZCh0aGlzLmdhbWUpOwogICAgICAgIHRoaXMuZ2FtZS51cGRhdGUgPSAoZHQpID0+IHsKICAgICAgICAgICAgaWYgKGZvcmdlU3RhdGUuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBGb3JnZSBNb2RlOiBPbmx5IHVwZGF0ZSBmb3JnZSBjb21wb25lbnRzIGFuZCByZW5kZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZpek1peGVyKSB0aGlzLnZpek1peGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZvcmNlIENhbWVyYSBVcGRhdGUgaGVyZSBzaW5jZSBtYWluLmpzIGxvb3AgaXMgc2tpcHBlZAogICAgICAgICAgICAgICAgdXBkYXRlQ2FtZXJhKCk7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5yZW5kZXJlciAmJiB0aGlzLmdhbWUuc2NlbmUgJiYgdGhpcy5nYW1lLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5yZW5kZXJlci5yZW5kZXIodGhpcy5nYW1lLnNjZW5lLCB0aGlzLmdhbWUuY2FtZXJhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE5vcm1hbCBNb2RlOiBSdW4gc3RhbmRhcmQgZ2FtZSB1cGRhdGUKICAgICAgICAgICAgICAgIG9yaWdpbmFsVXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9Owp9KSgpOw==","DebugVisualizer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBEZWJ1Z1Zpc3VhbGl6ZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0hpdGJveGVzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd1ZlY3RvcnMgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zaG93QUkgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMudmlzdWFscyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hdGVyaWFscwogICAgICAgICAgICB0aGlzLm1hdFRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4yIH0pOwogICAgICAgICAgICB0aGlzLm1hdENhdGNoID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZjAwLCB3aXJlZnJhbWU6IHRydWUsIHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjIgfSk7CiAgICAgICAgICAgIHRoaXMubWF0VmVsID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZjAwIH0pOyAvLyBZZWxsb3cgVmVsb2NpdHkKICAgICAgICAgICAgdGhpcy5tYXRJbnB1dCA9IG5ldyBUSFJFRS5MaW5lQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiB9KTsgLy8gQ3lhbiBJbnB1dAogICAgICAgICAgICB0aGlzLm1hdEFJID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmYwMGZmIH0pOyAvLyBNYWdlbnRhIEFJIFBlcmNlcHRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJpZXMKICAgICAgICAgICAgdGhpcy5nZW9DeWxpbmRlciA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEsIDEsIDAuMSwgMTYpOwogICAgICAgICAgICB0aGlzLmdlb0N5bGluZGVyLnRyYW5zbGF0ZSgwLCAwLjA1LCAwKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWQpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZpc3VhbHMuc2l6ZSA+IDApIHRoaXMuY2xlYXIoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lIHx8ICFnYW1lLnRlYW1zLmhvbWUpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGVudGl0aWVzID0gWwogICAgICAgICAgICAgICAgLi4uZ2FtZS50ZWFtcy5ob21lLnBsYXllcnMsCiAgICAgICAgICAgICAgICAuLi5nYW1lLnRlYW1zLmF3YXkucGxheWVycywKICAgICAgICAgICAgICAgIGdhbWUuZW50aXRpZXMuYmFsbAogICAgICAgICAgICBdOwoKICAgICAgICAgICAgZW50aXRpZXMuZm9yRWFjaChlID0+IHsKICAgICAgICAgICAgICAgIGlmICghZSB8fCAhZS5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCB2ID0gdGhpcy52aXN1YWxzLmdldChlKTsKICAgICAgICAgICAgICAgIGlmICghdikgewogICAgICAgICAgICAgICAgICAgIHYgPSB0aGlzLmNyZWF0ZVZpc3VhbChlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpc3VhbHMuc2V0KGUsIHYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWwoZSwgdik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgY3JlYXRlVmlzdWFsKGVudGl0eSkgewogICAgICAgICAgICBjb25zdCBncm91cCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZChncm91cCk7CgogICAgICAgICAgICAvLyBIaXRib3hlcwogICAgICAgICAgICBjb25zdCB0YWNrbGUgPSBuZXcgVEhSRUUuTWVzaCh0aGlzLmdlb0N5bGluZGVyLCB0aGlzLm1hdFRhY2tsZSk7CiAgICAgICAgICAgIGNvbnN0IGNhdGNoUiA9IG5ldyBUSFJFRS5NZXNoKHRoaXMuZ2VvQ3lsaW5kZXIsIHRoaXMubWF0Q2F0Y2gpOwogICAgICAgICAgICBncm91cC5hZGQodGFja2xlKTsKICAgICAgICAgICAgZ3JvdXAuYWRkKGNhdGNoUik7CgogICAgICAgICAgICAvLyBMaW5lcwogICAgICAgICAgICBjb25zdCB2ZWxMaW5lID0gdGhpcy5jcmVhdGVMaW5lKHRoaXMubWF0VmVsKTsKICAgICAgICAgICAgY29uc3QgaW5wdXRMaW5lID0gdGhpcy5jcmVhdGVMaW5lKHRoaXMubWF0SW5wdXQpOwogICAgICAgICAgICBjb25zdCBhaUxpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRBSSk7IC8vIExpbmUgdG8gcGVyY2VpdmVkIHRhcmdldAogICAgICAgICAgICAKICAgICAgICAgICAgZ3JvdXAuYWRkKHZlbExpbmUpOwogICAgICAgICAgICBncm91cC5hZGQoaW5wdXRMaW5lKTsKICAgICAgICAgICAgZ3JvdXAuYWRkKGFpTGluZSk7CgogICAgICAgICAgICByZXR1cm4geyBncm91cCwgdGFja2xlLCBjYXRjaFIsIHZlbExpbmUsIGlucHV0TGluZSwgYWlMaW5lIH07CiAgICAgICAgfQoKICAgICAgICBjcmVhdGVMaW5lKG1hdCkgewogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKS5zZXRGcm9tUG9pbnRzKFtuZXcgVEhSRUUuVmVjdG9yMygpLCBuZXcgVEhSRUUuVmVjdG9yMygpXSk7CiAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuTGluZShnZW8sIG1hdCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVMaW5lKGxpbmUsIHN0YXJ0LCBlbmQpIHsKICAgICAgICAgICAgY29uc3QgcG9zID0gbGluZS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLmFycmF5OwogICAgICAgICAgICBwb3NbMF0gPSBzdGFydC54OyBwb3NbMV0gPSBzdGFydC55OyBwb3NbMl0gPSBzdGFydC56OwogICAgICAgICAgICBwb3NbM10gPSBlbmQueDsgcG9zWzRdID0gZW5kLnk7IHBvc1s1XSA9IGVuZC56OwogICAgICAgICAgICBsaW5lLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24ubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICBsaW5lLnZpc2libGUgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFsKGUsIHYpIHsKICAgICAgICAgICAgdi5ncm91cC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhpdGJveGVzIChMb2NhbCB0byBlbnRpdHkgcG9zaXRpb24pCiAgICAgICAgICAgIHYudGFja2xlLnBvc2l0aW9uLmNvcHkoZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdi5jYXRjaFIucG9zaXRpb24uY29weShlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd0hpdGJveGVzICYmIGUucm9sZSkgewogICAgICAgICAgICAgICAgdi50YWNrbGUudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBjb25zdCByVCA9IGUudGFja2xlUmFkaXVzIHx8IDIuNTsKICAgICAgICAgICAgICAgIHYudGFja2xlLnNjYWxlLnNldChyVCwgMSwgclQpOwoKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgLy8gTG9naWMgZnJvbSBtYWluLmpzIGNoZWNrQmFsbEdyYWIKICAgICAgICAgICAgICAgIGNvbnN0IHJDID0gZS5pc0Rhc2hpbmcgPyA0LjAgOiAyLjU7IAogICAgICAgICAgICAgICAgdi5jYXRjaFIuc2NhbGUuc2V0KHJDLCAxLCByQyk7CiAgICAgICAgICAgICAgICB2LmNhdGNoUi5wb3NpdGlvbi55ID0gZS5tZXNoLnBvc2l0aW9uLnkgKyAwLjE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2LnRhY2tsZS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB2LmNhdGNoUi52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFZlY3RvcnMgKEdsb2JhbCBsaW5lcykKICAgICAgICAgICAgY29uc3Qgb3JpZ2luID0gZS5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgIG9yaWdpbi55ICs9IDEuMDsgLy8gTGlmdCB1cAoKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd1ZlY3RvcnMpIHsKICAgICAgICAgICAgICAgIC8vIFZlbG9jaXR5CiAgICAgICAgICAgICAgICBpZiAoZS52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGVuZCA9IG9yaWdpbi5jbG9uZSgpLmFkZChlLnZlbG9jaXR5KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxpbmUodi52ZWxMaW5lLCBvcmlnaW4sIGVuZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBJbnB1dAogICAgICAgICAgICAgICAgaWYgKGUuaW5wdXRWZWN0b3IgJiYgZS5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGVuZCA9IG9yaWdpbi5jbG9uZSgpLmFkZChlLmlucHV0VmVjdG9yLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMy4wKSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVMaW5lKHYuaW5wdXRMaW5lLCBvcmlnaW4sIGVuZCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHYuaW5wdXRMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYudmVsTGluZS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB2LmlucHV0TGluZS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFJCiAgICAgICAgICAgIGlmICh0aGlzLnNob3dBSSAmJiBlLnBlcmNlaXZlZFRhcmdldFBvcykgewogICAgICAgICAgICAgICAgLy8gRHJhdyBsaW5lIHRvIHBlcmNlaXZlZCB0YXJnZXQKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTGluZSh2LmFpTGluZSwgb3JpZ2luLCBlLnBlcmNlaXZlZFRhcmdldFBvcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2LmFpTGluZS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNsZWFyKCkgewogICAgICAgICAgICB0aGlzLnZpc3VhbHMuZm9yRWFjaCh2ID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuc2NlbmUucmVtb3ZlKHYuZ3JvdXApOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy52aXN1YWxzLmNsZWFyKCk7CiAgICAgICAgfQogICAgfQogICAgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyID0gRGVidWdWaXN1YWxpemVyOwp9KSgpOw==","./DebugVisualizer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBEZWJ1Z1Zpc3VhbGl6ZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0hpdGJveGVzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd1ZlY3RvcnMgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zaG93QUkgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMudmlzdWFscyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hdGVyaWFscwogICAgICAgICAgICB0aGlzLm1hdFRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4yIH0pOwogICAgICAgICAgICB0aGlzLm1hdENhdGNoID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZjAwLCB3aXJlZnJhbWU6IHRydWUsIHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjIgfSk7CiAgICAgICAgICAgIHRoaXMubWF0VmVsID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZjAwIH0pOyAvLyBZZWxsb3cgVmVsb2NpdHkKICAgICAgICAgICAgdGhpcy5tYXRJbnB1dCA9IG5ldyBUSFJFRS5MaW5lQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiB9KTsgLy8gQ3lhbiBJbnB1dAogICAgICAgICAgICB0aGlzLm1hdEFJID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmYwMGZmIH0pOyAvLyBNYWdlbnRhIEFJIFBlcmNlcHRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJpZXMKICAgICAgICAgICAgdGhpcy5nZW9DeWxpbmRlciA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEsIDEsIDAuMSwgMTYpOwogICAgICAgICAgICB0aGlzLmdlb0N5bGluZGVyLnRyYW5zbGF0ZSgwLCAwLjA1LCAwKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWQpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZpc3VhbHMuc2l6ZSA+IDApIHRoaXMuY2xlYXIoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lIHx8ICFnYW1lLnRlYW1zLmhvbWUpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGVudGl0aWVzID0gWwogICAgICAgICAgICAgICAgLi4uZ2FtZS50ZWFtcy5ob21lLnBsYXllcnMsCiAgICAgICAgICAgICAgICAuLi5nYW1lLnRlYW1zLmF3YXkucGxheWVycywKICAgICAgICAgICAgICAgIGdhbWUuZW50aXRpZXMuYmFsbAogICAgICAgICAgICBdOwoKICAgICAgICAgICAgZW50aXRpZXMuZm9yRWFjaChlID0+IHsKICAgICAgICAgICAgICAgIGlmICghZSB8fCAhZS5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCB2ID0gdGhpcy52aXN1YWxzLmdldChlKTsKICAgICAgICAgICAgICAgIGlmICghdikgewogICAgICAgICAgICAgICAgICAgIHYgPSB0aGlzLmNyZWF0ZVZpc3VhbChlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpc3VhbHMuc2V0KGUsIHYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWwoZSwgdik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgY3JlYXRlVmlzdWFsKGVudGl0eSkgewogICAgICAgICAgICBjb25zdCBncm91cCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZChncm91cCk7CgogICAgICAgICAgICAvLyBIaXRib3hlcwogICAgICAgICAgICBjb25zdCB0YWNrbGUgPSBuZXcgVEhSRUUuTWVzaCh0aGlzLmdlb0N5bGluZGVyLCB0aGlzLm1hdFRhY2tsZSk7CiAgICAgICAgICAgIGNvbnN0IGNhdGNoUiA9IG5ldyBUSFJFRS5NZXNoKHRoaXMuZ2VvQ3lsaW5kZXIsIHRoaXMubWF0Q2F0Y2gpOwogICAgICAgICAgICBncm91cC5hZGQodGFja2xlKTsKICAgICAgICAgICAgZ3JvdXAuYWRkKGNhdGNoUik7CgogICAgICAgICAgICAvLyBMaW5lcwogICAgICAgICAgICBjb25zdCB2ZWxMaW5lID0gdGhpcy5jcmVhdGVMaW5lKHRoaXMubWF0VmVsKTsKICAgICAgICAgICAgY29uc3QgaW5wdXRMaW5lID0gdGhpcy5jcmVhdGVMaW5lKHRoaXMubWF0SW5wdXQpOwogICAgICAgICAgICBjb25zdCBhaUxpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRBSSk7IC8vIExpbmUgdG8gcGVyY2VpdmVkIHRhcmdldAogICAgICAgICAgICAKICAgICAgICAgICAgZ3JvdXAuYWRkKHZlbExpbmUpOwogICAgICAgICAgICBncm91cC5hZGQoaW5wdXRMaW5lKTsKICAgICAgICAgICAgZ3JvdXAuYWRkKGFpTGluZSk7CgogICAgICAgICAgICByZXR1cm4geyBncm91cCwgdGFja2xlLCBjYXRjaFIsIHZlbExpbmUsIGlucHV0TGluZSwgYWlMaW5lIH07CiAgICAgICAgfQoKICAgICAgICBjcmVhdGVMaW5lKG1hdCkgewogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKS5zZXRGcm9tUG9pbnRzKFtuZXcgVEhSRUUuVmVjdG9yMygpLCBuZXcgVEhSRUUuVmVjdG9yMygpXSk7CiAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuTGluZShnZW8sIG1hdCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVMaW5lKGxpbmUsIHN0YXJ0LCBlbmQpIHsKICAgICAgICAgICAgY29uc3QgcG9zID0gbGluZS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLmFycmF5OwogICAgICAgICAgICBwb3NbMF0gPSBzdGFydC54OyBwb3NbMV0gPSBzdGFydC55OyBwb3NbMl0gPSBzdGFydC56OwogICAgICAgICAgICBwb3NbM10gPSBlbmQueDsgcG9zWzRdID0gZW5kLnk7IHBvc1s1XSA9IGVuZC56OwogICAgICAgICAgICBsaW5lLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24ubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICBsaW5lLnZpc2libGUgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFsKGUsIHYpIHsKICAgICAgICAgICAgdi5ncm91cC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhpdGJveGVzIChMb2NhbCB0byBlbnRpdHkgcG9zaXRpb24pCiAgICAgICAgICAgIHYudGFja2xlLnBvc2l0aW9uLmNvcHkoZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdi5jYXRjaFIucG9zaXRpb24uY29weShlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd0hpdGJveGVzICYmIGUucm9sZSkgewogICAgICAgICAgICAgICAgdi50YWNrbGUudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBjb25zdCByVCA9IGUudGFja2xlUmFkaXVzIHx8IDIuNTsKICAgICAgICAgICAgICAgIHYudGFja2xlLnNjYWxlLnNldChyVCwgMSwgclQpOwoKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgLy8gTG9naWMgZnJvbSBtYWluLmpzIGNoZWNrQmFsbEdyYWIKICAgICAgICAgICAgICAgIGNvbnN0IHJDID0gZS5pc0Rhc2hpbmcgPyA0LjAgOiAyLjU7IAogICAgICAgICAgICAgICAgdi5jYXRjaFIuc2NhbGUuc2V0KHJDLCAxLCByQyk7CiAgICAgICAgICAgICAgICB2LmNhdGNoUi5wb3NpdGlvbi55ID0gZS5tZXNoLnBvc2l0aW9uLnkgKyAwLjE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2LnRhY2tsZS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB2LmNhdGNoUi52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFZlY3RvcnMgKEdsb2JhbCBsaW5lcykKICAgICAgICAgICAgY29uc3Qgb3JpZ2luID0gZS5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgIG9yaWdpbi55ICs9IDEuMDsgLy8gTGlmdCB1cAoKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd1ZlY3RvcnMpIHsKICAgICAgICAgICAgICAgIC8vIFZlbG9jaXR5CiAgICAgICAgICAgICAgICBpZiAoZS52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGVuZCA9IG9yaWdpbi5jbG9uZSgpLmFkZChlLnZlbG9jaXR5KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxpbmUodi52ZWxMaW5lLCBvcmlnaW4sIGVuZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBJbnB1dAogICAgICAgICAgICAgICAgaWYgKGUuaW5wdXRWZWN0b3IgJiYgZS5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGVuZCA9IG9yaWdpbi5jbG9uZSgpLmFkZChlLmlucHV0VmVjdG9yLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMy4wKSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVMaW5lKHYuaW5wdXRMaW5lLCBvcmlnaW4sIGVuZCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHYuaW5wdXRMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYudmVsTGluZS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB2LmlucHV0TGluZS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFJCiAgICAgICAgICAgIGlmICh0aGlzLnNob3dBSSAmJiBlLnBlcmNlaXZlZFRhcmdldFBvcykgewogICAgICAgICAgICAgICAgLy8gRHJhdyBsaW5lIHRvIHBlcmNlaXZlZCB0YXJnZXQKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTGluZSh2LmFpTGluZSwgb3JpZ2luLCBlLnBlcmNlaXZlZFRhcmdldFBvcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2LmFpTGluZS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNsZWFyKCkgewogICAgICAgICAgICB0aGlzLnZpc3VhbHMuZm9yRWFjaCh2ID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuc2NlbmUucmVtb3ZlKHYuZ3JvdXApOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy52aXN1YWxzLmNsZWFyKCk7CiAgICAgICAgfQogICAgfQogICAgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyID0gRGVidWdWaXN1YWxpemVyOwp9KSgpOw==","/DebugVisualizer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBEZWJ1Z1Zpc3VhbGl6ZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0hpdGJveGVzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd1ZlY3RvcnMgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zaG93QUkgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMudmlzdWFscyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hdGVyaWFscwogICAgICAgICAgICB0aGlzLm1hdFRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4yIH0pOwogICAgICAgICAgICB0aGlzLm1hdENhdGNoID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZjAwLCB3aXJlZnJhbWU6IHRydWUsIHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjIgfSk7CiAgICAgICAgICAgIHRoaXMubWF0VmVsID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZjAwIH0pOyAvLyBZZWxsb3cgVmVsb2NpdHkKICAgICAgICAgICAgdGhpcy5tYXRJbnB1dCA9IG5ldyBUSFJFRS5MaW5lQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiB9KTsgLy8gQ3lhbiBJbnB1dAogICAgICAgICAgICB0aGlzLm1hdEFJID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmYwMGZmIH0pOyAvLyBNYWdlbnRhIEFJIFBlcmNlcHRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJpZXMKICAgICAgICAgICAgdGhpcy5nZW9DeWxpbmRlciA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEsIDEsIDAuMSwgMTYpOwogICAgICAgICAgICB0aGlzLmdlb0N5bGluZGVyLnRyYW5zbGF0ZSgwLCAwLjA1LCAwKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWQpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnZpc3VhbHMuc2l6ZSA+IDApIHRoaXMuY2xlYXIoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lIHx8ICFnYW1lLnRlYW1zLmhvbWUpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGVudGl0aWVzID0gWwogICAgICAgICAgICAgICAgLi4uZ2FtZS50ZWFtcy5ob21lLnBsYXllcnMsCiAgICAgICAgICAgICAgICAuLi5nYW1lLnRlYW1zLmF3YXkucGxheWVycywKICAgICAgICAgICAgICAgIGdhbWUuZW50aXRpZXMuYmFsbAogICAgICAgICAgICBdOwoKICAgICAgICAgICAgZW50aXRpZXMuZm9yRWFjaChlID0+IHsKICAgICAgICAgICAgICAgIGlmICghZSB8fCAhZS5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCB2ID0gdGhpcy52aXN1YWxzLmdldChlKTsKICAgICAgICAgICAgICAgIGlmICghdikgewogICAgICAgICAgICAgICAgICAgIHYgPSB0aGlzLmNyZWF0ZVZpc3VhbChlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpc3VhbHMuc2V0KGUsIHYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWwoZSwgdik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgY3JlYXRlVmlzdWFsKGVudGl0eSkgewogICAgICAgICAgICBjb25zdCBncm91cCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZChncm91cCk7CgogICAgICAgICAgICAvLyBIaXRib3hlcwogICAgICAgICAgICBjb25zdCB0YWNrbGUgPSBuZXcgVEhSRUUuTWVzaCh0aGlzLmdlb0N5bGluZGVyLCB0aGlzLm1hdFRhY2tsZSk7CiAgICAgICAgICAgIGNvbnN0IGNhdGNoUiA9IG5ldyBUSFJFRS5NZXNoKHRoaXMuZ2VvQ3lsaW5kZXIsIHRoaXMubWF0Q2F0Y2gpOwogICAgICAgICAgICBncm91cC5hZGQodGFja2xlKTsKICAgICAgICAgICAgZ3JvdXAuYWRkKGNhdGNoUik7CgogICAgICAgICAgICAvLyBMaW5lcwogICAgICAgICAgICBjb25zdCB2ZWxMaW5lID0gdGhpcy5jcmVhdGVMaW5lKHRoaXMubWF0VmVsKTsKICAgICAgICAgICAgY29uc3QgaW5wdXRMaW5lID0gdGhpcy5jcmVhdGVMaW5lKHRoaXMubWF0SW5wdXQpOwogICAgICAgICAgICBjb25zdCBhaUxpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRBSSk7IC8vIExpbmUgdG8gcGVyY2VpdmVkIHRhcmdldAogICAgICAgICAgICAKICAgICAgICAgICAgZ3JvdXAuYWRkKHZlbExpbmUpOwogICAgICAgICAgICBncm91cC5hZGQoaW5wdXRMaW5lKTsKICAgICAgICAgICAgZ3JvdXAuYWRkKGFpTGluZSk7CgogICAgICAgICAgICByZXR1cm4geyBncm91cCwgdGFja2xlLCBjYXRjaFIsIHZlbExpbmUsIGlucHV0TGluZSwgYWlMaW5lIH07CiAgICAgICAgfQoKICAgICAgICBjcmVhdGVMaW5lKG1hdCkgewogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKS5zZXRGcm9tUG9pbnRzKFtuZXcgVEhSRUUuVmVjdG9yMygpLCBuZXcgVEhSRUUuVmVjdG9yMygpXSk7CiAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuTGluZShnZW8sIG1hdCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVMaW5lKGxpbmUsIHN0YXJ0LCBlbmQpIHsKICAgICAgICAgICAgY29uc3QgcG9zID0gbGluZS5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLmFycmF5OwogICAgICAgICAgICBwb3NbMF0gPSBzdGFydC54OyBwb3NbMV0gPSBzdGFydC55OyBwb3NbMl0gPSBzdGFydC56OwogICAgICAgICAgICBwb3NbM10gPSBlbmQueDsgcG9zWzRdID0gZW5kLnk7IHBvc1s1XSA9IGVuZC56OwogICAgICAgICAgICBsaW5lLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24ubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICBsaW5lLnZpc2libGUgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFsKGUsIHYpIHsKICAgICAgICAgICAgdi5ncm91cC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhpdGJveGVzIChMb2NhbCB0byBlbnRpdHkgcG9zaXRpb24pCiAgICAgICAgICAgIHYudGFja2xlLnBvc2l0aW9uLmNvcHkoZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdi5jYXRjaFIucG9zaXRpb24uY29weShlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd0hpdGJveGVzICYmIGUucm9sZSkgewogICAgICAgICAgICAgICAgdi50YWNrbGUudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBjb25zdCByVCA9IGUudGFja2xlUmFkaXVzIHx8IDIuNTsKICAgICAgICAgICAgICAgIHYudGFja2xlLnNjYWxlLnNldChyVCwgMSwgclQpOwoKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgLy8gTG9naWMgZnJvbSBtYWluLmpzIGNoZWNrQmFsbEdyYWIKICAgICAgICAgICAgICAgIGNvbnN0IHJDID0gZS5pc0Rhc2hpbmcgPyA0LjAgOiAyLjU7IAogICAgICAgICAgICAgICAgdi5jYXRjaFIuc2NhbGUuc2V0KHJDLCAxLCByQyk7CiAgICAgICAgICAgICAgICB2LmNhdGNoUi5wb3NpdGlvbi55ID0gZS5tZXNoLnBvc2l0aW9uLnkgKyAwLjE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2LnRhY2tsZS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB2LmNhdGNoUi52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFZlY3RvcnMgKEdsb2JhbCBsaW5lcykKICAgICAgICAgICAgY29uc3Qgb3JpZ2luID0gZS5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgIG9yaWdpbi55ICs9IDEuMDsgLy8gTGlmdCB1cAoKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd1ZlY3RvcnMpIHsKICAgICAgICAgICAgICAgIC8vIFZlbG9jaXR5CiAgICAgICAgICAgICAgICBpZiAoZS52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGVuZCA9IG9yaWdpbi5jbG9uZSgpLmFkZChlLnZlbG9jaXR5KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxpbmUodi52ZWxMaW5lLCBvcmlnaW4sIGVuZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBJbnB1dAogICAgICAgICAgICAgICAgaWYgKGUuaW5wdXRWZWN0b3IgJiYgZS5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGVuZCA9IG9yaWdpbi5jbG9uZSgpLmFkZChlLmlucHV0VmVjdG9yLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMy4wKSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVMaW5lKHYuaW5wdXRMaW5lLCBvcmlnaW4sIGVuZCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHYuaW5wdXRMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYudmVsTGluZS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB2LmlucHV0TGluZS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFJCiAgICAgICAgICAgIGlmICh0aGlzLnNob3dBSSAmJiBlLnBlcmNlaXZlZFRhcmdldFBvcykgewogICAgICAgICAgICAgICAgLy8gRHJhdyBsaW5lIHRvIHBlcmNlaXZlZCB0YXJnZXQKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTGluZSh2LmFpTGluZSwgb3JpZ2luLCBlLnBlcmNlaXZlZFRhcmdldFBvcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2LmFpTGluZS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNsZWFyKCkgewogICAgICAgICAgICB0aGlzLnZpc3VhbHMuZm9yRWFjaCh2ID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuc2NlbmUucmVtb3ZlKHYuZ3JvdXApOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy52aXN1YWxzLmNsZWFyKCk7CiAgICAgICAgfQogICAgfQogICAgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyID0gRGVidWdWaXN1YWxpemVyOwp9KSgpOw==","MenuManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNZW51TWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3IoZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZU1hbmFnZXI7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tbWVudScpOwogICAgICAgICAgICB0aGlzLml0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLm1lbnUtaXRlbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zZXR1cEV2ZW50cygpOwogICAgICAgIH0KCiAgICAgICAgc2V0dXBFdmVudHMoKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIFByZXZlbnQgY2xpY2stdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlU2VsZWN0aW9uKGl0ZW0uZGF0YXNldC5hY3Rpb24pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignbW91c2VlbnRlcicsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAvLyBPcHRpb25hbDogUGxheSBob3ZlciBzb3VuZAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaGFuZGxlU2VsZWN0aW9uKGFjdGlvbikgewogICAgICAgICAgICBjb25zb2xlLmxvZygiTWVudSBTZWxlY3Rpb246IiwgYWN0aW9uKTsKICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ25vcm1hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ25vcm1hbCcpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhcnRNYXRjaCgncHJhY3RpY2UnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdiYWxsX2xhYicpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGwgPSAnYmFsbF9sYWInOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ3ByYWN0aWNlJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnb3B0aW9ucycpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJPcHRpb25zIGNsaWNrZWQgKE5vdCBpbXBsZW1lbnRlZCkiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2hvdygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGlkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZShmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguTWVudU1hbmFnZXIgPSBNZW51TWFuYWdlcjsKfSkoKTs=","./MenuManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNZW51TWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3IoZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZU1hbmFnZXI7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tbWVudScpOwogICAgICAgICAgICB0aGlzLml0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLm1lbnUtaXRlbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zZXR1cEV2ZW50cygpOwogICAgICAgIH0KCiAgICAgICAgc2V0dXBFdmVudHMoKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIFByZXZlbnQgY2xpY2stdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlU2VsZWN0aW9uKGl0ZW0uZGF0YXNldC5hY3Rpb24pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignbW91c2VlbnRlcicsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAvLyBPcHRpb25hbDogUGxheSBob3ZlciBzb3VuZAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaGFuZGxlU2VsZWN0aW9uKGFjdGlvbikgewogICAgICAgICAgICBjb25zb2xlLmxvZygiTWVudSBTZWxlY3Rpb246IiwgYWN0aW9uKTsKICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ25vcm1hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ25vcm1hbCcpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhcnRNYXRjaCgncHJhY3RpY2UnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdiYWxsX2xhYicpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGwgPSAnYmFsbF9sYWInOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ3ByYWN0aWNlJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnb3B0aW9ucycpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJPcHRpb25zIGNsaWNrZWQgKE5vdCBpbXBsZW1lbnRlZCkiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2hvdygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGlkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZShmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguTWVudU1hbmFnZXIgPSBNZW51TWFuYWdlcjsKfSkoKTs=","/MenuManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNZW51TWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3IoZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZU1hbmFnZXI7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tbWVudScpOwogICAgICAgICAgICB0aGlzLml0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLm1lbnUtaXRlbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zZXR1cEV2ZW50cygpOwogICAgICAgIH0KCiAgICAgICAgc2V0dXBFdmVudHMoKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIFByZXZlbnQgY2xpY2stdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlU2VsZWN0aW9uKGl0ZW0uZGF0YXNldC5hY3Rpb24pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignbW91c2VlbnRlcicsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAvLyBPcHRpb25hbDogUGxheSBob3ZlciBzb3VuZAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaGFuZGxlU2VsZWN0aW9uKGFjdGlvbikgewogICAgICAgICAgICBjb25zb2xlLmxvZygiTWVudSBTZWxlY3Rpb246IiwgYWN0aW9uKTsKICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ25vcm1hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ25vcm1hbCcpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhcnRNYXRjaCgncHJhY3RpY2UnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdiYWxsX2xhYicpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGwgPSAnYmFsbF9sYWInOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ3ByYWN0aWNlJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnb3B0aW9ucycpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJPcHRpb25zIGNsaWNrZWQgKE5vdCBpbXBsZW1lbnRlZCkiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2hvdygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGlkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZShmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguTWVudU1hbmFnZXIgPSBNZW51TWFuYWdlcjsKfSkoKTs=","PracticeManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQcmFjdGljZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREcmlsbCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZSA9IHt9OyAKICAgICAgICAgICAgCnRoaXMuZHJpbGxzID0gewogICAgICAgICAgICAgICAgJ2ZyZWUnOiB7IG5hbWU6ICdGUkVFIFJPQU0nLCBzZXR1cDogdGhpcy5fc2V0dXBGcmVlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BGcmVlLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdiYWxsX2xhYic6IHsgbmFtZTogJ0JBTEwgTEFCJywgc2V0dXA6IHRoaXMuX3NldHVwQmFsbExhYi5iaW5kKHRoaXMpLCBsb29wOiB0aGlzLl9sb29wQmFsbExhYi5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAnc2hvb3RpbmcnOiB7IG5hbWU6ICdTSE9PVElORyBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cFNob290aW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BTaG9vdGluZy5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncGFzc2luZyc6IHsgbmFtZTogJ1BBU1NJTkcgRFJJTEwnLCBzZXR1cDogdGhpcy5fc2V0dXBQYXNzaW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BQYXNzaW5nLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdkZWZlbnNlJzogeyBuYW1lOiAnREVGRU5TRSBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cERlZmVuc2UuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcERlZmVuc2UuYmluZCh0aGlzKSB9LAogICAgICAgICAgICAgICAgJ2N1cnZlJzogeyBuYW1lOiAnQ1VSVkUgU0hPVCcsIHNldHVwOiB0aGlzLl9zZXR1cEN1cnZlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BDdXJ2ZS5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncmFwaWRfZmlyZSc6IHsgbmFtZTogJ1JBUElEIEZJUkUnLCBzZXR1cDogdGhpcy5fc2V0dXBSYXBpZEZpcmUuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcFJhcGlkRmlyZS5iaW5kKHRoaXMpIH0KICAgICAgICAgICAgfTsKCnRoaXMudWkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2Utb3ZlcmxheScpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dlc3R1cmUtaGludCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gewogICAgICAgICAgICAgICAgaW5mU3RhdHM6IHRydWUsCiAgICAgICAgICAgICAgICBhaUR1bW15OiB0cnVlLAogICAgICAgICAgICAgICAgc2hvd0hpdGJveGVzOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy50YXJnZXRSaW5nID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107IC8vIEFycmF5IHRvIHRyYWNrIHZpc3VhbCBjb3BpZXMgb2YgdGhyb3duIGJhbGxzCiAgICAgICAgICAgIHRoaXMuX2luaXRWaXN1YWxzKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwRXZlbnRzKCk7CiAgICAgICAgfQoKICAgICAgICBfaW5pdFZpc3VhbHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBhIGdsb3dpbmcgcmluZyBmb3IgdGFyZ2V0cwogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMS41LCAxLjgsIDMyKTsKICAgICAgICAgICAgZ2VvbWV0cnkucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBmZmZmLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gQWRkIHRvIHNjZW5lIHZpYSBnYW1lIG1hbmFnZXIgcmVmZXJlbmNlCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc2NlbmUpIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy50YXJnZXRSaW5nKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0KCkgewp0aGlzLmlzUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAvLyBJZiBtZW51IHJlcXVlc3RlZCBhIHNwZWNpZmljIGRyaWxsIChlLmcuLCBCYWxsIExhYiksIGhvbm9yIGl0IG9uY2UuCiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGw7CiAgICAgICAgICAgIGlmIChyZXEgJiYgdGhpcy5kcmlsbHNbcmVxXSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChyZXEpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXgucmVxdWVzdGVkUHJhY3RpY2VEcmlsbCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldERyaWxsKCdmcmVlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBIVUQgaXMgdmlzaWJsZQogICAgICAgICAgICBjb25zdCBodWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKTsKICAgICAgICAgICAgaWYoaHVkKSBodWQuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICB9CgogICAgICAgIHN0b3AoKSB7CgogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlUGFuZWwoKTsKICAgICAgICAgICAgdGhpcy5faGlkZVJlc3RvcmVCdG4oKTsKdGhpcy5fY2xlYXJEcmlsbCgpOwogICAgICAgICAgICAKLy8gQ2xlYXIgR2hvc3QgQmFsbHMKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYi5tZXNoKSB0aGlzLmdhbWUuc2NlbmUucmVtb3ZlKGIubWVzaCk7CiAgICAgICAgICAgICAgICBpZiAoYi50cmFpbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50cmFpbC5tZXNoLmdlb21ldHJ5KSBiLnRyYWlsLm1lc2guZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gZmFsc2U7CgogICAgICAgICAgICAvLyBSZXN0b3JlIEF3YXkgVGVhbSBWaXNpYmlsaXR5IGZvciBOb3JtYWwgTWF0Y2gKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSAwOyAvLyBFbnN1cmUgdGhleSBhcmVuJ3Qgc3R1Y2sgdW5kZXIgZmxvb3IKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGlzYWJsZSBkZWJ1ZyB2aXN1YWxzIGlmIHRoZXkgd2VyZSBvbgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXREcmlsbChrZXkpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmRyaWxsc1trZXldKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuX2NsZWFyRHJpbGwoKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RHJpbGwgPSBrZXk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkucXVlcnlTZWxlY3RvckFsbCgnLmRyaWxsLWJ0bicpLmZvckVhY2goYnRuID0+IHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJywgYnRuLmRhdGFzZXQuZHJpbGwgPT09IGtleSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUnVuIFNldHVwCiAgICAgICAgICAgIHRoaXMuZHJpbGxzW2tleV0uc2V0dXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFubm91bmNlbWVudAogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnNob3dBbm5vdW5jZW1lbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zaG93QW5ub3VuY2VtZW50KHRoaXMuZHJpbGxzW2tleV0ubmFtZSwgJ25vcm1hbCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzUnVubmluZykgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ29tbW9uIFByYWN0aWNlIExvZ2ljIChJbmZpbml0ZSBTdGF0cykKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5pbmZTdGF0cykgewogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbmZpbml0ZVN0YXRzKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERyaWxsIExvZ2ljCiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnREcmlsbCAmJiB0aGlzLmRyaWxsc1t0aGlzLmN1cnJlbnREcmlsbF0ubG9vcCkgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbHNbdGhpcy5jdXJyZW50RHJpbGxdLmxvb3AoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXN1YWxzIEFuaW1hdGlvbgovLyBWaXN1YWxzIEFuaW1hdGlvbgogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nICYmIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucm90YXRpb24ueiArPSBkdDsgLy8gU3BpbgogICAgICAgICAgICAgICAgY29uc3QgcyA9IDEuMCArIE1hdGguc2luKERhdGUubm93KCkgKiAwLjAwNSkgKiAwLjE7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcuc2NhbGUuc2V0KHMsIHMsIHMpOwogICAgICAgICAgICB9CgovLyBVcGRhdGUgR2hvc3QgQmFsbHMKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2hvc3RCYWxscy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2hvc3RCYWxsc1tpXTsKICAgICAgICAgICAgICAgIGIubGlmZSAtPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gLS0tIFBIWVNJQ1MgJiBWSVNVQUxTIERFTEVHQVRJT04gLS0tCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguQmFsbCAmJiB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZS51cGRhdGVGcmVlKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlRnJlZS5jYWxsKGIsIGR0KTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZS51cGRhdGVWaXN1YWxzLmNhbGwoYiwgZHQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBUcmFpbAogICAgICAgICAgICAgICAgaWYgKGIudHJhaWwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFpbFBvcyA9IGIubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChiLmRlZm9ybU5vZGUpIHRyYWlsUG9zLnkgKz0gYi5kZWZvcm1Ob2RlLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICAgICAgYi50cmFpbC51cGRhdGUodHJhaWxQb3MpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIC0tLSBHT0FMIERFVEVDVElPTiBGT1IgR0hPU1QgQkFMTFMgLS0tCiAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBiLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICAvLyBDaGVjayBaIGRlcHRoIChHb2FsIGlzIGF0ICsvLSAyOCwgdHJpZ2dlciBhdCAyOSkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueikgPiAyOS4wKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gR29hbCBCb3ggRGltZW5zaW9ucyAoTWF0Y2hlcyBHYW1lTWFuYWdlcikKICAgICAgICAgICAgICAgICAgICBjb25zdCBoYWxmV2lkdGggPSAxMS4wOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhbGZIZWlnaHQgPSA5LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbFlPZmZzZXQgPSAtNC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueCkgPD0gaGFsZldpZHRoICYmIE1hdGguYWJzKHBvcy55IC0gZ29hbFlPZmZzZXQpIDw9IGhhbGZIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR09BTCEKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIEdvYWwgRlgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIHBvcywgeyBzY2FsZTogOC4wLCBsaWZlOiAwLjUgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIHBvcywgeyBzY2FsZTogNS4wIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVicmlzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGs9MDsgazwxMDsgaysrKSB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdkZWJyaXMnLCBwb3MsIHsgc2NhbGU6IDAuNSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiR09BTCIsIHBvcywgImdvYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAvLyBLaWxsIGJhbGwgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgICAgICAgICAgYi5saWZlID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2xlYW51cAogICAgICAgICAgICAgICAgaWYgKGIubGlmZSA8PSAwIHx8IGIubWVzaC5wb3NpdGlvbi55IDwgLTEwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLnJlbW92ZShiLm1lc2gpOwogICAgICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGIudHJhaWwubWVzaC5nZW9tZXRyeSkgYi50cmFpbC5tZXNoLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3NldHVwRXZlbnRzKCkgewoKICAgICAgICAgICAgLy8gTWluaW1pemUgLyBSZXN0b3JlCiAgICAgICAgICAgIGNvbnN0IG1pbkJ0biA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI3AtbWluaW1pemUnKTsKICAgICAgICAgICAgaWYgKG1pbkJ0bikgewogICAgICAgICAgICAgICAgbWluQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVQYW5lbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dSZXN0b3JlQnRuKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgcmVzdG9yZUJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcmFjdGljZS1yZXN0b3JlLWJ0bicpOwogICAgICAgICAgICBpZiAocmVzdG9yZUJ0bikgewogICAgICAgICAgICAgICAgcmVzdG9yZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93UGFuZWwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUmVzdG9yZUJ0bigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERyaWxsIEJ1dHRvbnMKICAgICAgICAgICAgdGhpcy51aS5xdWVyeVNlbGVjdG9yQWxsKCcuZHJpbGwtYnRuJykuZm9yRWFjaChidG4gPT4gewogICAgICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RHJpbGwoYnRuLmRhdGFzZXQuZHJpbGwpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUmVzZXQgQmFsbAogICAgICAgICAgICBjb25zdCByZXNldEJ0biA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI3AtcmVzZXQtYmFsbCcpOwogICAgICAgICAgICBpZiAocmVzZXRCdG4pIHsKICAgICAgICAgICAgICAgIHJlc2V0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRXhpdAogICAgICAgICAgICBjb25zdCBleGl0QnRuID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjcC1leGl0Jyk7CiAgICAgICAgICAgIGlmIChleGl0QnRuKSB7CiAgICAgICAgICAgICAgICBleGl0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlci5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9wdGlvbnMgVG9nZ2xlcwogICAgICAgICAgICB0aGlzLl9iaW5kVG9nZ2xlKCdvcHQtaW5mLXN0YXQnLCAnaW5mU3RhdHMnKTsKICAgICAgICAgICAgdGhpcy5fYmluZFRvZ2dsZSgnb3B0LWFpLWR1bW15JywgJ2FpRHVtbXknLCAodmFsKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgQUkgRHVtbXkgc3RhdGUgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LmFpRW5hYmxlZCA9ICF2YWw7IC8vIElmIGR1bW15IGlzIFRSVUUsIEFJIGlzIEZBTFNFCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9iaW5kVG9nZ2xlKCdvcHQtaGl0Ym94ZXMnLCAnc2hvd0hpdGJveGVzJywgKHZhbCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLmVuYWJsZWQgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5zaG93SGl0Ym94ZXMgPSB2YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gS2V5Ym9hcmQgU2hvcnRjdXQgZm9yIFJlc2V0IChSKQovLyBLZXlib2FyZCBTaG9ydGN1dCBmb3IgUmVzZXQgKFIpCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzUnVubmluZyAmJiBlLmtleS50b0xvd2VyQ2FzZSgpID09PSAncicgJiYgIWUucmVwZWF0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKX2JpbmRUb2dnbGUoaWQsIG9wdGlvbktleSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgY29uc3QgZWwgPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoYCMke2lkfWApOwogICAgICAgICAgICBpZiAoIWVsKSByZXR1cm47CgogICAgICAgICAgICAvLyBIZWxwZXIgdG8gdXBkYXRlIHZpc3VhbHMKICAgICAgICAgICAgY29uc3QgdXBkYXRlVmlzdWFsID0gKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgaXNBY3RpdmUgPSB0aGlzLm9wdGlvbnNbb3B0aW9uS2V5XTsKICAgICAgICAgICAgICAgIGVsLmNsYXNzTGlzdC50b2dnbGUoJ2FjdGl2ZScsIGlzQWN0aXZlKTsKICAgICAgICAgICAgICAgIGNvbnN0IGJveCA9IGVsLnF1ZXJ5U2VsZWN0b3IoJy5jaGVja2JveCcpOwogICAgICAgICAgICAgICAgaWYgKGJveCkgYm94LmlubmVyVGV4dCA9IGlzQWN0aXZlID8gJ+KWoycgOiAn4pahJzsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgdmlzdWFsIHN0YXRlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIHVwZGF0ZVZpc3VhbCgpOwoKICAgICAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9uc1tvcHRpb25LZXldID0gIXRoaXMub3B0aW9uc1tvcHRpb25LZXldOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB1cGRhdGVWaXN1YWwoKTsKCiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKHRoaXMub3B0aW9uc1tvcHRpb25LZXldKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKCiAgICAgICAgX3NldHVwQmFsbExhYigpIHsKICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIkJBTEwgTEFCOiBPcGVuIERldlRvb2xzIOKGkiBCYWxsIExhYi4gVXNlIFNob3QgQ2Fubm9uICsgdHJhamVjdG9yeSBwcmV2aWV3ICsgcmVjb3JkL3JlcGxheS4iKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKCiAgICAgICAgICAgIGNvbnN0IGhvbWUgPSB0aGlzLmdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgY29uc3QgYXdheSA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5OwogICAgICAgICAgICBjb25zdCBwID0gaG9tZSA/IGhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKICAgICAgICAgICAgaWYgKCFwKSByZXR1cm47CgogICAgICAgICAgICAvLyBTb2xvIG1vZGU6IGhpZGUgZXZlcnlvbmUgZXhjZXB0IHRoZSBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmIChob21lICYmIGhvbWUucGxheWVycykgewogICAgICAgICAgICAgICAgaG9tZS5wbGF5ZXJzLmZvckVhY2gobWF0ZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGUubWVzaCkgbWF0ZS5tZXNoLnZpc2libGUgPSAobWF0ZSA9PT0gcCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXdheSAmJiBhd2F5LnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGF3YXkucGxheWVycy5mb3JFYWNoKG9wcCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wcC5tZXNoKSBvcHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUGxhY2UgYWN0aXZlIHBsYXllciBhdCBjZW50ZXIgZmFjaW5nIHRoZSBhd2F5IGdvYWwKICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLTI4KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgaWYgKHAuc3luY1JvdGF0aW9uKSBwLnN5bmNSb3RhdGlvbigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCaWcgc3RhdHMgc28geW91IGNhbiB0ZXN0IGV4dHJlbWVzCiAgICAgICAgICAgIGlmIChwLnN0YXRzKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlBBID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkVOID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLm1heEhQID0gTWF0aC5tYXgocC5zdGF0cy5tYXhIUCB8fCA5OTksIDk5OSk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkhQID0gcC5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQSBjbGVhciB0YXJnZXQgbWFya2VyIChwdXJlbHkgdmlzdWFsKQogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uc2V0KDAsIDAuMSwgLTE4KTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZjAwZmYpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KCiAgICAgICAgX2xvb3BCYWxsTGFiKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgaWYgKCFiIHx8ICFwKSByZXR1cm47CgogICAgICAgICAgICAvLyBBdXRvLXJlc2V0IGJhbGwgYmFjayB0byBwbGF5ZXIgb25jZSBpdCBjb21lcyB0byByZXN0LAogICAgICAgICAgICAvLyBzbyB5b3UgY2FuIHNwYW0gdmFyaWF0aW9ucyB3aXRob3V0IHRvdWNoaW5nIGFueXRoaW5nLgogICAgICAgICAgICBpZiAoYi5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzdG9wcGVkID0gKGIudmVsb2NpdHkubGVuZ3RoU3EoKSA8IDAuMDEpICYmIChiLnBvd2VyIDw9IDAuMDEpOwogICAgICAgICAgICAgICAgaWYgKHN0b3BwZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gKHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgfHwgMCkgKyBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA+IDAuNDUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbGlnaHQgdGFyZ2V0IGJvYiAoaGVscHMgZGVwdGggcGVyY2VwdGlvbikKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZyAmJiB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnkgPSAwLjEgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDMpICogMC4wNTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5SW5maW5pdGVTdGF0cygpIHsKICAgICAgICAgICAgY29uc3QgaG9tZSA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBpZiAoaG9tZSkgewogICAgICAgICAgICAgICAgaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7CiAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSBwLnN0YXRzLkVOOwogICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLnZlbm9tID0gMDsKICAgICAgICAgICAgICAgICAgICBwLnN0YXR1cy5uYXAgPSAwOwogICAgICAgICAgICAgICAgICAgIHAuc3R1blRpbWVyID0gMDsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2xlYXJEcmlsbCgpIHsKICAgICAgICAgICAgLy8gUmVzZXQgcG9zaXRpb25zLCBjbGVhciBkdW1taWVzLCByZXNldCBzY29yZQppZiAodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KSBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlID0geyBzY29yZTogMCwgdGltZXI6IDAsIHN0YWdlOiAwLCByZXNldHRpbmc6IGZhbHNlIH07CiAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUmVzZXQgdGVhbXMgdG8gZGVmYXVsdCBwb3NpdGlvbnMKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IEFJIER1bW15IHNldHRpbmcKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5haUVuYWJsZWQgPSAhdGhpcy5vcHRpb25zLmFpRHVtbXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gSGlkZSBhd2F5IHRlYW0gYnkgZGVmYXVsdCBpbiBkcmlsbHMgdW5sZXNzIHNwZWNpZmllZAogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIC0xMDAsIDApOyAvLyBNb3ZlIGF3YXkKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFbnN1cmUgSG9tZSB0ZWFtIGlzIHZpc2libGUKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgX3Jlc2V0QmFsbFRvUGxheWVyKCkgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmIChwICYmIGIpIHsKICAgICAgICAgICAgICAgIGIucmVzZXQoKTsKICAgICAgICAgICAgICAgIGIuZ3JhYihwKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJSRVNFVCIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU25hcCBjYW1lcmEKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FtZXJhTWFuYWdlcikgdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVTY29yZVVJKHZhbCkgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI2RyaWxsLXNjb3JlJyk7CiAgICAgICAgICAgIGlmIChlbCkgZWwuaW5uZXJUZXh0ID0gYFNDT1JFOiAke3ZhbH1gOwogICAgICAgIH0KCiAgICAgICAgX3NldEluc3RydWN0aW9uKHRleHQpIHsKICAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjZHJpbGwtaW5zdHJ1Y3Rpb24nKTsKICAgICAgICAgICAgIGlmIChlbCkgZWwuaW5uZXJUZXh0ID0gdGV4dDsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBEUklMTFMgLS0tCgogICAgICAgIF9zZXR1cEZyZWUoKSB7CiAgICAgICAgICAgIHRoaXMuX3NldEluc3RydWN0aW9uKCJGcmVlIHByYWN0aWNlLiBJbmZpbml0ZSBIUC9FTi4iKTsKICAgICAgICAgICAgLy8gU2hvdyBldmVyeW9uZQogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5jb3B5KHAuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQogICAgICAgIF9sb29wRnJlZShkdCkge30KCiAgICAgICAgX3NldHVwU2hvb3RpbmcoKSB7CgogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiU2NvcmUgb24gdGhlIEdvYWxpZSEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOyAvLyBDbGVhciByZXNldCBmbGFnCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXR1cDogQWN0aXZlIFBsYXllciBhdCAxOG0sIEdvYWxpZSBpbiBuZXQuCiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIGNvbnN0IGcgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHAgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC0xMCk7IC8vIDE4bSBvdXQgKEhvbWUgYXR0YWNrcyAtWikKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLTI4KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZyAmJiBnLm1lc2gpIHsKICAgICAgICAgICAgICAgIGcubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGcubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTI3KTsKICAgICAgICAgICAgICAgIGcubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBnLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9sb29wU2hvb3RpbmcoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGdvYWwgc2NvcmVkIChHYW1lTWFuYWdlciBoYW5kbGVzIHRoZSBhY3R1YWwgZ29hbCBldmVudCwgYnV0IHdlIHRyYWNrIHJlc2V0KQogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YXRlID09PSAnZ29hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRoaXMuZHJpbGxTdGF0ZS5zY29yZSk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhdGUgPSAnYWN0aXZlJzsgLy8gSGlqYWNrIHN0YXRlIGJhY2sKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBTaG9vdGluZygpLCAxMDAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgZ29hbGllIGNhdGNoZXMKICAgICAgICAgICAgY29uc3QgZyA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ0dMJyk7CiAgICAgICAgICAgIGlmIChnICYmIGcuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTQVZFRCIsIGcubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBTaG9vdGluZygpLCAxMDAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3NldHVwUGFzc2luZygpIHsKCiAgICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiUGFzcyB0byB0aGUgbW92aW5nIHRhcmdldCEiKTsKICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgICAvLyBTZXR1cDogQWN0aXZlIFBsYXllciBjZW50ZXIuIDEgVGVhbW1hdGUgcnVubmluZyBwYXR0ZXJucy4KICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQoeCA9PiB4ICE9PSBwICYmIHgucm9sZSAhPT0gJ0dMJyk7CiAgICAgICAgICAgICAKICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS50YXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICAgICAKICAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAxMCk7CiAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgfQogICAgICAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOwogICAgICAgICAgICAgICAgIHRhcmdldC5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgIHRhcmdldC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgfQogICAgICAgICAgICAgCiAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KCiAgICAgICAgX2xvb3BQYXNzaW5nKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmRyaWxsU3RhdGUudGFyZ2V0OwogICAgICAgICAgICBpZiAoIXRhcmdldCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTW92ZSB0YXJnZXQgaW4gY2lyY2xlCiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS50aW1lciArPSBkdDsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gucG9zaXRpb24ueCA9IE1hdGguc2luKHRoaXMuZHJpbGxTdGF0ZS50aW1lcikgKiAxMDsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gucG9zaXRpb24ueiA9IC0xMCArIE1hdGguY29zKHRoaXMuZHJpbGxTdGF0ZS50aW1lciAqIDAuNSkgKiA1OwogICAgICAgICAgICB0YXJnZXQubWVzaC5sb29rQXQoMCwwLDEwKTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBSaW5nCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi5jb3B5KHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi55ID0gMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweDAwZmZmZik7IC8vIEN5YW4KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRhcmdldC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5zY29yZSsrOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIk5JQ0UgUEFTUyEiLCB0YXJnZXQubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVzZXQKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRhcmdldC5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NldHVwUGFzc2luZygpOyAvLyBSZS1zZXR1cCB0byByZXNldCBwb3NpdGlvbnMKICAgICAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgX3NldHVwRGVmZW5zZSgpIHsKCiAgICAgICAgICAgIHRoaXMuX3NldEluc3RydWN0aW9uKCJUYWNrbGUgdGhlIGF0dGFja2VyISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBhdHRhY2tlciA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuYXR0YWNrZXIgPSBhdHRhY2tlcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDIwKTsgLy8gTmVhciBvd24gZ29hbAogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhdHRhY2tlcikgewogICAgICAgICAgICAgICAgYXR0YWNrZXIubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGF0dGFja2VyLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC0xMCk7CiAgICAgICAgICAgICAgICBhdHRhY2tlci52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgLy8gR2l2ZSBiYWxsIHRvIGF0dGFja2VyCiAgICAgICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICBiLnJlc2V0KCk7CiAgICAgICAgICAgICAgICBiLmdyYWIoYXR0YWNrZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9sb29wRGVmZW5zZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgYXR0YWNrZXIgPSB0aGlzLmRyaWxsU3RhdGUuYXR0YWNrZXI7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWF0dGFja2VyIHx8ICFwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBdHRhY2tlciBydW5zIHRvIGdvYWwgKCtaKQogICAgICAgICAgICBjb25zdCBnb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMjgpOwogICAgICAgICAgICBjb25zdCBkaXIgPSBnb2FsUG9zLmNsb25lKCkuc3ViKGF0dGFja2VyLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFJpbmcgb24gQXR0YWNrZXIKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLmNvcHkoYXR0YWNrZXIubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZjAwMDApOyAvLyBSZWQgZm9yIGVuZW15CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhdHRhY2tlci5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBhdHRhY2tlci5zZXRJbnB1dChkaXIueCwgZGlyLnopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQmFsbCBsb3N0IChUYWNrbGVkKQogICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCB8fCB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTVE9QUEVEISIsIHAubWVzaC5wb3NpdGlvbiwgImJsb2NrIik7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cERlZmVuc2UoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZhaWwgY29uZGl0aW9uOiBBdHRhY2tlciBzY29yZXMgKEdhbWVNYW5hZ2VyIGhhbmRsZXMgZ29hbCBjaGVjaykKICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc3RhdGUgPT09ICdnb2FsJykgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhdGUgPSAnYWN0aXZlJzsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJGQUlMRUQiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBEZWZlbnNlKCksIDEwMDApOwogICAgICAgICAgICB9Cn0KCiAgICAgICAgX3NldHVwQ3VydmUoKSB7CnRoaXMuX3NldEluc3RydWN0aW9uKCJTd2lwZSBhIENVUlZFICggKSApIHRvIGJ5cGFzcyB0aGUgZGVmZW5kZXIhIik7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFNob3cgZ2VzdHVyZSBoaW50CiAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDbGVhciBhbnkgZXhpc3RpbmcgdGltZW91dAogICAgICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCkgY2xlYXJUaW1lb3V0KHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEF1dG8gaGlkZSBhZnRlciA0cwogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAvLyBVc2UgYSBkZWZlbmRlciBkdW1teQogICAgICAgICAgICBjb25zdCBkZWZlbmRlciA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ0xEJyk7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5kZWZlbmRlciA9IGRlZmVuZGVyOwoKICAgICAgICAgICAgaWYgKHApIHsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMTUpOwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtMjgpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGVmZW5kZXIpIHsKICAgICAgICAgICAgICAgIGRlZmVuZGVyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBkZWZlbmRlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCA1KTsgLy8gMTBtIGluIGZyb250IG9mIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIubWVzaC5sb29rQXQoMCwgMCwgMTUpOyAvLyBGYWNlIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEJvb3N0IEJMIHRvIGVuc3VyZSBzdHJhaWdodCBzaG90cyBhcmUgYmxvY2tlZAogICAgICAgICAgICAgICAgZGVmZW5kZXIuc3RhdHMuQkwgPSA5OTsgCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhleSBkb24ndCBtb3ZlCiAgICAgICAgICAgICAgICBkZWZlbmRlci5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUYXJnZXQgUmluZyBiZWhpbmQgZGVmZW5kZXIKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnNldCgwLCAwLjEsIC0xMCk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4MDBmZmZmKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgpfbG9vcEN1cnZlKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IGRlZmVuZGVyID0gdGhpcy5kcmlsbFN0YXRlLmRlZmVuZGVyOwoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgYmFsbCBwYXNzZWQgdGhlIGRlZmVuZGVyIGxpbmUgKHogPCAwKQogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAwKSB7CiAgICAgICAgICAgICAgICAvLyBTdWNjZXNzIHpvbmUgKFdpdGhpbiA1bSB3aWR0aCkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhiYWxsLm1lc2gucG9zaXRpb24ueCkgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRUQhIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBDdXJ2ZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGJsb2NrZWQgKEJhbGwgc3RvcHBlZCBvciBwb3dlciBkcmFpbmVkIHNpZ25pZmljYW50bHkgbmVhciBkZWZlbmRlcikKICAgICAgICAgICAgaWYgKGRlZmVuZGVyICYmIGJhbGwubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGRlZmVuZGVyLm1lc2gucG9zaXRpb24pIDwgMy4wKSB7CiAgICAgICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA8PSAwIHx8IGJhbGwudmVsb2NpdHkubGVuZ3RoKCkgPCAxLjApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0tFRCIsIGRlZmVuZGVyLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZS1zaG93IGhpbnQgb24gZmFpbHVyZSB0byBndWlkZSBwbGF5ZXIKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTWlzc2VkIC8gT3V0IG9mIGJvdW5kcwogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAtMTUpIHsKICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiTUlTU0VEIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgLy8gUmUtc2hvdyBoaW50IG9uIG1pc3MKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX3NldHVwUmFwaWRGaXJlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVU5MSU1JVEVEIEFNTU8hIFNwYW0gdGhyb3dzISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBGaW5kIFRpZHVzIG9yIGRlZmF1bHQgdG8gTEYKICAgICAgICAgICAgbGV0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQoeCA9PiB4LmNoYXJhY3Rlck5hbWUgJiYgeC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKTsKICAgICAgICAgICAgaWYgKCFwKSBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnTEYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldCBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5zZXRBY3RpdmVQbGF5ZXIocCk7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtMjgpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBCb29zdCBzdGF0cyBmb3IgZnVuCiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlBBID0gOTk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEhJREUgRVZFUllPTkUgKEFsb25lIE1vZGUpCiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChtYXRlID0+IHsKICAgICAgICAgICAgICAgIGlmIChtYXRlICE9PSBwICYmIG1hdGUubWVzaCkgbWF0ZS5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChvcHAgPT4gewogICAgICAgICAgICAgICAgaWYgKG9wcC5tZXNoKSBvcHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgpfbG9vcFJhcGlkRmlyZShkdCkgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CgogICAgICAgICAgICBpZiAoIXAgfHwgIWIpIHJldHVybjsKCiAgICAgICAgICAgIC8vIERldGVjdCBpZiBiYWxsIHdhcyBqdXN0IHRocm93biAoaXMgZnJlZSkKICAgICAgICAgICAgaWYgKGIuc3RhdGUgPT09ICdmcmVlJykgewogICAgICAgICAgICAgICAgLy8gMS4gU3Bhd24gR2hvc3QgQmFsbCAoVmlzdWFsIENvcHkpCiAgICAgICAgICAgICAgICAvLyBDbG9uZSB0aGUgbWVzaCBoaWVyYXJjaHkgdG8gcHJlc2VydmUgRGVmb3JtL1NwaW4gbm9kZXMKICAgICAgICAgICAgICAgIGNvbnN0IGdob3N0TWVzaCA9IGIubWVzaC5jbG9uZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdmlzaWJpbGl0eSBhbmQgYWRkIHRvIHNjZW5lCiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKGdob3N0TWVzaCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlLWJpbmQgaW50ZXJuYWwgcmVmZXJlbmNlcyBmb3IgdGhlIHBoeXNpY3MgZW5naW5lCiAgICAgICAgICAgICAgICAvLyBIaWVyYXJjaHk6IE1lc2ggLT4gRGVmb3JtTm9kZSAtPiBTcGluTm9kZQogICAgICAgICAgICAgICAgY29uc3QgZGVmb3JtTm9kZSA9IGdob3N0TWVzaC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5Ob2RlID0gZGVmb3JtTm9kZSA/IGRlZm9ybU5vZGUuY2hpbGRyZW5bMF0gOiBudWxsOwoKICAgICAgICAgICAgICAgIC8vIERldGVybWluZSBUcmFpbCBDb2xvciBiYXNlZCBvbiBUZWNoCiAgICAgICAgICAgICAgICBsZXQgdHJhaWxDb2xvciA9IDB4ZmY0NDAwOyAvLyBEZWZhdWx0IFNIIChPcmFuZ2UpCiAgICAgICAgICAgICAgICBpZiAoYi50ZWNobmlxdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ3Zlbm9tJykgdHJhaWxDb2xvciA9IDB4YWEwMGZmOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICd3aXRoZXInKSB0cmFpbENvbG9yID0gMHg4ODg4ODg7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ25hcCcpIHRyYWlsQ29sb3IgPSAweDAwMDA4ODsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnc3BoZXJlJykgdHJhaWxDb2xvciA9IDB4MDBmZmZmOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICdqZWNodCcpIHRyYWlsQ29sb3IgPSAweGZmMDAwMDsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnaW52aXNpYmxlJykgdHJhaWxDb2xvciA9IDB4NDQ0NDQ0OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChiLnBvd2VyVHlwZSA9PT0gJ1BBJykgewogICAgICAgICAgICAgICAgICAgIHRyYWlsQ29sb3IgPSAweDAwYWFmZjsgLy8gUGFzcyAoQmx1ZSkKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDcmVhdGUgVHJhaWwKICAgICAgICAgICAgICAgIGNvbnN0IHRyYWlsID0gbmV3IHdpbmRvdy5mbHV4LlRyYWlsUmVuZGVyZXIodGhpcy5nYW1lLnNjZW5lKTsKICAgICAgICAgICAgICAgIHRyYWlsLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0cmFpbC5zZXRDb2xvcih0cmFpbENvbG9yKTsKICAgICAgICAgICAgICAgIHRyYWlsLnJlc2V0KGdob3N0TWVzaC5wb3NpdGlvbik7CgogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIGEgIk1vY2siIEJhbGwgb2JqZWN0IHRoYXQgc2F0aXNmaWVzIEJhbGwuanMgcGh5c2ljcyByZXF1aXJlbWVudHMKICAgICAgICAgICAgICAgIGNvbnN0IGdob3N0QmFsbCA9IHsKICAgICAgICAgICAgICAgICAgICBtZXNoOiBnaG9zdE1lc2gsCiAgICAgICAgICAgICAgICAgICAgZGVmb3JtTm9kZTogZGVmb3JtTm9kZSwKICAgICAgICAgICAgICAgICAgICBzcGluTm9kZTogc3Bpbk5vZGUsCiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IGIudmVsb2NpdHkuY2xvbmUoKSwKICAgICAgICAgICAgICAgICAgICBhbmd1bGFyVmVsb2NpdHk6IGIuYW5ndWxhclZlbG9jaXR5ID8gYi5hbmd1bGFyVmVsb2NpdHkuY2xvbmUoKSA6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgYWNjdW11bGF0ZWRSb3RhdGlvbjogYi5hY2N1bXVsYXRlZFJvdGF0aW9uID8gYi5hY2N1bXVsYXRlZFJvdGF0aW9uLmNsb25lKCkgOiBuZXcgVEhSRUUuUXVhdGVybmlvbigpLAogICAgICAgICAgICAgICAgICAgIHN0YXRlOiAnZnJlZScsCiAgICAgICAgICAgICAgICAgICAgcG93ZXI6IGIucG93ZXIsCiAgICAgICAgICAgICAgICAgICAgcG93ZXJUeXBlOiBiLnBvd2VyVHlwZSwKICAgICAgICAgICAgICAgICAgICB0ZWNobmlxdWU6IGIudGVjaG5pcXVlLAogICAgICAgICAgICAgICAgICAgIGlzSW52aXNpYmxlOiBiLmlzSW52aXNpYmxlLAogICAgICAgICAgICAgICAgICAgIGxpZmU6IDUuMCwgLy8gRW5vdWdoIHRpbWUgdG8gcmVhY2ggZ29hbAogICAgICAgICAgICAgICAgICAgIHRyYWlsOiB0cmFpbCwKICAgICAgICAgICAgICAgICAgICBfYnViYmxlVGltZXI6IDAsCiAgICAgICAgICAgICAgICAgICAgX2dob3N0OiB0cnVlLAogICAgICAgICAgICAgICAgICAgIC8vIE1vY2sgbWV0aG9kcwogICAgICAgICAgICAgICAgICAgIHJlc2V0OiAoKSA9PiB7fSwgCiAgICAgICAgICAgICAgICAgICAgZHJvcDogKCkgPT4ge30sCiAgICAgICAgICAgICAgICAgICAgcmV2ZWFsOiAoKSA9PiB7fQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSB2aXNpYmlsaXR5CiAgICAgICAgICAgICAgICBnaG9zdE1lc2gudmlzaWJsZSA9ICFiLmlzSW52aXNpYmxlOwoKICAgICAgICAgICAgICAgIHRoaXMuZ2hvc3RCYWxscy5wdXNoKGdob3N0QmFsbCk7CgovLyAyLiBSZXNldCBSZWFsIEJhbGwgdG8gUGxheWVyIElOU1RBTlRMWQogICAgICAgICAgICAgICAgYi52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZJWDogRm9yY2UgYmFsbCBwb3NpdGlvbiB0byBiZSBleHBsaWNpdGx5IGluIGZyb250IG9mIHRoZSBwbGF5ZXIKICAgICAgICAgICAgICAgIC8vIFRoaXMgcHJldmVudHMgYW55IGxvZ2ljIGZyb20gdGhpbmtpbmcgdGhlIGJhbGwgaXMgYmVoaW5kIGFuZCB0cmlnZ2VyaW5nIGEgdHVybgogICAgICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHAubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIGIubWVzaC5wb3NpdGlvbi5jb3B5KHAubWVzaC5wb3NpdGlvbikuYWRkKGZ3ZC5tdWx0aXBseVNjYWxhcigwLjgpKTsKICAgICAgICAgICAgICAgIGIubWVzaC5wb3NpdGlvbi55ICs9IDEuMDsKCiAgICAgICAgICAgICAgICAvLyBNYW51YWwgQXR0YWNoIChCeXBhc3MgJ2NhdGNoJyBhbmltYXRpb24pCiAgICAgICAgICAgICAgICBiLmhvbGRlciA9IHA7CiAgICAgICAgICAgICAgICBiLnN0YXRlID0gJ2hlbGQnOwogICAgICAgICAgICAgICAgcC5oYXNCYWxsID0gdHJ1ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVzZXQgUGxheWVyIFRocm93IFN0YXRlIHNvIHRoZXkgY2FuIGZpcmUgYWdhaW4gaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIHAuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcC5jYXRjaENvb2xkb3duID0gMDsKCiAgICAgICAgICAgICAgICAvLyBTeW5jIHJvdGF0aW9uIHRvIHByZXZlbnQgc25hcHBpbmcKICAgICAgICAgICAgICAgIGlmIChwLnN5bmNSb3RhdGlvbikgcC5zeW5jUm90YXRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5zdXJlIGluZmluaXRlIHN0YXRzCiAgICAgICAgICAgIHAuY3VycmVudEVOID0gcC5zdGF0cy5FTjsKICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7CiAgICAgICAgfQoKICAgICAgICBfc2hvd1BhbmVsKCkgewogICAgICAgICAgICBpZiAodGhpcy51aSkgdGhpcy51aS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICB9CgogICAgICAgIF9oaWRlUGFuZWwoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnVpKSB0aGlzLnVpLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dSZXN0b3JlQnRuKCkgewogICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2UtcmVzdG9yZS1idG4nKTsKICAgICAgICAgICAgaWYgKGJ0bikgYnRuLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgIH0KCiAgICAgICAgX2hpZGVSZXN0b3JlQnRuKCkgewogICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2UtcmVzdG9yZS1idG4nKTsKICAgICAgICAgICAgaWYgKGJ0bikgYnRuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQogICAgfQp3aW5kb3cuZmx1eC5QcmFjdGljZU1hbmFnZXIgPSBQcmFjdGljZU1hbmFnZXI7Cn0pKCk7","./PracticeManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQcmFjdGljZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREcmlsbCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZSA9IHt9OyAKICAgICAgICAgICAgCnRoaXMuZHJpbGxzID0gewogICAgICAgICAgICAgICAgJ2ZyZWUnOiB7IG5hbWU6ICdGUkVFIFJPQU0nLCBzZXR1cDogdGhpcy5fc2V0dXBGcmVlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BGcmVlLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdiYWxsX2xhYic6IHsgbmFtZTogJ0JBTEwgTEFCJywgc2V0dXA6IHRoaXMuX3NldHVwQmFsbExhYi5iaW5kKHRoaXMpLCBsb29wOiB0aGlzLl9sb29wQmFsbExhYi5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAnc2hvb3RpbmcnOiB7IG5hbWU6ICdTSE9PVElORyBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cFNob290aW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BTaG9vdGluZy5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncGFzc2luZyc6IHsgbmFtZTogJ1BBU1NJTkcgRFJJTEwnLCBzZXR1cDogdGhpcy5fc2V0dXBQYXNzaW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BQYXNzaW5nLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdkZWZlbnNlJzogeyBuYW1lOiAnREVGRU5TRSBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cERlZmVuc2UuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcERlZmVuc2UuYmluZCh0aGlzKSB9LAogICAgICAgICAgICAgICAgJ2N1cnZlJzogeyBuYW1lOiAnQ1VSVkUgU0hPVCcsIHNldHVwOiB0aGlzLl9zZXR1cEN1cnZlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BDdXJ2ZS5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncmFwaWRfZmlyZSc6IHsgbmFtZTogJ1JBUElEIEZJUkUnLCBzZXR1cDogdGhpcy5fc2V0dXBSYXBpZEZpcmUuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcFJhcGlkRmlyZS5iaW5kKHRoaXMpIH0KICAgICAgICAgICAgfTsKCnRoaXMudWkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2Utb3ZlcmxheScpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dlc3R1cmUtaGludCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gewogICAgICAgICAgICAgICAgaW5mU3RhdHM6IHRydWUsCiAgICAgICAgICAgICAgICBhaUR1bW15OiB0cnVlLAogICAgICAgICAgICAgICAgc2hvd0hpdGJveGVzOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy50YXJnZXRSaW5nID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107IC8vIEFycmF5IHRvIHRyYWNrIHZpc3VhbCBjb3BpZXMgb2YgdGhyb3duIGJhbGxzCiAgICAgICAgICAgIHRoaXMuX2luaXRWaXN1YWxzKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwRXZlbnRzKCk7CiAgICAgICAgfQoKICAgICAgICBfaW5pdFZpc3VhbHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBhIGdsb3dpbmcgcmluZyBmb3IgdGFyZ2V0cwogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMS41LCAxLjgsIDMyKTsKICAgICAgICAgICAgZ2VvbWV0cnkucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBmZmZmLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gQWRkIHRvIHNjZW5lIHZpYSBnYW1lIG1hbmFnZXIgcmVmZXJlbmNlCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc2NlbmUpIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy50YXJnZXRSaW5nKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0KCkgewp0aGlzLmlzUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAvLyBJZiBtZW51IHJlcXVlc3RlZCBhIHNwZWNpZmljIGRyaWxsIChlLmcuLCBCYWxsIExhYiksIGhvbm9yIGl0IG9uY2UuCiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGw7CiAgICAgICAgICAgIGlmIChyZXEgJiYgdGhpcy5kcmlsbHNbcmVxXSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChyZXEpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXgucmVxdWVzdGVkUHJhY3RpY2VEcmlsbCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldERyaWxsKCdmcmVlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBIVUQgaXMgdmlzaWJsZQogICAgICAgICAgICBjb25zdCBodWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKTsKICAgICAgICAgICAgaWYoaHVkKSBodWQuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICB9CgogICAgICAgIHN0b3AoKSB7CgogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlUGFuZWwoKTsKICAgICAgICAgICAgdGhpcy5faGlkZVJlc3RvcmVCdG4oKTsKdGhpcy5fY2xlYXJEcmlsbCgpOwogICAgICAgICAgICAKLy8gQ2xlYXIgR2hvc3QgQmFsbHMKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYi5tZXNoKSB0aGlzLmdhbWUuc2NlbmUucmVtb3ZlKGIubWVzaCk7CiAgICAgICAgICAgICAgICBpZiAoYi50cmFpbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50cmFpbC5tZXNoLmdlb21ldHJ5KSBiLnRyYWlsLm1lc2guZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gZmFsc2U7CgogICAgICAgICAgICAvLyBSZXN0b3JlIEF3YXkgVGVhbSBWaXNpYmlsaXR5IGZvciBOb3JtYWwgTWF0Y2gKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSAwOyAvLyBFbnN1cmUgdGhleSBhcmVuJ3Qgc3R1Y2sgdW5kZXIgZmxvb3IKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGlzYWJsZSBkZWJ1ZyB2aXN1YWxzIGlmIHRoZXkgd2VyZSBvbgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXREcmlsbChrZXkpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmRyaWxsc1trZXldKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuX2NsZWFyRHJpbGwoKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RHJpbGwgPSBrZXk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkucXVlcnlTZWxlY3RvckFsbCgnLmRyaWxsLWJ0bicpLmZvckVhY2goYnRuID0+IHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJywgYnRuLmRhdGFzZXQuZHJpbGwgPT09IGtleSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUnVuIFNldHVwCiAgICAgICAgICAgIHRoaXMuZHJpbGxzW2tleV0uc2V0dXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFubm91bmNlbWVudAogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnNob3dBbm5vdW5jZW1lbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zaG93QW5ub3VuY2VtZW50KHRoaXMuZHJpbGxzW2tleV0ubmFtZSwgJ25vcm1hbCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzUnVubmluZykgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ29tbW9uIFByYWN0aWNlIExvZ2ljIChJbmZpbml0ZSBTdGF0cykKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5pbmZTdGF0cykgewogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbmZpbml0ZVN0YXRzKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERyaWxsIExvZ2ljCiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnREcmlsbCAmJiB0aGlzLmRyaWxsc1t0aGlzLmN1cnJlbnREcmlsbF0ubG9vcCkgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbHNbdGhpcy5jdXJyZW50RHJpbGxdLmxvb3AoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXN1YWxzIEFuaW1hdGlvbgovLyBWaXN1YWxzIEFuaW1hdGlvbgogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nICYmIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucm90YXRpb24ueiArPSBkdDsgLy8gU3BpbgogICAgICAgICAgICAgICAgY29uc3QgcyA9IDEuMCArIE1hdGguc2luKERhdGUubm93KCkgKiAwLjAwNSkgKiAwLjE7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcuc2NhbGUuc2V0KHMsIHMsIHMpOwogICAgICAgICAgICB9CgovLyBVcGRhdGUgR2hvc3QgQmFsbHMKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2hvc3RCYWxscy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2hvc3RCYWxsc1tpXTsKICAgICAgICAgICAgICAgIGIubGlmZSAtPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gLS0tIFBIWVNJQ1MgJiBWSVNVQUxTIERFTEVHQVRJT04gLS0tCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguQmFsbCAmJiB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZS51cGRhdGVGcmVlKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlRnJlZS5jYWxsKGIsIGR0KTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZS51cGRhdGVWaXN1YWxzLmNhbGwoYiwgZHQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBUcmFpbAogICAgICAgICAgICAgICAgaWYgKGIudHJhaWwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFpbFBvcyA9IGIubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChiLmRlZm9ybU5vZGUpIHRyYWlsUG9zLnkgKz0gYi5kZWZvcm1Ob2RlLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICAgICAgYi50cmFpbC51cGRhdGUodHJhaWxQb3MpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIC0tLSBHT0FMIERFVEVDVElPTiBGT1IgR0hPU1QgQkFMTFMgLS0tCiAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBiLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICAvLyBDaGVjayBaIGRlcHRoIChHb2FsIGlzIGF0ICsvLSAyOCwgdHJpZ2dlciBhdCAyOSkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueikgPiAyOS4wKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gR29hbCBCb3ggRGltZW5zaW9ucyAoTWF0Y2hlcyBHYW1lTWFuYWdlcikKICAgICAgICAgICAgICAgICAgICBjb25zdCBoYWxmV2lkdGggPSAxMS4wOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhbGZIZWlnaHQgPSA5LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbFlPZmZzZXQgPSAtNC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueCkgPD0gaGFsZldpZHRoICYmIE1hdGguYWJzKHBvcy55IC0gZ29hbFlPZmZzZXQpIDw9IGhhbGZIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR09BTCEKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIEdvYWwgRlgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIHBvcywgeyBzY2FsZTogOC4wLCBsaWZlOiAwLjUgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIHBvcywgeyBzY2FsZTogNS4wIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVicmlzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGs9MDsgazwxMDsgaysrKSB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdkZWJyaXMnLCBwb3MsIHsgc2NhbGU6IDAuNSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiR09BTCIsIHBvcywgImdvYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAvLyBLaWxsIGJhbGwgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgICAgICAgICAgYi5saWZlID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2xlYW51cAogICAgICAgICAgICAgICAgaWYgKGIubGlmZSA8PSAwIHx8IGIubWVzaC5wb3NpdGlvbi55IDwgLTEwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLnJlbW92ZShiLm1lc2gpOwogICAgICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGIudHJhaWwubWVzaC5nZW9tZXRyeSkgYi50cmFpbC5tZXNoLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3NldHVwRXZlbnRzKCkgewoKICAgICAgICAgICAgLy8gTWluaW1pemUgLyBSZXN0b3JlCiAgICAgICAgICAgIGNvbnN0IG1pbkJ0biA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI3AtbWluaW1pemUnKTsKICAgICAgICAgICAgaWYgKG1pbkJ0bikgewogICAgICAgICAgICAgICAgbWluQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVQYW5lbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dSZXN0b3JlQnRuKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgcmVzdG9yZUJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcmFjdGljZS1yZXN0b3JlLWJ0bicpOwogICAgICAgICAgICBpZiAocmVzdG9yZUJ0bikgewogICAgICAgICAgICAgICAgcmVzdG9yZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93UGFuZWwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUmVzdG9yZUJ0bigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERyaWxsIEJ1dHRvbnMKICAgICAgICAgICAgdGhpcy51aS5xdWVyeVNlbGVjdG9yQWxsKCcuZHJpbGwtYnRuJykuZm9yRWFjaChidG4gPT4gewogICAgICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RHJpbGwoYnRuLmRhdGFzZXQuZHJpbGwpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUmVzZXQgQmFsbAogICAgICAgICAgICBjb25zdCByZXNldEJ0biA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI3AtcmVzZXQtYmFsbCcpOwogICAgICAgICAgICBpZiAocmVzZXRCdG4pIHsKICAgICAgICAgICAgICAgIHJlc2V0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRXhpdAogICAgICAgICAgICBjb25zdCBleGl0QnRuID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjcC1leGl0Jyk7CiAgICAgICAgICAgIGlmIChleGl0QnRuKSB7CiAgICAgICAgICAgICAgICBleGl0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlci5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9wdGlvbnMgVG9nZ2xlcwogICAgICAgICAgICB0aGlzLl9iaW5kVG9nZ2xlKCdvcHQtaW5mLXN0YXQnLCAnaW5mU3RhdHMnKTsKICAgICAgICAgICAgdGhpcy5fYmluZFRvZ2dsZSgnb3B0LWFpLWR1bW15JywgJ2FpRHVtbXknLCAodmFsKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgQUkgRHVtbXkgc3RhdGUgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LmFpRW5hYmxlZCA9ICF2YWw7IC8vIElmIGR1bW15IGlzIFRSVUUsIEFJIGlzIEZBTFNFCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9iaW5kVG9nZ2xlKCdvcHQtaGl0Ym94ZXMnLCAnc2hvd0hpdGJveGVzJywgKHZhbCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLmVuYWJsZWQgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5zaG93SGl0Ym94ZXMgPSB2YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gS2V5Ym9hcmQgU2hvcnRjdXQgZm9yIFJlc2V0IChSKQovLyBLZXlib2FyZCBTaG9ydGN1dCBmb3IgUmVzZXQgKFIpCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzUnVubmluZyAmJiBlLmtleS50b0xvd2VyQ2FzZSgpID09PSAncicgJiYgIWUucmVwZWF0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKX2JpbmRUb2dnbGUoaWQsIG9wdGlvbktleSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgY29uc3QgZWwgPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoYCMke2lkfWApOwogICAgICAgICAgICBpZiAoIWVsKSByZXR1cm47CgogICAgICAgICAgICAvLyBIZWxwZXIgdG8gdXBkYXRlIHZpc3VhbHMKICAgICAgICAgICAgY29uc3QgdXBkYXRlVmlzdWFsID0gKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgaXNBY3RpdmUgPSB0aGlzLm9wdGlvbnNbb3B0aW9uS2V5XTsKICAgICAgICAgICAgICAgIGVsLmNsYXNzTGlzdC50b2dnbGUoJ2FjdGl2ZScsIGlzQWN0aXZlKTsKICAgICAgICAgICAgICAgIGNvbnN0IGJveCA9IGVsLnF1ZXJ5U2VsZWN0b3IoJy5jaGVja2JveCcpOwogICAgICAgICAgICAgICAgaWYgKGJveCkgYm94LmlubmVyVGV4dCA9IGlzQWN0aXZlID8gJ+KWoycgOiAn4pahJzsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgdmlzdWFsIHN0YXRlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIHVwZGF0ZVZpc3VhbCgpOwoKICAgICAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9uc1tvcHRpb25LZXldID0gIXRoaXMub3B0aW9uc1tvcHRpb25LZXldOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB1cGRhdGVWaXN1YWwoKTsKCiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKHRoaXMub3B0aW9uc1tvcHRpb25LZXldKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKCiAgICAgICAgX3NldHVwQmFsbExhYigpIHsKICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIkJBTEwgTEFCOiBPcGVuIERldlRvb2xzIOKGkiBCYWxsIExhYi4gVXNlIFNob3QgQ2Fubm9uICsgdHJhamVjdG9yeSBwcmV2aWV3ICsgcmVjb3JkL3JlcGxheS4iKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKCiAgICAgICAgICAgIGNvbnN0IGhvbWUgPSB0aGlzLmdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgY29uc3QgYXdheSA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5OwogICAgICAgICAgICBjb25zdCBwID0gaG9tZSA/IGhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKICAgICAgICAgICAgaWYgKCFwKSByZXR1cm47CgogICAgICAgICAgICAvLyBTb2xvIG1vZGU6IGhpZGUgZXZlcnlvbmUgZXhjZXB0IHRoZSBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmIChob21lICYmIGhvbWUucGxheWVycykgewogICAgICAgICAgICAgICAgaG9tZS5wbGF5ZXJzLmZvckVhY2gobWF0ZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGUubWVzaCkgbWF0ZS5tZXNoLnZpc2libGUgPSAobWF0ZSA9PT0gcCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXdheSAmJiBhd2F5LnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGF3YXkucGxheWVycy5mb3JFYWNoKG9wcCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wcC5tZXNoKSBvcHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUGxhY2UgYWN0aXZlIHBsYXllciBhdCBjZW50ZXIgZmFjaW5nIHRoZSBhd2F5IGdvYWwKICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLTI4KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgaWYgKHAuc3luY1JvdGF0aW9uKSBwLnN5bmNSb3RhdGlvbigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCaWcgc3RhdHMgc28geW91IGNhbiB0ZXN0IGV4dHJlbWVzCiAgICAgICAgICAgIGlmIChwLnN0YXRzKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlBBID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkVOID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLm1heEhQID0gTWF0aC5tYXgocC5zdGF0cy5tYXhIUCB8fCA5OTksIDk5OSk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkhQID0gcC5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQSBjbGVhciB0YXJnZXQgbWFya2VyIChwdXJlbHkgdmlzdWFsKQogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uc2V0KDAsIDAuMSwgLTE4KTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZjAwZmYpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KCiAgICAgICAgX2xvb3BCYWxsTGFiKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgaWYgKCFiIHx8ICFwKSByZXR1cm47CgogICAgICAgICAgICAvLyBBdXRvLXJlc2V0IGJhbGwgYmFjayB0byBwbGF5ZXIgb25jZSBpdCBjb21lcyB0byByZXN0LAogICAgICAgICAgICAvLyBzbyB5b3UgY2FuIHNwYW0gdmFyaWF0aW9ucyB3aXRob3V0IHRvdWNoaW5nIGFueXRoaW5nLgogICAgICAgICAgICBpZiAoYi5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzdG9wcGVkID0gKGIudmVsb2NpdHkubGVuZ3RoU3EoKSA8IDAuMDEpICYmIChiLnBvd2VyIDw9IDAuMDEpOwogICAgICAgICAgICAgICAgaWYgKHN0b3BwZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gKHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgfHwgMCkgKyBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA+IDAuNDUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbGlnaHQgdGFyZ2V0IGJvYiAoaGVscHMgZGVwdGggcGVyY2VwdGlvbikKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZyAmJiB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnkgPSAwLjEgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDMpICogMC4wNTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5SW5maW5pdGVTdGF0cygpIHsKICAgICAgICAgICAgY29uc3QgaG9tZSA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBpZiAoaG9tZSkgewogICAgICAgICAgICAgICAgaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7CiAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSBwLnN0YXRzLkVOOwogICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLnZlbm9tID0gMDsKICAgICAgICAgICAgICAgICAgICBwLnN0YXR1cy5uYXAgPSAwOwogICAgICAgICAgICAgICAgICAgIHAuc3R1blRpbWVyID0gMDsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2xlYXJEcmlsbCgpIHsKICAgICAgICAgICAgLy8gUmVzZXQgcG9zaXRpb25zLCBjbGVhciBkdW1taWVzLCByZXNldCBzY29yZQppZiAodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KSBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlID0geyBzY29yZTogMCwgdGltZXI6IDAsIHN0YWdlOiAwLCByZXNldHRpbmc6IGZhbHNlIH07CiAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUmVzZXQgdGVhbXMgdG8gZGVmYXVsdCBwb3NpdGlvbnMKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IEFJIER1bW15IHNldHRpbmcKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5haUVuYWJsZWQgPSAhdGhpcy5vcHRpb25zLmFpRHVtbXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gSGlkZSBhd2F5IHRlYW0gYnkgZGVmYXVsdCBpbiBkcmlsbHMgdW5sZXNzIHNwZWNpZmllZAogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIC0xMDAsIDApOyAvLyBNb3ZlIGF3YXkKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFbnN1cmUgSG9tZSB0ZWFtIGlzIHZpc2libGUKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgX3Jlc2V0QmFsbFRvUGxheWVyKCkgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmIChwICYmIGIpIHsKICAgICAgICAgICAgICAgIGIucmVzZXQoKTsKICAgICAgICAgICAgICAgIGIuZ3JhYihwKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJSRVNFVCIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU25hcCBjYW1lcmEKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FtZXJhTWFuYWdlcikgdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVTY29yZVVJKHZhbCkgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI2RyaWxsLXNjb3JlJyk7CiAgICAgICAgICAgIGlmIChlbCkgZWwuaW5uZXJUZXh0ID0gYFNDT1JFOiAke3ZhbH1gOwogICAgICAgIH0KCiAgICAgICAgX3NldEluc3RydWN0aW9uKHRleHQpIHsKICAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjZHJpbGwtaW5zdHJ1Y3Rpb24nKTsKICAgICAgICAgICAgIGlmIChlbCkgZWwuaW5uZXJUZXh0ID0gdGV4dDsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBEUklMTFMgLS0tCgogICAgICAgIF9zZXR1cEZyZWUoKSB7CiAgICAgICAgICAgIHRoaXMuX3NldEluc3RydWN0aW9uKCJGcmVlIHByYWN0aWNlLiBJbmZpbml0ZSBIUC9FTi4iKTsKICAgICAgICAgICAgLy8gU2hvdyBldmVyeW9uZQogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5jb3B5KHAuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQogICAgICAgIF9sb29wRnJlZShkdCkge30KCiAgICAgICAgX3NldHVwU2hvb3RpbmcoKSB7CgogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiU2NvcmUgb24gdGhlIEdvYWxpZSEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOyAvLyBDbGVhciByZXNldCBmbGFnCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXR1cDogQWN0aXZlIFBsYXllciBhdCAxOG0sIEdvYWxpZSBpbiBuZXQuCiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIGNvbnN0IGcgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHAgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC0xMCk7IC8vIDE4bSBvdXQgKEhvbWUgYXR0YWNrcyAtWikKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLTI4KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZyAmJiBnLm1lc2gpIHsKICAgICAgICAgICAgICAgIGcubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGcubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTI3KTsKICAgICAgICAgICAgICAgIGcubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBnLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9sb29wU2hvb3RpbmcoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGdvYWwgc2NvcmVkIChHYW1lTWFuYWdlciBoYW5kbGVzIHRoZSBhY3R1YWwgZ29hbCBldmVudCwgYnV0IHdlIHRyYWNrIHJlc2V0KQogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YXRlID09PSAnZ29hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRoaXMuZHJpbGxTdGF0ZS5zY29yZSk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhdGUgPSAnYWN0aXZlJzsgLy8gSGlqYWNrIHN0YXRlIGJhY2sKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBTaG9vdGluZygpLCAxMDAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgZ29hbGllIGNhdGNoZXMKICAgICAgICAgICAgY29uc3QgZyA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ0dMJyk7CiAgICAgICAgICAgIGlmIChnICYmIGcuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTQVZFRCIsIGcubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBTaG9vdGluZygpLCAxMDAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3NldHVwUGFzc2luZygpIHsKCiAgICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiUGFzcyB0byB0aGUgbW92aW5nIHRhcmdldCEiKTsKICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgICAvLyBTZXR1cDogQWN0aXZlIFBsYXllciBjZW50ZXIuIDEgVGVhbW1hdGUgcnVubmluZyBwYXR0ZXJucy4KICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQoeCA9PiB4ICE9PSBwICYmIHgucm9sZSAhPT0gJ0dMJyk7CiAgICAgICAgICAgICAKICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS50YXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICAgICAKICAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAxMCk7CiAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgfQogICAgICAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOwogICAgICAgICAgICAgICAgIHRhcmdldC5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgIHRhcmdldC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgfQogICAgICAgICAgICAgCiAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KCiAgICAgICAgX2xvb3BQYXNzaW5nKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmRyaWxsU3RhdGUudGFyZ2V0OwogICAgICAgICAgICBpZiAoIXRhcmdldCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTW92ZSB0YXJnZXQgaW4gY2lyY2xlCiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS50aW1lciArPSBkdDsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gucG9zaXRpb24ueCA9IE1hdGguc2luKHRoaXMuZHJpbGxTdGF0ZS50aW1lcikgKiAxMDsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gucG9zaXRpb24ueiA9IC0xMCArIE1hdGguY29zKHRoaXMuZHJpbGxTdGF0ZS50aW1lciAqIDAuNSkgKiA1OwogICAgICAgICAgICB0YXJnZXQubWVzaC5sb29rQXQoMCwwLDEwKTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBSaW5nCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi5jb3B5KHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi55ID0gMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweDAwZmZmZik7IC8vIEN5YW4KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRhcmdldC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5zY29yZSsrOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIk5JQ0UgUEFTUyEiLCB0YXJnZXQubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVzZXQKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRhcmdldC5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NldHVwUGFzc2luZygpOyAvLyBSZS1zZXR1cCB0byByZXNldCBwb3NpdGlvbnMKICAgICAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgX3NldHVwRGVmZW5zZSgpIHsKCiAgICAgICAgICAgIHRoaXMuX3NldEluc3RydWN0aW9uKCJUYWNrbGUgdGhlIGF0dGFja2VyISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBhdHRhY2tlciA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuYXR0YWNrZXIgPSBhdHRhY2tlcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDIwKTsgLy8gTmVhciBvd24gZ29hbAogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhdHRhY2tlcikgewogICAgICAgICAgICAgICAgYXR0YWNrZXIubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGF0dGFja2VyLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC0xMCk7CiAgICAgICAgICAgICAgICBhdHRhY2tlci52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgLy8gR2l2ZSBiYWxsIHRvIGF0dGFja2VyCiAgICAgICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICBiLnJlc2V0KCk7CiAgICAgICAgICAgICAgICBiLmdyYWIoYXR0YWNrZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9sb29wRGVmZW5zZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgYXR0YWNrZXIgPSB0aGlzLmRyaWxsU3RhdGUuYXR0YWNrZXI7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWF0dGFja2VyIHx8ICFwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBdHRhY2tlciBydW5zIHRvIGdvYWwgKCtaKQogICAgICAgICAgICBjb25zdCBnb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMjgpOwogICAgICAgICAgICBjb25zdCBkaXIgPSBnb2FsUG9zLmNsb25lKCkuc3ViKGF0dGFja2VyLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFJpbmcgb24gQXR0YWNrZXIKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLmNvcHkoYXR0YWNrZXIubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZjAwMDApOyAvLyBSZWQgZm9yIGVuZW15CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhdHRhY2tlci5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBhdHRhY2tlci5zZXRJbnB1dChkaXIueCwgZGlyLnopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQmFsbCBsb3N0IChUYWNrbGVkKQogICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCB8fCB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTVE9QUEVEISIsIHAubWVzaC5wb3NpdGlvbiwgImJsb2NrIik7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cERlZmVuc2UoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZhaWwgY29uZGl0aW9uOiBBdHRhY2tlciBzY29yZXMgKEdhbWVNYW5hZ2VyIGhhbmRsZXMgZ29hbCBjaGVjaykKICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc3RhdGUgPT09ICdnb2FsJykgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhdGUgPSAnYWN0aXZlJzsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJGQUlMRUQiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBEZWZlbnNlKCksIDEwMDApOwogICAgICAgICAgICB9Cn0KCiAgICAgICAgX3NldHVwQ3VydmUoKSB7CnRoaXMuX3NldEluc3RydWN0aW9uKCJTd2lwZSBhIENVUlZFICggKSApIHRvIGJ5cGFzcyB0aGUgZGVmZW5kZXIhIik7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFNob3cgZ2VzdHVyZSBoaW50CiAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDbGVhciBhbnkgZXhpc3RpbmcgdGltZW91dAogICAgICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCkgY2xlYXJUaW1lb3V0KHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEF1dG8gaGlkZSBhZnRlciA0cwogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAvLyBVc2UgYSBkZWZlbmRlciBkdW1teQogICAgICAgICAgICBjb25zdCBkZWZlbmRlciA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ0xEJyk7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5kZWZlbmRlciA9IGRlZmVuZGVyOwoKICAgICAgICAgICAgaWYgKHApIHsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMTUpOwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtMjgpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGVmZW5kZXIpIHsKICAgICAgICAgICAgICAgIGRlZmVuZGVyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBkZWZlbmRlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCA1KTsgLy8gMTBtIGluIGZyb250IG9mIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIubWVzaC5sb29rQXQoMCwgMCwgMTUpOyAvLyBGYWNlIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEJvb3N0IEJMIHRvIGVuc3VyZSBzdHJhaWdodCBzaG90cyBhcmUgYmxvY2tlZAogICAgICAgICAgICAgICAgZGVmZW5kZXIuc3RhdHMuQkwgPSA5OTsgCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhleSBkb24ndCBtb3ZlCiAgICAgICAgICAgICAgICBkZWZlbmRlci5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUYXJnZXQgUmluZyBiZWhpbmQgZGVmZW5kZXIKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnNldCgwLCAwLjEsIC0xMCk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4MDBmZmZmKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgpfbG9vcEN1cnZlKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IGRlZmVuZGVyID0gdGhpcy5kcmlsbFN0YXRlLmRlZmVuZGVyOwoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgYmFsbCBwYXNzZWQgdGhlIGRlZmVuZGVyIGxpbmUgKHogPCAwKQogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAwKSB7CiAgICAgICAgICAgICAgICAvLyBTdWNjZXNzIHpvbmUgKFdpdGhpbiA1bSB3aWR0aCkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhiYWxsLm1lc2gucG9zaXRpb24ueCkgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRUQhIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBDdXJ2ZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGJsb2NrZWQgKEJhbGwgc3RvcHBlZCBvciBwb3dlciBkcmFpbmVkIHNpZ25pZmljYW50bHkgbmVhciBkZWZlbmRlcikKICAgICAgICAgICAgaWYgKGRlZmVuZGVyICYmIGJhbGwubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGRlZmVuZGVyLm1lc2gucG9zaXRpb24pIDwgMy4wKSB7CiAgICAgICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA8PSAwIHx8IGJhbGwudmVsb2NpdHkubGVuZ3RoKCkgPCAxLjApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0tFRCIsIGRlZmVuZGVyLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZS1zaG93IGhpbnQgb24gZmFpbHVyZSB0byBndWlkZSBwbGF5ZXIKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTWlzc2VkIC8gT3V0IG9mIGJvdW5kcwogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAtMTUpIHsKICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiTUlTU0VEIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgLy8gUmUtc2hvdyBoaW50IG9uIG1pc3MKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX3NldHVwUmFwaWRGaXJlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVU5MSU1JVEVEIEFNTU8hIFNwYW0gdGhyb3dzISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBGaW5kIFRpZHVzIG9yIGRlZmF1bHQgdG8gTEYKICAgICAgICAgICAgbGV0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQoeCA9PiB4LmNoYXJhY3Rlck5hbWUgJiYgeC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKTsKICAgICAgICAgICAgaWYgKCFwKSBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnTEYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldCBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5zZXRBY3RpdmVQbGF5ZXIocCk7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtMjgpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBCb29zdCBzdGF0cyBmb3IgZnVuCiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlBBID0gOTk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEhJREUgRVZFUllPTkUgKEFsb25lIE1vZGUpCiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChtYXRlID0+IHsKICAgICAgICAgICAgICAgIGlmIChtYXRlICE9PSBwICYmIG1hdGUubWVzaCkgbWF0ZS5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChvcHAgPT4gewogICAgICAgICAgICAgICAgaWYgKG9wcC5tZXNoKSBvcHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgpfbG9vcFJhcGlkRmlyZShkdCkgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CgogICAgICAgICAgICBpZiAoIXAgfHwgIWIpIHJldHVybjsKCiAgICAgICAgICAgIC8vIERldGVjdCBpZiBiYWxsIHdhcyBqdXN0IHRocm93biAoaXMgZnJlZSkKICAgICAgICAgICAgaWYgKGIuc3RhdGUgPT09ICdmcmVlJykgewogICAgICAgICAgICAgICAgLy8gMS4gU3Bhd24gR2hvc3QgQmFsbCAoVmlzdWFsIENvcHkpCiAgICAgICAgICAgICAgICAvLyBDbG9uZSB0aGUgbWVzaCBoaWVyYXJjaHkgdG8gcHJlc2VydmUgRGVmb3JtL1NwaW4gbm9kZXMKICAgICAgICAgICAgICAgIGNvbnN0IGdob3N0TWVzaCA9IGIubWVzaC5jbG9uZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdmlzaWJpbGl0eSBhbmQgYWRkIHRvIHNjZW5lCiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKGdob3N0TWVzaCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlLWJpbmQgaW50ZXJuYWwgcmVmZXJlbmNlcyBmb3IgdGhlIHBoeXNpY3MgZW5naW5lCiAgICAgICAgICAgICAgICAvLyBIaWVyYXJjaHk6IE1lc2ggLT4gRGVmb3JtTm9kZSAtPiBTcGluTm9kZQogICAgICAgICAgICAgICAgY29uc3QgZGVmb3JtTm9kZSA9IGdob3N0TWVzaC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5Ob2RlID0gZGVmb3JtTm9kZSA/IGRlZm9ybU5vZGUuY2hpbGRyZW5bMF0gOiBudWxsOwoKICAgICAgICAgICAgICAgIC8vIERldGVybWluZSBUcmFpbCBDb2xvciBiYXNlZCBvbiBUZWNoCiAgICAgICAgICAgICAgICBsZXQgdHJhaWxDb2xvciA9IDB4ZmY0NDAwOyAvLyBEZWZhdWx0IFNIIChPcmFuZ2UpCiAgICAgICAgICAgICAgICBpZiAoYi50ZWNobmlxdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ3Zlbm9tJykgdHJhaWxDb2xvciA9IDB4YWEwMGZmOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICd3aXRoZXInKSB0cmFpbENvbG9yID0gMHg4ODg4ODg7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ25hcCcpIHRyYWlsQ29sb3IgPSAweDAwMDA4ODsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnc3BoZXJlJykgdHJhaWxDb2xvciA9IDB4MDBmZmZmOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICdqZWNodCcpIHRyYWlsQ29sb3IgPSAweGZmMDAwMDsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnaW52aXNpYmxlJykgdHJhaWxDb2xvciA9IDB4NDQ0NDQ0OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChiLnBvd2VyVHlwZSA9PT0gJ1BBJykgewogICAgICAgICAgICAgICAgICAgIHRyYWlsQ29sb3IgPSAweDAwYWFmZjsgLy8gUGFzcyAoQmx1ZSkKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDcmVhdGUgVHJhaWwKICAgICAgICAgICAgICAgIGNvbnN0IHRyYWlsID0gbmV3IHdpbmRvdy5mbHV4LlRyYWlsUmVuZGVyZXIodGhpcy5nYW1lLnNjZW5lKTsKICAgICAgICAgICAgICAgIHRyYWlsLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0cmFpbC5zZXRDb2xvcih0cmFpbENvbG9yKTsKICAgICAgICAgICAgICAgIHRyYWlsLnJlc2V0KGdob3N0TWVzaC5wb3NpdGlvbik7CgogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIGEgIk1vY2siIEJhbGwgb2JqZWN0IHRoYXQgc2F0aXNmaWVzIEJhbGwuanMgcGh5c2ljcyByZXF1aXJlbWVudHMKICAgICAgICAgICAgICAgIGNvbnN0IGdob3N0QmFsbCA9IHsKICAgICAgICAgICAgICAgICAgICBtZXNoOiBnaG9zdE1lc2gsCiAgICAgICAgICAgICAgICAgICAgZGVmb3JtTm9kZTogZGVmb3JtTm9kZSwKICAgICAgICAgICAgICAgICAgICBzcGluTm9kZTogc3Bpbk5vZGUsCiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IGIudmVsb2NpdHkuY2xvbmUoKSwKICAgICAgICAgICAgICAgICAgICBhbmd1bGFyVmVsb2NpdHk6IGIuYW5ndWxhclZlbG9jaXR5ID8gYi5hbmd1bGFyVmVsb2NpdHkuY2xvbmUoKSA6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgYWNjdW11bGF0ZWRSb3RhdGlvbjogYi5hY2N1bXVsYXRlZFJvdGF0aW9uID8gYi5hY2N1bXVsYXRlZFJvdGF0aW9uLmNsb25lKCkgOiBuZXcgVEhSRUUuUXVhdGVybmlvbigpLAogICAgICAgICAgICAgICAgICAgIHN0YXRlOiAnZnJlZScsCiAgICAgICAgICAgICAgICAgICAgcG93ZXI6IGIucG93ZXIsCiAgICAgICAgICAgICAgICAgICAgcG93ZXJUeXBlOiBiLnBvd2VyVHlwZSwKICAgICAgICAgICAgICAgICAgICB0ZWNobmlxdWU6IGIudGVjaG5pcXVlLAogICAgICAgICAgICAgICAgICAgIGlzSW52aXNpYmxlOiBiLmlzSW52aXNpYmxlLAogICAgICAgICAgICAgICAgICAgIGxpZmU6IDUuMCwgLy8gRW5vdWdoIHRpbWUgdG8gcmVhY2ggZ29hbAogICAgICAgICAgICAgICAgICAgIHRyYWlsOiB0cmFpbCwKICAgICAgICAgICAgICAgICAgICBfYnViYmxlVGltZXI6IDAsCiAgICAgICAgICAgICAgICAgICAgX2dob3N0OiB0cnVlLAogICAgICAgICAgICAgICAgICAgIC8vIE1vY2sgbWV0aG9kcwogICAgICAgICAgICAgICAgICAgIHJlc2V0OiAoKSA9PiB7fSwgCiAgICAgICAgICAgICAgICAgICAgZHJvcDogKCkgPT4ge30sCiAgICAgICAgICAgICAgICAgICAgcmV2ZWFsOiAoKSA9PiB7fQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSB2aXNpYmlsaXR5CiAgICAgICAgICAgICAgICBnaG9zdE1lc2gudmlzaWJsZSA9ICFiLmlzSW52aXNpYmxlOwoKICAgICAgICAgICAgICAgIHRoaXMuZ2hvc3RCYWxscy5wdXNoKGdob3N0QmFsbCk7CgovLyAyLiBSZXNldCBSZWFsIEJhbGwgdG8gUGxheWVyIElOU1RBTlRMWQogICAgICAgICAgICAgICAgYi52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZJWDogRm9yY2UgYmFsbCBwb3NpdGlvbiB0byBiZSBleHBsaWNpdGx5IGluIGZyb250IG9mIHRoZSBwbGF5ZXIKICAgICAgICAgICAgICAgIC8vIFRoaXMgcHJldmVudHMgYW55IGxvZ2ljIGZyb20gdGhpbmtpbmcgdGhlIGJhbGwgaXMgYmVoaW5kIGFuZCB0cmlnZ2VyaW5nIGEgdHVybgogICAgICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHAubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIGIubWVzaC5wb3NpdGlvbi5jb3B5KHAubWVzaC5wb3NpdGlvbikuYWRkKGZ3ZC5tdWx0aXBseVNjYWxhcigwLjgpKTsKICAgICAgICAgICAgICAgIGIubWVzaC5wb3NpdGlvbi55ICs9IDEuMDsKCiAgICAgICAgICAgICAgICAvLyBNYW51YWwgQXR0YWNoIChCeXBhc3MgJ2NhdGNoJyBhbmltYXRpb24pCiAgICAgICAgICAgICAgICBiLmhvbGRlciA9IHA7CiAgICAgICAgICAgICAgICBiLnN0YXRlID0gJ2hlbGQnOwogICAgICAgICAgICAgICAgcC5oYXNCYWxsID0gdHJ1ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVzZXQgUGxheWVyIFRocm93IFN0YXRlIHNvIHRoZXkgY2FuIGZpcmUgYWdhaW4gaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIHAuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcC5jYXRjaENvb2xkb3duID0gMDsKCiAgICAgICAgICAgICAgICAvLyBTeW5jIHJvdGF0aW9uIHRvIHByZXZlbnQgc25hcHBpbmcKICAgICAgICAgICAgICAgIGlmIChwLnN5bmNSb3RhdGlvbikgcC5zeW5jUm90YXRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5zdXJlIGluZmluaXRlIHN0YXRzCiAgICAgICAgICAgIHAuY3VycmVudEVOID0gcC5zdGF0cy5FTjsKICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7CiAgICAgICAgfQoKICAgICAgICBfc2hvd1BhbmVsKCkgewogICAgICAgICAgICBpZiAodGhpcy51aSkgdGhpcy51aS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICB9CgogICAgICAgIF9oaWRlUGFuZWwoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnVpKSB0aGlzLnVpLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dSZXN0b3JlQnRuKCkgewogICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2UtcmVzdG9yZS1idG4nKTsKICAgICAgICAgICAgaWYgKGJ0bikgYnRuLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgIH0KCiAgICAgICAgX2hpZGVSZXN0b3JlQnRuKCkgewogICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2UtcmVzdG9yZS1idG4nKTsKICAgICAgICAgICAgaWYgKGJ0bikgYnRuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQogICAgfQp3aW5kb3cuZmx1eC5QcmFjdGljZU1hbmFnZXIgPSBQcmFjdGljZU1hbmFnZXI7Cn0pKCk7","/PracticeManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQcmFjdGljZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREcmlsbCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZSA9IHt9OyAKICAgICAgICAgICAgCnRoaXMuZHJpbGxzID0gewogICAgICAgICAgICAgICAgJ2ZyZWUnOiB7IG5hbWU6ICdGUkVFIFJPQU0nLCBzZXR1cDogdGhpcy5fc2V0dXBGcmVlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BGcmVlLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdiYWxsX2xhYic6IHsgbmFtZTogJ0JBTEwgTEFCJywgc2V0dXA6IHRoaXMuX3NldHVwQmFsbExhYi5iaW5kKHRoaXMpLCBsb29wOiB0aGlzLl9sb29wQmFsbExhYi5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAnc2hvb3RpbmcnOiB7IG5hbWU6ICdTSE9PVElORyBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cFNob290aW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BTaG9vdGluZy5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncGFzc2luZyc6IHsgbmFtZTogJ1BBU1NJTkcgRFJJTEwnLCBzZXR1cDogdGhpcy5fc2V0dXBQYXNzaW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BQYXNzaW5nLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdkZWZlbnNlJzogeyBuYW1lOiAnREVGRU5TRSBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cERlZmVuc2UuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcERlZmVuc2UuYmluZCh0aGlzKSB9LAogICAgICAgICAgICAgICAgJ2N1cnZlJzogeyBuYW1lOiAnQ1VSVkUgU0hPVCcsIHNldHVwOiB0aGlzLl9zZXR1cEN1cnZlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BDdXJ2ZS5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncmFwaWRfZmlyZSc6IHsgbmFtZTogJ1JBUElEIEZJUkUnLCBzZXR1cDogdGhpcy5fc2V0dXBSYXBpZEZpcmUuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcFJhcGlkRmlyZS5iaW5kKHRoaXMpIH0KICAgICAgICAgICAgfTsKCnRoaXMudWkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2Utb3ZlcmxheScpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dlc3R1cmUtaGludCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gewogICAgICAgICAgICAgICAgaW5mU3RhdHM6IHRydWUsCiAgICAgICAgICAgICAgICBhaUR1bW15OiB0cnVlLAogICAgICAgICAgICAgICAgc2hvd0hpdGJveGVzOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy50YXJnZXRSaW5nID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107IC8vIEFycmF5IHRvIHRyYWNrIHZpc3VhbCBjb3BpZXMgb2YgdGhyb3duIGJhbGxzCiAgICAgICAgICAgIHRoaXMuX2luaXRWaXN1YWxzKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwRXZlbnRzKCk7CiAgICAgICAgfQoKICAgICAgICBfaW5pdFZpc3VhbHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBhIGdsb3dpbmcgcmluZyBmb3IgdGFyZ2V0cwogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMS41LCAxLjgsIDMyKTsKICAgICAgICAgICAgZ2VvbWV0cnkucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBmZmZmLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gQWRkIHRvIHNjZW5lIHZpYSBnYW1lIG1hbmFnZXIgcmVmZXJlbmNlCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc2NlbmUpIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy50YXJnZXRSaW5nKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0KCkgewp0aGlzLmlzUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAvLyBJZiBtZW51IHJlcXVlc3RlZCBhIHNwZWNpZmljIGRyaWxsIChlLmcuLCBCYWxsIExhYiksIGhvbm9yIGl0IG9uY2UuCiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGw7CiAgICAgICAgICAgIGlmIChyZXEgJiYgdGhpcy5kcmlsbHNbcmVxXSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChyZXEpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXgucmVxdWVzdGVkUHJhY3RpY2VEcmlsbCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldERyaWxsKCdmcmVlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBIVUQgaXMgdmlzaWJsZQogICAgICAgICAgICBjb25zdCBodWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKTsKICAgICAgICAgICAgaWYoaHVkKSBodWQuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICB9CgogICAgICAgIHN0b3AoKSB7CgogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlUGFuZWwoKTsKICAgICAgICAgICAgdGhpcy5faGlkZVJlc3RvcmVCdG4oKTsKdGhpcy5fY2xlYXJEcmlsbCgpOwogICAgICAgICAgICAKLy8gQ2xlYXIgR2hvc3QgQmFsbHMKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYi5tZXNoKSB0aGlzLmdhbWUuc2NlbmUucmVtb3ZlKGIubWVzaCk7CiAgICAgICAgICAgICAgICBpZiAoYi50cmFpbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50cmFpbC5tZXNoLmdlb21ldHJ5KSBiLnRyYWlsLm1lc2guZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gZmFsc2U7CgogICAgICAgICAgICAvLyBSZXN0b3JlIEF3YXkgVGVhbSBWaXNpYmlsaXR5IGZvciBOb3JtYWwgTWF0Y2gKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSAwOyAvLyBFbnN1cmUgdGhleSBhcmVuJ3Qgc3R1Y2sgdW5kZXIgZmxvb3IKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGlzYWJsZSBkZWJ1ZyB2aXN1YWxzIGlmIHRoZXkgd2VyZSBvbgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXREcmlsbChrZXkpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmRyaWxsc1trZXldKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuX2NsZWFyRHJpbGwoKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RHJpbGwgPSBrZXk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkucXVlcnlTZWxlY3RvckFsbCgnLmRyaWxsLWJ0bicpLmZvckVhY2goYnRuID0+IHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJywgYnRuLmRhdGFzZXQuZHJpbGwgPT09IGtleSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUnVuIFNldHVwCiAgICAgICAgICAgIHRoaXMuZHJpbGxzW2tleV0uc2V0dXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFubm91bmNlbWVudAogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnNob3dBbm5vdW5jZW1lbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zaG93QW5ub3VuY2VtZW50KHRoaXMuZHJpbGxzW2tleV0ubmFtZSwgJ25vcm1hbCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzUnVubmluZykgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ29tbW9uIFByYWN0aWNlIExvZ2ljIChJbmZpbml0ZSBTdGF0cykKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5pbmZTdGF0cykgewogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbmZpbml0ZVN0YXRzKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERyaWxsIExvZ2ljCiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnREcmlsbCAmJiB0aGlzLmRyaWxsc1t0aGlzLmN1cnJlbnREcmlsbF0ubG9vcCkgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbHNbdGhpcy5jdXJyZW50RHJpbGxdLmxvb3AoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXN1YWxzIEFuaW1hdGlvbgovLyBWaXN1YWxzIEFuaW1hdGlvbgogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nICYmIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucm90YXRpb24ueiArPSBkdDsgLy8gU3BpbgogICAgICAgICAgICAgICAgY29uc3QgcyA9IDEuMCArIE1hdGguc2luKERhdGUubm93KCkgKiAwLjAwNSkgKiAwLjE7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcuc2NhbGUuc2V0KHMsIHMsIHMpOwogICAgICAgICAgICB9CgovLyBVcGRhdGUgR2hvc3QgQmFsbHMKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2hvc3RCYWxscy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2hvc3RCYWxsc1tpXTsKICAgICAgICAgICAgICAgIGIubGlmZSAtPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gLS0tIFBIWVNJQ1MgJiBWSVNVQUxTIERFTEVHQVRJT04gLS0tCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguQmFsbCAmJiB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZS51cGRhdGVGcmVlKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlRnJlZS5jYWxsKGIsIGR0KTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZS51cGRhdGVWaXN1YWxzLmNhbGwoYiwgZHQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBUcmFpbAogICAgICAgICAgICAgICAgaWYgKGIudHJhaWwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFpbFBvcyA9IGIubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChiLmRlZm9ybU5vZGUpIHRyYWlsUG9zLnkgKz0gYi5kZWZvcm1Ob2RlLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICAgICAgYi50cmFpbC51cGRhdGUodHJhaWxQb3MpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIC0tLSBHT0FMIERFVEVDVElPTiBGT1IgR0hPU1QgQkFMTFMgLS0tCiAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBiLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICAvLyBDaGVjayBaIGRlcHRoIChHb2FsIGlzIGF0ICsvLSAyOCwgdHJpZ2dlciBhdCAyOSkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueikgPiAyOS4wKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gR29hbCBCb3ggRGltZW5zaW9ucyAoTWF0Y2hlcyBHYW1lTWFuYWdlcikKICAgICAgICAgICAgICAgICAgICBjb25zdCBoYWxmV2lkdGggPSAxMS4wOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhbGZIZWlnaHQgPSA5LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbFlPZmZzZXQgPSAtNC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueCkgPD0gaGFsZldpZHRoICYmIE1hdGguYWJzKHBvcy55IC0gZ29hbFlPZmZzZXQpIDw9IGhhbGZIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR09BTCEKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIEdvYWwgRlgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIHBvcywgeyBzY2FsZTogOC4wLCBsaWZlOiAwLjUgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIHBvcywgeyBzY2FsZTogNS4wIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVicmlzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGs9MDsgazwxMDsgaysrKSB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdkZWJyaXMnLCBwb3MsIHsgc2NhbGU6IDAuNSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiR09BTCIsIHBvcywgImdvYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAvLyBLaWxsIGJhbGwgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgICAgICAgICAgYi5saWZlID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2xlYW51cAogICAgICAgICAgICAgICAgaWYgKGIubGlmZSA8PSAwIHx8IGIubWVzaC5wb3NpdGlvbi55IDwgLTEwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLnJlbW92ZShiLm1lc2gpOwogICAgICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGIudHJhaWwubWVzaC5nZW9tZXRyeSkgYi50cmFpbC5tZXNoLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3NldHVwRXZlbnRzKCkgewoKICAgICAgICAgICAgLy8gTWluaW1pemUgLyBSZXN0b3JlCiAgICAgICAgICAgIGNvbnN0IG1pbkJ0biA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI3AtbWluaW1pemUnKTsKICAgICAgICAgICAgaWYgKG1pbkJ0bikgewogICAgICAgICAgICAgICAgbWluQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVQYW5lbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dSZXN0b3JlQnRuKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgcmVzdG9yZUJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcmFjdGljZS1yZXN0b3JlLWJ0bicpOwogICAgICAgICAgICBpZiAocmVzdG9yZUJ0bikgewogICAgICAgICAgICAgICAgcmVzdG9yZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93UGFuZWwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUmVzdG9yZUJ0bigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERyaWxsIEJ1dHRvbnMKICAgICAgICAgICAgdGhpcy51aS5xdWVyeVNlbGVjdG9yQWxsKCcuZHJpbGwtYnRuJykuZm9yRWFjaChidG4gPT4gewogICAgICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RHJpbGwoYnRuLmRhdGFzZXQuZHJpbGwpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUmVzZXQgQmFsbAogICAgICAgICAgICBjb25zdCByZXNldEJ0biA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI3AtcmVzZXQtYmFsbCcpOwogICAgICAgICAgICBpZiAocmVzZXRCdG4pIHsKICAgICAgICAgICAgICAgIHJlc2V0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRXhpdAogICAgICAgICAgICBjb25zdCBleGl0QnRuID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjcC1leGl0Jyk7CiAgICAgICAgICAgIGlmIChleGl0QnRuKSB7CiAgICAgICAgICAgICAgICBleGl0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlci5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9wdGlvbnMgVG9nZ2xlcwogICAgICAgICAgICB0aGlzLl9iaW5kVG9nZ2xlKCdvcHQtaW5mLXN0YXQnLCAnaW5mU3RhdHMnKTsKICAgICAgICAgICAgdGhpcy5fYmluZFRvZ2dsZSgnb3B0LWFpLWR1bW15JywgJ2FpRHVtbXknLCAodmFsKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgQUkgRHVtbXkgc3RhdGUgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LmFpRW5hYmxlZCA9ICF2YWw7IC8vIElmIGR1bW15IGlzIFRSVUUsIEFJIGlzIEZBTFNFCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9iaW5kVG9nZ2xlKCdvcHQtaGl0Ym94ZXMnLCAnc2hvd0hpdGJveGVzJywgKHZhbCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLmVuYWJsZWQgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5zaG93SGl0Ym94ZXMgPSB2YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gS2V5Ym9hcmQgU2hvcnRjdXQgZm9yIFJlc2V0IChSKQovLyBLZXlib2FyZCBTaG9ydGN1dCBmb3IgUmVzZXQgKFIpCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzUnVubmluZyAmJiBlLmtleS50b0xvd2VyQ2FzZSgpID09PSAncicgJiYgIWUucmVwZWF0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKX2JpbmRUb2dnbGUoaWQsIG9wdGlvbktleSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgY29uc3QgZWwgPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoYCMke2lkfWApOwogICAgICAgICAgICBpZiAoIWVsKSByZXR1cm47CgogICAgICAgICAgICAvLyBIZWxwZXIgdG8gdXBkYXRlIHZpc3VhbHMKICAgICAgICAgICAgY29uc3QgdXBkYXRlVmlzdWFsID0gKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgaXNBY3RpdmUgPSB0aGlzLm9wdGlvbnNbb3B0aW9uS2V5XTsKICAgICAgICAgICAgICAgIGVsLmNsYXNzTGlzdC50b2dnbGUoJ2FjdGl2ZScsIGlzQWN0aXZlKTsKICAgICAgICAgICAgICAgIGNvbnN0IGJveCA9IGVsLnF1ZXJ5U2VsZWN0b3IoJy5jaGVja2JveCcpOwogICAgICAgICAgICAgICAgaWYgKGJveCkgYm94LmlubmVyVGV4dCA9IGlzQWN0aXZlID8gJ+KWoycgOiAn4pahJzsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgdmlzdWFsIHN0YXRlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIHVwZGF0ZVZpc3VhbCgpOwoKICAgICAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9uc1tvcHRpb25LZXldID0gIXRoaXMub3B0aW9uc1tvcHRpb25LZXldOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB1cGRhdGVWaXN1YWwoKTsKCiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKHRoaXMub3B0aW9uc1tvcHRpb25LZXldKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKCiAgICAgICAgX3NldHVwQmFsbExhYigpIHsKICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIkJBTEwgTEFCOiBPcGVuIERldlRvb2xzIOKGkiBCYWxsIExhYi4gVXNlIFNob3QgQ2Fubm9uICsgdHJhamVjdG9yeSBwcmV2aWV3ICsgcmVjb3JkL3JlcGxheS4iKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKCiAgICAgICAgICAgIGNvbnN0IGhvbWUgPSB0aGlzLmdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgY29uc3QgYXdheSA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5OwogICAgICAgICAgICBjb25zdCBwID0gaG9tZSA/IGhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKICAgICAgICAgICAgaWYgKCFwKSByZXR1cm47CgogICAgICAgICAgICAvLyBTb2xvIG1vZGU6IGhpZGUgZXZlcnlvbmUgZXhjZXB0IHRoZSBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmIChob21lICYmIGhvbWUucGxheWVycykgewogICAgICAgICAgICAgICAgaG9tZS5wbGF5ZXJzLmZvckVhY2gobWF0ZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGUubWVzaCkgbWF0ZS5tZXNoLnZpc2libGUgPSAobWF0ZSA9PT0gcCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXdheSAmJiBhd2F5LnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGF3YXkucGxheWVycy5mb3JFYWNoKG9wcCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wcC5tZXNoKSBvcHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUGxhY2UgYWN0aXZlIHBsYXllciBhdCBjZW50ZXIgZmFjaW5nIHRoZSBhd2F5IGdvYWwKICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLTI4KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgaWYgKHAuc3luY1JvdGF0aW9uKSBwLnN5bmNSb3RhdGlvbigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCaWcgc3RhdHMgc28geW91IGNhbiB0ZXN0IGV4dHJlbWVzCiAgICAgICAgICAgIGlmIChwLnN0YXRzKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlBBID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkVOID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLm1heEhQID0gTWF0aC5tYXgocC5zdGF0cy5tYXhIUCB8fCA5OTksIDk5OSk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkhQID0gcC5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQSBjbGVhciB0YXJnZXQgbWFya2VyIChwdXJlbHkgdmlzdWFsKQogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uc2V0KDAsIDAuMSwgLTE4KTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZjAwZmYpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KCiAgICAgICAgX2xvb3BCYWxsTGFiKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgaWYgKCFiIHx8ICFwKSByZXR1cm47CgogICAgICAgICAgICAvLyBBdXRvLXJlc2V0IGJhbGwgYmFjayB0byBwbGF5ZXIgb25jZSBpdCBjb21lcyB0byByZXN0LAogICAgICAgICAgICAvLyBzbyB5b3UgY2FuIHNwYW0gdmFyaWF0aW9ucyB3aXRob3V0IHRvdWNoaW5nIGFueXRoaW5nLgogICAgICAgICAgICBpZiAoYi5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzdG9wcGVkID0gKGIudmVsb2NpdHkubGVuZ3RoU3EoKSA8IDAuMDEpICYmIChiLnBvd2VyIDw9IDAuMDEpOwogICAgICAgICAgICAgICAgaWYgKHN0b3BwZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gKHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgfHwgMCkgKyBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA+IDAuNDUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbGlnaHQgdGFyZ2V0IGJvYiAoaGVscHMgZGVwdGggcGVyY2VwdGlvbikKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZyAmJiB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnkgPSAwLjEgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDMpICogMC4wNTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5SW5maW5pdGVTdGF0cygpIHsKICAgICAgICAgICAgY29uc3QgaG9tZSA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBpZiAoaG9tZSkgewogICAgICAgICAgICAgICAgaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7CiAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSBwLnN0YXRzLkVOOwogICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLnZlbm9tID0gMDsKICAgICAgICAgICAgICAgICAgICBwLnN0YXR1cy5uYXAgPSAwOwogICAgICAgICAgICAgICAgICAgIHAuc3R1blRpbWVyID0gMDsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2xlYXJEcmlsbCgpIHsKICAgICAgICAgICAgLy8gUmVzZXQgcG9zaXRpb25zLCBjbGVhciBkdW1taWVzLCByZXNldCBzY29yZQppZiAodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KSBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlID0geyBzY29yZTogMCwgdGltZXI6IDAsIHN0YWdlOiAwLCByZXNldHRpbmc6IGZhbHNlIH07CiAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUmVzZXQgdGVhbXMgdG8gZGVmYXVsdCBwb3NpdGlvbnMKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IEFJIER1bW15IHNldHRpbmcKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5haUVuYWJsZWQgPSAhdGhpcy5vcHRpb25zLmFpRHVtbXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gSGlkZSBhd2F5IHRlYW0gYnkgZGVmYXVsdCBpbiBkcmlsbHMgdW5sZXNzIHNwZWNpZmllZAogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIC0xMDAsIDApOyAvLyBNb3ZlIGF3YXkKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFbnN1cmUgSG9tZSB0ZWFtIGlzIHZpc2libGUKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgX3Jlc2V0QmFsbFRvUGxheWVyKCkgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmIChwICYmIGIpIHsKICAgICAgICAgICAgICAgIGIucmVzZXQoKTsKICAgICAgICAgICAgICAgIGIuZ3JhYihwKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJSRVNFVCIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU25hcCBjYW1lcmEKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FtZXJhTWFuYWdlcikgdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVTY29yZVVJKHZhbCkgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI2RyaWxsLXNjb3JlJyk7CiAgICAgICAgICAgIGlmIChlbCkgZWwuaW5uZXJUZXh0ID0gYFNDT1JFOiAke3ZhbH1gOwogICAgICAgIH0KCiAgICAgICAgX3NldEluc3RydWN0aW9uKHRleHQpIHsKICAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjZHJpbGwtaW5zdHJ1Y3Rpb24nKTsKICAgICAgICAgICAgIGlmIChlbCkgZWwuaW5uZXJUZXh0ID0gdGV4dDsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBEUklMTFMgLS0tCgogICAgICAgIF9zZXR1cEZyZWUoKSB7CiAgICAgICAgICAgIHRoaXMuX3NldEluc3RydWN0aW9uKCJGcmVlIHByYWN0aWNlLiBJbmZpbml0ZSBIUC9FTi4iKTsKICAgICAgICAgICAgLy8gU2hvdyBldmVyeW9uZQogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5jb3B5KHAuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQogICAgICAgIF9sb29wRnJlZShkdCkge30KCiAgICAgICAgX3NldHVwU2hvb3RpbmcoKSB7CgogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiU2NvcmUgb24gdGhlIEdvYWxpZSEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOyAvLyBDbGVhciByZXNldCBmbGFnCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXR1cDogQWN0aXZlIFBsYXllciBhdCAxOG0sIEdvYWxpZSBpbiBuZXQuCiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIGNvbnN0IGcgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHAgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC0xMCk7IC8vIDE4bSBvdXQgKEhvbWUgYXR0YWNrcyAtWikKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLTI4KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZyAmJiBnLm1lc2gpIHsKICAgICAgICAgICAgICAgIGcubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGcubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTI3KTsKICAgICAgICAgICAgICAgIGcubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBnLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9sb29wU2hvb3RpbmcoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGdvYWwgc2NvcmVkIChHYW1lTWFuYWdlciBoYW5kbGVzIHRoZSBhY3R1YWwgZ29hbCBldmVudCwgYnV0IHdlIHRyYWNrIHJlc2V0KQogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YXRlID09PSAnZ29hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRoaXMuZHJpbGxTdGF0ZS5zY29yZSk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhdGUgPSAnYWN0aXZlJzsgLy8gSGlqYWNrIHN0YXRlIGJhY2sKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBTaG9vdGluZygpLCAxMDAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgZ29hbGllIGNhdGNoZXMKICAgICAgICAgICAgY29uc3QgZyA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ0dMJyk7CiAgICAgICAgICAgIGlmIChnICYmIGcuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTQVZFRCIsIGcubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBTaG9vdGluZygpLCAxMDAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3NldHVwUGFzc2luZygpIHsKCiAgICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiUGFzcyB0byB0aGUgbW92aW5nIHRhcmdldCEiKTsKICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgICAvLyBTZXR1cDogQWN0aXZlIFBsYXllciBjZW50ZXIuIDEgVGVhbW1hdGUgcnVubmluZyBwYXR0ZXJucy4KICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQoeCA9PiB4ICE9PSBwICYmIHgucm9sZSAhPT0gJ0dMJyk7CiAgICAgICAgICAgICAKICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS50YXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICAgICAKICAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAxMCk7CiAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgfQogICAgICAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOwogICAgICAgICAgICAgICAgIHRhcmdldC5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgIHRhcmdldC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgfQogICAgICAgICAgICAgCiAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KCiAgICAgICAgX2xvb3BQYXNzaW5nKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmRyaWxsU3RhdGUudGFyZ2V0OwogICAgICAgICAgICBpZiAoIXRhcmdldCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTW92ZSB0YXJnZXQgaW4gY2lyY2xlCiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS50aW1lciArPSBkdDsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gucG9zaXRpb24ueCA9IE1hdGguc2luKHRoaXMuZHJpbGxTdGF0ZS50aW1lcikgKiAxMDsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gucG9zaXRpb24ueiA9IC0xMCArIE1hdGguY29zKHRoaXMuZHJpbGxTdGF0ZS50aW1lciAqIDAuNSkgKiA1OwogICAgICAgICAgICB0YXJnZXQubWVzaC5sb29rQXQoMCwwLDEwKTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBSaW5nCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi5jb3B5KHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi55ID0gMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweDAwZmZmZik7IC8vIEN5YW4KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRhcmdldC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5zY29yZSsrOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIk5JQ0UgUEFTUyEiLCB0YXJnZXQubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVzZXQKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRhcmdldC5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NldHVwUGFzc2luZygpOyAvLyBSZS1zZXR1cCB0byByZXNldCBwb3NpdGlvbnMKICAgICAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgX3NldHVwRGVmZW5zZSgpIHsKCiAgICAgICAgICAgIHRoaXMuX3NldEluc3RydWN0aW9uKCJUYWNrbGUgdGhlIGF0dGFja2VyISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBhdHRhY2tlciA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuYXR0YWNrZXIgPSBhdHRhY2tlcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDIwKTsgLy8gTmVhciBvd24gZ29hbAogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhdHRhY2tlcikgewogICAgICAgICAgICAgICAgYXR0YWNrZXIubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGF0dGFja2VyLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC0xMCk7CiAgICAgICAgICAgICAgICBhdHRhY2tlci52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgLy8gR2l2ZSBiYWxsIHRvIGF0dGFja2VyCiAgICAgICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICBiLnJlc2V0KCk7CiAgICAgICAgICAgICAgICBiLmdyYWIoYXR0YWNrZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9sb29wRGVmZW5zZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgYXR0YWNrZXIgPSB0aGlzLmRyaWxsU3RhdGUuYXR0YWNrZXI7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWF0dGFja2VyIHx8ICFwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBdHRhY2tlciBydW5zIHRvIGdvYWwgKCtaKQogICAgICAgICAgICBjb25zdCBnb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMjgpOwogICAgICAgICAgICBjb25zdCBkaXIgPSBnb2FsUG9zLmNsb25lKCkuc3ViKGF0dGFja2VyLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFJpbmcgb24gQXR0YWNrZXIKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLmNvcHkoYXR0YWNrZXIubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZjAwMDApOyAvLyBSZWQgZm9yIGVuZW15CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhdHRhY2tlci5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBhdHRhY2tlci5zZXRJbnB1dChkaXIueCwgZGlyLnopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQmFsbCBsb3N0IChUYWNrbGVkKQogICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCB8fCB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTVE9QUEVEISIsIHAubWVzaC5wb3NpdGlvbiwgImJsb2NrIik7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cERlZmVuc2UoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZhaWwgY29uZGl0aW9uOiBBdHRhY2tlciBzY29yZXMgKEdhbWVNYW5hZ2VyIGhhbmRsZXMgZ29hbCBjaGVjaykKICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc3RhdGUgPT09ICdnb2FsJykgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhdGUgPSAnYWN0aXZlJzsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJGQUlMRUQiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBEZWZlbnNlKCksIDEwMDApOwogICAgICAgICAgICB9Cn0KCiAgICAgICAgX3NldHVwQ3VydmUoKSB7CnRoaXMuX3NldEluc3RydWN0aW9uKCJTd2lwZSBhIENVUlZFICggKSApIHRvIGJ5cGFzcyB0aGUgZGVmZW5kZXIhIik7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFNob3cgZ2VzdHVyZSBoaW50CiAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDbGVhciBhbnkgZXhpc3RpbmcgdGltZW91dAogICAgICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCkgY2xlYXJUaW1lb3V0KHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEF1dG8gaGlkZSBhZnRlciA0cwogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAvLyBVc2UgYSBkZWZlbmRlciBkdW1teQogICAgICAgICAgICBjb25zdCBkZWZlbmRlciA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ0xEJyk7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5kZWZlbmRlciA9IGRlZmVuZGVyOwoKICAgICAgICAgICAgaWYgKHApIHsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMTUpOwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtMjgpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGVmZW5kZXIpIHsKICAgICAgICAgICAgICAgIGRlZmVuZGVyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBkZWZlbmRlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCA1KTsgLy8gMTBtIGluIGZyb250IG9mIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIubWVzaC5sb29rQXQoMCwgMCwgMTUpOyAvLyBGYWNlIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEJvb3N0IEJMIHRvIGVuc3VyZSBzdHJhaWdodCBzaG90cyBhcmUgYmxvY2tlZAogICAgICAgICAgICAgICAgZGVmZW5kZXIuc3RhdHMuQkwgPSA5OTsgCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhleSBkb24ndCBtb3ZlCiAgICAgICAgICAgICAgICBkZWZlbmRlci5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUYXJnZXQgUmluZyBiZWhpbmQgZGVmZW5kZXIKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnNldCgwLCAwLjEsIC0xMCk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4MDBmZmZmKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgpfbG9vcEN1cnZlKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IGRlZmVuZGVyID0gdGhpcy5kcmlsbFN0YXRlLmRlZmVuZGVyOwoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgYmFsbCBwYXNzZWQgdGhlIGRlZmVuZGVyIGxpbmUgKHogPCAwKQogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAwKSB7CiAgICAgICAgICAgICAgICAvLyBTdWNjZXNzIHpvbmUgKFdpdGhpbiA1bSB3aWR0aCkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhiYWxsLm1lc2gucG9zaXRpb24ueCkgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRUQhIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBDdXJ2ZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGJsb2NrZWQgKEJhbGwgc3RvcHBlZCBvciBwb3dlciBkcmFpbmVkIHNpZ25pZmljYW50bHkgbmVhciBkZWZlbmRlcikKICAgICAgICAgICAgaWYgKGRlZmVuZGVyICYmIGJhbGwubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGRlZmVuZGVyLm1lc2gucG9zaXRpb24pIDwgMy4wKSB7CiAgICAgICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA8PSAwIHx8IGJhbGwudmVsb2NpdHkubGVuZ3RoKCkgPCAxLjApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0tFRCIsIGRlZmVuZGVyLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZS1zaG93IGhpbnQgb24gZmFpbHVyZSB0byBndWlkZSBwbGF5ZXIKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTWlzc2VkIC8gT3V0IG9mIGJvdW5kcwogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAtMTUpIHsKICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiTUlTU0VEIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgLy8gUmUtc2hvdyBoaW50IG9uIG1pc3MKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX3NldHVwUmFwaWRGaXJlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVU5MSU1JVEVEIEFNTU8hIFNwYW0gdGhyb3dzISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBGaW5kIFRpZHVzIG9yIGRlZmF1bHQgdG8gTEYKICAgICAgICAgICAgbGV0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQoeCA9PiB4LmNoYXJhY3Rlck5hbWUgJiYgeC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKTsKICAgICAgICAgICAgaWYgKCFwKSBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnTEYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldCBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5zZXRBY3RpdmVQbGF5ZXIocCk7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtMjgpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBCb29zdCBzdGF0cyBmb3IgZnVuCiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlBBID0gOTk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEhJREUgRVZFUllPTkUgKEFsb25lIE1vZGUpCiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChtYXRlID0+IHsKICAgICAgICAgICAgICAgIGlmIChtYXRlICE9PSBwICYmIG1hdGUubWVzaCkgbWF0ZS5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChvcHAgPT4gewogICAgICAgICAgICAgICAgaWYgKG9wcC5tZXNoKSBvcHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgpfbG9vcFJhcGlkRmlyZShkdCkgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CgogICAgICAgICAgICBpZiAoIXAgfHwgIWIpIHJldHVybjsKCiAgICAgICAgICAgIC8vIERldGVjdCBpZiBiYWxsIHdhcyBqdXN0IHRocm93biAoaXMgZnJlZSkKICAgICAgICAgICAgaWYgKGIuc3RhdGUgPT09ICdmcmVlJykgewogICAgICAgICAgICAgICAgLy8gMS4gU3Bhd24gR2hvc3QgQmFsbCAoVmlzdWFsIENvcHkpCiAgICAgICAgICAgICAgICAvLyBDbG9uZSB0aGUgbWVzaCBoaWVyYXJjaHkgdG8gcHJlc2VydmUgRGVmb3JtL1NwaW4gbm9kZXMKICAgICAgICAgICAgICAgIGNvbnN0IGdob3N0TWVzaCA9IGIubWVzaC5jbG9uZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdmlzaWJpbGl0eSBhbmQgYWRkIHRvIHNjZW5lCiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKGdob3N0TWVzaCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlLWJpbmQgaW50ZXJuYWwgcmVmZXJlbmNlcyBmb3IgdGhlIHBoeXNpY3MgZW5naW5lCiAgICAgICAgICAgICAgICAvLyBIaWVyYXJjaHk6IE1lc2ggLT4gRGVmb3JtTm9kZSAtPiBTcGluTm9kZQogICAgICAgICAgICAgICAgY29uc3QgZGVmb3JtTm9kZSA9IGdob3N0TWVzaC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5Ob2RlID0gZGVmb3JtTm9kZSA/IGRlZm9ybU5vZGUuY2hpbGRyZW5bMF0gOiBudWxsOwoKICAgICAgICAgICAgICAgIC8vIERldGVybWluZSBUcmFpbCBDb2xvciBiYXNlZCBvbiBUZWNoCiAgICAgICAgICAgICAgICBsZXQgdHJhaWxDb2xvciA9IDB4ZmY0NDAwOyAvLyBEZWZhdWx0IFNIIChPcmFuZ2UpCiAgICAgICAgICAgICAgICBpZiAoYi50ZWNobmlxdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ3Zlbm9tJykgdHJhaWxDb2xvciA9IDB4YWEwMGZmOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICd3aXRoZXInKSB0cmFpbENvbG9yID0gMHg4ODg4ODg7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ25hcCcpIHRyYWlsQ29sb3IgPSAweDAwMDA4ODsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnc3BoZXJlJykgdHJhaWxDb2xvciA9IDB4MDBmZmZmOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICdqZWNodCcpIHRyYWlsQ29sb3IgPSAweGZmMDAwMDsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnaW52aXNpYmxlJykgdHJhaWxDb2xvciA9IDB4NDQ0NDQ0OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChiLnBvd2VyVHlwZSA9PT0gJ1BBJykgewogICAgICAgICAgICAgICAgICAgIHRyYWlsQ29sb3IgPSAweDAwYWFmZjsgLy8gUGFzcyAoQmx1ZSkKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDcmVhdGUgVHJhaWwKICAgICAgICAgICAgICAgIGNvbnN0IHRyYWlsID0gbmV3IHdpbmRvdy5mbHV4LlRyYWlsUmVuZGVyZXIodGhpcy5nYW1lLnNjZW5lKTsKICAgICAgICAgICAgICAgIHRyYWlsLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0cmFpbC5zZXRDb2xvcih0cmFpbENvbG9yKTsKICAgICAgICAgICAgICAgIHRyYWlsLnJlc2V0KGdob3N0TWVzaC5wb3NpdGlvbik7CgogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIGEgIk1vY2siIEJhbGwgb2JqZWN0IHRoYXQgc2F0aXNmaWVzIEJhbGwuanMgcGh5c2ljcyByZXF1aXJlbWVudHMKICAgICAgICAgICAgICAgIGNvbnN0IGdob3N0QmFsbCA9IHsKICAgICAgICAgICAgICAgICAgICBtZXNoOiBnaG9zdE1lc2gsCiAgICAgICAgICAgICAgICAgICAgZGVmb3JtTm9kZTogZGVmb3JtTm9kZSwKICAgICAgICAgICAgICAgICAgICBzcGluTm9kZTogc3Bpbk5vZGUsCiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IGIudmVsb2NpdHkuY2xvbmUoKSwKICAgICAgICAgICAgICAgICAgICBhbmd1bGFyVmVsb2NpdHk6IGIuYW5ndWxhclZlbG9jaXR5ID8gYi5hbmd1bGFyVmVsb2NpdHkuY2xvbmUoKSA6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgYWNjdW11bGF0ZWRSb3RhdGlvbjogYi5hY2N1bXVsYXRlZFJvdGF0aW9uID8gYi5hY2N1bXVsYXRlZFJvdGF0aW9uLmNsb25lKCkgOiBuZXcgVEhSRUUuUXVhdGVybmlvbigpLAogICAgICAgICAgICAgICAgICAgIHN0YXRlOiAnZnJlZScsCiAgICAgICAgICAgICAgICAgICAgcG93ZXI6IGIucG93ZXIsCiAgICAgICAgICAgICAgICAgICAgcG93ZXJUeXBlOiBiLnBvd2VyVHlwZSwKICAgICAgICAgICAgICAgICAgICB0ZWNobmlxdWU6IGIudGVjaG5pcXVlLAogICAgICAgICAgICAgICAgICAgIGlzSW52aXNpYmxlOiBiLmlzSW52aXNpYmxlLAogICAgICAgICAgICAgICAgICAgIGxpZmU6IDUuMCwgLy8gRW5vdWdoIHRpbWUgdG8gcmVhY2ggZ29hbAogICAgICAgICAgICAgICAgICAgIHRyYWlsOiB0cmFpbCwKICAgICAgICAgICAgICAgICAgICBfYnViYmxlVGltZXI6IDAsCiAgICAgICAgICAgICAgICAgICAgX2dob3N0OiB0cnVlLAogICAgICAgICAgICAgICAgICAgIC8vIE1vY2sgbWV0aG9kcwogICAgICAgICAgICAgICAgICAgIHJlc2V0OiAoKSA9PiB7fSwgCiAgICAgICAgICAgICAgICAgICAgZHJvcDogKCkgPT4ge30sCiAgICAgICAgICAgICAgICAgICAgcmV2ZWFsOiAoKSA9PiB7fQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSB2aXNpYmlsaXR5CiAgICAgICAgICAgICAgICBnaG9zdE1lc2gudmlzaWJsZSA9ICFiLmlzSW52aXNpYmxlOwoKICAgICAgICAgICAgICAgIHRoaXMuZ2hvc3RCYWxscy5wdXNoKGdob3N0QmFsbCk7CgovLyAyLiBSZXNldCBSZWFsIEJhbGwgdG8gUGxheWVyIElOU1RBTlRMWQogICAgICAgICAgICAgICAgYi52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZJWDogRm9yY2UgYmFsbCBwb3NpdGlvbiB0byBiZSBleHBsaWNpdGx5IGluIGZyb250IG9mIHRoZSBwbGF5ZXIKICAgICAgICAgICAgICAgIC8vIFRoaXMgcHJldmVudHMgYW55IGxvZ2ljIGZyb20gdGhpbmtpbmcgdGhlIGJhbGwgaXMgYmVoaW5kIGFuZCB0cmlnZ2VyaW5nIGEgdHVybgogICAgICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHAubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIGIubWVzaC5wb3NpdGlvbi5jb3B5KHAubWVzaC5wb3NpdGlvbikuYWRkKGZ3ZC5tdWx0aXBseVNjYWxhcigwLjgpKTsKICAgICAgICAgICAgICAgIGIubWVzaC5wb3NpdGlvbi55ICs9IDEuMDsKCiAgICAgICAgICAgICAgICAvLyBNYW51YWwgQXR0YWNoIChCeXBhc3MgJ2NhdGNoJyBhbmltYXRpb24pCiAgICAgICAgICAgICAgICBiLmhvbGRlciA9IHA7CiAgICAgICAgICAgICAgICBiLnN0YXRlID0gJ2hlbGQnOwogICAgICAgICAgICAgICAgcC5oYXNCYWxsID0gdHJ1ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVzZXQgUGxheWVyIFRocm93IFN0YXRlIHNvIHRoZXkgY2FuIGZpcmUgYWdhaW4gaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIHAuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcC5jYXRjaENvb2xkb3duID0gMDsKCiAgICAgICAgICAgICAgICAvLyBTeW5jIHJvdGF0aW9uIHRvIHByZXZlbnQgc25hcHBpbmcKICAgICAgICAgICAgICAgIGlmIChwLnN5bmNSb3RhdGlvbikgcC5zeW5jUm90YXRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5zdXJlIGluZmluaXRlIHN0YXRzCiAgICAgICAgICAgIHAuY3VycmVudEVOID0gcC5zdGF0cy5FTjsKICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7CiAgICAgICAgfQoKICAgICAgICBfc2hvd1BhbmVsKCkgewogICAgICAgICAgICBpZiAodGhpcy51aSkgdGhpcy51aS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICB9CgogICAgICAgIF9oaWRlUGFuZWwoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnVpKSB0aGlzLnVpLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dSZXN0b3JlQnRuKCkgewogICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2UtcmVzdG9yZS1idG4nKTsKICAgICAgICAgICAgaWYgKGJ0bikgYnRuLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgIH0KCiAgICAgICAgX2hpZGVSZXN0b3JlQnRuKCkgewogICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2UtcmVzdG9yZS1idG4nKTsKICAgICAgICAgICAgaWYgKGJ0bikgYnRuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQogICAgfQp3aW5kb3cuZmx1eC5QcmFjdGljZU1hbmFnZXIgPSBQcmFjdGljZU1hbmFnZXI7Cn0pKCk7","WaterOverlay.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gSGlnaC1RdWFsaXR5IE5vaXNlIFRleHR1cmUgR2VuZXJhdG9yIC0tLQogICAgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBzaXplID0gNTEyOwogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gc2l6ZTsgYy5oZWlnaHQgPSBzaXplOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMwMDAwMDAnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzaXplLCBzaXplKTsKICAgICAgICAKICAgICAgICAvLyBHZW5lcmF0ZSBzZWFtbGVzcyBub2lzZSAoUGVybGluLWlzaCB2aWEgbGF5ZXJlZCByYW5kb20gY2lyY2xlcy9ncmFkaWVudHMpCiAgICAgICAgY29uc3QgZHJhd05vaXNlTGF5ZXIgPSAoc2NhbGUsIGFscGhhKSA9PiB7CiAgICAgICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IGFscGhhOwogICAgICAgICAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ2xpZ2h0ZXInOyAvLyBBZGRpdGl2ZQogICAgICAgICAgICBjb25zdCBjb3VudCA9IDMwMCAqIHNjYWxlOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCByID0gKE1hdGgucmFuZG9tKCkgKiAzMCArIDEwKSAvIHNjYWxlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgsIHksIDAsIHgsIHksIHIpOwogICAgICAgICAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJyM4ODg4ODgnKTsKICAgICAgICAgICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICd0cmFuc3BhcmVudCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyh4LCB5LCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBXcmFwIGFyb3VuZCBmb3Igc2VhbWxlc3MgdGlsaW5nCiAgICAgICAgICAgICAgICBbW3gtc2l6ZSwgeV0sIFt4K3NpemUsIHldLCBbeCwgeS1zaXplXSwgW3gsIHkrc2l6ZV1dLmZvckVhY2gocG9zID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnMiA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChwb3NbMF0sIHBvc1sxXSwgMCwgcG9zWzBdLCBwb3NbMV0sIHIpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgwLCAnIzg4ODg4OCcpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgxLCAndHJhbnNwYXJlbnQnKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzI7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKHBvc1swXSwgcG9zWzFdLCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIAogICAgICAgIGRyYXdOb2lzZUxheWVyKDEuMCwgMC4zKTsKICAgICAgICBkcmF3Tm9pc2VMYXllcigyLjAsIDAuMik7CiAgICAgICAgZHJhd05vaXNlTGF5ZXIoNC4wLCAwLjEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9KSgpOwoKICAgIGNsYXNzIFdhdGVyT3ZlcmxheSB7CiAgICAgICAgY29uc3RydWN0b3IoY2FtZXJhKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVsbHNjcmVlbiBxdWFkCiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMik7CiAgICAgICAgICAgIApjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CgogICAgICAgICAgICBjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHROb2lzZTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CgogICAgICAgICAgICAgICAgLy8gRkZYIFBhbGV0dGUgKEFkZGl0aXZlIEZyaWVuZGx5KQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0RFRVAgPSB2ZWMzKDAuMCwgMC4wMiwgMC4xKTsgICAgIC8vIFN1YnRsZSBEZWVwIEJsdWUgRWRnZQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0dMT1cgPSB2ZWMzKDAuMCwgMC41LCAwLjgpOyAgICAgIC8vIEN5YW4gR2xvdwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1JBWSAgPSB2ZWMzKDAuNCwgMC43LCAxLjApOyAgICAgIC8vIExpZ2h0IFNoYWZ0cwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1BZUkUgPSB2ZWMzKDEuMCwgMC45LCAwLjYpOyAgICAgIC8vIFB5cmVmbHkgR29sZAoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWMyIHV2ID0gdlV2OwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSB1VGltZSAqIDAuMTsKCiAgICAgICAgICAgICAgICAgICAgLy8gMS4gRGlzdG9ydGlvbiAoTG9va3VwIDEpCiAgICAgICAgICAgICAgICAgICAgLy8gTG93IGZyZXF1ZW5jeSBub2lzZSBmb3Igd2FycGluZyBldmVyeXRoaW5nIGVsc2UKICAgICAgICAgICAgICAgICAgICBmbG9hdCB3YXJwID0gdGV4dHVyZTJEKHROb2lzZSwgdXYgKiAwLjQgKyB2ZWMyKHQgKiAwLjA0LCB0ICogMC4wMikpLnI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gQ2F1c3RpY3MgKExvb2t1cCAyKQogICAgICAgICAgICAgICAgICAgIC8vIERvbWFpbiB3YXJwIHRoZSBVVnMgdXNpbmcgdGhlIGZpcnN0IGxvb2t1cCB0byBjcmVhdGUgbGlxdWlkIGZlZWwuCiAgICAgICAgICAgICAgICAgICAgLy8gUmVkdWNlZCB0byBzaW5nbGUgbG9va3VwIHdpdGggaGVhdnkgd2FycGluZyBmb3IgZWZmaWNpZW5jeS4KICAgICAgICAgICAgICAgICAgICB2ZWMyIGNVViA9IHV2ICogMi4wICsgdmVjMih3YXJwICogMC41LCB3YXJwICogMC4yKSAtIHZlYzIodCAqIDAuMDUpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGMgPSB0ZXh0dXJlMkQodE5vaXNlLCBjVVYpLnI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU2hhcnBlbiBjYXVzdGljcyB2aWEgY2hlYXAgbWF0aCAocmVwbGFjZSBwb3cgd2l0aCBtdWxzKQogICAgICAgICAgICAgICAgICAgIGMgPSAoYyAtIDAuNCkgKiAyLjU7IC8vIEluY3JlYXNlIGNvbnRyYXN0CiAgICAgICAgICAgICAgICAgICAgYyA9IG1heCgwLjAsIGMpOwogICAgICAgICAgICAgICAgICAgIGMgPSBjICogYzsgLy8gXjIKICAgICAgICAgICAgICAgICAgICBjID0gYyAqIGM7IC8vIF40CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgY2F1c3RpYyA9IGMgKiAxMi4wOwogICAgICAgICAgICAgICAgICAgIC8vIFRpbnQgYmFzZWQgb24gaW50ZW5zaXR5IChGYWtlIGNocm9tYXRpYyBhYmVycmF0aW9uKQogICAgICAgICAgICAgICAgICAgIHZlYzMgY2F1c3RpY0NvbG9yID0gdmVjMyhjYXVzdGljICogMC44LCBjYXVzdGljLCBjYXVzdGljICogMS4yKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gMy4gUmF5cyAoTG9va3VwIDMpCiAgICAgICAgICAgICAgICAgICAgLy8gVmVydGljYWwgc3RyZXRjaCBmb3IgbGlnaHQgc2hhZnRzCiAgICAgICAgICAgICAgICAgICAgdmVjMiByYXlVViA9IHZlYzIodXYueCArIHdhcnAgKiAwLjEsIHV2LnkgKiAwLjE1IC0gdCAqIDAuMDUpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheXMgPSB0ZXh0dXJlMkQodE5vaXNlLCByYXlVVikucjsKICAgICAgICAgICAgICAgICAgICByYXlzID0gcmF5cyAqIHJheXM7IC8vIF4yCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRmFkZSByYXlzIGF0IHRvcC9ib3R0b20gbGluZWFybHkgKENoZWFwZXIgdGhhbiBzbW9vdGhzdGVwKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheU1hc2sgPSAxLjAgLSBhYnModXYueSAqIDIuMCAtIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgcmF5cyAqPSBtYXgoMC4wLCByYXlNYXNrKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gNC4gUHlyZWZsaWVzIChQcm9jZWR1cmFsIC0gT3B0aW1pemVkKQogICAgICAgICAgICAgICAgICAgIC8vIEdyaWQgYmFzZWQsIGxpbmVhciBtb3Rpb24gaW5zdGVhZCBvZiB0cmlnCiAgICAgICAgICAgICAgICAgICAgdmVjMiBwID0gdXYgKiA1LjA7IC8vIDV4NSBncmlkCiAgICAgICAgICAgICAgICAgICAgdmVjMiBpZCA9IGZsb29yKHApOwogICAgICAgICAgICAgICAgICAgIHZlYzIgc3ViID0gZnJhY3QocCkgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU2ltcGxlIGhhc2gKICAgICAgICAgICAgICAgICAgICBmbG9hdCBuID0gZnJhY3Qoc2luKGRvdChpZCwgdmVjMigxMi45ODk4LCA3OC4yMzMpKSkgKiA0Mzc1OC41NDUzKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMaW5lYXIgbW90aW9uIHdpdGggd3JhcHBpbmcgKENoZWFwZXIgdGhhbiBzaW4vY29zKQogICAgICAgICAgICAgICAgICAgIC8vIFVzZSBuIHRvIHJhbmRvbWl6ZSBzcGVlZCBhbmQgZGlyZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgcHggPSBmcmFjdChuICogMTMuMCArIHQgKiAwLjMpIC0gMC41OwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHB5ID0gZnJhY3QobiAqIDcuMCArIHQgKiAwLjIpIC0gMC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZlYzIgZmx5UG9zID0gdmVjMihweCwgcHkpOwogICAgICAgICAgICAgICAgICAgIC8vIERvdCBwcm9kdWN0IGZvciBkaXN0YW5jZSBzcXVhcmVkCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZDIgPSBkb3Qoc3ViIC0gZmx5UG9zLCBzdWIgLSBmbHlQb3MpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEdsb3cgZmFsbG9mZiAoSW52ZXJzZSBzcXVhcmUgYXBwcm94KQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGZseSA9IDAuMDAwOCAvIChkMiArIDAuMDAwNSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gTWFzazogT25seSBzb21lIGNlbGxzIGhhdmUgZmxpZXMgKDMwJSBjaGFuY2UpCiAgICAgICAgICAgICAgICAgICAgZmx5ICo9IHN0ZXAoMC43LCBuKTsgCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQmxpbmsgKEtlZXAgc2luIGhlcmUgZm9yIHNtb290aCBwdWxzaW5nLCBpdCdzIHBlci1waXhlbCBidXQgbG93IGZyZXEpCiAgICAgICAgICAgICAgICAgICAgZmx5ICo9IDAuNSArIDAuNSAqIHNpbih0ICogNS4wICsgbiAqIDEwLjApOwoKICAgICAgICAgICAgICAgICAgICAvLyBDb21wb3NpdGlvbgogICAgICAgICAgICAgICAgICAgIHZlYzMgZmluYWxDb2wgPSB2ZWMzKDAuMCk7CgogICAgICAgICAgICAgICAgICAgIC8vIFZpZ25ldHRlIChEaXN0YW5jZSBzcXVhcmVkIC0gY2hlYXApCiAgICAgICAgICAgICAgICAgICAgdmVjMiB2ZCA9IHV2IC0gMC41OwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHZTcSA9IGRvdCh2ZCwgdmQpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHZpZyA9IHZTcSAqIDEuMjsgCiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gQ19ERUVQICogdmlnOwoKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBjYXVzdGljQ29sb3IgKiBDX0dMT1cgKiAwLjY7CiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gcmF5cyAqIENfUkFZICogMC4zOwogICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sICs9IGZseSAqIENfUFlSRTsKCiAgICAgICAgICAgICAgICAgICAgLy8gU2NhbmxpbmUgKFNpbXBsZSBzaW5lKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNjYW4gPSBzaW4odXYueSAqIDYwMC4wICsgdVRpbWUgKiA1LjApICogMC4wMzsKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBDX0dMT1cgKiBzY2FuOwoKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGZpbmFsQ29sLCB1T3BhY2l0eSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7Cgp0aGlzLm1hdGVyaWFsID0gbmV3IFRIUkVFLlNoYWRlck1hdGVyaWFsKHsKICAgICAgICAgICAgICAgIHVuaWZvcm1zOiB7CiAgICAgICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgICAgICB1T3BhY2l0eTogeyB2YWx1ZTogMC41IH0sCiAgICAgICAgICAgICAgICAgICAgdE5vaXNlOiB7IHZhbHVlOiB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHZlcnRleFNoYWRlcjogdmVydCwKICAgICAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBmcmFnLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyAvLyBBZGRpdGl2ZSBibGVuZGluZyBwcmV2ZW50cyBkYXJrIG9jY2x1c2lvbgogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMubWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCB0aGlzLm1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy5tZXNoLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5tZXNoLnJlbmRlck9yZGVyID0gOTk5OTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFkZCB0byBjYW1lcmEgc28gaXQgc3RheXMgb24gc2NyZWVuCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmFkZCh0aGlzLm1lc2gpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwudW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIHdpbmRvdy5mbHV4LldhdGVyT3ZlcmxheSA9IFdhdGVyT3ZlcmxheTsKfSkoKTs=","./WaterOverlay.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gSGlnaC1RdWFsaXR5IE5vaXNlIFRleHR1cmUgR2VuZXJhdG9yIC0tLQogICAgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBzaXplID0gNTEyOwogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gc2l6ZTsgYy5oZWlnaHQgPSBzaXplOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMwMDAwMDAnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzaXplLCBzaXplKTsKICAgICAgICAKICAgICAgICAvLyBHZW5lcmF0ZSBzZWFtbGVzcyBub2lzZSAoUGVybGluLWlzaCB2aWEgbGF5ZXJlZCByYW5kb20gY2lyY2xlcy9ncmFkaWVudHMpCiAgICAgICAgY29uc3QgZHJhd05vaXNlTGF5ZXIgPSAoc2NhbGUsIGFscGhhKSA9PiB7CiAgICAgICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IGFscGhhOwogICAgICAgICAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ2xpZ2h0ZXInOyAvLyBBZGRpdGl2ZQogICAgICAgICAgICBjb25zdCBjb3VudCA9IDMwMCAqIHNjYWxlOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCByID0gKE1hdGgucmFuZG9tKCkgKiAzMCArIDEwKSAvIHNjYWxlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgsIHksIDAsIHgsIHksIHIpOwogICAgICAgICAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJyM4ODg4ODgnKTsKICAgICAgICAgICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICd0cmFuc3BhcmVudCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyh4LCB5LCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBXcmFwIGFyb3VuZCBmb3Igc2VhbWxlc3MgdGlsaW5nCiAgICAgICAgICAgICAgICBbW3gtc2l6ZSwgeV0sIFt4K3NpemUsIHldLCBbeCwgeS1zaXplXSwgW3gsIHkrc2l6ZV1dLmZvckVhY2gocG9zID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnMiA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChwb3NbMF0sIHBvc1sxXSwgMCwgcG9zWzBdLCBwb3NbMV0sIHIpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgwLCAnIzg4ODg4OCcpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgxLCAndHJhbnNwYXJlbnQnKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzI7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKHBvc1swXSwgcG9zWzFdLCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIAogICAgICAgIGRyYXdOb2lzZUxheWVyKDEuMCwgMC4zKTsKICAgICAgICBkcmF3Tm9pc2VMYXllcigyLjAsIDAuMik7CiAgICAgICAgZHJhd05vaXNlTGF5ZXIoNC4wLCAwLjEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9KSgpOwoKICAgIGNsYXNzIFdhdGVyT3ZlcmxheSB7CiAgICAgICAgY29uc3RydWN0b3IoY2FtZXJhKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVsbHNjcmVlbiBxdWFkCiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMik7CiAgICAgICAgICAgIApjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CgogICAgICAgICAgICBjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHROb2lzZTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CgogICAgICAgICAgICAgICAgLy8gRkZYIFBhbGV0dGUgKEFkZGl0aXZlIEZyaWVuZGx5KQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0RFRVAgPSB2ZWMzKDAuMCwgMC4wMiwgMC4xKTsgICAgIC8vIFN1YnRsZSBEZWVwIEJsdWUgRWRnZQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0dMT1cgPSB2ZWMzKDAuMCwgMC41LCAwLjgpOyAgICAgIC8vIEN5YW4gR2xvdwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1JBWSAgPSB2ZWMzKDAuNCwgMC43LCAxLjApOyAgICAgIC8vIExpZ2h0IFNoYWZ0cwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1BZUkUgPSB2ZWMzKDEuMCwgMC45LCAwLjYpOyAgICAgIC8vIFB5cmVmbHkgR29sZAoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWMyIHV2ID0gdlV2OwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSB1VGltZSAqIDAuMTsKCiAgICAgICAgICAgICAgICAgICAgLy8gMS4gRGlzdG9ydGlvbiAoTG9va3VwIDEpCiAgICAgICAgICAgICAgICAgICAgLy8gTG93IGZyZXF1ZW5jeSBub2lzZSBmb3Igd2FycGluZyBldmVyeXRoaW5nIGVsc2UKICAgICAgICAgICAgICAgICAgICBmbG9hdCB3YXJwID0gdGV4dHVyZTJEKHROb2lzZSwgdXYgKiAwLjQgKyB2ZWMyKHQgKiAwLjA0LCB0ICogMC4wMikpLnI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gQ2F1c3RpY3MgKExvb2t1cCAyKQogICAgICAgICAgICAgICAgICAgIC8vIERvbWFpbiB3YXJwIHRoZSBVVnMgdXNpbmcgdGhlIGZpcnN0IGxvb2t1cCB0byBjcmVhdGUgbGlxdWlkIGZlZWwuCiAgICAgICAgICAgICAgICAgICAgLy8gUmVkdWNlZCB0byBzaW5nbGUgbG9va3VwIHdpdGggaGVhdnkgd2FycGluZyBmb3IgZWZmaWNpZW5jeS4KICAgICAgICAgICAgICAgICAgICB2ZWMyIGNVViA9IHV2ICogMi4wICsgdmVjMih3YXJwICogMC41LCB3YXJwICogMC4yKSAtIHZlYzIodCAqIDAuMDUpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGMgPSB0ZXh0dXJlMkQodE5vaXNlLCBjVVYpLnI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU2hhcnBlbiBjYXVzdGljcyB2aWEgY2hlYXAgbWF0aCAocmVwbGFjZSBwb3cgd2l0aCBtdWxzKQogICAgICAgICAgICAgICAgICAgIGMgPSAoYyAtIDAuNCkgKiAyLjU7IC8vIEluY3JlYXNlIGNvbnRyYXN0CiAgICAgICAgICAgICAgICAgICAgYyA9IG1heCgwLjAsIGMpOwogICAgICAgICAgICAgICAgICAgIGMgPSBjICogYzsgLy8gXjIKICAgICAgICAgICAgICAgICAgICBjID0gYyAqIGM7IC8vIF40CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgY2F1c3RpYyA9IGMgKiAxMi4wOwogICAgICAgICAgICAgICAgICAgIC8vIFRpbnQgYmFzZWQgb24gaW50ZW5zaXR5IChGYWtlIGNocm9tYXRpYyBhYmVycmF0aW9uKQogICAgICAgICAgICAgICAgICAgIHZlYzMgY2F1c3RpY0NvbG9yID0gdmVjMyhjYXVzdGljICogMC44LCBjYXVzdGljLCBjYXVzdGljICogMS4yKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gMy4gUmF5cyAoTG9va3VwIDMpCiAgICAgICAgICAgICAgICAgICAgLy8gVmVydGljYWwgc3RyZXRjaCBmb3IgbGlnaHQgc2hhZnRzCiAgICAgICAgICAgICAgICAgICAgdmVjMiByYXlVViA9IHZlYzIodXYueCArIHdhcnAgKiAwLjEsIHV2LnkgKiAwLjE1IC0gdCAqIDAuMDUpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheXMgPSB0ZXh0dXJlMkQodE5vaXNlLCByYXlVVikucjsKICAgICAgICAgICAgICAgICAgICByYXlzID0gcmF5cyAqIHJheXM7IC8vIF4yCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRmFkZSByYXlzIGF0IHRvcC9ib3R0b20gbGluZWFybHkgKENoZWFwZXIgdGhhbiBzbW9vdGhzdGVwKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheU1hc2sgPSAxLjAgLSBhYnModXYueSAqIDIuMCAtIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgcmF5cyAqPSBtYXgoMC4wLCByYXlNYXNrKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gNC4gUHlyZWZsaWVzIChQcm9jZWR1cmFsIC0gT3B0aW1pemVkKQogICAgICAgICAgICAgICAgICAgIC8vIEdyaWQgYmFzZWQsIGxpbmVhciBtb3Rpb24gaW5zdGVhZCBvZiB0cmlnCiAgICAgICAgICAgICAgICAgICAgdmVjMiBwID0gdXYgKiA1LjA7IC8vIDV4NSBncmlkCiAgICAgICAgICAgICAgICAgICAgdmVjMiBpZCA9IGZsb29yKHApOwogICAgICAgICAgICAgICAgICAgIHZlYzIgc3ViID0gZnJhY3QocCkgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU2ltcGxlIGhhc2gKICAgICAgICAgICAgICAgICAgICBmbG9hdCBuID0gZnJhY3Qoc2luKGRvdChpZCwgdmVjMigxMi45ODk4LCA3OC4yMzMpKSkgKiA0Mzc1OC41NDUzKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMaW5lYXIgbW90aW9uIHdpdGggd3JhcHBpbmcgKENoZWFwZXIgdGhhbiBzaW4vY29zKQogICAgICAgICAgICAgICAgICAgIC8vIFVzZSBuIHRvIHJhbmRvbWl6ZSBzcGVlZCBhbmQgZGlyZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgcHggPSBmcmFjdChuICogMTMuMCArIHQgKiAwLjMpIC0gMC41OwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHB5ID0gZnJhY3QobiAqIDcuMCArIHQgKiAwLjIpIC0gMC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZlYzIgZmx5UG9zID0gdmVjMihweCwgcHkpOwogICAgICAgICAgICAgICAgICAgIC8vIERvdCBwcm9kdWN0IGZvciBkaXN0YW5jZSBzcXVhcmVkCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZDIgPSBkb3Qoc3ViIC0gZmx5UG9zLCBzdWIgLSBmbHlQb3MpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEdsb3cgZmFsbG9mZiAoSW52ZXJzZSBzcXVhcmUgYXBwcm94KQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGZseSA9IDAuMDAwOCAvIChkMiArIDAuMDAwNSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gTWFzazogT25seSBzb21lIGNlbGxzIGhhdmUgZmxpZXMgKDMwJSBjaGFuY2UpCiAgICAgICAgICAgICAgICAgICAgZmx5ICo9IHN0ZXAoMC43LCBuKTsgCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQmxpbmsgKEtlZXAgc2luIGhlcmUgZm9yIHNtb290aCBwdWxzaW5nLCBpdCdzIHBlci1waXhlbCBidXQgbG93IGZyZXEpCiAgICAgICAgICAgICAgICAgICAgZmx5ICo9IDAuNSArIDAuNSAqIHNpbih0ICogNS4wICsgbiAqIDEwLjApOwoKICAgICAgICAgICAgICAgICAgICAvLyBDb21wb3NpdGlvbgogICAgICAgICAgICAgICAgICAgIHZlYzMgZmluYWxDb2wgPSB2ZWMzKDAuMCk7CgogICAgICAgICAgICAgICAgICAgIC8vIFZpZ25ldHRlIChEaXN0YW5jZSBzcXVhcmVkIC0gY2hlYXApCiAgICAgICAgICAgICAgICAgICAgdmVjMiB2ZCA9IHV2IC0gMC41OwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHZTcSA9IGRvdCh2ZCwgdmQpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHZpZyA9IHZTcSAqIDEuMjsgCiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gQ19ERUVQICogdmlnOwoKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBjYXVzdGljQ29sb3IgKiBDX0dMT1cgKiAwLjY7CiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gcmF5cyAqIENfUkFZICogMC4zOwogICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sICs9IGZseSAqIENfUFlSRTsKCiAgICAgICAgICAgICAgICAgICAgLy8gU2NhbmxpbmUgKFNpbXBsZSBzaW5lKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNjYW4gPSBzaW4odXYueSAqIDYwMC4wICsgdVRpbWUgKiA1LjApICogMC4wMzsKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBDX0dMT1cgKiBzY2FuOwoKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGZpbmFsQ29sLCB1T3BhY2l0eSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7Cgp0aGlzLm1hdGVyaWFsID0gbmV3IFRIUkVFLlNoYWRlck1hdGVyaWFsKHsKICAgICAgICAgICAgICAgIHVuaWZvcm1zOiB7CiAgICAgICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgICAgICB1T3BhY2l0eTogeyB2YWx1ZTogMC41IH0sCiAgICAgICAgICAgICAgICAgICAgdE5vaXNlOiB7IHZhbHVlOiB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHZlcnRleFNoYWRlcjogdmVydCwKICAgICAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBmcmFnLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyAvLyBBZGRpdGl2ZSBibGVuZGluZyBwcmV2ZW50cyBkYXJrIG9jY2x1c2lvbgogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMubWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCB0aGlzLm1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy5tZXNoLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5tZXNoLnJlbmRlck9yZGVyID0gOTk5OTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFkZCB0byBjYW1lcmEgc28gaXQgc3RheXMgb24gc2NyZWVuCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmFkZCh0aGlzLm1lc2gpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwudW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIHdpbmRvdy5mbHV4LldhdGVyT3ZlcmxheSA9IFdhdGVyT3ZlcmxheTsKfSkoKTs=","/WaterOverlay.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gSGlnaC1RdWFsaXR5IE5vaXNlIFRleHR1cmUgR2VuZXJhdG9yIC0tLQogICAgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBzaXplID0gNTEyOwogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gc2l6ZTsgYy5oZWlnaHQgPSBzaXplOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMwMDAwMDAnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzaXplLCBzaXplKTsKICAgICAgICAKICAgICAgICAvLyBHZW5lcmF0ZSBzZWFtbGVzcyBub2lzZSAoUGVybGluLWlzaCB2aWEgbGF5ZXJlZCByYW5kb20gY2lyY2xlcy9ncmFkaWVudHMpCiAgICAgICAgY29uc3QgZHJhd05vaXNlTGF5ZXIgPSAoc2NhbGUsIGFscGhhKSA9PiB7CiAgICAgICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IGFscGhhOwogICAgICAgICAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ2xpZ2h0ZXInOyAvLyBBZGRpdGl2ZQogICAgICAgICAgICBjb25zdCBjb3VudCA9IDMwMCAqIHNjYWxlOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCByID0gKE1hdGgucmFuZG9tKCkgKiAzMCArIDEwKSAvIHNjYWxlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgsIHksIDAsIHgsIHksIHIpOwogICAgICAgICAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJyM4ODg4ODgnKTsKICAgICAgICAgICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICd0cmFuc3BhcmVudCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyh4LCB5LCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBXcmFwIGFyb3VuZCBmb3Igc2VhbWxlc3MgdGlsaW5nCiAgICAgICAgICAgICAgICBbW3gtc2l6ZSwgeV0sIFt4K3NpemUsIHldLCBbeCwgeS1zaXplXSwgW3gsIHkrc2l6ZV1dLmZvckVhY2gocG9zID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnMiA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChwb3NbMF0sIHBvc1sxXSwgMCwgcG9zWzBdLCBwb3NbMV0sIHIpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgwLCAnIzg4ODg4OCcpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgxLCAndHJhbnNwYXJlbnQnKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzI7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKHBvc1swXSwgcG9zWzFdLCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIAogICAgICAgIGRyYXdOb2lzZUxheWVyKDEuMCwgMC4zKTsKICAgICAgICBkcmF3Tm9pc2VMYXllcigyLjAsIDAuMik7CiAgICAgICAgZHJhd05vaXNlTGF5ZXIoNC4wLCAwLjEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9KSgpOwoKICAgIGNsYXNzIFdhdGVyT3ZlcmxheSB7CiAgICAgICAgY29uc3RydWN0b3IoY2FtZXJhKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVsbHNjcmVlbiBxdWFkCiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMik7CiAgICAgICAgICAgIApjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CgogICAgICAgICAgICBjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHROb2lzZTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CgogICAgICAgICAgICAgICAgLy8gRkZYIFBhbGV0dGUgKEFkZGl0aXZlIEZyaWVuZGx5KQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0RFRVAgPSB2ZWMzKDAuMCwgMC4wMiwgMC4xKTsgICAgIC8vIFN1YnRsZSBEZWVwIEJsdWUgRWRnZQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0dMT1cgPSB2ZWMzKDAuMCwgMC41LCAwLjgpOyAgICAgIC8vIEN5YW4gR2xvdwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1JBWSAgPSB2ZWMzKDAuNCwgMC43LCAxLjApOyAgICAgIC8vIExpZ2h0IFNoYWZ0cwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1BZUkUgPSB2ZWMzKDEuMCwgMC45LCAwLjYpOyAgICAgIC8vIFB5cmVmbHkgR29sZAoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWMyIHV2ID0gdlV2OwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSB1VGltZSAqIDAuMTsKCiAgICAgICAgICAgICAgICAgICAgLy8gMS4gRGlzdG9ydGlvbiAoTG9va3VwIDEpCiAgICAgICAgICAgICAgICAgICAgLy8gTG93IGZyZXF1ZW5jeSBub2lzZSBmb3Igd2FycGluZyBldmVyeXRoaW5nIGVsc2UKICAgICAgICAgICAgICAgICAgICBmbG9hdCB3YXJwID0gdGV4dHVyZTJEKHROb2lzZSwgdXYgKiAwLjQgKyB2ZWMyKHQgKiAwLjA0LCB0ICogMC4wMikpLnI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gQ2F1c3RpY3MgKExvb2t1cCAyKQogICAgICAgICAgICAgICAgICAgIC8vIERvbWFpbiB3YXJwIHRoZSBVVnMgdXNpbmcgdGhlIGZpcnN0IGxvb2t1cCB0byBjcmVhdGUgbGlxdWlkIGZlZWwuCiAgICAgICAgICAgICAgICAgICAgLy8gUmVkdWNlZCB0byBzaW5nbGUgbG9va3VwIHdpdGggaGVhdnkgd2FycGluZyBmb3IgZWZmaWNpZW5jeS4KICAgICAgICAgICAgICAgICAgICB2ZWMyIGNVViA9IHV2ICogMi4wICsgdmVjMih3YXJwICogMC41LCB3YXJwICogMC4yKSAtIHZlYzIodCAqIDAuMDUpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGMgPSB0ZXh0dXJlMkQodE5vaXNlLCBjVVYpLnI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU2hhcnBlbiBjYXVzdGljcyB2aWEgY2hlYXAgbWF0aCAocmVwbGFjZSBwb3cgd2l0aCBtdWxzKQogICAgICAgICAgICAgICAgICAgIGMgPSAoYyAtIDAuNCkgKiAyLjU7IC8vIEluY3JlYXNlIGNvbnRyYXN0CiAgICAgICAgICAgICAgICAgICAgYyA9IG1heCgwLjAsIGMpOwogICAgICAgICAgICAgICAgICAgIGMgPSBjICogYzsgLy8gXjIKICAgICAgICAgICAgICAgICAgICBjID0gYyAqIGM7IC8vIF40CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgY2F1c3RpYyA9IGMgKiAxMi4wOwogICAgICAgICAgICAgICAgICAgIC8vIFRpbnQgYmFzZWQgb24gaW50ZW5zaXR5IChGYWtlIGNocm9tYXRpYyBhYmVycmF0aW9uKQogICAgICAgICAgICAgICAgICAgIHZlYzMgY2F1c3RpY0NvbG9yID0gdmVjMyhjYXVzdGljICogMC44LCBjYXVzdGljLCBjYXVzdGljICogMS4yKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gMy4gUmF5cyAoTG9va3VwIDMpCiAgICAgICAgICAgICAgICAgICAgLy8gVmVydGljYWwgc3RyZXRjaCBmb3IgbGlnaHQgc2hhZnRzCiAgICAgICAgICAgICAgICAgICAgdmVjMiByYXlVViA9IHZlYzIodXYueCArIHdhcnAgKiAwLjEsIHV2LnkgKiAwLjE1IC0gdCAqIDAuMDUpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheXMgPSB0ZXh0dXJlMkQodE5vaXNlLCByYXlVVikucjsKICAgICAgICAgICAgICAgICAgICByYXlzID0gcmF5cyAqIHJheXM7IC8vIF4yCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRmFkZSByYXlzIGF0IHRvcC9ib3R0b20gbGluZWFybHkgKENoZWFwZXIgdGhhbiBzbW9vdGhzdGVwKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheU1hc2sgPSAxLjAgLSBhYnModXYueSAqIDIuMCAtIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgcmF5cyAqPSBtYXgoMC4wLCByYXlNYXNrKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gNC4gUHlyZWZsaWVzIChQcm9jZWR1cmFsIC0gT3B0aW1pemVkKQogICAgICAgICAgICAgICAgICAgIC8vIEdyaWQgYmFzZWQsIGxpbmVhciBtb3Rpb24gaW5zdGVhZCBvZiB0cmlnCiAgICAgICAgICAgICAgICAgICAgdmVjMiBwID0gdXYgKiA1LjA7IC8vIDV4NSBncmlkCiAgICAgICAgICAgICAgICAgICAgdmVjMiBpZCA9IGZsb29yKHApOwogICAgICAgICAgICAgICAgICAgIHZlYzIgc3ViID0gZnJhY3QocCkgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU2ltcGxlIGhhc2gKICAgICAgICAgICAgICAgICAgICBmbG9hdCBuID0gZnJhY3Qoc2luKGRvdChpZCwgdmVjMigxMi45ODk4LCA3OC4yMzMpKSkgKiA0Mzc1OC41NDUzKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMaW5lYXIgbW90aW9uIHdpdGggd3JhcHBpbmcgKENoZWFwZXIgdGhhbiBzaW4vY29zKQogICAgICAgICAgICAgICAgICAgIC8vIFVzZSBuIHRvIHJhbmRvbWl6ZSBzcGVlZCBhbmQgZGlyZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgcHggPSBmcmFjdChuICogMTMuMCArIHQgKiAwLjMpIC0gMC41OwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHB5ID0gZnJhY3QobiAqIDcuMCArIHQgKiAwLjIpIC0gMC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZlYzIgZmx5UG9zID0gdmVjMihweCwgcHkpOwogICAgICAgICAgICAgICAgICAgIC8vIERvdCBwcm9kdWN0IGZvciBkaXN0YW5jZSBzcXVhcmVkCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZDIgPSBkb3Qoc3ViIC0gZmx5UG9zLCBzdWIgLSBmbHlQb3MpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEdsb3cgZmFsbG9mZiAoSW52ZXJzZSBzcXVhcmUgYXBwcm94KQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGZseSA9IDAuMDAwOCAvIChkMiArIDAuMDAwNSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gTWFzazogT25seSBzb21lIGNlbGxzIGhhdmUgZmxpZXMgKDMwJSBjaGFuY2UpCiAgICAgICAgICAgICAgICAgICAgZmx5ICo9IHN0ZXAoMC43LCBuKTsgCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQmxpbmsgKEtlZXAgc2luIGhlcmUgZm9yIHNtb290aCBwdWxzaW5nLCBpdCdzIHBlci1waXhlbCBidXQgbG93IGZyZXEpCiAgICAgICAgICAgICAgICAgICAgZmx5ICo9IDAuNSArIDAuNSAqIHNpbih0ICogNS4wICsgbiAqIDEwLjApOwoKICAgICAgICAgICAgICAgICAgICAvLyBDb21wb3NpdGlvbgogICAgICAgICAgICAgICAgICAgIHZlYzMgZmluYWxDb2wgPSB2ZWMzKDAuMCk7CgogICAgICAgICAgICAgICAgICAgIC8vIFZpZ25ldHRlIChEaXN0YW5jZSBzcXVhcmVkIC0gY2hlYXApCiAgICAgICAgICAgICAgICAgICAgdmVjMiB2ZCA9IHV2IC0gMC41OwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHZTcSA9IGRvdCh2ZCwgdmQpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHZpZyA9IHZTcSAqIDEuMjsgCiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gQ19ERUVQICogdmlnOwoKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBjYXVzdGljQ29sb3IgKiBDX0dMT1cgKiAwLjY7CiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gcmF5cyAqIENfUkFZICogMC4zOwogICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sICs9IGZseSAqIENfUFlSRTsKCiAgICAgICAgICAgICAgICAgICAgLy8gU2NhbmxpbmUgKFNpbXBsZSBzaW5lKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNjYW4gPSBzaW4odXYueSAqIDYwMC4wICsgdVRpbWUgKiA1LjApICogMC4wMzsKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBDX0dMT1cgKiBzY2FuOwoKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGZpbmFsQ29sLCB1T3BhY2l0eSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7Cgp0aGlzLm1hdGVyaWFsID0gbmV3IFRIUkVFLlNoYWRlck1hdGVyaWFsKHsKICAgICAgICAgICAgICAgIHVuaWZvcm1zOiB7CiAgICAgICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgICAgICB1T3BhY2l0eTogeyB2YWx1ZTogMC41IH0sCiAgICAgICAgICAgICAgICAgICAgdE5vaXNlOiB7IHZhbHVlOiB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHZlcnRleFNoYWRlcjogdmVydCwKICAgICAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBmcmFnLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyAvLyBBZGRpdGl2ZSBibGVuZGluZyBwcmV2ZW50cyBkYXJrIG9jY2x1c2lvbgogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMubWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCB0aGlzLm1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy5tZXNoLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5tZXNoLnJlbmRlck9yZGVyID0gOTk5OTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFkZCB0byBjYW1lcmEgc28gaXQgc3RheXMgb24gc2NyZWVuCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmFkZCh0aGlzLm1lc2gpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwudW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIHdpbmRvdy5mbHV4LldhdGVyT3ZlcmxheSA9IFdhdGVyT3ZlcmxheTsKfSkoKTs=","GlyphManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUSU9OIC0tLQogICAgY29uc3QgX2NyZWF0ZUdseXBoVGV4dHVyZSA9IChjb2xvclN0ciwgdHlwZSkgPT4gewogICAgICAgIGNvbnN0IHNpemUgPSAyNTY7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSBzaXplOyBjLmhlaWdodCA9IHNpemU7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgc2l6ZSwgc2l6ZSk7CiAgICAgICAgCiAgICAgICAgLy8gR2xvdyBzZXR0aW5ncwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gMTU7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gY29sb3JTdHI7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3JTdHI7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGNvbG9yU3RyOwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKCiAgICAgICAgY29uc3QgY3ggPSBzaXplIC8gMjsKICAgICAgICBjb25zdCBjeSA9IHNpemUgLyAyOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ3JpbmcnKSB7CiAgICAgICAgICAgIC8vIE91dGVyIFJpbmcKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDY7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDExMCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBJbm5lciBSaW5nCiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoY3gsIGN5LCA5MCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBSdW5lcwpjdHguZm9udCA9ICcyNHB4IFNwaXJhLCBzYW5zLXNlcmlmJzsKICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTAwOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IGN4ICsgTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjeSArIE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICBjdHgudHJhbnNsYXRlKHgsIHkpOwogICAgICAgICAgICAgICAgY3R4LnJvdGF0ZShhbmdsZSArIE1hdGguUEkvMik7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGEgc2ltcGxlIHJ1bmUtbGlrZSBzaGFwZQogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygtNSwgLTUpOyBjdHgubGluZVRvKDUsIDApOyBjdHgubGluZVRvKC01LCA1KTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdydW5lJykgewogICAgICAgICAgICAvLyBDZW50cmFsIENvbXBsZXggUnVuZQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgNjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKGN4LCBjeSAtIDYwKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCwgY3kgKyA2MCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3ggLSA2MCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgNjAsIGN5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9OwoKICAgIGNvbnN0IF90ZWNoVGV4dHVyZSA9IF9jcmVhdGVHbHlwaFRleHR1cmUoJyMwMGZmZmYnLCAncmluZycpOyAvLyBDeWFuIFJpbmcKICAgIGNvbnN0IF9zdGF0dXNUZXh0dXJlID0gX2NyZWF0ZUdseXBoVGV4dHVyZSgnI2ZmMDBmZicsICdydW5lJyk7IC8vIE1hZ2VudGEgUnVuZQogICAgY29uc3QgX2NoYXJnZVRleHR1cmUgPSBfY3JlYXRlR2x5cGhUZXh0dXJlKCcjZmZmZjAwJywgJ3JpbmcnKTsgLy8gR29sZCBSaW5nCgogICAgY2xhc3MgR2x5cGhNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZ2x5cGhzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNYXRlcmlhbHMKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbHMgPSB7CiAgICAgICAgICAgICAgICB0ZWNoOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF90ZWNoVGV4dHVyZSwgCiAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBzdGF0dXM6IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgICAgIG1hcDogX3N0YXR1c1RleHR1cmUsIAogICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmZmZmYKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgY2hhcmdlOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF9jaGFyZ2VUZXh0dXJlLCAKICAgICAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgCiAgICAgICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUG9vbAogICAgICAgICAgICB0aGlzLnBvb2wgPSBbXTsKICAgICAgICAgICAgdGhpcy5wb29sU2l6ZSA9IDMwOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLCAxKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgdGhpcy5tYXRlcmlhbHMudGVjaCk7CiAgICAgICAgICAgICAgICBtZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1lc2gucmVuZGVyT3JkZXIgPSAyMDAwOyAvLyBEcmF3IG9uIHRvcCBvZiB3YXRlci9hcmVuYQogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQobWVzaCk7CiAgICAgICAgICAgICAgICB0aGlzLnBvb2wucHVzaChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgbWVzaCA9IHRoaXMucG9vbC5maW5kKG0gPT4gIW0udmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghbWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgbWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgbWVzaC5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWxzW3R5cGVdIHx8IHRoaXMubWF0ZXJpYWxzLnRlY2g7CiAgICAgICAgICAgIG1lc2gucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgTWF0ZXJpYWwgT3BhY2l0eQogICAgICAgICAgICBtZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CgogICAgICAgICAgICAvLyBEZWZhdWx0cwogICAgICAgICAgICBjb25zdCBzY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMS4wOwogICAgICAgICAgICBtZXNoLnNjYWxlLnNldChzY2FsZSwgc2NhbGUsIHNjYWxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9yaWVudGF0aW9uCiAgICAgICAgICAgIGlmIChvcHRpb25zLmZhY2VDYW1lcmEpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMub3JpZW50YXRpb24gPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgLy8gRmFjZSBjYW1lcmEgWS1heGlzIHJvdGF0aW9uIG9ubHkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKGNhbVBvcy54IC0gcG9zLngsIGNhbVBvcy56IC0gcG9zLnopOwogICAgICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24ueSA9IGFuZ2xlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCAoR3JvdW5kKQogICAgICAgICAgICAgICAgbWVzaC5yb3RhdGlvbi5zZXQoLU1hdGguUEkgLyAyLCAwLCBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLm9mZnNldFkpIHsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24ueSArPSBvcHRpb25zLm9mZnNldFk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2x5cGhzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogbWVzaCwKICAgICAgICAgICAgICAgIGFnZTogMCwKICAgICAgICAgICAgICAgIGxpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICBtYXhMaWZlOiBvcHRpb25zLmxpZmUgfHwgMS4wLAogICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogb3B0aW9ucy5yb3RhdGlvblNwZWVkIHx8IDEuMCwKICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IG9wdGlvbnMuc2NhbGVTcGVlZCB8fCAwLAogICAgICAgICAgICAgICAgZmFkZTogb3B0aW9ucy5mYWRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmZhZGUgOiB0cnVlLAogICAgICAgICAgICAgICAgZm9sbG93VGFyZ2V0OiBvcHRpb25zLnBhcmVudCB8fCBudWxsLAogICAgICAgICAgICAgICAgb2Zmc2V0WTogb3B0aW9ucy5vZmZzZXRZIHx8IDAKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2x5cGhzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nbHlwaHNbaV07CiAgICAgICAgICAgICAgICBnLmFnZSArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAoZy5hZ2UgPj0gZy5saWZlKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdseXBocy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IGcuYWdlIC8gZy5tYXhMaWZlOwoKICAgICAgICAgICAgICAgIC8vIEZvbGxvdyB0YXJnZXQKICAgICAgICAgICAgICAgIGlmIChnLmZvbGxvd1RhcmdldCAmJiBnLmZvbGxvd1RhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLmNvcHkoZy5mb2xsb3dUYXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnkgKz0gZy5vZmZzZXRZOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGdyb3VuZCBvcmllbnRlZCwga2VlcCBuZWFyIGZsb29yCiAgICAgICAgICAgICAgICAgICAgaWYgKGcubWVzaC5yb3RhdGlvbi54ID09PSAtTWF0aC5QSS8yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBnLm1lc2gucG9zaXRpb24ueSA9IDAuMSArIGcub2Zmc2V0WTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uCiAgICAgICAgICAgICAgICBnLm1lc2gucm90YXRpb24ueiArPSBnLnJvdGF0aW9uU3BlZWQgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGcuc2NhbGVTcGVlZCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBnLm1lc2guc2NhbGUueCArIGcuc2NhbGVTcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgICAgIGcubWVzaC5zY2FsZS5zZXQocywgcywgcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmFkZQogICAgICAgICAgICAgICAgaWYgKGcuZmFkZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBvcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0IDwgMC4xKSBvcGFjaXR5ID0gdCAvIDAuMTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ID4gMC43KSBvcGFjaXR5ID0gMS4wIC0gKCh0IC0gMC43KSAvIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkdseXBoTWFuYWdlciA9IEdseXBoTWFuYWdlcjsKfSkoKTs=","./GlyphManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUSU9OIC0tLQogICAgY29uc3QgX2NyZWF0ZUdseXBoVGV4dHVyZSA9IChjb2xvclN0ciwgdHlwZSkgPT4gewogICAgICAgIGNvbnN0IHNpemUgPSAyNTY7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSBzaXplOyBjLmhlaWdodCA9IHNpemU7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgc2l6ZSwgc2l6ZSk7CiAgICAgICAgCiAgICAgICAgLy8gR2xvdyBzZXR0aW5ncwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gMTU7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gY29sb3JTdHI7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3JTdHI7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGNvbG9yU3RyOwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKCiAgICAgICAgY29uc3QgY3ggPSBzaXplIC8gMjsKICAgICAgICBjb25zdCBjeSA9IHNpemUgLyAyOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ3JpbmcnKSB7CiAgICAgICAgICAgIC8vIE91dGVyIFJpbmcKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDY7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDExMCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBJbm5lciBSaW5nCiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoY3gsIGN5LCA5MCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBSdW5lcwpjdHguZm9udCA9ICcyNHB4IFNwaXJhLCBzYW5zLXNlcmlmJzsKICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTAwOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IGN4ICsgTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjeSArIE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICBjdHgudHJhbnNsYXRlKHgsIHkpOwogICAgICAgICAgICAgICAgY3R4LnJvdGF0ZShhbmdsZSArIE1hdGguUEkvMik7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGEgc2ltcGxlIHJ1bmUtbGlrZSBzaGFwZQogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygtNSwgLTUpOyBjdHgubGluZVRvKDUsIDApOyBjdHgubGluZVRvKC01LCA1KTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdydW5lJykgewogICAgICAgICAgICAvLyBDZW50cmFsIENvbXBsZXggUnVuZQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgNjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKGN4LCBjeSAtIDYwKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCwgY3kgKyA2MCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3ggLSA2MCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgNjAsIGN5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9OwoKICAgIGNvbnN0IF90ZWNoVGV4dHVyZSA9IF9jcmVhdGVHbHlwaFRleHR1cmUoJyMwMGZmZmYnLCAncmluZycpOyAvLyBDeWFuIFJpbmcKICAgIGNvbnN0IF9zdGF0dXNUZXh0dXJlID0gX2NyZWF0ZUdseXBoVGV4dHVyZSgnI2ZmMDBmZicsICdydW5lJyk7IC8vIE1hZ2VudGEgUnVuZQogICAgY29uc3QgX2NoYXJnZVRleHR1cmUgPSBfY3JlYXRlR2x5cGhUZXh0dXJlKCcjZmZmZjAwJywgJ3JpbmcnKTsgLy8gR29sZCBSaW5nCgogICAgY2xhc3MgR2x5cGhNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZ2x5cGhzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNYXRlcmlhbHMKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbHMgPSB7CiAgICAgICAgICAgICAgICB0ZWNoOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF90ZWNoVGV4dHVyZSwgCiAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBzdGF0dXM6IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgICAgIG1hcDogX3N0YXR1c1RleHR1cmUsIAogICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmZmZmYKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgY2hhcmdlOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF9jaGFyZ2VUZXh0dXJlLCAKICAgICAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgCiAgICAgICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUG9vbAogICAgICAgICAgICB0aGlzLnBvb2wgPSBbXTsKICAgICAgICAgICAgdGhpcy5wb29sU2l6ZSA9IDMwOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLCAxKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgdGhpcy5tYXRlcmlhbHMudGVjaCk7CiAgICAgICAgICAgICAgICBtZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1lc2gucmVuZGVyT3JkZXIgPSAyMDAwOyAvLyBEcmF3IG9uIHRvcCBvZiB3YXRlci9hcmVuYQogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQobWVzaCk7CiAgICAgICAgICAgICAgICB0aGlzLnBvb2wucHVzaChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgbWVzaCA9IHRoaXMucG9vbC5maW5kKG0gPT4gIW0udmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghbWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgbWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgbWVzaC5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWxzW3R5cGVdIHx8IHRoaXMubWF0ZXJpYWxzLnRlY2g7CiAgICAgICAgICAgIG1lc2gucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgTWF0ZXJpYWwgT3BhY2l0eQogICAgICAgICAgICBtZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CgogICAgICAgICAgICAvLyBEZWZhdWx0cwogICAgICAgICAgICBjb25zdCBzY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMS4wOwogICAgICAgICAgICBtZXNoLnNjYWxlLnNldChzY2FsZSwgc2NhbGUsIHNjYWxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9yaWVudGF0aW9uCiAgICAgICAgICAgIGlmIChvcHRpb25zLmZhY2VDYW1lcmEpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMub3JpZW50YXRpb24gPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgLy8gRmFjZSBjYW1lcmEgWS1heGlzIHJvdGF0aW9uIG9ubHkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKGNhbVBvcy54IC0gcG9zLngsIGNhbVBvcy56IC0gcG9zLnopOwogICAgICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24ueSA9IGFuZ2xlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCAoR3JvdW5kKQogICAgICAgICAgICAgICAgbWVzaC5yb3RhdGlvbi5zZXQoLU1hdGguUEkgLyAyLCAwLCBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLm9mZnNldFkpIHsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24ueSArPSBvcHRpb25zLm9mZnNldFk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2x5cGhzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogbWVzaCwKICAgICAgICAgICAgICAgIGFnZTogMCwKICAgICAgICAgICAgICAgIGxpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICBtYXhMaWZlOiBvcHRpb25zLmxpZmUgfHwgMS4wLAogICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogb3B0aW9ucy5yb3RhdGlvblNwZWVkIHx8IDEuMCwKICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IG9wdGlvbnMuc2NhbGVTcGVlZCB8fCAwLAogICAgICAgICAgICAgICAgZmFkZTogb3B0aW9ucy5mYWRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmZhZGUgOiB0cnVlLAogICAgICAgICAgICAgICAgZm9sbG93VGFyZ2V0OiBvcHRpb25zLnBhcmVudCB8fCBudWxsLAogICAgICAgICAgICAgICAgb2Zmc2V0WTogb3B0aW9ucy5vZmZzZXRZIHx8IDAKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2x5cGhzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nbHlwaHNbaV07CiAgICAgICAgICAgICAgICBnLmFnZSArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAoZy5hZ2UgPj0gZy5saWZlKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdseXBocy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IGcuYWdlIC8gZy5tYXhMaWZlOwoKICAgICAgICAgICAgICAgIC8vIEZvbGxvdyB0YXJnZXQKICAgICAgICAgICAgICAgIGlmIChnLmZvbGxvd1RhcmdldCAmJiBnLmZvbGxvd1RhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLmNvcHkoZy5mb2xsb3dUYXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnkgKz0gZy5vZmZzZXRZOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGdyb3VuZCBvcmllbnRlZCwga2VlcCBuZWFyIGZsb29yCiAgICAgICAgICAgICAgICAgICAgaWYgKGcubWVzaC5yb3RhdGlvbi54ID09PSAtTWF0aC5QSS8yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBnLm1lc2gucG9zaXRpb24ueSA9IDAuMSArIGcub2Zmc2V0WTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uCiAgICAgICAgICAgICAgICBnLm1lc2gucm90YXRpb24ueiArPSBnLnJvdGF0aW9uU3BlZWQgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGcuc2NhbGVTcGVlZCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBnLm1lc2guc2NhbGUueCArIGcuc2NhbGVTcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgICAgIGcubWVzaC5zY2FsZS5zZXQocywgcywgcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmFkZQogICAgICAgICAgICAgICAgaWYgKGcuZmFkZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBvcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0IDwgMC4xKSBvcGFjaXR5ID0gdCAvIDAuMTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ID4gMC43KSBvcGFjaXR5ID0gMS4wIC0gKCh0IC0gMC43KSAvIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkdseXBoTWFuYWdlciA9IEdseXBoTWFuYWdlcjsKfSkoKTs=","/GlyphManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUSU9OIC0tLQogICAgY29uc3QgX2NyZWF0ZUdseXBoVGV4dHVyZSA9IChjb2xvclN0ciwgdHlwZSkgPT4gewogICAgICAgIGNvbnN0IHNpemUgPSAyNTY7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSBzaXplOyBjLmhlaWdodCA9IHNpemU7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgc2l6ZSwgc2l6ZSk7CiAgICAgICAgCiAgICAgICAgLy8gR2xvdyBzZXR0aW5ncwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gMTU7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gY29sb3JTdHI7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3JTdHI7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGNvbG9yU3RyOwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKCiAgICAgICAgY29uc3QgY3ggPSBzaXplIC8gMjsKICAgICAgICBjb25zdCBjeSA9IHNpemUgLyAyOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ3JpbmcnKSB7CiAgICAgICAgICAgIC8vIE91dGVyIFJpbmcKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDY7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDExMCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBJbm5lciBSaW5nCiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoY3gsIGN5LCA5MCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBSdW5lcwpjdHguZm9udCA9ICcyNHB4IFNwaXJhLCBzYW5zLXNlcmlmJzsKICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTAwOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IGN4ICsgTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjeSArIE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICBjdHgudHJhbnNsYXRlKHgsIHkpOwogICAgICAgICAgICAgICAgY3R4LnJvdGF0ZShhbmdsZSArIE1hdGguUEkvMik7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGEgc2ltcGxlIHJ1bmUtbGlrZSBzaGFwZQogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygtNSwgLTUpOyBjdHgubGluZVRvKDUsIDApOyBjdHgubGluZVRvKC01LCA1KTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdydW5lJykgewogICAgICAgICAgICAvLyBDZW50cmFsIENvbXBsZXggUnVuZQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgNjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKGN4LCBjeSAtIDYwKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCwgY3kgKyA2MCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3ggLSA2MCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgNjAsIGN5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9OwoKICAgIGNvbnN0IF90ZWNoVGV4dHVyZSA9IF9jcmVhdGVHbHlwaFRleHR1cmUoJyMwMGZmZmYnLCAncmluZycpOyAvLyBDeWFuIFJpbmcKICAgIGNvbnN0IF9zdGF0dXNUZXh0dXJlID0gX2NyZWF0ZUdseXBoVGV4dHVyZSgnI2ZmMDBmZicsICdydW5lJyk7IC8vIE1hZ2VudGEgUnVuZQogICAgY29uc3QgX2NoYXJnZVRleHR1cmUgPSBfY3JlYXRlR2x5cGhUZXh0dXJlKCcjZmZmZjAwJywgJ3JpbmcnKTsgLy8gR29sZCBSaW5nCgogICAgY2xhc3MgR2x5cGhNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZ2x5cGhzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNYXRlcmlhbHMKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbHMgPSB7CiAgICAgICAgICAgICAgICB0ZWNoOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF90ZWNoVGV4dHVyZSwgCiAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBzdGF0dXM6IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgICAgIG1hcDogX3N0YXR1c1RleHR1cmUsIAogICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmZmZmYKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgY2hhcmdlOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF9jaGFyZ2VUZXh0dXJlLCAKICAgICAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgCiAgICAgICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUG9vbAogICAgICAgICAgICB0aGlzLnBvb2wgPSBbXTsKICAgICAgICAgICAgdGhpcy5wb29sU2l6ZSA9IDMwOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLCAxKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgdGhpcy5tYXRlcmlhbHMudGVjaCk7CiAgICAgICAgICAgICAgICBtZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1lc2gucmVuZGVyT3JkZXIgPSAyMDAwOyAvLyBEcmF3IG9uIHRvcCBvZiB3YXRlci9hcmVuYQogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQobWVzaCk7CiAgICAgICAgICAgICAgICB0aGlzLnBvb2wucHVzaChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgbWVzaCA9IHRoaXMucG9vbC5maW5kKG0gPT4gIW0udmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghbWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgbWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgbWVzaC5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWxzW3R5cGVdIHx8IHRoaXMubWF0ZXJpYWxzLnRlY2g7CiAgICAgICAgICAgIG1lc2gucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgTWF0ZXJpYWwgT3BhY2l0eQogICAgICAgICAgICBtZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CgogICAgICAgICAgICAvLyBEZWZhdWx0cwogICAgICAgICAgICBjb25zdCBzY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMS4wOwogICAgICAgICAgICBtZXNoLnNjYWxlLnNldChzY2FsZSwgc2NhbGUsIHNjYWxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9yaWVudGF0aW9uCiAgICAgICAgICAgIGlmIChvcHRpb25zLmZhY2VDYW1lcmEpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMub3JpZW50YXRpb24gPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgLy8gRmFjZSBjYW1lcmEgWS1heGlzIHJvdGF0aW9uIG9ubHkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKGNhbVBvcy54IC0gcG9zLngsIGNhbVBvcy56IC0gcG9zLnopOwogICAgICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24ueSA9IGFuZ2xlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCAoR3JvdW5kKQogICAgICAgICAgICAgICAgbWVzaC5yb3RhdGlvbi5zZXQoLU1hdGguUEkgLyAyLCAwLCBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLm9mZnNldFkpIHsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24ueSArPSBvcHRpb25zLm9mZnNldFk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2x5cGhzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogbWVzaCwKICAgICAgICAgICAgICAgIGFnZTogMCwKICAgICAgICAgICAgICAgIGxpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICBtYXhMaWZlOiBvcHRpb25zLmxpZmUgfHwgMS4wLAogICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogb3B0aW9ucy5yb3RhdGlvblNwZWVkIHx8IDEuMCwKICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IG9wdGlvbnMuc2NhbGVTcGVlZCB8fCAwLAogICAgICAgICAgICAgICAgZmFkZTogb3B0aW9ucy5mYWRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmZhZGUgOiB0cnVlLAogICAgICAgICAgICAgICAgZm9sbG93VGFyZ2V0OiBvcHRpb25zLnBhcmVudCB8fCBudWxsLAogICAgICAgICAgICAgICAgb2Zmc2V0WTogb3B0aW9ucy5vZmZzZXRZIHx8IDAKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2x5cGhzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nbHlwaHNbaV07CiAgICAgICAgICAgICAgICBnLmFnZSArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAoZy5hZ2UgPj0gZy5saWZlKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdseXBocy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IGcuYWdlIC8gZy5tYXhMaWZlOwoKICAgICAgICAgICAgICAgIC8vIEZvbGxvdyB0YXJnZXQKICAgICAgICAgICAgICAgIGlmIChnLmZvbGxvd1RhcmdldCAmJiBnLmZvbGxvd1RhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLmNvcHkoZy5mb2xsb3dUYXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnkgKz0gZy5vZmZzZXRZOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGdyb3VuZCBvcmllbnRlZCwga2VlcCBuZWFyIGZsb29yCiAgICAgICAgICAgICAgICAgICAgaWYgKGcubWVzaC5yb3RhdGlvbi54ID09PSAtTWF0aC5QSS8yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBnLm1lc2gucG9zaXRpb24ueSA9IDAuMSArIGcub2Zmc2V0WTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uCiAgICAgICAgICAgICAgICBnLm1lc2gucm90YXRpb24ueiArPSBnLnJvdGF0aW9uU3BlZWQgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGcuc2NhbGVTcGVlZCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBnLm1lc2guc2NhbGUueCArIGcuc2NhbGVTcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgICAgIGcubWVzaC5zY2FsZS5zZXQocywgcywgcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmFkZQogICAgICAgICAgICAgICAgaWYgKGcuZmFkZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBvcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0IDwgMC4xKSBvcGFjaXR5ID0gdCAvIDAuMTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ID4gMC43KSBvcGFjaXR5ID0gMS4wIC0gKCh0IC0gMC43KSAvIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkdseXBoTWFuYWdlciA9IEdseXBoTWFuYWdlcjsKfSkoKTs=","AudioManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBBdWRpb01hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgICB0aGlzLmJnbSA9IG5ldyBBdWRpbygpOwogICAgICAgICAgICB0aGlzLmJnbS5zcmMgPSAnaHR0cHM6Ly9maWxlcy5jYXRib3gubW9lL3NwMnloeS5tcDMnOwogICAgICAgICAgICB0aGlzLmJnbS5sb29wID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5iZ20udm9sdW1lID0gMC41OwogICAgICAgICAgICB0aGlzLmlzTXV0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5oYXNJbnRlcmFjdGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvdWxkQmVQbGF5aW5nID0gZmFsc2U7IC8vIEludGVudCBmbGFnCgogICAgICAgICAgICAvLyBQcmVsb2FkCiAgICAgICAgICAgIHRoaXMuYmdtLmxvYWQoKTsKCiAgICAgICAgICAgIC8vIC0tLSBIRVJDVUxFQU4gTE9PUCBFTkZPUkNFTUVOVCAtLS0KICAgICAgICAgICAgLy8gMS4gTWFudWFsIExvb3AgUmVkdW5kYW5jeQogICAgICAgICAgICB0aGlzLmJnbS5hZGRFdmVudExpc3RlbmVyKCdlbmRlZCcsICgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJBdWRpb01hbmFnZXI6IEJHTSBlbmRlZCBldmVudCBjYXVnaHQuIEZvcmNpbmcgbWFudWFsIGxvb3AgcmVzZXQuIik7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgIXRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmJnbS5wbGF5KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAgIT09IHVuZGVmaW5lZCkgcC5jYXRjaChlID0+IGNvbnNvbGUud2FybigiTWFudWFsIGxvb3AgcmVwbGF5IGZhaWxlZDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gMi4gUGF1c2UgV2F0Y2hkb2cgKElmIHBhdXNlZCBidXQgc2hvdWxkIGJlIHBsYXlpbmcsIEZPUkNFIFBMQVkpCiAgICAgICAgICAgIHRoaXMuYmdtLmFkZEV2ZW50TGlzdGVuZXIoJ3BhdXNlJywgKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hvdWxkQmVQbGF5aW5nICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTbWFsbCB0aW1lb3V0IHRvIGFsbG93IGludGVudGlvbmFsIG9wZXJhdGlvbnMgdG8gZmluaXNoIGlmIGFueQogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgdGhpcy5iZ20ucGF1c2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiQXVkaW9NYW5hZ2VyOiBVbmV4cGVjdGVkIHBhdXNlIGRldGVjdGVkLiBBdHRlbXB0aW5nIHJlc3VtZS4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBsYXkoKS5jYXRjaChlID0+IGNvbnNvbGUud2FybigiUmVzdW1lIGZhaWxlZDoiLCBlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCAxMDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIDMuIFBlcmlvZGljIFdhdGNoZG9nIChUaGUgIk5ldmVyIFN0b3AiIEd1YXJhbnRlZSkKICAgICAgICAgICAgc2V0SW50ZXJ2YWwoKCkgPT4gdGhpcy5fd2F0Y2hkb2coKSwgMTAwMCk7CiAgICAgICAgfQoKICAgICAgICBfd2F0Y2hkb2coKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNob3VsZEJlUGxheWluZyAmJiAhdGhpcy5pc011dGVkKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5iZ20ucGF1c2VkIHx8IHRoaXMuYmdtLmVuZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkF1ZGlvTWFuYWdlcjogV2F0Y2hkb2cgZm9yY2luZyBwbGF5LiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBsYXkoKS5jYXRjaCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNpbGVudCBjYXRjaCwgbGlrZWx5IHdhaXRpbmcgZm9yIGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBsYXlCR00oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0ZWQpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcGxheVByb21pc2UgPSB0aGlzLmJnbS5wbGF5KCk7CiAgICAgICAgICAgIGlmIChwbGF5UHJvbWlzZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBwbGF5UHJvbWlzZS5jYXRjaChlcnJvciA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkF1ZGlvTWFuYWdlcjogQXV0b3BsYXkgcHJldmVudGVkLiBFbmdhZ2luZyBpbnRlcmFjdGlvbiBsb2NrLiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3dhaXRGb3JJbnRlcmFjdGlvbigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF93YWl0Rm9ySW50ZXJhY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl93YWl0aW5nRm9ySW50ZXJhY3Rpb24pIHJldHVybjsKICAgICAgICAgICAgdGhpcy5fd2FpdGluZ0ZvckludGVyYWN0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IG9uSW50ZXJhY3QgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmhhc0ludGVyYWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBUcnkgdG8gcGxheQogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hvdWxkQmVQbGF5aW5nICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkudGhlbigoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN1Y2Nlc3MhIERldGFjaCBsaXN0ZW5lcnMKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fd2FpdGluZ0ZvckludGVyYWN0aW9uID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlbW92ZUludGVyYWN0aW9uTGlzdGVuZXJzKG9uSW50ZXJhY3QpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiQXVkaW9NYW5hZ2VyOiBBdWRpbyB1bmxvY2tlZCBzdWNjZXNzZnVsbHkuIik7CiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQXVkaW9NYW5hZ2VyOiBJbnRlcmFjdGlvbiBwbGF5IGZhaWxlZC4gS2VlcGluZyBsaXN0ZW5lcnMgYXR0YWNoZWQuIiwgZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERvIE5PVCBkZXRhY2ggbGlzdGVuZXJzLCB3YWl0IGZvciBuZXh0IGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIE5vdCBzdXBwb3NlZCB0byBwbGF5PyBKdXN0IGRldGFjaC4KICAgICAgICAgICAgICAgICAgICB0aGlzLl93YWl0aW5nRm9ySW50ZXJhY3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVJbnRlcmFjdGlvbkxpc3RlbmVycyhvbkludGVyYWN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVzZSBjYXB0dXJlIHRvIGNhdGNoIGl0IGVhcmx5LCBidXQgZG9uJ3QgdXNlICdvbmNlOiB0cnVlJyBzbyB3ZSBjYW4gcmV0cnkgaWYgZmFpbGVkCiAgICAgICAgICAgIGNvbnN0IG9wdHMgPSB7IGNhcHR1cmU6IHRydWUsIHBhc3NpdmU6IHRydWUgfTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBvbkludGVyYWN0LCBvcHRzKTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIG9uSW50ZXJhY3QsIG9wdHMpOwogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgb25JbnRlcmFjdCwgb3B0cyk7CiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIG9uSW50ZXJhY3QsIG9wdHMpOwogICAgICAgIH0KCiAgICAgICAgX3JlbW92ZUludGVyYWN0aW9uTGlzdGVuZXJzKGhhbmRsZXIpIHsKICAgICAgICAgICAgY29uc3Qgb3B0cyA9IHsgY2FwdHVyZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZSB9OwogICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIGhhbmRsZXIsIG9wdHMpOwogICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlciwgb3B0cyk7CiAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBoYW5kbGVyLCBvcHRzKTsKICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgaGFuZGxlciwgb3B0cyk7CiAgICAgICAgfQoKICAgICAgICBzdG9wQkdNKCkgewogICAgICAgICAgICB0aGlzLnNob3VsZEJlUGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmJnbS5wYXVzZSgpOwogICAgICAgICAgICB0aGlzLmJnbS5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgfQoKICAgICAgICBwYXVzZUJHTSgpIHsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICB9CgogICAgICAgIHJlc3VtZUJHTSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUJHTSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXRWb2x1bWUodm9sdW1lKSB7CiAgICAgICAgICAgIHRoaXMuYmdtLnZvbHVtZSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHZvbHVtZSkpOwogICAgICAgIH0KCiAgICAgICAgdG9nZ2xlTXV0ZSgpIHsKICAgICAgICAgICAgdGhpcy5pc011dGVkID0gIXRoaXMuaXNNdXRlZDsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBhdXNlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXlCR00oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5pc011dGVkOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5BdWRpb01hbmFnZXIgPSBBdWRpb01hbmFnZXI7Cn0pKCk7","./AudioManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBBdWRpb01hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgICB0aGlzLmJnbSA9IG5ldyBBdWRpbygpOwogICAgICAgICAgICB0aGlzLmJnbS5zcmMgPSAnaHR0cHM6Ly9maWxlcy5jYXRib3gubW9lL3NwMnloeS5tcDMnOwogICAgICAgICAgICB0aGlzLmJnbS5sb29wID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5iZ20udm9sdW1lID0gMC41OwogICAgICAgICAgICB0aGlzLmlzTXV0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5oYXNJbnRlcmFjdGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvdWxkQmVQbGF5aW5nID0gZmFsc2U7IC8vIEludGVudCBmbGFnCgogICAgICAgICAgICAvLyBQcmVsb2FkCiAgICAgICAgICAgIHRoaXMuYmdtLmxvYWQoKTsKCiAgICAgICAgICAgIC8vIC0tLSBIRVJDVUxFQU4gTE9PUCBFTkZPUkNFTUVOVCAtLS0KICAgICAgICAgICAgLy8gMS4gTWFudWFsIExvb3AgUmVkdW5kYW5jeQogICAgICAgICAgICB0aGlzLmJnbS5hZGRFdmVudExpc3RlbmVyKCdlbmRlZCcsICgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJBdWRpb01hbmFnZXI6IEJHTSBlbmRlZCBldmVudCBjYXVnaHQuIEZvcmNpbmcgbWFudWFsIGxvb3AgcmVzZXQuIik7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgIXRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmJnbS5wbGF5KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAgIT09IHVuZGVmaW5lZCkgcC5jYXRjaChlID0+IGNvbnNvbGUud2FybigiTWFudWFsIGxvb3AgcmVwbGF5IGZhaWxlZDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gMi4gUGF1c2UgV2F0Y2hkb2cgKElmIHBhdXNlZCBidXQgc2hvdWxkIGJlIHBsYXlpbmcsIEZPUkNFIFBMQVkpCiAgICAgICAgICAgIHRoaXMuYmdtLmFkZEV2ZW50TGlzdGVuZXIoJ3BhdXNlJywgKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hvdWxkQmVQbGF5aW5nICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTbWFsbCB0aW1lb3V0IHRvIGFsbG93IGludGVudGlvbmFsIG9wZXJhdGlvbnMgdG8gZmluaXNoIGlmIGFueQogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgdGhpcy5iZ20ucGF1c2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiQXVkaW9NYW5hZ2VyOiBVbmV4cGVjdGVkIHBhdXNlIGRldGVjdGVkLiBBdHRlbXB0aW5nIHJlc3VtZS4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBsYXkoKS5jYXRjaChlID0+IGNvbnNvbGUud2FybigiUmVzdW1lIGZhaWxlZDoiLCBlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCAxMDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIDMuIFBlcmlvZGljIFdhdGNoZG9nIChUaGUgIk5ldmVyIFN0b3AiIEd1YXJhbnRlZSkKICAgICAgICAgICAgc2V0SW50ZXJ2YWwoKCkgPT4gdGhpcy5fd2F0Y2hkb2coKSwgMTAwMCk7CiAgICAgICAgfQoKICAgICAgICBfd2F0Y2hkb2coKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNob3VsZEJlUGxheWluZyAmJiAhdGhpcy5pc011dGVkKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5iZ20ucGF1c2VkIHx8IHRoaXMuYmdtLmVuZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkF1ZGlvTWFuYWdlcjogV2F0Y2hkb2cgZm9yY2luZyBwbGF5LiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBsYXkoKS5jYXRjaCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNpbGVudCBjYXRjaCwgbGlrZWx5IHdhaXRpbmcgZm9yIGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBsYXlCR00oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0ZWQpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcGxheVByb21pc2UgPSB0aGlzLmJnbS5wbGF5KCk7CiAgICAgICAgICAgIGlmIChwbGF5UHJvbWlzZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBwbGF5UHJvbWlzZS5jYXRjaChlcnJvciA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkF1ZGlvTWFuYWdlcjogQXV0b3BsYXkgcHJldmVudGVkLiBFbmdhZ2luZyBpbnRlcmFjdGlvbiBsb2NrLiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3dhaXRGb3JJbnRlcmFjdGlvbigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF93YWl0Rm9ySW50ZXJhY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl93YWl0aW5nRm9ySW50ZXJhY3Rpb24pIHJldHVybjsKICAgICAgICAgICAgdGhpcy5fd2FpdGluZ0ZvckludGVyYWN0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IG9uSW50ZXJhY3QgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmhhc0ludGVyYWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBUcnkgdG8gcGxheQogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hvdWxkQmVQbGF5aW5nICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkudGhlbigoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN1Y2Nlc3MhIERldGFjaCBsaXN0ZW5lcnMKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fd2FpdGluZ0ZvckludGVyYWN0aW9uID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlbW92ZUludGVyYWN0aW9uTGlzdGVuZXJzKG9uSW50ZXJhY3QpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiQXVkaW9NYW5hZ2VyOiBBdWRpbyB1bmxvY2tlZCBzdWNjZXNzZnVsbHkuIik7CiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQXVkaW9NYW5hZ2VyOiBJbnRlcmFjdGlvbiBwbGF5IGZhaWxlZC4gS2VlcGluZyBsaXN0ZW5lcnMgYXR0YWNoZWQuIiwgZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERvIE5PVCBkZXRhY2ggbGlzdGVuZXJzLCB3YWl0IGZvciBuZXh0IGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIE5vdCBzdXBwb3NlZCB0byBwbGF5PyBKdXN0IGRldGFjaC4KICAgICAgICAgICAgICAgICAgICB0aGlzLl93YWl0aW5nRm9ySW50ZXJhY3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVJbnRlcmFjdGlvbkxpc3RlbmVycyhvbkludGVyYWN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVzZSBjYXB0dXJlIHRvIGNhdGNoIGl0IGVhcmx5LCBidXQgZG9uJ3QgdXNlICdvbmNlOiB0cnVlJyBzbyB3ZSBjYW4gcmV0cnkgaWYgZmFpbGVkCiAgICAgICAgICAgIGNvbnN0IG9wdHMgPSB7IGNhcHR1cmU6IHRydWUsIHBhc3NpdmU6IHRydWUgfTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBvbkludGVyYWN0LCBvcHRzKTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIG9uSW50ZXJhY3QsIG9wdHMpOwogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgb25JbnRlcmFjdCwgb3B0cyk7CiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIG9uSW50ZXJhY3QsIG9wdHMpOwogICAgICAgIH0KCiAgICAgICAgX3JlbW92ZUludGVyYWN0aW9uTGlzdGVuZXJzKGhhbmRsZXIpIHsKICAgICAgICAgICAgY29uc3Qgb3B0cyA9IHsgY2FwdHVyZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZSB9OwogICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIGhhbmRsZXIsIG9wdHMpOwogICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlciwgb3B0cyk7CiAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBoYW5kbGVyLCBvcHRzKTsKICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgaGFuZGxlciwgb3B0cyk7CiAgICAgICAgfQoKICAgICAgICBzdG9wQkdNKCkgewogICAgICAgICAgICB0aGlzLnNob3VsZEJlUGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmJnbS5wYXVzZSgpOwogICAgICAgICAgICB0aGlzLmJnbS5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgfQoKICAgICAgICBwYXVzZUJHTSgpIHsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICB9CgogICAgICAgIHJlc3VtZUJHTSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUJHTSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXRWb2x1bWUodm9sdW1lKSB7CiAgICAgICAgICAgIHRoaXMuYmdtLnZvbHVtZSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHZvbHVtZSkpOwogICAgICAgIH0KCiAgICAgICAgdG9nZ2xlTXV0ZSgpIHsKICAgICAgICAgICAgdGhpcy5pc011dGVkID0gIXRoaXMuaXNNdXRlZDsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBhdXNlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXlCR00oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5pc011dGVkOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5BdWRpb01hbmFnZXIgPSBBdWRpb01hbmFnZXI7Cn0pKCk7","/AudioManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBBdWRpb01hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgICB0aGlzLmJnbSA9IG5ldyBBdWRpbygpOwogICAgICAgICAgICB0aGlzLmJnbS5zcmMgPSAnaHR0cHM6Ly9maWxlcy5jYXRib3gubW9lL3NwMnloeS5tcDMnOwogICAgICAgICAgICB0aGlzLmJnbS5sb29wID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5iZ20udm9sdW1lID0gMC41OwogICAgICAgICAgICB0aGlzLmlzTXV0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5oYXNJbnRlcmFjdGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvdWxkQmVQbGF5aW5nID0gZmFsc2U7IC8vIEludGVudCBmbGFnCgogICAgICAgICAgICAvLyBQcmVsb2FkCiAgICAgICAgICAgIHRoaXMuYmdtLmxvYWQoKTsKCiAgICAgICAgICAgIC8vIC0tLSBIRVJDVUxFQU4gTE9PUCBFTkZPUkNFTUVOVCAtLS0KICAgICAgICAgICAgLy8gMS4gTWFudWFsIExvb3AgUmVkdW5kYW5jeQogICAgICAgICAgICB0aGlzLmJnbS5hZGRFdmVudExpc3RlbmVyKCdlbmRlZCcsICgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJBdWRpb01hbmFnZXI6IEJHTSBlbmRlZCBldmVudCBjYXVnaHQuIEZvcmNpbmcgbWFudWFsIGxvb3AgcmVzZXQuIik7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgIXRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmJnbS5wbGF5KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAgIT09IHVuZGVmaW5lZCkgcC5jYXRjaChlID0+IGNvbnNvbGUud2FybigiTWFudWFsIGxvb3AgcmVwbGF5IGZhaWxlZDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gMi4gUGF1c2UgV2F0Y2hkb2cgKElmIHBhdXNlZCBidXQgc2hvdWxkIGJlIHBsYXlpbmcsIEZPUkNFIFBMQVkpCiAgICAgICAgICAgIHRoaXMuYmdtLmFkZEV2ZW50TGlzdGVuZXIoJ3BhdXNlJywgKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hvdWxkQmVQbGF5aW5nICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTbWFsbCB0aW1lb3V0IHRvIGFsbG93IGludGVudGlvbmFsIG9wZXJhdGlvbnMgdG8gZmluaXNoIGlmIGFueQogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgdGhpcy5iZ20ucGF1c2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiQXVkaW9NYW5hZ2VyOiBVbmV4cGVjdGVkIHBhdXNlIGRldGVjdGVkLiBBdHRlbXB0aW5nIHJlc3VtZS4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBsYXkoKS5jYXRjaChlID0+IGNvbnNvbGUud2FybigiUmVzdW1lIGZhaWxlZDoiLCBlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCAxMDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIDMuIFBlcmlvZGljIFdhdGNoZG9nIChUaGUgIk5ldmVyIFN0b3AiIEd1YXJhbnRlZSkKICAgICAgICAgICAgc2V0SW50ZXJ2YWwoKCkgPT4gdGhpcy5fd2F0Y2hkb2coKSwgMTAwMCk7CiAgICAgICAgfQoKICAgICAgICBfd2F0Y2hkb2coKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNob3VsZEJlUGxheWluZyAmJiAhdGhpcy5pc011dGVkKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5iZ20ucGF1c2VkIHx8IHRoaXMuYmdtLmVuZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkF1ZGlvTWFuYWdlcjogV2F0Y2hkb2cgZm9yY2luZyBwbGF5LiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBsYXkoKS5jYXRjaCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNpbGVudCBjYXRjaCwgbGlrZWx5IHdhaXRpbmcgZm9yIGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBsYXlCR00oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0ZWQpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcGxheVByb21pc2UgPSB0aGlzLmJnbS5wbGF5KCk7CiAgICAgICAgICAgIGlmIChwbGF5UHJvbWlzZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBwbGF5UHJvbWlzZS5jYXRjaChlcnJvciA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkF1ZGlvTWFuYWdlcjogQXV0b3BsYXkgcHJldmVudGVkLiBFbmdhZ2luZyBpbnRlcmFjdGlvbiBsb2NrLiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3dhaXRGb3JJbnRlcmFjdGlvbigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF93YWl0Rm9ySW50ZXJhY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl93YWl0aW5nRm9ySW50ZXJhY3Rpb24pIHJldHVybjsKICAgICAgICAgICAgdGhpcy5fd2FpdGluZ0ZvckludGVyYWN0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IG9uSW50ZXJhY3QgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmhhc0ludGVyYWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBUcnkgdG8gcGxheQogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hvdWxkQmVQbGF5aW5nICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkudGhlbigoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN1Y2Nlc3MhIERldGFjaCBsaXN0ZW5lcnMKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fd2FpdGluZ0ZvckludGVyYWN0aW9uID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlbW92ZUludGVyYWN0aW9uTGlzdGVuZXJzKG9uSW50ZXJhY3QpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiQXVkaW9NYW5hZ2VyOiBBdWRpbyB1bmxvY2tlZCBzdWNjZXNzZnVsbHkuIik7CiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQXVkaW9NYW5hZ2VyOiBJbnRlcmFjdGlvbiBwbGF5IGZhaWxlZC4gS2VlcGluZyBsaXN0ZW5lcnMgYXR0YWNoZWQuIiwgZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERvIE5PVCBkZXRhY2ggbGlzdGVuZXJzLCB3YWl0IGZvciBuZXh0IGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIE5vdCBzdXBwb3NlZCB0byBwbGF5PyBKdXN0IGRldGFjaC4KICAgICAgICAgICAgICAgICAgICB0aGlzLl93YWl0aW5nRm9ySW50ZXJhY3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVJbnRlcmFjdGlvbkxpc3RlbmVycyhvbkludGVyYWN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVzZSBjYXB0dXJlIHRvIGNhdGNoIGl0IGVhcmx5LCBidXQgZG9uJ3QgdXNlICdvbmNlOiB0cnVlJyBzbyB3ZSBjYW4gcmV0cnkgaWYgZmFpbGVkCiAgICAgICAgICAgIGNvbnN0IG9wdHMgPSB7IGNhcHR1cmU6IHRydWUsIHBhc3NpdmU6IHRydWUgfTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBvbkludGVyYWN0LCBvcHRzKTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIG9uSW50ZXJhY3QsIG9wdHMpOwogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgb25JbnRlcmFjdCwgb3B0cyk7CiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIG9uSW50ZXJhY3QsIG9wdHMpOwogICAgICAgIH0KCiAgICAgICAgX3JlbW92ZUludGVyYWN0aW9uTGlzdGVuZXJzKGhhbmRsZXIpIHsKICAgICAgICAgICAgY29uc3Qgb3B0cyA9IHsgY2FwdHVyZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZSB9OwogICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIGhhbmRsZXIsIG9wdHMpOwogICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlciwgb3B0cyk7CiAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBoYW5kbGVyLCBvcHRzKTsKICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgaGFuZGxlciwgb3B0cyk7CiAgICAgICAgfQoKICAgICAgICBzdG9wQkdNKCkgewogICAgICAgICAgICB0aGlzLnNob3VsZEJlUGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmJnbS5wYXVzZSgpOwogICAgICAgICAgICB0aGlzLmJnbS5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgfQoKICAgICAgICBwYXVzZUJHTSgpIHsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICB9CgogICAgICAgIHJlc3VtZUJHTSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUJHTSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXRWb2x1bWUodm9sdW1lKSB7CiAgICAgICAgICAgIHRoaXMuYmdtLnZvbHVtZSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHZvbHVtZSkpOwogICAgICAgIH0KCiAgICAgICAgdG9nZ2xlTXV0ZSgpIHsKICAgICAgICAgICAgdGhpcy5pc011dGVkID0gIXRoaXMuaXNNdXRlZDsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBhdXNlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXlCR00oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5pc011dGVkOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5BdWRpb01hbmFnZXIgPSBBdWRpb01hbmFnZXI7Cn0pKCk7","LightShafts.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBMaWdodFNoYWZ0cyB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgIHROb2lzZTogeyB2YWx1ZTogbnVsbCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9pbml0KCk7CiAgICAgICAgfQoKX2luaXQoKSB7CiAgICAgICAgICAgIC8vIEdlb21ldHJ5OiBBIGNsdXN0ZXIgb2YgY29uZXMvY3lsaW5kZXJzCiAgICAgICAgICAgIC8vIFdlIHVzZSBhIHNpbmdsZSBnZW9tZXRyeSB3aXRoIGluc3RhbmNpbmcgb3IgbWVyZ2VkIGdlb21ldHJ5IGZvciBwZXJmb3JtYW5jZSwKICAgICAgICAgICAgLy8gYnV0IGZvciBzaW1wbGljaXR5IGFuZCBhZXN0aGV0aWMgY29udHJvbCwgbGV0J3MgdXNlIGEgZmV3IGxhcmdlIHBsYW5lcyBvciBhIGN5bGluZGVyLgogICAgICAgICAgICAvLyBBIGxhcmdlIGN5bGluZGVyIHdpdGggb3BlbiBlbmRzIHdvcmtzIHdlbGwgZm9yIGEgInBvb2wiIHNoYWZ0IGVmZmVjdC4KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluY3JlYXNlZCBsZW5ndGggdG8gOTAgdG8gYWNjb21tb2RhdGUgdGlsdCB3aXRob3V0IGNsaXBwaW5nIHRvcC9ib3R0b20KICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgzMCwgMjAsIDkwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaGFkZXIKICAgICAgICAgICAgY29uc3QgdmVydCA9IGAKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdlBvczsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2UG9zID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3NpdGlvbiwgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIGNvbnN0IGZyYWcgPSBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdE5vaXNlOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2UG9zOwoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBmYWRlIChTb2Z0IHRvcCBhbmQgYm90dG9tKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gc21vb3Roc3RlcCgwLjAsIDAuMywgdlV2LnkpICogc21vb3Roc3RlcCgxLjAsIDAuNiwgdlV2LnkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTY3JvbGxpbmcgUmF5cwogICAgICAgICAgICAgICAgICAgIC8vIExheWVyIDE6IFNsb3csIGJyb2FkIHJheXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBuMSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZlYzIodlV2LnggKiAyLjAgKyB1VGltZSAqIDAuMDIsIHZVdi55ICogMC41IC0gdVRpbWUgKiAwLjA1KSkucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMYXllciAyOiBGYXN0LCBpbnRlcmZlcmVuY2UgcmF5cwogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4yID0gdGV4dHVyZTJEKHROb2lzZSwgdmVjMih2VXYueCAqIDMuMCAtIHVUaW1lICogMC4wMywgdlV2LnkgKiAwLjUgLSB1VGltZSAqIDAuMSkpLnI7CgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheXMgPSBuMSAqIG4yOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IGludGVuc2l0eSBzaWduaWZpY2FudGx5IChSZW1vdmVkIHBvdyB0byBwcmV2ZW50IGNydXNoaW5nKQogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogMy4wOyAKCiAgICAgICAgICAgICAgICAgICAgLy8gR2xpc3RlbmluZyBTcGFya2xlcyAoSGlnaCBmcmVxdWVuY3kgbm9pc2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BhcmtsZSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZVdiAqIHZlYzIoOC4wLCAyLjApICsgdmVjMih1VGltZSAqIDAuMSwgdVRpbWUgKiAwLjMpKS5yOwogICAgICAgICAgICAgICAgICAgIHNwYXJrbGUgPSBwb3coc3BhcmtsZSwgNS4wKSAqIDEwLjA7IC8vIFNoYXJwIHBvaW50cwoKICAgICAgICAgICAgICAgICAgICAvLyBDb2xvcjogQ3lhbi9CbHVlL1doaXRlIChCcmlnaHRlciBiYXNlKQogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKDAuNiwgMC45LCAxLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENvbWJpbmUgKEhpZ2hlciBtdWx0aXBsaWVycykKICAgICAgICAgICAgICAgICAgICBmbG9hdCBmaW5hbEFscGhhID0gKHJheXMgKiAwLjggKyBzcGFya2xlICogMC40KSAqIGFscGhhOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIERpc3RhbmNlIGZhZGUgKG9wdGlvbmFsLCBoYW5kbGVkIGJ5IGZvZyB1c3VhbGx5IGJ1dCB3ZSB3YW50IGFkZGl0aXZlKQogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGZpbmFsQWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHRoaXMudW5pZm9ybXMsCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IHZlcnQsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogZnJhZywKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBDb250YWluZXIgZm9yIHRoZSBhbmdsZSAoUmVhbGlzdGljIExpZ2h0IFNvdXJjZSkKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgLy8gQW5nbGU6IENvbWluZyBmcm9tIHRvcC1sZWZ0IChzaW11bGF0aW5nIHN1cmZhY2Ugc3VuIHBlbmV0cmF0aW5nIGRlZXAgd2F0ZXIpCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJvdGF0aW9uLnogPSBNYXRoLlBJIC8gNTsgLy8gfjM2IGRlZ3JlZXMgdGlsdAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDEwOyAvLyB+MTggZGVncmVlcyBmb3J3YXJkCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnBvc2l0aW9uLnNldCgxMiwgOCwgMCk7IC8vIE9mZnNldCBzb3VyY2UgdG8gaGl0IGFyZW5hIGNlbnRlcgogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNvbnRhaW5lcik7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSAxMDA7IAogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5tZXNoKTsKCiAgICAgICAgICAgIC8vIEFkZCBhIHNlY29uZCBsYXllciBmb3IgY29yZSBpbnRlbnNpdHkKICAgICAgICAgICAgY29uc3QgY29yZUdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEyLCA4LCA5MCwgMTYsIDEsIHRydWUpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoID0gbmV3IFRIUkVFLk1lc2goY29yZUdlbywgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoLnJlbmRlck9yZGVyID0gMTAwOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jb3JlTWVzaCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExhenkgbG9hZCB0ZXh0dXJlCiAgICAgICAgICAgIGlmICghdGhpcy51bmlmb3Jtcy50Tm9pc2UudmFsdWUgJiYgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnROb2lzZS52YWx1ZSA9IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZTsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3cmFwcGluZyBpcyBjb3JyZWN0IGZvciB0aGUgY3lsaW5kZXIgVVZzCiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZS53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbG93bHkgcm90YXRlIHNoYWZ0cyBmb3IgZHluYW1pYyBmZWVsCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC5yb3RhdGlvbi55ICs9IGR0ICogMC4wMjsKICAgICAgICAgICAgaWYgKHRoaXMuY29yZU1lc2gpIHRoaXMuY29yZU1lc2gucm90YXRpb24ueSAtPSBkdCAqIDAuMDM7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkxpZ2h0U2hhZnRzID0gTGlnaHRTaGFmdHM7Cn0pKCk7","./LightShafts.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBMaWdodFNoYWZ0cyB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgIHROb2lzZTogeyB2YWx1ZTogbnVsbCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9pbml0KCk7CiAgICAgICAgfQoKX2luaXQoKSB7CiAgICAgICAgICAgIC8vIEdlb21ldHJ5OiBBIGNsdXN0ZXIgb2YgY29uZXMvY3lsaW5kZXJzCiAgICAgICAgICAgIC8vIFdlIHVzZSBhIHNpbmdsZSBnZW9tZXRyeSB3aXRoIGluc3RhbmNpbmcgb3IgbWVyZ2VkIGdlb21ldHJ5IGZvciBwZXJmb3JtYW5jZSwKICAgICAgICAgICAgLy8gYnV0IGZvciBzaW1wbGljaXR5IGFuZCBhZXN0aGV0aWMgY29udHJvbCwgbGV0J3MgdXNlIGEgZmV3IGxhcmdlIHBsYW5lcyBvciBhIGN5bGluZGVyLgogICAgICAgICAgICAvLyBBIGxhcmdlIGN5bGluZGVyIHdpdGggb3BlbiBlbmRzIHdvcmtzIHdlbGwgZm9yIGEgInBvb2wiIHNoYWZ0IGVmZmVjdC4KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluY3JlYXNlZCBsZW5ndGggdG8gOTAgdG8gYWNjb21tb2RhdGUgdGlsdCB3aXRob3V0IGNsaXBwaW5nIHRvcC9ib3R0b20KICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgzMCwgMjAsIDkwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaGFkZXIKICAgICAgICAgICAgY29uc3QgdmVydCA9IGAKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdlBvczsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2UG9zID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3NpdGlvbiwgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIGNvbnN0IGZyYWcgPSBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdE5vaXNlOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2UG9zOwoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBmYWRlIChTb2Z0IHRvcCBhbmQgYm90dG9tKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gc21vb3Roc3RlcCgwLjAsIDAuMywgdlV2LnkpICogc21vb3Roc3RlcCgxLjAsIDAuNiwgdlV2LnkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTY3JvbGxpbmcgUmF5cwogICAgICAgICAgICAgICAgICAgIC8vIExheWVyIDE6IFNsb3csIGJyb2FkIHJheXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBuMSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZlYzIodlV2LnggKiAyLjAgKyB1VGltZSAqIDAuMDIsIHZVdi55ICogMC41IC0gdVRpbWUgKiAwLjA1KSkucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMYXllciAyOiBGYXN0LCBpbnRlcmZlcmVuY2UgcmF5cwogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4yID0gdGV4dHVyZTJEKHROb2lzZSwgdmVjMih2VXYueCAqIDMuMCAtIHVUaW1lICogMC4wMywgdlV2LnkgKiAwLjUgLSB1VGltZSAqIDAuMSkpLnI7CgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheXMgPSBuMSAqIG4yOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IGludGVuc2l0eSBzaWduaWZpY2FudGx5IChSZW1vdmVkIHBvdyB0byBwcmV2ZW50IGNydXNoaW5nKQogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogMy4wOyAKCiAgICAgICAgICAgICAgICAgICAgLy8gR2xpc3RlbmluZyBTcGFya2xlcyAoSGlnaCBmcmVxdWVuY3kgbm9pc2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BhcmtsZSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZVdiAqIHZlYzIoOC4wLCAyLjApICsgdmVjMih1VGltZSAqIDAuMSwgdVRpbWUgKiAwLjMpKS5yOwogICAgICAgICAgICAgICAgICAgIHNwYXJrbGUgPSBwb3coc3BhcmtsZSwgNS4wKSAqIDEwLjA7IC8vIFNoYXJwIHBvaW50cwoKICAgICAgICAgICAgICAgICAgICAvLyBDb2xvcjogQ3lhbi9CbHVlL1doaXRlIChCcmlnaHRlciBiYXNlKQogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKDAuNiwgMC45LCAxLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENvbWJpbmUgKEhpZ2hlciBtdWx0aXBsaWVycykKICAgICAgICAgICAgICAgICAgICBmbG9hdCBmaW5hbEFscGhhID0gKHJheXMgKiAwLjggKyBzcGFya2xlICogMC40KSAqIGFscGhhOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIERpc3RhbmNlIGZhZGUgKG9wdGlvbmFsLCBoYW5kbGVkIGJ5IGZvZyB1c3VhbGx5IGJ1dCB3ZSB3YW50IGFkZGl0aXZlKQogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGZpbmFsQWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHRoaXMudW5pZm9ybXMsCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IHZlcnQsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogZnJhZywKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBDb250YWluZXIgZm9yIHRoZSBhbmdsZSAoUmVhbGlzdGljIExpZ2h0IFNvdXJjZSkKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgLy8gQW5nbGU6IENvbWluZyBmcm9tIHRvcC1sZWZ0IChzaW11bGF0aW5nIHN1cmZhY2Ugc3VuIHBlbmV0cmF0aW5nIGRlZXAgd2F0ZXIpCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJvdGF0aW9uLnogPSBNYXRoLlBJIC8gNTsgLy8gfjM2IGRlZ3JlZXMgdGlsdAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDEwOyAvLyB+MTggZGVncmVlcyBmb3J3YXJkCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnBvc2l0aW9uLnNldCgxMiwgOCwgMCk7IC8vIE9mZnNldCBzb3VyY2UgdG8gaGl0IGFyZW5hIGNlbnRlcgogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNvbnRhaW5lcik7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSAxMDA7IAogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5tZXNoKTsKCiAgICAgICAgICAgIC8vIEFkZCBhIHNlY29uZCBsYXllciBmb3IgY29yZSBpbnRlbnNpdHkKICAgICAgICAgICAgY29uc3QgY29yZUdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEyLCA4LCA5MCwgMTYsIDEsIHRydWUpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoID0gbmV3IFRIUkVFLk1lc2goY29yZUdlbywgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoLnJlbmRlck9yZGVyID0gMTAwOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jb3JlTWVzaCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExhenkgbG9hZCB0ZXh0dXJlCiAgICAgICAgICAgIGlmICghdGhpcy51bmlmb3Jtcy50Tm9pc2UudmFsdWUgJiYgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnROb2lzZS52YWx1ZSA9IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZTsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3cmFwcGluZyBpcyBjb3JyZWN0IGZvciB0aGUgY3lsaW5kZXIgVVZzCiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZS53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbG93bHkgcm90YXRlIHNoYWZ0cyBmb3IgZHluYW1pYyBmZWVsCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC5yb3RhdGlvbi55ICs9IGR0ICogMC4wMjsKICAgICAgICAgICAgaWYgKHRoaXMuY29yZU1lc2gpIHRoaXMuY29yZU1lc2gucm90YXRpb24ueSAtPSBkdCAqIDAuMDM7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkxpZ2h0U2hhZnRzID0gTGlnaHRTaGFmdHM7Cn0pKCk7","/LightShafts.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBMaWdodFNoYWZ0cyB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgIHROb2lzZTogeyB2YWx1ZTogbnVsbCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9pbml0KCk7CiAgICAgICAgfQoKX2luaXQoKSB7CiAgICAgICAgICAgIC8vIEdlb21ldHJ5OiBBIGNsdXN0ZXIgb2YgY29uZXMvY3lsaW5kZXJzCiAgICAgICAgICAgIC8vIFdlIHVzZSBhIHNpbmdsZSBnZW9tZXRyeSB3aXRoIGluc3RhbmNpbmcgb3IgbWVyZ2VkIGdlb21ldHJ5IGZvciBwZXJmb3JtYW5jZSwKICAgICAgICAgICAgLy8gYnV0IGZvciBzaW1wbGljaXR5IGFuZCBhZXN0aGV0aWMgY29udHJvbCwgbGV0J3MgdXNlIGEgZmV3IGxhcmdlIHBsYW5lcyBvciBhIGN5bGluZGVyLgogICAgICAgICAgICAvLyBBIGxhcmdlIGN5bGluZGVyIHdpdGggb3BlbiBlbmRzIHdvcmtzIHdlbGwgZm9yIGEgInBvb2wiIHNoYWZ0IGVmZmVjdC4KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluY3JlYXNlZCBsZW5ndGggdG8gOTAgdG8gYWNjb21tb2RhdGUgdGlsdCB3aXRob3V0IGNsaXBwaW5nIHRvcC9ib3R0b20KICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgzMCwgMjAsIDkwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaGFkZXIKICAgICAgICAgICAgY29uc3QgdmVydCA9IGAKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdlBvczsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2UG9zID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3NpdGlvbiwgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIGNvbnN0IGZyYWcgPSBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdE5vaXNlOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2UG9zOwoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBmYWRlIChTb2Z0IHRvcCBhbmQgYm90dG9tKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gc21vb3Roc3RlcCgwLjAsIDAuMywgdlV2LnkpICogc21vb3Roc3RlcCgxLjAsIDAuNiwgdlV2LnkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTY3JvbGxpbmcgUmF5cwogICAgICAgICAgICAgICAgICAgIC8vIExheWVyIDE6IFNsb3csIGJyb2FkIHJheXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBuMSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZlYzIodlV2LnggKiAyLjAgKyB1VGltZSAqIDAuMDIsIHZVdi55ICogMC41IC0gdVRpbWUgKiAwLjA1KSkucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMYXllciAyOiBGYXN0LCBpbnRlcmZlcmVuY2UgcmF5cwogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4yID0gdGV4dHVyZTJEKHROb2lzZSwgdmVjMih2VXYueCAqIDMuMCAtIHVUaW1lICogMC4wMywgdlV2LnkgKiAwLjUgLSB1VGltZSAqIDAuMSkpLnI7CgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheXMgPSBuMSAqIG4yOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IGludGVuc2l0eSBzaWduaWZpY2FudGx5IChSZW1vdmVkIHBvdyB0byBwcmV2ZW50IGNydXNoaW5nKQogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogMy4wOyAKCiAgICAgICAgICAgICAgICAgICAgLy8gR2xpc3RlbmluZyBTcGFya2xlcyAoSGlnaCBmcmVxdWVuY3kgbm9pc2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BhcmtsZSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZVdiAqIHZlYzIoOC4wLCAyLjApICsgdmVjMih1VGltZSAqIDAuMSwgdVRpbWUgKiAwLjMpKS5yOwogICAgICAgICAgICAgICAgICAgIHNwYXJrbGUgPSBwb3coc3BhcmtsZSwgNS4wKSAqIDEwLjA7IC8vIFNoYXJwIHBvaW50cwoKICAgICAgICAgICAgICAgICAgICAvLyBDb2xvcjogQ3lhbi9CbHVlL1doaXRlIChCcmlnaHRlciBiYXNlKQogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKDAuNiwgMC45LCAxLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENvbWJpbmUgKEhpZ2hlciBtdWx0aXBsaWVycykKICAgICAgICAgICAgICAgICAgICBmbG9hdCBmaW5hbEFscGhhID0gKHJheXMgKiAwLjggKyBzcGFya2xlICogMC40KSAqIGFscGhhOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIERpc3RhbmNlIGZhZGUgKG9wdGlvbmFsLCBoYW5kbGVkIGJ5IGZvZyB1c3VhbGx5IGJ1dCB3ZSB3YW50IGFkZGl0aXZlKQogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGZpbmFsQWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHRoaXMudW5pZm9ybXMsCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IHZlcnQsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogZnJhZywKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBDb250YWluZXIgZm9yIHRoZSBhbmdsZSAoUmVhbGlzdGljIExpZ2h0IFNvdXJjZSkKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgLy8gQW5nbGU6IENvbWluZyBmcm9tIHRvcC1sZWZ0IChzaW11bGF0aW5nIHN1cmZhY2Ugc3VuIHBlbmV0cmF0aW5nIGRlZXAgd2F0ZXIpCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJvdGF0aW9uLnogPSBNYXRoLlBJIC8gNTsgLy8gfjM2IGRlZ3JlZXMgdGlsdAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDEwOyAvLyB+MTggZGVncmVlcyBmb3J3YXJkCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnBvc2l0aW9uLnNldCgxMiwgOCwgMCk7IC8vIE9mZnNldCBzb3VyY2UgdG8gaGl0IGFyZW5hIGNlbnRlcgogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNvbnRhaW5lcik7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSAxMDA7IAogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5tZXNoKTsKCiAgICAgICAgICAgIC8vIEFkZCBhIHNlY29uZCBsYXllciBmb3IgY29yZSBpbnRlbnNpdHkKICAgICAgICAgICAgY29uc3QgY29yZUdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEyLCA4LCA5MCwgMTYsIDEsIHRydWUpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoID0gbmV3IFRIUkVFLk1lc2goY29yZUdlbywgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoLnJlbmRlck9yZGVyID0gMTAwOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jb3JlTWVzaCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExhenkgbG9hZCB0ZXh0dXJlCiAgICAgICAgICAgIGlmICghdGhpcy51bmlmb3Jtcy50Tm9pc2UudmFsdWUgJiYgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnROb2lzZS52YWx1ZSA9IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZTsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3cmFwcGluZyBpcyBjb3JyZWN0IGZvciB0aGUgY3lsaW5kZXIgVVZzCiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZS53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbG93bHkgcm90YXRlIHNoYWZ0cyBmb3IgZHluYW1pYyBmZWVsCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC5yb3RhdGlvbi55ICs9IGR0ICogMC4wMjsKICAgICAgICAgICAgaWYgKHRoaXMuY29yZU1lc2gpIHRoaXMuY29yZU1lc2gucm90YXRpb24ueSAtPSBkdCAqIDAuMDM7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkxpZ2h0U2hhZnRzID0gTGlnaHRTaGFmdHM7Cn0pKCk7","Stadium.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFJldXNhYmxlIEdsb3cgZm9yIExpZ2h0cwogICAgY29uc3QgX2dsb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAzMik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjQsICdyZ2JhKDAsIDE3MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgNjQsIDY0KTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIGNvbnN0IF9nbG93TWF0ZXJpYWwgPSBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyAKICAgICAgICBtYXA6IF9nbG93VGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBTdGFkaXVtIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuY29udGFpbmVyKTsKCiAgICAgICAgICAgIC8vIENvbmZpZyBmb3IgIkhlcmN1bGVhbiIgc2NhbGUKLy8gQ29uZmlnIGZvciAiSGVyY3VsZWFuIiBzY2FsZQogICAgICAgICAgICB0aGlzLmNvbmZpZyA9IHsKICAgICAgICAgICAgICAgIHJhZGl1czogNjAsICAgICAgIC8vIFN0YXJ0IG91dHNpZGUgdGhlIGFyZW5hICg0OCByYWRpdXMpCiAgICAgICAgICAgICAgICB0aWVyczogNiwgICAgICAgICAvLyBOdW1iZXIgb2Ygc2VhdGluZyByaW5ncwogICAgICAgICAgICAgICAgdGllckhlaWdodDogMTIsCiAgICAgICAgICAgICAgICB0aWVyRGVwdGg6IDE1LAogICAgICAgICAgICAgICAgY3Jvd2RDb3VudDogODAwMCwgLy8gSW5jcmVhc2VkIGRlbnNpdHkKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDA4MGMxMCwgLy8gRGVlcCBkYXJrIGJsdWUvYmxhY2sKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4MDBhYWZmCiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLnJpbmdzID0gW107CiAgICAgICAgICAgIHRoaXMuY3Jvd2QgPSBudWxsOwoKdGhpcy5fYnVpbGRBcmNoaXRlY3R1cmUoKTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRDcm93ZCgpOwogICAgICAgICAgICB0aGlzLl9idWlsZEhlcmN1bGVhblJpbmdzKCk7CiAgICAgICAgICAgIHRoaXMuX2J1aWxkU3RhZGl1bUxpZ2h0cygpOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkQXJjaGl0ZWN0dXJlKCkgewogICAgICAgICAgICAvLyAxLiBUaGUgVm9pZCBCb3dsIChCYWNrZ3JvdW5kIE9jY2x1ZGVyKQogICAgICAgICAgICAvLyBNYXNzaXZlIGN5bGluZGVyIHRvIGJsb2NrIHRoZSB2b2lkCiAgICAgICAgICAgIGNvbnN0IGJvd2xHZW8gPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgxODAsIDUwLCAxMjAsIDMyLCAxLCB0cnVlKTsKICAgICAgICAgICAgY29uc3QgYm93bE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IHRoaXMuY29uZmlnLnN0cnVjdHVyZUNvbG9yLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkJhY2tTaWRlLAogICAgICAgICAgICAgICAgZm9nOiB0cnVlIAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3QgYm93bCA9IG5ldyBUSFJFRS5NZXNoKGJvd2xHZW8sIGJvd2xNYXQpOwogICAgICAgICAgICBib3dsLnBvc2l0aW9uLnkgPSAyMDsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKGJvd2wpOwoKICAgICAgICAgICAgLy8gMi4gU2VhdGluZyBUaWVycyAoQ29uY2VudHJpYyBSaW5ncykKICAgICAgICAgICAgY29uc3QgdGllck1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDExMWEyMiwgc2lkZTogVEhSRUUuRG91YmxlU2lkZSB9KTsKICAgICAgICAgICAgY29uc3QgcmltTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDA0NDY2IH0pOwoKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5jb25maWcudGllcnM7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgeSA9IChpICogdGhpcy5jb25maWcudGllckhlaWdodCkgLSAzMDsKICAgICAgICAgICAgICAgIGNvbnN0IHJJbm5lciA9IHRoaXMuY29uZmlnLnJhZGl1cyArIChpICogKHRoaXMuY29uZmlnLnRpZXJEZXB0aCAqIDAuOCkpOwogICAgICAgICAgICAgICAgY29uc3Qgck91dGVyID0gcklubmVyICsgdGhpcy5jb25maWcudGllckRlcHRoOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGbG9vciBSaW5nCiAgICAgICAgICAgICAgICBjb25zdCByaW5nR2VvID0gbmV3IFRIUkVFLlJpbmdHZW9tZXRyeShySW5uZXIsIHJPdXRlciwgNjQpOwogICAgICAgICAgICAgICAgcmluZ0dlby5yb3RhdGVYKC1NYXRoLlBJIC8gMik7CiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gocmluZ0dlbywgdGllck1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnkgPSB5OwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKG1lc2gpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBHbG93aW5nIFJpbSAoVGhlICJUZWNoIiBmZWVsKQogICAgICAgICAgICAgICAgY29uc3QgcmltR2VvID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkocklubmVyLCAwLjgsIDQsIDY0KTsKICAgICAgICAgICAgICAgIHJpbUdlby5yb3RhdGVYKE1hdGguUEkgLyAyKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJpbSA9IG5ldyBUSFJFRS5NZXNoKHJpbUdlbywgcmltTWF0KTsKICAgICAgICAgICAgICAgIHJpbS5wb3NpdGlvbi55ID0geTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBNYXNzaXZlIFBpbGxhcnMgKFRoZSAiSGVyY3VsZWFuIiBTdXBwb3J0KQogICAgICAgICAgICBjb25zdCBwaWxsYXJHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoOCwgMjAwLCA4KTsKICAgICAgICAgICAgY29uc3QgcGlsbGFyTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDUwNTA1IH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ODsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gOCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIGNvbnN0IHIgPSAxNDA7IC8vIEZhciBvdXQKICAgICAgICAgICAgICAgIGNvbnN0IG1lc2ggPSBuZXcgVEhSRUUuTWVzaChwaWxsYXJHZW8sIHBpbGxhck1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnNldChNYXRoLmNvcyhhbmdsZSkqciwgMCwgTWF0aC5zaW4oYW5nbGUpKnIpOwogICAgICAgICAgICAgICAgbWVzaC5sb29rQXQoMCwwLDApOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKG1lc2gpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2J1aWxkQ3Jvd2QoKSB7CiAgICAgICAgICAgIC8vIEluc3RhbmNlZCBNZXNoIGZvciBDcm93ZCAoTG93IFBvbHksIEhpZ2ggQ291bnQpCiAgICAgICAgICAgIC8vIFVzaW5nIGEgc2ltcGxlIHZlcnRpY2FsIHBsYW5lIHRoYXQgZmFjZXMgY2VudGVyCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDEuMiwgMi41KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIC0tLSBDUk9XRCBTSEFERVIgSU1QTEVNRU5UQVRJT04gLS0tCiAgICAgICAgICAgIC8vIEFkZCBpbnN0YW5jZS1zcGVjaWZpYyByYW5kb20gb2Zmc2V0IGZvciBhbmltYXRpb24gdmFyaWF0aW9uCiAgICAgICAgICAgIGNvbnN0IG9mZnNldHMgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuY29uZmlnLmNyb3dkQ291bnQpOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLmNvbmZpZy5jcm93ZENvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIG9mZnNldHNbaV0gPSBNYXRoLnJhbmRvbSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ2FPZmZzZXQnLCBuZXcgVEhSRUUuSW5zdGFuY2VkQnVmZmVyQXR0cmlidXRlKG9mZnNldHMsIDEpKTsKCiAgICAgICAgICAgIC8vIEN1c3RvbSBTaGFkZXIgdmlhIG9uQmVmb3JlQ29tcGlsZQogICAgICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgbWF0Lm9uQmVmb3JlQ29tcGlsZSA9IChzaGFkZXIpID0+IHsKICAgICAgICAgICAgICAgIHNoYWRlci51bmlmb3Jtcy51VGltZSA9IHsgdmFsdWU6IDAgfTsKICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2RVbmlmb3JtcyA9IHNoYWRlci51bmlmb3JtczsKCiAgICAgICAgICAgICAgICBzaGFkZXIudmVydGV4U2hhZGVyID0gYAogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVRpbWU7CiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IGFPZmZzZXQ7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2SnVtcDsgLy8gUGFzcyB0byBmcmFnbWVudCBmb3IgY29sb3IgdmFyaWF0aW9uCiAgICAgICAgICAgICAgICBgICsgc2hhZGVyLnZlcnRleFNoYWRlcjsKCiAgICAgICAgICAgICAgICBzaGFkZXIudmVydGV4U2hhZGVyID0gc2hhZGVyLnZlcnRleFNoYWRlci5yZXBsYWNlKAogICAgICAgICAgICAgICAgICAgICcjaW5jbHVkZSA8YmVnaW5fdmVydGV4PicsCiAgICAgICAgICAgICAgICAgICAgYAogICAgICAgICAgICAgICAgICAgICNpbmNsdWRlIDxiZWdpbl92ZXJ0ZXg+CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uIExvZ2ljCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BlZWQgPSA4LjA7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdCA9IHVUaW1lICogc3BlZWQgKyAoYU9mZnNldCAqIDEwMC4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBKdW1wIChTaW5lIHdhdmUgY2xpcHBlZCkKICAgICAgICAgICAgICAgICAgICBmbG9hdCBqdW1wID0gbWF4KDAuMCwgc2luKHQpKTsKICAgICAgICAgICAgICAgICAgICBqdW1wID0gcG93KGp1bXAsIDIuMCk7IC8vIFNoYXJwZW4gdGhlIGp1bXAgY3VydmUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSYW5kb21pemUganVtcCBoZWlnaHQgc2xpZ2h0bHkKICAgICAgICAgICAgICAgICAgICBmbG9hdCBoZWlnaHQgPSAwLjUgKyAwLjUgKiBhT2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVkLnkgKz0ganVtcCAqIGhlaWdodDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTd2F5IChTaWRlIHRvIHNpZGUpCiAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtZWQueCArPSBjb3ModCAqIDAuNSkgKiAwLjE7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdkp1bXAgPSBqdW1wOwogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgc2hhZGVyLmZyYWdtZW50U2hhZGVyID0gYAogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkp1bXA7CiAgICAgICAgICAgICAgICBgICsgc2hhZGVyLmZyYWdtZW50U2hhZGVyOwoKICAgICAgICAgICAgICAgIHNoYWRlci5mcmFnbWVudFNoYWRlciA9IHNoYWRlci5mcmFnbWVudFNoYWRlci5yZXBsYWNlKAogICAgICAgICAgICAgICAgICAgICd2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIG9wYWNpdHkgKTsnLAogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICAgICB2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIG9wYWNpdHkgKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBCcmlnaHRlbiB3aGVuIGp1bXBpbmcgKENoZWVyaW5nIGVmZmVjdCkKICAgICAgICAgICAgICAgICAgICBkaWZmdXNlQ29sb3IucmdiICs9IHZlYzMoMC4yKSAqIHZKdW1wOwogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAp0aGlzLmNyb3dkID0gbmV3IFRIUkVFLkluc3RhbmNlZE1lc2goZ2VvLCBtYXQsIHRoaXMuY29uZmlnLmNyb3dkQ291bnQpOwogICAgICAgICAgICB0aGlzLmNyb3dkLmluc3RhbmNlTWF0cml4LnNldFVzYWdlKFRIUkVFLkR5bmFtaWNEcmF3VXNhZ2UpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBFbmFibGUgY3VsbGluZyBhbmQgbWFudWFsbHkgc2V0IGJvdW5kaW5nIHNwaGVyZSB0byBjb3ZlciB0aGUgd2hvbGUgc3RhZGl1bQogICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIEdQVSBmcm9tIHByb2Nlc3NpbmcgMjUwMCBpbnN0YW5jZXMgd2hlbiB0aGUgZW50aXJlIHN0cnVjdHVyZSBpcyBvdXQgb2YgdmlldwogICAgICAgICAgICB0aGlzLmNyb3dkLmZydXN0dW1DdWxsZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmNyb3dkLmdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlID0gbmV3IFRIUkVFLlNwaGVyZShuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKSwgMTUwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGR1bW15ID0gbmV3IFRIUkVFLk9iamVjdDNEKCk7CiAgICAgICAgICAgIGNvbnN0IGNvbG9yID0gbmV3IFRIUkVFLkNvbG9yKCk7CiAgICAgICAgICAgIAovLyAxLiBDYWxjdWxhdGUgVG90YWwgQ2lyY3VtZmVyZW5jZSBmb3IgZGlzdHJpYnV0aW9uIHRvIGVuc3VyZSBhbGwgdGllcnMgZ2V0IHBlb3BsZQogICAgICAgICAgICBsZXQgdG90YWxDaXJjID0gMDsKICAgICAgICAgICAgY29uc3QgdGllclJhZGlpID0gW107CiAgICAgICAgICAgIGZvcihsZXQgdD0wOyB0PHRoaXMuY29uZmlnLnRpZXJzOyB0KyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJNaW4gPSB0aGlzLmNvbmZpZy5yYWRpdXMgKyAodCAqICh0aGlzLmNvbmZpZy50aWVyRGVwdGggKiAwLjgpKSArIDI7CiAgICAgICAgICAgICAgICBjb25zdCBjaXJjID0gMiAqIE1hdGguUEkgKiByTWluOwogICAgICAgICAgICAgICAgdG90YWxDaXJjICs9IGNpcmM7CiAgICAgICAgICAgICAgICB0aWVyUmFkaWkucHVzaCh7IHJNaW46IHJNaW4sIGNpcmM6IGNpcmMgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBpZHggPSAwOwogICAgICAgICAgICBmb3IobGV0IHQ9MDsgdDx0aGlzLmNvbmZpZy50aWVyczsgdCsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB5QmFzZSA9ICh0ICogdGhpcy5jb25maWcudGllckhlaWdodCkgLSAzMDsKICAgICAgICAgICAgICAgIGNvbnN0IHsgck1pbiwgY2lyYyB9ID0gdGllclJhZGlpW3RdOwogICAgICAgICAgICAgICAgY29uc3Qgck1heCA9IHJNaW4gKyB0aGlzLmNvbmZpZy50aWVyRGVwdGggLSAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEaXN0cmlidXRlIHByb3BvcnRpb25hbGx5IHNvIHVwcGVyIHJvd3MgZG9uJ3QgZ2V0IGN1dCBvZmYKICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50UGVyVGllciA9IE1hdGguZmxvb3IodGhpcy5jb25maWcuY3Jvd2RDb3VudCAqIChjaXJjIC8gdG90YWxDaXJjKSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50UGVyVGllcjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlkeCA+PSB0aGlzLmNvbmZpZy5jcm93ZENvdW50KSBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IHJNaW4gKyBNYXRoLnJhbmRvbSgpICogKHJNYXggLSByTWluKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBkdW1teS5wb3NpdGlvbi5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguY29zKGFuZ2xlKSAqIHIsCiAgICAgICAgICAgICAgICAgICAgICAgIHlCYXNlICsgMS4yNSwgLy8gQ2VudGVyIG9mIHF1YWQKICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5zaW4oYW5nbGUpICogcgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRmFjZSBjZW50ZXIKICAgICAgICAgICAgICAgICAgICBkdW1teS5sb29rQXQoMCwgeUJhc2UsIDApOwogICAgICAgICAgICAgICAgICAgIGR1bW15LnVwZGF0ZU1hdHJpeCgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2Quc2V0TWF0cml4QXQoaWR4LCBkdW1teS5tYXRyaXgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJhbmRvbSBUZWFtIENvbG9ycyAoU2ltdWxhdGluZyBmYW5zKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhbmQgPSBNYXRoLnJhbmRvbSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChyYW5kIDwgMC40NSkgY29sb3Iuc2V0SGV4KDB4MDA4OGZmKTsgLy8gSG9tZSBCbHVlCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocmFuZCA8IDAuOSkgY29sb3Iuc2V0SGV4KDB4ZmY0NDQ0KTsgLy8gQXdheSBSZWQKICAgICAgICAgICAgICAgICAgICBlbHNlIGNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIE5ldXRyYWwvRmxhc2gKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBWYXJ5IGJyaWdodG5lc3MgZm9yIGRlcHRoCiAgICAgICAgICAgICAgICAgICAgY29sb3IubXVsdGlwbHlTY2FsYXIoMC41ICsgTWF0aC5yYW5kb20oKSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jcm93ZC5zZXRDb2xvckF0KGlkeCwgY29sb3IpOwogICAgICAgICAgICAgICAgICAgIGlkeCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jcm93ZCk7CiAgICAgICAgfQoKICAgICAgICBfYnVpbGRIZXJjdWxlYW5SaW5ncygpIHsKICAgICAgICAgICAgLy8gTWFzc2l2ZSBmbG9hdGluZyByaW5ncyB0aGF0IHJvdGF0ZSBzbG93bHkKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgCiAgICAgICAgICAgICAgICBjb2xvcjogMHg0NDU1NjYsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC4zLAogICAgICAgICAgICAgICAgd2lyZWZyYW1lOiB0cnVlIC8vIFRlY2gvSG9sb2dyYXBoaWMgZmVlbAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIDEuIEVxdWF0b3JpYWwgUmluZyAoTWFzc2l2ZSkKICAgICAgICAgICAgY29uc3QgZ2VvMSA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KDExMCwgMSwgMTYsIDEwMCk7CiAgICAgICAgICAgIGNvbnN0IHJpbmcxID0gbmV3IFRIUkVFLk1lc2goZ2VvMSwgbWF0KTsKICAgICAgICAgICAgcmluZzEucm90YXRpb24ueCA9IE1hdGguUEkgLyAyOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQocmluZzEpOwogICAgICAgICAgICB0aGlzLnJpbmdzLnB1c2goeyBtZXNoOiByaW5nMSwgYXhpczogJ3onLCBzcGVlZDogMC4wMSB9KTsKCiAgICAgICAgICAgIC8vIDIuIFRpbHRlZCBSaW5nCiAgICAgICAgICAgIGNvbnN0IGdlbzIgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxMzAsIDIsIDE2LCAxMDApOwogICAgICAgICAgICBjb25zdCByaW5nMiA9IG5ldyBUSFJFRS5NZXNoKGdlbzIsIG1hdCk7CiAgICAgICAgICAgIHJpbmcyLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMzsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmcyKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzIsIGF4aXM6ICd5Jywgc3BlZWQ6IC0wLjAwOCB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDMuIFZlcnRpY2FsIFJpbmcKICAgICAgICAgICAgY29uc3QgZ2VvMyA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KDE1MCwgMywgMTYsIDEwMCk7CmNvbnN0IHJpbmczID0gbmV3IFRIUkVFLk1lc2goZ2VvMywgbWF0KTsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmczKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzMsIGF4aXM6ICd5Jywgc3BlZWQ6IDAuMDA1IH0pOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkU3RhZGl1bUxpZ2h0cygpIHsKICAgICAgICAgICAgY29uc3QgY291bnQgPSAxNjsgLy8gTnVtYmVyIG9mIGxpZ2h0cyBhcm91bmQgdGhlIGVxdWF0b3IKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gMzY7IC8vIEp1c3Qgb3V0c2lkZSB0aGUgYXJlbmEgYm91bmRhcnkgKDMyKQogICAgICAgICAgICBjb25zdCB5UG9zID0gMDsgLy8gTWlkZGxlIG9mIHRoZSBzcGhlcmUKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGxpZ2h0R2VvID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDAuNCwgOCwgOCk7CiAgICAgICAgICAgIGNvbnN0IGxpZ2h0TWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZmZmIH0pOwoKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8Y291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIGNvdW50KSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IE1hdGguY29zKGFuZ2xlKSAqIHJhZGl1czsKICAgICAgICAgICAgICAgIGNvbnN0IHogPSBNYXRoLnNpbihhbmdsZSkgKiByYWRpdXM7CgogICAgICAgICAgICAgICAgLy8gMS4gUGh5c2ljYWwgRml4dHVyZSAoVGhlIGJ1bGIpCiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gobGlnaHRHZW8sIGxpZ2h0TWF0KTsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24uc2V0KHgsIHlQb3MsIHopOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKG1lc2gpOwoKICAgICAgICAgICAgICAgIC8vIDIuIFZpc3VhbCBHbG93IChGbGFyZSkKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUoX2dsb3dNYXRlcmlhbCk7CiAgICAgICAgICAgICAgICBzcHJpdGUucG9zaXRpb24uc2V0KHgsIHlQb3MsIHopOwogICAgICAgICAgICAgICAgc3ByaXRlLnNjYWxlLnNldCg4LCA4LCAxKTsgLy8gTGFyZ2UgZ2xvdwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHNwcml0ZSk7CgovLyAzLiBBY3R1YWwgUG9pbnQgTGlnaHQgLSBSRU1PVkVEIGZvciBvcHRpbWl6YXRpb24KICAgICAgICAgICAgICAgIC8vIFNpbmNlIHdlIHVzZSBNZXNoQmFzaWNNYXRlcmlhbCAoVW5saXQpLCByZWFsIGxpZ2h0cyB3YXN0ZSBDUFUvR1BVIHJlc291cmNlcy4KICAgICAgICAgICAgICAgIC8vIFRoZSBzcHJpdGUgZ2xvdyBhYm92ZSBwcm92aWRlcyB0aGUgdmlzdWFsIGVmZmVjdC4KICAgICAgICAgICAgfQogICAgICAgIH0KdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIEFuaW1hdGUgUmluZ3MKdGhpcy5yaW5ncy5mb3JFYWNoKHIgPT4gewogICAgICAgICAgICAgICAgaWYgKHIubWVzaCAmJiByLmF4aXMpIHsKICAgICAgICAgICAgICAgICAgICByLm1lc2gucm90YXRpb25bci5heGlzXSArPSByLnNwZWVkICogZHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gVXBkYXRlIENyb3dkIFNoYWRlcgogICAgICAgICAgICBpZiAodGhpcy5jcm93ZFVuaWZvcm1zKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNyb3dkVW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguU3RhZGl1bSA9IFN0YWRpdW07Cn0pKCk7","./Stadium.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFJldXNhYmxlIEdsb3cgZm9yIExpZ2h0cwogICAgY29uc3QgX2dsb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAzMik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjQsICdyZ2JhKDAsIDE3MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgNjQsIDY0KTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIGNvbnN0IF9nbG93TWF0ZXJpYWwgPSBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyAKICAgICAgICBtYXA6IF9nbG93VGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBTdGFkaXVtIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuY29udGFpbmVyKTsKCiAgICAgICAgICAgIC8vIENvbmZpZyBmb3IgIkhlcmN1bGVhbiIgc2NhbGUKLy8gQ29uZmlnIGZvciAiSGVyY3VsZWFuIiBzY2FsZQogICAgICAgICAgICB0aGlzLmNvbmZpZyA9IHsKICAgICAgICAgICAgICAgIHJhZGl1czogNjAsICAgICAgIC8vIFN0YXJ0IG91dHNpZGUgdGhlIGFyZW5hICg0OCByYWRpdXMpCiAgICAgICAgICAgICAgICB0aWVyczogNiwgICAgICAgICAvLyBOdW1iZXIgb2Ygc2VhdGluZyByaW5ncwogICAgICAgICAgICAgICAgdGllckhlaWdodDogMTIsCiAgICAgICAgICAgICAgICB0aWVyRGVwdGg6IDE1LAogICAgICAgICAgICAgICAgY3Jvd2RDb3VudDogODAwMCwgLy8gSW5jcmVhc2VkIGRlbnNpdHkKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDA4MGMxMCwgLy8gRGVlcCBkYXJrIGJsdWUvYmxhY2sKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4MDBhYWZmCiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLnJpbmdzID0gW107CiAgICAgICAgICAgIHRoaXMuY3Jvd2QgPSBudWxsOwoKdGhpcy5fYnVpbGRBcmNoaXRlY3R1cmUoKTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRDcm93ZCgpOwogICAgICAgICAgICB0aGlzLl9idWlsZEhlcmN1bGVhblJpbmdzKCk7CiAgICAgICAgICAgIHRoaXMuX2J1aWxkU3RhZGl1bUxpZ2h0cygpOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkQXJjaGl0ZWN0dXJlKCkgewogICAgICAgICAgICAvLyAxLiBUaGUgVm9pZCBCb3dsIChCYWNrZ3JvdW5kIE9jY2x1ZGVyKQogICAgICAgICAgICAvLyBNYXNzaXZlIGN5bGluZGVyIHRvIGJsb2NrIHRoZSB2b2lkCiAgICAgICAgICAgIGNvbnN0IGJvd2xHZW8gPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgxODAsIDUwLCAxMjAsIDMyLCAxLCB0cnVlKTsKICAgICAgICAgICAgY29uc3QgYm93bE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IHRoaXMuY29uZmlnLnN0cnVjdHVyZUNvbG9yLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkJhY2tTaWRlLAogICAgICAgICAgICAgICAgZm9nOiB0cnVlIAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3QgYm93bCA9IG5ldyBUSFJFRS5NZXNoKGJvd2xHZW8sIGJvd2xNYXQpOwogICAgICAgICAgICBib3dsLnBvc2l0aW9uLnkgPSAyMDsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKGJvd2wpOwoKICAgICAgICAgICAgLy8gMi4gU2VhdGluZyBUaWVycyAoQ29uY2VudHJpYyBSaW5ncykKICAgICAgICAgICAgY29uc3QgdGllck1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDExMWEyMiwgc2lkZTogVEhSRUUuRG91YmxlU2lkZSB9KTsKICAgICAgICAgICAgY29uc3QgcmltTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDA0NDY2IH0pOwoKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5jb25maWcudGllcnM7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgeSA9IChpICogdGhpcy5jb25maWcudGllckhlaWdodCkgLSAzMDsKICAgICAgICAgICAgICAgIGNvbnN0IHJJbm5lciA9IHRoaXMuY29uZmlnLnJhZGl1cyArIChpICogKHRoaXMuY29uZmlnLnRpZXJEZXB0aCAqIDAuOCkpOwogICAgICAgICAgICAgICAgY29uc3Qgck91dGVyID0gcklubmVyICsgdGhpcy5jb25maWcudGllckRlcHRoOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGbG9vciBSaW5nCiAgICAgICAgICAgICAgICBjb25zdCByaW5nR2VvID0gbmV3IFRIUkVFLlJpbmdHZW9tZXRyeShySW5uZXIsIHJPdXRlciwgNjQpOwogICAgICAgICAgICAgICAgcmluZ0dlby5yb3RhdGVYKC1NYXRoLlBJIC8gMik7CiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gocmluZ0dlbywgdGllck1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnkgPSB5OwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKG1lc2gpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBHbG93aW5nIFJpbSAoVGhlICJUZWNoIiBmZWVsKQogICAgICAgICAgICAgICAgY29uc3QgcmltR2VvID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkocklubmVyLCAwLjgsIDQsIDY0KTsKICAgICAgICAgICAgICAgIHJpbUdlby5yb3RhdGVYKE1hdGguUEkgLyAyKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJpbSA9IG5ldyBUSFJFRS5NZXNoKHJpbUdlbywgcmltTWF0KTsKICAgICAgICAgICAgICAgIHJpbS5wb3NpdGlvbi55ID0geTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBNYXNzaXZlIFBpbGxhcnMgKFRoZSAiSGVyY3VsZWFuIiBTdXBwb3J0KQogICAgICAgICAgICBjb25zdCBwaWxsYXJHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoOCwgMjAwLCA4KTsKICAgICAgICAgICAgY29uc3QgcGlsbGFyTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDUwNTA1IH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ODsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gOCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIGNvbnN0IHIgPSAxNDA7IC8vIEZhciBvdXQKICAgICAgICAgICAgICAgIGNvbnN0IG1lc2ggPSBuZXcgVEhSRUUuTWVzaChwaWxsYXJHZW8sIHBpbGxhck1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnNldChNYXRoLmNvcyhhbmdsZSkqciwgMCwgTWF0aC5zaW4oYW5nbGUpKnIpOwogICAgICAgICAgICAgICAgbWVzaC5sb29rQXQoMCwwLDApOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKG1lc2gpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2J1aWxkQ3Jvd2QoKSB7CiAgICAgICAgICAgIC8vIEluc3RhbmNlZCBNZXNoIGZvciBDcm93ZCAoTG93IFBvbHksIEhpZ2ggQ291bnQpCiAgICAgICAgICAgIC8vIFVzaW5nIGEgc2ltcGxlIHZlcnRpY2FsIHBsYW5lIHRoYXQgZmFjZXMgY2VudGVyCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDEuMiwgMi41KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIC0tLSBDUk9XRCBTSEFERVIgSU1QTEVNRU5UQVRJT04gLS0tCiAgICAgICAgICAgIC8vIEFkZCBpbnN0YW5jZS1zcGVjaWZpYyByYW5kb20gb2Zmc2V0IGZvciBhbmltYXRpb24gdmFyaWF0aW9uCiAgICAgICAgICAgIGNvbnN0IG9mZnNldHMgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuY29uZmlnLmNyb3dkQ291bnQpOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLmNvbmZpZy5jcm93ZENvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIG9mZnNldHNbaV0gPSBNYXRoLnJhbmRvbSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ2FPZmZzZXQnLCBuZXcgVEhSRUUuSW5zdGFuY2VkQnVmZmVyQXR0cmlidXRlKG9mZnNldHMsIDEpKTsKCiAgICAgICAgICAgIC8vIEN1c3RvbSBTaGFkZXIgdmlhIG9uQmVmb3JlQ29tcGlsZQogICAgICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgbWF0Lm9uQmVmb3JlQ29tcGlsZSA9IChzaGFkZXIpID0+IHsKICAgICAgICAgICAgICAgIHNoYWRlci51bmlmb3Jtcy51VGltZSA9IHsgdmFsdWU6IDAgfTsKICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2RVbmlmb3JtcyA9IHNoYWRlci51bmlmb3JtczsKCiAgICAgICAgICAgICAgICBzaGFkZXIudmVydGV4U2hhZGVyID0gYAogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVRpbWU7CiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IGFPZmZzZXQ7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2SnVtcDsgLy8gUGFzcyB0byBmcmFnbWVudCBmb3IgY29sb3IgdmFyaWF0aW9uCiAgICAgICAgICAgICAgICBgICsgc2hhZGVyLnZlcnRleFNoYWRlcjsKCiAgICAgICAgICAgICAgICBzaGFkZXIudmVydGV4U2hhZGVyID0gc2hhZGVyLnZlcnRleFNoYWRlci5yZXBsYWNlKAogICAgICAgICAgICAgICAgICAgICcjaW5jbHVkZSA8YmVnaW5fdmVydGV4PicsCiAgICAgICAgICAgICAgICAgICAgYAogICAgICAgICAgICAgICAgICAgICNpbmNsdWRlIDxiZWdpbl92ZXJ0ZXg+CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uIExvZ2ljCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BlZWQgPSA4LjA7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdCA9IHVUaW1lICogc3BlZWQgKyAoYU9mZnNldCAqIDEwMC4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBKdW1wIChTaW5lIHdhdmUgY2xpcHBlZCkKICAgICAgICAgICAgICAgICAgICBmbG9hdCBqdW1wID0gbWF4KDAuMCwgc2luKHQpKTsKICAgICAgICAgICAgICAgICAgICBqdW1wID0gcG93KGp1bXAsIDIuMCk7IC8vIFNoYXJwZW4gdGhlIGp1bXAgY3VydmUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSYW5kb21pemUganVtcCBoZWlnaHQgc2xpZ2h0bHkKICAgICAgICAgICAgICAgICAgICBmbG9hdCBoZWlnaHQgPSAwLjUgKyAwLjUgKiBhT2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVkLnkgKz0ganVtcCAqIGhlaWdodDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTd2F5IChTaWRlIHRvIHNpZGUpCiAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtZWQueCArPSBjb3ModCAqIDAuNSkgKiAwLjE7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdkp1bXAgPSBqdW1wOwogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgc2hhZGVyLmZyYWdtZW50U2hhZGVyID0gYAogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkp1bXA7CiAgICAgICAgICAgICAgICBgICsgc2hhZGVyLmZyYWdtZW50U2hhZGVyOwoKICAgICAgICAgICAgICAgIHNoYWRlci5mcmFnbWVudFNoYWRlciA9IHNoYWRlci5mcmFnbWVudFNoYWRlci5yZXBsYWNlKAogICAgICAgICAgICAgICAgICAgICd2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIG9wYWNpdHkgKTsnLAogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICAgICB2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIG9wYWNpdHkgKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBCcmlnaHRlbiB3aGVuIGp1bXBpbmcgKENoZWVyaW5nIGVmZmVjdCkKICAgICAgICAgICAgICAgICAgICBkaWZmdXNlQ29sb3IucmdiICs9IHZlYzMoMC4yKSAqIHZKdW1wOwogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAp0aGlzLmNyb3dkID0gbmV3IFRIUkVFLkluc3RhbmNlZE1lc2goZ2VvLCBtYXQsIHRoaXMuY29uZmlnLmNyb3dkQ291bnQpOwogICAgICAgICAgICB0aGlzLmNyb3dkLmluc3RhbmNlTWF0cml4LnNldFVzYWdlKFRIUkVFLkR5bmFtaWNEcmF3VXNhZ2UpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBFbmFibGUgY3VsbGluZyBhbmQgbWFudWFsbHkgc2V0IGJvdW5kaW5nIHNwaGVyZSB0byBjb3ZlciB0aGUgd2hvbGUgc3RhZGl1bQogICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIEdQVSBmcm9tIHByb2Nlc3NpbmcgMjUwMCBpbnN0YW5jZXMgd2hlbiB0aGUgZW50aXJlIHN0cnVjdHVyZSBpcyBvdXQgb2YgdmlldwogICAgICAgICAgICB0aGlzLmNyb3dkLmZydXN0dW1DdWxsZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmNyb3dkLmdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlID0gbmV3IFRIUkVFLlNwaGVyZShuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKSwgMTUwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGR1bW15ID0gbmV3IFRIUkVFLk9iamVjdDNEKCk7CiAgICAgICAgICAgIGNvbnN0IGNvbG9yID0gbmV3IFRIUkVFLkNvbG9yKCk7CiAgICAgICAgICAgIAovLyAxLiBDYWxjdWxhdGUgVG90YWwgQ2lyY3VtZmVyZW5jZSBmb3IgZGlzdHJpYnV0aW9uIHRvIGVuc3VyZSBhbGwgdGllcnMgZ2V0IHBlb3BsZQogICAgICAgICAgICBsZXQgdG90YWxDaXJjID0gMDsKICAgICAgICAgICAgY29uc3QgdGllclJhZGlpID0gW107CiAgICAgICAgICAgIGZvcihsZXQgdD0wOyB0PHRoaXMuY29uZmlnLnRpZXJzOyB0KyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJNaW4gPSB0aGlzLmNvbmZpZy5yYWRpdXMgKyAodCAqICh0aGlzLmNvbmZpZy50aWVyRGVwdGggKiAwLjgpKSArIDI7CiAgICAgICAgICAgICAgICBjb25zdCBjaXJjID0gMiAqIE1hdGguUEkgKiByTWluOwogICAgICAgICAgICAgICAgdG90YWxDaXJjICs9IGNpcmM7CiAgICAgICAgICAgICAgICB0aWVyUmFkaWkucHVzaCh7IHJNaW46IHJNaW4sIGNpcmM6IGNpcmMgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBpZHggPSAwOwogICAgICAgICAgICBmb3IobGV0IHQ9MDsgdDx0aGlzLmNvbmZpZy50aWVyczsgdCsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB5QmFzZSA9ICh0ICogdGhpcy5jb25maWcudGllckhlaWdodCkgLSAzMDsKICAgICAgICAgICAgICAgIGNvbnN0IHsgck1pbiwgY2lyYyB9ID0gdGllclJhZGlpW3RdOwogICAgICAgICAgICAgICAgY29uc3Qgck1heCA9IHJNaW4gKyB0aGlzLmNvbmZpZy50aWVyRGVwdGggLSAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEaXN0cmlidXRlIHByb3BvcnRpb25hbGx5IHNvIHVwcGVyIHJvd3MgZG9uJ3QgZ2V0IGN1dCBvZmYKICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50UGVyVGllciA9IE1hdGguZmxvb3IodGhpcy5jb25maWcuY3Jvd2RDb3VudCAqIChjaXJjIC8gdG90YWxDaXJjKSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50UGVyVGllcjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlkeCA+PSB0aGlzLmNvbmZpZy5jcm93ZENvdW50KSBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IHJNaW4gKyBNYXRoLnJhbmRvbSgpICogKHJNYXggLSByTWluKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBkdW1teS5wb3NpdGlvbi5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguY29zKGFuZ2xlKSAqIHIsCiAgICAgICAgICAgICAgICAgICAgICAgIHlCYXNlICsgMS4yNSwgLy8gQ2VudGVyIG9mIHF1YWQKICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5zaW4oYW5nbGUpICogcgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRmFjZSBjZW50ZXIKICAgICAgICAgICAgICAgICAgICBkdW1teS5sb29rQXQoMCwgeUJhc2UsIDApOwogICAgICAgICAgICAgICAgICAgIGR1bW15LnVwZGF0ZU1hdHJpeCgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2Quc2V0TWF0cml4QXQoaWR4LCBkdW1teS5tYXRyaXgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJhbmRvbSBUZWFtIENvbG9ycyAoU2ltdWxhdGluZyBmYW5zKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhbmQgPSBNYXRoLnJhbmRvbSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChyYW5kIDwgMC40NSkgY29sb3Iuc2V0SGV4KDB4MDA4OGZmKTsgLy8gSG9tZSBCbHVlCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocmFuZCA8IDAuOSkgY29sb3Iuc2V0SGV4KDB4ZmY0NDQ0KTsgLy8gQXdheSBSZWQKICAgICAgICAgICAgICAgICAgICBlbHNlIGNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIE5ldXRyYWwvRmxhc2gKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBWYXJ5IGJyaWdodG5lc3MgZm9yIGRlcHRoCiAgICAgICAgICAgICAgICAgICAgY29sb3IubXVsdGlwbHlTY2FsYXIoMC41ICsgTWF0aC5yYW5kb20oKSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jcm93ZC5zZXRDb2xvckF0KGlkeCwgY29sb3IpOwogICAgICAgICAgICAgICAgICAgIGlkeCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jcm93ZCk7CiAgICAgICAgfQoKICAgICAgICBfYnVpbGRIZXJjdWxlYW5SaW5ncygpIHsKICAgICAgICAgICAgLy8gTWFzc2l2ZSBmbG9hdGluZyByaW5ncyB0aGF0IHJvdGF0ZSBzbG93bHkKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgCiAgICAgICAgICAgICAgICBjb2xvcjogMHg0NDU1NjYsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC4zLAogICAgICAgICAgICAgICAgd2lyZWZyYW1lOiB0cnVlIC8vIFRlY2gvSG9sb2dyYXBoaWMgZmVlbAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIDEuIEVxdWF0b3JpYWwgUmluZyAoTWFzc2l2ZSkKICAgICAgICAgICAgY29uc3QgZ2VvMSA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KDExMCwgMSwgMTYsIDEwMCk7CiAgICAgICAgICAgIGNvbnN0IHJpbmcxID0gbmV3IFRIUkVFLk1lc2goZ2VvMSwgbWF0KTsKICAgICAgICAgICAgcmluZzEucm90YXRpb24ueCA9IE1hdGguUEkgLyAyOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQocmluZzEpOwogICAgICAgICAgICB0aGlzLnJpbmdzLnB1c2goeyBtZXNoOiByaW5nMSwgYXhpczogJ3onLCBzcGVlZDogMC4wMSB9KTsKCiAgICAgICAgICAgIC8vIDIuIFRpbHRlZCBSaW5nCiAgICAgICAgICAgIGNvbnN0IGdlbzIgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxMzAsIDIsIDE2LCAxMDApOwogICAgICAgICAgICBjb25zdCByaW5nMiA9IG5ldyBUSFJFRS5NZXNoKGdlbzIsIG1hdCk7CiAgICAgICAgICAgIHJpbmcyLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMzsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmcyKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzIsIGF4aXM6ICd5Jywgc3BlZWQ6IC0wLjAwOCB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDMuIFZlcnRpY2FsIFJpbmcKICAgICAgICAgICAgY29uc3QgZ2VvMyA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KDE1MCwgMywgMTYsIDEwMCk7CmNvbnN0IHJpbmczID0gbmV3IFRIUkVFLk1lc2goZ2VvMywgbWF0KTsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmczKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzMsIGF4aXM6ICd5Jywgc3BlZWQ6IDAuMDA1IH0pOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkU3RhZGl1bUxpZ2h0cygpIHsKICAgICAgICAgICAgY29uc3QgY291bnQgPSAxNjsgLy8gTnVtYmVyIG9mIGxpZ2h0cyBhcm91bmQgdGhlIGVxdWF0b3IKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gMzY7IC8vIEp1c3Qgb3V0c2lkZSB0aGUgYXJlbmEgYm91bmRhcnkgKDMyKQogICAgICAgICAgICBjb25zdCB5UG9zID0gMDsgLy8gTWlkZGxlIG9mIHRoZSBzcGhlcmUKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGxpZ2h0R2VvID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDAuNCwgOCwgOCk7CiAgICAgICAgICAgIGNvbnN0IGxpZ2h0TWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZmZmIH0pOwoKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8Y291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIGNvdW50KSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IE1hdGguY29zKGFuZ2xlKSAqIHJhZGl1czsKICAgICAgICAgICAgICAgIGNvbnN0IHogPSBNYXRoLnNpbihhbmdsZSkgKiByYWRpdXM7CgogICAgICAgICAgICAgICAgLy8gMS4gUGh5c2ljYWwgRml4dHVyZSAoVGhlIGJ1bGIpCiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gobGlnaHRHZW8sIGxpZ2h0TWF0KTsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24uc2V0KHgsIHlQb3MsIHopOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKG1lc2gpOwoKICAgICAgICAgICAgICAgIC8vIDIuIFZpc3VhbCBHbG93IChGbGFyZSkKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUoX2dsb3dNYXRlcmlhbCk7CiAgICAgICAgICAgICAgICBzcHJpdGUucG9zaXRpb24uc2V0KHgsIHlQb3MsIHopOwogICAgICAgICAgICAgICAgc3ByaXRlLnNjYWxlLnNldCg4LCA4LCAxKTsgLy8gTGFyZ2UgZ2xvdwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHNwcml0ZSk7CgovLyAzLiBBY3R1YWwgUG9pbnQgTGlnaHQgLSBSRU1PVkVEIGZvciBvcHRpbWl6YXRpb24KICAgICAgICAgICAgICAgIC8vIFNpbmNlIHdlIHVzZSBNZXNoQmFzaWNNYXRlcmlhbCAoVW5saXQpLCByZWFsIGxpZ2h0cyB3YXN0ZSBDUFUvR1BVIHJlc291cmNlcy4KICAgICAgICAgICAgICAgIC8vIFRoZSBzcHJpdGUgZ2xvdyBhYm92ZSBwcm92aWRlcyB0aGUgdmlzdWFsIGVmZmVjdC4KICAgICAgICAgICAgfQogICAgICAgIH0KdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIEFuaW1hdGUgUmluZ3MKdGhpcy5yaW5ncy5mb3JFYWNoKHIgPT4gewogICAgICAgICAgICAgICAgaWYgKHIubWVzaCAmJiByLmF4aXMpIHsKICAgICAgICAgICAgICAgICAgICByLm1lc2gucm90YXRpb25bci5heGlzXSArPSByLnNwZWVkICogZHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gVXBkYXRlIENyb3dkIFNoYWRlcgogICAgICAgICAgICBpZiAodGhpcy5jcm93ZFVuaWZvcm1zKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNyb3dkVW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguU3RhZGl1bSA9IFN0YWRpdW07Cn0pKCk7","/Stadium.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFJldXNhYmxlIEdsb3cgZm9yIExpZ2h0cwogICAgY29uc3QgX2dsb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAzMik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjQsICdyZ2JhKDAsIDE3MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgNjQsIDY0KTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIGNvbnN0IF9nbG93TWF0ZXJpYWwgPSBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyAKICAgICAgICBtYXA6IF9nbG93VGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBTdGFkaXVtIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuY29udGFpbmVyKTsKCiAgICAgICAgICAgIC8vIENvbmZpZyBmb3IgIkhlcmN1bGVhbiIgc2NhbGUKLy8gQ29uZmlnIGZvciAiSGVyY3VsZWFuIiBzY2FsZQogICAgICAgICAgICB0aGlzLmNvbmZpZyA9IHsKICAgICAgICAgICAgICAgIHJhZGl1czogNjAsICAgICAgIC8vIFN0YXJ0IG91dHNpZGUgdGhlIGFyZW5hICg0OCByYWRpdXMpCiAgICAgICAgICAgICAgICB0aWVyczogNiwgICAgICAgICAvLyBOdW1iZXIgb2Ygc2VhdGluZyByaW5ncwogICAgICAgICAgICAgICAgdGllckhlaWdodDogMTIsCiAgICAgICAgICAgICAgICB0aWVyRGVwdGg6IDE1LAogICAgICAgICAgICAgICAgY3Jvd2RDb3VudDogODAwMCwgLy8gSW5jcmVhc2VkIGRlbnNpdHkKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDA4MGMxMCwgLy8gRGVlcCBkYXJrIGJsdWUvYmxhY2sKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4MDBhYWZmCiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLnJpbmdzID0gW107CiAgICAgICAgICAgIHRoaXMuY3Jvd2QgPSBudWxsOwoKdGhpcy5fYnVpbGRBcmNoaXRlY3R1cmUoKTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRDcm93ZCgpOwogICAgICAgICAgICB0aGlzLl9idWlsZEhlcmN1bGVhblJpbmdzKCk7CiAgICAgICAgICAgIHRoaXMuX2J1aWxkU3RhZGl1bUxpZ2h0cygpOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkQXJjaGl0ZWN0dXJlKCkgewogICAgICAgICAgICAvLyAxLiBUaGUgVm9pZCBCb3dsIChCYWNrZ3JvdW5kIE9jY2x1ZGVyKQogICAgICAgICAgICAvLyBNYXNzaXZlIGN5bGluZGVyIHRvIGJsb2NrIHRoZSB2b2lkCiAgICAgICAgICAgIGNvbnN0IGJvd2xHZW8gPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgxODAsIDUwLCAxMjAsIDMyLCAxLCB0cnVlKTsKICAgICAgICAgICAgY29uc3QgYm93bE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IHRoaXMuY29uZmlnLnN0cnVjdHVyZUNvbG9yLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkJhY2tTaWRlLAogICAgICAgICAgICAgICAgZm9nOiB0cnVlIAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3QgYm93bCA9IG5ldyBUSFJFRS5NZXNoKGJvd2xHZW8sIGJvd2xNYXQpOwogICAgICAgICAgICBib3dsLnBvc2l0aW9uLnkgPSAyMDsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKGJvd2wpOwoKICAgICAgICAgICAgLy8gMi4gU2VhdGluZyBUaWVycyAoQ29uY2VudHJpYyBSaW5ncykKICAgICAgICAgICAgY29uc3QgdGllck1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDExMWEyMiwgc2lkZTogVEhSRUUuRG91YmxlU2lkZSB9KTsKICAgICAgICAgICAgY29uc3QgcmltTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDA0NDY2IH0pOwoKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5jb25maWcudGllcnM7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgeSA9IChpICogdGhpcy5jb25maWcudGllckhlaWdodCkgLSAzMDsKICAgICAgICAgICAgICAgIGNvbnN0IHJJbm5lciA9IHRoaXMuY29uZmlnLnJhZGl1cyArIChpICogKHRoaXMuY29uZmlnLnRpZXJEZXB0aCAqIDAuOCkpOwogICAgICAgICAgICAgICAgY29uc3Qgck91dGVyID0gcklubmVyICsgdGhpcy5jb25maWcudGllckRlcHRoOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGbG9vciBSaW5nCiAgICAgICAgICAgICAgICBjb25zdCByaW5nR2VvID0gbmV3IFRIUkVFLlJpbmdHZW9tZXRyeShySW5uZXIsIHJPdXRlciwgNjQpOwogICAgICAgICAgICAgICAgcmluZ0dlby5yb3RhdGVYKC1NYXRoLlBJIC8gMik7CiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gocmluZ0dlbywgdGllck1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnkgPSB5OwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKG1lc2gpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBHbG93aW5nIFJpbSAoVGhlICJUZWNoIiBmZWVsKQogICAgICAgICAgICAgICAgY29uc3QgcmltR2VvID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkocklubmVyLCAwLjgsIDQsIDY0KTsKICAgICAgICAgICAgICAgIHJpbUdlby5yb3RhdGVYKE1hdGguUEkgLyAyKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJpbSA9IG5ldyBUSFJFRS5NZXNoKHJpbUdlbywgcmltTWF0KTsKICAgICAgICAgICAgICAgIHJpbS5wb3NpdGlvbi55ID0geTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBNYXNzaXZlIFBpbGxhcnMgKFRoZSAiSGVyY3VsZWFuIiBTdXBwb3J0KQogICAgICAgICAgICBjb25zdCBwaWxsYXJHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoOCwgMjAwLCA4KTsKICAgICAgICAgICAgY29uc3QgcGlsbGFyTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDUwNTA1IH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ODsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gOCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIGNvbnN0IHIgPSAxNDA7IC8vIEZhciBvdXQKICAgICAgICAgICAgICAgIGNvbnN0IG1lc2ggPSBuZXcgVEhSRUUuTWVzaChwaWxsYXJHZW8sIHBpbGxhck1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnNldChNYXRoLmNvcyhhbmdsZSkqciwgMCwgTWF0aC5zaW4oYW5nbGUpKnIpOwogICAgICAgICAgICAgICAgbWVzaC5sb29rQXQoMCwwLDApOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKG1lc2gpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2J1aWxkQ3Jvd2QoKSB7CiAgICAgICAgICAgIC8vIEluc3RhbmNlZCBNZXNoIGZvciBDcm93ZCAoTG93IFBvbHksIEhpZ2ggQ291bnQpCiAgICAgICAgICAgIC8vIFVzaW5nIGEgc2ltcGxlIHZlcnRpY2FsIHBsYW5lIHRoYXQgZmFjZXMgY2VudGVyCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDEuMiwgMi41KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIC0tLSBDUk9XRCBTSEFERVIgSU1QTEVNRU5UQVRJT04gLS0tCiAgICAgICAgICAgIC8vIEFkZCBpbnN0YW5jZS1zcGVjaWZpYyByYW5kb20gb2Zmc2V0IGZvciBhbmltYXRpb24gdmFyaWF0aW9uCiAgICAgICAgICAgIGNvbnN0IG9mZnNldHMgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuY29uZmlnLmNyb3dkQ291bnQpOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLmNvbmZpZy5jcm93ZENvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIG9mZnNldHNbaV0gPSBNYXRoLnJhbmRvbSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ2FPZmZzZXQnLCBuZXcgVEhSRUUuSW5zdGFuY2VkQnVmZmVyQXR0cmlidXRlKG9mZnNldHMsIDEpKTsKCiAgICAgICAgICAgIC8vIEN1c3RvbSBTaGFkZXIgdmlhIG9uQmVmb3JlQ29tcGlsZQogICAgICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgbWF0Lm9uQmVmb3JlQ29tcGlsZSA9IChzaGFkZXIpID0+IHsKICAgICAgICAgICAgICAgIHNoYWRlci51bmlmb3Jtcy51VGltZSA9IHsgdmFsdWU6IDAgfTsKICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2RVbmlmb3JtcyA9IHNoYWRlci51bmlmb3JtczsKCiAgICAgICAgICAgICAgICBzaGFkZXIudmVydGV4U2hhZGVyID0gYAogICAgICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVRpbWU7CiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IGFPZmZzZXQ7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2SnVtcDsgLy8gUGFzcyB0byBmcmFnbWVudCBmb3IgY29sb3IgdmFyaWF0aW9uCiAgICAgICAgICAgICAgICBgICsgc2hhZGVyLnZlcnRleFNoYWRlcjsKCiAgICAgICAgICAgICAgICBzaGFkZXIudmVydGV4U2hhZGVyID0gc2hhZGVyLnZlcnRleFNoYWRlci5yZXBsYWNlKAogICAgICAgICAgICAgICAgICAgICcjaW5jbHVkZSA8YmVnaW5fdmVydGV4PicsCiAgICAgICAgICAgICAgICAgICAgYAogICAgICAgICAgICAgICAgICAgICNpbmNsdWRlIDxiZWdpbl92ZXJ0ZXg+CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uIExvZ2ljCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BlZWQgPSA4LjA7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdCA9IHVUaW1lICogc3BlZWQgKyAoYU9mZnNldCAqIDEwMC4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBKdW1wIChTaW5lIHdhdmUgY2xpcHBlZCkKICAgICAgICAgICAgICAgICAgICBmbG9hdCBqdW1wID0gbWF4KDAuMCwgc2luKHQpKTsKICAgICAgICAgICAgICAgICAgICBqdW1wID0gcG93KGp1bXAsIDIuMCk7IC8vIFNoYXJwZW4gdGhlIGp1bXAgY3VydmUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSYW5kb21pemUganVtcCBoZWlnaHQgc2xpZ2h0bHkKICAgICAgICAgICAgICAgICAgICBmbG9hdCBoZWlnaHQgPSAwLjUgKyAwLjUgKiBhT2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVkLnkgKz0ganVtcCAqIGhlaWdodDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTd2F5IChTaWRlIHRvIHNpZGUpCiAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtZWQueCArPSBjb3ModCAqIDAuNSkgKiAwLjE7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdkp1bXAgPSBqdW1wOwogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgc2hhZGVyLmZyYWdtZW50U2hhZGVyID0gYAogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkp1bXA7CiAgICAgICAgICAgICAgICBgICsgc2hhZGVyLmZyYWdtZW50U2hhZGVyOwoKICAgICAgICAgICAgICAgIHNoYWRlci5mcmFnbWVudFNoYWRlciA9IHNoYWRlci5mcmFnbWVudFNoYWRlci5yZXBsYWNlKAogICAgICAgICAgICAgICAgICAgICd2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIG9wYWNpdHkgKTsnLAogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICAgICB2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIG9wYWNpdHkgKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBCcmlnaHRlbiB3aGVuIGp1bXBpbmcgKENoZWVyaW5nIGVmZmVjdCkKICAgICAgICAgICAgICAgICAgICBkaWZmdXNlQ29sb3IucmdiICs9IHZlYzMoMC4yKSAqIHZKdW1wOwogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAp0aGlzLmNyb3dkID0gbmV3IFRIUkVFLkluc3RhbmNlZE1lc2goZ2VvLCBtYXQsIHRoaXMuY29uZmlnLmNyb3dkQ291bnQpOwogICAgICAgICAgICB0aGlzLmNyb3dkLmluc3RhbmNlTWF0cml4LnNldFVzYWdlKFRIUkVFLkR5bmFtaWNEcmF3VXNhZ2UpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBFbmFibGUgY3VsbGluZyBhbmQgbWFudWFsbHkgc2V0IGJvdW5kaW5nIHNwaGVyZSB0byBjb3ZlciB0aGUgd2hvbGUgc3RhZGl1bQogICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIEdQVSBmcm9tIHByb2Nlc3NpbmcgMjUwMCBpbnN0YW5jZXMgd2hlbiB0aGUgZW50aXJlIHN0cnVjdHVyZSBpcyBvdXQgb2YgdmlldwogICAgICAgICAgICB0aGlzLmNyb3dkLmZydXN0dW1DdWxsZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmNyb3dkLmdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlID0gbmV3IFRIUkVFLlNwaGVyZShuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKSwgMTUwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGR1bW15ID0gbmV3IFRIUkVFLk9iamVjdDNEKCk7CiAgICAgICAgICAgIGNvbnN0IGNvbG9yID0gbmV3IFRIUkVFLkNvbG9yKCk7CiAgICAgICAgICAgIAovLyAxLiBDYWxjdWxhdGUgVG90YWwgQ2lyY3VtZmVyZW5jZSBmb3IgZGlzdHJpYnV0aW9uIHRvIGVuc3VyZSBhbGwgdGllcnMgZ2V0IHBlb3BsZQogICAgICAgICAgICBsZXQgdG90YWxDaXJjID0gMDsKICAgICAgICAgICAgY29uc3QgdGllclJhZGlpID0gW107CiAgICAgICAgICAgIGZvcihsZXQgdD0wOyB0PHRoaXMuY29uZmlnLnRpZXJzOyB0KyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJNaW4gPSB0aGlzLmNvbmZpZy5yYWRpdXMgKyAodCAqICh0aGlzLmNvbmZpZy50aWVyRGVwdGggKiAwLjgpKSArIDI7CiAgICAgICAgICAgICAgICBjb25zdCBjaXJjID0gMiAqIE1hdGguUEkgKiByTWluOwogICAgICAgICAgICAgICAgdG90YWxDaXJjICs9IGNpcmM7CiAgICAgICAgICAgICAgICB0aWVyUmFkaWkucHVzaCh7IHJNaW46IHJNaW4sIGNpcmM6IGNpcmMgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBpZHggPSAwOwogICAgICAgICAgICBmb3IobGV0IHQ9MDsgdDx0aGlzLmNvbmZpZy50aWVyczsgdCsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB5QmFzZSA9ICh0ICogdGhpcy5jb25maWcudGllckhlaWdodCkgLSAzMDsKICAgICAgICAgICAgICAgIGNvbnN0IHsgck1pbiwgY2lyYyB9ID0gdGllclJhZGlpW3RdOwogICAgICAgICAgICAgICAgY29uc3Qgck1heCA9IHJNaW4gKyB0aGlzLmNvbmZpZy50aWVyRGVwdGggLSAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEaXN0cmlidXRlIHByb3BvcnRpb25hbGx5IHNvIHVwcGVyIHJvd3MgZG9uJ3QgZ2V0IGN1dCBvZmYKICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50UGVyVGllciA9IE1hdGguZmxvb3IodGhpcy5jb25maWcuY3Jvd2RDb3VudCAqIChjaXJjIC8gdG90YWxDaXJjKSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50UGVyVGllcjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlkeCA+PSB0aGlzLmNvbmZpZy5jcm93ZENvdW50KSBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IHJNaW4gKyBNYXRoLnJhbmRvbSgpICogKHJNYXggLSByTWluKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBkdW1teS5wb3NpdGlvbi5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguY29zKGFuZ2xlKSAqIHIsCiAgICAgICAgICAgICAgICAgICAgICAgIHlCYXNlICsgMS4yNSwgLy8gQ2VudGVyIG9mIHF1YWQKICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5zaW4oYW5nbGUpICogcgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRmFjZSBjZW50ZXIKICAgICAgICAgICAgICAgICAgICBkdW1teS5sb29rQXQoMCwgeUJhc2UsIDApOwogICAgICAgICAgICAgICAgICAgIGR1bW15LnVwZGF0ZU1hdHJpeCgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2Quc2V0TWF0cml4QXQoaWR4LCBkdW1teS5tYXRyaXgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJhbmRvbSBUZWFtIENvbG9ycyAoU2ltdWxhdGluZyBmYW5zKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhbmQgPSBNYXRoLnJhbmRvbSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChyYW5kIDwgMC40NSkgY29sb3Iuc2V0SGV4KDB4MDA4OGZmKTsgLy8gSG9tZSBCbHVlCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocmFuZCA8IDAuOSkgY29sb3Iuc2V0SGV4KDB4ZmY0NDQ0KTsgLy8gQXdheSBSZWQKICAgICAgICAgICAgICAgICAgICBlbHNlIGNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIE5ldXRyYWwvRmxhc2gKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBWYXJ5IGJyaWdodG5lc3MgZm9yIGRlcHRoCiAgICAgICAgICAgICAgICAgICAgY29sb3IubXVsdGlwbHlTY2FsYXIoMC41ICsgTWF0aC5yYW5kb20oKSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jcm93ZC5zZXRDb2xvckF0KGlkeCwgY29sb3IpOwogICAgICAgICAgICAgICAgICAgIGlkeCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jcm93ZCk7CiAgICAgICAgfQoKICAgICAgICBfYnVpbGRIZXJjdWxlYW5SaW5ncygpIHsKICAgICAgICAgICAgLy8gTWFzc2l2ZSBmbG9hdGluZyByaW5ncyB0aGF0IHJvdGF0ZSBzbG93bHkKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgCiAgICAgICAgICAgICAgICBjb2xvcjogMHg0NDU1NjYsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC4zLAogICAgICAgICAgICAgICAgd2lyZWZyYW1lOiB0cnVlIC8vIFRlY2gvSG9sb2dyYXBoaWMgZmVlbAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIDEuIEVxdWF0b3JpYWwgUmluZyAoTWFzc2l2ZSkKICAgICAgICAgICAgY29uc3QgZ2VvMSA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KDExMCwgMSwgMTYsIDEwMCk7CiAgICAgICAgICAgIGNvbnN0IHJpbmcxID0gbmV3IFRIUkVFLk1lc2goZ2VvMSwgbWF0KTsKICAgICAgICAgICAgcmluZzEucm90YXRpb24ueCA9IE1hdGguUEkgLyAyOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQocmluZzEpOwogICAgICAgICAgICB0aGlzLnJpbmdzLnB1c2goeyBtZXNoOiByaW5nMSwgYXhpczogJ3onLCBzcGVlZDogMC4wMSB9KTsKCiAgICAgICAgICAgIC8vIDIuIFRpbHRlZCBSaW5nCiAgICAgICAgICAgIGNvbnN0IGdlbzIgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxMzAsIDIsIDE2LCAxMDApOwogICAgICAgICAgICBjb25zdCByaW5nMiA9IG5ldyBUSFJFRS5NZXNoKGdlbzIsIG1hdCk7CiAgICAgICAgICAgIHJpbmcyLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMzsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmcyKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzIsIGF4aXM6ICd5Jywgc3BlZWQ6IC0wLjAwOCB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDMuIFZlcnRpY2FsIFJpbmcKICAgICAgICAgICAgY29uc3QgZ2VvMyA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KDE1MCwgMywgMTYsIDEwMCk7CmNvbnN0IHJpbmczID0gbmV3IFRIUkVFLk1lc2goZ2VvMywgbWF0KTsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmczKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzMsIGF4aXM6ICd5Jywgc3BlZWQ6IDAuMDA1IH0pOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkU3RhZGl1bUxpZ2h0cygpIHsKICAgICAgICAgICAgY29uc3QgY291bnQgPSAxNjsgLy8gTnVtYmVyIG9mIGxpZ2h0cyBhcm91bmQgdGhlIGVxdWF0b3IKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gMzY7IC8vIEp1c3Qgb3V0c2lkZSB0aGUgYXJlbmEgYm91bmRhcnkgKDMyKQogICAgICAgICAgICBjb25zdCB5UG9zID0gMDsgLy8gTWlkZGxlIG9mIHRoZSBzcGhlcmUKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGxpZ2h0R2VvID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDAuNCwgOCwgOCk7CiAgICAgICAgICAgIGNvbnN0IGxpZ2h0TWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZmZmIH0pOwoKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8Y291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIGNvdW50KSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IE1hdGguY29zKGFuZ2xlKSAqIHJhZGl1czsKICAgICAgICAgICAgICAgIGNvbnN0IHogPSBNYXRoLnNpbihhbmdsZSkgKiByYWRpdXM7CgogICAgICAgICAgICAgICAgLy8gMS4gUGh5c2ljYWwgRml4dHVyZSAoVGhlIGJ1bGIpCiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gobGlnaHRHZW8sIGxpZ2h0TWF0KTsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24uc2V0KHgsIHlQb3MsIHopOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKG1lc2gpOwoKICAgICAgICAgICAgICAgIC8vIDIuIFZpc3VhbCBHbG93IChGbGFyZSkKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUoX2dsb3dNYXRlcmlhbCk7CiAgICAgICAgICAgICAgICBzcHJpdGUucG9zaXRpb24uc2V0KHgsIHlQb3MsIHopOwogICAgICAgICAgICAgICAgc3ByaXRlLnNjYWxlLnNldCg4LCA4LCAxKTsgLy8gTGFyZ2UgZ2xvdwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHNwcml0ZSk7CgovLyAzLiBBY3R1YWwgUG9pbnQgTGlnaHQgLSBSRU1PVkVEIGZvciBvcHRpbWl6YXRpb24KICAgICAgICAgICAgICAgIC8vIFNpbmNlIHdlIHVzZSBNZXNoQmFzaWNNYXRlcmlhbCAoVW5saXQpLCByZWFsIGxpZ2h0cyB3YXN0ZSBDUFUvR1BVIHJlc291cmNlcy4KICAgICAgICAgICAgICAgIC8vIFRoZSBzcHJpdGUgZ2xvdyBhYm92ZSBwcm92aWRlcyB0aGUgdmlzdWFsIGVmZmVjdC4KICAgICAgICAgICAgfQogICAgICAgIH0KdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIEFuaW1hdGUgUmluZ3MKdGhpcy5yaW5ncy5mb3JFYWNoKHIgPT4gewogICAgICAgICAgICAgICAgaWYgKHIubWVzaCAmJiByLmF4aXMpIHsKICAgICAgICAgICAgICAgICAgICByLm1lc2gucm90YXRpb25bci5heGlzXSArPSByLnNwZWVkICogZHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gVXBkYXRlIENyb3dkIFNoYWRlcgogICAgICAgICAgICBpZiAodGhpcy5jcm93ZFVuaWZvcm1zKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNyb3dkVW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguU3RhZGl1bSA9IFN0YWRpdW07Cn0pKCk7"}}</script></head>
<body>
<div id="game-container">
<img id="screen-overlay-gif" src="https://i.postimg.cc/htrkgHTr/grok-video-2026-01-09-06-22-47-ezgif-com-resize.gif">
        <div id="ui-layer">
            <!-- Cinematic Letterboxing -->
            <div id="cinematic-bars">
                <div class="bar top"></div>
                <div class="bar bottom"></div>
            </div>

            <!-- Tech Copy / Event Flash System -->
            <div id="tech-flash-overlay">
                <div class="flash-line top"></div>
                <div class="tech-content-wrapper">
                    <div class="tech-text">TECHCOPY!</div>
                    <div class="tech-sub-text"></div>
                    <div class="tech-timer-track">
                        <div class="tech-timer-fill"></div>
                    </div>
                </div>
                <div class="flash-line bottom"></div>
            </div>

            <div id="loading">Loading Blitzball...</div>

            <!-- Top HUD -->
            <div id="hud-top">
                <div class="team-wing home">
                    <div class="crystal-bg"></div>
                    <div class="team-data">
                        <div class="team-name">BESAID</div>
                        <div class="team-sub">AUROCHS</div>
                    </div>
                    <div class="score-box">
                        <div id="score-player" class="score-digit">0</div>
                    </div>
                </div>

                <div class="timer-complex">
                    <div class="timer-crystal-ring"></div>
                    <div class="timer-content">
                        <div id="half-indicator">1st</div>
                        <div id="timer-display">00:00</div>
                    </div>
                </div>

                <div class="team-wing away">
                    <div class="score-box">
                        <div id="score-cpu" class="score-digit">0</div>
                    </div>
                    <div class="team-data">
                        <div class="team-name">LUCA</div>
                        <div class="team-sub">GOERS</div>
                    </div>
                    <div class="crystal-bg"></div>
                </div>
            </div>

            <!-- NEW: Goal Distance Indicator -->
            <div id="goal-distance-container">
                <div class="distance-label">GOAL</div>
                <div id="goal-distance">0m</div>
            </div>

            <!-- Mini-Map -->
            <div id="minimap-container">
                <div class="radar-rim"></div>
                <div id="minimap"></div>
                <div class="radar-label">SPHERE POOL</div>
            </div>

            <!-- Player Status Panel -->
            <div id="player-status-panel">
                <div class="char-name">TIDUS</div>
                <div class="hp-gauge-container">
                    <div class="hp-label">HP</div>
                    <div class="hp-bar-track">
                        <div class="hp-bar-fill" style="width: 100%;"></div>
                    </div>
                    <div class="hp-value">120/120</div>
                </div>
                <div class="tech-gauge-container">
                    <div class="tech-label">EXP</div>
                    <div class="tech-bar-track">
                        <div class="tech-bar-fill" style="width: 45%;"></div>
                    </div>
                </div>
            </div>

            <!-- NEW: Charge Power Meter -->
            <div id="charge-meter-container">
                <div class="charge-label">POWER</div>
                <div class="charge-meter-track">
                    <div id="charge-meter-fill"></div>
                </div>
                <div class="charge-hint">RELEASE!</div>
            </div>

            <!-- Announcement -->
            <div id="announcement">GOAL!</div>

            <!-- Controls -->
            <!-- Movement Joystick (Left) -->
            <div id="joystick-hit-zone"></div>
            <div id="joystick-visual-container">
                <div id="joystick-base"></div>
                <div id="joystick-knob"></div>
            </div>

            <!-- NEW: Aim Joystick (Right) -->
            <div id="aim-joystick-zone"></div>
            <div id="aim-joystick-visual">
                <div id="aim-joystick-base"></div>
                <div id="aim-joystick-knob"></div>
            </div>

            <div id="camera-zone"></div>

            <!-- Action Command -->
            <div id="action-container">
                <div class="command-menu-bg"></div>
                <div class="command-ring"></div>
                <div id="action-label">COMMAND</div>
                <div id="action-buttons-wrapper" style="position: relative; width: 100px; height: 100px;">
                    <div id="action-button">
                        <div class="limit-ring"></div>
                        <span class="btn-text">WAIT</span>
                        <div class="btn-glare"></div>
                    </div>
                    <div id="pass-button">
                        <div class="limit-ring"></div>
                        <span class="btn-text">PASS</span>
                        <div class="btn-glare"></div>
                    </div>
                </div>
            </div>

            <!-- NEW: Tackle Button -->
            <div id="tackle-button">
                <span class="btn-text">TACKLE</span>
                <div class="btn-glare"></div>
            </div>

            <!-- Auto/Demo Toggle -->
            <div id="auto-toggle" class="glass-btn">MANUAL</div>

            <!-- NEW: Settings Button -->
            <div id="settings-button" class="glass-btn">SETTINGS</div>

            <div id="practice-restore-btn">MENU</div>
<div id="controls-hint">WASD or Drag to Swim | Swipe to Dash</div>

            <!-- Gesture Hint Overlay -->
            <div id="gesture-hint">
                <svg width="200" height="300" viewBox="0 0 200 300" style="overflow: visible;">
                    <path class="curve-arrow" d="M100 250 Q 180 150 100 50" stroke="#00ffff" stroke-width="6" fill="none" stroke-linecap="round" stroke-dasharray="15 15"></path>
                    <polygon points="100,40 115,65 85,65" fill="#00ffff" filter="drop-shadow(0 0 5px #00ffff)"></polygon>
                </svg>
                <div class="gesture-text">SWIPE CURVE</div>
                <div class="gesture-hand"></div>
<div class="gesture-hand"></div>
            </div>

            <!-- Offscreen Player Indicator -->
            <div id="offscreen-indicator">
                <div class="arrow"></div>
            </div>

            <!-- NEW: Settings Panel -->
            <!-- NEW: Settings Panel -->
<div id="settings-panel" style="display: none;">
                <div class="settings-header">
                    <span>SETTINGS</span>
                    <button id="settings-close">X</button>
                </div>
                <div class="settings-content">
                    <div class="setting-row">
                        <label>Sensitivity</label>
                        <input type="range" id="sensitivity-slider" min="50" max="150" value="100">
                    </div>
                    <div class="setting-row">
                        <label>Aim Assist</label>
                        <input type="checkbox" id="aim-assist-toggle" checked="">
                    </div>
                    <div class="setting-row">
                        <label>Camera Shake</label>
                        <input type="checkbox" id="shake-toggle" checked="">
                    </div>
                    <div class="setting-row">
                        <label>Music Volume</label>
                        <input type="range" id="volume-slider" min="0" max="100" value="50">
                    </div>
                    <div class="setting-row" style="justify-content: center; margin-top: 20px; background: transparent;">
                        <button id="exit-to-menu-btn" class="glass-btn" style="width: 100%; border-color: #ff4444; color: #ff4444;">EXIT TO MENU</button>
                    </div>
                </div>
            </div>


            <!-- Practice Overlay -->
            <div id="practice-overlay">
                <div class="practice-panel">
                    <div class="panel-header">
                        <div class="panel-minimize-btn" id="p-minimize">-</div>
                        <div class="panel-title-group">
                            <span class="panel-title">BLITZ TRAINING</span>
                            <span class="panel-subtitle">SPHERE POOL SIMULATION</span>
                        </div>
                        <div class="panel-deco-line"></div>
                    </div>

                    <div class="panel-content">
                        <div class="panel-section">
                            <div class="section-label">DRILL SELECTION</div>
                            <div class="drill-list">
<div class="drill-btn active" data-drill="free">
                                    <span class="icon"></span> FREE ROAM
                                </div>
                                <div class="drill-btn" data-drill="ball_lab">
                                    <span class="icon"></span> BALL LAB
                                </div>
                                <div class="drill-btn" data-drill="shooting">
                                    <span class="icon"></span> SHOOTING
                                </div>
                                <div class="drill-btn" data-drill="passing">
                                    <span class="icon"></span> PASSING
                                </div>
<div class="drill-btn" data-drill="defense">
                                    <span class="icon"></span> DEFENSE
                                </div>
                                <div class="drill-btn" data-drill="curve">
<span class="icon"></span> CURVE BALL
                                </div>
                                <div class="drill-btn" data-drill="rapid_fire">
                                    <span class="icon"></span> RAPID FIRE
                                </div>
                            </div>
                        </div>

                        <div class="panel-section">
                            <div class="section-label">SYSTEM OVERRIDE</div>
                            <div class="option-list">
<div class="option-toggle active" id="opt-inf-stat">
                                    <span class="checkbox"></span> INF STATS
                                </div>
                                <div class="option-toggle active" id="opt-ai-dummy">
                                    <span class="checkbox"></span> AI DUMMY
                                </div>
                                <div class="option-toggle" id="opt-hitboxes">
                                    <span class="checkbox"></span> HITBOXES
                                </div>
                            </div>

                            <div class="section-label" style="margin-top: 15px;">COMMANDS</div>
                            <div class="action-btn" id="p-reset-ball">RESET BALL (R)</div>
                            <div class="action-btn" id="p-exit">EXIT PRACTICE</div>
                        </div>
                    </div>

                    <div class="panel-footer">
                        <div id="drill-instruction">SELECT A DRILL TO BEGIN SIMULATION</div>
                        <div id="drill-score">SCORE: 0</div>
                    </div>
                </div>
            </div>

            <!-- Main Menu -->
            <div id="main-menu" class="active">
                <div class="menu-bg-overlay"></div>
                <div class="ffx-logo-container">
                    <div class="ffx-logo-main">BLITZBALL</div>
                    <div class="ffx-logo-sub">REMASTERED</div>
                </div>
                <div class="menu-options">
                    <div class="menu-item" data-action="normal">
                        <span class="cursor">&gt;</span>
                        <span class="label">NORMAL MATCH</span>
                    </div>
                    <div class="menu-item" data-action="practice">
                        <span class="cursor">&gt;</span>
                        <span class="label">PRACTICE</span>
                    </div>
                    <div class="menu-item" data-action="ball_lab">
                        <span class="cursor">&gt;</span>
                        <span class="label">BALL LAB</span>
                    </div>
                    <div class="menu-item" data-action="options">
                        <span class="cursor">&gt;</span>
                        <span class="label">OPTIONS</span>
                    </div>
                </div>
                <div class="menu-footer">FLUX ENGINE v2.0</div>
            </div>
        </div>
    </div>

    <!-- Game Scripts -->
    <script>(function() {
    window.flux = window.flux || {};

    const _loader = new THREE.GLTFLoader();

    // Helper to convert a single material to Basic (Unlit/PSX)
// Helper to convert a single material to Basic (Unlit/PSX)
    function convertMaterial(oldMat, isSkinned) {
        
        // Preserve texture: Check map, then emissiveMap
        const texture = oldMat.map || oldMat.emissiveMap || null;

        // FORCE OPAQUE VISIBILITY
        // We override transparency to ensure models are always visible (fixing the "invisible model" issue).
        const params = {
            map: texture,
            color: 0xffffff,        // FORCE WHITE: Remove any tint from GLTF
            skinning: isSkinned,
            side: THREE.DoubleSide, // Render both sides to prevent backface culling invisibility
            transparent: false,     // Disable transparency to prevent sorting issues
            opacity: 1.0,           // Force full opacity
            alphaTest: 0.5,         // Strong alpha test for cutouts (nets/grates)
            vertexColors: oldMat.vertexColors, // Preserve vertex colors
            depthTest: true,
            depthWrite: true,       // Force depth write so it occludes properly
            fog: true
        };

        // Ensure texture encoding is correct for Three.js
        if (params.map) params.map.encoding = THREE.sRGBEncoding;

        return new THREE.MeshBasicMaterial(params);
    }

    window.flux.AssetLoader = {
        loadModel: function(url, onLoad, onProgress, onError) {
            _loader.load(url, function(gltf) {
                gltf.scene.traverse(function(node) {
                    if (node.isMesh) {
node.castShadow = false;
                        node.receiveShadow = false;
                        node.frustumCulled = false; // Prevent invisibility
                        if (node.material) {
                            if (Array.isArray(node.material)) {
                                node.material = node.material.map(m => convertMaterial(m, node.isSkinnedMesh));
                            } else {
                                node.material = convertMaterial(node.material, node.isSkinnedMesh);
                            }
                        }
                    }
                });
                if (onLoad) onLoad(gltf);
            }, onProgress, onError);
        }
    };
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Ball Lab / DevTools: throw & curve mapping knobs
    // (Defaults match current feel; DevTools can tweak at runtime.)
    window.flux.ThrowConfig = window.flux.ThrowConfig || {
        SWIPE_MIN_PX: 20,
        AIM_DX_SCALE: 1.0,
        AIM_DY_SCALE: 1.0,

        POWER_BASE: 1.0,
        POWER_RANGE: 0.8,          // Base multiplier = POWER_BASE + ratio*POWER_RANGE
        POWER_MAX_BONUS_RATIO: 0.95,
        POWER_MAX_MULTIPLIER: 2.5,

        CURVE_ENABLED: true,
        CURVE_INTENSITY_THRESHOLD: 0.25,
        CURVE_SPIN_SCALE: 1000.0,
        CURVE_SPEED_MULT: 1.5,
        CURVE_SPIN_CAP: 1500.0,
        CURVE_PERFECT_SPIN: 500.0
    };

    // Assist knobs (0..1): helps make the game feel "sporty" + fluid without going full auto.
    window.flux.AssistConfig = window.flux.AssistConfig || {
        PASS_AIM_ASSIST: 0.65,
        SHOT_AIM_ASSIST: 0.35,
        CATCH_ASSIST: 0.55,
        STEERING_ASSIST: 0.35,
        INPUT_RESPONSE: 14.0,
        PASS_CONE_DEG: 60,
        SHOT_CONE_DEG: 35,
        PASS_LEAD_TIME: 0.22,
        SHOT_LIFT: 0.08
    };

// Reusable math objects
const _pVec = new THREE.Vector3();
    const _pVec2 = new THREE.Vector3();
    const _pQuat = new THREE.Quaternion();
    const _pQuat2 = new THREE.Quaternion();
    const _pTargetQuat = new THREE.Quaternion();
    const _pEuler = new THREE.Euler();
    const _pAxisY = new THREE.Vector3(0, 1, 0);
    const _pAxisZ = new THREE.Vector3(0, 0, 1);

class Player {
        constructor(scene, role = 'MF') {
            this.scene = scene;
            this.role = role;
            this.team = null; // Assigned by Team.addPlayer
            this.homePosition = new THREE.Vector3();

            this.mesh = null;
            this.mixer = null;
            this.actions = {};
            this.activeAction = null;
            this.state = 'idle';
                        this._animLocked = false;
            this._lockedState = null;
            this._lastLocomotion = 'idle';
this.inputVector = new THREE.Vector3(0, 0, 0);
            this.desiredInputVector = new THREE.Vector3(0, 0, 0);

            // Physics (Drift/Inertia Model)
            this.velocity = new THREE.Vector3(0, 0, 0);
            this.acceleration = 12.0;
            this.drag = 3.0;
            this.maxSpeed = 8.0;
            // Bone reference for holding ball
            this.handBone = null;
this.canCatch = true;
            this.catchCooldown = 0; // Replaces setTimeout for safety

            // Blitzball Stats
            this.stats = {
                HP: 100,
                maxHP: 100,
                EN: 30,
                AT: 10,
                PA: 15,
                BL: 10,
                SH: 15,
                CA: 10,
                SP: 60
            };

            // Leveling System
            this.level = 1;
            this.exp = 0;
            this.nextLevelExp = 100;

            // Status Effects & Techniques
            this.status = {
                venom: 0,
                nap: 0,
                wither: { PA: 0, SH: 0, AT: 0, BL: 0, CA: 0, SP: 0 }
            };

            this.marking = null;
            this.learnedTechs = [];

            this.techs = {
                tackle: null,
                shoot: null,
                pass: null,
                passive: null
            };

            // Visuals
            this.baseColorHex = 0xffffff;
            this.originalMaterials = [];
            this.auraMesh = null;
            this.rotationOffset = 0;
this.baseScale = 1.17; // Increased ~8%

            // Real-time Stats
            this.currentEN = this.stats.EN;
this.tackleRadius = 2.0; // Reduced from 2.5 to reduce swarm lock

            this.speed = 4.0;
            this._updateDerivedStats();

            this.hasBall = false;
            this.isThrowing = false;

            // Dash State
            this.isDashing = false;
            this.dashTime = 0;
            this.dashTotalTime = 0.5;
this.dashCooldown = 0;
            this.dashVec = new THREE.Vector3();

            // Feedback Accumulators
            this._accumulatedDamage = 0;
            this._damageTimer = 0;

            // HP Bar
            this.hpBar = null;
            this.hpBarFill = null;

            // Gameplay Flow Timers
            this.stunTimer = 0;
            this.immunityTimer = 0;

            // Banking & Verticality
            this.bankingAmount = 0;
            this.targetY = 0;

            // Encounter System
            this.isEngaged = false;
            this.clashTimer = 0;

            this.encounterTimer = 0; // Track duration of current engagement
            // Charge Mechanic
            this.isCharging = false;
            this.chargeTime = 0;
            this.maxChargeTime = 1.5;

            // FIXED: Improved Rotation State with hysteresis
            this.currentYaw = 0;
            this.targetYaw = 0;
            this.lastValidYaw = 0; // Store last known good yaw for deadzone handling
            this.pitchAmount = 0;
            this.bankingAmount = 0;
            this.facingDeadzone = 0.3; // Minimum input/velocity magnitude to update facing

            // Particle Emission Timers
            this._particleTimers = {
                venom: 0,
                nap: 0,
                wither: 0
            };

            // DevTools Flags
            this.isGodMode = false;

            // Pass Target Indicator
// Pass Target Indicator
            this.passTargetIndicator = null;
            
            // Bubble Trail Timer
            this._bubbleTimer = 0;

this._dashParticleTimer = 0;
        }

        syncRotation() {
            if (!this.mesh) return;
            const euler = new THREE.Euler().setFromQuaternion(this.mesh.quaternion, 'YXZ');
            this.currentYaw = euler.y - this.rotationOffset;
            this.targetYaw = this.currentYaw;
            this.lastValidYaw = this.currentYaw;
            this.bankingAmount = 0;
            this.pitchAmount = 0;
        }

        getStat(name) {
            let val = this.stats[name];
            if (this.status.wither[name] > 0) {
                val *= 0.5;
            }
            return val;
        }

        applyStatus(type, duration, subType = null) {
            if (type === 'venom') {
                const wasActive = this.status.venom > 1.0;
                this.status.venom = Math.max(this.status.venom, duration);

                if (!wasActive) {
                    console.log(`${this.role} poisoned!`);
                    if (window.flux.gameInstance.floatingText)
                        window.flux.gameInstance.floatingText.spawn("POISON", this.mesh.position, "status");
                }
            } else if (type === 'nap') {
                const wasActive = this.status.nap > 1.0;
                this.status.nap = Math.max(this.status.nap, duration);

                if (!wasActive) {
                    if (this.hasBall) this.fumble();
                    console.log(`${this.role} fell asleep!`);
                    if (window.flux.gameInstance.floatingText)
                        window.flux.gameInstance.floatingText.spawn("SLEEP", this.mesh.position, "status");
                }
            } else if (type === 'wither' && subType) {
                const currentVal = this.status.wither[subType] || 0;
                const wasActive = currentVal > 1.0;
                this.status.wither[subType] = Math.max(currentVal, duration);

                if (!wasActive) {
                    console.log(`${this.role} withered ${subType}!`);
                    if (window.flux.gameInstance.floatingText)
                        window.flux.gameInstance.floatingText.spawn(`WITHER ${subType}`, this.mesh.position, "status");
                }
            }
        }

        _updateDerivedStats() {
            const sp = this.getStat('SP');
            this.maxSpeed = 5.0 + (sp / 15.0);
            this.currentEN = this.getStat('EN');
        }

setMesh(sourceMesh, animations) {
            this.mesh = sourceMesh;
            this.scene.add(this.mesh);
            this._createHPBar();
            this._createAura();
            this._createPassTargetIndicator();

            // Custom Character Scaling
            if (this.characterName) {
                if (this.characterName.includes('Tidus')) this.baseScale = 1.6;
                else if (this.characterName.includes('Wakka')) this.baseScale = 1.4;
            }

            this.mesh.scale.setScalar(this.baseScale);

            this.mesh.traverse((node) => {
                if (node.isMesh && node.material) {
const convertOne = (mat) => {
                        const m = new THREE.MeshBasicMaterial({
                            map: mat.map || null,
                            color: new THREE.Color(0xffffff), // FORCE WHITE: Ignore source color
                            transparent: !!mat.transparent,
                            opacity: (mat.opacity !== undefined ? mat.opacity : 1),
                            alphaTest: (mat.alphaTest !== undefined ? mat.alphaTest : 0),
                            side: mat.side,
                            depthTest: mat.depthTest,
                            depthWrite: mat.depthWrite,
                            fog: true,
                            skinning: !!node.isSkinnedMesh
                        });
                        this.originalMaterials.push({ material: m, baseColor: m.color.clone() });
                        return m;
                    };
                    node.material = Array.isArray(node.material)
                        ? node.material.map(convertOne)
                        : convertOne(node.material);
                }

                if (node.isBone) {
                    const name = node.name.toLowerCase();
                    if ((name.includes('hand') && name.includes('r')) || name.includes('righthand')) {
                        this.handBone = node;
                    }
                }
            });

            this.mixer = new THREE.AnimationMixer(this.mesh);

            // Layered animation system (locomotion base + upper-body overlay + full-body one-shots)
            this.clips = {};
            this.upperActions = {};
            this.baseActions = {};
            this.activeUpperAction = null;
            this._upperLocked = false;
            this._upperLockedState = null;
            this._layeredEnabled = true;
            this._locomotionFade = 0.2;
            this._animSpeedSmoothed = 0;
            this._baseSuppression = 0;


            if (animations) {
                const _normClipName = (s) => (s || '')
                    .toLowerCase()
                    .replace(/[_\-]+/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();

                animations.forEach((clip) => {
                    const name = _normClipName(clip.name);
                    const action = this.mixer.clipAction(clip);
                    const has = (re) => re.test(name);

                    const reg = (key) => { this.actions[key] = action; this.clips[key] = clip; };

                    // --- Core locomotion ---
                    if (has(/tread|treading|idle|float/)) {
                        reg('idle');
                    } else if (has(/dash|sprint|burst|fast\s*swim|swim\s*fast/)) {
                        reg('dash');
                    } else if (has(/swim|freestyle|crawl/)) {
                        reg('swim');

                    // --- Throwing (pass/shot variants if present) ---
                    } else if (has(/throw|toss|pitch/)) {
                        if (has(/shoot|shot|goal/)) reg('throw_shot');
                        else if (has(/pass/)) reg('throw_pass');
                        else reg('throw');

                    // --- Catching (jump/air variants if present) ---
                    } else if (has(/catch|receive|grab|intercept/)) {
                        if (has(/jump|leap|air|dive/)) reg('catch_jump');
                        else reg('catch');

                    // --- Hit / React ---
                    } else if (has(/react|hit|hurt|damage|stagger|knock/)) {
                        reg('react');

                    // --- Optional states (only used if clips exist) ---
                    } else if (has(/charge|aim|ready|windup|hold/)) {
                        reg('charge');
                    } else if (has(/tackle|check|ram/)) {
                        reg('tackle');
                    } else if (has(/block|save/)) {
                        reg('block');
                    } else if (has(/celebrate|victory|cheer/)) {
                        reg('celebrate');

                    } else {
                        this.actions[clip.name] = action; this.clips[clip.name] = clip;
                    }
                });
            }
if (this.actions['idle']) {
                if (this._layeredEnabled) {
                    try {
                        // In layered mode we don't use the single-action state machine.
                        this.actions['idle'].enabled = true;
                        this.actions['idle'].play();
                    } catch (_) {}
                } else {
                    this.play('idle');
                }
            } else {
                const first = Object.values(this.actions)[0];
                if(first) first.play();
            }

            // Initialize layered mixing if enabled.
            if (this._layeredEnabled) {
                this._initLayeredAnimation();
            }

                    // One-shot animation lock: prevent locomotion from interrupting throw/catch/react.
            // When a one-shot finishes, automatically return to locomotion.
            if (this.mixer) {
                this.mixer.addEventListener('finished', (e) => {
                    if (!this._animLocked) return;
                    if (!e || !e.action) return;

                    // Upper-body one-shot handling
                    if (this._upperLocked && this.activeUpperAction && e.action === this.activeUpperAction) {
                        this._upperLocked = false;
                        this._upperLockedState = null;
                        try { e.action.clampWhenFinished = false; } catch (_) {}
                        try { e.action.fadeOut(0.08); } catch (_) {}
                        this.activeUpperAction = null;
                        return;
                    }

                    if (e.action !== this.activeAction) return;

                    this._animLocked = false;
                    this._lockedState = null;

                    // Unclamp so future plays don't freeze on last frame.
                    try { e.action.clampWhenFinished = false; } catch (_) {}

                    // Return to locomotion unless another override is active.
                    if (!this.isThrowing) {
                        this._updateLocomotionAnim(0.15);
                    }
                });
            }

}

play(actionName, duration = 0.5) {
            const newAction = this.actions[actionName];
            if (!newAction || newAction === this.activeAction) return;

            if (this.activeAction) {
                this.activeAction.fadeOut(duration);
            }

            newAction.reset();
            newAction.fadeIn(duration);
            newAction.play();
            this.activeAction = newAction;
            this.state = actionName;
        }

        _updateLocomotionAnim(duration = 0.2) {
            if (this._layeredEnabled) { this._locomotionFade = duration; return; }

            if (this._animLocked) return;

            const vx = this.velocity ? this.velocity.x : 0;
            const vz = this.velocity ? this.velocity.z : 0;

            const inputMoving = this.inputVector && this.inputVector.lengthSq() > 0.05;
            const velMoving = (vx * vx + vz * vz) > 0.02;

            const moving = inputMoving || velMoving;

            let target = moving ? 'swim' : 'idle';
            if (moving && this.isDashing && this.actions['dash']) target = 'dash';

            // Optional: while stationary and charging, prefer a charge/aim loop if it exists.
            if (!moving && this.isCharging && this.actions['charge']) target = 'charge';

            if (this.state !== target) {
                // Ensure looping for locomotion-style clips
                const a = this.actions[target];
                if (a) {
                    try { a.setLoop(THREE.LoopRepeat); } catch (_) {}
                    a.clampWhenFinished = false;
                }
                this.play(target, duration);
                this._lastLocomotion = target;
            }
        }

        playOneShot(actionName, duration = 0.1, opts = {}) {
            // In layered mode, route throws/catches to the upper-body layer so players can keep swimming.
            if (this._layeredEnabled) {
                const upperKeys = {
                    'throw': true,
                    'throw_pass': true,
                    'throw_shot': true,
                    'catch': true
                };
                if (upperKeys[actionName]) {
                    return this._playUpperOneShot(actionName, duration, opts);
                }
            }

            const a = this.actions[actionName];
            if (!a) return false;

            // Lock locomotion so it doesn't stomp the one-shot.
            this._animLocked = true;
            this._lockedState = actionName;

            try {
                a.reset();
                a.setLoop(THREE.LoopOnce);
                a.clampWhenFinished = true;
                a.timeScale = (opts.timeScale !== undefined ? opts.timeScale : 1.0);
            } catch (_) {}

            this.play(actionName, duration);
            return true;
        }
        setInput(x, z) {
            if (this.status.nap > 0) {
                this.desiredInputVector.set(0, 0, 0);
                this.inputVector.set(0, 0, 0);
                return;
            }
            this.desiredInputVector.set(x, 0, z);
        }

receiveBall() {
            this.canCatch = false;
            
            // CRITICAL FIX: Reset states that might prevent shooting
            this.isThrowing = false;
            this.isCharging = false;
            this._hideChargeUI();

            if (this.status.nap > 0) {
                this.status.nap = 0;
            }

            this.hasBall = true;
            this.immunityTimer = 2.0;

            const ball = window.flux.gameInstance.entities.ball;
            if (ball && ball.lastHolder && ball.lastHolder.team === this.team && ball.lastHolder !== this) {
                ball.lastHolder.gainExp(2);
                this.gainExp(1);
            }

            const ballY = (this.ballRef && this.ballRef.mesh) ? this.ballRef.mesh.position.y : 0;
            const catchKey = (ballY > 0.25 && this.actions['catch_jump']) ? 'catch_jump' : 'catch';
            this.playOneShot(catchKey, 0.1);

            if (window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("SNAP!", this.mesh.position, "comic-action");
            }
        }


        _initLayeredAnimation() {
            // Base layer: idle/swim/dash are always playing, we just blend weights.
            const ensureLooping = (a) => {
                if (!a) return;
                try { a.setLoop(THREE.LoopRepeat); } catch (_) {}
                a.clampWhenFinished = false;
                a.enabled = true;
            };

            const idle = this.actions['idle'] || null;
            const swim = this.actions['swim'] || null;
            const dash = this.actions['dash'] || null;

            this.baseActions.idle = idle;
            this.baseActions.swim = swim;
            this.baseActions.dash = dash;

            // Start base actions so we can blend weights without restarting clips (smoother on mobile).
            [idle, swim, dash].forEach((a) => {
                if (!a) return;
                ensureLooping(a);
                try {
                    a.play();
                    a.setEffectiveWeight(0);
                } catch (_) {}
            });

            // Upper-body layer: filtered clips for throw/catch/charge (only upper bones).
            const upperHints = ['spine','chest','neck','head','shoulder','clavicle','arm','forearm','hand','wrist','thumb','finger'];
            const isUpperBoneName = (boneName) => {
                const n = (boneName || '').toLowerCase();
                for (const h of upperHints) if (n.includes(h)) return true;
                return false;
            };

            const filterClipTracks = (clip, predicate) => {
                if (!clip) return null;
                const tracks = [];
                for (const t of (clip.tracks || [])) {
                    const trackName = t.name || '';
                    const boneName = trackName.split('.')[0];
                    if (predicate(boneName)) tracks.push(t);
                }
                if (!tracks.length) return null;
                const filtered = clip.clone();
                filtered.tracks = tracks;
                filtered.name = (clip.name || 'clip') + "_UPPER";
                return filtered;
            };

            const makeUpperAction = (key, loopMode) => {
                const clip = this.clips[key];
                if (!clip) return null;
                const upperClip = filterClipTracks(clip, isUpperBoneName);
                if (!upperClip) return null;
                const a = this.mixer.clipAction(upperClip);
                a.enabled = true;
                if (loopMode === 'loop') {
                    try { a.setLoop(THREE.LoopRepeat); } catch (_) {}
                    a.clampWhenFinished = false;
                } else {
                    try { a.setLoop(THREE.LoopOnce); } catch (_) {}
                    a.clampWhenFinished = true;
                }
                try {
                    a.setEffectiveWeight(0);
                    if (loopMode === 'loop') {
                        a.play();
                    } else {
                        a.stop();
                    }
                } catch (_) {}
                this.upperActions[key] = a;
                return a;
            };

            // Preferred upper overlay clips (if they exist)
            makeUpperAction('charge', 'loop');
            makeUpperAction('throw', 'once');
            makeUpperAction('throw_pass', 'once');
            makeUpperAction('throw_shot', 'once');
            makeUpperAction('catch', 'once');

            // Start with sane defaults
            this._animSpeedSmoothed = 0;
            this._baseSuppression = 0;
        }

        _playUpperOneShot(actionName, fade = 0.08, opts = {}) {
            const a = this.upperActions[actionName];
            if (!a) {
                // Fallback to full-body one-shot if no upper clip exists.
                const fa = this.actions[actionName];
                if (!fa) return false;

                this._animLocked = true;
                this._lockedState = actionName;

                if (this.activeAction && this.activeAction !== fa) {
                    try { this.activeAction.fadeOut(fade); } catch (_) {}
                }

                try {
                    fa.reset();
                    fa.enabled = true;
                    fa.setLoop(THREE.LoopOnce);
                    fa.clampWhenFinished = true;
                    fa.setEffectiveTimeScale(opts.timeScale !== undefined ? opts.timeScale : 1.0);
                    fa.setEffectiveWeight(1.0);
                    fa.fadeIn(fade);
                    fa.play();
                } catch (_) {}

                this.activeAction = fa;
                this.state = actionName;
                return true;
            }

            // Stop any current upper one-shot
            if (this.activeUpperAction && this.activeUpperAction !== a) {
                try { this.activeUpperAction.fadeOut(0.06); } catch (_) {}
            }

            this._upperLocked = true;
            this._upperLockedState = actionName;
            this.activeUpperAction = a;

            try {
                a.reset();
                a.enabled = true;
                a.setEffectiveTimeScale(opts.timeScale !== undefined ? opts.timeScale : 1.0);
                a.setEffectiveWeight(1.0);
                a.setLoop(THREE.LoopOnce);
                a.clampWhenFinished = true;
                a.fadeIn(fade);
                a.play();
            } catch (_) {}

            return true;
        }

        _setWeight(action, target, lerpAlpha) {
            if (!action) return;
            const cur = (action.getEffectiveWeight ? action.getEffectiveWeight() : 0) || 0;
            const next = cur + (target - cur) * lerpAlpha;
            try { action.setEffectiveWeight(next); } catch (_) {}
        }

        _updateLayeredAnimation(dt) {
            if (!this.mixer) return;

            // Smooth speed (helps on mobile jitter)
            const vx = this.velocity ? this.velocity.x : 0;
            const vz = this.velocity ? this.velocity.z : 0;
            const speed = Math.sqrt(vx * vx + vz * vz);
            this._animSpeedSmoothed += (speed - this._animSpeedSmoothed) * Math.min(1, dt * 10.0);

            // Base suppression during full-body one-shots
            const wantSupp = this._animLocked ? 1.0 : 0.0;
            this._baseSuppression += (wantSupp - this._baseSuppression) * Math.min(1, dt * 14.0);
            const baseMul = 1.0 - this._baseSuppression;

            const fade = (this._locomotionFade || 0.2);
            const lerpAlpha = Math.min(1, dt / Math.max(0.0001, fade));

            // Blend idle <-> swim using a soft threshold + hysteresis
            const inMove = (this.inputVector && this.inputVector.lengthSq() > 0.05);
            const moving = inMove || this._animSpeedSmoothed > 0.08;

            // Smooth swim blend
            const swimBlend = moving ? Math.min(1, Math.max(0, (this._animSpeedSmoothed - 0.05) / 0.45)) : 0;
            const dashBlend = (this.isDashing && this.baseActions.dash) ? 1 : 0;

            const idleW = (1 - swimBlend) * (1 - dashBlend) * baseMul;
            const swimW = (swimBlend) * (1 - dashBlend) * baseMul;
            const dashW = (dashBlend) * baseMul;

            this._setWeight(this.baseActions.idle, idleW, lerpAlpha);
            this._setWeight(this.baseActions.swim, swimW, lerpAlpha);
            this._setWeight(this.baseActions.dash, dashW, lerpAlpha);

            // Time-scale locomotion so it matches actual motion
            if (this.baseActions.swim) {
                const ts = 0.75 + Math.min(1.5, this._animSpeedSmoothed * 1.2);
                try { this.baseActions.swim.setEffectiveTimeScale(ts); } catch (_) {}
            }
            if (this.baseActions.dash) {
                const ts = 1.1 + Math.min(1.2, this._animSpeedSmoothed * 0.8);
                try { this.baseActions.dash.setEffectiveTimeScale(ts); } catch (_) {}
            }
            if (this.baseActions.idle) {
                try { this.baseActions.idle.setEffectiveTimeScale(1.0); } catch (_) {}
            }

            // Upper-body overlay (aim/charge loop) when holding ball.
            const chargeA = this.upperActions['charge'] || null;
            const wantsCharge = (!this._upperLocked) && chargeA && this.hasBall && (this.isCharging || this.chargeTime > 0.05);
            const chargeTargetW = wantsCharge ? 1.0 : 0.0;
            this._setWeight(chargeA, chargeTargetW, lerpAlpha);

            if (chargeA && wantsCharge) {
                try { chargeA.setEffectiveTimeScale(1.0); } catch (_) {}
            }

            // If full-body one-shot is active, also damp upper overlay so it doesn't fight.
            if (this._animLocked && chargeA) {
                try { chargeA.setEffectiveWeight(0); } catch (_) {}
            }
        }


throwBall(ball, forcedType = null, powerMultiplier = 1.0, forcedSpin = null) {
            if (!this.hasBall || this.isThrowing) return;
            if (this.status.nap > 0) return;

            this.isThrowing = true;

            // Lock aim direction at start of throw
            this.lockedAimVector = new THREE.Vector3();

            if (this.inputVector.lengthSq() > 0.1) {
                this.lockedAimVector.copy(this.inputVector).normalize();
            } else {
                this.lockedAimVector.set(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
            }

const goalZ = (this.team && this.team.side === 1) ? -46 : 46;
            const distToGoal = Math.abs(this.mesh.position.z - goalZ);

            let type = forcedType;
            if (!type) {
                type = (distToGoal < 25) ? 'SH' : 'PA';
            }

            const isFinisher = (type === 'SH' && distToGoal < 12.0);

            let techName = (type === 'SH') ? this.techs.shoot : this.techs.pass;

            if (this.status.venom > 0 && techName) {
                if (window.flux.gameInstance.floatingText)
                    window.flux.gameInstance.floatingText.spawn("SILENCED", this.mesh.position, "status");
                techName = null;
            }

            let windupTime = 100;
            let animSpeed = 1.5;

            if (powerMultiplier > 1.1) {
                windupTime += 200;
            }

            if (isFinisher && !techName) {
                windupTime = 50;
                animSpeed = 3.0;
            }

if (techName) {
                windupTime = 400;
                animSpeed = 0.8;

                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.playCinematic(techName, this.mesh, 1.2);
                }

                this.immunityTimer = 1.5;

                if (window.flux.gameInstance.floatingText) {
                    const label = techName.replace('_', ' ').toUpperCase();
                    window.flux.gameInstance.floatingText.spawn(label, this.mesh.position, "tech");
                }

                // NEW: Spawn Tech Glyph (Vertical Casting Circle)
                if (window.flux.gameInstance.glyphManager) {
                    window.flux.gameInstance.glyphManager.spawn('tech', this.mesh.position, {
                        parent: this,
                        life: 1.2,
                        rotationSpeed: 4.0,
                        scaleSpeed: 1.5,
                        offsetY: 1.2,
                        faceCamera: true
                    });
                }
            }

            // Pick best throw clip (pass/shot variants if present)
            const throwKey =
                (type === 'SH' && this.actions['throw_shot']) ? 'throw_shot' :
                (type === 'PA' && this.actions['throw_pass']) ? 'throw_pass' :
                'throw';

            this.playOneShot(throwKey, 0.1, { timeScale: animSpeed });

            if (window.flux.gameInstance.floatingText && !techName) {
                window.flux.gameInstance.floatingText.spawn("WHOOSH", this.mesh.position, "comic-action");
            }

setTimeout(() => {
                // Safety: If ball holder is still us, proceed. If hasBall is false but holder is us, assume sync lag and proceed.
                if (this.hasBall || (ball && ball.holder === this)) {
const throwAction = this.actions[throwKey];
                    if (throwAction) throwAction.timeScale = 1.0;

                    let finalDir = new THREE.Vector3();
                    let referenceDir = new THREE.Vector3();

if (this.overrideAimVector) {
                        finalDir.copy(this.overrideAimVector).normalize();
                        referenceDir.copy(finalDir);

                        // REMOVED: Instant rotation snap. 
                        // The update loop handles smooth rotation via targetYaw.
                        // This prevents the "flipping around" visual glitch.
                    } else {
                        finalDir.copy(this.lockedAimVector);
                        referenceDir.copy(this.lockedAimVector);
                    }

const spin = new THREE.Vector3(0, 0, 0);

                    if (forcedSpin) {
                        spin.copy(forcedSpin);
                    } else if (this.inputVector.lengthSq() > 0.1) {
                        const inputDir = this.inputVector.clone().normalize();
                        const crossY = new THREE.Vector3().crossVectors(referenceDir, inputDir).y;

                        if (Math.abs(crossY) > 0.1) {
                            spin.set(0, crossY * 12.0, 0);
                        }
                    }

                    let baseCost = (type === 'SH') ? 20 : 10;
                    let techCost = 0;
                    let techBonus = 0;
                    let techPayload = null;

                    if (techName) {
                        switch (techName) {
                            case 'venom':
                                techCost = (type === 'SH' ? 20 : 10);
                                techBonus = 3;
                                techPayload = { type: 'venom', level: 1 };
                                break;
                            case 'wither':
                                techCost = (type === 'SH' ? 20 : 10);
                                techBonus = 3;
                                techPayload = { type: 'wither', level: 1 };
                                break;
                            case 'nap':
                                techCost = (type === 'SH' ? 35 : 30);
                                techBonus = 3;
                                techPayload = { type: 'nap', level: 1 };
                                break;
                            case 'sphere':
                                if (type === 'SH') {
                                    techCost = 25;
                                    const rng = Math.floor(Math.random() * 11) + 5;
                                    techBonus = rng;
                                    techPayload = { type: 'sphere', level: 1, bonus: rng };
                                    if (window.flux.gameInstance.floatingText)
                                        window.flux.gameInstance.floatingText.spawn(`SPHERE +${rng}`, this.mesh.position, "goal");
                                }
                                break;
                            case 'jecht':
                                if (type === 'SH') {
                                    techCost = 40;
                                    techBonus = 5;
                                    techPayload = { type: 'jecht', level: 1 };
                                    this._performJechtKnockback();
                                }
                                break;
                            case 'invisible':
                                if (type === 'SH') {
                                    techCost = 25;
                                    techBonus = 2;
                                    techPayload = { type: 'invisible', level: 1 };
                                }
                                break;
                        }
                    }

                    const totalCost = baseCost + techCost;

                    let powerFactor = 1.0;
                    if (this.stats.HP < totalCost) {
                        powerFactor = 0.5;
                        this.stats.HP = 0;
                        techPayload = null;
                        techBonus = 0;
                        if (window.flux.gameInstance.floatingText)
                            window.flux.gameInstance.floatingText.spawn("TIRED", this.mesh.position, "damage");
                    } else {
                        this.stats.HP -= totalCost;
                    }

                    let statVal = this.getStat(type);
                    statVal += techBonus;
                    statVal *= powerFactor;
                    statVal *= powerMultiplier;

const goalZ = (this.team && this.team.side === 1) ? -46 : 46;
                    const goalDir = new THREE.Vector3(0, 0, goalZ - this.mesh.position.z).normalize();
                    const goalDot = finalDir.dot(goalDir);

                    if (type === 'SH') {
                        const goalPos = new THREE.Vector3(0, 2, goalZ);
                        const toGoal = goalPos.clone().sub(this.mesh.position).normalize();

                        const sh = this.getStat('SH');
                        const settings2 = (window.flux && window.flux._debugIO) ? window.flux._debugIO.settings : null;
                        const AC2 = window.flux.AssistConfig || {};
                        const shotAssist = Math.max(0, Math.min(1, (settings2 && typeof settings2.shotAimAssist === 'number') ? settings2.shotAimAssist : (AC2.SHOT_AIM_ASSIST !== undefined ? AC2.SHOT_AIM_ASSIST : 0.35)));
                        const coneDeg = (AC2.SHOT_CONE_DEG !== undefined ? AC2.SHOT_CONE_DEG : 35);
                        const minDot = Math.cos(coneDeg * Math.PI / 180);

                        // Blend amount: stats * user assist (kept modest so it's not "baby" easy).
                        let assistFactor = shotAssist * Math.min(0.9, Math.max(0.08, sh / 100.0));

                        // If player explicitly aimed, reduce help but keep some to preserve flow.
                        if (this.overrideAimVector) {
                            assistFactor *= 0.55;
                        }

                        if (goalDot > minDot) {
                            const u = Math.max(0, Math.min(1, (goalDot - minDot) / (1.0 - minDot)));
                            const w = u * u * (3 - 2 * u); // smoothstep
                            finalDir.lerp(toGoal, assistFactor * w);
                        }

                        if (isFinisher) {
                            finalDir.y += 0.05;
                            if (window.flux.gameInstance.floatingText) {
                                window.flux.gameInstance.floatingText.spawn("SLAM!", this.mesh.position, "comic-impact");
                            }
} else {
                            finalDir.y += 0.22 + (0.10 * shotAssist);
                        }
                        
// Goalie Loft Bonus (Prevent interception by immediate defender)
                        if (this.role === 'GL') finalDir.y += 0.8; // High loft for clearance

                    } else {
                        const target = this._findPassTargetInCone(finalDir);

                        if (target) {
                            const dist = this.mesh.position.distanceTo(target.mesh.position);

                            const toMate = target.mesh.position.clone().sub(this.mesh.position);

                            // Lead the receiver slightly (scales with distance, capped)
                            const settings2 = (window.flux && window.flux._debugIO) ? window.flux._debugIO.settings : null;
                            const AC2 = window.flux.AssistConfig || {};
                            const leadTBase = (AC2.PASS_LEAD_TIME !== undefined ? AC2.PASS_LEAD_TIME : 0.22);
                            const leadT = leadTBase + Math.min(0.20, dist * 0.007);

                            if (target.velocity && target.velocity.lengthSq && target.velocity.lengthSq() > 0.01) {
                                toMate.addScaledVector(target.velocity, leadT);
                            }
                            toMate.normalize();

                            const pa = this.getStat('PA');
                            const passAssist = Math.max(0, Math.min(1, (settings2 && typeof settings2.passAimAssist === 'number') ? settings2.passAimAssist : (AC2.PASS_AIM_ASSIST !== undefined ? AC2.PASS_AIM_ASSIST : 0.65)));

                            const coneDeg = (AC2.PASS_CONE_DEG !== undefined ? AC2.PASS_CONE_DEG : 60);
                            const minDot = Math.cos(coneDeg * Math.PI / 180);
                            const dotMate = Math.max(-1, Math.min(1, finalDir.dot(toMate)));

                            let assistFactor = passAssist * Math.min(1.0, 0.35 + (pa / 80.0));

                            // If player explicitly aimed, reduce help but keep some to preserve flow.
                            if (this.overrideAimVector) {
                                assistFactor *= 0.55;
                            }

                            if (dotMate > minDot) {
                                const u = Math.max(0, Math.min(1, (dotMate - minDot) / (1.0 - minDot)));
                                const w = u * u * (3 - 2 * u); // smoothstep
                                finalDir.lerp(toMate, assistFactor * w);
                            }

                            // Loft: scales with distance (helps the receiver read it)
                            finalDir.y += Math.min(0.6, dist * 0.03) + (0.05 * passAssist);
                        } else {
                            finalDir.y += 0.2;
                        }
                        
                        // Goalie Loft Bonus for Passing
// Goalie Loft Bonus for Passing
                        if (this.role === 'GL') finalDir.y += 0.8; // High loft for clearance
                    }

                    finalDir.normalize();

                    if (techPayload && window.flux.gameInstance && window.flux.gameInstance.triggerTechEvent) {
                        window.flux.gameInstance.triggerTechEvent(this, techName);
                    }

ball.shoot(finalDir, statVal, type, techPayload, spin);
                    
                    // Extra grace period for Goalie to prevent point-blank interceptions
                    if (this.role === 'GL') {
                        ball.catchGracePeriod = 0.6; // 0.6s immunity (approx 10-12m travel)
                    }

this.loseBall();

this.catchCooldown = 1.0; // 1s cooldown
                    this.canCatch = false;
                }
            }, windupTime);

            setTimeout(() => {
                this.isThrowing = false;
                this.overrideAimVector = null;
                this._updateLocomotionAnim(0.2);
            }, windupTime + 500);
        }

        _findPassTargetInCone(aimDir) {
            if (!this.team) return null;

            const settings = (window.flux && window.flux._debugIO) ? window.flux._debugIO.settings : null;
            const AC = window.flux.AssistConfig || {};
            const passAssist = Math.max(0, Math.min(1, (settings && typeof settings.passAimAssist === 'number') ? settings.passAimAssist : (AC.PASS_AIM_ASSIST !== undefined ? AC.PASS_AIM_ASSIST : 0.65)));

            // Wider intent cone as assist increases (still requires pointing generally at the teammate)
            const coneDeg = (AC.PASS_CONE_DEG !== undefined ? AC.PASS_CONE_DEG : 60);
            const coneMinDot = Math.cos(coneDeg * Math.PI / 180);
            const minDot = (0.75 * (1.0 - passAssist)) + (coneMinDot * passAssist);

            let bestTarget = null;
            let bestScore = -Infinity;

            const goalZ = (this.team && this.team.side === 1) ? -46 : 46;
            const forwardSign = (this.team && this.team.side === 1) ? -1 : 1;

            for (const mate of this.team.players) {
                if (mate === this || !mate.mesh) continue;
                if (mate.status && mate.status.nap > 0) continue;
                if (mate.stunTimer && mate.stunTimer > 0.2) continue;

                const toMate = mate.mesh.position.clone().sub(this.mesh.position);
                const dist = toMate.length();
                if (dist < 0.001) continue;
                toMate.multiplyScalar(1.0 / dist);

                const dot = aimDir.dot(toMate);
                if (dot < minDot) continue;

                // Prefer: strong alignment, reasonable distance, forward progress.
                const distScore = 1.0 - Math.min(1.0, dist / 30.0);
                const progress = forwardSign * (mate.mesh.position.z - this.mesh.position.z);
                const progressScore = Math.max(-1.0, Math.min(1.0, progress / 18.0));

                // Slight bias toward mates closer to opponent goal (feels more "sporty" / attacking)
                const goalProx = 1.0 - Math.min(1.0, Math.abs(mate.mesh.position.z - goalZ) / 60.0);

                let score = (dot * 3.0) + (distScore * 1.2) + (progressScore * 0.8) + (goalProx * 0.4);

                if (score > bestScore) {
                    bestScore = score;
                    bestTarget = mate;
                }
            }

            return bestTarget;
        }

startCharge() {
            if (!this.hasBall || this.isThrowing || this.status.nap > 0) return;
            this.isCharging = true;
            this.chargeTime = 0;

// Visuals handled in update

            // Show charge UI
            this._updateChargeUI(0);

            // NEW: Spawn Charge Glyph (Ground Ring)
            if (window.flux.gameInstance && window.flux.gameInstance.glyphManager) {
                window.flux.gameInstance.glyphManager.spawn('charge', this.mesh.position, {
                    parent: this,
                    life: this.maxChargeTime,
                    rotationSpeed: 3.0,
                    scaleSpeed: 0.2,
                    offsetY: 0.1
                });
            }
        }

releaseCharge(dx, dy, curveInput = null) {
            if (!this.isCharging) return;
            this.isCharging = false;

            // Power Calculation
            const ratio = Math.min(this.chargeTime / this.maxChargeTime, 1.0);
            const TC = window.flux.ThrowConfig || {};

            // Base multiplier (defaults: 1.0 to 1.8)
            let multiplier = (TC.POWER_BASE !== undefined ? TC.POWER_BASE : 1.0) + (ratio * (TC.POWER_RANGE !== undefined ? TC.POWER_RANGE : 0.8));// MAX POWER BONUS: If held near max, significant boost
            if (ratio > (TC.POWER_MAX_BONUS_RATIO !== undefined ? TC.POWER_MAX_BONUS_RATIO : 0.95)) {
                multiplier = (TC.POWER_MAX_MULTIPLIER !== undefined ? TC.POWER_MAX_MULTIPLIER : 2.5); // Critical Power
                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("MAX POWER!", this.mesh.position, "comic-impact");
                }
                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.addFovImpulse(-10);
                    window.flux.gameInstance.cameraManager.addShake(1.0);
                }
            }

            this._hideChargeUI();

            // Aim Vector Calculation
            let aimVec = null;
            const swipeLen = Math.sqrt(dx*dx + dy*dy);

            if (swipeLen > (TC.SWIPE_MIN_PX !== undefined ? TC.SWIPE_MIN_PX : 20)) {
                const camera = window.flux.gameInstance.camera;
                const fwd = new THREE.Vector3();
                const right = new THREE.Vector3();

                if (camera) {
                    camera.getWorldDirection(fwd);
                    fwd.y = 0;
                    if (fwd.lengthSq() < 0.001) fwd.set(0, 0, -1);
                    else fwd.normalize();

                    right.crossVectors(fwd, new THREE.Vector3(0, 1, 0)).normalize();

                    const worldVec = new THREE.Vector3();
                    worldVec.addScaledVector(right, dx * (TC.AIM_DX_SCALE !== undefined ? TC.AIM_DX_SCALE : 1.0));
                    worldVec.addScaledVector(fwd, -dy * (TC.AIM_DY_SCALE !== undefined ? TC.AIM_DY_SCALE : 1.0));
                    worldVec.normalize();

                    aimVec = worldVec;
                    this.overrideAimVector = aimVec;
                } else {
                    aimVec = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
                    this.overrideAimVector = null;
                }
            } else {
                aimVec = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
                this.overrideAimVector = null;
            }

// --- ANALOG CURVE LOGIC ---
            // Formula: Curve = Intensity * Speed
            let spinVec = null;
            
if ((TC.CURVE_ENABLED !== false) && curveInput && Math.abs(curveInput.intensity) > (TC.CURVE_INTENSITY_THRESHOLD !== undefined ? TC.CURVE_INTENSITY_THRESHOLD : 0.25)) {
                const rawIntensity = Math.abs(curveInput.intensity);
                const sign = Math.sign(curveInput.intensity); // Positive = Right Hump = Left Curve
                const swipeSpeed = curveInput.speed || 1.0;

                // 1. Base Spin from Arc (Tuned for realism, no cyclones)
// 1. Base Spin from Arc (Herculean Boost)
                let spinMag = rawIntensity * (TC.CURVE_SPIN_SCALE !== undefined ? TC.CURVE_SPIN_SCALE : 1000.0);

                // 2. Speed Bonus (Quickness adds RPM)
                const speedBonus = Math.max(1.0, swipeSpeed * (TC.CURVE_SPEED_MULT !== undefined ? TC.CURVE_SPEED_MULT : 1.5));
                spinMag *= speedBonus;

                // Cap (Increased to 1500 for massive arcs)
                spinMag = Math.min((TC.CURVE_SPIN_CAP !== undefined ? TC.CURVE_SPIN_CAP : 1500.0), spinMag);

                // Apply Spin
                // Right Hump (Positive Intensity) -> Left Curve (Positive Spin Y)
                spinVec = new THREE.Vector3(0, spinMag * sign, 0);
                
if (spinMag > (TC.CURVE_PERFECT_SPIN !== undefined ? TC.CURVE_PERFECT_SPIN : 500.0) && window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("PERFECT CURVE", this.mesh.position, "tech");
                    if (window.flux.gameInstance.cameraManager) {
                        window.flux.gameInstance.cameraManager.addShake(0.5);
                        window.flux.gameInstance.cameraManager.addRollImpulse(sign * -0.3); // Tilt camera into the curve
                    }
                }
            }

            // Determine Type (Pass vs Shoot)
// Determine Type (Pass vs Shoot)
            const goalZ = (this.team && this.team.side === 1) ? -46 : 46;
            const goalDir = new THREE.Vector3(0, 0, goalZ - this.mesh.position.z).normalize();
            const dotGoal = aimVec.dot(goalDir);

            let type = 'PA';
            const distToGoal = Math.abs(this.mesh.position.z - goalZ);

            if (dotGoal > 0.8 && distToGoal < 35.0) {
                type = 'SH';
            } else if (dotGoal > 0.5 && distToGoal < 20.0) {
                type = 'SH';
            }

            // Smart Pass Override
            const targetMate = this._findPassTargetInCone(aimVec);
            if (targetMate && type === 'SH') {
                const distMate = this.mesh.position.distanceTo(targetMate.mesh.position);
                if (distMate < 12.0) type = 'PA';
            }

            const ball = window.flux.gameInstance.entities.ball;
            if (ball) {
                this.throwBall(ball, type, multiplier, spinVec);
            }
        }

        // NEW: Charge UI methods
        _updateChargeUI(ratio) {
            const meter = document.getElementById('charge-meter-fill');
            if (meter) {
                meter.style.width = `${ratio * 100}%`;
                if (ratio > 0.9) {
                    meter.style.background = 'linear-gradient(90deg, #ff0, #f80)';
                } else if (ratio > 0.5) {
                    meter.style.background = 'linear-gradient(90deg, #0f0, #ff0)';
                } else {
                    meter.style.background = 'linear-gradient(90deg, #0af, #0f0)';
                }
            }
            const container = document.getElementById('charge-meter-container');
            if (container) container.style.display = 'block';
        }

        _hideChargeUI() {
            const container = document.getElementById('charge-meter-container');
            if (container) container.style.display = 'none';
        }

        setOverrideAim(x, z) {
            if (!this.overrideAimVector) this.overrideAimVector = new THREE.Vector3();
            this.overrideAimVector.set(x, 0, z).normalize();
        }

loseBall() {
            this.hasBall = false;
            this._hidePassTargetIndicators();
            // Fix: Ensure player can catch again if they lose possession unexpectedly
            this.canCatch = true;
            // Safety: Reset states to prevent locking
            this.isThrowing = false;
            this.isCharging = false;
            this._hideChargeUI();
        }

update(dt) {
            if (!this.mesh) return;

            // SYNC FIX: If ball thinks I hold it, but I don't, force receive
            if (this.ballRef && this.ballRef.holder === this && !this.hasBall) {
                console.warn("Syncing ball possession to player");
                this.receiveBall();
            }
            // Input smoothing (less twitchy / more "swimmy")
            const settings = (window.flux && window.flux._debugIO) ? window.flux._debugIO.settings : null;
            const AC = window.flux.AssistConfig || {};
            const inputResp = (settings && typeof settings.inputResponse === 'number') ? settings.inputResponse : (AC.INPUT_RESPONSE !== undefined ? AC.INPUT_RESPONSE : 14.0);
            const steeringAssist = Math.max(0, Math.min(1, (settings && typeof settings.steeringAssist === 'number') ? settings.steeringAssist : (AC.STEERING_ASSIST !== undefined ? AC.STEERING_ASSIST : 0.0)));

            // Higher speed -> a touch more damping so you're not over-steering.
            const speedNow = this.velocity.length();
            const resp = Math.max(4.0, inputResp * (1.0 + 0.25 * steeringAssist) * (speedNow > 6.0 ? 0.85 : 1.0));
            const tInput = 1 - Math.pow(0.001, dt * resp);
            this.inputVector.lerp(this.desiredInputVector, tInput);

            if (this.isGodMode) {
                this.stats.HP = this.stats.maxHP;
                this.currentEN = this.getStat('EN');
                this.status.venom = 0;
                this.status.nap = 0;
            }

            // Animation: layered mixing (base locomotion + upper-body overlay + one-shots)
            if (this._layeredEnabled) this._updateLayeredAnimation(dt);
            else this._updateLocomotionAnim(0.2);

            if (this.mixer) {
                this.mixer.update(dt);
            }


            this._updateStatus(dt);

            // Charge Logic
// Charge Logic
            if (this.isCharging) {
                if (!this.hasBall || this.status.nap > 0 || this.stunTimer > 0) {
                    this.isCharging = false;
                    this.mesh.position.y = 0;
                    this.mesh.scale.setScalar(this.baseScale);
                    this._hideChargeUI();
                } else {
this.chargeTime += dt;
                    
                    // AUTO-RELEASE: If held too long (3s), force release to prevent stuck state
                    if (this.chargeTime > 3.0) {
                        this.releaseCharge(0, 0); // Force weak shot
                        return;
                    }

                    const ratio = Math.min(this.chargeTime / this.maxChargeTime, 1.0);
                    
                    // Levitation (Powering up)
                    const hover = (Math.sin(Date.now() * 0.02) * 0.1) + (ratio * 0.8);
                    
                    // Vibration (Intensity increases with charge)
                    const shake = 0.05 + (0.1 * ratio);
                    
                    // Apply Y offset (Hover + Jitter)
                    this.mesh.position.y = hover + (Math.random() - 0.5) * shake;
                    
                    // Apply Rotation Jitter (via banking/pitch variables)
                    // This avoids positional drift while giving a "struggling to contain power" look
                    this.bankingAmount += (Math.random() - 0.5) * shake;
                    this.pitchAmount += (Math.random() - 0.5) * shake;

                    // Ensure scale stays normal (Remove swelling effect)
                    this.mesh.scale.setScalar(this.baseScale);

                    this._updateChargeUI(ratio);
                }
            }
if (this.dashCooldown > 0) this.dashCooldown -= dt;
            if (this.clashCooldown > 0) this.clashCooldown -= dt;
            if (this.stunTimer > 0) this.stunTimer -= dt;
            if (this.immunityTimer > 0) this.immunityTimer -= dt;
            if (this.catchCooldown > 0) {
                this.catchCooldown -= dt;
                if (this.catchCooldown <= 0) this.canCatch = true;
            }
            // Dash Logic
// Dash Logic
            if (this.isDashing) {
                this.dashTime -= dt;
                
                this._dashParticleTimer -= dt;
                if (this._dashParticleTimer <= 0) {
                    this._dashParticleTimer = 0.03;
                    if (window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                        const back = this.velocity.clone().normalize().negate();
                        if (back.lengthSq() < 0.1) back.set(0, 0, 1);
                        
                        const pos = this.mesh.position.clone().add(back.multiplyScalar(0.5));
                        pos.y += 1.0 + (Math.random() - 0.5) * 0.5;
                        pos.x += (Math.random() - 0.5) * 0.5;
                        pos.z += (Math.random() - 0.5) * 0.5;
                        
                        window.flux.gameInstance.particleManager.spawn('dash_stream', pos, { scale: 2.5 });
                    }
                }

                // Smooth Rotation during Dash
                let diff = this.targetYaw - this.currentYaw;
                while (diff > Math.PI) diff -= Math.PI * 2;
                while (diff < -Math.PI) diff += Math.PI * 2;
                
                const turnSpeed = 15.0; // Fast turning for dash
                const change = Math.max(-turnSpeed * dt, Math.min(turnSpeed * dt, diff));
                this.currentYaw += change;

                this._checkTackleCollision();
                
                if (this.dashTime <= 0) {
                    this.isDashing = false;
                    this.mesh.position.y = 0;
                    this.dashType = null;
                } else {
                    if (this.dashType === 'vertical') {
                        _pVec.copy(this.dashVec).multiplyScalar(dt);
                        this.mesh.position.add(_pVec);
                        const t = 1 - (this.dashTime / this.dashTotalTime);
                        this.mesh.position.y = Math.sin(t * Math.PI) * 3.0;
                    } else {
                        // Horizontal Dash Movement
                        _pVec.copy(this.velocity).multiplyScalar(dt);
                        this.mesh.position.add(_pVec);
                        this.mesh.position.y = 0;

                        // Visual Tackle Lean (Shoulder Bash Animation)
                        const t = 1 - (this.dashTime / this.dashTotalTime); // 0 to 1
                        const lean = Math.sin(t * Math.PI); // Peak at 1.0 in middle
                        
                        // Re-apply base facing + Aggressive Shoulder Check
// Re-apply base facing + Aggressive Shoulder Check
                        _pQuat.setFromAxisAngle(_pAxisY, this.currentYaw + this.rotationOffset);
                        
                        let pitch = 0;
                        let yaw = 0;
                        let roll = 0;
                        let lungeAmt = 0;

                        if (this.dashType === 'horizontal' || this.dashType === 'break') {
                             // TACKLE/BREAK: Aggressive Shoulder Check
                             pitch = 1.2 * lean; // Head down / Lean forward
                             yaw = 0.8 * lean;   // Turn shoulder into target
                             roll = -0.6 * lean; // Dip shoulder
                             lungeAmt = 0.8 * lean; // Thrust mesh forward visually
                        } else if (this.dashType === 'sprint') {
                             // SPRINT: Aerodynamic lean
                             pitch = 0.5 * lean; 
                             lungeAmt = 0.2 * lean;
                        }

                        // Apply Lunge (Visual Offset)
                        if (lungeAmt > 0) {
                             _pVec.set(0, 0, lungeAmt).applyQuaternion(_pQuat);
                             this.mesh.position.add(_pVec);
                        }

                        _pEuler.set(pitch, yaw, roll);
                        _pQuat2.setFromEuler(_pEuler);
                        this.mesh.quaternion.multiplyQuaternions(_pQuat, _pQuat2);

                        this.velocity.multiplyScalar(0.96);

                        this.velocity.multiplyScalar(0.96);
                    }
                }
                return;
            }
            // Stun/Nap Check
            if (this.status.nap > 0 || this.stunTimer > 0) {
                const dragFactor = Math.max(0, 1 - (2.0 * dt));
                this.velocity.multiplyScalar(dragFactor);

                _pVec.copy(this.velocity).multiplyScalar(dt);
                this.mesh.position.add(_pVec);

                if (!this._layeredEnabled && !this._animLocked && this.state !== 'idle' && this.state !== 'catch') this.play('idle', 0.5);

                this._updateHPBar();
                this._updatePassTargetIndicators();
                return;
            }

            this._checkTacklePressure(dt);

            if (this.isThrowing) {
                this.velocity.multiplyScalar(Math.max(0, 1.0 - (2.0 * dt)));

                this._applySoftCollision(dt);
                this._applyGoalCrease(dt);

                _pVec.copy(this.velocity).multiplyScalar(dt);
                this.mesh.position.add(_pVec);

this._updateVerticality(dt);
                this._updateBanking(dt); // Enable rotation during throw

            } else {
                this._updatePhysics(dt);
                this._updateVerticality(dt);
                this._updateBanking(dt);
            }

this._updateHPBar();
            this._updatePassTargetIndicators();

            // Bubble Trail Logic
// Bubble Trail Logic (Dynamic)
            const speedSq = this.velocity.lengthSq();
            if (speedSq > 1.0 && window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                this._bubbleTimer -= dt;
                if (this._bubbleTimer <= 0) {
                    const pm = window.flux.gameInstance.particleManager;
                    const backDir = this.velocity.clone().normalize().negate();
                    
                    // 1. Standard Wake (Always spawn)
                    const offset = backDir.clone().multiplyScalar(0.8);
                    offset.y = 0.5 + Math.random() * 0.5; 
                    offset.x += (Math.random()-0.5) * 0.5;
                    offset.z += (Math.random()-0.5) * 0.5;
                    pm.spawn('bubble', this.mesh.position.clone().add(offset), { scale: 0.15 + Math.random() * 0.25 });

                    // 2. Cavitation (High Speed) - Add on top
                    const isHighSpeed = speedSq > 40.0; 
                    if (isHighSpeed) {
                        for(let i=0; i<3; i++) {
                            const mOffset = backDir.clone().multiplyScalar(0.5 + Math.random()*0.5);
                            mOffset.x += (Math.random()-0.5)*0.8;
                            mOffset.y = 0.5 + (Math.random()-0.5)*0.8; 
                            mOffset.z += (Math.random()-0.5)*0.8;
                            
                            pm.spawn('bubble_micro', this.mesh.position.clone().add(mOffset), { scale: 0.06 + Math.random()*0.08 });
                        }
                        this._bubbleTimer = 0.03; 
                    } else {
                        this._bubbleTimer = 0.1; 
                    }
                }
            }
}

        _updateStatus(dt) {
            const pm = window.flux.gameInstance ? window.flux.gameInstance.particleManager : null;

            if (this.status.venom > 0) {
                this.status.venom -= dt;
                this.stats.HP -= 5 * dt;
                if (this.stats.HP < 0) this.stats.HP = 0;

                this._particleTimers.venom -= dt;
                if (this._particleTimers.venom <= 0 && pm) {
                    pm.spawn('venom', this.mesh.position);
                    this._particleTimers.venom = 0.15;
                }
            } else {
                if (!this.hasBall && this.stats.HP < this.stats.maxHP) {
                    this.stats.HP += 5 * dt;
                    if (this.stats.HP > this.stats.maxHP) this.stats.HP = this.stats.maxHP;
                }
            }

            if (this.hasBall) {
                this.stats.HP -= 2.0 * dt;
                if (this.stats.HP < 0) this.stats.HP = 0;
            }

            if (this.status.nap > 0) {
                this.status.nap -= dt;

                this._particleTimers.nap -= dt;
                if (this._particleTimers.nap <= 0 && pm) {
                    pm.spawn('nap', this.mesh.position);
                    this._particleTimers.nap = 0.8;
                }
            }

            let isWithering = false;
            for (let key in this.status.wither) {
                if (this.status.wither[key] > 0) {
                    this.status.wither[key] -= dt;
                    isWithering = true;
                }
            }

            if (isWithering) {
                this._particleTimers.wither -= dt;
                if (this._particleTimers.wither <= 0 && pm) {
                    pm.spawn('wither', this.mesh.position);
                    this._particleTimers.wither = 0.2;
                }
            }

            this._updateVisuals();
        }

_updateVisuals() {
            // REMOVED: Yellow sphere/tint logic as per request.
            // Always revert to base color.
            this.originalMaterials.forEach(entry => {
                entry.material.color.copy(entry.baseColor);
            });
        }

        _createAura() {
            // Aura removed per user request
            this.auraMesh = null;
        }

        // NEW: Pass target indicator
        _createPassTargetIndicator() {
            // Create a ring that highlights potential pass targets
            const geo = new THREE.RingGeometry(0.8, 1.0, 16);
            const mat = new THREE.MeshBasicMaterial({
                color: 0x00ff00,
                transparent: true,
                opacity: 0.6,
                side: THREE.DoubleSide
            });
            this.passTargetIndicator = new THREE.Mesh(geo, mat);
            this.passTargetIndicator.rotation.x = -Math.PI / 2;
            this.passTargetIndicator.position.y = 0.1;
            this.passTargetIndicator.visible = false;
            this.scene.add(this.passTargetIndicator);
        }

        _updatePassTargetIndicators() {
            if (!this.hasBall || !this.team) {
                this._hidePassTargetIndicators();
                return;
            }

            // Find best pass target
            const aimDir = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion);
            const target = this._findPassTargetInCone(aimDir);

            if (target && target.mesh && this.passTargetIndicator) {
                this.passTargetIndicator.visible = true;
                this.passTargetIndicator.position.x = target.mesh.position.x;
                this.passTargetIndicator.position.z = target.mesh.position.z;
                this.passTargetIndicator.position.y = 0.1;
                this.passTargetIndicator.rotation.z += 0.05;
            } else {
                this._hidePassTargetIndicators();
            }
        }

        _hidePassTargetIndicators() {
            if (this.passTargetIndicator) {
                this.passTargetIndicator.visible = false;
            }
        }

_applySoftCollision(dt) {
            if (!this.mesh || !window.flux.gameInstance) return;

            const game = window.flux.gameInstance;
            const teams = [game.teams.home, game.teams.away];

            const repulsionRadius = 0.5; // Reduced to 0.5 to fix invisible wall issues
            const stiffness = 15.0;

            teams.forEach(team => {
                if (!team) return;
                team.players.forEach(other => {
                    if (other === this || !other.mesh) return;

                    const dx = this.mesh.position.x - other.mesh.position.x;
                    const dy = this.mesh.position.y - other.mesh.position.y;
                    const dz = this.mesh.position.z - other.mesh.position.z;

                    const distSq = dx*dx + dy*dy + dz*dz;
                    const minDist = repulsionRadius * 2.0;

                    if (distSq < minDist * minDist && distSq > 0.0001) {
                        const dist = Math.sqrt(distSq);
                        const overlap = minDist - dist;

                        const force = overlap * stiffness;

                        const nx = dx / dist;
                        const ny = dy / dist;
                        const nz = dz / dist;

                        this.velocity.x += nx * force * dt;
                        this.velocity.y += ny * force * dt;
                        this.velocity.z += nz * force * dt;
                    }
                });
            });
        }

        _updatePhysics(dt) {
            this._applySoftCollision(dt);
this._applyGoalCrease(dt);

            const inputLenSq = this.inputVector.lengthSq();
            const isInputActive = inputLenSq > 0.01;

            let currentMaxSpeed = this.maxSpeed;
if (this.isEngaged) currentMaxSpeed *= 0.8; // Buffed from 0.5 to allow escape
            if (this.isCharging) currentMaxSpeed *= 0.9;

            if (isInputActive) {
                _pVec.copy(this.inputVector).normalize();

                const targetVelX = _pVec.x * currentMaxSpeed;
                const targetVelZ = _pVec.z * currentMaxSpeed;

                const currentSpeed = this.velocity.length();
                const speedRatio = Math.min(1.0, currentSpeed / this.maxSpeed);

                const agility = THREE.MathUtils.lerp(10.0, 2.0, speedRatio);

                const t = 1.0 - Math.pow(0.01, dt * agility);

                this.velocity.x += (targetVelX - this.velocity.x) * t;
                this.velocity.z += (targetVelZ - this.velocity.z) * t;

                if (!this._layeredEnabled && !this._animLocked && this.state !== 'swim') this.play('swim', 0.2);

            } else {
                const brakeFactor = 2.0;
                const t = 1.0 - Math.pow(0.1, dt * brakeFactor);

                this.velocity.x += (0 - this.velocity.x) * t;
                this.velocity.z += (0 - this.velocity.z) * t;

                if (this.velocity.lengthSq() < 0.01) {
                    this.velocity.set(0, this.velocity.y, 0);
                }

                if (!this._layeredEnabled && !this._animLocked && this.state !== 'idle' && this.state !== 'catch' && this.state !== 'throw' && this.state !== 'react') {
                    this.play('idle', 0.3);
                }
            }

            this.velocity.y *= Math.max(0, 1.0 - (2.0 * dt));

            _pVec.copy(this.velocity).multiplyScalar(dt);
            this.mesh.position.add(_pVec);
        }

        _updateVerticality(dt) {
            let targetY = 0;

            const ball = window.flux.gameInstance.entities.ball;

            if (ball && ball.mesh && !this.hasBall) {
                const distToBall = this.mesh.position.distanceTo(ball.mesh.position);
                if (distToBall < 15.0) {
                    targetY = ball.mesh.position.y;
                }
            }

            if (this.hasBall) {
                targetY = 0.5;
            }

            const yDiff = targetY - this.mesh.position.y;

            const lift = yDiff * 10.0 * dt;
            this.velocity.y += lift;

            if (this.mesh.position.y > 8.0) {
                this.mesh.position.y = 8.0;
                this.velocity.y *= -0.5;
            } else if (this.mesh.position.y < -8.0) {
                this.mesh.position.y = -8.0;
                this.velocity.y *= -0.5;
            }
        }

        // FIXED: Improved banking with hysteresis to prevent facing flips
// FIXED: Improved banking with hysteresis to prevent facing flips
        _updateBanking(dt) {
            const inputLenSq = this.inputVector.lengthSq();
            const velLenSq = this.velocity.lengthSq();

            let targetYaw = this.targetYaw;
            let shouldUpdateYaw = false;

            // PRIORITY 1: Explicit Aim (Aim Stick / Swipe)
            if (this.overrideAimVector) {
                targetYaw = Math.atan2(this.overrideAimVector.x, this.overrideAimVector.z);
                shouldUpdateYaw = true;
            }
            // PRIORITY 2: Movement Input
            else if (inputLenSq > this.facingDeadzone * this.facingDeadzone) {
                targetYaw = Math.atan2(this.inputVector.x, this.inputVector.z);
                shouldUpdateYaw = true;
            } 
            // PRIORITY 3: Velocity (Drifting)
            else if (velLenSq > this.facingDeadzone * this.facingDeadzone) {
                targetYaw = Math.atan2(this.velocity.x, this.velocity.z);
                shouldUpdateYaw = true;
            }

            // If we should update, do so. Otherwise keep last valid yaw
            if (shouldUpdateYaw) {
                this.lastValidYaw = targetYaw;
            } else {
                targetYaw = this.lastValidYaw;
            }

            // Smooth Yaw with wrap-around handling
            let diff = targetYaw - this.currentYaw;
            while (diff > Math.PI) diff -= Math.PI * 2;
            while (diff < -Math.PI) diff += Math.PI * 2;

            const speedRatio = Math.min(1.0, this.velocity.length() / this.maxSpeed);
const turnSpeed = THREE.MathUtils.lerp(8.0, 4.0, speedRatio); // Reduced from 12.0/6.0 to reduce flipping

            // Prevent sudden snaps when diff is very large (teleport/reset scenarios)
            const maxYawChange = Math.PI * dt * turnSpeed;
            const yawChange = Math.max(-maxYawChange, Math.min(maxYawChange, diff * dt * turnSpeed));

            this.currentYaw += yawChange;
            this.targetYaw = targetYaw;

            // Banking
            const bankSensitivity = 0.8;
            const maxBank = 0.75;

            let targetBank = -diff * bankSensitivity;
            targetBank = Math.max(-maxBank, Math.min(maxBank, targetBank));

            const bankLerp = 1.0 - Math.pow(0.02, dt);
            this.bankingAmount += (targetBank - this.bankingAmount) * bankLerp;

            // Pitch
            const pitchSensitivity = 0.1;
            const maxPitch = 1.0;

            let targetPitch = -this.velocity.y * pitchSensitivity;
            targetPitch = Math.max(-maxPitch, Math.min(maxPitch, targetPitch));

            const pitchLerp = 1.0 - Math.pow(0.05, dt);
            this.pitchAmount += (targetPitch - this.pitchAmount) * pitchLerp;

            // Apply Rotation
            const finalYaw = this.currentYaw + this.rotationOffset;

            this.mesh.quaternion.setFromAxisAngle(_pAxisY, finalYaw);

            _pQuat.setFromAxisAngle(new THREE.Vector3(1, 0, 0), this.pitchAmount);
            this.mesh.quaternion.multiply(_pQuat);

            _pQuat.setFromAxisAngle(new THREE.Vector3(0, 0, 1), this.bankingAmount);
            this.mesh.quaternion.multiply(_pQuat);

            // Idle Bob
            if (velLenSq < 0.1 && !this.isEngaged) {
                const time = Date.now() * 0.0015;
                const bobPitch = Math.sin(time) * 0.03;
                const bobRoll = Math.cos(time * 0.7) * 0.02;

_pEuler.set(bobPitch, 0, bobRoll);
                _pQuat.setFromEuler(_pEuler);
                this.mesh.quaternion.multiply(_pQuat);
            }
        }

_checkTacklePressure(dt) {
            if (!this.hasBall) {
                this.isEngaged = false;
                this.encounterTimer = 0;
                return;
            }

            if (this.immunityTimer > 0) return;
            if (this.isDashing) return;

            const game = window.flux.gameInstance;
            if (!game || !this.team) return;

            const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
            const opponentTeam = game.teams[opponentTeamId];

            if (!opponentTeam) return;

            let engagedThisFrame = false;
            const effectiveRadius = this.isEngaged ? this.tackleRadius * 1.2 : this.tackleRadius;

            // 1. Check Engagement Status
            for (const entity of opponentTeam.players) {
                if (!entity.mesh || entity.status.nap > 0 || entity.stunTimer > 0) continue;
                const dist = this.mesh.position.distanceTo(entity.mesh.position);
                if (dist < effectiveRadius) {
                    engagedThisFrame = true;
                    break; 
                }
            }

            // 2. Update Timer & UI Feedback
            if (engagedThisFrame) {
                if (!this.isEngaged) {
                    // Just became engaged
                    this.encounterTimer = 0;
                    if (this.team.isHuman && this.team.activePlayer === this && game.floatingText) {
                        game.floatingText.spawn("ENGAGED!", this.mesh.position, "comic-action");
                        // Hint for the player
                        setTimeout(() => {
                            if (this.isEngaged && this.hasBall && game.floatingText) {
                                game.floatingText.spawn("BREAK NOW!", this.mesh.position, "tech");
                            }
                        }, 200);
                    }
                }
                this.encounterTimer += dt;
            } else {
                this.encounterTimer = 0;
            }

            this.isEngaged = engagedThisFrame;

            // 3. Apply Damage (With Grace Period)
            // Grace Period: 0.5s before damage starts ticking
            if (this.isEngaged && this.encounterTimer > 0.5) {
                for (const entity of opponentTeam.players) {
                    if (!entity.mesh || entity.status.nap > 0 || entity.stunTimer > 0) continue;
                    
                    const dist = this.mesh.position.distanceTo(entity.mesh.position);
                    if (dist < effectiveRadius) {
                        // Discrete Clash Event
                        if (entity.clashCooldown <= 0) {
                            this._resolveClash(entity, game);
                            entity.clashCooldown = 2.0; // Increased cooldown (was 1.5) to reduce spam
                        }
                    }
                }
            }

            if (this.currentEN <= 0) {
                this.fumble();
            }
        }

_resolveClash(opponent, game) {
            const oppAT = opponent.getStat('AT');
            
            // Variance: 0.8 to 1.2
            const variance = 0.8 + Math.random() * 0.4;
            let damage = Math.floor(oppAT * variance);
            if (damage < 1) damage = 1;

            // Directional Shielding
            // Carrier Forward
            _pVec.copy(_pAxisZ).applyQuaternion(this.mesh.quaternion); 
            // Vector To Opponent
            const toOpp = opponent.mesh.position.clone().sub(this.mesh.position).normalize();
            
            const dot = _pVec.dot(toOpp);
            
            // If opponent is BEHIND (dot < -0.2), damage is reduced (Shielding).
            let isShielded = false;
            if (dot < -0.2) {
                damage = Math.floor(damage * 0.5);
                isShielded = true;
            }

            // Apply Damage
            this.currentEN -= damage;
            if (this.currentEN < 0) this.currentEN = 0;

            // Tech Effects
            if (opponent.techs.tackle) {
                if (opponent.techs.tackle === 'venom') {
                    this.applyStatus('venom', 10.0);
                    damage += 3;
                } else if (opponent.techs.tackle === 'wither') {
                    const stats = ['PA', 'SH', 'AT', 'EN'];
                    const target = stats[Math.floor(Math.random() * stats.length)];
                    this.applyStatus('wither', 10.0, target);
                    damage += 3;
                } else if (opponent.techs.tackle === 'drain') {
                    this.stats.HP -= damage; 
                    opponent.stats.HP += damage;
                    if (game.floatingText) game.floatingText.spawn("DRAIN", this.mesh.position, "heal");
                }
            }

            // Visuals - JUICED UP
            const midPos = this.mesh.position.clone().lerp(opponent.mesh.position, 0.5);
            midPos.y += 1.5;

            if (game.floatingText) {
                if (isShielded) {
                    setTimeout(() => {
                        if (game.floatingText) game.floatingText.spawn("SHIELD", this.mesh.position, "block");
                    }, 100);
                }
                
                // Damage feedback
                game.floatingText.spawn(`${damage}`, this.mesh.position, "damage");
            }

            if (game.particleManager) {
                // Massive Impact Juice
                game.particleManager.spawn('shockwave', midPos, { scale: 3.0, life: 0.4 });
                game.particleManager.spawn('flash', midPos, { scale: 4.0 });
                // Debris shower
                for(let i=0; i<6; i++) {
                    game.particleManager.spawn('debris', midPos, { scale: 0.4 });
                }
            }

            if (game.cameraManager) {
                // HERCULEAN SHAKE
                game.cameraManager.addShake(2.5); // Increased from 1.2
                game.cameraManager.addFovImpulse(-5); // Zoom in impact
            }
            
            if (game.triggerImpact) {
                // Freeze frame
                game.triggerImpact(0.15, 'heavy');
            }

            opponent.gainExp(2);
        }

        _performJechtKnockback() {
            if (!this.team) return;
            const game = window.flux.gameInstance;
            const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
            const opponentTeam = game.teams[opponentTeamId];

            if (!opponentTeam) return;

            const range = 6.0;
            const force = 25.0;

            if (game.floatingText) {
                game.floatingText.spawn("JECHT SHOT!", this.mesh.position, "goal");
            }

            opponentTeam.players.forEach(p => {
                if (!p.mesh) return;
                const dist = this.mesh.position.distanceTo(p.mesh.position);
                if (dist < range) {
                    const dir = p.mesh.position.clone().sub(this.mesh.position).normalize();
                    dir.y = 0.5;
                    dir.normalize();

                    p.velocity.add(dir.multiplyScalar(force));

                    p.isDashing = false;
                    const reactAction = p.actions && p.actions['react'];
                    if (reactAction) {
                        reactAction.setLoop(THREE.LoopOnce);
                        reactAction.clampWhenFinished = true;
                        p.playOneShot('react', 0.1);
} else {
                        p.play('catch', 0.5);
                    }

                    if (game.floatingText) {
                        game.floatingText.spawn("SMACK!", p.mesh.position, "damage");
                    }
                    if (game.triggerImpact) game.triggerImpact(0.15, 'shatter');
                }
            });
        }

        fumble() {
            console.log("FUMBLE! EN Depleted.");
            if (window.flux.gameInstance.floatingText && this.mesh) {
                window.flux.gameInstance.floatingText.spawn("CRASH!", this.mesh.position, "comic-impact");
            }

            this.stunTimer = 1.5;

            const backDir = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize().negate();
            backDir.x += (Math.random() - 0.5) * 0.5;
            backDir.z += (Math.random() - 0.5) * 0.5;
            backDir.normalize();

            this.velocity.add(backDir.multiplyScalar(12.0));

            if (this.hasBall) {
                const ball = window.flux.gameInstance.entities.ball;
                if (ball) {
                    const ejectDir = new THREE.Vector3(Math.random()-0.5, 0.8, Math.random()-0.5).normalize();
                    ball.shoot(ejectDir, 6.0, 'none');
this.loseBall();
                    this.canCatch = false;

                    this.currentEN = 0;
                }
            }
        }

        dash(x, z) {
            if (this.isDashing || this.dashCooldown > 0) return;
            if (this.status.nap > 0) return;

            // OFFENSE: BREAK TACKLE
            if (this.hasBall && this.isEngaged) {
                const cost = 15;

                if (this.currentEN < cost) {
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("FAILED!", this.mesh.position, "damage");
                    }
                    this.fumble();
                    return;
                }

                this.currentEN -= cost;
                this.isDashing = true;
                this.dashTime = 0.4;
                this.dashCooldown = 2.0;
                this.dashType = 'break';

_pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
                this.velocity.add(_pVec.multiplyScalar(15.0));

                const game = window.flux.gameInstance;
                const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
                const opponentTeam = game.teams[opponentTeamId];

                opponentTeam.players.forEach(p => {
                    if (!p.mesh) return;
                    const dist = this.mesh.position.distanceTo(p.mesh.position);
                    if (dist < this.tackleRadius * 1.5) {
                        const pushDir = p.mesh.position.clone().sub(this.mesh.position).normalize();
                        pushDir.y = 0.5;
                        p.velocity.add(pushDir.multiplyScalar(15.0));

                        p.stunTimer = 2.0;
                        p.play('catch', 0.2);

                        if (game.floatingText) {
                            game.floatingText.spawn("STUN!", p.mesh.position, "damage");
                        }
                    }
                });

if (game.floatingText) {
                    game.floatingText.spawn("BREAK!", this.mesh.position, "tech");
                }
                
// NEW: Spawn Break Glyph (Explosive Burst)
                if (game.glyphManager) {
                    game.glyphManager.spawn('status', this.mesh.position, {
                        parent: this,
                        life: 0.5,
                        rotationSpeed: 8.0,
                        scaleSpeed: 3.0,
                        offsetY: 0.5
                    });
                }
                
// Particle Burst (Break Tackle)
                if (game.particleManager) {
                    game.particleManager.spawn('shockwave', this.mesh.position, { scale: 2.0, life: 0.3 });
                    game.particleManager.spawn('flash', this.mesh.position, { scale: 2.5 });
                    // Bubble Burst
                    for(let i=0; i<30; i++) {
const bPos = this.mesh.position.clone().add(_pVec.set((Math.random()-0.5), 1.0+(Math.random()-0.5), (Math.random()-0.5)));
                    game.particleManager.spawn('bubble', bPos, { scale: 0.2 + Math.random() * 0.4 });
                    }
                }

                if (game.triggerImpact) game.triggerImpact(0.15, 'heavy');

                return;
            }

            // OFFENSE: SPRINT
            if (this.hasBall) {
                const cost = 5;
                if (this.currentEN < cost) {
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("NO EN!", this.mesh.position, "damage");
                    }
                    return;
                }

                this.currentEN -= cost;
                this.isDashing = true;
                this.dashTime = 0.4;
                this.dashCooldown = 1.5;
                this.dashType = 'sprint';

const burstDir = this.velocity.clone().normalize();
                if (burstDir.lengthSq() < 0.1) burstDir.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);

                this.velocity.add(burstDir.multiplyScalar(15.0));

                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.addFovImpulse(20);
                }
                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("DASH!", this.mesh.position, "tech");
                }
                return;
            }

            // DEFENSE: BLOCK / TACKLE
            const ball = window.flux.gameInstance.entities.ball;
            let isBlockContext = false;
            if (ball && ball.mesh) {
                const dist = this.mesh.position.distanceTo(ball.mesh.position);
                if (dist < 8.0 && ball.mesh.position.y > 2.5) {
                    isBlockContext = true;
                }
            }

            this.isDashing = true;
            this.dashTime = this.dashTotalTime;
            this.dashCooldown = 1.5;

            const len = Math.sqrt(x*x + z*z);
            const nx = (len > 0) ? x/len : 0;
            const nz = (len > 0) ? z/len : 0;

if (len > 0) {
                // Smooth turn for dash instead of snap
                this.targetYaw = Math.atan2(nx, nz);
            }
            if (isBlockContext) {
                this.dashType = 'vertical';

                const dirToBall = ball.mesh.position.clone().sub(this.mesh.position);
                dirToBall.y = 0;

                if (dirToBall.lengthSq() > 0.01) {
                    dirToBall.normalize();
                    this.dashVec.copy(dirToBall).multiplyScalar(8.0);
                } else {
                    this.dashVec.set(0, 0, 0);
                }

                const catchAction = this.actions['catch'];
                if (catchAction) {
                    catchAction.setLoop(THREE.LoopOnce);
                    catchAction.clampWhenFinished = true;
                    catchAction.timeScale = 1.5;
                }
                this.play('catch', 0.1);

                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("BLOCK!", this.mesh.position, "default");
                }

            } else {
                this.dashType = 'horizontal';
                this._hasHitTackle = false;

                // Apply velocity impulse in dash direction
// Apply velocity impulse in dash direction
                _pVec.set(nx, 0, nz);
                if (_pVec.lengthSq() < 0.1) {
                    _pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
                }
                this.velocity.add(_pVec.multiplyScalar(20.0));

                const lungeAction = this.actions['throw'];
                if (lungeAction) {
                    lungeAction.setLoop(THREE.LoopOnce);
                    lungeAction.clampWhenFinished = true;
                    lungeAction.timeScale = 2.0;
                }
                this.play('throw', 0.1);

                if (window.flux.gameInstance.triggerImpact) window.flux.gameInstance.triggerImpact(0.05, 'default');
            }

if (window.flux.gameInstance.cameraManager) {
                window.flux.gameInstance.cameraManager.addFovImpulse(10);
                window.flux.gameInstance.cameraManager.addShake(0.3); 
            }
            // Dash Effect
            if (window.flux.gameInstance.particleManager) {
                const dashPos = this.mesh.position.clone();
                dashPos.y += 1.0;
                window.flux.gameInstance.particleManager.spawn('shockwave', dashPos, { scale: 1.5, life: 0.3 });
                // Speed lines
                const back = this.velocity.clone().normalize().negate();
                for(let i=0; i<3; i++) {
                    const p = dashPos.clone().add(back.multiplyScalar(Math.random()));
                    p.x += (Math.random()-0.5);
                    window.flux.gameInstance.particleManager.spawn('dash_stream', p, { scale: 1.5 });
                }
            }
        }

        _createHPBar() {
            const container = new THREE.Group();

            const bgGeo = new THREE.PlaneGeometry(1.2, 0.15);
            const bgMat = new THREE.MeshBasicMaterial({ color: 0x000000, side: THREE.DoubleSide, depthTest: false });
            const bg = new THREE.Mesh(bgGeo, bgMat);
            container.add(bg);

            const fillGeo = new THREE.PlaneGeometry(1.16, 0.11);
            fillGeo.translate(0.58, 0, 0);
            const fillMat = new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.DoubleSide, depthTest: false });
            this.hpBarFill = new THREE.Mesh(fillGeo, fillMat);
            this.hpBarFill.position.set(-0.58, 0, 0.01);
            container.add(this.hpBarFill);

            this.hpBar = container;
            this.scene.add(this.hpBar);
        }

        _updateHPBar() {
            if (!this.hpBar || !this.mesh) return;

            this.hpBar.position.copy(this.mesh.position);
            this.hpBar.position.y += 2.2;

            if (window.flux.gameInstance && window.flux.gameInstance.camera) {
                this.hpBar.lookAt(window.flux.gameInstance.camera.position);
            }

            const pct = Math.max(0, this.stats.HP / this.stats.maxHP);
            this.hpBarFill.scale.setX(pct);

            if (pct > 0.5) this.hpBarFill.material.color.setHex(0x00ff00);
            else if (pct > 0.25) this.hpBarFill.material.color.setHex(0xffff00);
            else this.hpBarFill.material.color.setHex(0xff0000);

            this.hpBar.visible = (pct < 0.98);
        }

        gainExp(amount) {
            if (!window.flux.gameInstance || window.flux.gameInstance.state !== 'active') return;

            this.exp += amount;

            if (this.exp >= this.nextLevelExp) {
                this.levelUp();
            }
        }

        levelUp() {
            this.level++;
            this.exp -= this.nextLevelExp;
            this.nextLevelExp = Math.floor(this.nextLevelExp * 1.5);

            const keys = ['HP', 'EN', 'AT', 'PA', 'BL', 'SH', 'CA', 'SP'];

            const hpGain = Math.floor(Math.random() * 20) + 10;
            this.stats.maxHP += hpGain;
            this.stats.HP = this.stats.maxHP;

            keys.forEach(k => {
                if (k === 'HP') return;
                if (Math.random() > 0.4) {
                    const gain = Math.floor(Math.random() * 2) + 1;
                    this.stats[k] += gain;
                }
            });

            this._updateDerivedStats();

            console.log(`${this.role} reached Level ${this.level}!`);

            if (window.flux.gameInstance.floatingText && this.mesh) {
                window.flux.gameInstance.floatingText.spawn("LEVEL UP!", this.mesh.position, "tech");
            }
        }

        _checkTackleCollision() {
            if (!this.team || this._hasHitTackle) return;

            const game = window.flux.gameInstance;
            if (!game) return;

            const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
            const opponentTeam = game.teams[opponentTeamId];

            for (const opp of opponentTeam.players) {
                if (!opp.mesh) continue;
                const dist = this.mesh.position.distanceTo(opp.mesh.position);

if (dist < 3.0) { // Increased from 2.0 for easier hits
                    this._resolveTackleHit(opp);
                    this._hasHitTackle = true;
                    return;
                }
            }
        }

        _resolveTackleHit(opp) {
            this.isDashing = false;
            this.velocity.multiplyScalar(-0.5);
            if (!this._layeredEnabled) this.play('idle', 0.2);

            const at = this.getStat('AT');
            let damage = at * 3.0;

            if (this.techs.tackle === 'venom') {
                opp.applyStatus('venom', 10.0);
                damage += 5;
            } else if (this.techs.tackle === 'wither') {
                opp.applyStatus('wither', 10.0, 'EN');
                damage += 5;
            } else if (this.techs.tackle === 'drain') {
                this.stats.HP += 20;
                opp.stats.HP -= 20;
                if (window.flux.gameInstance.floatingText)
                    window.flux.gameInstance.floatingText.spawn("DRAIN", this.mesh.position, "heal");
            }

            if (opp.hasBall) {
                opp.currentEN -= damage;

if (window.flux.gameInstance.floatingText) {
                    // Removed "EN" suffix for cleaner look
                    window.flux.gameInstance.floatingText.spawn(`${Math.floor(damage)}`, opp.mesh.position, "damage");
                    window.flux.gameInstance.floatingText.spawn("BAM!", opp.mesh.position, "comic-impact");
                }

                if (opp.currentEN <= 0) {
                    opp.fumble();
                } else {
                    opp.stunTimer = 0.5;
                    opp.playOneShot('react', 0.1);
}

                if (this.techs.tackle && window.flux.gameInstance.triggerTechEvent) {
                    window.flux.gameInstance.triggerTechEvent(this, this.techs.tackle);
                }

            } else {
                opp.stunTimer = 1.0;
                opp.playOneShot('react', 0.1);
if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("SMACK!", opp.mesh.position, "comic-impact");
                }
            }

            const pushDir = opp.mesh.position.clone().sub(this.mesh.position).normalize();
            pushDir.y = 0.2;
            opp.velocity.add(pushDir.multiplyScalar(12.0));

            if (window.flux.gameInstance.triggerImpact) window.flux.gameInstance.triggerImpact(0.1, 'heavy');
            if (window.flux.gameInstance.cameraManager) window.flux.gameInstance.cameraManager.addShake(0.8);
            if (window.flux.gameInstance.spawnClash) {
const mid = this.mesh.position.clone().add(opp.mesh.position).multiplyScalar(0.5);
                window.flux.gameInstance.spawnClash(mid);
            }
            
// Bubble Burst (Tackle Hit)
// Bubble Burst (Tackle Hit)
            if (window.flux.gameInstance.particleManager) {
                const mid = this.mesh.position.clone().lerp(opp.mesh.position, 0.5);
                mid.y += 1.0;
                for(let i=0; i<30; i++) {
                    const bubblePos = mid.clone().add(new THREE.Vector3((Math.random()-0.5)*1.5, (Math.random()-0.5)*1.5, (Math.random()-0.5)*1.5));
                    window.flux.gameInstance.particleManager.spawn('bubble', bubblePos, { scale: 0.15 + Math.random() * 0.35 });
                }
            }
        }

        _applyGoalCrease(dt) {

            const goals = [

                new THREE.Vector3(0, 0, 46),
                new THREE.Vector3(0, 0, -46)
            ];

            const radius = 10.0;

            goals.forEach(goal => {
                const dx = this.mesh.position.x - goal.x;
                const dz = this.mesh.position.z - goal.z;
                const distSq = dx*dx + dz*dz;

                if (distSq < radius * radius) {
                    const dist = Math.sqrt(distSq);
                    const pushX = dist > 0 ? dx / dist : 1;
                    const pushZ = dist > 0 ? dz / dist : 0;

                    const force = 50.0;
                    this.velocity.x += pushX * force * dt;
                    this.velocity.z += pushZ * force * dt;

                    if (dist < radius - 0.5) {
                        const clampRatio = radius / (dist + 0.001);
                        this.mesh.position.x = goal.x + dx * clampRatio;
                        this.mesh.position.z = goal.z + dz * clampRatio;
                    }
                }
            });
        }
    }

    window.flux.Player = Player;
})();
</script>
    <script>(function() {
    window.flux = window.flux || {};

// Formation Definitions (Coordinates for Side 1: Defends +Z, Attacks -Z)
    // X: Left(-)/Right(+), Z: Forward(-)/Back(+)
    const FORMATIONS = {
        'Normal': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 15 }, 'RD': { x: 8, z: 15 },
            'MF': { x: 0, z: 5 },
            'LF': { x: -10, z: -10 }, 'RF': { x: 10, z: -10 }
        },
        'Center Attack': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 15 }, 'RD': { x: 8, z: 15 },
            'MF': { x: 0, z: 0 },
            'LF': { x: -4, z: -15 }, 'RF': { x: 4, z: -15 }
        },
        'Right Side': {
            'GL': { x: 0, z: 25 },
            'LD': { x: 0, z: 15 }, 'RD': { x: 12, z: 15 },
            'MF': { x: 10, z: 5 },
            'LF': { x: 5, z: -10 }, 'RF': { x: 15, z: -10 }
        },
        'Left Side': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -12, z: 15 }, 'RD': { x: 0, z: 15 },
            'MF': { x: -10, z: 5 },
            'LF': { x: -15, z: -10 }, 'RF': { x: -5, z: -10 }
        },
        'All-Out Defense': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -6, z: 20 }, 'RD': { x: 6, z: 20 },
            'MF': { x: 0, z: 10 },
            'LF': { x: -10, z: 5 }, 'RF': { x: 10, z: 5 }
        },
        'Flat Line': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 0 }, 'RD': { x: 8, z: 0 },
            'MF': { x: 0, z: 0 },
            'LF': { x: -15, z: 0 }, 'RF': { x: 15, z: 0 }
        },
        'Counter': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 20 }, 'RD': { x: 8, z: 20 },
            'MF': { x: 0, z: 15 },
            'LF': { x: -12, z: -20 }, 'RF': { x: 12, z: -20 }
        },
        'Double Sides': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -18, z: 15 }, 'RD': { x: 18, z: 15 },
            'MF': { x: 0, z: 5 },
            'LF': { x: -18, z: -10 }, 'RF': { x: 18, z: -10 }
        }
    };



    // --- Enemy Indicator (Red Arrow Sprite) ---
    // Shared texture/material so we don't create 6 canvases.
const _enemyArrowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64;
        c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, c.width, c.height);
        
        // Arrow pointing DOWN
        ctx.beginPath();
        ctx.moveTo(6, 12);   
        ctx.lineTo(58, 12);  
        ctx.lineTo(32, 52);  
        ctx.closePath();
        ctx.fillStyle = '#ff0000';
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = 'rgba(255,255,255,0.95)';
        ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

const _playerArrowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, c.width, c.height);
        
        // Arrow pointing DOWN
        ctx.beginPath();
        ctx.moveTo(6, 12);   
        ctx.lineTo(58, 12);  
        ctx.lineTo(32, 52);  
        ctx.closePath();
        ctx.fillStyle = '#00ff00'; // Green
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = 'rgba(255,255,255,0.95)';
        ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

    const _teammateArrowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, c.width, c.height);
        
        // Arrow pointing DOWN
        ctx.beginPath();
        ctx.moveTo(6, 12);   
        ctx.lineTo(58, 12);  
        ctx.lineTo(32, 52);  
        ctx.closePath();
        ctx.fillStyle = '#ffffff'; // White
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = 'rgba(0,0,0,0.5)';
        ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

    const _enemyArrowMaterial = new THREE.SpriteMaterial({ map: _enemyArrowTexture, transparent: true, depthTest: false, depthWrite: false });
    const _playerArrowMaterial = new THREE.SpriteMaterial({ map: _playerArrowTexture, transparent: true, depthTest: false, depthWrite: false });
    const _teammateArrowMaterial = new THREE.SpriteMaterial({ map: _teammateArrowTexture, transparent: true, depthTest: false, depthWrite: false });
class Team {
        /**
         * Generates and applies stats to a player based on role and level.
         * Centralizes balancing to ensure high-level play feels distinct.
         */
        static generateStats(player, role, level = 1, isHuman = false) {
            // 1. Define Role Baselines (Level 1)
            // Balanced to be weak but functional at Level 1
            const base = {
                HP: 100, SP: 55, EN: 10, AT: 5, PA: 5, BL: 5, SH: 5, CA: 5
            };

            // Role Specializations
            switch(role) {
                case 'LF': case 'RF': // Strikers
                    base.SH += 10; base.SP += 5; base.EN += 5;
                    break;
                case 'MF': // Playmakers
                    base.PA += 10; base.AT += 8; base.EN += 8; base.SP += 2;
                    break;
                case 'LD': case 'RD': // Defenders
                    base.AT += 12; base.BL += 10; base.PA += 5;
                    break;
                case 'GL': // Goalie
                    base.CA += 10; base.SP += 5; base.PA += 15; // Strong arm
                    break;
            }

            // 2. Scaling Factors (Per Level)
            // Designed so Level 50 is "God Tier" and Level 1 is "Rookie"
            const growth = {
                HP: 15,    // +1500 HP at Lvl 99
                SP: 0.5,   // +50 SP at Lvl 99 (Speed demon)
                Primary: 0.8, // +80 Stat at Lvl 99
                Secondary: 0.5 // +50 Stat at Lvl 99
            };

            // Helper to scale
            const scale = (val, rate) => Math.floor(val + ((level - 1) * rate));

            // Apply Scaling
            player.stats.HP = scale(base.HP, growth.HP);
            
            // SP: Cap at 99, but ensure high levels feel FAST
            player.stats.SP = Math.min(99, scale(base.SP, growth.SP));

            // Stat distribution based on role priorities
            if (['LF', 'RF'].includes(role)) {
                player.stats.SH = Math.min(99, scale(base.SH, growth.Primary));
                player.stats.EN = Math.min(99, scale(base.EN, growth.Primary));
                player.stats.AT = Math.min(99, scale(base.AT, growth.Secondary));
                player.stats.PA = Math.min(99, scale(base.PA, growth.Secondary));
                player.stats.BL = Math.min(99, scale(base.BL, growth.Secondary));
            } else if (role === 'MF') {
                player.stats.PA = Math.min(99, scale(base.PA, growth.Primary));
                player.stats.AT = Math.min(99, scale(base.AT, growth.Primary));
                player.stats.EN = Math.min(99, scale(base.EN, growth.Primary));
                player.stats.SH = Math.min(99, scale(base.SH, growth.Secondary));
                player.stats.BL = Math.min(99, scale(base.BL, growth.Secondary));
            } else if (['LD', 'RD'].includes(role)) {
                player.stats.AT = Math.min(99, scale(base.AT, growth.Primary));
                player.stats.BL = Math.min(99, scale(base.BL, growth.Primary));
                player.stats.PA = Math.min(99, scale(base.PA, growth.Secondary));
                player.stats.EN = Math.min(99, scale(base.EN, growth.Secondary));
                player.stats.SH = Math.min(99, scale(base.SH, 0.2)); // Defenders bad at shooting
            } else if (role === 'GL') {
                player.stats.CA = Math.min(99, scale(base.CA, growth.Primary));
                player.stats.PA = Math.min(99, scale(base.PA, growth.Secondary));
                player.stats.SH = Math.min(99, scale(base.SH, 0.3));
            }

            // 3. Human Player Bonus (The "Hero" Feel)
            // Gives the player a slight edge to make gameplay feel punchy
            if (isHuman) {
                player.stats.HP += 150; // Tankier
                player.stats.SP += 5;   // Faster
                player.stats.EN += 5;   // Harder to tackle
                
                // Key Stat Boost
                if (role === 'LF' || role === 'RF') player.stats.SH += 5;
                if (role === 'MF') player.stats.PA += 5;
                if (role === 'LD' || role === 'RD') player.stats.AT += 5;
                if (role === 'GL') player.stats.CA += 5;
            }

            // 4. Finalize
            player.stats.maxHP = player.stats.HP;
            player.level = level;
            player._updateDerivedStats();
        }

constructor(scene, id, side, color, isHuman) {
            this.scene = scene;
            this.id = id; // 'home' or 'away'
            this.side = side; // 1 (Defends +Z) or -1 (Defends -Z)
            this.color = color;
            this.isHuman = isHuman;
            this.aiEnabled = true; // Master switch for AI logic
            
            this.players = [];
            this.activePlayer = null; // The player currently controlled/focused
            
            // Formation Anchors
            this.currentFormation = 'Normal';
            
            // Player Indicator (Green Arrow)
            if (this.isHuman) {
                this.playerArrow = new THREE.Sprite(_playerArrowMaterial);
                this.playerArrow.scale.set(0.8, 0.8, 1.0);
                this.playerArrow.renderOrder = 1000; // On top
            }
        }

        assignMarks(opposingTeam) {
            // Simple auto-assign logic: Mark the player in the "matching" position
            // LF<->RD, RF<->LD, MF<->MF, LD<->RF, RD<->LF, GL<->LF
            this.players.forEach(p => {
                let targetRole = 'MF';
                switch (p.role) {
                    case 'LF': targetRole = 'RD'; break;
                    case 'RF': targetRole = 'LD'; break;
                    case 'MF': targetRole = 'MF'; break;
                    case 'LD': targetRole = 'RF'; break;
                    case 'RD': targetRole = 'LF'; break;
                    case 'GL': targetRole = 'LF'; break;
                }

                const target = opposingTeam.players.find(op => op.role === targetRole);
                if (target) {
                    p.marking = target;
                    // console.log(`${this.id} ${p.role} marked ${target.role}`);
                }
            });
        }

        addPlayer(player) {
            this.players.push(player);
            player.team = this;

            // Calculate Home Position based on Formation
            this._updatePlayerHomePosition(player);

            // Enemy indicator: red arrows over the Away team (so enemies are readable)
// Enemy indicator: red arrows over the Away team
            if (this.id === 'away' && player.mesh) {
                const arrow = new THREE.Sprite(_enemyArrowMaterial);
                arrow.scale.set(0.8, 0.8, 1.0);
                arrow.position.set(0, 3.2, 0); // above head
                arrow.renderOrder = 999;
                player.mesh.add(arrow);
                player.enemyArrow = arrow;
            }

            // Teammate indicator: White arrows for inactive humans
            if (this.isHuman && player.mesh) {
                const arrow = new THREE.Sprite(_teammateArrowMaterial);
                arrow.scale.set(0.6, 0.6, 1.0);
                arrow.position.set(0, 3.2, 0);
                arrow.renderOrder = 999;
                arrow.visible = false; // Hidden by default, managed by setActivePlayer
                player.mesh.add(arrow);
                player.teammateArrow = arrow;
            }
        }

        setFormation(name) {
            if (!FORMATIONS[name]) return;
            this.currentFormation = name;
            // console.log(`Team ${this.id} switched to ${name}`);
            
            this.players.forEach(p => {
                this._updatePlayerHomePosition(p);
            });
        }

_updatePlayerHomePosition(player) {
            const data = FORMATIONS[this.currentFormation];
            if (!data) return;

            const offset = data[player.role];
            if (offset) {
                // X Position:
                // Formations: -X is Left, +X is Right.
                // Home Team (Side 1) faces -Z. Left is -X. Use offset.x as is.
                let xPos = offset.x;
                let zPos = offset.z * this.side;

                player.homePosition.set(xPos, 0, zPos);
                
                // Away Team (Side -1) faces +Z. Left is +X. Flip X.
                if (this.side === -1) {
                    player.homePosition.x *= -1; 
                }
            }
            
            // Set initial position
            if (player.mesh) {
                player.mesh.position.copy(player.homePosition);
                // Face center (0,0,0)
                player.mesh.lookAt(0, 0, 0);
            }
        }

        update(dt) {
            // Update all players
            for (let i = 0; i < this.players.length; i++) {
                this.players[i].update(dt);
            }

            // Auto-switch active player if Human
            if (this.isHuman) {
                this.updateActivePlayerSelection();
            }
        }

        updateActivePlayerSelection() {
            const ball = window.flux.gameInstance.entities.ball;
            if (!ball) return;

            // 1. OFFENSE: If we have the ball, active player is the holder
            if (ball.holder && ball.holder.team === this) {
                if (this.activePlayer !== ball.holder) {
                    this.setActivePlayer(ball.holder);
                }
                return;
            }

            // 2. DEFENSE: Select closest to ball
            // Optimization: Only check every few frames or if distance is significant
            let closest = null;
            let minDst = Infinity;

            for (const p of this.players) {
                if (p.role === 'GL') continue; // Don't auto-switch to goalie usually
                if (!p.mesh) continue;

                const d = p.mesh.position.distanceTo(ball.mesh.position);
                if (d < minDst) {
                    minDst = d;
                    closest = p;
                }
            }

            if (closest && closest !== this.activePlayer) {
                this.setActivePlayer(closest);
            }
        }

setActivePlayer(player) {
            // Reset input on previous
            if (this.activePlayer) {
                this.activePlayer.setInput(0, 0);
            }
            this.activePlayer = player;

            // Visual Indicators
            if (this.isHuman) {
                // 1. Green Arrow for Active
                if (this.playerArrow && player.mesh) {
                    player.mesh.add(this.playerArrow);
                    this.playerArrow.position.set(0, 3.5, 0); // Float above head
                }

                // 2. White Arrows for Others
                this.players.forEach(p => {
                    if (p.teammateArrow) {
                        p.teammateArrow.visible = (p !== player);
                    }
                });
            }
        }

resetPositions() {
            for (const p of this.players) {
                if (p.mesh) {
                    p.mesh.position.copy(p.homePosition);
                    
                    // Reset Physics
                    p.velocity.set(0, 0, 0);
                    p.inputVector.set(0, 0, 0);
                    p.isDashing = false;
                    p.isThrowing = false;
p.loseBall(); // Drop ball if holding
                    p.canCatch = true; // Force reset capability
                    
                    // Reset Stats
                    p.currentEN = p.stats.EN;
                    
// Orientation: Face Center
                    p.mesh.lookAt(0, 0, 0);
                    if (p.syncRotation) p.syncRotation();
                    
                    // Reset Animation
                    p.play('idle', 0.1);
                }
            }
            // Reset active player to MF
            const mf = this.players.find(p => p.role === 'MF');
            if (mf) this.setActivePlayer(mf);
        }
    }

    window.flux.Team = Team;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

// Reusable vectors
const _aiVec = new THREE.Vector3();
    const _targetPos = new THREE.Vector3();
    const _scanDir = new THREE.Vector3();
    const _scanToOpp = new THREE.Vector3();
    const _tempVec1 = new THREE.Vector3();
    const _tempVec2 = new THREE.Vector3();
    const _tempVec3 = new THREE.Vector3();

class AIPlayer extends window.flux.Player {
        constructor(scene, role) {
            super(scene, role);
            this.ballRef = null;
            
            // Stats are managed by Team/Main or default Player values.
            // No constructor overrides to ensure fair scaling and demo consistency.
            this._updateDerivedStats();

            // State Machine
            this.aiState = 'IDLE';
            this.decisionTimer = 0;
            this.decisionInterval = 0.1; // IMPROVED: Faster decisions (was 0.2)

            // --- PERCEPTION SYSTEM (Reaction Time) ---
            // The AI tracks a "ghost" target that lags behind reality.
            // This allows human players to juke/fake out the AI.
            this.perceivedTargetPos = new THREE.Vector3();
            this.reactionSpeed = 8.0; // IMPROVED: Faster reaction (was 5.0)

            // IMPROVED: Better anticipation
            this.anticipationTime = 0.4; // Lead target by this many seconds
            
            // Role Config
            this.isForward = ['LF', 'RF'].includes(role);
            this.isMidfielder = role === 'MF';
            this.isDefender = ['LD', 'RD'].includes(role);

            // Assign default techniques so AI is a threat
            this._assignDefaultTechs();
        }

        _assignDefaultTechs() {
            // Randomly assign techs based on role
const tackleTechs = ['venom', 'wither', 'drain'];
            const shootTechs = ['venom', 'sphere', 'invisible'];
            const passTechs = ['venom', 'wither', 'nap'];
            const passiveTechs = ['brawler', 'elite_defense'];

            // Helper to pick random
            const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
            const chance = (prob) => Math.random() < prob;

if (this.isDefender) {
                // Defenders love status tackles and passives
                if (chance(0.8)) this.techs.tackle = pick(tackleTechs);
                if (chance(0.3)) this.techs.pass = pick(passTechs);
                if (chance(0.5)) this.techs.passive = pick(passiveTechs);
            } else if (this.isMidfielder) {
                // Midfielders are balanced
                if (chance(0.6)) this.techs.tackle = pick(tackleTechs);
                if (chance(0.6)) this.techs.pass = pick(passTechs);
                if (chance(0.3)) this.techs.shoot = pick(shootTechs);
                if (chance(0.3)) this.techs.passive = pick(passiveTechs);
            } else if (this.isForward) {
                // Forwards focus on shooting
                if (chance(0.9)) this.techs.shoot = pick(shootTechs);
                if (chance(0.4)) this.techs.tackle = pick(tackleTechs); // Frontline pressure
                if (chance(0.2)) this.techs.passive = pick(passiveTechs);
            }
        }

update(dt) {
            // Safety: Auto-link ball if missing (Self-healing)
            if (!this.ballRef && window.flux.gameInstance && window.flux.gameInstance.entities) {
                this.ballRef = window.flux.gameInstance.entities.ball;
            }

            // 0. Check if AI logic should run
            const game = window.flux.gameInstance;
            const isDemo = game && game.isDemoMode;
            
            // Check incapacitation (Stun or Nap)
            const isIncapacitated = (this.stunTimer > 0) || (this.status.nap > 0);
            
            // AI runs if:
            // 1. It's an AI team (not human)
            // 2. It's a Human team BUT Demo Mode is ON
            // 3. It's a Human team, Demo is OFF, but this player is NOT the active controlled player
            const isHumanTeam = this.team && this.team.isHuman;
            const isActivePlayer = this.team && (this.team.activePlayer === this);
            const shouldRunAI = (!isHumanTeam || isDemo || (isHumanTeam && !isActivePlayer));
            
            // Master AI Switch for the team
            const isTeamAIEnabled = this.team ? this.team.aiEnabled : true;

            if (isIncapacitated) {
                // If stunned/sleeping, do nothing.
                this.setInput(0, 0);
            } else if (shouldRunAI && isTeamAIEnabled) {
                // --- IMPROVED PERCEPTION UPDATE ---
                // Update perceived position towards real target (Ball or Ball Holder)
                if (this.ballRef && this.ballRef.mesh) {
                    let realTarget = this.ballRef.mesh.position.clone();

                    // If ball is held, track the holder with anticipation
                    if (this.ballRef.holder && this.ballRef.holder.mesh) {
                        realTarget = this.ballRef.holder.mesh.position.clone();

                        // IMPROVED: Lead the target based on their velocity
                        if (this.ballRef.holder.velocity) {
                            realTarget.addScaledVector(this.ballRef.holder.velocity, this.anticipationTime);
                        }
                    } else if (this.ballRef.velocity) {
                        // For loose ball, anticipate based on ball velocity
                        realTarget.addScaledVector(this.ballRef.velocity, this.anticipationTime * 0.5);
                    }

                    // Lerp perception towards anticipated reality
                    const alpha = Math.min(1.0, dt * this.reactionSpeed);
                    this.perceivedTargetPos.lerp(realTarget, alpha);
                }

                // 1. Decision Making
                this.decisionTimer += dt;
                if (this.decisionTimer > this.decisionInterval) {
                    this.decisionTimer = 0;
                    this._evaluateState();
                }

                // 2. Execute State (Sets inputVector)
                this._executeState(dt);
                
                // 3. Interception Logic
                this._applyInterceptionPressure(dt);
            } else {
                // Here if:
                // 1. Controlled by Human (shouldRunAI == false)
                // 2. AI Logic is Disabled (isTeamAIEnabled == false)

                // If AI is disabled, we must stop the bot UNLESS it is being driven by human input.
                // Human input drives the player if: isHumanTeam AND isActivePlayer AND !isDemo
                const isDrivenByHuman = isHumanTeam && isActivePlayer && !isDemo;

                if (!isTeamAIEnabled && !isDrivenByHuman) {
                    this.setInput(0, 0);
                }

                // We still apply passive interception if in the way.
                this._applyInterceptionPressure(dt);
            }

            // 4. Base Update
            super.update(dt);
        }

_evaluateState() {
            if (!this.ballRef) return;
            const ball = this.ballRef;

            // 1. I have the ball
            if (this.hasBall) {
                this.aiState = 'ATTACK_CARRY';
                return;
            }

            // 2. Loose Ball Logic (Anti-Flocking)
            if (!ball.holder) {
                // Default: Return to formation. Only chase if we are the best candidate.
                this.aiState = 'RETURN_HOME';

// Hysteresis: If I was already chasing, I'm effectively "closer" to prevent jittery switching
                // This prevents two players from swapping roles rapidly when equidistant.
                const bias = (this.aiState === 'CHASE') ? 0.8 : 1.0;
                const myDist = this.mesh.position.distanceTo(ball.mesh.position) * bias;
                
                let isClosest = true;

                if (this.team && this.team.players) {
                    for (const p of this.team.players) {
                        if (p === this) continue;
                        if (!p.mesh) continue;
                        
                        // Ignore Goalie (Goalie handles their own area; field players shouldn't rely on them)
                        if (p.role === 'GL') continue;

                        // Ignore incapacitated teammates
                        if (p.status && p.status.nap > 0) continue;

                        // Calculate teammate distance
                        // Note: We don't apply bias to others, effectively making "me" stickier if I'm already chasing
                        const pDist = p.mesh.position.distanceTo(ball.mesh.position);
                        
                        // If a teammate is closer, yield to them
                        if (pDist < myDist) {
                            isClosest = false;
                            break;
                        }
                    }
}

                if (isClosest) {
                    this.aiState = 'CHASE';
                }
                return;
            }

            // 3. Teammate has ball
            if (ball.holder.team === this.team) {
                this.aiState = 'SUPPORT';
                return;
            }

            // 4. Opponent has ball
            if (ball.holder.team !== this.team) {
                this.aiState = 'DEFEND';
                return;
            }
        }

        _executeState(dt) {
            if (!this.ballRef) {
                this.setInput(0, 0);
                return;
            }

            switch (this.aiState) {
                case 'ATTACK_CARRY': this._stateAttackCarry(dt); break;
                case 'SUPPORT': this._stateSupport(dt); break;
                case 'DEFEND': this._stateDefend(dt); break;
                case 'CHASE': this._stateChase(dt); break;
                case 'RETURN_HOME': 
                default: this._stateReturnHome(dt); break;
            }
        }

        // --- STATES ---

_stateAttackCarry(dt) {
            // Drive to goal
            // Home (Side 1) attacks -Z. Away (Side -1) attacks +Z.
            const attackDir = (this.team.side === 1) ? -1 : 1;
const goalZ = 46 * attackDir;
            
            // Target: Goal (but respect crease)
            _targetPos.set(0, 0, goalZ);
            this._avoidGoalCrease(_targetPos);
            
            // Move
            this._moveTo(_targetPos);

            // Decision: Shoot or Pass?
            const distToGoal = Math.abs(this.mesh.position.z - goalZ);
            
            // 1. Shoot if close and clear
            if (distToGoal < 20.0 && !this.isThrowing) {
                this._smartThrow(this.ballRef, 'SH'); 
                return;
            }
            
            // 2. Pass Logic
            // Check pass if: Surrounded, Low EN, or Playmaker (Midfielder) sees opportunity
            const isSurrounded = this._isSurrounded();
            const lowEN = this.currentEN < 10;
            const isPlaymaker = this.isMidfielder;
            
            if ((isSurrounded || lowEN || isPlaymaker) && !this.isThrowing) {
                const bestMate = this._findBestPassTarget();
                
                if (bestMate) {
                    // Evaluate if pass is worth it
                    // If Playmaker, pass if mate is closer to goal
                    // If Panic (Surrounded/LowEN), pass to anyone open
                    
                    let shouldPass = false;
                    
                    if (isSurrounded || lowEN) {
                        shouldPass = true;
                    } else if (isPlaymaker) {
                        const myDist = Math.abs(this.mesh.position.z - goalZ);
                        const mateDist = Math.abs(bestMate.mesh.position.z - goalZ);
                        if (mateDist < myDist - 5.0) shouldPass = true; // Mate is 5m closer
                    }
                    
                    if (shouldPass) {
                        // Face target
                        this.mesh.lookAt(bestMate.mesh.position);
                        // Execute Pass
                        this._smartThrow(this.ballRef, 'PA');
                        return;
                    }
                }
            }
            
            // 3. Panic Clear (If surrounded and no pass)
            if (isSurrounded && !this.isThrowing) {
                // Just shoot/clear
                this._smartThrow(this.ballRef, 'SH');
            }
        }

        _isSurrounded() {
            // Simple check: count enemies nearby
            let count = 0;
            const game = window.flux.gameInstance;
            if (!game) return false;
            const oppTeam = (this.team.id === 'home') ? game.teams.away : game.teams.home;
            
            for(let p of oppTeam.players) {
                if (p.mesh && p.mesh.position.distanceTo(this.mesh.position) < 4.0) {
                    count++;
                }
            }
            return count >= 2;
        }

_smartThrow(ball, forcedType = null) {
            // Wrapper around throwBall to manage HP and Techs
            // 1. Determine intended action type
            let type = forcedType;
            if (!type) {
                _tempVec1.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
                const attackDir = (this.team && this.team.side === 1) ? -1 : 1;
                const isAimingGoal = (_tempVec1.z * attackDir > 0.5);
                type = isAimingGoal ? 'SH' : 'PA';
            }

            // 2. Get Tech
            const techName = (type === 'SH') ? this.techs.shoot : this.techs.pass;
            
            // 3. Estimate Cost
            let baseCost = (type === 'SH') ? 20 : 10;
            let techCost = 0;
            
            if (techName) {
                // Rough estimates based on Player.js
                if (techName.includes('nap')) techCost = 30;
                else if (techName.includes('sphere') || techName.includes('invisible')) techCost = 25;
                else techCost = 20; // Venom/Wither
            }

            const totalCost = baseCost + techCost;

            // 4. Decision
            // If we have a tech but not enough HP for it, BUT enough HP for normal...
            // Disable tech temporarily to avoid "Tired" penalty (0.5x stats)
            let tempTech = null;
            if (techName && this.stats.HP < totalCost && this.stats.HP >= baseCost) {
                // Unequip
                if (type === 'SH') {
                    tempTech = this.techs.shoot;
                    this.techs.shoot = null;
                } else {
                    tempTech = this.techs.pass;
                    this.techs.pass = null;
                }
            }

            // Execute
            this.throwBall(ball, type);

            // Restore
            if (tempTech) {
                if (type === 'SH') this.techs.shoot = tempTech;
                else this.techs.pass = tempTech;
            }
        }

_stateChase(dt) {
            // Interception: Chase the PERCEIVED position, not the real one.
            // This allows jukes to work because the AI is chasing where you WERE.
            _targetPos.copy(this.perceivedTargetPos);
            
            // If ball has velocity, lead it slightly based on perception
            const ball = this.ballRef;
            if (ball.velocity.lengthSq() > 1.0) {
                _targetPos.addScaledVector(ball.velocity, 0.3);
            }
            
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);
        }

_stateReturnHome(dt) {
            // Return to formation position
            _targetPos.copy(this.homePosition);
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);
        }

_stateSupport(dt) {
            // OFFENSE (Teammate has ball)
            // Goal: Find open space to receive a pass
            const ballPos = this.ballRef.mesh.position;
            const attackDir = (this.team.side === 1) ? -1 : 1;
const goalZ = (this.team.side === 1) ? -46 : 46;

            // 1. Determine "Ideal" Support Position
            // Start with formation home
            _targetPos.copy(this.homePosition);
            
            // 2. Dynamic Adjustment
            if (this.isForward) {
                // Forwards: Make runs towards the goal/box
                // If ball is deep, cut to center. If ball is back, push line.
                _targetPos.z = ballPos.z + (attackDir * 10.0); // Stay ahead of ball
                
                // Zig-zag run pattern based on time to look "alive"
                const time = Date.now() * 0.001;
                _targetPos.x += Math.sin(time + this.mesh.id) * 5.0;
                
            } else if (this.isMidfielder) {
                // Midfielders: Find pocket between ball and goal
                _tempVec1.set(0, 0, goalZ);
                _targetPos.lerpVectors(ballPos, _tempVec1, 0.4);
                
                // Stay wide if ball is central, come central if ball is wide
                if (Math.abs(ballPos.x) < 5) _targetPos.x = (this.homePosition.x > 0 ? 10 : -10);
                else _targetPos.x = 0;
            } else {
                // Defenders: Support from behind (safety valve)
                _targetPos.z = ballPos.z - (attackDir * 8.0);
            }

            // 3. Avoid Defenders (Raycast-ish check)
            // If a defender is near my target, shift away
            const game = window.flux.gameInstance;
            if (game) {
                const oppTeam = (this.team.id === 'home') ? game.teams.away : game.teams.home;
                for (const opp of oppTeam.players) {
                    if (opp.mesh && opp.mesh.position.distanceTo(_targetPos) < 4.0) {
                        // Defender is clogging my spot. Shift away from them.
                        _tempVec2.copy(_targetPos).sub(opp.mesh.position).normalize();
                        _targetPos.addScaledVector(_tempVec2, 5.0);
                    }
                }
            }

            // 4. Clamp to Arena & Crease
            this._avoidGoalCrease(_targetPos);

            this._moveTo(_targetPos);
        }

_stateDefend(dt) {
            // DEFENSE (Opponent has ball)
            // Use Perceived Position for distance checks and movement
            const targetPos = this.perceivedTargetPos;
            const distToBall = this.mesh.position.distanceTo(targetPos);
            
            // 1. Determine Press Range
            // Base range
// Base range
            let pressRange = this.isDefender ? 20.0 : 15.0; // Increased aggression range
            
            // Aggressive Tech Usage
            if (this.techs.tackle && this.stats.HP > 20) {
                pressRange += 5.0; 
            }

            // --- ANTI-SWARM LOGIC & AGGRESSION ---
            // Only the closest defender should hard-press from distance.
            // Others should stick to their zones/marks unless the ball enters their personal space.
            let amIClosest = true;
            const myDistSq = distToBall * distToBall;
            
            if (this.team && this.team.players) {
                for(const mate of this.team.players) {
                    if (mate === this || !mate.mesh) continue;
                    // Ignore Goalie and incapacitated teammates
                    if (mate.role === 'GL' || mate.status.nap > 0 || mate.stunTimer > 0) continue;
                    
                    // Use real positions for teammate comparison (AI knows where teammates are)
                    const dSq = mate.mesh.position.distanceToSquared(targetPos);
                    if (dSq < myDistSq) {
                        amIClosest = false;
                        break;
                    }
                }
            }

            // ZOMBIE FIX: If I am the closest, I MUST CHASE.
            // Set pressRange to essentially infinite if closest, so they don't just stand there.
// ZOMBIE FIX: If I am the closest, I MUST CHASE.
            // Set pressRange to essentially infinite if closest, so they don't just stand there.
            if (amIClosest) {
                pressRange = 100.0; // Infinite chase
            } else {
                const distToMyGoal = Math.abs(targetPos.z - (this.team.side === 1 ? 46 : -46));
                if (distToMyGoal < 40.0) {
                    pressRange = 25.0; // Aggressive zone defense
                } else {
                    pressRange = 10.0; // Looser marking in midfield
                }
            }
            // If ball is close enough (based on context), PRESS IT
            if (distToBall < pressRange) {
                _targetPos.copy(targetPos);
                this._avoidGoalCrease(_targetPos);
                this._moveTo(_targetPos);
                return;
            }

            // 2. Mark Mode (Man-to-Man)
            // If I have a mark assigned, stick to them unless pressing ball
            if (this.marking && this.marking.mesh) {
                const markPos = this.marking.mesh.position;
                
                // Position: Between mark and my goal (Goal Side)
const myGoalZ = (this.team.side === 1) ? 46 : -46;
                
                // Vector from Mark to Goal
                _tempVec1.set(0, 0, myGoalZ - markPos.z);
                const distToGoal = _tempVec1.length();
                _tempVec1.normalize();
                
                // Stand 3.5 units towards goal from the mark (Increased from 2.0 to give breathing room)
                _targetPos.copy(markPos).addScaledVector(_tempVec1, 3.5);
                
                this._avoidGoalCrease(_targetPos);
                this._moveTo(_targetPos);
                return;
            }

            // 3. Zone Defense (Formation + Slide)
            _targetPos.copy(this.homePosition);
            
            // Slide logic (Shift formation towards ball side)
            _targetPos.z += ballPos.z * 0.6;
            
            // Defender Override: Always stay between ball and goal
// Defender Override: Always stay between ball and goal
            if (this.isDefender) {
                const myGoalZ = (this.team.side === 1) ? 46 : -46;
                const midpoint = (ballPos.z + myGoalZ) * 0.5;
                _targetPos.z = (_targetPos.z + midpoint) * 0.5;
            }

            // Clamp
// Clamp
            _targetPos.z = Math.max(-44.0, Math.min(44.0, _targetPos.z));
            
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);
        }

_avoidGoalCrease(targetPos) {
            // 1. Goal Crease Avoidance (Radius 10 around goals at +/- 28)
            // Matches Player.js _applyGoalCrease physics to prevent stuttering
// 1. Goal Crease Avoidance (Radius 10 around goals at +/- 28)
            // Matches Player.js _applyGoalCrease physics to prevent stuttering
// Matches Player.js _applyGoalCrease physics to prevent stuttering
            const creaseRadius = 10.0;
            const goals = [
                { x: 0, z: -46 }
            ];

            goals.forEach(goal => {
                const dx = targetPos.x - goal.x;
                const dz = targetPos.z - goal.z;
                const distSq = dx*dx + dz*dz;

                if (distSq < creaseRadius * creaseRadius) {
                    // Inside crease, project to edge
                    const dist = Math.sqrt(distSq);
                    if (dist > 0.001) {
                        const ratio = creaseRadius / dist;
                        targetPos.x = goal.x + dx * ratio;
                        targetPos.z = goal.z + dz * ratio;
                    } else {
                        // Exact center, push out towards center field
                        targetPos.z = goal.z + (goal.z > 0 ? -creaseRadius : creaseRadius);
                    }
                }
            });

// 2. Arena Boundary Clamp
            const arenaRadius = 45.0; // Keep slightly inside visual/physics wall
            const dSq = targetPos.x * targetPos.x + targetPos.z * targetPos.z;

            if (dSq > arenaRadius*arenaRadius) {
                const d = Math.sqrt(dSq);
                const r = arenaRadius / d;
                targetPos.x *= r;
                targetPos.z *= r;
            }
        }

        _findBestPassTarget() {
            let bestTarget = null;
            let maxScore = -Infinity;
            
            // Attack direction & Goal Z
            const attackDir = (this.team.side === 1) ? -1 : 1; // Home attacks -Z
const goalZ = (this.team.side === 1) ? -46 : 46;

            for (const mate of this.team.players) {
                if (mate === this) continue;
                if (!mate.mesh) continue;
                if (mate.status.nap > 0) continue; // Don't pass to sleepers
                if (mate.stunTimer > 0) continue;  // Don't pass to stunned players
                
                const dist = this.mesh.position.distanceTo(mate.mesh.position);
                if (dist < 4.0) continue;  // Too close (Reduced for tiki-taka)
                if (dist > 30.0) continue; // Too far (Increased range)
                
                // 1. Raycast Check (Is the lane clear?)
                if (this._isPathBlocked(mate.mesh.position)) continue; 
                
                // 2. Calculate Strategic Score
                let score = 0;

                // A. Forward Progress (Verticality)
                const myDistToGoal = Math.abs(this.mesh.position.z - goalZ);
                const mateDistToGoal = Math.abs(mate.mesh.position.z - goalZ);
                const progress = myDistToGoal - mateDistToGoal; // Positive if moving closer
                
                score += progress * 1.5; 
                
                // B. Goal Proximity (Absolute)
                if (mateDistToGoal < 15.0) score += 10.0;
                if (mateDistToGoal < 8.0) score += 15.0;

                // C. Openness (Space around receiver)
                const openness = this._calculateOpenness(mate);
                score += openness * 3.0; // High weight on safety

                // D. Role Bias (Forwards are prime targets)
                if (mate.isForward) score += 5.0;

                // E. Distance Penalty (Long passes are risky)
                score -= dist * 0.5;

                if (score > maxScore) {
                    maxScore = score;
                    bestTarget = mate;
                }
            }
            
            return bestTarget;
        }

        _calculateOpenness(player) {
            let minDefDist = 999;
            const game = window.flux.gameInstance;
            if (!game) return 0;
            const oppTeam = (this.team.id === 'home') ? game.teams.away : game.teams.home;

            for (const opp of oppTeam.players) {
                if (!opp.mesh || opp.status.nap > 0 || opp.stunTimer > 0) continue;
                const d = player.mesh.position.distanceTo(opp.mesh.position);
                if (d < minDefDist) minDefDist = d;
            }
            
            // Clamp: Anything beyond 8m is "Wide Open"
            return Math.min(minDefDist, 8.0);
        }

        _isPathBlocked(targetPos) {
            const start = this.mesh.position;
            const end = targetPos;
            const dist = start.distanceTo(end);
            
            // Prepare Ray Direction
            _scanDir.subVectors(end, start).normalize();
            
            const game = window.flux.gameInstance;
            if (!game) return false;
            const oppTeam = (this.team.id === 'home') ? game.teams.away : game.teams.home;
            
            // Interception radius
            const safetyRadius = 2.5; 

            for (const opp of oppTeam.players) {
                if (!opp.mesh || opp.status.nap > 0 || opp.stunTimer > 0) continue;
                
                // Vector from start to opponent
                _scanToOpp.subVectors(opp.mesh.position, start);
                
                // Project onto path
                const projection = _scanToOpp.dot(_scanDir);
                
                // Check if projection is within the segment
                if (projection > 0 && projection < dist) {
                    // Calculate perpendicular distance squared
                    // distSq = |toOpp|^2 - projection^2
                    const perpDistSq = _scanToOpp.lengthSq() - (projection * projection);
                    
                    if (perpDistSq < (safetyRadius * safetyRadius)) {
                        return true; // Blocked
                    }
                }
            }
            return false;
        }

_moveTo(target) {
            _aiVec.subVectors(target, this.mesh.position);
            _aiVec.y = 0;
            
            const distSq = _aiVec.lengthSq();

            // Deadzone: If within 1.0m (1.0 sq), stop.
            // Increased from 0.1 (0.3m) to prevent micro-adjustment spinning at destination.
            // This is crucial when targets are dynamic (e.g. relative to ball holder).
            if (distSq > 1.0) {
                _aiVec.normalize();
                this.setInput(_aiVec.x, _aiVec.z);
            } else {
                this.setInput(0, 0);
                // Braking friction to stop drift immediately upon reaching target
                this.velocity.multiplyScalar(0.8);
            }
        }

_applyInterceptionPressure(dt) {
            const ball = this.ballRef;
            if (!ball || !ball.mesh) return; // Safety check

            // 1. Basic Eligibility Checks
            // Must be free and moving
            if (ball.state !== 'free' || ball.velocity.lengthSq() < 1.0) return;
            // Cannot intercept invisible ball
            if (ball.isInvisible) return;
            // Skip if sleeping or stunned
            if (this.status.nap > 0 || this.stunTimer > 0) return;

            // 2. Range Calculation (The "Field" Radius)
            let range = 2.0; // Reduced from 3.5 to prevent "force field" feeling
            
            // Passive Techs: Brawler / Elite Defense
            if (this.techs.passive === 'brawler' || this.techs.passive === 'elite_defense') {
                range += 1.5; // Reduced boost
            }

            const dist = this.mesh.position.distanceTo(ball.mesh.position);
            if (dist > range) return;

            // 3. Directional Factor (The "Cone")
            // Vector from Ball to Defender
            _scanToOpp.subVectors(this.mesh.position, ball.mesh.position).normalize();
            _tempVec1.copy(ball.velocity).normalize();
            
            // Dot Product: 
            // 1.0 = Ball heading straight for defender
            // 0.0 = Passing by side (Perpendicular)
            const headingDot = _tempVec1.dot(_scanToOpp);
            
            // Only apply drag if ball is approaching DIRECTLY (Stricter cone)
            // Increased threshold from 0.0 to 0.7 (Must be within ~45 degrees)
            if (headingDot < 0.7) return;

            // 4. Calculate Pressure Intensity
            // Distance Factor: Closer = Stronger (Linear falloff)
            const distFactor = Math.max(0, 1.0 - (dist / range));
            
            // Angle Factor: Direct hit = 1.0, Glancing = 0.4
            const angleFactor = Math.max(0.3, headingDot);

            // BL Stat
            const bl = this.getStat('BL');
            
            // Total Pressure (PA/SH drain per second)
            // Base multiplier for stats (Reduced from 6.0 to 3.0)
            const pressureMultiplier = 3.0; 
            const pressure = bl * distFactor * angleFactor * pressureMultiplier * dt;

            // 5. Apply to Ball Stats (PA/SH)
            if (ball.power > 0) {
                ball.power -= pressure;
                
                // Visual Feedback (Accumulator)
                this._accumulatedBlock = (this._accumulatedBlock || 0) + pressure;
                // Show floating text every 5 points drained
                if (this._accumulatedBlock >= 5.0) { 
                    const val = Math.floor(this._accumulatedBlock);
                    this._accumulatedBlock -= val;
                    
                    if (window.flux.gameInstance.floatingText) { 
                         // Spawn on ball, attach to ball
                         window.flux.gameInstance.floatingText.spawn(`-${val}`, ball.mesh.position, "block", ball.mesh);
                    }
                }
            }

            // 7. Visuals: The "Tether" / Interference Field
            // Spawn sparks between ball and defender to show the field effect
            if (Math.random() < (distFactor * 0.8)) { 
                _tempVec2.copy(this.mesh.position).lerp(ball.mesh.position, 0.5 + (Math.random()-0.5)*0.2);
                // Jitter
                _tempVec2.x += (Math.random()-0.5) * 0.5;
                _tempVec2.y += (Math.random()-0.5) * 0.5;
                _tempVec2.z += (Math.random()-0.5) * 0.5;
                
                if (window.flux.gameInstance.spawnClash) {
                    window.flux.gameInstance.spawnClash(_tempVec2, 0.6); // Spark
                }
            }

            // 8. Shot Stop / Block Logic
            if (ball.power <= 0 && ball.powerType === 'SH') {
                ball.powerType = 'none'; // Neutralize shot
                
                // NO DEFLECTION: The ball continues on its path.
                // It is now a "dead ball" (no power) but keeps moving.
                
                if (window.flux.gameInstance.floatingText) { 
                    window.flux.gameInstance.floatingText.spawn("BLOCKED", this.mesh.position, "comic-impact");
                }
                // No impact freeze to keep flow smooth
            }

            // 9. Status Risk (Venom/Nap/Wither on Ball)
            if (ball.technique && !this._techApplied) {
                this._techApplied = true;
                const tech = ball.technique;
                
                if (tech.type === 'venom') {
                    this.applyStatus('venom', 15.0);
                } else if (tech.type === 'nap') {
                    this.applyStatus('nap', 8.0);
                } else if (tech.type === 'wither') {
                    this.applyStatus('wither', 15.0, 'BL');
                }
                
                setTimeout(() => { this._techApplied = false; }, 2000);
            }
}
    }

    window.flux.AIPlayer = AIPlayer;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};
    
    // Reusable vectors to avoid GC
const _gVec = new THREE.Vector3();
    const _gPos = new THREE.Vector3();
    const _ballPos = new THREE.Vector3();
    const _faceVec = new THREE.Vector3();
    const _goalCenter = new THREE.Vector3();
    const _tempVecG = new THREE.Vector3();

    class Goalie extends window.flux.Player {
constructor(scene, role) {
            super(scene, role);
            
            // Goalie Specific Stats (Buffed for Playability)
            this.stats.CA = 30; // Catch
            this.stats.SP = 40; // Speed
            this.stats.EN = 50;
            
            // BUFFED: Strong arm for clearing the zone
            this.stats.PA = 45; // Was 20 - Now strong enough to reach midfield
            this.stats.SH = 35; // Was 10 - Decent clearance kick
            
            this._updateDerivedStats();

            // Goal Dimensions (Save Box)
// Goal Dimensions (Save Box) - Matches GameManager detection
// Goal Dimensions (Save Box) - Matches GameManager detection
            this.goalWidth = 22.0; // Increased to match new detection box
            this.goalHeight = 18.0; // Increased to match new detection box
            
            // Save Mechanics
            this.saveRadius = 6.0; 
            this.pressureMultiplier = 5.0; 
            
            // Techs
            this.techs = {
                active: null, 
                passive: null 
            };
            
            // AI State
            this.throwTimer = 0;
            this._accumulatedSave = 0;
            
            // Super Goalie State
            this.isSuperGoalie = false;
            this.superGoalieTimer = 0;
        }

update(dt) {
            // 1. Super Goalie Timer
            if (this.isSuperGoalie) {
                this.superGoalieTimer -= dt;
                if (this.superGoalieTimer <= 0) {
                    this.isSuperGoalie = false;
                }
            }
            
            // 2. Possession Logic (Ball Held)
            if (this.hasBall) {
                this._checkTacklePressure(dt);
                
                const game = window.flux.gameInstance;
                const isHumanControlled = this.team && this.team.isHuman && this.team.activePlayer === this && !game.isDemoMode;
                
                if (isHumanControlled) {
                    // Human: Full control (Rotation, Charging, etc via Player.update)
                    super.update(dt);
                } else {
                    // AI: Logic then update
                    if (!this.isThrowing) {
                        this._aiPossessionLogic(dt);
                    }
                    // Ensure AI doesn't drift
                    this.setInput(0, 0);
                    super.update(dt);
                }
                this._constrainBounds();
                return; 
            }

            // 3. Defense / Save Logic (No Ball)
            // We must handle timers and status manually because we skip super.update() to use custom movement
            if (this.dashCooldown > 0) this.dashCooldown -= dt;
            if (this.clashCooldown > 0) this.clashCooldown -= dt;
            if (this.stunTimer > 0) this.stunTimer -= dt;
            if (this.immunityTimer > 0) this.immunityTimer -= dt;

            this._updateStatus(dt);

            if (this.stunTimer > 0 || this.status.nap > 0) {
                if (this.mixer) this.mixer.update(dt);
                this._updateHPBar();
                this._constrainBounds();
                return;
            }

            // Custom Movement
            this._defenseLogic(dt);
            
            // Update Animation
            if (this.mixer) this.mixer.update(dt);
            this._updateHPBar();
            
            this._constrainBounds();
        }

_constrainBounds() {
            if (!this.mesh) return;
            const pos = this.mesh.position;
            const side = this.team ? this.team.side : 1;
            
            // X Bounds (Width of penalty area +/- 10m) -> Increased for massive goal
const xLimit = 20.0; // Reduced width of goalie movement
            if (pos.x > xLimit) { pos.x = xLimit; this.velocity.x = 0; }
            if (pos.x < -xLimit) { pos.x = -xLimit; this.velocity.x = 0; }
            
            // Y Bounds
            const yLimit = 12.0; // Reduced height ceiling
            if (pos.y > yLimit) { pos.y = yLimit; this.velocity.y = 0; }
            if (pos.y < -yLimit) { pos.y = -yLimit; this.velocity.y = 0; }
            
            // Z Bounds (Depth)
// Z Bounds (Depth)
            // Home (Side 1): Goal at +46. Trigger at 45. Limit to 45.5.
            // Away (Side -1): Goal at -46. Trigger at -45. Limit to -45.5.
            if (side === 1) {
                if (pos.z > 45.5) { pos.z = 45.5; this.velocity.z = 0; }
                if (pos.z < 20.0) { pos.z = 20.0; this.velocity.z = 0; }
            } else {
                if (pos.z < -45.5) { pos.z = -45.5; this.velocity.z = 0; }
                if (pos.z > -20.0) { pos.z = -20.0; this.velocity.z = 0; }
            }
        }

// Override throwBall to fix "weak throw" issue
// Override throwBall to fix "weak throw" issue
        throwBall(ball, forcedType = null, powerMultiplier = 1.0) {
            // Goalies almost always PASS, even when "clearing" forward.
            // The default Player logic switches to 'SH' (Shoot) if aiming forward, 
            // which uses the Goalie's lower SH stat. We force PA unless specified.
            const type = forcedType || 'PA';
            
            // BOOST: Apply a multiplier to ensure the goalie can clear the ball to midfield.
            // NERFED: Reduced from 1.6 to 1.2 to prevent cross-map throws as per user feedback.
            const boost = 1.2;

            super.throwBall(ball, type, powerMultiplier * boost);
        }

_defenseLogic(dt) {
            // 0. Game State Check
            if (window.flux.gameInstance.state !== 'active') return;

            const ball = window.flux.gameInstance.entities.ball;
            if (!ball || !ball.mesh) return;

            // Determine Threat Source
            let threatPos = _ballPos;
            let isThreat = false;
const myGoalZ = (this.team.side === 1) ? 46 : -46;

            // Case A: Ball is Held (Pre-throw)
            if (ball.state === 'held' && ball.holder && ball.holder.team !== this.team) {
                threatPos = ball.holder.mesh.position;
                
                // Check if holder is in attacking half or near enough
                const distToGoal = Math.abs(threatPos.z - myGoalZ);
                if (distToGoal < 40.0) { // If they are within 40m, track them
                    isThreat = true;
                }
            } 
            // Case B: Ball is Free (Shot/Pass)
            else if (ball.state === 'free') {
                threatPos = ball.mesh.position;
                
                // Direction Check
                const movingTowards = (this.team.side === 1 && ball.velocity.z > 0) || 
                                      (this.team.side === -1 && ball.velocity.z < 0);
                
                // Position Check
// Position Check
                const inFrontOfGoal = (this.team.side === 1 && threatPos.z < 45.0) || 
                                      (this.team.side === -1 && threatPos.z > -45.0);

                isThreat = movingTowards && inFrontOfGoal;
            }

            if (isThreat) {
                // --- POSITIONING: ANGLE CUTTING ---
                _ballPos.copy(threatPos); // Update reference for lookAt
                
                // 1. Calculate Goal Center
// 1. Calculate Goal Center (Adjusted for Y offset)
_goalCenter.set(0, -4.5, myGoalZ);
                
                // 2. Vector from Goal to Ball
                _tempVecG.subVectors(_ballPos, _goalCenter);
                const distToBall = _tempVecG.length();
                _tempVecG.normalize(); // Now holds direction
                
                // 3. Determine Extension (How far out to step)
                // Base: 1.5m off line.
                // Max: 6.0m off line (Cutting angle).
                // Scale based on ball proximity: Closer ball = More extension (to a point)
let extension = 1.5;
                if (distToBall < 30.0) {
                    const ratio = 1.0 - (Math.max(0, distToBall - 5.0) / 25.0); 
                    extension = 1.5 + (4.5 * ratio); 
                }
                
// Safety: Don't go past the ball (keep 1m buffer)
                extension = Math.min(extension, distToBall - 1.0);
                
                // 4. Calculate Target Position (Base Interception)
                _gPos.copy(_goalCenter).add(_tempVecG.multiplyScalar(extension));
                
                // 5. Vertical Override (Jump to meet ball)
                // Explicitly set Y to match ball height if it's high
                if (_ballPos.y > 0.5) {
                    _gPos.y = _ballPos.y;
                } else {
                    _gPos.y = 0.5; // Default stance
                }

                // 6. Clamp to Goal Box Dimensions (Lateral/Vertical Limits)
                // Goal Width 22 (+/- 11), Height 18 (+/- 9).
                // Allow slightly outside posts to cover angles.
                const clampX = this.goalWidth * 0.6; // +/- 13.2
const clampY = 12.0; // Reduced max jump height
                
                _gPos.x = Math.max(-clampX, Math.min(clampX, _gPos.x));
                _gPos.y = Math.max(-clampY, Math.min(clampY, _gPos.y));
                
                // 6. Lead the ball slightly if it has lateral velocity (Anticipation)
if (ball.velocity.lengthSq() > 1.0) {
                    const anticipation = ball.velocity.clone().multiplyScalar(0.25); // 0.25s lead
                    anticipation.z = 0; // Only lateral lead
                    _gPos.add(anticipation);
                }

                // CLAMP Z: Prevent Goalie from going into the net or behind goal
// CLAMP Z: Prevent Goalie from going into the net or behind goal
// CLAMP Z: Prevent Goalie from going into the net or behind goal
if (this.team.side === 1) {
                    _gPos.z = Math.min(45.5, _gPos.z);
                } else {
                    _gPos.z = Math.max(-45.5, _gPos.z);
                }

                // Move towards target
                const moveDir = _gVec.subVectors(_gPos, this.mesh.position);
                const distToTarget = moveDir.length();
                
                if (distToTarget > 0.1) {
                    moveDir.normalize();
                    // Burst speed for saves if ball is close
                    const urgency = (distToBall < 10.0) ? 1.5 : 1.0;
                    const speed = this.maxSpeed * urgency;
                    
                    this.mesh.position.add(moveDir.multiplyScalar(speed * dt));
                    
                    // Face ball
                    this.mesh.lookAt(_ballPos);
                    
                    if (this.state !== 'swim') this.play('swim', 0.2);
                } else {
                    if (this.state !== 'idle') this.play('idle', 0.2);
                    this.mesh.lookAt(_ballPos);
                }

                // --- SAVE MECHANIC ---
                // If ball is within range, apply CA pressure
                const dist = this.mesh.position.distanceTo(ball.mesh.position);
                if (dist < this.saveRadius) { 
                    this._applySavePressure(ball, dt);
                }
            } else {
                // --- IDLE / RETURN TO POST ---
                // Return to home position (usually center of goal)
                _gPos.copy(this.homePosition);
                const moveDir = _gVec.subVectors(_gPos, this.mesh.position);
                
                if (moveDir.length() > 0.5) {
                    moveDir.normalize();
                    this.mesh.position.add(moveDir.multiplyScalar(this.maxSpeed * 0.6 * dt));
                    if (this.state !== 'swim') this.play('swim', 0.2);
                } else {
                    if (this.state !== 'idle') this.play('idle', 0.2);
                }
                
                // Face center field
                this.mesh.lookAt(0, 0, 0);
            }
        }

        _applySavePressure(ball, dt) {
            // If Goalie is Asleep, they cannot save.
            if (this.status.nap > 0) return;

            // --- SUPER GOALIE TRIGGER ---
            // Trigger if: Tech equipped, Not active, Ball has power, Ball is close
            if (this.techs.active === 'super_goalie' && !this.isSuperGoalie && ball.power > 5.0) {
                // Chance to trigger (High chance for AI, or check HP)
                // Cost: 10 HP
                if (this.stats.HP >= 10) {
                    this.stats.HP -= 10;
                    this.isSuperGoalie = true;
                    this.superGoalieTimer = 1.5; // Lasts 1.5s
                    
                    console.log(`${this.role} used SUPER GOALIE!`);
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("SUPER GOALIE!", this.mesh.position, "save");
                    }
                    
                    // Trigger Techcopy Event
                    if (window.flux.gameInstance && window.flux.gameInstance.triggerTechEvent) {
                        window.flux.gameInstance.triggerTechEvent(this, 'super_goalie');
                    }
                }
            }

            // Calculate Effective CA
            let ca = this.getStat('CA');
            
            // Apply Super Goalie Bonus (e.g. +50% + Flat 10)
            if (this.isSuperGoalie) {
                ca = (ca * 1.5) + 10;
            }
            
            // Apply Grip Gloves (Passive)
            if (this.techs.passive === 'grip_gloves') {
                ca += 5;
            }

            // Calculate Pressure
            // Pressure = CA * dt * Multiplier
            const pressure = ca * dt * this.pressureMultiplier;
            
            if (ball.power > 0) {
                ball.power -= pressure;
                
                // Visual Feedback
                this._accumulatedSave += pressure;
                // THROTTLE: Increased threshold to 12.0
                if (this._accumulatedSave >= 12.0) { 
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("BLOCK!", this.mesh.position, "comic-impact");
                    }
                    this._accumulatedSave = 0;
                }
            }

            // Apply Ball Technique to Goalie (Risk of catching special shots)
            if (ball.technique && !this._techApplied) {
                this._techApplied = true;
                const tech = ball.technique;
                
                if (tech.type === 'venom') {
                    this.applyStatus('venom', 15.0);
                } else if (tech.type === 'nap') {
                    this.applyStatus('nap', 8.0);
                } else if (tech.type === 'wither') {
                    this.applyStatus('wither', 15.0, 'CA');
                }
                setTimeout(() => { this._techApplied = false; }, 2000);
            }

            // Check Result
            if (ball.power <= 0) {
                // CATCH
                this.catchBall(ball);
            } 
        }

        catchBall(ball) {
            ball.grab(this);
            this.play('catch', 0.1);
            console.log("SAVED by " + this.role);
            
            // EXP REWARD: Save
            this.gainExp(5);

            if (window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("SAVED!", this.mesh.position, "comic-impact");
            }
            if (window.flux.gameInstance.triggerImpact) window.flux.gameInstance.triggerImpact(0.15, 'heavy');
            
            // Reset throw timer
            this.throwTimer = 0;
        }

_aiPossessionLogic(dt) {
            this.throwTimer += dt;
            
            // Hold for a moment (1.5s) then throw
            if (this.throwTimer > 1.5) {
                // Find best target: Prefer MF or Defenders, but must be somewhat distant to avoid "handoff" look
                // Filter for teammates > 8 units away if possible
                const validMates = this.team.players.filter(p => 
                    p !== this && 
                    p.mesh && 
                    p.mesh.position.distanceTo(this.mesh.position) > 8.0
                );

                let target = null;

                // Priority 1: Midfielder (Playmaker)
                target = validMates.find(p => p.role === 'MF');
                
                // Priority 2: Defenders
                if (!target) target = validMates.find(p => p.role === 'LD' || p.role === 'RD');
                
                // Priority 3: Anyone open (fallback to close range if no one is far)
                if (!target) target = this.team.players.find(p => p !== this && p.role !== 'GL');

                if (target && target.mesh) {
                    // AIMING LOGIC: Loft the pass
                    // Look at target, but aim slightly up to create an arc
                    const targetPos = target.mesh.position.clone();
                    
                    // Calculate distance
                    const dist = this.mesh.position.distanceTo(targetPos);
                    
                    // Loft factor: The further away, the higher we aim
                    // 20 units away -> Aim 5 units above head
                    const loft = Math.max(1.0, dist * 0.25);
                    targetPos.y += loft;

                    this.mesh.lookAt(targetPos);
                    
                    // Throw
                    const ball = window.flux.gameInstance.entities.ball;
                    this.throwBall(ball, 'PA'); 
                    console.log(`${this.role} throws to ${target.role} (Dist: ${dist.toFixed(1)})`);
                } else {
                    // Clear it forward
                    this.mesh.lookAt(0, 5, 0); // Aim up-center
                    const ball = window.flux.gameInstance.entities.ball;
                    this.throwBall(ball, 'SH'); // Hard clear
                }
                
                this.throwTimer = 0;
            }
        }
    }

    window.flux.Goalie = Goalie;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Reusable math vectors to avoid GC
const _bVec = new THREE.Vector3();
    const _bDir = new THREE.Vector3();
    const _axisY = new THREE.Vector3(0, 1, 0);
    const _tempVec = new THREE.Vector3();
    const _magnusVec = new THREE.Vector3();

// Physics Configuration (Exposed for DevTools)
window.flux.BallConfig = {
        // -----------------------------------------------------------------
        // Core integration
        // -----------------------------------------------------------------
        SUBSTEPS: 2,                // Physics substeps per frame (stability at high speeds)
        STOP_SPEED: 0.02,           // Below this speed, snap to rest (prevents endless drift)

        // -----------------------------------------------------------------
        // Water resistance (physical velocity drag, NOT stat decay)
        // -----------------------------------------------------------------
        WATER_DRAG_LINEAR: 0.15,    // Linear drag term (roughly your previous WATER_DRAG)
        WATER_DRAG_QUAD: 0.002,     // Quadratic drag (stronger at high speed, helps tame rockets)

        // -----------------------------------------------------------------
        // Spin & curve
        // -----------------------------------------------------------------
        SPIN_DRAG: 0.40,            // Spin decay per second
        MAGNUS_ENABLED: true,
        MAGNUS_COEFF: 0.08,         // Lift strength
        MAGNUS_CAP: 60.0,           // Max magnus delta-V per substep (prevents explosions)

        // -----------------------------------------------------------------
        // Depth constraint (keeps ball near play plane without feeling like a hard floor)
        // -----------------------------------------------------------------
        DEPTH_TARGET_Y: 0.0,
        DEPTH_SPRING: 1.0,          // Your previous GRAVITY_SPRING
        DEPTH_DAMP: 1.5,            // Your previous GRAVITY_DAMP

        // -----------------------------------------------------------------
        // Arena boundary (soft wall + clamp)
        // -----------------------------------------------------------------
BOUNDARY_RADIUS: 46.0,
        BOUNDARY_HEIGHT: 20.0,
        GOAL_POCKET_ENABLED: true,
        GOAL_POCKET_X: 12.0,        // Half-width of goal pocket corridor
        GOAL_POCKET_Z: 40.0,        // Start of goal pocket corridor (abs z) - Pushed back
        GOAL_POCKET_RADIUS: 55.0,   // Effective radius when in goal pocket
        WALL_SOFT_BUFFER: 3.0,      // Distance from wall where soft repulsion begins
        WALL_SOFT_FORCE: 20.0,      // Soft repulsion strength
        WALL_ELASTICITY: 0.30,      // Bounce dampening on clamp
        WALL_FRICTION: 0.95,        // Tangential damping on wall contact

        FLOOR_ELASTICITY: 0.40,     // Bounce dampening on ceiling/floor clamp

        // -----------------------------------------------------------------
        // Throw mapping (stat force -> physical launch speed)
        // -----------------------------------------------------------------
        LAUNCH_SPEED_SCALE: 1.0,    // Multiplies force when converting to velocity
        LAUNCH_SPEED_CAP: 85.0      // Physical speed cap (was hardcoded in Ball.shoot)
    };


    
    const C = window.flux.BallConfig; // Local alias for brevity
    // --- TRAIL RENDERER ---
// --- TRAIL RENDERER ---
    class TrailRenderer {
        constructor(scene) {
            this.scene = scene;
            this.segments = 30; // More segments for smoother curves
            this.points = [];
this.baseWidth = 0.8; // Increased width for visibility
            this.currentWidth = 0.8;
            
            // Geometry
            const geometry = new THREE.BufferGeometry();
            const posData = new Float32Array(this.segments * 2 * 3);
            geometry.setAttribute('position', new THREE.BufferAttribute(posData, 3));
            
            // Indices
            const indices = [];
            for (let i=0; i<this.segments-1; i++) {
                const base = i*2;
                indices.push(base, base+1, base+2);
                indices.push(base+1, base+3, base+2);
            }
            geometry.setIndex(indices);
            
            this.material = new THREE.MeshBasicMaterial({
                color: 0x00aaff,
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.9, // Increased opacity
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            
            this.mesh = new THREE.Mesh(geometry, this.material);
            this.mesh.frustumCulled = false;
            this.scene.add(this.mesh);
            
            // Init points
            for(let i=0; i<this.segments; i++) this.points.push(new THREE.Vector3());
            this.active = false;

            // Reusable temps (avoid per-frame allocations on mobile)
            this._tmpDir = new THREE.Vector3();
            this._tmpToCam = new THREE.Vector3();
            this._tmpRight = new THREE.Vector3();
        }
        
        reset(pos) {
            for(let i=0; i<this.segments; i++) this.points[i].copy(pos);
            this.updateGeometry();
        }
        
        setColor(hex) {
            this.material.color.setHex(hex);
        }
        
        update(currentPos, speedRatio = 0.0) {
            if (!this.active) {
                this.reset(currentPos);
                return;
            }

// Dynamic Width based on speed AND SPIN (Power Visual)
            // Fast ball = Thicker. Spinning ball = Even Thicker.
            const ball = window.flux.gameInstance ? window.flux.gameInstance.entities.ball : null;
            const spinRatio = ball ? Math.min(1.0, ball.angularVelocity.length() / 30.0) : 0;
            
            const targetWidth = this.baseWidth * (0.8 + speedRatio * 1.2 + spinRatio * 2.0);
            this.currentWidth += (targetWidth - this.currentWidth) * 0.2; // Smooth transition

            // Shift points
            for (let i = this.segments - 1; i > 0; i--) {
                this.points[i].copy(this.points[i-1]);
            }
            this.points[0].copy(currentPos);
            
            this.updateGeometry();
        }
        
        updateGeometry() {
            const positions = this.mesh.geometry.attributes.position.array;
            const cam = window.flux.gameInstance ? window.flux.gameInstance.camera : null;
            if (!cam) return;
            const camPos = cam.position;
            const tempDir = this._tmpDir;
            const tempToCam = this._tmpToCam;
            const tempRight = this._tmpRight;
            for (let i=0; i<this.segments; i++) {
                const p = this.points[i];
                
                // Taper width along trail length
                const taper = 1.0 - Math.pow(i / this.segments, 2); // Quadratic taper
                const w = this.currentWidth * taper;
                
                // Calculate direction
                if (i < this.segments - 1) {
                    tempDir.subVectors(this.points[i], this.points[i+1]);
                } else {
                    tempDir.subVectors(this.points[i-1], this.points[i]);
                }
                
                if (tempDir.lengthSq() < 0.0001) tempDir.set(0, 1, 0);
                tempDir.normalize();
                
                tempToCam.subVectors(camPos, p).normalize();
                tempRight.crossVectors(tempDir, tempToCam).normalize().multiplyScalar(w);
                
                // Vert 1
                positions[i*6 + 0] = p.x - tempRight.x;
                positions[i*6 + 1] = p.y - tempRight.y;
                positions[i*6 + 2] = p.z - tempRight.z;
                
                // Vert 2
                positions[i*6 + 3] = p.x + tempRight.x;
                positions[i*6 + 4] = p.y + tempRight.y;
                positions[i*6 + 5] = p.z + tempRight.z;
            }
            this.mesh.geometry.attributes.position.needsUpdate = true;
        }
    }
class Ball {

        constructor(scene) {
            this.scene = scene;
            this.mesh = null;
            this.holder = null; 
            this.lastHolder = null; // Track who threw it last (for EXP/Assists)
            
            this.velocity = new THREE.Vector3(0, 0, 0);
            this.angularVelocity = new THREE.Vector3(0, 0, 0);
            this.state = 'free'; // 'free', 'held', 'magnetized'
            this.isInvisible = false;

            // Continuous Stats
            this.power = 0;      // Current PA or SH value
            this.powerType = 'none'; // 'PA' or 'SH'
            this.decayRate = 3.0; // Stat points lost per second (Water resistance)
            this.catchGracePeriod = 0; // Time before ball can be caught again

            // Magnet System
            this.magnetTarget = null;
            this.magnetTimer = 0;
            this.magnetDuration = 0.2; 
            this.magnetStartPos = new THREE.Vector3();
            this.magnetStartVel = new THREE.Vector3();

            // Visuals (Squash & Stretch)
            this.accumulatedRotation = new THREE.Quaternion();
            this.deformNode = null;
            this.spinNode = null;
            this.model = null;

this.initMesh();
            this.trail = new TrailRenderer(scene);
            this._bubbleTimer = 0;
}
initMesh() {
            // Hierarchy: Mesh (Pos) -> Deform (Squash/Stretch) -> Spin (Rotation) -> Model
            this.mesh = new THREE.Group();
            this.scene.add(this.mesh);

            this.deformNode = new THREE.Group();
this.deformNode = new THREE.Group();
            this.deformNode.position.y = 0.0; // Reset offset so ball is centered on mesh position
            this.mesh.add(this.deformNode); // Fix: Add deformNode to mesh

            this.spinNode = new THREE.Group();
            this.deformNode.add(this.spinNode);

            // Procedural Placeholder Texture (Blitzball-ish)
            const placeholderTex = (() => {
                const c = document.createElement('canvas');
                c.width = 128; c.height = 64;
                const ctx = c.getContext('2d');
                ctx.fillStyle = '#eeeeee';
                ctx.fillRect(0,0,128,64);
                
                // Blue bumps/details
                ctx.fillStyle = '#0088ff';
                for(let i=0; i<6; i++) {
                    ctx.beginPath();
                    ctx.arc(i*25, 32, 10, 0, Math.PI*2);
                    ctx.fill();
                }
                ctx.fillStyle = '#004488';
                ctx.fillRect(0, 28, 128, 8); // Stripe
                
                return new THREE.CanvasTexture(c);
            })();

            // Placeholder Visual (Immediate feedback, persists until valid model loads)
// Placeholder Visual (Immediate feedback, persists until valid model loads)
// Placeholder Visual (Immediate feedback, persists until valid model loads)
const geometry = new THREE.SphereGeometry(0.3, 16, 16); // Scaled down ~15%
            const material = new THREE.MeshBasicMaterial({
                map: placeholderTex,
                color: 0xffffff, 
                wireframe: false, // Solid
                transparent: false,
                opacity: 1.0
            });
            this.placeholder = new THREE.Mesh(geometry, material);

            // Load GLB Model
            const url = 'https://cdn.tinyglb.com/models/521ae8788e584e378a79d9732a075356.glb';
            
            window.flux.AssetLoader.loadModel(url, (gltf) => {
                console.log("DEBUG: Ball GLB loaded.", gltf);
                
                const model = gltf.scene;

                // 1. Reset root transforms
                model.position.set(0, 0, 0);
                model.rotation.set(0, 0, 0);
                model.scale.set(1, 1, 1);
                model.updateMatrixWorld(true);

                // 2. Harden Materials & Visibility
                model.traverse((node) => {
                    if (node.isMesh) {
                        node.castShadow = false;
                        node.receiveShadow = false;
                        node.frustumCulled = false; // CRITICAL: Prevent culling if bounds are off
                        
                        if (node.material) {
                            const mats = Array.isArray(node.material) ? node.material : [node.material];
                            mats.forEach(m => {
                                m.color.setHex(0xffffff); // Force white base
                                m.side = THREE.DoubleSide;
                                m.transparent = false;
                                m.opacity = 1.0;
                                m.alphaTest = 0; // CRITICAL: Disable alpha test to prevent culling
                                m.depthWrite = true;
                                m.depthTest = true;
                            });
                        }
                    }
                });

                // 3. Compute Bounding Box
                const box = new THREE.Box3().setFromObject(model);
                const size = new THREE.Vector3();
                box.getSize(size);
                const center = new THREE.Vector3();
                box.getCenter(center);

                // 4. Validation
                const maxDim = Math.max(size.x, size.y, size.z);
                if (maxDim <= 0.001 || !isFinite(maxDim)) {
                    console.warn("Ball model has invalid dimensions. Keeping placeholder.");
                    return; 
                }

                // 5. Calculate Scale
// 5. Calculate Scale
const targetDiameter = 0.72; // Reduced scale by ~15% (was 0.85)
                const scaleFactor = targetDiameter / maxDim;

                // 6. Apply Transforms
                model.scale.setScalar(scaleFactor);
                model.position.copy(center).multiplyScalar(-scaleFactor);

                // 7. Swap Placeholder
                if (this.placeholder) {
                    this.spinNode.remove(this.placeholder);
                    if (this.placeholder.geometry) this.placeholder.geometry.dispose();
                    this.placeholder = null;
                }

                this.model = model;
                this.spinNode.add(this.model);
                console.log(`Blitzball model attached. Scale: ${scaleFactor.toFixed(4)}`);

            }, undefined, (err) => {
                console.error("Failed to load Blitzball model:", err);
                // Fallback: Keep placeholder but tint it red to indicate error
                if (this.placeholder) {
                    this.placeholder.material.color.setHex(0xffaaaa);
                }
            });
        }

update(dt) {
            if (!this.mesh) return;

            // Ball Lab replay override (lets DevTools drive the ball deterministically)
            const __lab = window.flux && window.flux.ballLab;
            if (__lab && __lab.isReplaying && __lab.targetBall === this && typeof __lab.applyReplayFrame === 'function') {
                __lab.applyReplayFrame(this, dt);
                if (this.trail) this.trail.active = false;
                this.updateVisuals(dt);
                return;
            }

            // Safety: Reset if position corrupted
            if (isNaN(this.mesh.position.x) || isNaN(this.mesh.position.y) || isNaN(this.mesh.position.z)) {
                this.reset();
                return;
            }

            // Safety: Fix "Unpickable Ball" Bug
            // If state is 'held' or 'magnetized' but the actor is missing/invalid, force drop to 'free'.
            if (this.state === 'held' && (!this.holder || !this.holder.mesh)) {
                this.drop();
            }
            if (this.state === 'magnetized' && (!this.magnetTarget || !this.magnetTarget.mesh)) {
                this.drop();
            }
if (this.trail) {
                // Trail is active if ball is moving fast and free
                const speed = this.velocity.length();
                this.trail.active = (this.state === 'free' && speed > 2.0);
                
                // Fix: Offset trail to match visual model position (deformNode offset)
                _bVec.copy(this.mesh.position);
                if (this.deformNode) _bVec.y += this.deformNode.position.y;

                // Pass speed ratio (0 to 1 based on max speed approx 60)
                const ratio = Math.min(speed / 60.0, 1.0);
                this.trail.update(_bVec, ratio);
            }

            if (this.state === 'held' && this.holder && this.holder.mesh) {
                this.updateHeld(dt);
            } else if (this.state === 'magnetized') {
                this.updateMagnetized(dt);
            } else {
                this.updateFree(dt);
            }
            
            if (this.catchGracePeriod > 0) {
                this.catchGracePeriod -= dt;
            }

this.updateVisuals(dt);
            
            // Safety: Ensure visibility if not explicitly invisible
// Safety: Ensure visibility if not explicitly invisible
            if (this.mesh && !this.isInvisible) {
                this.mesh.visible = true;
                // Force model visibility if present (sometimes GLTF loader hides it)
                if (this.model) this.model.visible = true;
            }
        }

magnetize(target) {
            if (this.state === 'magnetized' || this.state === 'held') return;
            
            this.state = 'magnetized';
            this.magnetTarget = target;
            this.holder = target; // Logical possession so AI reacts
            this.magnetTimer = 0;
            this.magnetStartPos.copy(this.mesh.position);
            this.magnetStartVel.copy(this.velocity);
            
            // Dynamic Duration based on distance (Smoother for long range, snappy for close)
            const dist = this.mesh.position.distanceTo(target.mesh.position);
            this.magnetDuration = Math.max(0.15, Math.min(0.4, dist / 15.0));
            
            // Kill physics
            this.velocity.set(0, 0, 0);
            this.angularVelocity.set(0, 0, 0);

            // Notify player immediately so they stop chasing and play animation
            if (target.receiveBall) {
                target.receiveBall();
            }

            this.reveal();
        }

updateMagnetized(dt) {
            if (!this.magnetTarget || !this.magnetTarget.mesh) {
                this.drop();
                return;
            }

            this.magnetTimer += dt;
            
            // Normalized Time
            let t = this.magnetTimer / this.magnetDuration;
            if (t > 1.0) t = 1.0;

            // Target "Virtual Hand" Position (Front of Chest)
            const holderPos = this.magnetTarget.mesh.position;
            const holderQuat = this.magnetTarget.mesh.quaternion;
            
            // Offset: Forward 0.6, Up 1.0 (Chest height)
            const offset = _bVec.set(0, 1.0, 0.6).applyQuaternion(holderQuat);
            const targetPos = offset.add(holderPos);

            // --- QUADRATIC BEZIER CURVE ---
            // P0 = Start, P2 = Target
            // P1 = Control Point (Projected along initial velocity to preserve momentum feel)
            
            const p0 = this.magnetStartPos;
            const p2 = targetPos;
            
            // Calculate P1 (Control Point)
            // Project forward from P0 along start velocity vector
            // Distance of projection = 40% of total distance to target
            const dist = p0.distanceTo(p2);
            const p1 = _tempVec.copy(p0);
            
            const velLen = this.magnetStartVel.lengthSq();
            if (velLen > 1.0) {
                // Use velocity tangent
// Use velocity tangent
                _bDir.copy(this.magnetStartVel).normalize();
                p1.add(_bDir.multiplyScalar(dist * 0.4));
            } else {
                // No velocity (stationary ball), arc upwards slightly
                p1.lerp(p2, 0.5);
                p1.y += 1.5; 
            }

            // Bezier: B(t) = (1-t)^2 * P0 + 2(1-t)t * P1 + t^2 * P2
            const oneMinusT = 1.0 - t;
            const w0 = oneMinusT * oneMinusT;
            const w1 = 2.0 * oneMinusT * t;
            const w2 = t * t;
            
            this.mesh.position.x = (w0 * p0.x) + (w1 * p1.x) + (w2 * p2.x);
            this.mesh.position.y = (w0 * p0.y) + (w1 * p1.y) + (w2 * p2.y);
            this.mesh.position.z = (w0 * p0.z) + (w1 * p1.z) + (w2 * p2.z);

            // Finish
            if (t >= 1.0) {
                this.grab(this.magnetTarget);
            }
        }

updateHeld(dt) {
            // ATTACHED STATE (Virtual Attachment)
            if (!this.holder || !this.holder.mesh) {
                this.drop();
                return;
            }

            this.velocity.set(0, 0, 0);
            this.angularVelocity.set(0, 0, 0);

            // 1. Try to use Hand Bone if available (Realism)
            if (this.holder.handBone) {
                // Get world position of the hand bone
                this.holder.handBone.getWorldPosition(this.mesh.position);
                
                // Adjust slightly to sit IN the hand rather than ON the wrist
                // We can't easily know "forward" for the bone without more info, 
                // but usually GLTF bones are oriented. For now, exact bone pos is better than chest.
            } else {
                // 2. Fallback: Calculate "Carrying" Position (Right Hand Side)
                // Relative to player: Up 0.8 (Waist/Chest), Right 0.4, Forward 0.5
                const holderPos = this.holder.mesh.position;
                const holderQuat = this.holder.mesh.quaternion;
                
                // Reuse _bVec
// Reuse _bVec
                // Offset: x=0.35 (Right), y=1.3 (Chest/Hands), z=0.5 (Forward)
                _bVec.set(0.35, 1.3, 0.5).applyQuaternion(holderQuat);
                this.mesh.position.copy(holderPos).add(_bVec);
            }

// Visual Flair: Spin the ball slowly
            const rotX = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0), 2 * dt);
            const rotY = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0), 5 * dt);
            this.accumulatedRotation.multiply(rotX).multiply(rotY);
        }


updateFree(dt) {
    const C = window.flux.BallConfig || {};
    const substeps = Math.max(1, Math.floor(C.SUBSTEPS || 1));
    const stepDt = dt / substeps;

    // --- 1) Integrate physics in substeps for stability ---
    for (let s = 0; s < substeps; s++) {
        // A) Magnus effect (curve from spin)
        if (C.MAGNUS_ENABLED && this.angularVelocity && this.velocity) {
            const spinSq = this.angularVelocity.lengthSq();
            const velSq = this.velocity.lengthSq();
            if (spinSq > 0.25 && velSq > 0.25) {
                _magnusVec.copy(this.angularVelocity).cross(this.velocity).multiplyScalar((C.MAGNUS_COEFF || 0) * stepDt);

                // Cap to avoid numeric blowups
                const cap = (C.MAGNUS_CAP !== undefined ? C.MAGNUS_CAP : 60.0);
                const magLen = _magnusVec.length();
                if (magLen > cap) _magnusVec.multiplyScalar(cap / magLen);

                this.velocity.add(_magnusVec);
            }
        }

        // B) Spin decay
        if (this.angularVelocity) {
            const spinDrag = Math.max(0, 1.0 - (C.SPIN_DRAG || 0) * stepDt);
            this.angularVelocity.multiplyScalar(spinDrag);
        }

        // C) Depth spring (keeps ball near plane)
        const targetY = (C.DEPTH_TARGET_Y !== undefined ? C.DEPTH_TARGET_Y : 0.0);
        const yErr = (this.mesh.position.y - targetY);
        this.velocity.y -= yErr * (C.DEPTH_SPRING || 0) * stepDt;
        this.velocity.y *= Math.max(0, 1.0 - (C.DEPTH_DAMP || 0) * stepDt);

        // D) Apply drag (linear + quadratic)
        const vLen = this.velocity.length();
        if (vLen > 0.00001) {
            const lin = (C.WATER_DRAG_LINEAR !== undefined ? C.WATER_DRAG_LINEAR : (C.WATER_DRAG || 0)) * stepDt;
            const quad = (C.WATER_DRAG_QUAD || 0) * vLen * stepDt;
            const drag = Math.max(0, 1.0 - lin - quad);
            this.velocity.multiplyScalar(drag);

            const stop = (C.STOP_SPEED || 0);
            if (stop > 0 && this.velocity.lengthSq() < stop * stop) {
                this.velocity.set(0, 0, 0);
            }
        }

        // E) Move
        _tempVec.copy(this.velocity).multiplyScalar(stepDt);
        this.mesh.position.add(_tempVec);

        // F) Stat power decay (game logic)
        if (this.power > 0) {
            this.power -= this.decayRate * stepDt;
            if (this.power < 0) this.power = 0;
        }

        // G) Boundary logic (soft wall + clamp)
        const pos = this.mesh.position;
        const distXZ = Math.sqrt(pos.x * pos.x + pos.z * pos.z);

        const boundaryRadius = (C.BOUNDARY_RADIUS !== undefined ? C.BOUNDARY_RADIUS : 33.0);
        let effectiveBoundary = boundaryRadius;

        if (C.GOAL_POCKET_ENABLED) {
            const inGoalPocket = (Math.abs(pos.x) < (C.GOAL_POCKET_X || 12.0) && Math.abs(pos.z) > (C.GOAL_POCKET_Z || 25.0));
            if (inGoalPocket) effectiveBoundary = (C.GOAL_POCKET_RADIUS || 45.0);
        }

        const softBuffer = Math.max(0.01, (C.WALL_SOFT_BUFFER !== undefined ? C.WALL_SOFT_BUFFER : 3.0));

        // Soft repulsion (curves trajectory near wall instead of ping-pong)
        if (distXZ > effectiveBoundary - softBuffer) {
            const penetration = distXZ - (effectiveBoundary - softBuffer);
            const ratio = Math.max(0, Math.min(1, penetration / softBuffer));

            _tempVec.set(-pos.x, 0, -pos.z);
            if (_tempVec.lengthSq() > 0.0001) {
                _tempVec.normalize();
                const force = ratio * ratio * (C.WALL_SOFT_FORCE || 0) * stepDt;
                this.velocity.addScaledVector(_tempVec, force);
            }
        }

        // Hard clamp if it still hits
        if (distXZ > effectiveBoundary) {
            _tempVec.set(-pos.x, 0, -pos.z);
            if (_tempVec.lengthSq() > 0.0001) _tempVec.normalize();

            const overlap = distXZ - effectiveBoundary;
            pos.addScaledVector(_tempVec, overlap);

const vDotN = this.velocity.dot(_tempVec);

            // Only adjust if moving outward (against inward normal)
            if (vDotN < 0) {
                // Trigger Arena Deformation if impact is forceful
                const impactSpeed = Math.abs(vDotN);
                if (impactSpeed > 10.0 && window.flux.triggerArenaImpact) {
                    // Pass the contact point (pos) and strength based on speed
                    window.flux.triggerArenaImpact(pos, Math.min(impactSpeed * 0.5, 15.0));
                }

                const e = (C.WALL_ELASTICITY !== undefined ? C.WALL_ELASTICITY : 0.3);
                const impulse = _tempVec.clone().multiplyScalar(-vDotN * (1.0 + e));
                this.velocity.add(impulse);
                
                // Tangential friction
                const friction = (C.WALL_FRICTION !== undefined ? C.WALL_FRICTION : 0.95);
                const tangent = this.velocity.clone().projectOnPlane(_tempVec);
                this.velocity.sub(tangent.multiplyScalar(1.0 - friction));
            }
        }

        // Ceiling/Floor clamp
        const bh = (C.BOUNDARY_HEIGHT !== undefined ? C.BOUNDARY_HEIGHT : 15.0);
        if (Math.abs(pos.y) > bh) {
            const sign = Math.sign(pos.y) || 1;
            pos.y = bh * sign;
            const fe = (C.FLOOR_ELASTICITY !== undefined ? C.FLOOR_ELASTICITY : 0.4);
            this.velocity.y *= -fe;
}
    }

    // --- 2) FX that should run once per frame (not per substep) ---
    if (!this._ghost) {
        const speedSq = this.velocity.lengthSq();
        if (speedSq > 2.0 && window.flux.gameInstance && window.flux.gameInstance.particleManager) {
            this._bubbleTimer -= dt;
            if (this._bubbleTimer <= 0) {
                const pm = window.flux.gameInstance.particleManager;
                const offset = this.velocity.clone().normalize().multiplyScalar(-0.8);

                // Standard bubble
// Standard bubble
                const stdPos = this.mesh.position.clone().add(offset).add(_bDir.set((Math.random()-0.5)*0.3, (Math.random()-0.5)*0.3, (Math.random()-0.5)*0.3));
                if (this.deformNode) stdPos.y += this.deformNode.position.y;
                pm.spawn('bubble', stdPos, { scale: 0.4 + Math.random() * 0.4 }); // Increased scale

                // Micro bubbles at high speed
                if (speedSq > 50.0) {
                    const count = Math.min(4, Math.floor(speedSq / 60));
                    for (let i = 0; i < count; i++) {
const jitter = _bDir.set((Math.random()-0.5)*0.4, (Math.random()-0.5)*0.4, (Math.random()-0.5)*0.4);
                        const spawnPos = this.mesh.position.clone().add(offset).add(jitter);
                        if (this.deformNode) spawnPos.y += this.deformNode.position.y;
                        pm.spawn('bubble_micro', spawnPos, { scale: 0.05 + Math.random() * 0.1 });
                    }
                    this._bubbleTimer = 0.02;
                } else {
                    if (Math.random() > 0.5) {
const jitter = _bDir.set((Math.random()-0.5)*0.2, (Math.random()-0.5)*0.2, (Math.random()-0.5)*0.2);
                        const spawnPos = this.mesh.position.clone().add(offset).add(jitter);
                        if (this.deformNode) spawnPos.y += this.deformNode.position.y;
                        pm.spawn('bubble_micro', spawnPos, { scale: 0.04 + Math.random() * 0.06 });
                    }
                    this._bubbleTimer = 0.05;
                }
            }
        }
    }

    // --- 3) Visual rotation ---
    const spinSpeed = this.angularVelocity.length();
    if (spinSpeed > 0.5) {
        const axis = _tempVec.copy(this.angularVelocity).normalize();
        const q = new THREE.Quaternion().setFromAxisAngle(axis, spinSpeed * dt);
        this.accumulatedRotation.premultiply(q);
    } else {
        const speed = this.velocity.length();
        if (speed > 0.1) {
            _tempVec.copy(this.velocity).cross(_axisY).normalize();
            if (_tempVec.lengthSq() > 0.01) {
                const q = new THREE.Quaternion().setFromAxisAngle(_tempVec, speed * dt);
                this.accumulatedRotation.premultiply(q);
            }
        }
    }
}

grab(player) {
            this.reveal(); 
            
            // Announcement: Possession (if taking from free state)
            if (this.state === 'free') {
                 if (window.flux.gameInstance && window.flux.gameInstance.showAnnouncement) {
                     window.flux.gameInstance.showAnnouncement("POSSESSION", "normal");
                 }
            }

            // Check Turnover (Possession Change)
            const previousTeam = this.holder ? this.holder.team : (this.lastHolder ? this.lastHolder.team : null);
            if (previousTeam && previousTeam !== player.team) {
                 if (window.flux.gameInstance && window.flux.gameInstance.floatingText) {
                     window.flux.gameInstance.floatingText.spawn("TURNOVER", player.mesh.position, "tech");
                 }
            }
            
            // If someone else held it, they lose it
            if (this.holder && this.holder !== player) {
                this.holder.loseBall();
            }

            this.holder = player;
            this.state = 'held';
            
            // NOTE: We do NOT parent the mesh to the player anymore.
            // This prevents the ball from flying around due to swim animations.
            // Instead, we update its position manually in updateHeld().
            
            // Notify player
            if (player.receiveBall) {
                player.receiveBall();
            }
            
            console.log("Ball grabbed by " + player.role);
        }

        drop() {
            this.reveal(); // Ensure visible
            
            // No need to detach from scene graph since we aren't parenting to player anymore.
            // Just clear holder.

            if (this.holder) {
                if (this.holder.loseBall) this.holder.loseBall();
                this.holder = null;
            }
            
            this.state = 'free';
        }
// Shoot/Pass
// Shoot/Pass
        shoot(directionVector, force, type = 'SH', technique = null, spinVector = null) {
            this.lastHolder = this.holder; // Record for EXP attribution
            
            // Fumble Detection (Type 'none' is used by Player.fumble)
            if (type === 'none') {
                if (window.flux.gameInstance && window.flux.gameInstance.showAnnouncement) {
                    window.flux.gameInstance.showAnnouncement("FUMBLE!", "slam");
                }
            }

            this.drop(); // Detach first
            
            // Set Grace Period to prevent instant interceptions/catches
            // 0.2s allows ball to clear the thrower's immediate vicinity
            this.catchGracePeriod = 0.2;

            // Physical Velocity (Visual speed)
// Physical Velocity (Visual speed)
            // We map force (stat) to physical speed, but clamp it reasonable
            // Increased cap to 40.0 to allow for strong passes and clears
// Increased cap to 85.0 to allow for strong passes and clears and "Max Power" feel
const C = window.flux.BallConfig || {};
            const scale = (C.LAUNCH_SPEED_SCALE !== undefined ? C.LAUNCH_SPEED_SCALE : 1.0);
            const cap = (C.LAUNCH_SPEED_CAP !== undefined ? C.LAUNCH_SPEED_CAP : 85.0);
            const speed = Math.min(force * scale, cap);
            this.velocity.copy(directionVector).normalize().multiplyScalar(speed);
            
            // Apply Spin if provided
            if (spinVector) {
                this.angularVelocity.copy(spinVector);
            } else {
                this.angularVelocity.set(0, 0, 0);
            }
            
            // Stat Power (Game Logic)
            this.power = force;
            this.powerType = type;
            this.technique = technique; 
            
            // Update Trail Color
            if (this.trail) {
                let color = 0x00aaff; // Default Blue (Pass)
                
                if (technique) {
                    if (technique.type === 'venom') color = 0xaa00ff; // Purple
                    else if (technique.type === 'wither') color = 0x888888; // Grey
                    else if (technique.type === 'nap') color = 0x000088; // Dark Blue
                    else if (technique.type === 'sphere') color = 0x00ffff; // Cyan
                    else if (technique.type === 'jecht') color = 0xff0000; // Red
                } else if (type === 'SH') {
                    color = 0xff4400; // Orange/Red
                }
                
                this.trail.setColor(color);
            }
            
            // Handle Invisible Shot
            if (technique && technique.type === 'invisible') {
                this.isInvisible = true;
                if (this.mesh) this.mesh.visible = false;
                console.log("Invisible Shot!");
            }
            
            console.log(`Ball ${type} with Power: ${this.power.toFixed(1)} Spin: ${this.angularVelocity.length().toFixed(1)}`);
            
            // Visual Feedback for Curve
            if (this.angularVelocity.length() > 15.0 && window.flux.gameInstance && window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("CURVE!", this.mesh.position, "tech");
            }
        }

        reveal() {

            this.isInvisible = false;
            if (this.mesh) this.mesh.visible = true;
        }
        
reset() {
            this.reveal();
            this.drop();
            this.mesh.position.set(0, 0, 0);
            this.velocity.set(0, 0, 0);
            this.angularVelocity.set(0, 0, 0);
            this.catchGracePeriod = 0;
            this.power = 0;
        }
isCatchable() {
            return this.catchGracePeriod <= 0;
        }

        updateVisuals(dt) {
            if (!this.deformNode || !this.spinNode) return;

            // 1. Squash & Stretch based on velocity
// 1. Squash & Stretch based on velocity
            const speed = this.velocity.length();
            
            // Only apply stretch if moving fast enough
            if (speed > 1.0 && this.state === 'free') {
                // Orient deformNode to velocity direction
                const dir = this.velocity.clone().normalize();
                // Default forward is Z (0,0,1)
                this.deformNode.quaternion.setFromUnitVectors(new THREE.Vector3(0,0,1), dir);
                
                // Calculate stretch factor
                // Max stretch at speed 40 (approx max shot power)
                const factor = Math.min(speed / 40.0, 1.0); 
                const stretch = 1.0 + (factor * 0.8); // Increased stretch max to 1.8x
                const squash = 1.0 / Math.sqrt(stretch); // Maintain volume
                
                this.deformNode.scale.set(squash, squash, stretch);
            } else {
                // Reset deformation
                this.deformNode.quaternion.identity();
                this.deformNode.scale.set(1, 1, 1);
            }

            // 2. Apply Accumulated Spin
            // Since deformNode might be rotated, we need to apply spin in the correct space.
            // spinNode rotation = deformNode_inverse * accumulatedRotation
const invDeform = this.deformNode.quaternion.clone().invert();
            this.spinNode.quaternion.copy(invDeform.multiply(this.accumulatedRotation));
        }
    }

window.flux.Ball = Ball;
    window.flux.TrailRenderer = TrailRenderer;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class MiniMap {
        constructor() {
            this.container = document.getElementById('minimap');
            this.dots = new Map(); // Map entity to DOM element
            this.width = 100; // Matches CSS width
            this.height = 100; // Matches CSS height
            this.worldRadius = 30; // Arena radius
        }

        register(entity, type) {
            if (!this.container) return;
            
            const dot = document.createElement('div');
            dot.className = `map-dot ${type}`;
            this.container.appendChild(dot);
            
            this.dots.set(entity, dot);
        }

        init(homeTeam, awayTeam, ball) {
            if (!this.container) return;
            this.container.innerHTML = ''; // Clear existing
            this.dots.clear();

            // Register Home Team
            homeTeam.players.forEach(p => this.register(p, 'home'));
            
            // Register Away Team
            awayTeam.players.forEach(p => this.register(p, 'away'));
            
            // Register Ball
            this.register(ball, 'ball');
        }

        update() {
            if (!this.container) return;

            const halfW = this.width / 2;
            const halfH = this.height / 2;
            // Scale: Map Radius (50px) / World Radius (30 units)
            const scale = halfW / this.worldRadius; 

for (const [entity, dot] of this.dots) {
                if (!entity.mesh) continue;

                // Invisible Ball Logic
                if (entity.isInvisible) {
                    dot.style.display = 'none';
                    continue;
                } else {
                    dot.style.display = 'block';
                }
                if (!entity.mesh) continue;

                const pos = entity.mesh.position;
                
                // Map Logic:
                // World Z is Up/Down. -Z is Top (Attack Direction for Home), +Z is Bottom.
                // World X is Left/Right.
                
                // Calculate raw position relative to center
                let dx = pos.x * scale;
                let dy = pos.z * scale;

                // Clamp to circle (keep dots inside the map)
                const dist = Math.sqrt(dx*dx + dy*dy);
                const maxDist = halfW - 2; // -2 for dot radius padding
                
                if (dist > maxDist) {
                    const angle = Math.atan2(dy, dx);
                    dx = Math.cos(angle) * maxDist;
                    dy = Math.sin(angle) * maxDist;
                }

                // Convert to CSS coordinates (0,0 is Top-Left)
                // Center is (50, 50)
                const cssX = halfW + dx;
                const cssY = halfH + dy;

                dot.style.transform = `translate(${cssX}px, ${cssY}px)`;
                
// Status Updates
                if (entity.status) {
                    // Nap (Sleep) turns dot dark/black
                    if (entity.status.nap > 0) {
                        if (!dot.classList.contains('nap')) dot.classList.add('nap');
                    } else {
                        if (dot.classList.contains('nap')) dot.classList.remove('nap');
                    }
                }

                // Active Player Marker (Green)
// Active Player Marker (Green)
                const game = window.flux.gameInstance;
                const isActive = (game && game.teams.home && game.teams.home.activePlayer === entity);
                
                if (isActive) {
                    if (!dot.classList.contains('active-player')) dot.classList.add('active-player');
                } else {
                    if (dot.classList.contains('active-player')) dot.classList.remove('active-player');
                }

                // Ball Carrier Marker (Glow)
                if (entity.hasBall) {
                    if (!dot.classList.contains('ball-carrier')) dot.classList.add('ball-carrier');
                } else {
                    if (dot.classList.contains('ball-carrier')) dot.classList.remove('ball-carrier');
                }
            }
        }
    }
            

    

    window.flux.MiniMap = MiniMap;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

// Spark Texture (Procedural Burst)
    const _sparkTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0,0,64,64);
        
        // Burst shape
        const cx = 32, cy = 32;
        const spikes = 8;
        const outer = 30;
        const inner = 10;
        
        ctx.beginPath();
        for(let i=0; i<spikes*2; i++){
            const r = (i%2===0)? outer : inner;
            const a = (Math.PI*i)/spikes;
            ctx.lineTo(cx + Math.cos(a)*r, cy + Math.sin(a)*r);
        }
        ctx.closePath();
        ctx.fillStyle = '#ffcc00';
        ctx.fill();
        
        // White Core
        ctx.beginPath();
        ctx.arc(cx, cy, 8, 0, Math.PI*2);
        ctx.fillStyle = '#ffffff';
        ctx.fill();
        
        return new THREE.CanvasTexture(c);
    })();

    const _sparkMaterial = new THREE.SpriteMaterial({ 
        map: _sparkTexture, 
        transparent: true, 
        blending: THREE.AdditiveBlending,
        depthWrite: false
    });

    class GameManager {

        
constructor(scene, uiLayerId, camera, renderer) {
window.flux.gameInstance = this;
            this.renderer = renderer; // Store renderer
            this.scene = scene;
            this.camera = camera;
            this.uiLayer = document.getElementById(uiLayerId);
            
            this.score = { home: 0, away: 0 };
            this.time = 0;
            this.half = 1;
            this.halfDuration = 300; // 5 minutes (seconds)
            this.isOvertime = false;
            this.isDemoMode = false;
this.gameMode = 'normal'; // 'normal' or 'practice'
            this.isForgeMode = false; // Asset Forge State
            // Impact Frames
            this.impactPause = 0;
            
            this.state = 'menu'; // Start in menu
this.teams = {
                home: null,
                away: null
            };
            
            this.entities = {
                ball: null
            };

this.ui = {
                scorePlayer: null,
                scoreCpu: null,
                timer: null,
                half: null,
                announcement: null,
                // Player Status Panel
                statusPanel: {
                    container: null,
                    name: null,
                    hpBar: null,
                    hpText: null,
                    expBar: null
                }
            };

            // Techcopy State
            this.techCopyState = {
                active: false,
                timer: 0,
                tech: null,
                learners: []
            };

this.miniMap = new window.flux.MiniMap();
            
            // Initialize Floating Text
// Initialize Floating Text
this.floatingText = new window.flux.FloatingTextManager(scene, uiLayerId, camera);
            
            // Reusable vector for UI calculations
            this._tempVec = new THREE.Vector3();

            // Initialize Particle Manager (Status Effects)
            
// Initialize Particle Manager (Status Effects)
            this.particleManager = new window.flux.ParticleManager(scene);
this.glyphManager = null; // Injected by main.js
            this._initParticles(); // 3D Spark System (Legacy/Impact)

this.debugVisualizer = new window.flux.DebugVisualizer(scene);
            this.practiceManager = new window.flux.PracticeManager(this); // Initialize Practice Manager
            this._injectStyles();
this._initUI();
        }

_initCinematics() {
            this.menuShotIndex = 0;
            this.menuShotTimer = 0;
            this.menuShots = [
                // 1. "The Arena" - Wide Establishing Shot (Slow dolly in)
                {
                    duration: 10.0,
                    update: (t, cam) => {
                        const p1 = new THREE.Vector3(60, 35, 60);
                        const p2 = new THREE.Vector3(40, 25, 40);
                        // Smoothstep interpolation
                        const st = t * t * (3 - 2 * t); 
                        cam.position.lerpVectors(p1, p2, st);
                        cam.lookAt(0, 0, 0);
                    }
                },
                // 2. "The Team" - Tracking Shot along the formation
                {
                    duration: 8.0,
                    update: (t, cam) => {
                        // Move along the side of the home team formation
                        const zStart = -25;
                        const zEnd = 25;
                        const currentZ = zStart + (zEnd - zStart) * t;
                        
                        cam.position.set(-25, 6, currentZ);
                        cam.lookAt(0, 2, currentZ * 0.8); // Look slightly ahead of center
                    }
                },
                // 3. "The Striker" - Close up orbit on a key position
                {
                    duration: 8.0,
                    update: (t, cam) => {
                        // Focus on where the LF/RF usually stands (approx +/- 10, -10)
                        const target = new THREE.Vector3(-10, 0, -10);
                        const angle = t * 1.0 + 3.5;
                        const dist = 10.0;
                        
                        cam.position.set(
                            target.x + Math.cos(angle) * dist,
                            target.y + 4.0,
                            target.z + Math.sin(angle) * dist
                        );
                        cam.lookAt(target.x, target.y + 1.5, target.z);
                    }
                },
                // 4. "The Goal" - Low Angle looking up at the net
                {
                    duration: 7.0,
                    update: (t, cam) => {
                        const p1 = new THREE.Vector3(0, -5, 32); // Low near goal
                        const p2 = new THREE.Vector3(0, 8, 20);  // Rising up
                        cam.position.lerpVectors(p1, p2, t);
                        cam.lookAt(0, 15, 45); // Look up at the structure
                        cam.rotation.z = (t - 0.5) * 0.15; // Slight cinematic tilt
                    }
                },
                // 5. "The Dive" - Vertical drop into the pool
                {
                    duration: 8.0,
                    update: (t, cam) => {
                        const p1 = new THREE.Vector3(0, 50, 0);
                        const p2 = new THREE.Vector3(0, 10, 0);
                        const st = t * t * (3 - 2 * t);
                        cam.position.lerpVectors(p1, p2, st);
                        cam.lookAt(0, 0, 0);
                        cam.rotation.z = t * 0.8; // Spiral down
                    }
                }
];
        }

        _injectStyles() {
            if (document.getElementById('flux-dynamic-styles')) return;
            const style = document.createElement('style');
            style.id = 'flux-dynamic-styles';
style.textContent = `
                @keyframes textSlam {
                    0% { transform: translate(-50%, -50%) scale(4); opacity: 0; letter-spacing: 50px; }
                    10% { transform: translate(-50%, -50%) scale(1); opacity: 1; letter-spacing: 5px; }
                    15% { transform: translate(-50%, -50%) scale(1.1); }
                    20% { transform: translate(-50%, -50%) scale(1); }
                    80% { transform: translate(-50%, -50%) scale(1); opacity: 1; filter: blur(0px); }
                    100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; filter: blur(10px); }
                }
                
                .announcement-slam {
                    position: absolute;
                    top: 45%; left: 50%;
                    transform: translate(-50%, -50%);
                    width: 100%;
                    text-align: center;
                    font-family: 'Impact', sans-serif;
                    font-size: 96px;
                    font-style: italic;
                    text-transform: uppercase;
                    background: linear-gradient(to bottom, #ffffff 0%, #ffdd00 45%, #ff8800 100%);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    filter: drop-shadow(0 0 10px rgba(0,0,0,1)) drop-shadow(0 0 30px rgba(255, 100, 0, 0.6));
                    z-index: 2000;
                    animation: textSlam 1.8s cubic-bezier(0.1, 0.8, 0.1, 1) forwards;
                    pointer-events: none;
                    white-space: nowrap;
                }

                .modal-overlay {
                    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                    background: radial-gradient(circle at center, rgba(10, 25, 60, 0.95) 0%, rgba(0, 0, 0, 0.98) 100%);
                    display: flex; justify-content: center; align-items: center; flex-direction: column;
                    z-index: 1900;
                    opacity: 0; pointer-events: none; transition: opacity 0.8s;
                    backdrop-filter: blur(8px);
                }
                .modal-overlay.active { opacity: 1; pointer-events: auto; }
                
                .modal-title {
                    font-family: 'Garamond', serif;
                    font-size: 52px; color: #fff;
                    text-transform: uppercase;
                    text-shadow: 0 0 20px #00aaff, 0 0 40px #0044aa;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #00aaff;
                    padding-bottom: 10px;
                    width: 80%; text-align: center;
                    letter-spacing: 5px;
                }
                
                .modal-score-container {
                    display: flex; align-items: center; gap: 40px;
                    margin-bottom: 40px;
                }
                .modal-score {
                    font-family: 'Impact', sans-serif;
                    font-size: 80px; color: #ffd700;
                    letter-spacing: 5px;
                    text-shadow: 0 0 20px #b8860b;
                }
                .modal-vs {
                    font-family: 'Courier New', monospace;
                    font-size: 24px; color: #00aaff; opacity: 0.7;
                }

                .flash-overlay {
                    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                    background: white;
                    z-index: 2100;
                    opacity: 0; pointer-events: none;
                    transition: opacity 0.1s ease-out;
                    mix-blend-mode: overlay;
                }

                @keyframes clashPop {
                    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
                    50% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.8; }
                    100% { transform: translate(-50%, -50%) scale(2.0); opacity: 0; }
                }

                .clash-spark {
                    position: absolute;
                    width: 60px; height: 60px;
                    background: radial-gradient(circle, #ffffff 0%, #ffff00 40%, transparent 70%);
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 1500;
                    mix-blend-mode: screen;
                    animation: clashPop 0.3s ease-out forwards;
                    box-shadow: 0 0 20px #ffaa00;
                }
            `;
            document.head.appendChild(style);
        }

        registerTeams(homeTeam, awayTeam, ball) {
            this.teams.home = homeTeam;
            this.teams.away = awayTeam;
this.entities.ball = ball;
            
            // Initialize MiniMap
            if (this.miniMap) {
                this.miniMap.init(homeTeam, awayTeam, ball);
            }
        }

_initUI() {
            // Bind to existing HTML elements
            this.ui.scorePlayer = document.getElementById('score-player');
            this.ui.scoreCpu = document.getElementById('score-cpu');
            this.ui.timer = document.getElementById('timer-display');
            this.ui.half = document.getElementById('half-indicator');
            this.ui.announcement = document.getElementById('announcement');
            
            this.ui.techFlash = document.getElementById('tech-flash-overlay');
            if (this.ui.techFlash) {
                this.ui.techSub = this.ui.techFlash.querySelector('.tech-sub-text');
            }
            this.ui.techTimerFill = document.querySelector('.tech-timer-fill');
this.ui.techTimerFill = document.querySelector('.tech-timer-fill');

            // Bind Player Status Panel
            // Bind Player Status Panel
            this.ui.statusPanel.container = document.getElementById('player-status-panel');
            this.ui.statusPanel.name = document.querySelector('#player-status-panel .char-name');
            this.ui.statusPanel.hpBar = document.querySelector('#player-status-panel .hp-bar-fill');
            this.ui.statusPanel.hpText = document.querySelector('#player-status-panel .hp-value');
            this.ui.statusPanel.expBar = document.querySelector('#player-status-panel .tech-bar-fill');
            
            // Create Modal Overlay
            this.ui.modal = document.createElement('div');
            this.ui.modal.className = 'modal-overlay';
            this.ui.modal.innerHTML = `
                <div class="modal-title">HALF TIME</div>
                <div class="modal-score-container">
                    <div class="modal-score" id="modal-score-home">0</div>
                    <div class="modal-vs">-</div>
                    <div class="modal-score" id="modal-score-away">0</div>
                </div>
                <div id="modal-msg" style="color: #00aaff; font-size: 14px; letter-spacing: 2px;">PREPARING 2ND HALF...</div>
            `;
            this.uiLayer.appendChild(this.ui.modal);

            // Create Flash Overlay
            this.ui.flash = document.createElement('div');
            this.ui.flash.className = 'flash-overlay';
            this.uiLayer.appendChild(this.ui.flash);

            // Initial State
            this._updateScoreUI();
            if (this.ui.timer) this.ui.timer.innerText = "00:00";
        }
        _updateScoreUI() {
            if (this.ui.scorePlayer) this.ui.scorePlayer.innerText = this.score.home;
            if (this.ui.scoreCpu) this.ui.scoreCpu.innerText = this.score.away;
        }

updatePractice(dt) {
            // Delegate logic to PracticeManager
            if (this.practiceManager) {
                this.practiceManager.update(dt);
            }
        }

        update(dt) {

if (this.state === 'menu') {
                // --- POPULATE ARENA FOR B-ROLL ---
                // Ensure players are visible and animated
                const animateTeam = (team) => {
                    if (!team) return;
                    team.players.forEach(p => {
                        if (p.mesh) {
                            p.mesh.visible = true;
                            // Gentle bobbing to simulate treading water
                            p.mesh.position.y = p.homePosition.y + Math.sin(Date.now() * 0.002 + p.mesh.id) * 0.5;
                            // Ensure idle animation is playing
                            if (p.state !== 'idle') p.play('idle', 0.5);
                            if (p.mixer) p.mixer.update(dt);
                        }
                    });
                };
                animateTeam(this.teams.home);
                animateTeam(this.teams.away);

                // --- CINEMATIC B-ROLL ---
                if (this.menuShots && this.menuShots.length > 0) {
                    const shot = this.menuShots[this.menuShotIndex];
                    this.menuShotTimer += dt;
                    
                    if (this.menuShotTimer >= shot.duration) {
                        this.menuShotTimer = 0;
                        this.menuShotIndex = (this.menuShotIndex + 1) % this.menuShots.length;
                    }
                    
                    // Normalize time (0 to 1)
                    const t = this.menuShotTimer / shot.duration;
                    if (this.camera) {
                        shot.update(t, this.camera);
                    }
                }

                // Ambient FX in Menu
                if (this.particleManager && Math.random() < 0.2) {
                    // Spawn random bubbles for atmosphere
                    const range = 60;
                    const pos = new THREE.Vector3(
                        (Math.random()-0.5)*range, 
                        -10 + Math.random()*20, 
                        (Math.random()-0.5)*range
                    );
                    this.particleManager.spawn('bubble', pos, { life: 3.0 + Math.random()*2.0, scale: 0.3 + Math.random()*0.4 });
                }

                // Update Background Systems
                if (this.waterOverlay) this.waterOverlay.update(dt);
                if (this.lightShafts) this.lightShafts.update(dt);
                if (this.stadium) this.stadium.update(dt);
                if (this.particleManager) this.particleManager.update(dt);

                // Render
                if (this.renderer && this.scene && this.camera) {
                    this.renderer.render(this.scene, this.camera);
                }
                return;
            }

            if (this.state === 'active') {
                if (this.gameMode === 'practice') {
                    this.updatePractice(dt);
                } else {
                    this.time += dt;
                    this._updateTimer();
                    this._checkHalfTime();
                }

                this._checkGoals();
                
                if (this.miniMap) this.miniMap.update();
                if (this.floatingText) this.floatingText.update(dt);
if (this.particleManager) this.particleManager.update(dt);
                // GlyphManager updated by main.js
                
                // Update Techcopy Window
                if (this.techCopyState.active) {
                    this.techCopyState.timer -= dt;
                    
                    // Update UI Bar
                    if (this.ui.techTimerFill) {
                        const pct = Math.max(0, (this.techCopyState.timer / this.techCopyState.maxTime) * 100);
                        this.ui.techTimerFill.style.width = `${pct}%`;
                        
                        // Color shift based on urgency
                        if (pct < 30) this.ui.techTimerFill.style.background = '#ff0000';
                        else this.ui.techTimerFill.style.background = 'linear-gradient(90deg, #ffffff, #00ffff)';
                    }

                    if (this.techCopyState.timer <= 0) {
                        this.endTechCopyWindow(false);
                    }
                }
                
                this._updateParticles(dt);
this._updateParticles(dt);
                if (this.debugVisualizer) this.debugVisualizer.update();
            }
        }
            
        _updateOffscreenIndicator() {
            const p = this.teams.home ? this.teams.home.activePlayer : null;
            const indicator = this.ui.offscreenIndicator;
            
            if (!p || !p.mesh || !this.camera || !indicator) return;

            // 1. Get Player Position (Center Mass)
            const pos = p.mesh.position.clone();
            pos.y += 1.0; 
            
            // 2. Project to Normalized Device Coordinates (NDC) [-1, 1]
            this._tempVec.copy(pos).project(this.camera);
            
            // 3. Check if Behind Camera
            const camFwd = new THREE.Vector3();
            this.camera.getWorldDirection(camFwd);
            const toPlayer = pos.clone().sub(this.camera.position).normalize();
            const dot = camFwd.dot(toPlayer);
            const isBehind = dot < 0.2; // Buffer to prevent flipping at edge

            // 4. Check Bounds
            const isOffScreen = (
                this._tempVec.x < -0.9 || this._tempVec.x > 0.9 ||
                this._tempVec.y < -0.9 || this._tempVec.y > 0.9 ||
                isBehind
            );

            if (isOffScreen) {
                indicator.style.display = 'block';
                
                let x = this._tempVec.x;
                let y = this._tempVec.y;

                // If behind, invert coordinates to point correctly
                if (isBehind) {
                    x = -x;
                    y = -y;
                    // Fix singularity if exactly behind center
                    if (Math.abs(x) < 0.01 && Math.abs(y) < 0.01) y = -1; 
                }

                // Clamp to screen edges
                // We want to find the intersection of the vector (x,y) with the box [-0.9, 0.9]
                const padding = 0.9;
                
                // Normalize to get direction
                const mag = Math.sqrt(x*x + y*y);
                const nx = x / mag;
                const ny = y / mag;
                
                // Raycast to box edges
                // Vertical edges: x = +/- padding
                // Horizontal edges: y = +/- padding
                
                // Avoid divide by zero
                const tx = (Math.abs(nx) > 0.001) ? (nx > 0 ? padding : -padding) / nx : 999;
                const ty = (Math.abs(ny) > 0.001) ? (ny > 0 ? padding : -padding) / ny : 999;
                
                // Use the nearest intersection (smallest positive t)
                // Since we are projecting from center (0,0) to (nx,ny), t must be positive.
                const t = Math.min(Math.abs(tx), Math.abs(ty));
                
                const screenX = nx * t;
                const screenY = ny * t;

                // Convert NDC to Pixels
                const width = window.innerWidth;
                const height = window.innerHeight;
                
                const px = (screenX * 0.5 + 0.5) * width;
                const py = (-(screenY) * 0.5 + 0.5) * height;

                // Calculate Rotation
                // Arrow points UP by default.
                // We want it to point in direction (nx, ny) on screen.
                // Screen Y is down (inverted from WebGL Y).
                // So (0, 1) in NDC is UP. (0, -1) in NDC is DOWN.
                // atan2(y, x) gives angle from +X.
                // We want angle from +Y (Up).
                // Rotation = PI/2 - angle.
                
                const angle = Math.atan2(ny, nx);
                const rot = (Math.PI / 2) - angle;

                indicator.style.transform = `translate(${px}px, ${py}px) rotate(${rot}rad)`;
                
            } else {

                indicator.style.display = 'none';
            }
        }

        _updateTimer() {
            if (!this.ui.timer) return;
            // Clamp to half duration for display if we go slightly over before tick
            const t = Math.min(this.time, this.halfDuration);
            const minutes = Math.floor(t / 60);
            const seconds = Math.floor(t % 60);
            this.ui.timer.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        _checkHalfTime() {
            if (this.time >= this.halfDuration) {
                this.endHalf();
            }
        }

endHalf() {
            this.state = 'halftime';
            
            if (this.half === 1) {
                this._showModal("HALF TIME", "PREPARING 2ND HALF...");
                setTimeout(() => {
                    this._hideModal();
                    this.startSecondHalf();
                }, 4000);
            } else {
                // End of 2nd Half or Overtime Period
                if (this.score.home === this.score.away) {
                    // TIED - Go to Overtime (Golden Goal)
                    this._showModal("OVERTIME", "GOLDEN GOAL RULE ACTIVE");
                    setTimeout(() => {
                        this._hideModal();
                        this.startOvertime();
                    }, 4000);
                } else {
                    // Winner decided
                    this.endGame();
                }
            }
        }

        startSecondHalf() {
            this.half = 2;
            this.time = 0;
            this.ui.half.innerText = "2nd HALF";
            this.resetRound(null); // Neutral Blitz-off for 2nd half start
        }

        startOvertime() {
            this.half++;
            this.time = 0;
            this.isOvertime = true;
            this.ui.half.innerText = "OVERTIME";
            this.resetRound(null); // Neutral Blitz-off
        }

        endGame() {
            this.state = 'gameover';
            let msg = "DRAW";
            if (this.score.home > this.score.away) msg = "VICTORY";
            if (this.score.away > this.score.home) msg = "DEFEAT";
            
this._showModal(msg, "PRESS REFRESH TO PLAY AGAIN");
            // Stop Music on Game Over
            if (this.audioManager) {
                this.audioManager.stopBGM();
            }
            // No reset, just stop.
        }

        _showModal(title, subtext) {
            if (!this.ui.modal) return;
            
            this.ui.modal.querySelector('.modal-title').innerText = title;
            this.ui.modal.querySelector('#modal-score-home').innerText = this.score.home;
            this.ui.modal.querySelector('#modal-score-away').innerText = this.score.away;
            this.ui.modal.querySelector('#modal-msg').innerText = subtext;
            
            this.ui.modal.classList.add('active');
            
            // Hide HUD elements
            document.getElementById('hud-top').style.opacity = '0';
            document.getElementById('player-status-panel').style.opacity = '0';
        }

        _hideModal() {
            if (!this.ui.modal) return;
            this.ui.modal.classList.remove('active');
            
            // Show HUD elements
            document.getElementById('hud-top').style.opacity = '1';
            document.getElementById('player-status-panel').style.opacity = '1';
        }

_checkGoals() {
            const ball = this.entities.ball;
            if (!ball || !ball.mesh) return;

            const pos = ball.mesh.position;

            // Precise Goal Detection
            // Visual Goal is at Z = +/- 28.
            // We define a "Goal Mouth" box matching Goalie.js (Width 14, Height 8).
// We define a "Goal Mouth" box matching the visual net.
            // Arena Radius is 32. Goal is roughly 22m wide, 18m high.
// Arena Radius is 32. Goal is roughly 22m wide, 18m high.
            const halfWidth = 11.0; // Increased to 11 (Width 22) to catch corners
            const halfHeight = 9.0; // Increased to 9 (Height 18) to catch high shots
            const goalYOffset = -4.5; // Moved down to match visual model (-4.5m)

            const triggerZ = 45.0; // Trigger earlier (was 30) to ensure registration before bounce

            if (Math.abs(pos.z) > triggerZ) {
                // PREVENT OWN GOAL BY CARRIER (User Request)
                // If the ball is held by the team defending this goal, do not count it.
                if (ball.holder) {
                    // Home (Side 1) defends +Z. If pos.z > 0 (Home Goal) and holder is Home, ignore.
                    if (pos.z > 0 && ball.holder.team.side === 1) return;
                    // Away (Side -1) defends -Z. If pos.z < 0 (Away Goal) and holder is Away, ignore.
                    if (pos.z < 0 && ball.holder.team.side === -1) return;
                }

                // 2. Check Frame (Must be within width/height)
// 2. Check Frame (Must be within width/height, accounting for Y offset)
                if (Math.abs(pos.x) <= halfWidth && Math.abs(pos.y - goalYOffset) <= halfHeight) {
                    if (pos.z < 0) {
                        this.goalScored('home'); // Home attacks -Z
                    } else {
                        this.goalScored('away'); // Away attacks +Z
                    }
                }
            }
        }

goalScored(scorer) {
            if (this.state !== 'active') return;
            
            // IMPACT FRAME: GOAL
this.triggerImpact(0.4, 'shatter'); // Massive freeze for goal
            if (this.state !== 'active') return;
            
            // EXP REWARD: Goal
            // Find who scored (Last holder of ball)
            const ball = this.entities.ball;
            if (ball && ball.lastHolder && ball.lastHolder.team.id === scorer) {
                ball.lastHolder.gainExp(10);
                // Optional: Assist logic could go here (track lastHolder.lastPasser?)
            }

            this.state = 'goal';
            this.score[scorer]++;
            this._updateScoreUI();
            
// 1. VISCERAL SHAKE & PARTICLES
            if (this.cameraManager) {
                this.cameraManager.addShake(2.0); // Heavy shake
            }
            if (this.particleManager && this.entities.ball && this.entities.ball.mesh) {
                const goalPos = this.entities.ball.mesh.position.clone();
                // Massive Goal Explosion
                this.particleManager.spawn('shockwave', goalPos, { scale: 15.0, life: 0.8 });
                this.particleManager.spawn('flash', goalPos, { scale: 10.0 });
                for(let i=0; i<30; i++) {
                    this.particleManager.spawn('debris', goalPos, { scale: 0.8 });
                }
            }
            // 2. SCREEN FLASH
            if (this.ui.flash) {
                this.ui.flash.style.opacity = '0.8';
                setTimeout(() => { this.ui.flash.style.opacity = '0'; }, 100);
            }

            // 3. GOLDEN GOAL CHECK
            if (this.isOvertime) {
                this.showAnnouncement("GOLDEN GOAL!", 'slam');
                // End game after short delay
                setTimeout(() => {
                    this.endGame();
                }, 3000);
                return;
            }

            // 4. SLAM ANNOUNCEMENT (Normal)
            this.showAnnouncement("GOAL!", 'slam');
            
            // Reset sequence
            // Scored-upon team gets ball
            const loser = scorer === 'home' ? 'away' : 'home';
            
            // FASTER FLOW: Reduced delay from 3000ms to 1200ms
            setTimeout(() => {
                this.resetRound(loser);
            }, 2000); // Slightly longer to appreciate the "GOAL" slam
        }

showAnnouncement(text, type = 'normal', duration = 2000) {
            const el = this.ui.announcement;
            if (!el) return;

            // Clear previous timeout
            if (this._announceTimeout) {
                clearTimeout(this._announceTimeout);
                this._announceTimeout = null;
            }

            // Reset Animation by cloning
            const newEl = el.cloneNode(true);
            el.parentNode.replaceChild(newEl, el);
            this.ui.announcement = newEl;

            newEl.innerText = text;
            newEl.style.display = 'block';
            
            // Apply Class based on type
            newEl.className = ''; // Reset classes
            if (type === 'slam') {
                newEl.classList.add('announcement-slam');
            } else {
                // Default style
                newEl.style.animation = 'none';
                newEl.offsetHeight; /* trigger reflow */
                newEl.style.animation = 'announceSlide 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            }

            // Auto-hide
            if (duration > 0) {
                this._announceTimeout = setTimeout(() => {
                    this.hideAnnouncement();
                }, duration);
            }
        }

        hideAnnouncement() {
            if (this.ui.announcement) {
                this.ui.announcement.style.display = 'none';
            }
        }

resetRound(possessionTeamId) {
            this.state = 'reset';
            
            // Reset Ball
            if (this.entities.ball) this.entities.ball.reset();
            
            // Reset Teams
            if (this.teams.home) this.teams.home.resetPositions();
            if (this.teams.away) this.teams.away.resetPositions();
            
            // Clear ball holder
            if (this.entities.ball) this.entities.ball.drop();

            // CRITICAL: Snap camera to prevent disorientation
            if (this.cameraManager) {
                // Force update target first (usually ball)
                if (this.entities.ball && this.entities.ball.mesh) {
                    this.cameraManager.setTarget(this.entities.ball.mesh, this.entities.ball.velocity);
                    this.cameraManager.snapToTarget();
                }
            }

            // FASTER FLOW: Reduced delay from 2000ms to 100ms
            setTimeout(() => {
                this.startKickoff(possessionTeamId);
}, 100);
        }

        startKickoff(possessionTeamId) {
            this.state = 'kickoff';
            this.showAnnouncement("BLITZ OFF!", 'slam');
            
            // If a team has possession (after goal), give to MF
            if (possessionTeamId) {
                const team = this.teams[possessionTeamId];
                if (team) {
                    const mf = team.players.find(p => p.role === 'MF');
                    if (mf && this.entities.ball) {
                        this.entities.ball.grab(mf);
                        
                        // CRITICAL: Snap camera to new holder to prevent swing/disorientation
                        if (this.cameraManager) {
                            this.cameraManager.setTarget(mf.mesh, mf.velocity);
                            this.cameraManager.snapToTarget();
                        }
                    }
                }
            } else {
                // Neutral kickoff - ensure camera is snapped to center ball
                if (this.cameraManager && this.entities.ball && this.entities.ball.mesh) {
                    this.cameraManager.setTarget(this.entities.ball.mesh, this.entities.ball.velocity);
                    this.cameraManager.snapToTarget();
                }
            }
            
            // FASTER FLOW: Reduced delay from 1000ms to 800ms
            setTimeout(() => {
                this.hideAnnouncement();
                this.state = 'active';
            }, 800);
        }
        
// Initial start
        startMatch(mode = 'normal') {
            this.gameMode = mode;
            console.log("Starting Match in mode:", mode);
            
            // Start Music
            if (this.audioManager) {
                this.audioManager.playBGM();
            }
            
            // Reset Score
this.score.home = 0;
            this.score.away = 0;
            this._updateScoreUI();
            
            // Reset Time
            this.time = 0;
            this.half = 1;
            if (this.ui.half) this.ui.half.innerText = "1st";
            
if (mode === 'practice') {
                if (this.ui.half) this.ui.half.innerText = "PRAC";
                
                // Start Practice Manager
                if (this.practiceManager) {
                    this.practiceManager.start();
                }

                // In practice, ensure AI is enabled for sparring
                if (this.teams.away) {
                    this.teams.away.aiEnabled = true;
                }
            } else {

                // Ensure Practice Manager is stopped if normal game
                if (this.practiceManager) this.practiceManager.stop();
                
                // Safety: Ensure all players are visible (in case Practice hid them)
                // And FORCE AI ENABLED (Fix for "Zombies" if coming from Practice Mode)
                if (this.teams.away) {
                    this.teams.away.players.forEach(p => { if(p.mesh) p.mesh.visible = true; });
                    this.teams.away.aiEnabled = true; 
                }
                if (this.teams.home) {
                    this.teams.home.players.forEach(p => { if(p.mesh) p.mesh.visible = true; });
                }

this.resetRound();
            }
}

setMenuMode(isActive) {
            this.state = isActive ? 'menu' : 'active';
            
            if (isActive && this.audioManager) {
                this.audioManager.stopBGM();
            }
            
            // Hide HUD in menu
            const hudTop = document.getElementById('hud-top');
            const statusPanel = document.getElementById('player-status-panel');
            const controls = document.getElementById('action-container');
            const joystick = document.getElementById('joystick-hit-zone');
            
            const display = isActive ? 'none' : 'flex'; // or block/etc
            
            if (hudTop) hudTop.style.display = display;
            if (statusPanel) statusPanel.style.display = isActive ? 'none' : 'block'; // Status panel has specific logic
            if (controls) controls.style.display = isActive ? 'none' : 'flex';
            if (joystick) joystick.style.display = isActive ? 'none' : 'block';
            
            // If entering menu, reset camera to a nice angle?
            // Handled by update loop
        }
toggleDemoMode() {
            this.isDemoMode = !this.isDemoMode;
            console.log("Demo Mode:", this.isDemoMode);
            
            // Update UI Button
            const btn = document.getElementById('auto-toggle');
            if (btn) {
                btn.innerText = this.isDemoMode ? "AUTO PILOT" : "MANUAL";
                if (this.isDemoMode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
            
            // Announcement
            const text = this.isDemoMode ? "AUTO PILOT" : "MANUAL";
            this.showAnnouncement(text);
            
            // Visual Flair: Spawn text above active player
            if (this.isDemoMode && this.floatingText && this.teams.home && this.teams.home.activePlayer && this.teams.home.activePlayer.mesh) {
                this.floatingText.spawn("AI ENGAGED", this.teams.home.activePlayer.mesh.position, "goal");
            }

            // Auto-hide announcement
setTimeout(() => {
                if (this.ui.announcement && this.ui.announcement.innerText === text) {
                    this.hideAnnouncement();
                }
            }, 1500);
        }

        // --- TECHCOPY SYSTEM ---

        triggerTechEvent(sourcePlayer, techName) {
            if (!sourcePlayer || !sourcePlayer.team) return;

            // Find opposing team
            const oppTeamId = sourcePlayer.team.id === 'home' ? 'away' : 'home';
            const oppTeam = this.teams[oppTeamId];
            if (!oppTeam) return;

            // Find who is marking this source
            const learners = oppTeam.players.filter(p => p.marking === sourcePlayer);
            
            if (learners.length === 0) return;

            // Only show UI if the learning team is Human (Home)
            // (Or if we are in Demo mode and want to see it happen for Home team)
            if (oppTeam.isHuman) {
                // Filter out those who already know it
                const validLearners = learners.filter(p => !p.learnedTechs.includes(techName));
                if (validLearners.length > 0) {
                    this.startTechCopyWindow(techName, validLearners);
                }
            }
        }

startTechCopyWindow(techName, learners) {
            this.techCopyState.active = true;
            this.techCopyState.maxTime = 0.6; // 0.6s window
            this.techCopyState.timer = this.techCopyState.maxTime;
            this.techCopyState.tech = techName;
            this.techCopyState.learners = learners;
            
            // Show UI
            if (this.ui.techFlash) {
                this.ui.techFlash.style.display = 'flex';
                this.ui.techFlash.style.background = ""; // Reset background
                this.ui.techFlash.querySelector('.tech-text').innerText = "TECHCOPY!";
                
                if (this.ui.techSub) {
                    this.ui.techSub.innerText = techName.replace('_', ' ');
                }
                
                // Reset bar
                if (this.ui.techTimerFill) {
                    this.ui.techTimerFill.style.width = '100%';
                }
            }
        }

attemptTechCopy() {
            if (!this.techCopyState.active) return false;
            
            // Success!
            const tech = this.techCopyState.tech;
            const learners = this.techCopyState.learners;
            
            learners.forEach(p => {
                // Double check to prevent duplicates
                if (!p.learnedTechs.includes(tech)) {
                    p.learnedTechs.push(tech);
                    console.log(`${p.role} learned ${tech}!`);
                    
                    // 1. Floating Text
                    if (this.floatingText && p.mesh) {
                        this.floatingText.spawn(`LEARNED!`, p.mesh.position, "tech");
                    }
                    
                    // 2. Particle Effect (Spiral)
                    if (this.particleManager && p.mesh) {
                        // Spawn multiple particles for a swirl effect
                        for(let i=0; i<10; i++) {
                            setTimeout(() => {
                                this.particleManager.spawn('learned', p.mesh.position);
                            }, i * 50);
                        }
                    }
                }
            });
            
            this.endTechCopyWindow(true);
            return true;
        }

endTechCopyWindow(success) {
            this.techCopyState.active = false;
            if (this.ui.techFlash) {
                if (success) {
                    this.ui.techFlash.querySelector('.tech-text').innerText = "SUCCESS!";
                    // Flash success color (White flash)
                    this.ui.techFlash.style.background = "rgba(255, 255, 255, 0.8)";
                    
                    // Hide after short delay to show the success flash
                    setTimeout(() => { 
                        this.ui.techFlash.style.display = 'none'; 
                    }, 300);
                } else {
                    // Failed / Missed
                    this.ui.techFlash.style.display = 'none';
                }
            }
        }
_updatePlayerStatusUI() {
            if (!this.teams.home || !this.teams.home.activePlayer) return;
            
            const p = this.teams.home.activePlayer;
            const ui = this.ui.statusPanel;
            
// UI Updates (Action Button Context)
                ui.container.style.display = 'block';
                
                // Name & Level
                if (ui.name) ui.name.innerText = `${p.characterName || p.role} LV${p.level}`;
                
                // HP
                if (ui.hpBar) {
                    const hpPct = Math.max(0, Math.min(100, (p.stats.HP / p.stats.maxHP) * 100));
                    ui.hpBar.style.width = `${hpPct}%`;
                    // Color shift
                    if (hpPct < 25) ui.hpBar.style.background = 'linear-gradient(90deg, #ff0000, #ff4444)';
                    else if (hpPct < 50) ui.hpBar.style.background = 'linear-gradient(90deg, #ffff00, #ffff88)';
                    else ui.hpBar.style.background = 'linear-gradient(90deg, #00ff00, #ccffcc)';
                }
                if (ui.hpText) ui.hpText.innerText = `${Math.floor(p.stats.HP)}/${p.stats.maxHP}`;
                
                // EXP
                if (ui.expBar) {
                    const expPct = Math.max(0, Math.min(100, (p.exp / p.nextLevelExp) * 100));
                    ui.expBar.style.width = `${expPct}%`;
ui.expBar.style.width = `${expPct}%`;
                }
        }

_initParticles() {
            this.activeSparks = [];
            this.sparkPool = [];
            const poolSize = 40; // Sufficient for continuous grinding
            
            for (let i = 0; i < poolSize; i++) {
                const sprite = new THREE.Sprite(_sparkMaterial.clone());
                sprite.visible = false;
                this.scene.add(sprite);
                this.sparkPool.push(sprite);
            }
        }

        spawnClash(pos, intensity = 1.0) {
            // Find free spark
            const spark = this.sparkPool.find(s => !s.visible);
            if (!spark) return; // Pool exhausted
            
            spark.position.copy(pos);
            spark.visible = true;
            
            // Randomize rotation
            spark.material.rotation = Math.random() * Math.PI;
            
            // Initialize Active State
            this.activeSparks.push({
                mesh: spark,
                age: 0,
                life: 0.15 + Math.random() * 0.15, // Fast, punchy sparks
                maxScale: 2.5 * intensity,
                velocity: new THREE.Vector3(
                    (Math.random()-0.5)*8, 
                    (Math.random()-0.5)*8, 
                    (Math.random()-0.5)*8
                )
            });
        }

        _updateParticles(dt) {
            for (let i = this.activeSparks.length - 1; i >= 0; i--) {
                const p = this.activeSparks[i];
                p.age += dt;
                
                if (p.age >= p.life) {
                    p.mesh.visible = false;
                    this.activeSparks.splice(i, 1);
                    continue;
                }
                
                const t = p.age / p.life;
                
                // Expand
                const currentScale = 0.5 + (p.maxScale - 0.5) * t;
                p.mesh.scale.setScalar(currentScale);
                
                // Fade out
                p.mesh.material.opacity = 1.0 - (t * t); // Quadratic fade
                
                // Move
                p.mesh.position.addScaledVector(p.velocity, dt);
                p.mesh.material.rotation += 10.0 * dt;
            }
        }

// Helper for impact frames

triggerImpact(duration, type = 'default') {
            this.impactPause = duration;
            
            const container = document.getElementById('game-container');
            if (!container) return;

            // Reset classes to ensure animation restarts
            container.classList.remove('impact-fx', 'impact-heavy', 'impact-shatter');
            
            // Force reflow
            void container.offsetWidth;

            let className = 'impact-fx';
            if (type === 'heavy') className = 'impact-heavy';
            if (type === 'shatter') className = 'impact-shatter';

            container.classList.add(className);

            // Auto-remove class after duration
            setTimeout(() => {
                container.classList.remove(className);
            }, duration * 1000 + 100);
        }
    }

    window.flux.GameManager = GameManager;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class FloatingTextManager {
        constructor(scene, containerId, camera) {
            this.scene = scene;
            this.camera = camera;
            this.container = document.getElementById(containerId);
            this.texts = [];
            
            // Reusable vector for projection
            this._tempV = new THREE.Vector3();
        }

spawn(text, worldPos, type = 'default', target = null) {
            if (!this.container || !this.camera) return;

            // Create Wrapper (Positioning)
            const wrapper = document.createElement('div');
            wrapper.className = 'floating-text-wrapper';

            // Create Inner (Animation/Styling)
            const inner = document.createElement('span');
            inner.innerText = text;
            
            // Smart Class Assignment
            let classes = ['floating-text-inner'];
            
            // Add base type
            classes.push(type);

            // Keyword Detection for Auto-Styling
            const upper = text.toString().toUpperCase();
            
if (upper.includes('POISON') || upper.includes('VENOM')) classes.push('venom');
            else if (upper.includes('SLEEP') || upper.includes('NAP') || upper.includes('ZZZ')) classes.push('sleep');
            else if (upper.includes('WITHER')) classes.push('wither');
            else if (type === 'tech' || upper.includes('SHOT') || upper.includes('JECHT') || upper.includes('TACKLE')) classes.push('tech');
            else if (type === 'comic-impact') classes.push('comic-impact');
            else if (type === 'comic-action') classes.push('comic-action');
            else if (!isNaN(parseInt(text)) && type !== 'score') classes.push('damage'); // Numeric is usually damage
            else if (type === 'save' || type === 'block') classes.push('save');

            inner.className = classes.join(' ');
            wrapper.appendChild(inner);
            this.container.appendChild(wrapper);

            // Physics Instance
            const instance = {
                el: wrapper, 
                worldPos: worldPos.clone(),
                offset: new THREE.Vector3(0, 0, 0),
                velocity: new THREE.Vector3(0, 0, 0),
                gravity: 0,
                drag: 0,
                elasticity: 0.6,
                floorY: -999, // Virtual floor relative to start
                
life: 1.0,  // Reduced from 1.5
                maxLife: 1.0,
                target: target
            };

            // Customize Physics based on Type
if (classes.includes('damage') || classes.includes('save') || classes.includes('block')) {
                // DEBRIS PHYSICS (Pop, Arc, Bounce)
                instance.target = null; // Detach from entity so it falls naturally
                instance.gravity = 40.0; // Heavy gravity for snappy feel
                instance.drag = 0.5;
                instance.floorY = -4.0; // Bounce off a virtual floor below impact
                
                // Explosive Burst
                const spread = 6.0;
                instance.velocity.set(
                    (Math.random() - 0.5) * spread,
                    15.0 + Math.random() * 5.0, // High initial pop
                    (Math.random() - 0.5) * spread
                );
                
                instance.life = 2.0;
                instance.maxLife = 2.0;

            } else if (classes.includes('comic-impact')) {
                // COMIC POP (Stay in place mostly, slight drift)
                instance.gravity = 0;
                instance.velocity.set((Math.random()-0.5)*2, 1.0, (Math.random()-0.5)*2);
instance.life = 0.5; // Reduced from 0.8
                instance.maxLife = 0.5;

            } else if (classes.includes('comic-action')) {
                // COMIC ZIP (Fast movement)
                instance.gravity = 0;
                instance.velocity.set(0, 2.0, 0);
instance.life = 0.4; // Reduced from 0.6
                instance.maxLife = 0.4;

            } else if (classes.includes('tech')) {
                // TECH FLOAT (Slow rise)
                instance.gravity = 0;
                instance.velocity.set(0, 2.0, 0); // Steady rise
                instance.life = 2.5;
                instance.maxLife = 2.5;
                instance.offset.y = 2.0; // Start higher

            } else if (classes.includes('sleep')) {
                // SLEEP DRIFT (Slow meandering)
                instance.gravity = -0.5; // Slight anti-gravity
                instance.velocity.set(0, 0.5, 0);
                instance.life = 3.0;
                instance.maxLife = 3.0;

            } else {
                // DEFAULT (Status, etc)
                instance.velocity.set(0, 3.0, 0);
                instance.gravity = 5.0; // Slight arc
            }
            
            // Randomize start pos slightly to prevent stacking
            if (!target) {
                instance.worldPos.x += (Math.random() - 0.5) * 0.5;
                instance.worldPos.z += (Math.random() - 0.5) * 0.5;
            }
instance.worldPos.y += 1.0;
            this.texts.push(instance);
            this.updatePosition(instance);
        }

// spawnVersus removed

        update(dt) {
            for (let i = this.texts.length - 1; i >= 0; i--) {
                const t = this.texts[i];
                t.life -= dt;
                
                // If attached to a target, update base position (only for non-debris)
                if (t.target && t.target.parent) { 
                    t.worldPos.copy(t.target.position);
                    t.worldPos.y += 1.0; 
                }

                // Physics Integration
                if (t.gravity !== 0 || t.velocity.lengthSq() > 0) {
                    // Gravity
                    t.velocity.y -= t.gravity * dt;
                    
                    // Drag (Air resistance)
                    if (t.drag > 0) {
                        t.velocity.multiplyScalar(Math.max(0, 1.0 - (t.drag * dt)));
                    }

                    // Move
                    t.offset.addScaledVector(t.velocity, dt);

                    // Bounce Logic
                    if (t.offset.y < t.floorY) {
                        t.offset.y = t.floorY;
                        // Bounce velocity
                        t.velocity.y *= -t.elasticity;
                        // Ground friction
                        t.velocity.x *= 0.7;
                        t.velocity.z *= 0.7;
                        
                        // Stop bouncing if energy is low
                        if (Math.abs(t.velocity.y) < 2.0) t.velocity.y = 0;
                    }
                }

                if (t.life <= 0) {
                    if (t.el.parentNode) t.el.parentNode.removeChild(t.el);
                    this.texts.splice(i, 1);
                } else {
                    this.updatePosition(t);
                    // Fade out in last 30%
                    if (t.life < t.maxLife * 0.3) {
                        t.el.style.opacity = t.life / (t.maxLife * 0.3);
                    }
                }
            }
        }

        updatePosition(t) {
            // Project world pos + offset to screen
            this._tempV.copy(t.worldPos).add(t.offset);
            
            // Standard Three.js projection
            this._tempV.project(this.camera);

            const x = (this._tempV.x * .5 + .5) * this.container.clientWidth;
            const y = (-(this._tempV.y * .5) + .5) * this.container.clientHeight;

            // Hide if behind camera
            if (this._tempV.z > 1) {
                t.el.style.display = 'none';
            } else {
                t.el.style.display = 'block';
                t.el.style.transform = `translate(${x}px, ${y}px)`;
            }
}
    }

    window.flux.FloatingTextManager = FloatingTextManager;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    // --- TEXTURE GENERATORS ---
    
    // 1. Venom Bubble (Green, shiny, sharp)
    const _venomTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(32, 32, 4, 32, 32, 30);
        g.addColorStop(0, 'rgba(150, 255, 100, 0.9)');
        g.addColorStop(0.8, 'rgba(0, 200, 0, 0.5)');
        g.addColorStop(1, 'rgba(0, 50, 0, 0)');
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(32, 32, 30, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
        ctx.beginPath(); ctx.arc(20, 20, 6, 0, Math.PI*2); ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 2. Sleep Zzz
    const _napTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.font = 'bold italic 48px sans-serif';
        ctx.fillStyle = '#ffffff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.shadowColor = '#0000ff';
        ctx.shadowBlur = 4;
        ctx.fillText('Z', 32, 32);
        return new THREE.CanvasTexture(c);
    })();

    // 3. Wither Smoke
// 3. Wither Smoke (Optimized to 32x32)
    const _witherTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
        g.addColorStop(0, 'rgba(80, 80, 80, 0.8)');
        g.addColorStop(0.5, 'rgba(40, 40, 40, 0.4)');
        g.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, 32, 32);
        return new THREE.CanvasTexture(c);
    })();

    // 4. Shockwave Ring (Optimized to 64x64)
    const _shockwaveTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        const cx = 32, cy = 32;
        const g = ctx.createRadialGradient(cx, cy, 20, cx, cy, 30);
        g.addColorStop(0, 'rgba(255, 255, 255, 0)');
        g.addColorStop(0.5, 'rgba(255, 255, 255, 1)');
        g.addColorStop(1, 'rgba(255, 255, 255, 0)');
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, 64, 64);
        return new THREE.CanvasTexture(c);
    })();

    // 5. Flash Star (Optimized to 32x32)
    const _flashTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        const cx = 16, cy = 16;
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        for(let i=0; i<4; i++) {
            const a = (i * Math.PI / 2);
            ctx.moveTo(cx, cy);
            ctx.lineTo(cx + Math.cos(a)*15, cy + Math.sin(a)*15);
            ctx.lineTo(cx + Math.cos(a + 0.2)*5, cy + Math.sin(a + 0.2)*5);
        }
        ctx.fill();
        const g = ctx.createRadialGradient(cx, cy, 0, cx, cy, 10);
        g.addColorStop(0, 'rgba(255, 255, 255, 1)');
        g.addColorStop(1, 'rgba(255, 255, 255, 0)');
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(cx, cy, 10, 0, Math.PI*2); ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 6. Debris Shard (New)
    const _debrisTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.moveTo(16, 0); ctx.lineTo(32, 16); ctx.lineTo(16, 32); ctx.lineTo(0, 16);
        ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 7. Bubble Texture (New: Aesthetic & Subtle)
    const _bubbleTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        
        // Clear
        ctx.clearRect(0, 0, 64, 64);

        // Main Bubble Body (Soft Gradient)
        const g = ctx.createRadialGradient(28, 28, 0, 32, 32, 30);

        g.addColorStop(0, 'rgba(255, 255, 255, 0.4)'); // Brighter core
        g.addColorStop(0.5, 'rgba(100, 220, 255, 0.6)'); // More opaque body
        g.addColorStop(0.9, 'rgba(50, 150, 255, 0.8)'); // Strong edge
        g.addColorStop(1, 'rgba(50, 150, 255, 0.0)'); // Soft edge
        
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(32, 32, 30, 0, Math.PI*2); ctx.fill();
        
        // Sharp Specular Highlight (Reflection)
        const g2 = ctx.createRadialGradient(20, 20, 0, 20, 20, 12);
        g2.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
        g2.addColorStop(1, 'rgba(255, 255, 255, 0.0)');
        
        ctx.fillStyle = g2;
        ctx.beginPath(); 
        ctx.ellipse(22, 22, 10, 6, -Math.PI / 4, 0, Math.PI * 2); 
        ctx.fill();
        
        // Bottom Rim Light
// Bottom Rim Light
        ctx.strokeStyle = 'rgba(200, 255, 255, 0.8)'; // Brighter rim
        ctx.lineWidth = 3;
        ctx.beginPath(); ctx.arc(32, 32, 28, 0.2 * Math.PI, 0.8 * Math.PI); ctx.stroke();
        
        return new THREE.CanvasTexture(c);
    })();

    // 8. Micro Bubble (New: Sharp, high-vis cavitation)
    const _microBubbleTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, 32, 32);
        
        // Intense bright core
        const g = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
        g.addColorStop(0, 'rgba(255, 255, 255, 1.0)');
        g.addColorStop(0.3, 'rgba(220, 255, 255, 0.8)');
        g.addColorStop(0.6, 'rgba(100, 200, 255, 0.3)');
        g.addColorStop(1.0, 'rgba(0, 0, 0, 0)');
        
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(16, 16, 16, 0, Math.PI*2); ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 9. Dash Stream (New: Speed line)
    const _dashStreamTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 16;
        const ctx = c.getContext('2d');
        
        const g = ctx.createLinearGradient(0, 0, 64, 0);
        g.addColorStop(0, 'rgba(0, 255, 255, 0)');
        g.addColorStop(0.5, 'rgba(200, 255, 255, 0.8)');
        g.addColorStop(1, 'rgba(0, 255, 255, 0)');
        
        ctx.fillStyle = g;
        ctx.fillRect(0, 4, 64, 8);
        
        return new THREE.CanvasTexture(c);
    })();

    class ParticleManager {

        constructor(scene) {
            this.scene = scene;
            this.particles = [];
            
            // Mobile Optimization: Check screen width
            const isMobile = window.innerWidth < 800;
            
            // Shared Materials
            // Note: alphaTest added to NormalBlending materials to help GPU discard transparent pixels
            this.materials = {
                venom: new THREE.SpriteMaterial({ map: _venomTex, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending }),
                nap: new THREE.SpriteMaterial({ map: _napTex, transparent: true, depthWrite: false, blending: THREE.NormalBlending, alphaTest: 0.1 }),
                wither: new THREE.SpriteMaterial({ map: _witherTex, transparent: true, depthWrite: false, blending: THREE.NormalBlending, alphaTest: 0.05 }),
                learned: new THREE.SpriteMaterial({ map: _venomTex, color: 0x00ffff, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending }),
                shockwave: new THREE.SpriteMaterial({ map: _shockwaveTex, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending }),
                flash: new THREE.SpriteMaterial({ map: _flashTex, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending }),
                debris: new THREE.SpriteMaterial({ map: _debrisTex, transparent: true, depthWrite: false, blending: THREE.NormalBlending, alphaTest: 0.1 }),
                bubble: new THREE.SpriteMaterial({ map: _bubbleTex, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending }),
                bubble_micro: new THREE.SpriteMaterial({ map: _microBubbleTex, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending }),
                dash_stream: new THREE.SpriteMaterial({ map: _dashStreamTex, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending })
            };

            // Object Pool
            this.pool = [];
            // Reduce pool size on mobile to prevent excessive overdraw
            this.poolSize = isMobile ? 120 : 300;
            
            for(let i=0; i<this.poolSize; i++) {
                // Clone material to allow individual opacity/rotation
                // We clone 'venom' as a placeholder, it gets overwritten in spawn()
                const mat = this.materials.venom.clone();
                const sprite = new THREE.Sprite(mat); 
                sprite.visible = false;
                sprite.scale.set(0,0,0); 
                // Optimization: Disable frustum culling for particles to avoid CPU overhead of bounding box calc
                // since they are always in front of camera usually, or cheap to draw.
                // Actually, keeping culling is better if they go off screen.
                // sprite.frustumCulled = false; 
                this.scene.add(sprite);
                this.pool.push(sprite);
            }
        }

        spawn(type, pos, options = {}) {
            const p = this.pool.find(s => !s.visible);
            if (!p) return;

            p.visible = true;
            
            const template = this.materials[type] || this.materials.venom;
            p.material.map = template.map;
            p.material.blending = template.blending;
            p.material.depthWrite = template.depthWrite;
            p.material.transparent = template.transparent;

            p.position.copy(pos);
            
            p.material.rotation = 0;
            p.material.color.setHex(0xffffff);
            p.material.opacity = 1.0;

            const data = {
                mesh: p,
                type: type,
                age: 0,
                life: options.life || 1.0,
                maxLife: options.life || 1.0,
                velocity: new THREE.Vector3(0, 0, 0),
                startScale: options.scale || 1.0,
                gravity: 0,
                drag: 0
            };

            // Configuration per type
            if (type === 'venom') {
                data.life = 1.0 + Math.random() * 0.5;
                data.velocity.set(0, 1.0 + Math.random(), 0);
                data.startScale = 0.3 + Math.random() * 0.2;
                p.material.opacity = 0.8;
                
            } else if (type === 'nap') {
                data.life = 2.0;
                data.velocity.set((Math.random()-0.5)*0.2, 0.5, (Math.random()-0.5)*0.2);
                data.startScale = 0.4;
                p.material.opacity = 1.0;

            } else if (type === 'wither') {
                data.life = 1.5;
                data.velocity.set((Math.random()-0.5)*0.5, 0.5, (Math.random()-0.5)*0.5);
                p.material.opacity = 0.6;
                p.material.rotation = Math.random() * Math.PI;

            } else if (type === 'shockwave') {
                data.life = options.life || 0.4;
                data.maxLife = data.life;
                data.startScale = options.scale || 2.0;
                p.material.opacity = 1.0;
                
            } else if (type === 'flash') {
                data.life = 0.2;
                data.maxLife = 0.2;
                data.startScale = options.scale || 3.0;
                p.material.opacity = 1.0;
                p.material.rotation = Math.random() * Math.PI;

            } else if (type === 'debris') {
                data.life = 1.5;
                data.maxLife = 1.5;
                const speed = 5.0 + Math.random() * 10.0;
                data.velocity.set(
                    (Math.random()-0.5) * speed,
                    (Math.random() * speed * 0.5) + 2.0,
                    (Math.random()-0.5) * speed
                );
                data.gravity = 20.0;
                data.drag = 1.0;
                data.startScale = (options.scale || 0.3) * (0.5 + Math.random());
                p.material.opacity = 1.0;
                p.material.rotation = Math.random() * Math.PI;

            } else if (type === 'bubble') {
                data.life = 1.0 + Math.random() * 1.0;
                data.maxLife = data.life;
                data.velocity.set(
                    (Math.random() - 0.5) * 0.5,
                    0.5 + Math.random() * 1.0,
                    (Math.random() - 0.5) * 0.5
                );
data.startScale = (options.scale || 0.3) * (0.8 + Math.random() * 0.4); // Larger base scale
                p.material.opacity = 0.9; // More opaque
                p.material.color.setHex(0xaaccff);

            } else if (type === 'bubble_micro') {
                data.life = 0.4 + Math.random() * 0.4;
                data.maxLife = data.life;
                data.velocity.set(
                    (Math.random() - 0.5) * 1.5,
                    1.5 + Math.random() * 2.0,
                    (Math.random() - 0.5) * 1.5
                );
data.startScale = (options.scale || 0.15) * (0.8 + Math.random() * 0.5); // Larger micro bubbles
                p.material.opacity = 1.0;
                p.material.color.setHex(0xffffff);

            } else if (type === 'dash_stream') {
                data.life = 0.3;
                data.maxLife = 0.3;
                data.startScale = options.scale || 2.0;
                p.material.opacity = 0.8;
                p.material.rotation = Math.random() * Math.PI;
            }

            if (type !== 'shockwave') {
                p.scale.setScalar(data.startScale);
            } else {
                p.scale.setScalar(0.1);
            }

            this.particles.push(data);
        }

        update(dt) {
            for (let i = this.particles.length - 1; i >= 0; i--) {
                const p = this.particles[i];
                p.age += dt;

                if (p.age >= p.life) {
                    p.mesh.visible = false;
                    p.mesh.scale.set(0,0,0);
                    this.particles.splice(i, 1);
                    continue;
                }

                const t = p.age / p.life;

                if (p.gravity > 0) p.velocity.y -= p.gravity * dt;
                if (p.drag > 0) p.velocity.multiplyScalar(Math.max(0, 1.0 - (p.drag * dt)));
                p.mesh.position.addScaledVector(p.velocity, dt);

                if (p.type === 'shockwave') {
                    const s = p.startScale * Math.pow(t, 0.5) * 5.0; 
                    p.mesh.scale.setScalar(s);
                    p.mesh.material.opacity = 1.0 - Math.pow(t, 2);
                    
                } else if (p.type === 'flash') {
                    const s = p.startScale * (1.0 - t);
                    p.mesh.scale.setScalar(s);
                    p.mesh.material.rotation += 5.0 * dt;

                } else if (p.type === 'debris') {
                    p.mesh.material.rotation += 10.0 * dt;
                    p.mesh.scale.setScalar(p.startScale * (1.0 - t));
                    
                } else if (p.type === 'venom') {
                    p.mesh.position.x += Math.sin(p.age * 10 + p.mesh.id) * dt * 0.5;
                    p.mesh.material.opacity = 0.8 * (1.0 - Math.pow(t, 3));
                    
                } else if (p.type === 'nap') {
                    const s = p.startScale * (0.5 + t * 1.5);
                    p.mesh.scale.setScalar(s);
                    p.mesh.material.opacity = 1.0 - Math.pow(t, 2);
                    p.mesh.position.x += Math.sin(p.age * 2) * dt * 0.3;

                } else if (p.type === 'bubble') {
                    p.mesh.position.x += Math.sin(p.age * 5.0 + p.mesh.id) * dt * 0.2;
                    p.mesh.position.z += Math.cos(p.age * 4.0 + p.mesh.id) * dt * 0.2;
                    
                    const s = p.startScale * (1.0 + t * 0.2);
                    p.mesh.scale.setScalar(s);
                    p.mesh.material.opacity = 0.6 * (1.0 - Math.pow(t, 2));

                } else if (p.type === 'bubble_micro') {
                    p.mesh.position.x += (Math.random() - 0.5) * dt * 2.0;
                    p.mesh.position.z += (Math.random() - 0.5) * dt * 2.0;
                    
                    const s = p.startScale * (1.0 - t);
                    p.mesh.scale.setScalar(s);
                    p.mesh.material.opacity = 0.9 * (1.0 - t);
                    
                    const s2 = p.startScale;
                    p.mesh.scale.set(s2 * (1.0 + t), s2 * 0.2, 1.0);
                }
            }
        }
    }
    window.flux.ParticleManager = ParticleManager;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // --- TEXTURE GENERATION ---
    const _createGlyphTexture = (colorStr, type) => {
        const size = 256;
        const c = document.createElement('canvas');
        c.width = size; c.height = size;
        const ctx = c.getContext('2d');
        
        ctx.clearRect(0, 0, size, size);
        
        // Glow settings
        ctx.shadowBlur = 15;
        ctx.shadowColor = colorStr;
        ctx.strokeStyle = colorStr;
        ctx.fillStyle = colorStr;
        ctx.lineCap = 'round';

        const cx = size / 2;
        const cy = size / 2;

        if (type === 'ring') {
            // Outer Ring
            ctx.lineWidth = 6;
            ctx.beginPath();
            ctx.arc(cx, cy, 110, 0, Math.PI * 2);
            ctx.stroke();

            // Inner Ring
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(cx, cy, 90, 0, Math.PI * 2);
            ctx.stroke();

            // Runes
ctx.font = '24px Spira, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            for(let i=0; i<8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const r = 100;
                const x = cx + Math.cos(angle) * r;
                const y = cy + Math.sin(angle) * r;
                
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(angle + Math.PI/2);
                // Draw a simple rune-like shape
                ctx.beginPath();
                ctx.moveTo(-5, -5); ctx.lineTo(5, 0); ctx.lineTo(-5, 5);
                ctx.stroke();
                ctx.restore();
            }
        } else if (type === 'rune') {
            // Central Complex Rune
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.arc(cx, cy, 60, 0, Math.PI * 2);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(cx, cy - 60);
            ctx.lineTo(cx, cy + 60);
            ctx.moveTo(cx - 60, cy);
            ctx.lineTo(cx + 60, cy);
            ctx.stroke();

            ctx.beginPath();
            ctx.arc(cx, cy, 20, 0, Math.PI * 2);
            ctx.fill();
        }

        const tex = new THREE.CanvasTexture(c);
        return tex;
    };

    const _techTexture = _createGlyphTexture('#00ffff', 'ring'); // Cyan Ring
    const _statusTexture = _createGlyphTexture('#ff00ff', 'rune'); // Magenta Rune
    const _chargeTexture = _createGlyphTexture('#ffff00', 'ring'); // Gold Ring

    class GlyphManager {
        constructor(scene) {
            this.scene = scene;
            this.glyphs = [];
            
            // Materials
            this.materials = {
                tech: new THREE.MeshBasicMaterial({ 
                    map: _techTexture, 
                    transparent: true, 
                    side: THREE.DoubleSide, 
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    color: 0xffffff
                }),
                status: new THREE.MeshBasicMaterial({ 
                    map: _statusTexture, 
                    transparent: true, 
                    side: THREE.DoubleSide, 
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    color: 0xffffff
                }),
                charge: new THREE.MeshBasicMaterial({ 
                    map: _chargeTexture, 
                    transparent: true, 
                    side: THREE.DoubleSide, 
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    color: 0xffffff
                })
            };

            // Pool
            this.pool = [];
            this.poolSize = 30;
            const geo = new THREE.PlaneGeometry(1, 1);
            
            for(let i=0; i<this.poolSize; i++) {
                const mesh = new THREE.Mesh(geo, this.materials.tech);
                mesh.visible = false;
                mesh.renderOrder = 2000; // Draw on top of water/arena
                this.scene.add(mesh);
                this.pool.push(mesh);
            }
        }

        spawn(type, pos, options = {}) {
            const mesh = this.pool.find(m => !m.visible);
            if (!mesh) return;

            mesh.visible = true;
            mesh.material = this.materials[type] || this.materials.tech;
            mesh.position.copy(pos);
            
            // Reset Material Opacity
            mesh.material.opacity = 1.0;

            // Defaults
            const scale = options.scale || 1.0;
            mesh.scale.set(scale, scale, scale);
            
            // Orientation
            if (options.faceCamera) {
                if (window.flux.gameInstance && window.flux.gameInstance.camera) {
                    mesh.lookAt(window.flux.gameInstance.camera.position);
                }
            } else if (options.orientation === 'vertical') {
                mesh.rotation.set(0, 0, 0);
                // Face camera Y-axis rotation only
                if (window.flux.gameInstance && window.flux.gameInstance.camera) {
                    const camPos = window.flux.gameInstance.camera.position;
                    const angle = Math.atan2(camPos.x - pos.x, camPos.z - pos.z);
                    mesh.rotation.y = angle;
                }
            } else {
                // Horizontal (Ground)
                mesh.rotation.set(-Math.PI / 2, 0, Math.random() * Math.PI);
            }

            if (options.offsetY) {
                mesh.position.y += options.offsetY;
            }

            this.glyphs.push({
                mesh: mesh,
                age: 0,
                life: options.life || 1.0,
                maxLife: options.life || 1.0,
                rotationSpeed: options.rotationSpeed || 1.0,
                scaleSpeed: options.scaleSpeed || 0,
                fade: options.fade !== undefined ? options.fade : true,
                followTarget: options.parent || null,
                offsetY: options.offsetY || 0
            });
        }

        update(dt) {
            for (let i = this.glyphs.length - 1; i >= 0; i--) {
                const g = this.glyphs[i];
                g.age += dt;

                if (g.age >= g.life) {
                    g.mesh.visible = false;
                    this.glyphs.splice(i, 1);
                    continue;
                }

                const t = g.age / g.maxLife;

                // Follow target
                if (g.followTarget && g.followTarget.mesh) {
                    g.mesh.position.copy(g.followTarget.mesh.position);
                    g.mesh.position.y += g.offsetY;
                    
                    // If ground oriented, keep near floor
                    if (g.mesh.rotation.x === -Math.PI/2) {
                         g.mesh.position.y = 0.1 + g.offsetY;
                    }
                }

                // Animation
                g.mesh.rotation.z += g.rotationSpeed * dt;
                
                if (g.scaleSpeed !== 0) {
                    const s = g.mesh.scale.x + g.scaleSpeed * dt;
                    g.mesh.scale.set(s, s, s);
                }

                // Fade
                if (g.fade) {
                    let opacity = 1.0;
                    if (t < 0.1) opacity = t / 0.1;
                    else if (t > 0.7) opacity = 1.0 - ((t - 0.7) / 0.3);
                    g.mesh.material.opacity = opacity;
                }
            }
        }
    }

    window.flux.GlyphManager = GlyphManager;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Reusable vectors to avoid Garbage Collection
    const _idealPos = new THREE.Vector3();
    const _idealLook = new THREE.Vector3();
    const _currentPos = new THREE.Vector3();
    const _currentLook = new THREE.Vector3();
    const _velocity = new THREE.Vector3();
    const _targetWorldPos = new THREE.Vector3();
    const _camOffset = new THREE.Vector3();
    const _lookAhead = new THREE.Vector3();
    const _goalPos = new THREE.Vector3();
    const _camFwd = new THREE.Vector3();
    const _camRight = new THREE.Vector3();

    class CameraManager {
        constructor(camera, scene) {
            this.camera = camera;
            this.scene = scene;

            // --- IMPROVED CONFIGURATION ---
            this.config = {
                // FIXED PERSPECTIVE SETTINGS
                baseDistance: 22.0,
                baseHeight: 14.0,

                // IMPROVED: Faster, more responsive smoothing
// IMPROVED: Faster, more responsive smoothing
                followSpeed: 4.0,     
                lookSpeed: 1.5,       // REDUCED: Lazier look to reveal curve

                // Dynamic FOV
                fovBase: 50,
                fovMax: 60,

                // IMPROVED: Look-ahead settings
                lookAheadDistance: 6.0,
                lookAheadSmoothing: 3.0,

                // Smart framing
ballTrackWeight: 0.1, // REDUCED: Don't track ball laterally too much
                threatAwareness: true
            };

            // State
            this.target = null;
            this.ball = null; // Direct ball reference for smart framing
            this.targetVel = new THREE.Vector3();
            this.targetInput = new THREE.Vector3();
            this.smoothedInput = new THREE.Vector3();
            this.smoothedLookAhead = new THREE.Vector3();

            // Camera State
            this.pos = camera.position.clone();
            this.lookAt = new THREE.Vector3(0, 0, 0);

            // Orbit State
            this.currentYaw = Math.PI;
            this.targetYaw = Math.PI;

            // IMPROVED: Manual orbit from touch (right side of screen)
            this.manualOrbitYaw = 0;
            this.manualOrbitPitch = 0;
            this.orbitSensitivity = 0.004;
            this.autoRecenterTimer = 0;
            this.autoRecenterDelay = 3.0;

// Shake
            this.shakeIntensity = 0;
            this.shakeRoll = 0; // NEW: Rotational shake
this.shakeOffset = new THREE.Vector3();
            this.fovImpulse = 0;
            this.rollImpulse = 0; // NEW: Dynamic tilt for curves

            // Cinematic State
            this.isCinematic = false;
            this.cinematicTimer = 0;
            this.cinematicDuration = 0;
            this.cinematicType = 'default';
            this.cinematicStartPos = new THREE.Vector3();
            this.cinematicStartLook = new THREE.Vector3();
            this.cinematicEndPos = new THREE.Vector3();

            // IMPROVED: Dynamic pull-back based on action
            this.currentPullBack = 0;
            this.maxPullBack = 8;
        }

        // NEW: Set ball reference for smart framing
        setBall(ball) {
            this.ball = ball;
        }

        // IMPROVED: Get camera-relative input transformation
        getCameraRelativeInput(inputX, inputZ) {
            this.camera.getWorldDirection(_camFwd);
            _camFwd.y = 0;

            if (_camFwd.lengthSq() < 0.001) {
                _camFwd.set(0, 0, -1);
            } else {
                _camFwd.normalize();
            }

            _camRight.crossVectors(new THREE.Vector3(0, 1, 0), _camFwd).normalize();

            // Transform input to world space
            const worldX = (inputX * _camRight.x) + (inputZ * _camFwd.x);
            const worldZ = (inputX * _camRight.z) + (inputZ * _camFwd.z);

            return { x: worldX, z: worldZ };
        }

        // NEW: Manual orbit input from touch
        handleOrbitInput(dx, dy) {
            this.manualOrbitYaw += dx * this.orbitSensitivity;
            this.manualOrbitPitch += dy * this.orbitSensitivity * 0.5;

            // Clamp pitch
            this.manualOrbitPitch = Math.max(-0.3, Math.min(0.5, this.manualOrbitPitch));

            // Reset auto-recenter timer
            this.autoRecenterTimer = 0;
        }

        // NEW: Recenter camera
        recenter() {
            this.manualOrbitYaw = 0;
            this.manualOrbitPitch = 0;
        }

        playCinematic(type, target, duration = 1.5) {
            this.isCinematic = true;
            this.cinematicTimer = 0;
            this.cinematicDuration = duration;
            this.target = target;
            this.cinematicType = type;

            this.cinematicStartPos.copy(this.pos);
            this.cinematicStartLook.copy(this.lookAt);

            this.addFovImpulse(-15);
        }

        _updateCinematic(dt) {
            this.cinematicTimer += dt;
            const progress = Math.min(1.0, this.cinematicTimer / this.cinematicDuration);

            const t = 1 - Math.pow(1 - progress, 3);

            let activeTarget = this.target;
            let isBallTracking = false;
            const ball = window.flux.gameInstance ? window.flux.gameInstance.entities.ball : null;

            if (ball && ball.mesh && ball.state === 'free' && ball.velocity.lengthSq() > 2.0) {
                activeTarget = ball.mesh;
                isBallTracking = true;
            }

            if (!activeTarget) {
                this.isCinematic = false;
                return;
            }

            activeTarget.getWorldPosition(_targetWorldPos);

            const endLook = _targetWorldPos.clone();
            let fwd = new THREE.Vector3();
            let right = new THREE.Vector3();

            if (isBallTracking) {
                endLook.addScaledVector(ball.velocity, 0.3);

                fwd.copy(ball.velocity).normalize();
                fwd.y = 0;
                if (fwd.lengthSq() < 0.01) fwd.set(0,0,1);
                fwd.normalize();

                right.crossVectors(new THREE.Vector3(0,1,0), fwd).normalize();
            } else {
                endLook.y += 1.5;
                fwd.set(0, 0, 1).applyQuaternion(activeTarget.quaternion);
                right.set(1, 0, 0).applyQuaternion(activeTarget.quaternion);
            }

            const endPos = _targetWorldPos.clone();

            if (this.cinematicType === 'jecht') {
                const dist = isBallTracking ? 14.0 : 10.0;
                const offset = fwd.clone().multiplyScalar(-dist).add(right.clone().multiplyScalar(3.0));
                endPos.add(offset);
                endPos.y += 6.0;
            } else if (this.cinematicType === 'sphere') {
                const dist = isBallTracking ? 16.0 : 12.0;
                const offset = fwd.clone().multiplyScalar(-dist);
                endPos.add(offset);
                endPos.y += 10.0;
            } else if (this.cinematicType === 'invisible') {
                const dist = 12.0;
                const offset = fwd.clone().multiplyScalar(-dist * 0.5).add(right.clone().multiplyScalar(dist));
                endPos.add(offset);
                endPos.y += 5.0;
            } else {
                const dist = isBallTracking ? 14.0 : 10.0;
                const offset = fwd.clone().multiplyScalar(-dist);
                endPos.add(offset);
                endPos.y += 5.0;
            }

            this.pos.lerp(endPos, dt * 4.0);
            this.lookAt.lerp(endLook, dt * 6.0);

            this.camera.position.copy(this.pos);
            this.camera.lookAt(this.lookAt);

            if (this.cinematicTimer >= this.cinematicDuration) {
                this.isCinematic = false;
            }
        }

setTarget(mesh, velocity, input, isAiming = false) {
            this.target = mesh;
            if (velocity) this.targetVel.copy(velocity);
            if (input) this.targetInput.copy(input);
            else this.targetInput.set(0, 0, 0);
            this.isAiming = isAiming;
        }

        // Keep for compatibility
        handleInput(dx, dy) {
            this.handleOrbitInput(dx, dy);
        }

        getYaw() { return this.currentYaw; }

        addShake(amount) {

            this.shakeIntensity = Math.min(this.shakeIntensity + amount, 4.0); // Increased cap
            this.shakeRoll = Math.min(this.shakeRoll + amount * 0.2, 0.8); // Add roll
        }
        addFovImpulse(amount) {
            this.fovImpulse = Math.min(this.fovImpulse + amount, 30);

        }
        addRollImpulse(amount) {
            this.rollImpulse += amount;
            // Clamp
            this.rollImpulse = Math.max(-0.5, Math.min(0.5, this.rollImpulse));
}

        snapToTarget() {
            if (!this.target) return;
            this.target.getWorldPosition(_targetWorldPos);

            this._calculateIdealState(0);

            this.pos.copy(_idealPos);
            this.lookAt.copy(_idealLook);
            this.currentYaw = this.targetYaw;

            this.camera.position.copy(this.pos);
            this.camera.lookAt(this.lookAt);

            this.smoothedInput.set(0, 0, 0);
            this.smoothedLookAhead.set(0, 0, 0);
        }

        update(dt) {
            if (this.isCinematic) {
                this._updateCinematic(dt);
                return;
            }

            if (!this.target) return;

            const safeDt = Math.min(dt, 0.05);

            // IMPROVED: Auto-recenter logic (Only if not aiming)
            if (!this.isAiming) {
                this.autoRecenterTimer += safeDt;
                if (this.autoRecenterTimer > this.autoRecenterDelay) {
                    const recenterSpeed = 2.0 * safeDt;
                    this.manualOrbitYaw *= (1.0 - recenterSpeed);
                    this.manualOrbitPitch *= (1.0 - recenterSpeed);
                }
            }

            // IMPROVED: Smart pull-back based on ball speed
            if (this.ball && this.ball.velocity) {
                const ballSpeed = this.ball.velocity.length();
                const targetPullBack = Math.min(this.maxPullBack, ballSpeed * 0.3);
                this.currentPullBack += (targetPullBack - this.currentPullBack) * safeDt * 3.0;
            } else {
                this.currentPullBack *= (1.0 - safeDt * 2.0);
            }

            // 1. Update Target Info
            this.target.getWorldPosition(_targetWorldPos);

            // 2. Calculate Ideal State
            this._calculateIdealState(safeDt);

            // 3. IMPROVED: Faster, more responsive smoothing
            // If aiming, snap faster to prevent "jank"
// If aiming, slightly faster follow but not instant snap
const speedMult = this.isAiming ? 1.5 : 1.0;
            const lookFactor = 1.0 - Math.exp(-this.config.lookSpeed * speedMult * safeDt);
            const posFactor = 1.0 - Math.exp(-this.config.followSpeed * speedMult * safeDt);

            this.pos.lerp(_idealPos, posFactor);
            this.lookAt.lerp(_idealLook, lookFactor);

            // 4. Screen Shake (Position & Rotation)
            if (this.shakeIntensity > 0) {
                const decay = 8.0 * safeDt; // Fast decay for snappy feel
                this.shakeIntensity -= decay;
                if (this.shakeIntensity < 0) this.shakeIntensity = 0;

                const shakeMag = this.shakeIntensity * 0.5;
                this.shakeOffset.set(
                    (Math.random() - 0.5) * shakeMag,
                    (Math.random() - 0.5) * shakeMag,
                    (Math.random() - 0.5) * shakeMag
                );
            } else {
                this.shakeOffset.set(0, 0, 0);
            }

            // Roll Shake
            if (this.shakeRoll > 0) {
                this.shakeRoll -= 5.0 * safeDt;
                if (this.shakeRoll < 0) this.shakeRoll = 0;
                this.camera.rotation.z = (Math.random() - 0.5) * this.shakeRoll;
} else {
                this.camera.rotation.z = 0;
            }
            
            // Apply Curve Tilt (Roll Impulse)
            if (Math.abs(this.rollImpulse) > 0.001) {
                this.camera.rotation.z += this.rollImpulse;
                this.rollImpulse *= (1.0 - 4.0 * safeDt); // Decay
            }

            // 5. Dynamic FOV
            const speed = this.targetVel.length();
            const speedRatio = Math.min(speed / 20.0, 1.0);
            const warp = speedRatio * speedRatio;

            // Zoom in slightly when aiming
            const aimZoom = this.isAiming ? -5 : 0;
            const targetFov = this.config.fovBase + (this.config.fovMax - this.config.fovBase) * warp + this.fovImpulse + aimZoom;

            this.fovImpulse *= Math.max(0, 1.0 - (5.0 * safeDt));

            this.camera.fov += (targetFov - this.camera.fov) * 3.0 * safeDt;
            this.camera.updateProjectionMatrix();

            // 6. Apply to Camera
            this.camera.position.copy(this.pos).add(this.shakeOffset);
            this.camera.lookAt(this.lookAt);
        }

        _calculateIdealState(dt) {
            const tPos = _targetWorldPos;

// --- AIM MODE OVERRIDE ---
            if (this.isAiming) {
                // Relaxed Aim Mode: Zoom in but maintain orientation
                const aimDist = 16.0; 
                const aimHeight = 8.0;
                
                // Use Manual Orbit Logic (Consistent with Standard Mode)
                // This prevents the camera from snapping "behind" the player if they are moving sideways
                const effectiveDistance = aimDist;
                const effectiveHeight = aimHeight + this.manualOrbitPitch * 10;
                
                // Base Z offset (Camera defaults to +Z)
                const camZ = effectiveDistance;
                
                // Apply Orbit Rotation
                const finalX = camZ * Math.sin(this.manualOrbitYaw);
                const finalZ = camZ * Math.cos(this.manualOrbitYaw);
                
                _idealPos.set(tPos.x + finalX, tPos.y + effectiveHeight, tPos.z + finalZ);
                
                _idealLook.copy(tPos);
                _idealLook.y += 1.0; // Look at player center
                
                // Disable look-ahead to keep framing stable while aiming
                this.smoothedLookAhead.set(0,0,0);
                
                return;
            }

            // --- STANDARD MODE ---

            // IMPROVED: Apply manual orbit
            // 1. Calculate Ideal Position with pull-back
            const effectiveDistance = this.config.baseDistance + this.currentPullBack;
            const effectiveHeight = this.config.baseHeight + this.currentPullBack * 0.3 + this.manualOrbitPitch * 10;

            // Base offset (Camera usually sits at +Z relative to target)
            const camX = 0; 
            const camZ = effectiveDistance;

            // Apply Orbit Rotation
            // x' = x*cos(t) - z*sin(t)
            // z' = x*sin(t) + z*cos(t)
            // Note: The previous math was slightly weird, standardizing here:
            // We want Yaw 0 to be +Z. 
            const finalCamX = camZ * Math.sin(this.manualOrbitYaw);
            const finalCamZ = camZ * Math.cos(this.manualOrbitYaw);

            _idealPos.set(tPos.x + finalCamX, tPos.y + effectiveHeight, tPos.z + finalCamZ);

            // Clamp to arena bounds (roughly) to prevent clipping through walls
            if (_idealPos.z > 45.0) _idealPos.z = 45.0;
            if (_idealPos.z < -45.0) _idealPos.z = -45.0;

            // 2. Calculate Ideal LookAt with IMPROVED look-ahead
            _idealLook.copy(tPos);

            // IMPROVED: Velocity-based look-ahead
            if (this.targetVel.lengthSq() > 0.5) {
                const speed = this.targetVel.length();
                const lookAheadFactor = Math.min(1.0, speed / 10.0) * this.config.lookAheadDistance;

                const velDir = this.targetVel.clone().normalize();
                _lookAhead.copy(velDir).multiplyScalar(lookAheadFactor);

                // Smooth the look-ahead
                this.smoothedLookAhead.lerp(_lookAhead, dt * this.config.lookAheadSmoothing);
                _idealLook.add(this.smoothedLookAhead);
            } else {
                this.smoothedLookAhead.multiplyScalar(1.0 - dt * 2.0);
                _idealLook.add(this.smoothedLookAhead);
            }

            _idealLook.y *= 0.5; // Look slightly lower than actual target height

            // IMPROVED: Include ball in framing when nearby
            if (this.ball && this.ball.mesh && this.config.ballTrackWeight > 0) {
                const ballPos = this.ball.mesh.position;
                const distToBall = tPos.distanceTo(ballPos);

                if (distToBall < 20 && distToBall > 2) {
                    const ballWeight = Math.max(0, 1 - distToBall / 20) * this.config.ballTrackWeight;
                    _idealLook.lerp(ballPos, ballWeight);
                }
            }

            // 3. Input Anticipation (Smoothed)
            this.smoothedInput.lerp(this.targetInput, dt * 2.0);

            if (this.smoothedInput.lengthSq() > 0.01) {
                _idealLook.x += this.smoothedInput.x * 3.0;
                _idealLook.z += this.smoothedInput.z * 3.0;
            }
        }

        // NEW: Get forward direction for UI reference
        getForwardDirection() {
            this.camera.getWorldDirection(_camFwd);
            _camFwd.y = 0;
            if (_camFwd.lengthSq() < 0.001) {
                _camFwd.set(0, 0, -1);
            } else {
                _camFwd.normalize();
            }
            return _camFwd.clone();
        }

        // NEW: Get right direction
        getRightDirection() {
            const fwd = this.getForwardDirection();
            _camRight.crossVectors(new THREE.Vector3(0, 1, 0), fwd).normalize();
            return _camRight.clone();
        }
    }

    window.flux.CameraManager = CameraManager;
})();
</script>
    <script>(function() {
    window.flux = window.flux || {};

// Tooltip Descriptions for Long-Press
    const TOOLTIP_DESCRIPTIONS = {
        'SUBSTEPS': "Physics iterations per frame. Higher = more stable, more CPU.",
        'STOP_SPEED': "Velocity threshold below which the ball snaps to a halt.",
        'WATER_DRAG_LINEAR': "Base water resistance. Slows ball linearly.",
        'WATER_DRAG_QUAD': "Quadratic drag. Slows high-speed balls significantly.",
        'SPIN_DRAG': "How fast the ball's spin decays over time.",
        'MAGNUS_ENABLED': "Enables the Magnus effect (curve from spin).",
        'MAGNUS_COEFF': "Strength of the curve force relative to spin/speed.",
        'MAGNUS_CAP': "Maximum curve force allowed (prevents physics explosions).",
        'DEPTH_TARGET_Y': "Ideal Y height the ball tries to float at.",
        'DEPTH_SPRING': "Strength of the force pulling ball to Target Y.",
        'DEPTH_DAMP': "Damping on vertical movement to prevent oscillation.",
        'BOUNDARY_RADIUS': "Radius of the circular arena wall.",
        'BOUNDARY_HEIGHT': "Height of the arena ceiling/floor.",
        'WALL_SOFT_BUFFER': "Distance from wall where soft repulsion begins.",
        'WALL_SOFT_FORCE': "Force pushing ball away from wall before impact.",
        'WALL_ELASTICITY': "Bounciness of the wall (0 = dead thud, 1 = perfect bounce).",
        'WALL_FRICTION': "Friction when sliding along the wall.",
        'FLOOR_ELASTICITY': "Bounciness of the floor/ceiling.",
        'GOAL_POCKET_ENABLED': "Enables the extended corridor for the goal.",
        'GOAL_POCKET_X': "Half-width of the goal pocket corridor.",
        'GOAL_POCKET_Z': "Z-depth where the pocket starts.",
        'GOAL_POCKET_RADIUS': "Effective radius inside the pocket.",
        'LAUNCH_SPEED_SCALE': "Multiplier for converting Stat Power to Physics Velocity.",
        'LAUNCH_SPEED_CAP': "Maximum physical speed the ball can be thrown.",
        'SWIPE_MIN_PX': "Minimum swipe distance to register a throw.",
        'AIM_DX_SCALE': "Sensitivity of horizontal aim from swipe.",
        'AIM_DY_SCALE': "Sensitivity of vertical aim from swipe.",
        'POWER_BASE': "Base power multiplier for a quick tap.",
        'POWER_RANGE': "Additional power multiplier at full charge.",
        'POWER_MAX_BONUS_RATIO': "Charge threshold for 'Max Power' bonus.",
        'POWER_MAX_MULTIPLIER': "Multiplier applied when hitting Max Power.",
        'CURVE_ENABLED': "Enables curve shots via curved swipes.",
        'CURVE_INTENSITY_THRESHOLD': "How curved a swipe must be to trigger spin.",
        'CURVE_SPIN_SCALE': "Multiplier for converting swipe curve to ball spin.",
        'CURVE_SPEED_MULT': "Multiplier for spin based on swipe speed.",
        'CURVE_SPIN_CAP': "Maximum spin allowed from a curve throw.",
        'CURVE_PERFECT_SPIN': "Spin threshold to trigger 'Perfect Curve' FX.",
        'timeScale': "Global game speed multiplier.",
        'demoMode': "Toggle AI vs AI auto-play.",
        'resolution': "Internal render resolution scale (0.5 = half res).",
        'arenaOpacity': "Opacity of the outer arena grid.",
        'arena2Opacity': "Opacity of the inner hex grid."
    };

    class DevTools {
        constructor(gameManager) {
            this.game = gameManager;
            
            // lil-gui attaches to window.lil by default in UMD build
            if (!window.lil || !window.lil.GUI) {
                console.warn("DevTools: lil-gui not found.");
                return;
            }

const container = document.getElementById('game-container');
            this.gui = new window.lil.GUI({ title: 'Flux DevTools', container: container });
            
            // Position as a collapsed tab on the right frame
// Position as a sliding tab on the right frame
// Position as a sliding tab on the right frame
// Wrapper for sliding animation
            const wrapper = document.createElement('div');
            wrapper.style.position = 'absolute';
            wrapper.style.top = '100px';
            wrapper.style.right = '-260px';
            wrapper.style.width = '260px';
            wrapper.style.transition = 'right 0.3s cubic-bezier(0.2, 0.8, 0.2, 1.0)';
            wrapper.style.zIndex = '9999';
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = 'column';
            container.appendChild(wrapper);

            const dom = this.gui.domElement;
            dom.style.width = '100%';
            dom.style.setProperty('--width', '100%');
            dom.style.maxHeight = '80vh';
            dom.style.overflowY = 'auto';
            dom.style.overflowX = 'hidden';
            
            // Move GUI into wrapper
            wrapper.appendChild(dom);
            
            // Create Toggle Handle
            const handle = document.createElement('div');
            handle.style.position = 'absolute';
            handle.style.left = '-40px'; // Protrude to the left
            handle.style.top = '0';
            handle.style.width = '40px';
            handle.style.height = '40px';
            handle.style.backgroundColor = 'rgba(0, 20, 40, 0.9)';
            handle.style.border = '1px solid #00ffff';
            handle.style.borderRight = 'none';
            handle.style.borderTopLeftRadius = '8px';
            handle.style.borderBottomLeftRadius = '8px';
            handle.style.cursor = 'pointer';
            handle.style.display = 'flex';
            handle.style.justifyContent = 'center';
            handle.style.alignItems = 'center';
            handle.style.color = '#00ffff';
            handle.style.fontSize = '20px';
            handle.innerHTML = '';
            handle.style.boxShadow = '-5px 0 10px rgba(0,0,0,0.5)';
            
            wrapper.appendChild(handle);
            
            // Toggle Logic
            let isOpen = false;
            handle.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent game inputs
                isOpen = !isOpen;
                wrapper.style.right = isOpen ? '0px' : '-260px';
                handle.innerHTML = isOpen ? '' : '';
            });
            // Default global timeScale if not set
if (window.flux.timeScale === undefined) window.flux.timeScale = 0.8;

this._setupGeneral();
            this._setupControlsFeel();
            this._setupGameState();
this._setupOverlays();
            this._setupTeams();
            this._setupPlayerInspector();
            this._setupBallSandbox();
this._setupFXLab();
this._setupFXLab();
            this._setupVisuals();
            this._setupTooltips();
        }

        _setupTooltips() {
            // Create Tooltip DOM
            this.tooltipEl = document.createElement('div');
            Object.assign(this.tooltipEl.style, {
                position: 'fixed',
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                backgroundColor: 'rgba(0, 10, 30, 0.95)',
                border: '2px solid #00ffff',
                padding: '20px',
                color: '#fff',
                fontFamily: 'monospace',
                fontSize: '14px',
                maxWidth: '300px',
                zIndex: '10000',
                display: 'none',
                pointerEvents: 'none',
                boxShadow: '0 0 20px rgba(0, 255, 255, 0.3)',
                borderRadius: '8px',
                textAlign: 'center'
            });
            document.body.appendChild(this.tooltipEl);

            // Recursive function to attach listeners
            const attach = (gui) => {
                // Controllers
                if (gui.controllers) {
                    gui.controllers.forEach(c => {
                        const dom = c.domElement.closest('.controller'); // lil-gui structure
                        if(dom) {
                            const label = dom.querySelector('.name');
                            if(label) {
                                this._addLongPress(label, c.property, c._name);
                            }
                        }
                    });
                }
                // Sub-folders
                if(gui.folders) {
                    gui.folders.forEach(f => attach(f));
                }
            };

            // Wait a tick for GUI to fully render DOM
            setTimeout(() => attach(this.gui), 100);
        }

        _addLongPress(element, property, name) {
            let timer = null;
            const duration = 500; // 0.5s

            const start = (e) => {
                timer = setTimeout(() => {
                    this._showTooltip(property, name);
                }, duration);
            };

            const end = () => {
                if(timer) {
                    clearTimeout(timer);
                    timer = null;
                }
                this._hideTooltip();
            };

            element.addEventListener('mousedown', start);
            element.addEventListener('touchstart', start, {passive: true});
            
            element.addEventListener('mouseup', end);
            element.addEventListener('mouseleave', end);
            element.addEventListener('touchend', end);
            element.addEventListener('touchcancel', end);
        }

        _showTooltip(prop, name) {
            const desc = TOOLTIP_DESCRIPTIONS[prop];
            if(desc) {
                this.tooltipEl.innerHTML = `<strong style="color:#00ffff; font-size:16px;">${name || prop}</strong><br><br>${desc}`;
                this.tooltipEl.style.display = 'block';
            }
        }

        _hideTooltip() {
            if (this.tooltipEl) this.tooltipEl.style.display = 'none';
        }


_setupGeneral() {
            const folder = this.gui.addFolder('General');
            
const params = {
                timeScale: window.flux.timeScale,
                demoMode: this.game.isDemoMode,
                toggleHUD: true,
                resolution: 0.50,
arenaOpacity: 0.3,
                arena2Opacity: 0.25
            };

            folder.add(params, 'timeScale', 0.0, 5.0).name('Game Speed').onChange(v => {
                window.flux.timeScale = v;
            });

            folder.add(params, 'demoMode').name('Demo Mode').listen().onChange(v => {
                if (this.game.isDemoMode !== v) {
                    this.game.toggleDemoMode();
                }
            });

            folder.add(params, 'toggleHUD').name('Show HUD').onChange(v => {
                const hud = document.getElementById('ui-layer');
                if (hud) {
                    hud.style.visibility = v ? 'visible' : 'hidden';
                }
            });

            folder.add(params, 'resolution', 0.1, 2.0).name('Resolution Scale').onChange(v => {
                const w = window.innerWidth;
                const h = window.innerHeight;
                const renderer = this.game.renderer;
                if (renderer) {
                    renderer.setSize(w * v, h * v, false);
                }
            });

folder.add(params, 'arenaOpacity', 0.0, 1.0).name('Arena 1 Opacity').onChange(v => {
                if (window.flux.arenaMesh && window.flux.arenaMesh.material) {
                    window.flux.arenaMesh.material.opacity = v;
                }
            });

            const blendModes = {
                'Normal': THREE.NormalBlending,
                'Additive': THREE.AdditiveBlending,
                'Multiply': THREE.MultiplyBlending,
                'Subtractive': THREE.SubtractiveBlending,
                'NoBlending': THREE.NoBlending
            };
params.arenaBlend = 'Normal';

            folder.add(params, 'arenaBlend', Object.keys(blendModes)).name('Arena 1 Blend').onChange(v => {
                if (window.flux.arenaMesh && window.flux.arenaMesh.material) {
                    window.flux.arenaMesh.material.blending = blendModes[v];
                    window.flux.arenaMesh.material.needsUpdate = true;
                }
            });

            // Arena 2 Controls
folder.add(params, 'arena2Opacity', 0.0, 1.0).name('Arena 2 Opacity').onChange(v => {
                if (window.flux.arenaMesh2 && window.flux.arenaMesh2.material && window.flux.arenaMesh2.material.uniforms.uOpacity) {
                    window.flux.arenaMesh2.material.uniforms.uOpacity.value = v;
                }
            });

params.arena2Blend = 'Additive';
            folder.add(params, 'arena2Blend', Object.keys(blendModes)).name('Arena 2 Blend').onChange(v => {
                if (window.flux.arenaMesh2 && window.flux.arenaMesh2.material) {
                    window.flux.arenaMesh2.material.blending = blendModes[v];
                    window.flux.arenaMesh2.material.needsUpdate = true;
                }
            });
            
            // Apply defaults
            if (window.flux.arenaMesh && window.flux.arenaMesh.material) {
                window.flux.arenaMesh.material.opacity = params.arenaOpacity;
            }
            if (window.flux.arenaMesh2 && window.flux.arenaMesh2.material) {
                window.flux.arenaMesh2.material.opacity = params.arena2Opacity;
            }
        }

        _setupControlsFeel() {
            const debugIO = (window.flux && window.flux._debugIO) ? window.flux._debugIO : null;
            if (!debugIO || !debugIO.settings) return;

            const s = debugIO.settings;

            // Ensure defaults exist (older projects may not have these keys yet)
            if (s.passAimAssist === undefined) s.passAimAssist = 0.65;
            if (s.shotAimAssist === undefined) s.shotAimAssist = 0.35;
            if (s.catchAssist === undefined) s.catchAssist = 0.55;
            if (s.steeringAssist === undefined) s.steeringAssist = 0.35;
            if (s.inputResponse === undefined) s.inputResponse = 14.0;
            if (s.predictiveCatchTime === undefined) s.predictiveCatchTime = 0.12;

            const folder = this.gui.addFolder('Controls & Feel');

            // Core toggles
            folder.add(s, 'joystickSensitivity', 0.3, 2.0, 0.01).name('Move Sensitivity');
            folder.add(s, 'invertCamera').name('Invert Camera');
            folder.add(s, 'autoRecenter').name('Auto Recenter');
            folder.add(s, 'aimAssist').name('Aim Assist');

            // Assist layer (0..1)
            const a = folder.addFolder('Assist Strengths');
            a.add(s, 'passAimAssist', 0.0, 1.0, 0.01).name('Pass Assist');
            a.add(s, 'shotAimAssist', 0.0, 1.0, 0.01).name('Shot Assist');
            a.add(s, 'catchAssist', 0.0, 1.0, 0.01).name('Catch Assist');
            a.add(s, 'steeringAssist', 0.0, 1.0, 0.01).name('Steering Assist');

            const f = folder.addFolder('Responsiveness');
            f.add(s, 'inputResponse', 4.0, 24.0, 0.1).name('Input Response');
            f.add(s, 'predictiveCatchTime', 0.0, 0.35, 0.01).name('Predict Catch (s)');
        }


_setupOverlays() {
            const folder = this.gui.addFolder('Overlays & FX');
            
            // 1. GIF Overlay
            const gifEl = document.getElementById('screen-overlay-gif');
            if (gifEl) {
                const gifParams = {
                    visible: true,
opacity: 0.62,
                    blend: 'overlay'
                };
                
                const gFolder = folder.addFolder('Screen GIF');
                gFolder.add(gifParams, 'visible').onChange(v => gifEl.style.display = v ? 'block' : 'none');
                gFolder.add(gifParams, 'opacity', 0.0, 1.0).onChange(v => gifEl.style.opacity = v);
                
                const blendModes = [
                    'normal', 'multiply', 'screen', 'overlay', 
                    'darken', 'lighten', 'color-dodge', 'color-burn', 
                    'hard-light', 'soft-light', 'difference', 'exclusion', 
                    'hue', 'saturation', 'color', 'luminosity'
                ];
                gFolder.add(gifParams, 'blend', blendModes).onChange(v => gifEl.style.mixBlendMode = v);
            }

            // 2. Water Overlay
            const wo = this.game.waterOverlay;
            if (wo && wo.mesh) {
                const wFolder = folder.addFolder('Water Shader');
                const wParams = { 
                    visible: true,
                    opacity: wo.material.uniforms.uOpacity ? wo.material.uniforms.uOpacity.value : 0.5,
                    blend: 'Additive'
                };
                
                wFolder.add(wParams, 'visible').onChange(v => wo.mesh.visible = v);
                
                if (wo.material.uniforms.uOpacity) {
                    wFolder.add(wParams, 'opacity', 0.0, 2.0).onChange(v => wo.material.uniforms.uOpacity.value = v);
                }

                const threeBlends = {
                    'Normal': THREE.NormalBlending,
                    'Additive': THREE.AdditiveBlending,
                    'Subtractive': THREE.SubtractiveBlending,
                    'Multiply': THREE.MultiplyBlending,
                    'NoBlending': THREE.NoBlending
                };
                
                wFolder.add(wParams, 'blend', Object.keys(threeBlends)).onChange(v => {
                    wo.material.blending = threeBlends[v];
                    wo.material.needsUpdate = true;
                });
            }

            // 3. Light Shafts
            const ls = this.game.lightShafts;
            if (ls && ls.container) {
                const lParams = { visible: true };
                folder.add(lParams, 'visible').name('Light Shafts').onChange(v => ls.container.visible = v);
            }
        }

_setupGameState() {
            const folder = this.gui.addFolder('Game State');
            const gm = this.game;
            
            const params = {
                forceHomeGoal: () => { 
                    if(gm.state === 'active') gm.goalScored('home'); 
                    else console.warn("Game must be active to trigger goal");
                },
                forceAwayGoal: () => { 
                    if(gm.state === 'active') gm.goalScored('away');
                    else console.warn("Game must be active to trigger goal");
                },
                forceHalftime: () => {
                    if(gm.state === 'active') gm.endHalf();
                },
                resetRound: () => gm.resetRound(),
                exitToMenu: () => {
                    if (window.flux.gameInstance && window.flux.gameInstance.menuManager) {
                        window.flux.gameInstance.menuManager.show();
                        window.flux.gameInstance.state = 'menu';
                        // Stop practice if running
                        if (window.flux.gameInstance.practiceManager) {
                            window.flux.gameInstance.practiceManager.stop();
                        }
                    }
                }
            };

            folder.add(params, 'forceHomeGoal').name('Trigger Home Goal');
            folder.add(params, 'forceAwayGoal').name('Trigger Away Goal');
            folder.add(params, 'forceHalftime').name('Force Halftime');
            folder.add(params, 'resetRound').name('Reset Round');
            folder.add(params, 'exitToMenu').name('Exit to Menu');
        }

        _setupTeams() {
            const folder = this.gui.addFolder('Teams');
            if (!this.game.teams.home || !this.game.teams.away) return;

            const home = this.game.teams.home;
            const away = this.game.teams.away;

            // Home
            const hFolder = folder.addFolder('Home Team');
            hFolder.add(home, 'isHuman').name('Is Human Controlled').listen();
            hFolder.add(home, 'aiEnabled').name('AI Logic Enabled').listen();

            // Away
            const aFolder = folder.addFolder('Away Team');
            aFolder.add(away, 'isHuman').name('Is Human Controlled').listen();
            aFolder.add(away, 'aiEnabled').name('AI Logic Enabled').listen();

        }

_setupPlayerInspector() {
            const folder = this.gui.addFolder('Player Inspector (Home Active)');
            
            // Helper to get current active player safely
            const getActive = () => {
                return (this.game.teams.home && this.game.teams.home.activePlayer) 
                    ? this.game.teams.home.activePlayer 
                    : null;
            };

            // Proxy object to bind GUI to dynamic target
            const proxy = {
                get Role() { 
                    const p = getActive();
                    return p ? p.role : '-'; 
                },
                
                get GodMode() { 
                    const p = getActive();
                    return p ? p.isGodMode : false; 
                },
                set GodMode(v) { 
                    const p = getActive();
                    if(p) p.isGodMode = v; 
                },

                // Runtime Values
                get HP() { 
                    const p = getActive();
                    return p ? p.stats.HP : 0; 
                },
                set HP(v) { 
                    const p = getActive();
                    if(p) p.stats.HP = v; 
                },
                
                get CurrentEN() { 
                    const p = getActive();
                    return p ? p.currentEN : 0; 
                },
                set CurrentEN(v) { 
                    const p = getActive();
                    if(p) p.currentEN = v; 
                },

                // Base Stats
                get MaxHP() { 
                    const p = getActive();
                    return p ? p.stats.maxHP : 0; 
                },
                set MaxHP(v) { 
                    const p = getActive();
                    if(p) p.stats.maxHP = v; 
                },

                get SP() { 
                    const p = getActive();
                    return p ? p.stats.SP : 0; 
                },
                set SP(v) { 
                    const p = getActive();
                    if(p) { 
                        p.stats.SP = v; 
                        p._updateDerivedStats(); 
                    } 
                },

                get EN() { 
                    const p = getActive();
                    return p ? p.stats.EN : 0; 
                }, 
                set EN(v) { 
                    const p = getActive();
                    if(p) {
                        p.stats.EN = v;
                    }
                },

                get AT() { 
                    const p = getActive();
                    return p ? p.stats.AT : 0; 
                },
                set AT(v) { 
                    const p = getActive();
                    if(p) p.stats.AT = v; 
                },

                get PA() { 
                    const p = getActive();
                    return p ? p.stats.PA : 0; 
                },
                set PA(v) { 
                    const p = getActive();
                    if(p) p.stats.PA = v; 
                },

                get BL() { 
                    const p = getActive();
                    return p ? p.stats.BL : 0; 
                },
                set BL(v) { 
                    const p = getActive();
                    if(p) p.stats.BL = v; 
                },

                get SH() { 
                    const p = getActive();
                    return p ? p.stats.SH : 0; 
                },
                set SH(v) { 
                    const p = getActive();
                    if(p) p.stats.SH = v; 
                },

                get CA() { 
                    const p = getActive();
                    return p ? p.stats.CA : 0; 
                },
                set CA(v) { 
                    const p = getActive();
                    if(p) p.stats.CA = v; 
                },

                // Actions
                LevelUp: () => { 
                    const p = getActive();
                    if(p) p.levelUp(); 
                },
                FullHeal: () => { 
                    const p = getActive(); 
                    if(p) { 
                        p.stats.HP = p.stats.maxHP; 
                        p.currentEN = p.getStat('EN'); 
                        p.status.venom = 0; 
                        p.status.nap = 0; 
                        for(let k in p.status.wither) p.status.wither[k] = 0;
                        if(window.flux.gameInstance.floatingText) {
                            window.flux.gameInstance.floatingText.spawn("FULL HEAL", p.mesh.position, "heal");
                        }
                    } 
                },
                DrainEN: () => { 
                    const p = getActive();
                    if(p) {
                        p.currentEN = 0;
                        p.fumble(); // Trigger fumble logic
                    }
                }
            };

            folder.add(proxy, 'Role').listen().disable();
            folder.add(proxy, 'GodMode').name('God Mode (Inf HP/EN)').listen();

            const rtFolder = folder.addFolder('Runtime Status');
            rtFolder.add(proxy, 'HP', 0, 9999).listen();
            rtFolder.add(proxy, 'CurrentEN', 0, 100).name('Current EN').listen();

            const statFolder = folder.addFolder('Base Stats');
            statFolder.add(proxy, 'MaxHP', 100, 9999).listen();
            statFolder.add(proxy, 'EN', 0, 99).name('Max EN').listen();
            statFolder.add(proxy, 'SP', 0, 99).listen();
            statFolder.add(proxy, 'AT', 0, 99).listen();
            statFolder.add(proxy, 'PA', 0, 99).listen();
            statFolder.add(proxy, 'BL', 0, 99).listen();
            statFolder.add(proxy, 'SH', 0, 99).listen();
            statFolder.add(proxy, 'CA', 0, 99).listen();

            const actionFolder = folder.addFolder('Actions');
            actionFolder.add(proxy, 'LevelUp').name('Instant Level Up');
            actionFolder.add(proxy, 'FullHeal').name('Full Heal & Cure');
            actionFolder.add(proxy, 'DrainEN').name('Drain EN (Fumble)');
        }

_setupBallSandbox() {
    const root = this.gui.addFolder('Ball Lab (Throw & Physics)');

    // ------------------------------------------------------------
    // Shared state object (lives on window.flux so it survives reloads)
    // ------------------------------------------------------------
    const lab = window.flux.ballLab = window.flux.ballLab || {};
    lab.game = this.game;

    const C = window.flux.BallConfig;
    const TC = window.flux.ThrowConfig;

    if (!C || !TC) {
        console.warn("Ball Lab: Missing BallConfig or ThrowConfig.");
        return;
    }

    // ------------------------------------------------------------
    // Helpers
    // ------------------------------------------------------------
    const getBall = () => this.game && this.game.entities ? this.game.entities.ball : null;
    const getActive = () => this.game && this.game.teams && this.game.teams.home ? this.game.teams.home.activePlayer : null;

    const ensurePreviewLine = () => {
        if (lab.previewLine) return;
        if (!this.game || !this.game.scene) return;

        const geom = new THREE.BufferGeometry();
        const mat = new THREE.LineBasicMaterial({ transparent: true, opacity: 0.95 });
        const line = new THREE.Line(geom, mat);
        line.frustumCulled = false;
        line.renderOrder = 999;
        this.game.scene.add(line);
        lab.previewLine = line;
    };

    const clearPreviewLine = () => {
        if (lab.previewLine && lab.previewLine.geometry) {
            lab.previewLine.geometry.dispose();
            lab.previewLine.geometry = new THREE.BufferGeometry();
        }
    };

    // A safe "ghost ball" that can use Ball.updateFree without spawning FX
    const makeGhostBall = (pos, vel, spin) => {
        const gb = {
            mesh: { position: pos.clone() },
            velocity: vel.clone(),
            angularVelocity: (spin ? spin.clone() : new THREE.Vector3()),
            accumulatedRotation: new THREE.Quaternion(),
            power: 0,
            decayRate: 0,
            _bubbleTimer: 999,
            _ghost: true,
            deformNode: null
        };
        return gb;
    };

    // Use Ball.updateFree for faithful trajectory prediction
    const simulate = (ghostBall, steps, stepDt) => {
        const pts = [];
        pts.push(ghostBall.mesh.position.clone());
        const proto = window.flux.Ball && window.flux.Ball.prototype;
        if (!proto || typeof proto.updateFree !== 'function') return pts;

        for (let i = 0; i < steps; i++) {
            proto.updateFree.call(ghostBall, stepDt);
            pts.push(ghostBall.mesh.position.clone());
        }
        return pts;
    };

    // ------------------------------------------------------------
    // Preview + record/replay runtime loop
    // ------------------------------------------------------------
lab.preview = lab.preview || {
        enabled: false,
        source: 'Cannon',
        steps: 120,
        stepDt: 1/60,
        refreshHz: 10,
        showOnHeldOnly: false
    };

    lab.cannon = lab.cannon || {
        yaw: 0,
        pitch: 0,
        power: 20,
        type: 'SH',
        spinX: 0,
        spinY: 0,
        spinZ: 0,
        fireBurst: 1,
        spreadDeg: 0
    };

    lab.recording = lab.recording || {
        isRecording: false,
        frames: [],
        maxSeconds: 12
    };

    lab.replay = lab.replay || {
        isReplaying: false,
        frames: [],
        idx: 0,
        loop: true,
        speed: 1.0
    };

    lab.isReplaying = false;
    lab.targetBall = null;

    lab.applyReplayFrame = (ball, dt) => {
        const rep = lab.replay;
        if (!rep || !rep.isReplaying || !rep.frames || rep.frames.length === 0) {
            lab.isReplaying = false;
            return;
        }

        // Advance time by stepping indices (frame-based)
        const step = Math.max(1, Math.floor(rep.speed));
        rep.idx += step;

        if (rep.idx >= rep.frames.length) {
            if (rep.loop) rep.idx = 0;
            else { rep.isReplaying = false; lab.isReplaying = false; return; }
        }

        const f = rep.frames[rep.idx];
        if (!f) return;

        ball.drop(); // ensure no holder logic fights us
        ball.state = 'free';
        ball.mesh.position.set(f.px, f.py, f.pz);
        ball.velocity.set(f.vx, f.vy, f.vz);
        ball.angularVelocity.set(f.sx, f.sy, f.sz);
    };

    lab._previewTimer = lab._previewTimer || 0;

    lab.update = (dt) => {
        // --- recording ---
        const b = getBall();
        if (b && lab.recording && lab.recording.isRecording) {
            const r = lab.recording;
            const maxFrames = Math.floor((r.maxSeconds || 12) / (dt || (1/60)));
            if (r.frames.length > maxFrames) r.frames.shift();
            r.frames.push({
                px: b.mesh.position.x, py: b.mesh.position.y, pz: b.mesh.position.z,
                vx: b.velocity.x, vy: b.velocity.y, vz: b.velocity.z,
                sx: b.angularVelocity.x, sy: b.angularVelocity.y, sz: b.angularVelocity.z
            });
        }

        // --- preview refresh ---
        lab._previewTimer += dt;
        const refreshInterval = 1.0 / Math.max(1, (lab.preview.refreshHz || 10));
        if (lab.preview.enabled && lab._previewTimer >= refreshInterval) {
            lab._previewTimer = 0;
            lab.refreshPreview();
        }
    };

    lab.refreshPreview = () => {
        if (!lab.preview.enabled) { clearPreviewLine(); return; }
        ensurePreviewLine();

        const b = getBall();
        const p = getActive();
        if (!b || !b.mesh) return;

        if (lab.preview.showOnHeldOnly && b.state !== 'held') {
            clearPreviewLine();
            return;
        }

        // Decide preview source
        let startPos = b.mesh.position;
        let startVel = b.velocity;
        let startSpin = b.angularVelocity;

        if (lab.preview.source === 'Cannon') {
            // Cannon always launches from ball position (or player if held)
            const yawRad = (lab.cannon.yaw || 0) * Math.PI / 180;
            const pitchRad = (lab.cannon.pitch || 0) * Math.PI / 180;

            const dir = new THREE.Vector3(
                Math.sin(yawRad) * Math.cos(pitchRad),
                Math.sin(pitchRad),
                -Math.cos(yawRad) * Math.cos(pitchRad)
            ).normalize();

            const cap = (window.flux.BallConfig.LAUNCH_SPEED_CAP !== undefined ? window.flux.BallConfig.LAUNCH_SPEED_CAP : 85.0);
            const scale = (window.flux.BallConfig.LAUNCH_SPEED_SCALE !== undefined ? window.flux.BallConfig.LAUNCH_SPEED_SCALE : 1.0);
            const speed = Math.min((lab.cannon.power || 20) * scale, cap);

            startPos = (b.state === 'held' && p && p.mesh) ? p.mesh.position.clone().add(new THREE.Vector3(0, 1.2, 0)) : b.mesh.position.clone();
            startVel = dir.multiplyScalar(speed);
            startSpin = new THREE.Vector3(lab.cannon.spinX || 0, lab.cannon.spinY || 0, lab.cannon.spinZ || 0);
        }

        const ghost = makeGhostBall(startPos.clone(), startVel.clone(), startSpin);
        const pts = simulate(ghost, Math.floor(lab.preview.steps || 120), (lab.preview.stepDt || (1/60)));

        if (lab.previewLine) {
            lab.previewLine.geometry.dispose();
            lab.previewLine.geometry = new THREE.BufferGeometry().setFromPoints(pts);
        }
    };

    // ------------------------------------------------------------
    // Folder: Ball Physics (BallConfig)
    // ------------------------------------------------------------
    const phys = root.addFolder('Ball Physics (BallConfig)');

    const integ = phys.addFolder('Integration');
    integ.add(C, 'SUBSTEPS', 1, 12, 1).name('Substeps');
    integ.add(C, 'STOP_SPEED', 0.0, 0.2).name('Stop Speed');

    const drag = phys.addFolder('Water Drag');
    drag.add(C, 'WATER_DRAG_LINEAR', 0.0, 2.0).name('Linear Drag');
    drag.add(C, 'WATER_DRAG_QUAD', 0.0, 0.05).name('Quadratic Drag');

    const spin = phys.addFolder('Spin');
    spin.add(C, 'SPIN_DRAG', 0.0, 3.0).name('Spin Decay');

    const magnus = phys.addFolder('Magnus');
    magnus.add(C, 'MAGNUS_ENABLED').name('Enabled');
    magnus.add(C, 'MAGNUS_COEFF', 0.0, 0.5).name('Coeff');
    magnus.add(C, 'MAGNUS_CAP', 0.0, 200.0).name('Cap');

    const depth = phys.addFolder('Depth Constraint');
    depth.add(C, 'DEPTH_TARGET_Y', -5.0, 5.0).name('Target Y');
    depth.add(C, 'DEPTH_SPRING', 0.0, 10.0).name('Spring');
    depth.add(C, 'DEPTH_DAMP', 0.0, 6.0).name('Damp');

    const arena = phys.addFolder('Arena Boundary');
    arena.add(C, 'BOUNDARY_RADIUS', 10.0, 120.0).name('Radius');
    arena.add(C, 'BOUNDARY_HEIGHT', 2.0, 40.0).name('Height');
    arena.add(C, 'WALL_SOFT_BUFFER', 0.0, 20.0).name('Soft Buffer');
    arena.add(C, 'WALL_SOFT_FORCE', 0.0, 200.0).name('Soft Force');
    arena.add(C, 'WALL_ELASTICITY', 0.0, 1.0).name('Wall Bounce');
    arena.add(C, 'WALL_FRICTION', 0.0, 1.0).name('Wall Friction');
    arena.add(C, 'FLOOR_ELASTICITY', 0.0, 1.0).name('Ceil/Floor Bounce');

    const pocket = arena.addFolder('Goal Pocket');
    pocket.add(C, 'GOAL_POCKET_ENABLED').name('Enabled');
    pocket.add(C, 'GOAL_POCKET_X', 0.0, 40.0).name('Pocket Half-X');
    pocket.add(C, 'GOAL_POCKET_Z', 0.0, 50.0).name('Pocket Start |Z|');
    pocket.add(C, 'GOAL_POCKET_RADIUS', 10.0, 120.0).name('Pocket Radius');

    const launch = phys.addFolder('Launch Mapping');
    launch.add(C, 'LAUNCH_SPEED_SCALE', 0.1, 5.0).name('Speed Scale');
    launch.add(C, 'LAUNCH_SPEED_CAP', 10.0, 200.0).name('Speed Cap');

    // ------------------------------------------------------------
    // Folder: Throw mapping (Player.releaseCharge -> Ball.shoot)
    // ------------------------------------------------------------
    const throwMap = root.addFolder('Throw Mapping (ThrowConfig)');
    throwMap.add(TC, 'SWIPE_MIN_PX', 0, 120, 1).name('Swipe Min PX');
    throwMap.add(TC, 'AIM_DX_SCALE', 0.1, 5.0).name('Aim X Scale');
    throwMap.add(TC, 'AIM_DY_SCALE', 0.1, 5.0).name('Aim Y Scale');
    throwMap.add(TC, 'POWER_BASE', 0.1, 3.0).name('Power Base');
    throwMap.add(TC, 'POWER_RANGE', 0.0, 3.0).name('Power Range');
    throwMap.add(TC, 'POWER_MAX_BONUS_RATIO', 0.0, 1.0).name('Max Bonus Ratio');
    throwMap.add(TC, 'POWER_MAX_MULTIPLIER', 1.0, 6.0).name('Max Multiplier');

    const curveMap = throwMap.addFolder('Curve');
    curveMap.add(TC, 'CURVE_ENABLED').name('Enabled');
    curveMap.add(TC, 'CURVE_INTENSITY_THRESHOLD', 0.0, 1.0).name('Input Threshold');
    curveMap.add(TC, 'CURVE_SPIN_SCALE', 0.0, 4000.0).name('Spin Scale');
    curveMap.add(TC, 'CURVE_SPEED_MULT', 0.0, 5.0).name('Swipe Speed Mult');
    curveMap.add(TC, 'CURVE_SPIN_CAP', 0.0, 6000.0).name('Spin Cap');
    curveMap.add(TC, 'CURVE_PERFECT_SPIN', 0.0, 2000.0).name('Perfect Threshold');

    // ------------------------------------------------------------
    // Folder: Teleport / State tools
    // ------------------------------------------------------------
    const tp = root.addFolder('Teleport / Reset');
    const tpParams = {
        ToCenter: () => { const b = getBall(); if (b) b.reset(); },
        ToActivePlayer: () => { const b = getBall(); const p = getActive(); if (b && p) b.grab(p); },
        ToHomeGoal: () => { const b = getBall(); if (b) { b.drop(); b.mesh.position.set(0, 0, 25); b.velocity.set(0,0,0); b.angularVelocity.set(0,0,0); } },
        ToAwayGoal: () => { const b = getBall(); if (b) { b.drop(); b.mesh.position.set(0, 0, -25); b.velocity.set(0,0,0); b.angularVelocity.set(0,0,0); } },
        ToSky: () => { const b = getBall(); if (b) { b.drop(); b.mesh.position.set(0, 10, 0); b.velocity.set(0,0,0); b.angularVelocity.set(0,0,0); } },
        ClearPreview: () => clearPreviewLine()
    };
    tp.add(tpParams, 'ToCenter');
    tp.add(tpParams, 'ToActivePlayer');
    tp.add(tpParams, 'ToHomeGoal');
    tp.add(tpParams, 'ToAwayGoal');
    tp.add(tpParams, 'ToSky');
    tp.add(tpParams, 'ClearPreview');

    // ------------------------------------------------------------
    // Folder: Shot Cannon (force fire with params)
    // ------------------------------------------------------------
    const cannon = root.addFolder('Shot Cannon');
    cannon.add(lab.cannon, 'yaw', -180, 180, 1).name('Yaw (deg)');
    cannon.add(lab.cannon, 'pitch', -89, 89, 1).name('Pitch (deg)');
    cannon.add(lab.cannon, 'power', 0, 120, 0.1).name('Power');
    cannon.add(lab.cannon, 'type', ['PA','SH']).name('Type');
    cannon.add(lab.cannon, 'spinX', -3000, 3000, 1).name('Spin X');
    cannon.add(lab.cannon, 'spinY', -3000, 3000, 1).name('Spin Y');
    cannon.add(lab.cannon, 'spinZ', -3000, 3000, 1).name('Spin Z');
    cannon.add(lab.cannon, 'fireBurst', 1, 10, 1).name('Burst Count');
    cannon.add(lab.cannon, 'spreadDeg', 0, 30, 0.5).name('Spread (deg)');

    const fireParams = {
        Fire: () => {
            const b = getBall();
            const p = getActive();
            if (!b) return;

            const yawRad = (lab.cannon.yaw || 0) * Math.PI / 180;
            const pitchRad = (lab.cannon.pitch || 0) * Math.PI / 180;

            const baseDir = new THREE.Vector3(
                Math.sin(yawRad) * Math.cos(pitchRad),
                Math.sin(pitchRad),
                -Math.cos(yawRad) * Math.cos(pitchRad)
            ).normalize();

            const start = (b.state === 'held' && p && p.mesh) ? p.mesh.position.clone().add(new THREE.Vector3(0, 1.2, 0)) : b.mesh.position.clone();

            for (let i = 0; i < (lab.cannon.fireBurst || 1); i++) {
                const dir = baseDir.clone();
                if (lab.cannon.spreadDeg > 0) {
                    const spread = (lab.cannon.spreadDeg * Math.PI / 180);
                    dir.x += (Math.random()-0.5) * spread;
                    dir.y += (Math.random()-0.5) * spread;
                    dir.z += (Math.random()-0.5) * spread;
                    dir.normalize();
                }

                b.drop();
                b.mesh.position.copy(start);
                b.velocity.set(0,0,0);
                b.angularVelocity.set(0,0,0);

                const spin = new THREE.Vector3(lab.cannon.spinX || 0, lab.cannon.spinY || 0, lab.cannon.spinZ || 0);
                b.shoot(dir, lab.cannon.power || 20, lab.cannon.type || 'SH', null, spin);
            }
        }
    };
    cannon.add(fireParams, 'Fire');

    // ------------------------------------------------------------
    // Folder: Trajectory Preview
    // ------------------------------------------------------------
    const preview = root.addFolder('Trajectory Preview');
    preview.add(lab.preview, 'enabled').name('Enabled').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'source', ['Cannon', 'Live Ball']).name('Source').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'steps', 10, 600, 1).name('Steps').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'stepDt', 1/240, 1/15, 1/240).name('Step dt').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'refreshHz', 1, 60, 1).name('Refresh Hz');
    preview.add(lab.preview, 'showOnHeldOnly').name('Only when Held').onChange(() => lab.refreshPreview());

    const previewBtns = {
        Refresh: () => lab.refreshPreview(),
        Hide: () => { lab.preview.enabled = false; clearPreviewLine(); }
    };
    preview.add(previewBtns, 'Refresh');
    preview.add(previewBtns, 'Hide');

    // ------------------------------------------------------------
    // Folder: Record / Replay
    // ------------------------------------------------------------
    const rr = root.addFolder('Record / Replay');
    const rrParams = {
        Record: () => {
            lab.recording.isRecording = true;
            lab.recording.frames = [];
        },
        Stop: () => {
            lab.recording.isRecording = false;
        },
        UseRecordingForReplay: () => {
            lab.replay.frames = (lab.recording.frames || []).slice();
            lab.replay.idx = 0;
        },
        Play: () => {
            const b = getBall();
            if (!b) return;
            lab.replay.isReplaying = true;
            lab.isReplaying = true;
            lab.targetBall = b;
            lab.replay.idx = 0;
        },
        Pause: () => {
            lab.replay.isReplaying = false;
            lab.isReplaying = false;
        },
        Clear: () => {
            lab.recording.frames = [];
            lab.replay.frames = [];
            lab.replay.idx = 0;
            lab.replay.isReplaying = false;
            lab.isReplaying = false;
        }
    };
    rr.add(rrParams, 'Record');
    rr.add(rrParams, 'Stop');
    rr.add(rrParams, 'UseRecordingForReplay').name('Copy Rec -> Replay');
    rr.add(lab.replay, 'loop').name('Loop');
    rr.add(lab.replay, 'speed', 0.25, 6.0, 0.25).name('Replay Speed');
    rr.add(rrParams, 'Play');
    rr.add(rrParams, 'Pause');
    rr.add(rrParams, 'Clear');

    // ------------------------------------------------------------
    // Folder: Presets
    // ------------------------------------------------------------
    const presets = root.addFolder('Presets');
    const P = {
        Vanilla: () => {
            Object.assign(C, {
                SUBSTEPS: 2,
                STOP_SPEED: 0.02,
                WATER_DRAG_LINEAR: 0.15,
                WATER_DRAG_QUAD: 0.002,
                SPIN_DRAG: 0.40,
                MAGNUS_ENABLED: true,
                MAGNUS_COEFF: 0.08,
                MAGNUS_CAP: 60.0,
                DEPTH_TARGET_Y: 0.0,
                DEPTH_SPRING: 1.0,
                DEPTH_DAMP: 1.5,
                BOUNDARY_RADIUS: 33.0,
                BOUNDARY_HEIGHT: 15.0,
                WALL_SOFT_BUFFER: 3.0,
                WALL_SOFT_FORCE: 20.0,
                WALL_ELASTICITY: 0.30,
                WALL_FRICTION: 0.95,
                FLOOR_ELASTICITY: 0.40,
                GOAL_POCKET_ENABLED: true,
                GOAL_POCKET_X: 12.0,
                GOAL_POCKET_Z: 25.0,
                GOAL_POCKET_RADIUS: 45.0,
                LAUNCH_SPEED_SCALE: 1.0,
                LAUNCH_SPEED_CAP: 85.0
            });
            lab.refreshPreview();
        },
        ArcadeCurve: () => {
            Object.assign(C, {
                MAGNUS_ENABLED: true,
                MAGNUS_COEFF: 0.16,
                MAGNUS_CAP: 90.0,
                SPIN_DRAG: 0.25,
                WATER_DRAG_LINEAR: 0.12,
                WATER_DRAG_QUAD: 0.001,
                WALL_SOFT_FORCE: 35.0,
                LAUNCH_SPEED_CAP: 110.0
            });
            Object.assign(TC, {
                CURVE_ENABLED: true,
                CURVE_SPIN_SCALE: 1500.0,
                CURVE_SPIN_CAP: 3000.0,
                CURVE_PERFECT_SPIN: 700.0
            });
            lab.refreshPreview();
        },
        SnappyRealistic: () => {
            Object.assign(C, {
                WATER_DRAG_LINEAR: 0.25,
                WATER_DRAG_QUAD: 0.006,
                MAGNUS_COEFF: 0.05,
                MAGNUS_CAP: 40.0,
                SPIN_DRAG: 0.75,
                STOP_SPEED: 0.05,
                LAUNCH_SPEED_CAP: 70.0
            });
            lab.refreshPreview();
        }
    };
    presets.add(P, 'Vanilla');
    presets.add(P, 'ArcadeCurve');
    presets.add(P, 'SnappyRealistic');

    // ------------------------------------------------------------
    // Folder: Snapshot / Export
    // ------------------------------------------------------------
    const snapshot = root.addFolder('Snapshot / Export');

    const _round = (n, places = 4) => {
        if (!Number.isFinite(n)) return null;
        const p = Math.pow(10, places);
        return Math.round(n * p) / p;
    };

    const _v3 = (v, places = 4) => {
        if (!v) return null;
        return [_round(v.x, places), _round(v.y, places), _round(v.z, places)];
    };

    const _cloneJson = (obj) => {
        if (!obj) return null;
        try { return JSON.parse(JSON.stringify(obj)); } catch (e) { return null; }
    };

    const _playerSnap = (p) => {
        if (!p) return null;
        const anim = (p.activeAction && p.activeAction._clip) ? p.activeAction._clip.name : (p.state || null);
        return {
            name: p.characterName || p.name || null,
            role: p.role || null,
            state: p.state || null,
            hasBall: !!p.hasBall,
            isThrowing: !!p.isThrowing,
            isCharging: !!p.isCharging,
            isDashing: !!p.isDashing,
            dashCooldown: _round(p.dashCooldown, 4),
            pos: _v3(p.mesh && p.mesh.position),
            vel: _v3(p.velocity),
            input: _v3(p.inputVector),
            stats: p.stats ? _cloneJson(p.stats) : null,
            anim
        };
    };

    const _teamSnap = (t) => {
        if (!t) return null;
        const active = t.activePlayer ? _playerSnap(t.activePlayer) : null;
        return {
            id: t.id || null,
            side: t.side,
            isHuman: !!t.isHuman,
            aiEnabled: !!t.aiEnabled,
            currentFormation: t.currentFormation || null,
            activePlayer: active,
            players: Array.isArray(t.players) ? t.players.map(_playerSnap) : []
        };
    };

    const buildSnapshot = () => {
        const game = this.game || window.flux.gameInstance || null;
        const ball = game && game.entities ? game.entities.ball : null;
        const camMgr = game ? game.cameraManager : null;
        const cam = (camMgr && camMgr.camera) ? camMgr.camera : (game ? game.camera : null);

        const ballSnap = ball ? {
            state: ball.state || null,
            isInvisible: !!ball.isInvisible,
            holder: ball.holder ? (ball.holder.characterName || ball.holder.name || null) : null,
            lastHolder: ball.lastHolder ? (ball.lastHolder.characterName || ball.lastHolder.name || null) : null,
            pos: _v3(ball.mesh && ball.mesh.position),
            vel: _v3(ball.velocity),
            angVel: _v3(ball.angularVelocity),
            power: _round(ball.power, 4),
            shotType: ball.shotType || null
        } : null;

        const cameraSnap = cam ? {
            pos: _v3(cam.position),
            rot: cam.rotation ? [_round(cam.rotation.x, 4), _round(cam.rotation.y, 4), _round(cam.rotation.z, 4)] : null,
            fov: _round(cam.fov, 4),
            near: _round(cam.near, 6),
            far: _round(cam.far, 4)
        } : null;

        const camMgrSnap = camMgr ? {
            mode: camMgr.mode || null,
            targetName: (camMgr.target && (camMgr.target.characterName || camMgr.target.name)) || null,
            settings: camMgr.settings ? _cloneJson(camMgr.settings) : null
        } : null;

        const debugIO = window.flux && window.flux._debugIO ? window.flux._debugIO : null;
        const inputSnap = debugIO ? {
            settings: debugIO.settings ? _cloneJson(debugIO.settings) : null,
            perf: debugIO.perf ? _cloneJson(debugIO.perf) : null,
            move: (debugIO.input && debugIO.input.move) ? {
                touchId: debugIO.input.move.touchId ?? null,
                dragging: !!debugIO.input.move.dragging,
                vector: debugIO.input.move.vector ? _cloneJson(debugIO.input.move.vector) : null
            } : null,
            aim: (debugIO.input && debugIO.input.aim) ? {
                touchId: debugIO.input.aim.touchId ?? null,
                dragging: !!debugIO.input.aim.dragging,
                vector: debugIO.input.aim.vector ? _cloneJson(debugIO.input.aim.vector) : null
            } : null,
            swipe: (debugIO.input && debugIO.input.swipe) ? {
                touchId: debugIO.input.swipe.touchId ?? null,
                start: debugIO.input.swipe.start ? _cloneJson(debugIO.input.swipe.start) : null,
                points: Array.isArray(debugIO.input.swipe.points) ? debugIO.input.swipe.points.slice(-32).map(_cloneJson) : []
            } : null
        } : null;

        return {
            meta: {
                timestampISO: new Date().toISOString(),
                href: (typeof location !== 'undefined' && location.href) ? location.href : null,
                userAgent: (typeof navigator !== 'undefined' && navigator.userAgent) ? navigator.userAgent : null
            },
            game: game ? {
                score: game.score ? _cloneJson(game.score) : null,
                time: _round(game.time, 4),
                half: game.half ?? null,
                halfDuration: _round(game.halfDuration, 4),
                isOvertime: !!game.isOvertime,
                isDemoMode: !!game.isDemoMode
            } : null,
            config: {
                BallConfig: (window.flux && window.flux.BallConfig) ? _cloneJson(window.flux.BallConfig) : null,
                ThrowConfig: (window.flux && window.flux.ThrowConfig) ? _cloneJson(window.flux.ThrowConfig) : null
            },
            camera: cameraSnap,
            cameraManager: camMgrSnap,
            ball: ballSnap,
            teams: game ? {
                home: _teamSnap(game.teams && game.teams.home),
                away: _teamSnap(game.teams && game.teams.away)
            } : null,
            input: inputSnap
        };
    };

    const _copyText = async (text) => {
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
                return true;
            }
        } catch (e) {}
        // Fallback
        try {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            ta.style.top = '-9999px';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            return ok;
        } catch (e) {}
        return false;
    };

    const _downloadText = (filename, text) => {
        try {
            const blob = new Blob([text], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        } catch (e) {
            console.warn('Snapshot download failed:', e);
        }
    };

    const snapshotActions = {
        CopySnapshot: async () => {
            const snap = buildSnapshot();
            const text = JSON.stringify(snap, null, 2);
            const ok = await _copyText(text);
            console.log('[Snapshot]', snap);
            if (!ok) console.warn('Snapshot: copy failed (see console).');
        },
        DownloadSnapshot: () => {
            const snap = buildSnapshot();
            const text = JSON.stringify(snap, null, 2);
            _downloadText('snapshot.json', text);
            console.log('[Snapshot]', snap);
        }
    };

    snapshot.add(snapshotActions, 'CopySnapshot').name('Copy JSON Snapshot');
    snapshot.add(snapshotActions, 'DownloadSnapshot').name('Download snapshot.json');

}
    }

window.flux.DevTools = DevTools;

    DevTools.prototype._setupVisualDebug = function() {
        const folder = this.gui.addFolder('Visual Debugging');
        const dv = this.game.debugVisualizer;
        if (!dv) return;

        const params = {
            enabled: dv.enabled,
            hitboxes: dv.showHitboxes,
            vectors: dv.showVectors,
            ai: dv.showAI
        };

        folder.add(params, 'enabled').name('Enable Visualizer').onChange(v => dv.enabled = v);
        folder.add(params, 'hitboxes').name('Show Hitboxes').onChange(v => dv.showHitboxes = v);
        folder.add(params, 'vectors').name('Show Vectors').onChange(v => dv.showVectors = v);
        folder.add(params, 'ai').name('Show AI Perception').onChange(v => dv.showAI = v);
    };

    DevTools.prototype._setupFXLab = function() {
        const folder = this.gui.addFolder('FX Lab & UI Test');
        
        const getTargetPos = () => {
            const p = this.game.teams.home.activePlayer;
            return p && p.mesh ? p.mesh.position : new THREE.Vector3(0, 2, 0);
        };

        const fxParams = {
            SpawnVenom: () => this.game.particleManager.spawn('venom', getTargetPos()),
            SpawnNap: () => this.game.particleManager.spawn('nap', getTargetPos()),
            SpawnWither: () => this.game.particleManager.spawn('wither', getTargetPos()),
            SpawnLearned: () => this.game.particleManager.spawn('learned', getTargetPos()),
            SpawnClash: () => this.game.spawnClash(getTargetPos()),
        };

        const fxSub = folder.addFolder('Particles');
        fxSub.add(fxParams, 'SpawnVenom');
        fxSub.add(fxParams, 'SpawnNap');
        fxSub.add(fxParams, 'SpawnWither');
        fxSub.add(fxParams, 'SpawnLearned');
        fxSub.add(fxParams, 'SpawnClash');

        const txtParams = {
            Text: "TEST",
            Type: "damage",
            Spawn: () => {
                if(this.game.floatingText) 
                    this.game.floatingText.spawn(txtParams.Text, getTargetPos(), txtParams.Type);
            }
        };
        
        const txtSub = folder.addFolder('Floating Text');
        txtSub.add(txtParams, 'Text');
        txtSub.add(txtParams, 'Type', ['damage', 'heal', 'status', 'tech', 'comic-impact', 'comic-action', 'save', 'block', 'default']);
        txtSub.add(txtParams, 'Spawn').name('Spawn Text');

        const camParams = {
            ShakeSmall: () => this.game.cameraManager.addShake(0.5),
            ShakeBig: () => this.game.cameraManager.addShake(2.0),
            ImpactLight: () => this.game.triggerImpact(0.1, 'default'),
            ImpactHeavy: () => this.game.triggerImpact(0.2, 'heavy'),
            ImpactShatter: () => this.game.triggerImpact(0.4, 'shatter'),
        };

        const camSub = folder.addFolder('Camera & Impact');
        camSub.add(camParams, 'ShakeSmall');
        camSub.add(camParams, 'ShakeBig');
        camSub.add(camParams, 'ImpactLight');
        camSub.add(camParams, 'ImpactHeavy');
        camSub.add(camParams, 'ImpactShatter');
    };


DevTools.prototype._setupVisuals = function() {
        const folder = this.gui.addFolder('Asset Forge');
        
        const forgeState = {
            active: false,
            assetName: 'Tidus',
            animName: 'idle',
            posX: 0, posY: 0, posZ: 0,
            rotX: 0, rotY: 0, rotZ: 0,
            scale: 1.0,
            camDist: 5, camHeight: 1.5, camRot: 0
        };

        const assets = {
            'Tidus': 'https://cdn.tinyglb.com/models/da788bef258c4f0b8d9ef1acc19c5567.glb',
            'Wakka': 'https://cdn.tinyglb.com/models/59114c98951647c9b8da74b0bd3636cb.glb',
            'Letty': 'https://cdn.tinyglb.com/models/43ace34c6fd94215967e842bf909da5e.glb',
            'Datto': 'https://cdn.tinyglb.com/models/e6d67ecb2e4c4715bd73a40795e1d3d5.glb',
            'Jassu': 'https://cdn.tinyglb.com/models/8216459567354e63958d4108d828de98.glb',
            'Botta': 'https://cdn.tinyglb.com/models/ad155efedc0d48fdad09da3e1cae9c97.glb',
            'Ball': 'https://cdn.tinyglb.com/models/521ae8788e584e378a79d9732a075356.glb',
            'Goal': 'https://cdn.tinyglb.com/models/a516bd90fa7c4dedb5dcbfdf803f13d5.glb'
        };

        let currentAsset = null;

        const updateTransform = () => {
            if (currentAsset) {
                currentAsset.position.set(forgeState.posX, forgeState.posY, forgeState.posZ);
                currentAsset.rotation.set(forgeState.rotX, forgeState.rotY, forgeState.rotZ);
                currentAsset.scale.setScalar(forgeState.scale);
            }
        };

        const updateCamera = () => {
            if (!forgeState.active) return;
            // Orbit around (1000, Y, 1000)
            const cx = 1000 + Math.sin(forgeState.camRot) * forgeState.camDist;
            const cz = 1000 + Math.cos(forgeState.camRot) * forgeState.camDist;
            this.game.camera.position.set(cx, forgeState.camHeight, cz);
            this.game.camera.lookAt(1000, forgeState.posY + 1, 1000);
        };

        const playAnimation = () => {
            if (!this.vizMixer || !this.vizClips) return;
            this.vizMixer.stopAllAction();
            if (forgeState.animName === 'none') return;
            
            let clip = this.vizClips.find(c => c.name === forgeState.animName);
            if (!clip) clip = this.vizClips.find(c => c.name.toLowerCase().includes(forgeState.animName.toLowerCase()));
            if (clip) this.vizMixer.clipAction(clip).play();
        };

        const spawnAsset = () => {
            if (!this.vizGroup) return;
            
            // Clear previous
            while(this.vizGroup.children.length > 0) {
                const child = this.vizGroup.children[0];
                this.vizGroup.remove(child);
            }
            
            this.vizMixer = null;
            currentAsset = null;

            const url = assets[forgeState.assetName];
            if (!url) return;

            console.log("Forge: Spawning", forgeState.assetName);

            window.flux.AssetLoader.loadModel(url, (gltf) => {
                // Check if we are still in forge mode before adding
                if (!forgeState.active) return;

                const model = gltf.scene;
                this.vizGroup.add(model);
                currentAsset = model;
                
                // Reset model transform relative to group
                model.position.set(0,0,0);
                model.rotation.set(0,0,0);
                
                updateTransform();

                if (gltf.animations && gltf.animations.length > 0) {
                    this.vizMixer = new THREE.AnimationMixer(model);
                    this.vizClips = gltf.animations;
                    playAnimation();
                }
            });
        };

        const toggleForge = (isActive) => {
            forgeState.active = isActive;
            this.game.isForgeMode = isActive; // Critical: Tell main.js to stop game loop
            
            // Toggle Game Visibility (Hide everything in the main arena)
            const gameLayer = [this.game.teams.home, this.game.teams.away, this.game.entities.ball];
            gameLayer.forEach(t => {
                if(t && t.players) t.players.forEach(p => { if(p.mesh) p.mesh.visible = !isActive; });
                else if(t && t.mesh) t.mesh.visible = !isActive;
            });
            if(window.flux.arenaMesh) window.flux.arenaMesh.visible = !isActive;
            if(window.flux.arenaMesh2) window.flux.arenaMesh2.visible = !isActive;
            if(this.game.stadium && this.game.stadium.container) this.game.stadium.container.visible = !isActive;
            if(this.game.waterOverlay && this.game.waterOverlay.mesh) this.game.waterOverlay.mesh.visible = !isActive;
            
            // Hide UI
            const ui = document.getElementById('ui-layer');
            if(ui) ui.style.display = isActive ? 'none' : 'flex';

            if (isActive) {
                // Initialize Forge Scene if needed
                if (!this.vizGroupParent) {
                    this.vizGroupParent = new THREE.Group();
                    this.game.scene.add(this.vizGroupParent);
                    
                    this.vizGroup = new THREE.Group();
                    this.vizGroup.position.set(1000, 0, 1000); // Far away from arena
                    this.vizGroupParent.add(this.vizGroup);

                    const grid = new THREE.GridHelper(20, 20, 0x00ffff, 0x444444);
                    grid.position.set(1000, 0, 1000);
                    this.vizGroupParent.add(grid);

                    this.vizLight = new THREE.DirectionalLight(0xffffff, 1.0);
                    this.vizLight.position.set(1005, 10, 1005);
                    this.game.scene.add(this.vizLight);
                    
                    this.vizAmbient = new THREE.AmbientLight(0x404040);
                    this.game.scene.add(this.vizAmbient);
                }
                
                this.vizGroupParent.visible = true;
                this.vizLight.visible = true;
                this.vizAmbient.visible = true;
                
                spawnAsset();
                updateCamera();
                
            } else {
                // Restore Game
                if (this.vizGroupParent) this.vizGroupParent.visible = false;
                if (this.vizLight) this.vizLight.visible = false;
                if (this.vizAmbient) this.vizAmbient.visible = false;
                
                // Snap camera back to game target
                if (this.game.cameraManager) this.game.cameraManager.snapToTarget();
            }
        };

        folder.add(forgeState, 'active').name('Enable Forge').onChange(toggleForge);
        folder.add(forgeState, 'assetName', Object.keys(assets)).name('Select Asset').onChange(spawnAsset);
        
        const tf = folder.addFolder('Transform');
        tf.add(forgeState, 'posX', -5, 5).onChange(updateTransform);
        tf.add(forgeState, 'posY', -5, 5).onChange(updateTransform);
        tf.add(forgeState, 'posZ', -5, 5).onChange(updateTransform);
        tf.add(forgeState, 'rotX', 0, 6.28).onChange(updateTransform);
        tf.add(forgeState, 'rotY', 0, 6.28).onChange(updateTransform);
        tf.add(forgeState, 'rotZ', 0, 6.28).onChange(updateTransform);
        tf.add(forgeState, 'scale', 0.1, 3.0).onChange(updateTransform);

        folder.add(forgeState, 'animName', ['none', 'idle', 'swim', 'throw', 'catch', 'react']).name('Animation').onChange(playAnimation);

        const cf = folder.addFolder('Camera');
        cf.add(forgeState, 'camDist', 2, 15).onChange(updateCamera);
        cf.add(forgeState, 'camHeight', 0, 10).onChange(updateCamera);
        cf.add(forgeState, 'camRot', 0, 6.28).onChange(updateCamera);

        // Hook Game Loop
        const originalUpdate = this.game.update.bind(this.game);
        this.game.update = (dt) => {
            if (forgeState.active) {
                // Forge Mode: Only update forge components and render
                if (this.vizMixer) this.vizMixer.update(dt);
                
                // Force Camera Update here since main.js loop is skipped
                updateCamera();

                if (this.game.renderer && this.game.scene && this.game.camera) {
                    this.game.renderer.render(this.game.scene, this.game.camera);
                }
            } else {
                // Normal Mode: Run standard game update
                originalUpdate(dt);
            }
        };
    };
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class DebugVisualizer {
        constructor(scene) {
            this.scene = scene;
            this.enabled = false;
            this.showHitboxes = false;
            this.showVectors = false;
            this.showAI = false;

            this.visuals = new Map();
            
            // Materials
            this.matTackle = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true, transparent: true, opacity: 0.2 });
            this.matCatch = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true, transparent: true, opacity: 0.2 });
            this.matVel = new THREE.LineBasicMaterial({ color: 0xffff00 }); // Yellow Velocity
            this.matInput = new THREE.LineBasicMaterial({ color: 0x00ffff }); // Cyan Input
            this.matAI = new THREE.LineBasicMaterial({ color: 0xff00ff }); // Magenta AI Perception
            
            // Geometries
            this.geoCylinder = new THREE.CylinderGeometry(1, 1, 0.1, 16);
            this.geoCylinder.translate(0, 0.05, 0);
        }

        update() {
            if (!this.enabled) {
                if (this.visuals.size > 0) this.clear();
                return;
            }

            const game = window.flux.gameInstance;
            if (!game || !game.teams.home) return;

            const entities = [
                ...game.teams.home.players,
                ...game.teams.away.players,
                game.entities.ball
            ];

            entities.forEach(e => {
                if (!e || !e.mesh) return;
                
                let v = this.visuals.get(e);
                if (!v) {
                    v = this.createVisual(e);
                    this.visuals.set(e, v);
                }
                this.updateVisual(e, v);
            });
        }

        createVisual(entity) {
            const group = new THREE.Group();
            this.scene.add(group);

            // Hitboxes
            const tackle = new THREE.Mesh(this.geoCylinder, this.matTackle);
            const catchR = new THREE.Mesh(this.geoCylinder, this.matCatch);
            group.add(tackle);
            group.add(catchR);

            // Lines
            const velLine = this.createLine(this.matVel);
            const inputLine = this.createLine(this.matInput);
            const aiLine = this.createLine(this.matAI); // Line to perceived target
            
            group.add(velLine);
            group.add(inputLine);
            group.add(aiLine);

            return { group, tackle, catchR, velLine, inputLine, aiLine };
        }

        createLine(mat) {
            const geo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(), new THREE.Vector3()]);
            return new THREE.Line(geo, mat);
        }

        updateLine(line, start, end) {
            const pos = line.geometry.attributes.position.array;
            pos[0] = start.x; pos[1] = start.y; pos[2] = start.z;
            pos[3] = end.x; pos[4] = end.y; pos[5] = end.z;
            line.geometry.attributes.position.needsUpdate = true;
            line.visible = true;
        }

        updateVisual(e, v) {
            v.group.visible = true;
            
            // Hitboxes (Local to entity position)
            v.tackle.position.copy(e.mesh.position);
            v.catchR.position.copy(e.mesh.position);
            
            if (this.showHitboxes && e.role) {
                v.tackle.visible = true;
                const rT = e.tackleRadius || 2.5;
                v.tackle.scale.set(rT, 1, rT);

                v.catchR.visible = true;
                // Logic from main.js checkBallGrab
                const rC = e.isDashing ? 4.0 : 2.5; 
                v.catchR.scale.set(rC, 1, rC);
                v.catchR.position.y = e.mesh.position.y + 0.1;
            } else {
                v.tackle.visible = false;
                v.catchR.visible = false;
            }

            // Vectors (Global lines)
            const origin = e.mesh.position.clone();
            origin.y += 1.0; // Lift up

            if (this.showVectors) {
                // Velocity
                if (e.velocity) {
                    const end = origin.clone().add(e.velocity);
                    this.updateLine(v.velLine, origin, end);
                }
                // Input
                if (e.inputVector && e.inputVector.lengthSq() > 0) {
                    const end = origin.clone().add(e.inputVector.clone().multiplyScalar(3.0));
                    this.updateLine(v.inputLine, origin, end);
                } else {
                    v.inputLine.visible = false;
                }
            } else {
                v.velLine.visible = false;
                v.inputLine.visible = false;
            }

            // AI
            if (this.showAI && e.perceivedTargetPos) {
                // Draw line to perceived target
                this.updateLine(v.aiLine, origin, e.perceivedTargetPos);
            } else {
                v.aiLine.visible = false;
            }
        }

        clear() {
            this.visuals.forEach(v => {
                this.scene.remove(v.group);
            });
            this.visuals.clear();
        }
    }
    window.flux.DebugVisualizer = DebugVisualizer;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class MenuManager {
        constructor(gameManager) {
            this.game = gameManager;
            this.container = document.getElementById('main-menu');
            this.items = document.querySelectorAll('.menu-item');
            
            this.setupEvents();
        }

        setupEvents() {
            this.items.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent click-through
                    this.handleSelection(item.dataset.action);
                });
                
                item.addEventListener('mouseenter', () => {
                    // Optional: Play hover sound
                });
            });
        }

        handleSelection(action) {
            console.log("Menu Selection:", action);
            if (action === 'normal') {
                this.hide();
                this.game.startMatch('normal');
            } else if (action === 'practice') {
                this.hide();
                this.game.startMatch('practice');
            } else if (action === 'ball_lab') {
                this.hide();
                window.flux = window.flux || {};
                window.flux.requestedPracticeDrill = 'ball_lab';
                this.game.startMatch('practice');
            } else if (action === 'options') {
                console.log("Options clicked (Not implemented)");
            }
        }

        show() {
            if (this.container) {
                this.container.classList.add('active');
                this.game.setMenuMode(true);
            }
        }

        hide() {
            if (this.container) {
                this.container.classList.remove('active');
                this.game.setMenuMode(false);
            }
        }
    }

    window.flux.MenuManager = MenuManager;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    class PracticeManager {
        constructor(gameManager) {
            this.game = gameManager;
            this.isRunning = false;
            this.currentDrill = null;
            this.drillState = {}; 
            
this.drills = {
                'free': { name: 'FREE ROAM', setup: this._setupFree.bind(this), loop: this._loopFree.bind(this) },
                'ball_lab': { name: 'BALL LAB', setup: this._setupBallLab.bind(this), loop: this._loopBallLab.bind(this) },
                'shooting': { name: 'SHOOTING DRILL', setup: this._setupShooting.bind(this), loop: this._loopShooting.bind(this) },
                'passing': { name: 'PASSING DRILL', setup: this._setupPassing.bind(this), loop: this._loopPassing.bind(this) },
                'defense': { name: 'DEFENSE DRILL', setup: this._setupDefense.bind(this), loop: this._loopDefense.bind(this) },
                'curve': { name: 'CURVE SHOT', setup: this._setupCurve.bind(this), loop: this._loopCurve.bind(this) },
                'rapid_fire': { name: 'RAPID FIRE', setup: this._setupRapidFire.bind(this), loop: this._loopRapidFire.bind(this) }
            };

this.ui = document.getElementById('practice-overlay');
            this.gestureHint = document.getElementById('gesture-hint');
            
            this.options = {
                infStats: true,
                aiDummy: true,
                showHitboxes: false
            };
            
this.targetRing = null;
            this.ghostBalls = []; // Array to track visual copies of thrown balls
            this._initVisuals();
            this._setupEvents();
        }

        _initVisuals() {
            // Create a glowing ring for targets
            const geometry = new THREE.RingGeometry(1.5, 1.8, 32);
            geometry.rotateX(-Math.PI / 2);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x00ffff, 
                side: THREE.DoubleSide, 
                transparent: true, 
                opacity: 0.6,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            this.targetRing = new THREE.Mesh(geometry, material);
            this.targetRing.visible = false;
            // Add to scene via game manager reference
            if (this.game.scene) this.game.scene.add(this.targetRing);
        }

        start() {
this.isRunning = true;
            this._showPanel();
            // If menu requested a specific drill (e.g., Ball Lab), honor it once.
            const req = window.flux && window.flux.requestedPracticeDrill;
            if (req && this.drills[req]) {
                this.setDrill(req);
                window.flux.requestedPracticeDrill = null;
            } else {
                this.setDrill('free');
            }
            
            // Ensure HUD is visible
            const hud = document.getElementById('ui-layer');
            if(hud) hud.style.visibility = 'visible';
        }

        stop() {

            this.isRunning = false;
            this._hidePanel();
            this._hideRestoreBtn();
this._clearDrill();
            
// Clear Ghost Balls
            this.ghostBalls.forEach(b => {
                if (b.mesh) this.game.scene.remove(b.mesh);
                if (b.trail) {
                    this.game.scene.remove(b.trail.mesh);
                    if (b.trail.mesh.geometry) b.trail.mesh.geometry.dispose();
                }
            });
            this.ghostBalls = [];
            if (this.targetRing) this.targetRing.visible = false;

            // Restore Away Team Visibility for Normal Match
            if (this.game.teams.away) {
                this.game.teams.away.players.forEach(p => {
                    if(p.mesh) {
                        p.mesh.visible = true;
                        p.mesh.position.y = 0; // Ensure they aren't stuck under floor
                    }
                });
            }

            // Disable debug visuals if they were on
            if (this.game.debugVisualizer) {
                this.game.debugVisualizer.enabled = false;
                this.game.debugVisualizer.showHitboxes = false;
            }
        }

        setDrill(key) {
            if (!this.drills[key]) return;
            this._clearDrill();
            this.currentDrill = key;
            
            // Update UI
            if (this.ui) {
                this.ui.querySelectorAll('.drill-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.drill === key);
                });
            }

            // Run Setup
            this.drills[key].setup();
            
            // Announcement
            if (this.game.showAnnouncement) {
                this.game.showAnnouncement(this.drills[key].name, 'normal');
            }
        }

        update(dt) {
            if (!this.isRunning) return;

            // Common Practice Logic (Infinite Stats)
            if (this.options.infStats) {
                this._applyInfiniteStats();
            }

            // Drill Logic
            if (this.currentDrill && this.drills[this.currentDrill].loop) {
                this.drills[this.currentDrill].loop(dt);
            }
            
            // Visuals Animation
// Visuals Animation
            if (this.targetRing && this.targetRing.visible) {
                this.targetRing.rotation.z += dt; // Spin
                const s = 1.0 + Math.sin(Date.now() * 0.005) * 0.1;
                this.targetRing.scale.set(s, s, s);
            }

// Update Ghost Balls
            for (let i = this.ghostBalls.length - 1; i >= 0; i--) {
                const b = this.ghostBalls[i];
                b.life -= dt;
                
                // --- PHYSICS & VISUALS DELEGATION ---
                if (window.flux.Ball && window.flux.Ball.prototype.updateFree) {
                    window.flux.Ball.prototype.updateFree.call(b, dt);
                    window.flux.Ball.prototype.updateVisuals.call(b, dt);
                }

                // Update Trail
                if (b.trail) {
                    const trailPos = b.mesh.position.clone();
                    if (b.deformNode) trailPos.y += b.deformNode.position.y;
                    b.trail.update(trailPos);
                }

                // --- GOAL DETECTION FOR GHOST BALLS ---
                const pos = b.mesh.position;
                // Check Z depth (Goal is at +/- 28, trigger at 29)
                if (Math.abs(pos.z) > 29.0) {
                    // Goal Box Dimensions (Matches GameManager)
                    const halfWidth = 11.0;
                    const halfHeight = 9.0;
                    const goalYOffset = -4.5;
                    
                    if (Math.abs(pos.x) <= halfWidth && Math.abs(pos.y - goalYOffset) <= halfHeight) {
                        // GOAL!
                        if (this.game.particleManager) {
                            // Spawn Goal FX
                            this.game.particleManager.spawn('shockwave', pos, { scale: 8.0, life: 0.5 });
                            this.game.particleManager.spawn('flash', pos, { scale: 5.0 });
                            // Debris
                            for(let k=0; k<10; k++) this.game.particleManager.spawn('debris', pos, { scale: 0.5 });
                        }
                        if (this.game.floatingText) {
                            this.game.floatingText.spawn("GOAL", pos, "goal");
                        }
                        // Kill ball immediately
                        b.life = 0;
                    }
                }

                // Cleanup
                if (b.life <= 0 || b.mesh.position.y < -10) {
                    this.game.scene.remove(b.mesh);
                    if (b.trail) {
                        this.game.scene.remove(b.trail.mesh);
                        if (b.trail.mesh.geometry) b.trail.mesh.geometry.dispose();
                    }
                    this.ghostBalls.splice(i, 1);
                }
            }
        }

        _setupEvents() {

            // Minimize / Restore
            const minBtn = this.ui.querySelector('#p-minimize');
            if (minBtn) {
                minBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this._hidePanel();
                    this._showRestoreBtn();
                });
            }

            const restoreBtn = document.getElementById('practice-restore-btn');
            if (restoreBtn) {
                restoreBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this._showPanel();
                    this._hideRestoreBtn();
                });
            }

            // Drill Buttons
            this.ui.querySelectorAll('.drill-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.setDrill(btn.dataset.drill);
                });
            });

            // Reset Ball
            const resetBtn = this.ui.querySelector('#p-reset-ball');
            if (resetBtn) {
                resetBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this._resetBallToPlayer();
                });
            }

            // Exit
            const exitBtn = this.ui.querySelector('#p-exit');
            if (exitBtn) {
                exitBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (window.flux.gameInstance && window.flux.gameInstance.menuManager) {
                        window.flux.gameInstance.menuManager.show();
                        window.flux.gameInstance.state = 'menu';
                        this.stop();
                    }
                });
            }

            // Options Toggles
            this._bindToggle('opt-inf-stat', 'infStats');
            this._bindToggle('opt-ai-dummy', 'aiDummy', (val) => {
                // Update AI Dummy state immediately
                if (this.game.teams.away) {
                    this.game.teams.away.aiEnabled = !val; // If dummy is TRUE, AI is FALSE
                }
            });
            this._bindToggle('opt-hitboxes', 'showHitboxes', (val) => {
                if (this.game.debugVisualizer) {
                    this.game.debugVisualizer.enabled = val;
                    this.game.debugVisualizer.showHitboxes = val;
                }
            });

            // Keyboard Shortcut for Reset (R)
// Keyboard Shortcut for Reset (R)
            window.addEventListener('keydown', (e) => {
                if (this.isRunning && e.key.toLowerCase() === 'r' && !e.repeat) {
                    this._resetBallToPlayer();
                }
            });
        }

_bindToggle(id, optionKey, callback) {
            const el = this.ui.querySelector(`#${id}`);
            if (!el) return;

            // Helper to update visuals
            const updateVisual = () => {
                const isActive = this.options[optionKey];
                el.classList.toggle('active', isActive);
                const box = el.querySelector('.checkbox');
                if (box) box.innerText = isActive ? '' : '';
            };

            // Initialize visual state immediately
            updateVisual();

            el.addEventListener('click', (e) => {
                e.stopPropagation();
                this.options[optionKey] = !this.options[optionKey];
                
                updateVisual();

                if (callback) callback(this.options[optionKey]);
            });
        }


        _setupBallLab() {
            this._setInstruction("BALL LAB: Open DevTools  Ball Lab. Use Shot Cannon + trajectory preview + record/replay.");
            this.drillState.resetting = false;
            this.drillState._autoResetTimer = 0;

            const home = this.game.teams.home;
            const away = this.game.teams.away;
            const p = home ? home.activePlayer : null;
            if (!p) return;

            // Solo mode: hide everyone except the active player
            if (home && home.players) {
                home.players.forEach(mate => {
                    if (mate.mesh) mate.mesh.visible = (mate === p);
                });
            }
            if (away && away.players) {
                away.players.forEach(opp => {
                    if (opp.mesh) opp.mesh.visible = false;
                });
            }

            // Place active player at center facing the away goal
            if (p.mesh) {
                p.mesh.position.set(0, 0, 0);
                p.mesh.lookAt(0, 0, -28);
                p.velocity.set(0, 0, 0);
                if (p.syncRotation) p.syncRotation();
            }

            // Big stats so you can test extremes
            if (p.stats) {
                p.stats.SH = 99;
                p.stats.PA = 99;
                p.stats.EN = 99;
                p.stats.maxHP = Math.max(p.stats.maxHP || 999, 999);
                p.stats.HP = p.stats.maxHP;
            }

            // A clear target marker (purely visual)
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.set(0, 0.1, -18);
                this.targetRing.material.color.setHex(0xff00ff);
            }

            this._resetBallToPlayer();
        }

        _loopBallLab(dt) {
            const b = this.game.entities.ball;
            const p = this.game.teams.home.activePlayer;
            if (!b || !p) return;

            // Auto-reset ball back to player once it comes to rest,
            // so you can spam variations without touching anything.
            if (b.state === 'free') {
                const stopped = (b.velocity.lengthSq() < 0.01) && (b.power <= 0.01);
                if (stopped) {
                    this.drillState._autoResetTimer = (this.drillState._autoResetTimer || 0) + dt;
                    if (this.drillState._autoResetTimer > 0.45) {
                        this._resetBallToPlayer();
                        this.drillState._autoResetTimer = 0;
                    }
                } else {
                    this.drillState._autoResetTimer = 0;
                }
            } else {
                this.drillState._autoResetTimer = 0;
            }

            // Slight target bob (helps depth perception)
            if (this.targetRing && this.targetRing.visible) {
                this.targetRing.position.y = 0.1 + Math.sin(Date.now() * 0.003) * 0.05;
            }
        }

        _applyInfiniteStats() {
            const home = this.game.teams.home;
            if (home) {
                home.players.forEach(p => {
                    p.stats.HP = p.stats.maxHP;
                    p.currentEN = p.stats.EN;
                    p.status.venom = 0;
                    p.status.nap = 0;
                    p.stunTimer = 0;
                });
            }
        }

        _clearDrill() {
            // Reset positions, clear dummies, reset score
if (this.drillState.hintTimeout) clearTimeout(this.drillState.hintTimeout);
            this.drillState = { score: 0, timer: 0, stage: 0, resetting: false };
            if (this.gestureHint) this.gestureHint.style.display = 'none';
            this._updateScoreUI(0);
            
            if (this.targetRing) this.targetRing.visible = false;

            // Reset teams to default positions
            this.game.teams.home.resetPositions();
            this.game.teams.away.resetPositions();
            
            // Apply AI Dummy setting
            if (this.game.teams.away) {
                this.game.teams.away.aiEnabled = !this.options.aiDummy;
            }
            // Hide away team by default in drills unless specified
            this.game.teams.away.players.forEach(p => {
                if(p.mesh) p.mesh.visible = false;
                p.mesh.position.set(0, -100, 0); // Move away
                p.velocity.set(0,0,0);
            });
            
            // Ensure Home team is visible
            this.game.teams.home.players.forEach(p => {
                if(p.mesh) p.mesh.visible = true;
            });
        }

        _resetBallToPlayer() {
            const p = this.game.teams.home.activePlayer;
            const b = this.game.entities.ball;
            if (p && b) {
                b.reset();
                b.grab(p);
                if (this.game.floatingText) this.game.floatingText.spawn("RESET", p.mesh.position, "tech");
                
                // Snap camera
                if (this.game.cameraManager) this.game.cameraManager.snapToTarget();
            }
        }

        _updateScoreUI(val) {
            const el = this.ui.querySelector('#drill-score');
            if (el) el.innerText = `SCORE: ${val}`;
        }

        _setInstruction(text) {
             const el = this.ui.querySelector('#drill-instruction');
             if (el) el.innerText = text;
        }

        // --- DRILLS ---

        _setupFree() {
            this._setInstruction("Free practice. Infinite HP/EN.");
            // Show everyone
            this.game.teams.away.players.forEach(p => {
                if(p.mesh) p.mesh.visible = true;
                p.mesh.position.copy(p.homePosition);
            });
            this._resetBallToPlayer();
        }
        _loopFree(dt) {}

        _setupShooting() {

            this._setInstruction("Score on the Goalie!");
            this.drillState.resetting = false; // Clear reset flag
            
            // Setup: Active Player at 18m, Goalie in net.
            const p = this.game.teams.home.activePlayer;
            const g = this.game.teams.away.players.find(x => x.role === 'GL');
            
            if (p && p.mesh) {
                p.mesh.position.set(0, 0, -10); // 18m out (Home attacks -Z)
                p.mesh.lookAt(0, 0, -28);
                p.velocity.set(0,0,0);
            }
            if (g && g.mesh) {
                g.mesh.visible = true;
                g.mesh.position.set(0, 0, -27);
                g.mesh.lookAt(0, 0, 0);
                g.velocity.set(0,0,0);
            }
            
            this._resetBallToPlayer();
        }
        
        _loopShooting(dt) {
            if (this.drillState.resetting) return;

            // Check if goal scored (GameManager handles the actual goal event, but we track reset)
            if (this.game.state === 'goal') {
                this.drillState.resetting = true;
                this.drillState.score++;
                this._updateScoreUI(this.drillState.score);
                this.game.state = 'active'; // Hijack state back
                setTimeout(() => this._setupShooting(), 1000);
                return;
            }
            
            // If goalie catches
            const g = this.game.teams.away.players.find(x => x.role === 'GL');
            if (g && g.hasBall) {
                 this.drillState.resetting = true;
                 if (this.game.floatingText) this.game.floatingText.spawn("SAVED", g.mesh.position, "damage");
                 setTimeout(() => this._setupShooting(), 1000);
            }
        }

        _setupPassing() {

             this._setInstruction("Pass to the moving target!");
             this.drillState.resetting = false;

             // Setup: Active Player center. 1 Teammate running patterns.
             const p = this.game.teams.home.activePlayer;
             const target = this.game.teams.home.players.find(x => x !== p && x.role !== 'GL');
             
             this.drillState.target = target;
             
             if (p) {
                 p.mesh.position.set(0, 0, 10);
                 p.velocity.set(0,0,0);
             }
             if (target) {
                 target.mesh.position.set(0, 0, -10);
                 target.mesh.visible = true;
                 target.velocity.set(0,0,0);
             }
             
             this._resetBallToPlayer();
        }

        _loopPassing(dt) {
            if (this.drillState.resetting) return;

            const target = this.drillState.target;
            if (!target) return;
            
            // Move target in circle
            this.drillState.timer += dt;
            target.mesh.position.x = Math.sin(this.drillState.timer) * 10;
            target.mesh.position.z = -10 + Math.cos(this.drillState.timer * 0.5) * 5;
            target.mesh.lookAt(0,0,10);

            // Update Ring
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.copy(target.mesh.position);
                this.targetRing.position.y = 0.1;
                this.targetRing.material.color.setHex(0x00ffff); // Cyan
            }

            if (target.hasBall) {
                this.drillState.resetting = true;
                this.drillState.score++;
                this._updateScoreUI(this.drillState.score);
                if (this.game.floatingText) this.game.floatingText.spawn("NICE PASS!", target.mesh.position, "heal");
                
                // Reset
                setTimeout(() => {
                    target.loseBall();
                    this._setupPassing(); // Re-setup to reset positions
                }, 800);
            }
        }
        
        _setupDefense() {

            this._setInstruction("Tackle the attacker!");
            this.drillState.resetting = false;

            const p = this.game.teams.home.activePlayer;
            const attacker = this.game.teams.away.players.find(x => x.role === 'MF');
            
            this.drillState.attacker = attacker;
            
            if (p) {
                p.mesh.position.set(0, 0, 20); // Near own goal
                p.velocity.set(0,0,0);
            }
            if (attacker) {
                attacker.mesh.visible = true;
                attacker.mesh.position.set(0, 0, -10);
                attacker.velocity.set(0,0,0);
                // Give ball to attacker
                const b = this.game.entities.ball;
                b.reset();
                b.grab(attacker);
            }
        }
        
        _loopDefense(dt) {
            if (this.drillState.resetting) return;

            const attacker = this.drillState.attacker;
            const p = this.game.teams.home.activePlayer;
            
            if (!attacker || !p) return;
            
            // Attacker runs to goal (+Z)
            const goalPos = new THREE.Vector3(0, 0, 28);
            const dir = goalPos.clone().sub(attacker.mesh.position).normalize();
            
            // Update Ring on Attacker
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.copy(attacker.mesh.position);
                this.targetRing.position.y = 0.1;
                this.targetRing.material.color.setHex(0xff0000); // Red for enemy
            }

            if (attacker.hasBall) {
                attacker.setInput(dir.x, dir.z);
            } else {
                // Ball lost (Tackled)
                if (p.hasBall || this.game.entities.ball.state === 'free') {
                    this.drillState.resetting = true;
                    this.drillState.score++;
                    this._updateScoreUI(this.drillState.score);
                    if (this.game.floatingText) this.game.floatingText.spawn("STOPPED!", p.mesh.position, "block");
                    setTimeout(() => this._setupDefense(), 1000);
                }
            }
            
            // Fail condition: Attacker scores (GameManager handles goal check)
             if (this.game.state === 'goal') {
                this.drillState.resetting = true;
                this.game.state = 'active';
                if (this.game.floatingText) this.game.floatingText.spawn("FAILED", p.mesh.position, "damage");
                setTimeout(() => this._setupDefense(), 1000);
            }
}

        _setupCurve() {
this._setInstruction("Swipe a CURVE ( ) ) to bypass the defender!");
            this.drillState.resetting = false;

            // Show gesture hint
            if (this.gestureHint) {
                this.gestureHint.style.display = 'flex';
                this.gestureHint.classList.add('active');
                
                // Clear any existing timeout
                if (this.drillState.hintTimeout) clearTimeout(this.drillState.hintTimeout);
                
                // Auto hide after 4s
                this.drillState.hintTimeout = setTimeout(() => {
                    if (this.gestureHint) {
                        this.gestureHint.style.display = 'none';
                        this.gestureHint.classList.remove('active');
                    }
                }, 4000);
            }

            const p = this.game.teams.home.activePlayer;
            // Use a defender dummy
            const defender = this.game.teams.away.players.find(x => x.role === 'LD');
            this.drillState.defender = defender;

            if (p) {
                p.mesh.position.set(0, 0, 15);
                p.mesh.lookAt(0, 0, -28);
                p.velocity.set(0,0,0);
            }

            if (defender) {
                defender.mesh.visible = true;
                defender.mesh.position.set(0, 0, 5); // 10m in front of player
                defender.mesh.lookAt(0, 0, 15); // Face player
                defender.velocity.set(0,0,0);
                // Boost BL to ensure straight shots are blocked
                defender.stats.BL = 99; 
                // Ensure they don't move
                defender.aiState = 'IDLE';
            }

            // Target Ring behind defender
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.set(0, 0.1, -10);
                this.targetRing.material.color.setHex(0x00ffff);
            }

            this._resetBallToPlayer();
        }

_loopCurve(dt) {
            if (this.drillState.resetting) return;

            const ball = this.game.entities.ball;
            const defender = this.drillState.defender;

            // Check if ball passed the defender line (z < 0)
            if (ball.mesh.position.z < 0) {
                // Success zone (Within 5m width)
                if (Math.abs(ball.mesh.position.x) < 5) {
                    this.drillState.resetting = true;
                    this.drillState.score++;
                    this._updateScoreUI(this.drillState.score);
                    if (this.game.floatingText) this.game.floatingText.spawn("CURVED!", ball.mesh.position, "tech");
                    setTimeout(() => this._setupCurve(), 1000);
                    return;
                }
            }

            // Check if blocked (Ball stopped or power drained significantly near defender)
            if (defender && ball.mesh.position.distanceTo(defender.mesh.position) < 3.0) {
                if (ball.power <= 0 || ball.velocity.length() < 1.0) {
                    this.drillState.resetting = true;
                    if (this.game.floatingText) this.game.floatingText.spawn("BLOCKED", defender.mesh.position, "damage");
                    
                    // Re-show hint on failure to guide player
                    if (this.gestureHint) {
                        this.gestureHint.style.display = 'flex';
                        this.gestureHint.classList.add('active');
                        clearTimeout(this.drillState.hintTimeout);
                        this.drillState.hintTimeout = setTimeout(() => {
                            if (this.gestureHint) {
                                this.gestureHint.style.display = 'none';
                                this.gestureHint.classList.remove('active');
                            }
                        }, 4000);
                    }

                    setTimeout(() => this._setupCurve(), 1000);
                    return;
                }
            }

            // Missed / Out of bounds
            if (ball.mesh.position.z < -15) {
                 this.drillState.resetting = true;
                 if (this.game.floatingText) this.game.floatingText.spawn("MISSED", ball.mesh.position, "damage");
                 
                 // Re-show hint on miss
                 if (this.gestureHint) {
                    this.gestureHint.style.display = 'flex';
                    this.gestureHint.classList.add('active');
                    clearTimeout(this.drillState.hintTimeout);
                    this.drillState.hintTimeout = setTimeout(() => {
                        if (this.gestureHint) {
                            this.gestureHint.style.display = 'none';
                            this.gestureHint.classList.remove('active');
                        }
                    }, 4000);
                 }

                 setTimeout(() => this._setupCurve(), 1000);
            }
        }

_setupRapidFire() {
            this._setInstruction("UNLIMITED AMMO! Spam throws!");
            this.drillState.resetting = false;

            // Find Tidus or default to LF
            let p = this.game.teams.home.players.find(x => x.characterName && x.characterName.includes('Tidus'));
            if (!p) p = this.game.teams.home.players.find(x => x.role === 'LF');
            
            // Set active player
            if (p) {
                this.game.teams.home.setActivePlayer(p);
                p.mesh.position.set(0, 0, 0);
                p.mesh.lookAt(0, 0, -28);
                p.velocity.set(0,0,0);
                
                // Boost stats for fun
                p.stats.SH = 99;
                p.stats.PA = 99;
            }

            // HIDE EVERYONE (Alone Mode)
            this.game.teams.home.players.forEach(mate => {
                if (mate !== p && mate.mesh) mate.mesh.visible = false;
            });
            this.game.teams.away.players.forEach(opp => {
                if (opp.mesh) opp.mesh.visible = false;
            });

            this._resetBallToPlayer();
        }

_loopRapidFire(dt) {
            const p = this.game.teams.home.activePlayer;
            const b = this.game.entities.ball;

            if (!p || !b) return;

            // Detect if ball was just thrown (is free)
            if (b.state === 'free') {
                // 1. Spawn Ghost Ball (Visual Copy)
                // Clone the mesh hierarchy to preserve Deform/Spin nodes
                const ghostMesh = b.mesh.clone();
                
                // Ensure visibility and add to scene
                this.game.scene.add(ghostMesh);
                
                // Re-bind internal references for the physics engine
                // Hierarchy: Mesh -> DeformNode -> SpinNode
                const deformNode = ghostMesh.children[0];
                const spinNode = deformNode ? deformNode.children[0] : null;

                // Determine Trail Color based on Tech
                let trailColor = 0xff4400; // Default SH (Orange)
                if (b.technique) {
                    if (b.technique.type === 'venom') trailColor = 0xaa00ff;
                    else if (b.technique.type === 'wither') trailColor = 0x888888;
                    else if (b.technique.type === 'nap') trailColor = 0x000088;
                    else if (b.technique.type === 'sphere') trailColor = 0x00ffff;
                    else if (b.technique.type === 'jecht') trailColor = 0xff0000;
                    else if (b.technique.type === 'invisible') trailColor = 0x444444;
                } else if (b.powerType === 'PA') {
                    trailColor = 0x00aaff; // Pass (Blue)
                }

                // Create Trail
                const trail = new window.flux.TrailRenderer(this.game.scene);
                trail.active = true;
                trail.setColor(trailColor);
                trail.reset(ghostMesh.position);

                // Create a "Mock" Ball object that satisfies Ball.js physics requirements
                const ghostBall = {
                    mesh: ghostMesh,
                    deformNode: deformNode,
                    spinNode: spinNode,
                    velocity: b.velocity.clone(),
                    angularVelocity: b.angularVelocity ? b.angularVelocity.clone() : new THREE.Vector3(),
                    accumulatedRotation: b.accumulatedRotation ? b.accumulatedRotation.clone() : new THREE.Quaternion(),
                    state: 'free',
                    power: b.power,
                    powerType: b.powerType,
                    technique: b.technique,
                    isInvisible: b.isInvisible,
                    life: 5.0, // Enough time to reach goal
                    trail: trail,
                    _bubbleTimer: 0,
                    _ghost: true,
                    // Mock methods
                    reset: () => {}, 
                    drop: () => {},
                    reveal: () => {}
                };

                // Apply visibility
                ghostMesh.visible = !b.isInvisible;

                this.ghostBalls.push(ghostBall);

// 2. Reset Real Ball to Player INSTANTLY
                b.velocity.set(0, 0, 0);
                b.angularVelocity.set(0, 0, 0);
                
                // FIX: Force ball position to be explicitly in front of the player
                // This prevents any logic from thinking the ball is behind and triggering a turn
                const fwd = new THREE.Vector3(0, 0, 1).applyQuaternion(p.mesh.quaternion);
                b.mesh.position.copy(p.mesh.position).add(fwd.multiplyScalar(0.8));
                b.mesh.position.y += 1.0;

                // Manual Attach (Bypass 'catch' animation)
                b.holder = p;
                b.state = 'held';
                p.hasBall = true;
                
                // Reset Player Throw State so they can fire again immediately
                p.isThrowing = false;
                p.catchCooldown = 0;

                // Sync rotation to prevent snapping
                if (p.syncRotation) p.syncRotation();
            }
            
            // Ensure infinite stats
            p.currentEN = p.stats.EN;
            p.stats.HP = p.stats.maxHP;
        }

        _showPanel() {
            if (this.ui) this.ui.classList.add('active');
        }

        _hidePanel() {
            if (this.ui) this.ui.classList.remove('active');
        }

        _showRestoreBtn() {
            const btn = document.getElementById('practice-restore-btn');
            if (btn) btn.style.display = 'block';
        }

        _hideRestoreBtn() {
            const btn = document.getElementById('practice-restore-btn');
            if (btn) btn.style.display = 'none';
        }
    }
window.flux.PracticeManager = PracticeManager;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    // --- High-Quality Noise Texture Generator ---
    window.flux.noiseTexture = (() => {
        const size = 512;
        const c = document.createElement('canvas');
        c.width = size; c.height = size;
        const ctx = c.getContext('2d');
        
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, size, size);
        
        // Generate seamless noise (Perlin-ish via layered random circles/gradients)
        const drawNoiseLayer = (scale, alpha) => {
            ctx.globalAlpha = alpha;
            ctx.globalCompositeOperation = 'lighter'; // Additive
            const count = 300 * scale;
            for(let i=0; i<count; i++) {
                const x = Math.random() * size;
                const y = Math.random() * size;
                const r = (Math.random() * 30 + 10) / scale;
                
                const g = ctx.createRadialGradient(x, y, 0, x, y, r);
                g.addColorStop(0, '#888888');
                g.addColorStop(1, 'transparent');
                
                ctx.fillStyle = g;
                ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
                
                // Wrap around for seamless tiling
                [[x-size, y], [x+size, y], [x, y-size], [x, y+size]].forEach(pos => {
                    const g2 = ctx.createRadialGradient(pos[0], pos[1], 0, pos[0], pos[1], r);
                    g2.addColorStop(0, '#888888');
                    g2.addColorStop(1, 'transparent');
                    ctx.fillStyle = g2;
                    ctx.beginPath(); ctx.arc(pos[0], pos[1], r, 0, Math.PI*2); ctx.fill();
                });
            }
        };
        
        drawNoiseLayer(1.0, 0.3);
        drawNoiseLayer(2.0, 0.2);
        drawNoiseLayer(4.0, 0.1);
        
        const tex = new THREE.CanvasTexture(c);
        tex.wrapS = THREE.RepeatWrapping;
        tex.wrapT = THREE.RepeatWrapping;
        return tex;
    })();

    class WaterOverlay {
        constructor(camera) {
            this.camera = camera;
            
            // Fullscreen quad
            const geometry = new THREE.PlaneGeometry(2, 2);
            
const vert = `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = vec4(position, 1.0);
                }
            `;

            const frag = `
                precision mediump float;
                uniform float uTime;
                uniform float uOpacity;
                uniform sampler2D tNoise;
                varying vec2 vUv;

                // FFX Palette (Additive Friendly)
                const vec3 C_DEEP = vec3(0.0, 0.02, 0.1);     // Subtle Deep Blue Edge
                const vec3 C_GLOW = vec3(0.0, 0.5, 0.8);      // Cyan Glow
                const vec3 C_RAY  = vec3(0.4, 0.7, 1.0);      // Light Shafts
                const vec3 C_PYRE = vec3(1.0, 0.9, 0.6);      // Pyrefly Gold

                void main() {
                    vec2 uv = vUv;
                    float t = uTime * 0.1;

                    // 1. Distortion (Lookup 1)
                    // Low frequency noise for warping everything else
                    float warp = texture2D(tNoise, uv * 0.4 + vec2(t * 0.04, t * 0.02)).r;
                    
                    // 2. Caustics (Lookup 2)
                    // Domain warp the UVs using the first lookup to create liquid feel.
                    // Reduced to single lookup with heavy warping for efficiency.
                    vec2 cUV = uv * 2.0 + vec2(warp * 0.5, warp * 0.2) - vec2(t * 0.05);
                    float c = texture2D(tNoise, cUV).r;
                    
                    // Sharpen caustics via cheap math (replace pow with muls)
                    c = (c - 0.4) * 2.5; // Increase contrast
                    c = max(0.0, c);
                    c = c * c; // ^2
                    c = c * c; // ^4
                    
                    float caustic = c * 12.0;
                    // Tint based on intensity (Fake chromatic aberration)
                    vec3 causticColor = vec3(caustic * 0.8, caustic, caustic * 1.2);

                    // 3. Rays (Lookup 3)
                    // Vertical stretch for light shafts
                    vec2 rayUV = vec2(uv.x + warp * 0.1, uv.y * 0.15 - t * 0.05);
                    float rays = texture2D(tNoise, rayUV).r;
                    rays = rays * rays; // ^2
                    
                    // Fade rays at top/bottom linearly (Cheaper than smoothstep)
                    float rayMask = 1.0 - abs(uv.y * 2.0 - 1.0);
                    rays *= max(0.0, rayMask);

                    // 4. Pyreflies (Procedural - Optimized)
                    // Grid based, linear motion instead of trig
                    vec2 p = uv * 5.0; // 5x5 grid
                    vec2 id = floor(p);
                    vec2 sub = fract(p) - 0.5;
                    
                    // Simple hash
                    float n = fract(sin(dot(id, vec2(12.9898, 78.233))) * 43758.5453);
                    
                    // Linear motion with wrapping (Cheaper than sin/cos)
                    // Use n to randomize speed and direction
                    float px = fract(n * 13.0 + t * 0.3) - 0.5;
                    float py = fract(n * 7.0 + t * 0.2) - 0.5;
                    
                    vec2 flyPos = vec2(px, py);
                    // Dot product for distance squared
                    float d2 = dot(sub - flyPos, sub - flyPos);
                    
                    // Glow falloff (Inverse square approx)
                    float fly = 0.0008 / (d2 + 0.0005);
                    
                    // Mask: Only some cells have flies (30% chance)
                    fly *= step(0.7, n); 
                    
                    // Blink (Keep sin here for smooth pulsing, it's per-pixel but low freq)
                    fly *= 0.5 + 0.5 * sin(t * 5.0 + n * 10.0);

                    // Composition
                    vec3 finalCol = vec3(0.0);

                    // Vignette (Distance squared - cheap)
                    vec2 vd = uv - 0.5;
                    float vSq = dot(vd, vd);
                    float vig = vSq * 1.2; 
                    finalCol += C_DEEP * vig;

                    finalCol += causticColor * C_GLOW * 0.6;
                    finalCol += rays * C_RAY * 0.3;
                    finalCol += fly * C_PYRE;

                    // Scanline (Simple sine)
                    float scan = sin(uv.y * 600.0 + uTime * 5.0) * 0.03;
                    finalCol += C_GLOW * scan;

                    gl_FragColor = vec4(finalCol, uOpacity);
                }
            `;

this.material = new THREE.ShaderMaterial({
                uniforms: {
                    uTime: { value: 0 },
                    uOpacity: { value: 0.5 },
                    tNoise: { value: window.flux.noiseTexture }
                },
                vertexShader: vert,
                fragmentShader: frag,
                transparent: true,
                depthTest: false,
                depthWrite: false,
                blending: THREE.AdditiveBlending // Additive blending prevents dark occlusion
            });

            this.mesh = new THREE.Mesh(geometry, this.material);
            this.mesh.frustumCulled = false;
            this.mesh.renderOrder = 9999;
            
            // Add to camera so it stays on screen
            this.camera.add(this.mesh);
        }
        
        update(dt) {
            if (this.material) {
                this.material.uniforms.uTime.value += dt;
            }
        }
    }
    
    window.flux.WaterOverlay = WaterOverlay;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    class LightShafts {
        constructor(scene) {
            this.scene = scene;
            this.mesh = null;
            this.uniforms = {
                uTime: { value: 0 },
                tNoise: { value: null }
            };

            this._init();
        }

_init() {
            // Geometry: A cluster of cones/cylinders
            // We use a single geometry with instancing or merged geometry for performance,
            // but for simplicity and aesthetic control, let's use a few large planes or a cylinder.
            // A large cylinder with open ends works well for a "pool" shaft effect.
            
            // Increased length to 90 to accommodate tilt without clipping top/bottom
            const geometry = new THREE.CylinderGeometry(30, 20, 90, 32, 1, true);
            
            // Shader
            const vert = `
                varying vec2 vUv;
                varying vec3 vPos;
                void main() {
                    vUv = uv;
                    vPos = position;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `;

            const frag = `
                uniform float uTime;
                uniform sampler2D tNoise;
                varying vec2 vUv;
                varying vec3 vPos;

                void main() {
                    // Vertical fade (Soft top and bottom)
                    float alpha = smoothstep(0.0, 0.3, vUv.y) * smoothstep(1.0, 0.6, vUv.y);

                    // Scrolling Rays
                    // Layer 1: Slow, broad rays
                    float n1 = texture2D(tNoise, vec2(vUv.x * 2.0 + uTime * 0.02, vUv.y * 0.5 - uTime * 0.05)).r;
                    
                    // Layer 2: Fast, interference rays
                    float n2 = texture2D(tNoise, vec2(vUv.x * 3.0 - uTime * 0.03, vUv.y * 0.5 - uTime * 0.1)).r;

                    float rays = n1 * n2;
                    // Boost intensity significantly (Removed pow to prevent crushing)
                    rays = rays * 3.0; 

                    // Glistening Sparkles (High frequency noise)
                    float sparkle = texture2D(tNoise, vUv * vec2(8.0, 2.0) + vec2(uTime * 0.1, uTime * 0.3)).r;
                    sparkle = pow(sparkle, 5.0) * 10.0; // Sharp points

                    // Color: Cyan/Blue/White (Brighter base)
                    vec3 color = vec3(0.6, 0.9, 1.0);
                    
                    // Combine (Higher multipliers)
                    float finalAlpha = (rays * 0.8 + sparkle * 0.4) * alpha;
                    
                    // Distance fade (optional, handled by fog usually but we want additive)
                    gl_FragColor = vec4(color, finalAlpha);
                }
            `;

            const material = new THREE.ShaderMaterial({
                uniforms: this.uniforms,
                vertexShader: vert,
                fragmentShader: frag,
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                side: THREE.DoubleSide
            });

            // Container for the angle (Realistic Light Source)
            this.container = new THREE.Group();
            // Angle: Coming from top-left (simulating surface sun penetrating deep water)
            this.container.rotation.z = Math.PI / 5; // ~36 degrees tilt
            this.container.rotation.x = Math.PI / 10; // ~18 degrees forward
            this.container.position.set(12, 8, 0); // Offset source to hit arena center
            this.scene.add(this.container);

            this.mesh = new THREE.Mesh(geometry, material);
            this.mesh.renderOrder = 100; 
            this.mesh.position.set(0, 0, 0);
            this.container.add(this.mesh);

            // Add a second layer for core intensity
            const coreGeo = new THREE.CylinderGeometry(12, 8, 90, 16, 1, true);
            this.coreMesh = new THREE.Mesh(coreGeo, material);
            this.coreMesh.renderOrder = 100;
            this.container.add(this.coreMesh);
        }

        update(dt) {
            this.uniforms.uTime.value += dt;
            
            // Lazy load texture
            if (!this.uniforms.tNoise.value && window.flux.noiseTexture) {
                this.uniforms.tNoise.value = window.flux.noiseTexture;
                // Ensure wrapping is correct for the cylinder UVs
                window.flux.noiseTexture.wrapS = THREE.RepeatWrapping;
                window.flux.noiseTexture.wrapT = THREE.RepeatWrapping;
            }

            // Slowly rotate shafts for dynamic feel
            if (this.mesh) this.mesh.rotation.y += dt * 0.02;
            if (this.coreMesh) this.coreMesh.rotation.y -= dt * 0.03;
        }
    }

    window.flux.LightShafts = LightShafts;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

// Reusable Glow for Lights
    const _glowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
        g.addColorStop(0, 'rgba(255, 255, 255, 1)');
        g.addColorStop(0.4, 'rgba(0, 170, 255, 0.4)');
        g.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, 64, 64);
        return new THREE.CanvasTexture(c);
    })();

    const _glowMaterial = new THREE.SpriteMaterial({ 
        map: _glowTexture, 
        transparent: true, 
        blending: THREE.AdditiveBlending,
        depthWrite: false
    });

    class Stadium {
        constructor(scene) {
            this.scene = scene;
            this.container = new THREE.Group();
            this.scene.add(this.container);

            // Config for "Herculean" scale
// Config for "Herculean" scale
            this.config = {
                radius: 60,       // Start outside the arena (48 radius)
                tiers: 6,         // Number of seating rings
                tierHeight: 12,
                tierDepth: 15,
                crowdCount: 8000, // Increased density
                structureColor: 0x080c10, // Deep dark blue/black
                lightColor: 0x00aaff
            };

            this.rings = [];
            this.crowd = null;

this._buildArchitecture();
            this._buildCrowd();
            this._buildHerculeanRings();
            this._buildStadiumLights();
        }

        _buildArchitecture() {
            // 1. The Void Bowl (Background Occluder)
            // Massive cylinder to block the void
            const bowlGeo = new THREE.CylinderGeometry(180, 50, 120, 32, 1, true);
            const bowlMat = new THREE.MeshBasicMaterial({ 
                color: this.config.structureColor, 
                side: THREE.BackSide,
                fog: true 
            });
            const bowl = new THREE.Mesh(bowlGeo, bowlMat);
            bowl.position.y = 20;
            this.container.add(bowl);

            // 2. Seating Tiers (Concentric Rings)
            const tierMat = new THREE.MeshBasicMaterial({ color: 0x111a22, side: THREE.DoubleSide });
            const rimMat = new THREE.MeshBasicMaterial({ color: 0x004466 });

            for(let i=0; i<this.config.tiers; i++) {
                const y = (i * this.config.tierHeight) - 30;
                const rInner = this.config.radius + (i * (this.config.tierDepth * 0.8));
                const rOuter = rInner + this.config.tierDepth;
                
                // Floor Ring
                const ringGeo = new THREE.RingGeometry(rInner, rOuter, 64);
                ringGeo.rotateX(-Math.PI / 2);
                const mesh = new THREE.Mesh(ringGeo, tierMat);
                mesh.position.y = y;
                this.container.add(mesh);
                
                // Glowing Rim (The "Tech" feel)
                const rimGeo = new THREE.TorusGeometry(rInner, 0.8, 4, 64);
                rimGeo.rotateX(Math.PI / 2);
                const rim = new THREE.Mesh(rimGeo, rimMat);
                rim.position.y = y;
                this.container.add(rim);
            }

            // 3. Massive Pillars (The "Herculean" Support)
            const pillarGeo = new THREE.BoxGeometry(8, 200, 8);
            const pillarMat = new THREE.MeshBasicMaterial({ color: 0x050505 });
            
            for(let i=0; i<8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const r = 140; // Far out
                const mesh = new THREE.Mesh(pillarGeo, pillarMat);
                mesh.position.set(Math.cos(angle)*r, 0, Math.sin(angle)*r);
                mesh.lookAt(0,0,0);
                this.container.add(mesh);
            }
        }

_buildCrowd() {
            // Instanced Mesh for Crowd (Low Poly, High Count)
            // Using a simple vertical plane that faces center
            const geo = new THREE.PlaneGeometry(1.2, 2.5);
            
            // --- CROWD SHADER IMPLEMENTATION ---
            // Add instance-specific random offset for animation variation
            const offsets = new Float32Array(this.config.crowdCount);
            for(let i=0; i<this.config.crowdCount; i++) {
                offsets[i] = Math.random();
            }
            geo.setAttribute('aOffset', new THREE.InstancedBufferAttribute(offsets, 1));

            // Custom Shader via onBeforeCompile
            const mat = new THREE.MeshBasicMaterial({ side: THREE.DoubleSide });
            
            mat.onBeforeCompile = (shader) => {
                shader.uniforms.uTime = { value: 0 };
                this.crowdUniforms = shader.uniforms;

                shader.vertexShader = `
                    uniform float uTime;
                    attribute float aOffset;
                    varying float vJump; // Pass to fragment for color variation
                ` + shader.vertexShader;

                shader.vertexShader = shader.vertexShader.replace(
                    '#include <begin_vertex>',
                    `
                    #include <begin_vertex>
                    
                    // Animation Logic
                    float speed = 8.0;
                    float t = uTime * speed + (aOffset * 100.0);
                    
                    // Jump (Sine wave clipped)
                    float jump = max(0.0, sin(t));
                    jump = pow(jump, 2.0); // Sharpen the jump curve
                    
                    // Randomize jump height slightly
                    float height = 0.5 + 0.5 * aOffset;
                    
                    transformed.y += jump * height;
                    
                    // Sway (Side to side)
                    transformed.x += cos(t * 0.5) * 0.1;
                    
                    vJump = jump;
                    `
                );

                shader.fragmentShader = `
                    varying float vJump;
                ` + shader.fragmentShader;

                shader.fragmentShader = shader.fragmentShader.replace(
                    'vec4 diffuseColor = vec4( diffuse, opacity );',
                    `
                    vec4 diffuseColor = vec4( diffuse, opacity );
                    
                    // Brighten when jumping (Cheering effect)
                    diffuseColor.rgb += vec3(0.2) * vJump;
                    `
                );
            };
            
this.crowd = new THREE.InstancedMesh(geo, mat, this.config.crowdCount);
            this.crowd.instanceMatrix.setUsage(THREE.DynamicDrawUsage);
            
            // Optimization: Enable culling and manually set bounding sphere to cover the whole stadium
            // This prevents GPU from processing 2500 instances when the entire structure is out of view
            this.crowd.frustumCulled = true;
            this.crowd.geometry.boundingSphere = new THREE.Sphere(new THREE.Vector3(0, 0, 0), 150);
            
            const dummy = new THREE.Object3D();
            const color = new THREE.Color();
            
// 1. Calculate Total Circumference for distribution to ensure all tiers get people
            let totalCirc = 0;
            const tierRadii = [];
            for(let t=0; t<this.config.tiers; t++) {
                const rMin = this.config.radius + (t * (this.config.tierDepth * 0.8)) + 2;
                const circ = 2 * Math.PI * rMin;
                totalCirc += circ;
                tierRadii.push({ rMin: rMin, circ: circ });
            }

            let idx = 0;
            for(let t=0; t<this.config.tiers; t++) {
                const yBase = (t * this.config.tierHeight) - 30;
                const { rMin, circ } = tierRadii[t];
                const rMax = rMin + this.config.tierDepth - 2;
                
                // Distribute proportionally so upper rows don't get cut off
                const countPerTier = Math.floor(this.config.crowdCount * (circ / totalCirc));
                
                for(let i=0; i<countPerTier; i++) {
                    if (idx >= this.config.crowdCount) break;

                    const angle = Math.random() * Math.PI * 2;
                    const r = rMin + Math.random() * (rMax - rMin);
                    
                    dummy.position.set(
                        Math.cos(angle) * r,
                        yBase + 1.25, // Center of quad
                        Math.sin(angle) * r
                    );
                    
                    // Face center
                    dummy.lookAt(0, yBase, 0);
                    dummy.updateMatrix();
                    
                    this.crowd.setMatrixAt(idx, dummy.matrix);
                    
                    // Random Team Colors (Simulating fans)
                    const rand = Math.random();
                    if (rand < 0.45) color.setHex(0x0088ff); // Home Blue
                    else if (rand < 0.9) color.setHex(0xff4444); // Away Red
                    else color.setHex(0xffffff); // Neutral/Flash
                    
                    // Vary brightness for depth
                    color.multiplyScalar(0.5 + Math.random() * 0.5);
                    
                    this.crowd.setColorAt(idx, color);
                    idx++;
                }
            }
            
            this.container.add(this.crowd);
        }

        _buildHerculeanRings() {
            // Massive floating rings that rotate slowly
            const mat = new THREE.MeshBasicMaterial({ 
                color: 0x445566, 
                transparent: true, 
                opacity: 0.3,
                wireframe: true // Tech/Holographic feel
            });

            // 1. Equatorial Ring (Massive)
            const geo1 = new THREE.TorusGeometry(110, 1, 16, 100);
            const ring1 = new THREE.Mesh(geo1, mat);
            ring1.rotation.x = Math.PI / 2;
            this.container.add(ring1);
            this.rings.push({ mesh: ring1, axis: 'z', speed: 0.01 });

            // 2. Tilted Ring
            const geo2 = new THREE.TorusGeometry(130, 2, 16, 100);
            const ring2 = new THREE.Mesh(geo2, mat);
            ring2.rotation.x = Math.PI / 3;
            this.container.add(ring2);
            this.rings.push({ mesh: ring2, axis: 'y', speed: -0.008 });
            
            // 3. Vertical Ring
            const geo3 = new THREE.TorusGeometry(150, 3, 16, 100);
const ring3 = new THREE.Mesh(geo3, mat);
            this.container.add(ring3);
            this.rings.push({ mesh: ring3, axis: 'y', speed: 0.005 });
        }

        _buildStadiumLights() {
            const count = 16; // Number of lights around the equator
            const radius = 36; // Just outside the arena boundary (32)
            const yPos = 0; // Middle of the sphere
            
            const lightGeo = new THREE.SphereGeometry(0.4, 8, 8);
            const lightMat = new THREE.MeshBasicMaterial({ color: 0xffffff });

            for(let i=0; i<count; i++) {
                const angle = (i / count) * Math.PI * 2;
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;

                // 1. Physical Fixture (The bulb)
                const mesh = new THREE.Mesh(lightGeo, lightMat);
                mesh.position.set(x, yPos, z);
                this.container.add(mesh);

                // 2. Visual Glow (Flare)
                const sprite = new THREE.Sprite(_glowMaterial);
                sprite.position.set(x, yPos, z);
                sprite.scale.set(8, 8, 1); // Large glow
                this.container.add(sprite);

// 3. Actual Point Light - REMOVED for optimization
                // Since we use MeshBasicMaterial (Unlit), real lights waste CPU/GPU resources.
                // The sprite glow above provides the visual effect.
            }
        }
update(dt) {
            // Animate Rings
this.rings.forEach(r => {
                if (r.mesh && r.axis) {
                    r.mesh.rotation[r.axis] += r.speed * dt;
                }
            });

            // Update Crowd Shader
            if (this.crowdUniforms) {
                this.crowdUniforms.uTime.value += dt;
            }
        }
    }

    window.flux.Stadium = Stadium;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class AudioManager {
        constructor() {
            this.bgm = new Audio();
            this.bgm.src = 'https://files.catbox.moe/sp2yhy.mp3';
            this.bgm.loop = true;
            this.bgm.volume = 0.5;
            this.isMuted = false;
            this.hasInteracted = false;
            this.shouldBePlaying = false; // Intent flag

            // Preload
            this.bgm.load();

            // --- HERCULEAN LOOP ENFORCEMENT ---
            // 1. Manual Loop Redundancy
            this.bgm.addEventListener('ended', () => {
                console.log("AudioManager: BGM ended event caught. Forcing manual loop reset.");
                this.bgm.currentTime = 0;
                if (this.shouldBePlaying && !this.isMuted) {
                    const p = this.bgm.play();
                    if (p !== undefined) p.catch(e => console.warn("Manual loop replay failed:", e));
                }
            });

            // 2. Pause Watchdog (If paused but should be playing, FORCE PLAY)
            this.bgm.addEventListener('pause', () => {
                if (this.shouldBePlaying && !this.isMuted) {
                    // Small timeout to allow intentional operations to finish if any
                    setTimeout(() => {
                        if (this.shouldBePlaying && this.bgm.paused) {
                            console.log("AudioManager: Unexpected pause detected. Attempting resume.");
                            this.bgm.play().catch(e => console.warn("Resume failed:", e));
                        }
                    }, 100);
                }
            });

            // 3. Periodic Watchdog (The "Never Stop" Guarantee)
            setInterval(() => this._watchdog(), 1000);
        }

        _watchdog() {
            if (this.shouldBePlaying && !this.isMuted) {
                if (this.bgm.paused || this.bgm.ended) {
                    console.log("AudioManager: Watchdog forcing play.");
                    this.bgm.play().catch(() => {
                        // Silent catch, likely waiting for interaction
                    });
                }
            }
        }

        playBGM() {
            if (this.isMuted) return;
            this.shouldBePlaying = true;
            
            const playPromise = this.bgm.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log("AudioManager: Autoplay prevented. Engaging interaction lock.");
                    this._waitForInteraction();
                });
            }
        }

        _waitForInteraction() {
            if (this._waitingForInteraction) return;
            this._waitingForInteraction = true;
            
            const onInteract = () => {
                this.hasInteracted = true;
                
                // Try to play
                if (this.shouldBePlaying && !this.isMuted) {
                    this.bgm.play().then(() => {
                        // Success! Detach listeners
                        this._waitingForInteraction = false;
                        this._removeInteractionListeners(onInteract);
                        console.log("AudioManager: Audio unlocked successfully.");
                    }).catch(e => {
                        console.warn("AudioManager: Interaction play failed. Keeping listeners attached.", e);
                        // Do NOT detach listeners, wait for next interaction
                    });
                } else {
                    // Not supposed to play? Just detach.
                    this._waitingForInteraction = false;
                    this._removeInteractionListeners(onInteract);
                }
            };
            
            // Use capture to catch it early, but don't use 'once: true' so we can retry if failed
            const opts = { capture: true, passive: true };
            document.addEventListener('click', onInteract, opts);
            document.addEventListener('touchstart', onInteract, opts);
            document.addEventListener('keydown', onInteract, opts);
            document.addEventListener('mousedown', onInteract, opts);
        }

        _removeInteractionListeners(handler) {
            const opts = { capture: true, passive: true };
            document.removeEventListener('click', handler, opts);
            document.removeEventListener('touchstart', handler, opts);
            document.removeEventListener('keydown', handler, opts);
            document.removeEventListener('mousedown', handler, opts);
        }

        stopBGM() {
            this.shouldBePlaying = false;
            this.bgm.pause();
            this.bgm.currentTime = 0;
        }

        pauseBGM() {
            this.shouldBePlaying = false;
            this.bgm.pause();
        }

        resumeBGM() {
            if (!this.isMuted) {
                this.playBGM();
            }
        }

        setVolume(volume) {
            this.bgm.volume = Math.max(0, Math.min(1, volume));
        }

        toggleMute() {
            this.isMuted = !this.isMuted;
            if (this.isMuted) {
                this.shouldBePlaying = false;
                this.bgm.pause();
            } else {
                this.playBGM();
            }
            return this.isMuted;
        }
    }

    window.flux.AudioManager = AudioManager;
})();</script>
    <script>(function() {
    // Namespace
    window.flux = window.flux || {};
    window.flux._runtimeUpdaters = window.flux._runtimeUpdaters || [];

    // Config
const _config = {
        internalWidth: 360,
        internalHeight: 640,
        bgColor: 0x001e36,
        fogColor: 0x001e36,
        fogDensity: 0.0001, // Drastically reduced to ensure visibility
        arenaRadius: 48.0
    };

    // Globals
// Globals
    const _input = { x: 0, y: 0 }; // Input state
    
    // Shader Uniforms
    const _arenaUniforms = {
        uTime: { value: 0 },
        uImpactPos: { value: new THREE.Vector3() },
        uImpactStr: { value: 0.0 }
    };
    const _particleUniforms = {
        uTime: { value: 0 }
    };

    // Expose Impact Trigger
    window.flux.triggerArenaImpact = function(pos, strength) {
        _arenaUniforms.uImpactPos.value.copy(pos);
        _arenaUniforms.uImpactStr.value = strength * 2.0; // Scale up for visibility
    };
// _input already declared above
    const _tempVec1 = new THREE.Vector3(); // Reusable for physics/logic
    const _tempVec2 = new THREE.Vector3(); // Reusable for physics/logic
    const _tempVec3 = new THREE.Vector3(); // Reusable for predictive assist
    let _scene, _camera, _renderer, _clock;
    let _homeTeam, _awayTeam;
    let _ball;
    let _gameManager;
    let _menuManager;
    let _audioManager;

    let _cameraManager;
    let _waterOverlay;
    let _lightShafts;
    let _stadium;
    let _glyphManager;

    // IMPROVED: Settings object
    const _settings = {
        joystickSensitivity: 1.0,
        aimAssist: true,
        cameraShake: true,
        hitStop: true,
        invertCamera: false,
        autoRecenter: true,

        // --- "FEELS GOOD" ASSIST LAYER (tunable in DevTools snapshots) ---
        // 0.0 = off / pure skill, 1.0 = very helpful but not full auto-play.
        passAimAssist: 0.65,
        shotAimAssist: 0.35,
        catchAssist: 0.55,
        steeringAssist: 0.35,

        // Higher = snappier input, lower = floatier.
        inputResponse: 14.0,

        // Seconds ahead used for catch prediction (helps with fast balls).
        predictiveCatchTime: 0.12
    };

    // ---------------------------------------------------------------------
    // Debug IO Bridge (exposed for DevTools JSON snapshots)
    // ---------------------------------------------------------------------
    const _debugIO = window.flux._debugIO = window.flux._debugIO || {};
    _debugIO.settings = _settings;
    _debugIO.input = _debugIO.input || {};
    _debugIO.perf = _debugIO.perf || { frame: 0, rawDt: 0, dt: 0, fps: 0, avgFps: 0 };


    // ---------------------------------------------------------------------
    // Touch helpers (multi-touch safe)
    // ---------------------------------------------------------------------
    function _findTouchById(touchList, id) {
        if (id === null || id === undefined) return null;
        if (!touchList) return null;
        for (let i = 0; i < touchList.length; i++) {
            const t = touchList[i];
            if (t && t.identifier === id) return t;
        }
        return null;
    }

    function _endedTouchById(changedTouches, id) {
        if (id === null || id === undefined) return null;
        if (!changedTouches) return null;
        for (let i = 0; i < changedTouches.length; i++) {
            const t = changedTouches[i];
            if (t && t.identifier === id) return t;
        }
        return null;
    }


    function init() {
        _container = document.getElementById('game-container');

        // 1. Scene
        _scene = new THREE.Scene();
        _scene.background = new THREE.Color(_config.bgColor);
        _scene.fog = new THREE.FogExp2(_config.fogColor, _config.fogDensity);

        // 2. Camera
        const aspect = _config.internalWidth / _config.internalHeight;
_camera = new THREE.PerspectiveCamera(60, aspect, 0.1, 500);
_camera.position.set(0, 14, 22);
        _camera.lookAt(0, 0, 0);
        _scene.add(_camera); // Ensure camera is in scene for children to render

        // 3. Renderer
// 3. Renderer
        _renderer = new THREE.WebGLRenderer({ 
            antialias: false,
            powerPreference: "high-performance",
            precision: "mediump", // Mobile optimization: faster shaders
            stencil: false,       // Disable stencil buffer if not used
            depth: true
        });
        _renderer.setPixelRatio(1); // Force 1:1 pixel ratio, we handle scaling via setSize
        _renderer.autoClear = false; // We manage clearing via background or manual calls if needed (though scene.background handles color)
        // Expose renderer for DevTools
        if (_gameManager) _gameManager.renderer = _renderer; 
        else window.flux.gameInstance = { renderer: _renderer }; // Temp hook
_container.appendChild(_renderer.domElement);

// --- Video Overlay Enforcement ---
        // --- Overlay Video Logic Removed (Switched to GIF) ---
        // 5. Environment
        createParticles();
        createArena();

// 5.5 Game Manager
_gameManager = new window.flux.GameManager(_scene, 'ui-layer', _camera, _renderer);
        
        // 5.5.1 Audio Manager
        _audioManager = new window.flux.AudioManager();
        _gameManager.audioManager = _audioManager;

        // 5.6 Camera Manager
        _cameraManager = new window.flux.CameraManager(_camera, _scene);
        _gameManager.cameraManager = _cameraManager;

        // 5.7 Dev Tools
if (window.flux.DevTools) {
            new window.flux.DevTools(_gameManager);
        }
// 5.8 Water Overlay, Light Shafts, Stadium, Glyphs
        _waterOverlay = new window.flux.WaterOverlay(_camera);
        _lightShafts = new window.flux.LightShafts(_scene);
        _stadium = new window.flux.Stadium(_scene);
        _glyphManager = new window.flux.GlyphManager(_scene);
        
if (_gameManager) {
            _gameManager.glyphManager = _glyphManager;
            _gameManager.waterOverlay = _waterOverlay;
            _gameManager.lightShafts = _lightShafts;
            _gameManager.stadium = _stadium;
        }
        // 6. Teams Setup
        _homeTeam = new window.flux.Team(_scene, 'home', 1, 0x00aaff, true);
        _awayTeam = new window.flux.Team(_scene, 'away', -1, 0xff6666, false);

        // 7. Ball
        _ball = new window.flux.Ball(_scene);

        // IMPROVED: Link ball to camera for smart framing
        _cameraManager.setBall(_ball);

        // 8. Team Roster Models
        const roles = ['LF', 'RF', 'MF', 'LD', 'RD', 'GL'];
        const homeRoster = {
            LF: { name: 'Tidus', url: 'https://cdn.tinyglb.com/models/da788bef258c4f0b8d9ef1acc19c5567.glb' },
            RF: { name: 'Wakka', url: 'https://cdn.tinyglb.com/models/59114c98951647c9b8da74b0bd3636cb.glb' },
            MF: { name: 'Letty', url: 'https://cdn.tinyglb.com/models/43ace34c6fd94215967e842bf909da5e.glb' },
            LD: { name: 'Datto', url: 'https://cdn.tinyglb.com/models/e6d67ecb2e4c4715bd73a40795e1d3d5.glb' },
            RD: { name: 'Jassu', url: 'https://cdn.tinyglb.com/models/8216459567354e63958d4108d828de98.glb' },
            GL: { name: 'Botta', url: 'https://cdn.tinyglb.com/models/ad155efedc0d48fdad09da3e1cae9c97.glb' }
        };

        const applyStats = (p, role, isHome) => {
            const teamLevel = isHome ? 25 : 22;
            window.flux.Team.generateStats(p, role, teamLevel, isHome);

            if (p.characterName.includes('Tidus')) {
                p.stats.SH += 5;
                p.stats.SP += 3;
            } else if (p.characterName.includes('Wakka')) {
                p.stats.SH += 3;
                p.stats.EN += 5;
            } else if (p.characterName.includes('Brother')) {
                p.stats.SP = 99;
            }

            p._updateDerivedStats();
        };

        let homeLoaded = 0;
        const roleGltfs = {};

        const finalizeTeams = () => {
            roles.forEach(role => {
                const gltf = roleGltfs[role] || roleGltfs.LF;

                const p = (role === 'GL')
                    ? new window.flux.Goalie(_scene, role)
                    : new window.flux.AIPlayer(_scene, role);

                const entry = homeRoster[role];
                p.characterName = entry ? `CPU ${entry.name}` : 'CPU';
                applyStats(p, role, false);

                if (gltf && gltf.scene) {
                    const clone = THREE.SkeletonUtils.clone(gltf.scene);
                    p.setMesh(clone, gltf.animations || []);
                } else {
                    console.warn('Missing GLTF for away role:', role);
                }

                _awayTeam.addPlayer(p);
            });

            const allPlayers = [..._homeTeam.players, ..._awayTeam.players];
            allPlayers.forEach(p => {
                if (p.ballRef === null) p.ballRef = _ball;
            });

            _homeTeam.activePlayer = _homeTeam.players.find(p => p.role === 'MF');

            if (_homeTeam.activePlayer) {
                _homeTeam.activePlayer.techs.tackle = 'venom';
                _homeTeam.activePlayer.techs.shoot = 'sphere';
                console.log('Equipped Home MF with Venom Tackle & Sphere Shot');
            }

            const awayMF = _awayTeam.players.find(p => p.role === 'MF');
            if (awayMF) {
                awayMF.techs.tackle = 'wither';
            }
            _awayTeam.setFormation('Counter');

            const awayGL = _awayTeam.players.find(p => p.role === 'GL');
            if (awayGL) {
                awayGL.techs.active = 'super_goalie';
                awayGL.techs.passive = 'grip_gloves';
                console.log('Equipped Away GL with Super Goalie');
            }

            _homeTeam.assignMarks(_awayTeam);
            _awayTeam.assignMarks(_homeTeam);

            document.getElementById('loading').style.display = 'none';
            if (_gameManager) {
                _gameManager.registerTeams(_homeTeam, _awayTeam, _ball);

                _menuManager = new window.flux.MenuManager(_gameManager);
                _menuManager.show();
            }
        };

roles.forEach(role => {
            const entry = homeRoster[role];
            if (!entry) return;

            const onComplete = () => {
                homeLoaded++;
                if (homeLoaded >= roles.length) {
                    finalizeTeams();
                }
            };

            window.flux.AssetLoader.loadModel(entry.url, (gltf) => {
                roleGltfs[role] = gltf;

                const p = (role === 'GL')
                    ? new window.flux.Goalie(_scene, role)
                    : new window.flux.AIPlayer(_scene, role);

                p.characterName = entry.name;
                applyStats(p, role, true);

                const clone = THREE.SkeletonUtils.clone(gltf.scene);
                p.setMesh(clone, gltf.animations);
                _homeTeam.addPlayer(p);

                onComplete();
            }, undefined, (err) => {
                console.error('Failed to load model', entry.name, entry.url, err);
                
                // Fallback Mesh (Red Box)
                const fallbackGeo = new THREE.BoxGeometry(1, 2, 1);
                const fallbackMat = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true });
                const fallbackMesh = new THREE.Mesh(fallbackGeo, fallbackMat);
                
                // Store dummy in roleGltfs for away team cloning
                roleGltfs[role] = { scene: fallbackMesh, animations: [] };

                const p = (role === 'GL')
                    ? new window.flux.Goalie(_scene, role)
                    : new window.flux.AIPlayer(_scene, role);

                p.characterName = entry.name + " (Error)";
                applyStats(p, role, true);
                
                p.setMesh(fallbackMesh.clone(), []);
                _homeTeam.addPlayer(p);

                onComplete();
            });
        });

        // 8. Input
        setupInputs();

        // 9. Loop
        _clock = new THREE.Clock();
        requestAnimationFrame(animate);

        // Handle resize
        window.addEventListener('resize', onResize);
        onResize();
    }

function createParticles() {
        const count = 1500; // Increased count
        const geometry = new THREE.BufferGeometry();
        const vertices = [];
        const offsets = []; // Random offsets for independent bobbing

        for (let i = 0; i < count; i++) {
            vertices.push(
                (Math.random() - 0.5) * 80, // Wider spread X
                (Math.random() - 0.5) * 50, // Wider spread Y
                (Math.random() - 0.5) * 80  // Wider spread Z
            );
            offsets.push(Math.random() * 100);
        }

        geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
        geometry.setAttribute('aOffset', new THREE.Float32BufferAttribute(offsets, 1));

        const material = new THREE.ShaderMaterial({
            uniforms: _particleUniforms,
            transparent: true,
            depthWrite: false,
            blending: THREE.AdditiveBlending,
vertexShader: `
                uniform float uTime;
                attribute float aOffset;
                varying float vAlpha;
                void main() {
                    vec3 pos = position;
                    // Bobbing motion: Sine wave based on time + random offset
                    float bob = sin(uTime * 0.5 + aOffset) * 2.0;
                    pos.y += bob;
                    
                    vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
                    gl_Position = projectionMatrix * mvPosition;
                    
                    // Size attenuation - Small and shimmery
                    float sizeBase = 2.0 + sin(uTime * 3.0 + aOffset) * 1.0; 
                    gl_PointSize = sizeBase * (20.0 / -mvPosition.z);
                    
                    // Fade based on distance/height
                    vAlpha = 0.5 + 0.5 * sin(uTime * 2.0 + aOffset);
                }
            `,
            fragmentShader: `
                varying float vAlpha;
                void main() {
                    // Soft glow particle (Dust mote)
                    vec2 coord = gl_PointCoord - vec2(0.5);
                    float dist = length(coord);
                    if(dist > 0.5) discard;
                    
                    // Soft falloff for shimmer
                    float strength = 1.0 - (dist * 2.0);
                    strength = pow(strength, 2.0);
                    
                    // Cyan/Blue tint, additive feel
                    gl_FragColor = vec4(0.7, 0.9, 1.0, vAlpha * strength * 0.8);
                }
            `
        });

        const points = new THREE.Points(geometry, material);
        points.frustumCulled = false;
        _scene.add(points);
    }

function createArena() {
        const geometry = new THREE.SphereGeometry(_config.arenaRadius, 32, 32);
        
        const texLoader = new THREE.TextureLoader();
        const arenaTex = texLoader.load('https://i.postimg.cc/W1LsH68Q/file-0000000023ec71f596593829e8118760-(1).png');
        arenaTex.magFilter = THREE.NearestFilter;
        arenaTex.minFilter = THREE.NearestFilter;
        arenaTex.wrapS = THREE.RepeatWrapping;
        arenaTex.wrapT = THREE.RepeatWrapping;
        arenaTex.repeat.set(6, 4);

        // --- Procedural Hex Texture (Inner Layer) ---
        const hexTex = (() => {
            const c = document.createElement('canvas');
            c.width = 512; c.height = 512;
            const ctx = c.getContext('2d');
            // Transparent background
            ctx.clearRect(0,0,512,512);
            
            ctx.strokeStyle = 'rgba(0, 255, 255, 0.8)';
            ctx.lineWidth = 4;
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#00ffff';
            
            const r = 64;
            const w = r * 2;
            const h = Math.sqrt(3) * r;
            
            // Draw Hexes
            for(let y = -1; y < 512/h + 2; y++) {
                for(let x = -1; x < 512/(w*0.75) + 2; x++) {
                    const cx = x * w * 0.75;
                    const cy = y * h + (x%2===0 ? 0 : h/2);
                    
                    ctx.beginPath();
                    for(let i=0; i<6; i++) {
                        const ang = Math.PI/3 * i;
                        ctx.lineTo(cx + Math.cos(ang)*r, cy + Math.sin(ang)*r);
                    }
                    ctx.closePath();
                    ctx.stroke();
                    
                    // Center dot
                    ctx.fillStyle = 'rgba(0, 100, 255, 0.3)';
                    ctx.beginPath(); ctx.arc(cx, cy, 5, 0, Math.PI*2); ctx.fill();
                }
            }
            return new THREE.CanvasTexture(c);
        })();
        hexTex.wrapS = THREE.RepeatWrapping;
        hexTex.wrapT = THREE.RepeatWrapping;
        hexTex.repeat.set(4, 2);

        // --- Arena 1 (Outer Grid) ---
        const material = new THREE.MeshBasicMaterial({
            map: arenaTex,
            color: 0xffffff,
            wireframe: false,
            transparent: true,
opacity: 0.3, 
            blending: THREE.NormalBlending,
            side: THREE.BackSide,
            depthWrite: false
        });
            
        const arena = new THREE.Mesh(geometry, material);
        _scene.add(arena);
        window.flux.arenaMesh = arena;

        // --- Arena 2 (Inner Hex + Impact Shader) ---
        // We use a custom shader to warp vertices on impact
        const arenaUniforms = THREE.UniformsUtils.merge([
            THREE.UniformsLib['common'],
            _arenaUniforms,
            { 
                tMap: { value: hexTex },
uOpacity: { value: 0.25 } // Exposed uniform
            }
        ]);

        const material2 = new THREE.ShaderMaterial({
            uniforms: arenaUniforms,
            transparent: true,
            side: THREE.BackSide,
            blending: THREE.AdditiveBlending,
            depthWrite: false,
            vertexShader: `
                uniform float uTime;
                uniform vec3 uImpactPos;
                uniform float uImpactStr;
                varying vec2 vUv;
                
                void main() {
                    vUv = uv;
                    vec3 pos = position;
                    
                    // Impact Logic
                    float dist = distance(pos, uImpactPos);
                    float radius = 20.0; // Radius of deformation
                    
                    if (dist < radius) {
                        float t = dist / radius;
                        float bulge = (1.0 - t) * (1.0 - t);
                        float ripple = sin(t * 10.0 - uTime * 5.0) * 0.1;
                        vec3 normal = normalize(pos);
                        pos += normal * (bulge * uImpactStr);
                    }

                    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
                }
            `,
            fragmentShader: `
                uniform sampler2D tMap;
                uniform float uImpactStr;
                uniform float uOpacity;
                varying vec2 vUv;
                
                void main() {
                    vec4 texColor = texture2D(tMap, vUv);
                    
                    // Base opacity + Impact Highlight
                    float alpha = uOpacity * texColor.a;
                    alpha += uImpactStr * 0.02; 

                    // Tint Cyan/Blue
                    vec3 color = texColor.rgb * vec3(0.5, 1.0, 1.0);
                    
                    // Scanline effect
                    float scan = sin(vUv.y * 100.0 + uImpactStr) * 0.1;
                    color += scan;

                    gl_FragColor = vec4(color, alpha);
                }
            `
        });

        const arena2 = new THREE.Mesh(geometry, material2);
        arena2.scale.setScalar(0.98); // Slightly smaller
        _scene.add(arena2);
        window.flux.arenaMesh2 = arena2;
        // --- NEW: FFX GOAL MODELS ---
        const goalUrl = 'https://cdn.tinyglb.com/models/a516bd90fa7c4dedb5dcbfdf803f13d5.glb';
        
        const onGoalLoaded = (model, isFallback) => {
            const goalA = model;
            // Moved down ~15ft (4.5m) total as requested
// Moved down ~15ft (4.5m) total as requested, pushed back to edge
            goalA.position.set(0, -4.5, -46);
            
            if (!isFallback) {
                goalA.scale.setScalar(54.0); // Increased 50% (was 36.0)
            }
            // Setup Goal A
            goalA.traverse(c => {
                if(c.isMesh) {
                    c.frustumCulled = false; // CRITICAL: Prevent culling
                    c.renderOrder = 0;
                    
                    // Ensure material is visible
                    if (c.material) {
                        c.material.color.setHex(0xffffff); // White to show original texture/colors (was blue)
                        c.material.transparent = false;
                        c.material.opacity = 1.0;
                        c.material.side = THREE.DoubleSide;
                        c.material.depthWrite = true;
                        c.material.depthTest = true;
                    }
                }
            });
            _scene.add(goalA);

            // Setup Goal B
            const goalB = isFallback ? goalA.clone() : THREE.SkeletonUtils.clone(goalA);

goalB.position.set(0, -4.5, 46); // Moved closer (was 45) and down
            goalB.rotation.y = Math.PI;
            // Ensure Goal B meshes are also persistent
            goalB.traverse(c => {
                if(c.isMesh) c.frustumCulled = false;
            });

            _scene.add(goalB);
        };

        window.flux.AssetLoader.loadModel(goalUrl, (gltf) => {
            onGoalLoaded(gltf.scene, false);
        }, undefined, (err) => {
            console.warn("Goal model failed to load. Using fallback.", err);
            const geo = new THREE.BoxGeometry(75, 45, 10); // Fallback massive box (Scaled 1.5x)
            const fallbackMat = new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true });
            const fallback = new THREE.Mesh(geo, fallbackMat);
            onGoalLoaded(fallback, true);
        });

        // --- NEW: MASSIVE FIELD MARKINGS ---
        createFieldMarkings();
    }

    function createFieldMarkings() {
        const size = 1024;
        const c = document.createElement('canvas');
        c.width = size; c.height = size;
        const ctx = c.getContext('2d');
        const cx = size/2; const cy = size/2;

        // Helper to draw
        const draw = () => {
            ctx.clearRect(0, 0, size, size);

            // Glow Settings
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#00ffff';
            ctx.strokeStyle = 'rgba(100, 255, 255, 0.9)';
            ctx.lineWidth = 5;
            ctx.lineCap = 'round';

            // 1. Main Field Circle (The Sphere Equator)
            ctx.beginPath();
            ctx.arc(cx, cy, 450, 0, Math.PI*2);
            ctx.stroke();

            // 2. Inner Decorative Ring
            ctx.beginPath();
            ctx.arc(cx, cy, 420, 0, Math.PI*2);
            ctx.lineWidth = 2;
            ctx.strokeStyle = 'rgba(0, 200, 255, 0.5)';
            ctx.stroke();

            // 3. Center Blitzoff Zone (Complex Star/Rune)
            ctx.lineWidth = 4;
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.beginPath();
            ctx.arc(cx, cy, 80, 0, Math.PI*2);
            ctx.stroke();
            
            // Inner Star Pattern
            ctx.beginPath();
            for(let i=0; i<5; i++) {
                const a = (i/5)*Math.PI*2 - Math.PI/2;
                const x = cx + Math.cos(a)*60;
                const y = cy + Math.sin(a)*60;
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                // Inner point
                const a2 = ((i+0.5)/5)*Math.PI*2 - Math.PI/2;
                const x2 = cx + Math.cos(a2)*25;
                const y2 = cy + Math.sin(a2)*25;
                ctx.lineTo(x2,y2);
            }
            ctx.closePath();
            ctx.stroke();

            // 4. Midfield Line
            ctx.beginPath();
            ctx.moveTo(0, cy); ctx.lineTo(size, cy);
            ctx.stroke();

            // 5. Goal Boxes (Trapezoids)
            const drawGoalBox = (yPos, dir) => {
                ctx.beginPath();
                ctx.moveTo(cx - 150, yPos);
                ctx.lineTo(cx + 150, yPos);
                ctx.lineTo(cx + 225, yPos + (dir * 120));
                ctx.lineTo(cx - 225, yPos + (dir * 120));
                ctx.closePath();
                ctx.stroke();
            };
            drawGoalBox(50, 1); // Top (Home side in texture space)
            drawGoalBox(size-50, -1); // Bottom

            // 6. Runes (Procedural Text Ring)
            // Use Spira font if loaded, fallback to monospace
            ctx.font = '32px Spira, monospace'; 
            ctx.fillStyle = 'rgba(0, 255, 255, 0.7)';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            const runes = "BLITZBALL SPHERE POOL ZANARKAND ABYSS ETERNAL CALM ";
            const runeCount = 32;
            for(let i=0; i<runeCount; i++) {
                const angle = (i / runeCount) * Math.PI * 2;
                const r = 480;
                const x = cx + Math.cos(angle) * r;
                const y = cy + Math.sin(angle) * r;
                
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(angle + Math.PI/2);
                const char = runes[i % runes.length];
                ctx.fillText(char, 0, 0);
                ctx.restore();
            }

            const tex = new THREE.CanvasTexture(c);
            tex.anisotropy = 16;

            // Floor Plane (Deep)
// Floor Plane (Deep)
            const geo = new THREE.PlaneGeometry(90, 90);
            const mat = new THREE.MeshBasicMaterial({
                map: tex,
                transparent: true,
                opacity: 0.8,
                side: THREE.DoubleSide,
                depthWrite: false,
                blending: THREE.AdditiveBlending
            });

            const field = new THREE.Mesh(geo, mat);
            field.rotation.x = -Math.PI / 2;
            field.position.y = -8.0; // Sunk deep into the sphere
            _scene.add(field);
        };

        // Attempt to load font first
        document.fonts.load('32px Spira').then(() => {
            draw();
        }).catch(() => {
            console.warn("Spira font failed to load for canvas, using fallback.");
            draw();
        });

        // Floating Holographic Rings (Mid-height)
        const ringGeo = new THREE.TorusGeometry(20, 0.1, 16, 100);
        const ringMat = new THREE.MeshBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0.3, blending: THREE.AdditiveBlending });
        const ring1 = new THREE.Mesh(ringGeo, ringMat);
        ring1.rotation.x = Math.PI / 2;
        ring1.position.y = 0;
        _scene.add(ring1);
        
        const ring2 = new THREE.Mesh(ringGeo, ringMat);
        ring2.rotation.x = Math.PI / 2;
        ring2.scale.setScalar(1.2);
        ring2.position.y = 4.0;
        _scene.add(ring2);

        // Animate Rings (integrated into main loop to avoid a second RAF on mobile)
        let _ringTime = 0;
        const _ringUpdate = (dt) => {
            _ringTime += dt;
            if (ring1) {
                ring1.rotation.z += dt * 0.9;
                ring1.scale.setScalar(1.0 + Math.sin(_ringTime * 0.5) * 0.05);
            }
            if (ring2) {
                ring2.rotation.z -= dt * 0.75;
                ring2.position.y = 4.0 + Math.cos(_ringTime * 0.7) * 1.0;
            }
        };
        if (window.flux && window.flux._runtimeUpdaters) window.flux._runtimeUpdaters.push(_ringUpdate);
}

    // --- INPUT SYSTEM ---
// --- INPUT SYSTEM ---
const _keys = {};
// Globals moved to below helper

    // Helper: Analyze curve geometry for analog control
    const analyzeSwipeCurve = (points) => {
        if (points.length < 3) return { intensity: 0, speed: 0, dx: 0, dy: 0 };
        
        const pStart = points[0];
        const pEnd = points[points.length - 1];
        const midIdx = Math.floor(points.length / 2);
        const pMid = points[midIdx];

        const dx = pEnd.x - pStart.x;
        const dy = pEnd.y - pStart.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        const dt = pEnd.t - pStart.t;
        const speed = (dt > 0) ? dist / dt : 0; // px/ms

        if (dist < 50) return { intensity: 0, speed: speed, dx, dy };

        const vSM_x = pMid.x - pStart.x;
        const vSM_y = pMid.y - pStart.y;

        // Cross product gives signed area/curvature direction
        const cross = (dx * vSM_y) - (dy * vSM_x);
        // Normalize by distance squared to get a curvature ratio independent of scale
const intensity = cross / (dist * dist);

        return { intensity, speed, dx, dy };
    };
    let _swipePoints = []; // Track swipe history for curves
    const _aimInput = { x: 0, y: 0, active: false }; // NEW: Aim joystick

    const _actionBuffer = { active: false, timestamp: 0, duration: 300 };

    const _camFwd = new THREE.Vector3();
    const _camRight = new THREE.Vector3();
    const _upAxis = new THREE.Vector3(0, 1, 0);

    function setupInputs() {
        // Keyboard
        window.addEventListener('keydown', (e) => {
            _keys[e.key] = true;
            if (e.code === 'Space' && _homeTeam && _homeTeam.activePlayer && _ball) {
                _homeTeam.activePlayer.throwBall(_ball);
            }
            // NEW: Tackle on Shift
            if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') {
                if (_homeTeam && _homeTeam.activePlayer) {
                    const p = _homeTeam.activePlayer;
                    if (!p.hasBall) {
                        p.dash(p.inputVector.x, p.inputVector.z);
                    }
                }
            }
            updateInputVector();
        });
        window.addEventListener('keyup', (e) => { _keys[e.key] = false; updateInputVector(); });

        // --- FLOATING JOYSTICK (Movement) ---
        const hitZone = document.getElementById('joystick-hit-zone');
        const visuals = document.getElementById('joystick-visual-container');
        const base = document.getElementById('joystick-base');
        const knob = document.getElementById('joystick-knob');

        let startX = 0, startY = 0;
        let dragging = false;
        const maxDist = 40;

        let moveTouchId = null;
        const moveDeadzonePx = 6;

        // Expose move joystick state for snapshots
        const _dbg = window.flux._debugIO = window.flux._debugIO || {};
        _dbg.settings = _settings;
        _dbg.input = _dbg.input || {};
        _dbg.input.move = _dbg.input.move || {};
        _dbg.input.move.vector = _input;
        _dbg.input.move.dragging = dragging;
        _dbg.input.move.touchId = moveTouchId;


        const handleStart = (clientX, clientY) => {
            dragging = true;
            startX = clientX;

            if (_dbg && _dbg.input && _dbg.input.move) {
                _dbg.input.move.dragging = dragging;
            }

            startY = clientY;

            visuals.style.display = 'block';
            visuals.style.left = `${clientX}px`;
            visuals.style.top = `${clientY}px`;

            knob.style.transform = `translate(-50%, -50%)`;

            createRipple(clientX, clientY);

            _input.x = 0;
            _input.y = 0;
            updateInputVector();
        };

        const handleMove = (clientX, clientY) => {
            if (!dragging) return;

            let dx = clientX - startX;
            let dy = clientY - startY;

            const dist = Math.sqrt(dx*dx + dy*dy);


            // Deadzone to prevent drift from tiny thumb jitter
            if (dist < moveDeadzonePx) {
                dx = 0;
                dy = 0;
            }

            if (dist > maxDist) {
                dx = (dx / dist) * maxDist;
                dy = (dy / dist) * maxDist;
            }

            knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;

            _input.x = (dx / maxDist) * _settings.joystickSensitivity;
            _input.y = (dy / maxDist) * _settings.joystickSensitivity;
            updateInputVector();
        };

        const handleEnd = () => {
            if (!dragging) return;
            dragging = false;

            moveTouchId = null;

            visuals.style.display = 'none';

            if (_dbg && _dbg.input && _dbg.input.move) {
                _dbg.input.move.dragging = dragging;
                _dbg.input.move.touchId = moveTouchId;
            }


            _input.x = 0;
            _input.y = 0;
            updateInputVector();
        };

        if (hitZone) {
            hitZone.addEventListener('touchstart', (e) => {
                if (e.cancelable) e.preventDefault();
                const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e.touches[0];
                moveTouchId = t ? t.identifier : null;
                if (_dbg && _dbg.input && _dbg.input.move) {
                    _dbg.input.move.touchId = moveTouchId;
                }
                handleStart(t.clientX, t.clientY);
            }, { passive: false });

            window.addEventListener('touchmove', (e) => {
                if (!dragging) return;
                if (e.cancelable) e.preventDefault();
                const t = _findTouchById(e.touches, moveTouchId);
                if (!t) return;
                handleMove(t.clientX, t.clientY);
            }, { passive: false });

            window.addEventListener('touchend', (e) => {
                if (!dragging) return;
                const tEnd = _endedTouchById(e.changedTouches, moveTouchId);
                if (!tEnd) return; // Ignore other fingers lifting
                handleEnd();
            });
            window.addEventListener('touchcancel', (e) => {
                if (!dragging) return;
                const tEnd = _endedTouchById(e.changedTouches, moveTouchId);
                if (!tEnd) return;
                handleEnd();
            });

            hitZone.addEventListener('mousedown', (e) => {
                handleStart(e.clientX, e.clientY);
            });
            window.addEventListener('mousemove', (e) => {
                if (dragging) handleMove(e.clientX, e.clientY);
            });
            window.addEventListener('mouseup', handleEnd);
        }

        // --- NEW: AIM JOYSTICK (Right side) ---
        setupAimJoystick();

        // --- NEW: TACKLE BUTTON ---
        setupTackleButton();

        // Swipe Detection
// Swipe Detection
        let swipeStart = { x: 0, y: 0, t: 0 };
        let swipeTouchId = null;
        
        // Expose swipe/throw gesture state for snapshots
        _dbg.input.swipe = _dbg.input.swipe || {};
        _dbg.input.swipe.start = swipeStart;
        _dbg.input.swipe.touchId = swipeTouchId;
        _dbg.input.swipe.points = _swipePoints;
const onSwipeStart = (x, y) => {
            swipeStart.x = x;
            swipeStart.y = y;
            swipeStart.t = Date.now();
            _swipePoints = [{x, y, t: Date.now()}];
        };

const onSwipeMove = (x, y) => {
            if (_swipePoints.length > 0) {
                _swipePoints.push({x, y, t: Date.now()});
                createSwipeTrailDot(x, y); // Visual Feedback
            }
        };

const onSwipeEnd = (x, y) => {
            if (_swipePoints.length < 2) return;
            _swipePoints.push({x, y, t: Date.now()});

            const { intensity, speed, dx, dy } = analyzeSwipeCurve(_swipePoints);
            const dist = Math.sqrt(dx*dx + dy*dy);

            if (_homeTeam && _homeTeam.activePlayer && _camera) {
                const p = _homeTeam.activePlayer;

                // --- CURVE BALL DETECTION (Immediate Throw) ---
// --- CURVE BALL DETECTION (Immediate Throw) ---
                if (p.hasBall && !p.isThrowing && !p.isCharging) {
                    // Analog Curve Check: Threshold 0.25 requires a deliberate arc (The "Feat")
                    if (Math.abs(intensity) > 0.25 && dist > 100) {
                        _camera.getWorldDirection(_camFwd);
                        _camFwd.y = 0; _camFwd.normalize();
                        _camRight.crossVectors(_camFwd, _upAxis).normalize();

                        const worldX = (_camRight.x * dx) + (_camFwd.x * -dy);
                        const worldZ = (_camRight.z * dx) + (_camFwd.z * -dy);
                        const throwDir = new THREE.Vector3(worldX, 0, worldZ).normalize();

                        // Map intensity to spin - Drastically reduced sensitivity
                        const rawSpin = Math.abs(intensity) * 300.0; 
                        const speedFactor = Math.min(1.5, speed / 1.0);
                        const spinPower = Math.min(400.0, rawSpin * speedFactor);
                        const spinSign = Math.sign(intensity); 
                        const spinVec = new THREE.Vector3(0, spinPower * spinSign, 0);


                        p.setOverrideAim(throwDir.x, throwDir.z);
                        p.throwBall(window.flux.gameInstance.entities.ball, 'SH', 1.0, spinVec);
                        
                        if (window.flux.gameInstance.floatingText) {
                            window.flux.gameInstance.floatingText.spawn("CURVE", p.mesh.position, "tech");
                        }
                        createRipple(x, y);
                        _swipePoints = [];
                        return; 
                    }
                }

                // --- STANDARD DASH / AIM ---
                _camera.getWorldDirection(_camFwd);
                _camFwd.y = 0;
                if (_camFwd.lengthSq() < 0.001) _camFwd.set(0, 0, -1);
                else _camFwd.normalize();

                _camRight.crossVectors(_camFwd, _upAxis).normalize();

const worldX2 = (_camRight.x * dx) + (_camFwd.x * -dy);
                const worldZ2 = (_camRight.z * dx) + (_camFwd.z * -dy);

                if (p.isThrowing) {
p.setOverrideAim(worldX2, worldZ2);
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("AIM!", p.mesh.position, "default");
                    }
                } else {
if (dist > 50) p.dash(worldX2, worldZ2);
                }

                createRipple(x, y);
            }
_swipePoints = [];
        };

        window.addEventListener('touchstart', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;

            const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e.touches[0];
            swipeTouchId = t ? t.identifier : null;
// onSwipeStart(t.clientX, t.clientY); // Fixed syntax error
            if (_dbg && _dbg.input && _dbg.input.swipe) { _dbg.input.swipe.touchId = swipeTouchId; }
            onSwipeStart(t.clientX, t.clientY);
            createRipple(t.clientX, t.clientY);
        }, { passive: false });

window.addEventListener('touchmove', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone')) return;
            const t = _findTouchById(e.touches, swipeTouchId);
            if (!t) return;
            onSwipeMove(t.clientX, t.clientY);
        }, { passive: false });

        window.addEventListener('touchend', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;
            const tEnd = _endedTouchById(e.changedTouches, swipeTouchId);
            if (!tEnd) return; // Ignore other fingers lifting
            onSwipeEnd(tEnd.clientX, tEnd.clientY);
            swipeTouchId = null;
            if (_dbg && _dbg.input && _dbg.input.swipe) { _dbg.input.swipe.touchId = swipeTouchId; }
        });

                window.addEventListener('touchcancel', (e) => {
if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;
            const tEnd = _endedTouchById(e.changedTouches, swipeTouchId);
            if (!tEnd) return; // Ignore other fingers lifting
            onSwipeEnd(tEnd.clientX, tEnd.clientY);
            swipeTouchId = null;
            if (_dbg && _dbg.input && _dbg.input.swipe) { _dbg.input.swipe.touchId = swipeTouchId; }
        
        });
// Mouse Swipe
        window.addEventListener('mousedown', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;

            onSwipeStart(e.clientX, e.clientY);
            createRipple(e.clientX, e.clientY);
        });

        window.addEventListener('mousemove', (e) => {
             if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone')) return;
            // Only track if mouse is down (simulating drag)
            if (e.buttons === 1) {
                onSwipeMove(e.clientX, e.clientY);
            }
        });


        window.addEventListener('mouseup', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;
            onSwipeEnd(e.clientX, e.clientY);
        });

        // Action Button (Shoot/Pass)
        const actionBtn = document.getElementById('action-button');

const setupButton = (btn) => {
            if (!btn) return;

            let btnStartX = 0;
            let btnStartY = 0;
            let isDragging = false;
            let swipePoints = [];
            let actionTouchId = null;

            const attemptAction = () => {
                if (!_homeTeam || !_homeTeam.activePlayer) return false;
                const p = _homeTeam.activePlayer;

                if (p.hasBall && !p.isCharging && !p.isThrowing && p.status.nap <= 0) {
                    p.startCharge();
                    btn.classList.add('active');
                    return true;
                }
                return false;
            };

            const handleStart = (e) => {
                if (e.cancelable) e.preventDefault();

                if (_gameManager && _gameManager.techCopyState.active) {
                    _gameManager.attemptTechCopy();
                    btn.classList.add('active');
                    setTimeout(() => btn.classList.remove('active'), 100);
                    return;
                }

                if (_gameManager && _gameManager.isDemoMode) return;

                let clientX = e.clientX;
                let clientY = e.clientY;
                if (e.changedTouches && e.changedTouches.length) {
                    const t = e.changedTouches[0];
                    actionTouchId = t.identifier;
                    clientX = t.clientX;
                    clientY = t.clientY;
                } else {
                    actionTouchId = null; // mouse
                }
                btnStartX = clientX;
                btnStartY = clientY;
                isDragging = true;
                swipePoints = [{x: clientX, y: clientY, t: Date.now()}];

                _actionBuffer.active = true;
                _actionBuffer.timestamp = Date.now();

                if (attemptAction()) {
                    _actionBuffer.active = false;
                }

                // Attach global listeners to track swipe outside button
                window.addEventListener('touchmove', handleMove, { passive: false });
                window.addEventListener('touchend', handleEnd);
                window.addEventListener('touchcancel', handleEnd);
                window.addEventListener('mousemove', handleMove);
                window.addEventListener('mouseup', handleEnd);
            };

            const handleMove = (e) => {
                if (!isDragging) return;

                // Touch path (multi-touch safe)
                if (e.touches && actionTouchId !== null) {
                    const t = _findTouchById(e.touches, actionTouchId);
                    if (!t) return;
                    swipePoints.push({x: t.clientX, y: t.clientY, t: Date.now()});
                    return;
                }

                // Mouse path
                const clientX = e.clientX;
                const clientY = e.clientY;
                swipePoints.push({x: clientX, y: clientY, t: Date.now()});
            };

const handleEnd = (e) => {
                let dx = 0;
                let dy = 0;
                let validEnd = false;

                // 1. Check Touch
                if (e.changedTouches && actionTouchId !== null) {
                    const tEnd = _endedTouchById(e.changedTouches, actionTouchId);
                    if (tEnd) {
                        dx = tEnd.clientX - btnStartX;
                        dy = tEnd.clientY - btnStartY;
                        validEnd = true;
                        actionTouchId = null;
                    }
                } 
                // 2. Check Mouse
                else if (!e.changedTouches && isDragging) {
                    dx = e.clientX - btnStartX;
                    dy = e.clientY - btnStartY;
                    validEnd = true;
                }

                if (!validEnd) return;

                // Cleanup listeners
                window.removeEventListener('touchmove', handleMove);
                window.removeEventListener('touchend', handleEnd);
                window.removeEventListener('touchcancel', handleEnd);
                window.removeEventListener('mousemove', handleMove);
                window.removeEventListener('mouseup', handleEnd);

                if (!isDragging) return;
                isDragging = false;
                
                const wasBuffered = _actionBuffer.active;
                _actionBuffer.active = false;

                if (_homeTeam && _homeTeam.activePlayer) {
                    const p = _homeTeam.activePlayer;
                    
                    // Curve Analysis
                    let curveData = null;
                    let spinVec = null;

                    // Calculate curve if we have enough data
// Calculate curve if we have enough data
                    if (swipePoints.length > 2) {
                        const analysis = analyzeSwipeCurve(swipePoints);
                        // High threshold for button release too
                        if (Math.abs(analysis.intensity) > 0.25) {
                            curveData = analysis;
                            
                            // Calculate spin vector for mouse/touch unified (Conservative values)
                            const spinPower = Math.min(400.0, Math.abs(analysis.intensity) * 1500.0);
                            const spinSign = Math.sign(analysis.intensity);
                            spinVec = new THREE.Vector3(0, spinPower * spinSign, 0);
                        }
}

                    // EXECUTE
                    if (p.isCharging) {
                        // Normal Release
                        if (spinVec) {
                            // Unified spin passing
                            p.releaseCharge(dx, dy, { intensity: curveData.intensity, speed: curveData.speed }); 
                        } else {
                            p.releaseCharge(dx, dy, curveData);
                        }
                        btn.classList.remove('active');
                    } 
                    else if (wasBuffered && p.hasBall && !p.isThrowing && p.status.nap <= 0) {
                        // Buffered Tap (Instant Shot)
                        // Force start and release immediately
                        p.startCharge();
                        p.releaseCharge(dx, dy, curveData);
                        btn.classList.remove('active');
                    }
                }
            };

            btn.addEventListener('touchstart', handleStart, { passive: false });
            btn.addEventListener('mousedown', handleStart);
        };
        setupButton(actionBtn);

// Auto Toggle
        const autoBtn = document.getElementById('auto-toggle');
        if (autoBtn) {
            const handleToggle = () => {
                if (_gameManager) {
                    _gameManager.toggleDemoMode();
                    if (_homeTeam && _homeTeam.activePlayer) {
                        _homeTeam.activePlayer.setInput(0, 0);
                    }
                }
            };

            autoBtn.addEventListener('click', handleToggle);
autoBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleToggle();
            }, { passive: false });
        }

        // NEW: Settings Button
        setupSettingsButton();
    }

    // NEW: Aim Joystick Setup
// NEW: Aim Joystick Setup
function setupAimJoystick() {
        const aimKnob = document.getElementById('aim-joystick-knob');
        const aimVisuals = document.getElementById('aim-joystick-visual');
        const aimZone = document.getElementById('aim-joystick-zone');
        if (!aimZone) return;
        let aimStartX = 0, aimStartY = 0;
        let aimDragging = false;
        const aimMaxDist = 35;
        let aimTouchId = null;

        

        // Expose aim joystick state for snapshots
        const _dbg = window.flux._debugIO = window.flux._debugIO || {};
        _dbg.settings = _settings;
        _dbg.input = _dbg.input || {};
        _dbg.input.aim = _dbg.input.aim || {};
        _dbg.input.aim.vector = _aimInput;
        _dbg.input.aim.dragging = aimDragging;
        _dbg.input.aim.touchId = aimTouchId;
const handleAimStart = (clientX, clientY) => {
            aimDragging = true;
            aimStartX = clientX;

            if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.dragging = aimDragging; }

            aimStartY = clientY;
            _aimInput.active = true;

            if (aimVisuals) {
                aimVisuals.style.display = 'block';
                aimVisuals.style.left = `${clientX}px`;
                aimVisuals.style.top = `${clientY}px`;
            }
            if (aimKnob) {
                aimKnob.style.transform = `translate(-50%, -50%)`;
            }
        };

        const handleAimMove = (clientX, clientY) => {
            if (!aimDragging) return;

            let dx = clientX - aimStartX;
            let dy = clientY - aimStartY;

            const dist = Math.sqrt(dx*dx + dy*dy);

            if (dist > aimMaxDist) {
                dx = (dx / dist) * aimMaxDist;
                dy = (dy / dist) * aimMaxDist;
            }

            if (aimKnob) {
                aimKnob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            }

            // Normalize and transform to world space
            _aimInput.x = dx / aimMaxDist;
            _aimInput.y = dy / aimMaxDist;

            // Apply aim to player if charging
            if (_homeTeam && _homeTeam.activePlayer) {
                const p = _homeTeam.activePlayer;
                if (p.isCharging || p.isThrowing) {
                    // Transform screen aim to world space
                    _camera.getWorldDirection(_camFwd);
                    _camFwd.y = 0;
                    if (_camFwd.lengthSq() < 0.001) _camFwd.set(0, 0, -1);
                    else _camFwd.normalize();
                    _camRight.crossVectors(_camFwd, _upAxis).normalize();

                    const worldX = (_camRight.x * _aimInput.x) + (_camFwd.x * -_aimInput.y);
                    const worldZ = (_camRight.z * _aimInput.x) + (_camFwd.z * -_aimInput.y);

                    if (Math.abs(worldX) > 0.1 || Math.abs(worldZ) > 0.1) {
                        p.setOverrideAim(worldX, worldZ);
                    }
                }
            }
        };

const handleAimEnd = () => {
            if (!aimDragging) return;
            aimDragging = false;
            _aimInput.active = false;
            _aimInput.x = 0;
            _aimInput.y = 0;

            if (aimVisuals) {
                aimVisuals.style.display = 'none';
            }

            // Clear player aim override
            if (_homeTeam && _homeTeam.activePlayer) {
                _homeTeam.activePlayer.overrideAimVector = null;
            }
        };

        aimZone.addEventListener('touchstart', (e) => {
            if (e.cancelable) e.preventDefault();
            const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e.touches[0];
            aimTouchId = t ? t.identifier : null;
            if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.touchId = aimTouchId; }
            handleAimStart(t.clientX, t.clientY);
        }, { passive: false });

        window.addEventListener('touchmove', (e) => {
            if (!aimDragging) return;
            if (e.cancelable) e.preventDefault();
            const t = _findTouchById(e.touches, aimTouchId);
            if (!t) return;
            handleAimMove(t.clientX, t.clientY);
        }, { passive: false });

        window.addEventListener('touchend', (e) => {
            if (!aimDragging) return;
            const tEnd = _endedTouchById(e.changedTouches, aimTouchId);
            if (!tEnd) return;
            aimTouchId = null;
            handleAimEnd();
            if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.touchId = aimTouchId; _dbg.input.aim.dragging = aimDragging; }
            handleAimEnd();
        });

                window.addEventListener('touchcancel', (e) => {
            if (!aimDragging) return;
                        const tEnd = _endedTouchById(e.changedTouches, aimTouchId);
                        if (!tEnd) return;
                        aimTouchId = null;
                        handleAimEnd();
                        if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.touchId = aimTouchId; _dbg.input.aim.dragging = aimDragging; }
                        handleAimEnd();
        });
// Mouse support for desktop testing
        aimZone.addEventListener('mousedown', (e) => {
            handleAimStart(e.clientX, e.clientY);
        });
        window.addEventListener('mousemove', (e) => {
            if (aimDragging) handleAimMove(e.clientX, e.clientY);
        });
        window.addEventListener('mouseup', (e) => {
            if (aimDragging) handleAimEnd();
        });
    }

    // NEW: Tackle Button Setup
    function setupTackleButton() {
        const tackleBtn = document.getElementById('tackle-button');
        if (!tackleBtn) return;

        const handleTackle = (e) => {
            if (e.cancelable) e.preventDefault();

            if (_gameManager && _gameManager.isDemoMode) return;

            if (_homeTeam && _homeTeam.activePlayer) {
                const p = _homeTeam.activePlayer;

                // If we don't have the ball, dash/tackle
                if (!p.hasBall) {
                    // Get current movement direction or forward
                    let dashX = p.inputVector.x;
                    let dashZ = p.inputVector.z;

                    // If not moving, dash forward
                    if (Math.abs(dashX) < 0.1 && Math.abs(dashZ) < 0.1) {
                        const fwd = new THREE.Vector3(0, 0, 1).applyQuaternion(p.mesh.quaternion);
                        dashX = fwd.x;
                        dashZ = fwd.z;
                    }

                    p.dash(dashX, dashZ);

                    tackleBtn.classList.add('active');
                    setTimeout(() => tackleBtn.classList.remove('active'), 200);

                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("TACKLE!", p.mesh.position, "tech");
                    }
                } else if (p.isEngaged) {
                    // Break tackle if engaged
                    p.dash(p.inputVector.x, p.inputVector.z);
                    tackleBtn.classList.add('active');
                    setTimeout(() => tackleBtn.classList.remove('active'), 200);
                }
            }
        };

        tackleBtn.addEventListener('touchstart', handleTackle, { passive: false });
        tackleBtn.addEventListener('mousedown', handleTackle);
    }

    // NEW: Settings Button Setup
// NEW: Settings Button Setup
function setupSettingsButton() {
        const settingsBtn = document.getElementById('settings-button');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsClose = document.getElementById('settings-close');

        if (!settingsBtn || !settingsPanel) return;

        settingsBtn.addEventListener('click', () => {
            settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'block' : 'none';
        });

        if (settingsClose) {
            settingsClose.addEventListener('click', () => {
                settingsPanel.style.display = 'none';
            });
        }

        // Sensitivity slider
        const sensitivitySlider = document.getElementById('sensitivity-slider');
        if (sensitivitySlider) {
            sensitivitySlider.value = _settings.joystickSensitivity * 100;
            sensitivitySlider.addEventListener('input', (e) => {
                _settings.joystickSensitivity = e.target.value / 100;
            });
        }

        // Aim assist toggle
        const aimAssistToggle = document.getElementById('aim-assist-toggle');
        if (aimAssistToggle) {
            aimAssistToggle.checked = _settings.aimAssist;
            aimAssistToggle.addEventListener('change', (e) => {
                _settings.aimAssist = e.target.checked;
            });
        }

        // Camera shake toggle
        const shakeToggle = document.getElementById('shake-toggle');
        if (shakeToggle) {
            shakeToggle.checked = _settings.cameraShake;
            shakeToggle.addEventListener('change', (e) => {
                _settings.cameraShake = e.target.checked;
            });
        }

        // Volume slider
        const volumeSlider = document.getElementById('volume-slider');
        if (volumeSlider && _audioManager) {
            volumeSlider.addEventListener('input', (e) => {
                const vol = e.target.value / 100;
                _audioManager.setVolume(vol);
            });
        }

        // Exit to Menu
        const exitBtn = document.getElementById('exit-to-menu-btn');
        if (exitBtn) {
            exitBtn.addEventListener('click', () => {
                if (_menuManager) {
                    _menuManager.show();
                    if (_gameManager) {
                        _gameManager.state = 'menu';
                        // Stop practice if running
                        if (_gameManager.practiceManager) {
                            _gameManager.practiceManager.stop();
                        }
                    }
                    settingsPanel.style.display = 'none';
                }
            });
        }
    }

    function updateInputVector() {
        let x = _input.x || 0;
        let z = _input.y || 0;

        if (_keys['w'] || _keys['ArrowUp']) z -= 1;
        if (_keys['s'] || _keys['ArrowDown']) z += 1;
        if (_keys['a'] || _keys['ArrowLeft']) x -= 1;
        if (_keys['d'] || _keys['ArrowRight']) x += 1;

        const lenSq = x*x + z*z;
        if (lenSq > 1) {
            const len = Math.sqrt(lenSq);
            x /= len;
            z /= len;
        }

        if (isNaN(x)) x = 0;
        if (isNaN(z)) z = 0;

        if (_camera) {
            _camera.getWorldDirection(_camFwd);
            _camFwd.y = 0;

            if (_camFwd.lengthSq() < 0.001) {
                _camFwd.set(0, 0, -1);
            } else {
                _camFwd.normalize();
            }

            _camRight.crossVectors(_camFwd, _upAxis).normalize();
        } else {
            _camFwd.set(0, 0, -1);
            _camRight.set(1, 0, 0);
        }

        let worldX = (_camFwd.x * -z) + (_camRight.x * x);
        let worldZ = (_camFwd.z * -z) + (_camRight.z * x);

        if (isNaN(worldX) || isNaN(worldZ)) {
            worldX = 0;
            worldZ = 0;
        }

        if (_homeTeam && _homeTeam.activePlayer) {
            if (_gameManager && !_gameManager.isDemoMode) {
                _homeTeam.activePlayer.setInput(worldX, worldZ);
            }

}
    }
function createRipple(x, y) {
        const ripple = document.createElement('div');
        ripple.className = 'touch-ripple';
        ripple.style.left = `${x}px`;
        ripple.style.top = `${y}px`;
        document.getElementById('ui-layer').appendChild(ripple);

        setTimeout(() => {
            if (ripple.parentNode) ripple.parentNode.removeChild(ripple);
        }, 600);

    }

    // NEW: Visual Swipe Trail
    function createSwipeTrailDot(x, y) {
        const dot = document.createElement('div');
        dot.className = 'swipe-trail-dot';
        dot.style.left = `${x - 6}px`; // Center (12px width)
        dot.style.top = `${y - 6}px`;
        document.getElementById('ui-layer').appendChild(dot);
        
        // CSS animation handles removal, but we clean up DOM to be safe
        setTimeout(() => {
            if (dot.parentNode) dot.parentNode.removeChild(dot);
        }, 500);
    }

    function onResize() {
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        if (_camera) {
            _camera.aspect = width / height;
            _camera.updateProjectionMatrix();
        }
        
        // Strictly 0.50 as requested
        const resScale = 0.50;
        
        _config.internalWidth = Math.floor(width * resScale);
        _config.internalHeight = Math.floor(height * resScale);

        if (_renderer) {
            _renderer.setSize(_config.internalWidth, _config.internalHeight, false);
        }
    }

function animate() {
        requestAnimationFrame(animate);

        const rawDt = _clock.getDelta();
        // Clamp dt to prevent spirals of death (max 0.1s)
        const dt = Math.min(rawDt, 0.1) * (window.flux.timeScale !== undefined ? window.flux.timeScale : 0.8);

        

        // Perf stats for DevTools snapshots
        if (window.flux && window.flux._debugIO && window.flux._debugIO.perf) {
            const perf = window.flux._debugIO.perf;
            perf.frame = (perf.frame || 0) + 1;
            perf.rawDt = rawDt;
            perf.dt = dt;
            const fps = dt > 0 ? (1 / dt) : 0;
            perf.fps = fps;
            perf.avgFps = (perf.avgFps && perf.avgFps > 0) ? (perf.avgFps * 0.9 + fps * 0.1) : fps;
        }
// Impact Frames
        if (_gameManager && _gameManager.impactPause > 0) {
            _gameManager.impactPause -= dt;
            if (_renderer && _scene && _camera) {
                _renderer.render(_scene, _camera);
            }
            return;
        }

        updateInputVector();

        // Action Buffer Processing
        if (_actionBuffer.active) {
            if (Date.now() - _actionBuffer.timestamp > _actionBuffer.duration) {
                _actionBuffer.active = false;
            } else {
                if (_homeTeam && _homeTeam.activePlayer) {
                    const p = _homeTeam.activePlayer;

                    if (p.hasBall && !p.isCharging && !p.isThrowing && p.status.nap <= 0) {
                        p.startCharge();
                        const btn = document.getElementById('action-button');
                        if (btn) btn.classList.add('active');
                        _actionBuffer.active = false;
                    }
                }
            }
        }

        // Menu State Handling
        if (_gameManager && _gameManager.state === 'menu' && _camera) {
            const time = Date.now() * 0.0005;
            const radius = 50;
            _camera.position.x = Math.sin(time) * radius;
            _camera.position.z = Math.cos(time) * radius;
            _camera.position.y = 20;
            _camera.lookAt(0, 0, 0);

            if (_renderer && _scene) {
                _renderer.render(_scene, _camera);
            }
            return;
        }

// Stable sub-stepping (prevents dt spikes from making physics/camera feel floaty on mobile)
        const _maxStep = 1 / 60;
        const _steps = Math.min(4, Math.max(1, Math.ceil(dt / _maxStep)));
        const _stepDt = dt / _steps;

        for (let _si = 0; _si < _steps; _si++) {
            const _sdt = _stepDt;

            if (_gameManager) _gameManager.update(_sdt);

            // If in Asset Forge mode, skip game logic and standard rendering
            // DevTools handles the rendering in its hooked update function
            if (_gameManager && _gameManager.isForgeMode) {
                // Forge mode handles its own rendering loop in DevTools hook
                return;
            }

            // Update Entities
            if (_homeTeam) {
                _homeTeam.update(_sdt);
                _homeTeam.players.forEach(p => checkBallGrab(p));
            }

            if (_awayTeam) {
                _awayTeam.update(_sdt);
                _awayTeam.players.forEach(p => checkBallGrab(p));
            }

            if (_ball) {
                _ball.update(_sdt);
            }

            // Ball Lab runtime (trajectory preview / record-replay)
            if (window.flux && window.flux.ballLab && typeof window.flux.ballLab.update === 'function') {
                window.flux.ballLab.update(_sdt);
            }

            // Update Camera
            updateCameraLogic(_sdt);

            // Update Visuals
            if (_waterOverlay) _waterOverlay.update(_sdt);
            if (_lightShafts) _lightShafts.update(_sdt);

            // Runtime updaters (FX, arena rings, etc.)
            if (window.flux && window.flux._runtimeUpdaters && window.flux._runtimeUpdaters.length) {
                for (let ui = 0; ui < window.flux._runtimeUpdaters.length; ui++) {
                    const fn = window.flux._runtimeUpdaters[ui];
                    if (typeof fn === 'function') fn(_sdt);
                }
            }

            // Update Global Uniforms
            if (_arenaUniforms) {
                _arenaUniforms.uTime.value += _sdt;
                // Decay impact strength
                _arenaUniforms.uImpactStr.value *= Math.max(0, 1.0 - _sdt * 4.0);
            }
            if (_particleUniforms) {
                _particleUniforms.uTime.value += _sdt;
            }

            if (_stadium) _stadium.update(_sdt);
        }


        if (_renderer && _scene && _camera) {
            _renderer.render(_scene, _camera);
        }
        // UI Updates
        updateUI();
    }

    function updateUI() {
        if (!_homeTeam || !_homeTeam.activePlayer) return;

        const btn = document.getElementById('action-button');
        const lbl = document.getElementById('action-label');
        const tackleBtn = document.getElementById('tackle-button');
        const p = _homeTeam.activePlayer;

        if (btn && lbl) {
            const btnText = btn.querySelector('.btn-text');

            if (p.hasBall) {
                if (btnText && btnText.innerText !== "ACTION") {
                    btnText.innerText = "ACTION";
                    btn.classList.add('shoot-mode');
                    lbl.innerText = "OFFENSE";
                    lbl.classList.add('shoot-label');
                }

                const isHighEnergy = (p.stats.HP / p.stats.maxHP) > 0.4;
                if (isHighEnergy) {
                    if (!btn.classList.contains('limit-ready')) btn.classList.add('limit-ready');
                } else {
                    if (btn.classList.contains('limit-ready')) btn.classList.remove('limit-ready');
                }

            } else {
                if (btnText && btnText.innerText !== "SWIM") {
                    btnText.innerText = "SWIM";
                    btn.classList.remove('shoot-mode');
                    btn.classList.remove('limit-ready');
                    lbl.innerText = "NORMAL";
                    lbl.classList.remove('shoot-label');
                }
            }
        }

        // Update tackle button visibility
        if (tackleBtn) {
            if (!p.hasBall || p.isEngaged) {
                tackleBtn.style.display = 'flex';
                // Update tackle button text based on context
                const tackleText = tackleBtn.querySelector('.btn-text');
                if (tackleText) {
                    if (p.isEngaged && p.hasBall) {
                        tackleText.innerText = 'BREAK';
                        tackleBtn.classList.add('urgent');
                    } else {
                        tackleText.innerText = 'TACKLE';
                        tackleBtn.classList.remove('urgent');
                    }
                }
            } else {
                tackleBtn.style.display = 'none';
            }
        }

        // Update distance to goal indicator
        const distIndicator = document.getElementById('goal-distance');
        if (distIndicator && p.mesh) {
            const goalZ = (p.team && p.team.side === 1) ? -28 : 28;
            const dist = Math.abs(p.mesh.position.z - goalZ);
            distIndicator.innerText = `${Math.floor(dist)}m`;
        }
    }

function updateCameraLogic(dt) {
        if (!_cameraManager || !_ball) return;

        let targetMesh = _ball.mesh;
        let targetVel = _ball.velocity;
        let targetInput = null;
        let isAiming = false;

        if (_ball.holder && _ball.holder.mesh) {
            targetMesh = _ball.holder.mesh;
            targetVel = _ball.holder.velocity;
            if (_ball.holder.inputVector) {
                targetInput = _ball.holder.inputVector;
            }
// Check aiming state (Charging or Throwing)
            if (_ball.holder.isCharging || _ball.holder.isThrowing) {
                isAiming = true;
            }
        }

        _cameraManager.setTarget(targetMesh, targetVel, targetInput, isAiming);
        _cameraManager.update(dt);
    }

    function checkBallGrab(entity) {
        if (!entity.canCatch) return;
        if (_ball && !_ball.isCatchable()) return;
        if (entity.stunTimer > 0 || (entity.status && entity.status.nap > 0)) return;
        if (_ball.state !== 'free') return;
        if (!_ball.mesh || !entity.mesh) return;

const ballPos = _ball.mesh.position;
        const entPos = entity.mesh.position;

        const dx = ballPos.x - entPos.x;
        const dz = ballPos.z - entPos.z;
        const distXZ = Math.sqrt(dx*dx + dz*dz);
        const distY = Math.abs(ballPos.y - entPos.y);

        // Assist tuning (0..1)
        const s = (window.flux && window.flux._debugIO && window.flux._debugIO.settings) ? window.flux._debugIO.settings : null;
        const catchAssist = Math.max(0, Math.min(1, (s && typeof s.catchAssist === 'number') ? s.catchAssist : 0.0));
        const predictiveT = Math.max(0, Math.min(0.5, (s && typeof s.predictiveCatchTime === 'number') ? s.predictiveCatchTime : 0.12));

        // Predictive sample (helps with fast balls that skim by)
        const predPos = _tempVec3.copy(ballPos).addScaledVector(_ball.velocity, predictiveT);

        const dxP = predPos.x - entPos.x;
        const dzP = predPos.z - entPos.z;
        const distXZPred = Math.sqrt(dxP*dxP + dzP*dzP);
        const distYPred = Math.abs(predPos.y - entPos.y);

        const effDistXZ = Math.min(distXZ, distXZPred);
        const effDistY  = Math.min(distY,  distYPred);

        const touchRadius = 1.0 + (0.6 * catchAssist);
        // Base radii (slightly forgiving by default; assist scales them up)
        let magnetRadius = 1.8 + (1.6 * catchAssist);
        let interactionRadius = 3.5 + (2.2 * catchAssist);
        let catchHeight = 3.0 + (1.6 * catchAssist);

        if (entity.isDashing) {
            magnetRadius = 3.0;
            interactionRadius = 4.5;
            catchHeight = 4.5;
        }

        if (effDistXZ > interactionRadius || effDistY > catchHeight) return;

        // Optimization: Use shared vectors to avoid GC
const samplePos = (distXZPred < distXZ) ? predPos : ballPos;
        _tempVec1.copy(samplePos).sub(entPos).normalize(); // toBall (predictive if closer)
        _tempVec2.set(0, 0, 1).applyQuaternion(entity.mesh.quaternion).normalize(); // playerForward

        const facingDot = _tempVec2.dot(_tempVec1);

        const coneThreshold = -0.2 - (0.4 * (typeof catchAssist !== 'undefined' ? catchAssist : 0.0));
        const isInCone = facingDot > coneThreshold;
        const isInTouch = effDistXZ < touchRadius;

        if (effDistXZ < interactionRadius && !isInCone) {
            const targetAngle = Math.atan2(_tempVec1.x, _tempVec1.z);
            const q = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0), targetAngle);
            entity.mesh.quaternion.slerp(q, 0.1);
            if (entity.syncRotation) entity.syncRotation();
        }

// (Removed duplicate logic block)

        if (isInTouch || (effDistXZ < magnetRadius && isInCone)) {
            // BLAST THROUGH LOGIC
            const ballSpeed = _ball.velocity.length();
            let catchChance = 1.0;

            // If ball is moving fast (e.g. > 20), check CA
            if (ballSpeed > 20.0) {
                const ca = entity.getStat('CA');
                // Difficulty scales with speed. 
                const difficulty = ballSpeed * 1.2; 
                
                if (difficulty > ca) {
                    catchChance = 0.4 + (ca / difficulty) * 0.6;
                    
                    // Point Blank Penalty: Harder to react if ball is right on top of you moving fast
                    if (effDistXZ < 1.2) {
                        catchChance *= 0.6; // Blast through likely
                    }
                    
                    if (entity.isDashing) catchChance += 0.2;
                }
            } else if (_ball.powerType === 'SH' && _ball.power > 15.0) {
                // Shot power check
                const ca = entity.getStat('CA');
                if (_ball.power > ca * 1.2) {
                    const chance = Math.min(0.7, (_ball.power - ca) * 0.04);
                    catchChance = 1.0 - chance;
                }
            }

            // Assist nudges catch odds upward (never guarantees)
            if (typeof catchAssist !== 'undefined' && catchAssist > 0) {
                catchChance = Math.max(0.05, Math.min(1.0, catchChance * (1.0 - 0.25 * catchAssist) + (0.25 * catchAssist)));
            }

            let fumble = false;
            if (Math.random() > catchChance) {
                fumble = true;
            }

            if (fumble) {
                if (window.flux.gameInstance.floatingText) {
                    // Visual feedback for blast through
                    window.flux.gameInstance.floatingText.spawn("BLAST THROUGH!", entPos, "damage");
                }
                
                // Deflect slightly but keep moving fast (Blast Through)
                // Don't stop it completely like a block, just perturb it
                _ball.velocity.multiplyScalar(0.85); 
                _ball.velocity.x += (Math.random()-0.5) * 5.0;
                _ball.velocity.y += (Math.random()) * 5.0; // Pop up
                _ball.velocity.z += (Math.random()-0.5) * 5.0;
                
                _ball.power *= 0.7;

                entity.canCatch = false;
                // Stun briefly
                entity.stunTimer = 0.5;
                if(entity.play) entity.play('react', 0.1);
                
                setTimeout(() => { entity.canCatch = true; }, 1000);

            } else {
                _ball.magnetize(entity);
            }
        }
    }

    // Start
    init();
})();</script>


</body></html>