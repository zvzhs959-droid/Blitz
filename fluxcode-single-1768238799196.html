<html lang="en"><head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Blitzball FFX Remastered</title>
    <style>:root {
    --ffx-blue-deep: #020408;
    --ffx-blue-dark: #0a1525;
    --ffx-blue-mid: #152a45;
    --ffx-blue-light: #2a4d75;
    --ffx-cyan: #60c0d0;
    --ffx-cyan-glow: #00ffff;
    --ffx-gold: #c8b060;
    --ffx-gold-light: #f0e090;
    --ffx-gold-dark: #8a7030;
    --ffx-glass-bg: rgba(10, 20, 40, 0.75);
    --ffx-glass-border: rgba(100, 200, 255, 0.3);
    
    --font-title: 'Garamond', 'Times New Roman', serif;
    --font-data: 'Impact', 'Arial Narrow', sans-serif;
    --font-ui: 'Courier New', monospace;
    --font-spira: 'Spira', 'Impact', sans-serif;
}

@font-face {
    font-family: 'Spira';
    src: url('https://files.catbox.moe/zyn7s3.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
}

html, body {
    margin: 0;
    padding: 0;
    background-color: #000;
    overflow: hidden;
    width: 100vw;
    height: 100%;
    position: fixed; 
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    font-family: var(--font-data);
    color: white;
    user-select: none;
    -webkit-user-select: none;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
}

* {
    box-sizing: border-box;
}

/* --- MAIN GAME CONTAINER --- */
#game-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    max-width: none;
    background: #000510;
    box-shadow: none;
    overflow: hidden;
    transition: filter 0.05s;
    z-index: 1;
}

/* --- IMPACT FX --- */
#game-container.impact-fx {
    animation: impactShake 0.1s ease-in-out;
    filter: contrast(1.2) brightness(1.1);
}

#game-container.impact-heavy {
    animation: impactShake 0.2s ease-in-out;
    filter: contrast(1.5) brightness(1.3) sepia(0.4) hue-rotate(-10deg);
}

#game-container.impact-shatter {
    animation: impactShake 0.4s ease-in-out;
    filter: contrast(2.0) invert(0.1) saturate(2.0);
}

@keyframes impactShake {
    0% { transform: translate(0, 0); }
    25% { transform: translate(-5px, 5px); }
    50% { transform: translate(5px, -5px); }
    75% { transform: translate(-5px, -5px); }
    100% { transform: translate(0, 0); }
}

/* --- CANVAS & RENDER --- */
canvas {
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    image-rendering: pixelated; 
    z-index: 0;
}

/* --- GIF OVERLAY --- */
#screen-overlay-gif {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    mix-blend-mode: overlay;
    opacity: 1.0;
    pointer-events: none;
    z-index: 950;
    image-rendering: pixelated;
}

#ui-layer {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    z-index: 1000;
}

/* --- CINEMATIC BARS --- */
#cinematic-bars .bar {
    position: absolute;
    left: 0; width: 100%; height: 0;
    background: black;
    transition: height 0.5s ease;
    z-index: 800;
}
#cinematic-bars .bar.top { top: 0; }
#cinematic-bars .bar.bottom { bottom: 0; }

/* --- TECH FLASH OVERLAY --- */
#tech-flash-overlay {
    position: absolute;
    top: 20%; left: 0; width: 100%; height: 120px;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(0, 20, 60, 0.9) 20%, rgba(0, 20, 60, 0.9) 80%, rgba(0,0,0,0) 100%);
    z-index: 2200;
    backdrop-filter: blur(2px);
    border-top: 1px solid rgba(100, 255, 255, 0.3);
    border-bottom: 1px solid rgba(100, 255, 255, 0.3);
    animation: flashEnter 0.15s ease-out;
}

@keyframes flashEnter {
    from { transform: scaleY(0); opacity: 0; }
    to { transform: scaleY(1); opacity: 1; }
}

.tech-content-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    transform: skewX(-10deg);
}

.tech-text {
    font-family: var(--font-spira);
    font-size: clamp(28px, 10vw, 42px);
    color: #ffffff;
    text-shadow: 0 0 10px #00ffff, 0 0 20px #0000ff;
    letter-spacing: 3px;
    margin-bottom: 2px;
    font-style: italic;
    animation: blinkText 0.08s infinite alternate;
    text-align: center;
}

.tech-sub-text {
    font-family: var(--font-ui);
    font-size: 14px;
    color: #00ffff;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 8px;
    text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
}

.tech-timer-track {
    width: 250px;
    height: 8px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #444;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
}

.tech-timer-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffffff, #00ffff);
    width: 100%;
    transform-origin: left;
    box-shadow: 0 0 10px #00ffff;
}

@keyframes blinkText {
    from { opacity: 0.8; text-shadow: 0 0 5px #00ffff; transform: scale(1); }
    to { opacity: 1.0; text-shadow: 0 0 20px #ffffff, 0 0 10px #00ffff; transform: scale(1.02); }
}

/* --- HUD TOP --- */
/* --- HUD TOP --- */
#hud-top {
    position: absolute;
    top: 0;
    left: 0;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    width: 100%;
    padding: 15px;
    padding-top: max(15px, env(safe-area-inset-top));
    padding-left: max(15px, env(safe-area-inset-left));
    padding-right: max(15px, env(safe-area-inset-right));
    box-sizing: border-box;
    background: linear-gradient(to bottom, rgba(0, 5, 15, 0.9) 0%, rgba(0,0,0,0) 100%);
    pointer-events: none;
    transition: opacity 0.5s;
}

.team-wing {
    position: relative;
    display: flex;
    align-items: center;
    width: 140px;
    height: 55px;
    background: linear-gradient(160deg, rgba(20, 40, 80, 0.9) 0%, rgba(5, 10, 20, 0.95) 100%);
    border: 1px solid rgba(100, 200, 255, 0.3);
    border-top: 2px solid var(--ffx-cyan);
    border-radius: 4px;
    transform: skewX(-15deg);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(0, 100, 255, 0.1);
    padding: 0 15px;
    backdrop-filter: blur(4px);
}

.team-wing::after {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: wingShimmer 4s infinite;
}

@keyframes wingShimmer {
    0% { transform: translateX(-100%); }
    20% { transform: translateX(100%); }
    100% { transform: translateX(100%); }
}

.team-wing.away {
    transform: skewX(15deg);
    flex-direction: row-reverse;
    border-top-color: #ff6666;
    background: linear-gradient(-160deg, rgba(60, 20, 20, 0.9) 0%, rgba(20, 5, 5, 0.95) 100%);
}

.team-data {
    display: flex;
    flex-direction: column;
    justify-content: center;
    transform: skewX(15deg);
    flex-grow: 1;
}
.team-wing.away .team-data { transform: skewX(-15deg); text-align: right; }

.team-name {
    font-family: var(--font-title);
    font-size: 16px;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 0 5px rgba(0, 150, 255, 0.8);
}
.team-sub {
    font-family: var(--font-data);
    font-size: 10px;
    color: var(--ffx-cyan);
    opacity: 0.8;
    letter-spacing: 2px;
}
.team-wing.away .team-sub { color: #ffaaaa; }

.score-box {
    font-family: var(--font-data);
    font-size: 42px;
    color: white;
    text-shadow: 0 0 15px var(--ffx-cyan-glow);
    transform: skewX(15deg);
    margin: 0 5px;
    min-width: 30px;
    text-align: center;
}
.team-wing.away .score-box { transform: skewX(-15deg); text-shadow: 0 0 15px #ff4444; }

.timer-complex {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: -5px;
}

.timer-crystal-ring {
    position: absolute;
    top: -30px;
    width: 140px;
    height: 70px;
    border-radius: 50%;
    border-top: 3px solid var(--ffx-gold);
    border-bottom: 1px solid transparent;
    box-shadow: 0 -5px 20px rgba(200, 180, 100, 0.4), inset 0 10px 20px rgba(0,0,0,0.5);
    z-index: -1;
    background: radial-gradient(ellipse at top, rgba(20, 40, 80, 0.9), transparent 70%);
    backdrop-filter: blur(4px);
}

#half-indicator {
    font-family: var(--font-spira);
    font-size: 12px;
    color: var(--ffx-gold);
    letter-spacing: 4px;
    margin-bottom: -4px;
    text-shadow: 0 0 5px var(--ffx-gold-dark);
    text-transform: uppercase;
}

#timer-display {
    font-family: var(--font-data);
    font-size: 48px;
    background: linear-gradient(to bottom, #fff 0%, #ffd700 50%, #b8860b 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 2px 0px rgba(0,0,0,0.8));
    letter-spacing: 2px;
}
/* --- PLAYER STATUS PANEL --- */
#player-status-panel {
    position: absolute;
    bottom: max(160px, env(safe-area-inset-bottom) + 40px);
    left: max(20px, env(safe-area-inset-left));
    width: 160px;
    padding: 10px;
    background: linear-gradient(90deg, rgba(0, 10, 30, 0.8) 0%, rgba(0,0,0,0) 100%);
    border-left: 3px solid var(--ffx-cyan);
    border-radius: 0 10px 10px 0;
    backdrop-filter: blur(4px);
    transform: skewX(-10deg);
    pointer-events: none;
    display: none;
}

.char-name {
    font-family: var(--font-title);
    font-size: 18px;
    color: white;
    text-transform: uppercase;
    margin-bottom: 5px;
    transform: skewX(10deg);
    text-shadow: 0 0 5px var(--ffx-blue-light);
}

.hp-gauge-container {
    display: flex;
    align-items: center;
    margin-bottom: 4px;
    transform: skewX(10deg);
}
.hp-label { font-size: 10px; color: var(--ffx-cyan); width: 20px; }
.hp-bar-track {
    flex-grow: 1;
    height: 6px;
    background: rgba(0,0,0,0.5);
    border: 1px solid #444;
    margin: 0 5px;
}
.hp-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #00ff00, #ccffcc);
    box-shadow: 0 0 5px #00ff00;
}
.hp-value { font-size: 10px; color: #fff; width: 45px; text-align: right; }

.tech-gauge-container {
    display: flex;
    align-items: center;
    transform: skewX(10deg);
}
.tech-label { font-size: 10px; color: var(--ffx-gold); width: 20px; }
.tech-bar-track {
    flex-grow: 1;
    height: 4px;
    background: rgba(0,0,0,0.5);
    border: 1px solid #444;
    margin: 0 5px;
}
.tech-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffaa00, #ffffaa);
}

/* --- MINIMAP --- */
#minimap-container {
    position: absolute;
    top: max(80px, env(safe-area-inset-top) + 60px);
    right: max(20px, env(safe-area-inset-right));
    width: 110px;
    height: 110px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.radar-rim {
    position: absolute;
    width: 100%; height: 100%;
    border-radius: 50%;
    border: 2px solid var(--ffx-blue-light);
    box-shadow: 0 0 15px var(--ffx-blue-mid), inset 0 0 20px rgba(0,0,0,0.8);
    background: radial-gradient(circle, rgba(0, 20, 60, 0.4) 0%, rgba(0, 5, 10, 0.8) 100%);
    z-index: 5;
}

#minimap {
    position: relative;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    z-index: 6;
    overflow: hidden;
}

.radar-label {
    position: absolute;
    bottom: -15px;
    width: 140%;
    left: -20%;
    text-align: center;
    font-family: var(--font-spira);
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 0 5px var(--ffx-cyan);
}

.map-dot {
    position: absolute;
    width: 6px; height: 6px;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 4px currentColor;
}
.map-dot.home { background: var(--ffx-cyan); color: var(--ffx-cyan); }
.map-dot.away { background: #ff4444; color: #ff4444; }
.map-dot.ball { 
    background: #ff00cc;
    color: #ff00cc; 
    width: 12px; height: 12px;
    border: 2px solid #ffffff;
    z-index: 20;
    animation: blinkBall 0.3s infinite alternate;
    box-shadow: 0 0 6px #ff00cc;
}
.map-dot.nap { background: #333; color: #000; border: 1px solid #555; }
.map-dot.active-player { 
    background: #00ff00 !important; 
    color: #00ff00 !important; 
    box-shadow: 0 0 8px #00ff00;
    z-index: 15;
    transform: translate(-50%, -50%) scale(1.2);
}
.map-dot.ball-carrier {
    box-shadow: 0 0 15px #fff, 0 0 30px #ffaa00;
    border: 2px solid #ffffff;
    background-color: #ffaa00 !important;
    z-index: 100;
    width: 10px; height: 10px;
    animation: carrierPulse 0.8s infinite alternate;
}
@keyframes carrierPulse {
    from { transform: translate(-50%, -50%) scale(1.2); box-shadow: 0 0 10px #fff; opacity: 0.8; }
    to { transform: translate(-50%, -50%) scale(1.8); box-shadow: 0 0 25px #ffcc00; opacity: 1.0; }
}
@keyframes blinkBall { from { opacity: 1; transform: translate(-50%, -50%) scale(1); } to { opacity: 0.5; transform: translate(-50%, -50%) scale(1.3); } }

/* --- ANNOUNCEMENTS --- */
#announcement {
    position: absolute;
    top: 40%; 
    left: 5%; 
    width: 90%;
    text-align: center;
    font-family: var(--font-data);
    font-size: clamp(40px, 12vw, 72px);
    font-weight: 900;
    font-style: italic;
    text-transform: uppercase;
    letter-spacing: 2px;
    line-height: 1.0;
    white-space: normal;
    background: linear-gradient(to bottom, #fff 0%, #ffd700 40%, #b8860b 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 10px rgba(255, 100, 0, 0.5)) drop-shadow(3px 3px 0 #000);
    display: none;
    z-index: 2000;
    animation: announceSlide 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    pointer-events: none;
}

@keyframes announceSlide {
    from { transform: scale(0) rotate(-5deg); opacity: 0; }
    to { transform: scale(1) rotate(0deg); opacity: 1; }
}

/* --- JOYSTICK --- */
#joystick-hit-zone {
    position: absolute;
    bottom: 0; left: 0;
    width: 50%; height: 50%;
    z-index: 1000;
    background: rgba(0,0,0,0); 
    touch-action: none;
    pointer-events: auto;
}

#joystick-visual-container {
    position: absolute;
    top: 0; left: 0;
    width: 0; height: 0;
    overflow: visible;
    pointer-events: none;
    display: none;
    z-index: 1100;
}

#joystick-base {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 120px; height: 120px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(0, 40, 80, 0.4) 0%, rgba(0, 10, 20, 0.1) 60%, transparent 100%);
    border: 1px solid rgba(100, 220, 255, 0.3);
    box-shadow: 0 0 20px rgba(0, 100, 255, 0.2), inset 0 0 30px rgba(0, 50, 100, 0.3);
    animation: basePulse 2s infinite alternate;
}

@keyframes basePulse {
    from { box-shadow: 0 0 10px rgba(0, 100, 255, 0.2); border-color: rgba(100, 220, 255, 0.2); }
    to { box-shadow: 0 0 25px rgba(0, 100, 255, 0.5); border-color: rgba(100, 255, 255, 0.6); }
}

#joystick-knob {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 50px; height: 50px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, #e0ffff 0%, #00aaff 40%, #004488 80%, #001122 100%);
    border: 2px solid #88ccff;
    box-shadow: 0 0 15px #00ffff, inset 0 0 10px rgba(255,255,255,0.8);
    transition: transform 0.05s linear;
}

#joystick-knob::after {
    content: "";
    position: absolute;
    top: 20%; left: 20%; width: 20%; height: 20%;
    background: radial-gradient(circle, #ffffff 0%, transparent 70%);
    filter: blur(2px);
    opacity: 0.8;
}

.touch-ripple {
    position: absolute;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(200, 255, 255, 0.8) 0%, rgba(0, 255, 255, 0.4) 40%, transparent 70%);
    transform: translate(-50%, -50%) scale(0);
    animation: rippleAnim 0.6s ease-out forwards;
    pointer-events: none;
    z-index: 9000;
    mix-blend-mode: screen;
}

@keyframes rippleAnim {
    0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(3.0); opacity: 0; }
}

#camera-zone {
    position: absolute;
    top: 0; right: 0; width: 50%; height: 100%;
    pointer-events: auto;
    touch-action: none;
    z-index: 50;
}

/* --- ACTION BUTTON --- */
#action-container {
    position: absolute;
    bottom: max(40px, env(safe-area-inset-bottom)); 
    right: max(40px, env(safe-area-inset-right));
    display: flex;
    flex-direction: column;
    align-items: center;
    pointer-events: auto;
    z-index: 100;
}

.command-menu-bg {
    position: absolute;
    width: 180px; height: 80px;
    bottom: 15px;
    background: linear-gradient(90deg, transparent 0%, rgba(0, 10, 30, 0.8) 50%, transparent 100%);
    border-bottom: 1px solid rgba(0, 200, 255, 0.3);
    z-index: -1;
}

.command-ring {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 130px; height: 130px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-top: 2px solid rgba(0, 255, 255, 0.6);
    border-bottom: 2px solid rgba(0, 255, 255, 0.6);
    border-radius: 50%;
    animation: spinReverse 15s linear infinite;
    pointer-events: none;
    box-shadow: 0 0 15px rgba(0, 100, 255, 0.2);
}
@keyframes spinReverse { from { transform: translate(-50%, -50%) rotate(360deg); } to { transform: translate(-50%, -50%) rotate(0deg); } }

#action-label {
    font-family: var(--font-spira);
    font-size: 12px;
    color: var(--ffx-cyan);
    background: rgba(0, 5, 10, 0.8);
    padding: 4px 12px;
    border: 1px solid var(--ffx-blue-light);
    border-radius: 10px;
    margin-bottom: 15px;
    text-transform: uppercase;
    letter-spacing: 2px;
    box-shadow: 0 0 10px rgba(0,0,0,0.8);
    text-shadow: 0 0 5px var(--ffx-cyan);
    transition: all 0.3s;
}

#action-button {
    position: absolute;
    top: 0; left: 0;
    width: 100px; height: 100px;
    border-radius: 50%;
    cursor: pointer;
    transition: transform 0.1s, filter 0.3s;
    background: radial-gradient(circle at 35% 35%, #ffffff 0%, #0088ff 40%, #002266 80%, #000 100%);
    border: 3px solid #44aaff;
    box-shadow: 0 0 20px rgba(0, 100, 255, 0.8), inset 0 0 20px rgba(255, 255, 255, 0.4);
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: visible;
    z-index: 10;
}

#pass-button {
    display: none !important;
    position: absolute;
    bottom: -20px; left: -30px;
    width: 60px; height: 60px;
    border-radius: 50%;
    cursor: pointer;
    z-index: 9;
}

#action-button::before {
    content: '';
    position: absolute;
    top: -40px; left: -40px; right: -40px; bottom: -40px;
    border-radius: 50%;
    z-index: 10;
}

#action-button:active { transform: scale(0.92); }

#action-button .btn-text {
    font-family: var(--font-title);
    font-size: 22px;
    font-weight: bold;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8), 0 0 10px rgba(255,255,255,0.5);
    z-index: 5;
    pointer-events: none;
    letter-spacing: 1px;
}

#action-button .btn-glare {
    position: absolute;
    top: -50%; left: -50%; width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.4) 50%, transparent 60%);
    animation: glarePass 5s infinite;
    pointer-events: none;
    z-index: 6;
    border-radius: 50%;
}

.limit-ring {
    position: absolute;
    top: -5px; left: -5px; right: -5px; bottom: -5px;
    border-radius: 50%;
    border: 2px solid transparent;
    box-shadow: 0 0 0 transparent;
    transition: all 0.5s;
    z-index: 1;
    pointer-events: none;
}

#action-button.shoot-mode {
    background: radial-gradient(circle at 35% 35%, #ffffaa 0%, #ffaa00 40%, #882200 80%, #220000 100%);
    border-color: #ffcc00;
    box-shadow: 0 0 30px rgba(255, 100, 0, 0.8), inset 0 0 20px rgba(255, 255, 0, 0.5);
}

#action-button.limit-ready .limit-ring {
    border-color: #ffdd44;
    animation: limitPulse 0.8s ease-in-out infinite alternate;
}

.shoot-label {
    color: #ffdd44 !important;
    border-color: #ffaa00 !important;
    text-shadow: 0 0 10px #ff4400 !important;
}

@keyframes limitPulse {
    0% { transform: scale(1.0); box-shadow: 0 0 10px #ffaa00, inset 0 0 5px #ffaa00; opacity: 0.5; }
    100% { transform: scale(1.15); box-shadow: 0 0 30px #ff4400, inset 0 0 15px #ff0000; opacity: 1.0; }
}

/* --- AUTO TOGGLE --- */
#auto-toggle {
    position: absolute;
    top: max(200px, env(safe-area-inset-top) + 60px); 
    right: max(20px, env(safe-area-inset-right));
    width: 110px;
    padding: 10px 0;
    text-align: center;
    font-size: 12px;
    font-weight: bold;
    color: var(--ffx-cyan);
    background: linear-gradient(135deg, rgba(0, 20, 40, 0.8) 0%, rgba(0, 5, 10, 0.9) 100%);
    border: 1px solid var(--ffx-blue-light);
    border-top: 1px solid var(--ffx-cyan);
    border-radius: 4px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    backdrop-filter: blur(4px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    pointer-events: auto;
    transition: all 0.2s;
    z-index: 100;
}

#auto-toggle:hover {
    background: rgba(0, 40, 80, 0.9);
    box-shadow: 0 0 15px var(--ffx-cyan);
    color: white;
}

#auto-toggle.active {
    background: linear-gradient(135deg, rgba(100, 20, 0, 0.8) 0%, rgba(40, 0, 0, 0.9) 100%);
    border-color: #ff4400;
    color: #ffaa00;
    animation: pulseRed 2s infinite;
}
@keyframes pulseRed { 0% { box-shadow: 0 0 5px #ff0000; } 50% { box-shadow: 0 0 20px #ff4400; } 100% { box-shadow: 0 0 5px #ff0000; } }

/* --- FLOATING TEXT --- */
.floating-text-wrapper {
    position: absolute;
    top: 0; left: 0;
    pointer-events: none;
    z-index: 2000;
    will-change: transform;
}

.floating-text-inner {
    display: block;
    font-family: var(--font-data);
    font-weight: 900;
    text-transform: uppercase;
    white-space: nowrap;
    text-align: center;
    font-size: 24px; 
    text-shadow: 1px 1px 0 #000;
    opacity: 0.9;
}

.floating-text-inner.damage {
    font-size: 42px;
    font-style: italic;
    background: linear-gradient(to bottom, #ffffff 0%, #ffcc00 40%, #ff4400 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 4px 4px rgba(0,0,0,0.8));
    animation: popDamage 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

.floating-text-inner.heal {
    font-size: 36px;
    color: #44ff44;
    text-shadow: 0 0 10px #00ff00;
    animation: floatUp 1s ease-out forwards;
}

.floating-text-inner.venom {
    font-family: var(--font-data);
    font-size: 42px;
    font-style: italic;
    color: #aaff00;
    text-shadow: 0 0 10px #448800, 2px 2px 0 #002200;
    background: linear-gradient(to bottom, #ccff66 0%, #66cc00 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 5px rgba(100, 255, 0, 0.5));
    animation: dripStatus 2s infinite;
}

.floating-text-inner.sleep {
    font-family: var(--font-title);
    font-size: 42px;
    color: #ffffff;
    text-shadow: 0 0 15px #0044ff, 0 0 30px #0000ff;
    opacity: 0.9;
    animation: driftStatus 3s ease-in-out infinite;
}

.floating-text-inner.wither {
    font-family: var(--font-data);
    font-size: 38px;
    color: #cccccc;
    text-shadow: 2px 2px 0 #444444;
    background: linear-gradient(to bottom, #eeeeee 0%, #888888 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: witherStatus 1.5s forwards;
}

.floating-text-inner.tech {
    font-family: var(--font-title);
    font-size: 32px;
    color: #00ffff;
    background: rgba(0, 10, 30, 0.7);
    padding: 2px 10px;
    border: 1px solid #00ffff;
    border-radius: 4px;
    box-shadow: 0 0 10px #0088ff;
    text-shadow: 0 0 5px #fff;
    animation: shakeTech 0.6s ease-in-out, flashTech 0.3s;
    transform-origin: center;
}

.floating-text-inner.save, .floating-text-inner.block {
    font-size: 48px;
    font-weight: 900;
    color: #ffffff;
    -webkit-text-stroke: 1px #004488;
    text-shadow: 0 0 20px #0088ff;
    animation: popDamage 0.5s ease-out forwards;
}

@keyframes popDamage {
    0% { transform: scale(0.5); opacity: 0; }
    20% { transform: scale(1.5); opacity: 1; }
    40% { transform: scale(1.0); opacity: 1; }
    100% { transform: scale(1.0); opacity: 0; }
}

@keyframes floatUp {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(-50px); opacity: 0; }
}

@keyframes dripStatus {
    0% { transform: scaleY(1); filter: blur(0px); }
    50% { transform: scaleY(1.1) translateY(5px); filter: blur(1px); }
    100% { transform: scaleY(1); filter: blur(0px); }
}

@keyframes driftStatus {
    0% { transform: translateX(0) rotate(0deg); opacity: 0; }
    20% { opacity: 1; }
    50% { transform: translateX(15px) translateY(-20px) rotate(10deg); }
    100% { transform: translateX(-15px) translateY(-50px) rotate(-10deg); opacity: 0; }
}

@keyframes witherStatus {
    0% { transform: scale(1); filter: grayscale(0%); opacity: 1; }
    100% { transform: scale(0.6); filter: grayscale(100%); opacity: 0; }
}

@keyframes shakeTech {
    0% { transform: scale(0.8); }
    10%, 30%, 50%, 70%, 90% { transform: scale(1.1) translate(-2px, 2px); }
    20%, 40%, 60%, 80% { transform: scale(1.1) translate(2px, -2px); }
    100% { transform: scale(1.0); }
}

@keyframes flashTech {
    0% { background-color: #fff; color: #000; border-color: #fff; }
    100% { background-color: rgba(0, 10, 30, 0.85); color: #00ffff; border-color: #00ffff; }
}

#loading {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    color: var(--ffx-cyan);
    text-transform: uppercase;
    letter-spacing: 5px;
    animation: blink 1s infinite;
}
@keyframes blink { 50% { opacity: 0.5; } }

#controls-hint {
    position: absolute;
    top: 130px; width: 100%;
    text-align: center;
    font-size: 10px;
    color: rgba(255,255,255,0.4);
    text-transform: uppercase;
    pointer-events: none;
}

.floating-text-inner.comic-impact {
    font-family: 'Impact', sans-serif;
    font-size: 42px;
    color: #ffff00; 
    -webkit-text-stroke: 1px #000;
    text-shadow: 3px 3px 0 #ff0000;
    font-style: italic;
    transform-origin: center;
    white-space: nowrap;
    animation: comicPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    z-index: 2500;
}

.floating-text-inner.comic-action {
    font-family: 'Arial Black', sans-serif;
    font-size: 28px;
    color: #00ffff; 
    -webkit-text-stroke: 1px #000;
    text-shadow: 2px 2px 0 #0044aa;
    font-style: italic;
    white-space: nowrap;
    animation: comicSlide 0.4s ease-out forwards;
    z-index: 2500;
}

@keyframes comicPop {
    0% { transform: scale(0) rotate(-20deg); opacity: 0; }
    40% { transform: scale(1.2) rotate(5deg); opacity: 1; }
    60% { transform: scale(1.0) rotate(-5deg); opacity: 1; }
    100% { transform: scale(1.1) rotate(0deg); opacity: 0; }
}

@keyframes comicSlide {
    0% { transform: translate(-20px, 20px) scale(0.5); opacity: 0; }
    100% { transform: translate(20px, -20px) scale(1.2); opacity: 0; }
}

/* --- MAIN MENU --- */
/* --- MAIN MENU & END GAME (FFX STYLE) --- */
#main-menu, #end-game-menu {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.8s cubic-bezier(0.2, 0.8, 0.2, 1.0);
    background: radial-gradient(circle at center, rgba(0, 20, 60, 0.4) 0%, rgba(0, 5, 10, 0.8) 100%);
    backdrop-filter: blur(5px);
}

#main-menu.active, #end-game-menu.active {
    opacity: 1;
    pointer-events: auto;
}

.menu-bg-overlay, .end-bg-layer {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: 
        linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,0.1) 50%), 
        repeating-linear-gradient(90deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 1px, transparent 1px, transparent 20px);
    background-size: 100% 4px, 100% 100%;
    pointer-events: none;
    z-index: -1;
}

/* LOGO STYLING */
.ffx-logo-container {
    margin-bottom: 50px;
    text-align: center;
    transform: skewX(-10deg);
    position: relative;
}

.ffx-logo-main {
    font-family: var(--font-title);
    font-size: clamp(48px, 10vw, 84px);
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 8px;
    background: linear-gradient(to bottom, #ffffff 0%, #aaccff 40%, #0088ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 15px rgba(0, 100, 255, 0.8));
    animation: logoShimmer 3s infinite alternate;
}

.ffx-logo-sub {
    font-family: var(--font-spira);
    font-size: clamp(14px, 3vw, 24px);
    color: var(--ffx-gold);
    letter-spacing: 15px;
    margin-top: -10px;
    text-shadow: 0 0 10px #ffaa00;
    opacity: 0.9;
}

@keyframes logoShimmer {
    0% { filter: drop-shadow(0 0 10px rgba(0, 100, 255, 0.5)); }
    100% { filter: drop-shadow(0 0 25px rgba(0, 200, 255, 0.9)); }
}

/* MENU OPTIONS */
.menu-options, .end-options {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 320px;
}

.menu-item {
    position: relative;
    padding: 12px 30px;
    background: linear-gradient(90deg, rgba(0, 30, 60, 0.8) 0%, rgba(0, 10, 20, 0.2) 100%);
    border-left: 3px solid rgba(100, 200, 255, 0.3);
    border-bottom: 1px solid rgba(100, 200, 255, 0.1);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1.0);
    transform: skewX(-15deg);
    display: flex;
    align-items: center;
    overflow: hidden;
}

.menu-item::before {
    content: '';
    position: absolute;
    top: 0; left: -100%; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.4s;
}

.menu-item:hover::before {
    left: 100%;
}

.menu-item:hover {
    background: linear-gradient(90deg, rgba(0, 80, 160, 0.9) 0%, rgba(0, 20, 40, 0.4) 100%);
    border-left-color: #00ffff;
    padding-left: 45px;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
}

.menu-item .label {
    font-family: var(--font-title);
    font-size: 20px;
    color: #cccccc;
    letter-spacing: 3px;
    text-transform: uppercase;
    transform: skewX(15deg);
    transition: color 0.2s;
}

.menu-item:hover .label {
    color: #ffffff;
    text-shadow: 0 0 10px #00ffff;
}

.menu-item .cursor {
    width: 10px; height: 10px;
    background: var(--ffx-gold);
    border-radius: 50%;
    margin-right: 15px;
    opacity: 0;
    transform: translateX(-20px) skewX(15deg);
    transition: all 0.3s;
    box-shadow: 0 0 10px var(--ffx-gold);
}

.menu-item:hover .cursor {
    opacity: 1;
    transform: translateX(0) skewX(15deg);
}

.menu-footer {
    position: absolute;
    bottom: 30px;
    font-family: var(--font-ui);
    font-size: 10px;
    color: rgba(255,255,255,0.3);
    letter-spacing: 4px;
    text-transform: uppercase;
}

/* END GAME SPECIFIC */
.result-header {
    text-align: center;
    margin-bottom: 40px;
    transform: skewX(-10deg);
}

.result-title {
    font-family: var(--font-title);
    font-size: 72px;
    color: #fff;
    text-shadow: 0 0 20px #00aaff, 0 0 40px #0044aa;
    letter-spacing: 5px;
    line-height: 1.0;
}

.result-subtitle {
    font-family: var(--font-spira);
    font-size: 18px;
    color: var(--ffx-gold);
    letter-spacing: 8px;
    margin-top: 5px;
}

.final-score-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 40px;
    margin-bottom: 50px;
    background: linear-gradient(90deg, transparent, rgba(0, 20, 50, 0.8), transparent);
    padding: 20px 0;
    width: 100%;
}

.final-team {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 120px;
}

.final-score-digit {
    font-family: var(--font-data);
    font-size: 80px;
    color: #ffffff;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    line-height: 1.0;
}

.final-team.home .final-score-digit { color: #00ffff; text-shadow: 0 0 20px #00ffff; }
.final-team.away .final-score-digit { color: #ff4444; text-shadow: 0 0 20px #ff4444; }

.final-team-name {
    font-family: var(--font-title);
    font-size: 14px;
    color: #aaa;
    letter-spacing: 2px;
    margin-top: 5px;
}

.final-vs {
    display: flex;
    flex-direction: column;
    align-items: center;
    opacity: 0.6;
}

.final-vs span {
    font-family: var(--font-spira);
    font-size: 24px;
    color: var(--ffx-gold);
    margin: 5px 0;
}

.vs-line {
    width: 2px; height: 30px;
    background: linear-gradient(to bottom, transparent, var(--ffx-gold), transparent);
}
/* --- PRACTICE OVERLAY --- */
#practice-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 5, 10, 0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2500;
    pointer-events: none;
}

#practice-overlay.active {
    display: flex;
}

.practice-panel {
    position: absolute;
    top: max(60px, env(safe-area-inset-top) + 40px); 
    right: max(20px, env(safe-area-inset-right));
    width: 280px;
    background: linear-gradient(160deg, rgba(0, 20, 50, 0.95) 0%, rgba(0, 10, 20, 0.98) 100%);
    border: 1px solid #4488ff;
    border-radius: 0 0 15px 0;
    box-shadow: 0 0 20px rgba(0, 100, 255, 0.2), inset 0 0 50px rgba(0, 20, 60, 0.5);
    padding: 15px;
    pointer-events: auto;
    transform: skewX(-2deg);
    backdrop-filter: blur(5px);
}

.panel-header {
    margin-bottom: 15px;
    text-align: center;
}

.panel-title-group {
    display: flex;
    flex-direction: column;
}

.panel-title {
    font-family: var(--font-title);
    font-size: clamp(18px, 6vw, 24px);
    color: #ffffff;
    text-shadow: 0 0 10px #00ffff;
    letter-spacing: 2px;
}

.panel-subtitle {
    font-family: var(--font-spira);
    font-size: 8px;
    color: #4488ff;
    letter-spacing: 4px;
    margin-top: -2px;
}

.panel-deco-line {
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, transparent, #00ffff, transparent);
    margin-top: 5px;
    box-shadow: 0 0 5px #00ffff;
}

.panel-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.section-label {
    font-family: var(--font-ui);
    font-size: 10px;
    color: var(--ffx-gold);
    border-bottom: 1px solid rgba(200, 176, 96, 0.3);
    margin-bottom: 5px;
    padding-bottom: 2px;
    letter-spacing: 1px;
}

.drill-list {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.drill-btn {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    background: linear-gradient(90deg, rgba(255, 255, 255, 0.05), transparent);
    border-left: 2px solid transparent;
    cursor: pointer;
    font-family: var(--font-data);
    font-size: 14px;
    color: #aaa;
    transition: all 0.2s;
}

.drill-btn:hover {
    background: linear-gradient(90deg, rgba(0, 255, 255, 0.1), transparent);
    color: #fff;
    padding-left: 15px;
}

.drill-btn.active {
    background: linear-gradient(90deg, rgba(0, 100, 255, 0.4), transparent);
    border-left: 3px solid #00ffff;
    color: #fff;
    text-shadow: 0 0 5px #00ffff;
}

.drill-btn .icon {
    width: 20px;
    text-align: center;
    margin-right: 10px;
    color: var(--ffx-cyan);
}

.option-list {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.option-toggle {
    display: flex;
    align-items: center;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 12px;
    color: #ccc;
    transition: color 0.2s;
}

.option-toggle:hover { color: #fff; }

.option-toggle .checkbox {
    margin-right: 10px;
    color: #444;
    font-family: monospace;
    font-size: 14px;
}

.option-toggle.active .checkbox {
    color: #00ff00;
    text-shadow: 0 0 5px #00ff00;
}

.option-toggle.active {
    color: #fff;
}

.action-btn {
    text-align: center;
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid #444;
    padding: 6px;
    font-size: 11px;
    color: #aaa;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.action-btn:hover {
    border-color: #fff;
    color: #fff;
    background: rgba(255, 255, 255, 0.1);
}

#p-exit:hover {
    border-color: #ff4444;
    color: #ff4444;
    background: rgba(50, 0, 0, 0.3);
}

.panel-footer {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    text-align: center;
}

#drill-instruction {
    font-size: 10px;
    color: var(--ffx-cyan);
    margin-bottom: 5px;
    font-style: italic;
}

#drill-score {
    font-family: var(--font-data);
    font-size: 24px;
    color: var(--ffx-gold);
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

.panel-minimize-btn {
    position: absolute;
    top: 10px; right: 10px;
    width: 20px; height: 20px;
    border: 1px solid var(--ffx-cyan);
    color: var(--ffx-cyan);
    text-align: center;
    line-height: 18px;
    cursor: pointer;
    font-size: 14px;
    background: rgba(0,0,0,0.5);
    transition: all 0.2s;
}
.panel-minimize-btn:hover { 
    background: var(--ffx-cyan); 
    color: #000; 
    box-shadow: 0 0 5px var(--ffx-cyan);
}

#practice-restore-btn {
    position: absolute;
    top: max(60px, env(safe-area-inset-top) + 40px); 
    right: max(20px, env(safe-area-inset-right));
    padding: 8px 15px;
    background: linear-gradient(90deg, rgba(0, 20, 50, 0.9) 0%, rgba(0, 10, 20, 0.9) 100%);
    border: 1px solid var(--ffx-cyan);
    border-left: 3px solid var(--ffx-cyan);
    color: var(--ffx-cyan);
    font-family: var(--font-data);
    font-size: 12px;
    letter-spacing: 1px;
    cursor: pointer;
    z-index: 2400;
    display: none;
    pointer-events: auto;
    transform: skewX(-10deg);
    box-shadow: 0 0 10px rgba(0, 100, 255, 0.2);
    text-transform: uppercase;
}
#practice-restore-btn:hover {
    background: rgba(0, 40, 80, 0.9);
    color: #fff;
    text-shadow: 0 0 5px #00ffff;
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
}

/* --- AIM JOYSTICK --- */
#aim-joystick-zone {
    position: absolute;
    bottom: max(150px, env(safe-area-inset-bottom));
    right: 0;
    width: 40%;
    height: 35%;
    z-index: 1000;
    background: rgba(0,0,0,0);
    touch-action: none;
    pointer-events: auto;
}

#aim-joystick-visual {
    position: absolute;
    top: 0; left: 0;
    width: 0; height: 0;
    overflow: visible;
    pointer-events: none;
    display: none;
    z-index: 1100;
}

#aim-joystick-base {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 90px; height: 90px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(255, 100, 0, 0.3) 0%, rgba(80, 20, 0, 0.1) 60%, transparent 100%);
    border: 1px solid rgba(255, 150, 50, 0.4);
    box-shadow: 0 0 15px rgba(255, 100, 0, 0.2), inset 0 0 20px rgba(255, 50, 0, 0.2);
}

#aim-joystick-knob {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 40px; height: 40px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, #ffcc88 0%, #ff6600 40%, #882200 80%, #220000 100%);
    border: 2px solid #ffaa44;
    box-shadow: 0 0 10px #ff4400, inset 0 0 8px rgba(255,255,255,0.6);
    transition: transform 0.05s linear;
}

#aim-joystick-knob::after {
    content: "AIM";
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 8px;
    color: white;
    font-family: var(--font-data);
    text-shadow: 0 0 3px #000;
}

/* --- TACKLE BUTTON --- */
#tackle-button {
    position: absolute;
    bottom: max(160px, env(safe-area-inset-bottom) + 100px);
    right: max(40px, env(safe-area-inset-right));
    width: 70px;
    height: 70px;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    justify-content: center;
    align-items: center;
    pointer-events: auto;
    z-index: 100;
    background: radial-gradient(circle at 35% 35%, #ff8888 0%, #cc0000 40%, #660000 80%, #220000 100%);
    border: 3px solid #ff4444;
    box-shadow: 0 0 15px rgba(255, 50, 50, 0.6), inset 0 0 15px rgba(255, 200, 200, 0.3);
    transition: transform 0.1s, filter 0.2s;
}

#tackle-button:active {
    transform: scale(0.9);
    filter: brightness(1.2);
}

#tackle-button.active {
    background: radial-gradient(circle at 35% 35%, #ffffff 0%, #ff4444 40%, #aa0000 80%, #440000 100%);
    box-shadow: 0 0 25px rgba(255, 100, 100, 0.9);
}

#tackle-button .btn-text {
    font-family: var(--font-data);
    font-size: 12px;
    font-weight: bold;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    pointer-events: none;
    text-transform: uppercase;
    letter-spacing: 1px;
}

#tackle-button .btn-glare {
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.3) 50%, transparent 60%);
    pointer-events: none;
    border-radius: 50%;
    animation: glarePass 4s infinite;
}

#tackle-button.urgent {
    animation: urgentPulse 0.5s infinite alternate;
    background: radial-gradient(circle at 35% 35%, #ff5555 0%, #ff0000 40%, #880000 100%);
    border-color: #ffaaaa;
    box-shadow: 0 0 20px #ff0000;
}

@keyframes urgentPulse {
    from { transform: scale(1.0); }
    to { transform: scale(1.15); }
}

/* --- CHARGE POWER METER --- */
#charge-meter-container {
    position: absolute;
    bottom: max(250px, env(safe-area-inset-bottom) + 100px);
    left: 50%;
    transform: translateX(-50%);
    width: 200px;
    display: none;
    flex-direction: column;
    align-items: center;
    pointer-events: none;
    z-index: 2000;
    background: rgba(0, 10, 30, 0.8);
    padding: 10px 15px;
    border: 1px solid var(--ffx-cyan);
    border-radius: 5px;
    box-shadow: 0 0 15px rgba(0, 100, 255, 0.3);
}

.charge-label {
    font-family: var(--font-spira);
    font-size: 12px;
    color: var(--ffx-cyan);
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 5px;
}

.charge-meter-track {
    width: 100%;
    height: 12px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #444;
    border-radius: 6px;
    overflow: hidden;
}

#charge-meter-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #0af, #0f0);
    box-shadow: 0 0 10px #0f0;
    transition: width 0.05s linear, background 0.1s;
    border-radius: 5px;
}

.charge-hint {
    font-family: var(--font-ui);
    font-size: 10px;
    color: var(--ffx-gold);
    margin-top: 5px;
    opacity: 0.8;
    animation: blink 0.5s infinite;
}

/* --- GOAL DISTANCE INDICATOR --- */
#goal-distance-container {
    position: absolute;
    top: max(75px, env(safe-area-inset-top) + 55px);
    left: max(20px, env(safe-area-inset-left));
    display: flex;
    flex-direction: column;
    align-items: center;
    pointer-events: none;
    z-index: 100;
    background: linear-gradient(90deg, rgba(0, 10, 30, 0.7) 0%, transparent 100%);
    padding: 5px 15px 5px 10px;
    border-left: 2px solid var(--ffx-gold);
}

.distance-label {
    font-family: var(--font-spira);
    font-size: 8px;
    color: var(--ffx-gold);
    letter-spacing: 2px;
    text-transform: uppercase;
}

#goal-distance {
    font-family: var(--font-data);
    font-size: 24px;
    color: white;
    text-shadow: 0 0 5px var(--ffx-gold);
}

/* --- SETTINGS BUTTON --- */
#settings-button {
    position: absolute;
    top: max(240px, env(safe-area-inset-top) + 100px);
    right: max(20px, env(safe-area-inset-right));
    width: 110px;
    padding: 8px 0;
    text-align: center;
    font-size: 10px;
    font-weight: bold;
    color: #888;
    background: linear-gradient(135deg, rgba(20, 20, 20, 0.8) 0%, rgba(10, 10, 10, 0.9) 100%);
    border: 1px solid #444;
    border-radius: 4px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    pointer-events: auto;
    transition: all 0.2s;
    z-index: 100;
}

#settings-button:hover {
    background: rgba(40, 40, 40, 0.9);
    border-color: #888;
    color: #fff;
}

/* --- SETTINGS PANEL --- */
#settings-panel {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 280px;
    background: linear-gradient(160deg, rgba(0, 20, 50, 0.98) 0%, rgba(0, 10, 20, 0.99) 100%);
    border: 2px solid var(--ffx-cyan);
    border-radius: 10px;
    box-shadow: 0 0 30px rgba(0, 100, 255, 0.4);
    z-index: 3500;
    pointer-events: auto;
    backdrop-filter: blur(10px);
}

.settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid rgba(100, 200, 255, 0.3);
    background: rgba(0, 30, 60, 0.5);
}

.settings-header span {
    font-family: var(--font-title);
    font-size: 20px;
    color: white;
    text-shadow: 0 0 5px var(--ffx-cyan);
    letter-spacing: 3px;
}

#settings-close {
    width: 30px;
    height: 30px;
    border: 1px solid #ff4444;
    background: rgba(50, 0, 0, 0.5);
    color: #ff4444;
    font-size: 14px;
    cursor: pointer;
    border-radius: 5px;
    transition: all 0.2s;
}

#settings-close:hover {
    background: #ff4444;
    color: white;
}

.settings-content {
    padding: 20px;
}

.setting-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 5px;
}

.setting-row label {
    font-family: var(--font-data);
    font-size: 14px;
    color: #ccc;
}

.setting-row input[type="range"] {
    width: 100px;
    accent-color: var(--ffx-cyan);
}

.setting-row input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--ffx-cyan);
    cursor: pointer;
}

/* --- GLARE ANIMATION --- */
@keyframes glarePass {
    0% { transform: translateX(-100%) rotate(45deg); }
    30% { transform: translateX(100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}

/* --- STATUS TYPE FLOATING TEXT --- */
.floating-text-inner.status {
    font-family: var(--font-data);
    font-size: 28px;
    font-style: italic;
    color: #ff00ff;
    text-shadow: 0 0 10px #ff00ff, 2px 2px 0 #000;
    animation: statusPop 1.2s ease-out forwards;
}

@keyframes statusPop {
    0% { transform: scale(0.5) translateY(0); opacity: 0; }
    20% { transform: scale(1.3) translateY(-10px); opacity: 1; }
    100% { transform: scale(1.0) translateY(-40px); opacity: 0; }
}

/* --- GOAL TYPE FLOATING TEXT --- */
.floating-text-inner.goal {
    font-family: var(--font-data);
    font-size: 48px;
    font-weight: 900;
    background: linear-gradient(to bottom, #fff 0%, #ffd700 50%, #ff8800 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 4px 4px rgba(0,0,0,0.9));
    animation: goalPop 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

@keyframes goalPop {
    0% { transform: scale(0) rotate(-10deg); opacity: 0; }
    50% { transform: scale(1.5) rotate(5deg); opacity: 1; }
    100% { transform: scale(1.2) rotate(0deg); opacity: 0; }
}

/* --- DEFAULT TYPE FLOATING TEXT --- */
.floating-text-inner.default {
    font-family: var(--font-data);
    font-size: 24px;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    animation: floatUp 0.8s ease-out forwards;
}

/* --- MOBILE PORTRAIT OPTIMIZATIONS --- */
@media screen and (orientation: portrait) and (max-width: 600px) {
    .team-wing { width: 90px; padding: 0 5px; }
    .score-box { font-size: 24px; margin: 0 5px; }
    .team-name { font-size: 10px; }
    .team-sub { display: none; }
    
    .timer-crystal-ring { width: 80px; height: 40px; top: -15px; }
    #timer-display { font-size: 28px; }
    
    #minimap-container { width: 90px; height: 90px; }
    #minimap { width: 80px; height: 80px; }
    .radar-label { font-size: 10px; }
    
    .tech-text { font-size: 24px; }
    
    #action-button { width: 80px; height: 80px; }
    .command-ring { width: 100px; height: 100px; }
    #action-label { font-size: 10px; padding: 2px 8px; }
    
    #player-status-panel { width: 130px; bottom: max(140px, env(safe-area-inset-bottom) + 20px); }
    .char-name { font-size: 14px; }
    
    #auto-toggle, #settings-button, #practice-restore-btn {
        width: 90px;
        font-size: 9px;
        right: max(10px, env(safe-area-inset-right));
    }
    
    #goal-distance-container { left: max(10px, env(safe-area-inset-left)); }
#goal-distance { font-size: 18px; }
}

/* --- GESTURE HINT --- */
#gesture-hint {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 200px; height: 300px;
    pointer-events: none;
    display: none;
    z-index: 2500;
    opacity: 0.9;
}

#gesture-hint.active {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.curve-arrow {
    filter: drop-shadow(0 0 5px #00ffff);
    animation: dashDraw 1.5s linear infinite;
}

@keyframes dashDraw {
    to { stroke-dashoffset: -30; }
}

.gesture-text {
    font-family: var(--font-data);
    font-size: 24px;
    color: #ffffff;
    text-shadow: 0 0 10px #00ffff;
    margin-top: -50px;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-align: center;
}

.gesture-hand {
    font-size: 48px;
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    animation: handSwipe 1.5s ease-in-out infinite;
    filter: drop-shadow(0 0 10px black);
}

@keyframes handSwipe {
    0% { transform: translate(-50%, 50px) rotate(0deg); opacity: 0; }
    20% { opacity: 1; }
    80% { transform: translate(20px, -100px) rotate(20deg); opacity: 1; }
    100% { transform: translate(0px, -120px) rotate(10deg); opacity: 0; }
}

/* --- SWIPE TRAIL (INTUITIVE FEEDBACK) --- */
.swipe-trail-dot {
    position: absolute;
    width: 12px;
    height: 12px;
    background: radial-gradient(circle, #00ffff 0%, rgba(0, 255, 255, 0) 70%);
    border-radius: 50%;
    pointer-events: none;
    z-index: 9000;
    animation: fadeTrail 0.5s linear forwards;
    mix-blend-mode: screen;
}

@keyframes fadeTrail {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(0.2); opacity: 0; }
}
@keyframes fadeTrail {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(0.2); opacity: 0; }
}

/* --- OFFSCREEN INDICATOR --- */
#offscreen-indicator {
    position: absolute;
    top: 0; left: 0;
    width: 40px; height: 40px;
    margin-left: -20px; margin-top: -20px;
    z-index: 1500;
    pointer-events: none;
    display: none;
    filter: drop-shadow(0 0 5px #000);
}

#offscreen-indicator .arrow {
    width: 0; height: 0;
    border-left: 15px solid transparent;
    border-right: 15px solid transparent;
    border-bottom: 25px solid #00ff00; /* Green for player */
    animation: pulseArrow 0.5s infinite alternate;
    transform-origin: center bottom;
}

@keyframes pulseArrow {
    from { transform: scale(1); filter: brightness(1); }
    to { transform: scale(1.2); filter: brightness(1.5); }
}</style>

    <!-- Three.js Core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- GLTFLoader -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/utils/SkeletonUtils.js"></script>
    <!-- Lil-GUI -->
    <script src="https://cdn.jsdelivr.net/npm/lil-gui@0.19.1/dist/lil-gui.umd.min.js"></script>
<script type="importmap">{"imports":{"style.css":"data:text/css;base64,OnJvb3QgewogICAgLS1mZngtYmx1ZS1kZWVwOiAjMDIwNDA4OwogICAgLS1mZngtYmx1ZS1kYXJrOiAjMGExNTI1OwogICAgLS1mZngtYmx1ZS1taWQ6ICMxNTJhNDU7CiAgICAtLWZmeC1ibHVlLWxpZ2h0OiAjMmE0ZDc1OwogICAgLS1mZngtY3lhbjogIzYwYzBkMDsKICAgIC0tZmZ4LWN5YW4tZ2xvdzogIzAwZmZmZjsKICAgIC0tZmZ4LWdvbGQ6ICNjOGIwNjA7CiAgICAtLWZmeC1nb2xkLWxpZ2h0OiAjZjBlMDkwOwogICAgLS1mZngtZ29sZC1kYXJrOiAjOGE3MDMwOwogICAgLS1mZngtZ2xhc3MtYmc6IHJnYmEoMTAsIDIwLCA0MCwgMC43NSk7CiAgICAtLWZmeC1nbGFzcy1ib3JkZXI6IHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIAogICAgLS1mb250LXRpdGxlOiAnR2FyYW1vbmQnLCAnVGltZXMgTmV3IFJvbWFuJywgc2VyaWY7CiAgICAtLWZvbnQtZGF0YTogJ0ltcGFjdCcsICdBcmlhbCBOYXJyb3cnLCBzYW5zLXNlcmlmOwogICAgLS1mb250LXVpOiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAtLWZvbnQtc3BpcmE6ICdTcGlyYScsICdJbXBhY3QnLCBzYW5zLXNlcmlmOwp9CgpAZm9udC1mYWNlIHsKICAgIGZvbnQtZmFtaWx5OiAnU3BpcmEnOwogICAgc3JjOiB1cmwoJ2h0dHBzOi8vZmlsZXMuY2F0Ym94Lm1vZS96eW43czMudHRmJykgZm9ybWF0KCd0cnVldHlwZScpOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgIGZvbnQtc3R5bGU6IG5vcm1hbDsKfQoKaHRtbCwgYm9keSB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB3aWR0aDogMTAwdnc7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBwb3NpdGlvbjogZml4ZWQ7IAogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHJpZ2h0OiAwOwogICAgYm90dG9tOiAwOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBjb2xvcjogd2hpdGU7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICBwYWRkaW5nLXRvcDogZW52KHNhZmUtYXJlYS1pbnNldC10b3ApOwogICAgcGFkZGluZy1ib3R0b206IGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKTsKICAgIHBhZGRpbmctbGVmdDogZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KTsKICAgIHBhZGRpbmctcmlnaHQ6IGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpOwp9CgoqIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7Cn0KCi8qIC0tLSBNQUlOIEdBTUUgQ09OVEFJTkVSIC0tLSAqLwojZ2FtZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgbWF4LXdpZHRoOiBub25lOwogICAgYmFja2dyb3VuZDogIzAwMDUxMDsKICAgIGJveC1zaGFkb3c6IG5vbmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgdHJhbnNpdGlvbjogZmlsdGVyIDAuMDVzOwogICAgei1pbmRleDogMTsKfQoKLyogLS0tIElNUEFDVCBGWCAtLS0gKi8KI2dhbWUtY29udGFpbmVyLmltcGFjdC1meCB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuMXMgZWFzZS1pbi1vdXQ7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDEuMikgYnJpZ2h0bmVzcygxLjEpOwp9CgojZ2FtZS1jb250YWluZXIuaW1wYWN0LWhlYXZ5IHsKICAgIGFuaW1hdGlvbjogaW1wYWN0U2hha2UgMC4ycyBlYXNlLWluLW91dDsKICAgIGZpbHRlcjogY29udHJhc3QoMS41KSBicmlnaHRuZXNzKDEuMykgc2VwaWEoMC40KSBodWUtcm90YXRlKC0xMGRlZyk7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3Qtc2hhdHRlciB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuNHMgZWFzZS1pbi1vdXQ7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDIuMCkgaW52ZXJ0KDAuMSkgc2F0dXJhdGUoMi4wKTsKfQoKQGtleWZyYW1lcyBpbXBhY3RTaGFrZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDAsIDApOyB9CiAgICAyNSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNXB4LCA1cHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSg1cHgsIC01cHgpOyB9CiAgICA3NSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNXB4LCAtNXB4KTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDAsIDApOyB9Cn0KCi8qIC0tLSBDQU5WQVMgJiBSRU5ERVIgLS0tICovCmNhbnZhcyB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsKICAgIGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGltYWdlLXJlbmRlcmluZzogcGl4ZWxhdGVkOyAKICAgIHotaW5kZXg6IDA7Cn0KCi8qIC0tLSBHSUYgT1ZFUkxBWSAtLS0gKi8KI3NjcmVlbi1vdmVybGF5LWdpZiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgb2JqZWN0LWZpdDogY292ZXI7CiAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKICAgIG9wYWNpdHk6IDEuMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogOTUwOwogICAgaW1hZ2UtcmVuZGVyaW5nOiBwaXhlbGF0ZWQ7Cn0KCiN1aS1sYXllciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgei1pbmRleDogMTAwMDsKfQoKLyogLS0tIENJTkVNQVRJQyBCQVJTIC0tLSAqLwojY2luZW1hdGljLWJhcnMgLmJhciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAwOwogICAgYmFja2dyb3VuZDogYmxhY2s7CiAgICB0cmFuc2l0aW9uOiBoZWlnaHQgMC41cyBlYXNlOwogICAgei1pbmRleDogODAwOwp9CiNjaW5lbWF0aWMtYmFycyAuYmFyLnRvcCB7IHRvcDogMDsgfQojY2luZW1hdGljLWJhcnMgLmJhci5ib3R0b20geyBib3R0b206IDA7IH0KCi8qIC0tLSBURUNIIEZMQVNIIE9WRVJMQVkgLS0tICovCiN0ZWNoLWZsYXNoLW92ZXJsYXkgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAyMCU7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEyMHB4OwogICAgZGlzcGxheTogbm9uZTsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwwLDAsMCkgMCUsIHJnYmEoMCwgMjAsIDYwLCAwLjkpIDIwJSwgcmdiYSgwLCAyMCwgNjAsIDAuOSkgODAlLCByZ2JhKDAsMCwwLDApIDEwMCUpOwogICAgei1pbmRleDogMjIwMDsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigycHgpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMTAwLCAyNTUsIDI1NSwgMC4zKTsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDEwMCwgMjU1LCAyNTUsIDAuMyk7CiAgICBhbmltYXRpb246IGZsYXNoRW50ZXIgMC4xNXMgZWFzZS1vdXQ7Cn0KCkBrZXlmcmFtZXMgZmxhc2hFbnRlciB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiBzY2FsZVkoMCk7IG9wYWNpdHk6IDA7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZVkoMSk7IG9wYWNpdHk6IDE7IH0KfQoKLnRlY2gtY29udGVudC13cmFwcGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goLTEwZGVnKTsKfQoKLnRlY2gtdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IGNsYW1wKDI4cHgsIDEwdncsIDQycHgpOwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZiwgMCAwIDIwcHggIzAwMDBmZjsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7CiAgICBtYXJnaW4tYm90dG9tOiAycHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBhbmltYXRpb246IGJsaW5rVGV4dCAwLjA4cyBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCi50ZWNoLXN1Yi10ZXh0IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjMDBmZmZmOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjUpOwp9CgoudGVjaC10aW1lci10cmFjayB7CiAgICB3aWR0aDogMjUwcHg7CiAgICBoZWlnaHQ6IDhweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC42KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggcmdiYSgwLDAsMCwwLjUpOwp9CgoudGVjaC10aW1lci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmZmZiwgIzAwZmZmZik7CiAgICB3aWR0aDogMTAwJTsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGxlZnQ7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwp9CgpAa2V5ZnJhbWVzIGJsaW5rVGV4dCB7CiAgICBmcm9tIHsgb3BhY2l0eTogMC44OyB0ZXh0LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOyB0cmFuc2Zvcm06IHNjYWxlKDEpOyB9CiAgICB0byB7IG9wYWNpdHk6IDEuMDsgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICNmZmZmZmYsIDAgMCAxMHB4ICMwMGZmZmY7IHRyYW5zZm9ybTogc2NhbGUoMS4wMik7IH0KfQoKLyogLS0tIEhVRCBUT1AgLS0tICovCi8qIC0tLSBIVUQgVE9QIC0tLSAqLwojaHVkLXRvcCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7CiAgICBsZWZ0OiAwOwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIGFsaWduLWl0ZW1zOiBmbGV4LXN0YXJ0OwogICAgd2lkdGg6IDEwMCU7CiAgICBwYWRkaW5nOiAxNXB4OwogICAgcGFkZGluZy10b3A6IG1heCgxNXB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkpOwogICAgcGFkZGluZy1sZWZ0OiBtYXgoMTVweCwgZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KSk7CiAgICBwYWRkaW5nLXJpZ2h0OiBtYXgoMTVweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sIHJnYmEoMCwgNSwgMTUsIDAuOSkgMCUsIHJnYmEoMCwwLDAsMCkgMTAwJSk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC41czsKfQoKLnRlYW0td2luZyB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHdpZHRoOiAxNDBweDsKICAgIGhlaWdodDogNTVweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHJnYmEoMjAsIDQwLCA4MCwgMC45KSAwJSwgcmdiYSg1LCAxMCwgMjAsIDAuOTUpIDEwMCUpOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgxMDAsIDIwMCwgMjU1LCAwLjMpOwogICAgYm9yZGVyLXRvcDogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIHRyYW5zZm9ybTogc2tld1goLTE1ZGVnKTsKICAgIGJveC1zaGFkb3c6IDAgNXB4IDE1cHggcmdiYSgwLCAwLCAwLCAwLjUpLCBpbnNldCAwIDAgMjBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjEpOwogICAgcGFkZGluZzogMCAxNXB4OwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7Cn0KCi50ZWFtLXdpbmc6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgcmdiYSgyNTUsMjU1LDI1NSwwLjEpLCB0cmFuc3BhcmVudCk7CiAgICBhbmltYXRpb246IHdpbmdTaGltbWVyIDRzIGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIHdpbmdTaGltbWVyIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0xMDAlKTsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDEwMCUpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDEwMCUpOyB9Cn0KCi50ZWFtLXdpbmcuYXdheSB7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDE1ZGVnKTsKICAgIGZsZXgtZGlyZWN0aW9uOiByb3ctcmV2ZXJzZTsKICAgIGJvcmRlci10b3AtY29sb3I6ICNmZjY2NjY7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoLTE2MGRlZywgcmdiYSg2MCwgMjAsIDIwLCAwLjkpIDAlLCByZ2JhKDIwLCA1LCA1LCAwLjk1KSAxMDAlKTsKfQoKLnRlYW0tZGF0YSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZyk7CiAgICBmbGV4LWdyb3c6IDE7Cn0KLnRlYW0td2luZy5hd2F5IC50ZWFtLWRhdGEgeyB0cmFuc2Zvcm06IHNrZXdYKC0xNWRlZyk7IHRleHQtYWxpZ246IHJpZ2h0OyB9CgoudGVhbS1uYW1lIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMTZweDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCByZ2JhKDAsIDE1MCwgMjU1LCAwLjgpOwp9Ci50ZWFtLXN1YiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBvcGFjaXR5OiAwLjg7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4Owp9Ci50ZWFtLXdpbmcuYXdheSAudGVhbS1zdWIgeyBjb2xvcjogI2ZmYWFhYTsgfQoKLnNjb3JlLWJveCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDAgMTVweCB2YXIoLS1mZngtY3lhbi1nbG93KTsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpOwogICAgbWFyZ2luOiAwIDVweDsKICAgIG1pbi13aWR0aDogMzBweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoudGVhbS13aW5nLmF3YXkgLnNjb3JlLWJveCB7IHRyYW5zZm9ybTogc2tld1goLTE1ZGVnKTsgdGV4dC1zaGFkb3c6IDAgMCAxNXB4ICNmZjQ0NDQ7IH0KCi50aW1lci1jb21wbGV4IHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG1hcmdpbi10b3A6IC01cHg7Cn0KCi50aW1lci1jcnlzdGFsLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtMzBweDsKICAgIHdpZHRoOiAxNDBweDsKICAgIGhlaWdodDogNzBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlci10b3A6IDNweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3gtc2hhZG93OiAwIC01cHggMjBweCByZ2JhKDIwMCwgMTgwLCAxMDAsIDAuNCksIGluc2V0IDAgMTBweCAyMHB4IHJnYmEoMCwwLDAsMC41KTsKICAgIHotaW5kZXg6IC0xOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGVsbGlwc2UgYXQgdG9wLCByZ2JhKDIwLCA0MCwgODAsIDAuOSksIHRyYW5zcGFyZW50IDcwJSk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNHB4KTsKfQoKI2hhbGYtaW5kaWNhdG9yIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogNHB4OwogICAgbWFyZ2luLWJvdHRvbTogLTRweDsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1nb2xkLWRhcmspOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKfQoKI3RpbWVyLWRpc3BsYXkgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQ4cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmIDAlLCAjZmZkNzAwIDUwJSwgI2I4ODYwYiAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDJweCAwcHggcmdiYSgwLDAsMCwwLjgpKTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7Cn0KLyogLS0tIFBMQVlFUiBTVEFUVVMgUEFORUwgLS0tICovCiNwbGF5ZXItc3RhdHVzLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyA0MHB4KTsKICAgIGxlZnQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQpKTsKICAgIHdpZHRoOiAxNjBweDsKICAgIHBhZGRpbmc6IDEwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMTAsIDMwLCAwLjgpIDAlLCByZ2JhKDAsMCwwLDApIDEwMCUpOwogICAgYm9yZGVyLWxlZnQ6IDNweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiAwIDEwcHggMTBweCAwOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7Cn0KCi5jaGFyLW5hbWUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAxOHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKICAgIHRyYW5zZm9ybTogc2tld1goMTBkZWcpOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwp9CgouaHAtZ2F1Z2UtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogNHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7Cn0KLmhwLWxhYmVsIHsgZm9udC1zaXplOiAxMHB4OyBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOyB3aWR0aDogMjBweDsgfQouaHAtYmFyLXRyYWNrIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGhlaWdodDogNnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIG1hcmdpbjogMCA1cHg7Cn0KLmhwLWJhci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgIzAwZmYwMCwgI2NjZmZjYyk7CiAgICBib3gtc2hhZG93OiAwIDAgNXB4ICMwMGZmMDA7Cn0KLmhwLXZhbHVlIHsgZm9udC1zaXplOiAxMHB4OyBjb2xvcjogI2ZmZjsgd2lkdGg6IDQ1cHg7IHRleHQtYWxpZ246IHJpZ2h0OyB9CgoudGVjaC1nYXVnZS1jb250YWluZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDEwZGVnKTsKfQoudGVjaC1sYWJlbCB7IGZvbnQtc2l6ZTogMTBweDsgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsgd2lkdGg6IDIwcHg7IH0KLnRlY2gtYmFyLXRyYWNrIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGhlaWdodDogNHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIG1hcmdpbjogMCA1cHg7Cn0KLnRlY2gtYmFyLWZpbGwgewogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjZmZhYTAwLCAjZmZmZmFhKTsKfQoKLyogLS0tIE1JTklNQVAgLS0tICovCiNtaW5pbWFwLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg4MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA2MHB4KTsKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgaGVpZ2h0OiAxMTBweDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7Cn0KCi5yYWRhci1yaW0gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHZhcigtLWZmeC1ibHVlLWxpZ2h0KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHZhcigtLWZmeC1ibHVlLW1pZCksIGluc2V0IDAgMCAyMHB4IHJnYmEoMCwwLDAsMC44KTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMCwgMjAsIDYwLCAwLjQpIDAlLCByZ2JhKDAsIDUsIDEwLCAwLjgpIDEwMCUpOwogICAgei1pbmRleDogNTsKfQoKI21pbmltYXAgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgd2lkdGg6IDEwMHB4OwogICAgaGVpZ2h0OiAxMDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHotaW5kZXg6IDY7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgoucmFkYXItbGFiZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAtMTVweDsKICAgIHdpZHRoOiAxNDAlOwogICAgbGVmdDogLTIwJTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4pOwp9CgoubWFwLWRvdCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB3aWR0aDogNnB4OyBoZWlnaHQ6IDZweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgYm94LXNoYWRvdzogMCAwIDRweCBjdXJyZW50Q29sb3I7Cn0KLm1hcC1kb3QuaG9tZSB7IGJhY2tncm91bmQ6IHZhcigtLWZmeC1jeWFuKTsgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsgfQoubWFwLWRvdC5hd2F5IHsgYmFja2dyb3VuZDogI2ZmNDQ0NDsgY29sb3I6ICNmZjQ0NDQ7IH0KLm1hcC1kb3QuYmFsbCB7IAogICAgYmFja2dyb3VuZDogI2ZmMDBjYzsKICAgIGNvbG9yOiAjZmYwMGNjOyAKICAgIHdpZHRoOiAxMnB4OyBoZWlnaHQ6IDEycHg7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjZmZmZmZmOwogICAgei1pbmRleDogMjA7CiAgICBhbmltYXRpb246IGJsaW5rQmFsbCAwLjNzIGluZmluaXRlIGFsdGVybmF0ZTsKICAgIGJveC1zaGFkb3c6IDAgMCA2cHggI2ZmMDBjYzsKfQoubWFwLWRvdC5uYXAgeyBiYWNrZ3JvdW5kOiAjMzMzOyBjb2xvcjogIzAwMDsgYm9yZGVyOiAxcHggc29saWQgIzU1NTsgfQoubWFwLWRvdC5hY3RpdmUtcGxheWVyIHsgCiAgICBiYWNrZ3JvdW5kOiAjMDBmZjAwICFpbXBvcnRhbnQ7IAogICAgY29sb3I6ICMwMGZmMDAgIWltcG9ydGFudDsgCiAgICBib3gtc2hhZG93OiAwIDAgOHB4ICMwMGZmMDA7CiAgICB6LWluZGV4OiAxNTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuMik7Cn0KLm1hcC1kb3QuYmFsbC1jYXJyaWVyIHsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4ICNmZmYsIDAgMCAzMHB4ICNmZmFhMDA7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjZmZmZmZmOwogICAgYmFja2dyb3VuZC1jb2xvcjogI2ZmYWEwMCAhaW1wb3J0YW50OwogICAgei1pbmRleDogMTAwOwogICAgd2lkdGg6IDEwcHg7IGhlaWdodDogMTBweDsKICAgIGFuaW1hdGlvbjogY2FycmllclB1bHNlIDAuOHMgaW5maW5pdGUgYWx0ZXJuYXRlOwp9CkBrZXlmcmFtZXMgY2FycmllclB1bHNlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjIpOyBib3gtc2hhZG93OiAwIDAgMTBweCAjZmZmOyBvcGFjaXR5OiAwLjg7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS44KTsgYm94LXNoYWRvdzogMCAwIDI1cHggI2ZmY2MwMDsgb3BhY2l0eTogMS4wOyB9Cn0KQGtleWZyYW1lcyBibGlua0JhbGwgeyBmcm9tIHsgb3BhY2l0eTogMTsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IH0gdG8geyBvcGFjaXR5OiAwLjU7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuMyk7IH0gfQoKLyogLS0tIEFOTk9VTkNFTUVOVFMgLS0tICovCiNhbm5vdW5jZW1lbnQgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA0MCU7IAogICAgbGVmdDogNSU7IAogICAgd2lkdGg6IDkwJTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiBjbGFtcCg0MHB4LCAxMnZ3LCA3MnB4KTsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICB3aGl0ZS1zcGFjZTogbm9ybWFsOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZiAwJSwgI2ZmZDcwMCA0MCUsICNiODg2MGIgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggcmdiYSgyNTUsIDEwMCwgMCwgMC41KSkgZHJvcC1zaGFkb3coM3B4IDNweCAwICMwMDApOwogICAgZGlzcGxheTogbm9uZTsKICAgIHotaW5kZXg6IDIwMDA7CiAgICBhbmltYXRpb246IGFubm91bmNlU2xpZGUgMC41cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKQGtleWZyYW1lcyBhbm5vdW5jZVNsaWRlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHNjYWxlKDApIHJvdGF0ZSgtNWRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZSgxKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDE7IH0KfQoKLyogLS0tIEpPWVNUSUNLIC0tLSAqLwojam95c3RpY2staGl0LXpvbmUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDUwJTsgaGVpZ2h0OiA1MCU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwKTsgCiAgICB0b3VjaC1hY3Rpb246IG5vbmU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKfQoKI2pveXN0aWNrLXZpc3VhbC1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDA7IGhlaWdodDogMDsKICAgIG92ZXJmbG93OiB2aXNpYmxlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMTEwMDsKfQoKI2pveXN0aWNrLWJhc2UgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDEyMHB4OyBoZWlnaHQ6IDEyMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgwLCA0MCwgODAsIDAuNCkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjEpIDYwJSwgdHJhbnNwYXJlbnQgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDEwMCwgMjIwLCAyNTUsIDAuMyk7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpLCBpbnNldCAwIDAgMzBweCByZ2JhKDAsIDUwLCAxMDAsIDAuMyk7CiAgICBhbmltYXRpb246IGJhc2VQdWxzZSAycyBpbmZpbml0ZSBhbHRlcm5hdGU7Cn0KCkBrZXlmcmFtZXMgYmFzZVB1bHNlIHsKICAgIGZyb20geyBib3gtc2hhZG93OiAwIDAgMTBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpOyBib3JkZXItY29sb3I6IHJnYmEoMTAwLCAyMjAsIDI1NSwgMC4yKTsgfQogICAgdG8geyBib3gtc2hhZG93OiAwIDAgMjVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjUpOyBib3JkZXItY29sb3I6IHJnYmEoMTAwLCAyNTUsIDI1NSwgMC42KTsgfQp9Cgojam95c3RpY2sta25vYiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogNTBweDsgaGVpZ2h0OiA1MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzMCUgMzAlLCAjZTBmZmZmIDAlLCAjMDBhYWZmIDQwJSwgIzAwNDQ4OCA4MCUsICMwMDExMjIgMTAwJSk7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjODhjY2ZmOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggIzAwZmZmZiwgaW5zZXQgMCAwIDEwcHggcmdiYSgyNTUsMjU1LDI1NSwwLjgpOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMDVzIGxpbmVhcjsKfQoKI2pveXN0aWNrLWtub2I6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICIiOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAyMCU7IGxlZnQ6IDIwJTsgd2lkdGg6IDIwJTsgaGVpZ2h0OiAyMCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAjZmZmZmZmIDAlLCB0cmFuc3BhcmVudCA3MCUpOwogICAgZmlsdGVyOiBibHVyKDJweCk7CiAgICBvcGFjaXR5OiAwLjg7Cn0KCi50b3VjaC1yaXBwbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgyMDAsIDI1NSwgMjU1LCAwLjgpIDAlLCByZ2JhKDAsIDI1NSwgMjU1LCAwLjQpIDQwJSwgdHJhbnNwYXJlbnQgNzAlKTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDApOwogICAgYW5pbWF0aW9uOiByaXBwbGVBbmltIDAuNnMgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDkwMDA7CiAgICBtaXgtYmxlbmQtbW9kZTogc2NyZWVuOwp9CgpAa2V5ZnJhbWVzIHJpcHBsZUFuaW0gewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgwKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDMuMCk7IG9wYWNpdHk6IDA7IH0KfQoKI2NhbWVyYS16b25lIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgcmlnaHQ6IDA7IHdpZHRoOiA1MCU7IGhlaWdodDogMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdG91Y2gtYWN0aW9uOiBub25lOwogICAgei1pbmRleDogNTA7Cn0KCi8qIC0tLSBBQ1RJT04gQlVUVE9OIC0tLSAqLwojYWN0aW9uLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCg0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOyAKICAgIHJpZ2h0OiBtYXgoNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB6LWluZGV4OiAxMDA7Cn0KCi5jb21tYW5kLW1lbnUtYmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDE4MHB4OyBoZWlnaHQ6IDgwcHg7CiAgICBib3R0b206IDE1cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHRyYW5zcGFyZW50IDAlLCByZ2JhKDAsIDEwLCAzMCwgMC44KSA1MCUsIHRyYW5zcGFyZW50IDEwMCUpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMCwgMjAwLCAyNTUsIDAuMyk7CiAgICB6LWluZGV4OiAtMTsKfQoKLmNvbW1hbmQtcmluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMTMwcHg7IGhlaWdodDogMTMwcHg7CiAgICBib3JkZXI6IDJweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7CiAgICBib3JkZXItdG9wOiAycHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC42KTsKICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCByZ2JhKDAsIDI1NSwgMjU1LCAwLjYpOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYW5pbWF0aW9uOiBzcGluUmV2ZXJzZSAxNXMgbGluZWFyIGluZmluaXRlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpOwp9CkBrZXlmcmFtZXMgc3BpblJldmVyc2UgeyBmcm9tIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgcm90YXRlKDM2MGRlZyk7IH0gdG8geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSByb3RhdGUoMGRlZyk7IH0gfQoKI2FjdGlvbi1sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCA1LCAxMCwgMC44KTsKICAgIHBhZGRpbmc6IDRweCAxMnB4OwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwogICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMCwwLDAsMC44KTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjNzOwp9CgojYWN0aW9uLWJ1dHRvbiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwcHg7IGhlaWdodDogMTAwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4xcywgZmlsdGVyIDAuM3M7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZmZmZmYgMCUsICMwMDg4ZmYgNDAlLCAjMDAyMjY2IDgwJSwgIzAwMCAxMDAlKTsKICAgIGJvcmRlcjogM3B4IHNvbGlkICM0NGFhZmY7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjgpLCBpbnNldCAwIDAgMjBweCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNCk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICB6LWluZGV4OiAxMDsKfQoKI3Bhc3MtYnV0dG9uIHsKICAgIGRpc3BsYXk6IG5vbmUgIWltcG9ydGFudDsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogLTIwcHg7IGxlZnQ6IC0zMHB4OwogICAgd2lkdGg6IDYwcHg7IGhlaWdodDogNjBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHotaW5kZXg6IDk7Cn0KCiNhY3Rpb24tYnV0dG9uOjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC00MHB4OyBsZWZ0OiAtNDBweDsgcmlnaHQ6IC00MHB4OyBib3R0b206IC00MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgei1pbmRleDogMTA7Cn0KCiNhY3Rpb24tYnV0dG9uOmFjdGl2ZSB7IHRyYW5zZm9ybTogc2NhbGUoMC45Mik7IH0KCiNhY3Rpb24tYnV0dG9uIC5idG4tdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDIycHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDJweCA0cHggcmdiYSgwLDAsMCwwLjgpLCAwIDAgMTBweCByZ2JhKDI1NSwyNTUsMjU1LDAuNSk7CiAgICB6LWluZGV4OiA1OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgojYWN0aW9uLWJ1dHRvbiAuYnRuLWdsYXJlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwJTsgbGVmdDogLTUwJTsgd2lkdGg6IDIwMCU7IGhlaWdodDogMjAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg0NWRlZywgdHJhbnNwYXJlbnQgNDAlLCByZ2JhKDI1NSwyNTUsMjU1LDAuNCkgNTAlLCB0cmFuc3BhcmVudCA2MCUpOwogICAgYW5pbWF0aW9uOiBnbGFyZVBhc3MgNXMgaW5maW5pdGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDY7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7Cn0KCi5saW1pdC1yaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTVweDsgbGVmdDogLTVweDsgcmlnaHQ6IC01cHg7IGJvdHRvbTogLTVweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHRyYW5zcGFyZW50OwogICAgYm94LXNoYWRvdzogMCAwIDAgdHJhbnNwYXJlbnQ7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC41czsKICAgIHotaW5kZXg6IDE7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKI2FjdGlvbi1idXR0b24uc2hvb3QtbW9kZSB7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZmZmYWEgMCUsICNmZmFhMDAgNDAlLCAjODgyMjAwIDgwJSwgIzIyMDAwMCAxMDAlKTsKICAgIGJvcmRlci1jb2xvcjogI2ZmY2MwMDsKICAgIGJveC1zaGFkb3c6IDAgMCAzMHB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuOCksIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCAyNTUsIDAsIDAuNSk7Cn0KCiNhY3Rpb24tYnV0dG9uLmxpbWl0LXJlYWR5IC5saW1pdC1yaW5nIHsKICAgIGJvcmRlci1jb2xvcjogI2ZmZGQ0NDsKICAgIGFuaW1hdGlvbjogbGltaXRQdWxzZSAwLjhzIGVhc2UtaW4tb3V0IGluZmluaXRlIGFsdGVybmF0ZTsKfQoKLnNob290LWxhYmVsIHsKICAgIGNvbG9yOiAjZmZkZDQ0ICFpbXBvcnRhbnQ7CiAgICBib3JkZXItY29sb3I6ICNmZmFhMDAgIWltcG9ydGFudDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmY0NDAwICFpbXBvcnRhbnQ7Cn0KCkBrZXlmcmFtZXMgbGltaXRQdWxzZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgYm94LXNoYWRvdzogMCAwIDEwcHggI2ZmYWEwMCwgaW5zZXQgMCAwIDVweCAjZmZhYTAwOyBvcGFjaXR5OiAwLjU7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMTUpOyBib3gtc2hhZG93OiAwIDAgMzBweCAjZmY0NDAwLCBpbnNldCAwIDAgMTVweCAjZmYwMDAwOyBvcGFjaXR5OiAxLjA7IH0KfQoKLyogLS0tIEFVVE8gVE9HR0xFIC0tLSAqLwojYXV0by10b2dnbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoMjAwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDYwcHgpOyAKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgcGFkZGluZzogMTBweCAwOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgwLCAyMCwgNDAsIDAuOCkgMCUsIHJnYmEoMCwgNSwgMTAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3JkZXItdG9wOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNHB4KTsKICAgIGJveC1zaGFkb3c6IDAgNXB4IDE1cHggcmdiYSgwLDAsMCwwLjMpOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIHotaW5kZXg6IDEwMDsKfQoKI2F1dG8tdG9nZ2xlOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjkpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggdmFyKC0tZmZ4LWN5YW4pOwogICAgY29sb3I6IHdoaXRlOwp9CgojYXV0by10b2dnbGUuYWN0aXZlIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMTAwLCAyMCwgMCwgMC44KSAwJSwgcmdiYSg0MCwgMCwgMCwgMC45KSAxMDAlKTsKICAgIGJvcmRlci1jb2xvcjogI2ZmNDQwMDsKICAgIGNvbG9yOiAjZmZhYTAwOwogICAgYW5pbWF0aW9uOiBwdWxzZVJlZCAycyBpbmZpbml0ZTsKfQpAa2V5ZnJhbWVzIHB1bHNlUmVkIHsgMCUgeyBib3gtc2hhZG93OiAwIDAgNXB4ICNmZjAwMDA7IH0gNTAlIHsgYm94LXNoYWRvdzogMCAwIDIwcHggI2ZmNDQwMDsgfSAxMDAlIHsgYm94LXNoYWRvdzogMCAwIDVweCAjZmYwMDAwOyB9IH0KCi8qIC0tLSBGTE9BVElORyBURVhUIC0tLSAqLwouZmxvYXRpbmctdGV4dC13cmFwcGVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogMjAwMDsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm07Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyIHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDI0cHg7IAogICAgdGV4dC1zaGFkb3c6IDFweCAxcHggMCAjMDAwOwogICAgb3BhY2l0eTogMC45Owp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5kYW1hZ2UgewogICAgZm9udC1zaXplOiA0MnB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZmZmZiAwJSwgI2ZmY2MwMCA0MCUsICNmZjQ0MDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCA0cHggNHB4IHJnYmEoMCwwLDAsMC44KSk7CiAgICBhbmltYXRpb246IHBvcERhbWFnZSAwLjhzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KSBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuaGVhbCB7CiAgICBmb250LXNpemU6IDM2cHg7CiAgICBjb2xvcjogIzQ0ZmY0NDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZjAwOwogICAgYW5pbWF0aW9uOiBmbG9hdFVwIDFzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci52ZW5vbSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGNvbG9yOiAjYWFmZjAwOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICM0NDg4MDAsIDJweCAycHggMCAjMDAyMjAwOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2NjZmY2NiAwJSwgIzY2Y2MwMCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgNXB4IHJnYmEoMTAwLCAyNTUsIDAsIDAuNSkpOwogICAgYW5pbWF0aW9uOiBkcmlwU3RhdHVzIDJzIGluZmluaXRlOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5zbGVlcCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTVweCAjMDA0NGZmLCAwIDAgMzBweCAjMDAwMGZmOwogICAgb3BhY2l0eTogMC45OwogICAgYW5pbWF0aW9uOiBkcmlmdFN0YXR1cyAzcyBlYXNlLWluLW91dCBpbmZpbml0ZTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIud2l0aGVyIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzOHB4OwogICAgY29sb3I6ICNjY2NjY2M7CiAgICB0ZXh0LXNoYWRvdzogMnB4IDJweCAwICM0NDQ0NDQ7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZWVlZWVlIDAlLCAjODg4ODg4IDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHdpdGhlclN0YXR1cyAxLjVzIGZvcndhcmRzOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci50ZWNoIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMzJweDsKICAgIGNvbG9yOiAjMDBmZmZmOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAxMCwgMzAsIDAuNyk7CiAgICBwYWRkaW5nOiAycHggMTBweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkICMwMGZmZmY7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjMDA4OGZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggI2ZmZjsKICAgIGFuaW1hdGlvbjogc2hha2VUZWNoIDAuNnMgZWFzZS1pbi1vdXQsIGZsYXNoVGVjaCAwLjNzOwogICAgdHJhbnNmb3JtLW9yaWdpbjogY2VudGVyOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5zYXZlLCAuZmxvYXRpbmctdGV4dC1pbm5lci5ibG9jayB7CiAgICBmb250LXNpemU6IDQ4cHg7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgY29sb3I6ICNmZmZmZmY7CiAgICAtd2Via2l0LXRleHQtc3Ryb2tlOiAxcHggIzAwNDQ4ODsKICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCAjMDA4OGZmOwogICAgYW5pbWF0aW9uOiBwb3BEYW1hZ2UgMC41cyBlYXNlLW91dCBmb3J3YXJkczsKfQoKQGtleWZyYW1lcyBwb3BEYW1hZ2UgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuNSk7IG9wYWNpdHk6IDA7IH0KICAgIDIwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS41KTsgb3BhY2l0eTogMTsgfQogICAgNDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgZmxvYXRVcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNTBweCk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyBkcmlwU3RhdHVzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZVkoMSk7IGZpbHRlcjogYmx1cigwcHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlWSgxLjEpIHRyYW5zbGF0ZVkoNXB4KTsgZmlsdGVyOiBibHVyKDFweCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlWSgxKTsgZmlsdGVyOiBibHVyKDBweCk7IH0KfQoKQGtleWZyYW1lcyBkcmlmdFN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIDIwJSB7IG9wYWNpdHk6IDE7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxNXB4KSB0cmFuc2xhdGVZKC0yMHB4KSByb3RhdGUoMTBkZWcpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0xNXB4KSB0cmFuc2xhdGVZKC01MHB4KSByb3RhdGUoLTEwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIHdpdGhlclN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IGZpbHRlcjogZ3JheXNjYWxlKDAlKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC42KTsgZmlsdGVyOiBncmF5c2NhbGUoMTAwJSk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyBzaGFrZVRlY2ggewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuOCk7IH0KICAgIDEwJSwgMzAlLCA1MCUsIDcwJSwgOTAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjEpIHRyYW5zbGF0ZSgtMnB4LCAycHgpOyB9CiAgICAyMCUsIDQwJSwgNjAlLCA4MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSkgdHJhbnNsYXRlKDJweCwgLTJweCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IH0KfQoKQGtleWZyYW1lcyBmbGFzaFRlY2ggewogICAgMCUgeyBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZmOyBjb2xvcjogIzAwMDsgYm9yZGVyLWNvbG9yOiAjZmZmOyB9CiAgICAxMDAlIHsgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgwLCAxMCwgMzAsIDAuODUpOyBjb2xvcjogIzAwZmZmZjsgYm9yZGVyLWNvbG9yOiAjMDBmZmZmOyB9Cn0KCiNsb2FkaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgIGFuaW1hdGlvbjogYmxpbmsgMXMgaW5maW5pdGU7Cn0KQGtleWZyYW1lcyBibGluayB7IDUwJSB7IG9wYWNpdHk6IDAuNTsgfSB9CgojY29udHJvbHMtaGludCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDEzMHB4OyB3aWR0aDogMTAwJTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiByZ2JhKDI1NSwyNTUsMjU1LDAuNCk7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmNvbWljLWltcGFjdCB7CiAgICBmb250LWZhbWlseTogJ0ltcGFjdCcsIHNhbnMtc2VyaWY7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBjb2xvcjogI2ZmZmYwMDsgCiAgICAtd2Via2l0LXRleHQtc3Ryb2tlOiAxcHggIzAwMDsKICAgIHRleHQtc2hhZG93OiAzcHggM3B4IDAgI2ZmMDAwMDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGNlbnRlcjsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICBhbmltYXRpb246IGNvbWljUG9wIDAuNHMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpIGZvcndhcmRzOwogICAgei1pbmRleDogMjUwMDsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuY29taWMtYWN0aW9uIHsKICAgIGZvbnQtZmFtaWx5OiAnQXJpYWwgQmxhY2snLCBzYW5zLXNlcmlmOwogICAgZm9udC1zaXplOiAyOHB4OwogICAgY29sb3I6ICMwMGZmZmY7IAogICAgLXdlYmtpdC10ZXh0LXN0cm9rZTogMXB4ICMwMDA7CiAgICB0ZXh0LXNoYWRvdzogMnB4IDJweCAwICMwMDQ0YWE7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgYW5pbWF0aW9uOiBjb21pY1NsaWRlIDAuNHMgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICB6LWluZGV4OiAyNTAwOwp9CgpAa2V5ZnJhbWVzIGNvbWljUG9wIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwKSByb3RhdGUoLTIwZGVnKTsgb3BhY2l0eTogMDsgfQogICAgNDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjIpIHJvdGF0ZSg1ZGVnKTsgb3BhY2l0eTogMTsgfQogICAgNjAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApIHJvdGF0ZSgtNWRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSkgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgY29taWNTbGlkZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC0yMHB4LCAyMHB4KSBzY2FsZSgwLjUpOyBvcGFjaXR5OiAwOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMjBweCwgLTIwcHgpIHNjYWxlKDEuMik7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIE1BSU4gTUVOVSAtLS0gKi8KLyogLS0tIE1BSU4gTUVOVSAmIEVORCBHQU1FIChGRlggU1RZTEUpIC0tLSAqLwojbWFpbi1tZW51LCAjZW5kLWdhbWUtbWVudSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDMwMDA7CiAgICBvcGFjaXR5OiAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuOHMgY3ViaWMtYmV6aWVyKDAuMiwgMC44LCAwLjIsIDEuMCk7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IGNlbnRlciwgcmdiYSgwLCAyMCwgNjAsIDAuNCkgMCUsIHJnYmEoMCwgNSwgMTAsIDAuOCkgMTAwJSk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNXB4KTsKfQoKI21haW4tbWVudS5hY3RpdmUsICNlbmQtZ2FtZS1tZW51LmFjdGl2ZSB7CiAgICBvcGFjaXR5OiAxOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87Cn0KCi5tZW51LWJnLW92ZXJsYXksIC5lbmQtYmctbGF5ZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogCiAgICAgICAgbGluZWFyLWdyYWRpZW50KHJnYmEoMCwwLDAsMCkgNTAlLCByZ2JhKDAsMCwwLDAuMSkgNTAlKSwgCiAgICAgICAgcmVwZWF0aW5nLWxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgyNTUsMjU1LDI1NSwwLjAyKSAwcHgsIHJnYmEoMjU1LDI1NSwyNTUsMC4wMikgMXB4LCB0cmFuc3BhcmVudCAxcHgsIHRyYW5zcGFyZW50IDIwcHgpOwogICAgYmFja2dyb3VuZC1zaXplOiAxMDAlIDRweCwgMTAwJSAxMDAlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAtMTsKfQoKLyogTE9HTyBTVFlMSU5HICovCi5mZngtbG9nby1jb250YWluZXIgewogICAgbWFyZ2luLWJvdHRvbTogNTBweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goLTEwZGVnKTsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKfQoKLmZmeC1sb2dvLW1haW4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiBjbGFtcCg0OHB4LCAxMHZ3LCA4NHB4KTsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiA4cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmZmZmIDAlLCAjYWFjY2ZmIDQwJSwgIzAwODhmZiAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjgpKTsKICAgIGFuaW1hdGlvbjogbG9nb1NoaW1tZXIgM3MgaW5maW5pdGUgYWx0ZXJuYXRlOwp9CgouZmZ4LWxvZ28tc3ViIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoMTRweCwgM3Z3LCAyNHB4KTsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogMTVweDsKICAgIG1hcmdpbi10b3A6IC0xMHB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICNmZmFhMDA7CiAgICBvcGFjaXR5OiAwLjk7Cn0KCkBrZXlmcmFtZXMgbG9nb1NoaW1tZXIgewogICAgMCUgeyBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuNSkpOyB9CiAgICAxMDAlIHsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMjVweCByZ2JhKDAsIDIwMCwgMjU1LCAwLjkpKTsgfQp9CgovKiBNRU5VIE9QVElPTlMgKi8KLm1lbnUtb3B0aW9ucywgLmVuZC1vcHRpb25zIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgZ2FwOiAxNXB4OwogICAgd2lkdGg6IDMyMHB4Owp9CgoubWVudS1pdGVtIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIHBhZGRpbmc6IDEycHggMzBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgwLCAzMCwgNjAsIDAuOCkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjIpIDEwMCUpOwogICAgYm9yZGVyLWxlZnQ6IDNweCBzb2xpZCByZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyk7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgcmdiYSgxMDAsIDIwMCwgMjU1LCAwLjEpOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdHJhbnNpdGlvbjogYWxsIDAuM3MgY3ViaWMtYmV6aWVyKDAuMiwgMC44LCAwLjIsIDEuMCk7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xNWRlZyk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCi5tZW51LWl0ZW06OmJlZm9yZSB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogLTEwMCU7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHRyYW5zcGFyZW50LCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMiksIHRyYW5zcGFyZW50KTsKICAgIHRyYW5zaXRpb246IGxlZnQgMC40czsKfQoKLm1lbnUtaXRlbTpob3Zlcjo6YmVmb3JlIHsKICAgIGxlZnQ6IDEwMCU7Cn0KCi5tZW51LWl0ZW06aG92ZXIgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDgwLCAxNjAsIDAuOSkgMCUsIHJnYmEoMCwgMjAsIDQwLCAwLjQpIDEwMCUpOwogICAgYm9yZGVyLWxlZnQtY29sb3I6ICMwMGZmZmY7CiAgICBwYWRkaW5nLWxlZnQ6IDQ1cHg7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjMpOwp9CgoubWVudS1pdGVtIC5sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDIwcHg7CiAgICBjb2xvcjogI2NjY2NjYzsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZyk7CiAgICB0cmFuc2l0aW9uOiBjb2xvciAwLjJzOwp9CgoubWVudS1pdGVtOmhvdmVyIC5sYWJlbCB7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwp9CgoubWVudS1pdGVtIC5jdXJzb3IgewogICAgd2lkdGg6IDEwcHg7IGhlaWdodDogMTBweDsKICAgIGJhY2tncm91bmQ6IHZhcigtLWZmeC1nb2xkKTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIG1hcmdpbi1yaWdodDogMTVweDsKICAgIG9wYWNpdHk6IDA7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTIwcHgpIHNrZXdYKDE1ZGVnKTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjNzOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWdvbGQpOwp9CgoubWVudS1pdGVtOmhvdmVyIC5jdXJzb3IgewogICAgb3BhY2l0eTogMTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKSBza2V3WCgxNWRlZyk7Cn0KCi5tZW51LWZvb3RlciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDMwcHg7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogcmdiYSgyNTUsMjU1LDI1NSwwLjMpOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KCi8qIEVORCBHQU1FIFNQRUNJRklDICovCi5yZXN1bHQtaGVhZGVyIHsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIG1hcmdpbi1ib3R0b206IDQwcHg7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7Cn0KCi5yZXN1bHQtdGl0bGUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiA3MnB4OwogICAgY29sb3I6ICNmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwYWFmZiwgMCAwIDQwcHggIzAwNDRhYTsKICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICBsaW5lLWhlaWdodDogMS4wOwp9CgoucmVzdWx0LXN1YnRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMThweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogOHB4OwogICAgbWFyZ2luLXRvcDogNXB4Owp9CgouZmluYWwtc2NvcmUtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBnYXA6IDQwcHg7CiAgICBtYXJnaW4tYm90dG9tOiA1MHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgcmdiYSgwLCAyMCwgNTAsIDAuOCksIHRyYW5zcGFyZW50KTsKICAgIHBhZGRpbmc6IDIwcHggMDsKICAgIHdpZHRoOiAxMDAlOwp9CgouZmluYWwtdGVhbSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB3aWR0aDogMTIwcHg7Cn0KCi5maW5hbC1zY29yZS1kaWdpdCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogODBweDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC41KTsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7Cn0KCi5maW5hbC10ZWFtLmhvbWUgLmZpbmFsLXNjb3JlLWRpZ2l0IHsgY29sb3I6ICMwMGZmZmY7IHRleHQtc2hhZG93OiAwIDAgMjBweCAjMDBmZmZmOyB9Ci5maW5hbC10ZWFtLmF3YXkgLmZpbmFsLXNjb3JlLWRpZ2l0IHsgY29sb3I6ICNmZjQ0NDQ7IHRleHQtc2hhZG93OiAwIDAgMjBweCAjZmY0NDQ0OyB9CgouZmluYWwtdGVhbS1uYW1lIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjYWFhOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG1hcmdpbi10b3A6IDVweDsKfQoKLmZpbmFsLXZzIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG9wYWNpdHk6IDAuNjsKfQoKLmZpbmFsLXZzIHNwYW4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIG1hcmdpbjogNXB4IDA7Cn0KCi52cy1saW5lIHsKICAgIHdpZHRoOiAycHg7IGhlaWdodDogMzBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sIHRyYW5zcGFyZW50LCB2YXIoLS1mZngtZ29sZCksIHRyYW5zcGFyZW50KTsKfQovKiAtLS0gUFJBQ1RJQ0UgT1ZFUkxBWSAtLS0gKi8KI3ByYWN0aWNlLW92ZXJsYXkgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCA1LCAxMCwgMC42KTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB6LWluZGV4OiAyNTAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCiNwcmFjdGljZS1vdmVybGF5LmFjdGl2ZSB7CiAgICBkaXNwbGF5OiBmbGV4Owp9CgoucHJhY3RpY2UtcGFuZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNDBweCk7IAogICAgcmlnaHQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogMjgwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTYwZGVnLCByZ2JhKDAsIDIwLCA1MCwgMC45NSkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjk4KSAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDg4ZmY7CiAgICBib3JkZXItcmFkaXVzOiAwIDAgMTVweCAwOwogICAgYm94LXNoYWRvdzogMCAwIDIwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC4yKSwgaW5zZXQgMCAwIDUwcHggcmdiYSgwLCAyMCwgNjAsIDAuNSk7CiAgICBwYWRkaW5nOiAxNXB4OwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0yZGVnKTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig1cHgpOwp9CgoucGFuZWwtaGVhZGVyIHsKICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCi5wYW5lbC10aXRsZS1ncm91cCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKfQoKLnBhbmVsLXRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoMThweCwgNnZ3LCAyNHB4KTsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICMwMGZmZmY7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4Owp9CgoucGFuZWwtc3VidGl0bGUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiA4cHg7CiAgICBjb2xvcjogIzQ0ODhmZjsKICAgIGxldHRlci1zcGFjaW5nOiA0cHg7CiAgICBtYXJnaW4tdG9wOiAtMnB4Owp9CgoucGFuZWwtZGVjby1saW5lIHsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAycHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHRyYW5zcGFyZW50LCAjMDBmZmZmLCB0cmFuc3BhcmVudCk7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICBib3gtc2hhZG93OiAwIDAgNXB4ICMwMGZmZmY7Cn0KCi5wYW5lbC1jb250ZW50IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgZ2FwOiAxNXB4Owp9Cgouc2VjdGlvbi1sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMjAwLCAxNzYsIDk2LCAwLjMpOwogICAgbWFyZ2luLWJvdHRvbTogNXB4OwogICAgcGFkZGluZy1ib3R0b206IDJweDsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7Cn0KCi5kcmlsbC1saXN0IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgZ2FwOiA1cHg7Cn0KCi5kcmlsbC1idG4gewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwYWRkaW5nOiA4cHggMTJweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjA1KSwgdHJhbnNwYXJlbnQpOwogICAgYm9yZGVyLWxlZnQ6IDJweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAxNHB4OwogICAgY29sb3I6ICNhYWE7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoKLmRyaWxsLWJ0bjpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMjU1LCAyNTUsIDAuMSksIHRyYW5zcGFyZW50KTsKICAgIGNvbG9yOiAjZmZmOwogICAgcGFkZGluZy1sZWZ0OiAxNXB4Owp9CgouZHJpbGwtYnRuLmFjdGl2ZSB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMTAwLCAyNTUsIDAuNCksIHRyYW5zcGFyZW50KTsKICAgIGJvcmRlci1sZWZ0OiAzcHggc29saWQgIzAwZmZmZjsKICAgIGNvbG9yOiAjZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggIzAwZmZmZjsKfQoKLmRyaWxsLWJ0biAuaWNvbiB7CiAgICB3aWR0aDogMjBweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIG1hcmdpbi1yaWdodDogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7Cn0KCi5vcHRpb24tbGlzdCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogNXB4Owp9Cgoub3B0aW9uLXRvZ2dsZSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBhZGRpbmc6IDVweCAxMHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgY29sb3I6ICNjY2M7CiAgICB0cmFuc2l0aW9uOiBjb2xvciAwLjJzOwp9Cgoub3B0aW9uLXRvZ2dsZTpob3ZlciB7IGNvbG9yOiAjZmZmOyB9Cgoub3B0aW9uLXRvZ2dsZSAuY2hlY2tib3ggewogICAgbWFyZ2luLXJpZ2h0OiAxMHB4OwogICAgY29sb3I6ICM0NDQ7CiAgICBmb250LWZhbWlseTogbW9ub3NwYWNlOwogICAgZm9udC1zaXplOiAxNHB4Owp9Cgoub3B0aW9uLXRvZ2dsZS5hY3RpdmUgLmNoZWNrYm94IHsKICAgIGNvbG9yOiAjMDBmZjAwOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggIzAwZmYwMDsKfQoKLm9wdGlvbi10b2dnbGUuYWN0aXZlIHsKICAgIGNvbG9yOiAjZmZmOwp9CgouYWN0aW9uLWJ0biB7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuNSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ0OwogICAgcGFkZGluZzogNnB4OwogICAgZm9udC1zaXplOiAxMXB4OwogICAgY29sb3I6ICNhYWE7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgouYWN0aW9uLWJ0bjpob3ZlciB7CiAgICBib3JkZXItY29sb3I6ICNmZmY7CiAgICBjb2xvcjogI2ZmZjsKICAgIGJhY2tncm91bmQ6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKTsKfQoKI3AtZXhpdDpob3ZlciB7CiAgICBib3JkZXItY29sb3I6ICNmZjQ0NDQ7CiAgICBjb2xvcjogI2ZmNDQ0NDsKICAgIGJhY2tncm91bmQ6IHJnYmEoNTAsIDAsIDAsIDAuMyk7Cn0KCi5wYW5lbC1mb290ZXIgewogICAgbWFyZ2luLXRvcDogMTVweDsKICAgIHBhZGRpbmctdG9wOiAxMHB4OwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoKI2RyaWxsLWluc3RydWN0aW9uIHsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBtYXJnaW4tYm90dG9tOiA1cHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7Cn0KCiNkcmlsbC1zY29yZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggcmdiYSgyNTUsIDIxNSwgMCwgMC41KTsKfQoKLnBhbmVsLW1pbmltaXplLWJ0biB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDEwcHg7IHJpZ2h0OiAxMHB4OwogICAgd2lkdGg6IDIwcHg7IGhlaWdodDogMjBweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBsaW5lLWhlaWdodDogMThweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC41KTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwp9Ci5wYW5lbC1taW5pbWl6ZS1idG46aG92ZXIgeyAKICAgIGJhY2tncm91bmQ6IHZhcigtLWZmeC1jeWFuKTsgCiAgICBjb2xvcjogIzAwMDsgCiAgICBib3gtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKfQoKI3ByYWN0aWNlLXJlc3RvcmUtYnRuIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDYwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDQwcHgpOyAKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgcGFkZGluZzogOHB4IDE1cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMjAsIDUwLCAwLjkpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC45KSAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1sZWZ0OiAzcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHotaW5kZXg6IDI0MDA7CiAgICBkaXNwbGF5OiBub25lOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKfQojcHJhY3RpY2UtcmVzdG9yZS1idG46aG92ZXIgewogICAgYmFja2dyb3VuZDogcmdiYSgwLCA0MCwgODAsIDAuOSk7CiAgICBjb2xvcjogI2ZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMGZmZmY7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjMpOwp9CgovKiAtLS0gQUlNIEpPWVNUSUNLIC0tLSAqLwojYWltLWpveXN0aWNrLXpvbmUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiBtYXgoMTUwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSk7CiAgICByaWdodDogMDsKICAgIHdpZHRoOiA0MCU7CiAgICBoZWlnaHQ6IDM1JTsKICAgIHotaW5kZXg6IDEwMDA7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDApOwogICAgdG91Y2gtYWN0aW9uOiBub25lOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87Cn0KCiNhaW0tam95c3RpY2stdmlzdWFsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAwOyBoZWlnaHQ6IDA7CiAgICBvdmVyZmxvdzogdmlzaWJsZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgZGlzcGxheTogbm9uZTsKICAgIHotaW5kZXg6IDExMDA7Cn0KCiNhaW0tam95c3RpY2stYmFzZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogOTBweDsgaGVpZ2h0OiA5MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgyNTUsIDEwMCwgMCwgMC4zKSAwJSwgcmdiYSg4MCwgMjAsIDAsIDAuMSkgNjAlLCB0cmFuc3BhcmVudCAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMjU1LCAxNTAsIDUwLCAwLjQpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgyNTUsIDEwMCwgMCwgMC4yKSwgaW5zZXQgMCAwIDIwcHggcmdiYSgyNTUsIDUwLCAwLCAwLjIpOwp9CgojYWltLWpveXN0aWNrLWtub2IgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDQwcHg7IGhlaWdodDogNDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzAlIDMwJSwgI2ZmY2M4OCAwJSwgI2ZmNjYwMCA0MCUsICM4ODIyMDAgODAlLCAjMjIwMDAwIDEwMCUpOwogICAgYm9yZGVyOiAycHggc29saWQgI2ZmYWE0NDsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4ICNmZjQ0MDAsIGluc2V0IDAgMCA4cHggcmdiYSgyNTUsMjU1LDI1NSwwLjYpOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMDVzIGxpbmVhcjsKfQoKI2FpbS1qb3lzdGljay1rbm9iOjphZnRlciB7CiAgICBjb250ZW50OiAiQUlNIjsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGZvbnQtc2l6ZTogOHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDNweCAjMDAwOwp9CgovKiAtLS0gVEFDS0xFIEJVVFRPTiAtLS0gKi8KI3RhY2tsZS1idXR0b24gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiBtYXgoMTYwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSArIDEwMHB4KTsKICAgIHJpZ2h0OiBtYXgoNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDcwcHg7CiAgICBoZWlnaHQ6IDcwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBkaXNwbGF5OiBub25lOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB6LWluZGV4OiAxMDA7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZjg4ODggMCUsICNjYzAwMDAgNDAlLCAjNjYwMDAwIDgwJSwgIzIyMDAwMCAxMDAlKTsKICAgIGJvcmRlcjogM3B4IHNvbGlkICNmZjQ0NDQ7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDI1NSwgNTAsIDUwLCAwLjYpLCBpbnNldCAwIDAgMTVweCByZ2JhKDI1NSwgMjAwLCAyMDAsIDAuMyk7CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4xcywgZmlsdGVyIDAuMnM7Cn0KCiN0YWNrbGUtYnV0dG9uOmFjdGl2ZSB7CiAgICB0cmFuc2Zvcm06IHNjYWxlKDAuOSk7CiAgICBmaWx0ZXI6IGJyaWdodG5lc3MoMS4yKTsKfQoKI3RhY2tsZS1idXR0b24uYWN0aXZlIHsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzUlIDM1JSwgI2ZmZmZmZiAwJSwgI2ZmNDQ0NCA0MCUsICNhYTAwMDAgODAlLCAjNDQwMDAwIDEwMCUpOwogICAgYm94LXNoYWRvdzogMCAwIDI1cHggcmdiYSgyNTUsIDEwMCwgMTAwLCAwLjkpOwp9CgojdGFja2xlLWJ1dHRvbiAuYnRuLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDFweCAycHggcmdiYSgwLDAsMCwwLjgpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKI3RhY2tsZS1idXR0b24gLmJ0bi1nbGFyZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01MCU7IGxlZnQ6IC01MCU7CiAgICB3aWR0aDogMjAwJTsgaGVpZ2h0OiAyMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDQ1ZGVnLCB0cmFuc3BhcmVudCA0MCUsIHJnYmEoMjU1LDI1NSwyNTUsMC4zKSA1MCUsIHRyYW5zcGFyZW50IDYwJSk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGFuaW1hdGlvbjogZ2xhcmVQYXNzIDRzIGluZmluaXRlOwp9CgojdGFja2xlLWJ1dHRvbi51cmdlbnQgewogICAgYW5pbWF0aW9uOiB1cmdlbnRQdWxzZSAwLjVzIGluZmluaXRlIGFsdGVybmF0ZTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzUlIDM1JSwgI2ZmNTU1NSAwJSwgI2ZmMDAwMCA0MCUsICM4ODAwMDAgMTAwJSk7CiAgICBib3JkZXItY29sb3I6ICNmZmFhYWE7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCAjZmYwMDAwOwp9CgpAa2V5ZnJhbWVzIHVyZ2VudFB1bHNlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjE1KTsgfQp9CgovKiAtLS0gQ0hBUkdFIFBPV0VSIE1FVEVSIC0tLSAqLwojY2hhcmdlLW1ldGVyLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCgyNTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pICsgMTAwcHgpOwogICAgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgd2lkdGg6IDIwMHB4OwogICAgZGlzcGxheTogbm9uZTsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAyMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAxMCwgMzAsIDAuOCk7CiAgICBwYWRkaW5nOiAxMHB4IDE1cHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjMpOwp9CgouY2hhcmdlLWxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKfQoKLmNoYXJnZS1tZXRlci10cmFjayB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTJweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC42KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBib3JkZXItcmFkaXVzOiA2cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgojY2hhcmdlLW1ldGVyLWZpbGwgewogICAgaGVpZ2h0OiAxMDAlOwogICAgd2lkdGg6IDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjMGFmLCAjMGYwKTsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4ICMwZjA7CiAgICB0cmFuc2l0aW9uOiB3aWR0aCAwLjA1cyBsaW5lYXIsIGJhY2tncm91bmQgMC4xczsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKfQoKLmNoYXJnZS1oaW50IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICBvcGFjaXR5OiAwLjg7CiAgICBhbmltYXRpb246IGJsaW5rIDAuNXMgaW5maW5pdGU7Cn0KCi8qIC0tLSBHT0FMIERJU1RBTkNFIElORElDQVRPUiAtLS0gKi8KI2dvYWwtZGlzdGFuY2UtY29udGFpbmVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDc1cHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDU1cHgpOwogICAgbGVmdDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtbGVmdCkpOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAxMDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMTAsIDMwLCAwLjcpIDAlLCB0cmFuc3BhcmVudCAxMDAlKTsKICAgIHBhZGRpbmc6IDVweCAxNXB4IDVweCAxMHB4OwogICAgYm9yZGVyLWxlZnQ6IDJweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7Cn0KCi5kaXN0YW5jZS1sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDhweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKfQoKI2dvYWwtZGlzdGFuY2UgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtZ29sZCk7Cn0KCi8qIC0tLSBTRVRUSU5HUyBCVVRUT04gLS0tICovCiNzZXR0aW5ncy1idXR0b24gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoMjQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDEwMHB4KTsKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgcGFkZGluZzogOHB4IDA7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiAjODg4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgyMCwgMjAsIDIwLCAwLjgpIDAlLCByZ2JhKDEwLCAxMCwgMTAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ0OwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgei1pbmRleDogMTAwOwp9Cgojc2V0dGluZ3MtYnV0dG9uOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoNDAsIDQwLCA0MCwgMC45KTsKICAgIGJvcmRlci1jb2xvcjogIzg4ODsKICAgIGNvbG9yOiAjZmZmOwp9CgovKiAtLS0gU0VUVElOR1MgUEFORUwgLS0tICovCiNzZXR0aW5ncy1wYW5lbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsKICAgIGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDI4MHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE2MGRlZywgcmdiYSgwLCAyMCwgNTAsIDAuOTgpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC45OSkgMTAwJSk7CiAgICBib3JkZXI6IDJweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiAxMHB4OwogICAgYm94LXNoYWRvdzogMCAwIDMwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC40KTsKICAgIHotaW5kZXg6IDM1MDA7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxMHB4KTsKfQoKLnNldHRpbmdzLWhlYWRlciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBhZGRpbmc6IDE1cHg7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgcmdiYSgxMDAsIDIwMCwgMjU1LCAwLjMpOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAzMCwgNjAsIDAuNSk7Cn0KCi5zZXR0aW5ncy1oZWFkZXIgc3BhbiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDIwcHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7CiAgICBsZXR0ZXItc3BhY2luZzogM3B4Owp9Cgojc2V0dGluZ3MtY2xvc2UgewogICAgd2lkdGg6IDMwcHg7CiAgICBoZWlnaHQ6IDMwcHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjZmY0NDQ0OwogICAgYmFja2dyb3VuZDogcmdiYSg1MCwgMCwgMCwgMC41KTsKICAgIGNvbG9yOiAjZmY0NDQ0OwogICAgZm9udC1zaXplOiAxNHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgYm9yZGVyLXJhZGl1czogNXB4OwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7Cn0KCiNzZXR0aW5ncy1jbG9zZTpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiAjZmY0NDQ0OwogICAgY29sb3I6IHdoaXRlOwp9Cgouc2V0dGluZ3MtY29udGVudCB7CiAgICBwYWRkaW5nOiAyMHB4Owp9Cgouc2V0dGluZy1yb3cgewogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgcGFkZGluZzogMTBweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC4zKTsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKfQoKLnNldHRpbmctcm93IGxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAxNHB4OwogICAgY29sb3I6ICNjY2M7Cn0KCi5zZXR0aW5nLXJvdyBpbnB1dFt0eXBlPSJyYW5nZSJdIHsKICAgIHdpZHRoOiAxMDBweDsKICAgIGFjY2VudC1jb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwp9Cgouc2V0dGluZy1yb3cgaW5wdXRbdHlwZT0iY2hlY2tib3giXSB7CiAgICB3aWR0aDogMjBweDsKICAgIGhlaWdodDogMjBweDsKICAgIGFjY2VudC1jb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgY3Vyc29yOiBwb2ludGVyOwp9CgovKiAtLS0gR0xBUkUgQU5JTUFUSU9OIC0tLSAqLwpAa2V5ZnJhbWVzIGdsYXJlUGFzcyB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtMTAwJSkgcm90YXRlKDQ1ZGVnKTsgfQogICAgMzAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDEwMCUpIHJvdGF0ZSg0NWRlZyk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMTAwJSkgcm90YXRlKDQ1ZGVnKTsgfQp9CgovKiAtLS0gU1RBVFVTIFRZUEUgRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtaW5uZXIuc3RhdHVzIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAyOHB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgY29sb3I6ICNmZjAwZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggI2ZmMDBmZiwgMnB4IDJweCAwICMwMDA7CiAgICBhbmltYXRpb246IHN0YXR1c1BvcCAxLjJzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgpAa2V5ZnJhbWVzIHN0YXR1c1BvcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC41KSB0cmFuc2xhdGVZKDApOyBvcGFjaXR5OiAwOyB9CiAgICAyMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMykgdHJhbnNsYXRlWSgtMTBweCk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCkgdHJhbnNsYXRlWSgtNDBweCk7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIEdPQUwgVFlQRSBGTE9BVElORyBURVhUIC0tLSAqLwouZmxvYXRpbmctdGV4dC1pbm5lci5nb2FsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiA0OHB4OwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmYgMCUsICNmZmQ3MDAgNTAlLCAjZmY4ODAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgNHB4IDRweCByZ2JhKDAsMCwwLDAuOSkpOwogICAgYW5pbWF0aW9uOiBnb2FsUG9wIDFzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KSBmb3J3YXJkczsKfQoKQGtleWZyYW1lcyBnb2FsUG9wIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwKSByb3RhdGUoLTEwZGVnKTsgb3BhY2l0eTogMDsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjUpIHJvdGF0ZSg1ZGVnKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4yKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIERFRkFVTFQgVFlQRSBGTE9BVElORyBURVhUIC0tLSAqLwouZmxvYXRpbmctdGV4dC1pbm5lci5kZWZhdWx0IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMnB4IDRweCByZ2JhKDAsMCwwLDAuOCk7CiAgICBhbmltYXRpb246IGZsb2F0VXAgMC44cyBlYXNlLW91dCBmb3J3YXJkczsKfQoKLyogLS0tIE1PQklMRSBQT1JUUkFJVCBPUFRJTUlaQVRJT05TIC0tLSAqLwpAbWVkaWEgc2NyZWVuIGFuZCAob3JpZW50YXRpb246IHBvcnRyYWl0KSBhbmQgKG1heC13aWR0aDogNjAwcHgpIHsKICAgIC50ZWFtLXdpbmcgeyB3aWR0aDogOTBweDsgcGFkZGluZzogMCA1cHg7IH0KICAgIC5zY29yZS1ib3ggeyBmb250LXNpemU6IDI0cHg7IG1hcmdpbjogMCA1cHg7IH0KICAgIC50ZWFtLW5hbWUgeyBmb250LXNpemU6IDEwcHg7IH0KICAgIC50ZWFtLXN1YiB7IGRpc3BsYXk6IG5vbmU7IH0KICAgIAogICAgLnRpbWVyLWNyeXN0YWwtcmluZyB7IHdpZHRoOiA4MHB4OyBoZWlnaHQ6IDQwcHg7IHRvcDogLTE1cHg7IH0KICAgICN0aW1lci1kaXNwbGF5IHsgZm9udC1zaXplOiAyOHB4OyB9CiAgICAKICAgICNtaW5pbWFwLWNvbnRhaW5lciB7IHdpZHRoOiA5MHB4OyBoZWlnaHQ6IDkwcHg7IH0KICAgICNtaW5pbWFwIHsgd2lkdGg6IDgwcHg7IGhlaWdodDogODBweDsgfQogICAgLnJhZGFyLWxhYmVsIHsgZm9udC1zaXplOiAxMHB4OyB9CiAgICAKICAgIC50ZWNoLXRleHQgeyBmb250LXNpemU6IDI0cHg7IH0KICAgIAogICAgI2FjdGlvbi1idXR0b24geyB3aWR0aDogODBweDsgaGVpZ2h0OiA4MHB4OyB9CiAgICAuY29tbWFuZC1yaW5nIHsgd2lkdGg6IDEwMHB4OyBoZWlnaHQ6IDEwMHB4OyB9CiAgICAjYWN0aW9uLWxhYmVsIHsgZm9udC1zaXplOiAxMHB4OyBwYWRkaW5nOiAycHggOHB4OyB9CiAgICAKICAgICNwbGF5ZXItc3RhdHVzLXBhbmVsIHsgd2lkdGg6IDEzMHB4OyBib3R0b206IG1heCgxNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pICsgMjBweCk7IH0KICAgIC5jaGFyLW5hbWUgeyBmb250LXNpemU6IDE0cHg7IH0KICAgIAogICAgI2F1dG8tdG9nZ2xlLCAjc2V0dGluZ3MtYnV0dG9uLCAjcHJhY3RpY2UtcmVzdG9yZS1idG4gewogICAgICAgIHdpZHRoOiA5MHB4OwogICAgICAgIGZvbnQtc2l6ZTogOXB4OwogICAgICAgIHJpZ2h0OiBtYXgoMTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgfQogICAgCiAgICAjZ29hbC1kaXN0YW5jZS1jb250YWluZXIgeyBsZWZ0OiBtYXgoMTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KSk7IH0KI2dvYWwtZGlzdGFuY2UgeyBmb250LXNpemU6IDE4cHg7IH0KfQoKLyogLS0tIEdFU1RVUkUgSElOVCAtLS0gKi8KI2dlc3R1cmUtaGludCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMjAwcHg7IGhlaWdodDogMzAwcHg7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAyNTAwOwogICAgb3BhY2l0eTogMC45Owp9CgojZ2VzdHVyZS1oaW50LmFjdGl2ZSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKfQoKLmN1cnZlLWFycm93IHsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDVweCAjMDBmZmZmKTsKICAgIGFuaW1hdGlvbjogZGFzaERyYXcgMS41cyBsaW5lYXIgaW5maW5pdGU7Cn0KCkBrZXlmcmFtZXMgZGFzaERyYXcgewogICAgdG8geyBzdHJva2UtZGFzaG9mZnNldDogLTMwOyB9Cn0KCi5nZXN0dXJlLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwogICAgbWFyZ2luLXRvcDogLTUwcHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoKLmdlc3R1cmUtaGFuZCB7CiAgICBmb250LXNpemU6IDQ4cHg7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDIwcHg7CiAgICBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICBhbmltYXRpb246IGhhbmRTd2lwZSAxLjVzIGVhc2UtaW4tb3V0IGluZmluaXRlOwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCBibGFjayk7Cn0KCkBrZXlmcmFtZXMgaGFuZFN3aXBlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgNTBweCkgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9CiAgICAyMCUgeyBvcGFjaXR5OiAxOyB9CiAgICA4MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgyMHB4LCAtMTAwcHgpIHJvdGF0ZSgyMGRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgwcHgsIC0xMjBweCkgcm90YXRlKDEwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgovKiAtLS0gU1dJUEUgVFJBSUwgKElOVFVJVElWRSBGRUVEQkFDSykgLS0tICovCi5zd2lwZS10cmFpbC1kb3QgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDEycHg7CiAgICBoZWlnaHQ6IDEycHg7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAjMDBmZmZmIDAlLCByZ2JhKDAsIDI1NSwgMjU1LCAwKSA3MCUpOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiA5MDAwOwogICAgYW5pbWF0aW9uOiBmYWRlVHJhaWwgMC41cyBsaW5lYXIgZm9yd2FyZHM7CiAgICBtaXgtYmxlbmQtbW9kZTogc2NyZWVuOwp9CgpAa2V5ZnJhbWVzIGZhZGVUcmFpbCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuMik7IG9wYWNpdHk6IDA7IH0KfQpAa2V5ZnJhbWVzIGZhZGVUcmFpbCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuMik7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIE9GRlNDUkVFTiBJTkRJQ0FUT1IgLS0tICovCiNvZmZzY3JlZW4taW5kaWNhdG9yIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiA0MHB4OyBoZWlnaHQ6IDQwcHg7CiAgICBtYXJnaW4tbGVmdDogLTIwcHg7IG1hcmdpbi10b3A6IC0yMHB4OwogICAgei1pbmRleDogMTUwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgZGlzcGxheTogbm9uZTsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDVweCAjMDAwKTsKfQoKI29mZnNjcmVlbi1pbmRpY2F0b3IgLmFycm93IHsKICAgIHdpZHRoOiAwOyBoZWlnaHQ6IDA7CiAgICBib3JkZXItbGVmdDogMTVweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGJvcmRlci1yaWdodDogMTVweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGJvcmRlci1ib3R0b206IDI1cHggc29saWQgIzAwZmYwMDsgLyogR3JlZW4gZm9yIHBsYXllciAqLwogICAgYW5pbWF0aW9uOiBwdWxzZUFycm93IDAuNXMgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgdHJhbnNmb3JtLW9yaWdpbjogY2VudGVyIGJvdHRvbTsKfQoKQGtleWZyYW1lcyBwdWxzZUFycm93IHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHNjYWxlKDEpOyBmaWx0ZXI6IGJyaWdodG5lc3MoMSk7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjIpOyBmaWx0ZXI6IGJyaWdodG5lc3MoMS41KTsgfQp9","./style.css":"data:text/css;base64,OnJvb3QgewogICAgLS1mZngtYmx1ZS1kZWVwOiAjMDIwNDA4OwogICAgLS1mZngtYmx1ZS1kYXJrOiAjMGExNTI1OwogICAgLS1mZngtYmx1ZS1taWQ6ICMxNTJhNDU7CiAgICAtLWZmeC1ibHVlLWxpZ2h0OiAjMmE0ZDc1OwogICAgLS1mZngtY3lhbjogIzYwYzBkMDsKICAgIC0tZmZ4LWN5YW4tZ2xvdzogIzAwZmZmZjsKICAgIC0tZmZ4LWdvbGQ6ICNjOGIwNjA7CiAgICAtLWZmeC1nb2xkLWxpZ2h0OiAjZjBlMDkwOwogICAgLS1mZngtZ29sZC1kYXJrOiAjOGE3MDMwOwogICAgLS1mZngtZ2xhc3MtYmc6IHJnYmEoMTAsIDIwLCA0MCwgMC43NSk7CiAgICAtLWZmeC1nbGFzcy1ib3JkZXI6IHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIAogICAgLS1mb250LXRpdGxlOiAnR2FyYW1vbmQnLCAnVGltZXMgTmV3IFJvbWFuJywgc2VyaWY7CiAgICAtLWZvbnQtZGF0YTogJ0ltcGFjdCcsICdBcmlhbCBOYXJyb3cnLCBzYW5zLXNlcmlmOwogICAgLS1mb250LXVpOiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAtLWZvbnQtc3BpcmE6ICdTcGlyYScsICdJbXBhY3QnLCBzYW5zLXNlcmlmOwp9CgpAZm9udC1mYWNlIHsKICAgIGZvbnQtZmFtaWx5OiAnU3BpcmEnOwogICAgc3JjOiB1cmwoJ2h0dHBzOi8vZmlsZXMuY2F0Ym94Lm1vZS96eW43czMudHRmJykgZm9ybWF0KCd0cnVldHlwZScpOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgIGZvbnQtc3R5bGU6IG5vcm1hbDsKfQoKaHRtbCwgYm9keSB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB3aWR0aDogMTAwdnc7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBwb3NpdGlvbjogZml4ZWQ7IAogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHJpZ2h0OiAwOwogICAgYm90dG9tOiAwOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBjb2xvcjogd2hpdGU7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICBwYWRkaW5nLXRvcDogZW52KHNhZmUtYXJlYS1pbnNldC10b3ApOwogICAgcGFkZGluZy1ib3R0b206IGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKTsKICAgIHBhZGRpbmctbGVmdDogZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KTsKICAgIHBhZGRpbmctcmlnaHQ6IGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpOwp9CgoqIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7Cn0KCi8qIC0tLSBNQUlOIEdBTUUgQ09OVEFJTkVSIC0tLSAqLwojZ2FtZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgbWF4LXdpZHRoOiBub25lOwogICAgYmFja2dyb3VuZDogIzAwMDUxMDsKICAgIGJveC1zaGFkb3c6IG5vbmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgdHJhbnNpdGlvbjogZmlsdGVyIDAuMDVzOwogICAgei1pbmRleDogMTsKfQoKLyogLS0tIElNUEFDVCBGWCAtLS0gKi8KI2dhbWUtY29udGFpbmVyLmltcGFjdC1meCB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuMXMgZWFzZS1pbi1vdXQ7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDEuMikgYnJpZ2h0bmVzcygxLjEpOwp9CgojZ2FtZS1jb250YWluZXIuaW1wYWN0LWhlYXZ5IHsKICAgIGFuaW1hdGlvbjogaW1wYWN0U2hha2UgMC4ycyBlYXNlLWluLW91dDsKICAgIGZpbHRlcjogY29udHJhc3QoMS41KSBicmlnaHRuZXNzKDEuMykgc2VwaWEoMC40KSBodWUtcm90YXRlKC0xMGRlZyk7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3Qtc2hhdHRlciB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuNHMgZWFzZS1pbi1vdXQ7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDIuMCkgaW52ZXJ0KDAuMSkgc2F0dXJhdGUoMi4wKTsKfQoKQGtleWZyYW1lcyBpbXBhY3RTaGFrZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDAsIDApOyB9CiAgICAyNSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNXB4LCA1cHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSg1cHgsIC01cHgpOyB9CiAgICA3NSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNXB4LCAtNXB4KTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDAsIDApOyB9Cn0KCi8qIC0tLSBDQU5WQVMgJiBSRU5ERVIgLS0tICovCmNhbnZhcyB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsKICAgIGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGltYWdlLXJlbmRlcmluZzogcGl4ZWxhdGVkOyAKICAgIHotaW5kZXg6IDA7Cn0KCi8qIC0tLSBHSUYgT1ZFUkxBWSAtLS0gKi8KI3NjcmVlbi1vdmVybGF5LWdpZiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgb2JqZWN0LWZpdDogY292ZXI7CiAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKICAgIG9wYWNpdHk6IDEuMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogOTUwOwogICAgaW1hZ2UtcmVuZGVyaW5nOiBwaXhlbGF0ZWQ7Cn0KCiN1aS1sYXllciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgei1pbmRleDogMTAwMDsKfQoKLyogLS0tIENJTkVNQVRJQyBCQVJTIC0tLSAqLwojY2luZW1hdGljLWJhcnMgLmJhciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAwOwogICAgYmFja2dyb3VuZDogYmxhY2s7CiAgICB0cmFuc2l0aW9uOiBoZWlnaHQgMC41cyBlYXNlOwogICAgei1pbmRleDogODAwOwp9CiNjaW5lbWF0aWMtYmFycyAuYmFyLnRvcCB7IHRvcDogMDsgfQojY2luZW1hdGljLWJhcnMgLmJhci5ib3R0b20geyBib3R0b206IDA7IH0KCi8qIC0tLSBURUNIIEZMQVNIIE9WRVJMQVkgLS0tICovCiN0ZWNoLWZsYXNoLW92ZXJsYXkgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAyMCU7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEyMHB4OwogICAgZGlzcGxheTogbm9uZTsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwwLDAsMCkgMCUsIHJnYmEoMCwgMjAsIDYwLCAwLjkpIDIwJSwgcmdiYSgwLCAyMCwgNjAsIDAuOSkgODAlLCByZ2JhKDAsMCwwLDApIDEwMCUpOwogICAgei1pbmRleDogMjIwMDsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigycHgpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMTAwLCAyNTUsIDI1NSwgMC4zKTsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDEwMCwgMjU1LCAyNTUsIDAuMyk7CiAgICBhbmltYXRpb246IGZsYXNoRW50ZXIgMC4xNXMgZWFzZS1vdXQ7Cn0KCkBrZXlmcmFtZXMgZmxhc2hFbnRlciB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiBzY2FsZVkoMCk7IG9wYWNpdHk6IDA7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZVkoMSk7IG9wYWNpdHk6IDE7IH0KfQoKLnRlY2gtY29udGVudC13cmFwcGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goLTEwZGVnKTsKfQoKLnRlY2gtdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IGNsYW1wKDI4cHgsIDEwdncsIDQycHgpOwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZiwgMCAwIDIwcHggIzAwMDBmZjsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7CiAgICBtYXJnaW4tYm90dG9tOiAycHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBhbmltYXRpb246IGJsaW5rVGV4dCAwLjA4cyBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCi50ZWNoLXN1Yi10ZXh0IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjMDBmZmZmOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjUpOwp9CgoudGVjaC10aW1lci10cmFjayB7CiAgICB3aWR0aDogMjUwcHg7CiAgICBoZWlnaHQ6IDhweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC42KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggcmdiYSgwLDAsMCwwLjUpOwp9CgoudGVjaC10aW1lci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmZmZiwgIzAwZmZmZik7CiAgICB3aWR0aDogMTAwJTsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGxlZnQ7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwp9CgpAa2V5ZnJhbWVzIGJsaW5rVGV4dCB7CiAgICBmcm9tIHsgb3BhY2l0eTogMC44OyB0ZXh0LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOyB0cmFuc2Zvcm06IHNjYWxlKDEpOyB9CiAgICB0byB7IG9wYWNpdHk6IDEuMDsgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICNmZmZmZmYsIDAgMCAxMHB4ICMwMGZmZmY7IHRyYW5zZm9ybTogc2NhbGUoMS4wMik7IH0KfQoKLyogLS0tIEhVRCBUT1AgLS0tICovCi8qIC0tLSBIVUQgVE9QIC0tLSAqLwojaHVkLXRvcCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7CiAgICBsZWZ0OiAwOwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIGFsaWduLWl0ZW1zOiBmbGV4LXN0YXJ0OwogICAgd2lkdGg6IDEwMCU7CiAgICBwYWRkaW5nOiAxNXB4OwogICAgcGFkZGluZy10b3A6IG1heCgxNXB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkpOwogICAgcGFkZGluZy1sZWZ0OiBtYXgoMTVweCwgZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KSk7CiAgICBwYWRkaW5nLXJpZ2h0OiBtYXgoMTVweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sIHJnYmEoMCwgNSwgMTUsIDAuOSkgMCUsIHJnYmEoMCwwLDAsMCkgMTAwJSk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC41czsKfQoKLnRlYW0td2luZyB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHdpZHRoOiAxNDBweDsKICAgIGhlaWdodDogNTVweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHJnYmEoMjAsIDQwLCA4MCwgMC45KSAwJSwgcmdiYSg1LCAxMCwgMjAsIDAuOTUpIDEwMCUpOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgxMDAsIDIwMCwgMjU1LCAwLjMpOwogICAgYm9yZGVyLXRvcDogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIHRyYW5zZm9ybTogc2tld1goLTE1ZGVnKTsKICAgIGJveC1zaGFkb3c6IDAgNXB4IDE1cHggcmdiYSgwLCAwLCAwLCAwLjUpLCBpbnNldCAwIDAgMjBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjEpOwogICAgcGFkZGluZzogMCAxNXB4OwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7Cn0KCi50ZWFtLXdpbmc6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgcmdiYSgyNTUsMjU1LDI1NSwwLjEpLCB0cmFuc3BhcmVudCk7CiAgICBhbmltYXRpb246IHdpbmdTaGltbWVyIDRzIGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIHdpbmdTaGltbWVyIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0xMDAlKTsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDEwMCUpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDEwMCUpOyB9Cn0KCi50ZWFtLXdpbmcuYXdheSB7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDE1ZGVnKTsKICAgIGZsZXgtZGlyZWN0aW9uOiByb3ctcmV2ZXJzZTsKICAgIGJvcmRlci10b3AtY29sb3I6ICNmZjY2NjY7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoLTE2MGRlZywgcmdiYSg2MCwgMjAsIDIwLCAwLjkpIDAlLCByZ2JhKDIwLCA1LCA1LCAwLjk1KSAxMDAlKTsKfQoKLnRlYW0tZGF0YSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZyk7CiAgICBmbGV4LWdyb3c6IDE7Cn0KLnRlYW0td2luZy5hd2F5IC50ZWFtLWRhdGEgeyB0cmFuc2Zvcm06IHNrZXdYKC0xNWRlZyk7IHRleHQtYWxpZ246IHJpZ2h0OyB9CgoudGVhbS1uYW1lIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMTZweDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCByZ2JhKDAsIDE1MCwgMjU1LCAwLjgpOwp9Ci50ZWFtLXN1YiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBvcGFjaXR5OiAwLjg7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4Owp9Ci50ZWFtLXdpbmcuYXdheSAudGVhbS1zdWIgeyBjb2xvcjogI2ZmYWFhYTsgfQoKLnNjb3JlLWJveCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDAgMTVweCB2YXIoLS1mZngtY3lhbi1nbG93KTsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpOwogICAgbWFyZ2luOiAwIDVweDsKICAgIG1pbi13aWR0aDogMzBweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoudGVhbS13aW5nLmF3YXkgLnNjb3JlLWJveCB7IHRyYW5zZm9ybTogc2tld1goLTE1ZGVnKTsgdGV4dC1zaGFkb3c6IDAgMCAxNXB4ICNmZjQ0NDQ7IH0KCi50aW1lci1jb21wbGV4IHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG1hcmdpbi10b3A6IC01cHg7Cn0KCi50aW1lci1jcnlzdGFsLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtMzBweDsKICAgIHdpZHRoOiAxNDBweDsKICAgIGhlaWdodDogNzBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlci10b3A6IDNweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3gtc2hhZG93OiAwIC01cHggMjBweCByZ2JhKDIwMCwgMTgwLCAxMDAsIDAuNCksIGluc2V0IDAgMTBweCAyMHB4IHJnYmEoMCwwLDAsMC41KTsKICAgIHotaW5kZXg6IC0xOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGVsbGlwc2UgYXQgdG9wLCByZ2JhKDIwLCA0MCwgODAsIDAuOSksIHRyYW5zcGFyZW50IDcwJSk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNHB4KTsKfQoKI2hhbGYtaW5kaWNhdG9yIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogNHB4OwogICAgbWFyZ2luLWJvdHRvbTogLTRweDsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1nb2xkLWRhcmspOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKfQoKI3RpbWVyLWRpc3BsYXkgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQ4cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmIDAlLCAjZmZkNzAwIDUwJSwgI2I4ODYwYiAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDJweCAwcHggcmdiYSgwLDAsMCwwLjgpKTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7Cn0KLyogLS0tIFBMQVlFUiBTVEFUVVMgUEFORUwgLS0tICovCiNwbGF5ZXItc3RhdHVzLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyA0MHB4KTsKICAgIGxlZnQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQpKTsKICAgIHdpZHRoOiAxNjBweDsKICAgIHBhZGRpbmc6IDEwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMTAsIDMwLCAwLjgpIDAlLCByZ2JhKDAsMCwwLDApIDEwMCUpOwogICAgYm9yZGVyLWxlZnQ6IDNweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiAwIDEwcHggMTBweCAwOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7Cn0KCi5jaGFyLW5hbWUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAxOHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKICAgIHRyYW5zZm9ybTogc2tld1goMTBkZWcpOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwp9CgouaHAtZ2F1Z2UtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogNHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7Cn0KLmhwLWxhYmVsIHsgZm9udC1zaXplOiAxMHB4OyBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOyB3aWR0aDogMjBweDsgfQouaHAtYmFyLXRyYWNrIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGhlaWdodDogNnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIG1hcmdpbjogMCA1cHg7Cn0KLmhwLWJhci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgIzAwZmYwMCwgI2NjZmZjYyk7CiAgICBib3gtc2hhZG93OiAwIDAgNXB4ICMwMGZmMDA7Cn0KLmhwLXZhbHVlIHsgZm9udC1zaXplOiAxMHB4OyBjb2xvcjogI2ZmZjsgd2lkdGg6IDQ1cHg7IHRleHQtYWxpZ246IHJpZ2h0OyB9CgoudGVjaC1nYXVnZS1jb250YWluZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDEwZGVnKTsKfQoudGVjaC1sYWJlbCB7IGZvbnQtc2l6ZTogMTBweDsgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsgd2lkdGg6IDIwcHg7IH0KLnRlY2gtYmFyLXRyYWNrIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGhlaWdodDogNHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIG1hcmdpbjogMCA1cHg7Cn0KLnRlY2gtYmFyLWZpbGwgewogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjZmZhYTAwLCAjZmZmZmFhKTsKfQoKLyogLS0tIE1JTklNQVAgLS0tICovCiNtaW5pbWFwLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg4MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA2MHB4KTsKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgaGVpZ2h0OiAxMTBweDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7Cn0KCi5yYWRhci1yaW0gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHZhcigtLWZmeC1ibHVlLWxpZ2h0KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHZhcigtLWZmeC1ibHVlLW1pZCksIGluc2V0IDAgMCAyMHB4IHJnYmEoMCwwLDAsMC44KTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMCwgMjAsIDYwLCAwLjQpIDAlLCByZ2JhKDAsIDUsIDEwLCAwLjgpIDEwMCUpOwogICAgei1pbmRleDogNTsKfQoKI21pbmltYXAgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgd2lkdGg6IDEwMHB4OwogICAgaGVpZ2h0OiAxMDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHotaW5kZXg6IDY7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgoucmFkYXItbGFiZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAtMTVweDsKICAgIHdpZHRoOiAxNDAlOwogICAgbGVmdDogLTIwJTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4pOwp9CgoubWFwLWRvdCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB3aWR0aDogNnB4OyBoZWlnaHQ6IDZweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgYm94LXNoYWRvdzogMCAwIDRweCBjdXJyZW50Q29sb3I7Cn0KLm1hcC1kb3QuaG9tZSB7IGJhY2tncm91bmQ6IHZhcigtLWZmeC1jeWFuKTsgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsgfQoubWFwLWRvdC5hd2F5IHsgYmFja2dyb3VuZDogI2ZmNDQ0NDsgY29sb3I6ICNmZjQ0NDQ7IH0KLm1hcC1kb3QuYmFsbCB7IAogICAgYmFja2dyb3VuZDogI2ZmMDBjYzsKICAgIGNvbG9yOiAjZmYwMGNjOyAKICAgIHdpZHRoOiAxMnB4OyBoZWlnaHQ6IDEycHg7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjZmZmZmZmOwogICAgei1pbmRleDogMjA7CiAgICBhbmltYXRpb246IGJsaW5rQmFsbCAwLjNzIGluZmluaXRlIGFsdGVybmF0ZTsKICAgIGJveC1zaGFkb3c6IDAgMCA2cHggI2ZmMDBjYzsKfQoubWFwLWRvdC5uYXAgeyBiYWNrZ3JvdW5kOiAjMzMzOyBjb2xvcjogIzAwMDsgYm9yZGVyOiAxcHggc29saWQgIzU1NTsgfQoubWFwLWRvdC5hY3RpdmUtcGxheWVyIHsgCiAgICBiYWNrZ3JvdW5kOiAjMDBmZjAwICFpbXBvcnRhbnQ7IAogICAgY29sb3I6ICMwMGZmMDAgIWltcG9ydGFudDsgCiAgICBib3gtc2hhZG93OiAwIDAgOHB4ICMwMGZmMDA7CiAgICB6LWluZGV4OiAxNTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuMik7Cn0KLm1hcC1kb3QuYmFsbC1jYXJyaWVyIHsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4ICNmZmYsIDAgMCAzMHB4ICNmZmFhMDA7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjZmZmZmZmOwogICAgYmFja2dyb3VuZC1jb2xvcjogI2ZmYWEwMCAhaW1wb3J0YW50OwogICAgei1pbmRleDogMTAwOwogICAgd2lkdGg6IDEwcHg7IGhlaWdodDogMTBweDsKICAgIGFuaW1hdGlvbjogY2FycmllclB1bHNlIDAuOHMgaW5maW5pdGUgYWx0ZXJuYXRlOwp9CkBrZXlmcmFtZXMgY2FycmllclB1bHNlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjIpOyBib3gtc2hhZG93OiAwIDAgMTBweCAjZmZmOyBvcGFjaXR5OiAwLjg7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS44KTsgYm94LXNoYWRvdzogMCAwIDI1cHggI2ZmY2MwMDsgb3BhY2l0eTogMS4wOyB9Cn0KQGtleWZyYW1lcyBibGlua0JhbGwgeyBmcm9tIHsgb3BhY2l0eTogMTsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IH0gdG8geyBvcGFjaXR5OiAwLjU7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuMyk7IH0gfQoKLyogLS0tIEFOTk9VTkNFTUVOVFMgLS0tICovCiNhbm5vdW5jZW1lbnQgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA0MCU7IAogICAgbGVmdDogNSU7IAogICAgd2lkdGg6IDkwJTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiBjbGFtcCg0MHB4LCAxMnZ3LCA3MnB4KTsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICB3aGl0ZS1zcGFjZTogbm9ybWFsOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZiAwJSwgI2ZmZDcwMCA0MCUsICNiODg2MGIgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggcmdiYSgyNTUsIDEwMCwgMCwgMC41KSkgZHJvcC1zaGFkb3coM3B4IDNweCAwICMwMDApOwogICAgZGlzcGxheTogbm9uZTsKICAgIHotaW5kZXg6IDIwMDA7CiAgICBhbmltYXRpb246IGFubm91bmNlU2xpZGUgMC41cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKQGtleWZyYW1lcyBhbm5vdW5jZVNsaWRlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHNjYWxlKDApIHJvdGF0ZSgtNWRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZSgxKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDE7IH0KfQoKLyogLS0tIEpPWVNUSUNLIC0tLSAqLwojam95c3RpY2staGl0LXpvbmUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDUwJTsgaGVpZ2h0OiA1MCU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwKTsgCiAgICB0b3VjaC1hY3Rpb246IG5vbmU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKfQoKI2pveXN0aWNrLXZpc3VhbC1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDA7IGhlaWdodDogMDsKICAgIG92ZXJmbG93OiB2aXNpYmxlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMTEwMDsKfQoKI2pveXN0aWNrLWJhc2UgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDEyMHB4OyBoZWlnaHQ6IDEyMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgwLCA0MCwgODAsIDAuNCkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjEpIDYwJSwgdHJhbnNwYXJlbnQgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDEwMCwgMjIwLCAyNTUsIDAuMyk7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpLCBpbnNldCAwIDAgMzBweCByZ2JhKDAsIDUwLCAxMDAsIDAuMyk7CiAgICBhbmltYXRpb246IGJhc2VQdWxzZSAycyBpbmZpbml0ZSBhbHRlcm5hdGU7Cn0KCkBrZXlmcmFtZXMgYmFzZVB1bHNlIHsKICAgIGZyb20geyBib3gtc2hhZG93OiAwIDAgMTBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpOyBib3JkZXItY29sb3I6IHJnYmEoMTAwLCAyMjAsIDI1NSwgMC4yKTsgfQogICAgdG8geyBib3gtc2hhZG93OiAwIDAgMjVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjUpOyBib3JkZXItY29sb3I6IHJnYmEoMTAwLCAyNTUsIDI1NSwgMC42KTsgfQp9Cgojam95c3RpY2sta25vYiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogNTBweDsgaGVpZ2h0OiA1MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzMCUgMzAlLCAjZTBmZmZmIDAlLCAjMDBhYWZmIDQwJSwgIzAwNDQ4OCA4MCUsICMwMDExMjIgMTAwJSk7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjODhjY2ZmOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggIzAwZmZmZiwgaW5zZXQgMCAwIDEwcHggcmdiYSgyNTUsMjU1LDI1NSwwLjgpOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMDVzIGxpbmVhcjsKfQoKI2pveXN0aWNrLWtub2I6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICIiOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAyMCU7IGxlZnQ6IDIwJTsgd2lkdGg6IDIwJTsgaGVpZ2h0OiAyMCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAjZmZmZmZmIDAlLCB0cmFuc3BhcmVudCA3MCUpOwogICAgZmlsdGVyOiBibHVyKDJweCk7CiAgICBvcGFjaXR5OiAwLjg7Cn0KCi50b3VjaC1yaXBwbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgyMDAsIDI1NSwgMjU1LCAwLjgpIDAlLCByZ2JhKDAsIDI1NSwgMjU1LCAwLjQpIDQwJSwgdHJhbnNwYXJlbnQgNzAlKTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDApOwogICAgYW5pbWF0aW9uOiByaXBwbGVBbmltIDAuNnMgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDkwMDA7CiAgICBtaXgtYmxlbmQtbW9kZTogc2NyZWVuOwp9CgpAa2V5ZnJhbWVzIHJpcHBsZUFuaW0gewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgwKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDMuMCk7IG9wYWNpdHk6IDA7IH0KfQoKI2NhbWVyYS16b25lIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgcmlnaHQ6IDA7IHdpZHRoOiA1MCU7IGhlaWdodDogMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdG91Y2gtYWN0aW9uOiBub25lOwogICAgei1pbmRleDogNTA7Cn0KCi8qIC0tLSBBQ1RJT04gQlVUVE9OIC0tLSAqLwojYWN0aW9uLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCg0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOyAKICAgIHJpZ2h0OiBtYXgoNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB6LWluZGV4OiAxMDA7Cn0KCi5jb21tYW5kLW1lbnUtYmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDE4MHB4OyBoZWlnaHQ6IDgwcHg7CiAgICBib3R0b206IDE1cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHRyYW5zcGFyZW50IDAlLCByZ2JhKDAsIDEwLCAzMCwgMC44KSA1MCUsIHRyYW5zcGFyZW50IDEwMCUpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMCwgMjAwLCAyNTUsIDAuMyk7CiAgICB6LWluZGV4OiAtMTsKfQoKLmNvbW1hbmQtcmluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMTMwcHg7IGhlaWdodDogMTMwcHg7CiAgICBib3JkZXI6IDJweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7CiAgICBib3JkZXItdG9wOiAycHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC42KTsKICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCByZ2JhKDAsIDI1NSwgMjU1LCAwLjYpOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYW5pbWF0aW9uOiBzcGluUmV2ZXJzZSAxNXMgbGluZWFyIGluZmluaXRlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpOwp9CkBrZXlmcmFtZXMgc3BpblJldmVyc2UgeyBmcm9tIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgcm90YXRlKDM2MGRlZyk7IH0gdG8geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSByb3RhdGUoMGRlZyk7IH0gfQoKI2FjdGlvbi1sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCA1LCAxMCwgMC44KTsKICAgIHBhZGRpbmc6IDRweCAxMnB4OwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwogICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMCwwLDAsMC44KTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjNzOwp9CgojYWN0aW9uLWJ1dHRvbiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwcHg7IGhlaWdodDogMTAwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4xcywgZmlsdGVyIDAuM3M7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZmZmZmYgMCUsICMwMDg4ZmYgNDAlLCAjMDAyMjY2IDgwJSwgIzAwMCAxMDAlKTsKICAgIGJvcmRlcjogM3B4IHNvbGlkICM0NGFhZmY7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjgpLCBpbnNldCAwIDAgMjBweCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNCk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICB6LWluZGV4OiAxMDsKfQoKI3Bhc3MtYnV0dG9uIHsKICAgIGRpc3BsYXk6IG5vbmUgIWltcG9ydGFudDsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogLTIwcHg7IGxlZnQ6IC0zMHB4OwogICAgd2lkdGg6IDYwcHg7IGhlaWdodDogNjBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHotaW5kZXg6IDk7Cn0KCiNhY3Rpb24tYnV0dG9uOjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC00MHB4OyBsZWZ0OiAtNDBweDsgcmlnaHQ6IC00MHB4OyBib3R0b206IC00MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgei1pbmRleDogMTA7Cn0KCiNhY3Rpb24tYnV0dG9uOmFjdGl2ZSB7IHRyYW5zZm9ybTogc2NhbGUoMC45Mik7IH0KCiNhY3Rpb24tYnV0dG9uIC5idG4tdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDIycHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDJweCA0cHggcmdiYSgwLDAsMCwwLjgpLCAwIDAgMTBweCByZ2JhKDI1NSwyNTUsMjU1LDAuNSk7CiAgICB6LWluZGV4OiA1OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgojYWN0aW9uLWJ1dHRvbiAuYnRuLWdsYXJlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwJTsgbGVmdDogLTUwJTsgd2lkdGg6IDIwMCU7IGhlaWdodDogMjAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg0NWRlZywgdHJhbnNwYXJlbnQgNDAlLCByZ2JhKDI1NSwyNTUsMjU1LDAuNCkgNTAlLCB0cmFuc3BhcmVudCA2MCUpOwogICAgYW5pbWF0aW9uOiBnbGFyZVBhc3MgNXMgaW5maW5pdGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDY7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7Cn0KCi5saW1pdC1yaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTVweDsgbGVmdDogLTVweDsgcmlnaHQ6IC01cHg7IGJvdHRvbTogLTVweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHRyYW5zcGFyZW50OwogICAgYm94LXNoYWRvdzogMCAwIDAgdHJhbnNwYXJlbnQ7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC41czsKICAgIHotaW5kZXg6IDE7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKI2FjdGlvbi1idXR0b24uc2hvb3QtbW9kZSB7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZmZmYWEgMCUsICNmZmFhMDAgNDAlLCAjODgyMjAwIDgwJSwgIzIyMDAwMCAxMDAlKTsKICAgIGJvcmRlci1jb2xvcjogI2ZmY2MwMDsKICAgIGJveC1zaGFkb3c6IDAgMCAzMHB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuOCksIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCAyNTUsIDAsIDAuNSk7Cn0KCiNhY3Rpb24tYnV0dG9uLmxpbWl0LXJlYWR5IC5saW1pdC1yaW5nIHsKICAgIGJvcmRlci1jb2xvcjogI2ZmZGQ0NDsKICAgIGFuaW1hdGlvbjogbGltaXRQdWxzZSAwLjhzIGVhc2UtaW4tb3V0IGluZmluaXRlIGFsdGVybmF0ZTsKfQoKLnNob290LWxhYmVsIHsKICAgIGNvbG9yOiAjZmZkZDQ0ICFpbXBvcnRhbnQ7CiAgICBib3JkZXItY29sb3I6ICNmZmFhMDAgIWltcG9ydGFudDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmY0NDAwICFpbXBvcnRhbnQ7Cn0KCkBrZXlmcmFtZXMgbGltaXRQdWxzZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgYm94LXNoYWRvdzogMCAwIDEwcHggI2ZmYWEwMCwgaW5zZXQgMCAwIDVweCAjZmZhYTAwOyBvcGFjaXR5OiAwLjU7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMTUpOyBib3gtc2hhZG93OiAwIDAgMzBweCAjZmY0NDAwLCBpbnNldCAwIDAgMTVweCAjZmYwMDAwOyBvcGFjaXR5OiAxLjA7IH0KfQoKLyogLS0tIEFVVE8gVE9HR0xFIC0tLSAqLwojYXV0by10b2dnbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoMjAwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDYwcHgpOyAKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgcGFkZGluZzogMTBweCAwOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgwLCAyMCwgNDAsIDAuOCkgMCUsIHJnYmEoMCwgNSwgMTAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3JkZXItdG9wOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNHB4KTsKICAgIGJveC1zaGFkb3c6IDAgNXB4IDE1cHggcmdiYSgwLDAsMCwwLjMpOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIHotaW5kZXg6IDEwMDsKfQoKI2F1dG8tdG9nZ2xlOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjkpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggdmFyKC0tZmZ4LWN5YW4pOwogICAgY29sb3I6IHdoaXRlOwp9CgojYXV0by10b2dnbGUuYWN0aXZlIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMTAwLCAyMCwgMCwgMC44KSAwJSwgcmdiYSg0MCwgMCwgMCwgMC45KSAxMDAlKTsKICAgIGJvcmRlci1jb2xvcjogI2ZmNDQwMDsKICAgIGNvbG9yOiAjZmZhYTAwOwogICAgYW5pbWF0aW9uOiBwdWxzZVJlZCAycyBpbmZpbml0ZTsKfQpAa2V5ZnJhbWVzIHB1bHNlUmVkIHsgMCUgeyBib3gtc2hhZG93OiAwIDAgNXB4ICNmZjAwMDA7IH0gNTAlIHsgYm94LXNoYWRvdzogMCAwIDIwcHggI2ZmNDQwMDsgfSAxMDAlIHsgYm94LXNoYWRvdzogMCAwIDVweCAjZmYwMDAwOyB9IH0KCi8qIC0tLSBGTE9BVElORyBURVhUIC0tLSAqLwouZmxvYXRpbmctdGV4dC13cmFwcGVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogMjAwMDsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm07Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyIHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDI0cHg7IAogICAgdGV4dC1zaGFkb3c6IDFweCAxcHggMCAjMDAwOwogICAgb3BhY2l0eTogMC45Owp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5kYW1hZ2UgewogICAgZm9udC1zaXplOiA0MnB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZmZmZiAwJSwgI2ZmY2MwMCA0MCUsICNmZjQ0MDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCA0cHggNHB4IHJnYmEoMCwwLDAsMC44KSk7CiAgICBhbmltYXRpb246IHBvcERhbWFnZSAwLjhzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KSBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuaGVhbCB7CiAgICBmb250LXNpemU6IDM2cHg7CiAgICBjb2xvcjogIzQ0ZmY0NDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZjAwOwogICAgYW5pbWF0aW9uOiBmbG9hdFVwIDFzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci52ZW5vbSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGNvbG9yOiAjYWFmZjAwOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICM0NDg4MDAsIDJweCAycHggMCAjMDAyMjAwOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2NjZmY2NiAwJSwgIzY2Y2MwMCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgNXB4IHJnYmEoMTAwLCAyNTUsIDAsIDAuNSkpOwogICAgYW5pbWF0aW9uOiBkcmlwU3RhdHVzIDJzIGluZmluaXRlOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5zbGVlcCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTVweCAjMDA0NGZmLCAwIDAgMzBweCAjMDAwMGZmOwogICAgb3BhY2l0eTogMC45OwogICAgYW5pbWF0aW9uOiBkcmlmdFN0YXR1cyAzcyBlYXNlLWluLW91dCBpbmZpbml0ZTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIud2l0aGVyIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzOHB4OwogICAgY29sb3I6ICNjY2NjY2M7CiAgICB0ZXh0LXNoYWRvdzogMnB4IDJweCAwICM0NDQ0NDQ7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZWVlZWVlIDAlLCAjODg4ODg4IDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHdpdGhlclN0YXR1cyAxLjVzIGZvcndhcmRzOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci50ZWNoIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMzJweDsKICAgIGNvbG9yOiAjMDBmZmZmOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAxMCwgMzAsIDAuNyk7CiAgICBwYWRkaW5nOiAycHggMTBweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkICMwMGZmZmY7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjMDA4OGZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggI2ZmZjsKICAgIGFuaW1hdGlvbjogc2hha2VUZWNoIDAuNnMgZWFzZS1pbi1vdXQsIGZsYXNoVGVjaCAwLjNzOwogICAgdHJhbnNmb3JtLW9yaWdpbjogY2VudGVyOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5zYXZlLCAuZmxvYXRpbmctdGV4dC1pbm5lci5ibG9jayB7CiAgICBmb250LXNpemU6IDQ4cHg7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgY29sb3I6ICNmZmZmZmY7CiAgICAtd2Via2l0LXRleHQtc3Ryb2tlOiAxcHggIzAwNDQ4ODsKICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCAjMDA4OGZmOwogICAgYW5pbWF0aW9uOiBwb3BEYW1hZ2UgMC41cyBlYXNlLW91dCBmb3J3YXJkczsKfQoKQGtleWZyYW1lcyBwb3BEYW1hZ2UgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuNSk7IG9wYWNpdHk6IDA7IH0KICAgIDIwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS41KTsgb3BhY2l0eTogMTsgfQogICAgNDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgZmxvYXRVcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNTBweCk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyBkcmlwU3RhdHVzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZVkoMSk7IGZpbHRlcjogYmx1cigwcHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlWSgxLjEpIHRyYW5zbGF0ZVkoNXB4KTsgZmlsdGVyOiBibHVyKDFweCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlWSgxKTsgZmlsdGVyOiBibHVyKDBweCk7IH0KfQoKQGtleWZyYW1lcyBkcmlmdFN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIDIwJSB7IG9wYWNpdHk6IDE7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxNXB4KSB0cmFuc2xhdGVZKC0yMHB4KSByb3RhdGUoMTBkZWcpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0xNXB4KSB0cmFuc2xhdGVZKC01MHB4KSByb3RhdGUoLTEwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIHdpdGhlclN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IGZpbHRlcjogZ3JheXNjYWxlKDAlKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC42KTsgZmlsdGVyOiBncmF5c2NhbGUoMTAwJSk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyBzaGFrZVRlY2ggewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuOCk7IH0KICAgIDEwJSwgMzAlLCA1MCUsIDcwJSwgOTAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjEpIHRyYW5zbGF0ZSgtMnB4LCAycHgpOyB9CiAgICAyMCUsIDQwJSwgNjAlLCA4MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSkgdHJhbnNsYXRlKDJweCwgLTJweCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IH0KfQoKQGtleWZyYW1lcyBmbGFzaFRlY2ggewogICAgMCUgeyBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZmOyBjb2xvcjogIzAwMDsgYm9yZGVyLWNvbG9yOiAjZmZmOyB9CiAgICAxMDAlIHsgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgwLCAxMCwgMzAsIDAuODUpOyBjb2xvcjogIzAwZmZmZjsgYm9yZGVyLWNvbG9yOiAjMDBmZmZmOyB9Cn0KCiNsb2FkaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgIGFuaW1hdGlvbjogYmxpbmsgMXMgaW5maW5pdGU7Cn0KQGtleWZyYW1lcyBibGluayB7IDUwJSB7IG9wYWNpdHk6IDAuNTsgfSB9CgojY29udHJvbHMtaGludCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDEzMHB4OyB3aWR0aDogMTAwJTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiByZ2JhKDI1NSwyNTUsMjU1LDAuNCk7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmNvbWljLWltcGFjdCB7CiAgICBmb250LWZhbWlseTogJ0ltcGFjdCcsIHNhbnMtc2VyaWY7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBjb2xvcjogI2ZmZmYwMDsgCiAgICAtd2Via2l0LXRleHQtc3Ryb2tlOiAxcHggIzAwMDsKICAgIHRleHQtc2hhZG93OiAzcHggM3B4IDAgI2ZmMDAwMDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGNlbnRlcjsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICBhbmltYXRpb246IGNvbWljUG9wIDAuNHMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpIGZvcndhcmRzOwogICAgei1pbmRleDogMjUwMDsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuY29taWMtYWN0aW9uIHsKICAgIGZvbnQtZmFtaWx5OiAnQXJpYWwgQmxhY2snLCBzYW5zLXNlcmlmOwogICAgZm9udC1zaXplOiAyOHB4OwogICAgY29sb3I6ICMwMGZmZmY7IAogICAgLXdlYmtpdC10ZXh0LXN0cm9rZTogMXB4ICMwMDA7CiAgICB0ZXh0LXNoYWRvdzogMnB4IDJweCAwICMwMDQ0YWE7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgYW5pbWF0aW9uOiBjb21pY1NsaWRlIDAuNHMgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICB6LWluZGV4OiAyNTAwOwp9CgpAa2V5ZnJhbWVzIGNvbWljUG9wIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwKSByb3RhdGUoLTIwZGVnKTsgb3BhY2l0eTogMDsgfQogICAgNDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjIpIHJvdGF0ZSg1ZGVnKTsgb3BhY2l0eTogMTsgfQogICAgNjAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApIHJvdGF0ZSgtNWRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSkgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgY29taWNTbGlkZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC0yMHB4LCAyMHB4KSBzY2FsZSgwLjUpOyBvcGFjaXR5OiAwOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMjBweCwgLTIwcHgpIHNjYWxlKDEuMik7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIE1BSU4gTUVOVSAtLS0gKi8KLyogLS0tIE1BSU4gTUVOVSAmIEVORCBHQU1FIChGRlggU1RZTEUpIC0tLSAqLwojbWFpbi1tZW51LCAjZW5kLWdhbWUtbWVudSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDMwMDA7CiAgICBvcGFjaXR5OiAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuOHMgY3ViaWMtYmV6aWVyKDAuMiwgMC44LCAwLjIsIDEuMCk7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IGNlbnRlciwgcmdiYSgwLCAyMCwgNjAsIDAuNCkgMCUsIHJnYmEoMCwgNSwgMTAsIDAuOCkgMTAwJSk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNXB4KTsKfQoKI21haW4tbWVudS5hY3RpdmUsICNlbmQtZ2FtZS1tZW51LmFjdGl2ZSB7CiAgICBvcGFjaXR5OiAxOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87Cn0KCi5tZW51LWJnLW92ZXJsYXksIC5lbmQtYmctbGF5ZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogCiAgICAgICAgbGluZWFyLWdyYWRpZW50KHJnYmEoMCwwLDAsMCkgNTAlLCByZ2JhKDAsMCwwLDAuMSkgNTAlKSwgCiAgICAgICAgcmVwZWF0aW5nLWxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgyNTUsMjU1LDI1NSwwLjAyKSAwcHgsIHJnYmEoMjU1LDI1NSwyNTUsMC4wMikgMXB4LCB0cmFuc3BhcmVudCAxcHgsIHRyYW5zcGFyZW50IDIwcHgpOwogICAgYmFja2dyb3VuZC1zaXplOiAxMDAlIDRweCwgMTAwJSAxMDAlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAtMTsKfQoKLyogTE9HTyBTVFlMSU5HICovCi5mZngtbG9nby1jb250YWluZXIgewogICAgbWFyZ2luLWJvdHRvbTogNTBweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goLTEwZGVnKTsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKfQoKLmZmeC1sb2dvLW1haW4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiBjbGFtcCg0OHB4LCAxMHZ3LCA4NHB4KTsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiA4cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmZmZmIDAlLCAjYWFjY2ZmIDQwJSwgIzAwODhmZiAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjgpKTsKICAgIGFuaW1hdGlvbjogbG9nb1NoaW1tZXIgM3MgaW5maW5pdGUgYWx0ZXJuYXRlOwp9CgouZmZ4LWxvZ28tc3ViIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoMTRweCwgM3Z3LCAyNHB4KTsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogMTVweDsKICAgIG1hcmdpbi10b3A6IC0xMHB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICNmZmFhMDA7CiAgICBvcGFjaXR5OiAwLjk7Cn0KCkBrZXlmcmFtZXMgbG9nb1NoaW1tZXIgewogICAgMCUgeyBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuNSkpOyB9CiAgICAxMDAlIHsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMjVweCByZ2JhKDAsIDIwMCwgMjU1LCAwLjkpKTsgfQp9CgovKiBNRU5VIE9QVElPTlMgKi8KLm1lbnUtb3B0aW9ucywgLmVuZC1vcHRpb25zIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgZ2FwOiAxNXB4OwogICAgd2lkdGg6IDMyMHB4Owp9CgoubWVudS1pdGVtIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIHBhZGRpbmc6IDEycHggMzBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgwLCAzMCwgNjAsIDAuOCkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjIpIDEwMCUpOwogICAgYm9yZGVyLWxlZnQ6IDNweCBzb2xpZCByZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyk7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgcmdiYSgxMDAsIDIwMCwgMjU1LCAwLjEpOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdHJhbnNpdGlvbjogYWxsIDAuM3MgY3ViaWMtYmV6aWVyKDAuMiwgMC44LCAwLjIsIDEuMCk7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xNWRlZyk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCi5tZW51LWl0ZW06OmJlZm9yZSB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogLTEwMCU7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHRyYW5zcGFyZW50LCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMiksIHRyYW5zcGFyZW50KTsKICAgIHRyYW5zaXRpb246IGxlZnQgMC40czsKfQoKLm1lbnUtaXRlbTpob3Zlcjo6YmVmb3JlIHsKICAgIGxlZnQ6IDEwMCU7Cn0KCi5tZW51LWl0ZW06aG92ZXIgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDgwLCAxNjAsIDAuOSkgMCUsIHJnYmEoMCwgMjAsIDQwLCAwLjQpIDEwMCUpOwogICAgYm9yZGVyLWxlZnQtY29sb3I6ICMwMGZmZmY7CiAgICBwYWRkaW5nLWxlZnQ6IDQ1cHg7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjMpOwp9CgoubWVudS1pdGVtIC5sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDIwcHg7CiAgICBjb2xvcjogI2NjY2NjYzsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZyk7CiAgICB0cmFuc2l0aW9uOiBjb2xvciAwLjJzOwp9CgoubWVudS1pdGVtOmhvdmVyIC5sYWJlbCB7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwp9CgoubWVudS1pdGVtIC5jdXJzb3IgewogICAgd2lkdGg6IDEwcHg7IGhlaWdodDogMTBweDsKICAgIGJhY2tncm91bmQ6IHZhcigtLWZmeC1nb2xkKTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIG1hcmdpbi1yaWdodDogMTVweDsKICAgIG9wYWNpdHk6IDA7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTIwcHgpIHNrZXdYKDE1ZGVnKTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjNzOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWdvbGQpOwp9CgoubWVudS1pdGVtOmhvdmVyIC5jdXJzb3IgewogICAgb3BhY2l0eTogMTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKSBza2V3WCgxNWRlZyk7Cn0KCi5tZW51LWZvb3RlciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDMwcHg7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogcmdiYSgyNTUsMjU1LDI1NSwwLjMpOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KCi8qIEVORCBHQU1FIFNQRUNJRklDICovCi5yZXN1bHQtaGVhZGVyIHsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIG1hcmdpbi1ib3R0b206IDQwcHg7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7Cn0KCi5yZXN1bHQtdGl0bGUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiA3MnB4OwogICAgY29sb3I6ICNmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwYWFmZiwgMCAwIDQwcHggIzAwNDRhYTsKICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICBsaW5lLWhlaWdodDogMS4wOwp9CgoucmVzdWx0LXN1YnRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMThweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogOHB4OwogICAgbWFyZ2luLXRvcDogNXB4Owp9CgouZmluYWwtc2NvcmUtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBnYXA6IDQwcHg7CiAgICBtYXJnaW4tYm90dG9tOiA1MHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgcmdiYSgwLCAyMCwgNTAsIDAuOCksIHRyYW5zcGFyZW50KTsKICAgIHBhZGRpbmc6IDIwcHggMDsKICAgIHdpZHRoOiAxMDAlOwp9CgouZmluYWwtdGVhbSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB3aWR0aDogMTIwcHg7Cn0KCi5maW5hbC1zY29yZS1kaWdpdCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogODBweDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC41KTsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7Cn0KCi5maW5hbC10ZWFtLmhvbWUgLmZpbmFsLXNjb3JlLWRpZ2l0IHsgY29sb3I6ICMwMGZmZmY7IHRleHQtc2hhZG93OiAwIDAgMjBweCAjMDBmZmZmOyB9Ci5maW5hbC10ZWFtLmF3YXkgLmZpbmFsLXNjb3JlLWRpZ2l0IHsgY29sb3I6ICNmZjQ0NDQ7IHRleHQtc2hhZG93OiAwIDAgMjBweCAjZmY0NDQ0OyB9CgouZmluYWwtdGVhbS1uYW1lIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjYWFhOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG1hcmdpbi10b3A6IDVweDsKfQoKLmZpbmFsLXZzIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG9wYWNpdHk6IDAuNjsKfQoKLmZpbmFsLXZzIHNwYW4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIG1hcmdpbjogNXB4IDA7Cn0KCi52cy1saW5lIHsKICAgIHdpZHRoOiAycHg7IGhlaWdodDogMzBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sIHRyYW5zcGFyZW50LCB2YXIoLS1mZngtZ29sZCksIHRyYW5zcGFyZW50KTsKfQovKiAtLS0gUFJBQ1RJQ0UgT1ZFUkxBWSAtLS0gKi8KI3ByYWN0aWNlLW92ZXJsYXkgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCA1LCAxMCwgMC42KTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB6LWluZGV4OiAyNTAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCiNwcmFjdGljZS1vdmVybGF5LmFjdGl2ZSB7CiAgICBkaXNwbGF5OiBmbGV4Owp9CgoucHJhY3RpY2UtcGFuZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNDBweCk7IAogICAgcmlnaHQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogMjgwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTYwZGVnLCByZ2JhKDAsIDIwLCA1MCwgMC45NSkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjk4KSAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDg4ZmY7CiAgICBib3JkZXItcmFkaXVzOiAwIDAgMTVweCAwOwogICAgYm94LXNoYWRvdzogMCAwIDIwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC4yKSwgaW5zZXQgMCAwIDUwcHggcmdiYSgwLCAyMCwgNjAsIDAuNSk7CiAgICBwYWRkaW5nOiAxNXB4OwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0yZGVnKTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig1cHgpOwp9CgoucGFuZWwtaGVhZGVyIHsKICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCi5wYW5lbC10aXRsZS1ncm91cCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKfQoKLnBhbmVsLXRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoMThweCwgNnZ3LCAyNHB4KTsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICMwMGZmZmY7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4Owp9CgoucGFuZWwtc3VidGl0bGUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiA4cHg7CiAgICBjb2xvcjogIzQ0ODhmZjsKICAgIGxldHRlci1zcGFjaW5nOiA0cHg7CiAgICBtYXJnaW4tdG9wOiAtMnB4Owp9CgoucGFuZWwtZGVjby1saW5lIHsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAycHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHRyYW5zcGFyZW50LCAjMDBmZmZmLCB0cmFuc3BhcmVudCk7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICBib3gtc2hhZG93OiAwIDAgNXB4ICMwMGZmZmY7Cn0KCi5wYW5lbC1jb250ZW50IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgZ2FwOiAxNXB4Owp9Cgouc2VjdGlvbi1sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMjAwLCAxNzYsIDk2LCAwLjMpOwogICAgbWFyZ2luLWJvdHRvbTogNXB4OwogICAgcGFkZGluZy1ib3R0b206IDJweDsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7Cn0KCi5kcmlsbC1saXN0IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgZ2FwOiA1cHg7Cn0KCi5kcmlsbC1idG4gewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwYWRkaW5nOiA4cHggMTJweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjA1KSwgdHJhbnNwYXJlbnQpOwogICAgYm9yZGVyLWxlZnQ6IDJweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAxNHB4OwogICAgY29sb3I6ICNhYWE7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoKLmRyaWxsLWJ0bjpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMjU1LCAyNTUsIDAuMSksIHRyYW5zcGFyZW50KTsKICAgIGNvbG9yOiAjZmZmOwogICAgcGFkZGluZy1sZWZ0OiAxNXB4Owp9CgouZHJpbGwtYnRuLmFjdGl2ZSB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMTAwLCAyNTUsIDAuNCksIHRyYW5zcGFyZW50KTsKICAgIGJvcmRlci1sZWZ0OiAzcHggc29saWQgIzAwZmZmZjsKICAgIGNvbG9yOiAjZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggIzAwZmZmZjsKfQoKLmRyaWxsLWJ0biAuaWNvbiB7CiAgICB3aWR0aDogMjBweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIG1hcmdpbi1yaWdodDogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7Cn0KCi5vcHRpb24tbGlzdCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogNXB4Owp9Cgoub3B0aW9uLXRvZ2dsZSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBhZGRpbmc6IDVweCAxMHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgY29sb3I6ICNjY2M7CiAgICB0cmFuc2l0aW9uOiBjb2xvciAwLjJzOwp9Cgoub3B0aW9uLXRvZ2dsZTpob3ZlciB7IGNvbG9yOiAjZmZmOyB9Cgoub3B0aW9uLXRvZ2dsZSAuY2hlY2tib3ggewogICAgbWFyZ2luLXJpZ2h0OiAxMHB4OwogICAgY29sb3I6ICM0NDQ7CiAgICBmb250LWZhbWlseTogbW9ub3NwYWNlOwogICAgZm9udC1zaXplOiAxNHB4Owp9Cgoub3B0aW9uLXRvZ2dsZS5hY3RpdmUgLmNoZWNrYm94IHsKICAgIGNvbG9yOiAjMDBmZjAwOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggIzAwZmYwMDsKfQoKLm9wdGlvbi10b2dnbGUuYWN0aXZlIHsKICAgIGNvbG9yOiAjZmZmOwp9CgouYWN0aW9uLWJ0biB7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuNSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ0OwogICAgcGFkZGluZzogNnB4OwogICAgZm9udC1zaXplOiAxMXB4OwogICAgY29sb3I6ICNhYWE7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgouYWN0aW9uLWJ0bjpob3ZlciB7CiAgICBib3JkZXItY29sb3I6ICNmZmY7CiAgICBjb2xvcjogI2ZmZjsKICAgIGJhY2tncm91bmQ6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKTsKfQoKI3AtZXhpdDpob3ZlciB7CiAgICBib3JkZXItY29sb3I6ICNmZjQ0NDQ7CiAgICBjb2xvcjogI2ZmNDQ0NDsKICAgIGJhY2tncm91bmQ6IHJnYmEoNTAsIDAsIDAsIDAuMyk7Cn0KCi5wYW5lbC1mb290ZXIgewogICAgbWFyZ2luLXRvcDogMTVweDsKICAgIHBhZGRpbmctdG9wOiAxMHB4OwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoKI2RyaWxsLWluc3RydWN0aW9uIHsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBtYXJnaW4tYm90dG9tOiA1cHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7Cn0KCiNkcmlsbC1zY29yZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggcmdiYSgyNTUsIDIxNSwgMCwgMC41KTsKfQoKLnBhbmVsLW1pbmltaXplLWJ0biB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDEwcHg7IHJpZ2h0OiAxMHB4OwogICAgd2lkdGg6IDIwcHg7IGhlaWdodDogMjBweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBsaW5lLWhlaWdodDogMThweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC41KTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwp9Ci5wYW5lbC1taW5pbWl6ZS1idG46aG92ZXIgeyAKICAgIGJhY2tncm91bmQ6IHZhcigtLWZmeC1jeWFuKTsgCiAgICBjb2xvcjogIzAwMDsgCiAgICBib3gtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKfQoKI3ByYWN0aWNlLXJlc3RvcmUtYnRuIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDYwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDQwcHgpOyAKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgcGFkZGluZzogOHB4IDE1cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMjAsIDUwLCAwLjkpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC45KSAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1sZWZ0OiAzcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHotaW5kZXg6IDI0MDA7CiAgICBkaXNwbGF5OiBub25lOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKfQojcHJhY3RpY2UtcmVzdG9yZS1idG46aG92ZXIgewogICAgYmFja2dyb3VuZDogcmdiYSgwLCA0MCwgODAsIDAuOSk7CiAgICBjb2xvcjogI2ZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMGZmZmY7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjMpOwp9CgovKiAtLS0gQUlNIEpPWVNUSUNLIC0tLSAqLwojYWltLWpveXN0aWNrLXpvbmUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiBtYXgoMTUwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSk7CiAgICByaWdodDogMDsKICAgIHdpZHRoOiA0MCU7CiAgICBoZWlnaHQ6IDM1JTsKICAgIHotaW5kZXg6IDEwMDA7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDApOwogICAgdG91Y2gtYWN0aW9uOiBub25lOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87Cn0KCiNhaW0tam95c3RpY2stdmlzdWFsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAwOyBoZWlnaHQ6IDA7CiAgICBvdmVyZmxvdzogdmlzaWJsZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgZGlzcGxheTogbm9uZTsKICAgIHotaW5kZXg6IDExMDA7Cn0KCiNhaW0tam95c3RpY2stYmFzZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogOTBweDsgaGVpZ2h0OiA5MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgyNTUsIDEwMCwgMCwgMC4zKSAwJSwgcmdiYSg4MCwgMjAsIDAsIDAuMSkgNjAlLCB0cmFuc3BhcmVudCAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMjU1LCAxNTAsIDUwLCAwLjQpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgyNTUsIDEwMCwgMCwgMC4yKSwgaW5zZXQgMCAwIDIwcHggcmdiYSgyNTUsIDUwLCAwLCAwLjIpOwp9CgojYWltLWpveXN0aWNrLWtub2IgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDQwcHg7IGhlaWdodDogNDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzAlIDMwJSwgI2ZmY2M4OCAwJSwgI2ZmNjYwMCA0MCUsICM4ODIyMDAgODAlLCAjMjIwMDAwIDEwMCUpOwogICAgYm9yZGVyOiAycHggc29saWQgI2ZmYWE0NDsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4ICNmZjQ0MDAsIGluc2V0IDAgMCA4cHggcmdiYSgyNTUsMjU1LDI1NSwwLjYpOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMDVzIGxpbmVhcjsKfQoKI2FpbS1qb3lzdGljay1rbm9iOjphZnRlciB7CiAgICBjb250ZW50OiAiQUlNIjsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGZvbnQtc2l6ZTogOHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDNweCAjMDAwOwp9CgovKiAtLS0gVEFDS0xFIEJVVFRPTiAtLS0gKi8KI3RhY2tsZS1idXR0b24gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiBtYXgoMTYwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSArIDEwMHB4KTsKICAgIHJpZ2h0OiBtYXgoNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDcwcHg7CiAgICBoZWlnaHQ6IDcwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBkaXNwbGF5OiBub25lOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB6LWluZGV4OiAxMDA7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZjg4ODggMCUsICNjYzAwMDAgNDAlLCAjNjYwMDAwIDgwJSwgIzIyMDAwMCAxMDAlKTsKICAgIGJvcmRlcjogM3B4IHNvbGlkICNmZjQ0NDQ7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDI1NSwgNTAsIDUwLCAwLjYpLCBpbnNldCAwIDAgMTVweCByZ2JhKDI1NSwgMjAwLCAyMDAsIDAuMyk7CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4xcywgZmlsdGVyIDAuMnM7Cn0KCiN0YWNrbGUtYnV0dG9uOmFjdGl2ZSB7CiAgICB0cmFuc2Zvcm06IHNjYWxlKDAuOSk7CiAgICBmaWx0ZXI6IGJyaWdodG5lc3MoMS4yKTsKfQoKI3RhY2tsZS1idXR0b24uYWN0aXZlIHsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzUlIDM1JSwgI2ZmZmZmZiAwJSwgI2ZmNDQ0NCA0MCUsICNhYTAwMDAgODAlLCAjNDQwMDAwIDEwMCUpOwogICAgYm94LXNoYWRvdzogMCAwIDI1cHggcmdiYSgyNTUsIDEwMCwgMTAwLCAwLjkpOwp9CgojdGFja2xlLWJ1dHRvbiAuYnRuLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDFweCAycHggcmdiYSgwLDAsMCwwLjgpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKI3RhY2tsZS1idXR0b24gLmJ0bi1nbGFyZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01MCU7IGxlZnQ6IC01MCU7CiAgICB3aWR0aDogMjAwJTsgaGVpZ2h0OiAyMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDQ1ZGVnLCB0cmFuc3BhcmVudCA0MCUsIHJnYmEoMjU1LDI1NSwyNTUsMC4zKSA1MCUsIHRyYW5zcGFyZW50IDYwJSk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGFuaW1hdGlvbjogZ2xhcmVQYXNzIDRzIGluZmluaXRlOwp9CgojdGFja2xlLWJ1dHRvbi51cmdlbnQgewogICAgYW5pbWF0aW9uOiB1cmdlbnRQdWxzZSAwLjVzIGluZmluaXRlIGFsdGVybmF0ZTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzUlIDM1JSwgI2ZmNTU1NSAwJSwgI2ZmMDAwMCA0MCUsICM4ODAwMDAgMTAwJSk7CiAgICBib3JkZXItY29sb3I6ICNmZmFhYWE7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCAjZmYwMDAwOwp9CgpAa2V5ZnJhbWVzIHVyZ2VudFB1bHNlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjE1KTsgfQp9CgovKiAtLS0gQ0hBUkdFIFBPV0VSIE1FVEVSIC0tLSAqLwojY2hhcmdlLW1ldGVyLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCgyNTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pICsgMTAwcHgpOwogICAgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgd2lkdGg6IDIwMHB4OwogICAgZGlzcGxheTogbm9uZTsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAyMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAxMCwgMzAsIDAuOCk7CiAgICBwYWRkaW5nOiAxMHB4IDE1cHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjMpOwp9CgouY2hhcmdlLWxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKfQoKLmNoYXJnZS1tZXRlci10cmFjayB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTJweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC42KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBib3JkZXItcmFkaXVzOiA2cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgojY2hhcmdlLW1ldGVyLWZpbGwgewogICAgaGVpZ2h0OiAxMDAlOwogICAgd2lkdGg6IDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjMGFmLCAjMGYwKTsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4ICMwZjA7CiAgICB0cmFuc2l0aW9uOiB3aWR0aCAwLjA1cyBsaW5lYXIsIGJhY2tncm91bmQgMC4xczsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKfQoKLmNoYXJnZS1oaW50IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICBvcGFjaXR5OiAwLjg7CiAgICBhbmltYXRpb246IGJsaW5rIDAuNXMgaW5maW5pdGU7Cn0KCi8qIC0tLSBHT0FMIERJU1RBTkNFIElORElDQVRPUiAtLS0gKi8KI2dvYWwtZGlzdGFuY2UtY29udGFpbmVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDc1cHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDU1cHgpOwogICAgbGVmdDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtbGVmdCkpOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAxMDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMTAsIDMwLCAwLjcpIDAlLCB0cmFuc3BhcmVudCAxMDAlKTsKICAgIHBhZGRpbmc6IDVweCAxNXB4IDVweCAxMHB4OwogICAgYm9yZGVyLWxlZnQ6IDJweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7Cn0KCi5kaXN0YW5jZS1sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDhweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKfQoKI2dvYWwtZGlzdGFuY2UgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtZ29sZCk7Cn0KCi8qIC0tLSBTRVRUSU5HUyBCVVRUT04gLS0tICovCiNzZXR0aW5ncy1idXR0b24gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoMjQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDEwMHB4KTsKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgcGFkZGluZzogOHB4IDA7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiAjODg4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgyMCwgMjAsIDIwLCAwLjgpIDAlLCByZ2JhKDEwLCAxMCwgMTAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ0OwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgei1pbmRleDogMTAwOwp9Cgojc2V0dGluZ3MtYnV0dG9uOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoNDAsIDQwLCA0MCwgMC45KTsKICAgIGJvcmRlci1jb2xvcjogIzg4ODsKICAgIGNvbG9yOiAjZmZmOwp9CgovKiAtLS0gU0VUVElOR1MgUEFORUwgLS0tICovCiNzZXR0aW5ncy1wYW5lbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsKICAgIGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDI4MHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE2MGRlZywgcmdiYSgwLCAyMCwgNTAsIDAuOTgpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC45OSkgMTAwJSk7CiAgICBib3JkZXI6IDJweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiAxMHB4OwogICAgYm94LXNoYWRvdzogMCAwIDMwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC40KTsKICAgIHotaW5kZXg6IDM1MDA7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxMHB4KTsKfQoKLnNldHRpbmdzLWhlYWRlciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBhZGRpbmc6IDE1cHg7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgcmdiYSgxMDAsIDIwMCwgMjU1LCAwLjMpOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAzMCwgNjAsIDAuNSk7Cn0KCi5zZXR0aW5ncy1oZWFkZXIgc3BhbiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDIwcHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7CiAgICBsZXR0ZXItc3BhY2luZzogM3B4Owp9Cgojc2V0dGluZ3MtY2xvc2UgewogICAgd2lkdGg6IDMwcHg7CiAgICBoZWlnaHQ6IDMwcHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjZmY0NDQ0OwogICAgYmFja2dyb3VuZDogcmdiYSg1MCwgMCwgMCwgMC41KTsKICAgIGNvbG9yOiAjZmY0NDQ0OwogICAgZm9udC1zaXplOiAxNHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgYm9yZGVyLXJhZGl1czogNXB4OwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7Cn0KCiNzZXR0aW5ncy1jbG9zZTpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiAjZmY0NDQ0OwogICAgY29sb3I6IHdoaXRlOwp9Cgouc2V0dGluZ3MtY29udGVudCB7CiAgICBwYWRkaW5nOiAyMHB4Owp9Cgouc2V0dGluZy1yb3cgewogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgcGFkZGluZzogMTBweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC4zKTsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKfQoKLnNldHRpbmctcm93IGxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAxNHB4OwogICAgY29sb3I6ICNjY2M7Cn0KCi5zZXR0aW5nLXJvdyBpbnB1dFt0eXBlPSJyYW5nZSJdIHsKICAgIHdpZHRoOiAxMDBweDsKICAgIGFjY2VudC1jb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwp9Cgouc2V0dGluZy1yb3cgaW5wdXRbdHlwZT0iY2hlY2tib3giXSB7CiAgICB3aWR0aDogMjBweDsKICAgIGhlaWdodDogMjBweDsKICAgIGFjY2VudC1jb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgY3Vyc29yOiBwb2ludGVyOwp9CgovKiAtLS0gR0xBUkUgQU5JTUFUSU9OIC0tLSAqLwpAa2V5ZnJhbWVzIGdsYXJlUGFzcyB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtMTAwJSkgcm90YXRlKDQ1ZGVnKTsgfQogICAgMzAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDEwMCUpIHJvdGF0ZSg0NWRlZyk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMTAwJSkgcm90YXRlKDQ1ZGVnKTsgfQp9CgovKiAtLS0gU1RBVFVTIFRZUEUgRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtaW5uZXIuc3RhdHVzIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAyOHB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgY29sb3I6ICNmZjAwZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggI2ZmMDBmZiwgMnB4IDJweCAwICMwMDA7CiAgICBhbmltYXRpb246IHN0YXR1c1BvcCAxLjJzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgpAa2V5ZnJhbWVzIHN0YXR1c1BvcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC41KSB0cmFuc2xhdGVZKDApOyBvcGFjaXR5OiAwOyB9CiAgICAyMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMykgdHJhbnNsYXRlWSgtMTBweCk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCkgdHJhbnNsYXRlWSgtNDBweCk7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIEdPQUwgVFlQRSBGTE9BVElORyBURVhUIC0tLSAqLwouZmxvYXRpbmctdGV4dC1pbm5lci5nb2FsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiA0OHB4OwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmYgMCUsICNmZmQ3MDAgNTAlLCAjZmY4ODAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgNHB4IDRweCByZ2JhKDAsMCwwLDAuOSkpOwogICAgYW5pbWF0aW9uOiBnb2FsUG9wIDFzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KSBmb3J3YXJkczsKfQoKQGtleWZyYW1lcyBnb2FsUG9wIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwKSByb3RhdGUoLTEwZGVnKTsgb3BhY2l0eTogMDsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjUpIHJvdGF0ZSg1ZGVnKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4yKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIERFRkFVTFQgVFlQRSBGTE9BVElORyBURVhUIC0tLSAqLwouZmxvYXRpbmctdGV4dC1pbm5lci5kZWZhdWx0IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMnB4IDRweCByZ2JhKDAsMCwwLDAuOCk7CiAgICBhbmltYXRpb246IGZsb2F0VXAgMC44cyBlYXNlLW91dCBmb3J3YXJkczsKfQoKLyogLS0tIE1PQklMRSBQT1JUUkFJVCBPUFRJTUlaQVRJT05TIC0tLSAqLwpAbWVkaWEgc2NyZWVuIGFuZCAob3JpZW50YXRpb246IHBvcnRyYWl0KSBhbmQgKG1heC13aWR0aDogNjAwcHgpIHsKICAgIC50ZWFtLXdpbmcgeyB3aWR0aDogOTBweDsgcGFkZGluZzogMCA1cHg7IH0KICAgIC5zY29yZS1ib3ggeyBmb250LXNpemU6IDI0cHg7IG1hcmdpbjogMCA1cHg7IH0KICAgIC50ZWFtLW5hbWUgeyBmb250LXNpemU6IDEwcHg7IH0KICAgIC50ZWFtLXN1YiB7IGRpc3BsYXk6IG5vbmU7IH0KICAgIAogICAgLnRpbWVyLWNyeXN0YWwtcmluZyB7IHdpZHRoOiA4MHB4OyBoZWlnaHQ6IDQwcHg7IHRvcDogLTE1cHg7IH0KICAgICN0aW1lci1kaXNwbGF5IHsgZm9udC1zaXplOiAyOHB4OyB9CiAgICAKICAgICNtaW5pbWFwLWNvbnRhaW5lciB7IHdpZHRoOiA5MHB4OyBoZWlnaHQ6IDkwcHg7IH0KICAgICNtaW5pbWFwIHsgd2lkdGg6IDgwcHg7IGhlaWdodDogODBweDsgfQogICAgLnJhZGFyLWxhYmVsIHsgZm9udC1zaXplOiAxMHB4OyB9CiAgICAKICAgIC50ZWNoLXRleHQgeyBmb250LXNpemU6IDI0cHg7IH0KICAgIAogICAgI2FjdGlvbi1idXR0b24geyB3aWR0aDogODBweDsgaGVpZ2h0OiA4MHB4OyB9CiAgICAuY29tbWFuZC1yaW5nIHsgd2lkdGg6IDEwMHB4OyBoZWlnaHQ6IDEwMHB4OyB9CiAgICAjYWN0aW9uLWxhYmVsIHsgZm9udC1zaXplOiAxMHB4OyBwYWRkaW5nOiAycHggOHB4OyB9CiAgICAKICAgICNwbGF5ZXItc3RhdHVzLXBhbmVsIHsgd2lkdGg6IDEzMHB4OyBib3R0b206IG1heCgxNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pICsgMjBweCk7IH0KICAgIC5jaGFyLW5hbWUgeyBmb250LXNpemU6IDE0cHg7IH0KICAgIAogICAgI2F1dG8tdG9nZ2xlLCAjc2V0dGluZ3MtYnV0dG9uLCAjcHJhY3RpY2UtcmVzdG9yZS1idG4gewogICAgICAgIHdpZHRoOiA5MHB4OwogICAgICAgIGZvbnQtc2l6ZTogOXB4OwogICAgICAgIHJpZ2h0OiBtYXgoMTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgfQogICAgCiAgICAjZ29hbC1kaXN0YW5jZS1jb250YWluZXIgeyBsZWZ0OiBtYXgoMTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KSk7IH0KI2dvYWwtZGlzdGFuY2UgeyBmb250LXNpemU6IDE4cHg7IH0KfQoKLyogLS0tIEdFU1RVUkUgSElOVCAtLS0gKi8KI2dlc3R1cmUtaGludCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMjAwcHg7IGhlaWdodDogMzAwcHg7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAyNTAwOwogICAgb3BhY2l0eTogMC45Owp9CgojZ2VzdHVyZS1oaW50LmFjdGl2ZSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKfQoKLmN1cnZlLWFycm93IHsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDVweCAjMDBmZmZmKTsKICAgIGFuaW1hdGlvbjogZGFzaERyYXcgMS41cyBsaW5lYXIgaW5maW5pdGU7Cn0KCkBrZXlmcmFtZXMgZGFzaERyYXcgewogICAgdG8geyBzdHJva2UtZGFzaG9mZnNldDogLTMwOyB9Cn0KCi5nZXN0dXJlLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwogICAgbWFyZ2luLXRvcDogLTUwcHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoKLmdlc3R1cmUtaGFuZCB7CiAgICBmb250LXNpemU6IDQ4cHg7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDIwcHg7CiAgICBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICBhbmltYXRpb246IGhhbmRTd2lwZSAxLjVzIGVhc2UtaW4tb3V0IGluZmluaXRlOwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCBibGFjayk7Cn0KCkBrZXlmcmFtZXMgaGFuZFN3aXBlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgNTBweCkgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9CiAgICAyMCUgeyBvcGFjaXR5OiAxOyB9CiAgICA4MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgyMHB4LCAtMTAwcHgpIHJvdGF0ZSgyMGRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgwcHgsIC0xMjBweCkgcm90YXRlKDEwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgovKiAtLS0gU1dJUEUgVFJBSUwgKElOVFVJVElWRSBGRUVEQkFDSykgLS0tICovCi5zd2lwZS10cmFpbC1kb3QgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDEycHg7CiAgICBoZWlnaHQ6IDEycHg7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAjMDBmZmZmIDAlLCByZ2JhKDAsIDI1NSwgMjU1LCAwKSA3MCUpOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiA5MDAwOwogICAgYW5pbWF0aW9uOiBmYWRlVHJhaWwgMC41cyBsaW5lYXIgZm9yd2FyZHM7CiAgICBtaXgtYmxlbmQtbW9kZTogc2NyZWVuOwp9CgpAa2V5ZnJhbWVzIGZhZGVUcmFpbCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuMik7IG9wYWNpdHk6IDA7IH0KfQpAa2V5ZnJhbWVzIGZhZGVUcmFpbCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuMik7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIE9GRlNDUkVFTiBJTkRJQ0FUT1IgLS0tICovCiNvZmZzY3JlZW4taW5kaWNhdG9yIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiA0MHB4OyBoZWlnaHQ6IDQwcHg7CiAgICBtYXJnaW4tbGVmdDogLTIwcHg7IG1hcmdpbi10b3A6IC0yMHB4OwogICAgei1pbmRleDogMTUwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgZGlzcGxheTogbm9uZTsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDVweCAjMDAwKTsKfQoKI29mZnNjcmVlbi1pbmRpY2F0b3IgLmFycm93IHsKICAgIHdpZHRoOiAwOyBoZWlnaHQ6IDA7CiAgICBib3JkZXItbGVmdDogMTVweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGJvcmRlci1yaWdodDogMTVweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGJvcmRlci1ib3R0b206IDI1cHggc29saWQgIzAwZmYwMDsgLyogR3JlZW4gZm9yIHBsYXllciAqLwogICAgYW5pbWF0aW9uOiBwdWxzZUFycm93IDAuNXMgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgdHJhbnNmb3JtLW9yaWdpbjogY2VudGVyIGJvdHRvbTsKfQoKQGtleWZyYW1lcyBwdWxzZUFycm93IHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHNjYWxlKDEpOyBmaWx0ZXI6IGJyaWdodG5lc3MoMSk7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjIpOyBmaWx0ZXI6IGJyaWdodG5lc3MoMS41KTsgfQp9","/style.css":"data:text/css;base64,OnJvb3QgewogICAgLS1mZngtYmx1ZS1kZWVwOiAjMDIwNDA4OwogICAgLS1mZngtYmx1ZS1kYXJrOiAjMGExNTI1OwogICAgLS1mZngtYmx1ZS1taWQ6ICMxNTJhNDU7CiAgICAtLWZmeC1ibHVlLWxpZ2h0OiAjMmE0ZDc1OwogICAgLS1mZngtY3lhbjogIzYwYzBkMDsKICAgIC0tZmZ4LWN5YW4tZ2xvdzogIzAwZmZmZjsKICAgIC0tZmZ4LWdvbGQ6ICNjOGIwNjA7CiAgICAtLWZmeC1nb2xkLWxpZ2h0OiAjZjBlMDkwOwogICAgLS1mZngtZ29sZC1kYXJrOiAjOGE3MDMwOwogICAgLS1mZngtZ2xhc3MtYmc6IHJnYmEoMTAsIDIwLCA0MCwgMC43NSk7CiAgICAtLWZmeC1nbGFzcy1ib3JkZXI6IHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIAogICAgLS1mb250LXRpdGxlOiAnR2FyYW1vbmQnLCAnVGltZXMgTmV3IFJvbWFuJywgc2VyaWY7CiAgICAtLWZvbnQtZGF0YTogJ0ltcGFjdCcsICdBcmlhbCBOYXJyb3cnLCBzYW5zLXNlcmlmOwogICAgLS1mb250LXVpOiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAtLWZvbnQtc3BpcmE6ICdTcGlyYScsICdJbXBhY3QnLCBzYW5zLXNlcmlmOwp9CgpAZm9udC1mYWNlIHsKICAgIGZvbnQtZmFtaWx5OiAnU3BpcmEnOwogICAgc3JjOiB1cmwoJ2h0dHBzOi8vZmlsZXMuY2F0Ym94Lm1vZS96eW43czMudHRmJykgZm9ybWF0KCd0cnVldHlwZScpOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgIGZvbnQtc3R5bGU6IG5vcm1hbDsKfQoKaHRtbCwgYm9keSB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB3aWR0aDogMTAwdnc7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBwb3NpdGlvbjogZml4ZWQ7IAogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHJpZ2h0OiAwOwogICAgYm90dG9tOiAwOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBjb2xvcjogd2hpdGU7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICBwYWRkaW5nLXRvcDogZW52KHNhZmUtYXJlYS1pbnNldC10b3ApOwogICAgcGFkZGluZy1ib3R0b206IGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKTsKICAgIHBhZGRpbmctbGVmdDogZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KTsKICAgIHBhZGRpbmctcmlnaHQ6IGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpOwp9CgoqIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7Cn0KCi8qIC0tLSBNQUlOIEdBTUUgQ09OVEFJTkVSIC0tLSAqLwojZ2FtZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgbWF4LXdpZHRoOiBub25lOwogICAgYmFja2dyb3VuZDogIzAwMDUxMDsKICAgIGJveC1zaGFkb3c6IG5vbmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgdHJhbnNpdGlvbjogZmlsdGVyIDAuMDVzOwogICAgei1pbmRleDogMTsKfQoKLyogLS0tIElNUEFDVCBGWCAtLS0gKi8KI2dhbWUtY29udGFpbmVyLmltcGFjdC1meCB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuMXMgZWFzZS1pbi1vdXQ7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDEuMikgYnJpZ2h0bmVzcygxLjEpOwp9CgojZ2FtZS1jb250YWluZXIuaW1wYWN0LWhlYXZ5IHsKICAgIGFuaW1hdGlvbjogaW1wYWN0U2hha2UgMC4ycyBlYXNlLWluLW91dDsKICAgIGZpbHRlcjogY29udHJhc3QoMS41KSBicmlnaHRuZXNzKDEuMykgc2VwaWEoMC40KSBodWUtcm90YXRlKC0xMGRlZyk7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3Qtc2hhdHRlciB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuNHMgZWFzZS1pbi1vdXQ7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDIuMCkgaW52ZXJ0KDAuMSkgc2F0dXJhdGUoMi4wKTsKfQoKQGtleWZyYW1lcyBpbXBhY3RTaGFrZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDAsIDApOyB9CiAgICAyNSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNXB4LCA1cHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSg1cHgsIC01cHgpOyB9CiAgICA3NSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNXB4LCAtNXB4KTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDAsIDApOyB9Cn0KCi8qIC0tLSBDQU5WQVMgJiBSRU5ERVIgLS0tICovCmNhbnZhcyB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsKICAgIGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGltYWdlLXJlbmRlcmluZzogcGl4ZWxhdGVkOyAKICAgIHotaW5kZXg6IDA7Cn0KCi8qIC0tLSBHSUYgT1ZFUkxBWSAtLS0gKi8KI3NjcmVlbi1vdmVybGF5LWdpZiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgb2JqZWN0LWZpdDogY292ZXI7CiAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKICAgIG9wYWNpdHk6IDEuMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogOTUwOwogICAgaW1hZ2UtcmVuZGVyaW5nOiBwaXhlbGF0ZWQ7Cn0KCiN1aS1sYXllciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgei1pbmRleDogMTAwMDsKfQoKLyogLS0tIENJTkVNQVRJQyBCQVJTIC0tLSAqLwojY2luZW1hdGljLWJhcnMgLmJhciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAwOwogICAgYmFja2dyb3VuZDogYmxhY2s7CiAgICB0cmFuc2l0aW9uOiBoZWlnaHQgMC41cyBlYXNlOwogICAgei1pbmRleDogODAwOwp9CiNjaW5lbWF0aWMtYmFycyAuYmFyLnRvcCB7IHRvcDogMDsgfQojY2luZW1hdGljLWJhcnMgLmJhci5ib3R0b20geyBib3R0b206IDA7IH0KCi8qIC0tLSBURUNIIEZMQVNIIE9WRVJMQVkgLS0tICovCiN0ZWNoLWZsYXNoLW92ZXJsYXkgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAyMCU7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEyMHB4OwogICAgZGlzcGxheTogbm9uZTsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwwLDAsMCkgMCUsIHJnYmEoMCwgMjAsIDYwLCAwLjkpIDIwJSwgcmdiYSgwLCAyMCwgNjAsIDAuOSkgODAlLCByZ2JhKDAsMCwwLDApIDEwMCUpOwogICAgei1pbmRleDogMjIwMDsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigycHgpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMTAwLCAyNTUsIDI1NSwgMC4zKTsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDEwMCwgMjU1LCAyNTUsIDAuMyk7CiAgICBhbmltYXRpb246IGZsYXNoRW50ZXIgMC4xNXMgZWFzZS1vdXQ7Cn0KCkBrZXlmcmFtZXMgZmxhc2hFbnRlciB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiBzY2FsZVkoMCk7IG9wYWNpdHk6IDA7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZVkoMSk7IG9wYWNpdHk6IDE7IH0KfQoKLnRlY2gtY29udGVudC13cmFwcGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goLTEwZGVnKTsKfQoKLnRlY2gtdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IGNsYW1wKDI4cHgsIDEwdncsIDQycHgpOwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZiwgMCAwIDIwcHggIzAwMDBmZjsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7CiAgICBtYXJnaW4tYm90dG9tOiAycHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBhbmltYXRpb246IGJsaW5rVGV4dCAwLjA4cyBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCi50ZWNoLXN1Yi10ZXh0IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjMDBmZmZmOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjUpOwp9CgoudGVjaC10aW1lci10cmFjayB7CiAgICB3aWR0aDogMjUwcHg7CiAgICBoZWlnaHQ6IDhweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC42KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggcmdiYSgwLDAsMCwwLjUpOwp9CgoudGVjaC10aW1lci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmZmZiwgIzAwZmZmZik7CiAgICB3aWR0aDogMTAwJTsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGxlZnQ7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwp9CgpAa2V5ZnJhbWVzIGJsaW5rVGV4dCB7CiAgICBmcm9tIHsgb3BhY2l0eTogMC44OyB0ZXh0LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOyB0cmFuc2Zvcm06IHNjYWxlKDEpOyB9CiAgICB0byB7IG9wYWNpdHk6IDEuMDsgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICNmZmZmZmYsIDAgMCAxMHB4ICMwMGZmZmY7IHRyYW5zZm9ybTogc2NhbGUoMS4wMik7IH0KfQoKLyogLS0tIEhVRCBUT1AgLS0tICovCi8qIC0tLSBIVUQgVE9QIC0tLSAqLwojaHVkLXRvcCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7CiAgICBsZWZ0OiAwOwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIGFsaWduLWl0ZW1zOiBmbGV4LXN0YXJ0OwogICAgd2lkdGg6IDEwMCU7CiAgICBwYWRkaW5nOiAxNXB4OwogICAgcGFkZGluZy10b3A6IG1heCgxNXB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkpOwogICAgcGFkZGluZy1sZWZ0OiBtYXgoMTVweCwgZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KSk7CiAgICBwYWRkaW5nLXJpZ2h0OiBtYXgoMTVweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sIHJnYmEoMCwgNSwgMTUsIDAuOSkgMCUsIHJnYmEoMCwwLDAsMCkgMTAwJSk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC41czsKfQoKLnRlYW0td2luZyB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHdpZHRoOiAxNDBweDsKICAgIGhlaWdodDogNTVweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHJnYmEoMjAsIDQwLCA4MCwgMC45KSAwJSwgcmdiYSg1LCAxMCwgMjAsIDAuOTUpIDEwMCUpOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgxMDAsIDIwMCwgMjU1LCAwLjMpOwogICAgYm9yZGVyLXRvcDogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIHRyYW5zZm9ybTogc2tld1goLTE1ZGVnKTsKICAgIGJveC1zaGFkb3c6IDAgNXB4IDE1cHggcmdiYSgwLCAwLCAwLCAwLjUpLCBpbnNldCAwIDAgMjBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjEpOwogICAgcGFkZGluZzogMCAxNXB4OwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7Cn0KCi50ZWFtLXdpbmc6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgcmdiYSgyNTUsMjU1LDI1NSwwLjEpLCB0cmFuc3BhcmVudCk7CiAgICBhbmltYXRpb246IHdpbmdTaGltbWVyIDRzIGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIHdpbmdTaGltbWVyIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0xMDAlKTsgfQogICAgMjAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDEwMCUpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDEwMCUpOyB9Cn0KCi50ZWFtLXdpbmcuYXdheSB7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDE1ZGVnKTsKICAgIGZsZXgtZGlyZWN0aW9uOiByb3ctcmV2ZXJzZTsKICAgIGJvcmRlci10b3AtY29sb3I6ICNmZjY2NjY7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoLTE2MGRlZywgcmdiYSg2MCwgMjAsIDIwLCAwLjkpIDAlLCByZ2JhKDIwLCA1LCA1LCAwLjk1KSAxMDAlKTsKfQoKLnRlYW0tZGF0YSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZyk7CiAgICBmbGV4LWdyb3c6IDE7Cn0KLnRlYW0td2luZy5hd2F5IC50ZWFtLWRhdGEgeyB0cmFuc2Zvcm06IHNrZXdYKC0xNWRlZyk7IHRleHQtYWxpZ246IHJpZ2h0OyB9CgoudGVhbS1uYW1lIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMTZweDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCByZ2JhKDAsIDE1MCwgMjU1LCAwLjgpOwp9Ci50ZWFtLXN1YiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBvcGFjaXR5OiAwLjg7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4Owp9Ci50ZWFtLXdpbmcuYXdheSAudGVhbS1zdWIgeyBjb2xvcjogI2ZmYWFhYTsgfQoKLnNjb3JlLWJveCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDAgMTVweCB2YXIoLS1mZngtY3lhbi1nbG93KTsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpOwogICAgbWFyZ2luOiAwIDVweDsKICAgIG1pbi13aWR0aDogMzBweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoudGVhbS13aW5nLmF3YXkgLnNjb3JlLWJveCB7IHRyYW5zZm9ybTogc2tld1goLTE1ZGVnKTsgdGV4dC1zaGFkb3c6IDAgMCAxNXB4ICNmZjQ0NDQ7IH0KCi50aW1lci1jb21wbGV4IHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG1hcmdpbi10b3A6IC01cHg7Cn0KCi50aW1lci1jcnlzdGFsLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtMzBweDsKICAgIHdpZHRoOiAxNDBweDsKICAgIGhlaWdodDogNzBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlci10b3A6IDNweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBib3gtc2hhZG93OiAwIC01cHggMjBweCByZ2JhKDIwMCwgMTgwLCAxMDAsIDAuNCksIGluc2V0IDAgMTBweCAyMHB4IHJnYmEoMCwwLDAsMC41KTsKICAgIHotaW5kZXg6IC0xOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGVsbGlwc2UgYXQgdG9wLCByZ2JhKDIwLCA0MCwgODAsIDAuOSksIHRyYW5zcGFyZW50IDcwJSk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNHB4KTsKfQoKI2hhbGYtaW5kaWNhdG9yIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogNHB4OwogICAgbWFyZ2luLWJvdHRvbTogLTRweDsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1nb2xkLWRhcmspOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKfQoKI3RpbWVyLWRpc3BsYXkgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQ4cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmIDAlLCAjZmZkNzAwIDUwJSwgI2I4ODYwYiAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDJweCAwcHggcmdiYSgwLDAsMCwwLjgpKTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7Cn0KLyogLS0tIFBMQVlFUiBTVEFUVVMgUEFORUwgLS0tICovCiNwbGF5ZXItc3RhdHVzLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyA0MHB4KTsKICAgIGxlZnQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQpKTsKICAgIHdpZHRoOiAxNjBweDsKICAgIHBhZGRpbmc6IDEwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMTAsIDMwLCAwLjgpIDAlLCByZ2JhKDAsMCwwLDApIDEwMCUpOwogICAgYm9yZGVyLWxlZnQ6IDNweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiAwIDEwcHggMTBweCAwOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7Cn0KCi5jaGFyLW5hbWUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAxOHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKICAgIHRyYW5zZm9ybTogc2tld1goMTBkZWcpOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwp9CgouaHAtZ2F1Z2UtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgbWFyZ2luLWJvdHRvbTogNHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7Cn0KLmhwLWxhYmVsIHsgZm9udC1zaXplOiAxMHB4OyBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOyB3aWR0aDogMjBweDsgfQouaHAtYmFyLXRyYWNrIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGhlaWdodDogNnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIG1hcmdpbjogMCA1cHg7Cn0KLmhwLWJhci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgIzAwZmYwMCwgI2NjZmZjYyk7CiAgICBib3gtc2hhZG93OiAwIDAgNXB4ICMwMGZmMDA7Cn0KLmhwLXZhbHVlIHsgZm9udC1zaXplOiAxMHB4OyBjb2xvcjogI2ZmZjsgd2lkdGg6IDQ1cHg7IHRleHQtYWxpZ246IHJpZ2h0OyB9CgoudGVjaC1nYXVnZS1jb250YWluZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDEwZGVnKTsKfQoudGVjaC1sYWJlbCB7IGZvbnQtc2l6ZTogMTBweDsgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsgd2lkdGg6IDIwcHg7IH0KLnRlY2gtYmFyLXRyYWNrIHsKICAgIGZsZXgtZ3JvdzogMTsKICAgIGhlaWdodDogNHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIG1hcmdpbjogMCA1cHg7Cn0KLnRlY2gtYmFyLWZpbGwgewogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjZmZhYTAwLCAjZmZmZmFhKTsKfQoKLyogLS0tIE1JTklNQVAgLS0tICovCiNtaW5pbWFwLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg4MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA2MHB4KTsKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgaGVpZ2h0OiAxMTBweDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7Cn0KCi5yYWRhci1yaW0gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHZhcigtLWZmeC1ibHVlLWxpZ2h0KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHZhcigtLWZmeC1ibHVlLW1pZCksIGluc2V0IDAgMCAyMHB4IHJnYmEoMCwwLDAsMC44KTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMCwgMjAsIDYwLCAwLjQpIDAlLCByZ2JhKDAsIDUsIDEwLCAwLjgpIDEwMCUpOwogICAgei1pbmRleDogNTsKfQoKI21pbmltYXAgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgd2lkdGg6IDEwMHB4OwogICAgaGVpZ2h0OiAxMDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHotaW5kZXg6IDY7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgoucmFkYXItbGFiZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAtMTVweDsKICAgIHdpZHRoOiAxNDAlOwogICAgbGVmdDogLTIwJTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggdmFyKC0tZmZ4LWN5YW4pOwp9CgoubWFwLWRvdCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB3aWR0aDogNnB4OyBoZWlnaHQ6IDZweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgYm94LXNoYWRvdzogMCAwIDRweCBjdXJyZW50Q29sb3I7Cn0KLm1hcC1kb3QuaG9tZSB7IGJhY2tncm91bmQ6IHZhcigtLWZmeC1jeWFuKTsgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsgfQoubWFwLWRvdC5hd2F5IHsgYmFja2dyb3VuZDogI2ZmNDQ0NDsgY29sb3I6ICNmZjQ0NDQ7IH0KLm1hcC1kb3QuYmFsbCB7IAogICAgYmFja2dyb3VuZDogI2ZmMDBjYzsKICAgIGNvbG9yOiAjZmYwMGNjOyAKICAgIHdpZHRoOiAxMnB4OyBoZWlnaHQ6IDEycHg7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjZmZmZmZmOwogICAgei1pbmRleDogMjA7CiAgICBhbmltYXRpb246IGJsaW5rQmFsbCAwLjNzIGluZmluaXRlIGFsdGVybmF0ZTsKICAgIGJveC1zaGFkb3c6IDAgMCA2cHggI2ZmMDBjYzsKfQoubWFwLWRvdC5uYXAgeyBiYWNrZ3JvdW5kOiAjMzMzOyBjb2xvcjogIzAwMDsgYm9yZGVyOiAxcHggc29saWQgIzU1NTsgfQoubWFwLWRvdC5hY3RpdmUtcGxheWVyIHsgCiAgICBiYWNrZ3JvdW5kOiAjMDBmZjAwICFpbXBvcnRhbnQ7IAogICAgY29sb3I6ICMwMGZmMDAgIWltcG9ydGFudDsgCiAgICBib3gtc2hhZG93OiAwIDAgOHB4ICMwMGZmMDA7CiAgICB6LWluZGV4OiAxNTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuMik7Cn0KLm1hcC1kb3QuYmFsbC1jYXJyaWVyIHsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4ICNmZmYsIDAgMCAzMHB4ICNmZmFhMDA7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjZmZmZmZmOwogICAgYmFja2dyb3VuZC1jb2xvcjogI2ZmYWEwMCAhaW1wb3J0YW50OwogICAgei1pbmRleDogMTAwOwogICAgd2lkdGg6IDEwcHg7IGhlaWdodDogMTBweDsKICAgIGFuaW1hdGlvbjogY2FycmllclB1bHNlIDAuOHMgaW5maW5pdGUgYWx0ZXJuYXRlOwp9CkBrZXlmcmFtZXMgY2FycmllclB1bHNlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjIpOyBib3gtc2hhZG93OiAwIDAgMTBweCAjZmZmOyBvcGFjaXR5OiAwLjg7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS44KTsgYm94LXNoYWRvdzogMCAwIDI1cHggI2ZmY2MwMDsgb3BhY2l0eTogMS4wOyB9Cn0KQGtleWZyYW1lcyBibGlua0JhbGwgeyBmcm9tIHsgb3BhY2l0eTogMTsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IH0gdG8geyBvcGFjaXR5OiAwLjU7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuMyk7IH0gfQoKLyogLS0tIEFOTk9VTkNFTUVOVFMgLS0tICovCiNhbm5vdW5jZW1lbnQgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA0MCU7IAogICAgbGVmdDogNSU7IAogICAgd2lkdGg6IDkwJTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiBjbGFtcCg0MHB4LCAxMnZ3LCA3MnB4KTsKICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7CiAgICB3aGl0ZS1zcGFjZTogbm9ybWFsOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZiAwJSwgI2ZmZDcwMCA0MCUsICNiODg2MGIgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggcmdiYSgyNTUsIDEwMCwgMCwgMC41KSkgZHJvcC1zaGFkb3coM3B4IDNweCAwICMwMDApOwogICAgZGlzcGxheTogbm9uZTsKICAgIHotaW5kZXg6IDIwMDA7CiAgICBhbmltYXRpb246IGFubm91bmNlU2xpZGUgMC41cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKQGtleWZyYW1lcyBhbm5vdW5jZVNsaWRlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHNjYWxlKDApIHJvdGF0ZSgtNWRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZSgxKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDE7IH0KfQoKLyogLS0tIEpPWVNUSUNLIC0tLSAqLwojam95c3RpY2staGl0LXpvbmUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDUwJTsgaGVpZ2h0OiA1MCU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwKTsgCiAgICB0b3VjaC1hY3Rpb246IG5vbmU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKfQoKI2pveXN0aWNrLXZpc3VhbC1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDA7IGhlaWdodDogMDsKICAgIG92ZXJmbG93OiB2aXNpYmxlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMTEwMDsKfQoKI2pveXN0aWNrLWJhc2UgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDEyMHB4OyBoZWlnaHQ6IDEyMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgwLCA0MCwgODAsIDAuNCkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjEpIDYwJSwgdHJhbnNwYXJlbnQgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDEwMCwgMjIwLCAyNTUsIDAuMyk7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpLCBpbnNldCAwIDAgMzBweCByZ2JhKDAsIDUwLCAxMDAsIDAuMyk7CiAgICBhbmltYXRpb246IGJhc2VQdWxzZSAycyBpbmZpbml0ZSBhbHRlcm5hdGU7Cn0KCkBrZXlmcmFtZXMgYmFzZVB1bHNlIHsKICAgIGZyb20geyBib3gtc2hhZG93OiAwIDAgMTBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpOyBib3JkZXItY29sb3I6IHJnYmEoMTAwLCAyMjAsIDI1NSwgMC4yKTsgfQogICAgdG8geyBib3gtc2hhZG93OiAwIDAgMjVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjUpOyBib3JkZXItY29sb3I6IHJnYmEoMTAwLCAyNTUsIDI1NSwgMC42KTsgfQp9Cgojam95c3RpY2sta25vYiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogNTBweDsgaGVpZ2h0OiA1MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzMCUgMzAlLCAjZTBmZmZmIDAlLCAjMDBhYWZmIDQwJSwgIzAwNDQ4OCA4MCUsICMwMDExMjIgMTAwJSk7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjODhjY2ZmOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggIzAwZmZmZiwgaW5zZXQgMCAwIDEwcHggcmdiYSgyNTUsMjU1LDI1NSwwLjgpOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMDVzIGxpbmVhcjsKfQoKI2pveXN0aWNrLWtub2I6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICIiOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAyMCU7IGxlZnQ6IDIwJTsgd2lkdGg6IDIwJTsgaGVpZ2h0OiAyMCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAjZmZmZmZmIDAlLCB0cmFuc3BhcmVudCA3MCUpOwogICAgZmlsdGVyOiBibHVyKDJweCk7CiAgICBvcGFjaXR5OiAwLjg7Cn0KCi50b3VjaC1yaXBwbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgyMDAsIDI1NSwgMjU1LCAwLjgpIDAlLCByZ2JhKDAsIDI1NSwgMjU1LCAwLjQpIDQwJSwgdHJhbnNwYXJlbnQgNzAlKTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDApOwogICAgYW5pbWF0aW9uOiByaXBwbGVBbmltIDAuNnMgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDkwMDA7CiAgICBtaXgtYmxlbmQtbW9kZTogc2NyZWVuOwp9CgpAa2V5ZnJhbWVzIHJpcHBsZUFuaW0gewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgwKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDMuMCk7IG9wYWNpdHk6IDA7IH0KfQoKI2NhbWVyYS16b25lIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgcmlnaHQ6IDA7IHdpZHRoOiA1MCU7IGhlaWdodDogMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdG91Y2gtYWN0aW9uOiBub25lOwogICAgei1pbmRleDogNTA7Cn0KCi8qIC0tLSBBQ1RJT04gQlVUVE9OIC0tLSAqLwojYWN0aW9uLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCg0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOyAKICAgIHJpZ2h0OiBtYXgoNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB6LWluZGV4OiAxMDA7Cn0KCi5jb21tYW5kLW1lbnUtYmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDE4MHB4OyBoZWlnaHQ6IDgwcHg7CiAgICBib3R0b206IDE1cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHRyYW5zcGFyZW50IDAlLCByZ2JhKDAsIDEwLCAzMCwgMC44KSA1MCUsIHRyYW5zcGFyZW50IDEwMCUpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMCwgMjAwLCAyNTUsIDAuMyk7CiAgICB6LWluZGV4OiAtMTsKfQoKLmNvbW1hbmQtcmluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMTMwcHg7IGhlaWdodDogMTMwcHg7CiAgICBib3JkZXI6IDJweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7CiAgICBib3JkZXItdG9wOiAycHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC42KTsKICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCByZ2JhKDAsIDI1NSwgMjU1LCAwLjYpOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYW5pbWF0aW9uOiBzcGluUmV2ZXJzZSAxNXMgbGluZWFyIGluZmluaXRlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpOwp9CkBrZXlmcmFtZXMgc3BpblJldmVyc2UgeyBmcm9tIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgcm90YXRlKDM2MGRlZyk7IH0gdG8geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSByb3RhdGUoMGRlZyk7IH0gfQoKI2FjdGlvbi1sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCA1LCAxMCwgMC44KTsKICAgIHBhZGRpbmc6IDRweCAxMnB4OwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwogICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMCwwLDAsMC44KTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjNzOwp9CgojYWN0aW9uLWJ1dHRvbiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwcHg7IGhlaWdodDogMTAwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4xcywgZmlsdGVyIDAuM3M7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZmZmZmYgMCUsICMwMDg4ZmYgNDAlLCAjMDAyMjY2IDgwJSwgIzAwMCAxMDAlKTsKICAgIGJvcmRlcjogM3B4IHNvbGlkICM0NGFhZmY7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjgpLCBpbnNldCAwIDAgMjBweCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNCk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICB6LWluZGV4OiAxMDsKfQoKI3Bhc3MtYnV0dG9uIHsKICAgIGRpc3BsYXk6IG5vbmUgIWltcG9ydGFudDsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogLTIwcHg7IGxlZnQ6IC0zMHB4OwogICAgd2lkdGg6IDYwcHg7IGhlaWdodDogNjBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHotaW5kZXg6IDk7Cn0KCiNhY3Rpb24tYnV0dG9uOjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC00MHB4OyBsZWZ0OiAtNDBweDsgcmlnaHQ6IC00MHB4OyBib3R0b206IC00MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgei1pbmRleDogMTA7Cn0KCiNhY3Rpb24tYnV0dG9uOmFjdGl2ZSB7IHRyYW5zZm9ybTogc2NhbGUoMC45Mik7IH0KCiNhY3Rpb24tYnV0dG9uIC5idG4tdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDIycHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDJweCA0cHggcmdiYSgwLDAsMCwwLjgpLCAwIDAgMTBweCByZ2JhKDI1NSwyNTUsMjU1LDAuNSk7CiAgICB6LWluZGV4OiA1OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgojYWN0aW9uLWJ1dHRvbiAuYnRuLWdsYXJlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwJTsgbGVmdDogLTUwJTsgd2lkdGg6IDIwMCU7IGhlaWdodDogMjAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg0NWRlZywgdHJhbnNwYXJlbnQgNDAlLCByZ2JhKDI1NSwyNTUsMjU1LDAuNCkgNTAlLCB0cmFuc3BhcmVudCA2MCUpOwogICAgYW5pbWF0aW9uOiBnbGFyZVBhc3MgNXMgaW5maW5pdGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDY7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7Cn0KCi5saW1pdC1yaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTVweDsgbGVmdDogLTVweDsgcmlnaHQ6IC01cHg7IGJvdHRvbTogLTVweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHRyYW5zcGFyZW50OwogICAgYm94LXNoYWRvdzogMCAwIDAgdHJhbnNwYXJlbnQ7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC41czsKICAgIHotaW5kZXg6IDE7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKfQoKI2FjdGlvbi1idXR0b24uc2hvb3QtbW9kZSB7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZmZmYWEgMCUsICNmZmFhMDAgNDAlLCAjODgyMjAwIDgwJSwgIzIyMDAwMCAxMDAlKTsKICAgIGJvcmRlci1jb2xvcjogI2ZmY2MwMDsKICAgIGJveC1zaGFkb3c6IDAgMCAzMHB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuOCksIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCAyNTUsIDAsIDAuNSk7Cn0KCiNhY3Rpb24tYnV0dG9uLmxpbWl0LXJlYWR5IC5saW1pdC1yaW5nIHsKICAgIGJvcmRlci1jb2xvcjogI2ZmZGQ0NDsKICAgIGFuaW1hdGlvbjogbGltaXRQdWxzZSAwLjhzIGVhc2UtaW4tb3V0IGluZmluaXRlIGFsdGVybmF0ZTsKfQoKLnNob290LWxhYmVsIHsKICAgIGNvbG9yOiAjZmZkZDQ0ICFpbXBvcnRhbnQ7CiAgICBib3JkZXItY29sb3I6ICNmZmFhMDAgIWltcG9ydGFudDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmY0NDAwICFpbXBvcnRhbnQ7Cn0KCkBrZXlmcmFtZXMgbGltaXRQdWxzZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgYm94LXNoYWRvdzogMCAwIDEwcHggI2ZmYWEwMCwgaW5zZXQgMCAwIDVweCAjZmZhYTAwOyBvcGFjaXR5OiAwLjU7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMTUpOyBib3gtc2hhZG93OiAwIDAgMzBweCAjZmY0NDAwLCBpbnNldCAwIDAgMTVweCAjZmYwMDAwOyBvcGFjaXR5OiAxLjA7IH0KfQoKLyogLS0tIEFVVE8gVE9HR0xFIC0tLSAqLwojYXV0by10b2dnbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoMjAwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDYwcHgpOyAKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgcGFkZGluZzogMTBweCAwOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgwLCAyMCwgNDAsIDAuOCkgMCUsIHJnYmEoMCwgNSwgMTAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3JkZXItdG9wOiAxcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNHB4KTsKICAgIGJveC1zaGFkb3c6IDAgNXB4IDE1cHggcmdiYSgwLDAsMCwwLjMpOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIHotaW5kZXg6IDEwMDsKfQoKI2F1dG8tdG9nZ2xlOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjkpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggdmFyKC0tZmZ4LWN5YW4pOwogICAgY29sb3I6IHdoaXRlOwp9CgojYXV0by10b2dnbGUuYWN0aXZlIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMTAwLCAyMCwgMCwgMC44KSAwJSwgcmdiYSg0MCwgMCwgMCwgMC45KSAxMDAlKTsKICAgIGJvcmRlci1jb2xvcjogI2ZmNDQwMDsKICAgIGNvbG9yOiAjZmZhYTAwOwogICAgYW5pbWF0aW9uOiBwdWxzZVJlZCAycyBpbmZpbml0ZTsKfQpAa2V5ZnJhbWVzIHB1bHNlUmVkIHsgMCUgeyBib3gtc2hhZG93OiAwIDAgNXB4ICNmZjAwMDA7IH0gNTAlIHsgYm94LXNoYWRvdzogMCAwIDIwcHggI2ZmNDQwMDsgfSAxMDAlIHsgYm94LXNoYWRvdzogMCAwIDVweCAjZmYwMDAwOyB9IH0KCi8qIC0tLSBGTE9BVElORyBURVhUIC0tLSAqLwouZmxvYXRpbmctdGV4dC13cmFwcGVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogMjAwMDsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm07Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyIHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDI0cHg7IAogICAgdGV4dC1zaGFkb3c6IDFweCAxcHggMCAjMDAwOwogICAgb3BhY2l0eTogMC45Owp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5kYW1hZ2UgewogICAgZm9udC1zaXplOiA0MnB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZmZmZiAwJSwgI2ZmY2MwMCA0MCUsICNmZjQ0MDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCA0cHggNHB4IHJnYmEoMCwwLDAsMC44KSk7CiAgICBhbmltYXRpb246IHBvcERhbWFnZSAwLjhzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KSBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuaGVhbCB7CiAgICBmb250LXNpemU6IDM2cHg7CiAgICBjb2xvcjogIzQ0ZmY0NDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZjAwOwogICAgYW5pbWF0aW9uOiBmbG9hdFVwIDFzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci52ZW5vbSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGNvbG9yOiAjYWFmZjAwOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICM0NDg4MDAsIDJweCAycHggMCAjMDAyMjAwOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2NjZmY2NiAwJSwgIzY2Y2MwMCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgNXB4IHJnYmEoMTAwLCAyNTUsIDAsIDAuNSkpOwogICAgYW5pbWF0aW9uOiBkcmlwU3RhdHVzIDJzIGluZmluaXRlOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5zbGVlcCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTVweCAjMDA0NGZmLCAwIDAgMzBweCAjMDAwMGZmOwogICAgb3BhY2l0eTogMC45OwogICAgYW5pbWF0aW9uOiBkcmlmdFN0YXR1cyAzcyBlYXNlLWluLW91dCBpbmZpbml0ZTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIud2l0aGVyIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAzOHB4OwogICAgY29sb3I6ICNjY2NjY2M7CiAgICB0ZXh0LXNoYWRvdzogMnB4IDJweCAwICM0NDQ0NDQ7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZWVlZWVlIDAlLCAjODg4ODg4IDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHdpdGhlclN0YXR1cyAxLjVzIGZvcndhcmRzOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci50ZWNoIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMzJweDsKICAgIGNvbG9yOiAjMDBmZmZmOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAxMCwgMzAsIDAuNyk7CiAgICBwYWRkaW5nOiAycHggMTBweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkICMwMGZmZmY7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjMDA4OGZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggI2ZmZjsKICAgIGFuaW1hdGlvbjogc2hha2VUZWNoIDAuNnMgZWFzZS1pbi1vdXQsIGZsYXNoVGVjaCAwLjNzOwogICAgdHJhbnNmb3JtLW9yaWdpbjogY2VudGVyOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5zYXZlLCAuZmxvYXRpbmctdGV4dC1pbm5lci5ibG9jayB7CiAgICBmb250LXNpemU6IDQ4cHg7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgY29sb3I6ICNmZmZmZmY7CiAgICAtd2Via2l0LXRleHQtc3Ryb2tlOiAxcHggIzAwNDQ4ODsKICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCAjMDA4OGZmOwogICAgYW5pbWF0aW9uOiBwb3BEYW1hZ2UgMC41cyBlYXNlLW91dCBmb3J3YXJkczsKfQoKQGtleWZyYW1lcyBwb3BEYW1hZ2UgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuNSk7IG9wYWNpdHk6IDA7IH0KICAgIDIwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS41KTsgb3BhY2l0eTogMTsgfQogICAgNDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgZmxvYXRVcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNTBweCk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyBkcmlwU3RhdHVzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZVkoMSk7IGZpbHRlcjogYmx1cigwcHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlWSgxLjEpIHRyYW5zbGF0ZVkoNXB4KTsgZmlsdGVyOiBibHVyKDFweCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlWSgxKTsgZmlsdGVyOiBibHVyKDBweCk7IH0KfQoKQGtleWZyYW1lcyBkcmlmdFN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIDIwJSB7IG9wYWNpdHk6IDE7IH0KICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxNXB4KSB0cmFuc2xhdGVZKC0yMHB4KSByb3RhdGUoMTBkZWcpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0xNXB4KSB0cmFuc2xhdGVZKC01MHB4KSByb3RhdGUoLTEwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIHdpdGhlclN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IGZpbHRlcjogZ3JheXNjYWxlKDAlKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC42KTsgZmlsdGVyOiBncmF5c2NhbGUoMTAwJSk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyBzaGFrZVRlY2ggewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuOCk7IH0KICAgIDEwJSwgMzAlLCA1MCUsIDcwJSwgOTAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjEpIHRyYW5zbGF0ZSgtMnB4LCAycHgpOyB9CiAgICAyMCUsIDQwJSwgNjAlLCA4MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSkgdHJhbnNsYXRlKDJweCwgLTJweCk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IH0KfQoKQGtleWZyYW1lcyBmbGFzaFRlY2ggewogICAgMCUgeyBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZmOyBjb2xvcjogIzAwMDsgYm9yZGVyLWNvbG9yOiAjZmZmOyB9CiAgICAxMDAlIHsgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgwLCAxMCwgMzAsIDAuODUpOyBjb2xvcjogIzAwZmZmZjsgYm9yZGVyLWNvbG9yOiAjMDBmZmZmOyB9Cn0KCiNsb2FkaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgIGFuaW1hdGlvbjogYmxpbmsgMXMgaW5maW5pdGU7Cn0KQGtleWZyYW1lcyBibGluayB7IDUwJSB7IG9wYWNpdHk6IDAuNTsgfSB9CgojY29udHJvbHMtaGludCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDEzMHB4OyB3aWR0aDogMTAwJTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiByZ2JhKDI1NSwyNTUsMjU1LDAuNCk7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmNvbWljLWltcGFjdCB7CiAgICBmb250LWZhbWlseTogJ0ltcGFjdCcsIHNhbnMtc2VyaWY7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBjb2xvcjogI2ZmZmYwMDsgCiAgICAtd2Via2l0LXRleHQtc3Ryb2tlOiAxcHggIzAwMDsKICAgIHRleHQtc2hhZG93OiAzcHggM3B4IDAgI2ZmMDAwMDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGNlbnRlcjsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICBhbmltYXRpb246IGNvbWljUG9wIDAuNHMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpIGZvcndhcmRzOwogICAgei1pbmRleDogMjUwMDsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuY29taWMtYWN0aW9uIHsKICAgIGZvbnQtZmFtaWx5OiAnQXJpYWwgQmxhY2snLCBzYW5zLXNlcmlmOwogICAgZm9udC1zaXplOiAyOHB4OwogICAgY29sb3I6ICMwMGZmZmY7IAogICAgLXdlYmtpdC10ZXh0LXN0cm9rZTogMXB4ICMwMDA7CiAgICB0ZXh0LXNoYWRvdzogMnB4IDJweCAwICMwMDQ0YWE7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgYW5pbWF0aW9uOiBjb21pY1NsaWRlIDAuNHMgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICB6LWluZGV4OiAyNTAwOwp9CgpAa2V5ZnJhbWVzIGNvbWljUG9wIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwKSByb3RhdGUoLTIwZGVnKTsgb3BhY2l0eTogMDsgfQogICAgNDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjIpIHJvdGF0ZSg1ZGVnKTsgb3BhY2l0eTogMTsgfQogICAgNjAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApIHJvdGF0ZSgtNWRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSkgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgY29taWNTbGlkZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC0yMHB4LCAyMHB4KSBzY2FsZSgwLjUpOyBvcGFjaXR5OiAwOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMjBweCwgLTIwcHgpIHNjYWxlKDEuMik7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIE1BSU4gTUVOVSAtLS0gKi8KLyogLS0tIE1BSU4gTUVOVSAmIEVORCBHQU1FIChGRlggU1RZTEUpIC0tLSAqLwojbWFpbi1tZW51LCAjZW5kLWdhbWUtbWVudSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDMwMDA7CiAgICBvcGFjaXR5OiAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuOHMgY3ViaWMtYmV6aWVyKDAuMiwgMC44LCAwLjIsIDEuMCk7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IGNlbnRlciwgcmdiYSgwLCAyMCwgNjAsIDAuNCkgMCUsIHJnYmEoMCwgNSwgMTAsIDAuOCkgMTAwJSk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNXB4KTsKfQoKI21haW4tbWVudS5hY3RpdmUsICNlbmQtZ2FtZS1tZW51LmFjdGl2ZSB7CiAgICBvcGFjaXR5OiAxOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87Cn0KCi5tZW51LWJnLW92ZXJsYXksIC5lbmQtYmctbGF5ZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogCiAgICAgICAgbGluZWFyLWdyYWRpZW50KHJnYmEoMCwwLDAsMCkgNTAlLCByZ2JhKDAsMCwwLDAuMSkgNTAlKSwgCiAgICAgICAgcmVwZWF0aW5nLWxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgyNTUsMjU1LDI1NSwwLjAyKSAwcHgsIHJnYmEoMjU1LDI1NSwyNTUsMC4wMikgMXB4LCB0cmFuc3BhcmVudCAxcHgsIHRyYW5zcGFyZW50IDIwcHgpOwogICAgYmFja2dyb3VuZC1zaXplOiAxMDAlIDRweCwgMTAwJSAxMDAlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAtMTsKfQoKLyogTE9HTyBTVFlMSU5HICovCi5mZngtbG9nby1jb250YWluZXIgewogICAgbWFyZ2luLWJvdHRvbTogNTBweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goLTEwZGVnKTsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKfQoKLmZmeC1sb2dvLW1haW4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiBjbGFtcCg0OHB4LCAxMHZ3LCA4NHB4KTsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiA4cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjZmZmZmZmIDAlLCAjYWFjY2ZmIDQwJSwgIzAwODhmZiAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjgpKTsKICAgIGFuaW1hdGlvbjogbG9nb1NoaW1tZXIgM3MgaW5maW5pdGUgYWx0ZXJuYXRlOwp9CgouZmZ4LWxvZ28tc3ViIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoMTRweCwgM3Z3LCAyNHB4KTsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogMTVweDsKICAgIG1hcmdpbi10b3A6IC0xMHB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICNmZmFhMDA7CiAgICBvcGFjaXR5OiAwLjk7Cn0KCkBrZXlmcmFtZXMgbG9nb1NoaW1tZXIgewogICAgMCUgeyBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuNSkpOyB9CiAgICAxMDAlIHsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMjVweCByZ2JhKDAsIDIwMCwgMjU1LCAwLjkpKTsgfQp9CgovKiBNRU5VIE9QVElPTlMgKi8KLm1lbnUtb3B0aW9ucywgLmVuZC1vcHRpb25zIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgZ2FwOiAxNXB4OwogICAgd2lkdGg6IDMyMHB4Owp9CgoubWVudS1pdGVtIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIHBhZGRpbmc6IDEycHggMzBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgwLCAzMCwgNjAsIDAuOCkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjIpIDEwMCUpOwogICAgYm9yZGVyLWxlZnQ6IDNweCBzb2xpZCByZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyk7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgcmdiYSgxMDAsIDIwMCwgMjU1LCAwLjEpOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdHJhbnNpdGlvbjogYWxsIDAuM3MgY3ViaWMtYmV6aWVyKDAuMiwgMC44LCAwLjIsIDEuMCk7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xNWRlZyk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCi5tZW51LWl0ZW06OmJlZm9yZSB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogLTEwMCU7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHRyYW5zcGFyZW50LCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMiksIHRyYW5zcGFyZW50KTsKICAgIHRyYW5zaXRpb246IGxlZnQgMC40czsKfQoKLm1lbnUtaXRlbTpob3Zlcjo6YmVmb3JlIHsKICAgIGxlZnQ6IDEwMCU7Cn0KCi5tZW51LWl0ZW06aG92ZXIgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDgwLCAxNjAsIDAuOSkgMCUsIHJnYmEoMCwgMjAsIDQwLCAwLjQpIDEwMCUpOwogICAgYm9yZGVyLWxlZnQtY29sb3I6ICMwMGZmZmY7CiAgICBwYWRkaW5nLWxlZnQ6IDQ1cHg7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjMpOwp9CgoubWVudS1pdGVtIC5sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDIwcHg7CiAgICBjb2xvcjogI2NjY2NjYzsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZyk7CiAgICB0cmFuc2l0aW9uOiBjb2xvciAwLjJzOwp9CgoubWVudS1pdGVtOmhvdmVyIC5sYWJlbCB7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwp9CgoubWVudS1pdGVtIC5jdXJzb3IgewogICAgd2lkdGg6IDEwcHg7IGhlaWdodDogMTBweDsKICAgIGJhY2tncm91bmQ6IHZhcigtLWZmeC1nb2xkKTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIG1hcmdpbi1yaWdodDogMTVweDsKICAgIG9wYWNpdHk6IDA7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTIwcHgpIHNrZXdYKDE1ZGVnKTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjNzOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggdmFyKC0tZmZ4LWdvbGQpOwp9CgoubWVudS1pdGVtOmhvdmVyIC5jdXJzb3IgewogICAgb3BhY2l0eTogMTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKSBza2V3WCgxNWRlZyk7Cn0KCi5tZW51LWZvb3RlciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDMwcHg7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogcmdiYSgyNTUsMjU1LDI1NSwwLjMpOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KCi8qIEVORCBHQU1FIFNQRUNJRklDICovCi5yZXN1bHQtaGVhZGVyIHsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIG1hcmdpbi1ib3R0b206IDQwcHg7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7Cn0KCi5yZXN1bHQtdGl0bGUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiA3MnB4OwogICAgY29sb3I6ICNmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwYWFmZiwgMCAwIDQwcHggIzAwNDRhYTsKICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICBsaW5lLWhlaWdodDogMS4wOwp9CgoucmVzdWx0LXN1YnRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMThweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogOHB4OwogICAgbWFyZ2luLXRvcDogNXB4Owp9CgouZmluYWwtc2NvcmUtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBnYXA6IDQwcHg7CiAgICBtYXJnaW4tYm90dG9tOiA1MHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgcmdiYSgwLCAyMCwgNTAsIDAuOCksIHRyYW5zcGFyZW50KTsKICAgIHBhZGRpbmc6IDIwcHggMDsKICAgIHdpZHRoOiAxMDAlOwp9CgouZmluYWwtdGVhbSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB3aWR0aDogMTIwcHg7Cn0KCi5maW5hbC1zY29yZS1kaWdpdCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogODBweDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC41KTsKICAgIGxpbmUtaGVpZ2h0OiAxLjA7Cn0KCi5maW5hbC10ZWFtLmhvbWUgLmZpbmFsLXNjb3JlLWRpZ2l0IHsgY29sb3I6ICMwMGZmZmY7IHRleHQtc2hhZG93OiAwIDAgMjBweCAjMDBmZmZmOyB9Ci5maW5hbC10ZWFtLmF3YXkgLmZpbmFsLXNjb3JlLWRpZ2l0IHsgY29sb3I6ICNmZjQ0NDQ7IHRleHQtc2hhZG93OiAwIDAgMjBweCAjZmY0NDQ0OyB9CgouZmluYWwtdGVhbS1uYW1lIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjYWFhOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG1hcmdpbi10b3A6IDVweDsKfQoKLmZpbmFsLXZzIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG9wYWNpdHk6IDAuNjsKfQoKLmZpbmFsLXZzIHNwYW4gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIG1hcmdpbjogNXB4IDA7Cn0KCi52cy1saW5lIHsKICAgIHdpZHRoOiAycHg7IGhlaWdodDogMzBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sIHRyYW5zcGFyZW50LCB2YXIoLS1mZngtZ29sZCksIHRyYW5zcGFyZW50KTsKfQovKiAtLS0gUFJBQ1RJQ0UgT1ZFUkxBWSAtLS0gKi8KI3ByYWN0aWNlLW92ZXJsYXkgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCA1LCAxMCwgMC42KTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB6LWluZGV4OiAyNTAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCiNwcmFjdGljZS1vdmVybGF5LmFjdGl2ZSB7CiAgICBkaXNwbGF5OiBmbGV4Owp9CgoucHJhY3RpY2UtcGFuZWwgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNDBweCk7IAogICAgcmlnaHQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogMjgwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTYwZGVnLCByZ2JhKDAsIDIwLCA1MCwgMC45NSkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjk4KSAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDg4ZmY7CiAgICBib3JkZXItcmFkaXVzOiAwIDAgMTVweCAwOwogICAgYm94LXNoYWRvdzogMCAwIDIwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC4yKSwgaW5zZXQgMCAwIDUwcHggcmdiYSgwLCAyMCwgNjAsIDAuNSk7CiAgICBwYWRkaW5nOiAxNXB4OwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0yZGVnKTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig1cHgpOwp9CgoucGFuZWwtaGVhZGVyIHsKICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCi5wYW5lbC10aXRsZS1ncm91cCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKfQoKLnBhbmVsLXRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoMThweCwgNnZ3LCAyNHB4KTsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICMwMGZmZmY7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4Owp9CgoucGFuZWwtc3VidGl0bGUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiA4cHg7CiAgICBjb2xvcjogIzQ0ODhmZjsKICAgIGxldHRlci1zcGFjaW5nOiA0cHg7CiAgICBtYXJnaW4tdG9wOiAtMnB4Owp9CgoucGFuZWwtZGVjby1saW5lIHsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAycHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHRyYW5zcGFyZW50LCAjMDBmZmZmLCB0cmFuc3BhcmVudCk7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICBib3gtc2hhZG93OiAwIDAgNXB4ICMwMGZmZmY7Cn0KCi5wYW5lbC1jb250ZW50IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgZ2FwOiAxNXB4Owp9Cgouc2VjdGlvbi1sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMjAwLCAxNzYsIDk2LCAwLjMpOwogICAgbWFyZ2luLWJvdHRvbTogNXB4OwogICAgcGFkZGluZy1ib3R0b206IDJweDsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7Cn0KCi5kcmlsbC1saXN0IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgZ2FwOiA1cHg7Cn0KCi5kcmlsbC1idG4gewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwYWRkaW5nOiA4cHggMTJweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjA1KSwgdHJhbnNwYXJlbnQpOwogICAgYm9yZGVyLWxlZnQ6IDJweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAxNHB4OwogICAgY29sb3I6ICNhYWE7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoKLmRyaWxsLWJ0bjpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMjU1LCAyNTUsIDAuMSksIHRyYW5zcGFyZW50KTsKICAgIGNvbG9yOiAjZmZmOwogICAgcGFkZGluZy1sZWZ0OiAxNXB4Owp9CgouZHJpbGwtYnRuLmFjdGl2ZSB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMTAwLCAyNTUsIDAuNCksIHRyYW5zcGFyZW50KTsKICAgIGJvcmRlci1sZWZ0OiAzcHggc29saWQgIzAwZmZmZjsKICAgIGNvbG9yOiAjZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggIzAwZmZmZjsKfQoKLmRyaWxsLWJ0biAuaWNvbiB7CiAgICB3aWR0aDogMjBweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIG1hcmdpbi1yaWdodDogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7Cn0KCi5vcHRpb24tbGlzdCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogNXB4Owp9Cgoub3B0aW9uLXRvZ2dsZSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBhZGRpbmc6IDVweCAxMHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgY29sb3I6ICNjY2M7CiAgICB0cmFuc2l0aW9uOiBjb2xvciAwLjJzOwp9Cgoub3B0aW9uLXRvZ2dsZTpob3ZlciB7IGNvbG9yOiAjZmZmOyB9Cgoub3B0aW9uLXRvZ2dsZSAuY2hlY2tib3ggewogICAgbWFyZ2luLXJpZ2h0OiAxMHB4OwogICAgY29sb3I6ICM0NDQ7CiAgICBmb250LWZhbWlseTogbW9ub3NwYWNlOwogICAgZm9udC1zaXplOiAxNHB4Owp9Cgoub3B0aW9uLXRvZ2dsZS5hY3RpdmUgLmNoZWNrYm94IHsKICAgIGNvbG9yOiAjMDBmZjAwOwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggIzAwZmYwMDsKfQoKLm9wdGlvbi10b2dnbGUuYWN0aXZlIHsKICAgIGNvbG9yOiAjZmZmOwp9CgouYWN0aW9uLWJ0biB7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuNSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ0OwogICAgcGFkZGluZzogNnB4OwogICAgZm9udC1zaXplOiAxMXB4OwogICAgY29sb3I6ICNhYWE7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgouYWN0aW9uLWJ0bjpob3ZlciB7CiAgICBib3JkZXItY29sb3I6ICNmZmY7CiAgICBjb2xvcjogI2ZmZjsKICAgIGJhY2tncm91bmQ6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKTsKfQoKI3AtZXhpdDpob3ZlciB7CiAgICBib3JkZXItY29sb3I6ICNmZjQ0NDQ7CiAgICBjb2xvcjogI2ZmNDQ0NDsKICAgIGJhY2tncm91bmQ6IHJnYmEoNTAsIDAsIDAsIDAuMyk7Cn0KCi5wYW5lbC1mb290ZXIgewogICAgbWFyZ2luLXRvcDogMTVweDsKICAgIHBhZGRpbmctdG9wOiAxMHB4OwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKTsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoKI2RyaWxsLWluc3RydWN0aW9uIHsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBtYXJnaW4tYm90dG9tOiA1cHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7Cn0KCiNkcmlsbC1zY29yZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggcmdiYSgyNTUsIDIxNSwgMCwgMC41KTsKfQoKLnBhbmVsLW1pbmltaXplLWJ0biB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDEwcHg7IHJpZ2h0OiAxMHB4OwogICAgd2lkdGg6IDIwcHg7IGhlaWdodDogMjBweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBsaW5lLWhlaWdodDogMThweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC41KTsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwp9Ci5wYW5lbC1taW5pbWl6ZS1idG46aG92ZXIgeyAKICAgIGJhY2tncm91bmQ6IHZhcigtLWZmeC1jeWFuKTsgCiAgICBjb2xvcjogIzAwMDsgCiAgICBib3gtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKfQoKI3ByYWN0aWNlLXJlc3RvcmUtYnRuIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDYwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDQwcHgpOyAKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgcGFkZGluZzogOHB4IDE1cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMjAsIDUwLCAwLjkpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC45KSAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1sZWZ0OiAzcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHotaW5kZXg6IDI0MDA7CiAgICBkaXNwbGF5OiBub25lOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjIpOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKfQojcHJhY3RpY2UtcmVzdG9yZS1idG46aG92ZXIgewogICAgYmFja2dyb3VuZDogcmdiYSgwLCA0MCwgODAsIDAuOSk7CiAgICBjb2xvcjogI2ZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMGZmZmY7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjMpOwp9CgovKiAtLS0gQUlNIEpPWVNUSUNLIC0tLSAqLwojYWltLWpveXN0aWNrLXpvbmUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiBtYXgoMTUwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSk7CiAgICByaWdodDogMDsKICAgIHdpZHRoOiA0MCU7CiAgICBoZWlnaHQ6IDM1JTsKICAgIHotaW5kZXg6IDEwMDA7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDApOwogICAgdG91Y2gtYWN0aW9uOiBub25lOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87Cn0KCiNhaW0tam95c3RpY2stdmlzdWFsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiAwOyBoZWlnaHQ6IDA7CiAgICBvdmVyZmxvdzogdmlzaWJsZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgZGlzcGxheTogbm9uZTsKICAgIHotaW5kZXg6IDExMDA7Cn0KCiNhaW0tam95c3RpY2stYmFzZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogOTBweDsgaGVpZ2h0OiA5MHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgyNTUsIDEwMCwgMCwgMC4zKSAwJSwgcmdiYSg4MCwgMjAsIDAsIDAuMSkgNjAlLCB0cmFuc3BhcmVudCAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMjU1LCAxNTAsIDUwLCAwLjQpOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgyNTUsIDEwMCwgMCwgMC4yKSwgaW5zZXQgMCAwIDIwcHggcmdiYSgyNTUsIDUwLCAwLCAwLjIpOwp9CgojYWltLWpveXN0aWNrLWtub2IgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDQwcHg7IGhlaWdodDogNDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzAlIDMwJSwgI2ZmY2M4OCAwJSwgI2ZmNjYwMCA0MCUsICM4ODIyMDAgODAlLCAjMjIwMDAwIDEwMCUpOwogICAgYm9yZGVyOiAycHggc29saWQgI2ZmYWE0NDsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4ICNmZjQ0MDAsIGluc2V0IDAgMCA4cHggcmdiYSgyNTUsMjU1LDI1NSwwLjYpOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMDVzIGxpbmVhcjsKfQoKI2FpbS1qb3lzdGljay1rbm9iOjphZnRlciB7CiAgICBjb250ZW50OiAiQUlNIjsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGZvbnQtc2l6ZTogOHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDNweCAjMDAwOwp9CgovKiAtLS0gVEFDS0xFIEJVVFRPTiAtLS0gKi8KI3RhY2tsZS1idXR0b24gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiBtYXgoMTYwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSArIDEwMHB4KTsKICAgIHJpZ2h0OiBtYXgoNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDcwcHg7CiAgICBoZWlnaHQ6IDcwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBkaXNwbGF5OiBub25lOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICB6LWluZGV4OiAxMDA7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDM1JSAzNSUsICNmZjg4ODggMCUsICNjYzAwMDAgNDAlLCAjNjYwMDAwIDgwJSwgIzIyMDAwMCAxMDAlKTsKICAgIGJvcmRlcjogM3B4IHNvbGlkICNmZjQ0NDQ7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDI1NSwgNTAsIDUwLCAwLjYpLCBpbnNldCAwIDAgMTVweCByZ2JhKDI1NSwgMjAwLCAyMDAsIDAuMyk7CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4xcywgZmlsdGVyIDAuMnM7Cn0KCiN0YWNrbGUtYnV0dG9uOmFjdGl2ZSB7CiAgICB0cmFuc2Zvcm06IHNjYWxlKDAuOSk7CiAgICBmaWx0ZXI6IGJyaWdodG5lc3MoMS4yKTsKfQoKI3RhY2tsZS1idXR0b24uYWN0aXZlIHsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzUlIDM1JSwgI2ZmZmZmZiAwJSwgI2ZmNDQ0NCA0MCUsICNhYTAwMDAgODAlLCAjNDQwMDAwIDEwMCUpOwogICAgYm94LXNoYWRvdzogMCAwIDI1cHggcmdiYSgyNTUsIDEwMCwgMTAwLCAwLjkpOwp9CgojdGFja2xlLWJ1dHRvbiAuYnRuLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDFweCAycHggcmdiYSgwLDAsMCwwLjgpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKI3RhY2tsZS1idXR0b24gLmJ0bi1nbGFyZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01MCU7IGxlZnQ6IC01MCU7CiAgICB3aWR0aDogMjAwJTsgaGVpZ2h0OiAyMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDQ1ZGVnLCB0cmFuc3BhcmVudCA0MCUsIHJnYmEoMjU1LDI1NSwyNTUsMC4zKSA1MCUsIHRyYW5zcGFyZW50IDYwJSk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGFuaW1hdGlvbjogZ2xhcmVQYXNzIDRzIGluZmluaXRlOwp9CgojdGFja2xlLWJ1dHRvbi51cmdlbnQgewogICAgYW5pbWF0aW9uOiB1cmdlbnRQdWxzZSAwLjVzIGluZmluaXRlIGFsdGVybmF0ZTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzUlIDM1JSwgI2ZmNTU1NSAwJSwgI2ZmMDAwMCA0MCUsICM4ODAwMDAgMTAwJSk7CiAgICBib3JkZXItY29sb3I6ICNmZmFhYWE7CiAgICBib3gtc2hhZG93OiAwIDAgMjBweCAjZmYwMDAwOwp9CgpAa2V5ZnJhbWVzIHVyZ2VudFB1bHNlIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjE1KTsgfQp9CgovKiAtLS0gQ0hBUkdFIFBPV0VSIE1FVEVSIC0tLSAqLwojY2hhcmdlLW1ldGVyLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCgyNTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pICsgMTAwcHgpOwogICAgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgd2lkdGg6IDIwMHB4OwogICAgZGlzcGxheTogbm9uZTsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAyMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAxMCwgMzAsIDAuOCk7CiAgICBwYWRkaW5nOiAxMHB4IDE1cHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjMpOwp9CgouY2hhcmdlLWxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKfQoKLmNoYXJnZS1tZXRlci10cmFjayB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTJweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC42KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBib3JkZXItcmFkaXVzOiA2cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgojY2hhcmdlLW1ldGVyLWZpbGwgewogICAgaGVpZ2h0OiAxMDAlOwogICAgd2lkdGg6IDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjMGFmLCAjMGYwKTsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4ICMwZjA7CiAgICB0cmFuc2l0aW9uOiB3aWR0aCAwLjA1cyBsaW5lYXIsIGJhY2tncm91bmQgMC4xczsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKfQoKLmNoYXJnZS1oaW50IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXVpKTsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICBvcGFjaXR5OiAwLjg7CiAgICBhbmltYXRpb246IGJsaW5rIDAuNXMgaW5maW5pdGU7Cn0KCi8qIC0tLSBHT0FMIERJU1RBTkNFIElORElDQVRPUiAtLS0gKi8KI2dvYWwtZGlzdGFuY2UtY29udGFpbmVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDc1cHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDU1cHgpOwogICAgbGVmdDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtbGVmdCkpOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAxMDA7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMTAsIDMwLCAwLjcpIDAlLCB0cmFuc3BhcmVudCAxMDAlKTsKICAgIHBhZGRpbmc6IDVweCAxNXB4IDVweCAxMHB4OwogICAgYm9yZGVyLWxlZnQ6IDJweCBzb2xpZCB2YXIoLS1mZngtZ29sZCk7Cn0KCi5kaXN0YW5jZS1sYWJlbCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDhweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKfQoKI2dvYWwtZGlzdGFuY2UgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtZ29sZCk7Cn0KCi8qIC0tLSBTRVRUSU5HUyBCVVRUT04gLS0tICovCiNzZXR0aW5ncy1idXR0b24gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoMjQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDEwMHB4KTsKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDExMHB4OwogICAgcGFkZGluZzogOHB4IDA7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiAjODg4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgcmdiYSgyMCwgMjAsIDIwLCAwLjgpIDAlLCByZ2JhKDEwLCAxMCwgMTAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ0OwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgei1pbmRleDogMTAwOwp9Cgojc2V0dGluZ3MtYnV0dG9uOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoNDAsIDQwLCA0MCwgMC45KTsKICAgIGJvcmRlci1jb2xvcjogIzg4ODsKICAgIGNvbG9yOiAjZmZmOwp9CgovKiAtLS0gU0VUVElOR1MgUEFORUwgLS0tICovCiNzZXR0aW5ncy1wYW5lbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsKICAgIGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDI4MHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE2MGRlZywgcmdiYSgwLCAyMCwgNTAsIDAuOTgpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC45OSkgMTAwJSk7CiAgICBib3JkZXI6IDJweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiAxMHB4OwogICAgYm94LXNoYWRvdzogMCAwIDMwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC40KTsKICAgIHotaW5kZXg6IDM1MDA7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxMHB4KTsKfQoKLnNldHRpbmdzLWhlYWRlciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBhZGRpbmc6IDE1cHg7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgcmdiYSgxMDAsIDIwMCwgMjU1LCAwLjMpOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAzMCwgNjAsIDAuNSk7Cn0KCi5zZXR0aW5ncy1oZWFkZXIgc3BhbiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDIwcHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7CiAgICBsZXR0ZXItc3BhY2luZzogM3B4Owp9Cgojc2V0dGluZ3MtY2xvc2UgewogICAgd2lkdGg6IDMwcHg7CiAgICBoZWlnaHQ6IDMwcHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjZmY0NDQ0OwogICAgYmFja2dyb3VuZDogcmdiYSg1MCwgMCwgMCwgMC41KTsKICAgIGNvbG9yOiAjZmY0NDQ0OwogICAgZm9udC1zaXplOiAxNHB4OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgYm9yZGVyLXJhZGl1czogNXB4OwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7Cn0KCiNzZXR0aW5ncy1jbG9zZTpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiAjZmY0NDQ0OwogICAgY29sb3I6IHdoaXRlOwp9Cgouc2V0dGluZ3MtY29udGVudCB7CiAgICBwYWRkaW5nOiAyMHB4Owp9Cgouc2V0dGluZy1yb3cgewogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgcGFkZGluZzogMTBweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC4zKTsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKfQoKLnNldHRpbmctcm93IGxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAxNHB4OwogICAgY29sb3I6ICNjY2M7Cn0KCi5zZXR0aW5nLXJvdyBpbnB1dFt0eXBlPSJyYW5nZSJdIHsKICAgIHdpZHRoOiAxMDBweDsKICAgIGFjY2VudC1jb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwp9Cgouc2V0dGluZy1yb3cgaW5wdXRbdHlwZT0iY2hlY2tib3giXSB7CiAgICB3aWR0aDogMjBweDsKICAgIGhlaWdodDogMjBweDsKICAgIGFjY2VudC1jb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgY3Vyc29yOiBwb2ludGVyOwp9CgovKiAtLS0gR0xBUkUgQU5JTUFUSU9OIC0tLSAqLwpAa2V5ZnJhbWVzIGdsYXJlUGFzcyB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtMTAwJSkgcm90YXRlKDQ1ZGVnKTsgfQogICAgMzAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDEwMCUpIHJvdGF0ZSg0NWRlZyk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMTAwJSkgcm90YXRlKDQ1ZGVnKTsgfQp9CgovKiAtLS0gU1RBVFVTIFRZUEUgRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtaW5uZXIuc3RhdHVzIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAyOHB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgY29sb3I6ICNmZjAwZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggI2ZmMDBmZiwgMnB4IDJweCAwICMwMDA7CiAgICBhbmltYXRpb246IHN0YXR1c1BvcCAxLjJzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgpAa2V5ZnJhbWVzIHN0YXR1c1BvcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC41KSB0cmFuc2xhdGVZKDApOyBvcGFjaXR5OiAwOyB9CiAgICAyMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMykgdHJhbnNsYXRlWSgtMTBweCk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCkgdHJhbnNsYXRlWSgtNDBweCk7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIEdPQUwgVFlQRSBGTE9BVElORyBURVhUIC0tLSAqLwouZmxvYXRpbmctdGV4dC1pbm5lci5nb2FsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiA0OHB4OwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmYgMCUsICNmZmQ3MDAgNTAlLCAjZmY4ODAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgNHB4IDRweCByZ2JhKDAsMCwwLDAuOSkpOwogICAgYW5pbWF0aW9uOiBnb2FsUG9wIDFzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KSBmb3J3YXJkczsKfQoKQGtleWZyYW1lcyBnb2FsUG9wIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwKSByb3RhdGUoLTEwZGVnKTsgb3BhY2l0eTogMDsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjUpIHJvdGF0ZSg1ZGVnKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4yKSByb3RhdGUoMGRlZyk7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIERFRkFVTFQgVFlQRSBGTE9BVElORyBURVhUIC0tLSAqLwouZmxvYXRpbmctdGV4dC1pbm5lci5kZWZhdWx0IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMnB4IDRweCByZ2JhKDAsMCwwLDAuOCk7CiAgICBhbmltYXRpb246IGZsb2F0VXAgMC44cyBlYXNlLW91dCBmb3J3YXJkczsKfQoKLyogLS0tIE1PQklMRSBQT1JUUkFJVCBPUFRJTUlaQVRJT05TIC0tLSAqLwpAbWVkaWEgc2NyZWVuIGFuZCAob3JpZW50YXRpb246IHBvcnRyYWl0KSBhbmQgKG1heC13aWR0aDogNjAwcHgpIHsKICAgIC50ZWFtLXdpbmcgeyB3aWR0aDogOTBweDsgcGFkZGluZzogMCA1cHg7IH0KICAgIC5zY29yZS1ib3ggeyBmb250LXNpemU6IDI0cHg7IG1hcmdpbjogMCA1cHg7IH0KICAgIC50ZWFtLW5hbWUgeyBmb250LXNpemU6IDEwcHg7IH0KICAgIC50ZWFtLXN1YiB7IGRpc3BsYXk6IG5vbmU7IH0KICAgIAogICAgLnRpbWVyLWNyeXN0YWwtcmluZyB7IHdpZHRoOiA4MHB4OyBoZWlnaHQ6IDQwcHg7IHRvcDogLTE1cHg7IH0KICAgICN0aW1lci1kaXNwbGF5IHsgZm9udC1zaXplOiAyOHB4OyB9CiAgICAKICAgICNtaW5pbWFwLWNvbnRhaW5lciB7IHdpZHRoOiA5MHB4OyBoZWlnaHQ6IDkwcHg7IH0KICAgICNtaW5pbWFwIHsgd2lkdGg6IDgwcHg7IGhlaWdodDogODBweDsgfQogICAgLnJhZGFyLWxhYmVsIHsgZm9udC1zaXplOiAxMHB4OyB9CiAgICAKICAgIC50ZWNoLXRleHQgeyBmb250LXNpemU6IDI0cHg7IH0KICAgIAogICAgI2FjdGlvbi1idXR0b24geyB3aWR0aDogODBweDsgaGVpZ2h0OiA4MHB4OyB9CiAgICAuY29tbWFuZC1yaW5nIHsgd2lkdGg6IDEwMHB4OyBoZWlnaHQ6IDEwMHB4OyB9CiAgICAjYWN0aW9uLWxhYmVsIHsgZm9udC1zaXplOiAxMHB4OyBwYWRkaW5nOiAycHggOHB4OyB9CiAgICAKICAgICNwbGF5ZXItc3RhdHVzLXBhbmVsIHsgd2lkdGg6IDEzMHB4OyBib3R0b206IG1heCgxNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pICsgMjBweCk7IH0KICAgIC5jaGFyLW5hbWUgeyBmb250LXNpemU6IDE0cHg7IH0KICAgIAogICAgI2F1dG8tdG9nZ2xlLCAjc2V0dGluZ3MtYnV0dG9uLCAjcHJhY3RpY2UtcmVzdG9yZS1idG4gewogICAgICAgIHdpZHRoOiA5MHB4OwogICAgICAgIGZvbnQtc2l6ZTogOXB4OwogICAgICAgIHJpZ2h0OiBtYXgoMTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgfQogICAgCiAgICAjZ29hbC1kaXN0YW5jZS1jb250YWluZXIgeyBsZWZ0OiBtYXgoMTBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KSk7IH0KI2dvYWwtZGlzdGFuY2UgeyBmb250LXNpemU6IDE4cHg7IH0KfQoKLyogLS0tIEdFU1RVUkUgSElOVCAtLS0gKi8KI2dlc3R1cmUtaGludCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMjAwcHg7IGhlaWdodDogMzAwcHg7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAyNTAwOwogICAgb3BhY2l0eTogMC45Owp9CgojZ2VzdHVyZS1oaW50LmFjdGl2ZSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKfQoKLmN1cnZlLWFycm93IHsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDVweCAjMDBmZmZmKTsKICAgIGFuaW1hdGlvbjogZGFzaERyYXcgMS41cyBsaW5lYXIgaW5maW5pdGU7Cn0KCkBrZXlmcmFtZXMgZGFzaERyYXcgewogICAgdG8geyBzdHJva2UtZGFzaG9mZnNldDogLTMwOyB9Cn0KCi5nZXN0dXJlLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwogICAgbWFyZ2luLXRvcDogLTUwcHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoKLmdlc3R1cmUtaGFuZCB7CiAgICBmb250LXNpemU6IDQ4cHg7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDIwcHg7CiAgICBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICBhbmltYXRpb246IGhhbmRTd2lwZSAxLjVzIGVhc2UtaW4tb3V0IGluZmluaXRlOwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCBibGFjayk7Cn0KCkBrZXlmcmFtZXMgaGFuZFN3aXBlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgNTBweCkgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9CiAgICAyMCUgeyBvcGFjaXR5OiAxOyB9CiAgICA4MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgyMHB4LCAtMTAwcHgpIHJvdGF0ZSgyMGRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgwcHgsIC0xMjBweCkgcm90YXRlKDEwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgovKiAtLS0gU1dJUEUgVFJBSUwgKElOVFVJVElWRSBGRUVEQkFDSykgLS0tICovCi5zd2lwZS10cmFpbC1kb3QgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDEycHg7CiAgICBoZWlnaHQ6IDEycHg7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAjMDBmZmZmIDAlLCByZ2JhKDAsIDI1NSwgMjU1LCAwKSA3MCUpOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiA5MDAwOwogICAgYW5pbWF0aW9uOiBmYWRlVHJhaWwgMC41cyBsaW5lYXIgZm9yd2FyZHM7CiAgICBtaXgtYmxlbmQtbW9kZTogc2NyZWVuOwp9CgpAa2V5ZnJhbWVzIGZhZGVUcmFpbCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuMik7IG9wYWNpdHk6IDA7IH0KfQpAa2V5ZnJhbWVzIGZhZGVUcmFpbCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuMik7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIE9GRlNDUkVFTiBJTkRJQ0FUT1IgLS0tICovCiNvZmZzY3JlZW4taW5kaWNhdG9yIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsKICAgIHdpZHRoOiA0MHB4OyBoZWlnaHQ6IDQwcHg7CiAgICBtYXJnaW4tbGVmdDogLTIwcHg7IG1hcmdpbi10b3A6IC0yMHB4OwogICAgei1pbmRleDogMTUwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgZGlzcGxheTogbm9uZTsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDVweCAjMDAwKTsKfQoKI29mZnNjcmVlbi1pbmRpY2F0b3IgLmFycm93IHsKICAgIHdpZHRoOiAwOyBoZWlnaHQ6IDA7CiAgICBib3JkZXItbGVmdDogMTVweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGJvcmRlci1yaWdodDogMTVweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGJvcmRlci1ib3R0b206IDI1cHggc29saWQgIzAwZmYwMDsgLyogR3JlZW4gZm9yIHBsYXllciAqLwogICAgYW5pbWF0aW9uOiBwdWxzZUFycm93IDAuNXMgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgdHJhbnNmb3JtLW9yaWdpbjogY2VudGVyIGJvdHRvbTsKfQoKQGtleWZyYW1lcyBwdWxzZUFycm93IHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHNjYWxlKDEpOyBmaWx0ZXI6IGJyaWdodG5lc3MoMSk7IH0KICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjIpOyBmaWx0ZXI6IGJyaWdodG5lc3MoMS41KTsgfQp9","AssetLoader.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfbG9hZGVyID0gbmV3IFRIUkVFLkdMVEZMb2FkZXIoKTsKCiAgICAvLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQovLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQogICAgZnVuY3Rpb24gY29udmVydE1hdGVyaWFsKG9sZE1hdCwgaXNTa2lubmVkKSB7CiAgICAgICAgCiAgICAgICAgLy8gUHJlc2VydmUgdGV4dHVyZTogQ2hlY2sgbWFwLCB0aGVuIGVtaXNzaXZlTWFwCiAgICAgICAgY29uc3QgdGV4dHVyZSA9IG9sZE1hdC5tYXAgfHwgb2xkTWF0LmVtaXNzaXZlTWFwIHx8IG51bGw7CgogICAgICAgIC8vIEZPUkNFIE9QQVFVRSBWSVNJQklMSVRZCiAgICAgICAgLy8gV2Ugb3ZlcnJpZGUgdHJhbnNwYXJlbmN5IHRvIGVuc3VyZSBtb2RlbHMgYXJlIGFsd2F5cyB2aXNpYmxlIChmaXhpbmcgdGhlICJpbnZpc2libGUgbW9kZWwiIGlzc3VlKS4KICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIG1hcDogdGV4dHVyZSwKICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAgICAgICAgLy8gRk9SQ0UgV0hJVEU6IFJlbW92ZSBhbnkgdGludCBmcm9tIEdMVEYKICAgICAgICAgICAgc2tpbm5pbmc6IGlzU2tpbm5lZCwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgLy8gUmVuZGVyIGJvdGggc2lkZXMgdG8gcHJldmVudCBiYWNrZmFjZSBjdWxsaW5nIGludmlzaWJpbGl0eQogICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsICAgICAvLyBEaXNhYmxlIHRyYW5zcGFyZW5jeSB0byBwcmV2ZW50IHNvcnRpbmcgaXNzdWVzCiAgICAgICAgICAgIG9wYWNpdHk6IDEuMCwgICAgICAgICAgIC8vIEZvcmNlIGZ1bGwgb3BhY2l0eQogICAgICAgICAgICBhbHBoYVRlc3Q6IDAuNSwgICAgICAgICAvLyBTdHJvbmcgYWxwaGEgdGVzdCBmb3IgY3V0b3V0cyAobmV0cy9ncmF0ZXMpCiAgICAgICAgICAgIHZlcnRleENvbG9yczogb2xkTWF0LnZlcnRleENvbG9ycywgLy8gUHJlc2VydmUgdmVydGV4IGNvbG9ycwogICAgICAgICAgICBkZXB0aFRlc3Q6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IHRydWUsICAgICAgIC8vIEZvcmNlIGRlcHRoIHdyaXRlIHNvIGl0IG9jY2x1ZGVzIHByb3Blcmx5CiAgICAgICAgICAgIGZvZzogdHJ1ZQogICAgICAgIH07CgogICAgICAgIC8vIEVuc3VyZSB0ZXh0dXJlIGVuY29kaW5nIGlzIGNvcnJlY3QgZm9yIFRocmVlLmpzCiAgICAgICAgaWYgKHBhcmFtcy5tYXApIHBhcmFtcy5tYXAuZW5jb2RpbmcgPSBUSFJFRS5zUkdCRW5jb2Rpbmc7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwocGFyYW1zKTsKICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlciA9IHsKICAgICAgICBsb2FkTW9kZWw6IGZ1bmN0aW9uKHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yKSB7CiAgICAgICAgICAgIF9sb2FkZXIubG9hZCh1cmwsIGZ1bmN0aW9uKGdsdGYpIHsKICAgICAgICAgICAgICAgIGdsdGYuc2NlbmUudHJhdmVyc2UoZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCkgewpub2RlLmNhc3RTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBQcmV2ZW50IGludmlzaWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZS5tYXRlcmlhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gbm9kZS5tYXRlcmlhbC5tYXAobSA9PiBjb252ZXJ0TWF0ZXJpYWwobSwgbm9kZS5pc1NraW5uZWRNZXNoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBjb252ZXJ0TWF0ZXJpYWwobm9kZS5tYXRlcmlhbCwgbm9kZS5pc1NraW5uZWRNZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKG9uTG9hZCkgb25Mb2FkKGdsdGYpOwogICAgICAgICAgICB9LCBvblByb2dyZXNzLCBvbkVycm9yKTsKICAgICAgICB9CiAgICB9Owp9KSgpOw==","./AssetLoader.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfbG9hZGVyID0gbmV3IFRIUkVFLkdMVEZMb2FkZXIoKTsKCiAgICAvLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQovLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQogICAgZnVuY3Rpb24gY29udmVydE1hdGVyaWFsKG9sZE1hdCwgaXNTa2lubmVkKSB7CiAgICAgICAgCiAgICAgICAgLy8gUHJlc2VydmUgdGV4dHVyZTogQ2hlY2sgbWFwLCB0aGVuIGVtaXNzaXZlTWFwCiAgICAgICAgY29uc3QgdGV4dHVyZSA9IG9sZE1hdC5tYXAgfHwgb2xkTWF0LmVtaXNzaXZlTWFwIHx8IG51bGw7CgogICAgICAgIC8vIEZPUkNFIE9QQVFVRSBWSVNJQklMSVRZCiAgICAgICAgLy8gV2Ugb3ZlcnJpZGUgdHJhbnNwYXJlbmN5IHRvIGVuc3VyZSBtb2RlbHMgYXJlIGFsd2F5cyB2aXNpYmxlIChmaXhpbmcgdGhlICJpbnZpc2libGUgbW9kZWwiIGlzc3VlKS4KICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIG1hcDogdGV4dHVyZSwKICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAgICAgICAgLy8gRk9SQ0UgV0hJVEU6IFJlbW92ZSBhbnkgdGludCBmcm9tIEdMVEYKICAgICAgICAgICAgc2tpbm5pbmc6IGlzU2tpbm5lZCwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgLy8gUmVuZGVyIGJvdGggc2lkZXMgdG8gcHJldmVudCBiYWNrZmFjZSBjdWxsaW5nIGludmlzaWJpbGl0eQogICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsICAgICAvLyBEaXNhYmxlIHRyYW5zcGFyZW5jeSB0byBwcmV2ZW50IHNvcnRpbmcgaXNzdWVzCiAgICAgICAgICAgIG9wYWNpdHk6IDEuMCwgICAgICAgICAgIC8vIEZvcmNlIGZ1bGwgb3BhY2l0eQogICAgICAgICAgICBhbHBoYVRlc3Q6IDAuNSwgICAgICAgICAvLyBTdHJvbmcgYWxwaGEgdGVzdCBmb3IgY3V0b3V0cyAobmV0cy9ncmF0ZXMpCiAgICAgICAgICAgIHZlcnRleENvbG9yczogb2xkTWF0LnZlcnRleENvbG9ycywgLy8gUHJlc2VydmUgdmVydGV4IGNvbG9ycwogICAgICAgICAgICBkZXB0aFRlc3Q6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IHRydWUsICAgICAgIC8vIEZvcmNlIGRlcHRoIHdyaXRlIHNvIGl0IG9jY2x1ZGVzIHByb3Blcmx5CiAgICAgICAgICAgIGZvZzogdHJ1ZQogICAgICAgIH07CgogICAgICAgIC8vIEVuc3VyZSB0ZXh0dXJlIGVuY29kaW5nIGlzIGNvcnJlY3QgZm9yIFRocmVlLmpzCiAgICAgICAgaWYgKHBhcmFtcy5tYXApIHBhcmFtcy5tYXAuZW5jb2RpbmcgPSBUSFJFRS5zUkdCRW5jb2Rpbmc7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwocGFyYW1zKTsKICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlciA9IHsKICAgICAgICBsb2FkTW9kZWw6IGZ1bmN0aW9uKHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yKSB7CiAgICAgICAgICAgIF9sb2FkZXIubG9hZCh1cmwsIGZ1bmN0aW9uKGdsdGYpIHsKICAgICAgICAgICAgICAgIGdsdGYuc2NlbmUudHJhdmVyc2UoZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCkgewpub2RlLmNhc3RTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBQcmV2ZW50IGludmlzaWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZS5tYXRlcmlhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gbm9kZS5tYXRlcmlhbC5tYXAobSA9PiBjb252ZXJ0TWF0ZXJpYWwobSwgbm9kZS5pc1NraW5uZWRNZXNoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBjb252ZXJ0TWF0ZXJpYWwobm9kZS5tYXRlcmlhbCwgbm9kZS5pc1NraW5uZWRNZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKG9uTG9hZCkgb25Mb2FkKGdsdGYpOwogICAgICAgICAgICB9LCBvblByb2dyZXNzLCBvbkVycm9yKTsKICAgICAgICB9CiAgICB9Owp9KSgpOw==","/AssetLoader.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfbG9hZGVyID0gbmV3IFRIUkVFLkdMVEZMb2FkZXIoKTsKCiAgICAvLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQovLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQogICAgZnVuY3Rpb24gY29udmVydE1hdGVyaWFsKG9sZE1hdCwgaXNTa2lubmVkKSB7CiAgICAgICAgCiAgICAgICAgLy8gUHJlc2VydmUgdGV4dHVyZTogQ2hlY2sgbWFwLCB0aGVuIGVtaXNzaXZlTWFwCiAgICAgICAgY29uc3QgdGV4dHVyZSA9IG9sZE1hdC5tYXAgfHwgb2xkTWF0LmVtaXNzaXZlTWFwIHx8IG51bGw7CgogICAgICAgIC8vIEZPUkNFIE9QQVFVRSBWSVNJQklMSVRZCiAgICAgICAgLy8gV2Ugb3ZlcnJpZGUgdHJhbnNwYXJlbmN5IHRvIGVuc3VyZSBtb2RlbHMgYXJlIGFsd2F5cyB2aXNpYmxlIChmaXhpbmcgdGhlICJpbnZpc2libGUgbW9kZWwiIGlzc3VlKS4KICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIG1hcDogdGV4dHVyZSwKICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAgICAgICAgLy8gRk9SQ0UgV0hJVEU6IFJlbW92ZSBhbnkgdGludCBmcm9tIEdMVEYKICAgICAgICAgICAgc2tpbm5pbmc6IGlzU2tpbm5lZCwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgLy8gUmVuZGVyIGJvdGggc2lkZXMgdG8gcHJldmVudCBiYWNrZmFjZSBjdWxsaW5nIGludmlzaWJpbGl0eQogICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsICAgICAvLyBEaXNhYmxlIHRyYW5zcGFyZW5jeSB0byBwcmV2ZW50IHNvcnRpbmcgaXNzdWVzCiAgICAgICAgICAgIG9wYWNpdHk6IDEuMCwgICAgICAgICAgIC8vIEZvcmNlIGZ1bGwgb3BhY2l0eQogICAgICAgICAgICBhbHBoYVRlc3Q6IDAuNSwgICAgICAgICAvLyBTdHJvbmcgYWxwaGEgdGVzdCBmb3IgY3V0b3V0cyAobmV0cy9ncmF0ZXMpCiAgICAgICAgICAgIHZlcnRleENvbG9yczogb2xkTWF0LnZlcnRleENvbG9ycywgLy8gUHJlc2VydmUgdmVydGV4IGNvbG9ycwogICAgICAgICAgICBkZXB0aFRlc3Q6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IHRydWUsICAgICAgIC8vIEZvcmNlIGRlcHRoIHdyaXRlIHNvIGl0IG9jY2x1ZGVzIHByb3Blcmx5CiAgICAgICAgICAgIGZvZzogdHJ1ZQogICAgICAgIH07CgogICAgICAgIC8vIEVuc3VyZSB0ZXh0dXJlIGVuY29kaW5nIGlzIGNvcnJlY3QgZm9yIFRocmVlLmpzCiAgICAgICAgaWYgKHBhcmFtcy5tYXApIHBhcmFtcy5tYXAuZW5jb2RpbmcgPSBUSFJFRS5zUkdCRW5jb2Rpbmc7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwocGFyYW1zKTsKICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlciA9IHsKICAgICAgICBsb2FkTW9kZWw6IGZ1bmN0aW9uKHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yKSB7CiAgICAgICAgICAgIF9sb2FkZXIubG9hZCh1cmwsIGZ1bmN0aW9uKGdsdGYpIHsKICAgICAgICAgICAgICAgIGdsdGYuc2NlbmUudHJhdmVyc2UoZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCkgewpub2RlLmNhc3RTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBQcmV2ZW50IGludmlzaWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZS5tYXRlcmlhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gbm9kZS5tYXRlcmlhbC5tYXAobSA9PiBjb252ZXJ0TWF0ZXJpYWwobSwgbm9kZS5pc1NraW5uZWRNZXNoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBjb252ZXJ0TWF0ZXJpYWwobm9kZS5tYXRlcmlhbCwgbm9kZS5pc1NraW5uZWRNZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKG9uTG9hZCkgb25Mb2FkKGdsdGYpOwogICAgICAgICAgICB9LCBvblByb2dyZXNzLCBvbkVycm9yKTsKICAgICAgICB9CiAgICB9Owp9KSgpOw==","Player.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBCYWxsIExhYiAvIERldlRvb2xzOiB0aHJvdyAmIGN1cnZlIG1hcHBpbmcga25vYnMKICAgIC8vIChEZWZhdWx0cyBtYXRjaCBjdXJyZW50IGZlZWw7IERldlRvb2xzIGNhbiB0d2VhayBhdCBydW50aW1lLikKICAgIHdpbmRvdy5mbHV4LlRocm93Q29uZmlnID0gd2luZG93LmZsdXguVGhyb3dDb25maWcgfHwgewogICAgICAgIFNXSVBFX01JTl9QWDogMjAsCiAgICAgICAgQUlNX0RYX1NDQUxFOiAxLjAsCiAgICAgICAgQUlNX0RZX1NDQUxFOiAxLjAsCgogICAgICAgIFBPV0VSX0JBU0U6IDEuMCwKICAgICAgICBQT1dFUl9SQU5HRTogMC44LCAgICAgICAgICAvLyBCYXNlIG11bHRpcGxpZXIgPSBQT1dFUl9CQVNFICsgcmF0aW8qUE9XRVJfUkFOR0UKICAgICAgICBQT1dFUl9NQVhfQk9OVVNfUkFUSU86IDAuOTUsCiAgICAgICAgUE9XRVJfTUFYX01VTFRJUExJRVI6IDIuNSwKCiAgICAgICAgQ1VSVkVfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBDVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEOiAwLjI1LAogICAgICAgIENVUlZFX1NQSU5fU0NBTEU6IDEwMDAuMCwKICAgICAgICBDVVJWRV9TUEVFRF9NVUxUOiAxLjUsCiAgICAgICAgQ1VSVkVfU1BJTl9DQVA6IDE1MDAuMCwKICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDUwMC4wCiAgICB9OwoKLy8gUmV1c2FibGUgbWF0aCBvYmplY3RzCmNvbnN0IF9wVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9wVmVjMiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfcFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BRdWF0MiA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRhcmdldFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BFdWxlciA9IG5ldyBUSFJFRS5FdWxlcigpOwogICAgY29uc3QgX3BBeGlzWSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApOwogICAgY29uc3QgX3BBeGlzWiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpOwogICAgY29uc3QgX3BJbnZRdWF0ID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgIGNvbnN0IF9wVG1wUXVhdCA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRtcEV1bGVyID0gbmV3IFRIUkVFLkV1bGVyKCk7CgoKY2xhc3MgUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSA9ICdNRicpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLnJvbGUgPSByb2xlOwogICAgICAgICAgICB0aGlzLnRlYW0gPSBudWxsOyAvLyBBc3NpZ25lZCBieSBUZWFtLmFkZFBsYXllcgogICAgICAgICAgICB0aGlzLmhvbWVQb3NpdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLm1peGVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hY3Rpb25zID0ge307CiAgICAgICAgICAgIHRoaXMuYWN0aXZlQWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdpZGxlJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2xhc3RMb2NvbW90aW9uID0gJ2lkbGUnOwp0aGlzLmlucHV0VmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAvLyBQaHlzaWNzIChEcmlmdC9JbmVydGlhIE1vZGVsKQogICAgICAgICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYWNjZWxlcmF0aW9uID0gMTIuMDsKICAgICAgICAgICAgdGhpcy5kcmFnID0gMy4wOwogICAgICAgICAgICB0aGlzLm1heFNwZWVkID0gOC4wOwogICAgICAgICAgICAvLyBCb25lIHJlZmVyZW5jZSBmb3IgaG9sZGluZyBiYWxsCiAgICAgICAgICAgIHRoaXMuaGFuZEJvbmUgPSBudWxsOwovLyBQcm9jZWR1cmFsIGFuaW1hdGlvbiBib25lIHJlZnMgKGZpbGxlZCBpbiBzZXRNZXNoKQp0aGlzLmJvbmVzID0gewogICAgaGlwczogbnVsbCwKICAgIHNwaW5lOiBudWxsLAogICAgY2hlc3Q6IG51bGwsCiAgICBuZWNrOiBudWxsLAogICAgaGVhZDogbnVsbCwKICAgIHJVcHBlckFybTogbnVsbCwKICAgIHJGb3JlQXJtOiBudWxsLAogICAgckhhbmQ6IG51bGwsCiAgICBsVXBwZXJBcm06IG51bGwsCiAgICBsRm9yZUFybTogbnVsbCwKICAgIGxIYW5kOiBudWxsCn07CnRoaXMuX2JvbmVCYXNlUXVhdHMgPSBudWxsOyAvLyBPcHRpb25hbCBmdXR1cmUgdXNlCnRoaXMuX3Byb2NBbmltVGltZSA9IDA7CnRoaXMuX3Ntb290aGVkU3BlZWQgPSAwOwp0aGlzLl9tb3ZpbmdMYXRjaCA9IGZhbHNlOwoKdGhpcy5jYW5DYXRjaCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2F0Y2hDb29sZG93biA9IDA7IC8vIFJlcGxhY2VzIHNldFRpbWVvdXQgZm9yIHNhZmV0eQoKICAgICAgICAgICAgLy8gQmxpdHpiYWxsIFN0YXRzCiAgICAgICAgICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLAogICAgICAgICAgICAgICAgbWF4SFA6IDEwMCwKICAgICAgICAgICAgICAgIEVOOiAzMCwKICAgICAgICAgICAgICAgIEFUOiAxMCwKICAgICAgICAgICAgICAgIFBBOiAxNSwKICAgICAgICAgICAgICAgIEJMOiAxMCwKICAgICAgICAgICAgICAgIFNIOiAxNSwKICAgICAgICAgICAgICAgIENBOiAxMCwKICAgICAgICAgICAgICAgIFNQOiA2MAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gTGV2ZWxpbmcgU3lzdGVtCiAgICAgICAgICAgIHRoaXMubGV2ZWwgPSAxOwogICAgICAgICAgICB0aGlzLmV4cCA9IDA7CiAgICAgICAgICAgIHRoaXMubmV4dExldmVsRXhwID0gMTAwOwoKICAgICAgICAgICAgLy8gU3RhdHVzIEVmZmVjdHMgJiBUZWNobmlxdWVzCiAgICAgICAgICAgIHRoaXMuc3RhdHVzID0gewogICAgICAgICAgICAgICAgdmVub206IDAsCiAgICAgICAgICAgICAgICBuYXA6IDAsCiAgICAgICAgICAgICAgICB3aXRoZXI6IHsgUEE6IDAsIFNIOiAwLCBBVDogMCwgQkw6IDAsIENBOiAwLCBTUDogMCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLm1hcmtpbmcgPSBudWxsOwogICAgICAgICAgICB0aGlzLmxlYXJuZWRUZWNocyA9IFtdOwoKICAgICAgICAgICAgdGhpcy50ZWNocyA9IHsKICAgICAgICAgICAgICAgIHRhY2tsZTogbnVsbCwKICAgICAgICAgICAgICAgIHNob290OiBudWxsLAogICAgICAgICAgICAgICAgcGFzczogbnVsbCwKICAgICAgICAgICAgICAgIHBhc3NpdmU6IG51bGwKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFZpc3VhbHMKICAgICAgICAgICAgdGhpcy5iYXNlQ29sb3JIZXggPSAweGZmZmZmZjsKICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscyA9IFtdOwogICAgICAgICAgICB0aGlzLmF1cmFNZXNoID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5yb3RhdGlvbk9mZnNldCA9IDA7CnRoaXMuYmFzZVNjYWxlID0gMS4xNzsgLy8gSW5jcmVhc2VkIH44JQoKICAgICAgICAgICAgLy8gUmVhbC10aW1lIFN0YXRzCiAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gdGhpcy5zdGF0cy5FTjsKdGhpcy50YWNrbGVSYWRpdXMgPSAyLjA7IC8vIFJlZHVjZWQgZnJvbSAyLjUgdG8gcmVkdWNlIHN3YXJtIGxvY2sKCiAgICAgICAgICAgIHRoaXMuc3BlZWQgPSA0LjA7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gRGFzaCBTdGF0ZQogICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5kYXNoVG90YWxUaW1lID0gMC41Owp0aGlzLmRhc2hDb29sZG93biA9IDA7CiAgICAgICAgICAgIHRoaXMuZGFzaFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBGZWVkYmFjayBBY2N1bXVsYXRvcnMKICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UgPSAwOwogICAgICAgICAgICB0aGlzLl9kYW1hZ2VUaW1lciA9IDA7CgogICAgICAgICAgICAvLyBIUCBCYXIKICAgICAgICAgICAgdGhpcy5ocEJhciA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsID0gbnVsbDsKCiAgICAgICAgICAgIC8vIEdhbWVwbGF5IEZsb3cgVGltZXJzCiAgICAgICAgICAgIHRoaXMuc3R1blRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMDsKCiAgICAgICAgICAgIC8vIEJhbmtpbmcgJiBWZXJ0aWNhbGl0eQogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLnRhcmdldFkgPSAwOwoKICAgICAgICAgICAgLy8gRW5jb3VudGVyIFN5c3RlbQogICAgICAgICAgICB0aGlzLmlzRW5nYWdlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNsYXNoVGltZXIgPSAwOwoKICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7IC8vIFRyYWNrIGR1cmF0aW9uIG9mIGN1cnJlbnQgZW5nYWdlbWVudAogICAgICAgICAgICAvLyBDaGFyZ2UgTWVjaGFuaWMKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4Q2hhcmdlVGltZSA9IDEuNTsKCiAgICAgICAgICAgIC8vIEZJWEVEOiBJbXByb3ZlZCBSb3RhdGlvbiBTdGF0ZSB3aXRoIGh5c3RlcmVzaXMKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gMDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLmxhc3RWYWxpZFlhdyA9IDA7IC8vIFN0b3JlIGxhc3Qga25vd24gZ29vZCB5YXcgZm9yIGRlYWR6b25lIGhhbmRsaW5nCiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmZhY2luZ0RlYWR6b25lID0gMC4zOyAvLyBNaW5pbXVtIGlucHV0L3ZlbG9jaXR5IG1hZ25pdHVkZSB0byB1cGRhdGUgZmFjaW5nCgogICAgICAgICAgICAvLyBQYXJ0aWNsZSBFbWlzc2lvbiBUaW1lcnMKICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMgPSB7CiAgICAgICAgICAgICAgICB2ZW5vbTogMCwKICAgICAgICAgICAgICAgIG5hcDogMCwKICAgICAgICAgICAgICAgIHdpdGhlcjogMAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gRGV2VG9vbHMgRmxhZ3MKICAgICAgICAgICAgdGhpcy5pc0dvZE1vZGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBhc3MgVGFyZ2V0IEluZGljYXRvcgovLyBQYXNzIFRhcmdldCBJbmRpY2F0b3IKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yID0gbnVsbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJ1YmJsZSBUcmFpbCBUaW1lcgogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDA7Cgp0aGlzLl9kYXNoUGFydGljbGVUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSAwOyAvLyBDb250aW51b3VzIHByZXNzdXJlIGZhY3RvciAoMC4wIHRvIDEuMCkKICAgICAgICB9CgogICAgICAgIHN5bmNSb3RhdGlvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgZXVsZXIgPSBuZXcgVEhSRUUuRXVsZXIoKS5zZXRGcm9tUXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbiwgJ1lYWicpOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgPSBldWxlci55IC0gdGhpcy5yb3RhdGlvbk9mZnNldDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgIHRoaXMubGFzdFZhbGlkWWF3ID0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ID0gMDsKICAgICAgICB9CgogICAgICAgIGdldFN0YXQobmFtZSkgewogICAgICAgICAgICBsZXQgdmFsID0gdGhpcy5zdGF0c1tuYW1lXTsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltuYW1lXSA+IDApIHsKICAgICAgICAgICAgICAgIHZhbCAqPSAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICB9CgogICAgICAgIGFwcGx5U3RhdHVzKHR5cGUsIGR1cmF0aW9uLCBzdWJUeXBlID0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMudmVub20gPiAxLjA7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy52ZW5vbSA9IE1hdGgubWF4KHRoaXMuc3RhdHVzLnZlbm9tLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnJvbGV9IHBvaXNvbmVkIWApOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQT0lTT04iLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMubmFwID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gTWF0aC5tYXgodGhpcy5zdGF0dXMubmFwLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gZmVsbCBhc2xlZXAhYCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNMRUVQIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3dpdGhlcicgJiYgc3ViVHlwZSkgewogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFZhbCA9IHRoaXMuc3RhdHVzLndpdGhlcltzdWJUeXBlXSB8fCAwOwogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gY3VycmVudFZhbCA+IDEuMDsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLndpdGhlcltzdWJUeXBlXSA9IE1hdGgubWF4KGN1cnJlbnRWYWwsIGR1cmF0aW9uKTsKCiAgICAgICAgICAgICAgICBpZiAoIXdhc0FjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gd2l0aGVyZWQgJHtzdWJUeXBlfSFgKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgV0lUSEVSICR7c3ViVHlwZX1gLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZURlcml2ZWRTdGF0cygpIHsKICAgICAgICAgICAgY29uc3Qgc3AgPSB0aGlzLmdldFN0YXQoJ1NQJyk7CiAgICAgICAgICAgIHRoaXMubWF4U3BlZWQgPSA1LjAgKyAoc3AgLyAxNS4wKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSB0aGlzLmdldFN0YXQoJ0VOJyk7CiAgICAgICAgfQoKc2V0TWVzaChzb3VyY2VNZXNoLCBhbmltYXRpb25zKSB7CiAgICAgICAgICAgIHRoaXMubWVzaCA9IHNvdXJjZU1lc2g7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUhQQmFyKCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUF1cmEoKTsKICAgICAgICAgICAgdGhpcy5fY3JlYXRlUGFzc1RhcmdldEluZGljYXRvcigpOwoKICAgICAgICAgICAgLy8gQ3VzdG9tIENoYXJhY3RlciBTY2FsaW5nCiAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUuaW5jbHVkZXMoJ1RpZHVzJykpIHRoaXMuYmFzZVNjYWxlID0gMS42OwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB0aGlzLmJhc2VTY2FsZSA9IDEuNDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXNoLnNjYWxlLnNldFNjYWxhcih0aGlzLmJhc2VTY2FsZSk7CgogICAgICAgICAgICB0aGlzLm1lc2gudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCAmJiBub2RlLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udmVydE9uZSA9IChtYXQpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXA6IG1hdC5tYXAgfHwgbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBuZXcgVEhSRUUuQ29sb3IoMHhmZmZmZmYpLCAvLyBGT1JDRSBXSElURTogSWdub3JlIHNvdXJjZSBjb2xvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6ICEhbWF0LnRyYW5zcGFyZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogKG1hdC5vcGFjaXR5ICE9PSB1bmRlZmluZWQgPyBtYXQub3BhY2l0eSA6IDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxwaGFUZXN0OiAobWF0LmFscGhhVGVzdCAhPT0gdW5kZWZpbmVkID8gbWF0LmFscGhhVGVzdCA6IDApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2lkZTogbWF0LnNpZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IG1hdC5kZXB0aFRlc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBtYXQuZGVwdGhXcml0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNraW5uaW5nOiAhIW5vZGUuaXNTa2lubmVkTWVzaAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5wdXNoKHsgbWF0ZXJpYWw6IG0sIGJhc2VDb2xvcjogbS5jb2xvci5jbG9uZSgpIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBBcnJheS5pc0FycmF5KG5vZGUubWF0ZXJpYWwpCiAgICAgICAgICAgICAgICAgICAgICAgID8gbm9kZS5tYXRlcmlhbC5tYXAoY29udmVydE9uZSkKICAgICAgICAgICAgICAgICAgICAgICAgOiBjb252ZXJ0T25lKG5vZGUubWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzQm9uZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSAobm9kZS5uYW1lIHx8ICcnKS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBDb3JlIHNwaW5lL2hlYWQgY2hhaW4gKE1peGFtby1mcmllbmRseSkKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuaGlwcyAmJiBuYW1lLmluY2x1ZGVzKCdoaXBzJykpIHRoaXMuYm9uZXMuaGlwcyA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLnNwaW5lICYmIG5hbWUuaW5jbHVkZXMoJ3NwaW5lJykgJiYgIW5hbWUuaW5jbHVkZXMoJ3NwaW5lMicpICYmICFuYW1lLmluY2x1ZGVzKCdzcGluZV8yJykpIHRoaXMuYm9uZXMuc3BpbmUgPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5jaGVzdCAmJiAobmFtZS5pbmNsdWRlcygnY2hlc3QnKSB8fCBuYW1lLmluY2x1ZGVzKCdzcGluZTInKSB8fCBuYW1lLmluY2x1ZGVzKCdzcGluZV8yJykpKSB0aGlzLmJvbmVzLmNoZXN0ID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubmVjayAmJiBuYW1lLmluY2x1ZGVzKCduZWNrJykpIHRoaXMuYm9uZXMubmVjayA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmhlYWQgJiYgbmFtZS5pbmNsdWRlcygnaGVhZCcpKSB0aGlzLmJvbmVzLmhlYWQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1JpZ2h0ID0gbmFtZS5pbmNsdWRlcygncmlnaHQnKSB8fCBuYW1lLmVuZHNXaXRoKCdyJykgfHwgbmFtZS5pbmNsdWRlcygnX3InKSB8fCBuYW1lLmluY2x1ZGVzKCcucicpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzTGVmdCAgPSBuYW1lLmluY2x1ZGVzKCdsZWZ0JykgIHx8IG5hbWUuZW5kc1dpdGgoJ2wnKSB8fCBuYW1lLmluY2x1ZGVzKCdfbCcpIHx8IG5hbWUuaW5jbHVkZXMoJy5sJyk7CgogICAgICAgICAgICAgICAgICAgIC8vIEFybXMvaGFuZHMgKE1peGFtbzogbWl4YW1vcmlnUmlnaHRBcm0vUmlnaHRGb3JlQXJtL1JpZ2h0SGFuZCkKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuclVwcGVyQXJtICYmIChuYW1lLmluY2x1ZGVzKCdyaWdodGFybScpIHx8IChpc1JpZ2h0ICYmIG5hbWUuaW5jbHVkZXMoJ3VwcGVyYXJtJykpKSkgdGhpcy5ib25lcy5yVXBwZXJBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5yRm9yZUFybSAmJiAobmFtZS5pbmNsdWRlcygncmlnaHRmb3JlYXJtJykgfHwgKGlzUmlnaHQgJiYgbmFtZS5pbmNsdWRlcygnZm9yZWFybScpKSkpIHRoaXMuYm9uZXMuckZvcmVBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5ySGFuZCAmJiAoKG5hbWUuaW5jbHVkZXMoJ2hhbmQnKSAmJiBpc1JpZ2h0KSB8fCBuYW1lLmluY2x1ZGVzKCdyaWdodGhhbmQnKSkpIHRoaXMuYm9uZXMuckhhbmQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubFVwcGVyQXJtICYmIChuYW1lLmluY2x1ZGVzKCdsZWZ0YXJtJykgfHwgKGlzTGVmdCAmJiBuYW1lLmluY2x1ZGVzKCd1cHBlcmFybScpKSkpIHRoaXMuYm9uZXMubFVwcGVyQXJtID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubEZvcmVBcm0gJiYgKG5hbWUuaW5jbHVkZXMoJ2xlZnRmb3JlYXJtJykgfHwgKGlzTGVmdCAmJiBuYW1lLmluY2x1ZGVzKCdmb3JlYXJtJykpKSkgdGhpcy5ib25lcy5sRm9yZUFybSA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmxIYW5kICYmICgobmFtZS5pbmNsdWRlcygnaGFuZCcpICYmIGlzTGVmdCkgfHwgbmFtZS5pbmNsdWRlcygnbGVmdGhhbmQnKSkpIHRoaXMuYm9uZXMubEhhbmQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICAvLyBCYWNrLWNvbXBhdDogYmFsbCBhdHRhY2htZW50IHVzZXMgaGFuZEJvbmUKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaGFuZEJvbmUgJiYgdGhpcy5ib25lcy5ySGFuZCkgdGhpcy5oYW5kQm9uZSA9IHRoaXMuYm9uZXMuckhhbmQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5taXhlciA9IG5ldyBUSFJFRS5BbmltYXRpb25NaXhlcih0aGlzLm1lc2gpOwoKICAgICAgICAgICAgaWYgKGFuaW1hdGlvbnMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IF9ub3JtQ2xpcE5hbWUgPSAocykgPT4gKHMgfHwgJycpCiAgICAgICAgICAgICAgICAgICAgLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvW19cLV0rL2csICcgJykKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXHMrL2csICcgJykKICAgICAgICAgICAgICAgICAgICAudHJpbSgpOwoKICAgICAgICAgICAgICAgIC8vIEhlbHBlciB0byBzdHJpcCBsZWcgdHJhY2tzIGZyb20gYWN0aW9uIGNsaXBzCiAgICAgICAgICAgICAgICBjb25zdCBfc3RyaXBMZWdzID0gKGNsaXApID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFja3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICBjbGlwLnRyYWNrcy5mb3JFYWNoKHQgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZWdleCB0byBtYXRjaCBsZWcgYm9uZXMgKE1peGFtbyBzdHlsZTogUmlnaHRVcExlZywgUmlnaHRMZWcsIFJpZ2h0Rm9vdCwgUmlnaHRUb2VCYXNlKQogICAgICAgICAgICAgICAgICAgICAgICAvLyBBbHNvIGdlbmVyaWMgIkxlZyIsICJGb290IgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXQubmFtZS5tYXRjaCgvKFVwTGVnfExlZ3xGb290fFRvZSkvaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYWNrcy5wdXNoKHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgY2xpcC50cmFja3MgPSB0cmFja3M7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNsaXA7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGFuaW1hdGlvbnMuZm9yRWFjaCgoY2xpcCkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBfbm9ybUNsaXBOYW1lKGNsaXAubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzID0gKHJlKSA9PiByZS50ZXN0KG5hbWUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxldCBpc0xvY29tb3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBsZXQgYWN0aW9uS2V5ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIENvcmUgbG9jb21vdGlvbiAtLS0KICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC90cmVhZHx0cmVhZGluZ3xpZGxlfGZsb2F0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2lkbGUnOwogICAgICAgICAgICAgICAgICAgICAgICBpc0xvY29tb3Rpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9kYXNofHNwcmludHxidXJzdHxmYXN0XHMqc3dpbXxzd2ltXHMqZmFzdC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdkYXNoJzsKICAgICAgICAgICAgICAgICAgICAgICAgaXNMb2NvbW90aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvc3dpbXxmcmVlc3R5bGV8Y3Jhd2wvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAnc3dpbSc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzTG9jb21vdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIFRocm93aW5nIChwYXNzL3Nob3QgdmFyaWFudHMgaWYgcHJlc2VudCkgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3Rocm93fHRvc3N8cGl0Y2gvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC9zaG9vdHxzaG90fGdvYWwvKSkgYWN0aW9uS2V5ID0gJ3Rocm93X3Nob3QnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChoYXMoL3Bhc3MvKSkgYWN0aW9uS2V5ID0gJ3Rocm93X3Bhc3MnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFjdGlvbktleSA9ICd0aHJvdyc7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBDYXRjaGluZyAoanVtcC9haXIgdmFyaWFudHMgaWYgcHJlc2VudCkgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2NhdGNofHJlY2VpdmV8Z3JhYnxpbnRlcmNlcHQvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC9qdW1wfGxlYXB8YWlyfGRpdmUvKSkgYWN0aW9uS2V5ID0gJ2NhdGNoX2p1bXAnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFjdGlvbktleSA9ICdjYXRjaCc7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBIaXQgLyBSZWFjdCAtLS0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvcmVhY3R8aGl0fGh1cnR8ZGFtYWdlfHN0YWdnZXJ8a25vY2svKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAncmVhY3QnOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gT3B0aW9uYWwgc3RhdGVzIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jaGFyZ2V8YWltfHJlYWR5fHdpbmR1cHxob2xkLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2NoYXJnZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3RhY2tsZXxjaGVja3xyYW0vKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAndGFja2xlJzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvYmxvY2t8c2F2ZS8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2NlbGVicmF0ZXx2aWN0b3J5fGNoZWVyLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2NlbGVicmF0ZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gY2xpcC5uYW1lOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gU3RyaXAgbGVncyBmcm9tIG5vbi1sb2NvbW90aW9uIGNsaXBzIHRvIGFsbG93IHRyZWFkaW5nIHdhdGVyIG92ZXJsYXkKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTG9jb21vdGlvbiAmJiBhY3Rpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3N0cmlwTGVncyhjbGlwKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChhY3Rpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3Rpb25zW2FjdGlvbktleV0gPSB0aGlzLm1peGVyLmNsaXBBY3Rpb24oY2xpcCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFN0YXJ0IGRlZmF1bHQgbG9jb21vdGlvbgogICAgICAgICAgICBpZiAodGhpcy5hY3Rpb25zWydpZGxlJ10pIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24oJ2lkbGUnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrCiAgICAgICAgICAgICAgICBjb25zdCBmaXJzdCA9IE9iamVjdC52YWx1ZXModGhpcy5hY3Rpb25zKVswXTsKICAgICAgICAgICAgICAgIGlmKGZpcnN0KSBmaXJzdC5wbGF5KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9uZS1zaG90IGFuaW1hdGlvbiBsaXN0ZW5lcgogICAgICAgICAgICBpZiAodGhpcy5taXhlcikgewogICAgICAgICAgICAgICAgdGhpcy5taXhlci5hZGRFdmVudExpc3RlbmVyKCdmaW5pc2hlZCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9hbmltTG9ja2VkKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLmFjdGlvbikgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBmaW5pc2hlZCBhY3Rpb24gaXMgb3VyIGN1cnJlbnQgb25lLXNob3QKICAgICAgICAgICAgICAgICAgICBpZiAoZS5hY3Rpb24gPT09IHRoaXMuYWN0aXZlT25lU2hvdCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hbmltTG9ja2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvY2tlZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVPbmVTaG90ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJldHVybiB0byBsb2NvbW90aW9uIHVwZGF0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMTUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE5ldyBtZXRob2QgZm9yIGJhc2UgbGF5ZXIgKGxlZ3MvYm9keSBtb3ZlbWVudCkKICAgICAgICBwbGF5TG9jb21vdGlvbihhY3Rpb25OYW1lLCBkdXJhdGlvbiA9IDAuNSkgewogICAgICAgICAgICBjb25zdCBuZXdBY3Rpb24gPSB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgIGlmICghbmV3QWN0aW9uIHx8IG5ld0FjdGlvbiA9PT0gdGhpcy5hY3RpdmVMb2NvbW90aW9uKSByZXR1cm47CgogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVMb2NvbW90aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUxvY29tb3Rpb24uZmFkZU91dChkdXJhdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5ld0FjdGlvbi5yZXNldCgpOwogICAgICAgICAgICBuZXdBY3Rpb24uZmFkZUluKGR1cmF0aW9uKTsKICAgICAgICAgICAgbmV3QWN0aW9uLnBsYXkoKTsKICAgICAgICAgICAgdGhpcy5hY3RpdmVMb2NvbW90aW9uID0gbmV3QWN0aW9uOwogICAgICAgICAgICB0aGlzLl9sYXN0TG9jb21vdGlvbiA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICAvLyBPdmVyaGF1bGVkIHBsYXkgbWV0aG9kIHRvIGhhbmRsZSBsYXllcmluZwogICAgICAgIHBsYXkoYWN0aW9uTmFtZSwgZHVyYXRpb24gPSAwLjUpIHsKICAgICAgICAgICAgLy8gSWYgaXQncyBhIGxvY29tb3Rpb24gc3RhdGUsIHJvdXRlIHRvIHBsYXlMb2NvbW90aW9uCiAgICAgICAgICAgIGlmIChbJ2lkbGUnLCAnc3dpbScsICdkYXNoJ10uaW5jbHVkZXMoYWN0aW9uTmFtZSkpIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24oYWN0aW9uTmFtZSwgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPdGhlcndpc2UgdHJlYXQgYXMgYW4gYWN0aW9uIGxheWVyCiAgICAgICAgICAgIGNvbnN0IG5ld0FjdGlvbiA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFuZXdBY3Rpb24pIHJldHVybjsKCiAgICAgICAgICAgIC8vIElmIHdlIGhhdmUgYW4gYWN0aXZlIG9uZS1zaG90LCBmYWRlIGl0IG91dAogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVPbmVTaG90ICYmIHRoaXMuYWN0aXZlT25lU2hvdCAhPT0gbmV3QWN0aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZU9uZVNob3QuZmFkZU91dCgwLjEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXdBY3Rpb24ucmVzZXQoKTsKICAgICAgICAgICAgbmV3QWN0aW9uLmZhZGVJbigwLjEpOyAvLyBGYXN0IHRyYW5zaXRpb24gZm9yIGFjdGlvbnMKICAgICAgICAgICAgbmV3QWN0aW9uLnBsYXkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYWN0aXZlT25lU2hvdCA9IG5ld0FjdGlvbjsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlTG9jb21vdGlvbkFuaW0oZHVyYXRpb24gPSAwLjIpIHsKICAgICAgICAgICAgLy8gTm90ZTogV2UgTk8gTE9OR0VSIGNoZWNrIF9hbmltTG9ja2VkIGhlcmUuCiAgICAgICAgICAgIC8vIExvY29tb3Rpb24gc2hvdWxkIHVwZGF0ZSBjb250aW51b3VzbHkgYmFzZWQgb24gc3BlZWQsIAogICAgICAgICAgICAvLyBydW5uaW5nIHVuZGVybmVhdGggdGhlIHVwcGVyIGJvZHkgYWN0aW9uLgogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgdnggPSB0aGlzLnZlbG9jaXR5ID8gdGhpcy52ZWxvY2l0eS54IDogMDsKICAgICAgICAgICAgY29uc3QgdnogPSB0aGlzLnZlbG9jaXR5ID8gdGhpcy52ZWxvY2l0eS56IDogMDsKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSBNYXRoLnNxcnQodnggKiB2eCArIHZ6ICogdnopOwoKICAgICAgICAgICAgLy8gU21vb3RoIHNwZWVkCiAgICAgICAgICAgIGNvbnN0IHNtb290aEsgPSAxLjAgLSBNYXRoLnBvdygwLjAwMSwgZHVyYXRpb24pOwogICAgICAgICAgICB0aGlzLl9zbW9vdGhlZFNwZWVkICs9IChzcGVlZCAtIHRoaXMuX3Ntb290aGVkU3BlZWQpICogc21vb3RoSzsKCiAgICAgICAgICAgIGNvbnN0IHNwZWVkTm9ybSA9ICh0aGlzLm1heFNwZWVkID4gMC4wMDAxKSA/IFRIUkVFLk1hdGhVdGlscy5jbGFtcCh0aGlzLl9zbW9vdGhlZFNwZWVkIC8gdGhpcy5tYXhTcGVlZCwgMCwgMSkgOiAwOwoKICAgICAgICAgICAgLy8gSHlzdGVyZXNpcwogICAgICAgICAgICBjb25zdCBlbnRlck1vdmUgPSAwLjE4OwogICAgICAgICAgICBjb25zdCBleGl0TW92ZSA9IDAuMTA7CgogICAgICAgICAgICBjb25zdCBpbnB1dE1vdmluZyA9IHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wNjsKICAgICAgICAgICAgY29uc3QgdmVsTW92aW5nID0gdGhpcy5fc21vb3RoZWRTcGVlZCA+ICh0aGlzLl9tb3ZpbmdMYXRjaCA/IGV4aXRNb3ZlIDogZW50ZXJNb3ZlKTsKCiAgICAgICAgICAgIHRoaXMuX21vdmluZ0xhdGNoID0gaW5wdXRNb3ZpbmcgfHwgdmVsTW92aW5nOwoKICAgICAgICAgICAgbGV0IHRhcmdldCA9IHRoaXMuX21vdmluZ0xhdGNoID8gJ3N3aW0nIDogJ2lkbGUnOwogICAgICAgICAgICBpZiAodGhpcy5fbW92aW5nTGF0Y2ggJiYgdGhpcy5pc0Rhc2hpbmcgJiYgdGhpcy5hY3Rpb25zWydkYXNoJ10pIHRhcmdldCA9ICdkYXNoJzsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBwbGF5YmFjayByYXRlCiAgICAgICAgICAgIGNvbnN0IGFwcGx5UmF0ZSA9IChrZXkpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGlvbnNba2V5XTsKICAgICAgICAgICAgICAgIGlmICghYSkgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gJ3N3aW0nKSBhLnRpbWVTY2FsZSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDAuODUsIDEuNzAsIHNwZWVkTm9ybSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChrZXkgPT09ICdkYXNoJykgYS50aW1lU2NhbGUgPSBUSFJFRS5NYXRoVXRpbHMubGVycCgxLjEwLCAyLjIwLCBzcGVlZE5vcm0pOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoa2V5ID09PSAnaWRsZScpIGEudGltZVNjYWxlID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoMC45NSwgMS4wNSwgc3BlZWROb3JtKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGFwcGx5UmF0ZSh0YXJnZXQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuX2xhc3RMb2NvbW90aW9uICE9PSB0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGlvbnNbdGFyZ2V0XTsKICAgICAgICAgICAgICAgIGlmIChhKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsgYS5zZXRMb29wKFRIUkVFLkxvb3BSZXBlYXQpOyB9IGNhdGNoIChfKSB7fQogICAgICAgICAgICAgICAgICAgIGEuY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24odGFyZ2V0LCBkdXJhdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBsYXlPbmVTaG90KGFjdGlvbk5hbWUsIGR1cmF0aW9uID0gMC4xLCBvcHRzID0ge30pIHsKICAgICAgICAgICAgY29uc3QgYSA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFhKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICB0aGlzLl9hbmltTG9ja2VkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5fbG9ja2VkU3RhdGUgPSBhY3Rpb25OYW1lOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGEucmVzZXQoKTsKICAgICAgICAgICAgICAgIGEuc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICBhLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGEudGltZVNjYWxlID0gKG9wdHMudGltZVNjYWxlICE9PSB1bmRlZmluZWQgPyBvcHRzLnRpbWVTY2FsZSA6IDEuMCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKF8pIHt9CgogICAgICAgICAgICAvLyBVc2UgdGhlIG5ldyBwbGF5IG1ldGhvZCB3aGljaCBoYW5kbGVzIGxheWVyaW5nCiAgICAgICAgICAgIHRoaXMucGxheShhY3Rpb25OYW1lLCBkdXJhdGlvbik7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBzZXRJbnB1dCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCh4LCAwLCB6KTsKICAgICAgICB9CgpyZWNlaXZlQmFsbCgpIHsKICAgICAgICAgICAgdGhpcy5jYW5DYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ1JJVElDQUwgRklYOiBSZXNldCBzdGF0ZXMgdGhhdCBtaWdodCBwcmV2ZW50IHNob290aW5nCiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMi4wOwoKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLmxhc3RIb2xkZXIgJiYgYmFsbC5sYXN0SG9sZGVyLnRlYW0gPT09IHRoaXMudGVhbSAmJiBiYWxsLmxhc3RIb2xkZXIgIT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGJhbGwubGFzdEhvbGRlci5nYWluRXhwKDIpOwogICAgICAgICAgICAgICAgdGhpcy5nYWluRXhwKDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBiYWxsWSA9ICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLm1lc2gpID8gdGhpcy5iYWxsUmVmLm1lc2gucG9zaXRpb24ueSA6IDA7CiAgICAgICAgICAgIGNvbnN0IGNhdGNoS2V5ID0gKGJhbGxZID4gMC4yNSAmJiB0aGlzLmFjdGlvbnNbJ2NhdGNoX2p1bXAnXSkgPyAnY2F0Y2hfanVtcCcgOiAnY2F0Y2gnOwogICAgICAgICAgICB0aGlzLnBsYXlPbmVTaG90KGNhdGNoS2V5LCAwLjEpOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNOQVAhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtYWN0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp0aHJvd0JhbGwoYmFsbCwgZm9yY2VkVHlwZSA9IG51bGwsIHBvd2VyTXVsdGlwbGllciA9IDEuMCwgZm9yY2VkU3BpbiA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgfHwgdGhpcy5pc1Rocm93aW5nKSByZXR1cm47CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CgogICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSB0cnVlOwoKICAgICAgICAgICAgLy8gTG9jayBhaW0gZGlyZWN0aW9uIGF0IHN0YXJ0IG9mIHRocm93CiAgICAgICAgICAgIHRoaXMubG9ja2VkQWltVmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgIHRoaXMubG9ja2VkQWltVmVjdG9yLmNvcHkodGhpcy5pbnB1dFZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3Rvci5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQoKY29uc3QgZ29hbFogPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC00NiA6IDQ2OwogICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CgogICAgICAgICAgICBsZXQgdHlwZSA9IGZvcmNlZFR5cGU7CiAgICAgICAgICAgIGlmICghdHlwZSkgewogICAgICAgICAgICAgICAgdHlwZSA9IChkaXN0VG9Hb2FsIDwgMjUpID8gJ1NIJyA6ICdQQSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGlzRmluaXNoZXIgPSAodHlwZSA9PT0gJ1NIJyAmJiBkaXN0VG9Hb2FsIDwgMTIuMCk7CgogICAgICAgICAgICBsZXQgdGVjaE5hbWUgPSAodHlwZSA9PT0gJ1NIJykgPyB0aGlzLnRlY2hzLnNob290IDogdGhpcy50ZWNocy5wYXNzOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnZlbm9tID4gMCAmJiB0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0lMRU5DRUQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIHRlY2hOYW1lID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV0IHdpbmR1cFRpbWUgPSAxMDA7CiAgICAgICAgICAgIGxldCBhbmltU3BlZWQgPSAxLjU7CgogICAgICAgICAgICBpZiAocG93ZXJNdWx0aXBsaWVyID4gMS4xKSB7CiAgICAgICAgICAgICAgICB3aW5kdXBUaW1lICs9IDIwMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGlzRmluaXNoZXIgJiYgIXRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICB3aW5kdXBUaW1lID0gNTA7CiAgICAgICAgICAgICAgICBhbmltU3BlZWQgPSAzLjA7CiAgICAgICAgICAgIH0KCmlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSA9IDQwMDsKICAgICAgICAgICAgICAgIGFuaW1TcGVlZCA9IDAuODsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5wbGF5Q2luZW1hdGljKHRlY2hOYW1lLCB0aGlzLm1lc2gsIDEuMik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMS41OwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGFiZWwgPSB0ZWNoTmFtZS5yZXBsYWNlKCdfJywgJyAnKS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24obGFiZWwsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBORVc6IFNwYXduIFRlY2ggR2x5cGggKFZlcnRpY2FsIENhc3RpbmcgQ2lyY2xlKQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyLnNwYXduKCd0ZWNoJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMS4yLAogICAgICAgICAgICAgICAgICAgICAgICByb3RhdGlvblNwZWVkOiA0LjAsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IDEuNSwKICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WTogMS4yLAogICAgICAgICAgICAgICAgICAgICAgICBmYWNlQ2FtZXJhOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFBpY2sgYmVzdCB0aHJvdyBjbGlwIChwYXNzL3Nob3QgdmFyaWFudHMgaWYgcHJlc2VudCkKICAgICAgICAgICAgY29uc3QgdGhyb3dLZXkgPQogICAgICAgICAgICAgICAgKHR5cGUgPT09ICdTSCcgJiYgdGhpcy5hY3Rpb25zWyd0aHJvd19zaG90J10pID8gJ3Rocm93X3Nob3QnIDoKICAgICAgICAgICAgICAgICh0eXBlID09PSAnUEEnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfcGFzcyddKSA/ICd0aHJvd19wYXNzJyA6CiAgICAgICAgICAgICAgICAndGhyb3cnOwoKICAgICAgICAgICAgdGhpcy5wbGF5T25lU2hvdCh0aHJvd0tleSwgMC4xLCB7IHRpbWVTY2FsZTogYW5pbVNwZWVkIH0pOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgIXRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJXSE9PU0giLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1hY3Rpb24iKTsKICAgICAgICAgICAgfQoKc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBTYWZldHk6IElmIGJhbGwgaG9sZGVyIGlzIHN0aWxsIHVzLCBwcm9jZWVkLiBJZiBoYXNCYWxsIGlzIGZhbHNlIGJ1dCBob2xkZXIgaXMgdXMsIGFzc3VtZSBzeW5jIGxhZyBhbmQgcHJvY2VlZC4KICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgfHwgKGJhbGwgJiYgYmFsbC5ob2xkZXIgPT09IHRoaXMpKSB7CmNvbnN0IHRocm93QWN0aW9uID0gdGhpcy5hY3Rpb25zW3Rocm93S2V5XTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhyb3dBY3Rpb24pIHRocm93QWN0aW9uLnRpbWVTY2FsZSA9IDEuMDsKCiAgICAgICAgICAgICAgICAgICAgbGV0IGZpbmFsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVmZXJlbmNlRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCmlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLmNvcHkodGhpcy5vdmVycmlkZUFpbVZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZURpci5jb3B5KGZpbmFsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJFTU9WRUQ6IEluc3RhbnQgcm90YXRpb24gc25hcC4gCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZSB1cGRhdGUgbG9vcCBoYW5kbGVzIHNtb290aCByb3RhdGlvbiB2aWEgdGFyZ2V0WWF3LgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIHRoZSAiZmxpcHBpbmcgYXJvdW5kIiB2aXN1YWwgZ2xpdGNoLgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLmNvcHkodGhpcy5sb2NrZWRBaW1WZWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2VEaXIuY29weSh0aGlzLmxvY2tlZEFpbVZlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgfQoKY29uc3Qgc3BpbiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwoKICAgICAgICAgICAgICAgICAgICBpZiAoZm9yY2VkU3BpbikgewogICAgICAgICAgICAgICAgICAgICAgICBzcGluLmNvcHkoZm9yY2VkU3Bpbik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5wdXREaXIgPSB0aGlzLmlucHV0VmVjdG9yLmNsb25lKCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNyb3NzWSA9IG5ldyBUSFJFRS5WZWN0b3IzKCkuY3Jvc3NWZWN0b3JzKHJlZmVyZW5jZURpciwgaW5wdXREaXIpLnk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoY3Jvc3NZKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Bpbi5zZXQoMCwgY3Jvc3NZICogMTIuMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGxldCBiYXNlQ29zdCA9ICh0eXBlID09PSAnU0gnKSA/IDIwIDogMTA7CiAgICAgICAgICAgICAgICAgICAgbGV0IHRlY2hDb3N0ID0gMDsKICAgICAgICAgICAgICAgICAgICBsZXQgdGVjaEJvbnVzID0gMDsKICAgICAgICAgICAgICAgICAgICBsZXQgdGVjaFBheWxvYWQgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICBpZiAodGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAndmVub20nOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gKHR5cGUgPT09ICdTSCcgPyAyMCA6IDEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAndmVub20nLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnd2l0aGVyJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9ICh0eXBlID09PSAnU0gnID8gMjAgOiAxMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IHsgdHlwZTogJ3dpdGhlcicsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICduYXAnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gKHR5cGUgPT09ICdTSCcgPyAzNSA6IDMwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnbmFwJywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3NwaGVyZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAyNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm5nID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMTEpICsgNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gcm5nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IHsgdHlwZTogJ3NwaGVyZScsIGxldmVsOiAxLCBib251czogcm5nIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgU1BIRVJFICske3JuZ31gLCB0aGlzLm1lc2gucG9zaXRpb24sICJnb2FsIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnamVjaHQnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gNDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnamVjaHQnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9wZXJmb3JtSmVjaHRLbm9ja2JhY2soKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdpbnZpc2libGUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gMjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnaW52aXNpYmxlJywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsQ29zdCA9IGJhc2VDb3N0ICsgdGVjaENvc3Q7CgogICAgICAgICAgICAgICAgICAgIGxldCBwb3dlckZhY3RvciA9IDEuMDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA8IHRvdGFsQ29zdCkgewogICAgICAgICAgICAgICAgICAgICAgICBwb3dlckZhY3RvciA9IDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJUSVJFRCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gdG90YWxDb3N0OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGV0IHN0YXRWYWwgPSB0aGlzLmdldFN0YXQodHlwZSk7CiAgICAgICAgICAgICAgICAgICAgc3RhdFZhbCArPSB0ZWNoQm9udXM7CiAgICAgICAgICAgICAgICAgICAgc3RhdFZhbCAqPSBwb3dlckZhY3RvcjsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IHBvd2VyTXVsdGlwbGllcjsKCmNvbnN0IGdvYWxaID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtNDYgOiA0NjsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnb2FsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbFogLSB0aGlzLm1lc2gucG9zaXRpb24ueikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbERvdCA9IGZpbmFsRGlyLmRvdChnb2FsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDIsIGdvYWxaKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdG9Hb2FsID0gZ29hbFBvcy5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2ggPSB0aGlzLmdldFN0YXQoJ1NIJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBNYXRoLm1pbigwLjksIE1hdGgubWF4KDAuMSwgc2ggLyAxMDAuMCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lzdEZhY3RvciAqPSAwLjE7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnb2FsRG90ID4gMC4yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5sZXJwKHRvR29hbCwgYXNzaXN0RmFjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRmluaXNoZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4wNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xBTSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4yNTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKLy8gR29hbGllIExvZnQgQm9udXMgKFByZXZlbnQgaW50ZXJjZXB0aW9uIGJ5IGltbWVkaWF0ZSBkZWZlbmRlcikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgZmluYWxEaXIueSArPSAwLjg7IC8vIEhpZ2ggbG9mdCBmb3IgY2xlYXJhbmNlCgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGZpbmFsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvTWF0ZSA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0LnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b01hdGUuYWRkU2NhbGVkVmVjdG9yKHRhcmdldC52ZWxvY2l0eSwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvTWF0ZS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYSA9IHRoaXMuZ2V0U3RhdCgnUEEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBNYXRoLm1pbigxLjAsIDAuMyArIChwYSAvIDgwLjApKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lzdEZhY3RvciAqPSAwLjE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIubGVycCh0b01hdGUsIGFzc2lzdEZhY3Rvcik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gTWF0aC5taW4oMC42LCBkaXN0ICogMC4wMyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CmZpbmFsRGlyLnkgKz0gMC4yOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBHb2FsaWUgTG9mdCBCb251cyBmb3IgUGFzc2luZwovLyBHb2FsaWUgTG9mdCBCb251cyBmb3IgUGFzc2luZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yb2xlID09PSAnR0wnKSBmaW5hbERpci55ICs9IDAuODsgLy8gSGlnaCBsb2Z0IGZvciBjbGVhcmFuY2UKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodGVjaFBheWxvYWQgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KHRoaXMsIHRlY2hOYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CgpiYWxsLnNob290KGZpbmFsRGlyLCBzdGF0VmFsLCB0eXBlLCB0ZWNoUGF5bG9hZCwgc3Bpbik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRXh0cmEgZ3JhY2UgcGVyaW9kIGZvciBHb2FsaWUgdG8gcHJldmVudCBwb2ludC1ibGFuayBpbnRlcmNlcHRpb25zCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgewogICAgICAgICAgICAgICAgICAgICAgICBiYWxsLmNhdGNoR3JhY2VQZXJpb2QgPSAwLjY7IC8vIDAuNnMgaW1tdW5pdHkgKGFwcHJveCAxMC0xMm0gdHJhdmVsKQogICAgICAgICAgICAgICAgICAgIH0KCnRoaXMubG9zZUJhbGwoKTsKCnRoaXMuY2F0Y2hDb29sZG93biA9IDEuMDsgLy8gMXMgY29vbGRvd24KICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHdpbmR1cFRpbWUpOwoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBudWxsOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlTG9jb21vdGlvbkFuaW0oMC4yKTsKICAgICAgICAgICAgfSwgd2luZHVwVGltZSArIDUwMCk7CiAgICAgICAgfQoKICAgICAgICBfZmluZFBhc3NUYXJnZXRJbkNvbmUoYWltRGlyKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtKSByZXR1cm4gbnVsbDsKCiAgICAgICAgICAgIGxldCBiZXN0VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IG1heFNjb3JlID0gLUluZmluaXR5OwoKICAgICAgICAgICAgZm9yIChjb25zdCBtYXRlIG9mIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcyB8fCAhbWF0ZS5tZXNoKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICBjb25zdCB0b01hdGUgPSBtYXRlLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGRvdCA9IGFpbURpci5kb3QodG9NYXRlKTsKCiAgICAgICAgICAgICAgICBpZiAoZG90ID4gMC43KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2NvcmUgPSAoZG90ICogMTApIC0gKGRpc3QgKiAwLjEpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoc2NvcmUgPiBtYXhTY29yZSkgewogICAgICAgICAgICAgICAgICAgICAgICBtYXhTY29yZSA9IHNjb3JlOwogICAgICAgICAgICAgICAgICAgICAgICBiZXN0VGFyZ2V0ID0gbWF0ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJlc3RUYXJnZXQ7CiAgICAgICAgfQoKc3RhcnRDaGFyZ2UoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CgovLyBWaXN1YWxzIGhhbmRsZWQgaW4gdXBkYXRlCgogICAgICAgICAgICAvLyBTaG93IGNoYXJnZSBVSQogICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSSgwKTsKCiAgICAgICAgICAgIC8vIE5FVzogU3Bhd24gQ2hhcmdlIEdseXBoIChHcm91bmQgUmluZykKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyLnNwYXduKCdjaGFyZ2UnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgbGlmZTogdGhpcy5tYXhDaGFyZ2VUaW1lLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IDMuMCwKICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAwLjIsCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WTogMC4xCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnJlbGVhc2VDaGFyZ2UoZHgsIGR5LCBjdXJ2ZUlucHV0ID0gbnVsbCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaXNDaGFyZ2luZykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBvd2VyIENhbGN1bGF0aW9uCiAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4odGhpcy5jaGFyZ2VUaW1lIC8gdGhpcy5tYXhDaGFyZ2VUaW1lLCAxLjApOwogICAgICAgICAgICBjb25zdCBUQyA9IHdpbmRvdy5mbHV4LlRocm93Q29uZmlnIHx8IHt9OwoKICAgICAgICAgICAgLy8gQmFzZSBtdWx0aXBsaWVyIChkZWZhdWx0czogMS4wIHRvIDEuOCkKICAgICAgICAgICAgbGV0IG11bHRpcGxpZXIgPSAoVEMuUE9XRVJfQkFTRSAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfQkFTRSA6IDEuMCkgKyAocmF0aW8gKiAoVEMuUE9XRVJfUkFOR0UgIT09IHVuZGVmaW5lZCA/IFRDLlBPV0VSX1JBTkdFIDogMC44KSk7Ly8gTUFYIFBPV0VSIEJPTlVTOiBJZiBoZWxkIG5lYXIgbWF4LCBzaWduaWZpY2FudCBib29zdAogICAgICAgICAgICBpZiAocmF0aW8gPiAoVEMuUE9XRVJfTUFYX0JPTlVTX1JBVElPICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9NQVhfQk9OVVNfUkFUSU8gOiAwLjk1KSkgewogICAgICAgICAgICAgICAgbXVsdGlwbGllciA9IChUQy5QT1dFUl9NQVhfTVVMVElQTElFUiAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfTUFYX01VTFRJUExJRVIgOiAyLjUpOyAvLyBDcml0aWNhbCBQb3dlcgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNQVggUE9XRVIhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKC0xMCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CgogICAgICAgICAgICAvLyBBaW0gVmVjdG9yIENhbGN1bGF0aW9uCiAgICAgICAgICAgIGxldCBhaW1WZWMgPSBudWxsOwogICAgICAgICAgICBjb25zdCBzd2lwZUxlbiA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCiAgICAgICAgICAgIGlmIChzd2lwZUxlbiA+IChUQy5TV0lQRV9NSU5fUFggIT09IHVuZGVmaW5lZCA/IFRDLlNXSVBFX01JTl9QWCA6IDIwKSkgewogICAgICAgICAgICAgICAgY29uc3QgY2FtZXJhID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYTsKICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICBjb25zdCByaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAgICAgaWYgKGNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihmd2QpOwogICAgICAgICAgICAgICAgICAgIGZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAoZndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgZndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBmd2Qubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIHJpZ2h0LmNyb3NzVmVjdG9ycyhmd2QsIG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgICAgIHdvcmxkVmVjLmFkZFNjYWxlZFZlY3RvcihyaWdodCwgZHggKiAoVEMuQUlNX0RYX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5BSU1fRFhfU0NBTEUgOiAxLjApKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5hZGRTY2FsZWRWZWN0b3IoZndkLCAtZHkgKiAoVEMuQUlNX0RZX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5BSU1fRFlfU0NBTEUgOiAxLjApKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgYWltVmVjID0gd29ybGRWZWM7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdmVycmlkZUFpbVZlY3RvciA9IGFpbVZlYzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYWltVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFpbVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgfQoKLy8gLS0tIEFOQUxPRyBDVVJWRSBMT0dJQyAtLS0KICAgICAgICAgICAgLy8gRm9ybXVsYTogQ3VydmUgPSBJbnRlbnNpdHkgKiBTcGVlZAogICAgICAgICAgICBsZXQgc3BpblZlYyA9IG51bGw7CiAgICAgICAgICAgIAppZiAoKFRDLkNVUlZFX0VOQUJMRUQgIT09IGZhbHNlKSAmJiBjdXJ2ZUlucHV0ICYmIE1hdGguYWJzKGN1cnZlSW5wdXQuaW50ZW5zaXR5KSA+IChUQy5DVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEIDogMC4yNSkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJhd0ludGVuc2l0eSA9IE1hdGguYWJzKGN1cnZlSW5wdXQuaW50ZW5zaXR5KTsKICAgICAgICAgICAgICAgIGNvbnN0IHNpZ24gPSBNYXRoLnNpZ24oY3VydmVJbnB1dC5pbnRlbnNpdHkpOyAvLyBQb3NpdGl2ZSA9IFJpZ2h0IEh1bXAgPSBMZWZ0IEN1cnZlCiAgICAgICAgICAgICAgICBjb25zdCBzd2lwZVNwZWVkID0gY3VydmVJbnB1dC5zcGVlZCB8fCAxLjA7CgogICAgICAgICAgICAgICAgLy8gMS4gQmFzZSBTcGluIGZyb20gQXJjIChUdW5lZCBmb3IgcmVhbGlzbSwgbm8gY3ljbG9uZXMpCi8vIDEuIEJhc2UgU3BpbiBmcm9tIEFyYyAoSGVyY3VsZWFuIEJvb3N0KQogICAgICAgICAgICAgICAgbGV0IHNwaW5NYWcgPSByYXdJbnRlbnNpdHkgKiAoVEMuQ1VSVkVfU1BJTl9TQ0FMRSAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BJTl9TQ0FMRSA6IDEwMDAuMCk7CgogICAgICAgICAgICAgICAgLy8gMi4gU3BlZWQgQm9udXMgKFF1aWNrbmVzcyBhZGRzIFJQTSkKICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkQm9udXMgPSBNYXRoLm1heCgxLjAsIHN3aXBlU3BlZWQgKiAoVEMuQ1VSVkVfU1BFRURfTVVMVCAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BFRURfTVVMVCA6IDEuNSkpOwogICAgICAgICAgICAgICAgc3Bpbk1hZyAqPSBzcGVlZEJvbnVzOwoKICAgICAgICAgICAgICAgIC8vIENhcCAoSW5jcmVhc2VkIHRvIDE1MDAgZm9yIG1hc3NpdmUgYXJjcykKICAgICAgICAgICAgICAgIHNwaW5NYWcgPSBNYXRoLm1pbigoVEMuQ1VSVkVfU1BJTl9DQVAgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX1NQSU5fQ0FQIDogMTUwMC4wKSwgc3Bpbk1hZyk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgU3BpbgogICAgICAgICAgICAgICAgLy8gUmlnaHQgSHVtcCAoUG9zaXRpdmUgSW50ZW5zaXR5KSAtPiBMZWZ0IEN1cnZlIChQb3NpdGl2ZSBTcGluIFkpCiAgICAgICAgICAgICAgICBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3Bpbk1hZyAqIHNpZ24sIDApOwogICAgICAgICAgICAgICAgCmlmIChzcGluTWFnID4gKFRDLkNVUlZFX1BFUkZFQ1RfU1BJTiAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfUEVSRkVDVF9TUElOIDogNTAwLjApICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQRVJGRUNUIENVUlZFIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSb2xsSW1wdWxzZShzaWduICogLTAuMyk7IC8vIFRpbHQgY2FtZXJhIGludG8gdGhlIGN1cnZlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEZXRlcm1pbmUgVHlwZSAoUGFzcyB2cyBTaG9vdCkKLy8gRGV0ZXJtaW5lIFR5cGUgKFBhc3MgdnMgU2hvb3QpCiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtNDYgOiA0NjsKICAgICAgICAgICAgY29uc3QgZ29hbERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIGdvYWxaIC0gdGhpcy5tZXNoLnBvc2l0aW9uLnopLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBjb25zdCBkb3RHb2FsID0gYWltVmVjLmRvdChnb2FsRGlyKTsKCiAgICAgICAgICAgIGxldCB0eXBlID0gJ1BBJzsKICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwoKICAgICAgICAgICAgaWYgKGRvdEdvYWwgPiAwLjggJiYgZGlzdFRvR29hbCA8IDM1LjApIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAnU0gnOwogICAgICAgICAgICB9IGVsc2UgaWYgKGRvdEdvYWwgPiAwLjUgJiYgZGlzdFRvR29hbCA8IDIwLjApIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAnU0gnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbWFydCBQYXNzIE92ZXJyaWRlCiAgICAgICAgICAgIGNvbnN0IHRhcmdldE1hdGUgPSB0aGlzLl9maW5kUGFzc1RhcmdldEluQ29uZShhaW1WZWMpOwogICAgICAgICAgICBpZiAodGFyZ2V0TWF0ZSAmJiB0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0TWF0ZSA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldE1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdE1hdGUgPCAxMi4wKSB0eXBlID0gJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgdHlwZSwgbXVsdGlwbGllciwgc3BpblZlYyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE5FVzogQ2hhcmdlIFVJIG1ldGhvZHMKICAgICAgICBfdXBkYXRlQ2hhcmdlVUkocmF0aW8pIHsKICAgICAgICAgICAgY29uc3QgbWV0ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhcmdlLW1ldGVyLWZpbGwnKTsKICAgICAgICAgICAgaWYgKG1ldGVyKSB7CiAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS53aWR0aCA9IGAke3JhdGlvICogMTAwfSVgOwogICAgICAgICAgICAgICAgaWYgKHJhdGlvID4gMC45KSB7CiAgICAgICAgICAgICAgICAgICAgbWV0ZXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAsICNmODApJzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmF0aW8gPiAwLjUpIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzBmMCwgI2ZmMCknOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzBhZiwgIzBmMCknOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIpIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlQ2hhcmdlVUkoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIpIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KCiAgICAgICAgc2V0T3ZlcnJpZGVBaW0oeCwgeikgewogICAgICAgICAgICBpZiAoIXRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yLnNldCh4LCAwLCB6KS5ub3JtYWxpemUoKTsKICAgICAgICB9Cgpsb3NlQmFsbCgpIHsKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwogICAgICAgICAgICAvLyBGaXg6IEVuc3VyZSBwbGF5ZXIgY2FuIGNhdGNoIGFnYWluIGlmIHRoZXkgbG9zZSBwb3NzZXNzaW9uIHVuZXhwZWN0ZWRseQogICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBzdGF0ZXMgdG8gcHJldmVudCBsb2NraW5nCiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyBTWU5DIEZJWDogSWYgYmFsbCB0aGlua3MgSSBob2xkIGl0LCBidXQgSSBkb24ndCwgZm9yY2UgcmVjZWl2ZQogICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmICYmIHRoaXMuYmFsbFJlZi5ob2xkZXIgPT09IHRoaXMgJiYgIXRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJTeW5jaW5nIGJhbGwgcG9zc2Vzc2lvbiB0byBwbGF5ZXIiKTsKICAgICAgICAgICAgICAgIHRoaXMucmVjZWl2ZUJhbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaXNHb2RNb2RlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gdGhpcy5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gdGhpcy5nZXRTdGF0KCdFTicpOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMudmVub20gPSAwOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBBbmltYXRpb246IGtlZXAgbG9jb21vdGlvbi9jaGFyZ2UgdXBkYXRlZCB1bmxlc3MgYSBvbmUtc2hvdCBpcyBsb2NraW5nIGFuaW1hdGlvbnMuCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CgoKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzKGR0KTsKCiAgICAgICAgICAgIC8vIENoYXJnZSBMb2dpYwovLyBDaGFyZ2UgTG9naWMKICAgICAgICAgICAgaWYgKHRoaXMuaXNDaGFyZ2luZykgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgfHwgdGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnNjYWxlLnNldFNjYWxhcih0aGlzLmJhc2VTY2FsZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CiAgICAgICAgICAgICAgICB9IGVsc2Ugewp0aGlzLmNoYXJnZVRpbWUgKz0gZHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQVVUTy1SRUxFQVNFOiBJZiBoZWxkIHRvbyBsb25nICgzcyksIGZvcmNlIHJlbGVhc2UgdG8gcHJldmVudCBzdHVjayBzdGF0ZQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJnZVRpbWUgPiAzLjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWxlYXNlQ2hhcmdlKDAsIDApOyAvLyBGb3JjZSB3ZWFrIHNob3QKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1pbih0aGlzLmNoYXJnZVRpbWUgLyB0aGlzLm1heENoYXJnZVRpbWUsIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gTGV2aXRhdGlvbiAoUG93ZXJpbmcgdXApCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaG92ZXIgPSAoTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDIpICogMC4xKSArIChyYXRpbyAqIDAuOCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVmlicmF0aW9uIChJbnRlbnNpdHkgaW5jcmVhc2VzIHdpdGggY2hhcmdlKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNoYWtlID0gMC4wNSArICgwLjEgKiByYXRpbyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQXBwbHkgWSBvZmZzZXQgKEhvdmVyICsgSml0dGVyKQogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gaG92ZXIgKyAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBcHBseSBSb3RhdGlvbiBKaXR0ZXIgKHZpYSBiYW5raW5nL3BpdGNoIHZhcmlhYmxlcykKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGF2b2lkcyBwb3NpdGlvbmFsIGRyaWZ0IHdoaWxlIGdpdmluZyBhICJzdHJ1Z2dsaW5nIHRvIGNvbnRhaW4gcG93ZXIiIGxvb2sKICAgICAgICAgICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5waXRjaEFtb3VudCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZTsKCiAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIHNjYWxlIHN0YXlzIG5vcm1hbCAoUmVtb3ZlIHN3ZWxsaW5nIGVmZmVjdCkKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0U2NhbGFyKHRoaXMuYmFzZVNjYWxlKTsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQ2hhcmdlVUkocmF0aW8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CmlmICh0aGlzLmRhc2hDb29sZG93biA+IDApIHRoaXMuZGFzaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5jbGFzaENvb2xkb3duID4gMCkgdGhpcy5jbGFzaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5zdHVuVGltZXIgPiAwKSB0aGlzLnN0dW5UaW1lciAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHRoaXMuaW1tdW5pdHlUaW1lciAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuY2F0Y2hDb29sZG93biA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhdGNoQ29vbGRvd24gPD0gMCkgdGhpcy5jYW5DYXRjaCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gRGFzaCBMb2dpYwovLyBEYXNoIExvZ2ljCiAgICAgICAgICAgIGlmICh0aGlzLmlzRGFzaGluZykgewogICAgICAgICAgICAgICAgdGhpcy5kYXNoVGltZSAtPSBkdDsKICAgICAgICAgICAgICAgIAp0aGlzLl9kYXNoUGFydGljbGVUaW1lciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9kYXNoUGFydGljbGVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZGFzaFBhcnRpY2xlVGltZXIgPSAwLjAxOyAvLyBJbmNyZWFzZWQgZGVuc2l0eSAod2FzIDAuMDMpCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhY2sgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCkubmVnYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYWNrLmxlbmd0aFNxKCkgPCAwLjEpIGJhY2suc2V0KDAsIDAsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3Bhd24gbXVsdGlwbGUgcGFydGljbGVzIHBlciB0aWNrIGZvciBhICJzdHJlYW0iCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDI7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKGJhY2subXVsdGlwbHlTY2FsYXIoMC41KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueSArPSAxLjAgKyAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2Rhc2hfc3RyZWFtJywgcG9zLCB7IHNjYWxlOiAyLjAgKyBNYXRoLnJhbmRvbSgpIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFNtb290aCBSb3RhdGlvbiBkdXJpbmcgRGFzaAogICAgICAgICAgICAgICAgbGV0IGRpZmYgPSB0aGlzLnRhcmdldFlhdyAtIHRoaXMuY3VycmVudFlhdzsKICAgICAgICAgICAgICAgIHdoaWxlIChkaWZmID4gTWF0aC5QSSkgZGlmZiAtPSBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIHdoaWxlIChkaWZmIDwgLU1hdGguUEkpIGRpZmYgKz0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHR1cm5TcGVlZCA9IDE1LjA7IC8vIEZhc3QgdHVybmluZyBmb3IgZGFzaAogICAgICAgICAgICAgICAgY29uc3QgY2hhbmdlID0gTWF0aC5tYXgoLXR1cm5TcGVlZCAqIGR0LCBNYXRoLm1pbih0dXJuU3BlZWQgKiBkdCwgZGlmZikpOwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ICs9IGNoYW5nZTsKCiAgICAgICAgICAgICAgICB0aGlzLl9jaGVja1RhY2tsZUNvbGxpc2lvbigpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXNoVGltZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXNoVHlwZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUeXBlID09PSAndmVydGljYWwnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5kYXNoVmVjKS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gMSAtICh0aGlzLmRhc2hUaW1lIC8gdGhpcy5kYXNoVG90YWxUaW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSBNYXRoLnNpbih0ICogTWF0aC5QSSkgKiAzLjA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCBEYXNoIE1vdmVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoZHQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIFRhY2tsZSBMZWFuIChTaG91bGRlciBCYXNoIEFuaW1hdGlvbikKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IDEgLSAodGhpcy5kYXNoVGltZSAvIHRoaXMuZGFzaFRvdGFsVGltZSk7IC8vIDAgdG8gMQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWFuID0gTWF0aC5zaW4odCAqIE1hdGguUEkpOyAvLyBQZWFrIGF0IDEuMCBpbiBtaWRkbGUKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlLWFwcGx5IGJhc2UgZmFjaW5nICsgQWdncmVzc2l2ZSBTaG91bGRlciBDaGVjawovLyBSZS1hcHBseSBiYXNlIGZhY2luZyArIEFnZ3Jlc3NpdmUgU2hvdWxkZXIgQ2hlY2sKICAgICAgICAgICAgICAgICAgICAgICAgX3BRdWF0LnNldEZyb21BeGlzQW5nbGUoX3BBeGlzWSwgdGhpcy5jdXJyZW50WWF3ICsgdGhpcy5yb3RhdGlvbk9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGl0Y2ggPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgeWF3ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJvbGwgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgbHVuZ2VBbXQgPSAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGFzaFR5cGUgPT09ICdob3Jpem9udGFsJyB8fCB0aGlzLmRhc2hUeXBlID09PSAnYnJlYWsnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVEFDS0xFL0JSRUFLOiBBZ2dyZXNzaXZlIFNob3VsZGVyIENoZWNrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGl0Y2ggPSAxLjIgKiBsZWFuOyAvLyBIZWFkIGRvd24gLyBMZWFuIGZvcndhcmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5YXcgPSAwLjggKiBsZWFuOyAgIC8vIFR1cm4gc2hvdWxkZXIgaW50byB0YXJnZXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb2xsID0gLTAuNiAqIGxlYW47IC8vIERpcCBzaG91bGRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGx1bmdlQW10ID0gMC44ICogbGVhbjsgLy8gVGhydXN0IG1lc2ggZm9yd2FyZCB2aXN1YWxseQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZGFzaFR5cGUgPT09ICdzcHJpbnQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU1BSSU5UOiBBZXJvZHluYW1pYyBsZWFuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGl0Y2ggPSAwLjUgKiBsZWFuOyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsdW5nZUFtdCA9IDAuMiAqIGxlYW47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFwcGx5IEx1bmdlIChWaXN1YWwgT2Zmc2V0KQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobHVuZ2VBbXQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIGx1bmdlQW10KS5hcHBseVF1YXRlcm5pb24oX3BRdWF0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgX3BFdWxlci5zZXQocGl0Y2gsIHlhdywgcm9sbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIF9wUXVhdDIuc2V0RnJvbUV1bGVyKF9wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseVF1YXRlcm5pb25zKF9wUXVhdCwgX3BRdWF0Mik7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOTYpOwoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjk2KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU3R1bi9OYXAgQ2hlY2sKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkcmFnRmFjdG9yID0gTWF0aC5tYXgoMCwgMSAtICgyLjAgKiBkdCkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihkcmFnRmFjdG9yKTsKCiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwoKICAgICAgICAgICAgICAgIGlmICghdGhpcy5fYW5pbUxvY2tlZCAmJiB0aGlzLnN0YXRlICE9PSAnaWRsZScgJiYgdGhpcy5zdGF0ZSAhPT0gJ2NhdGNoJykgdGhpcy5wbGF5KCdpZGxlJywgMC41KTsKCiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIUEJhcigpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVQcmVzc3VyZShkdCk7CgogICAgICAgICAgICBpZiAodGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICgyLjAgKiBkdCkpKTsKCiAgICAgICAgICAgICAgICB0aGlzLl9hcHBseVNvZnRDb2xsaXNpb24oZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlHb2FsQ3JlYXNlKGR0KTsKCiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwoKdGhpcy5fdXBkYXRlVmVydGljYWxpdHkoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQmFua2luZyhkdCk7IC8vIEVuYWJsZSByb3RhdGlvbiBkdXJpbmcgdGhyb3cKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZlcnRpY2FsaXR5KGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUJhbmtpbmcoZHQpOwogICAgICAgICAgICB9Cgp0aGlzLl91cGRhdGVIUEJhcigpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwoKICAgICAgICAgICAgLy8gQnViYmxlIFRyYWlsIExvZ2ljCi8vIEJ1YmJsZSBUcmFpbCBMb2dpYyAoRHluYW1pYykKICAgICAgICAgICAgY29uc3Qgc3BlZWRTcSA9IHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHNwZWVkU3EgPiAxLjAgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2J1YmJsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFja0RpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAxLiBTdGFuZGFyZCBXYWtlIChBbHdheXMgc3Bhd24pCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gYmFja0Rpci5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKDAuOCk7CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LnkgPSAwLjUgKyBNYXRoLnJhbmRvbSgpICogMC41OyAKICAgICAgICAgICAgICAgICAgICBvZmZzZXQueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgIG9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZScsIHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLCB7IHNjYWxlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMjUgfSk7CgogICAgICAgICAgICAgICAgICAgIC8vIDIuIENhdml0YXRpb24gKEhpZ2ggU3BlZWQpIC0gQWRkIG9uIHRvcAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzSGlnaFNwZWVkID0gc3BlZWRTcSA+IDQwLjA7IAogICAgICAgICAgICAgICAgICAgIGlmIChpc0hpZ2hTcGVlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1PZmZzZXQgPSBiYWNrRGlyLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC41ICsgTWF0aC5yYW5kb20oKSowLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC55ID0gMC41ICsgKE1hdGgucmFuZG9tKCktMC41KSowLjg7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlX21pY3JvJywgdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG1PZmZzZXQpLCB7IHNjYWxlOiAwLjA2ICsgTWF0aC5yYW5kb20oKSowLjA4IH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4wMzsgCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwLjE7IAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBQcm9jZWR1cmFsICdhbGl2ZScgcG9zZTogbG9vay9haW0vYmFsbC1ob2xkIG9mZnNldHMgKGFwcGxpZWQgYWZ0ZXIgbWl4ZXIgdXBkYXRlKQogICAgICAgICAgICB0aGlzLl9hcHBseVByb2NlZHVyYWxQb3NlKGR0KTsKCn0KCgpfYXBwbHlQcm9jZWR1cmFsUG9zZShkdCkgewogICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAvLyBBZHZhbmNlIGxvY2FsIHRpbWUgKHVzZWQgZm9yIHN1YnRsZSBzd2F5cykKICAgIHRoaXMuX3Byb2NBbmltVGltZSArPSBkdDsKCiAgICBjb25zdCBiID0gdGhpcy5ib25lczsKICAgIGlmICghYikgcmV0dXJuOwoKICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICBjb25zdCBiYWxsID0gKGdhbWUgJiYgZ2FtZS5lbnRpdGllcykgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwoKICAgIGxldCBzaG91bGRBcHBseSA9IGZhbHNlOwoKICAgIC8vIEJ1aWxkIGEgZGVzaXJlZCB3b3JsZC1zcGFjZSBkaXJlY3Rpb24gd2Ugd2FudCB0aGUgdG9yc28vaGVhZCB0byBiaWFzIHRvd2FyZC4KICAgIC8vIE5PVEU6IFdlIGFwcGx5IHRoaXMgQUZURVIgdGhlIGFuaW1hdGlvbiBtaXhlciBoYXMgcG9zZWQgYm9uZXMsIGFzIGEgc21hbGwgYWRkaXRpdmUgb2Zmc2V0LgogICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CgogICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgIC8vIEFpbSBkaXJlY3Rpb24gKHByZWZlciBleHBsaWNpdCBhaW0gdmVjdG9yKQogICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5vdmVycmlkZUFpbVZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmxvY2tlZEFpbVZlY3RvcikgewogICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMubG9ja2VkQWltVmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wOCkgewogICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMuaW5wdXRWZWN0b3IpLm5vcm1hbGl6ZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgIH0KICAgICAgICBzaG91bGRBcHBseSA9IHRydWU7CiAgICB9IGVsc2UgaWYgKGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgLy8gTG9vayBhdCB0aGUgYmFsbCBpZiBpdCdzIGluIHRoZSAiYXdhcmVuZXNzIiByYWRpdXMKICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICBpZiAoZGlzdCA8IDIwLjApIHsKICAgICAgICAgICAgX3BWZWMuc3ViVmVjdG9ycyhiYWxsLm1lc2gucG9zaXRpb24sIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIHNob3VsZEFwcGx5ID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKCFzaG91bGRBcHBseSkgcmV0dXJuOwoKICAgIC8vIENvbnZlcnQgdGhlIGRpcmVjdGlvbiBpbnRvIHRoZSBwbGF5ZXIncyBsb2NhbCBzcGFjZSBzbyB5YXcvcGl0Y2ggYXJlIHN0YWJsZS4KICAgIF9wSW52UXVhdC5jb3B5KHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5pbnZlcnQoKTsKICAgIF9wVmVjLmFwcGx5UXVhdGVybmlvbihfcEludlF1YXQpLm5vcm1hbGl6ZSgpOwoKICAgIGNvbnN0IGx4ID0gX3BWZWMueCwgbHkgPSBfcFZlYy55LCBseiA9IF9wVmVjLno7CiAgICBjb25zdCB5YXcgPSBNYXRoLmF0YW4yKGx4LCBseik7CiAgICBjb25zdCBwaXRjaCA9IE1hdGguYXRhbjIobHksIE1hdGguc3FydChseCAqIGx4ICsgbHogKiBseikgKyAxZS02KTsKCiAgICBjb25zdCB5YXdDID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHlhdywgLTAuOSwgMC45KTsKICAgIGNvbnN0IHBpdGNoQyA9IFRIUkVFLk1hdGhVdGlscy5jbGFtcChwaXRjaCwgLTAuNiwgMC42KTsKCiAgICBjb25zdCBzcGVlZE5vcm0gPSAodGhpcy5tYXhTcGVlZCA+IDAuMDAwMSkgPyBUSFJFRS5NYXRoVXRpbHMuY2xhbXAodGhpcy5fc21vb3RoZWRTcGVlZCAvIHRoaXMubWF4U3BlZWQsIDAsIDEpIDogMDsKICAgIGNvbnN0IGFpbVcgPSAodGhpcy5oYXNCYWxsID8gKHRoaXMuaXNDaGFyZ2luZyA/IDEuMCA6IDAuNjUpIDogMC4zNSkgKiAoMS4wIC0gMC4zNSAqIHNwZWVkTm9ybSk7CiAgICBjb25zdCBoZWFkVyA9ICh0aGlzLmhhc0JhbGwgPyAwLjU1IDogMC43NSkgKiAoMS4wIC0gMC4yNSAqIHNwZWVkTm9ybSk7CgogICAgLy8gVG9yc28gYmlhcyAoc3BpbmUvY2hlc3QpCiAgICBpZiAoYi5jaGVzdCkgewogICAgICAgIF9wVG1wRXVsZXIuc2V0KC1waXRjaEMgKiAwLjIwICogYWltVywgeWF3QyAqIDAuMzUgKiBhaW1XLCAwKTsKICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgIGIuY2hlc3QucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgfSBlbHNlIGlmIChiLnNwaW5lKSB7CiAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMTUgKiBhaW1XLCB5YXdDICogMC4yNSAqIGFpbVcsIDApOwogICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgYi5zcGluZS5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wVG1wUXVhdCk7CiAgICB9CgogICAgLy8gSGVhZC9uZWNrIGxvb2sKICAgIGlmIChiLm5lY2spIHsKICAgICAgICBfcFRtcEV1bGVyLnNldCgtcGl0Y2hDICogMC4yNSAqIGhlYWRXLCB5YXdDICogMC40NSAqIGhlYWRXLCAwKTsKICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgIGIubmVjay5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wVG1wUXVhdCk7CiAgICB9CiAgICBpZiAoYi5oZWFkKSB7CiAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMzAgKiBoZWFkVywgeWF3QyAqIDAuNTUgKiBoZWFkVywgMCk7CiAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICBiLmhlYWQucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgfQoKICAgIC8vIEJhbGwtaG9sZCAvIGFpbSBhcm0gcG9zZSAoa2VlcHMgInN3aW0iIGFuaW1hdGlvbiBidXQgcmVhZHMgYXMgaG9sZGluZy9haW1pbmcpCiAgICBpZiAodGhpcy5oYXNCYWxsICYmICF0aGlzLmlzVGhyb3dpbmcgJiYgIXRoaXMuX2FuaW1Mb2NrZWQpIHsKICAgICAgICBjb25zdCB0ID0gdGhpcy5fcHJvY0FuaW1UaW1lOwogICAgICAgIGNvbnN0IGxpZnQgPSBUSFJFRS5NYXRoVXRpbHMuY2xhbXAoMC4zNSArICh0aGlzLmlzQ2hhcmdpbmcgPyAwLjU1IDogMC4yNSkgLSBzcGVlZE5vcm0gKiAwLjIsIDAuMTUsIDAuOTUpOwogICAgICAgIGNvbnN0IHN3YXkgPSBNYXRoLnNpbih0ICogNS4wKSAqIDAuMDUgKiAoMC41ICsgbGlmdCk7CgogICAgICAgIGNvbnN0IHJhaXNlWCA9IC0wLjU1ICogbGlmdCArIHN3YXk7CiAgICAgICAgY29uc3QgcmFpc2VaID0gLTAuMjUgKiBsaWZ0OwoKICAgICAgICBpZiAoYi5yVXBwZXJBcm0pIHsKICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQocmFpc2VYLCB5YXdDICogMC4xMCAqIGxpZnQsIHJhaXNlWik7CiAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgIGIuclVwcGVyQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICB9CiAgICAgICAgaWYgKGIuckZvcmVBcm0pIHsKICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLTAuMzUgKiBsaWZ0ICsgc3dheSAqIDAuNSwgMCwgMCk7CiAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgIGIuckZvcmVBcm0ucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgIH0KCiAgICAgICAgLy8gQ291bnRlcmJhbGFuY2UgbGVmdCBhcm0gc2xpZ2h0bHkgZm9yIGEgbW9yZSBkeW5hbWljIHNpbGhvdWV0dGUKICAgICAgICBpZiAoYi5sVXBwZXJBcm0pIHsKICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoMC4xNSAqIGxpZnQsIC15YXdDICogMC4wNSAqIGxpZnQsIDAuMTUgKiBsaWZ0KTsKICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgYi5sVXBwZXJBcm0ucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgIH0KICAgIH0KfQoKCiAgICAgICAgX3VwZGF0ZVN0YXR1cyhkdCkgewogICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIgOiBudWxsOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnZlbm9tID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMudmVub20gLT0gZHQ7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IDUgKiBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQIDwgMCkgdGhpcy5zdGF0cy5IUCA9IDA7CgogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCd2ZW5vbScsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gPSAwLjE1OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgJiYgdGhpcy5zdGF0cy5IUCA8IHRoaXMuc3RhdHMubWF4SFApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQICs9IDUgKiBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA+IHRoaXMuc3RhdHMubWF4SFApIHRoaXMuc3RhdHMuSFAgPSB0aGlzLnN0YXRzLm1heEhQOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IDIuMCAqIGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPCAwKSB0aGlzLnN0YXRzLkhQID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLm5hcCAtPSBkdDsKCiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5uYXAgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMubmFwIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignbmFwJywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5uYXAgPSAwLjg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBpc1dpdGhlcmluZyA9IGZhbHNlOwogICAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5zdGF0dXMud2l0aGVyKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMud2l0aGVyW2tleV0gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMud2l0aGVyW2tleV0gLT0gZHQ7CiAgICAgICAgICAgICAgICAgICAgaXNXaXRoZXJpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNXaXRoZXJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLndpdGhlciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCd3aXRoZXInLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLndpdGhlciA9IDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmlzdWFscygpOwogICAgICAgIH0KCl91cGRhdGVWaXN1YWxzKCkgewogICAgICAgICAgICAvLyBSRU1PVkVEOiBZZWxsb3cgc3BoZXJlL3RpbnQgbG9naWMgYXMgcGVyIHJlcXVlc3QuCiAgICAgICAgICAgIC8vIEFsd2F5cyByZXZlcnQgdG8gYmFzZSBjb2xvci4KICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5mb3JFYWNoKGVudHJ5ID0+IHsKICAgICAgICAgICAgICAgIGVudHJ5Lm1hdGVyaWFsLmNvbG9yLmNvcHkoZW50cnkuYmFzZUNvbG9yKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfY3JlYXRlQXVyYSgpIHsKICAgICAgICAgICAgLy8gQXVyYSByZW1vdmVkIHBlciB1c2VyIHJlcXVlc3QKICAgICAgICAgICAgdGhpcy5hdXJhTWVzaCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IFBhc3MgdGFyZ2V0IGluZGljYXRvcgogICAgICAgIF9jcmVhdGVQYXNzVGFyZ2V0SW5kaWNhdG9yKCkgewogICAgICAgICAgICAvLyBDcmVhdGUgYSByaW5nIHRoYXQgaGlnaGxpZ2h0cyBwb3RlbnRpYWwgcGFzcyB0YXJnZXRzCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMC44LCAxLjAsIDE2KTsKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgICAgIGNvbG9yOiAweDAwZmYwMCwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yID0gbmV3IFRIUkVFLk1lc2goZ2VvLCBtYXQpOwogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3Iucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnBvc2l0aW9uLnkgPSAwLjE7CiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMucGFzc1RhcmdldEluZGljYXRvcik7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlUGFzc1RhcmdldEluZGljYXRvcnMoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8ICF0aGlzLnRlYW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGaW5kIGJlc3QgcGFzcyB0YXJnZXQKICAgICAgICAgICAgY29uc3QgYWltRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5fZmluZFBhc3NUYXJnZXRJbkNvbmUoYWltRGlyKTsKCiAgICAgICAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0Lm1lc2ggJiYgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueCA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLng7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueiA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLno7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci5yb3RhdGlvbi56ICs9IDAuMDU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpIHsKICAgICAgICAgICAgaWYgKHRoaXMucGFzc1RhcmdldEluZGljYXRvcikgewogICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9hcHBseVNvZnRDb2xsaXNpb24oZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2ggfHwgIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgdGVhbXMgPSBbZ2FtZS50ZWFtcy5ob21lLCBnYW1lLnRlYW1zLmF3YXldOwoKICAgICAgICAgICAgY29uc3QgcmVwdWxzaW9uUmFkaXVzID0gMC41OyAvLyBSZWR1Y2VkIHRvIDAuNSB0byBmaXggaW52aXNpYmxlIHdhbGwgaXNzdWVzCiAgICAgICAgICAgIGNvbnN0IHN0aWZmbmVzcyA9IDE1LjA7CgogICAgICAgICAgICB0ZWFtcy5mb3JFYWNoKHRlYW0gPT4gewogICAgICAgICAgICAgICAgaWYgKCF0ZWFtKSByZXR1cm47CiAgICAgICAgICAgICAgICB0ZWFtLnBsYXllcnMuZm9yRWFjaChvdGhlciA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG90aGVyID09PSB0aGlzIHx8ICFvdGhlci5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGR4ID0gdGhpcy5tZXNoLnBvc2l0aW9uLnggLSBvdGhlci5tZXNoLnBvc2l0aW9uLng7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHkgPSB0aGlzLm1lc2gucG9zaXRpb24ueSAtIG90aGVyLm1lc2gucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkeiA9IHRoaXMubWVzaC5wb3NpdGlvbi56IC0gb3RoZXIubWVzaC5wb3NpdGlvbi56OwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR5KmR5ICsgZHoqZHo7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWluRGlzdCA9IHJlcHVsc2lvblJhZGl1cyAqIDIuMDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IG1pbkRpc3QgKiBtaW5EaXN0ICYmIGRpc3RTcSA+IDAuMDAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG92ZXJsYXAgPSBtaW5EaXN0IC0gZGlzdDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gb3ZlcmxhcCAqIHN0aWZmbmVzczsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG54ID0gZHggLyBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBueSA9IGR5IC8gZGlzdDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbnogPSBkeiAvIGRpc3Q7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gbnggKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKz0gbnkgKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gbnogKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICB0aGlzLl9hcHBseVNvZnRDb2xsaXNpb24oZHQpOwogICAgICAgICAgICB0aGlzLl9hcHBseUdvYWxDcmVhc2UoZHQpOwoKICAgICAgICAgICAgY29uc3QgaW5wdXRMZW5TcSA9IHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKTsKICAgICAgICAgICAgY29uc3QgaXNJbnB1dEFjdGl2ZSA9IGlucHV0TGVuU3EgPiAwLjAxOwoKICAgICAgICAgICAgbGV0IGN1cnJlbnRNYXhTcGVlZCA9IHRoaXMubWF4U3BlZWQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTVFJVR0dMRSBTVEFURTogSGluZGVyIG1vdmVtZW50IGJhc2VkIG9uIHByZXNzdXJlCiAgICAgICAgICAgIC8vIEluc3RlYWQgb2YgYSBiaW5hcnkgMC44IG11bHRpcGxpZXIsIHdlIHNjYWxlIGJhc2VkIG9uIGludGVuc2l0eS4KICAgICAgICAgICAgLy8gTWF4IHN0cnVnZ2xlICgxLjApIHJlZHVjZXMgc3BlZWQgdG8gNDAlLgogICAgICAgICAgICBpZiAodGhpcy5zdHJ1Z2dsZUludGVuc2l0eSA+IDApIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRNYXhTcGVlZCAqPSAoMS4wIC0gKHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgKiAwLjYpKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgc2xpZ2h0IHJlZHVjdGlvbiBpZiBlbmdhZ2VkIGJ1dCBsb3cgcHJlc3N1cmUKICAgICAgICAgICAgICAgIGN1cnJlbnRNYXhTcGVlZCAqPSAwLjk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmlzQ2hhcmdpbmcpIGN1cnJlbnRNYXhTcGVlZCAqPSAwLjk7CgogICAgICAgICAgICBpZiAoaXNJbnB1dEFjdGl2ZSkgewogICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLmlucHV0VmVjdG9yKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSBTdHJ1Z2dsZSBKaXR0ZXIgdG8gZGlyZWN0aW9uCiAgICAgICAgICAgICAgICAvLyBTaW11bGF0ZXMgd3Jlc3RsaW5nIGZvciBjb250cm9sCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdHJ1Z2dsZUludGVuc2l0eSA+IDAuMykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGppdHRlciA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgKiAwLjg7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMueCArPSBqaXR0ZXI7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMueiArPSBqaXR0ZXI7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0VmVsWCA9IF9wVmVjLnggKiBjdXJyZW50TWF4U3BlZWQ7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRWZWxaID0gX3BWZWMueiAqIGN1cnJlbnRNYXhTcGVlZDsKCiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50U3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWRSYXRpbyA9IE1hdGgubWluKDEuMCwgY3VycmVudFNwZWVkIC8gdGhpcy5tYXhTcGVlZCk7CgogICAgICAgICAgICAgICAgLy8gQWdpbGl0eSBpcyByZWR1Y2VkIHdoZW4gc3RydWdnbGluZwogICAgICAgICAgICAgICAgbGV0IGFnaWxpdHkgPSBUSFJFRS5NYXRoVXRpbHMubGVycCgxMC4wLCAyLjAsIHNwZWVkUmF0aW8pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPiAwKSBhZ2lsaXR5ICo9IDAuNTsKCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gMS4wIC0gTWF0aC5wb3coMC4wMSwgZHQgKiBhZ2lsaXR5KTsKCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gKHRhcmdldFZlbFggLSB0aGlzLnZlbG9jaXR5LngpICogdDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiArPSAodGFyZ2V0VmVsWiAtIHRoaXMudmVsb2NpdHkueikgKiB0OwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJyYWtlRmFjdG9yID0gMi4wOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IDEuMCAtIE1hdGgucG93KDAuMSwgZHQgKiBicmFrZUZhY3Rvcik7CgogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9ICgwIC0gdGhpcy52ZWxvY2l0eS54KSAqIHQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gKDAgLSB0aGlzLnZlbG9jaXR5LnopICogdDsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMC4wMSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIHRoaXMudmVsb2NpdHkueSwgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSBNYXRoLm1heCgwLCAxLjAgLSAoMi4wICogZHQpKTsKCiAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoZHQpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVWZXJ0aWNhbGl0eShkdCkgewogICAgICAgICAgICBsZXQgdGFyZ2V0WSA9IDA7CgogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CgogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2ggJiYgIXRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvQmFsbCA8IDE1LjApIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRZID0gYmFsbC5tZXNoLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRhcmdldFkgPSAwLjU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHlEaWZmID0gdGFyZ2V0WSAtIHRoaXMubWVzaC5wb3NpdGlvbi55OwoKICAgICAgICAgICAgY29uc3QgbGlmdCA9IHlEaWZmICogMTAuMCAqIGR0OwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKz0gbGlmdDsKCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gucG9zaXRpb24ueSA+IDguMCkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSA4LjA7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLTAuNTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLm1lc2gucG9zaXRpb24ueSA8IC04LjApIHsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gLTguMDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSAtMC41OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBGSVhFRDogSW1wcm92ZWQgYmFua2luZyB3aXRoIGh5c3RlcmVzaXMgdG8gcHJldmVudCBmYWNpbmcgZmxpcHMKLy8gRklYRUQ6IEltcHJvdmVkIGJhbmtpbmcgd2l0aCBoeXN0ZXJlc2lzIHRvIHByZXZlbnQgZmFjaW5nIGZsaXBzCiAgICAgICAgX3VwZGF0ZUJhbmtpbmcoZHQpIHsKICAgICAgICAgICAgY29uc3QgaW5wdXRMZW5TcSA9IHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKTsKICAgICAgICAgICAgY29uc3QgdmVsTGVuU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CgogICAgICAgICAgICBsZXQgdGFyZ2V0WWF3ID0gdGhpcy50YXJnZXRZYXc7CiAgICAgICAgICAgIGxldCBzaG91bGRVcGRhdGVZYXcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDE6IEV4cGxpY2l0IEFpbSAoQWltIFN0aWNrIC8gU3dpcGUpCiAgICAgICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IueCwgdGhpcy5vdmVycmlkZUFpbVZlY3Rvci56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUFJJT1JJVFkgMjogTW92ZW1lbnQgSW5wdXQKICAgICAgICAgICAgZWxzZSBpZiAoaW5wdXRMZW5TcSA+IHRoaXMuZmFjaW5nRGVhZHpvbmUgKiB0aGlzLmZhY2luZ0RlYWR6b25lKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMuaW5wdXRWZWN0b3IueCwgdGhpcy5pbnB1dFZlY3Rvci56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDM6IFZlbG9jaXR5IChEcmlmdGluZykKICAgICAgICAgICAgZWxzZSBpZiAodmVsTGVuU3EgPiB0aGlzLmZhY2luZ0RlYWR6b25lICogdGhpcy5mYWNpbmdEZWFkem9uZSkgewogICAgICAgICAgICAgICAgdGFyZ2V0WWF3ID0gTWF0aC5hdGFuMih0aGlzLnZlbG9jaXR5LngsIHRoaXMudmVsb2NpdHkueik7CiAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGVZYXcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB3ZSBzaG91bGQgdXBkYXRlLCBkbyBzby4gT3RoZXJ3aXNlIGtlZXAgbGFzdCB2YWxpZCB5YXcKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZVlhdykgewogICAgICAgICAgICAgICAgdGhpcy5sYXN0VmFsaWRZYXcgPSB0YXJnZXRZYXc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSB0aGlzLmxhc3RWYWxpZFlhdzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU21vb3RoIFlhdyB3aXRoIHdyYXAtYXJvdW5kIGhhbmRsaW5nCiAgICAgICAgICAgIGxldCBkaWZmID0gdGFyZ2V0WWF3IC0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICB3aGlsZSAoZGlmZiA+IE1hdGguUEkpIGRpZmYgLT0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgIHdoaWxlIChkaWZmIDwgLU1hdGguUEkpIGRpZmYgKz0gTWF0aC5QSSAqIDI7CgogICAgICAgICAgICBjb25zdCBzcGVlZFJhdGlvID0gTWF0aC5taW4oMS4wLCB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpIC8gdGhpcy5tYXhTcGVlZCk7CmNvbnN0IHR1cm5TcGVlZCA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDguMCwgNC4wLCBzcGVlZFJhdGlvKTsgLy8gUmVkdWNlZCBmcm9tIDEyLjAvNi4wIHRvIHJlZHVjZSBmbGlwcGluZwoKICAgICAgICAgICAgLy8gUHJldmVudCBzdWRkZW4gc25hcHMgd2hlbiBkaWZmIGlzIHZlcnkgbGFyZ2UgKHRlbGVwb3J0L3Jlc2V0IHNjZW5hcmlvcykKICAgICAgICAgICAgY29uc3QgbWF4WWF3Q2hhbmdlID0gTWF0aC5QSSAqIGR0ICogdHVyblNwZWVkOwogICAgICAgICAgICBjb25zdCB5YXdDaGFuZ2UgPSBNYXRoLm1heCgtbWF4WWF3Q2hhbmdlLCBNYXRoLm1pbihtYXhZYXdDaGFuZ2UsIGRpZmYgKiBkdCAqIHR1cm5TcGVlZCkpOwoKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ICs9IHlhd0NoYW5nZTsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSB0YXJnZXRZYXc7CgogICAgICAgICAgICAvLyBCYW5raW5nCiAgICAgICAgICAgIGNvbnN0IGJhbmtTZW5zaXRpdml0eSA9IDAuODsKICAgICAgICAgICAgY29uc3QgbWF4QmFuayA9IDAuNzU7CgogICAgICAgICAgICBsZXQgdGFyZ2V0QmFuayA9IC1kaWZmICogYmFua1NlbnNpdGl2aXR5OwogICAgICAgICAgICB0YXJnZXRCYW5rID0gTWF0aC5tYXgoLW1heEJhbmssIE1hdGgubWluKG1heEJhbmssIHRhcmdldEJhbmspKTsKCiAgICAgICAgICAgIGNvbnN0IGJhbmtMZXJwID0gMS4wIC0gTWF0aC5wb3coMC4wMiwgZHQpOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgKz0gKHRhcmdldEJhbmsgLSB0aGlzLmJhbmtpbmdBbW91bnQpICogYmFua0xlcnA7CgogICAgICAgICAgICAvLyBQaXRjaAogICAgICAgICAgICBjb25zdCBwaXRjaFNlbnNpdGl2aXR5ID0gMC4xOwogICAgICAgICAgICBjb25zdCBtYXhQaXRjaCA9IDEuMDsKCiAgICAgICAgICAgIGxldCB0YXJnZXRQaXRjaCA9IC10aGlzLnZlbG9jaXR5LnkgKiBwaXRjaFNlbnNpdGl2aXR5OwogICAgICAgICAgICB0YXJnZXRQaXRjaCA9IE1hdGgubWF4KC1tYXhQaXRjaCwgTWF0aC5taW4obWF4UGl0Y2gsIHRhcmdldFBpdGNoKSk7CgogICAgICAgICAgICBjb25zdCBwaXRjaExlcnAgPSAxLjAgLSBNYXRoLnBvdygwLjA1LCBkdCk7CiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgKz0gKHRhcmdldFBpdGNoIC0gdGhpcy5waXRjaEFtb3VudCkgKiBwaXRjaExlcnA7CgogICAgICAgICAgICAvLyBBcHBseSBSb3RhdGlvbgogICAgICAgICAgICBjb25zdCBmaW5hbFlhdyA9IHRoaXMuY3VycmVudFlhdyArIHRoaXMucm90YXRpb25PZmZzZXQ7CgogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5zZXRGcm9tQXhpc0FuZ2xlKF9wQXhpc1ksIGZpbmFsWWF3KTsKCiAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDEsIDAsIDApLCB0aGlzLnBpdGNoQW1vdW50KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BRdWF0KTsKCiAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLCB0aGlzLmJhbmtpbmdBbW91bnQpOwogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseShfcFF1YXQpOwoKICAgICAgICAgICAgLy8gSWRsZSBCb2IKICAgICAgICAgICAgaWYgKHZlbExlblNxIDwgMC4xICYmICF0aGlzLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IERhdGUubm93KCkgKiAwLjAwMTU7CiAgICAgICAgICAgICAgICBjb25zdCBib2JQaXRjaCA9IE1hdGguc2luKHRpbWUpICogMC4wMzsKICAgICAgICAgICAgICAgIGNvbnN0IGJvYlJvbGwgPSBNYXRoLmNvcyh0aW1lICogMC43KSAqIDAuMDI7CgpfcEV1bGVyLnNldChib2JQaXRjaCwgMCwgYm9iUm9sbCk7CiAgICAgICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUV1bGVyKF9wRXVsZXIpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BRdWF0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9jaGVja1RhY2tsZVByZXNzdXJlKGR0KSB7CiAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNFbmdhZ2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIXRoaXMudGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CiAgICAgICAgICAgIGlmICghb3Bwb25lbnRUZWFtKSByZXR1cm47CgogICAgICAgICAgICBsZXQgdG90YWxQcmVzc3VyZSA9IDA7CiAgICAgICAgICAgIGxldCBlbmdhZ2VkQ291bnQgPSAwOwogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVSYWRpdXMgPSB0aGlzLnRhY2tsZVJhZGl1czsgCgogICAgICAgICAgICAvLyBGb3J3YXJkIHZlY3RvciBmb3Igc2hpZWxkaW5nIGNoZWNrCiAgICAgICAgICAgIF9wVmVjLmNvcHkoX3BBeGlzWikuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsgCgogICAgICAgICAgICBmb3IgKGNvbnN0IGVudGl0eSBvZiBvcHBvbmVudFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCB8fCBlbnRpdHkuc3RhdHVzLm5hcCA+IDAgfHwgZW50aXR5LnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oZW50aXR5Lm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCBlZmZlY3RpdmVSYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICBlbmdhZ2VkQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgUHJlc3N1cmUgSW50ZW5zaXR5ICgwIHRvIDEgYmFzZWQgb24gZGlzdGFuY2UpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJveGltaXR5ID0gMS4wIC0gKGRpc3QgLyBlZmZlY3RpdmVSYWRpdXMpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEJhc2UgUHJlc3N1cmUgZnJvbSBBVCBzdGF0CiAgICAgICAgICAgICAgICAgICAgbGV0IHByZXNzdXJlID0gZW50aXR5LmdldFN0YXQoJ0FUJykgKiBwcm94aW1pdHk7CgogICAgICAgICAgICAgICAgICAgIC8vIERpcmVjdGlvbmFsIFNoaWVsZGluZyAoQ29udGludW91cykKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b09wcCA9IGVudGl0eS5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZG90ID0gX3BWZWMuZG90KHRvT3BwKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJZiBvcHBvbmVudCBpcyBCRUhJTkQgKGRvdCA8IC0wLjIpLCBwcmVzc3VyZSBpcyByZWR1Y2VkIChTaGllbGRpbmcpCiAgICAgICAgICAgICAgICAgICAgbGV0IGlzU2hpZWxkZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoZG90IDwgLTAuMikgewogICAgICAgICAgICAgICAgICAgICAgICBwcmVzc3VyZSAqPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzU2hpZWxkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gVGVjaCBNb2RpZmllcnMgKENvbnRpbnVvdXMgYXBwbGljYXRpb24gY2hhbmNlKQogICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkudGVjaHMudGFja2xlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgZHQgKiAwLjUpIHRoaXMuYXBwbHlTdGF0dXMoJ3Zlbm9tJywgNS4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMS4yOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCBkdCAqIDAuNSkgdGhpcy5hcHBseVN0YXR1cygnd2l0aGVyJywgNS4wLCAnRU4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMS4yOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ2RyYWluJykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkcmFpbkFtdCA9IHByZXNzdXJlICogZHQgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gZHJhaW5BbXQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eS5zdGF0cy5IUCArPSBkcmFpbkFtdDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRvdGFsUHJlc3N1cmUgKz0gcHJlc3N1cmU7CgogICAgICAgICAgICAgICAgICAgIC8vIFZpc3VhbHM6IFNwYXJrcyBvY2Nhc2lvbmFsbHkgYmFzZWQgb24gcHJlc3N1cmUKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IGR0ICogNC4wICogcHJveGltaXR5KSB7IAogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuc3Bhd25DbGFzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWlkID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkubGVycChlbnRpdHkubWVzaC5wb3NpdGlvbiwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pZC55ICs9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuc3Bhd25DbGFzaChtaWQsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gT2NjYXNpb25hbCBTaGllbGQgVGV4dAogICAgICAgICAgICAgICAgICAgIGlmIChpc1NoaWVsZGVkICYmIE1hdGgucmFuZG9tKCkgPCBkdCAqIDEuMCAmJiBnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU0hJRUxEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiYmxvY2siKTsgLy8gVG9vIHNwYW1teSwgbWF5YmUganVzdCBzb3VuZCBsYXRlcgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5pc0VuZ2FnZWQgPSAoZW5nYWdlZENvdW50ID4gMCk7CgogICAgICAgICAgICBpZiAodGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5jb3VudGVyVGltZXIgKz0gZHQ7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgRU4gRHJhaW4gKENvbnRpbnVvdXMpCiAgICAgICAgICAgICAgICAvLyBTY2FsaW5nOiAyMCBBVCBwcmVzc3VyZSAtPiBhcHByb3ggMTAgRU4gbG9zdCBwZXIgc2Vjb25kCiAgICAgICAgICAgICAgICBjb25zdCBkcmFpblJhdGUgPSB0b3RhbFByZXNzdXJlICogMC41OyAKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOIC09IGRyYWluUmF0ZSAqIGR0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgU3RydWdnbGUgSW50ZW5zaXR5IGZvciBQaHlzaWNzICgwLjAgdG8gMS4wKQogICAgICAgICAgICAgICAgLy8gTWF4IHN0cnVnZ2xlIGF0IHJvdWdobHkgMzAgcHJlc3N1cmUKICAgICAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSBNYXRoLm1pbigxLjAsIHRvdGFsUHJlc3N1cmUgLyAzMC4wKTsKCiAgICAgICAgICAgICAgICAvLyBWaXN1YWwgRmVlZGJhY2sgZm9yIERyYWluIChBY2N1bXVsYXRlIHRvIGF2b2lkIHNwYW0pCiAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSArPSBkcmFpblJhdGUgKiBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSA+IDUuMCkgewogICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bihgLSR7TWF0aC5mbG9vcih0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSl9YCwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkRGFtYWdlID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSGludCBmb3IgcGxheWVyIGlmIGVuZ2FnZWQgdG9vIGxvbmcKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVuY291bnRlclRpbWVyID4gMS4wICYmIHRoaXMuZW5jb3VudGVyVGltZXIgPCAxLjEgJiYgdGhpcy50ZWFtLmlzSHVtYW4gJiYgdGhpcy50ZWFtLmFjdGl2ZVBsYXllciA9PT0gdGhpcykgewogICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJCUkVBSyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDw9IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuZnVtYmxlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9wZXJmb3JtSmVjaHRLbm9ja2JhY2soKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwoKICAgICAgICAgICAgaWYgKCFvcHBvbmVudFRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHJhbmdlID0gNi4wOwogICAgICAgICAgICBjb25zdCBmb3JjZSA9IDI1LjA7CgogICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJKRUNIVCBTSE9UISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImdvYWwiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgb3Bwb25lbnRUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ocC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBkaXIueSA9IDAuNTsKICAgICAgICAgICAgICAgICAgICBkaXIubm9ybWFsaXplKCk7CgpwLnZlbG9jaXR5LmFkZChkaXIubXVsdGlwbHlTY2FsYXIoZm9yY2UpKTsKCiAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAyLjA7IC8vIEVuc3VyZSB0aGV5IHN0YXkgZG93bgogICAgICAgICAgICAgICAgICAgIHAuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVhY3RBY3Rpb24gPSBwLmFjdGlvbnMgJiYgcC5hY3Rpb25zWydyZWFjdCddOwogICAgICAgICAgICAgICAgICAgIGlmIChyZWFjdEFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZWFjdEFjdGlvbi5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVhY3RBY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXlPbmVTaG90KCdyZWFjdCcsIDAuMSk7Cn0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2gnLCAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTTUFDSyEiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUudHJpZ2dlckltcGFjdCkgZ2FtZS50cmlnZ2VySW1wYWN0KDAuMTUsICdzaGF0dGVyJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVtYmxlKCkgewogICAgICAgICAgICBjb25zb2xlLmxvZygiRlVNQkxFISBFTiBEZXBsZXRlZC4iKTsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgdGhpcy5tZXNoKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDUkFTSCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zdHVuVGltZXIgPSAxLjU7CgogICAgICAgICAgICBjb25zdCBiYWNrRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgYmFja0Rpci54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgYmFja0Rpci56ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgYmFja0Rpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKGJhY2tEaXIubXVsdGlwbHlTY2FsYXIoMTIuMCkpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgaWYgKGJhbGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlamVjdERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKE1hdGgucmFuZG9tKCktMC41LCAwLjgsIE1hdGgucmFuZG9tKCktMC41KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBiYWxsLnNob290KGVqZWN0RGlyLCA2LjAsICdub25lJyk7CnRoaXMubG9zZUJhbGwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZGFzaCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzRGFzaGluZyB8fCB0aGlzLmRhc2hDb29sZG93biA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKCiAgICAgICAgICAgIC8vIE9GRkVOU0U6IEJSRUFLIFRBQ0tMRQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmIHRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjb3N0ID0gMTU7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkZBSUxFRCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mdW1ibGUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDIuMDsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnYnJlYWsnOwoKX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CnRoaXMudmVsb2NpdHkuYWRkKF9wVmVjLm11bHRpcGx5U2NhbGFyKDEwLjApKTsgLy8gTmVyZmVkIGZyb20gMTUuMCBmb3IgcmVhbGlzbQoKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW1JZCA9IHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CgogICAgICAgICAgICAgICAgb3Bwb25lbnRUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgdGhpcy50YWNrbGVSYWRpdXMgKiAxLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVzaERpciA9IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBwdXNoRGlyLnkgPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuYWRkKHB1c2hEaXIubXVsdGlwbHlTY2FsYXIoMTUuMCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2gnLCAwLjIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU1RVTiEiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJSRUFLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAovLyBORVc6IFNwYXduIEJyZWFrIEdseXBoIChFeHBsb3NpdmUgQnVyc3QpCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLmdseXBoTWFuYWdlci5zcGF3bignc3RhdHVzJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC41LAogICAgICAgICAgICAgICAgICAgICAgICByb3RhdGlvblNwZWVkOiA4LjAsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IDMuMCwKICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WTogMC41CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKLy8gUGFydGljbGUgQnVyc3QgKEJyZWFrIFRhY2tsZSkKICAgICAgICAgICAgICAgIGlmIChnYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIGdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCwgbGlmZTogMC4zIH0pOwogICAgICAgICAgICAgICAgICAgIGdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIHRoaXMubWVzaC5wb3NpdGlvbiwgeyBzY2FsZTogMi41IH0pOwogICAgICAgICAgICAgICAgICAgIC8vIEJ1YmJsZSBCdXJzdAogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDMwOyBpKyspIHsKY29uc3QgYlBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChfcFZlYy5zZXQoKE1hdGgucmFuZG9tKCktMC41KSwgMS4wKyhNYXRoLnJhbmRvbSgpLTAuNSksIChNYXRoLnJhbmRvbSgpLTAuNSkpKTsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgYlBvcywgeyBzY2FsZTogMC4yICsgTWF0aC5yYW5kb20oKSAqIDAuNCB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGdhbWUudHJpZ2dlckltcGFjdCkgZ2FtZS50cmlnZ2VySW1wYWN0KDAuMTUsICdoZWF2eScpOwoKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gT0ZGRU5TRTogU1BSSU5UCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNvc3QgPSA1OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIk5PIEVOISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDEuNTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnc3ByaW50JzsKCmNvbnN0IGJ1cnN0RGlyID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgaWYgKGJ1cnN0RGlyLmxlbmd0aFNxKCkgPCAwLjEpIGJ1cnN0RGlyLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwoKdGhpcy52ZWxvY2l0eS5hZGQoYnVyc3REaXIubXVsdGlwbHlTY2FsYXIoMTIuMCkpOyAvLyBOZXJmZWQgZnJvbSAxNS4wCgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgyMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkRBU0ghIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBERUZFTlNFOiBCTE9DSyAvIFRBQ0tMRQogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGxldCBpc0Jsb2NrQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA4LjAgJiYgYmFsbC5tZXNoLnBvc2l0aW9uLnkgPiAyLjUpIHsKICAgICAgICAgICAgICAgICAgICBpc0Jsb2NrQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5kYXNoVGltZSA9IHRoaXMuZGFzaFRvdGFsVGltZTsKICAgICAgICAgICAgdGhpcy5kYXNoQ29vbGRvd24gPSAxLjU7CgogICAgICAgICAgICBjb25zdCBsZW4gPSBNYXRoLnNxcnQoeCp4ICsgeip6KTsKICAgICAgICAgICAgY29uc3QgbnggPSAobGVuID4gMCkgPyB4L2xlbiA6IDA7CiAgICAgICAgICAgIGNvbnN0IG56ID0gKGxlbiA+IDApID8gei9sZW4gOiAwOwoKaWYgKGxlbiA+IDApIHsKICAgICAgICAgICAgICAgIC8vIFNtb290aCB0dXJuIGZvciBkYXNoIGluc3RlYWQgb2Ygc25hcAogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSBNYXRoLmF0YW4yKG54LCBueik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQmxvY2tDb250ZXh0KSB7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ3ZlcnRpY2FsJzsKCiAgICAgICAgICAgICAgICBjb25zdCBkaXJUb0JhbGwgPSBiYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGRpclRvQmFsbC55ID0gMDsKCiAgICAgICAgICAgICAgICBpZiAoZGlyVG9CYWxsLmxlbmd0aFNxKCkgPiAwLjAxKSB7CiAgICAgICAgICAgICAgICAgICAgZGlyVG9CYWxsLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZGFzaFZlYy5jb3B5KGRpclRvQmFsbCkubXVsdGlwbHlTY2FsYXIoOC4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXNoVmVjLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBjYXRjaEFjdGlvbiA9IHRoaXMuYWN0aW9uc1snY2F0Y2gnXTsKICAgICAgICAgICAgICAgIGlmIChjYXRjaEFjdGlvbikgewogICAgICAgICAgICAgICAgICAgIGNhdGNoQWN0aW9uLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgIGNhdGNoQWN0aW9uLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjYXRjaEFjdGlvbi50aW1lU2NhbGUgPSAxLjU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnBsYXkoJ2NhdGNoJywgMC4xKTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRlZmF1bHQiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ2hvcml6b250YWwnOwogICAgICAgICAgICAgICAgdGhpcy5faGFzSGl0VGFja2xlID0gZmFsc2U7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdmVsb2NpdHkgaW1wdWxzZSBpbiBkYXNoIGRpcmVjdGlvbgovLyBBcHBseSB2ZWxvY2l0eSBpbXB1bHNlIGluIGRhc2ggZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBfcFZlYy5zZXQobngsIDAsIG56KTsKICAgICAgICAgICAgICAgIGlmIChfcFZlYy5sZW5ndGhTcSgpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICB9CnRoaXMudmVsb2NpdHkuYWRkKF9wVmVjLm11bHRpcGx5U2NhbGFyKDE0LjApKTsgLy8gTmVyZmVkIGZyb20gMjAuMAoKICAgICAgICAgICAgICAgIGNvbnN0IGx1bmdlQWN0aW9uID0gdGhpcy5hY3Rpb25zWyd0aHJvdyddOwogICAgICAgICAgICAgICAgaWYgKGx1bmdlQWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgbHVuZ2VBY3Rpb24uc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICAgICAgbHVuZ2VBY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLnRpbWVTY2FsZSA9IDIuMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucGxheSgndGhyb3cnLCAwLjEpOwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCkgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QoMC4wNSwgJ2RlZmF1bHQnKTsKICAgICAgICAgICAgfQoKaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKDEwKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuMyk7IAogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIERhc2ggRWZmZWN0CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXNoUG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICBkYXNoUG9zLnkgKz0gMS4wOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgZGFzaFBvcywgeyBzY2FsZTogMS41LCBsaWZlOiAwLjMgfSk7CiAgICAgICAgICAgICAgICAvLyBTcGVlZCBsaW5lcwogICAgICAgICAgICAgICAgY29uc3QgYmFjayA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDM7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBkYXNoUG9zLmNsb25lKCkuYWRkKGJhY2subXVsdGlwbHlTY2FsYXIoTWF0aC5yYW5kb20oKSkpOwogICAgICAgICAgICAgICAgICAgIHAueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2Rhc2hfc3RyZWFtJywgcCwgeyBzY2FsZTogMS41IH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY3JlYXRlSFBCYXIoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IG5ldyBUSFJFRS5Hcm91cCgpOwoKICAgICAgICAgICAgY29uc3QgYmdHZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjIsIDAuMTUpOwogICAgICAgICAgICBjb25zdCBiZ01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwMDAwMCwgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgZGVwdGhUZXN0OiBmYWxzZSB9KTsKICAgICAgICAgICAgY29uc3QgYmcgPSBuZXcgVEhSRUUuTWVzaChiZ0dlbywgYmdNYXQpOwogICAgICAgICAgICBjb250YWluZXIuYWRkKGJnKTsKCiAgICAgICAgICAgIGNvbnN0IGZpbGxHZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjE2LCAwLjExKTsKICAgICAgICAgICAgZmlsbEdlby50cmFuc2xhdGUoMC41OCwgMCwgMCk7CiAgICAgICAgICAgIGNvbnN0IGZpbGxNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgwMGZmMDAsIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIGRlcHRoVGVzdDogZmFsc2UgfSk7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsID0gbmV3IFRIUkVFLk1lc2goZmlsbEdlbywgZmlsbE1hdCk7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsLnBvc2l0aW9uLnNldCgtMC41OCwgMCwgMC4wMSk7CiAgICAgICAgICAgIGNvbnRhaW5lci5hZGQodGhpcy5ocEJhckZpbGwpOwoKICAgICAgICAgICAgdGhpcy5ocEJhciA9IGNvbnRhaW5lcjsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5ocEJhcik7CiAgICAgICAgfQoKX3VwZGF0ZUhQQmFyKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaHBCYXIgfHwgIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gVmlzaWJpbGl0eSBDaGVjazogT25seSBzaG93IGluIEFjdGl2ZS9QcmFjdGljZSBzdGF0ZXMKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgYWxsb3dlZFN0YXRlID0gZ2FtZSAmJiAoZ2FtZS5zdGF0ZSA9PT0gJ2FjdGl2ZScgfHwgZ2FtZS5zdGF0ZSA9PT0gJ2tpY2tvZmYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghYWxsb3dlZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5ocEJhci5wb3NpdGlvbi5jb3B5KHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIHRoaXMuaHBCYXIucG9zaXRpb24ueSArPSAyLjI7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEpIHsKICAgICAgICAgICAgICAgIHRoaXMuaHBCYXIubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBwY3QgPSBNYXRoLm1heCgwLCB0aGlzLnN0YXRzLkhQIC8gdGhpcy5zdGF0cy5tYXhIUCk7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsLnNjYWxlLnNldFgocGN0KTsKCiAgICAgICAgICAgIGlmIChwY3QgPiAwLjUpIHRoaXMuaHBCYXJGaWxsLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweDAwZmYwMCk7CiAgICAgICAgICAgIGVsc2UgaWYgKHBjdCA+IDAuMjUpIHRoaXMuaHBCYXJGaWxsLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmZmYwMCk7CiAgICAgICAgICAgIGVsc2UgdGhpcy5ocEJhckZpbGwubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmYwMDAwKTsKCiAgICAgICAgICAgIC8vIEhpZGUgaWYgZnVsbCBIUCB0byByZWR1Y2UgY2x1dHRlciwgdW5sZXNzIGluIHByYWN0aWNlIG1vZGUKICAgICAgICAgICAgY29uc3QgYWx3YXlzU2hvdyA9IGdhbWUgJiYgZ2FtZS5nYW1lTW9kZSA9PT0gJ3ByYWN0aWNlJzsKICAgICAgICAgICAgdGhpcy5ocEJhci52aXNpYmxlID0gKHBjdCA8IDAuOTggfHwgYWx3YXlzU2hvdyk7CiAgICAgICAgfQoKICAgICAgICBnYWluRXhwKGFtb3VudCkgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSB8fCB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CgogICAgICAgICAgICB0aGlzLmV4cCArPSBhbW91bnQ7CgogICAgICAgICAgICBpZiAodGhpcy5leHAgPj0gdGhpcy5uZXh0TGV2ZWxFeHApIHsKICAgICAgICAgICAgICAgIHRoaXMubGV2ZWxVcCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsZXZlbFVwKCkgewogICAgICAgICAgICB0aGlzLmxldmVsKys7CiAgICAgICAgICAgIHRoaXMuZXhwIC09IHRoaXMubmV4dExldmVsRXhwOwogICAgICAgICAgICB0aGlzLm5leHRMZXZlbEV4cCA9IE1hdGguZmxvb3IodGhpcy5uZXh0TGV2ZWxFeHAgKiAxLjUpOwoKICAgICAgICAgICAgY29uc3Qga2V5cyA9IFsnSFAnLCAnRU4nLCAnQVQnLCAnUEEnLCAnQkwnLCAnU0gnLCAnQ0EnLCAnU1AnXTsKCiAgICAgICAgICAgIGNvbnN0IGhwR2FpbiA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDIwKSArIDEwOwogICAgICAgICAgICB0aGlzLnN0YXRzLm1heEhQICs9IGhwR2FpbjsKICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCA9IHRoaXMuc3RhdHMubWF4SFA7CgogICAgICAgICAgICBrZXlzLmZvckVhY2goayA9PiB7CiAgICAgICAgICAgICAgICBpZiAoayA9PT0gJ0hQJykgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPiAwLjQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnYWluID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMikgKyAxOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHNba10gKz0gZ2FpbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gcmVhY2hlZCBMZXZlbCAke3RoaXMubGV2ZWx9IWApOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgdGhpcy5tZXNoKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJMRVZFTCBVUCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jaGVja1RhY2tsZUNvbGxpc2lvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW0gfHwgdGhpcy5faGFzSGl0VGFja2xlKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwoKICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3Bwb25lbnRUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG9wcC5tZXNoLnBvc2l0aW9uKTsKCmlmIChkaXN0IDwgMy4wKSB7IC8vIEluY3JlYXNlZCBmcm9tIDIuMCBmb3IgZWFzaWVyIGhpdHMKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNvbHZlVGFja2xlSGl0KG9wcCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGFzSGl0VGFja2xlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9yZXNvbHZlVGFja2xlSGl0KG9wcCkgewogICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKC0wLjUpOwogICAgICAgICAgICB0aGlzLnBsYXkoJ2lkbGUnLCAwLjIpOwoKICAgICAgICAgICAgY29uc3QgYXQgPSB0aGlzLmdldFN0YXQoJ0FUJyk7CiAgICAgICAgICAgIGxldCBkYW1hZ2UgPSBhdCAqIDMuMDsKCiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnRhY2tsZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgb3BwLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDEwLjApOwogICAgICAgICAgICAgICAgZGFtYWdlICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50ZWNocy50YWNrbGUgPT09ICd3aXRoZXInKSB7CiAgICAgICAgICAgICAgICBvcHAuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDEwLjAsICdFTicpOwogICAgICAgICAgICAgICAgZGFtYWdlICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50ZWNocy50YWNrbGUgPT09ICdkcmFpbicpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgKz0gMjA7CiAgICAgICAgICAgICAgICBvcHAuc3RhdHMuSFAgLT0gMjA7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJEUkFJTiIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBvcHAuY3VycmVudEVOIC09IGRhbWFnZTsKCmlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUmVtb3ZlZCAiRU4iIHN1ZmZpeCBmb3IgY2xlYW5lciBsb29rCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgJHtNYXRoLmZsb29yKGRhbWFnZSl9YCwgb3BwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCQU0hIiwgb3BwLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAob3BwLmN1cnJlbnRFTiA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgb3BwLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBvcHAuc3R1blRpbWVyID0gMC41OwogICAgICAgICAgICAgICAgICAgIG9wcC5wbGF5T25lU2hvdCgncmVhY3QnLCAwLjEpOwp9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMudGFja2xlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQodGhpcywgdGhpcy50ZWNocy50YWNrbGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG9wcC5zdHVuVGltZXIgPSAxLjA7CiAgICAgICAgICAgICAgICBvcHAucGxheU9uZVNob3QoJ3JlYWN0JywgMC4xKTsKaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTTUFDSyEiLCBvcHAubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBwdXNoRGlyID0gb3BwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgcHVzaERpci55ID0gMC4yOwogICAgICAgICAgICBvcHAudmVsb2NpdHkuYWRkKHB1c2hEaXIubXVsdGlwbHlTY2FsYXIoMTIuMCkpOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjEsICdoZWF2eScpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuOCk7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaCkgewpjb25zdCBtaWQgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQob3BwLm1lc2gucG9zaXRpb24pLm11bHRpcGx5U2NhbGFyKDAuNSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaChtaWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAovLyBCdWJibGUgQnVyc3QgKFRhY2tsZSBIaXQpCi8vIEJ1YmJsZSBCdXJzdCAoVGFja2xlIEhpdCkKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG1pZCA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmxlcnAob3BwLm1lc2gucG9zaXRpb24sIDAuNSk7CiAgICAgICAgICAgICAgICBtaWQueSArPSAxLjA7CiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzMDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYnViYmxlUG9zID0gbWlkLmNsb25lKCkuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKChNYXRoLnJhbmRvbSgpLTAuNSkqMS41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjEuNSwgKE1hdGgucmFuZG9tKCktMC41KSoxLjUpKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBidWJibGVQb3MsIHsgc2NhbGU6IDAuMTUgKyBNYXRoLnJhbmRvbSgpICogMC4zNSB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5R29hbENyZWFzZShkdCkgewoKICAgICAgICAgICAgY29uc3QgZ29hbHMgPSBbCgogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgNDYpLAogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgLTQ2KQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gMTAuMDsKCiAgICAgICAgICAgIGdvYWxzLmZvckVhY2goZ29hbCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBkeCA9IHRoaXMubWVzaC5wb3NpdGlvbi54IC0gZ29hbC54OwogICAgICAgICAgICAgICAgY29uc3QgZHogPSB0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWwuejsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IGR4KmR4ICsgZHoqZHo7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IHJhZGl1cyAqIHJhZGl1cykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZGlzdFNxKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWCA9IGRpc3QgPiAwID8gZHggLyBkaXN0IDogMTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWiA9IGRpc3QgPiAwID8gZHogLyBkaXN0IDogMDsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSA1MC4wOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSBwdXNoWCAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9IHB1c2haICogZm9yY2UgKiBkdDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByYWRpdXMgLSAwLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xhbXBSYXRpbyA9IHJhZGl1cyAvIChkaXN0ICsgMC4wMDEpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueCA9IGdvYWwueCArIGR4ICogY2xhbXBSYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSBnb2FsLnogKyBkeiAqIGNsYW1wUmF0aW87CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguUGxheWVyID0gUGxheWVyOwp9KSgpOwo=","./Player.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBCYWxsIExhYiAvIERldlRvb2xzOiB0aHJvdyAmIGN1cnZlIG1hcHBpbmcga25vYnMKICAgIC8vIChEZWZhdWx0cyBtYXRjaCBjdXJyZW50IGZlZWw7IERldlRvb2xzIGNhbiB0d2VhayBhdCBydW50aW1lLikKICAgIHdpbmRvdy5mbHV4LlRocm93Q29uZmlnID0gd2luZG93LmZsdXguVGhyb3dDb25maWcgfHwgewogICAgICAgIFNXSVBFX01JTl9QWDogMjAsCiAgICAgICAgQUlNX0RYX1NDQUxFOiAxLjAsCiAgICAgICAgQUlNX0RZX1NDQUxFOiAxLjAsCgogICAgICAgIFBPV0VSX0JBU0U6IDEuMCwKICAgICAgICBQT1dFUl9SQU5HRTogMC44LCAgICAgICAgICAvLyBCYXNlIG11bHRpcGxpZXIgPSBQT1dFUl9CQVNFICsgcmF0aW8qUE9XRVJfUkFOR0UKICAgICAgICBQT1dFUl9NQVhfQk9OVVNfUkFUSU86IDAuOTUsCiAgICAgICAgUE9XRVJfTUFYX01VTFRJUExJRVI6IDIuNSwKCiAgICAgICAgQ1VSVkVfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBDVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEOiAwLjI1LAogICAgICAgIENVUlZFX1NQSU5fU0NBTEU6IDEwMDAuMCwKICAgICAgICBDVVJWRV9TUEVFRF9NVUxUOiAxLjUsCiAgICAgICAgQ1VSVkVfU1BJTl9DQVA6IDE1MDAuMCwKICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDUwMC4wCiAgICB9OwoKLy8gUmV1c2FibGUgbWF0aCBvYmplY3RzCmNvbnN0IF9wVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9wVmVjMiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfcFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BRdWF0MiA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRhcmdldFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BFdWxlciA9IG5ldyBUSFJFRS5FdWxlcigpOwogICAgY29uc3QgX3BBeGlzWSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApOwogICAgY29uc3QgX3BBeGlzWiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpOwogICAgY29uc3QgX3BJbnZRdWF0ID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgIGNvbnN0IF9wVG1wUXVhdCA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRtcEV1bGVyID0gbmV3IFRIUkVFLkV1bGVyKCk7CgoKY2xhc3MgUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSA9ICdNRicpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLnJvbGUgPSByb2xlOwogICAgICAgICAgICB0aGlzLnRlYW0gPSBudWxsOyAvLyBBc3NpZ25lZCBieSBUZWFtLmFkZFBsYXllcgogICAgICAgICAgICB0aGlzLmhvbWVQb3NpdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLm1peGVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hY3Rpb25zID0ge307CiAgICAgICAgICAgIHRoaXMuYWN0aXZlQWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdpZGxlJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2xhc3RMb2NvbW90aW9uID0gJ2lkbGUnOwp0aGlzLmlucHV0VmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAvLyBQaHlzaWNzIChEcmlmdC9JbmVydGlhIE1vZGVsKQogICAgICAgICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYWNjZWxlcmF0aW9uID0gMTIuMDsKICAgICAgICAgICAgdGhpcy5kcmFnID0gMy4wOwogICAgICAgICAgICB0aGlzLm1heFNwZWVkID0gOC4wOwogICAgICAgICAgICAvLyBCb25lIHJlZmVyZW5jZSBmb3IgaG9sZGluZyBiYWxsCiAgICAgICAgICAgIHRoaXMuaGFuZEJvbmUgPSBudWxsOwovLyBQcm9jZWR1cmFsIGFuaW1hdGlvbiBib25lIHJlZnMgKGZpbGxlZCBpbiBzZXRNZXNoKQp0aGlzLmJvbmVzID0gewogICAgaGlwczogbnVsbCwKICAgIHNwaW5lOiBudWxsLAogICAgY2hlc3Q6IG51bGwsCiAgICBuZWNrOiBudWxsLAogICAgaGVhZDogbnVsbCwKICAgIHJVcHBlckFybTogbnVsbCwKICAgIHJGb3JlQXJtOiBudWxsLAogICAgckhhbmQ6IG51bGwsCiAgICBsVXBwZXJBcm06IG51bGwsCiAgICBsRm9yZUFybTogbnVsbCwKICAgIGxIYW5kOiBudWxsCn07CnRoaXMuX2JvbmVCYXNlUXVhdHMgPSBudWxsOyAvLyBPcHRpb25hbCBmdXR1cmUgdXNlCnRoaXMuX3Byb2NBbmltVGltZSA9IDA7CnRoaXMuX3Ntb290aGVkU3BlZWQgPSAwOwp0aGlzLl9tb3ZpbmdMYXRjaCA9IGZhbHNlOwoKdGhpcy5jYW5DYXRjaCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2F0Y2hDb29sZG93biA9IDA7IC8vIFJlcGxhY2VzIHNldFRpbWVvdXQgZm9yIHNhZmV0eQoKICAgICAgICAgICAgLy8gQmxpdHpiYWxsIFN0YXRzCiAgICAgICAgICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLAogICAgICAgICAgICAgICAgbWF4SFA6IDEwMCwKICAgICAgICAgICAgICAgIEVOOiAzMCwKICAgICAgICAgICAgICAgIEFUOiAxMCwKICAgICAgICAgICAgICAgIFBBOiAxNSwKICAgICAgICAgICAgICAgIEJMOiAxMCwKICAgICAgICAgICAgICAgIFNIOiAxNSwKICAgICAgICAgICAgICAgIENBOiAxMCwKICAgICAgICAgICAgICAgIFNQOiA2MAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gTGV2ZWxpbmcgU3lzdGVtCiAgICAgICAgICAgIHRoaXMubGV2ZWwgPSAxOwogICAgICAgICAgICB0aGlzLmV4cCA9IDA7CiAgICAgICAgICAgIHRoaXMubmV4dExldmVsRXhwID0gMTAwOwoKICAgICAgICAgICAgLy8gU3RhdHVzIEVmZmVjdHMgJiBUZWNobmlxdWVzCiAgICAgICAgICAgIHRoaXMuc3RhdHVzID0gewogICAgICAgICAgICAgICAgdmVub206IDAsCiAgICAgICAgICAgICAgICBuYXA6IDAsCiAgICAgICAgICAgICAgICB3aXRoZXI6IHsgUEE6IDAsIFNIOiAwLCBBVDogMCwgQkw6IDAsIENBOiAwLCBTUDogMCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLm1hcmtpbmcgPSBudWxsOwogICAgICAgICAgICB0aGlzLmxlYXJuZWRUZWNocyA9IFtdOwoKICAgICAgICAgICAgdGhpcy50ZWNocyA9IHsKICAgICAgICAgICAgICAgIHRhY2tsZTogbnVsbCwKICAgICAgICAgICAgICAgIHNob290OiBudWxsLAogICAgICAgICAgICAgICAgcGFzczogbnVsbCwKICAgICAgICAgICAgICAgIHBhc3NpdmU6IG51bGwKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFZpc3VhbHMKICAgICAgICAgICAgdGhpcy5iYXNlQ29sb3JIZXggPSAweGZmZmZmZjsKICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscyA9IFtdOwogICAgICAgICAgICB0aGlzLmF1cmFNZXNoID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5yb3RhdGlvbk9mZnNldCA9IDA7CnRoaXMuYmFzZVNjYWxlID0gMS4xNzsgLy8gSW5jcmVhc2VkIH44JQoKICAgICAgICAgICAgLy8gUmVhbC10aW1lIFN0YXRzCiAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gdGhpcy5zdGF0cy5FTjsKdGhpcy50YWNrbGVSYWRpdXMgPSAyLjA7IC8vIFJlZHVjZWQgZnJvbSAyLjUgdG8gcmVkdWNlIHN3YXJtIGxvY2sKCiAgICAgICAgICAgIHRoaXMuc3BlZWQgPSA0LjA7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gRGFzaCBTdGF0ZQogICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5kYXNoVG90YWxUaW1lID0gMC41Owp0aGlzLmRhc2hDb29sZG93biA9IDA7CiAgICAgICAgICAgIHRoaXMuZGFzaFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBGZWVkYmFjayBBY2N1bXVsYXRvcnMKICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UgPSAwOwogICAgICAgICAgICB0aGlzLl9kYW1hZ2VUaW1lciA9IDA7CgogICAgICAgICAgICAvLyBIUCBCYXIKICAgICAgICAgICAgdGhpcy5ocEJhciA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsID0gbnVsbDsKCiAgICAgICAgICAgIC8vIEdhbWVwbGF5IEZsb3cgVGltZXJzCiAgICAgICAgICAgIHRoaXMuc3R1blRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMDsKCiAgICAgICAgICAgIC8vIEJhbmtpbmcgJiBWZXJ0aWNhbGl0eQogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLnRhcmdldFkgPSAwOwoKICAgICAgICAgICAgLy8gRW5jb3VudGVyIFN5c3RlbQogICAgICAgICAgICB0aGlzLmlzRW5nYWdlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNsYXNoVGltZXIgPSAwOwoKICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7IC8vIFRyYWNrIGR1cmF0aW9uIG9mIGN1cnJlbnQgZW5nYWdlbWVudAogICAgICAgICAgICAvLyBDaGFyZ2UgTWVjaGFuaWMKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4Q2hhcmdlVGltZSA9IDEuNTsKCiAgICAgICAgICAgIC8vIEZJWEVEOiBJbXByb3ZlZCBSb3RhdGlvbiBTdGF0ZSB3aXRoIGh5c3RlcmVzaXMKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gMDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLmxhc3RWYWxpZFlhdyA9IDA7IC8vIFN0b3JlIGxhc3Qga25vd24gZ29vZCB5YXcgZm9yIGRlYWR6b25lIGhhbmRsaW5nCiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmZhY2luZ0RlYWR6b25lID0gMC4zOyAvLyBNaW5pbXVtIGlucHV0L3ZlbG9jaXR5IG1hZ25pdHVkZSB0byB1cGRhdGUgZmFjaW5nCgogICAgICAgICAgICAvLyBQYXJ0aWNsZSBFbWlzc2lvbiBUaW1lcnMKICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMgPSB7CiAgICAgICAgICAgICAgICB2ZW5vbTogMCwKICAgICAgICAgICAgICAgIG5hcDogMCwKICAgICAgICAgICAgICAgIHdpdGhlcjogMAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gRGV2VG9vbHMgRmxhZ3MKICAgICAgICAgICAgdGhpcy5pc0dvZE1vZGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBhc3MgVGFyZ2V0IEluZGljYXRvcgovLyBQYXNzIFRhcmdldCBJbmRpY2F0b3IKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yID0gbnVsbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJ1YmJsZSBUcmFpbCBUaW1lcgogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDA7Cgp0aGlzLl9kYXNoUGFydGljbGVUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSAwOyAvLyBDb250aW51b3VzIHByZXNzdXJlIGZhY3RvciAoMC4wIHRvIDEuMCkKICAgICAgICB9CgogICAgICAgIHN5bmNSb3RhdGlvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgZXVsZXIgPSBuZXcgVEhSRUUuRXVsZXIoKS5zZXRGcm9tUXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbiwgJ1lYWicpOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgPSBldWxlci55IC0gdGhpcy5yb3RhdGlvbk9mZnNldDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgIHRoaXMubGFzdFZhbGlkWWF3ID0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ID0gMDsKICAgICAgICB9CgogICAgICAgIGdldFN0YXQobmFtZSkgewogICAgICAgICAgICBsZXQgdmFsID0gdGhpcy5zdGF0c1tuYW1lXTsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltuYW1lXSA+IDApIHsKICAgICAgICAgICAgICAgIHZhbCAqPSAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICB9CgogICAgICAgIGFwcGx5U3RhdHVzKHR5cGUsIGR1cmF0aW9uLCBzdWJUeXBlID0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMudmVub20gPiAxLjA7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy52ZW5vbSA9IE1hdGgubWF4KHRoaXMuc3RhdHVzLnZlbm9tLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnJvbGV9IHBvaXNvbmVkIWApOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQT0lTT04iLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMubmFwID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gTWF0aC5tYXgodGhpcy5zdGF0dXMubmFwLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gZmVsbCBhc2xlZXAhYCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNMRUVQIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3dpdGhlcicgJiYgc3ViVHlwZSkgewogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFZhbCA9IHRoaXMuc3RhdHVzLndpdGhlcltzdWJUeXBlXSB8fCAwOwogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gY3VycmVudFZhbCA+IDEuMDsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLndpdGhlcltzdWJUeXBlXSA9IE1hdGgubWF4KGN1cnJlbnRWYWwsIGR1cmF0aW9uKTsKCiAgICAgICAgICAgICAgICBpZiAoIXdhc0FjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gd2l0aGVyZWQgJHtzdWJUeXBlfSFgKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgV0lUSEVSICR7c3ViVHlwZX1gLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZURlcml2ZWRTdGF0cygpIHsKICAgICAgICAgICAgY29uc3Qgc3AgPSB0aGlzLmdldFN0YXQoJ1NQJyk7CiAgICAgICAgICAgIHRoaXMubWF4U3BlZWQgPSA1LjAgKyAoc3AgLyAxNS4wKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSB0aGlzLmdldFN0YXQoJ0VOJyk7CiAgICAgICAgfQoKc2V0TWVzaChzb3VyY2VNZXNoLCBhbmltYXRpb25zKSB7CiAgICAgICAgICAgIHRoaXMubWVzaCA9IHNvdXJjZU1lc2g7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUhQQmFyKCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUF1cmEoKTsKICAgICAgICAgICAgdGhpcy5fY3JlYXRlUGFzc1RhcmdldEluZGljYXRvcigpOwoKICAgICAgICAgICAgLy8gQ3VzdG9tIENoYXJhY3RlciBTY2FsaW5nCiAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUuaW5jbHVkZXMoJ1RpZHVzJykpIHRoaXMuYmFzZVNjYWxlID0gMS42OwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB0aGlzLmJhc2VTY2FsZSA9IDEuNDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXNoLnNjYWxlLnNldFNjYWxhcih0aGlzLmJhc2VTY2FsZSk7CgogICAgICAgICAgICB0aGlzLm1lc2gudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCAmJiBub2RlLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udmVydE9uZSA9IChtYXQpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXA6IG1hdC5tYXAgfHwgbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBuZXcgVEhSRUUuQ29sb3IoMHhmZmZmZmYpLCAvLyBGT1JDRSBXSElURTogSWdub3JlIHNvdXJjZSBjb2xvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6ICEhbWF0LnRyYW5zcGFyZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogKG1hdC5vcGFjaXR5ICE9PSB1bmRlZmluZWQgPyBtYXQub3BhY2l0eSA6IDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxwaGFUZXN0OiAobWF0LmFscGhhVGVzdCAhPT0gdW5kZWZpbmVkID8gbWF0LmFscGhhVGVzdCA6IDApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2lkZTogbWF0LnNpZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IG1hdC5kZXB0aFRlc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBtYXQuZGVwdGhXcml0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNraW5uaW5nOiAhIW5vZGUuaXNTa2lubmVkTWVzaAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5wdXNoKHsgbWF0ZXJpYWw6IG0sIGJhc2VDb2xvcjogbS5jb2xvci5jbG9uZSgpIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBBcnJheS5pc0FycmF5KG5vZGUubWF0ZXJpYWwpCiAgICAgICAgICAgICAgICAgICAgICAgID8gbm9kZS5tYXRlcmlhbC5tYXAoY29udmVydE9uZSkKICAgICAgICAgICAgICAgICAgICAgICAgOiBjb252ZXJ0T25lKG5vZGUubWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzQm9uZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSAobm9kZS5uYW1lIHx8ICcnKS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBDb3JlIHNwaW5lL2hlYWQgY2hhaW4gKE1peGFtby1mcmllbmRseSkKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuaGlwcyAmJiBuYW1lLmluY2x1ZGVzKCdoaXBzJykpIHRoaXMuYm9uZXMuaGlwcyA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLnNwaW5lICYmIG5hbWUuaW5jbHVkZXMoJ3NwaW5lJykgJiYgIW5hbWUuaW5jbHVkZXMoJ3NwaW5lMicpICYmICFuYW1lLmluY2x1ZGVzKCdzcGluZV8yJykpIHRoaXMuYm9uZXMuc3BpbmUgPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5jaGVzdCAmJiAobmFtZS5pbmNsdWRlcygnY2hlc3QnKSB8fCBuYW1lLmluY2x1ZGVzKCdzcGluZTInKSB8fCBuYW1lLmluY2x1ZGVzKCdzcGluZV8yJykpKSB0aGlzLmJvbmVzLmNoZXN0ID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubmVjayAmJiBuYW1lLmluY2x1ZGVzKCduZWNrJykpIHRoaXMuYm9uZXMubmVjayA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmhlYWQgJiYgbmFtZS5pbmNsdWRlcygnaGVhZCcpKSB0aGlzLmJvbmVzLmhlYWQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1JpZ2h0ID0gbmFtZS5pbmNsdWRlcygncmlnaHQnKSB8fCBuYW1lLmVuZHNXaXRoKCdyJykgfHwgbmFtZS5pbmNsdWRlcygnX3InKSB8fCBuYW1lLmluY2x1ZGVzKCcucicpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzTGVmdCAgPSBuYW1lLmluY2x1ZGVzKCdsZWZ0JykgIHx8IG5hbWUuZW5kc1dpdGgoJ2wnKSB8fCBuYW1lLmluY2x1ZGVzKCdfbCcpIHx8IG5hbWUuaW5jbHVkZXMoJy5sJyk7CgogICAgICAgICAgICAgICAgICAgIC8vIEFybXMvaGFuZHMgKE1peGFtbzogbWl4YW1vcmlnUmlnaHRBcm0vUmlnaHRGb3JlQXJtL1JpZ2h0SGFuZCkKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuclVwcGVyQXJtICYmIChuYW1lLmluY2x1ZGVzKCdyaWdodGFybScpIHx8IChpc1JpZ2h0ICYmIG5hbWUuaW5jbHVkZXMoJ3VwcGVyYXJtJykpKSkgdGhpcy5ib25lcy5yVXBwZXJBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5yRm9yZUFybSAmJiAobmFtZS5pbmNsdWRlcygncmlnaHRmb3JlYXJtJykgfHwgKGlzUmlnaHQgJiYgbmFtZS5pbmNsdWRlcygnZm9yZWFybScpKSkpIHRoaXMuYm9uZXMuckZvcmVBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5ySGFuZCAmJiAoKG5hbWUuaW5jbHVkZXMoJ2hhbmQnKSAmJiBpc1JpZ2h0KSB8fCBuYW1lLmluY2x1ZGVzKCdyaWdodGhhbmQnKSkpIHRoaXMuYm9uZXMuckhhbmQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubFVwcGVyQXJtICYmIChuYW1lLmluY2x1ZGVzKCdsZWZ0YXJtJykgfHwgKGlzTGVmdCAmJiBuYW1lLmluY2x1ZGVzKCd1cHBlcmFybScpKSkpIHRoaXMuYm9uZXMubFVwcGVyQXJtID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubEZvcmVBcm0gJiYgKG5hbWUuaW5jbHVkZXMoJ2xlZnRmb3JlYXJtJykgfHwgKGlzTGVmdCAmJiBuYW1lLmluY2x1ZGVzKCdmb3JlYXJtJykpKSkgdGhpcy5ib25lcy5sRm9yZUFybSA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmxIYW5kICYmICgobmFtZS5pbmNsdWRlcygnaGFuZCcpICYmIGlzTGVmdCkgfHwgbmFtZS5pbmNsdWRlcygnbGVmdGhhbmQnKSkpIHRoaXMuYm9uZXMubEhhbmQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICAvLyBCYWNrLWNvbXBhdDogYmFsbCBhdHRhY2htZW50IHVzZXMgaGFuZEJvbmUKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaGFuZEJvbmUgJiYgdGhpcy5ib25lcy5ySGFuZCkgdGhpcy5oYW5kQm9uZSA9IHRoaXMuYm9uZXMuckhhbmQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5taXhlciA9IG5ldyBUSFJFRS5BbmltYXRpb25NaXhlcih0aGlzLm1lc2gpOwoKICAgICAgICAgICAgaWYgKGFuaW1hdGlvbnMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IF9ub3JtQ2xpcE5hbWUgPSAocykgPT4gKHMgfHwgJycpCiAgICAgICAgICAgICAgICAgICAgLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvW19cLV0rL2csICcgJykKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXHMrL2csICcgJykKICAgICAgICAgICAgICAgICAgICAudHJpbSgpOwoKICAgICAgICAgICAgICAgIC8vIEhlbHBlciB0byBzdHJpcCBsZWcgdHJhY2tzIGZyb20gYWN0aW9uIGNsaXBzCiAgICAgICAgICAgICAgICBjb25zdCBfc3RyaXBMZWdzID0gKGNsaXApID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFja3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICBjbGlwLnRyYWNrcy5mb3JFYWNoKHQgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZWdleCB0byBtYXRjaCBsZWcgYm9uZXMgKE1peGFtbyBzdHlsZTogUmlnaHRVcExlZywgUmlnaHRMZWcsIFJpZ2h0Rm9vdCwgUmlnaHRUb2VCYXNlKQogICAgICAgICAgICAgICAgICAgICAgICAvLyBBbHNvIGdlbmVyaWMgIkxlZyIsICJGb290IgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXQubmFtZS5tYXRjaCgvKFVwTGVnfExlZ3xGb290fFRvZSkvaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYWNrcy5wdXNoKHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgY2xpcC50cmFja3MgPSB0cmFja3M7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNsaXA7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGFuaW1hdGlvbnMuZm9yRWFjaCgoY2xpcCkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBfbm9ybUNsaXBOYW1lKGNsaXAubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzID0gKHJlKSA9PiByZS50ZXN0KG5hbWUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxldCBpc0xvY29tb3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBsZXQgYWN0aW9uS2V5ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIENvcmUgbG9jb21vdGlvbiAtLS0KICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC90cmVhZHx0cmVhZGluZ3xpZGxlfGZsb2F0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2lkbGUnOwogICAgICAgICAgICAgICAgICAgICAgICBpc0xvY29tb3Rpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9kYXNofHNwcmludHxidXJzdHxmYXN0XHMqc3dpbXxzd2ltXHMqZmFzdC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdkYXNoJzsKICAgICAgICAgICAgICAgICAgICAgICAgaXNMb2NvbW90aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvc3dpbXxmcmVlc3R5bGV8Y3Jhd2wvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAnc3dpbSc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzTG9jb21vdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIFRocm93aW5nIChwYXNzL3Nob3QgdmFyaWFudHMgaWYgcHJlc2VudCkgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3Rocm93fHRvc3N8cGl0Y2gvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC9zaG9vdHxzaG90fGdvYWwvKSkgYWN0aW9uS2V5ID0gJ3Rocm93X3Nob3QnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChoYXMoL3Bhc3MvKSkgYWN0aW9uS2V5ID0gJ3Rocm93X3Bhc3MnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFjdGlvbktleSA9ICd0aHJvdyc7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBDYXRjaGluZyAoanVtcC9haXIgdmFyaWFudHMgaWYgcHJlc2VudCkgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2NhdGNofHJlY2VpdmV8Z3JhYnxpbnRlcmNlcHQvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC9qdW1wfGxlYXB8YWlyfGRpdmUvKSkgYWN0aW9uS2V5ID0gJ2NhdGNoX2p1bXAnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFjdGlvbktleSA9ICdjYXRjaCc7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBIaXQgLyBSZWFjdCAtLS0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvcmVhY3R8aGl0fGh1cnR8ZGFtYWdlfHN0YWdnZXJ8a25vY2svKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAncmVhY3QnOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gT3B0aW9uYWwgc3RhdGVzIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jaGFyZ2V8YWltfHJlYWR5fHdpbmR1cHxob2xkLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2NoYXJnZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3RhY2tsZXxjaGVja3xyYW0vKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAndGFja2xlJzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvYmxvY2t8c2F2ZS8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2NlbGVicmF0ZXx2aWN0b3J5fGNoZWVyLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2NlbGVicmF0ZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gY2xpcC5uYW1lOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gU3RyaXAgbGVncyBmcm9tIG5vbi1sb2NvbW90aW9uIGNsaXBzIHRvIGFsbG93IHRyZWFkaW5nIHdhdGVyIG92ZXJsYXkKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTG9jb21vdGlvbiAmJiBhY3Rpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3N0cmlwTGVncyhjbGlwKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChhY3Rpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3Rpb25zW2FjdGlvbktleV0gPSB0aGlzLm1peGVyLmNsaXBBY3Rpb24oY2xpcCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFN0YXJ0IGRlZmF1bHQgbG9jb21vdGlvbgogICAgICAgICAgICBpZiAodGhpcy5hY3Rpb25zWydpZGxlJ10pIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24oJ2lkbGUnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrCiAgICAgICAgICAgICAgICBjb25zdCBmaXJzdCA9IE9iamVjdC52YWx1ZXModGhpcy5hY3Rpb25zKVswXTsKICAgICAgICAgICAgICAgIGlmKGZpcnN0KSBmaXJzdC5wbGF5KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9uZS1zaG90IGFuaW1hdGlvbiBsaXN0ZW5lcgogICAgICAgICAgICBpZiAodGhpcy5taXhlcikgewogICAgICAgICAgICAgICAgdGhpcy5taXhlci5hZGRFdmVudExpc3RlbmVyKCdmaW5pc2hlZCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9hbmltTG9ja2VkKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLmFjdGlvbikgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBmaW5pc2hlZCBhY3Rpb24gaXMgb3VyIGN1cnJlbnQgb25lLXNob3QKICAgICAgICAgICAgICAgICAgICBpZiAoZS5hY3Rpb24gPT09IHRoaXMuYWN0aXZlT25lU2hvdCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hbmltTG9ja2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvY2tlZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVPbmVTaG90ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJldHVybiB0byBsb2NvbW90aW9uIHVwZGF0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMTUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE5ldyBtZXRob2QgZm9yIGJhc2UgbGF5ZXIgKGxlZ3MvYm9keSBtb3ZlbWVudCkKICAgICAgICBwbGF5TG9jb21vdGlvbihhY3Rpb25OYW1lLCBkdXJhdGlvbiA9IDAuNSkgewogICAgICAgICAgICBjb25zdCBuZXdBY3Rpb24gPSB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgIGlmICghbmV3QWN0aW9uIHx8IG5ld0FjdGlvbiA9PT0gdGhpcy5hY3RpdmVMb2NvbW90aW9uKSByZXR1cm47CgogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVMb2NvbW90aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUxvY29tb3Rpb24uZmFkZU91dChkdXJhdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5ld0FjdGlvbi5yZXNldCgpOwogICAgICAgICAgICBuZXdBY3Rpb24uZmFkZUluKGR1cmF0aW9uKTsKICAgICAgICAgICAgbmV3QWN0aW9uLnBsYXkoKTsKICAgICAgICAgICAgdGhpcy5hY3RpdmVMb2NvbW90aW9uID0gbmV3QWN0aW9uOwogICAgICAgICAgICB0aGlzLl9sYXN0TG9jb21vdGlvbiA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICAvLyBPdmVyaGF1bGVkIHBsYXkgbWV0aG9kIHRvIGhhbmRsZSBsYXllcmluZwogICAgICAgIHBsYXkoYWN0aW9uTmFtZSwgZHVyYXRpb24gPSAwLjUpIHsKICAgICAgICAgICAgLy8gSWYgaXQncyBhIGxvY29tb3Rpb24gc3RhdGUsIHJvdXRlIHRvIHBsYXlMb2NvbW90aW9uCiAgICAgICAgICAgIGlmIChbJ2lkbGUnLCAnc3dpbScsICdkYXNoJ10uaW5jbHVkZXMoYWN0aW9uTmFtZSkpIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24oYWN0aW9uTmFtZSwgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPdGhlcndpc2UgdHJlYXQgYXMgYW4gYWN0aW9uIGxheWVyCiAgICAgICAgICAgIGNvbnN0IG5ld0FjdGlvbiA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFuZXdBY3Rpb24pIHJldHVybjsKCiAgICAgICAgICAgIC8vIElmIHdlIGhhdmUgYW4gYWN0aXZlIG9uZS1zaG90LCBmYWRlIGl0IG91dAogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVPbmVTaG90ICYmIHRoaXMuYWN0aXZlT25lU2hvdCAhPT0gbmV3QWN0aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZU9uZVNob3QuZmFkZU91dCgwLjEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXdBY3Rpb24ucmVzZXQoKTsKICAgICAgICAgICAgbmV3QWN0aW9uLmZhZGVJbigwLjEpOyAvLyBGYXN0IHRyYW5zaXRpb24gZm9yIGFjdGlvbnMKICAgICAgICAgICAgbmV3QWN0aW9uLnBsYXkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYWN0aXZlT25lU2hvdCA9IG5ld0FjdGlvbjsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlTG9jb21vdGlvbkFuaW0oZHVyYXRpb24gPSAwLjIpIHsKICAgICAgICAgICAgLy8gTm90ZTogV2UgTk8gTE9OR0VSIGNoZWNrIF9hbmltTG9ja2VkIGhlcmUuCiAgICAgICAgICAgIC8vIExvY29tb3Rpb24gc2hvdWxkIHVwZGF0ZSBjb250aW51b3VzbHkgYmFzZWQgb24gc3BlZWQsIAogICAgICAgICAgICAvLyBydW5uaW5nIHVuZGVybmVhdGggdGhlIHVwcGVyIGJvZHkgYWN0aW9uLgogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgdnggPSB0aGlzLnZlbG9jaXR5ID8gdGhpcy52ZWxvY2l0eS54IDogMDsKICAgICAgICAgICAgY29uc3QgdnogPSB0aGlzLnZlbG9jaXR5ID8gdGhpcy52ZWxvY2l0eS56IDogMDsKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSBNYXRoLnNxcnQodnggKiB2eCArIHZ6ICogdnopOwoKICAgICAgICAgICAgLy8gU21vb3RoIHNwZWVkCiAgICAgICAgICAgIGNvbnN0IHNtb290aEsgPSAxLjAgLSBNYXRoLnBvdygwLjAwMSwgZHVyYXRpb24pOwogICAgICAgICAgICB0aGlzLl9zbW9vdGhlZFNwZWVkICs9IChzcGVlZCAtIHRoaXMuX3Ntb290aGVkU3BlZWQpICogc21vb3RoSzsKCiAgICAgICAgICAgIGNvbnN0IHNwZWVkTm9ybSA9ICh0aGlzLm1heFNwZWVkID4gMC4wMDAxKSA/IFRIUkVFLk1hdGhVdGlscy5jbGFtcCh0aGlzLl9zbW9vdGhlZFNwZWVkIC8gdGhpcy5tYXhTcGVlZCwgMCwgMSkgOiAwOwoKICAgICAgICAgICAgLy8gSHlzdGVyZXNpcwogICAgICAgICAgICBjb25zdCBlbnRlck1vdmUgPSAwLjE4OwogICAgICAgICAgICBjb25zdCBleGl0TW92ZSA9IDAuMTA7CgogICAgICAgICAgICBjb25zdCBpbnB1dE1vdmluZyA9IHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wNjsKICAgICAgICAgICAgY29uc3QgdmVsTW92aW5nID0gdGhpcy5fc21vb3RoZWRTcGVlZCA+ICh0aGlzLl9tb3ZpbmdMYXRjaCA/IGV4aXRNb3ZlIDogZW50ZXJNb3ZlKTsKCiAgICAgICAgICAgIHRoaXMuX21vdmluZ0xhdGNoID0gaW5wdXRNb3ZpbmcgfHwgdmVsTW92aW5nOwoKICAgICAgICAgICAgbGV0IHRhcmdldCA9IHRoaXMuX21vdmluZ0xhdGNoID8gJ3N3aW0nIDogJ2lkbGUnOwogICAgICAgICAgICBpZiAodGhpcy5fbW92aW5nTGF0Y2ggJiYgdGhpcy5pc0Rhc2hpbmcgJiYgdGhpcy5hY3Rpb25zWydkYXNoJ10pIHRhcmdldCA9ICdkYXNoJzsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBwbGF5YmFjayByYXRlCiAgICAgICAgICAgIGNvbnN0IGFwcGx5UmF0ZSA9IChrZXkpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGlvbnNba2V5XTsKICAgICAgICAgICAgICAgIGlmICghYSkgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gJ3N3aW0nKSBhLnRpbWVTY2FsZSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDAuODUsIDEuNzAsIHNwZWVkTm9ybSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChrZXkgPT09ICdkYXNoJykgYS50aW1lU2NhbGUgPSBUSFJFRS5NYXRoVXRpbHMubGVycCgxLjEwLCAyLjIwLCBzcGVlZE5vcm0pOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoa2V5ID09PSAnaWRsZScpIGEudGltZVNjYWxlID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoMC45NSwgMS4wNSwgc3BlZWROb3JtKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGFwcGx5UmF0ZSh0YXJnZXQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuX2xhc3RMb2NvbW90aW9uICE9PSB0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGlvbnNbdGFyZ2V0XTsKICAgICAgICAgICAgICAgIGlmIChhKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsgYS5zZXRMb29wKFRIUkVFLkxvb3BSZXBlYXQpOyB9IGNhdGNoIChfKSB7fQogICAgICAgICAgICAgICAgICAgIGEuY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24odGFyZ2V0LCBkdXJhdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBsYXlPbmVTaG90KGFjdGlvbk5hbWUsIGR1cmF0aW9uID0gMC4xLCBvcHRzID0ge30pIHsKICAgICAgICAgICAgY29uc3QgYSA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFhKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICB0aGlzLl9hbmltTG9ja2VkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5fbG9ja2VkU3RhdGUgPSBhY3Rpb25OYW1lOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGEucmVzZXQoKTsKICAgICAgICAgICAgICAgIGEuc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICBhLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGEudGltZVNjYWxlID0gKG9wdHMudGltZVNjYWxlICE9PSB1bmRlZmluZWQgPyBvcHRzLnRpbWVTY2FsZSA6IDEuMCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKF8pIHt9CgogICAgICAgICAgICAvLyBVc2UgdGhlIG5ldyBwbGF5IG1ldGhvZCB3aGljaCBoYW5kbGVzIGxheWVyaW5nCiAgICAgICAgICAgIHRoaXMucGxheShhY3Rpb25OYW1lLCBkdXJhdGlvbik7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBzZXRJbnB1dCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCh4LCAwLCB6KTsKICAgICAgICB9CgpyZWNlaXZlQmFsbCgpIHsKICAgICAgICAgICAgdGhpcy5jYW5DYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ1JJVElDQUwgRklYOiBSZXNldCBzdGF0ZXMgdGhhdCBtaWdodCBwcmV2ZW50IHNob290aW5nCiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMi4wOwoKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLmxhc3RIb2xkZXIgJiYgYmFsbC5sYXN0SG9sZGVyLnRlYW0gPT09IHRoaXMudGVhbSAmJiBiYWxsLmxhc3RIb2xkZXIgIT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGJhbGwubGFzdEhvbGRlci5nYWluRXhwKDIpOwogICAgICAgICAgICAgICAgdGhpcy5nYWluRXhwKDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBiYWxsWSA9ICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLm1lc2gpID8gdGhpcy5iYWxsUmVmLm1lc2gucG9zaXRpb24ueSA6IDA7CiAgICAgICAgICAgIGNvbnN0IGNhdGNoS2V5ID0gKGJhbGxZID4gMC4yNSAmJiB0aGlzLmFjdGlvbnNbJ2NhdGNoX2p1bXAnXSkgPyAnY2F0Y2hfanVtcCcgOiAnY2F0Y2gnOwogICAgICAgICAgICB0aGlzLnBsYXlPbmVTaG90KGNhdGNoS2V5LCAwLjEpOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNOQVAhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtYWN0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp0aHJvd0JhbGwoYmFsbCwgZm9yY2VkVHlwZSA9IG51bGwsIHBvd2VyTXVsdGlwbGllciA9IDEuMCwgZm9yY2VkU3BpbiA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgfHwgdGhpcy5pc1Rocm93aW5nKSByZXR1cm47CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CgogICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSB0cnVlOwoKICAgICAgICAgICAgLy8gTG9jayBhaW0gZGlyZWN0aW9uIGF0IHN0YXJ0IG9mIHRocm93CiAgICAgICAgICAgIHRoaXMubG9ja2VkQWltVmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgIHRoaXMubG9ja2VkQWltVmVjdG9yLmNvcHkodGhpcy5pbnB1dFZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3Rvci5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQoKY29uc3QgZ29hbFogPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC00NiA6IDQ2OwogICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CgogICAgICAgICAgICBsZXQgdHlwZSA9IGZvcmNlZFR5cGU7CiAgICAgICAgICAgIGlmICghdHlwZSkgewogICAgICAgICAgICAgICAgdHlwZSA9IChkaXN0VG9Hb2FsIDwgMjUpID8gJ1NIJyA6ICdQQSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGlzRmluaXNoZXIgPSAodHlwZSA9PT0gJ1NIJyAmJiBkaXN0VG9Hb2FsIDwgMTIuMCk7CgogICAgICAgICAgICBsZXQgdGVjaE5hbWUgPSAodHlwZSA9PT0gJ1NIJykgPyB0aGlzLnRlY2hzLnNob290IDogdGhpcy50ZWNocy5wYXNzOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnZlbm9tID4gMCAmJiB0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0lMRU5DRUQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIHRlY2hOYW1lID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV0IHdpbmR1cFRpbWUgPSAxMDA7CiAgICAgICAgICAgIGxldCBhbmltU3BlZWQgPSAxLjU7CgogICAgICAgICAgICBpZiAocG93ZXJNdWx0aXBsaWVyID4gMS4xKSB7CiAgICAgICAgICAgICAgICB3aW5kdXBUaW1lICs9IDIwMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGlzRmluaXNoZXIgJiYgIXRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICB3aW5kdXBUaW1lID0gNTA7CiAgICAgICAgICAgICAgICBhbmltU3BlZWQgPSAzLjA7CiAgICAgICAgICAgIH0KCmlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSA9IDQwMDsKICAgICAgICAgICAgICAgIGFuaW1TcGVlZCA9IDAuODsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5wbGF5Q2luZW1hdGljKHRlY2hOYW1lLCB0aGlzLm1lc2gsIDEuMik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMS41OwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGFiZWwgPSB0ZWNoTmFtZS5yZXBsYWNlKCdfJywgJyAnKS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24obGFiZWwsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBORVc6IFNwYXduIFRlY2ggR2x5cGggKFZlcnRpY2FsIENhc3RpbmcgQ2lyY2xlKQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyLnNwYXduKCd0ZWNoJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMS4yLAogICAgICAgICAgICAgICAgICAgICAgICByb3RhdGlvblNwZWVkOiA0LjAsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IDEuNSwKICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WTogMS4yLAogICAgICAgICAgICAgICAgICAgICAgICBmYWNlQ2FtZXJhOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFBpY2sgYmVzdCB0aHJvdyBjbGlwIChwYXNzL3Nob3QgdmFyaWFudHMgaWYgcHJlc2VudCkKICAgICAgICAgICAgY29uc3QgdGhyb3dLZXkgPQogICAgICAgICAgICAgICAgKHR5cGUgPT09ICdTSCcgJiYgdGhpcy5hY3Rpb25zWyd0aHJvd19zaG90J10pID8gJ3Rocm93X3Nob3QnIDoKICAgICAgICAgICAgICAgICh0eXBlID09PSAnUEEnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfcGFzcyddKSA/ICd0aHJvd19wYXNzJyA6CiAgICAgICAgICAgICAgICAndGhyb3cnOwoKICAgICAgICAgICAgdGhpcy5wbGF5T25lU2hvdCh0aHJvd0tleSwgMC4xLCB7IHRpbWVTY2FsZTogYW5pbVNwZWVkIH0pOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgIXRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJXSE9PU0giLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1hY3Rpb24iKTsKICAgICAgICAgICAgfQoKc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBTYWZldHk6IElmIGJhbGwgaG9sZGVyIGlzIHN0aWxsIHVzLCBwcm9jZWVkLiBJZiBoYXNCYWxsIGlzIGZhbHNlIGJ1dCBob2xkZXIgaXMgdXMsIGFzc3VtZSBzeW5jIGxhZyBhbmQgcHJvY2VlZC4KICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgfHwgKGJhbGwgJiYgYmFsbC5ob2xkZXIgPT09IHRoaXMpKSB7CmNvbnN0IHRocm93QWN0aW9uID0gdGhpcy5hY3Rpb25zW3Rocm93S2V5XTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhyb3dBY3Rpb24pIHRocm93QWN0aW9uLnRpbWVTY2FsZSA9IDEuMDsKCiAgICAgICAgICAgICAgICAgICAgbGV0IGZpbmFsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVmZXJlbmNlRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCmlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLmNvcHkodGhpcy5vdmVycmlkZUFpbVZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZURpci5jb3B5KGZpbmFsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJFTU9WRUQ6IEluc3RhbnQgcm90YXRpb24gc25hcC4gCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZSB1cGRhdGUgbG9vcCBoYW5kbGVzIHNtb290aCByb3RhdGlvbiB2aWEgdGFyZ2V0WWF3LgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIHRoZSAiZmxpcHBpbmcgYXJvdW5kIiB2aXN1YWwgZ2xpdGNoLgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLmNvcHkodGhpcy5sb2NrZWRBaW1WZWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2VEaXIuY29weSh0aGlzLmxvY2tlZEFpbVZlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgfQoKY29uc3Qgc3BpbiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwoKICAgICAgICAgICAgICAgICAgICBpZiAoZm9yY2VkU3BpbikgewogICAgICAgICAgICAgICAgICAgICAgICBzcGluLmNvcHkoZm9yY2VkU3Bpbik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5wdXREaXIgPSB0aGlzLmlucHV0VmVjdG9yLmNsb25lKCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNyb3NzWSA9IG5ldyBUSFJFRS5WZWN0b3IzKCkuY3Jvc3NWZWN0b3JzKHJlZmVyZW5jZURpciwgaW5wdXREaXIpLnk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoY3Jvc3NZKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Bpbi5zZXQoMCwgY3Jvc3NZICogMTIuMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGxldCBiYXNlQ29zdCA9ICh0eXBlID09PSAnU0gnKSA/IDIwIDogMTA7CiAgICAgICAgICAgICAgICAgICAgbGV0IHRlY2hDb3N0ID0gMDsKICAgICAgICAgICAgICAgICAgICBsZXQgdGVjaEJvbnVzID0gMDsKICAgICAgICAgICAgICAgICAgICBsZXQgdGVjaFBheWxvYWQgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICBpZiAodGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAndmVub20nOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gKHR5cGUgPT09ICdTSCcgPyAyMCA6IDEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAndmVub20nLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnd2l0aGVyJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9ICh0eXBlID09PSAnU0gnID8gMjAgOiAxMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IHsgdHlwZTogJ3dpdGhlcicsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICduYXAnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gKHR5cGUgPT09ICdTSCcgPyAzNSA6IDMwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnbmFwJywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3NwaGVyZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAyNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm5nID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMTEpICsgNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gcm5nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IHsgdHlwZTogJ3NwaGVyZScsIGxldmVsOiAxLCBib251czogcm5nIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgU1BIRVJFICske3JuZ31gLCB0aGlzLm1lc2gucG9zaXRpb24sICJnb2FsIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnamVjaHQnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gNDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnamVjaHQnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9wZXJmb3JtSmVjaHRLbm9ja2JhY2soKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdpbnZpc2libGUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gMjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnaW52aXNpYmxlJywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsQ29zdCA9IGJhc2VDb3N0ICsgdGVjaENvc3Q7CgogICAgICAgICAgICAgICAgICAgIGxldCBwb3dlckZhY3RvciA9IDEuMDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA8IHRvdGFsQ29zdCkgewogICAgICAgICAgICAgICAgICAgICAgICBwb3dlckZhY3RvciA9IDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJUSVJFRCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gdG90YWxDb3N0OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGV0IHN0YXRWYWwgPSB0aGlzLmdldFN0YXQodHlwZSk7CiAgICAgICAgICAgICAgICAgICAgc3RhdFZhbCArPSB0ZWNoQm9udXM7CiAgICAgICAgICAgICAgICAgICAgc3RhdFZhbCAqPSBwb3dlckZhY3RvcjsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IHBvd2VyTXVsdGlwbGllcjsKCmNvbnN0IGdvYWxaID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtNDYgOiA0NjsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnb2FsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbFogLSB0aGlzLm1lc2gucG9zaXRpb24ueikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbERvdCA9IGZpbmFsRGlyLmRvdChnb2FsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDIsIGdvYWxaKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdG9Hb2FsID0gZ29hbFBvcy5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2ggPSB0aGlzLmdldFN0YXQoJ1NIJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBNYXRoLm1pbigwLjksIE1hdGgubWF4KDAuMSwgc2ggLyAxMDAuMCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lzdEZhY3RvciAqPSAwLjE7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnb2FsRG90ID4gMC4yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5sZXJwKHRvR29hbCwgYXNzaXN0RmFjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRmluaXNoZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4wNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xBTSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4yNTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKLy8gR29hbGllIExvZnQgQm9udXMgKFByZXZlbnQgaW50ZXJjZXB0aW9uIGJ5IGltbWVkaWF0ZSBkZWZlbmRlcikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgZmluYWxEaXIueSArPSAwLjg7IC8vIEhpZ2ggbG9mdCBmb3IgY2xlYXJhbmNlCgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGZpbmFsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvTWF0ZSA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0LnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b01hdGUuYWRkU2NhbGVkVmVjdG9yKHRhcmdldC52ZWxvY2l0eSwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvTWF0ZS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYSA9IHRoaXMuZ2V0U3RhdCgnUEEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBNYXRoLm1pbigxLjAsIDAuMyArIChwYSAvIDgwLjApKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lzdEZhY3RvciAqPSAwLjE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIubGVycCh0b01hdGUsIGFzc2lzdEZhY3Rvcik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gTWF0aC5taW4oMC42LCBkaXN0ICogMC4wMyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CmZpbmFsRGlyLnkgKz0gMC4yOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBHb2FsaWUgTG9mdCBCb251cyBmb3IgUGFzc2luZwovLyBHb2FsaWUgTG9mdCBCb251cyBmb3IgUGFzc2luZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yb2xlID09PSAnR0wnKSBmaW5hbERpci55ICs9IDAuODsgLy8gSGlnaCBsb2Z0IGZvciBjbGVhcmFuY2UKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodGVjaFBheWxvYWQgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KHRoaXMsIHRlY2hOYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CgpiYWxsLnNob290KGZpbmFsRGlyLCBzdGF0VmFsLCB0eXBlLCB0ZWNoUGF5bG9hZCwgc3Bpbik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRXh0cmEgZ3JhY2UgcGVyaW9kIGZvciBHb2FsaWUgdG8gcHJldmVudCBwb2ludC1ibGFuayBpbnRlcmNlcHRpb25zCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgewogICAgICAgICAgICAgICAgICAgICAgICBiYWxsLmNhdGNoR3JhY2VQZXJpb2QgPSAwLjY7IC8vIDAuNnMgaW1tdW5pdHkgKGFwcHJveCAxMC0xMm0gdHJhdmVsKQogICAgICAgICAgICAgICAgICAgIH0KCnRoaXMubG9zZUJhbGwoKTsKCnRoaXMuY2F0Y2hDb29sZG93biA9IDEuMDsgLy8gMXMgY29vbGRvd24KICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHdpbmR1cFRpbWUpOwoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBudWxsOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlTG9jb21vdGlvbkFuaW0oMC4yKTsKICAgICAgICAgICAgfSwgd2luZHVwVGltZSArIDUwMCk7CiAgICAgICAgfQoKICAgICAgICBfZmluZFBhc3NUYXJnZXRJbkNvbmUoYWltRGlyKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtKSByZXR1cm4gbnVsbDsKCiAgICAgICAgICAgIGxldCBiZXN0VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IG1heFNjb3JlID0gLUluZmluaXR5OwoKICAgICAgICAgICAgZm9yIChjb25zdCBtYXRlIG9mIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcyB8fCAhbWF0ZS5tZXNoKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICBjb25zdCB0b01hdGUgPSBtYXRlLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGRvdCA9IGFpbURpci5kb3QodG9NYXRlKTsKCiAgICAgICAgICAgICAgICBpZiAoZG90ID4gMC43KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2NvcmUgPSAoZG90ICogMTApIC0gKGRpc3QgKiAwLjEpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoc2NvcmUgPiBtYXhTY29yZSkgewogICAgICAgICAgICAgICAgICAgICAgICBtYXhTY29yZSA9IHNjb3JlOwogICAgICAgICAgICAgICAgICAgICAgICBiZXN0VGFyZ2V0ID0gbWF0ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJlc3RUYXJnZXQ7CiAgICAgICAgfQoKc3RhcnRDaGFyZ2UoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CgovLyBWaXN1YWxzIGhhbmRsZWQgaW4gdXBkYXRlCgogICAgICAgICAgICAvLyBTaG93IGNoYXJnZSBVSQogICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSSgwKTsKCiAgICAgICAgICAgIC8vIE5FVzogU3Bhd24gQ2hhcmdlIEdseXBoIChHcm91bmQgUmluZykKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyLnNwYXduKCdjaGFyZ2UnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgbGlmZTogdGhpcy5tYXhDaGFyZ2VUaW1lLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IDMuMCwKICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAwLjIsCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WTogMC4xCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnJlbGVhc2VDaGFyZ2UoZHgsIGR5LCBjdXJ2ZUlucHV0ID0gbnVsbCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaXNDaGFyZ2luZykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBvd2VyIENhbGN1bGF0aW9uCiAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4odGhpcy5jaGFyZ2VUaW1lIC8gdGhpcy5tYXhDaGFyZ2VUaW1lLCAxLjApOwogICAgICAgICAgICBjb25zdCBUQyA9IHdpbmRvdy5mbHV4LlRocm93Q29uZmlnIHx8IHt9OwoKICAgICAgICAgICAgLy8gQmFzZSBtdWx0aXBsaWVyIChkZWZhdWx0czogMS4wIHRvIDEuOCkKICAgICAgICAgICAgbGV0IG11bHRpcGxpZXIgPSAoVEMuUE9XRVJfQkFTRSAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfQkFTRSA6IDEuMCkgKyAocmF0aW8gKiAoVEMuUE9XRVJfUkFOR0UgIT09IHVuZGVmaW5lZCA/IFRDLlBPV0VSX1JBTkdFIDogMC44KSk7Ly8gTUFYIFBPV0VSIEJPTlVTOiBJZiBoZWxkIG5lYXIgbWF4LCBzaWduaWZpY2FudCBib29zdAogICAgICAgICAgICBpZiAocmF0aW8gPiAoVEMuUE9XRVJfTUFYX0JPTlVTX1JBVElPICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9NQVhfQk9OVVNfUkFUSU8gOiAwLjk1KSkgewogICAgICAgICAgICAgICAgbXVsdGlwbGllciA9IChUQy5QT1dFUl9NQVhfTVVMVElQTElFUiAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfTUFYX01VTFRJUExJRVIgOiAyLjUpOyAvLyBDcml0aWNhbCBQb3dlcgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNQVggUE9XRVIhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKC0xMCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CgogICAgICAgICAgICAvLyBBaW0gVmVjdG9yIENhbGN1bGF0aW9uCiAgICAgICAgICAgIGxldCBhaW1WZWMgPSBudWxsOwogICAgICAgICAgICBjb25zdCBzd2lwZUxlbiA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCiAgICAgICAgICAgIGlmIChzd2lwZUxlbiA+IChUQy5TV0lQRV9NSU5fUFggIT09IHVuZGVmaW5lZCA/IFRDLlNXSVBFX01JTl9QWCA6IDIwKSkgewogICAgICAgICAgICAgICAgY29uc3QgY2FtZXJhID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYTsKICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICBjb25zdCByaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAgICAgaWYgKGNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihmd2QpOwogICAgICAgICAgICAgICAgICAgIGZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAoZndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgZndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBmd2Qubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIHJpZ2h0LmNyb3NzVmVjdG9ycyhmd2QsIG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgICAgIHdvcmxkVmVjLmFkZFNjYWxlZFZlY3RvcihyaWdodCwgZHggKiAoVEMuQUlNX0RYX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5BSU1fRFhfU0NBTEUgOiAxLjApKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5hZGRTY2FsZWRWZWN0b3IoZndkLCAtZHkgKiAoVEMuQUlNX0RZX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5BSU1fRFlfU0NBTEUgOiAxLjApKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgYWltVmVjID0gd29ybGRWZWM7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdmVycmlkZUFpbVZlY3RvciA9IGFpbVZlYzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYWltVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFpbVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgfQoKLy8gLS0tIEFOQUxPRyBDVVJWRSBMT0dJQyAtLS0KICAgICAgICAgICAgLy8gRm9ybXVsYTogQ3VydmUgPSBJbnRlbnNpdHkgKiBTcGVlZAogICAgICAgICAgICBsZXQgc3BpblZlYyA9IG51bGw7CiAgICAgICAgICAgIAppZiAoKFRDLkNVUlZFX0VOQUJMRUQgIT09IGZhbHNlKSAmJiBjdXJ2ZUlucHV0ICYmIE1hdGguYWJzKGN1cnZlSW5wdXQuaW50ZW5zaXR5KSA+IChUQy5DVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEIDogMC4yNSkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJhd0ludGVuc2l0eSA9IE1hdGguYWJzKGN1cnZlSW5wdXQuaW50ZW5zaXR5KTsKICAgICAgICAgICAgICAgIGNvbnN0IHNpZ24gPSBNYXRoLnNpZ24oY3VydmVJbnB1dC5pbnRlbnNpdHkpOyAvLyBQb3NpdGl2ZSA9IFJpZ2h0IEh1bXAgPSBMZWZ0IEN1cnZlCiAgICAgICAgICAgICAgICBjb25zdCBzd2lwZVNwZWVkID0gY3VydmVJbnB1dC5zcGVlZCB8fCAxLjA7CgogICAgICAgICAgICAgICAgLy8gMS4gQmFzZSBTcGluIGZyb20gQXJjIChUdW5lZCBmb3IgcmVhbGlzbSwgbm8gY3ljbG9uZXMpCi8vIDEuIEJhc2UgU3BpbiBmcm9tIEFyYyAoSGVyY3VsZWFuIEJvb3N0KQogICAgICAgICAgICAgICAgbGV0IHNwaW5NYWcgPSByYXdJbnRlbnNpdHkgKiAoVEMuQ1VSVkVfU1BJTl9TQ0FMRSAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BJTl9TQ0FMRSA6IDEwMDAuMCk7CgogICAgICAgICAgICAgICAgLy8gMi4gU3BlZWQgQm9udXMgKFF1aWNrbmVzcyBhZGRzIFJQTSkKICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkQm9udXMgPSBNYXRoLm1heCgxLjAsIHN3aXBlU3BlZWQgKiAoVEMuQ1VSVkVfU1BFRURfTVVMVCAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BFRURfTVVMVCA6IDEuNSkpOwogICAgICAgICAgICAgICAgc3Bpbk1hZyAqPSBzcGVlZEJvbnVzOwoKICAgICAgICAgICAgICAgIC8vIENhcCAoSW5jcmVhc2VkIHRvIDE1MDAgZm9yIG1hc3NpdmUgYXJjcykKICAgICAgICAgICAgICAgIHNwaW5NYWcgPSBNYXRoLm1pbigoVEMuQ1VSVkVfU1BJTl9DQVAgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX1NQSU5fQ0FQIDogMTUwMC4wKSwgc3Bpbk1hZyk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgU3BpbgogICAgICAgICAgICAgICAgLy8gUmlnaHQgSHVtcCAoUG9zaXRpdmUgSW50ZW5zaXR5KSAtPiBMZWZ0IEN1cnZlIChQb3NpdGl2ZSBTcGluIFkpCiAgICAgICAgICAgICAgICBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3Bpbk1hZyAqIHNpZ24sIDApOwogICAgICAgICAgICAgICAgCmlmIChzcGluTWFnID4gKFRDLkNVUlZFX1BFUkZFQ1RfU1BJTiAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfUEVSRkVDVF9TUElOIDogNTAwLjApICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQRVJGRUNUIENVUlZFIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSb2xsSW1wdWxzZShzaWduICogLTAuMyk7IC8vIFRpbHQgY2FtZXJhIGludG8gdGhlIGN1cnZlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEZXRlcm1pbmUgVHlwZSAoUGFzcyB2cyBTaG9vdCkKLy8gRGV0ZXJtaW5lIFR5cGUgKFBhc3MgdnMgU2hvb3QpCiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtNDYgOiA0NjsKICAgICAgICAgICAgY29uc3QgZ29hbERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIGdvYWxaIC0gdGhpcy5tZXNoLnBvc2l0aW9uLnopLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBjb25zdCBkb3RHb2FsID0gYWltVmVjLmRvdChnb2FsRGlyKTsKCiAgICAgICAgICAgIGxldCB0eXBlID0gJ1BBJzsKICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwoKICAgICAgICAgICAgaWYgKGRvdEdvYWwgPiAwLjggJiYgZGlzdFRvR29hbCA8IDM1LjApIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAnU0gnOwogICAgICAgICAgICB9IGVsc2UgaWYgKGRvdEdvYWwgPiAwLjUgJiYgZGlzdFRvR29hbCA8IDIwLjApIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAnU0gnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbWFydCBQYXNzIE92ZXJyaWRlCiAgICAgICAgICAgIGNvbnN0IHRhcmdldE1hdGUgPSB0aGlzLl9maW5kUGFzc1RhcmdldEluQ29uZShhaW1WZWMpOwogICAgICAgICAgICBpZiAodGFyZ2V0TWF0ZSAmJiB0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0TWF0ZSA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldE1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdE1hdGUgPCAxMi4wKSB0eXBlID0gJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgdHlwZSwgbXVsdGlwbGllciwgc3BpblZlYyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE5FVzogQ2hhcmdlIFVJIG1ldGhvZHMKICAgICAgICBfdXBkYXRlQ2hhcmdlVUkocmF0aW8pIHsKICAgICAgICAgICAgY29uc3QgbWV0ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhcmdlLW1ldGVyLWZpbGwnKTsKICAgICAgICAgICAgaWYgKG1ldGVyKSB7CiAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS53aWR0aCA9IGAke3JhdGlvICogMTAwfSVgOwogICAgICAgICAgICAgICAgaWYgKHJhdGlvID4gMC45KSB7CiAgICAgICAgICAgICAgICAgICAgbWV0ZXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAsICNmODApJzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmF0aW8gPiAwLjUpIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzBmMCwgI2ZmMCknOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzBhZiwgIzBmMCknOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIpIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlQ2hhcmdlVUkoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIpIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KCiAgICAgICAgc2V0T3ZlcnJpZGVBaW0oeCwgeikgewogICAgICAgICAgICBpZiAoIXRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yLnNldCh4LCAwLCB6KS5ub3JtYWxpemUoKTsKICAgICAgICB9Cgpsb3NlQmFsbCgpIHsKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwogICAgICAgICAgICAvLyBGaXg6IEVuc3VyZSBwbGF5ZXIgY2FuIGNhdGNoIGFnYWluIGlmIHRoZXkgbG9zZSBwb3NzZXNzaW9uIHVuZXhwZWN0ZWRseQogICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBzdGF0ZXMgdG8gcHJldmVudCBsb2NraW5nCiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyBTWU5DIEZJWDogSWYgYmFsbCB0aGlua3MgSSBob2xkIGl0LCBidXQgSSBkb24ndCwgZm9yY2UgcmVjZWl2ZQogICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmICYmIHRoaXMuYmFsbFJlZi5ob2xkZXIgPT09IHRoaXMgJiYgIXRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJTeW5jaW5nIGJhbGwgcG9zc2Vzc2lvbiB0byBwbGF5ZXIiKTsKICAgICAgICAgICAgICAgIHRoaXMucmVjZWl2ZUJhbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaXNHb2RNb2RlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gdGhpcy5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gdGhpcy5nZXRTdGF0KCdFTicpOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMudmVub20gPSAwOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBBbmltYXRpb246IGtlZXAgbG9jb21vdGlvbi9jaGFyZ2UgdXBkYXRlZCB1bmxlc3MgYSBvbmUtc2hvdCBpcyBsb2NraW5nIGFuaW1hdGlvbnMuCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CgoKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzKGR0KTsKCiAgICAgICAgICAgIC8vIENoYXJnZSBMb2dpYwovLyBDaGFyZ2UgTG9naWMKICAgICAgICAgICAgaWYgKHRoaXMuaXNDaGFyZ2luZykgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgfHwgdGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnNjYWxlLnNldFNjYWxhcih0aGlzLmJhc2VTY2FsZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CiAgICAgICAgICAgICAgICB9IGVsc2Ugewp0aGlzLmNoYXJnZVRpbWUgKz0gZHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQVVUTy1SRUxFQVNFOiBJZiBoZWxkIHRvbyBsb25nICgzcyksIGZvcmNlIHJlbGVhc2UgdG8gcHJldmVudCBzdHVjayBzdGF0ZQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJnZVRpbWUgPiAzLjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWxlYXNlQ2hhcmdlKDAsIDApOyAvLyBGb3JjZSB3ZWFrIHNob3QKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1pbih0aGlzLmNoYXJnZVRpbWUgLyB0aGlzLm1heENoYXJnZVRpbWUsIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gTGV2aXRhdGlvbiAoUG93ZXJpbmcgdXApCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaG92ZXIgPSAoTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDIpICogMC4xKSArIChyYXRpbyAqIDAuOCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVmlicmF0aW9uIChJbnRlbnNpdHkgaW5jcmVhc2VzIHdpdGggY2hhcmdlKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNoYWtlID0gMC4wNSArICgwLjEgKiByYXRpbyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQXBwbHkgWSBvZmZzZXQgKEhvdmVyICsgSml0dGVyKQogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gaG92ZXIgKyAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBcHBseSBSb3RhdGlvbiBKaXR0ZXIgKHZpYSBiYW5raW5nL3BpdGNoIHZhcmlhYmxlcykKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGF2b2lkcyBwb3NpdGlvbmFsIGRyaWZ0IHdoaWxlIGdpdmluZyBhICJzdHJ1Z2dsaW5nIHRvIGNvbnRhaW4gcG93ZXIiIGxvb2sKICAgICAgICAgICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5waXRjaEFtb3VudCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZTsKCiAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIHNjYWxlIHN0YXlzIG5vcm1hbCAoUmVtb3ZlIHN3ZWxsaW5nIGVmZmVjdCkKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0U2NhbGFyKHRoaXMuYmFzZVNjYWxlKTsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQ2hhcmdlVUkocmF0aW8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CmlmICh0aGlzLmRhc2hDb29sZG93biA+IDApIHRoaXMuZGFzaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5jbGFzaENvb2xkb3duID4gMCkgdGhpcy5jbGFzaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5zdHVuVGltZXIgPiAwKSB0aGlzLnN0dW5UaW1lciAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHRoaXMuaW1tdW5pdHlUaW1lciAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuY2F0Y2hDb29sZG93biA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhdGNoQ29vbGRvd24gPD0gMCkgdGhpcy5jYW5DYXRjaCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gRGFzaCBMb2dpYwovLyBEYXNoIExvZ2ljCiAgICAgICAgICAgIGlmICh0aGlzLmlzRGFzaGluZykgewogICAgICAgICAgICAgICAgdGhpcy5kYXNoVGltZSAtPSBkdDsKICAgICAgICAgICAgICAgIAp0aGlzLl9kYXNoUGFydGljbGVUaW1lciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9kYXNoUGFydGljbGVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZGFzaFBhcnRpY2xlVGltZXIgPSAwLjAxOyAvLyBJbmNyZWFzZWQgZGVuc2l0eSAod2FzIDAuMDMpCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhY2sgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCkubmVnYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYWNrLmxlbmd0aFNxKCkgPCAwLjEpIGJhY2suc2V0KDAsIDAsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3Bhd24gbXVsdGlwbGUgcGFydGljbGVzIHBlciB0aWNrIGZvciBhICJzdHJlYW0iCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDI7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKGJhY2subXVsdGlwbHlTY2FsYXIoMC41KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueSArPSAxLjAgKyAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2Rhc2hfc3RyZWFtJywgcG9zLCB7IHNjYWxlOiAyLjAgKyBNYXRoLnJhbmRvbSgpIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFNtb290aCBSb3RhdGlvbiBkdXJpbmcgRGFzaAogICAgICAgICAgICAgICAgbGV0IGRpZmYgPSB0aGlzLnRhcmdldFlhdyAtIHRoaXMuY3VycmVudFlhdzsKICAgICAgICAgICAgICAgIHdoaWxlIChkaWZmID4gTWF0aC5QSSkgZGlmZiAtPSBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIHdoaWxlIChkaWZmIDwgLU1hdGguUEkpIGRpZmYgKz0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHR1cm5TcGVlZCA9IDE1LjA7IC8vIEZhc3QgdHVybmluZyBmb3IgZGFzaAogICAgICAgICAgICAgICAgY29uc3QgY2hhbmdlID0gTWF0aC5tYXgoLXR1cm5TcGVlZCAqIGR0LCBNYXRoLm1pbih0dXJuU3BlZWQgKiBkdCwgZGlmZikpOwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ICs9IGNoYW5nZTsKCiAgICAgICAgICAgICAgICB0aGlzLl9jaGVja1RhY2tsZUNvbGxpc2lvbigpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXNoVGltZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXNoVHlwZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUeXBlID09PSAndmVydGljYWwnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5kYXNoVmVjKS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gMSAtICh0aGlzLmRhc2hUaW1lIC8gdGhpcy5kYXNoVG90YWxUaW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSBNYXRoLnNpbih0ICogTWF0aC5QSSkgKiAzLjA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCBEYXNoIE1vdmVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoZHQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIFRhY2tsZSBMZWFuIChTaG91bGRlciBCYXNoIEFuaW1hdGlvbikKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IDEgLSAodGhpcy5kYXNoVGltZSAvIHRoaXMuZGFzaFRvdGFsVGltZSk7IC8vIDAgdG8gMQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWFuID0gTWF0aC5zaW4odCAqIE1hdGguUEkpOyAvLyBQZWFrIGF0IDEuMCBpbiBtaWRkbGUKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlLWFwcGx5IGJhc2UgZmFjaW5nICsgQWdncmVzc2l2ZSBTaG91bGRlciBDaGVjawovLyBSZS1hcHBseSBiYXNlIGZhY2luZyArIEFnZ3Jlc3NpdmUgU2hvdWxkZXIgQ2hlY2sKICAgICAgICAgICAgICAgICAgICAgICAgX3BRdWF0LnNldEZyb21BeGlzQW5nbGUoX3BBeGlzWSwgdGhpcy5jdXJyZW50WWF3ICsgdGhpcy5yb3RhdGlvbk9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGl0Y2ggPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgeWF3ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJvbGwgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgbHVuZ2VBbXQgPSAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGFzaFR5cGUgPT09ICdob3Jpem9udGFsJyB8fCB0aGlzLmRhc2hUeXBlID09PSAnYnJlYWsnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVEFDS0xFL0JSRUFLOiBBZ2dyZXNzaXZlIFNob3VsZGVyIENoZWNrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGl0Y2ggPSAxLjIgKiBsZWFuOyAvLyBIZWFkIGRvd24gLyBMZWFuIGZvcndhcmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5YXcgPSAwLjggKiBsZWFuOyAgIC8vIFR1cm4gc2hvdWxkZXIgaW50byB0YXJnZXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb2xsID0gLTAuNiAqIGxlYW47IC8vIERpcCBzaG91bGRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGx1bmdlQW10ID0gMC44ICogbGVhbjsgLy8gVGhydXN0IG1lc2ggZm9yd2FyZCB2aXN1YWxseQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZGFzaFR5cGUgPT09ICdzcHJpbnQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU1BSSU5UOiBBZXJvZHluYW1pYyBsZWFuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGl0Y2ggPSAwLjUgKiBsZWFuOyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsdW5nZUFtdCA9IDAuMiAqIGxlYW47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFwcGx5IEx1bmdlIChWaXN1YWwgT2Zmc2V0KQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobHVuZ2VBbXQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIGx1bmdlQW10KS5hcHBseVF1YXRlcm5pb24oX3BRdWF0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgX3BFdWxlci5zZXQocGl0Y2gsIHlhdywgcm9sbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIF9wUXVhdDIuc2V0RnJvbUV1bGVyKF9wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseVF1YXRlcm5pb25zKF9wUXVhdCwgX3BRdWF0Mik7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOTYpOwoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjk2KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU3R1bi9OYXAgQ2hlY2sKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkcmFnRmFjdG9yID0gTWF0aC5tYXgoMCwgMSAtICgyLjAgKiBkdCkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihkcmFnRmFjdG9yKTsKCiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwoKICAgICAgICAgICAgICAgIGlmICghdGhpcy5fYW5pbUxvY2tlZCAmJiB0aGlzLnN0YXRlICE9PSAnaWRsZScgJiYgdGhpcy5zdGF0ZSAhPT0gJ2NhdGNoJykgdGhpcy5wbGF5KCdpZGxlJywgMC41KTsKCiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIUEJhcigpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVQcmVzc3VyZShkdCk7CgogICAgICAgICAgICBpZiAodGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICgyLjAgKiBkdCkpKTsKCiAgICAgICAgICAgICAgICB0aGlzLl9hcHBseVNvZnRDb2xsaXNpb24oZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlHb2FsQ3JlYXNlKGR0KTsKCiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwoKdGhpcy5fdXBkYXRlVmVydGljYWxpdHkoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQmFua2luZyhkdCk7IC8vIEVuYWJsZSByb3RhdGlvbiBkdXJpbmcgdGhyb3cKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZlcnRpY2FsaXR5KGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUJhbmtpbmcoZHQpOwogICAgICAgICAgICB9Cgp0aGlzLl91cGRhdGVIUEJhcigpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwoKICAgICAgICAgICAgLy8gQnViYmxlIFRyYWlsIExvZ2ljCi8vIEJ1YmJsZSBUcmFpbCBMb2dpYyAoRHluYW1pYykKICAgICAgICAgICAgY29uc3Qgc3BlZWRTcSA9IHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHNwZWVkU3EgPiAxLjAgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2J1YmJsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFja0RpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAxLiBTdGFuZGFyZCBXYWtlIChBbHdheXMgc3Bhd24pCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gYmFja0Rpci5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKDAuOCk7CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LnkgPSAwLjUgKyBNYXRoLnJhbmRvbSgpICogMC41OyAKICAgICAgICAgICAgICAgICAgICBvZmZzZXQueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgIG9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZScsIHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLCB7IHNjYWxlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMjUgfSk7CgogICAgICAgICAgICAgICAgICAgIC8vIDIuIENhdml0YXRpb24gKEhpZ2ggU3BlZWQpIC0gQWRkIG9uIHRvcAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzSGlnaFNwZWVkID0gc3BlZWRTcSA+IDQwLjA7IAogICAgICAgICAgICAgICAgICAgIGlmIChpc0hpZ2hTcGVlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1PZmZzZXQgPSBiYWNrRGlyLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC41ICsgTWF0aC5yYW5kb20oKSowLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC55ID0gMC41ICsgKE1hdGgucmFuZG9tKCktMC41KSowLjg7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlX21pY3JvJywgdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG1PZmZzZXQpLCB7IHNjYWxlOiAwLjA2ICsgTWF0aC5yYW5kb20oKSowLjA4IH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4wMzsgCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwLjE7IAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBQcm9jZWR1cmFsICdhbGl2ZScgcG9zZTogbG9vay9haW0vYmFsbC1ob2xkIG9mZnNldHMgKGFwcGxpZWQgYWZ0ZXIgbWl4ZXIgdXBkYXRlKQogICAgICAgICAgICB0aGlzLl9hcHBseVByb2NlZHVyYWxQb3NlKGR0KTsKCn0KCgpfYXBwbHlQcm9jZWR1cmFsUG9zZShkdCkgewogICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAvLyBBZHZhbmNlIGxvY2FsIHRpbWUgKHVzZWQgZm9yIHN1YnRsZSBzd2F5cykKICAgIHRoaXMuX3Byb2NBbmltVGltZSArPSBkdDsKCiAgICBjb25zdCBiID0gdGhpcy5ib25lczsKICAgIGlmICghYikgcmV0dXJuOwoKICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICBjb25zdCBiYWxsID0gKGdhbWUgJiYgZ2FtZS5lbnRpdGllcykgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwoKICAgIGxldCBzaG91bGRBcHBseSA9IGZhbHNlOwoKICAgIC8vIEJ1aWxkIGEgZGVzaXJlZCB3b3JsZC1zcGFjZSBkaXJlY3Rpb24gd2Ugd2FudCB0aGUgdG9yc28vaGVhZCB0byBiaWFzIHRvd2FyZC4KICAgIC8vIE5PVEU6IFdlIGFwcGx5IHRoaXMgQUZURVIgdGhlIGFuaW1hdGlvbiBtaXhlciBoYXMgcG9zZWQgYm9uZXMsIGFzIGEgc21hbGwgYWRkaXRpdmUgb2Zmc2V0LgogICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CgogICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgIC8vIEFpbSBkaXJlY3Rpb24gKHByZWZlciBleHBsaWNpdCBhaW0gdmVjdG9yKQogICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5vdmVycmlkZUFpbVZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmxvY2tlZEFpbVZlY3RvcikgewogICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMubG9ja2VkQWltVmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wOCkgewogICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMuaW5wdXRWZWN0b3IpLm5vcm1hbGl6ZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgIH0KICAgICAgICBzaG91bGRBcHBseSA9IHRydWU7CiAgICB9IGVsc2UgaWYgKGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgLy8gTG9vayBhdCB0aGUgYmFsbCBpZiBpdCdzIGluIHRoZSAiYXdhcmVuZXNzIiByYWRpdXMKICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICBpZiAoZGlzdCA8IDIwLjApIHsKICAgICAgICAgICAgX3BWZWMuc3ViVmVjdG9ycyhiYWxsLm1lc2gucG9zaXRpb24sIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIHNob3VsZEFwcGx5ID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKCFzaG91bGRBcHBseSkgcmV0dXJuOwoKICAgIC8vIENvbnZlcnQgdGhlIGRpcmVjdGlvbiBpbnRvIHRoZSBwbGF5ZXIncyBsb2NhbCBzcGFjZSBzbyB5YXcvcGl0Y2ggYXJlIHN0YWJsZS4KICAgIF9wSW52UXVhdC5jb3B5KHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5pbnZlcnQoKTsKICAgIF9wVmVjLmFwcGx5UXVhdGVybmlvbihfcEludlF1YXQpLm5vcm1hbGl6ZSgpOwoKICAgIGNvbnN0IGx4ID0gX3BWZWMueCwgbHkgPSBfcFZlYy55LCBseiA9IF9wVmVjLno7CiAgICBjb25zdCB5YXcgPSBNYXRoLmF0YW4yKGx4LCBseik7CiAgICBjb25zdCBwaXRjaCA9IE1hdGguYXRhbjIobHksIE1hdGguc3FydChseCAqIGx4ICsgbHogKiBseikgKyAxZS02KTsKCiAgICBjb25zdCB5YXdDID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHlhdywgLTAuOSwgMC45KTsKICAgIGNvbnN0IHBpdGNoQyA9IFRIUkVFLk1hdGhVdGlscy5jbGFtcChwaXRjaCwgLTAuNiwgMC42KTsKCiAgICBjb25zdCBzcGVlZE5vcm0gPSAodGhpcy5tYXhTcGVlZCA+IDAuMDAwMSkgPyBUSFJFRS5NYXRoVXRpbHMuY2xhbXAodGhpcy5fc21vb3RoZWRTcGVlZCAvIHRoaXMubWF4U3BlZWQsIDAsIDEpIDogMDsKICAgIGNvbnN0IGFpbVcgPSAodGhpcy5oYXNCYWxsID8gKHRoaXMuaXNDaGFyZ2luZyA/IDEuMCA6IDAuNjUpIDogMC4zNSkgKiAoMS4wIC0gMC4zNSAqIHNwZWVkTm9ybSk7CiAgICBjb25zdCBoZWFkVyA9ICh0aGlzLmhhc0JhbGwgPyAwLjU1IDogMC43NSkgKiAoMS4wIC0gMC4yNSAqIHNwZWVkTm9ybSk7CgogICAgLy8gVG9yc28gYmlhcyAoc3BpbmUvY2hlc3QpCiAgICBpZiAoYi5jaGVzdCkgewogICAgICAgIF9wVG1wRXVsZXIuc2V0KC1waXRjaEMgKiAwLjIwICogYWltVywgeWF3QyAqIDAuMzUgKiBhaW1XLCAwKTsKICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgIGIuY2hlc3QucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgfSBlbHNlIGlmIChiLnNwaW5lKSB7CiAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMTUgKiBhaW1XLCB5YXdDICogMC4yNSAqIGFpbVcsIDApOwogICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgYi5zcGluZS5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wVG1wUXVhdCk7CiAgICB9CgogICAgLy8gSGVhZC9uZWNrIGxvb2sKICAgIGlmIChiLm5lY2spIHsKICAgICAgICBfcFRtcEV1bGVyLnNldCgtcGl0Y2hDICogMC4yNSAqIGhlYWRXLCB5YXdDICogMC40NSAqIGhlYWRXLCAwKTsKICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgIGIubmVjay5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wVG1wUXVhdCk7CiAgICB9CiAgICBpZiAoYi5oZWFkKSB7CiAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMzAgKiBoZWFkVywgeWF3QyAqIDAuNTUgKiBoZWFkVywgMCk7CiAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICBiLmhlYWQucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgfQoKICAgIC8vIEJhbGwtaG9sZCAvIGFpbSBhcm0gcG9zZSAoa2VlcHMgInN3aW0iIGFuaW1hdGlvbiBidXQgcmVhZHMgYXMgaG9sZGluZy9haW1pbmcpCiAgICBpZiAodGhpcy5oYXNCYWxsICYmICF0aGlzLmlzVGhyb3dpbmcgJiYgIXRoaXMuX2FuaW1Mb2NrZWQpIHsKICAgICAgICBjb25zdCB0ID0gdGhpcy5fcHJvY0FuaW1UaW1lOwogICAgICAgIGNvbnN0IGxpZnQgPSBUSFJFRS5NYXRoVXRpbHMuY2xhbXAoMC4zNSArICh0aGlzLmlzQ2hhcmdpbmcgPyAwLjU1IDogMC4yNSkgLSBzcGVlZE5vcm0gKiAwLjIsIDAuMTUsIDAuOTUpOwogICAgICAgIGNvbnN0IHN3YXkgPSBNYXRoLnNpbih0ICogNS4wKSAqIDAuMDUgKiAoMC41ICsgbGlmdCk7CgogICAgICAgIGNvbnN0IHJhaXNlWCA9IC0wLjU1ICogbGlmdCArIHN3YXk7CiAgICAgICAgY29uc3QgcmFpc2VaID0gLTAuMjUgKiBsaWZ0OwoKICAgICAgICBpZiAoYi5yVXBwZXJBcm0pIHsKICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQocmFpc2VYLCB5YXdDICogMC4xMCAqIGxpZnQsIHJhaXNlWik7CiAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgIGIuclVwcGVyQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICB9CiAgICAgICAgaWYgKGIuckZvcmVBcm0pIHsKICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLTAuMzUgKiBsaWZ0ICsgc3dheSAqIDAuNSwgMCwgMCk7CiAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgIGIuckZvcmVBcm0ucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgIH0KCiAgICAgICAgLy8gQ291bnRlcmJhbGFuY2UgbGVmdCBhcm0gc2xpZ2h0bHkgZm9yIGEgbW9yZSBkeW5hbWljIHNpbGhvdWV0dGUKICAgICAgICBpZiAoYi5sVXBwZXJBcm0pIHsKICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoMC4xNSAqIGxpZnQsIC15YXdDICogMC4wNSAqIGxpZnQsIDAuMTUgKiBsaWZ0KTsKICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgYi5sVXBwZXJBcm0ucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgIH0KICAgIH0KfQoKCiAgICAgICAgX3VwZGF0ZVN0YXR1cyhkdCkgewogICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIgOiBudWxsOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnZlbm9tID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMudmVub20gLT0gZHQ7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IDUgKiBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQIDwgMCkgdGhpcy5zdGF0cy5IUCA9IDA7CgogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCd2ZW5vbScsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gPSAwLjE1OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgJiYgdGhpcy5zdGF0cy5IUCA8IHRoaXMuc3RhdHMubWF4SFApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQICs9IDUgKiBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA+IHRoaXMuc3RhdHMubWF4SFApIHRoaXMuc3RhdHMuSFAgPSB0aGlzLnN0YXRzLm1heEhQOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IDIuMCAqIGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPCAwKSB0aGlzLnN0YXRzLkhQID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLm5hcCAtPSBkdDsKCiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5uYXAgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMubmFwIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignbmFwJywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5uYXAgPSAwLjg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBpc1dpdGhlcmluZyA9IGZhbHNlOwogICAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5zdGF0dXMud2l0aGVyKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMud2l0aGVyW2tleV0gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMud2l0aGVyW2tleV0gLT0gZHQ7CiAgICAgICAgICAgICAgICAgICAgaXNXaXRoZXJpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNXaXRoZXJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLndpdGhlciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCd3aXRoZXInLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLndpdGhlciA9IDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmlzdWFscygpOwogICAgICAgIH0KCl91cGRhdGVWaXN1YWxzKCkgewogICAgICAgICAgICAvLyBSRU1PVkVEOiBZZWxsb3cgc3BoZXJlL3RpbnQgbG9naWMgYXMgcGVyIHJlcXVlc3QuCiAgICAgICAgICAgIC8vIEFsd2F5cyByZXZlcnQgdG8gYmFzZSBjb2xvci4KICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5mb3JFYWNoKGVudHJ5ID0+IHsKICAgICAgICAgICAgICAgIGVudHJ5Lm1hdGVyaWFsLmNvbG9yLmNvcHkoZW50cnkuYmFzZUNvbG9yKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfY3JlYXRlQXVyYSgpIHsKICAgICAgICAgICAgLy8gQXVyYSByZW1vdmVkIHBlciB1c2VyIHJlcXVlc3QKICAgICAgICAgICAgdGhpcy5hdXJhTWVzaCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IFBhc3MgdGFyZ2V0IGluZGljYXRvcgogICAgICAgIF9jcmVhdGVQYXNzVGFyZ2V0SW5kaWNhdG9yKCkgewogICAgICAgICAgICAvLyBDcmVhdGUgYSByaW5nIHRoYXQgaGlnaGxpZ2h0cyBwb3RlbnRpYWwgcGFzcyB0YXJnZXRzCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMC44LCAxLjAsIDE2KTsKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgICAgIGNvbG9yOiAweDAwZmYwMCwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yID0gbmV3IFRIUkVFLk1lc2goZ2VvLCBtYXQpOwogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3Iucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnBvc2l0aW9uLnkgPSAwLjE7CiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMucGFzc1RhcmdldEluZGljYXRvcik7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlUGFzc1RhcmdldEluZGljYXRvcnMoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8ICF0aGlzLnRlYW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGaW5kIGJlc3QgcGFzcyB0YXJnZXQKICAgICAgICAgICAgY29uc3QgYWltRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5fZmluZFBhc3NUYXJnZXRJbkNvbmUoYWltRGlyKTsKCiAgICAgICAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0Lm1lc2ggJiYgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueCA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLng7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueiA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLno7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci5yb3RhdGlvbi56ICs9IDAuMDU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpIHsKICAgICAgICAgICAgaWYgKHRoaXMucGFzc1RhcmdldEluZGljYXRvcikgewogICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9hcHBseVNvZnRDb2xsaXNpb24oZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2ggfHwgIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgdGVhbXMgPSBbZ2FtZS50ZWFtcy5ob21lLCBnYW1lLnRlYW1zLmF3YXldOwoKICAgICAgICAgICAgY29uc3QgcmVwdWxzaW9uUmFkaXVzID0gMC41OyAvLyBSZWR1Y2VkIHRvIDAuNSB0byBmaXggaW52aXNpYmxlIHdhbGwgaXNzdWVzCiAgICAgICAgICAgIGNvbnN0IHN0aWZmbmVzcyA9IDE1LjA7CgogICAgICAgICAgICB0ZWFtcy5mb3JFYWNoKHRlYW0gPT4gewogICAgICAgICAgICAgICAgaWYgKCF0ZWFtKSByZXR1cm47CiAgICAgICAgICAgICAgICB0ZWFtLnBsYXllcnMuZm9yRWFjaChvdGhlciA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG90aGVyID09PSB0aGlzIHx8ICFvdGhlci5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGR4ID0gdGhpcy5tZXNoLnBvc2l0aW9uLnggLSBvdGhlci5tZXNoLnBvc2l0aW9uLng7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHkgPSB0aGlzLm1lc2gucG9zaXRpb24ueSAtIG90aGVyLm1lc2gucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkeiA9IHRoaXMubWVzaC5wb3NpdGlvbi56IC0gb3RoZXIubWVzaC5wb3NpdGlvbi56OwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR5KmR5ICsgZHoqZHo7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWluRGlzdCA9IHJlcHVsc2lvblJhZGl1cyAqIDIuMDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IG1pbkRpc3QgKiBtaW5EaXN0ICYmIGRpc3RTcSA+IDAuMDAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG92ZXJsYXAgPSBtaW5EaXN0IC0gZGlzdDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gb3ZlcmxhcCAqIHN0aWZmbmVzczsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG54ID0gZHggLyBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBueSA9IGR5IC8gZGlzdDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbnogPSBkeiAvIGRpc3Q7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gbnggKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKz0gbnkgKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gbnogKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICB0aGlzLl9hcHBseVNvZnRDb2xsaXNpb24oZHQpOwogICAgICAgICAgICB0aGlzLl9hcHBseUdvYWxDcmVhc2UoZHQpOwoKICAgICAgICAgICAgY29uc3QgaW5wdXRMZW5TcSA9IHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKTsKICAgICAgICAgICAgY29uc3QgaXNJbnB1dEFjdGl2ZSA9IGlucHV0TGVuU3EgPiAwLjAxOwoKICAgICAgICAgICAgbGV0IGN1cnJlbnRNYXhTcGVlZCA9IHRoaXMubWF4U3BlZWQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTVFJVR0dMRSBTVEFURTogSGluZGVyIG1vdmVtZW50IGJhc2VkIG9uIHByZXNzdXJlCiAgICAgICAgICAgIC8vIEluc3RlYWQgb2YgYSBiaW5hcnkgMC44IG11bHRpcGxpZXIsIHdlIHNjYWxlIGJhc2VkIG9uIGludGVuc2l0eS4KICAgICAgICAgICAgLy8gTWF4IHN0cnVnZ2xlICgxLjApIHJlZHVjZXMgc3BlZWQgdG8gNDAlLgogICAgICAgICAgICBpZiAodGhpcy5zdHJ1Z2dsZUludGVuc2l0eSA+IDApIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRNYXhTcGVlZCAqPSAoMS4wIC0gKHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgKiAwLjYpKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgc2xpZ2h0IHJlZHVjdGlvbiBpZiBlbmdhZ2VkIGJ1dCBsb3cgcHJlc3N1cmUKICAgICAgICAgICAgICAgIGN1cnJlbnRNYXhTcGVlZCAqPSAwLjk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmlzQ2hhcmdpbmcpIGN1cnJlbnRNYXhTcGVlZCAqPSAwLjk7CgogICAgICAgICAgICBpZiAoaXNJbnB1dEFjdGl2ZSkgewogICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLmlucHV0VmVjdG9yKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSBTdHJ1Z2dsZSBKaXR0ZXIgdG8gZGlyZWN0aW9uCiAgICAgICAgICAgICAgICAvLyBTaW11bGF0ZXMgd3Jlc3RsaW5nIGZvciBjb250cm9sCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdHJ1Z2dsZUludGVuc2l0eSA+IDAuMykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGppdHRlciA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgKiAwLjg7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMueCArPSBqaXR0ZXI7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMueiArPSBqaXR0ZXI7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0VmVsWCA9IF9wVmVjLnggKiBjdXJyZW50TWF4U3BlZWQ7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRWZWxaID0gX3BWZWMueiAqIGN1cnJlbnRNYXhTcGVlZDsKCiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50U3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWRSYXRpbyA9IE1hdGgubWluKDEuMCwgY3VycmVudFNwZWVkIC8gdGhpcy5tYXhTcGVlZCk7CgogICAgICAgICAgICAgICAgLy8gQWdpbGl0eSBpcyByZWR1Y2VkIHdoZW4gc3RydWdnbGluZwogICAgICAgICAgICAgICAgbGV0IGFnaWxpdHkgPSBUSFJFRS5NYXRoVXRpbHMubGVycCgxMC4wLCAyLjAsIHNwZWVkUmF0aW8pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPiAwKSBhZ2lsaXR5ICo9IDAuNTsKCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gMS4wIC0gTWF0aC5wb3coMC4wMSwgZHQgKiBhZ2lsaXR5KTsKCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gKHRhcmdldFZlbFggLSB0aGlzLnZlbG9jaXR5LngpICogdDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiArPSAodGFyZ2V0VmVsWiAtIHRoaXMudmVsb2NpdHkueikgKiB0OwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJyYWtlRmFjdG9yID0gMi4wOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IDEuMCAtIE1hdGgucG93KDAuMSwgZHQgKiBicmFrZUZhY3Rvcik7CgogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9ICgwIC0gdGhpcy52ZWxvY2l0eS54KSAqIHQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gKDAgLSB0aGlzLnZlbG9jaXR5LnopICogdDsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMC4wMSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIHRoaXMudmVsb2NpdHkueSwgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSBNYXRoLm1heCgwLCAxLjAgLSAoMi4wICogZHQpKTsKCiAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoZHQpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVWZXJ0aWNhbGl0eShkdCkgewogICAgICAgICAgICBsZXQgdGFyZ2V0WSA9IDA7CgogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CgogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2ggJiYgIXRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvQmFsbCA8IDE1LjApIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRZID0gYmFsbC5tZXNoLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRhcmdldFkgPSAwLjU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHlEaWZmID0gdGFyZ2V0WSAtIHRoaXMubWVzaC5wb3NpdGlvbi55OwoKICAgICAgICAgICAgY29uc3QgbGlmdCA9IHlEaWZmICogMTAuMCAqIGR0OwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKz0gbGlmdDsKCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gucG9zaXRpb24ueSA+IDguMCkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSA4LjA7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLTAuNTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLm1lc2gucG9zaXRpb24ueSA8IC04LjApIHsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gLTguMDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSAtMC41OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBGSVhFRDogSW1wcm92ZWQgYmFua2luZyB3aXRoIGh5c3RlcmVzaXMgdG8gcHJldmVudCBmYWNpbmcgZmxpcHMKLy8gRklYRUQ6IEltcHJvdmVkIGJhbmtpbmcgd2l0aCBoeXN0ZXJlc2lzIHRvIHByZXZlbnQgZmFjaW5nIGZsaXBzCiAgICAgICAgX3VwZGF0ZUJhbmtpbmcoZHQpIHsKICAgICAgICAgICAgY29uc3QgaW5wdXRMZW5TcSA9IHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKTsKICAgICAgICAgICAgY29uc3QgdmVsTGVuU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CgogICAgICAgICAgICBsZXQgdGFyZ2V0WWF3ID0gdGhpcy50YXJnZXRZYXc7CiAgICAgICAgICAgIGxldCBzaG91bGRVcGRhdGVZYXcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDE6IEV4cGxpY2l0IEFpbSAoQWltIFN0aWNrIC8gU3dpcGUpCiAgICAgICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IueCwgdGhpcy5vdmVycmlkZUFpbVZlY3Rvci56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUFJJT1JJVFkgMjogTW92ZW1lbnQgSW5wdXQKICAgICAgICAgICAgZWxzZSBpZiAoaW5wdXRMZW5TcSA+IHRoaXMuZmFjaW5nRGVhZHpvbmUgKiB0aGlzLmZhY2luZ0RlYWR6b25lKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMuaW5wdXRWZWN0b3IueCwgdGhpcy5pbnB1dFZlY3Rvci56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDM6IFZlbG9jaXR5IChEcmlmdGluZykKICAgICAgICAgICAgZWxzZSBpZiAodmVsTGVuU3EgPiB0aGlzLmZhY2luZ0RlYWR6b25lICogdGhpcy5mYWNpbmdEZWFkem9uZSkgewogICAgICAgICAgICAgICAgdGFyZ2V0WWF3ID0gTWF0aC5hdGFuMih0aGlzLnZlbG9jaXR5LngsIHRoaXMudmVsb2NpdHkueik7CiAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGVZYXcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB3ZSBzaG91bGQgdXBkYXRlLCBkbyBzby4gT3RoZXJ3aXNlIGtlZXAgbGFzdCB2YWxpZCB5YXcKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZVlhdykgewogICAgICAgICAgICAgICAgdGhpcy5sYXN0VmFsaWRZYXcgPSB0YXJnZXRZYXc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSB0aGlzLmxhc3RWYWxpZFlhdzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU21vb3RoIFlhdyB3aXRoIHdyYXAtYXJvdW5kIGhhbmRsaW5nCiAgICAgICAgICAgIGxldCBkaWZmID0gdGFyZ2V0WWF3IC0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICB3aGlsZSAoZGlmZiA+IE1hdGguUEkpIGRpZmYgLT0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgIHdoaWxlIChkaWZmIDwgLU1hdGguUEkpIGRpZmYgKz0gTWF0aC5QSSAqIDI7CgogICAgICAgICAgICBjb25zdCBzcGVlZFJhdGlvID0gTWF0aC5taW4oMS4wLCB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpIC8gdGhpcy5tYXhTcGVlZCk7CmNvbnN0IHR1cm5TcGVlZCA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDguMCwgNC4wLCBzcGVlZFJhdGlvKTsgLy8gUmVkdWNlZCBmcm9tIDEyLjAvNi4wIHRvIHJlZHVjZSBmbGlwcGluZwoKICAgICAgICAgICAgLy8gUHJldmVudCBzdWRkZW4gc25hcHMgd2hlbiBkaWZmIGlzIHZlcnkgbGFyZ2UgKHRlbGVwb3J0L3Jlc2V0IHNjZW5hcmlvcykKICAgICAgICAgICAgY29uc3QgbWF4WWF3Q2hhbmdlID0gTWF0aC5QSSAqIGR0ICogdHVyblNwZWVkOwogICAgICAgICAgICBjb25zdCB5YXdDaGFuZ2UgPSBNYXRoLm1heCgtbWF4WWF3Q2hhbmdlLCBNYXRoLm1pbihtYXhZYXdDaGFuZ2UsIGRpZmYgKiBkdCAqIHR1cm5TcGVlZCkpOwoKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ICs9IHlhd0NoYW5nZTsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSB0YXJnZXRZYXc7CgogICAgICAgICAgICAvLyBCYW5raW5nCiAgICAgICAgICAgIGNvbnN0IGJhbmtTZW5zaXRpdml0eSA9IDAuODsKICAgICAgICAgICAgY29uc3QgbWF4QmFuayA9IDAuNzU7CgogICAgICAgICAgICBsZXQgdGFyZ2V0QmFuayA9IC1kaWZmICogYmFua1NlbnNpdGl2aXR5OwogICAgICAgICAgICB0YXJnZXRCYW5rID0gTWF0aC5tYXgoLW1heEJhbmssIE1hdGgubWluKG1heEJhbmssIHRhcmdldEJhbmspKTsKCiAgICAgICAgICAgIGNvbnN0IGJhbmtMZXJwID0gMS4wIC0gTWF0aC5wb3coMC4wMiwgZHQpOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgKz0gKHRhcmdldEJhbmsgLSB0aGlzLmJhbmtpbmdBbW91bnQpICogYmFua0xlcnA7CgogICAgICAgICAgICAvLyBQaXRjaAogICAgICAgICAgICBjb25zdCBwaXRjaFNlbnNpdGl2aXR5ID0gMC4xOwogICAgICAgICAgICBjb25zdCBtYXhQaXRjaCA9IDEuMDsKCiAgICAgICAgICAgIGxldCB0YXJnZXRQaXRjaCA9IC10aGlzLnZlbG9jaXR5LnkgKiBwaXRjaFNlbnNpdGl2aXR5OwogICAgICAgICAgICB0YXJnZXRQaXRjaCA9IE1hdGgubWF4KC1tYXhQaXRjaCwgTWF0aC5taW4obWF4UGl0Y2gsIHRhcmdldFBpdGNoKSk7CgogICAgICAgICAgICBjb25zdCBwaXRjaExlcnAgPSAxLjAgLSBNYXRoLnBvdygwLjA1LCBkdCk7CiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgKz0gKHRhcmdldFBpdGNoIC0gdGhpcy5waXRjaEFtb3VudCkgKiBwaXRjaExlcnA7CgogICAgICAgICAgICAvLyBBcHBseSBSb3RhdGlvbgogICAgICAgICAgICBjb25zdCBmaW5hbFlhdyA9IHRoaXMuY3VycmVudFlhdyArIHRoaXMucm90YXRpb25PZmZzZXQ7CgogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5zZXRGcm9tQXhpc0FuZ2xlKF9wQXhpc1ksIGZpbmFsWWF3KTsKCiAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDEsIDAsIDApLCB0aGlzLnBpdGNoQW1vdW50KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BRdWF0KTsKCiAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLCB0aGlzLmJhbmtpbmdBbW91bnQpOwogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseShfcFF1YXQpOwoKICAgICAgICAgICAgLy8gSWRsZSBCb2IKICAgICAgICAgICAgaWYgKHZlbExlblNxIDwgMC4xICYmICF0aGlzLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IERhdGUubm93KCkgKiAwLjAwMTU7CiAgICAgICAgICAgICAgICBjb25zdCBib2JQaXRjaCA9IE1hdGguc2luKHRpbWUpICogMC4wMzsKICAgICAgICAgICAgICAgIGNvbnN0IGJvYlJvbGwgPSBNYXRoLmNvcyh0aW1lICogMC43KSAqIDAuMDI7CgpfcEV1bGVyLnNldChib2JQaXRjaCwgMCwgYm9iUm9sbCk7CiAgICAgICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUV1bGVyKF9wRXVsZXIpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BRdWF0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9jaGVja1RhY2tsZVByZXNzdXJlKGR0KSB7CiAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNFbmdhZ2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIXRoaXMudGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CiAgICAgICAgICAgIGlmICghb3Bwb25lbnRUZWFtKSByZXR1cm47CgogICAgICAgICAgICBsZXQgdG90YWxQcmVzc3VyZSA9IDA7CiAgICAgICAgICAgIGxldCBlbmdhZ2VkQ291bnQgPSAwOwogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVSYWRpdXMgPSB0aGlzLnRhY2tsZVJhZGl1czsgCgogICAgICAgICAgICAvLyBGb3J3YXJkIHZlY3RvciBmb3Igc2hpZWxkaW5nIGNoZWNrCiAgICAgICAgICAgIF9wVmVjLmNvcHkoX3BBeGlzWikuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsgCgogICAgICAgICAgICBmb3IgKGNvbnN0IGVudGl0eSBvZiBvcHBvbmVudFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCB8fCBlbnRpdHkuc3RhdHVzLm5hcCA+IDAgfHwgZW50aXR5LnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oZW50aXR5Lm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCBlZmZlY3RpdmVSYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICBlbmdhZ2VkQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgUHJlc3N1cmUgSW50ZW5zaXR5ICgwIHRvIDEgYmFzZWQgb24gZGlzdGFuY2UpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJveGltaXR5ID0gMS4wIC0gKGRpc3QgLyBlZmZlY3RpdmVSYWRpdXMpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEJhc2UgUHJlc3N1cmUgZnJvbSBBVCBzdGF0CiAgICAgICAgICAgICAgICAgICAgbGV0IHByZXNzdXJlID0gZW50aXR5LmdldFN0YXQoJ0FUJykgKiBwcm94aW1pdHk7CgogICAgICAgICAgICAgICAgICAgIC8vIERpcmVjdGlvbmFsIFNoaWVsZGluZyAoQ29udGludW91cykKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b09wcCA9IGVudGl0eS5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZG90ID0gX3BWZWMuZG90KHRvT3BwKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJZiBvcHBvbmVudCBpcyBCRUhJTkQgKGRvdCA8IC0wLjIpLCBwcmVzc3VyZSBpcyByZWR1Y2VkIChTaGllbGRpbmcpCiAgICAgICAgICAgICAgICAgICAgbGV0IGlzU2hpZWxkZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoZG90IDwgLTAuMikgewogICAgICAgICAgICAgICAgICAgICAgICBwcmVzc3VyZSAqPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzU2hpZWxkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gVGVjaCBNb2RpZmllcnMgKENvbnRpbnVvdXMgYXBwbGljYXRpb24gY2hhbmNlKQogICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkudGVjaHMudGFja2xlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgZHQgKiAwLjUpIHRoaXMuYXBwbHlTdGF0dXMoJ3Zlbm9tJywgNS4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMS4yOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCBkdCAqIDAuNSkgdGhpcy5hcHBseVN0YXR1cygnd2l0aGVyJywgNS4wLCAnRU4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMS4yOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ2RyYWluJykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkcmFpbkFtdCA9IHByZXNzdXJlICogZHQgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gZHJhaW5BbXQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eS5zdGF0cy5IUCArPSBkcmFpbkFtdDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRvdGFsUHJlc3N1cmUgKz0gcHJlc3N1cmU7CgogICAgICAgICAgICAgICAgICAgIC8vIFZpc3VhbHM6IFNwYXJrcyBvY2Nhc2lvbmFsbHkgYmFzZWQgb24gcHJlc3N1cmUKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IGR0ICogNC4wICogcHJveGltaXR5KSB7IAogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuc3Bhd25DbGFzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWlkID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkubGVycChlbnRpdHkubWVzaC5wb3NpdGlvbiwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pZC55ICs9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuc3Bhd25DbGFzaChtaWQsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gT2NjYXNpb25hbCBTaGllbGQgVGV4dAogICAgICAgICAgICAgICAgICAgIGlmIChpc1NoaWVsZGVkICYmIE1hdGgucmFuZG9tKCkgPCBkdCAqIDEuMCAmJiBnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU0hJRUxEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiYmxvY2siKTsgLy8gVG9vIHNwYW1teSwgbWF5YmUganVzdCBzb3VuZCBsYXRlcgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5pc0VuZ2FnZWQgPSAoZW5nYWdlZENvdW50ID4gMCk7CgogICAgICAgICAgICBpZiAodGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5jb3VudGVyVGltZXIgKz0gZHQ7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgRU4gRHJhaW4gKENvbnRpbnVvdXMpCiAgICAgICAgICAgICAgICAvLyBTY2FsaW5nOiAyMCBBVCBwcmVzc3VyZSAtPiBhcHByb3ggMTAgRU4gbG9zdCBwZXIgc2Vjb25kCiAgICAgICAgICAgICAgICBjb25zdCBkcmFpblJhdGUgPSB0b3RhbFByZXNzdXJlICogMC41OyAKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOIC09IGRyYWluUmF0ZSAqIGR0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgU3RydWdnbGUgSW50ZW5zaXR5IGZvciBQaHlzaWNzICgwLjAgdG8gMS4wKQogICAgICAgICAgICAgICAgLy8gTWF4IHN0cnVnZ2xlIGF0IHJvdWdobHkgMzAgcHJlc3N1cmUKICAgICAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSBNYXRoLm1pbigxLjAsIHRvdGFsUHJlc3N1cmUgLyAzMC4wKTsKCiAgICAgICAgICAgICAgICAvLyBWaXN1YWwgRmVlZGJhY2sgZm9yIERyYWluIChBY2N1bXVsYXRlIHRvIGF2b2lkIHNwYW0pCiAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSArPSBkcmFpblJhdGUgKiBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSA+IDUuMCkgewogICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bihgLSR7TWF0aC5mbG9vcih0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSl9YCwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkRGFtYWdlID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSGludCBmb3IgcGxheWVyIGlmIGVuZ2FnZWQgdG9vIGxvbmcKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVuY291bnRlclRpbWVyID4gMS4wICYmIHRoaXMuZW5jb3VudGVyVGltZXIgPCAxLjEgJiYgdGhpcy50ZWFtLmlzSHVtYW4gJiYgdGhpcy50ZWFtLmFjdGl2ZVBsYXllciA9PT0gdGhpcykgewogICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJCUkVBSyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDw9IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuZnVtYmxlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9wZXJmb3JtSmVjaHRLbm9ja2JhY2soKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwoKICAgICAgICAgICAgaWYgKCFvcHBvbmVudFRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHJhbmdlID0gNi4wOwogICAgICAgICAgICBjb25zdCBmb3JjZSA9IDI1LjA7CgogICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJKRUNIVCBTSE9UISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImdvYWwiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgb3Bwb25lbnRUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ocC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBkaXIueSA9IDAuNTsKICAgICAgICAgICAgICAgICAgICBkaXIubm9ybWFsaXplKCk7CgpwLnZlbG9jaXR5LmFkZChkaXIubXVsdGlwbHlTY2FsYXIoZm9yY2UpKTsKCiAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAyLjA7IC8vIEVuc3VyZSB0aGV5IHN0YXkgZG93bgogICAgICAgICAgICAgICAgICAgIHAuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVhY3RBY3Rpb24gPSBwLmFjdGlvbnMgJiYgcC5hY3Rpb25zWydyZWFjdCddOwogICAgICAgICAgICAgICAgICAgIGlmIChyZWFjdEFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZWFjdEFjdGlvbi5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVhY3RBY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXlPbmVTaG90KCdyZWFjdCcsIDAuMSk7Cn0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2gnLCAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTTUFDSyEiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUudHJpZ2dlckltcGFjdCkgZ2FtZS50cmlnZ2VySW1wYWN0KDAuMTUsICdzaGF0dGVyJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVtYmxlKCkgewogICAgICAgICAgICBjb25zb2xlLmxvZygiRlVNQkxFISBFTiBEZXBsZXRlZC4iKTsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgdGhpcy5tZXNoKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDUkFTSCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zdHVuVGltZXIgPSAxLjU7CgogICAgICAgICAgICBjb25zdCBiYWNrRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgYmFja0Rpci54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgYmFja0Rpci56ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgYmFja0Rpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKGJhY2tEaXIubXVsdGlwbHlTY2FsYXIoMTIuMCkpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgaWYgKGJhbGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlamVjdERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKE1hdGgucmFuZG9tKCktMC41LCAwLjgsIE1hdGgucmFuZG9tKCktMC41KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBiYWxsLnNob290KGVqZWN0RGlyLCA2LjAsICdub25lJyk7CnRoaXMubG9zZUJhbGwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZGFzaCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzRGFzaGluZyB8fCB0aGlzLmRhc2hDb29sZG93biA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKCiAgICAgICAgICAgIC8vIE9GRkVOU0U6IEJSRUFLIFRBQ0tMRQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmIHRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjb3N0ID0gMTU7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkZBSUxFRCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mdW1ibGUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDIuMDsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnYnJlYWsnOwoKX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CnRoaXMudmVsb2NpdHkuYWRkKF9wVmVjLm11bHRpcGx5U2NhbGFyKDEwLjApKTsgLy8gTmVyZmVkIGZyb20gMTUuMCBmb3IgcmVhbGlzbQoKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW1JZCA9IHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CgogICAgICAgICAgICAgICAgb3Bwb25lbnRUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgdGhpcy50YWNrbGVSYWRpdXMgKiAxLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVzaERpciA9IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBwdXNoRGlyLnkgPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuYWRkKHB1c2hEaXIubXVsdGlwbHlTY2FsYXIoMTUuMCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2gnLCAwLjIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU1RVTiEiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJSRUFLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAovLyBORVc6IFNwYXduIEJyZWFrIEdseXBoIChFeHBsb3NpdmUgQnVyc3QpCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLmdseXBoTWFuYWdlci5zcGF3bignc3RhdHVzJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC41LAogICAgICAgICAgICAgICAgICAgICAgICByb3RhdGlvblNwZWVkOiA4LjAsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IDMuMCwKICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WTogMC41CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKLy8gUGFydGljbGUgQnVyc3QgKEJyZWFrIFRhY2tsZSkKICAgICAgICAgICAgICAgIGlmIChnYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIGdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCwgbGlmZTogMC4zIH0pOwogICAgICAgICAgICAgICAgICAgIGdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIHRoaXMubWVzaC5wb3NpdGlvbiwgeyBzY2FsZTogMi41IH0pOwogICAgICAgICAgICAgICAgICAgIC8vIEJ1YmJsZSBCdXJzdAogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDMwOyBpKyspIHsKY29uc3QgYlBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChfcFZlYy5zZXQoKE1hdGgucmFuZG9tKCktMC41KSwgMS4wKyhNYXRoLnJhbmRvbSgpLTAuNSksIChNYXRoLnJhbmRvbSgpLTAuNSkpKTsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgYlBvcywgeyBzY2FsZTogMC4yICsgTWF0aC5yYW5kb20oKSAqIDAuNCB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGdhbWUudHJpZ2dlckltcGFjdCkgZ2FtZS50cmlnZ2VySW1wYWN0KDAuMTUsICdoZWF2eScpOwoKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gT0ZGRU5TRTogU1BSSU5UCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNvc3QgPSA1OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIk5PIEVOISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDEuNTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnc3ByaW50JzsKCmNvbnN0IGJ1cnN0RGlyID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgaWYgKGJ1cnN0RGlyLmxlbmd0aFNxKCkgPCAwLjEpIGJ1cnN0RGlyLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwoKdGhpcy52ZWxvY2l0eS5hZGQoYnVyc3REaXIubXVsdGlwbHlTY2FsYXIoMTIuMCkpOyAvLyBOZXJmZWQgZnJvbSAxNS4wCgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgyMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkRBU0ghIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBERUZFTlNFOiBCTE9DSyAvIFRBQ0tMRQogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGxldCBpc0Jsb2NrQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA4LjAgJiYgYmFsbC5tZXNoLnBvc2l0aW9uLnkgPiAyLjUpIHsKICAgICAgICAgICAgICAgICAgICBpc0Jsb2NrQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5kYXNoVGltZSA9IHRoaXMuZGFzaFRvdGFsVGltZTsKICAgICAgICAgICAgdGhpcy5kYXNoQ29vbGRvd24gPSAxLjU7CgogICAgICAgICAgICBjb25zdCBsZW4gPSBNYXRoLnNxcnQoeCp4ICsgeip6KTsKICAgICAgICAgICAgY29uc3QgbnggPSAobGVuID4gMCkgPyB4L2xlbiA6IDA7CiAgICAgICAgICAgIGNvbnN0IG56ID0gKGxlbiA+IDApID8gei9sZW4gOiAwOwoKaWYgKGxlbiA+IDApIHsKICAgICAgICAgICAgICAgIC8vIFNtb290aCB0dXJuIGZvciBkYXNoIGluc3RlYWQgb2Ygc25hcAogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSBNYXRoLmF0YW4yKG54LCBueik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQmxvY2tDb250ZXh0KSB7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ3ZlcnRpY2FsJzsKCiAgICAgICAgICAgICAgICBjb25zdCBkaXJUb0JhbGwgPSBiYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGRpclRvQmFsbC55ID0gMDsKCiAgICAgICAgICAgICAgICBpZiAoZGlyVG9CYWxsLmxlbmd0aFNxKCkgPiAwLjAxKSB7CiAgICAgICAgICAgICAgICAgICAgZGlyVG9CYWxsLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZGFzaFZlYy5jb3B5KGRpclRvQmFsbCkubXVsdGlwbHlTY2FsYXIoOC4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXNoVmVjLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBjYXRjaEFjdGlvbiA9IHRoaXMuYWN0aW9uc1snY2F0Y2gnXTsKICAgICAgICAgICAgICAgIGlmIChjYXRjaEFjdGlvbikgewogICAgICAgICAgICAgICAgICAgIGNhdGNoQWN0aW9uLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgIGNhdGNoQWN0aW9uLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjYXRjaEFjdGlvbi50aW1lU2NhbGUgPSAxLjU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnBsYXkoJ2NhdGNoJywgMC4xKTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRlZmF1bHQiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ2hvcml6b250YWwnOwogICAgICAgICAgICAgICAgdGhpcy5faGFzSGl0VGFja2xlID0gZmFsc2U7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdmVsb2NpdHkgaW1wdWxzZSBpbiBkYXNoIGRpcmVjdGlvbgovLyBBcHBseSB2ZWxvY2l0eSBpbXB1bHNlIGluIGRhc2ggZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBfcFZlYy5zZXQobngsIDAsIG56KTsKICAgICAgICAgICAgICAgIGlmIChfcFZlYy5sZW5ndGhTcSgpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICB9CnRoaXMudmVsb2NpdHkuYWRkKF9wVmVjLm11bHRpcGx5U2NhbGFyKDE0LjApKTsgLy8gTmVyZmVkIGZyb20gMjAuMAoKICAgICAgICAgICAgICAgIGNvbnN0IGx1bmdlQWN0aW9uID0gdGhpcy5hY3Rpb25zWyd0aHJvdyddOwogICAgICAgICAgICAgICAgaWYgKGx1bmdlQWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgbHVuZ2VBY3Rpb24uc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICAgICAgbHVuZ2VBY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLnRpbWVTY2FsZSA9IDIuMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucGxheSgndGhyb3cnLCAwLjEpOwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCkgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QoMC4wNSwgJ2RlZmF1bHQnKTsKICAgICAgICAgICAgfQoKaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKDEwKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuMyk7IAogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIERhc2ggRWZmZWN0CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXNoUG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICBkYXNoUG9zLnkgKz0gMS4wOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgZGFzaFBvcywgeyBzY2FsZTogMS41LCBsaWZlOiAwLjMgfSk7CiAgICAgICAgICAgICAgICAvLyBTcGVlZCBsaW5lcwogICAgICAgICAgICAgICAgY29uc3QgYmFjayA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDM7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBkYXNoUG9zLmNsb25lKCkuYWRkKGJhY2subXVsdGlwbHlTY2FsYXIoTWF0aC5yYW5kb20oKSkpOwogICAgICAgICAgICAgICAgICAgIHAueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2Rhc2hfc3RyZWFtJywgcCwgeyBzY2FsZTogMS41IH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY3JlYXRlSFBCYXIoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IG5ldyBUSFJFRS5Hcm91cCgpOwoKICAgICAgICAgICAgY29uc3QgYmdHZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjIsIDAuMTUpOwogICAgICAgICAgICBjb25zdCBiZ01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwMDAwMCwgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgZGVwdGhUZXN0OiBmYWxzZSB9KTsKICAgICAgICAgICAgY29uc3QgYmcgPSBuZXcgVEhSRUUuTWVzaChiZ0dlbywgYmdNYXQpOwogICAgICAgICAgICBjb250YWluZXIuYWRkKGJnKTsKCiAgICAgICAgICAgIGNvbnN0IGZpbGxHZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjE2LCAwLjExKTsKICAgICAgICAgICAgZmlsbEdlby50cmFuc2xhdGUoMC41OCwgMCwgMCk7CiAgICAgICAgICAgIGNvbnN0IGZpbGxNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgwMGZmMDAsIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIGRlcHRoVGVzdDogZmFsc2UgfSk7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsID0gbmV3IFRIUkVFLk1lc2goZmlsbEdlbywgZmlsbE1hdCk7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsLnBvc2l0aW9uLnNldCgtMC41OCwgMCwgMC4wMSk7CiAgICAgICAgICAgIGNvbnRhaW5lci5hZGQodGhpcy5ocEJhckZpbGwpOwoKICAgICAgICAgICAgdGhpcy5ocEJhciA9IGNvbnRhaW5lcjsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5ocEJhcik7CiAgICAgICAgfQoKX3VwZGF0ZUhQQmFyKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaHBCYXIgfHwgIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gVmlzaWJpbGl0eSBDaGVjazogT25seSBzaG93IGluIEFjdGl2ZS9QcmFjdGljZSBzdGF0ZXMKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgYWxsb3dlZFN0YXRlID0gZ2FtZSAmJiAoZ2FtZS5zdGF0ZSA9PT0gJ2FjdGl2ZScgfHwgZ2FtZS5zdGF0ZSA9PT0gJ2tpY2tvZmYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghYWxsb3dlZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5ocEJhci5wb3NpdGlvbi5jb3B5KHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIHRoaXMuaHBCYXIucG9zaXRpb24ueSArPSAyLjI7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEpIHsKICAgICAgICAgICAgICAgIHRoaXMuaHBCYXIubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBwY3QgPSBNYXRoLm1heCgwLCB0aGlzLnN0YXRzLkhQIC8gdGhpcy5zdGF0cy5tYXhIUCk7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsLnNjYWxlLnNldFgocGN0KTsKCiAgICAgICAgICAgIGlmIChwY3QgPiAwLjUpIHRoaXMuaHBCYXJGaWxsLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweDAwZmYwMCk7CiAgICAgICAgICAgIGVsc2UgaWYgKHBjdCA+IDAuMjUpIHRoaXMuaHBCYXJGaWxsLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmZmYwMCk7CiAgICAgICAgICAgIGVsc2UgdGhpcy5ocEJhckZpbGwubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmYwMDAwKTsKCiAgICAgICAgICAgIC8vIEhpZGUgaWYgZnVsbCBIUCB0byByZWR1Y2UgY2x1dHRlciwgdW5sZXNzIGluIHByYWN0aWNlIG1vZGUKICAgICAgICAgICAgY29uc3QgYWx3YXlzU2hvdyA9IGdhbWUgJiYgZ2FtZS5nYW1lTW9kZSA9PT0gJ3ByYWN0aWNlJzsKICAgICAgICAgICAgdGhpcy5ocEJhci52aXNpYmxlID0gKHBjdCA8IDAuOTggfHwgYWx3YXlzU2hvdyk7CiAgICAgICAgfQoKICAgICAgICBnYWluRXhwKGFtb3VudCkgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSB8fCB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CgogICAgICAgICAgICB0aGlzLmV4cCArPSBhbW91bnQ7CgogICAgICAgICAgICBpZiAodGhpcy5leHAgPj0gdGhpcy5uZXh0TGV2ZWxFeHApIHsKICAgICAgICAgICAgICAgIHRoaXMubGV2ZWxVcCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsZXZlbFVwKCkgewogICAgICAgICAgICB0aGlzLmxldmVsKys7CiAgICAgICAgICAgIHRoaXMuZXhwIC09IHRoaXMubmV4dExldmVsRXhwOwogICAgICAgICAgICB0aGlzLm5leHRMZXZlbEV4cCA9IE1hdGguZmxvb3IodGhpcy5uZXh0TGV2ZWxFeHAgKiAxLjUpOwoKICAgICAgICAgICAgY29uc3Qga2V5cyA9IFsnSFAnLCAnRU4nLCAnQVQnLCAnUEEnLCAnQkwnLCAnU0gnLCAnQ0EnLCAnU1AnXTsKCiAgICAgICAgICAgIGNvbnN0IGhwR2FpbiA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDIwKSArIDEwOwogICAgICAgICAgICB0aGlzLnN0YXRzLm1heEhQICs9IGhwR2FpbjsKICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCA9IHRoaXMuc3RhdHMubWF4SFA7CgogICAgICAgICAgICBrZXlzLmZvckVhY2goayA9PiB7CiAgICAgICAgICAgICAgICBpZiAoayA9PT0gJ0hQJykgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPiAwLjQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnYWluID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMikgKyAxOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHNba10gKz0gZ2FpbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gcmVhY2hlZCBMZXZlbCAke3RoaXMubGV2ZWx9IWApOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgdGhpcy5tZXNoKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJMRVZFTCBVUCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jaGVja1RhY2tsZUNvbGxpc2lvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW0gfHwgdGhpcy5faGFzSGl0VGFja2xlKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwoKICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3Bwb25lbnRUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG9wcC5tZXNoLnBvc2l0aW9uKTsKCmlmIChkaXN0IDwgMy4wKSB7IC8vIEluY3JlYXNlZCBmcm9tIDIuMCBmb3IgZWFzaWVyIGhpdHMKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNvbHZlVGFja2xlSGl0KG9wcCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGFzSGl0VGFja2xlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9yZXNvbHZlVGFja2xlSGl0KG9wcCkgewogICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKC0wLjUpOwogICAgICAgICAgICB0aGlzLnBsYXkoJ2lkbGUnLCAwLjIpOwoKICAgICAgICAgICAgY29uc3QgYXQgPSB0aGlzLmdldFN0YXQoJ0FUJyk7CiAgICAgICAgICAgIGxldCBkYW1hZ2UgPSBhdCAqIDMuMDsKCiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnRhY2tsZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgb3BwLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDEwLjApOwogICAgICAgICAgICAgICAgZGFtYWdlICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50ZWNocy50YWNrbGUgPT09ICd3aXRoZXInKSB7CiAgICAgICAgICAgICAgICBvcHAuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDEwLjAsICdFTicpOwogICAgICAgICAgICAgICAgZGFtYWdlICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50ZWNocy50YWNrbGUgPT09ICdkcmFpbicpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgKz0gMjA7CiAgICAgICAgICAgICAgICBvcHAuc3RhdHMuSFAgLT0gMjA7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJEUkFJTiIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBvcHAuY3VycmVudEVOIC09IGRhbWFnZTsKCmlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUmVtb3ZlZCAiRU4iIHN1ZmZpeCBmb3IgY2xlYW5lciBsb29rCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgJHtNYXRoLmZsb29yKGRhbWFnZSl9YCwgb3BwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCQU0hIiwgb3BwLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAob3BwLmN1cnJlbnRFTiA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgb3BwLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBvcHAuc3R1blRpbWVyID0gMC41OwogICAgICAgICAgICAgICAgICAgIG9wcC5wbGF5T25lU2hvdCgncmVhY3QnLCAwLjEpOwp9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMudGFja2xlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQodGhpcywgdGhpcy50ZWNocy50YWNrbGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG9wcC5zdHVuVGltZXIgPSAxLjA7CiAgICAgICAgICAgICAgICBvcHAucGxheU9uZVNob3QoJ3JlYWN0JywgMC4xKTsKaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTTUFDSyEiLCBvcHAubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBwdXNoRGlyID0gb3BwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgcHVzaERpci55ID0gMC4yOwogICAgICAgICAgICBvcHAudmVsb2NpdHkuYWRkKHB1c2hEaXIubXVsdGlwbHlTY2FsYXIoMTIuMCkpOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjEsICdoZWF2eScpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuOCk7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaCkgewpjb25zdCBtaWQgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQob3BwLm1lc2gucG9zaXRpb24pLm11bHRpcGx5U2NhbGFyKDAuNSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaChtaWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAovLyBCdWJibGUgQnVyc3QgKFRhY2tsZSBIaXQpCi8vIEJ1YmJsZSBCdXJzdCAoVGFja2xlIEhpdCkKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG1pZCA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmxlcnAob3BwLm1lc2gucG9zaXRpb24sIDAuNSk7CiAgICAgICAgICAgICAgICBtaWQueSArPSAxLjA7CiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzMDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYnViYmxlUG9zID0gbWlkLmNsb25lKCkuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKChNYXRoLnJhbmRvbSgpLTAuNSkqMS41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjEuNSwgKE1hdGgucmFuZG9tKCktMC41KSoxLjUpKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBidWJibGVQb3MsIHsgc2NhbGU6IDAuMTUgKyBNYXRoLnJhbmRvbSgpICogMC4zNSB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5R29hbENyZWFzZShkdCkgewoKICAgICAgICAgICAgY29uc3QgZ29hbHMgPSBbCgogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgNDYpLAogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgLTQ2KQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gMTAuMDsKCiAgICAgICAgICAgIGdvYWxzLmZvckVhY2goZ29hbCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBkeCA9IHRoaXMubWVzaC5wb3NpdGlvbi54IC0gZ29hbC54OwogICAgICAgICAgICAgICAgY29uc3QgZHogPSB0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWwuejsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IGR4KmR4ICsgZHoqZHo7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IHJhZGl1cyAqIHJhZGl1cykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZGlzdFNxKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWCA9IGRpc3QgPiAwID8gZHggLyBkaXN0IDogMTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWiA9IGRpc3QgPiAwID8gZHogLyBkaXN0IDogMDsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSA1MC4wOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSBwdXNoWCAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9IHB1c2haICogZm9yY2UgKiBkdDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByYWRpdXMgLSAwLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xhbXBSYXRpbyA9IHJhZGl1cyAvIChkaXN0ICsgMC4wMDEpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueCA9IGdvYWwueCArIGR4ICogY2xhbXBSYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSBnb2FsLnogKyBkeiAqIGNsYW1wUmF0aW87CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguUGxheWVyID0gUGxheWVyOwp9KSgpOwo=","/Player.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBCYWxsIExhYiAvIERldlRvb2xzOiB0aHJvdyAmIGN1cnZlIG1hcHBpbmcga25vYnMKICAgIC8vIChEZWZhdWx0cyBtYXRjaCBjdXJyZW50IGZlZWw7IERldlRvb2xzIGNhbiB0d2VhayBhdCBydW50aW1lLikKICAgIHdpbmRvdy5mbHV4LlRocm93Q29uZmlnID0gd2luZG93LmZsdXguVGhyb3dDb25maWcgfHwgewogICAgICAgIFNXSVBFX01JTl9QWDogMjAsCiAgICAgICAgQUlNX0RYX1NDQUxFOiAxLjAsCiAgICAgICAgQUlNX0RZX1NDQUxFOiAxLjAsCgogICAgICAgIFBPV0VSX0JBU0U6IDEuMCwKICAgICAgICBQT1dFUl9SQU5HRTogMC44LCAgICAgICAgICAvLyBCYXNlIG11bHRpcGxpZXIgPSBQT1dFUl9CQVNFICsgcmF0aW8qUE9XRVJfUkFOR0UKICAgICAgICBQT1dFUl9NQVhfQk9OVVNfUkFUSU86IDAuOTUsCiAgICAgICAgUE9XRVJfTUFYX01VTFRJUExJRVI6IDIuNSwKCiAgICAgICAgQ1VSVkVfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBDVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEOiAwLjI1LAogICAgICAgIENVUlZFX1NQSU5fU0NBTEU6IDEwMDAuMCwKICAgICAgICBDVVJWRV9TUEVFRF9NVUxUOiAxLjUsCiAgICAgICAgQ1VSVkVfU1BJTl9DQVA6IDE1MDAuMCwKICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDUwMC4wCiAgICB9OwoKLy8gUmV1c2FibGUgbWF0aCBvYmplY3RzCmNvbnN0IF9wVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9wVmVjMiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfcFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BRdWF0MiA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRhcmdldFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BFdWxlciA9IG5ldyBUSFJFRS5FdWxlcigpOwogICAgY29uc3QgX3BBeGlzWSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApOwogICAgY29uc3QgX3BBeGlzWiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpOwogICAgY29uc3QgX3BJbnZRdWF0ID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgIGNvbnN0IF9wVG1wUXVhdCA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRtcEV1bGVyID0gbmV3IFRIUkVFLkV1bGVyKCk7CgoKY2xhc3MgUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSA9ICdNRicpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLnJvbGUgPSByb2xlOwogICAgICAgICAgICB0aGlzLnRlYW0gPSBudWxsOyAvLyBBc3NpZ25lZCBieSBUZWFtLmFkZFBsYXllcgogICAgICAgICAgICB0aGlzLmhvbWVQb3NpdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLm1peGVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hY3Rpb25zID0ge307CiAgICAgICAgICAgIHRoaXMuYWN0aXZlQWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdpZGxlJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2xhc3RMb2NvbW90aW9uID0gJ2lkbGUnOwp0aGlzLmlucHV0VmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAvLyBQaHlzaWNzIChEcmlmdC9JbmVydGlhIE1vZGVsKQogICAgICAgICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYWNjZWxlcmF0aW9uID0gMTIuMDsKICAgICAgICAgICAgdGhpcy5kcmFnID0gMy4wOwogICAgICAgICAgICB0aGlzLm1heFNwZWVkID0gOC4wOwogICAgICAgICAgICAvLyBCb25lIHJlZmVyZW5jZSBmb3IgaG9sZGluZyBiYWxsCiAgICAgICAgICAgIHRoaXMuaGFuZEJvbmUgPSBudWxsOwovLyBQcm9jZWR1cmFsIGFuaW1hdGlvbiBib25lIHJlZnMgKGZpbGxlZCBpbiBzZXRNZXNoKQp0aGlzLmJvbmVzID0gewogICAgaGlwczogbnVsbCwKICAgIHNwaW5lOiBudWxsLAogICAgY2hlc3Q6IG51bGwsCiAgICBuZWNrOiBudWxsLAogICAgaGVhZDogbnVsbCwKICAgIHJVcHBlckFybTogbnVsbCwKICAgIHJGb3JlQXJtOiBudWxsLAogICAgckhhbmQ6IG51bGwsCiAgICBsVXBwZXJBcm06IG51bGwsCiAgICBsRm9yZUFybTogbnVsbCwKICAgIGxIYW5kOiBudWxsCn07CnRoaXMuX2JvbmVCYXNlUXVhdHMgPSBudWxsOyAvLyBPcHRpb25hbCBmdXR1cmUgdXNlCnRoaXMuX3Byb2NBbmltVGltZSA9IDA7CnRoaXMuX3Ntb290aGVkU3BlZWQgPSAwOwp0aGlzLl9tb3ZpbmdMYXRjaCA9IGZhbHNlOwoKdGhpcy5jYW5DYXRjaCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2F0Y2hDb29sZG93biA9IDA7IC8vIFJlcGxhY2VzIHNldFRpbWVvdXQgZm9yIHNhZmV0eQoKICAgICAgICAgICAgLy8gQmxpdHpiYWxsIFN0YXRzCiAgICAgICAgICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLAogICAgICAgICAgICAgICAgbWF4SFA6IDEwMCwKICAgICAgICAgICAgICAgIEVOOiAzMCwKICAgICAgICAgICAgICAgIEFUOiAxMCwKICAgICAgICAgICAgICAgIFBBOiAxNSwKICAgICAgICAgICAgICAgIEJMOiAxMCwKICAgICAgICAgICAgICAgIFNIOiAxNSwKICAgICAgICAgICAgICAgIENBOiAxMCwKICAgICAgICAgICAgICAgIFNQOiA2MAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gTGV2ZWxpbmcgU3lzdGVtCiAgICAgICAgICAgIHRoaXMubGV2ZWwgPSAxOwogICAgICAgICAgICB0aGlzLmV4cCA9IDA7CiAgICAgICAgICAgIHRoaXMubmV4dExldmVsRXhwID0gMTAwOwoKICAgICAgICAgICAgLy8gU3RhdHVzIEVmZmVjdHMgJiBUZWNobmlxdWVzCiAgICAgICAgICAgIHRoaXMuc3RhdHVzID0gewogICAgICAgICAgICAgICAgdmVub206IDAsCiAgICAgICAgICAgICAgICBuYXA6IDAsCiAgICAgICAgICAgICAgICB3aXRoZXI6IHsgUEE6IDAsIFNIOiAwLCBBVDogMCwgQkw6IDAsIENBOiAwLCBTUDogMCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLm1hcmtpbmcgPSBudWxsOwogICAgICAgICAgICB0aGlzLmxlYXJuZWRUZWNocyA9IFtdOwoKICAgICAgICAgICAgdGhpcy50ZWNocyA9IHsKICAgICAgICAgICAgICAgIHRhY2tsZTogbnVsbCwKICAgICAgICAgICAgICAgIHNob290OiBudWxsLAogICAgICAgICAgICAgICAgcGFzczogbnVsbCwKICAgICAgICAgICAgICAgIHBhc3NpdmU6IG51bGwKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFZpc3VhbHMKICAgICAgICAgICAgdGhpcy5iYXNlQ29sb3JIZXggPSAweGZmZmZmZjsKICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscyA9IFtdOwogICAgICAgICAgICB0aGlzLmF1cmFNZXNoID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5yb3RhdGlvbk9mZnNldCA9IDA7CnRoaXMuYmFzZVNjYWxlID0gMS4xNzsgLy8gSW5jcmVhc2VkIH44JQoKICAgICAgICAgICAgLy8gUmVhbC10aW1lIFN0YXRzCiAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gdGhpcy5zdGF0cy5FTjsKdGhpcy50YWNrbGVSYWRpdXMgPSAyLjA7IC8vIFJlZHVjZWQgZnJvbSAyLjUgdG8gcmVkdWNlIHN3YXJtIGxvY2sKCiAgICAgICAgICAgIHRoaXMuc3BlZWQgPSA0LjA7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gRGFzaCBTdGF0ZQogICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5kYXNoVG90YWxUaW1lID0gMC41Owp0aGlzLmRhc2hDb29sZG93biA9IDA7CiAgICAgICAgICAgIHRoaXMuZGFzaFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBGZWVkYmFjayBBY2N1bXVsYXRvcnMKICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UgPSAwOwogICAgICAgICAgICB0aGlzLl9kYW1hZ2VUaW1lciA9IDA7CgogICAgICAgICAgICAvLyBIUCBCYXIKICAgICAgICAgICAgdGhpcy5ocEJhciA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsID0gbnVsbDsKCiAgICAgICAgICAgIC8vIEdhbWVwbGF5IEZsb3cgVGltZXJzCiAgICAgICAgICAgIHRoaXMuc3R1blRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMDsKCiAgICAgICAgICAgIC8vIEJhbmtpbmcgJiBWZXJ0aWNhbGl0eQogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLnRhcmdldFkgPSAwOwoKICAgICAgICAgICAgLy8gRW5jb3VudGVyIFN5c3RlbQogICAgICAgICAgICB0aGlzLmlzRW5nYWdlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNsYXNoVGltZXIgPSAwOwoKICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7IC8vIFRyYWNrIGR1cmF0aW9uIG9mIGN1cnJlbnQgZW5nYWdlbWVudAogICAgICAgICAgICAvLyBDaGFyZ2UgTWVjaGFuaWMKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4Q2hhcmdlVGltZSA9IDEuNTsKCiAgICAgICAgICAgIC8vIEZJWEVEOiBJbXByb3ZlZCBSb3RhdGlvbiBTdGF0ZSB3aXRoIGh5c3RlcmVzaXMKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gMDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLmxhc3RWYWxpZFlhdyA9IDA7IC8vIFN0b3JlIGxhc3Qga25vd24gZ29vZCB5YXcgZm9yIGRlYWR6b25lIGhhbmRsaW5nCiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmZhY2luZ0RlYWR6b25lID0gMC4zOyAvLyBNaW5pbXVtIGlucHV0L3ZlbG9jaXR5IG1hZ25pdHVkZSB0byB1cGRhdGUgZmFjaW5nCgogICAgICAgICAgICAvLyBQYXJ0aWNsZSBFbWlzc2lvbiBUaW1lcnMKICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMgPSB7CiAgICAgICAgICAgICAgICB2ZW5vbTogMCwKICAgICAgICAgICAgICAgIG5hcDogMCwKICAgICAgICAgICAgICAgIHdpdGhlcjogMAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gRGV2VG9vbHMgRmxhZ3MKICAgICAgICAgICAgdGhpcy5pc0dvZE1vZGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBhc3MgVGFyZ2V0IEluZGljYXRvcgovLyBQYXNzIFRhcmdldCBJbmRpY2F0b3IKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yID0gbnVsbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJ1YmJsZSBUcmFpbCBUaW1lcgogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDA7Cgp0aGlzLl9kYXNoUGFydGljbGVUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSAwOyAvLyBDb250aW51b3VzIHByZXNzdXJlIGZhY3RvciAoMC4wIHRvIDEuMCkKICAgICAgICB9CgogICAgICAgIHN5bmNSb3RhdGlvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgZXVsZXIgPSBuZXcgVEhSRUUuRXVsZXIoKS5zZXRGcm9tUXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbiwgJ1lYWicpOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgPSBldWxlci55IC0gdGhpcy5yb3RhdGlvbk9mZnNldDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgIHRoaXMubGFzdFZhbGlkWWF3ID0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ID0gMDsKICAgICAgICB9CgogICAgICAgIGdldFN0YXQobmFtZSkgewogICAgICAgICAgICBsZXQgdmFsID0gdGhpcy5zdGF0c1tuYW1lXTsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltuYW1lXSA+IDApIHsKICAgICAgICAgICAgICAgIHZhbCAqPSAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICB9CgogICAgICAgIGFwcGx5U3RhdHVzKHR5cGUsIGR1cmF0aW9uLCBzdWJUeXBlID0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMudmVub20gPiAxLjA7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy52ZW5vbSA9IE1hdGgubWF4KHRoaXMuc3RhdHVzLnZlbm9tLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnJvbGV9IHBvaXNvbmVkIWApOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQT0lTT04iLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMubmFwID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gTWF0aC5tYXgodGhpcy5zdGF0dXMubmFwLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gZmVsbCBhc2xlZXAhYCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNMRUVQIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3dpdGhlcicgJiYgc3ViVHlwZSkgewogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFZhbCA9IHRoaXMuc3RhdHVzLndpdGhlcltzdWJUeXBlXSB8fCAwOwogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gY3VycmVudFZhbCA+IDEuMDsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLndpdGhlcltzdWJUeXBlXSA9IE1hdGgubWF4KGN1cnJlbnRWYWwsIGR1cmF0aW9uKTsKCiAgICAgICAgICAgICAgICBpZiAoIXdhc0FjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gd2l0aGVyZWQgJHtzdWJUeXBlfSFgKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgV0lUSEVSICR7c3ViVHlwZX1gLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZURlcml2ZWRTdGF0cygpIHsKICAgICAgICAgICAgY29uc3Qgc3AgPSB0aGlzLmdldFN0YXQoJ1NQJyk7CiAgICAgICAgICAgIHRoaXMubWF4U3BlZWQgPSA1LjAgKyAoc3AgLyAxNS4wKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSB0aGlzLmdldFN0YXQoJ0VOJyk7CiAgICAgICAgfQoKc2V0TWVzaChzb3VyY2VNZXNoLCBhbmltYXRpb25zKSB7CiAgICAgICAgICAgIHRoaXMubWVzaCA9IHNvdXJjZU1lc2g7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUhQQmFyKCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUF1cmEoKTsKICAgICAgICAgICAgdGhpcy5fY3JlYXRlUGFzc1RhcmdldEluZGljYXRvcigpOwoKICAgICAgICAgICAgLy8gQ3VzdG9tIENoYXJhY3RlciBTY2FsaW5nCiAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUuaW5jbHVkZXMoJ1RpZHVzJykpIHRoaXMuYmFzZVNjYWxlID0gMS42OwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB0aGlzLmJhc2VTY2FsZSA9IDEuNDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXNoLnNjYWxlLnNldFNjYWxhcih0aGlzLmJhc2VTY2FsZSk7CgogICAgICAgICAgICB0aGlzLm1lc2gudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCAmJiBub2RlLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udmVydE9uZSA9IChtYXQpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXA6IG1hdC5tYXAgfHwgbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBuZXcgVEhSRUUuQ29sb3IoMHhmZmZmZmYpLCAvLyBGT1JDRSBXSElURTogSWdub3JlIHNvdXJjZSBjb2xvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6ICEhbWF0LnRyYW5zcGFyZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogKG1hdC5vcGFjaXR5ICE9PSB1bmRlZmluZWQgPyBtYXQub3BhY2l0eSA6IDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxwaGFUZXN0OiAobWF0LmFscGhhVGVzdCAhPT0gdW5kZWZpbmVkID8gbWF0LmFscGhhVGVzdCA6IDApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2lkZTogbWF0LnNpZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IG1hdC5kZXB0aFRlc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBtYXQuZGVwdGhXcml0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNraW5uaW5nOiAhIW5vZGUuaXNTa2lubmVkTWVzaAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5wdXNoKHsgbWF0ZXJpYWw6IG0sIGJhc2VDb2xvcjogbS5jb2xvci5jbG9uZSgpIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBBcnJheS5pc0FycmF5KG5vZGUubWF0ZXJpYWwpCiAgICAgICAgICAgICAgICAgICAgICAgID8gbm9kZS5tYXRlcmlhbC5tYXAoY29udmVydE9uZSkKICAgICAgICAgICAgICAgICAgICAgICAgOiBjb252ZXJ0T25lKG5vZGUubWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzQm9uZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSAobm9kZS5uYW1lIHx8ICcnKS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBDb3JlIHNwaW5lL2hlYWQgY2hhaW4gKE1peGFtby1mcmllbmRseSkKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuaGlwcyAmJiBuYW1lLmluY2x1ZGVzKCdoaXBzJykpIHRoaXMuYm9uZXMuaGlwcyA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLnNwaW5lICYmIG5hbWUuaW5jbHVkZXMoJ3NwaW5lJykgJiYgIW5hbWUuaW5jbHVkZXMoJ3NwaW5lMicpICYmICFuYW1lLmluY2x1ZGVzKCdzcGluZV8yJykpIHRoaXMuYm9uZXMuc3BpbmUgPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5jaGVzdCAmJiAobmFtZS5pbmNsdWRlcygnY2hlc3QnKSB8fCBuYW1lLmluY2x1ZGVzKCdzcGluZTInKSB8fCBuYW1lLmluY2x1ZGVzKCdzcGluZV8yJykpKSB0aGlzLmJvbmVzLmNoZXN0ID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubmVjayAmJiBuYW1lLmluY2x1ZGVzKCduZWNrJykpIHRoaXMuYm9uZXMubmVjayA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmhlYWQgJiYgbmFtZS5pbmNsdWRlcygnaGVhZCcpKSB0aGlzLmJvbmVzLmhlYWQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1JpZ2h0ID0gbmFtZS5pbmNsdWRlcygncmlnaHQnKSB8fCBuYW1lLmVuZHNXaXRoKCdyJykgfHwgbmFtZS5pbmNsdWRlcygnX3InKSB8fCBuYW1lLmluY2x1ZGVzKCcucicpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzTGVmdCAgPSBuYW1lLmluY2x1ZGVzKCdsZWZ0JykgIHx8IG5hbWUuZW5kc1dpdGgoJ2wnKSB8fCBuYW1lLmluY2x1ZGVzKCdfbCcpIHx8IG5hbWUuaW5jbHVkZXMoJy5sJyk7CgogICAgICAgICAgICAgICAgICAgIC8vIEFybXMvaGFuZHMgKE1peGFtbzogbWl4YW1vcmlnUmlnaHRBcm0vUmlnaHRGb3JlQXJtL1JpZ2h0SGFuZCkKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuclVwcGVyQXJtICYmIChuYW1lLmluY2x1ZGVzKCdyaWdodGFybScpIHx8IChpc1JpZ2h0ICYmIG5hbWUuaW5jbHVkZXMoJ3VwcGVyYXJtJykpKSkgdGhpcy5ib25lcy5yVXBwZXJBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5yRm9yZUFybSAmJiAobmFtZS5pbmNsdWRlcygncmlnaHRmb3JlYXJtJykgfHwgKGlzUmlnaHQgJiYgbmFtZS5pbmNsdWRlcygnZm9yZWFybScpKSkpIHRoaXMuYm9uZXMuckZvcmVBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5ySGFuZCAmJiAoKG5hbWUuaW5jbHVkZXMoJ2hhbmQnKSAmJiBpc1JpZ2h0KSB8fCBuYW1lLmluY2x1ZGVzKCdyaWdodGhhbmQnKSkpIHRoaXMuYm9uZXMuckhhbmQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubFVwcGVyQXJtICYmIChuYW1lLmluY2x1ZGVzKCdsZWZ0YXJtJykgfHwgKGlzTGVmdCAmJiBuYW1lLmluY2x1ZGVzKCd1cHBlcmFybScpKSkpIHRoaXMuYm9uZXMubFVwcGVyQXJtID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubEZvcmVBcm0gJiYgKG5hbWUuaW5jbHVkZXMoJ2xlZnRmb3JlYXJtJykgfHwgKGlzTGVmdCAmJiBuYW1lLmluY2x1ZGVzKCdmb3JlYXJtJykpKSkgdGhpcy5ib25lcy5sRm9yZUFybSA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmxIYW5kICYmICgobmFtZS5pbmNsdWRlcygnaGFuZCcpICYmIGlzTGVmdCkgfHwgbmFtZS5pbmNsdWRlcygnbGVmdGhhbmQnKSkpIHRoaXMuYm9uZXMubEhhbmQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICAvLyBCYWNrLWNvbXBhdDogYmFsbCBhdHRhY2htZW50IHVzZXMgaGFuZEJvbmUKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaGFuZEJvbmUgJiYgdGhpcy5ib25lcy5ySGFuZCkgdGhpcy5oYW5kQm9uZSA9IHRoaXMuYm9uZXMuckhhbmQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5taXhlciA9IG5ldyBUSFJFRS5BbmltYXRpb25NaXhlcih0aGlzLm1lc2gpOwoKICAgICAgICAgICAgaWYgKGFuaW1hdGlvbnMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IF9ub3JtQ2xpcE5hbWUgPSAocykgPT4gKHMgfHwgJycpCiAgICAgICAgICAgICAgICAgICAgLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvW19cLV0rL2csICcgJykKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXHMrL2csICcgJykKICAgICAgICAgICAgICAgICAgICAudHJpbSgpOwoKICAgICAgICAgICAgICAgIC8vIEhlbHBlciB0byBzdHJpcCBsZWcgdHJhY2tzIGZyb20gYWN0aW9uIGNsaXBzCiAgICAgICAgICAgICAgICBjb25zdCBfc3RyaXBMZWdzID0gKGNsaXApID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFja3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICBjbGlwLnRyYWNrcy5mb3JFYWNoKHQgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZWdleCB0byBtYXRjaCBsZWcgYm9uZXMgKE1peGFtbyBzdHlsZTogUmlnaHRVcExlZywgUmlnaHRMZWcsIFJpZ2h0Rm9vdCwgUmlnaHRUb2VCYXNlKQogICAgICAgICAgICAgICAgICAgICAgICAvLyBBbHNvIGdlbmVyaWMgIkxlZyIsICJGb290IgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXQubmFtZS5tYXRjaCgvKFVwTGVnfExlZ3xGb290fFRvZSkvaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYWNrcy5wdXNoKHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgY2xpcC50cmFja3MgPSB0cmFja3M7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNsaXA7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGFuaW1hdGlvbnMuZm9yRWFjaCgoY2xpcCkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBfbm9ybUNsaXBOYW1lKGNsaXAubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzID0gKHJlKSA9PiByZS50ZXN0KG5hbWUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxldCBpc0xvY29tb3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBsZXQgYWN0aW9uS2V5ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIENvcmUgbG9jb21vdGlvbiAtLS0KICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC90cmVhZHx0cmVhZGluZ3xpZGxlfGZsb2F0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2lkbGUnOwogICAgICAgICAgICAgICAgICAgICAgICBpc0xvY29tb3Rpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9kYXNofHNwcmludHxidXJzdHxmYXN0XHMqc3dpbXxzd2ltXHMqZmFzdC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdkYXNoJzsKICAgICAgICAgICAgICAgICAgICAgICAgaXNMb2NvbW90aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvc3dpbXxmcmVlc3R5bGV8Y3Jhd2wvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAnc3dpbSc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzTG9jb21vdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIFRocm93aW5nIChwYXNzL3Nob3QgdmFyaWFudHMgaWYgcHJlc2VudCkgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3Rocm93fHRvc3N8cGl0Y2gvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC9zaG9vdHxzaG90fGdvYWwvKSkgYWN0aW9uS2V5ID0gJ3Rocm93X3Nob3QnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChoYXMoL3Bhc3MvKSkgYWN0aW9uS2V5ID0gJ3Rocm93X3Bhc3MnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFjdGlvbktleSA9ICd0aHJvdyc7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBDYXRjaGluZyAoanVtcC9haXIgdmFyaWFudHMgaWYgcHJlc2VudCkgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2NhdGNofHJlY2VpdmV8Z3JhYnxpbnRlcmNlcHQvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC9qdW1wfGxlYXB8YWlyfGRpdmUvKSkgYWN0aW9uS2V5ID0gJ2NhdGNoX2p1bXAnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFjdGlvbktleSA9ICdjYXRjaCc7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBIaXQgLyBSZWFjdCAtLS0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvcmVhY3R8aGl0fGh1cnR8ZGFtYWdlfHN0YWdnZXJ8a25vY2svKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAncmVhY3QnOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gT3B0aW9uYWwgc3RhdGVzIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jaGFyZ2V8YWltfHJlYWR5fHdpbmR1cHxob2xkLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2NoYXJnZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3RhY2tsZXxjaGVja3xyYW0vKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAndGFja2xlJzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvYmxvY2t8c2F2ZS8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2NlbGVicmF0ZXx2aWN0b3J5fGNoZWVyLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2NlbGVicmF0ZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gY2xpcC5uYW1lOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gU3RyaXAgbGVncyBmcm9tIG5vbi1sb2NvbW90aW9uIGNsaXBzIHRvIGFsbG93IHRyZWFkaW5nIHdhdGVyIG92ZXJsYXkKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTG9jb21vdGlvbiAmJiBhY3Rpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3N0cmlwTGVncyhjbGlwKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChhY3Rpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3Rpb25zW2FjdGlvbktleV0gPSB0aGlzLm1peGVyLmNsaXBBY3Rpb24oY2xpcCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFN0YXJ0IGRlZmF1bHQgbG9jb21vdGlvbgogICAgICAgICAgICBpZiAodGhpcy5hY3Rpb25zWydpZGxlJ10pIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24oJ2lkbGUnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrCiAgICAgICAgICAgICAgICBjb25zdCBmaXJzdCA9IE9iamVjdC52YWx1ZXModGhpcy5hY3Rpb25zKVswXTsKICAgICAgICAgICAgICAgIGlmKGZpcnN0KSBmaXJzdC5wbGF5KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9uZS1zaG90IGFuaW1hdGlvbiBsaXN0ZW5lcgogICAgICAgICAgICBpZiAodGhpcy5taXhlcikgewogICAgICAgICAgICAgICAgdGhpcy5taXhlci5hZGRFdmVudExpc3RlbmVyKCdmaW5pc2hlZCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9hbmltTG9ja2VkKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLmFjdGlvbikgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBmaW5pc2hlZCBhY3Rpb24gaXMgb3VyIGN1cnJlbnQgb25lLXNob3QKICAgICAgICAgICAgICAgICAgICBpZiAoZS5hY3Rpb24gPT09IHRoaXMuYWN0aXZlT25lU2hvdCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hbmltTG9ja2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvY2tlZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVPbmVTaG90ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJldHVybiB0byBsb2NvbW90aW9uIHVwZGF0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMTUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE5ldyBtZXRob2QgZm9yIGJhc2UgbGF5ZXIgKGxlZ3MvYm9keSBtb3ZlbWVudCkKICAgICAgICBwbGF5TG9jb21vdGlvbihhY3Rpb25OYW1lLCBkdXJhdGlvbiA9IDAuNSkgewogICAgICAgICAgICBjb25zdCBuZXdBY3Rpb24gPSB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgIGlmICghbmV3QWN0aW9uIHx8IG5ld0FjdGlvbiA9PT0gdGhpcy5hY3RpdmVMb2NvbW90aW9uKSByZXR1cm47CgogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVMb2NvbW90aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUxvY29tb3Rpb24uZmFkZU91dChkdXJhdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5ld0FjdGlvbi5yZXNldCgpOwogICAgICAgICAgICBuZXdBY3Rpb24uZmFkZUluKGR1cmF0aW9uKTsKICAgICAgICAgICAgbmV3QWN0aW9uLnBsYXkoKTsKICAgICAgICAgICAgdGhpcy5hY3RpdmVMb2NvbW90aW9uID0gbmV3QWN0aW9uOwogICAgICAgICAgICB0aGlzLl9sYXN0TG9jb21vdGlvbiA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICAvLyBPdmVyaGF1bGVkIHBsYXkgbWV0aG9kIHRvIGhhbmRsZSBsYXllcmluZwogICAgICAgIHBsYXkoYWN0aW9uTmFtZSwgZHVyYXRpb24gPSAwLjUpIHsKICAgICAgICAgICAgLy8gSWYgaXQncyBhIGxvY29tb3Rpb24gc3RhdGUsIHJvdXRlIHRvIHBsYXlMb2NvbW90aW9uCiAgICAgICAgICAgIGlmIChbJ2lkbGUnLCAnc3dpbScsICdkYXNoJ10uaW5jbHVkZXMoYWN0aW9uTmFtZSkpIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24oYWN0aW9uTmFtZSwgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPdGhlcndpc2UgdHJlYXQgYXMgYW4gYWN0aW9uIGxheWVyCiAgICAgICAgICAgIGNvbnN0IG5ld0FjdGlvbiA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFuZXdBY3Rpb24pIHJldHVybjsKCiAgICAgICAgICAgIC8vIElmIHdlIGhhdmUgYW4gYWN0aXZlIG9uZS1zaG90LCBmYWRlIGl0IG91dAogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVPbmVTaG90ICYmIHRoaXMuYWN0aXZlT25lU2hvdCAhPT0gbmV3QWN0aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZU9uZVNob3QuZmFkZU91dCgwLjEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXdBY3Rpb24ucmVzZXQoKTsKICAgICAgICAgICAgbmV3QWN0aW9uLmZhZGVJbigwLjEpOyAvLyBGYXN0IHRyYW5zaXRpb24gZm9yIGFjdGlvbnMKICAgICAgICAgICAgbmV3QWN0aW9uLnBsYXkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYWN0aXZlT25lU2hvdCA9IG5ld0FjdGlvbjsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlTG9jb21vdGlvbkFuaW0oZHVyYXRpb24gPSAwLjIpIHsKICAgICAgICAgICAgLy8gTm90ZTogV2UgTk8gTE9OR0VSIGNoZWNrIF9hbmltTG9ja2VkIGhlcmUuCiAgICAgICAgICAgIC8vIExvY29tb3Rpb24gc2hvdWxkIHVwZGF0ZSBjb250aW51b3VzbHkgYmFzZWQgb24gc3BlZWQsIAogICAgICAgICAgICAvLyBydW5uaW5nIHVuZGVybmVhdGggdGhlIHVwcGVyIGJvZHkgYWN0aW9uLgogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgdnggPSB0aGlzLnZlbG9jaXR5ID8gdGhpcy52ZWxvY2l0eS54IDogMDsKICAgICAgICAgICAgY29uc3QgdnogPSB0aGlzLnZlbG9jaXR5ID8gdGhpcy52ZWxvY2l0eS56IDogMDsKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSBNYXRoLnNxcnQodnggKiB2eCArIHZ6ICogdnopOwoKICAgICAgICAgICAgLy8gU21vb3RoIHNwZWVkCiAgICAgICAgICAgIGNvbnN0IHNtb290aEsgPSAxLjAgLSBNYXRoLnBvdygwLjAwMSwgZHVyYXRpb24pOwogICAgICAgICAgICB0aGlzLl9zbW9vdGhlZFNwZWVkICs9IChzcGVlZCAtIHRoaXMuX3Ntb290aGVkU3BlZWQpICogc21vb3RoSzsKCiAgICAgICAgICAgIGNvbnN0IHNwZWVkTm9ybSA9ICh0aGlzLm1heFNwZWVkID4gMC4wMDAxKSA/IFRIUkVFLk1hdGhVdGlscy5jbGFtcCh0aGlzLl9zbW9vdGhlZFNwZWVkIC8gdGhpcy5tYXhTcGVlZCwgMCwgMSkgOiAwOwoKICAgICAgICAgICAgLy8gSHlzdGVyZXNpcwogICAgICAgICAgICBjb25zdCBlbnRlck1vdmUgPSAwLjE4OwogICAgICAgICAgICBjb25zdCBleGl0TW92ZSA9IDAuMTA7CgogICAgICAgICAgICBjb25zdCBpbnB1dE1vdmluZyA9IHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wNjsKICAgICAgICAgICAgY29uc3QgdmVsTW92aW5nID0gdGhpcy5fc21vb3RoZWRTcGVlZCA+ICh0aGlzLl9tb3ZpbmdMYXRjaCA/IGV4aXRNb3ZlIDogZW50ZXJNb3ZlKTsKCiAgICAgICAgICAgIHRoaXMuX21vdmluZ0xhdGNoID0gaW5wdXRNb3ZpbmcgfHwgdmVsTW92aW5nOwoKICAgICAgICAgICAgbGV0IHRhcmdldCA9IHRoaXMuX21vdmluZ0xhdGNoID8gJ3N3aW0nIDogJ2lkbGUnOwogICAgICAgICAgICBpZiAodGhpcy5fbW92aW5nTGF0Y2ggJiYgdGhpcy5pc0Rhc2hpbmcgJiYgdGhpcy5hY3Rpb25zWydkYXNoJ10pIHRhcmdldCA9ICdkYXNoJzsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBwbGF5YmFjayByYXRlCiAgICAgICAgICAgIGNvbnN0IGFwcGx5UmF0ZSA9IChrZXkpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGlvbnNba2V5XTsKICAgICAgICAgICAgICAgIGlmICghYSkgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gJ3N3aW0nKSBhLnRpbWVTY2FsZSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDAuODUsIDEuNzAsIHNwZWVkTm9ybSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChrZXkgPT09ICdkYXNoJykgYS50aW1lU2NhbGUgPSBUSFJFRS5NYXRoVXRpbHMubGVycCgxLjEwLCAyLjIwLCBzcGVlZE5vcm0pOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoa2V5ID09PSAnaWRsZScpIGEudGltZVNjYWxlID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoMC45NSwgMS4wNSwgc3BlZWROb3JtKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGFwcGx5UmF0ZSh0YXJnZXQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuX2xhc3RMb2NvbW90aW9uICE9PSB0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGlvbnNbdGFyZ2V0XTsKICAgICAgICAgICAgICAgIGlmIChhKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsgYS5zZXRMb29wKFRIUkVFLkxvb3BSZXBlYXQpOyB9IGNhdGNoIChfKSB7fQogICAgICAgICAgICAgICAgICAgIGEuY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24odGFyZ2V0LCBkdXJhdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBsYXlPbmVTaG90KGFjdGlvbk5hbWUsIGR1cmF0aW9uID0gMC4xLCBvcHRzID0ge30pIHsKICAgICAgICAgICAgY29uc3QgYSA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFhKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICB0aGlzLl9hbmltTG9ja2VkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5fbG9ja2VkU3RhdGUgPSBhY3Rpb25OYW1lOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGEucmVzZXQoKTsKICAgICAgICAgICAgICAgIGEuc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICBhLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGEudGltZVNjYWxlID0gKG9wdHMudGltZVNjYWxlICE9PSB1bmRlZmluZWQgPyBvcHRzLnRpbWVTY2FsZSA6IDEuMCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKF8pIHt9CgogICAgICAgICAgICAvLyBVc2UgdGhlIG5ldyBwbGF5IG1ldGhvZCB3aGljaCBoYW5kbGVzIGxheWVyaW5nCiAgICAgICAgICAgIHRoaXMucGxheShhY3Rpb25OYW1lLCBkdXJhdGlvbik7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBzZXRJbnB1dCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCh4LCAwLCB6KTsKICAgICAgICB9CgpyZWNlaXZlQmFsbCgpIHsKICAgICAgICAgICAgdGhpcy5jYW5DYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ1JJVElDQUwgRklYOiBSZXNldCBzdGF0ZXMgdGhhdCBtaWdodCBwcmV2ZW50IHNob290aW5nCiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMi4wOwoKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLmxhc3RIb2xkZXIgJiYgYmFsbC5sYXN0SG9sZGVyLnRlYW0gPT09IHRoaXMudGVhbSAmJiBiYWxsLmxhc3RIb2xkZXIgIT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGJhbGwubGFzdEhvbGRlci5nYWluRXhwKDIpOwogICAgICAgICAgICAgICAgdGhpcy5nYWluRXhwKDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBiYWxsWSA9ICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLm1lc2gpID8gdGhpcy5iYWxsUmVmLm1lc2gucG9zaXRpb24ueSA6IDA7CiAgICAgICAgICAgIGNvbnN0IGNhdGNoS2V5ID0gKGJhbGxZID4gMC4yNSAmJiB0aGlzLmFjdGlvbnNbJ2NhdGNoX2p1bXAnXSkgPyAnY2F0Y2hfanVtcCcgOiAnY2F0Y2gnOwogICAgICAgICAgICB0aGlzLnBsYXlPbmVTaG90KGNhdGNoS2V5LCAwLjEpOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNOQVAhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtYWN0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp0aHJvd0JhbGwoYmFsbCwgZm9yY2VkVHlwZSA9IG51bGwsIHBvd2VyTXVsdGlwbGllciA9IDEuMCwgZm9yY2VkU3BpbiA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgfHwgdGhpcy5pc1Rocm93aW5nKSByZXR1cm47CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CgogICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSB0cnVlOwoKICAgICAgICAgICAgLy8gTG9jayBhaW0gZGlyZWN0aW9uIGF0IHN0YXJ0IG9mIHRocm93CiAgICAgICAgICAgIHRoaXMubG9ja2VkQWltVmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgIHRoaXMubG9ja2VkQWltVmVjdG9yLmNvcHkodGhpcy5pbnB1dFZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3Rvci5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQoKY29uc3QgZ29hbFogPSAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC00NiA6IDQ2OwogICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CgogICAgICAgICAgICBsZXQgdHlwZSA9IGZvcmNlZFR5cGU7CiAgICAgICAgICAgIGlmICghdHlwZSkgewogICAgICAgICAgICAgICAgdHlwZSA9IChkaXN0VG9Hb2FsIDwgMjUpID8gJ1NIJyA6ICdQQSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGlzRmluaXNoZXIgPSAodHlwZSA9PT0gJ1NIJyAmJiBkaXN0VG9Hb2FsIDwgMTIuMCk7CgogICAgICAgICAgICBsZXQgdGVjaE5hbWUgPSAodHlwZSA9PT0gJ1NIJykgPyB0aGlzLnRlY2hzLnNob290IDogdGhpcy50ZWNocy5wYXNzOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnZlbm9tID4gMCAmJiB0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0lMRU5DRUQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIHRlY2hOYW1lID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV0IHdpbmR1cFRpbWUgPSAxMDA7CiAgICAgICAgICAgIGxldCBhbmltU3BlZWQgPSAxLjU7CgogICAgICAgICAgICBpZiAocG93ZXJNdWx0aXBsaWVyID4gMS4xKSB7CiAgICAgICAgICAgICAgICB3aW5kdXBUaW1lICs9IDIwMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGlzRmluaXNoZXIgJiYgIXRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICB3aW5kdXBUaW1lID0gNTA7CiAgICAgICAgICAgICAgICBhbmltU3BlZWQgPSAzLjA7CiAgICAgICAgICAgIH0KCmlmICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSA9IDQwMDsKICAgICAgICAgICAgICAgIGFuaW1TcGVlZCA9IDAuODsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5wbGF5Q2luZW1hdGljKHRlY2hOYW1lLCB0aGlzLm1lc2gsIDEuMik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMS41OwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGFiZWwgPSB0ZWNoTmFtZS5yZXBsYWNlKCdfJywgJyAnKS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24obGFiZWwsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBORVc6IFNwYXduIFRlY2ggR2x5cGggKFZlcnRpY2FsIENhc3RpbmcgQ2lyY2xlKQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyLnNwYXduKCd0ZWNoJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMS4yLAogICAgICAgICAgICAgICAgICAgICAgICByb3RhdGlvblNwZWVkOiA0LjAsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IDEuNSwKICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WTogMS4yLAogICAgICAgICAgICAgICAgICAgICAgICBmYWNlQ2FtZXJhOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFBpY2sgYmVzdCB0aHJvdyBjbGlwIChwYXNzL3Nob3QgdmFyaWFudHMgaWYgcHJlc2VudCkKICAgICAgICAgICAgY29uc3QgdGhyb3dLZXkgPQogICAgICAgICAgICAgICAgKHR5cGUgPT09ICdTSCcgJiYgdGhpcy5hY3Rpb25zWyd0aHJvd19zaG90J10pID8gJ3Rocm93X3Nob3QnIDoKICAgICAgICAgICAgICAgICh0eXBlID09PSAnUEEnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfcGFzcyddKSA/ICd0aHJvd19wYXNzJyA6CiAgICAgICAgICAgICAgICAndGhyb3cnOwoKICAgICAgICAgICAgdGhpcy5wbGF5T25lU2hvdCh0aHJvd0tleSwgMC4xLCB7IHRpbWVTY2FsZTogYW5pbVNwZWVkIH0pOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgIXRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJXSE9PU0giLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1hY3Rpb24iKTsKICAgICAgICAgICAgfQoKc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBTYWZldHk6IElmIGJhbGwgaG9sZGVyIGlzIHN0aWxsIHVzLCBwcm9jZWVkLiBJZiBoYXNCYWxsIGlzIGZhbHNlIGJ1dCBob2xkZXIgaXMgdXMsIGFzc3VtZSBzeW5jIGxhZyBhbmQgcHJvY2VlZC4KICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgfHwgKGJhbGwgJiYgYmFsbC5ob2xkZXIgPT09IHRoaXMpKSB7CmNvbnN0IHRocm93QWN0aW9uID0gdGhpcy5hY3Rpb25zW3Rocm93S2V5XTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhyb3dBY3Rpb24pIHRocm93QWN0aW9uLnRpbWVTY2FsZSA9IDEuMDsKCiAgICAgICAgICAgICAgICAgICAgbGV0IGZpbmFsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVmZXJlbmNlRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCmlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLmNvcHkodGhpcy5vdmVycmlkZUFpbVZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZURpci5jb3B5KGZpbmFsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJFTU9WRUQ6IEluc3RhbnQgcm90YXRpb24gc25hcC4gCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZSB1cGRhdGUgbG9vcCBoYW5kbGVzIHNtb290aCByb3RhdGlvbiB2aWEgdGFyZ2V0WWF3LgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIHRoZSAiZmxpcHBpbmcgYXJvdW5kIiB2aXN1YWwgZ2xpdGNoLgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLmNvcHkodGhpcy5sb2NrZWRBaW1WZWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2VEaXIuY29weSh0aGlzLmxvY2tlZEFpbVZlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgfQoKY29uc3Qgc3BpbiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwoKICAgICAgICAgICAgICAgICAgICBpZiAoZm9yY2VkU3BpbikgewogICAgICAgICAgICAgICAgICAgICAgICBzcGluLmNvcHkoZm9yY2VkU3Bpbik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5wdXREaXIgPSB0aGlzLmlucHV0VmVjdG9yLmNsb25lKCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNyb3NzWSA9IG5ldyBUSFJFRS5WZWN0b3IzKCkuY3Jvc3NWZWN0b3JzKHJlZmVyZW5jZURpciwgaW5wdXREaXIpLnk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoY3Jvc3NZKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Bpbi5zZXQoMCwgY3Jvc3NZICogMTIuMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGxldCBiYXNlQ29zdCA9ICh0eXBlID09PSAnU0gnKSA/IDIwIDogMTA7CiAgICAgICAgICAgICAgICAgICAgbGV0IHRlY2hDb3N0ID0gMDsKICAgICAgICAgICAgICAgICAgICBsZXQgdGVjaEJvbnVzID0gMDsKICAgICAgICAgICAgICAgICAgICBsZXQgdGVjaFBheWxvYWQgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICBpZiAodGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoICh0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAndmVub20nOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gKHR5cGUgPT09ICdTSCcgPyAyMCA6IDEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAndmVub20nLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnd2l0aGVyJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9ICh0eXBlID09PSAnU0gnID8gMjAgOiAxMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IHsgdHlwZTogJ3dpdGhlcicsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICduYXAnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gKHR5cGUgPT09ICdTSCcgPyAzNSA6IDMwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnbmFwJywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3NwaGVyZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAyNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm5nID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMTEpICsgNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gcm5nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IHsgdHlwZTogJ3NwaGVyZScsIGxldmVsOiAxLCBib251czogcm5nIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgU1BIRVJFICske3JuZ31gLCB0aGlzLm1lc2gucG9zaXRpb24sICJnb2FsIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnamVjaHQnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gNDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnamVjaHQnLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9wZXJmb3JtSmVjaHRLbm9ja2JhY2soKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdpbnZpc2libGUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gMjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0geyB0eXBlOiAnaW52aXNpYmxlJywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsQ29zdCA9IGJhc2VDb3N0ICsgdGVjaENvc3Q7CgogICAgICAgICAgICAgICAgICAgIGxldCBwb3dlckZhY3RvciA9IDEuMDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA8IHRvdGFsQ29zdCkgewogICAgICAgICAgICAgICAgICAgICAgICBwb3dlckZhY3RvciA9IDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hQYXlsb2FkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJUSVJFRCIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gdG90YWxDb3N0OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGV0IHN0YXRWYWwgPSB0aGlzLmdldFN0YXQodHlwZSk7CiAgICAgICAgICAgICAgICAgICAgc3RhdFZhbCArPSB0ZWNoQm9udXM7CiAgICAgICAgICAgICAgICAgICAgc3RhdFZhbCAqPSBwb3dlckZhY3RvcjsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IHBvd2VyTXVsdGlwbGllcjsKCmNvbnN0IGdvYWxaID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtNDYgOiA0NjsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnb2FsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbFogLSB0aGlzLm1lc2gucG9zaXRpb24ueikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbERvdCA9IGZpbmFsRGlyLmRvdChnb2FsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDIsIGdvYWxaKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdG9Hb2FsID0gZ29hbFBvcy5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2ggPSB0aGlzLmdldFN0YXQoJ1NIJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBNYXRoLm1pbigwLjksIE1hdGgubWF4KDAuMSwgc2ggLyAxMDAuMCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lzdEZhY3RvciAqPSAwLjE7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnb2FsRG90ID4gMC4yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5sZXJwKHRvR29hbCwgYXNzaXN0RmFjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRmluaXNoZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4wNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xBTSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4yNTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKLy8gR29hbGllIExvZnQgQm9udXMgKFByZXZlbnQgaW50ZXJjZXB0aW9uIGJ5IGltbWVkaWF0ZSBkZWZlbmRlcikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgZmluYWxEaXIueSArPSAwLjg7IC8vIEhpZ2ggbG9mdCBmb3IgY2xlYXJhbmNlCgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGZpbmFsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvTWF0ZSA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0LnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b01hdGUuYWRkU2NhbGVkVmVjdG9yKHRhcmdldC52ZWxvY2l0eSwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvTWF0ZS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYSA9IHRoaXMuZ2V0U3RhdCgnUEEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBNYXRoLm1pbigxLjAsIDAuMyArIChwYSAvIDgwLjApKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lzdEZhY3RvciAqPSAwLjE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIubGVycCh0b01hdGUsIGFzc2lzdEZhY3Rvcik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gTWF0aC5taW4oMC42LCBkaXN0ICogMC4wMyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CmZpbmFsRGlyLnkgKz0gMC4yOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBHb2FsaWUgTG9mdCBCb251cyBmb3IgUGFzc2luZwovLyBHb2FsaWUgTG9mdCBCb251cyBmb3IgUGFzc2luZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yb2xlID09PSAnR0wnKSBmaW5hbERpci55ICs9IDAuODsgLy8gSGlnaCBsb2Z0IGZvciBjbGVhcmFuY2UKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodGVjaFBheWxvYWQgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KHRoaXMsIHRlY2hOYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CgpiYWxsLnNob290KGZpbmFsRGlyLCBzdGF0VmFsLCB0eXBlLCB0ZWNoUGF5bG9hZCwgc3Bpbik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRXh0cmEgZ3JhY2UgcGVyaW9kIGZvciBHb2FsaWUgdG8gcHJldmVudCBwb2ludC1ibGFuayBpbnRlcmNlcHRpb25zCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgewogICAgICAgICAgICAgICAgICAgICAgICBiYWxsLmNhdGNoR3JhY2VQZXJpb2QgPSAwLjY7IC8vIDAuNnMgaW1tdW5pdHkgKGFwcHJveCAxMC0xMm0gdHJhdmVsKQogICAgICAgICAgICAgICAgICAgIH0KCnRoaXMubG9zZUJhbGwoKTsKCnRoaXMuY2F0Y2hDb29sZG93biA9IDEuMDsgLy8gMXMgY29vbGRvd24KICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHdpbmR1cFRpbWUpOwoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBudWxsOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlTG9jb21vdGlvbkFuaW0oMC4yKTsKICAgICAgICAgICAgfSwgd2luZHVwVGltZSArIDUwMCk7CiAgICAgICAgfQoKICAgICAgICBfZmluZFBhc3NUYXJnZXRJbkNvbmUoYWltRGlyKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtKSByZXR1cm4gbnVsbDsKCiAgICAgICAgICAgIGxldCBiZXN0VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IG1heFNjb3JlID0gLUluZmluaXR5OwoKICAgICAgICAgICAgZm9yIChjb25zdCBtYXRlIG9mIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcyB8fCAhbWF0ZS5tZXNoKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICBjb25zdCB0b01hdGUgPSBtYXRlLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGRvdCA9IGFpbURpci5kb3QodG9NYXRlKTsKCiAgICAgICAgICAgICAgICBpZiAoZG90ID4gMC43KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2NvcmUgPSAoZG90ICogMTApIC0gKGRpc3QgKiAwLjEpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoc2NvcmUgPiBtYXhTY29yZSkgewogICAgICAgICAgICAgICAgICAgICAgICBtYXhTY29yZSA9IHNjb3JlOwogICAgICAgICAgICAgICAgICAgICAgICBiZXN0VGFyZ2V0ID0gbWF0ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJlc3RUYXJnZXQ7CiAgICAgICAgfQoKc3RhcnRDaGFyZ2UoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CgovLyBWaXN1YWxzIGhhbmRsZWQgaW4gdXBkYXRlCgogICAgICAgICAgICAvLyBTaG93IGNoYXJnZSBVSQogICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSSgwKTsKCiAgICAgICAgICAgIC8vIE5FVzogU3Bhd24gQ2hhcmdlIEdseXBoIChHcm91bmQgUmluZykKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyLnNwYXduKCdjaGFyZ2UnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgbGlmZTogdGhpcy5tYXhDaGFyZ2VUaW1lLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IDMuMCwKICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAwLjIsCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WTogMC4xCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnJlbGVhc2VDaGFyZ2UoZHgsIGR5LCBjdXJ2ZUlucHV0ID0gbnVsbCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaXNDaGFyZ2luZykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBvd2VyIENhbGN1bGF0aW9uCiAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4odGhpcy5jaGFyZ2VUaW1lIC8gdGhpcy5tYXhDaGFyZ2VUaW1lLCAxLjApOwogICAgICAgICAgICBjb25zdCBUQyA9IHdpbmRvdy5mbHV4LlRocm93Q29uZmlnIHx8IHt9OwoKICAgICAgICAgICAgLy8gQmFzZSBtdWx0aXBsaWVyIChkZWZhdWx0czogMS4wIHRvIDEuOCkKICAgICAgICAgICAgbGV0IG11bHRpcGxpZXIgPSAoVEMuUE9XRVJfQkFTRSAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfQkFTRSA6IDEuMCkgKyAocmF0aW8gKiAoVEMuUE9XRVJfUkFOR0UgIT09IHVuZGVmaW5lZCA/IFRDLlBPV0VSX1JBTkdFIDogMC44KSk7Ly8gTUFYIFBPV0VSIEJPTlVTOiBJZiBoZWxkIG5lYXIgbWF4LCBzaWduaWZpY2FudCBib29zdAogICAgICAgICAgICBpZiAocmF0aW8gPiAoVEMuUE9XRVJfTUFYX0JPTlVTX1JBVElPICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9NQVhfQk9OVVNfUkFUSU8gOiAwLjk1KSkgewogICAgICAgICAgICAgICAgbXVsdGlwbGllciA9IChUQy5QT1dFUl9NQVhfTVVMVElQTElFUiAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfTUFYX01VTFRJUExJRVIgOiAyLjUpOyAvLyBDcml0aWNhbCBQb3dlcgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNQVggUE9XRVIhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKC0xMCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CgogICAgICAgICAgICAvLyBBaW0gVmVjdG9yIENhbGN1bGF0aW9uCiAgICAgICAgICAgIGxldCBhaW1WZWMgPSBudWxsOwogICAgICAgICAgICBjb25zdCBzd2lwZUxlbiA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCiAgICAgICAgICAgIGlmIChzd2lwZUxlbiA+IChUQy5TV0lQRV9NSU5fUFggIT09IHVuZGVmaW5lZCA/IFRDLlNXSVBFX01JTl9QWCA6IDIwKSkgewogICAgICAgICAgICAgICAgY29uc3QgY2FtZXJhID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYTsKICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICBjb25zdCByaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAgICAgaWYgKGNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihmd2QpOwogICAgICAgICAgICAgICAgICAgIGZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAoZndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgZndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBmd2Qubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIHJpZ2h0LmNyb3NzVmVjdG9ycyhmd2QsIG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgICAgIHdvcmxkVmVjLmFkZFNjYWxlZFZlY3RvcihyaWdodCwgZHggKiAoVEMuQUlNX0RYX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5BSU1fRFhfU0NBTEUgOiAxLjApKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5hZGRTY2FsZWRWZWN0b3IoZndkLCAtZHkgKiAoVEMuQUlNX0RZX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5BSU1fRFlfU0NBTEUgOiAxLjApKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgYWltVmVjID0gd29ybGRWZWM7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdmVycmlkZUFpbVZlY3RvciA9IGFpbVZlYzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYWltVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFpbVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgfQoKLy8gLS0tIEFOQUxPRyBDVVJWRSBMT0dJQyAtLS0KICAgICAgICAgICAgLy8gRm9ybXVsYTogQ3VydmUgPSBJbnRlbnNpdHkgKiBTcGVlZAogICAgICAgICAgICBsZXQgc3BpblZlYyA9IG51bGw7CiAgICAgICAgICAgIAppZiAoKFRDLkNVUlZFX0VOQUJMRUQgIT09IGZhbHNlKSAmJiBjdXJ2ZUlucHV0ICYmIE1hdGguYWJzKGN1cnZlSW5wdXQuaW50ZW5zaXR5KSA+IChUQy5DVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEIDogMC4yNSkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJhd0ludGVuc2l0eSA9IE1hdGguYWJzKGN1cnZlSW5wdXQuaW50ZW5zaXR5KTsKICAgICAgICAgICAgICAgIGNvbnN0IHNpZ24gPSBNYXRoLnNpZ24oY3VydmVJbnB1dC5pbnRlbnNpdHkpOyAvLyBQb3NpdGl2ZSA9IFJpZ2h0IEh1bXAgPSBMZWZ0IEN1cnZlCiAgICAgICAgICAgICAgICBjb25zdCBzd2lwZVNwZWVkID0gY3VydmVJbnB1dC5zcGVlZCB8fCAxLjA7CgogICAgICAgICAgICAgICAgLy8gMS4gQmFzZSBTcGluIGZyb20gQXJjIChUdW5lZCBmb3IgcmVhbGlzbSwgbm8gY3ljbG9uZXMpCi8vIDEuIEJhc2UgU3BpbiBmcm9tIEFyYyAoSGVyY3VsZWFuIEJvb3N0KQogICAgICAgICAgICAgICAgbGV0IHNwaW5NYWcgPSByYXdJbnRlbnNpdHkgKiAoVEMuQ1VSVkVfU1BJTl9TQ0FMRSAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BJTl9TQ0FMRSA6IDEwMDAuMCk7CgogICAgICAgICAgICAgICAgLy8gMi4gU3BlZWQgQm9udXMgKFF1aWNrbmVzcyBhZGRzIFJQTSkKICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkQm9udXMgPSBNYXRoLm1heCgxLjAsIHN3aXBlU3BlZWQgKiAoVEMuQ1VSVkVfU1BFRURfTVVMVCAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BFRURfTVVMVCA6IDEuNSkpOwogICAgICAgICAgICAgICAgc3Bpbk1hZyAqPSBzcGVlZEJvbnVzOwoKICAgICAgICAgICAgICAgIC8vIENhcCAoSW5jcmVhc2VkIHRvIDE1MDAgZm9yIG1hc3NpdmUgYXJjcykKICAgICAgICAgICAgICAgIHNwaW5NYWcgPSBNYXRoLm1pbigoVEMuQ1VSVkVfU1BJTl9DQVAgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX1NQSU5fQ0FQIDogMTUwMC4wKSwgc3Bpbk1hZyk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgU3BpbgogICAgICAgICAgICAgICAgLy8gUmlnaHQgSHVtcCAoUG9zaXRpdmUgSW50ZW5zaXR5KSAtPiBMZWZ0IEN1cnZlIChQb3NpdGl2ZSBTcGluIFkpCiAgICAgICAgICAgICAgICBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3Bpbk1hZyAqIHNpZ24sIDApOwogICAgICAgICAgICAgICAgCmlmIChzcGluTWFnID4gKFRDLkNVUlZFX1BFUkZFQ1RfU1BJTiAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfUEVSRkVDVF9TUElOIDogNTAwLjApICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQRVJGRUNUIENVUlZFIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSb2xsSW1wdWxzZShzaWduICogLTAuMyk7IC8vIFRpbHQgY2FtZXJhIGludG8gdGhlIGN1cnZlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEZXRlcm1pbmUgVHlwZSAoUGFzcyB2cyBTaG9vdCkKLy8gRGV0ZXJtaW5lIFR5cGUgKFBhc3MgdnMgU2hvb3QpCiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtNDYgOiA0NjsKICAgICAgICAgICAgY29uc3QgZ29hbERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIGdvYWxaIC0gdGhpcy5tZXNoLnBvc2l0aW9uLnopLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBjb25zdCBkb3RHb2FsID0gYWltVmVjLmRvdChnb2FsRGlyKTsKCiAgICAgICAgICAgIGxldCB0eXBlID0gJ1BBJzsKICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwoKICAgICAgICAgICAgaWYgKGRvdEdvYWwgPiAwLjggJiYgZGlzdFRvR29hbCA8IDM1LjApIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAnU0gnOwogICAgICAgICAgICB9IGVsc2UgaWYgKGRvdEdvYWwgPiAwLjUgJiYgZGlzdFRvR29hbCA8IDIwLjApIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAnU0gnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbWFydCBQYXNzIE92ZXJyaWRlCiAgICAgICAgICAgIGNvbnN0IHRhcmdldE1hdGUgPSB0aGlzLl9maW5kUGFzc1RhcmdldEluQ29uZShhaW1WZWMpOwogICAgICAgICAgICBpZiAodGFyZ2V0TWF0ZSAmJiB0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0TWF0ZSA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldE1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdE1hdGUgPCAxMi4wKSB0eXBlID0gJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgdHlwZSwgbXVsdGlwbGllciwgc3BpblZlYyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE5FVzogQ2hhcmdlIFVJIG1ldGhvZHMKICAgICAgICBfdXBkYXRlQ2hhcmdlVUkocmF0aW8pIHsKICAgICAgICAgICAgY29uc3QgbWV0ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhcmdlLW1ldGVyLWZpbGwnKTsKICAgICAgICAgICAgaWYgKG1ldGVyKSB7CiAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS53aWR0aCA9IGAke3JhdGlvICogMTAwfSVgOwogICAgICAgICAgICAgICAgaWYgKHJhdGlvID4gMC45KSB7CiAgICAgICAgICAgICAgICAgICAgbWV0ZXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAsICNmODApJzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmF0aW8gPiAwLjUpIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzBmMCwgI2ZmMCknOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzBhZiwgIzBmMCknOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIpIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlQ2hhcmdlVUkoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIpIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KCiAgICAgICAgc2V0T3ZlcnJpZGVBaW0oeCwgeikgewogICAgICAgICAgICBpZiAoIXRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yLnNldCh4LCAwLCB6KS5ub3JtYWxpemUoKTsKICAgICAgICB9Cgpsb3NlQmFsbCgpIHsKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwogICAgICAgICAgICAvLyBGaXg6IEVuc3VyZSBwbGF5ZXIgY2FuIGNhdGNoIGFnYWluIGlmIHRoZXkgbG9zZSBwb3NzZXNzaW9uIHVuZXhwZWN0ZWRseQogICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBzdGF0ZXMgdG8gcHJldmVudCBsb2NraW5nCiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyBTWU5DIEZJWDogSWYgYmFsbCB0aGlua3MgSSBob2xkIGl0LCBidXQgSSBkb24ndCwgZm9yY2UgcmVjZWl2ZQogICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmICYmIHRoaXMuYmFsbFJlZi5ob2xkZXIgPT09IHRoaXMgJiYgIXRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJTeW5jaW5nIGJhbGwgcG9zc2Vzc2lvbiB0byBwbGF5ZXIiKTsKICAgICAgICAgICAgICAgIHRoaXMucmVjZWl2ZUJhbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaXNHb2RNb2RlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gdGhpcy5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gdGhpcy5nZXRTdGF0KCdFTicpOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMudmVub20gPSAwOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBBbmltYXRpb246IGtlZXAgbG9jb21vdGlvbi9jaGFyZ2UgdXBkYXRlZCB1bmxlc3MgYSBvbmUtc2hvdCBpcyBsb2NraW5nIGFuaW1hdGlvbnMuCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CgoKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzKGR0KTsKCiAgICAgICAgICAgIC8vIENoYXJnZSBMb2dpYwovLyBDaGFyZ2UgTG9naWMKICAgICAgICAgICAgaWYgKHRoaXMuaXNDaGFyZ2luZykgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgfHwgdGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnNjYWxlLnNldFNjYWxhcih0aGlzLmJhc2VTY2FsZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CiAgICAgICAgICAgICAgICB9IGVsc2Ugewp0aGlzLmNoYXJnZVRpbWUgKz0gZHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQVVUTy1SRUxFQVNFOiBJZiBoZWxkIHRvbyBsb25nICgzcyksIGZvcmNlIHJlbGVhc2UgdG8gcHJldmVudCBzdHVjayBzdGF0ZQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJnZVRpbWUgPiAzLjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWxlYXNlQ2hhcmdlKDAsIDApOyAvLyBGb3JjZSB3ZWFrIHNob3QKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1pbih0aGlzLmNoYXJnZVRpbWUgLyB0aGlzLm1heENoYXJnZVRpbWUsIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gTGV2aXRhdGlvbiAoUG93ZXJpbmcgdXApCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaG92ZXIgPSAoTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDIpICogMC4xKSArIChyYXRpbyAqIDAuOCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVmlicmF0aW9uIChJbnRlbnNpdHkgaW5jcmVhc2VzIHdpdGggY2hhcmdlKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNoYWtlID0gMC4wNSArICgwLjEgKiByYXRpbyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQXBwbHkgWSBvZmZzZXQgKEhvdmVyICsgSml0dGVyKQogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gaG92ZXIgKyAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBBcHBseSBSb3RhdGlvbiBKaXR0ZXIgKHZpYSBiYW5raW5nL3BpdGNoIHZhcmlhYmxlcykKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGF2b2lkcyBwb3NpdGlvbmFsIGRyaWZ0IHdoaWxlIGdpdmluZyBhICJzdHJ1Z2dsaW5nIHRvIGNvbnRhaW4gcG93ZXIiIGxvb2sKICAgICAgICAgICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5waXRjaEFtb3VudCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZTsKCiAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIHNjYWxlIHN0YXlzIG5vcm1hbCAoUmVtb3ZlIHN3ZWxsaW5nIGVmZmVjdCkKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0U2NhbGFyKHRoaXMuYmFzZVNjYWxlKTsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQ2hhcmdlVUkocmF0aW8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CmlmICh0aGlzLmRhc2hDb29sZG93biA+IDApIHRoaXMuZGFzaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5jbGFzaENvb2xkb3duID4gMCkgdGhpcy5jbGFzaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5zdHVuVGltZXIgPiAwKSB0aGlzLnN0dW5UaW1lciAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHRoaXMuaW1tdW5pdHlUaW1lciAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuY2F0Y2hDb29sZG93biA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhdGNoQ29vbGRvd24gPD0gMCkgdGhpcy5jYW5DYXRjaCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gRGFzaCBMb2dpYwovLyBEYXNoIExvZ2ljCiAgICAgICAgICAgIGlmICh0aGlzLmlzRGFzaGluZykgewogICAgICAgICAgICAgICAgdGhpcy5kYXNoVGltZSAtPSBkdDsKICAgICAgICAgICAgICAgIAp0aGlzLl9kYXNoUGFydGljbGVUaW1lciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9kYXNoUGFydGljbGVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZGFzaFBhcnRpY2xlVGltZXIgPSAwLjAxOyAvLyBJbmNyZWFzZWQgZGVuc2l0eSAod2FzIDAuMDMpCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhY2sgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCkubmVnYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYWNrLmxlbmd0aFNxKCkgPCAwLjEpIGJhY2suc2V0KDAsIDAsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3Bhd24gbXVsdGlwbGUgcGFydGljbGVzIHBlciB0aWNrIGZvciBhICJzdHJlYW0iCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDI7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKGJhY2subXVsdGlwbHlTY2FsYXIoMC41KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueSArPSAxLjAgKyAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2Rhc2hfc3RyZWFtJywgcG9zLCB7IHNjYWxlOiAyLjAgKyBNYXRoLnJhbmRvbSgpIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFNtb290aCBSb3RhdGlvbiBkdXJpbmcgRGFzaAogICAgICAgICAgICAgICAgbGV0IGRpZmYgPSB0aGlzLnRhcmdldFlhdyAtIHRoaXMuY3VycmVudFlhdzsKICAgICAgICAgICAgICAgIHdoaWxlIChkaWZmID4gTWF0aC5QSSkgZGlmZiAtPSBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIHdoaWxlIChkaWZmIDwgLU1hdGguUEkpIGRpZmYgKz0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHR1cm5TcGVlZCA9IDE1LjA7IC8vIEZhc3QgdHVybmluZyBmb3IgZGFzaAogICAgICAgICAgICAgICAgY29uc3QgY2hhbmdlID0gTWF0aC5tYXgoLXR1cm5TcGVlZCAqIGR0LCBNYXRoLm1pbih0dXJuU3BlZWQgKiBkdCwgZGlmZikpOwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ICs9IGNoYW5nZTsKCiAgICAgICAgICAgICAgICB0aGlzLl9jaGVja1RhY2tsZUNvbGxpc2lvbigpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXNoVGltZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXNoVHlwZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUeXBlID09PSAndmVydGljYWwnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5kYXNoVmVjKS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gMSAtICh0aGlzLmRhc2hUaW1lIC8gdGhpcy5kYXNoVG90YWxUaW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSBNYXRoLnNpbih0ICogTWF0aC5QSSkgKiAzLjA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCBEYXNoIE1vdmVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoZHQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIFRhY2tsZSBMZWFuIChTaG91bGRlciBCYXNoIEFuaW1hdGlvbikKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IDEgLSAodGhpcy5kYXNoVGltZSAvIHRoaXMuZGFzaFRvdGFsVGltZSk7IC8vIDAgdG8gMQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWFuID0gTWF0aC5zaW4odCAqIE1hdGguUEkpOyAvLyBQZWFrIGF0IDEuMCBpbiBtaWRkbGUKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlLWFwcGx5IGJhc2UgZmFjaW5nICsgQWdncmVzc2l2ZSBTaG91bGRlciBDaGVjawovLyBSZS1hcHBseSBiYXNlIGZhY2luZyArIEFnZ3Jlc3NpdmUgU2hvdWxkZXIgQ2hlY2sKICAgICAgICAgICAgICAgICAgICAgICAgX3BRdWF0LnNldEZyb21BeGlzQW5nbGUoX3BBeGlzWSwgdGhpcy5jdXJyZW50WWF3ICsgdGhpcy5yb3RhdGlvbk9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGl0Y2ggPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgeWF3ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJvbGwgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgbHVuZ2VBbXQgPSAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGFzaFR5cGUgPT09ICdob3Jpem9udGFsJyB8fCB0aGlzLmRhc2hUeXBlID09PSAnYnJlYWsnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVEFDS0xFL0JSRUFLOiBBZ2dyZXNzaXZlIFNob3VsZGVyIENoZWNrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGl0Y2ggPSAxLjIgKiBsZWFuOyAvLyBIZWFkIGRvd24gLyBMZWFuIGZvcndhcmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5YXcgPSAwLjggKiBsZWFuOyAgIC8vIFR1cm4gc2hvdWxkZXIgaW50byB0YXJnZXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb2xsID0gLTAuNiAqIGxlYW47IC8vIERpcCBzaG91bGRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGx1bmdlQW10ID0gMC44ICogbGVhbjsgLy8gVGhydXN0IG1lc2ggZm9yd2FyZCB2aXN1YWxseQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZGFzaFR5cGUgPT09ICdzcHJpbnQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU1BSSU5UOiBBZXJvZHluYW1pYyBsZWFuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGl0Y2ggPSAwLjUgKiBsZWFuOyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsdW5nZUFtdCA9IDAuMiAqIGxlYW47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFwcGx5IEx1bmdlIChWaXN1YWwgT2Zmc2V0KQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobHVuZ2VBbXQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIGx1bmdlQW10KS5hcHBseVF1YXRlcm5pb24oX3BRdWF0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgX3BFdWxlci5zZXQocGl0Y2gsIHlhdywgcm9sbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIF9wUXVhdDIuc2V0RnJvbUV1bGVyKF9wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseVF1YXRlcm5pb25zKF9wUXVhdCwgX3BRdWF0Mik7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOTYpOwoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjk2KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU3R1bi9OYXAgQ2hlY2sKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkcmFnRmFjdG9yID0gTWF0aC5tYXgoMCwgMSAtICgyLjAgKiBkdCkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihkcmFnRmFjdG9yKTsKCiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwoKICAgICAgICAgICAgICAgIGlmICghdGhpcy5fYW5pbUxvY2tlZCAmJiB0aGlzLnN0YXRlICE9PSAnaWRsZScgJiYgdGhpcy5zdGF0ZSAhPT0gJ2NhdGNoJykgdGhpcy5wbGF5KCdpZGxlJywgMC41KTsKCiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIUEJhcigpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVQcmVzc3VyZShkdCk7CgogICAgICAgICAgICBpZiAodGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtICgyLjAgKiBkdCkpKTsKCiAgICAgICAgICAgICAgICB0aGlzLl9hcHBseVNvZnRDb2xsaXNpb24oZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlHb2FsQ3JlYXNlKGR0KTsKCiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwoKdGhpcy5fdXBkYXRlVmVydGljYWxpdHkoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQmFua2luZyhkdCk7IC8vIEVuYWJsZSByb3RhdGlvbiBkdXJpbmcgdGhyb3cKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZlcnRpY2FsaXR5KGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUJhbmtpbmcoZHQpOwogICAgICAgICAgICB9Cgp0aGlzLl91cGRhdGVIUEJhcigpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwoKICAgICAgICAgICAgLy8gQnViYmxlIFRyYWlsIExvZ2ljCi8vIEJ1YmJsZSBUcmFpbCBMb2dpYyAoRHluYW1pYykKICAgICAgICAgICAgY29uc3Qgc3BlZWRTcSA9IHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHNwZWVkU3EgPiAxLjAgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2J1YmJsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFja0RpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAxLiBTdGFuZGFyZCBXYWtlIChBbHdheXMgc3Bhd24pCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gYmFja0Rpci5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKDAuOCk7CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LnkgPSAwLjUgKyBNYXRoLnJhbmRvbSgpICogMC41OyAKICAgICAgICAgICAgICAgICAgICBvZmZzZXQueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgIG9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZScsIHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLCB7IHNjYWxlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMjUgfSk7CgogICAgICAgICAgICAgICAgICAgIC8vIDIuIENhdml0YXRpb24gKEhpZ2ggU3BlZWQpIC0gQWRkIG9uIHRvcAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzSGlnaFNwZWVkID0gc3BlZWRTcSA+IDQwLjA7IAogICAgICAgICAgICAgICAgICAgIGlmIChpc0hpZ2hTcGVlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1PZmZzZXQgPSBiYWNrRGlyLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC41ICsgTWF0aC5yYW5kb20oKSowLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC55ID0gMC41ICsgKE1hdGgucmFuZG9tKCktMC41KSowLjg7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlX21pY3JvJywgdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG1PZmZzZXQpLCB7IHNjYWxlOiAwLjA2ICsgTWF0aC5yYW5kb20oKSowLjA4IH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4wMzsgCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwLjE7IAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBQcm9jZWR1cmFsICdhbGl2ZScgcG9zZTogbG9vay9haW0vYmFsbC1ob2xkIG9mZnNldHMgKGFwcGxpZWQgYWZ0ZXIgbWl4ZXIgdXBkYXRlKQogICAgICAgICAgICB0aGlzLl9hcHBseVByb2NlZHVyYWxQb3NlKGR0KTsKCn0KCgpfYXBwbHlQcm9jZWR1cmFsUG9zZShkdCkgewogICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAvLyBBZHZhbmNlIGxvY2FsIHRpbWUgKHVzZWQgZm9yIHN1YnRsZSBzd2F5cykKICAgIHRoaXMuX3Byb2NBbmltVGltZSArPSBkdDsKCiAgICBjb25zdCBiID0gdGhpcy5ib25lczsKICAgIGlmICghYikgcmV0dXJuOwoKICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICBjb25zdCBiYWxsID0gKGdhbWUgJiYgZ2FtZS5lbnRpdGllcykgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwoKICAgIGxldCBzaG91bGRBcHBseSA9IGZhbHNlOwoKICAgIC8vIEJ1aWxkIGEgZGVzaXJlZCB3b3JsZC1zcGFjZSBkaXJlY3Rpb24gd2Ugd2FudCB0aGUgdG9yc28vaGVhZCB0byBiaWFzIHRvd2FyZC4KICAgIC8vIE5PVEU6IFdlIGFwcGx5IHRoaXMgQUZURVIgdGhlIGFuaW1hdGlvbiBtaXhlciBoYXMgcG9zZWQgYm9uZXMsIGFzIGEgc21hbGwgYWRkaXRpdmUgb2Zmc2V0LgogICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CgogICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgIC8vIEFpbSBkaXJlY3Rpb24gKHByZWZlciBleHBsaWNpdCBhaW0gdmVjdG9yKQogICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5vdmVycmlkZUFpbVZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmxvY2tlZEFpbVZlY3RvcikgewogICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMubG9ja2VkQWltVmVjdG9yKS5ub3JtYWxpemUoKTsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wOCkgewogICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMuaW5wdXRWZWN0b3IpLm5vcm1hbGl6ZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgIH0KICAgICAgICBzaG91bGRBcHBseSA9IHRydWU7CiAgICB9IGVsc2UgaWYgKGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgLy8gTG9vayBhdCB0aGUgYmFsbCBpZiBpdCdzIGluIHRoZSAiYXdhcmVuZXNzIiByYWRpdXMKICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICBpZiAoZGlzdCA8IDIwLjApIHsKICAgICAgICAgICAgX3BWZWMuc3ViVmVjdG9ycyhiYWxsLm1lc2gucG9zaXRpb24sIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIHNob3VsZEFwcGx5ID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKCFzaG91bGRBcHBseSkgcmV0dXJuOwoKICAgIC8vIENvbnZlcnQgdGhlIGRpcmVjdGlvbiBpbnRvIHRoZSBwbGF5ZXIncyBsb2NhbCBzcGFjZSBzbyB5YXcvcGl0Y2ggYXJlIHN0YWJsZS4KICAgIF9wSW52UXVhdC5jb3B5KHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5pbnZlcnQoKTsKICAgIF9wVmVjLmFwcGx5UXVhdGVybmlvbihfcEludlF1YXQpLm5vcm1hbGl6ZSgpOwoKICAgIGNvbnN0IGx4ID0gX3BWZWMueCwgbHkgPSBfcFZlYy55LCBseiA9IF9wVmVjLno7CiAgICBjb25zdCB5YXcgPSBNYXRoLmF0YW4yKGx4LCBseik7CiAgICBjb25zdCBwaXRjaCA9IE1hdGguYXRhbjIobHksIE1hdGguc3FydChseCAqIGx4ICsgbHogKiBseikgKyAxZS02KTsKCiAgICBjb25zdCB5YXdDID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHlhdywgLTAuOSwgMC45KTsKICAgIGNvbnN0IHBpdGNoQyA9IFRIUkVFLk1hdGhVdGlscy5jbGFtcChwaXRjaCwgLTAuNiwgMC42KTsKCiAgICBjb25zdCBzcGVlZE5vcm0gPSAodGhpcy5tYXhTcGVlZCA+IDAuMDAwMSkgPyBUSFJFRS5NYXRoVXRpbHMuY2xhbXAodGhpcy5fc21vb3RoZWRTcGVlZCAvIHRoaXMubWF4U3BlZWQsIDAsIDEpIDogMDsKICAgIGNvbnN0IGFpbVcgPSAodGhpcy5oYXNCYWxsID8gKHRoaXMuaXNDaGFyZ2luZyA/IDEuMCA6IDAuNjUpIDogMC4zNSkgKiAoMS4wIC0gMC4zNSAqIHNwZWVkTm9ybSk7CiAgICBjb25zdCBoZWFkVyA9ICh0aGlzLmhhc0JhbGwgPyAwLjU1IDogMC43NSkgKiAoMS4wIC0gMC4yNSAqIHNwZWVkTm9ybSk7CgogICAgLy8gVG9yc28gYmlhcyAoc3BpbmUvY2hlc3QpCiAgICBpZiAoYi5jaGVzdCkgewogICAgICAgIF9wVG1wRXVsZXIuc2V0KC1waXRjaEMgKiAwLjIwICogYWltVywgeWF3QyAqIDAuMzUgKiBhaW1XLCAwKTsKICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgIGIuY2hlc3QucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgfSBlbHNlIGlmIChiLnNwaW5lKSB7CiAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMTUgKiBhaW1XLCB5YXdDICogMC4yNSAqIGFpbVcsIDApOwogICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgYi5zcGluZS5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wVG1wUXVhdCk7CiAgICB9CgogICAgLy8gSGVhZC9uZWNrIGxvb2sKICAgIGlmIChiLm5lY2spIHsKICAgICAgICBfcFRtcEV1bGVyLnNldCgtcGl0Y2hDICogMC4yNSAqIGhlYWRXLCB5YXdDICogMC40NSAqIGhlYWRXLCAwKTsKICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgIGIubmVjay5xdWF0ZXJuaW9uLm11bHRpcGx5KF9wVG1wUXVhdCk7CiAgICB9CiAgICBpZiAoYi5oZWFkKSB7CiAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMzAgKiBoZWFkVywgeWF3QyAqIDAuNTUgKiBoZWFkVywgMCk7CiAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICBiLmhlYWQucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgfQoKICAgIC8vIEJhbGwtaG9sZCAvIGFpbSBhcm0gcG9zZSAoa2VlcHMgInN3aW0iIGFuaW1hdGlvbiBidXQgcmVhZHMgYXMgaG9sZGluZy9haW1pbmcpCiAgICBpZiAodGhpcy5oYXNCYWxsICYmICF0aGlzLmlzVGhyb3dpbmcgJiYgIXRoaXMuX2FuaW1Mb2NrZWQpIHsKICAgICAgICBjb25zdCB0ID0gdGhpcy5fcHJvY0FuaW1UaW1lOwogICAgICAgIGNvbnN0IGxpZnQgPSBUSFJFRS5NYXRoVXRpbHMuY2xhbXAoMC4zNSArICh0aGlzLmlzQ2hhcmdpbmcgPyAwLjU1IDogMC4yNSkgLSBzcGVlZE5vcm0gKiAwLjIsIDAuMTUsIDAuOTUpOwogICAgICAgIGNvbnN0IHN3YXkgPSBNYXRoLnNpbih0ICogNS4wKSAqIDAuMDUgKiAoMC41ICsgbGlmdCk7CgogICAgICAgIGNvbnN0IHJhaXNlWCA9IC0wLjU1ICogbGlmdCArIHN3YXk7CiAgICAgICAgY29uc3QgcmFpc2VaID0gLTAuMjUgKiBsaWZ0OwoKICAgICAgICBpZiAoYi5yVXBwZXJBcm0pIHsKICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQocmFpc2VYLCB5YXdDICogMC4xMCAqIGxpZnQsIHJhaXNlWik7CiAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgIGIuclVwcGVyQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICB9CiAgICAgICAgaWYgKGIuckZvcmVBcm0pIHsKICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLTAuMzUgKiBsaWZ0ICsgc3dheSAqIDAuNSwgMCwgMCk7CiAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgIGIuckZvcmVBcm0ucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgIH0KCiAgICAgICAgLy8gQ291bnRlcmJhbGFuY2UgbGVmdCBhcm0gc2xpZ2h0bHkgZm9yIGEgbW9yZSBkeW5hbWljIHNpbGhvdWV0dGUKICAgICAgICBpZiAoYi5sVXBwZXJBcm0pIHsKICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoMC4xNSAqIGxpZnQsIC15YXdDICogMC4wNSAqIGxpZnQsIDAuMTUgKiBsaWZ0KTsKICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgYi5sVXBwZXJBcm0ucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgIH0KICAgIH0KfQoKCiAgICAgICAgX3VwZGF0ZVN0YXR1cyhkdCkgewogICAgICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIgOiBudWxsOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLnZlbm9tID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMudmVub20gLT0gZHQ7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IDUgKiBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQIDwgMCkgdGhpcy5zdGF0cy5IUCA9IDA7CgogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCd2ZW5vbScsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gPSAwLjE1OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgJiYgdGhpcy5zdGF0cy5IUCA8IHRoaXMuc3RhdHMubWF4SFApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQICs9IDUgKiBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA+IHRoaXMuc3RhdHMubWF4SFApIHRoaXMuc3RhdHMuSFAgPSB0aGlzLnN0YXRzLm1heEhQOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IDIuMCAqIGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPCAwKSB0aGlzLnN0YXRzLkhQID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLm5hcCAtPSBkdDsKCiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5uYXAgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMubmFwIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignbmFwJywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy5uYXAgPSAwLjg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBpc1dpdGhlcmluZyA9IGZhbHNlOwogICAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5zdGF0dXMud2l0aGVyKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMud2l0aGVyW2tleV0gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMud2l0aGVyW2tleV0gLT0gZHQ7CiAgICAgICAgICAgICAgICAgICAgaXNXaXRoZXJpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNXaXRoZXJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLndpdGhlciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCd3aXRoZXInLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLndpdGhlciA9IDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmlzdWFscygpOwogICAgICAgIH0KCl91cGRhdGVWaXN1YWxzKCkgewogICAgICAgICAgICAvLyBSRU1PVkVEOiBZZWxsb3cgc3BoZXJlL3RpbnQgbG9naWMgYXMgcGVyIHJlcXVlc3QuCiAgICAgICAgICAgIC8vIEFsd2F5cyByZXZlcnQgdG8gYmFzZSBjb2xvci4KICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5mb3JFYWNoKGVudHJ5ID0+IHsKICAgICAgICAgICAgICAgIGVudHJ5Lm1hdGVyaWFsLmNvbG9yLmNvcHkoZW50cnkuYmFzZUNvbG9yKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfY3JlYXRlQXVyYSgpIHsKICAgICAgICAgICAgLy8gQXVyYSByZW1vdmVkIHBlciB1c2VyIHJlcXVlc3QKICAgICAgICAgICAgdGhpcy5hdXJhTWVzaCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IFBhc3MgdGFyZ2V0IGluZGljYXRvcgogICAgICAgIF9jcmVhdGVQYXNzVGFyZ2V0SW5kaWNhdG9yKCkgewogICAgICAgICAgICAvLyBDcmVhdGUgYSByaW5nIHRoYXQgaGlnaGxpZ2h0cyBwb3RlbnRpYWwgcGFzcyB0YXJnZXRzCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMC44LCAxLjAsIDE2KTsKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgICAgIGNvbG9yOiAweDAwZmYwMCwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yID0gbmV3IFRIUkVFLk1lc2goZ2VvLCBtYXQpOwogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3Iucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnBvc2l0aW9uLnkgPSAwLjE7CiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMucGFzc1RhcmdldEluZGljYXRvcik7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlUGFzc1RhcmdldEluZGljYXRvcnMoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8ICF0aGlzLnRlYW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGaW5kIGJlc3QgcGFzcyB0YXJnZXQKICAgICAgICAgICAgY29uc3QgYWltRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5fZmluZFBhc3NUYXJnZXRJbkNvbmUoYWltRGlyKTsKCiAgICAgICAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0Lm1lc2ggJiYgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueCA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLng7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueiA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLno7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci5yb3RhdGlvbi56ICs9IDAuMDU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpIHsKICAgICAgICAgICAgaWYgKHRoaXMucGFzc1RhcmdldEluZGljYXRvcikgewogICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9hcHBseVNvZnRDb2xsaXNpb24oZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2ggfHwgIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgdGVhbXMgPSBbZ2FtZS50ZWFtcy5ob21lLCBnYW1lLnRlYW1zLmF3YXldOwoKICAgICAgICAgICAgY29uc3QgcmVwdWxzaW9uUmFkaXVzID0gMC41OyAvLyBSZWR1Y2VkIHRvIDAuNSB0byBmaXggaW52aXNpYmxlIHdhbGwgaXNzdWVzCiAgICAgICAgICAgIGNvbnN0IHN0aWZmbmVzcyA9IDE1LjA7CgogICAgICAgICAgICB0ZWFtcy5mb3JFYWNoKHRlYW0gPT4gewogICAgICAgICAgICAgICAgaWYgKCF0ZWFtKSByZXR1cm47CiAgICAgICAgICAgICAgICB0ZWFtLnBsYXllcnMuZm9yRWFjaChvdGhlciA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG90aGVyID09PSB0aGlzIHx8ICFvdGhlci5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGR4ID0gdGhpcy5tZXNoLnBvc2l0aW9uLnggLSBvdGhlci5tZXNoLnBvc2l0aW9uLng7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHkgPSB0aGlzLm1lc2gucG9zaXRpb24ueSAtIG90aGVyLm1lc2gucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkeiA9IHRoaXMubWVzaC5wb3NpdGlvbi56IC0gb3RoZXIubWVzaC5wb3NpdGlvbi56OwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR5KmR5ICsgZHoqZHo7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWluRGlzdCA9IHJlcHVsc2lvblJhZGl1cyAqIDIuMDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IG1pbkRpc3QgKiBtaW5EaXN0ICYmIGRpc3RTcSA+IDAuMDAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG92ZXJsYXAgPSBtaW5EaXN0IC0gZGlzdDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gb3ZlcmxhcCAqIHN0aWZmbmVzczsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG54ID0gZHggLyBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBueSA9IGR5IC8gZGlzdDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbnogPSBkeiAvIGRpc3Q7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gbnggKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKz0gbnkgKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gbnogKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICB0aGlzLl9hcHBseVNvZnRDb2xsaXNpb24oZHQpOwogICAgICAgICAgICB0aGlzLl9hcHBseUdvYWxDcmVhc2UoZHQpOwoKICAgICAgICAgICAgY29uc3QgaW5wdXRMZW5TcSA9IHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKTsKICAgICAgICAgICAgY29uc3QgaXNJbnB1dEFjdGl2ZSA9IGlucHV0TGVuU3EgPiAwLjAxOwoKICAgICAgICAgICAgbGV0IGN1cnJlbnRNYXhTcGVlZCA9IHRoaXMubWF4U3BlZWQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTVFJVR0dMRSBTVEFURTogSGluZGVyIG1vdmVtZW50IGJhc2VkIG9uIHByZXNzdXJlCiAgICAgICAgICAgIC8vIEluc3RlYWQgb2YgYSBiaW5hcnkgMC44IG11bHRpcGxpZXIsIHdlIHNjYWxlIGJhc2VkIG9uIGludGVuc2l0eS4KICAgICAgICAgICAgLy8gTWF4IHN0cnVnZ2xlICgxLjApIHJlZHVjZXMgc3BlZWQgdG8gNDAlLgogICAgICAgICAgICBpZiAodGhpcy5zdHJ1Z2dsZUludGVuc2l0eSA+IDApIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRNYXhTcGVlZCAqPSAoMS4wIC0gKHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgKiAwLjYpKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgc2xpZ2h0IHJlZHVjdGlvbiBpZiBlbmdhZ2VkIGJ1dCBsb3cgcHJlc3N1cmUKICAgICAgICAgICAgICAgIGN1cnJlbnRNYXhTcGVlZCAqPSAwLjk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmlzQ2hhcmdpbmcpIGN1cnJlbnRNYXhTcGVlZCAqPSAwLjk7CgogICAgICAgICAgICBpZiAoaXNJbnB1dEFjdGl2ZSkgewogICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLmlucHV0VmVjdG9yKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSBTdHJ1Z2dsZSBKaXR0ZXIgdG8gZGlyZWN0aW9uCiAgICAgICAgICAgICAgICAvLyBTaW11bGF0ZXMgd3Jlc3RsaW5nIGZvciBjb250cm9sCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdHJ1Z2dsZUludGVuc2l0eSA+IDAuMykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGppdHRlciA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgKiAwLjg7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMueCArPSBqaXR0ZXI7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMueiArPSBqaXR0ZXI7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0VmVsWCA9IF9wVmVjLnggKiBjdXJyZW50TWF4U3BlZWQ7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRWZWxaID0gX3BWZWMueiAqIGN1cnJlbnRNYXhTcGVlZDsKCiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50U3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWRSYXRpbyA9IE1hdGgubWluKDEuMCwgY3VycmVudFNwZWVkIC8gdGhpcy5tYXhTcGVlZCk7CgogICAgICAgICAgICAgICAgLy8gQWdpbGl0eSBpcyByZWR1Y2VkIHdoZW4gc3RydWdnbGluZwogICAgICAgICAgICAgICAgbGV0IGFnaWxpdHkgPSBUSFJFRS5NYXRoVXRpbHMubGVycCgxMC4wLCAyLjAsIHNwZWVkUmF0aW8pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPiAwKSBhZ2lsaXR5ICo9IDAuNTsKCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gMS4wIC0gTWF0aC5wb3coMC4wMSwgZHQgKiBhZ2lsaXR5KTsKCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gKHRhcmdldFZlbFggLSB0aGlzLnZlbG9jaXR5LngpICogdDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiArPSAodGFyZ2V0VmVsWiAtIHRoaXMudmVsb2NpdHkueikgKiB0OwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJyYWtlRmFjdG9yID0gMi4wOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IDEuMCAtIE1hdGgucG93KDAuMSwgZHQgKiBicmFrZUZhY3Rvcik7CgogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9ICgwIC0gdGhpcy52ZWxvY2l0eS54KSAqIHQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gKDAgLSB0aGlzLnZlbG9jaXR5LnopICogdDsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMC4wMSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIHRoaXMudmVsb2NpdHkueSwgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSBNYXRoLm1heCgwLCAxLjAgLSAoMi4wICogZHQpKTsKCiAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoZHQpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVWZXJ0aWNhbGl0eShkdCkgewogICAgICAgICAgICBsZXQgdGFyZ2V0WSA9IDA7CgogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CgogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2ggJiYgIXRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvQmFsbCA8IDE1LjApIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRZID0gYmFsbC5tZXNoLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRhcmdldFkgPSAwLjU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHlEaWZmID0gdGFyZ2V0WSAtIHRoaXMubWVzaC5wb3NpdGlvbi55OwoKICAgICAgICAgICAgY29uc3QgbGlmdCA9IHlEaWZmICogMTAuMCAqIGR0OwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKz0gbGlmdDsKCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gucG9zaXRpb24ueSA+IDguMCkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSA4LjA7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLTAuNTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLm1lc2gucG9zaXRpb24ueSA8IC04LjApIHsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gLTguMDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSAtMC41OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBGSVhFRDogSW1wcm92ZWQgYmFua2luZyB3aXRoIGh5c3RlcmVzaXMgdG8gcHJldmVudCBmYWNpbmcgZmxpcHMKLy8gRklYRUQ6IEltcHJvdmVkIGJhbmtpbmcgd2l0aCBoeXN0ZXJlc2lzIHRvIHByZXZlbnQgZmFjaW5nIGZsaXBzCiAgICAgICAgX3VwZGF0ZUJhbmtpbmcoZHQpIHsKICAgICAgICAgICAgY29uc3QgaW5wdXRMZW5TcSA9IHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKTsKICAgICAgICAgICAgY29uc3QgdmVsTGVuU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CgogICAgICAgICAgICBsZXQgdGFyZ2V0WWF3ID0gdGhpcy50YXJnZXRZYXc7CiAgICAgICAgICAgIGxldCBzaG91bGRVcGRhdGVZYXcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDE6IEV4cGxpY2l0IEFpbSAoQWltIFN0aWNrIC8gU3dpcGUpCiAgICAgICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IueCwgdGhpcy5vdmVycmlkZUFpbVZlY3Rvci56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUFJJT1JJVFkgMjogTW92ZW1lbnQgSW5wdXQKICAgICAgICAgICAgZWxzZSBpZiAoaW5wdXRMZW5TcSA+IHRoaXMuZmFjaW5nRGVhZHpvbmUgKiB0aGlzLmZhY2luZ0RlYWR6b25lKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMuaW5wdXRWZWN0b3IueCwgdGhpcy5pbnB1dFZlY3Rvci56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDM6IFZlbG9jaXR5IChEcmlmdGluZykKICAgICAgICAgICAgZWxzZSBpZiAodmVsTGVuU3EgPiB0aGlzLmZhY2luZ0RlYWR6b25lICogdGhpcy5mYWNpbmdEZWFkem9uZSkgewogICAgICAgICAgICAgICAgdGFyZ2V0WWF3ID0gTWF0aC5hdGFuMih0aGlzLnZlbG9jaXR5LngsIHRoaXMudmVsb2NpdHkueik7CiAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGVZYXcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB3ZSBzaG91bGQgdXBkYXRlLCBkbyBzby4gT3RoZXJ3aXNlIGtlZXAgbGFzdCB2YWxpZCB5YXcKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZVlhdykgewogICAgICAgICAgICAgICAgdGhpcy5sYXN0VmFsaWRZYXcgPSB0YXJnZXRZYXc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSB0aGlzLmxhc3RWYWxpZFlhdzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU21vb3RoIFlhdyB3aXRoIHdyYXAtYXJvdW5kIGhhbmRsaW5nCiAgICAgICAgICAgIGxldCBkaWZmID0gdGFyZ2V0WWF3IC0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICB3aGlsZSAoZGlmZiA+IE1hdGguUEkpIGRpZmYgLT0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgIHdoaWxlIChkaWZmIDwgLU1hdGguUEkpIGRpZmYgKz0gTWF0aC5QSSAqIDI7CgogICAgICAgICAgICBjb25zdCBzcGVlZFJhdGlvID0gTWF0aC5taW4oMS4wLCB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpIC8gdGhpcy5tYXhTcGVlZCk7CmNvbnN0IHR1cm5TcGVlZCA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDguMCwgNC4wLCBzcGVlZFJhdGlvKTsgLy8gUmVkdWNlZCBmcm9tIDEyLjAvNi4wIHRvIHJlZHVjZSBmbGlwcGluZwoKICAgICAgICAgICAgLy8gUHJldmVudCBzdWRkZW4gc25hcHMgd2hlbiBkaWZmIGlzIHZlcnkgbGFyZ2UgKHRlbGVwb3J0L3Jlc2V0IHNjZW5hcmlvcykKICAgICAgICAgICAgY29uc3QgbWF4WWF3Q2hhbmdlID0gTWF0aC5QSSAqIGR0ICogdHVyblNwZWVkOwogICAgICAgICAgICBjb25zdCB5YXdDaGFuZ2UgPSBNYXRoLm1heCgtbWF4WWF3Q2hhbmdlLCBNYXRoLm1pbihtYXhZYXdDaGFuZ2UsIGRpZmYgKiBkdCAqIHR1cm5TcGVlZCkpOwoKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ICs9IHlhd0NoYW5nZTsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSB0YXJnZXRZYXc7CgogICAgICAgICAgICAvLyBCYW5raW5nCiAgICAgICAgICAgIGNvbnN0IGJhbmtTZW5zaXRpdml0eSA9IDAuODsKICAgICAgICAgICAgY29uc3QgbWF4QmFuayA9IDAuNzU7CgogICAgICAgICAgICBsZXQgdGFyZ2V0QmFuayA9IC1kaWZmICogYmFua1NlbnNpdGl2aXR5OwogICAgICAgICAgICB0YXJnZXRCYW5rID0gTWF0aC5tYXgoLW1heEJhbmssIE1hdGgubWluKG1heEJhbmssIHRhcmdldEJhbmspKTsKCiAgICAgICAgICAgIGNvbnN0IGJhbmtMZXJwID0gMS4wIC0gTWF0aC5wb3coMC4wMiwgZHQpOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgKz0gKHRhcmdldEJhbmsgLSB0aGlzLmJhbmtpbmdBbW91bnQpICogYmFua0xlcnA7CgogICAgICAgICAgICAvLyBQaXRjaAogICAgICAgICAgICBjb25zdCBwaXRjaFNlbnNpdGl2aXR5ID0gMC4xOwogICAgICAgICAgICBjb25zdCBtYXhQaXRjaCA9IDEuMDsKCiAgICAgICAgICAgIGxldCB0YXJnZXRQaXRjaCA9IC10aGlzLnZlbG9jaXR5LnkgKiBwaXRjaFNlbnNpdGl2aXR5OwogICAgICAgICAgICB0YXJnZXRQaXRjaCA9IE1hdGgubWF4KC1tYXhQaXRjaCwgTWF0aC5taW4obWF4UGl0Y2gsIHRhcmdldFBpdGNoKSk7CgogICAgICAgICAgICBjb25zdCBwaXRjaExlcnAgPSAxLjAgLSBNYXRoLnBvdygwLjA1LCBkdCk7CiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgKz0gKHRhcmdldFBpdGNoIC0gdGhpcy5waXRjaEFtb3VudCkgKiBwaXRjaExlcnA7CgogICAgICAgICAgICAvLyBBcHBseSBSb3RhdGlvbgogICAgICAgICAgICBjb25zdCBmaW5hbFlhdyA9IHRoaXMuY3VycmVudFlhdyArIHRoaXMucm90YXRpb25PZmZzZXQ7CgogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5zZXRGcm9tQXhpc0FuZ2xlKF9wQXhpc1ksIGZpbmFsWWF3KTsKCiAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDEsIDAsIDApLCB0aGlzLnBpdGNoQW1vdW50KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BRdWF0KTsKCiAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLCB0aGlzLmJhbmtpbmdBbW91bnQpOwogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseShfcFF1YXQpOwoKICAgICAgICAgICAgLy8gSWRsZSBCb2IKICAgICAgICAgICAgaWYgKHZlbExlblNxIDwgMC4xICYmICF0aGlzLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IERhdGUubm93KCkgKiAwLjAwMTU7CiAgICAgICAgICAgICAgICBjb25zdCBib2JQaXRjaCA9IE1hdGguc2luKHRpbWUpICogMC4wMzsKICAgICAgICAgICAgICAgIGNvbnN0IGJvYlJvbGwgPSBNYXRoLmNvcyh0aW1lICogMC43KSAqIDAuMDI7CgpfcEV1bGVyLnNldChib2JQaXRjaCwgMCwgYm9iUm9sbCk7CiAgICAgICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUV1bGVyKF9wRXVsZXIpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BRdWF0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9jaGVja1RhY2tsZVByZXNzdXJlKGR0KSB7CiAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNFbmdhZ2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIXRoaXMudGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CiAgICAgICAgICAgIGlmICghb3Bwb25lbnRUZWFtKSByZXR1cm47CgogICAgICAgICAgICBsZXQgdG90YWxQcmVzc3VyZSA9IDA7CiAgICAgICAgICAgIGxldCBlbmdhZ2VkQ291bnQgPSAwOwogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVSYWRpdXMgPSB0aGlzLnRhY2tsZVJhZGl1czsgCgogICAgICAgICAgICAvLyBGb3J3YXJkIHZlY3RvciBmb3Igc2hpZWxkaW5nIGNoZWNrCiAgICAgICAgICAgIF9wVmVjLmNvcHkoX3BBeGlzWikuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsgCgogICAgICAgICAgICBmb3IgKGNvbnN0IGVudGl0eSBvZiBvcHBvbmVudFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCB8fCBlbnRpdHkuc3RhdHVzLm5hcCA+IDAgfHwgZW50aXR5LnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oZW50aXR5Lm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCBlZmZlY3RpdmVSYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICBlbmdhZ2VkQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgUHJlc3N1cmUgSW50ZW5zaXR5ICgwIHRvIDEgYmFzZWQgb24gZGlzdGFuY2UpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJveGltaXR5ID0gMS4wIC0gKGRpc3QgLyBlZmZlY3RpdmVSYWRpdXMpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEJhc2UgUHJlc3N1cmUgZnJvbSBBVCBzdGF0CiAgICAgICAgICAgICAgICAgICAgbGV0IHByZXNzdXJlID0gZW50aXR5LmdldFN0YXQoJ0FUJykgKiBwcm94aW1pdHk7CgogICAgICAgICAgICAgICAgICAgIC8vIERpcmVjdGlvbmFsIFNoaWVsZGluZyAoQ29udGludW91cykKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b09wcCA9IGVudGl0eS5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZG90ID0gX3BWZWMuZG90KHRvT3BwKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJZiBvcHBvbmVudCBpcyBCRUhJTkQgKGRvdCA8IC0wLjIpLCBwcmVzc3VyZSBpcyByZWR1Y2VkIChTaGllbGRpbmcpCiAgICAgICAgICAgICAgICAgICAgbGV0IGlzU2hpZWxkZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoZG90IDwgLTAuMikgewogICAgICAgICAgICAgICAgICAgICAgICBwcmVzc3VyZSAqPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzU2hpZWxkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gVGVjaCBNb2RpZmllcnMgKENvbnRpbnVvdXMgYXBwbGljYXRpb24gY2hhbmNlKQogICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkudGVjaHMudGFja2xlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgZHQgKiAwLjUpIHRoaXMuYXBwbHlTdGF0dXMoJ3Zlbm9tJywgNS4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMS4yOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCBkdCAqIDAuNSkgdGhpcy5hcHBseVN0YXR1cygnd2l0aGVyJywgNS4wLCAnRU4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMS4yOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ2RyYWluJykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkcmFpbkFtdCA9IHByZXNzdXJlICogZHQgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gZHJhaW5BbXQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eS5zdGF0cy5IUCArPSBkcmFpbkFtdDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRvdGFsUHJlc3N1cmUgKz0gcHJlc3N1cmU7CgogICAgICAgICAgICAgICAgICAgIC8vIFZpc3VhbHM6IFNwYXJrcyBvY2Nhc2lvbmFsbHkgYmFzZWQgb24gcHJlc3N1cmUKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IGR0ICogNC4wICogcHJveGltaXR5KSB7IAogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuc3Bhd25DbGFzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWlkID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkubGVycChlbnRpdHkubWVzaC5wb3NpdGlvbiwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pZC55ICs9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuc3Bhd25DbGFzaChtaWQsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gT2NjYXNpb25hbCBTaGllbGQgVGV4dAogICAgICAgICAgICAgICAgICAgIGlmIChpc1NoaWVsZGVkICYmIE1hdGgucmFuZG9tKCkgPCBkdCAqIDEuMCAmJiBnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU0hJRUxEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiYmxvY2siKTsgLy8gVG9vIHNwYW1teSwgbWF5YmUganVzdCBzb3VuZCBsYXRlcgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5pc0VuZ2FnZWQgPSAoZW5nYWdlZENvdW50ID4gMCk7CgogICAgICAgICAgICBpZiAodGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5jb3VudGVyVGltZXIgKz0gZHQ7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgRU4gRHJhaW4gKENvbnRpbnVvdXMpCiAgICAgICAgICAgICAgICAvLyBTY2FsaW5nOiAyMCBBVCBwcmVzc3VyZSAtPiBhcHByb3ggMTAgRU4gbG9zdCBwZXIgc2Vjb25kCiAgICAgICAgICAgICAgICBjb25zdCBkcmFpblJhdGUgPSB0b3RhbFByZXNzdXJlICogMC41OyAKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOIC09IGRyYWluUmF0ZSAqIGR0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgU3RydWdnbGUgSW50ZW5zaXR5IGZvciBQaHlzaWNzICgwLjAgdG8gMS4wKQogICAgICAgICAgICAgICAgLy8gTWF4IHN0cnVnZ2xlIGF0IHJvdWdobHkgMzAgcHJlc3N1cmUKICAgICAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSBNYXRoLm1pbigxLjAsIHRvdGFsUHJlc3N1cmUgLyAzMC4wKTsKCiAgICAgICAgICAgICAgICAvLyBWaXN1YWwgRmVlZGJhY2sgZm9yIERyYWluIChBY2N1bXVsYXRlIHRvIGF2b2lkIHNwYW0pCiAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSArPSBkcmFpblJhdGUgKiBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSA+IDUuMCkgewogICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bihgLSR7TWF0aC5mbG9vcih0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSl9YCwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkRGFtYWdlID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSGludCBmb3IgcGxheWVyIGlmIGVuZ2FnZWQgdG9vIGxvbmcKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVuY291bnRlclRpbWVyID4gMS4wICYmIHRoaXMuZW5jb3VudGVyVGltZXIgPCAxLjEgJiYgdGhpcy50ZWFtLmlzSHVtYW4gJiYgdGhpcy50ZWFtLmFjdGl2ZVBsYXllciA9PT0gdGhpcykgewogICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJCUkVBSyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDw9IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuZnVtYmxlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9wZXJmb3JtSmVjaHRLbm9ja2JhY2soKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwoKICAgICAgICAgICAgaWYgKCFvcHBvbmVudFRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHJhbmdlID0gNi4wOwogICAgICAgICAgICBjb25zdCBmb3JjZSA9IDI1LjA7CgogICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJKRUNIVCBTSE9UISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImdvYWwiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgb3Bwb25lbnRUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ocC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBkaXIueSA9IDAuNTsKICAgICAgICAgICAgICAgICAgICBkaXIubm9ybWFsaXplKCk7CgpwLnZlbG9jaXR5LmFkZChkaXIubXVsdGlwbHlTY2FsYXIoZm9yY2UpKTsKCiAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAyLjA7IC8vIEVuc3VyZSB0aGV5IHN0YXkgZG93bgogICAgICAgICAgICAgICAgICAgIHAuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVhY3RBY3Rpb24gPSBwLmFjdGlvbnMgJiYgcC5hY3Rpb25zWydyZWFjdCddOwogICAgICAgICAgICAgICAgICAgIGlmIChyZWFjdEFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZWFjdEFjdGlvbi5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVhY3RBY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXlPbmVTaG90KCdyZWFjdCcsIDAuMSk7Cn0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2gnLCAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTTUFDSyEiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUudHJpZ2dlckltcGFjdCkgZ2FtZS50cmlnZ2VySW1wYWN0KDAuMTUsICdzaGF0dGVyJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVtYmxlKCkgewogICAgICAgICAgICBjb25zb2xlLmxvZygiRlVNQkxFISBFTiBEZXBsZXRlZC4iKTsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgdGhpcy5tZXNoKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDUkFTSCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zdHVuVGltZXIgPSAxLjU7CgogICAgICAgICAgICBjb25zdCBiYWNrRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgYmFja0Rpci54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgYmFja0Rpci56ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgYmFja0Rpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKGJhY2tEaXIubXVsdGlwbHlTY2FsYXIoMTIuMCkpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgaWYgKGJhbGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlamVjdERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKE1hdGgucmFuZG9tKCktMC41LCAwLjgsIE1hdGgucmFuZG9tKCktMC41KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBiYWxsLnNob290KGVqZWN0RGlyLCA2LjAsICdub25lJyk7CnRoaXMubG9zZUJhbGwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZGFzaCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzRGFzaGluZyB8fCB0aGlzLmRhc2hDb29sZG93biA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKCiAgICAgICAgICAgIC8vIE9GRkVOU0U6IEJSRUFLIFRBQ0tMRQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmIHRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjb3N0ID0gMTU7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkZBSUxFRCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mdW1ibGUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDIuMDsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnYnJlYWsnOwoKX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CnRoaXMudmVsb2NpdHkuYWRkKF9wVmVjLm11bHRpcGx5U2NhbGFyKDEwLjApKTsgLy8gTmVyZmVkIGZyb20gMTUuMCBmb3IgcmVhbGlzbQoKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW1JZCA9IHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CgogICAgICAgICAgICAgICAgb3Bwb25lbnRUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgdGhpcy50YWNrbGVSYWRpdXMgKiAxLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVzaERpciA9IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBwdXNoRGlyLnkgPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuYWRkKHB1c2hEaXIubXVsdGlwbHlTY2FsYXIoMTUuMCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2gnLCAwLjIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU1RVTiEiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJSRUFLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAovLyBORVc6IFNwYXduIEJyZWFrIEdseXBoIChFeHBsb3NpdmUgQnVyc3QpCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLmdseXBoTWFuYWdlci5zcGF3bignc3RhdHVzJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC41LAogICAgICAgICAgICAgICAgICAgICAgICByb3RhdGlvblNwZWVkOiA4LjAsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IDMuMCwKICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WTogMC41CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKLy8gUGFydGljbGUgQnVyc3QgKEJyZWFrIFRhY2tsZSkKICAgICAgICAgICAgICAgIGlmIChnYW1lLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIGdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCwgbGlmZTogMC4zIH0pOwogICAgICAgICAgICAgICAgICAgIGdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIHRoaXMubWVzaC5wb3NpdGlvbiwgeyBzY2FsZTogMi41IH0pOwogICAgICAgICAgICAgICAgICAgIC8vIEJ1YmJsZSBCdXJzdAogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDMwOyBpKyspIHsKY29uc3QgYlBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChfcFZlYy5zZXQoKE1hdGgucmFuZG9tKCktMC41KSwgMS4wKyhNYXRoLnJhbmRvbSgpLTAuNSksIChNYXRoLnJhbmRvbSgpLTAuNSkpKTsKICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgYlBvcywgeyBzY2FsZTogMC4yICsgTWF0aC5yYW5kb20oKSAqIDAuNCB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGdhbWUudHJpZ2dlckltcGFjdCkgZ2FtZS50cmlnZ2VySW1wYWN0KDAuMTUsICdoZWF2eScpOwoKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gT0ZGRU5TRTogU1BSSU5UCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNvc3QgPSA1OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIk5PIEVOISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDEuNTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnc3ByaW50JzsKCmNvbnN0IGJ1cnN0RGlyID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgaWYgKGJ1cnN0RGlyLmxlbmd0aFNxKCkgPCAwLjEpIGJ1cnN0RGlyLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwoKdGhpcy52ZWxvY2l0eS5hZGQoYnVyc3REaXIubXVsdGlwbHlTY2FsYXIoMTIuMCkpOyAvLyBOZXJmZWQgZnJvbSAxNS4wCgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkRm92SW1wdWxzZSgyMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkRBU0ghIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBERUZFTlNFOiBCTE9DSyAvIFRBQ0tMRQogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGxldCBpc0Jsb2NrQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhiYWxsLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA4LjAgJiYgYmFsbC5tZXNoLnBvc2l0aW9uLnkgPiAyLjUpIHsKICAgICAgICAgICAgICAgICAgICBpc0Jsb2NrQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5kYXNoVGltZSA9IHRoaXMuZGFzaFRvdGFsVGltZTsKICAgICAgICAgICAgdGhpcy5kYXNoQ29vbGRvd24gPSAxLjU7CgogICAgICAgICAgICBjb25zdCBsZW4gPSBNYXRoLnNxcnQoeCp4ICsgeip6KTsKICAgICAgICAgICAgY29uc3QgbnggPSAobGVuID4gMCkgPyB4L2xlbiA6IDA7CiAgICAgICAgICAgIGNvbnN0IG56ID0gKGxlbiA+IDApID8gei9sZW4gOiAwOwoKaWYgKGxlbiA+IDApIHsKICAgICAgICAgICAgICAgIC8vIFNtb290aCB0dXJuIGZvciBkYXNoIGluc3RlYWQgb2Ygc25hcAogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSBNYXRoLmF0YW4yKG54LCBueik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQmxvY2tDb250ZXh0KSB7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ3ZlcnRpY2FsJzsKCiAgICAgICAgICAgICAgICBjb25zdCBkaXJUb0JhbGwgPSBiYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGRpclRvQmFsbC55ID0gMDsKCiAgICAgICAgICAgICAgICBpZiAoZGlyVG9CYWxsLmxlbmd0aFNxKCkgPiAwLjAxKSB7CiAgICAgICAgICAgICAgICAgICAgZGlyVG9CYWxsLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZGFzaFZlYy5jb3B5KGRpclRvQmFsbCkubXVsdGlwbHlTY2FsYXIoOC4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXNoVmVjLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBjYXRjaEFjdGlvbiA9IHRoaXMuYWN0aW9uc1snY2F0Y2gnXTsKICAgICAgICAgICAgICAgIGlmIChjYXRjaEFjdGlvbikgewogICAgICAgICAgICAgICAgICAgIGNhdGNoQWN0aW9uLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgIGNhdGNoQWN0aW9uLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjYXRjaEFjdGlvbi50aW1lU2NhbGUgPSAxLjU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnBsYXkoJ2NhdGNoJywgMC4xKTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImRlZmF1bHQiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ2hvcml6b250YWwnOwogICAgICAgICAgICAgICAgdGhpcy5faGFzSGl0VGFja2xlID0gZmFsc2U7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdmVsb2NpdHkgaW1wdWxzZSBpbiBkYXNoIGRpcmVjdGlvbgovLyBBcHBseSB2ZWxvY2l0eSBpbXB1bHNlIGluIGRhc2ggZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBfcFZlYy5zZXQobngsIDAsIG56KTsKICAgICAgICAgICAgICAgIGlmIChfcFZlYy5sZW5ndGhTcSgpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICB9CnRoaXMudmVsb2NpdHkuYWRkKF9wVmVjLm11bHRpcGx5U2NhbGFyKDE0LjApKTsgLy8gTmVyZmVkIGZyb20gMjAuMAoKICAgICAgICAgICAgICAgIGNvbnN0IGx1bmdlQWN0aW9uID0gdGhpcy5hY3Rpb25zWyd0aHJvdyddOwogICAgICAgICAgICAgICAgaWYgKGx1bmdlQWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgbHVuZ2VBY3Rpb24uc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICAgICAgbHVuZ2VBY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLnRpbWVTY2FsZSA9IDIuMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucGxheSgndGhyb3cnLCAwLjEpOwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCkgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QoMC4wNSwgJ2RlZmF1bHQnKTsKICAgICAgICAgICAgfQoKaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKDEwKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuMyk7IAogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIERhc2ggRWZmZWN0CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXNoUG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICBkYXNoUG9zLnkgKz0gMS4wOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgZGFzaFBvcywgeyBzY2FsZTogMS41LCBsaWZlOiAwLjMgfSk7CiAgICAgICAgICAgICAgICAvLyBTcGVlZCBsaW5lcwogICAgICAgICAgICAgICAgY29uc3QgYmFjayA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDM7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBkYXNoUG9zLmNsb25lKCkuYWRkKGJhY2subXVsdGlwbHlTY2FsYXIoTWF0aC5yYW5kb20oKSkpOwogICAgICAgICAgICAgICAgICAgIHAueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2Rhc2hfc3RyZWFtJywgcCwgeyBzY2FsZTogMS41IH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY3JlYXRlSFBCYXIoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IG5ldyBUSFJFRS5Hcm91cCgpOwoKICAgICAgICAgICAgY29uc3QgYmdHZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjIsIDAuMTUpOwogICAgICAgICAgICBjb25zdCBiZ01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwMDAwMCwgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgZGVwdGhUZXN0OiBmYWxzZSB9KTsKICAgICAgICAgICAgY29uc3QgYmcgPSBuZXcgVEhSRUUuTWVzaChiZ0dlbywgYmdNYXQpOwogICAgICAgICAgICBjb250YWluZXIuYWRkKGJnKTsKCiAgICAgICAgICAgIGNvbnN0IGZpbGxHZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjE2LCAwLjExKTsKICAgICAgICAgICAgZmlsbEdlby50cmFuc2xhdGUoMC41OCwgMCwgMCk7CiAgICAgICAgICAgIGNvbnN0IGZpbGxNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgwMGZmMDAsIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIGRlcHRoVGVzdDogZmFsc2UgfSk7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsID0gbmV3IFRIUkVFLk1lc2goZmlsbEdlbywgZmlsbE1hdCk7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsLnBvc2l0aW9uLnNldCgtMC41OCwgMCwgMC4wMSk7CiAgICAgICAgICAgIGNvbnRhaW5lci5hZGQodGhpcy5ocEJhckZpbGwpOwoKICAgICAgICAgICAgdGhpcy5ocEJhciA9IGNvbnRhaW5lcjsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5ocEJhcik7CiAgICAgICAgfQoKX3VwZGF0ZUhQQmFyKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaHBCYXIgfHwgIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gVmlzaWJpbGl0eSBDaGVjazogT25seSBzaG93IGluIEFjdGl2ZS9QcmFjdGljZSBzdGF0ZXMKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgYWxsb3dlZFN0YXRlID0gZ2FtZSAmJiAoZ2FtZS5zdGF0ZSA9PT0gJ2FjdGl2ZScgfHwgZ2FtZS5zdGF0ZSA9PT0gJ2tpY2tvZmYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghYWxsb3dlZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5ocEJhci5wb3NpdGlvbi5jb3B5KHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIHRoaXMuaHBCYXIucG9zaXRpb24ueSArPSAyLjI7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEpIHsKICAgICAgICAgICAgICAgIHRoaXMuaHBCYXIubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBwY3QgPSBNYXRoLm1heCgwLCB0aGlzLnN0YXRzLkhQIC8gdGhpcy5zdGF0cy5tYXhIUCk7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsLnNjYWxlLnNldFgocGN0KTsKCiAgICAgICAgICAgIGlmIChwY3QgPiAwLjUpIHRoaXMuaHBCYXJGaWxsLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweDAwZmYwMCk7CiAgICAgICAgICAgIGVsc2UgaWYgKHBjdCA+IDAuMjUpIHRoaXMuaHBCYXJGaWxsLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmZmYwMCk7CiAgICAgICAgICAgIGVsc2UgdGhpcy5ocEJhckZpbGwubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmYwMDAwKTsKCiAgICAgICAgICAgIC8vIEhpZGUgaWYgZnVsbCBIUCB0byByZWR1Y2UgY2x1dHRlciwgdW5sZXNzIGluIHByYWN0aWNlIG1vZGUKICAgICAgICAgICAgY29uc3QgYWx3YXlzU2hvdyA9IGdhbWUgJiYgZ2FtZS5nYW1lTW9kZSA9PT0gJ3ByYWN0aWNlJzsKICAgICAgICAgICAgdGhpcy5ocEJhci52aXNpYmxlID0gKHBjdCA8IDAuOTggfHwgYWx3YXlzU2hvdyk7CiAgICAgICAgfQoKICAgICAgICBnYWluRXhwKGFtb3VudCkgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSB8fCB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CgogICAgICAgICAgICB0aGlzLmV4cCArPSBhbW91bnQ7CgogICAgICAgICAgICBpZiAodGhpcy5leHAgPj0gdGhpcy5uZXh0TGV2ZWxFeHApIHsKICAgICAgICAgICAgICAgIHRoaXMubGV2ZWxVcCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsZXZlbFVwKCkgewogICAgICAgICAgICB0aGlzLmxldmVsKys7CiAgICAgICAgICAgIHRoaXMuZXhwIC09IHRoaXMubmV4dExldmVsRXhwOwogICAgICAgICAgICB0aGlzLm5leHRMZXZlbEV4cCA9IE1hdGguZmxvb3IodGhpcy5uZXh0TGV2ZWxFeHAgKiAxLjUpOwoKICAgICAgICAgICAgY29uc3Qga2V5cyA9IFsnSFAnLCAnRU4nLCAnQVQnLCAnUEEnLCAnQkwnLCAnU0gnLCAnQ0EnLCAnU1AnXTsKCiAgICAgICAgICAgIGNvbnN0IGhwR2FpbiA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDIwKSArIDEwOwogICAgICAgICAgICB0aGlzLnN0YXRzLm1heEhQICs9IGhwR2FpbjsKICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCA9IHRoaXMuc3RhdHMubWF4SFA7CgogICAgICAgICAgICBrZXlzLmZvckVhY2goayA9PiB7CiAgICAgICAgICAgICAgICBpZiAoayA9PT0gJ0hQJykgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPiAwLjQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnYWluID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMikgKyAxOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHNba10gKz0gZ2FpbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gcmVhY2hlZCBMZXZlbCAke3RoaXMubGV2ZWx9IWApOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgdGhpcy5tZXNoKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJMRVZFTCBVUCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jaGVja1RhY2tsZUNvbGxpc2lvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW0gfHwgdGhpcy5faGFzSGl0VGFja2xlKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwoKICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3Bwb25lbnRUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG9wcC5tZXNoLnBvc2l0aW9uKTsKCmlmIChkaXN0IDwgMy4wKSB7IC8vIEluY3JlYXNlZCBmcm9tIDIuMCBmb3IgZWFzaWVyIGhpdHMKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNvbHZlVGFja2xlSGl0KG9wcCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGFzSGl0VGFja2xlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9yZXNvbHZlVGFja2xlSGl0KG9wcCkgewogICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKC0wLjUpOwogICAgICAgICAgICB0aGlzLnBsYXkoJ2lkbGUnLCAwLjIpOwoKICAgICAgICAgICAgY29uc3QgYXQgPSB0aGlzLmdldFN0YXQoJ0FUJyk7CiAgICAgICAgICAgIGxldCBkYW1hZ2UgPSBhdCAqIDMuMDsKCiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnRhY2tsZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgb3BwLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDEwLjApOwogICAgICAgICAgICAgICAgZGFtYWdlICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50ZWNocy50YWNrbGUgPT09ICd3aXRoZXInKSB7CiAgICAgICAgICAgICAgICBvcHAuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDEwLjAsICdFTicpOwogICAgICAgICAgICAgICAgZGFtYWdlICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50ZWNocy50YWNrbGUgPT09ICdkcmFpbicpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgKz0gMjA7CiAgICAgICAgICAgICAgICBvcHAuc3RhdHMuSFAgLT0gMjA7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJEUkFJTiIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBvcHAuY3VycmVudEVOIC09IGRhbWFnZTsKCmlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUmVtb3ZlZCAiRU4iIHN1ZmZpeCBmb3IgY2xlYW5lciBsb29rCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgJHtNYXRoLmZsb29yKGRhbWFnZSl9YCwgb3BwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCQU0hIiwgb3BwLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAob3BwLmN1cnJlbnRFTiA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgb3BwLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBvcHAuc3R1blRpbWVyID0gMC41OwogICAgICAgICAgICAgICAgICAgIG9wcC5wbGF5T25lU2hvdCgncmVhY3QnLCAwLjEpOwp9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMudGFja2xlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQodGhpcywgdGhpcy50ZWNocy50YWNrbGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG9wcC5zdHVuVGltZXIgPSAxLjA7CiAgICAgICAgICAgICAgICBvcHAucGxheU9uZVNob3QoJ3JlYWN0JywgMC4xKTsKaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTTUFDSyEiLCBvcHAubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBwdXNoRGlyID0gb3BwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgcHVzaERpci55ID0gMC4yOwogICAgICAgICAgICBvcHAudmVsb2NpdHkuYWRkKHB1c2hEaXIubXVsdGlwbHlTY2FsYXIoMTIuMCkpOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCgwLjEsICdoZWF2eScpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuOCk7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaCkgewpjb25zdCBtaWQgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQob3BwLm1lc2gucG9zaXRpb24pLm11bHRpcGx5U2NhbGFyKDAuNSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaChtaWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAovLyBCdWJibGUgQnVyc3QgKFRhY2tsZSBIaXQpCi8vIEJ1YmJsZSBCdXJzdCAoVGFja2xlIEhpdCkKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG1pZCA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmxlcnAob3BwLm1lc2gucG9zaXRpb24sIDAuNSk7CiAgICAgICAgICAgICAgICBtaWQueSArPSAxLjA7CiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzMDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYnViYmxlUG9zID0gbWlkLmNsb25lKCkuYWRkKG5ldyBUSFJFRS5WZWN0b3IzKChNYXRoLnJhbmRvbSgpLTAuNSkqMS41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjEuNSwgKE1hdGgucmFuZG9tKCktMC41KSoxLjUpKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBidWJibGVQb3MsIHsgc2NhbGU6IDAuMTUgKyBNYXRoLnJhbmRvbSgpICogMC4zNSB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5R29hbENyZWFzZShkdCkgewoKICAgICAgICAgICAgY29uc3QgZ29hbHMgPSBbCgogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgNDYpLAogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgLTQ2KQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gMTAuMDsKCiAgICAgICAgICAgIGdvYWxzLmZvckVhY2goZ29hbCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBkeCA9IHRoaXMubWVzaC5wb3NpdGlvbi54IC0gZ29hbC54OwogICAgICAgICAgICAgICAgY29uc3QgZHogPSB0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWwuejsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IGR4KmR4ICsgZHoqZHo7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IHJhZGl1cyAqIHJhZGl1cykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZGlzdFNxKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWCA9IGRpc3QgPiAwID8gZHggLyBkaXN0IDogMTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoWiA9IGRpc3QgPiAwID8gZHogLyBkaXN0IDogMDsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSA1MC4wOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSBwdXNoWCAqIGZvcmNlICogZHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS56ICs9IHB1c2haICogZm9yY2UgKiBkdDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPCByYWRpdXMgLSAwLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xhbXBSYXRpbyA9IHJhZGl1cyAvIChkaXN0ICsgMC4wMDEpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueCA9IGdvYWwueCArIGR4ICogY2xhbXBSYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSBnb2FsLnogKyBkeiAqIGNsYW1wUmF0aW87CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguUGxheWVyID0gUGxheWVyOwp9KSgpOwo=","main.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgLy8gTmFtZXNwYWNlCiAgICB3aW5kb3cuZmx1eCA9IHdpbmRvdy5mbHV4IHx8IHt9OwogICAgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyA9IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgfHwgW107CgogICAgLy8gQ29uZmlnCmNvbnN0IF9jb25maWcgPSB7CiAgICAgICAgaW50ZXJuYWxXaWR0aDogMzYwLAogICAgICAgIGludGVybmFsSGVpZ2h0OiA2NDAsCiAgICAgICAgYmdDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgZm9nQ29sb3I6IDB4MDAxZTM2LAogICAgICAgIGZvZ0RlbnNpdHk6IDAuMDAwMSwgLy8gRHJhc3RpY2FsbHkgcmVkdWNlZCB0byBlbnN1cmUgdmlzaWJpbGl0eQogICAgICAgIGFyZW5hUmFkaXVzOiA0OC4wCiAgICB9OwoKICAgIC8vIEdsb2JhbHMKLy8gR2xvYmFscwogICAgY29uc3QgX2lucHV0ID0geyB4OiAwLCB5OiAwIH07IC8vIElucHV0IHN0YXRlCiAgICAKICAgIC8vIFNoYWRlciBVbmlmb3JtcwogICAgY29uc3QgX2FyZW5hVW5pZm9ybXMgPSB7CiAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICB1SW1wYWN0UG9zOiB7IHZhbHVlOiBuZXcgVEhSRUUuVmVjdG9yMygpIH0sCiAgICAgICAgdUltcGFjdFN0cjogeyB2YWx1ZTogMC4wIH0KICAgIH07CiAgICBjb25zdCBfcGFydGljbGVVbmlmb3JtcyA9IHsKICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9CiAgICB9OwoKICAgIC8vIEV4cG9zZSBJbXBhY3QgVHJpZ2dlcgogICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0ID0gZnVuY3Rpb24ocG9zLCBzdHJlbmd0aCkgewogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RQb3MudmFsdWUuY29weShwb3MpOwogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RTdHIudmFsdWUgPSBzdHJlbmd0aCAqIDIuMDsgLy8gU2NhbGUgdXAgZm9yIHZpc2liaWxpdHkKICAgIH07Ci8vIF9pbnB1dCBhbHJlYWR5IGRlY2xhcmVkIGFib3ZlCiAgICBjb25zdCBfdGVtcFZlYzEgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBSZXVzYWJsZSBmb3IgcGh5c2ljcy9sb2dpYwogICAgY29uc3QgX3RlbXBWZWMyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsgLy8gUmV1c2FibGUgZm9yIHBoeXNpY3MvbG9naWMKICAgIGxldCBfc2NlbmUsIF9jYW1lcmEsIF9yZW5kZXJlciwgX2Nsb2NrOwogICAgbGV0IF9ob21lVGVhbSwgX2F3YXlUZWFtOwogICAgbGV0IF9iYWxsOwogICAgbGV0IF9nYW1lTWFuYWdlcjsKICAgIGxldCBfbWVudU1hbmFnZXI7CiAgICBsZXQgX2F1ZGlvTWFuYWdlcjsKCiAgICBsZXQgX2NhbWVyYU1hbmFnZXI7CiAgICBsZXQgX3dhdGVyT3ZlcmxheTsKICAgIGxldCBfbGlnaHRTaGFmdHM7CiAgICBsZXQgX3N0YWRpdW07CiAgICBsZXQgX2dseXBoTWFuYWdlcjsKCiAgICAvLyBJTVBST1ZFRDogU2V0dGluZ3Mgb2JqZWN0CiAgICBjb25zdCBfc2V0dGluZ3MgPSB7CiAgICAgICAgam95c3RpY2tTZW5zaXRpdml0eTogMS4wLAogICAgICAgIGFpbUFzc2lzdDogdHJ1ZSwKICAgICAgICBjYW1lcmFTaGFrZTogdHJ1ZSwKICAgICAgICBoaXRTdG9wOiB0cnVlLAogICAgICAgIGludmVydENhbWVyYTogZmFsc2UsCiAgICAgICAgYXV0b1JlY2VudGVyOiB0cnVlCiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRGVidWcgSU8gQnJpZGdlIChleHBvc2VkIGZvciBEZXZUb29scyBKU09OIHNuYXBzaG90cykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIHx8IHt9OwogICAgX2RlYnVnSU8uc2V0dGluZ3MgPSBfc2V0dGluZ3M7CiAgICBfZGVidWdJTy5pbnB1dCA9IF9kZWJ1Z0lPLmlucHV0IHx8IHt9OwogICAgX2RlYnVnSU8ucGVyZiA9IF9kZWJ1Z0lPLnBlcmYgfHwgeyBmcmFtZTogMCwgcmF3RHQ6IDAsIGR0OiAwLCBmcHM6IDAsIGF2Z0ZwczogMCB9OwoKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIFRvdWNoIGhlbHBlcnMgKG11bHRpLXRvdWNoIHNhZmUpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGZ1bmN0aW9uIF9maW5kVG91Y2hCeUlkKHRvdWNoTGlzdCwgaWQpIHsKICAgICAgICBpZiAoaWQgPT09IG51bGwgfHwgaWQgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgICAgaWYgKCF0b3VjaExpc3QpIHJldHVybiBudWxsOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdG91Y2hMaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IHQgPSB0b3VjaExpc3RbaV07CiAgICAgICAgICAgIGlmICh0ICYmIHQuaWRlbnRpZmllciA9PT0gaWQpIHJldHVybiB0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBfZW5kZWRUb3VjaEJ5SWQoY2hhbmdlZFRvdWNoZXMsIGlkKSB7CiAgICAgICAgaWYgKGlkID09PSBudWxsIHx8IGlkID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgICAgIGlmICghY2hhbmdlZFRvdWNoZXMpIHJldHVybiBudWxsOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hhbmdlZFRvdWNoZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgdCA9IGNoYW5nZWRUb3VjaGVzW2ldOwogICAgICAgICAgICBpZiAodCAmJiB0LmlkZW50aWZpZXIgPT09IGlkKSByZXR1cm4gdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGluaXQoKSB7CiAgICAgICAgX2NvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnYW1lLWNvbnRhaW5lcicpOwoKICAgICAgICAvLyAxLiBTY2VuZQogICAgICAgIF9zY2VuZSA9IG5ldyBUSFJFRS5TY2VuZSgpOwogICAgICAgIF9zY2VuZS5iYWNrZ3JvdW5kID0gbmV3IFRIUkVFLkNvbG9yKF9jb25maWcuYmdDb2xvcik7CiAgICAgICAgX3NjZW5lLmZvZyA9IG5ldyBUSFJFRS5Gb2dFeHAyKF9jb25maWcuZm9nQ29sb3IsIF9jb25maWcuZm9nRGVuc2l0eSk7CgogICAgICAgIC8vIDIuIENhbWVyYQogICAgICAgIGNvbnN0IGFzcGVjdCA9IF9jb25maWcuaW50ZXJuYWxXaWR0aCAvIF9jb25maWcuaW50ZXJuYWxIZWlnaHQ7Cl9jYW1lcmEgPSBuZXcgVEhSRUUuUGVyc3BlY3RpdmVDYW1lcmEoNjAsIGFzcGVjdCwgMC4xLCA1MDApOwpfY2FtZXJhLnBvc2l0aW9uLnNldCgwLCAxNCwgMjIpOwogICAgICAgIF9jYW1lcmEubG9va0F0KDAsIDAsIDApOwogICAgICAgIF9zY2VuZS5hZGQoX2NhbWVyYSk7IC8vIEVuc3VyZSBjYW1lcmEgaXMgaW4gc2NlbmUgZm9yIGNoaWxkcmVuIHRvIHJlbmRlcgoKICAgICAgICAvLyAzLiBSZW5kZXJlcgovLyAzLiBSZW5kZXJlcgogICAgICAgIF9yZW5kZXJlciA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlcmVyKHsgCiAgICAgICAgICAgIGFudGlhbGlhczogZmFsc2UsCiAgICAgICAgICAgIHBvd2VyUHJlZmVyZW5jZTogImhpZ2gtcGVyZm9ybWFuY2UiLAogICAgICAgICAgICBwcmVjaXNpb246ICJtZWRpdW1wIiwgLy8gTW9iaWxlIG9wdGltaXphdGlvbjogZmFzdGVyIHNoYWRlcnMKICAgICAgICAgICAgc3RlbmNpbDogZmFsc2UsICAgICAgIC8vIERpc2FibGUgc3RlbmNpbCBidWZmZXIgaWYgbm90IHVzZWQKICAgICAgICAgICAgZGVwdGg6IHRydWUKICAgICAgICB9KTsKICAgICAgICBfcmVuZGVyZXIuc2V0UGl4ZWxSYXRpbygxKTsgLy8gRm9yY2UgMToxIHBpeGVsIHJhdGlvLCB3ZSBoYW5kbGUgc2NhbGluZyB2aWEgc2V0U2l6ZQogICAgICAgIF9yZW5kZXJlci5hdXRvQ2xlYXIgPSBmYWxzZTsgLy8gV2UgbWFuYWdlIGNsZWFyaW5nIHZpYSBiYWNrZ3JvdW5kIG9yIG1hbnVhbCBjYWxscyBpZiBuZWVkZWQgKHRob3VnaCBzY2VuZS5iYWNrZ3JvdW5kIGhhbmRsZXMgY29sb3IpCiAgICAgICAgLy8gRXhwb3NlIHJlbmRlcmVyIGZvciBEZXZUb29scwogICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIF9nYW1lTWFuYWdlci5yZW5kZXJlciA9IF9yZW5kZXJlcjsgCiAgICAgICAgZWxzZSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPSB7IHJlbmRlcmVyOiBfcmVuZGVyZXIgfTsgLy8gVGVtcCBob29rCl9jb250YWluZXIuYXBwZW5kQ2hpbGQoX3JlbmRlcmVyLmRvbUVsZW1lbnQpOwoKLy8gLS0tIFZpZGVvIE92ZXJsYXkgRW5mb3JjZW1lbnQgLS0tCiAgICAgICAgLy8gLS0tIE92ZXJsYXkgVmlkZW8gTG9naWMgUmVtb3ZlZCAoU3dpdGNoZWQgdG8gR0lGKSAtLS0KICAgICAgICAvLyA1LiBFbnZpcm9ubWVudAogICAgICAgIGNyZWF0ZVBhcnRpY2xlcygpOwogICAgICAgIGNyZWF0ZUFyZW5hKCk7CmNyZWF0ZUFyZW5hKCk7CiAgICAgICAgY3JlYXRlSG9sb2dyYXBoaWNSaW5ncygpOwovLyA1LjUgR2FtZSBNYW5hZ2VyCl9nYW1lTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5HYW1lTWFuYWdlcihfc2NlbmUsICd1aS1sYXllcicsIF9jYW1lcmEsIF9yZW5kZXJlcik7CiAgICAgICAgCiAgICAgICAgLy8gNS41LjEgQXVkaW8gTWFuYWdlcgogICAgICAgIF9hdWRpb01hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguQXVkaW9NYW5hZ2VyKCk7CiAgICAgICAgX2dhbWVNYW5hZ2VyLmF1ZGlvTWFuYWdlciA9IF9hdWRpb01hbmFnZXI7CgogICAgICAgIC8vIDUuNiBDYW1lcmEgTWFuYWdlcgogICAgICAgIF9jYW1lcmFNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkNhbWVyYU1hbmFnZXIoX2NhbWVyYSwgX3NjZW5lKTsKICAgICAgICBfZ2FtZU1hbmFnZXIuY2FtZXJhTWFuYWdlciA9IF9jYW1lcmFNYW5hZ2VyOwoKICAgICAgICAvLyA1LjcgRGV2IFRvb2xzCmlmICh3aW5kb3cuZmx1eC5EZXZUb29scykgewogICAgICAgICAgICBuZXcgd2luZG93LmZsdXguRGV2VG9vbHMoX2dhbWVNYW5hZ2VyKTsKICAgICAgICB9Ci8vIDUuOCBXYXRlciBPdmVybGF5LCBMaWdodCBTaGFmdHMsIFN0YWRpdW0sIEdseXBocwogICAgICAgIF93YXRlck92ZXJsYXkgPSBuZXcgd2luZG93LmZsdXguV2F0ZXJPdmVybGF5KF9jYW1lcmEpOwogICAgICAgIF9saWdodFNoYWZ0cyA9IG5ldyB3aW5kb3cuZmx1eC5MaWdodFNoYWZ0cyhfc2NlbmUpOwogICAgICAgIF9zdGFkaXVtID0gbmV3IHdpbmRvdy5mbHV4LlN0YWRpdW0oX3NjZW5lKTsKICAgICAgICBfZ2x5cGhNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkdseXBoTWFuYWdlcihfc2NlbmUpOwogICAgICAgIAppZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIF9nYW1lTWFuYWdlci5nbHlwaE1hbmFnZXIgPSBfZ2x5cGhNYW5hZ2VyOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIud2F0ZXJPdmVybGF5ID0gX3dhdGVyT3ZlcmxheTsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmxpZ2h0U2hhZnRzID0gX2xpZ2h0U2hhZnRzOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIuc3RhZGl1bSA9IF9zdGFkaXVtOwogICAgICAgIH0KICAgICAgICAvLyA2LiBUZWFtcyBTZXR1cAogICAgICAgIF9ob21lVGVhbSA9IG5ldyB3aW5kb3cuZmx1eC5UZWFtKF9zY2VuZSwgJ2hvbWUnLCAxLCAweDAwYWFmZiwgdHJ1ZSk7CiAgICAgICAgX2F3YXlUZWFtID0gbmV3IHdpbmRvdy5mbHV4LlRlYW0oX3NjZW5lLCAnYXdheScsIC0xLCAweGZmNjY2NiwgZmFsc2UpOwoKICAgICAgICAvLyA3LiBCYWxsCiAgICAgICAgX2JhbGwgPSBuZXcgd2luZG93LmZsdXguQmFsbChfc2NlbmUpOwoKICAgICAgICAvLyBJTVBST1ZFRDogTGluayBiYWxsIHRvIGNhbWVyYSBmb3Igc21hcnQgZnJhbWluZwogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnNldEJhbGwoX2JhbGwpOwoKICAgICAgICAvLyA4LiBUZWFtIFJvc3RlciBNb2RlbHMKICAgICAgICBjb25zdCByb2xlcyA9IFsnTEYnLCAnUkYnLCAnTUYnLCAnTEQnLCAnUkQnLCAnR0wnXTsKICAgICAgICBjb25zdCBob21lUm9zdGVyID0gewogICAgICAgICAgICBMRjogeyBuYW1lOiAnVGlkdXMnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZGE3ODhiZWYyNThjNGYwYjhkOWVmMWFjYzE5YzU1NjcuZ2xiJyB9LAogICAgICAgICAgICBSRjogeyBuYW1lOiAnV2Fra2EnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJyB9LAogICAgICAgICAgICBNRjogeyBuYW1lOiAnTGV0dHknLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNDNhY2UzNGM2ZmQ5NDIxNTk2N2U4NDJiZjkwOWRhNWUuZ2xiJyB9LAogICAgICAgICAgICBMRDogeyBuYW1lOiAnRGF0dG8nLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZTZkNjdlY2IyZTRjNDcxNWJkNzNhNDA3OTVlMWQzZDUuZ2xiJyB9LAogICAgICAgICAgICBSRDogeyBuYW1lOiAnSmFzc3UnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJyB9LAogICAgICAgICAgICBHTDogeyBuYW1lOiAnQm90dGEnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvYWQxNTVlZmVkYzBkNDhmZGFkMDlkYTNlMWNhZTljOTcuZ2xiJyB9CiAgICAgICAgfTsKCmNvbnN0IGFwcGx5U3RhdHMgPSAocCwgcm9sZSwgaXNIb21lKSA9PiB7CmNvbnN0IHRlYW1MZXZlbCA9IGlzSG9tZSA/IDI1IDogODsgLy8gTmVyZmVkIENQVSBsZXZlbCBzaWduaWZpY2FudGx5ICh3YXMgMTUpCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LlRlYW0uZ2VuZXJhdGVTdGF0cyhwLCByb2xlLCB0ZWFtTGV2ZWwsIGlzSG9tZSk7CgogICAgICAgICAgICBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDU7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNQICs9IDM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDM7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkVOICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdCcm90aGVyJykpIHsKICAgICAgICAgICAgICAgIHAuc3RhdHMuU1AgPSA5OTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcC5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CiAgICAgICAgfTsKCiAgICAgICAgbGV0IGhvbWVMb2FkZWQgPSAwOwogICAgICAgIGNvbnN0IHJvbGVHbHRmcyA9IHt9OwoKICAgICAgICBjb25zdCBmaW5hbGl6ZVRlYW1zID0gKCkgPT4gewogICAgICAgICAgICByb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZ2x0ZiA9IHJvbGVHbHRmc1tyb2xlXSB8fCByb2xlR2x0ZnMuTEY7CgogICAgICAgICAgICAgICAgY29uc3QgcCA9IChyb2xlID09PSAnR0wnKQogICAgICAgICAgICAgICAgICAgID8gbmV3IHdpbmRvdy5mbHV4LkdvYWxpZShfc2NlbmUsIHJvbGUpCiAgICAgICAgICAgICAgICAgICAgOiBuZXcgd2luZG93LmZsdXguQUlQbGF5ZXIoX3NjZW5lLCByb2xlKTsKCiAgICAgICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgICAgICBwLmNoYXJhY3Rlck5hbWUgPSBlbnRyeSA/IGBDUFUgJHtlbnRyeS5uYW1lfWAgOiAnQ1BVJzsKICAgICAgICAgICAgICAgIGFwcGx5U3RhdHMocCwgcm9sZSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmICYmIGdsdGYuc2NlbmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjbG9uZSA9IFRIUkVFLlNrZWxldG9uVXRpbHMuY2xvbmUoZ2x0Zi5zY2VuZSk7CiAgICAgICAgICAgICAgICAgICAgcC5zZXRNZXNoKGNsb25lLCBnbHRmLmFuaW1hdGlvbnMgfHwgW10pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ01pc3NpbmcgR0xURiBmb3IgYXdheSByb2xlOicsIHJvbGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS5hZGRQbGF5ZXIocCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYWxsUGxheWVycyA9IFsuLi5faG9tZVRlYW0ucGxheWVycywgLi4uX2F3YXlUZWFtLnBsYXllcnNdOwogICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAocC5iYWxsUmVmID09PSBudWxsKSBwLmJhbGxSZWYgPSBfYmFsbDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyID0gX2hvbWVUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy50YWNrbGUgPSAndmVub20nOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy5zaG9vdCA9ICdzcGhlcmUnOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0VxdWlwcGVkIEhvbWUgTUYgd2l0aCBWZW5vbSBUYWNrbGUgJiBTcGhlcmUgU2hvdCcpOwogICAgICAgICAgICB9Cgpjb25zdCBhd2F5TUYgPSBfYXdheVRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgLy8gUmVtb3ZlZCBndWFyYW50ZWVkIFdpdGhlciB0YWNrbGUgZm9yIEF3YXkgTUYgdG8gcmVkdWNlIGRpZmZpY3VsdHkKICAgICAgICAgICAgX2F3YXlUZWFtLnNldEZvcm1hdGlvbignQ291bnRlcicpOwoKICAgICAgICAgICAgY29uc3QgYXdheUdMID0gX2F3YXlUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ0dMJyk7CiAgICAgICAgICAgIC8vIFJlbW92ZWQgZ3VhcmFudGVlZCBTdXBlciBHb2FsaWUgZm9yIEF3YXkgR0wgdG8gbWFrZSBzY29yaW5nIGVhc2llcgoKICAgICAgICAgICAgX2hvbWVUZWFtLmFzc2lnbk1hcmtzKF9hd2F5VGVhbSk7CiAgICAgICAgICAgIF9hd2F5VGVhbS5hc3NpZ25NYXJrcyhfaG9tZVRlYW0pOwoKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xvYWRpbmcnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIucmVnaXN0ZXJUZWFtcyhfaG9tZVRlYW0sIF9hd2F5VGVhbSwgX2JhbGwpOwoKICAgICAgICAgICAgICAgIF9tZW51TWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5NZW51TWFuYWdlcihfZ2FtZU1hbmFnZXIpOwogICAgICAgICAgICAgICAgX21lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgfQogICAgICAgIH07Cgpyb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgIGlmICghZW50cnkpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9uQ29tcGxldGUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBob21lTG9hZGVkKys7CiAgICAgICAgICAgICAgICBpZiAoaG9tZUxvYWRlZCA+PSByb2xlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBmaW5hbGl6ZVRlYW1zKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlci5sb2FkTW9kZWwoZW50cnkudXJsLCAoZ2x0ZikgPT4gewogICAgICAgICAgICAgICAgcm9sZUdsdGZzW3JvbGVdID0gZ2x0ZjsKCiAgICAgICAgICAgICAgICBjb25zdCBwID0gKHJvbGUgPT09ICdHTCcpCiAgICAgICAgICAgICAgICAgICAgPyBuZXcgd2luZG93LmZsdXguR29hbGllKF9zY2VuZSwgcm9sZSkKICAgICAgICAgICAgICAgICAgICA6IG5ldyB3aW5kb3cuZmx1eC5BSVBsYXllcihfc2NlbmUsIHJvbGUpOwoKICAgICAgICAgICAgICAgIHAuY2hhcmFjdGVyTmFtZSA9IGVudHJ5Lm5hbWU7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIHRydWUpOwoKICAgICAgICAgICAgICAgIGNvbnN0IGNsb25lID0gVEhSRUUuU2tlbGV0b25VdGlscy5jbG9uZShnbHRmLnNjZW5lKTsKICAgICAgICAgICAgICAgIHAuc2V0TWVzaChjbG9uZSwgZ2x0Zi5hbmltYXRpb25zKTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hZGRQbGF5ZXIocCk7CgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpOwogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2FkIG1vZGVsJywgZW50cnkubmFtZSwgZW50cnkudXJsLCBlcnIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayBNZXNoIChSZWQgQm94KQogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoMSwgMiwgMSk7CiAgICAgICAgICAgICAgICBjb25zdCBmYWxsYmFja01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlIH0pOwogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tNZXNoID0gbmV3IFRIUkVFLk1lc2goZmFsbGJhY2tHZW8sIGZhbGxiYWNrTWF0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU3RvcmUgZHVtbXkgaW4gcm9sZUdsdGZzIGZvciBhd2F5IHRlYW0gY2xvbmluZwogICAgICAgICAgICAgICAgcm9sZUdsdGZzW3JvbGVdID0geyBzY2VuZTogZmFsbGJhY2tNZXNoLCBhbmltYXRpb25zOiBbXSB9OwoKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSAocm9sZSA9PT0gJ0dMJykKICAgICAgICAgICAgICAgICAgICA/IG5ldyB3aW5kb3cuZmx1eC5Hb2FsaWUoX3NjZW5lLCByb2xlKQogICAgICAgICAgICAgICAgICAgIDogbmV3IHdpbmRvdy5mbHV4LkFJUGxheWVyKF9zY2VuZSwgcm9sZSk7CgogICAgICAgICAgICAgICAgcC5jaGFyYWN0ZXJOYW1lID0gZW50cnkubmFtZSArICIgKEVycm9yKSI7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIHRydWUpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBwLnNldE1lc2goZmFsbGJhY2tNZXNoLmNsb25lKCksIFtdKTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hZGRQbGF5ZXIocCk7CgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gOC4gSW5wdXQKICAgICAgICBzZXR1cElucHV0cygpOwoKICAgICAgICAvLyA5LiBMb29wCiAgICAgICAgX2Nsb2NrID0gbmV3IFRIUkVFLkNsb2NrKCk7CiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwoKICAgICAgICAvLyBIYW5kbGUgcmVzaXplCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIG9uUmVzaXplKTsKICAgICAgICBvblJlc2l6ZSgpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlUGFydGljbGVzKCkgewogICAgICAgIGNvbnN0IGNvdW50ID0gMTUwMDsgLy8gSW5jcmVhc2VkIGNvdW50CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IFtdOwogICAgICAgIGNvbnN0IG9mZnNldHMgPSBbXTsgLy8gUmFuZG9tIG9mZnNldHMgZm9yIGluZGVwZW5kZW50IGJvYmJpbmcKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgIHZlcnRpY2VzLnB1c2goCiAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA4MCwgLy8gV2lkZXIgc3ByZWFkIFgKICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDUwLCAvLyBXaWRlciBzcHJlYWQgWQogICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogODAgIC8vIFdpZGVyIHNwcmVhZCBaCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIG9mZnNldHMucHVzaChNYXRoLnJhbmRvbSgpICogMTAwKTsKICAgICAgICB9CgogICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSh2ZXJ0aWNlcywgMykpOwogICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgnYU9mZnNldCcsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKG9mZnNldHMsIDEpKTsKCiAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICB1bmlmb3JtczogX3BhcnRpY2xlVW5pZm9ybXMsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCnZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBhT2Zmc2V0OwogICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2QWxwaGE7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAvLyBCb2JiaW5nIG1vdGlvbjogU2luZSB3YXZlIGJhc2VkIG9uIHRpbWUgKyByYW5kb20gb2Zmc2V0CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYm9iID0gc2luKHVUaW1lICogMC41ICsgYU9mZnNldCkgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gYm9iOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZlYzQgbXZQb3NpdGlvbiA9IG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zLCAxLjApOwogICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG12UG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU2l6ZSBhdHRlbnVhdGlvbiAtIFNtYWxsIGFuZCBzaGltbWVyeQogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNpemVCYXNlID0gMi4wICsgc2luKHVUaW1lICogMy4wICsgYU9mZnNldCkgKiAxLjA7IAogICAgICAgICAgICAgICAgICAgIGdsX1BvaW50U2l6ZSA9IHNpemVCYXNlICogKDIwLjAgLyAtbXZQb3NpdGlvbi56KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBGYWRlIGJhc2VkIG9uIGRpc3RhbmNlL2hlaWdodAogICAgICAgICAgICAgICAgICAgIHZBbHBoYSA9IDAuNSArIDAuNSAqIHNpbih1VGltZSAqIDIuMCArIGFPZmZzZXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgLAogICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2QWxwaGE7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU29mdCBnbG93IHBhcnRpY2xlIChEdXN0IG1vdGUpCiAgICAgICAgICAgICAgICAgICAgdmVjMiBjb29yZCA9IGdsX1BvaW50Q29vcmQgLSB2ZWMyKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGlzdCA9IGxlbmd0aChjb29yZCk7CiAgICAgICAgICAgICAgICAgICAgaWYoZGlzdCA+IDAuNSkgZGlzY2FyZDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTb2Z0IGZhbGxvZmYgZm9yIHNoaW1tZXIKICAgICAgICAgICAgICAgICAgICBmbG9hdCBzdHJlbmd0aCA9IDEuMCAtIChkaXN0ICogMi4wKTsKICAgICAgICAgICAgICAgICAgICBzdHJlbmd0aCA9IHBvdyhzdHJlbmd0aCwgMi4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDeWFuL0JsdWUgdGludCwgYWRkaXRpdmUgZmVlbAogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoMC43LCAwLjksIDEuMCwgdkFscGhhICogc3RyZW5ndGggKiAwLjgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHBvaW50cyA9IG5ldyBUSFJFRS5Qb2ludHMoZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICBwb2ludHMuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgIF9zY2VuZS5hZGQocG9pbnRzKTsKICAgIH0KCmZ1bmN0aW9uIGNyZWF0ZUFyZW5hKCkgewogICAgICAgIC8vIEdyb3VwIGZvciByb3RhdGlvbgogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICBfc2NlbmUuYWRkKHdpbmRvdy5mbHV4LmFyZW5hR3JvdXApOwoKICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeShfY29uZmlnLmFyZW5hUmFkaXVzLCAzMiwgMzIpOwogICAgICAgIAogICAgICAgIC8vIC0tLSAxLiBCYXNlIFNwaGVyZSAoRmFpbnQgR3JpZCkgLS0tCiAgICAgICAgY29uc3QgdGV4TG9hZGVyID0gbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKTsKICAgICAgICBjb25zdCBhcmVuYVRleCA9IHRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9XMUxzSDY4US9maWxlLTAwMDAwMDAwMjNlYzcxZjU5NjU5MzgyOWU4MTE4NzYwLSgxKS5wbmcnKTsKICAgICAgICBhcmVuYVRleC5tYWdGaWx0ZXIgPSBUSFJFRS5OZWFyZXN0RmlsdGVyOwogICAgICAgIGFyZW5hVGV4Lm1pbkZpbHRlciA9IFRIUkVFLk5lYXJlc3RGaWx0ZXI7CiAgICAgICAgYXJlbmFUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBhcmVuYVRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGFyZW5hVGV4LnJlcGVhdC5zZXQoNiwgNCk7CgogICAgICAgIGNvbnN0IG1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiBhcmVuYVRleCwKICAgICAgICAgICAgY29sb3I6IDB4NDQ2Njg4LAogICAgICAgICAgICB3aXJlZnJhbWU6IGZhbHNlLAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4xNSwgCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgY29uc3QgYXJlbmEgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAuYWRkKGFyZW5hKTsKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2ggPSBhcmVuYTsKCiAgICAgICAgLy8gLS0tIDIuIElubmVyIEhleCBHcmlkIChXYXJwIEVmZmVjdCkgLS0tCiAgICAgICAgLy8gUmV1c2UgZXhpc3RpbmcgaGV4IGdlbmVyYXRpb24gbG9naWMgYnV0IGF0dGFjaCB0byBncm91cAogICAgICAgIGNvbnN0IGhleFRleCA9ICgoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICAgICAgYy53aWR0aCA9IDUxMjsgYy5oZWlnaHQgPSA1MTI7CiAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLDAsNTEyLDUxMik7CiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDAsIDI1NSwgMjU1LCAwLjUpJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgIGNvbnN0IHIgPSA2NDsKICAgICAgICAgICAgY29uc3QgdyA9IHIgKiAyOwogICAgICAgICAgICBjb25zdCBoID0gTWF0aC5zcXJ0KDMpICogcjsKICAgICAgICAgICAgZm9yKGxldCB5ID0gLTE7IHkgPCA1MTIvaCArIDI7IHkrKykgewogICAgICAgICAgICAgICAgZm9yKGxldCB4ID0gLTE7IHggPCA1MTIvKHcqMC43NSkgKyAyOyB4KyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjeCA9IHggKiB3ICogMC43NTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjeSA9IHkgKiBoICsgKHglMj09PTAgPyAwIDogaC8yKTsKICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8NjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZyA9IE1hdGguUEkvMyAqIGk7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oY3ggKyBNYXRoLmNvcyhhbmcpKnIsIGN5ICsgTWF0aC5zaW4oYW5nKSpyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICAgICAgfSkoKTsKICAgICAgICBoZXhUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBoZXhUZXgud3JhcFQgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBoZXhUZXgucmVwZWF0LnNldCg0LCAyKTsKCiAgICAgICAgY29uc3QgYXJlbmFVbmlmb3JtcyA9IFRIUkVFLlVuaWZvcm1zVXRpbHMubWVyZ2UoWwogICAgICAgICAgICBUSFJFRS5Vbmlmb3Jtc0xpYlsnY29tbW9uJ10sCiAgICAgICAgICAgIF9hcmVuYVVuaWZvcm1zLAogICAgICAgICAgICB7IAogICAgICAgICAgICAgICAgdE1hcDogeyB2YWx1ZTogaGV4VGV4IH0sCiAgICAgICAgICAgICAgICB1T3BhY2l0eTogeyB2YWx1ZTogMC4xIH0gCiAgICAgICAgICAgIH0KICAgICAgICBdKTsKCiAgICAgICAgY29uc3QgbWF0ZXJpYWwyID0gbmV3IFRIUkVFLlNoYWRlck1hdGVyaWFsKHsKICAgICAgICAgICAgdW5pZm9ybXM6IGFyZW5hVW5pZm9ybXMsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IGAKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVRpbWU7CiAgICAgICAgICAgICAgICB1bmlmb3JtIHZlYzMgdUltcGFjdFBvczsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUltcGFjdFN0cjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdlV2ID0gdXY7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkaXN0ID0gZGlzdGFuY2UocG9zLCB1SW1wYWN0UG9zKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYWRpdXMgPSAyMC4wOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSBkaXN0IC8gcmFkaXVzOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBidWxnZSA9ICgxLjAgLSB0KSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBub3JtYWwgPSBub3JtYWxpemUocG9zKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zICs9IG5vcm1hbCAqIChidWxnZSAqIHVJbXBhY3RTdHIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KHBvcywgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYCwKICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGAKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHRNYXA7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVJbXBhY3RTdHI7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVPcGFjaXR5OwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWM0IHRleENvbG9yID0gdGV4dHVyZTJEKHRNYXAsIHZVdik7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYWxwaGEgPSB1T3BhY2l0eSAqIHRleENvbG9yLmE7CiAgICAgICAgICAgICAgICAgICAgYWxwaGEgKz0gdUltcGFjdFN0ciAqIDAuMDI7IAogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB0ZXhDb2xvci5yZ2IgKiB2ZWMzKDAuMiwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGFscGhhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYAogICAgICAgIH0pOwoKICAgICAgICBjb25zdCBhcmVuYTIgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwyKTsKICAgICAgICBhcmVuYTIuc2NhbGUuc2V0U2NhbGFyKDAuOTgpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAuYWRkKGFyZW5hMik7CiAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMiA9IGFyZW5hMjsKCiAgICAgICAgLy8gLS0tIDMuIFRSSUJBTCBTVFJJUCAoRXF1YXRvcikgLS0tCiAgICAgICAgY29uc3QgdHJpYmFsVGV4ID0gKCgpID0+IHsKICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICBjLndpZHRoID0gMTAyNDsgYy5oZWlnaHQgPSAxMjg7CiAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLDAsMTAyNCwxMjgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQmFja2dyb3VuZCBQYXR0ZXJuCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjEpJzsKICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDEwLCAxMDI0LCAxMDgpOwoKICAgICAgICAgICAgLy8gRGV0YWlsZWQgVHJpYmFsIEdseXBocwogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgICAgICBjb25zdCBibG9ja1cgPSA2NDsKICAgICAgICAgICAgZm9yKGxldCB4PTA7IHg8MTAyNDsgeCs9YmxvY2tXKSB7CiAgICAgICAgICAgICAgICAvLyBPdXRlciBCb3gKICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCh4KzQsIDE1LCBibG9ja1ctOCwgOTgpOwogICAgICAgICAgICAgICAgLy8gSW5uZXIgQ3V0CiAgICAgICAgICAgICAgICBjdHguY2xlYXJSZWN0KHgrMTIsIDI1LCBibG9ja1ctMjQsIDc4KTsKICAgICAgICAgICAgICAgIC8vIENlbnRlciBEb3QKICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCh4KzI4LCA1MCwgOCwgMjgpOwogICAgICAgICAgICAgICAgLy8gQ29ubmVjdG9ycwogICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KHgsIDYwLCAxMiwgOCk7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoeCtibG9ja1ctMTIsIDYwLCAxMiwgOCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIH0pKCk7CiAgICAgICAgdHJpYmFsVGV4LndyYXBTID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgdHJpYmFsVGV4LndyYXBUID0gVEhSRUUuQ2xhbXBUb0VkZ2VXcmFwcGluZzsKICAgICAgICB0cmliYWxUZXgucmVwZWF0LnNldCg0LCAxKTsKCiAgICAgICAgLy8gQ3VzdG9tIFNoYWRlciBmb3IgQ29sb3IgU2hpZnRpbmcKICAgICAgICB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3JtcyA9IHsKICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgdUNvbG9yOiB7IHZhbHVlOiBuZXcgVEhSRUUuQ29sb3IoMHgwMGZmZmYpIH0sIC8vIERlZmF1bHQgQ3lhbgogICAgICAgICAgICB0VGV4OiB7IHZhbHVlOiB0cmliYWxUZXggfQogICAgICAgIH07CgogICAgICAgIGNvbnN0IHRyaWJhbE1hdCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgIHVuaWZvcm1zOiB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3JtcywKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdlV2OwogICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgIHZVdiA9IHV2OwogICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAsCiAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMzIHVDb2xvcjsKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHRUZXg7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdlV2OwogICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgIHZlYzQgdGV4ID0gdGV4dHVyZTJEKHRUZXgsIHZlYzIodlV2LnggKiAyLjAgKyB1VGltZSAqIDAuMDUsIHZVdi55KSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYWxwaGEgPSB0ZXguYSAqIDAuODsKICAgICAgICAgICAgICAgICAgICAvLyBQdWxzZQogICAgICAgICAgICAgICAgICAgIGZsb2F0IHB1bHNlID0gMC44ICsgMC4yICogc2luKHVUaW1lICogMi4wICsgdlV2LnggKiAxMC4wKTsKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KHVDb2xvciAqIHB1bHNlLCBhbHBoYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgdHJpYmFsR2VvID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTUsIF9jb25maWcuYXJlbmFSYWRpdXMgKiAwLjk1LCAxMiwgNjQsIDEsIHRydWUpOwogICAgICAgIGNvbnN0IHRyaWJhbE1lc2ggPSBuZXcgVEhSRUUuTWVzaCh0cmliYWxHZW8sIHRyaWJhbE1hdCk7CiAgICAgICAgdHJpYmFsTWVzaC5yb3RhdGlvbi54ID0gMDsgLy8gVXByaWdodCBjeWxpbmRlciBtYXRjaGVzIHNwaGVyZSBlcXVhdG9yCiAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5hZGQodHJpYmFsTWVzaCk7CgogICAgICAgIC8vIC0tLSA0LiBIT09LRUQgQVJST1dTIChBYm92ZS9CZWxvdyBTdHJpcCkgLS0tCiAgICAgICAgY29uc3QgYXJyb3dUZXggPSAoKCkgPT4gewogICAgICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgICAgIGMud2lkdGggPSA1MTI7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLDAsNTEyLDY0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKICAgICAgICAgICAgY3R4LnNoYWRvd0JsdXIgPSA1OwogICAgICAgICAgICBjdHguc2hhZG93Q29sb3IgPSAnI2ZmZmZmZic7CgogICAgICAgICAgICBjb25zdCBzdGVwID0gNjQ7CiAgICAgICAgICAgIGZvcihsZXQgeD0wOyB4PDUxMjsgeCs9c3RlcCkgewogICAgICAgICAgICAgICAgLy8gRG91YmxlIEhvb2sgQXJyb3cKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgIC8vIFRvcCBIb29rCiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHgrMjAsIDEwKTsgY3R4LmxpbmVUbyh4KzMyLCAyMCk7IGN0eC5saW5lVG8oeCs0NCwgMTApOwogICAgICAgICAgICAgICAgLy8gU2hhZnQKICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oeCszMiwgMjApOyBjdHgubGluZVRvKHgrMzIsIDQ0KTsKICAgICAgICAgICAgICAgIC8vIEJvdHRvbSBIb29rCiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHgrMjAsIDU0KTsgY3R4LmxpbmVUbyh4KzMyLCA0NCk7IGN0eC5saW5lVG8oeCs0NCwgNTQpOwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICB9KSgpOwogICAgICAgIGFycm93VGV4LndyYXBTID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgYXJyb3dUZXgucmVwZWF0LnNldCg0LCAxKTsKCiAgICAgICAgY29uc3QgYXJyb3dNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGFycm93VGV4LAogICAgICAgICAgICBjb2xvcjogMHgwMGZmZmYsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjYsCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwoKICAgICAgICAvLyBUb3AgUmluZwogICAgICAgIGNvbnN0IGFycm93R2VvVG9wID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTIsIF9jb25maWcuYXJlbmFSYWRpdXMgKiAwLjkyLCA4LCA2NCwgMSwgdHJ1ZSk7CiAgICAgICAgY29uc3QgYXJyb3dNZXNoVG9wID0gbmV3IFRIUkVFLk1lc2goYXJyb3dHZW9Ub3AsIGFycm93TWF0KTsKICAgICAgICBhcnJvd01lc2hUb3AucG9zaXRpb24ueSA9IDEyOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAuYWRkKGFycm93TWVzaFRvcCk7CgogICAgICAgIC8vIEJvdHRvbSBSaW5nCiAgICAgICAgY29uc3QgYXJyb3dNZXNoQm90ID0gbmV3IFRIUkVFLk1lc2goYXJyb3dHZW9Ub3AsIGFycm93TWF0KTsKICAgICAgICBhcnJvd01lc2hCb3QucG9zaXRpb24ueSA9IC0xMjsKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYUdyb3VwLmFkZChhcnJvd01lc2hCb3QpOwoKICAgICAgICAvLyAtLS0gNS4gVE9QIEdMWVBIUyAoRG9tZSkgLS0tCiAgICAgICAgY29uc3QgdG9wR2x5cGhUZXggPSAoKCkgPT4gewogICAgICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgICAgIGMud2lkdGggPSA1MTI7IGMuaGVpZ2h0ID0gNTEyOwogICAgICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgIGN0eC5jbGVhclJlY3QoMCwwLDUxMiw1MTIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMTAwLCAyMDAsIDI1NSwgMC41KSc7CiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoMjU2LCAyNTYsIDIwMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW50cmljYXRlIHBhdHRlcm4KICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ODsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhID0gKGkvOCkqTWF0aC5QSSoyOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IDI1NiArIE1hdGguY29zKGEpKjE1MDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAyNTYgKyBNYXRoLnNpbihhKSoxNTA7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIDQwLCAwLCBNYXRoLlBJKjIpOwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgLy8gQ29ubmVjdG9yCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKDI1NiwgMjU2KTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCwgeSk7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIH0pKCk7CgogICAgICAgIGNvbnN0IHRvcEdseXBoTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiB0b3BHbHlwaFRleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuNCwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHRvcEdseXBoR2VvID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoNjAsIDYwKTsKICAgICAgICBjb25zdCB0b3BHbHlwaCA9IG5ldyBUSFJFRS5NZXNoKHRvcEdseXBoR2VvLCB0b3BHbHlwaE1hdCk7CiAgICAgICAgdG9wR2x5cGgucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICB0b3BHbHlwaC5wb3NpdGlvbi55ID0gMzU7IC8vIE5lYXIgdG9wIG9mIGRvbWUKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYUdyb3VwLmFkZCh0b3BHbHlwaCk7CgogICAgICAgIC8vIC0tLSBORVc6IEZGWCBHT0FMIE1PREVMUyAtLS0KICAgICAgICBjb25zdCBnb2FsVXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hNTE2YmQ5MGZhN2M0ZGVkYjVkY2JmZGY4MDNmMTNkNS5nbGInOwogICAgICAgIAogICAgICAgIGNvbnN0IG9uR29hbExvYWRlZCA9IChtb2RlbCwgaXNGYWxsYmFjaykgPT4gewogICAgICAgICAgICBjb25zdCBnb2FsQSA9IG1vZGVsOwogICAgICAgICAgICAvLyBNb3ZlZCBkb3duIH4xNWZ0ICg0LjVtKSB0b3RhbCBhcyByZXF1ZXN0ZWQsIHB1c2hlZCBiYWNrIHRvIGVkZ2UKICAgICAgICAgICAgZ29hbEEucG9zaXRpb24uc2V0KDAsIC00LjUsIC00Nik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWlzRmFsbGJhY2spIHsKICAgICAgICAgICAgICAgIGdvYWxBLnNjYWxlLnNldFNjYWxhcig1NC4wKTsgLy8gSW5jcmVhc2VkIDUwJSAod2FzIDM2LjApCiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU2V0dXAgR29hbCBBCiAgICAgICAgICAgIGdvYWxBLnRyYXZlcnNlKGMgPT4gewogICAgICAgICAgICAgICAgaWYoYy5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICBjLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsgLy8gQ1JJVElDQUw6IFByZXZlbnQgY3VsbGluZwogICAgICAgICAgICAgICAgICAgIGMucmVuZGVyT3JkZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBtYXRlcmlhbCBpcyB2aXNpYmxlCiAgICAgICAgICAgICAgICAgICAgaWYgKGMubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZmZmZmYpOyAvLyBXaGl0ZSB0byBzaG93IG9yaWdpbmFsIHRleHR1cmUvY29sb3JzICh3YXMgYmx1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC50cmFuc3BhcmVudCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuc2lkZSA9IFRIUkVFLkRvdWJsZVNpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhUZXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyBBZGQgZ29hbHMgdG8gU0NFTkUsIG5vdCBhcmVuYUdyb3VwICh0aGV5IHNob3VsZG4ndCByb3RhdGUgd2l0aCB0aGUgc3BoZXJlKQogICAgICAgICAgICBfc2NlbmUuYWRkKGdvYWxBKTsKCiAgICAgICAgICAgIC8vIFNldHVwIEdvYWwgQgogICAgICAgICAgICBjb25zdCBnb2FsQiA9IGlzRmFsbGJhY2sgPyBnb2FsQS5jbG9uZSgpIDogVEhSRUUuU2tlbGV0b25VdGlscy5jbG9uZShnb2FsQSk7CgogICAgICAgICAgICBnb2FsQi5wb3NpdGlvbi5zZXQoMCwgLTQuNSwgNDYpOyAvLyBNb3ZlZCBjbG9zZXIgKHdhcyA0NSkgYW5kIGRvd24KICAgICAgICAgICAgZ29hbEIucm90YXRpb24ueSA9IE1hdGguUEk7CiAgICAgICAgICAgIC8vIEVuc3VyZSBHb2FsIEIgbWVzaGVzIGFyZSBhbHNvIHBlcnNpc3RlbnQKICAgICAgICAgICAgZ29hbEIudHJhdmVyc2UoYyA9PiB7CiAgICAgICAgICAgICAgICBpZihjLmlzTWVzaCkgYy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgX3NjZW5lLmFkZChnb2FsQik7CiAgICAgICAgfTsKCiAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKGdvYWxVcmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgIG9uR29hbExvYWRlZChnbHRmLnNjZW5lLCBmYWxzZSk7CiAgICAgICAgfSwgdW5kZWZpbmVkLCAoZXJyKSA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiR29hbCBtb2RlbCBmYWlsZWQgdG8gbG9hZC4gVXNpbmcgZmFsbGJhY2suIiwgZXJyKTsKICAgICAgICAgICAgY29uc3QgZ2VvID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KDc1LCA0NSwgMTApOyAvLyBGYWxsYmFjayBtYXNzaXZlIGJveCAoU2NhbGVkIDEuNXgpCiAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZmZmLCB3aXJlZnJhbWU6IHRydWUgfSk7CiAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrID0gbmV3IFRIUkVFLk1lc2goZ2VvLCBmYWxsYmFja01hdCk7CiAgICAgICAgICAgIG9uR29hbExvYWRlZChmYWxsYmFjaywgdHJ1ZSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIC0tLSBORVc6IE1BU1NJVkUgRklFTEQgTUFSS0lOR1MgLS0tCiAgICAgICAgY3JlYXRlRmllbGRNYXJraW5ncygpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlRmllbGRNYXJraW5ncygpIHsKICAgICAgICBjb25zdCBzaXplID0gMTAyNDsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IHNpemU7IGMuaGVpZ2h0ID0gc2l6ZTsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgY3ggPSBzaXplLzI7IGNvbnN0IGN5ID0gc2l6ZS8yOwoKICAgICAgICBjb25zdCBkcmF3ID0gKCkgPT4gewogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIHNpemUsIHNpemUpOwoKICAgICAgICAgICAgLy8gR2xvdyBTZXR0aW5ncwogICAgICAgICAgICBjdHguc2hhZG93Qmx1ciA9IDE1OwogICAgICAgICAgICBjdHguc2hhZG93Q29sb3IgPSAnIzAwZmZmZic7CiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDEwMCwgMjU1LCAyNTUsIDAuOSknOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICAgICAgY3R4LmxpbmVDYXAgPSAncm91bmQnOwoKICAgICAgICAgICAgLy8gMS4gT3V0ZXIgUnVuaWMgUmluZwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoY3gsIGN5LCA0ODAsIDAsIE1hdGguUEkqMik7CiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKCiAgICAgICAgICAgIC8vIDIuIENvbXBsZXggR2VvbWV0cmljIFN0YXIgKFRoZSAiQ29vbCBCaWcgR2x5cGgiKQogICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICBjdHgudHJhbnNsYXRlKGN4LCBjeSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMYXllciBBOiAzIE92ZXJsYXBwaW5nIFNxdWFyZXMgKDEyIHBvaW50cykKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwgMjAwLCAyNTUsIDAuNiknOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMjsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzsgaSsrKSB7CiAgICAgICAgICAgICAgICBjdHgucm90YXRlKE1hdGguUEkgLyA2KTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2VSZWN0KC0zNTAsIC0zNTAsIDcwMCwgNzAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTGF5ZXIgQjogSW5uZXIgQ2lyY2xlcwogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgxMDAsIDI1NSwgMjU1LCAwLjgpJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDU7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYygwLCAwLCAzMjAsIDAsIE1hdGguUEkqMik7IGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDAsIDAsIDEwMCwgMCwgTWF0aC5QSSoyKTsgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgLy8gTGF5ZXIgQzogQ2VudHJhbCBFbWJsZW0gKEJsaXR6YmFsbC1pc2gpCiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbygwLCAtODApOyBjdHgubGluZVRvKDYwLCA0MCk7IGN0eC5saW5lVG8oLTYwLCA0MCk7IGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oMCwgODApOyBjdHgubGluZVRvKC02MCwgLTQwKTsgY3R4LmxpbmVUbyg2MCwgLTQwKTsgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICBjdHgucmVzdG9yZSgpOwoKICAgICAgICAgICAgLy8gMy4gTWlkZmllbGQgTGluZQogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjUpJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDM7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbygwLCBjeSk7IGN0eC5saW5lVG8oc2l6ZSwgY3kpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyA0LiBHb2FsIEJveGVzIChUcmFwZXpvaWRzKQogICAgICAgICAgICBjb25zdCBkcmF3R29hbEJveCA9ICh5UG9zLCBkaXIpID0+IHsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3ggLSAxNTAsIHlQb3MpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIDE1MCwgeVBvcyk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgMjI1LCB5UG9zICsgKGRpciAqIDEyMCkpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCAtIDIyNSwgeVBvcyArIChkaXIgKiAxMjApKTsKICAgICAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgZHJhd0dvYWxCb3goNTAsIDEpOyAvLyBUb3AKICAgICAgICAgICAgZHJhd0dvYWxCb3goc2l6ZS01MCwgLTEpOyAvLyBCb3R0b20KCiAgICAgICAgICAgIC8vIDUuIFJ1bmVzIFRleHQgUmluZwogICAgICAgICAgICBjdHguZm9udCA9ICczNnB4IFNwaXJhLCBtb25vc3BhY2UnOyAKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICdyZ2JhKDAsIDI1NSwgMjU1LCAwLjgpJzsKICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBydW5lcyA9ICJZRVZPTiBTSU4gWkFOQVJLQU5EIEVURVJOQUwgQ0FMTSBTUEhFUkUgUE9PTCBCTElUWiBBQ0UgIjsKICAgICAgICAgICAgY29uc3QgcnVuZUNvdW50ID0gNDA7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHJ1bmVDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gcnVuZUNvdW50KSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgY29uc3QgciA9IDQ0MDsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBjeCArIE1hdGguY29zKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gY3kgKyBNYXRoLnNpbihhbmdsZSkgKiByOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICAgICAgY3R4LnRyYW5zbGF0ZSh4LCB5KTsKICAgICAgICAgICAgICAgIGN0eC5yb3RhdGUoYW5nbGUgKyBNYXRoLlBJLzIpOwogICAgICAgICAgICAgICAgY29uc3QgY2hhciA9IHJ1bmVzW2kgJSBydW5lcy5sZW5ndGhdOwogICAgICAgICAgICAgICAgY3R4LmZpbGxUZXh0KGNoYXIsIDAsIDApOwogICAgICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8vIEF0dGVtcHQgdG8gbG9hZCBmb250IGZpcnN0CiAgICAgICAgZG9jdW1lbnQuZm9udHMubG9hZCgnMzZweCBTcGlyYScpLnRoZW4oKCkgPT4gewogICAgICAgICAgICBkcmF3KCk7CiAgICAgICAgfSkuY2F0Y2goKCkgPT4gewogICAgICAgICAgICBkcmF3KCk7CiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHRleC5hbmlzb3Ryb3B5ID0gMTY7CgogICAgICAgIC8vIEZsb29yIFBsYW5lIChEZWVwKQogICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDkwLCA5MCk7CiAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiB0ZXgsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjksCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZwogICAgICAgIH0pOwoKICAgICAgICBjb25zdCBmaWVsZCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgbWF0KTsKICAgICAgICBmaWVsZC5yb3RhdGlvbi54ID0gLU1hdGguUEkgLyAyOwogICAgICAgIGZpZWxkLnBvc2l0aW9uLnkgPSAtOC4wOyAvLyBTdW5rIGRlZXAKICAgICAgICBfc2NlbmUuYWRkKGZpZWxkKTsKICAgIH0KCmZ1bmN0aW9uIGNyZWF0ZUhvbG9ncmFwaGljUmluZ3MoKSB7CiAgICAgICAgLy8gRmxvYXRpbmcgSG9sb2dyYXBoaWMgUmluZ3MgKE1pZC1oZWlnaHQpCiAgICAgICAgY29uc3QgcmluZ0dlbyA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KDIwLCAwLjEsIDE2LCAxMDApOwogICAgICAgIGNvbnN0IHJpbmdNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgwMGZmZmYsIHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjMsIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nIH0pOwogICAgICAgIGNvbnN0IHJpbmcxID0gbmV3IFRIUkVFLk1lc2gocmluZ0dlbywgcmluZ01hdCk7CiAgICAgICAgcmluZzEucm90YXRpb24ueCA9IE1hdGguUEkgLyAyOwogICAgICAgIHJpbmcxLnBvc2l0aW9uLnkgPSAwOwogICAgICAgIF9zY2VuZS5hZGQocmluZzEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHJpbmcyID0gbmV3IFRIUkVFLk1lc2gocmluZ0dlbywgcmluZ01hdCk7CiAgICAgICAgcmluZzIucm90YXRpb24ueCA9IE1hdGguUEkgLyAyOwogICAgICAgIHJpbmcyLnNjYWxlLnNldFNjYWxhcigxLjIpOwogICAgICAgIHJpbmcyLnBvc2l0aW9uLnkgPSA0LjA7CiAgICAgICAgX3NjZW5lLmFkZChyaW5nMik7CgogICAgICAgIC8vIEFuaW1hdGUgUmluZ3MgKGludGVncmF0ZWQgaW50byBtYWluIGxvb3AgdG8gYXZvaWQgYSBzZWNvbmQgUkFGIG9uIG1vYmlsZSkKICAgICAgICBsZXQgX3JpbmdUaW1lID0gMDsKICAgICAgICBjb25zdCBfcmluZ1VwZGF0ZSA9IChkdCkgPT4gewogICAgICAgICAgICBfcmluZ1RpbWUgKz0gZHQ7CiAgICAgICAgICAgIGlmIChyaW5nMSkgewogICAgICAgICAgICAgICAgcmluZzEucm90YXRpb24ueiArPSBkdCAqIDAuOTsKICAgICAgICAgICAgICAgIHJpbmcxLnNjYWxlLnNldFNjYWxhcigxLjAgKyBNYXRoLnNpbihfcmluZ1RpbWUgKiAwLjUpICogMC4wNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJpbmcyKSB7CiAgICAgICAgICAgICAgICByaW5nMi5yb3RhdGlvbi56IC09IGR0ICogMC43NTsKICAgICAgICAgICAgICAgIHJpbmcyLnBvc2l0aW9uLnkgPSA0LjAgKyBNYXRoLmNvcyhfcmluZ1RpbWUgKiAwLjcpICogMS4wOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycykgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycy5wdXNoKF9yaW5nVXBkYXRlKTsKICAgIH0KCiAgICAvLyAtLS0gSU5QVVQgU1lTVEVNIC0tLQovLyAtLS0gSU5QVVQgU1lTVEVNIC0tLQpjb25zdCBfa2V5cyA9IHt9OwovLyBHbG9iYWxzIG1vdmVkIHRvIGJlbG93IGhlbHBlcgoKICAgIC8vIEhlbHBlcjogQW5hbHl6ZSBjdXJ2ZSBnZW9tZXRyeSBmb3IgYW5hbG9nIGNvbnRyb2wKICAgIGNvbnN0IGFuYWx5emVTd2lwZUN1cnZlID0gKHBvaW50cykgPT4gewogICAgICAgIGlmIChwb2ludHMubGVuZ3RoIDwgMykgcmV0dXJuIHsgaW50ZW5zaXR5OiAwLCBzcGVlZDogMCwgZHg6IDAsIGR5OiAwIH07CiAgICAgICAgCiAgICAgICAgY29uc3QgcFN0YXJ0ID0gcG9pbnRzWzBdOwogICAgICAgIGNvbnN0IHBFbmQgPSBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDFdOwogICAgICAgIGNvbnN0IG1pZElkeCA9IE1hdGguZmxvb3IocG9pbnRzLmxlbmd0aCAvIDIpOwogICAgICAgIGNvbnN0IHBNaWQgPSBwb2ludHNbbWlkSWR4XTsKCiAgICAgICAgY29uc3QgZHggPSBwRW5kLnggLSBwU3RhcnQueDsKICAgICAgICBjb25zdCBkeSA9IHBFbmQueSAtIHBTdGFydC55OwogICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CiAgICAgICAgY29uc3QgZHQgPSBwRW5kLnQgLSBwU3RhcnQudDsKICAgICAgICBjb25zdCBzcGVlZCA9IChkdCA+IDApID8gZGlzdCAvIGR0IDogMDsgLy8gcHgvbXMKCiAgICAgICAgaWYgKGRpc3QgPCA1MCkgcmV0dXJuIHsgaW50ZW5zaXR5OiAwLCBzcGVlZDogc3BlZWQsIGR4LCBkeSB9OwoKICAgICAgICBjb25zdCB2U01feCA9IHBNaWQueCAtIHBTdGFydC54OwogICAgICAgIGNvbnN0IHZTTV95ID0gcE1pZC55IC0gcFN0YXJ0Lnk7CgogICAgICAgIC8vIENyb3NzIHByb2R1Y3QgZ2l2ZXMgc2lnbmVkIGFyZWEvY3VydmF0dXJlIGRpcmVjdGlvbgogICAgICAgIGNvbnN0IGNyb3NzID0gKGR4ICogdlNNX3kpIC0gKGR5ICogdlNNX3gpOwogICAgICAgIC8vIE5vcm1hbGl6ZSBieSBkaXN0YW5jZSBzcXVhcmVkIHRvIGdldCBhIGN1cnZhdHVyZSByYXRpbyBpbmRlcGVuZGVudCBvZiBzY2FsZQpjb25zdCBpbnRlbnNpdHkgPSBjcm9zcyAvIChkaXN0ICogZGlzdCk7CgogICAgICAgIHJldHVybiB7IGludGVuc2l0eSwgc3BlZWQsIGR4LCBkeSB9OwogICAgfTsKICAgIGxldCBfc3dpcGVQb2ludHMgPSBbXTsgLy8gVHJhY2sgc3dpcGUgaGlzdG9yeSBmb3IgY3VydmVzCiAgICBjb25zdCBfYWltSW5wdXQgPSB7IHg6IDAsIHk6IDAsIGFjdGl2ZTogZmFsc2UgfTsgLy8gTkVXOiBBaW0gam95c3RpY2sKCiAgICBjb25zdCBfYWN0aW9uQnVmZmVyID0geyBhY3RpdmU6IGZhbHNlLCB0aW1lc3RhbXA6IDAsIGR1cmF0aW9uOiAzMDAgfTsKCiAgICBjb25zdCBfY2FtRndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1SaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdXBBeGlzID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CgogICAgZnVuY3Rpb24gc2V0dXBJbnB1dHMoKSB7CiAgICAgICAgLy8gS2V5Ym9hcmQKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgIF9rZXlzW2Uua2V5XSA9IHRydWU7CiAgICAgICAgICAgIGlmIChlLmNvZGUgPT09ICdTcGFjZScgJiYgX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIgJiYgX2JhbGwpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIudGhyb3dCYWxsKF9iYWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBORVc6IFRhY2tsZSBvbiBTaGlmdAogICAgICAgICAgICBpZiAoZS5jb2RlID09PSAnU2hpZnRMZWZ0JyB8fCBlLmNvZGUgPT09ICdTaGlmdFJpZ2h0JykgewogICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5kYXNoKHAuaW5wdXRWZWN0b3IueCwgcC5pbnB1dFZlY3Rvci56KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9KTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5dXAnLCAoZSkgPT4geyBfa2V5c1tlLmtleV0gPSBmYWxzZTsgdXBkYXRlSW5wdXRWZWN0b3IoKTsgfSk7CgogICAgICAgIC8vIC0tLSBGTE9BVElORyBKT1lTVElDSyAoTW92ZW1lbnQpIC0tLQogICAgICAgIGNvbnN0IGhpdFpvbmUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2staGl0LXpvbmUnKTsKICAgICAgICBjb25zdCB2aXN1YWxzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2pveXN0aWNrLXZpc3VhbC1jb250YWluZXInKTsKICAgICAgICBjb25zdCBiYXNlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2pveXN0aWNrLWJhc2UnKTsKICAgICAgICBjb25zdCBrbm9iID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2pveXN0aWNrLWtub2InKTsKCiAgICAgICAgbGV0IHN0YXJ0WCA9IDAsIHN0YXJ0WSA9IDA7CiAgICAgICAgbGV0IGRyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgY29uc3QgbWF4RGlzdCA9IDQwOwoKICAgICAgICBsZXQgbW92ZVRvdWNoSWQgPSBudWxsOwogICAgICAgIGNvbnN0IG1vdmVEZWFkem9uZVB4ID0gNjsKCiAgICAgICAgLy8gRXhwb3NlIG1vdmUgam95c3RpY2sgc3RhdGUgZm9yIHNuYXBzaG90cwogICAgICAgIGNvbnN0IF9kYmcgPSB3aW5kb3cuZmx1eC5fZGVidWdJTyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIHx8IHt9OwogICAgICAgIF9kYmcuc2V0dGluZ3MgPSBfc2V0dGluZ3M7CiAgICAgICAgX2RiZy5pbnB1dCA9IF9kYmcuaW5wdXQgfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5tb3ZlID0gX2RiZy5pbnB1dC5tb3ZlIHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQubW92ZS52ZWN0b3IgPSBfaW5wdXQ7CiAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLmRyYWdnaW5nID0gZHJhZ2dpbmc7CiAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnRvdWNoSWQgPSBtb3ZlVG91Y2hJZDsKCgogICAgICAgIGNvbnN0IGhhbmRsZVN0YXJ0ID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgZHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICBzdGFydFggPSBjbGllbnRYOwoKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0Lm1vdmUpIHsKICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS5kcmFnZ2luZyA9IGRyYWdnaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzdGFydFkgPSBjbGllbnRZOwoKICAgICAgICAgICAgdmlzdWFscy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgdmlzdWFscy5zdHlsZS5sZWZ0ID0gYCR7Y2xpZW50WH1weGA7CiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUudG9wID0gYCR7Y2xpZW50WX1weGA7CgogICAgICAgICAgICBrbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoLTUwJSwgLTUwJSlgOwoKICAgICAgICAgICAgY3JlYXRlUmlwcGxlKGNsaWVudFgsIGNsaWVudFkpOwoKICAgICAgICAgICAgX2lucHV0LnggPSAwOwogICAgICAgICAgICBfaW5wdXQueSA9IDA7CiAgICAgICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgaGFuZGxlTW92ZSA9IChjbGllbnRYLCBjbGllbnRZKSA9PiB7CiAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKCiAgICAgICAgICAgIGxldCBkeCA9IGNsaWVudFggLSBzdGFydFg7CiAgICAgICAgICAgIGxldCBkeSA9IGNsaWVudFkgLSBzdGFydFk7CgogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwoKCiAgICAgICAgICAgIC8vIERlYWR6b25lIHRvIHByZXZlbnQgZHJpZnQgZnJvbSB0aW55IHRodW1iIGppdHRlcgogICAgICAgICAgICBpZiAoZGlzdCA8IG1vdmVEZWFkem9uZVB4KSB7CiAgICAgICAgICAgICAgICBkeCA9IDA7CiAgICAgICAgICAgICAgICBkeSA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkaXN0ID4gbWF4RGlzdCkgewogICAgICAgICAgICAgICAgZHggPSAoZHggLyBkaXN0KSAqIG1heERpc3Q7CiAgICAgICAgICAgICAgICBkeSA9IChkeSAvIGRpc3QpICogbWF4RGlzdDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAga25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKGNhbGMoLTUwJSArICR7ZHh9cHgpLCBjYWxjKC01MCUgKyAke2R5fXB4KSlgOwoKICAgICAgICAgICAgX2lucHV0LnggPSAoZHggLyBtYXhEaXN0KSAqIF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5OwogICAgICAgICAgICBfaW5wdXQueSA9IChkeSAvIG1heERpc3QpICogX3NldHRpbmdzLmpveXN0aWNrU2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgaGFuZGxlRW5kID0gKCkgPT4gewogICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgIGRyYWdnaW5nID0gZmFsc2U7CgogICAgICAgICAgICBtb3ZlVG91Y2hJZCA9IG51bGw7CgogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CgogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQubW92ZSkgewogICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLmRyYWdnaW5nID0gZHJhZ2dpbmc7CiAgICAgICAgICAgICAgICBfZGJnLmlucHV0Lm1vdmUudG91Y2hJZCA9IG1vdmVUb3VjaElkOwogICAgICAgICAgICB9CgoKICAgICAgICAgICAgX2lucHV0LnggPSAwOwogICAgICAgICAgICBfaW5wdXQueSA9IDA7CiAgICAgICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CiAgICAgICAgfTsKCiAgICAgICAgaWYgKGhpdFpvbmUpIHsKICAgICAgICAgICAgaGl0Wm9uZS5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzWzBdKSA/IGUuY2hhbmdlZFRvdWNoZXNbMF0gOiBlLnRvdWNoZXNbMF07CiAgICAgICAgICAgICAgICBtb3ZlVG91Y2hJZCA9IHQgPyB0LmlkZW50aWZpZXIgOiBudWxsOwogICAgICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0Lm1vdmUpIHsKICAgICAgICAgICAgICAgICAgICBfZGJnLmlucHV0Lm1vdmUudG91Y2hJZCA9IG1vdmVUb3VjaElkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaGFuZGxlU3RhcnQodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBtb3ZlVG91Y2hJZCk7CiAgICAgICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgICAgIGhhbmRsZU1vdmUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgbW92ZVRvdWNoSWQpOwogICAgICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47IC8vIElnbm9yZSBvdGhlciBmaW5nZXJzIGxpZnRpbmcKICAgICAgICAgICAgICAgIGhhbmRsZUVuZCgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgbW92ZVRvdWNoSWQpOwogICAgICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47CiAgICAgICAgICAgICAgICBoYW5kbGVFbmQoKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBoaXRab25lLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBoYW5kbGVTdGFydChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChkcmFnZ2luZykgaGFuZGxlTW92ZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGhhbmRsZUVuZCk7CiAgICAgICAgfQoKICAgICAgICAvLyAtLS0gTkVXOiBBSU0gSk9ZU1RJQ0sgKFJpZ2h0IHNpZGUpIC0tLQogICAgICAgIHNldHVwQWltSm95c3RpY2soKTsKCiAgICAgICAgLy8gLS0tIE5FVzogVEFDS0xFIEJVVFRPTiAtLS0KICAgICAgICBzZXR1cFRhY2tsZUJ1dHRvbigpOwoKICAgICAgICAvLyBTd2lwZSBEZXRlY3Rpb24KLy8gU3dpcGUgRGV0ZWN0aW9uCiAgICAgICAgbGV0IHN3aXBlU3RhcnQgPSB7IHg6IDAsIHk6IDAsIHQ6IDAgfTsKICAgICAgICBsZXQgc3dpcGVUb3VjaElkID0gbnVsbDsKICAgICAgICAKICAgICAgICAvLyBFeHBvc2Ugc3dpcGUvdGhyb3cgZ2VzdHVyZSBzdGF0ZSBmb3Igc25hcHNob3RzCiAgICAgICAgX2RiZy5pbnB1dC5zd2lwZSA9IF9kYmcuaW5wdXQuc3dpcGUgfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5zd2lwZS5zdGFydCA9IHN3aXBlU3RhcnQ7CiAgICAgICAgX2RiZy5pbnB1dC5zd2lwZS50b3VjaElkID0gc3dpcGVUb3VjaElkOwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUucG9pbnRzID0gX3N3aXBlUG9pbnRzOwpjb25zdCBvblN3aXBlU3RhcnQgPSAoeCwgeSkgPT4gewogICAgICAgICAgICBzd2lwZVN0YXJ0LnggPSB4OwogICAgICAgICAgICBzd2lwZVN0YXJ0LnkgPSB5OwogICAgICAgICAgICBzd2lwZVN0YXJ0LnQgPSBEYXRlLm5vdygpOwogICAgICAgICAgICBfc3dpcGVQb2ludHMgPSBbe3gsIHksIHQ6IERhdGUubm93KCl9XTsKICAgICAgICB9OwoKY29uc3Qgb25Td2lwZU1vdmUgPSAoeCwgeSkgPT4gewogICAgICAgICAgICBpZiAoX3N3aXBlUG9pbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIF9zd2lwZVBvaW50cy5wdXNoKHt4LCB5LCB0OiBEYXRlLm5vdygpfSk7CiAgICAgICAgICAgICAgICBjcmVhdGVTd2lwZVRyYWlsRG90KHgsIHkpOyAvLyBWaXN1YWwgRmVlZGJhY2sKICAgICAgICAgICAgfQogICAgICAgIH07Cgpjb25zdCBvblN3aXBlRW5kID0gKHgsIHkpID0+IHsKICAgICAgICAgICAgaWYgKF9zd2lwZVBvaW50cy5sZW5ndGggPCAyKSByZXR1cm47CiAgICAgICAgICAgIF9zd2lwZVBvaW50cy5wdXNoKHt4LCB5LCB0OiBEYXRlLm5vdygpfSk7CgogICAgICAgICAgICBjb25zdCB7IGludGVuc2l0eSwgc3BlZWQsIGR4LCBkeSB9ID0gYW5hbHl6ZVN3aXBlQ3VydmUoX3N3aXBlUG9pbnRzKTsKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllciAmJiBfY2FtZXJhKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgICAgICAvLyAtLS0gQ1VSVkUgQkFMTCBERVRFQ1RJT04gKEltbWVkaWF0ZSBUaHJvdykgLS0tCi8vIC0tLSBDVVJWRSBCQUxMIERFVEVDVElPTiAoSW1tZWRpYXRlIFRocm93KSAtLS0KICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgJiYgIXAuaXNUaHJvd2luZyAmJiAhcC5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQW5hbG9nIEN1cnZlIENoZWNrOiBUaHJlc2hvbGQgMC4yNSByZXF1aXJlcyBhIGRlbGliZXJhdGUgYXJjIChUaGUgIkZlYXQiKQogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhpbnRlbnNpdHkpID4gMC4yNSAmJiBkaXN0ID4gMTAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7IF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFggPSAoX2NhbVJpZ2h0LnggKiBkeCkgKyAoX2NhbUZ3ZC54ICogLWR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRaID0gKF9jYW1SaWdodC56ICogZHgpICsgKF9jYW1Gd2QueiAqIC1keSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRocm93RGlyID0gbmV3IFRIUkVFLlZlY3RvcjMod29ybGRYLCAwLCB3b3JsZFopLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTWFwIGludGVuc2l0eSB0byBzcGluIC0gRHJhc3RpY2FsbHkgcmVkdWNlZCBzZW5zaXRpdml0eQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByYXdTcGluID0gTWF0aC5hYnMoaW50ZW5zaXR5KSAqIDMwMC4wOyAKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BlZWRGYWN0b3IgPSBNYXRoLm1pbigxLjUsIHNwZWVkIC8gMS4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblBvd2VyID0gTWF0aC5taW4oNDAwLjAsIHJhd1NwaW4gKiBzcGVlZEZhY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5TaWduID0gTWF0aC5zaWduKGludGVuc2l0eSk7IAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3BpblBvd2VyICogc3BpblNpZ24sIDApOwoKCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0T3ZlcnJpZGVBaW0odGhyb3dEaXIueCwgdGhyb3dEaXIueik7CiAgICAgICAgICAgICAgICAgICAgICAgIHAudGhyb3dCYWxsKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsLCAnU0gnLCAxLjAsIHNwaW5WZWMpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNVUlZFIiwgcC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZVJpcHBsZSh4LCB5KTsKICAgICAgICAgICAgICAgICAgICAgICAgX3N3aXBlUG9pbnRzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIC0tLSBTVEFOREFSRCBEQVNIIC8gQUlNIC0tLQogICAgICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgICAgIGVsc2UgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwoKY29uc3Qgd29ybGRYMiA9IChfY2FtUmlnaHQueCAqIGR4KSArIChfY2FtRndkLnggKiAtZHkpOwogICAgICAgICAgICAgICAgY29uc3Qgd29ybGRaMiA9IChfY2FtUmlnaHQueiAqIGR4KSArIChfY2FtRndkLnogKiAtZHkpOwoKICAgICAgICAgICAgICAgIGlmIChwLmlzVGhyb3dpbmcpIHsKcC5zZXRPdmVycmlkZUFpbSh3b3JsZFgyLCB3b3JsZFoyKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJBSU0hIiwgcC5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CmlmIChkaXN0ID4gNTApIHAuZGFzaCh3b3JsZFgyLCB3b3JsZFoyKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjcmVhdGVSaXBwbGUoeCwgeSk7CiAgICAgICAgICAgIH0KX3N3aXBlUG9pbnRzID0gW107CiAgICAgICAgfTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCB0ID0gKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlc1swXSkgPyBlLmNoYW5nZWRUb3VjaGVzWzBdIDogZS50b3VjaGVzWzBdOwogICAgICAgICAgICBzd2lwZVRvdWNoSWQgPSB0ID8gdC5pZGVudGlmaWVyIDogbnVsbDsKLy8gb25Td2lwZVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsgLy8gRml4ZWQgc3ludGF4IGVycm9yCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5zd2lwZSkgeyBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7IH0KICAgICAgICAgICAgb25Td2lwZVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICAgICAgY3JlYXRlUmlwcGxlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdCA9IF9maW5kVG91Y2hCeUlkKGUudG91Y2hlcywgc3dpcGVUb3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgIG9uU3dpcGVNb3ZlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgc3dpcGVUb3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47IC8vIElnbm9yZSBvdGhlciBmaW5nZXJzIGxpZnRpbmcKICAgICAgICAgICAgb25Td2lwZUVuZCh0RW5kLmNsaWVudFgsIHRFbmQuY2xpZW50WSk7CiAgICAgICAgICAgIHN3aXBlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5zd2lwZSkgeyBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7IH0KICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCAoZSkgPT4gewppZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgc3dpcGVUb3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47IC8vIElnbm9yZSBvdGhlciBmaW5nZXJzIGxpZnRpbmcKICAgICAgICAgICAgb25Td2lwZUVuZCh0RW5kLmNsaWVudFgsIHRFbmQuY2xpZW50WSk7CiAgICAgICAgICAgIHN3aXBlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5zd2lwZSkgeyBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7IH0KICAgICAgICAKICAgICAgICB9KTsKLy8gTW91c2UgU3dpcGUKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwoKICAgICAgICAgICAgb25Td2lwZVN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgY3JlYXRlUmlwcGxlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpKSByZXR1cm47CiAgICAgICAgICAgIC8vIE9ubHkgdHJhY2sgaWYgbW91c2UgaXMgZG93biAoc2ltdWxhdGluZyBkcmFnKQogICAgICAgICAgICBpZiAoZS5idXR0b25zID09PSAxKSB7CiAgICAgICAgICAgICAgICBvblN3aXBlTW92ZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwogICAgICAgICAgICBvblN3aXBlRW5kKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gQWN0aW9uIEJ1dHRvbiAoU2hvb3QvUGFzcykKICAgICAgICBjb25zdCBhY3Rpb25CdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWJ1dHRvbicpOwoKY29uc3Qgc2V0dXBCdXR0b24gPSAoYnRuKSA9PiB7CiAgICAgICAgICAgIGlmICghYnRuKSByZXR1cm47CgogICAgICAgICAgICBsZXQgYnRuU3RhcnRYID0gMDsKICAgICAgICAgICAgbGV0IGJ0blN0YXJ0WSA9IDA7CiAgICAgICAgICAgIGxldCBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIGxldCBzd2lwZVBvaW50cyA9IFtdOwogICAgICAgICAgICBsZXQgYWN0aW9uVG91Y2hJZCA9IG51bGw7CgogICAgICAgICAgICBjb25zdCBhdHRlbXB0QWN0aW9uID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgJiYgIXAuaXNDaGFyZ2luZyAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcC5zdGFydENoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGNvbnN0IGhhbmRsZVN0YXJ0ID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci50ZWNoQ29weVN0YXRlLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci5hdHRlbXB0VGVjaENvcHkoKTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyksIDEwMCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmlzRGVtb01vZGUpIHJldHVybjsKCiAgICAgICAgICAgICAgICBsZXQgY2xpZW50WCA9IGUuY2xpZW50WDsKICAgICAgICAgICAgICAgIGxldCBjbGllbnRZID0gZS5jbGllbnRZOwogICAgICAgICAgICAgICAgaWYgKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gZS5jaGFuZ2VkVG91Y2hlc1swXTsKICAgICAgICAgICAgICAgICAgICBhY3Rpb25Ub3VjaElkID0gdC5pZGVudGlmaWVyOwogICAgICAgICAgICAgICAgICAgIGNsaWVudFggPSB0LmNsaWVudFg7CiAgICAgICAgICAgICAgICAgICAgY2xpZW50WSA9IHQuY2xpZW50WTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aW9uVG91Y2hJZCA9IG51bGw7IC8vIG1vdXNlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBidG5TdGFydFggPSBjbGllbnRYOwogICAgICAgICAgICAgICAgYnRuU3RhcnRZID0gY2xpZW50WTsKICAgICAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgc3dpcGVQb2ludHMgPSBbe3g6IGNsaWVudFgsIHk6IGNsaWVudFksIHQ6IERhdGUubm93KCl9XTsKCiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLnRpbWVzdGFtcCA9IERhdGUubm93KCk7CgogICAgICAgICAgICAgICAgaWYgKGF0dGVtcHRBY3Rpb24oKSkgewogICAgICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQXR0YWNoIGdsb2JhbCBsaXN0ZW5lcnMgdG8gdHJhY2sgc3dpcGUgb3V0c2lkZSBidXR0b24KICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBoYW5kbGVNb3ZlLCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlTW92ZSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBoYW5kbGVNb3ZlID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghaXNEcmFnZ2luZykgcmV0dXJuOwoKICAgICAgICAgICAgICAgIC8vIFRvdWNoIHBhdGggKG11bHRpLXRvdWNoIHNhZmUpCiAgICAgICAgICAgICAgICBpZiAoZS50b3VjaGVzICYmIGFjdGlvblRvdWNoSWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBhY3Rpb25Ub3VjaElkKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBzd2lwZVBvaW50cy5wdXNoKHt4OiB0LmNsaWVudFgsIHk6IHQuY2xpZW50WSwgdDogRGF0ZS5ub3coKX0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNb3VzZSBwYXRoCiAgICAgICAgICAgICAgICBjb25zdCBjbGllbnRYID0gZS5jbGllbnRYOwogICAgICAgICAgICAgICAgY29uc3QgY2xpZW50WSA9IGUuY2xpZW50WTsKICAgICAgICAgICAgICAgIHN3aXBlUG9pbnRzLnB1c2goe3g6IGNsaWVudFgsIHk6IGNsaWVudFksIHQ6IERhdGUubm93KCl9KTsKICAgICAgICAgICAgfTsKCmNvbnN0IGhhbmRsZUVuZCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgZHggPSAwOwogICAgICAgICAgICAgICAgbGV0IGR5ID0gMDsKICAgICAgICAgICAgICAgIGxldCB2YWxpZEVuZCA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIC8vIDEuIENoZWNrIFRvdWNoCiAgICAgICAgICAgICAgICBpZiAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBhY3Rpb25Ub3VjaElkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBhY3Rpb25Ub3VjaElkKTsKICAgICAgICAgICAgICAgICAgICBpZiAodEVuZCkgewogICAgICAgICAgICAgICAgICAgICAgICBkeCA9IHRFbmQuY2xpZW50WCAtIGJ0blN0YXJ0WDsKICAgICAgICAgICAgICAgICAgICAgICAgZHkgPSB0RW5kLmNsaWVudFkgLSBidG5TdGFydFk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkRW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIC8vIDIuIENoZWNrIE1vdXNlCiAgICAgICAgICAgICAgICBlbHNlIGlmICghZS5jaGFuZ2VkVG91Y2hlcyAmJiBpc0RyYWdnaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgZHggPSBlLmNsaWVudFggLSBidG5TdGFydFg7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBlLmNsaWVudFkgLSBidG5TdGFydFk7CiAgICAgICAgICAgICAgICAgICAgdmFsaWRFbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghdmFsaWRFbmQpIHJldHVybjsKCiAgICAgICAgICAgICAgICAvLyBDbGVhbnVwIGxpc3RlbmVycwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGhhbmRsZU1vdmUpOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlTW92ZSk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGhhbmRsZUVuZCk7CgogICAgICAgICAgICAgICAgaWYgKCFpc0RyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHdhc0J1ZmZlcmVkID0gX2FjdGlvbkJ1ZmZlci5hY3RpdmU7CiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEN1cnZlIEFuYWx5c2lzCiAgICAgICAgICAgICAgICAgICAgbGV0IGN1cnZlRGF0YSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgbGV0IHNwaW5WZWMgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgY3VydmUgaWYgd2UgaGF2ZSBlbm91Z2ggZGF0YQovLyBDYWxjdWxhdGUgY3VydmUgaWYgd2UgaGF2ZSBlbm91Z2ggZGF0YQogICAgICAgICAgICAgICAgICAgIGlmIChzd2lwZVBvaW50cy5sZW5ndGggPiAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuYWx5c2lzID0gYW5hbHl6ZVN3aXBlQ3VydmUoc3dpcGVQb2ludHMpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBIaWdoIHRocmVzaG9sZCBmb3IgYnV0dG9uIHJlbGVhc2UgdG9vCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhhbmFseXNpcy5pbnRlbnNpdHkpID4gMC4yNSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VydmVEYXRhID0gYW5hbHlzaXM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBzcGluIHZlY3RvciBmb3IgbW91c2UvdG91Y2ggdW5pZmllZCAoQ29uc2VydmF0aXZlIHZhbHVlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5Qb3dlciA9IE1hdGgubWluKDQwMC4wLCBNYXRoLmFicyhhbmFseXNpcy5pbnRlbnNpdHkpICogMTUwMC4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5TaWduID0gTWF0aC5zaWduKGFuYWx5c2lzLmludGVuc2l0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3BpblBvd2VyICogc3BpblNpZ24sIDApOwogICAgICAgICAgICAgICAgICAgICAgICB9Cn0KCiAgICAgICAgICAgICAgICAgICAgLy8gRVhFQ1VURQogICAgICAgICAgICAgICAgICAgIGlmIChwLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTm9ybWFsIFJlbGVhc2UKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNwaW5WZWMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFVuaWZpZWQgc3BpbiBwYXNzaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnJlbGVhc2VDaGFyZ2UoZHgsIGR5LCB7IGludGVuc2l0eTogY3VydmVEYXRhLmludGVuc2l0eSwgc3BlZWQ6IGN1cnZlRGF0YS5zcGVlZCB9KTsgCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnJlbGVhc2VDaGFyZ2UoZHgsIGR5LCBjdXJ2ZURhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHdhc0J1ZmZlcmVkICYmIHAuaGFzQmFsbCAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJ1ZmZlcmVkIFRhcCAoSW5zdGFudCBTaG90KQogICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3JjZSBzdGFydCBhbmQgcmVsZWFzZSBpbW1lZGlhdGVseQogICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXJ0Q2hhcmdlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucmVsZWFzZUNoYXJnZShkeCwgZHksIGN1cnZlRGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGhhbmRsZVN0YXJ0LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgaGFuZGxlU3RhcnQpOwogICAgICAgIH07CiAgICAgICAgc2V0dXBCdXR0b24oYWN0aW9uQnRuKTsKCi8vIEF1dG8gVG9nZ2xlCiAgICAgICAgY29uc3QgYXV0b0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhdXRvLXRvZ2dsZScpOwogICAgICAgIGlmIChhdXRvQnRuKSB7CiAgICAgICAgICAgIGNvbnN0IGhhbmRsZVRvZ2dsZSA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIudG9nZ2xlRGVtb01vZGUoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBhdXRvQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgaGFuZGxlVG9nZ2xlKTsKYXV0b0J0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIGhhbmRsZVRvZ2dsZSgpOwogICAgICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBTZXR0aW5ncyBCdXR0b24KICAgICAgICBzZXR1cFNldHRpbmdzQnV0dG9uKCk7CiAgICB9CgogICAgLy8gTkVXOiBBaW0gSm95c3RpY2sgU2V0dXAKLy8gTkVXOiBBaW0gSm95c3RpY2sgU2V0dXAKZnVuY3Rpb24gc2V0dXBBaW1Kb3lzdGljaygpIHsKICAgICAgICBjb25zdCBhaW1Lbm9iID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1qb3lzdGljay1rbm9iJyk7CiAgICAgICAgY29uc3QgYWltVmlzdWFscyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaW0tam95c3RpY2stdmlzdWFsJyk7CiAgICAgICAgY29uc3QgYWltWm9uZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaW0tam95c3RpY2stem9uZScpOwogICAgICAgIGlmICghYWltWm9uZSkgcmV0dXJuOwogICAgICAgIGxldCBhaW1TdGFydFggPSAwLCBhaW1TdGFydFkgPSAwOwogICAgICAgIGxldCBhaW1EcmFnZ2luZyA9IGZhbHNlOwogICAgICAgIGNvbnN0IGFpbU1heERpc3QgPSAzNTsKICAgICAgICBsZXQgYWltVG91Y2hJZCA9IG51bGw7CgogICAgICAgIAoKICAgICAgICAvLyBFeHBvc2UgYWltIGpveXN0aWNrIHN0YXRlIGZvciBzbmFwc2hvdHMKICAgICAgICBjb25zdCBfZGJnID0gd2luZG93LmZsdXguX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyB8fCB7fTsKICAgICAgICBfZGJnLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgICAgIF9kYmcuaW5wdXQgPSBfZGJnLmlucHV0IHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQuYWltID0gX2RiZy5pbnB1dC5haW0gfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5haW0udmVjdG9yID0gX2FpbUlucHV0OwogICAgICAgIF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7CiAgICAgICAgX2RiZy5pbnB1dC5haW0udG91Y2hJZCA9IGFpbVRvdWNoSWQ7CmNvbnN0IGhhbmRsZUFpbVN0YXJ0ID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgYWltRHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICBhaW1TdGFydFggPSBjbGllbnRYOwoKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS5kcmFnZ2luZyA9IGFpbURyYWdnaW5nOyB9CgogICAgICAgICAgICBhaW1TdGFydFkgPSBjbGllbnRZOwogICAgICAgICAgICBfYWltSW5wdXQuYWN0aXZlID0gdHJ1ZTsKCiAgICAgICAgICAgIGlmIChhaW1WaXN1YWxzKSB7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgYWltVmlzdWFscy5zdHlsZS5sZWZ0ID0gYCR7Y2xpZW50WH1weGA7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLnRvcCA9IGAke2NsaWVudFl9cHhgOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhaW1Lbm9iKSB7CiAgICAgICAgICAgICAgICBhaW1Lbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoLTUwJSwgLTUwJSlgOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgaGFuZGxlQWltTW92ZSA9IChjbGllbnRYLCBjbGllbnRZKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKCiAgICAgICAgICAgIGxldCBkeCA9IGNsaWVudFggLSBhaW1TdGFydFg7CiAgICAgICAgICAgIGxldCBkeSA9IGNsaWVudFkgLSBhaW1TdGFydFk7CgogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwoKICAgICAgICAgICAgaWYgKGRpc3QgPiBhaW1NYXhEaXN0KSB7CiAgICAgICAgICAgICAgICBkeCA9IChkeCAvIGRpc3QpICogYWltTWF4RGlzdDsKICAgICAgICAgICAgICAgIGR5ID0gKGR5IC8gZGlzdCkgKiBhaW1NYXhEaXN0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYWltS25vYikgewogICAgICAgICAgICAgICAgYWltS25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKGNhbGMoLTUwJSArICR7ZHh9cHgpLCBjYWxjKC01MCUgKyAke2R5fXB4KSlgOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBOb3JtYWxpemUgYW5kIHRyYW5zZm9ybSB0byB3b3JsZCBzcGFjZQogICAgICAgICAgICBfYWltSW5wdXQueCA9IGR4IC8gYWltTWF4RGlzdDsKICAgICAgICAgICAgX2FpbUlucHV0LnkgPSBkeSAvIGFpbU1heERpc3Q7CgogICAgICAgICAgICAvLyBBcHBseSBhaW0gdG8gcGxheWVyIGlmIGNoYXJnaW5nCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICAgICBpZiAocC5pc0NoYXJnaW5nIHx8IHAuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgICAgIC8vIFRyYW5zZm9ybSBzY3JlZW4gYWltIHRvIHdvcmxkIHNwYWNlCiAgICAgICAgICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgICAgICAgICBfY2FtRndkLnkgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFggPSAoX2NhbVJpZ2h0LnggKiBfYWltSW5wdXQueCkgKyAoX2NhbUZ3ZC54ICogLV9haW1JbnB1dC55KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoX2NhbVJpZ2h0LnogKiBfYWltSW5wdXQueCkgKyAoX2NhbUZ3ZC56ICogLV9haW1JbnB1dC55KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHdvcmxkWCkgPiAwLjEgfHwgTWF0aC5hYnMod29ybGRaKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBwLnNldE92ZXJyaWRlQWltKHdvcmxkWCwgd29ybGRaKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKY29uc3QgaGFuZGxlQWltRW5kID0gKCkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgIGFpbURyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIF9haW1JbnB1dC5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgX2FpbUlucHV0LnggPSAwOwogICAgICAgICAgICBfYWltSW5wdXQueSA9IDA7CgogICAgICAgICAgICBpZiAoYWltVmlzdWFscykgewogICAgICAgICAgICAgICAgYWltVmlzdWFscy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDbGVhciBwbGF5ZXIgYWltIG92ZXJyaWRlCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5vdmVycmlkZUFpbVZlY3RvciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBhaW1ab25lLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGNvbnN0IHQgPSAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzWzBdKSA/IGUuY2hhbmdlZFRvdWNoZXNbMF0gOiBlLnRvdWNoZXNbMF07CiAgICAgICAgICAgIGFpbVRvdWNoSWQgPSB0ID8gdC5pZGVudGlmaWVyIDogbnVsbDsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsgfQogICAgICAgICAgICBoYW5kbGVBaW1TdGFydCh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBhaW1Ub3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgIGhhbmRsZUFpbU1vdmUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBhaW1Ub3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47CiAgICAgICAgICAgIGFpbVRvdWNoSWQgPSBudWxsOwogICAgICAgICAgICBoYW5kbGVBaW1FbmQoKTsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsgfQogICAgICAgICAgICBoYW5kbGVBaW1FbmQoKTsKICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgYWltVG91Y2hJZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBhaW1Ub3VjaElkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlQWltRW5kKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5haW0pIHsgX2RiZy5pbnB1dC5haW0udG91Y2hJZCA9IGFpbVRvdWNoSWQ7IF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7IH0KICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlQWltRW5kKCk7CiAgICAgICAgfSk7Ci8vIE1vdXNlIHN1cHBvcnQgZm9yIGRlc2t0b3AgdGVzdGluZwogICAgICAgIGFpbVpvbmUuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgaGFuZGxlQWltU3RhcnQoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgIH0pOwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoYWltRHJhZ2dpbmcpIGhhbmRsZUFpbU1vdmUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgIH0pOwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGFpbURyYWdnaW5nKSBoYW5kbGVBaW1FbmQoKTsKICAgICAgICB9KTsKICAgIH0KCiAgICAvLyBORVc6IFRhY2tsZSBCdXR0b24gU2V0dXAKICAgIGZ1bmN0aW9uIHNldHVwVGFja2xlQnV0dG9uKCkgewogICAgICAgIGNvbnN0IHRhY2tsZUJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0YWNrbGUtYnV0dG9uJyk7CiAgICAgICAgaWYgKCF0YWNrbGVCdG4pIHJldHVybjsKCmNvbnN0IGhhbmRsZVRhY2tsZSA9IChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsgLy8gUHJldmVudCBidWJibGluZyB0byBqb3lzdGljawoKICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaXNEZW1vTW9kZSkgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgICAgICAvLyBWaXN1YWwgRmVlZGJhY2sgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGFja2xlQnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpLCAxNTApOwoKICAgICAgICAgICAgICAgIC8vIElmIHdlIGRvbid0IGhhdmUgdGhlIGJhbGwsIGRhc2gvdGFja2xlCiAgICAgICAgICAgICAgICBpZiAoIXAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgIC8vIEdldCBjdXJyZW50IG1vdmVtZW50IGRpcmVjdGlvbiBvciBmb3J3YXJkCiAgICAgICAgICAgICAgICAgICAgbGV0IGRhc2hYID0gcC5pbnB1dFZlY3Rvci54OwogICAgICAgICAgICAgICAgICAgIGxldCBkYXNoWiA9IHAuaW5wdXRWZWN0b3IuejsKCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgbm90IG1vdmluZywgZGFzaCBmb3J3YXJkIHJlbGF0aXZlIHRvIHBsYXllciBmYWNpbmcKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGFzaFgpIDwgMC4xICYmIE1hdGguYWJzKGRhc2haKSA8IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24ocC5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgICAgICAgICBkYXNoWCA9IGZ3ZC54OwogICAgICAgICAgICAgICAgICAgICAgICBkYXNoWiA9IGZ3ZC56OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcC5kYXNoKGRhc2hYLCBkYXNoWik7CgogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgc2hvdyB0ZXh0IGlmIGRhc2ggYWN0dWFsbHkgaGFwcGVuZWQgKGNvb2xkb3duIGNoZWNrIGluc2lkZSBkYXNoKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlRBQ0tMRSEiLCBwLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQnJlYWsgdGFja2xlIGlmIGVuZ2FnZWQKICAgICAgICAgICAgICAgICAgICBwLmRhc2gocC5pbnB1dFZlY3Rvci54LCBwLmlucHV0VmVjdG9yLnopOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdGFja2xlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBoYW5kbGVUYWNrbGUsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgdGFja2xlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIGhhbmRsZVRhY2tsZSk7CiAgICB9CgogICAgLy8gTkVXOiBTZXR0aW5ncyBCdXR0b24gU2V0dXAKLy8gTkVXOiBTZXR0aW5ncyBCdXR0b24gU2V0dXAKZnVuY3Rpb24gc2V0dXBTZXR0aW5nc0J1dHRvbigpIHsKICAgICAgICBjb25zdCBzZXR0aW5nc0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXR0aW5ncy1idXR0b24nKTsKICAgICAgICBjb25zdCBzZXR0aW5nc1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NldHRpbmdzLXBhbmVsJyk7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NDbG9zZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXR0aW5ncy1jbG9zZScpOwoKICAgICAgICBpZiAoIXNldHRpbmdzQnRuIHx8ICFzZXR0aW5nc1BhbmVsKSByZXR1cm47CgogICAgICAgIHNldHRpbmdzQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPSBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJyA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgfSk7CgogICAgICAgIGlmIChzZXR0aW5nc0Nsb3NlKSB7CiAgICAgICAgICAgIHNldHRpbmdzQ2xvc2UuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gU2Vuc2l0aXZpdHkgc2xpZGVyCiAgICAgICAgY29uc3Qgc2Vuc2l0aXZpdHlTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2Vuc2l0aXZpdHktc2xpZGVyJyk7CiAgICAgICAgaWYgKHNlbnNpdGl2aXR5U2xpZGVyKSB7CiAgICAgICAgICAgIHNlbnNpdGl2aXR5U2xpZGVyLnZhbHVlID0gX3NldHRpbmdzLmpveXN0aWNrU2Vuc2l0aXZpdHkgKiAxMDA7CiAgICAgICAgICAgIHNlbnNpdGl2aXR5U2xpZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgKGUpID0+IHsKICAgICAgICAgICAgICAgIF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5ID0gZS50YXJnZXQudmFsdWUgLyAxMDA7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gQWltIGFzc2lzdCB0b2dnbGUKICAgICAgICBjb25zdCBhaW1Bc3Npc3RUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWltLWFzc2lzdC10b2dnbGUnKTsKICAgICAgICBpZiAoYWltQXNzaXN0VG9nZ2xlKSB7CiAgICAgICAgICAgIGFpbUFzc2lzdFRvZ2dsZS5jaGVja2VkID0gX3NldHRpbmdzLmFpbUFzc2lzdDsKICAgICAgICAgICAgYWltQXNzaXN0VG9nZ2xlLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBfc2V0dGluZ3MuYWltQXNzaXN0ID0gZS50YXJnZXQuY2hlY2tlZDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBDYW1lcmEgc2hha2UgdG9nZ2xlCiAgICAgICAgY29uc3Qgc2hha2VUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2hha2UtdG9nZ2xlJyk7CiAgICAgICAgaWYgKHNoYWtlVG9nZ2xlKSB7CiAgICAgICAgICAgIHNoYWtlVG9nZ2xlLmNoZWNrZWQgPSBfc2V0dGluZ3MuY2FtZXJhU2hha2U7CiAgICAgICAgICAgIHNoYWtlVG9nZ2xlLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBfc2V0dGluZ3MuY2FtZXJhU2hha2UgPSBlLnRhcmdldC5jaGVja2VkOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIFZvbHVtZSBzbGlkZXIKICAgICAgICBjb25zdCB2b2x1bWVTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndm9sdW1lLXNsaWRlcicpOwogICAgICAgIGlmICh2b2x1bWVTbGlkZXIgJiYgX2F1ZGlvTWFuYWdlcikgewogICAgICAgICAgICB2b2x1bWVTbGlkZXIuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgY29uc3Qgdm9sID0gZS50YXJnZXQudmFsdWUgLyAxMDA7CiAgICAgICAgICAgICAgICBfYXVkaW9NYW5hZ2VyLnNldFZvbHVtZSh2b2wpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIEV4aXQgdG8gTWVudQogICAgICAgIGNvbnN0IGV4aXRCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXhpdC10by1tZW51LWJ0bicpOwogICAgICAgIGlmIChleGl0QnRuKSB7CiAgICAgICAgICAgIGV4aXRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoX21lbnVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgX21lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RvcCBwcmFjdGljZSBpZiBydW5uaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIucHJhY3RpY2VNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIucHJhY3RpY2VNYW5hZ2VyLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiB1cGRhdGVJbnB1dFZlY3RvcigpIHsKICAgICAgICBsZXQgeCA9IF9pbnB1dC54IHx8IDA7CiAgICAgICAgbGV0IHogPSBfaW5wdXQueSB8fCAwOwoKICAgICAgICBpZiAoX2tleXNbJ3cnXSB8fCBfa2V5c1snQXJyb3dVcCddKSB6IC09IDE7CiAgICAgICAgaWYgKF9rZXlzWydzJ10gfHwgX2tleXNbJ0Fycm93RG93biddKSB6ICs9IDE7CiAgICAgICAgaWYgKF9rZXlzWydhJ10gfHwgX2tleXNbJ0Fycm93TGVmdCddKSB4IC09IDE7CiAgICAgICAgaWYgKF9rZXlzWydkJ10gfHwgX2tleXNbJ0Fycm93UmlnaHQnXSkgeCArPSAxOwoKICAgICAgICBjb25zdCBsZW5TcSA9IHgqeCArIHoqejsKICAgICAgICBpZiAobGVuU3EgPiAxKSB7CiAgICAgICAgICAgIGNvbnN0IGxlbiA9IE1hdGguc3FydChsZW5TcSk7CiAgICAgICAgICAgIHggLz0gbGVuOwogICAgICAgICAgICB6IC89IGxlbjsKICAgICAgICB9CgogICAgICAgIGlmIChpc05hTih4KSkgeCA9IDA7CiAgICAgICAgaWYgKGlzTmFOKHopKSB6ID0gMDsKCiAgICAgICAgaWYgKF9jYW1lcmEpIHsKICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKCiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhfY2FtRndkLCBfdXBBeGlzKS5ub3JtYWxpemUoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBfY2FtRndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgIF9jYW1SaWdodC5zZXQoMSwgMCwgMCk7CiAgICAgICAgfQoKICAgICAgICBsZXQgd29ybGRYID0gKF9jYW1Gd2QueCAqIC16KSArIChfY2FtUmlnaHQueCAqIHgpOwogICAgICAgIGxldCB3b3JsZFogPSAoX2NhbUZ3ZC56ICogLXopICsgKF9jYW1SaWdodC56ICogeCk7CgogICAgICAgIGlmIChpc05hTih3b3JsZFgpIHx8IGlzTmFOKHdvcmxkWikpIHsKICAgICAgICAgICAgd29ybGRYID0gMDsKICAgICAgICAgICAgd29ybGRaID0gMDsKICAgICAgICB9CgppZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgLy8gRklYOiBPbmx5IGFsbG93IG1vdmVtZW50IGlmIGdhbWUgaXMgYWN0aXZlIG9yIGluIHByYWN0aWNlCiAgICAgICAgICAgIGNvbnN0IGdtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBjYW5Nb3ZlID0gZ20gJiYgIWdtLmlzRGVtb01vZGUgJiYgKGdtLnN0YXRlID09PSAnYWN0aXZlJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoY2FuTW92ZSkgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5zZXRJbnB1dCh3b3JsZFgsIHdvcmxkWik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLnNldElucHV0KDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgfQp9CgogICAgZnVuY3Rpb24gY3JlYXRlUmlwcGxlKHgsIHkpIHsKICAgICAgICBjb25zdCByaXBwbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICByaXBwbGUuY2xhc3NOYW1lID0gJ3RvdWNoLXJpcHBsZSc7CiAgICAgICAgcmlwcGxlLnN0eWxlLmxlZnQgPSBgJHt4fXB4YDsKICAgICAgICByaXBwbGUuc3R5bGUudG9wID0gYCR7eX1weGA7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJykuYXBwZW5kQ2hpbGQocmlwcGxlKTsKCiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGlmIChyaXBwbGUucGFyZW50Tm9kZSkgcmlwcGxlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQocmlwcGxlKTsKICAgICAgICB9LCA2MDApOwoKICAgIH0KCiAgICAvLyBORVc6IFZpc3VhbCBTd2lwZSBUcmFpbAogICAgZnVuY3Rpb24gY3JlYXRlU3dpcGVUcmFpbERvdCh4LCB5KSB7CiAgICAgICAgY29uc3QgZG90ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgZG90LmNsYXNzTmFtZSA9ICdzd2lwZS10cmFpbC1kb3QnOwogICAgICAgIGRvdC5zdHlsZS5sZWZ0ID0gYCR7eCAtIDZ9cHhgOyAvLyBDZW50ZXIgKDEycHggd2lkdGgpCiAgICAgICAgZG90LnN0eWxlLnRvcCA9IGAke3kgLSA2fXB4YDsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKS5hcHBlbmRDaGlsZChkb3QpOwogICAgICAgIAogICAgICAgIC8vIENTUyBhbmltYXRpb24gaGFuZGxlcyByZW1vdmFsLCBidXQgd2UgY2xlYW4gdXAgRE9NIHRvIGJlIHNhZmUKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgaWYgKGRvdC5wYXJlbnROb2RlKSBkb3QucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChkb3QpOwogICAgICAgIH0sIDUwMCk7CiAgICB9CgogICAgZnVuY3Rpb24gb25SZXNpemUoKSB7CiAgICAgICAgY29uc3Qgd2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICBjb25zdCBoZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgCiAgICAgICAgaWYgKF9jYW1lcmEpIHsKICAgICAgICAgICAgX2NhbWVyYS5hc3BlY3QgPSB3aWR0aCAvIGhlaWdodDsKICAgICAgICAgICAgX2NhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFN0cmljdGx5IDAuNTAgYXMgcmVxdWVzdGVkCiAgICAgICAgY29uc3QgcmVzU2NhbGUgPSAwLjUwOwogICAgICAgIAogICAgICAgIF9jb25maWcuaW50ZXJuYWxXaWR0aCA9IE1hdGguZmxvb3Iod2lkdGggKiByZXNTY2FsZSk7CiAgICAgICAgX2NvbmZpZy5pbnRlcm5hbEhlaWdodCA9IE1hdGguZmxvb3IoaGVpZ2h0ICogcmVzU2NhbGUpOwoKICAgICAgICBpZiAoX3JlbmRlcmVyKSB7CiAgICAgICAgICAgIF9yZW5kZXJlci5zZXRTaXplKF9jb25maWcuaW50ZXJuYWxXaWR0aCwgX2NvbmZpZy5pbnRlcm5hbEhlaWdodCwgZmFsc2UpOwogICAgICAgIH0KICAgIH0KCmZ1bmN0aW9uIGFuaW1hdGUoKSB7CiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwoKICAgICAgICBjb25zdCByYXdEdCA9IF9jbG9jay5nZXREZWx0YSgpOwogICAgICAgIC8vIENsYW1wIGR0IHRvIHByZXZlbnQgc3BpcmFscyBvZiBkZWF0aCAobWF4IDAuMXMpCiAgICAgICAgY29uc3QgZHQgPSBNYXRoLm1pbihyYXdEdCwgMC4xKSAqICh3aW5kb3cuZmx1eC50aW1lU2NhbGUgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA6IDAuOCk7CgogICAgICAgIAoKICAgICAgICAvLyBQZXJmIHN0YXRzIGZvciBEZXZUb29scyBzbmFwc2hvdHMKICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX2RlYnVnSU8gJiYgd2luZG93LmZsdXguX2RlYnVnSU8ucGVyZikgewogICAgICAgICAgICBjb25zdCBwZXJmID0gd2luZG93LmZsdXguX2RlYnVnSU8ucGVyZjsKICAgICAgICAgICAgcGVyZi5mcmFtZSA9IChwZXJmLmZyYW1lIHx8IDApICsgMTsKICAgICAgICAgICAgcGVyZi5yYXdEdCA9IHJhd0R0OwogICAgICAgICAgICBwZXJmLmR0ID0gZHQ7CiAgICAgICAgICAgIGNvbnN0IGZwcyA9IGR0ID4gMCA/ICgxIC8gZHQpIDogMDsKICAgICAgICAgICAgcGVyZi5mcHMgPSBmcHM7CiAgICAgICAgICAgIHBlcmYuYXZnRnBzID0gKHBlcmYuYXZnRnBzICYmIHBlcmYuYXZnRnBzID4gMCkgPyAocGVyZi5hdmdGcHMgKiAwLjkgKyBmcHMgKiAwLjEpIDogZnBzOwogICAgICAgIH0KLy8gSW1wYWN0IEZyYW1lcwogICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmltcGFjdFBhdXNlID4gMCkgewogICAgICAgICAgICBfZ2FtZU1hbmFnZXIuaW1wYWN0UGF1c2UgLT0gZHQ7CiAgICAgICAgICAgIGlmIChfcmVuZGVyZXIgJiYgX3NjZW5lICYmIF9jYW1lcmEpIHsKICAgICAgICAgICAgICAgIF9yZW5kZXJlci5yZW5kZXIoX3NjZW5lLCBfY2FtZXJhKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwoKICAgICAgICAvLyBBY3Rpb24gQnVmZmVyIFByb2Nlc3NpbmcKICAgICAgICBpZiAoX2FjdGlvbkJ1ZmZlci5hY3RpdmUpIHsKICAgICAgICAgICAgaWYgKERhdGUubm93KCkgLSBfYWN0aW9uQnVmZmVyLnRpbWVzdGFtcCA+IF9hY3Rpb25CdWZmZXIuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCAmJiAhcC5pc0NoYXJnaW5nICYmICFwLmlzVGhyb3dpbmcgJiYgcC5zdGF0dXMubmFwIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGFydENoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWJ1dHRvbicpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYnRuKSBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBNZW51IFN0YXRlIEhhbmRsaW5nCiAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuc3RhdGUgPT09ICdtZW51JyAmJiBfY2FtZXJhKSB7CiAgICAgICAgICAgIGNvbnN0IHRpbWUgPSBEYXRlLm5vdygpICogMC4wMDA1OwogICAgICAgICAgICBjb25zdCByYWRpdXMgPSA1MDsKICAgICAgICAgICAgX2NhbWVyYS5wb3NpdGlvbi54ID0gTWF0aC5zaW4odGltZSkgKiByYWRpdXM7CiAgICAgICAgICAgIF9jYW1lcmEucG9zaXRpb24ueiA9IE1hdGguY29zKHRpbWUpICogcmFkaXVzOwogICAgICAgICAgICBfY2FtZXJhLnBvc2l0aW9uLnkgPSAyMDsKICAgICAgICAgICAgX2NhbWVyYS5sb29rQXQoMCwgMCwgMCk7CgogICAgICAgICAgICBpZiAoX3JlbmRlcmVyICYmIF9zY2VuZSkgewogICAgICAgICAgICAgICAgX3JlbmRlcmVyLnJlbmRlcihfc2NlbmUsIF9jYW1lcmEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgovLyBTdGFibGUgc3ViLXN0ZXBwaW5nIChwcmV2ZW50cyBkdCBzcGlrZXMgZnJvbSBtYWtpbmcgcGh5c2ljcy9jYW1lcmEgZmVlbCBmbG9hdHkgb24gbW9iaWxlKQogICAgICAgIGNvbnN0IF9tYXhTdGVwID0gMSAvIDYwOwogICAgICAgIGNvbnN0IF9zdGVwcyA9IE1hdGgubWluKDQsIE1hdGgubWF4KDEsIE1hdGguY2VpbChkdCAvIF9tYXhTdGVwKSkpOwogICAgICAgIGNvbnN0IF9zdGVwRHQgPSBkdCAvIF9zdGVwczsKCiAgICAgICAgZm9yIChsZXQgX3NpID0gMDsgX3NpIDwgX3N0ZXBzOyBfc2krKykgewogICAgICAgICAgICBjb25zdCBfc2R0ID0gX3N0ZXBEdDsKCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIF9nYW1lTWFuYWdlci51cGRhdGUoX3NkdCk7CgogICAgICAgICAgICAvLyBJZiBpbiBBc3NldCBGb3JnZSBtb2RlLCBza2lwIGdhbWUgbG9naWMgYW5kIHN0YW5kYXJkIHJlbmRlcmluZwogICAgICAgICAgICAvLyBEZXZUb29scyBoYW5kbGVzIHRoZSByZW5kZXJpbmcgaW4gaXRzIGhvb2tlZCB1cGRhdGUgZnVuY3Rpb24KICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaXNGb3JnZU1vZGUpIHsKICAgICAgICAgICAgICAgIC8vIEZvcmdlIG1vZGUgaGFuZGxlcyBpdHMgb3duIHJlbmRlcmluZyBsb29wIGluIERldlRvb2xzIGhvb2sKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIEVudGl0aWVzCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0pIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS51cGRhdGUoX3NkdCk7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gY2hlY2tCYWxsR3JhYihwKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChfYXdheVRlYW0pIHsKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS51cGRhdGUoX3NkdCk7CiAgICAgICAgICAgICAgICBfYXdheVRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gY2hlY2tCYWxsR3JhYihwKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChfYmFsbCkgewogICAgICAgICAgICAgICAgX2JhbGwudXBkYXRlKF9zZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCYWxsIExhYiBydW50aW1lICh0cmFqZWN0b3J5IHByZXZpZXcgLyByZWNvcmQtcmVwbGF5KQogICAgICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguYmFsbExhYiAmJiB0eXBlb2Ygd2luZG93LmZsdXguYmFsbExhYi51cGRhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmJhbGxMYWIudXBkYXRlKF9zZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgQ2FtZXJhCiAgICAgICAgICAgIHVwZGF0ZUNhbWVyYUxvZ2ljKF9zZHQpOwoKICAgICAgICAgICAgLy8gVXBkYXRlIFZpc3VhbHMKICAgICAgICAgICAgaWYgKF93YXRlck92ZXJsYXkpIF93YXRlck92ZXJsYXkudXBkYXRlKF9zZHQpOwogICAgICAgICAgICBpZiAoX2xpZ2h0U2hhZnRzKSBfbGlnaHRTaGFmdHMudXBkYXRlKF9zZHQpOwoKLy8gUnVudGltZSB1cGRhdGVycyAoRlgsIGFyZW5hIHJpbmdzLCBldGMuKQogICAgICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyAmJiB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgZm9yIChsZXQgdWkgPSAwOyB1aSA8IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMubGVuZ3RoOyB1aSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm4gPSB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzW3VpXTsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAnZnVuY3Rpb24nKSBmbihfc2R0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIEdseXBoIE1hbmFnZXIgKENyaXRpY2FsIGZvciB2aXN1YWwgY2xlYW51cCkKICAgICAgICAgICAgaWYgKF9nbHlwaE1hbmFnZXIpIF9nbHlwaE1hbmFnZXIudXBkYXRlKF9zZHQpOwoKLy8gVXBkYXRlIEdsb2JhbCBVbmlmb3JtcwogICAgICAgICAgICBpZiAoX2FyZW5hVW5pZm9ybXMpIHsKICAgICAgICAgICAgICAgIF9hcmVuYVVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IF9zZHQ7CiAgICAgICAgICAgICAgICBfYXJlbmFVbmlmb3Jtcy51SW1wYWN0U3RyLnZhbHVlICo9IE1hdGgubWF4KDAsIDEuMCAtIF9zZHQgKiA0LjApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAtLS0gTkVXOiBBcmVuYSBSb3RhdGlvbiAmIENvbG9yIFNoaWZ0IC0tLQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFHcm91cCkgewogICAgICAgICAgICAgICAgLy8gUm90YXRlIHNwaGVyZSBzbG93bHkgdG8gc2hvdyB3YXRlciBtb3ZlbWVudAogICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5yb3RhdGlvbi55ICs9IF9zZHQgKiAwLjA1OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXgudHJpYmFsVW5pZm9ybXMpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnRyaWJhbFVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IF9zZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFBvc3Nlc3Npb24gQ29sb3IgTG9naWMKICAgICAgICAgICAgICAgIGxldCB0YXJnZXRDb2xvciA9IG5ldyBUSFJFRS5Db2xvcigweDAwZmZmZik7IC8vIERlZmF1bHQgQ3lhbiAoSG9tZS9OZXV0cmFsKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoX2JhbGwgJiYgX2JhbGwuaG9sZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9iYWxsLmhvbGRlci50ZWFtICYmIF9iYWxsLmhvbGRlci50ZWFtLnNpZGUgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldENvbG9yLnNldEhleCgweGZmODgwMCk7IC8vIE9yYW5nZSAoQXdheSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNtb290aCBMZXJwCiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3Jtcy51Q29sb3IudmFsdWUubGVycCh0YXJnZXRDb2xvciwgX3NkdCAqIDIuMCk7CiAgICAgICAgICAgIH0KCmlmIChfcGFydGljbGVVbmlmb3JtcykgewogICAgICAgICAgICAgICAgX3BhcnRpY2xlVW5pZm9ybXMudVRpbWUudmFsdWUgKz0gX3NkdDsKICAgICAgICAgICAgfQogICAgICAgIH0gLy8gQ2xvc2Ugc3ViLXN0ZXAgbG9vcAoKICAgICAgICBpZiAoX3JlbmRlcmVyICYmIF9zY2VuZSAmJiBfY2FtZXJhKSB7CiAgICAgICAgICAgIF9yZW5kZXJlci5yZW5kZXIoX3NjZW5lLCBfY2FtZXJhKTsKICAgICAgICB9CiAgICAgICAgLy8gVUkgVXBkYXRlcwogICAgICAgIHVwZGF0ZVVJKCk7CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlVUkoKSB7CiAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybjsKCiAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKICAgICAgICBjb25zdCBsYmwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWxhYmVsJyk7CiAgICAgICAgY29uc3QgdGFja2xlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RhY2tsZS1idXR0b24nKTsKICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgaWYgKGJ0biAmJiBsYmwpIHsKICAgICAgICAgICAgY29uc3QgYnRuVGV4dCA9IGJ0bi5xdWVyeVNlbGVjdG9yKCcuYnRuLXRleHQnKTsKCiAgICAgICAgICAgIGlmIChwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGlmIChidG5UZXh0ICYmIGJ0blRleHQuaW5uZXJUZXh0ICE9PSAiQUNUSU9OIikgewogICAgICAgICAgICAgICAgICAgIGJ0blRleHQuaW5uZXJUZXh0ID0gIkFDVElPTiI7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ3Nob290LW1vZGUnKTsKICAgICAgICAgICAgICAgICAgICBsYmwuaW5uZXJUZXh0ID0gIk9GRkVOU0UiOwogICAgICAgICAgICAgICAgICAgIGxibC5jbGFzc0xpc3QuYWRkKCdzaG9vdC1sYWJlbCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IGlzSGlnaEVuZXJneSA9IChwLnN0YXRzLkhQIC8gcC5zdGF0cy5tYXhIUCkgPiAwLjQ7CiAgICAgICAgICAgICAgICBpZiAoaXNIaWdoRW5lcmd5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFidG4uY2xhc3NMaXN0LmNvbnRhaW5zKCdsaW1pdC1yZWFkeScpKSBidG4uY2xhc3NMaXN0LmFkZCgnbGltaXQtcmVhZHknKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJ0bi5jbGFzc0xpc3QuY29udGFpbnMoJ2xpbWl0LXJlYWR5JykpIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdsaW1pdC1yZWFkeScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChidG5UZXh0ICYmIGJ0blRleHQuaW5uZXJUZXh0ICE9PSAiU1dJTSIpIHsKICAgICAgICAgICAgICAgICAgICBidG5UZXh0LmlubmVyVGV4dCA9ICJTV0lNIjsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnc2hvb3QtbW9kZScpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdsaW1pdC1yZWFkeScpOwogICAgICAgICAgICAgICAgICAgIGxibC5pbm5lclRleHQgPSAiTk9STUFMIjsKICAgICAgICAgICAgICAgICAgICBsYmwuY2xhc3NMaXN0LnJlbW92ZSgnc2hvb3QtbGFiZWwnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVXBkYXRlIHRhY2tsZSBidXR0b24gdmlzaWJpbGl0eQogICAgICAgIGlmICh0YWNrbGVCdG4pIHsKICAgICAgICAgICAgaWYgKCFwLmhhc0JhbGwgfHwgcC5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgLy8gVXBkYXRlIHRhY2tsZSBidXR0b24gdGV4dCBiYXNlZCBvbiBjb250ZXh0CiAgICAgICAgICAgICAgICBjb25zdCB0YWNrbGVUZXh0ID0gdGFja2xlQnRuLnF1ZXJ5U2VsZWN0b3IoJy5idG4tdGV4dCcpOwogICAgICAgICAgICAgICAgaWYgKHRhY2tsZVRleHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocC5pc0VuZ2FnZWQgJiYgcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZVRleHQuaW5uZXJUZXh0ID0gJ0JSRUFLJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGFja2xlQnRuLmNsYXNzTGlzdC5hZGQoJ3VyZ2VudCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZVRleHQuaW5uZXJUZXh0ID0gJ1RBQ0tMRSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QucmVtb3ZlKCd1cmdlbnQnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YWNrbGVCdG4uc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVXBkYXRlIGRpc3RhbmNlIHRvIGdvYWwgaW5kaWNhdG9yCiAgICAgICAgY29uc3QgZGlzdEluZGljYXRvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnb2FsLWRpc3RhbmNlJyk7CiAgICAgICAgaWYgKGRpc3RJbmRpY2F0b3IgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHAudGVhbSAmJiBwLnRlYW0uc2lkZSA9PT0gMSkgPyAtMjggOiAyODsKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguYWJzKHAubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICBkaXN0SW5kaWNhdG9yLmlubmVyVGV4dCA9IGAke01hdGguZmxvb3IoZGlzdCl9bWA7CiAgICAgICAgfQogICAgfQoKZnVuY3Rpb24gdXBkYXRlQ2FtZXJhTG9naWMoZHQpIHsKICAgICAgICBpZiAoIV9jYW1lcmFNYW5hZ2VyIHx8ICFfYmFsbCkgcmV0dXJuOwoKICAgICAgICBsZXQgdGFyZ2V0TWVzaCA9IF9iYWxsLm1lc2g7CiAgICAgICAgbGV0IHRhcmdldFZlbCA9IF9iYWxsLnZlbG9jaXR5OwogICAgICAgIGxldCB0YXJnZXRJbnB1dCA9IG51bGw7CiAgICAgICAgbGV0IGlzQWltaW5nID0gZmFsc2U7CgogICAgICAgIGlmIChfYmFsbC5ob2xkZXIgJiYgX2JhbGwuaG9sZGVyLm1lc2gpIHsKICAgICAgICAgICAgdGFyZ2V0TWVzaCA9IF9iYWxsLmhvbGRlci5tZXNoOwogICAgICAgICAgICB0YXJnZXRWZWwgPSBfYmFsbC5ob2xkZXIudmVsb2NpdHk7CiAgICAgICAgICAgIGlmIChfYmFsbC5ob2xkZXIuaW5wdXRWZWN0b3IpIHsKICAgICAgICAgICAgICAgIHRhcmdldElucHV0ID0gX2JhbGwuaG9sZGVyLmlucHV0VmVjdG9yOwogICAgICAgICAgICB9Ci8vIENoZWNrIGFpbWluZyBzdGF0ZSAoQ2hhcmdpbmcgb3IgVGhyb3dpbmcpCiAgICAgICAgICAgIGlmIChfYmFsbC5ob2xkZXIuaXNDaGFyZ2luZyB8fCBfYmFsbC5ob2xkZXIuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgaXNBaW1pbmcgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQodGFyZ2V0TWVzaCwgdGFyZ2V0VmVsLCB0YXJnZXRJbnB1dCwgaXNBaW1pbmcpOwogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICB9CgpmdW5jdGlvbiBjaGVja0JhbGxHcmFiKGVudGl0eSkgewogICAgICAgIGlmICghZW50aXR5LmNhbkNhdGNoKSByZXR1cm47CiAgICAgICAgaWYgKF9iYWxsICYmICFfYmFsbC5pc0NhdGNoYWJsZSgpKSByZXR1cm47CiAgICAgICAgaWYgKGVudGl0eS5zdHVuVGltZXIgPiAwIHx8IChlbnRpdHkuc3RhdHVzICYmIGVudGl0eS5zdGF0dXMubmFwID4gMCkpIHJldHVybjsKICAgICAgICBpZiAoX2JhbGwuc3RhdGUgIT09ICdmcmVlJykgcmV0dXJuOwogICAgICAgIGlmICghX2JhbGwubWVzaCB8fCAhZW50aXR5Lm1lc2gpIHJldHVybjsKCiAgICAgICAgY29uc3QgYmFsbFBvcyA9IF9iYWxsLm1lc2gucG9zaXRpb247CiAgICAgICAgY29uc3QgZW50UG9zID0gZW50aXR5Lm1lc2gucG9zaXRpb247CgogICAgICAgIGNvbnN0IGR4ID0gYmFsbFBvcy54IC0gZW50UG9zLng7CiAgICAgICAgY29uc3QgZHogPSBiYWxsUG9zLnogLSBlbnRQb3MuejsKICAgICAgICBjb25zdCBkaXN0WFogPSBNYXRoLnNxcnQoZHgqZHggKyBkeipkeik7CiAgICAgICAgY29uc3QgZGlzdFkgPSBNYXRoLmFicyhiYWxsUG9zLnkgLSBlbnRQb3MueSk7CgogICAgICAgIC8vIC0tLSBSRUxBWEVEIFRPTEVSQU5DRVMgRk9SIEVBU0lFUiBQSUNLVVAgLS0tCiAgICAgICAgY29uc3QgdG91Y2hSYWRpdXMgPSAxLjU7IC8vIEluY3JlYXNlZCBmcm9tIDEuMCAoQXV0by1ncmFiIHJhZGl1cykKICAgICAgICBsZXQgbWFnbmV0UmFkaXVzID0gMy41OyAgLy8gSW5jcmVhc2VkIGZyb20gMS44IChNYWduZXRpYyByYWRpdXMpCiAgICAgICAgbGV0IGludGVyYWN0aW9uUmFkaXVzID0gNi4wOyAvLyBJbmNyZWFzZWQgZnJvbSAzLjUgKFR1cm4tdG8gcmFkaXVzKQogICAgICAgIGxldCBjYXRjaEhlaWdodCA9IDYuMDsgICAvLyBJbmNyZWFzZWQgZnJvbSAzLjAgKFZlcnRpY2FsIHJlYWNoKQoKICAgICAgICBpZiAoZW50aXR5LmlzRGFzaGluZykgewogICAgICAgICAgICBtYWduZXRSYWRpdXMgPSA0LjU7CiAgICAgICAgICAgIGludGVyYWN0aW9uUmFkaXVzID0gNy4wOwogICAgICAgICAgICBjYXRjaEhlaWdodCA9IDcuMDsKICAgICAgICB9CgogICAgICAgIGlmIChkaXN0WFogPiBpbnRlcmFjdGlvblJhZGl1cyB8fCBkaXN0WSA+IGNhdGNoSGVpZ2h0KSByZXR1cm47CgogICAgICAgIC8vIE9wdGltaXphdGlvbjogVXNlIHNoYXJlZCB2ZWN0b3JzIHRvIGF2b2lkIEdDCiAgICAgICAgX3RlbXBWZWMxLmNvcHkoYmFsbFBvcykuc3ViKGVudFBvcykubm9ybWFsaXplKCk7IC8vIHRvQmFsbAogICAgICAgIF90ZW1wVmVjMi5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKGVudGl0eS5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOyAvLyBwbGF5ZXJGb3J3YXJkCgogICAgICAgIGNvbnN0IGZhY2luZ0RvdCA9IF90ZW1wVmVjMi5kb3QoX3RlbXBWZWMxKTsKCiAgICAgICAgY29uc3QgY29uZVRocmVzaG9sZCA9IC0wLjQ7IC8vIE1vcmUgZ2VuZXJvdXMgY29uZSAod2FzIC0wLjIpCiAgICAgICAgY29uc3QgaXNJbkNvbmUgPSBmYWNpbmdEb3QgPiBjb25lVGhyZXNob2xkOwogICAgICAgIAogICAgICAgIC8vIEFVVE8tVFVSTjogSWYgbmVhciBidXQgZmFjaW5nIHdyb25nIHdheSwgdHVybiB0b3dhcmRzIGJhbGwKICAgICAgICBpZiAoZGlzdFhaIDwgaW50ZXJhY3Rpb25SYWRpdXMgJiYgIWlzSW5Db25lKSB7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldEFuZ2xlID0gTWF0aC5hdGFuMihfdGVtcFZlYzEueCwgX3RlbXBWZWMxLnopOwogICAgICAgICAgICBjb25zdCBxID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMSwwKSwgdGFyZ2V0QW5nbGUpOwogICAgICAgICAgICBlbnRpdHkubWVzaC5xdWF0ZXJuaW9uLnNsZXJwKHEsIDAuMik7IC8vIEZhc3RlciB0dXJuICh3YXMgMC4xKQogICAgICAgICAgICBpZiAoZW50aXR5LnN5bmNSb3RhdGlvbikgZW50aXR5LnN5bmNSb3RhdGlvbigpOwogICAgICAgIH0KCiAgICAgICAgLy8gR1JBQiBMT0dJQwogICAgICAgIC8vIDEuIFRvdWNoOiBWZXJ5IGNsb3NlIChpZ25vcmUgZmFjaW5nIC0gcHJldmVudHMgcnVubmluZyBvdmVyIGJhbGwpCiAgICAgICAgLy8gMi4gTWFnbmV0OiBDbG9zZSBhbmQgZmFjaW5nCiAgICAgICAgY29uc3QgaXNUb3VjaCA9IGRpc3RYWiA8IHRvdWNoUmFkaXVzOwogICAgICAgIGNvbnN0IGlzTWFnbmV0ID0gZGlzdFhaIDwgbWFnbmV0UmFkaXVzICYmIGlzSW5Db25lOwoKICAgICAgICBpZiAoaXNUb3VjaCB8fCBpc01hZ25ldCkgewogICAgICAgICAgICAvLyBCTEFTVCBUSFJPVUdIIExPR0lDCiAgICAgICAgICAgIGNvbnN0IGJhbGxTcGVlZCA9IF9iYWxsLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICBsZXQgY2F0Y2hDaGFuY2UgPSAxLjA7CgogICAgICAgICAgICAvLyBJZiBiYWxsIGlzIG1vdmluZyBmYXN0IChlLmcuID4gMjApLCBjaGVjayBDQQogICAgICAgICAgICBpZiAoYmFsbFNwZWVkID4gMjAuMCkgewogICAgICAgICAgICAgICAgY29uc3QgY2EgPSBlbnRpdHkuZ2V0U3RhdCgnQ0EnKTsKICAgICAgICAgICAgICAgIC8vIERpZmZpY3VsdHkgc2NhbGVzIHdpdGggc3BlZWQuIAogICAgICAgICAgICAgICAgY29uc3QgZGlmZmljdWx0eSA9IGJhbGxTcGVlZCAqIDEuMjsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChkaWZmaWN1bHR5ID4gY2EpIHsKICAgICAgICAgICAgICAgICAgICBjYXRjaENoYW5jZSA9IDAuNCArIChjYSAvIGRpZmZpY3VsdHkpICogMC42OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFBvaW50IEJsYW5rIFBlbmFsdHk6IEhhcmRlciB0byByZWFjdCBpZiBiYWxsIGlzIHJpZ2h0IG9uIHRvcCBvZiB5b3UgbW92aW5nIGZhc3QKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdFhaIDwgMS4yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoQ2hhbmNlICo9IDAuNjsgLy8gQmxhc3QgdGhyb3VnaCBsaWtlbHkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKGVudGl0eS5pc0Rhc2hpbmcpIGNhdGNoQ2hhbmNlICs9IDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChfYmFsbC5wb3dlclR5cGUgPT09ICdTSCcgJiYgX2JhbGwucG93ZXIgPiAxNS4wKSB7CiAgICAgICAgICAgICAgICAvLyBTaG90IHBvd2VyIGNoZWNrCiAgICAgICAgICAgICAgICBjb25zdCBjYSA9IGVudGl0eS5nZXRTdGF0KCdDQScpOwogICAgICAgICAgICAgICAgaWYgKF9iYWxsLnBvd2VyID4gY2EgKiAxLjIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFuY2UgPSBNYXRoLm1pbigwLjcsIChfYmFsbC5wb3dlciAtIGNhKSAqIDAuMDQpOwogICAgICAgICAgICAgICAgICAgIGNhdGNoQ2hhbmNlID0gMS4wIC0gY2hhbmNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgZnVtYmxlID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gY2F0Y2hDaGFuY2UpIHsKICAgICAgICAgICAgICAgIGZ1bWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmdW1ibGUpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIGZlZWRiYWNrIGZvciBibGFzdCB0aHJvdWdoCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxBU1QgVEhST1VHSCEiLCBlbnRQb3MsICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGVmbGVjdCBzbGlnaHRseSBidXQga2VlcCBtb3ZpbmcgZmFzdCAoQmxhc3QgVGhyb3VnaCkKICAgICAgICAgICAgICAgIC8vIERvbid0IHN0b3AgaXQgY29tcGxldGVseSBsaWtlIGEgYmxvY2ssIGp1c3QgcGVydHVyYiBpdAogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC44NSk7IAogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogNS4wOwogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkueSArPSAoTWF0aC5yYW5kb20oKSkgKiA1LjA7IC8vIFBvcCB1cAogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogNS4wOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfYmFsbC5wb3dlciAqPSAwLjc7CgogICAgICAgICAgICAgICAgZW50aXR5LmNhbkNhdGNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBTdHVuIGJyaWVmbHkKICAgICAgICAgICAgICAgIGVudGl0eS5zdHVuVGltZXIgPSAwLjU7CiAgICAgICAgICAgICAgICBpZihlbnRpdHkucGxheSkgZW50aXR5LnBsYXkoJ3JlYWN0JywgMC4xKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IGVudGl0eS5jYW5DYXRjaCA9IHRydWU7IH0sIDEwMDApOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9iYWxsLm1hZ25ldGl6ZShlbnRpdHkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIFN0YXJ0CiAgICBpbml0KCk7Cn0pKCk7","./main.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgLy8gTmFtZXNwYWNlCiAgICB3aW5kb3cuZmx1eCA9IHdpbmRvdy5mbHV4IHx8IHt9OwogICAgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyA9IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgfHwgW107CgogICAgLy8gQ29uZmlnCmNvbnN0IF9jb25maWcgPSB7CiAgICAgICAgaW50ZXJuYWxXaWR0aDogMzYwLAogICAgICAgIGludGVybmFsSGVpZ2h0OiA2NDAsCiAgICAgICAgYmdDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgZm9nQ29sb3I6IDB4MDAxZTM2LAogICAgICAgIGZvZ0RlbnNpdHk6IDAuMDAwMSwgLy8gRHJhc3RpY2FsbHkgcmVkdWNlZCB0byBlbnN1cmUgdmlzaWJpbGl0eQogICAgICAgIGFyZW5hUmFkaXVzOiA0OC4wCiAgICB9OwoKICAgIC8vIEdsb2JhbHMKLy8gR2xvYmFscwogICAgY29uc3QgX2lucHV0ID0geyB4OiAwLCB5OiAwIH07IC8vIElucHV0IHN0YXRlCiAgICAKICAgIC8vIFNoYWRlciBVbmlmb3JtcwogICAgY29uc3QgX2FyZW5hVW5pZm9ybXMgPSB7CiAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICB1SW1wYWN0UG9zOiB7IHZhbHVlOiBuZXcgVEhSRUUuVmVjdG9yMygpIH0sCiAgICAgICAgdUltcGFjdFN0cjogeyB2YWx1ZTogMC4wIH0KICAgIH07CiAgICBjb25zdCBfcGFydGljbGVVbmlmb3JtcyA9IHsKICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9CiAgICB9OwoKICAgIC8vIEV4cG9zZSBJbXBhY3QgVHJpZ2dlcgogICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0ID0gZnVuY3Rpb24ocG9zLCBzdHJlbmd0aCkgewogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RQb3MudmFsdWUuY29weShwb3MpOwogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RTdHIudmFsdWUgPSBzdHJlbmd0aCAqIDIuMDsgLy8gU2NhbGUgdXAgZm9yIHZpc2liaWxpdHkKICAgIH07Ci8vIF9pbnB1dCBhbHJlYWR5IGRlY2xhcmVkIGFib3ZlCiAgICBjb25zdCBfdGVtcFZlYzEgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBSZXVzYWJsZSBmb3IgcGh5c2ljcy9sb2dpYwogICAgY29uc3QgX3RlbXBWZWMyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsgLy8gUmV1c2FibGUgZm9yIHBoeXNpY3MvbG9naWMKICAgIGxldCBfc2NlbmUsIF9jYW1lcmEsIF9yZW5kZXJlciwgX2Nsb2NrOwogICAgbGV0IF9ob21lVGVhbSwgX2F3YXlUZWFtOwogICAgbGV0IF9iYWxsOwogICAgbGV0IF9nYW1lTWFuYWdlcjsKICAgIGxldCBfbWVudU1hbmFnZXI7CiAgICBsZXQgX2F1ZGlvTWFuYWdlcjsKCiAgICBsZXQgX2NhbWVyYU1hbmFnZXI7CiAgICBsZXQgX3dhdGVyT3ZlcmxheTsKICAgIGxldCBfbGlnaHRTaGFmdHM7CiAgICBsZXQgX3N0YWRpdW07CiAgICBsZXQgX2dseXBoTWFuYWdlcjsKCiAgICAvLyBJTVBST1ZFRDogU2V0dGluZ3Mgb2JqZWN0CiAgICBjb25zdCBfc2V0dGluZ3MgPSB7CiAgICAgICAgam95c3RpY2tTZW5zaXRpdml0eTogMS4wLAogICAgICAgIGFpbUFzc2lzdDogdHJ1ZSwKICAgICAgICBjYW1lcmFTaGFrZTogdHJ1ZSwKICAgICAgICBoaXRTdG9wOiB0cnVlLAogICAgICAgIGludmVydENhbWVyYTogZmFsc2UsCiAgICAgICAgYXV0b1JlY2VudGVyOiB0cnVlCiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRGVidWcgSU8gQnJpZGdlIChleHBvc2VkIGZvciBEZXZUb29scyBKU09OIHNuYXBzaG90cykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIHx8IHt9OwogICAgX2RlYnVnSU8uc2V0dGluZ3MgPSBfc2V0dGluZ3M7CiAgICBfZGVidWdJTy5pbnB1dCA9IF9kZWJ1Z0lPLmlucHV0IHx8IHt9OwogICAgX2RlYnVnSU8ucGVyZiA9IF9kZWJ1Z0lPLnBlcmYgfHwgeyBmcmFtZTogMCwgcmF3RHQ6IDAsIGR0OiAwLCBmcHM6IDAsIGF2Z0ZwczogMCB9OwoKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIFRvdWNoIGhlbHBlcnMgKG11bHRpLXRvdWNoIHNhZmUpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGZ1bmN0aW9uIF9maW5kVG91Y2hCeUlkKHRvdWNoTGlzdCwgaWQpIHsKICAgICAgICBpZiAoaWQgPT09IG51bGwgfHwgaWQgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgICAgaWYgKCF0b3VjaExpc3QpIHJldHVybiBudWxsOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdG91Y2hMaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IHQgPSB0b3VjaExpc3RbaV07CiAgICAgICAgICAgIGlmICh0ICYmIHQuaWRlbnRpZmllciA9PT0gaWQpIHJldHVybiB0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBfZW5kZWRUb3VjaEJ5SWQoY2hhbmdlZFRvdWNoZXMsIGlkKSB7CiAgICAgICAgaWYgKGlkID09PSBudWxsIHx8IGlkID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgICAgIGlmICghY2hhbmdlZFRvdWNoZXMpIHJldHVybiBudWxsOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hhbmdlZFRvdWNoZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgdCA9IGNoYW5nZWRUb3VjaGVzW2ldOwogICAgICAgICAgICBpZiAodCAmJiB0LmlkZW50aWZpZXIgPT09IGlkKSByZXR1cm4gdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGluaXQoKSB7CiAgICAgICAgX2NvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnYW1lLWNvbnRhaW5lcicpOwoKICAgICAgICAvLyAxLiBTY2VuZQogICAgICAgIF9zY2VuZSA9IG5ldyBUSFJFRS5TY2VuZSgpOwogICAgICAgIF9zY2VuZS5iYWNrZ3JvdW5kID0gbmV3IFRIUkVFLkNvbG9yKF9jb25maWcuYmdDb2xvcik7CiAgICAgICAgX3NjZW5lLmZvZyA9IG5ldyBUSFJFRS5Gb2dFeHAyKF9jb25maWcuZm9nQ29sb3IsIF9jb25maWcuZm9nRGVuc2l0eSk7CgogICAgICAgIC8vIDIuIENhbWVyYQogICAgICAgIGNvbnN0IGFzcGVjdCA9IF9jb25maWcuaW50ZXJuYWxXaWR0aCAvIF9jb25maWcuaW50ZXJuYWxIZWlnaHQ7Cl9jYW1lcmEgPSBuZXcgVEhSRUUuUGVyc3BlY3RpdmVDYW1lcmEoNjAsIGFzcGVjdCwgMC4xLCA1MDApOwpfY2FtZXJhLnBvc2l0aW9uLnNldCgwLCAxNCwgMjIpOwogICAgICAgIF9jYW1lcmEubG9va0F0KDAsIDAsIDApOwogICAgICAgIF9zY2VuZS5hZGQoX2NhbWVyYSk7IC8vIEVuc3VyZSBjYW1lcmEgaXMgaW4gc2NlbmUgZm9yIGNoaWxkcmVuIHRvIHJlbmRlcgoKICAgICAgICAvLyAzLiBSZW5kZXJlcgovLyAzLiBSZW5kZXJlcgogICAgICAgIF9yZW5kZXJlciA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlcmVyKHsgCiAgICAgICAgICAgIGFudGlhbGlhczogZmFsc2UsCiAgICAgICAgICAgIHBvd2VyUHJlZmVyZW5jZTogImhpZ2gtcGVyZm9ybWFuY2UiLAogICAgICAgICAgICBwcmVjaXNpb246ICJtZWRpdW1wIiwgLy8gTW9iaWxlIG9wdGltaXphdGlvbjogZmFzdGVyIHNoYWRlcnMKICAgICAgICAgICAgc3RlbmNpbDogZmFsc2UsICAgICAgIC8vIERpc2FibGUgc3RlbmNpbCBidWZmZXIgaWYgbm90IHVzZWQKICAgICAgICAgICAgZGVwdGg6IHRydWUKICAgICAgICB9KTsKICAgICAgICBfcmVuZGVyZXIuc2V0UGl4ZWxSYXRpbygxKTsgLy8gRm9yY2UgMToxIHBpeGVsIHJhdGlvLCB3ZSBoYW5kbGUgc2NhbGluZyB2aWEgc2V0U2l6ZQogICAgICAgIF9yZW5kZXJlci5hdXRvQ2xlYXIgPSBmYWxzZTsgLy8gV2UgbWFuYWdlIGNsZWFyaW5nIHZpYSBiYWNrZ3JvdW5kIG9yIG1hbnVhbCBjYWxscyBpZiBuZWVkZWQgKHRob3VnaCBzY2VuZS5iYWNrZ3JvdW5kIGhhbmRsZXMgY29sb3IpCiAgICAgICAgLy8gRXhwb3NlIHJlbmRlcmVyIGZvciBEZXZUb29scwogICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIF9nYW1lTWFuYWdlci5yZW5kZXJlciA9IF9yZW5kZXJlcjsgCiAgICAgICAgZWxzZSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPSB7IHJlbmRlcmVyOiBfcmVuZGVyZXIgfTsgLy8gVGVtcCBob29rCl9jb250YWluZXIuYXBwZW5kQ2hpbGQoX3JlbmRlcmVyLmRvbUVsZW1lbnQpOwoKLy8gLS0tIFZpZGVvIE92ZXJsYXkgRW5mb3JjZW1lbnQgLS0tCiAgICAgICAgLy8gLS0tIE92ZXJsYXkgVmlkZW8gTG9naWMgUmVtb3ZlZCAoU3dpdGNoZWQgdG8gR0lGKSAtLS0KICAgICAgICAvLyA1LiBFbnZpcm9ubWVudAogICAgICAgIGNyZWF0ZVBhcnRpY2xlcygpOwogICAgICAgIGNyZWF0ZUFyZW5hKCk7CmNyZWF0ZUFyZW5hKCk7CiAgICAgICAgY3JlYXRlSG9sb2dyYXBoaWNSaW5ncygpOwovLyA1LjUgR2FtZSBNYW5hZ2VyCl9nYW1lTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5HYW1lTWFuYWdlcihfc2NlbmUsICd1aS1sYXllcicsIF9jYW1lcmEsIF9yZW5kZXJlcik7CiAgICAgICAgCiAgICAgICAgLy8gNS41LjEgQXVkaW8gTWFuYWdlcgogICAgICAgIF9hdWRpb01hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguQXVkaW9NYW5hZ2VyKCk7CiAgICAgICAgX2dhbWVNYW5hZ2VyLmF1ZGlvTWFuYWdlciA9IF9hdWRpb01hbmFnZXI7CgogICAgICAgIC8vIDUuNiBDYW1lcmEgTWFuYWdlcgogICAgICAgIF9jYW1lcmFNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkNhbWVyYU1hbmFnZXIoX2NhbWVyYSwgX3NjZW5lKTsKICAgICAgICBfZ2FtZU1hbmFnZXIuY2FtZXJhTWFuYWdlciA9IF9jYW1lcmFNYW5hZ2VyOwoKICAgICAgICAvLyA1LjcgRGV2IFRvb2xzCmlmICh3aW5kb3cuZmx1eC5EZXZUb29scykgewogICAgICAgICAgICBuZXcgd2luZG93LmZsdXguRGV2VG9vbHMoX2dhbWVNYW5hZ2VyKTsKICAgICAgICB9Ci8vIDUuOCBXYXRlciBPdmVybGF5LCBMaWdodCBTaGFmdHMsIFN0YWRpdW0sIEdseXBocwogICAgICAgIF93YXRlck92ZXJsYXkgPSBuZXcgd2luZG93LmZsdXguV2F0ZXJPdmVybGF5KF9jYW1lcmEpOwogICAgICAgIF9saWdodFNoYWZ0cyA9IG5ldyB3aW5kb3cuZmx1eC5MaWdodFNoYWZ0cyhfc2NlbmUpOwogICAgICAgIF9zdGFkaXVtID0gbmV3IHdpbmRvdy5mbHV4LlN0YWRpdW0oX3NjZW5lKTsKICAgICAgICBfZ2x5cGhNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkdseXBoTWFuYWdlcihfc2NlbmUpOwogICAgICAgIAppZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIF9nYW1lTWFuYWdlci5nbHlwaE1hbmFnZXIgPSBfZ2x5cGhNYW5hZ2VyOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIud2F0ZXJPdmVybGF5ID0gX3dhdGVyT3ZlcmxheTsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmxpZ2h0U2hhZnRzID0gX2xpZ2h0U2hhZnRzOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIuc3RhZGl1bSA9IF9zdGFkaXVtOwogICAgICAgIH0KICAgICAgICAvLyA2LiBUZWFtcyBTZXR1cAogICAgICAgIF9ob21lVGVhbSA9IG5ldyB3aW5kb3cuZmx1eC5UZWFtKF9zY2VuZSwgJ2hvbWUnLCAxLCAweDAwYWFmZiwgdHJ1ZSk7CiAgICAgICAgX2F3YXlUZWFtID0gbmV3IHdpbmRvdy5mbHV4LlRlYW0oX3NjZW5lLCAnYXdheScsIC0xLCAweGZmNjY2NiwgZmFsc2UpOwoKICAgICAgICAvLyA3LiBCYWxsCiAgICAgICAgX2JhbGwgPSBuZXcgd2luZG93LmZsdXguQmFsbChfc2NlbmUpOwoKICAgICAgICAvLyBJTVBST1ZFRDogTGluayBiYWxsIHRvIGNhbWVyYSBmb3Igc21hcnQgZnJhbWluZwogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnNldEJhbGwoX2JhbGwpOwoKICAgICAgICAvLyA4LiBUZWFtIFJvc3RlciBNb2RlbHMKICAgICAgICBjb25zdCByb2xlcyA9IFsnTEYnLCAnUkYnLCAnTUYnLCAnTEQnLCAnUkQnLCAnR0wnXTsKICAgICAgICBjb25zdCBob21lUm9zdGVyID0gewogICAgICAgICAgICBMRjogeyBuYW1lOiAnVGlkdXMnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZGE3ODhiZWYyNThjNGYwYjhkOWVmMWFjYzE5YzU1NjcuZ2xiJyB9LAogICAgICAgICAgICBSRjogeyBuYW1lOiAnV2Fra2EnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJyB9LAogICAgICAgICAgICBNRjogeyBuYW1lOiAnTGV0dHknLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNDNhY2UzNGM2ZmQ5NDIxNTk2N2U4NDJiZjkwOWRhNWUuZ2xiJyB9LAogICAgICAgICAgICBMRDogeyBuYW1lOiAnRGF0dG8nLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZTZkNjdlY2IyZTRjNDcxNWJkNzNhNDA3OTVlMWQzZDUuZ2xiJyB9LAogICAgICAgICAgICBSRDogeyBuYW1lOiAnSmFzc3UnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJyB9LAogICAgICAgICAgICBHTDogeyBuYW1lOiAnQm90dGEnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvYWQxNTVlZmVkYzBkNDhmZGFkMDlkYTNlMWNhZTljOTcuZ2xiJyB9CiAgICAgICAgfTsKCmNvbnN0IGFwcGx5U3RhdHMgPSAocCwgcm9sZSwgaXNIb21lKSA9PiB7CmNvbnN0IHRlYW1MZXZlbCA9IGlzSG9tZSA/IDI1IDogODsgLy8gTmVyZmVkIENQVSBsZXZlbCBzaWduaWZpY2FudGx5ICh3YXMgMTUpCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LlRlYW0uZ2VuZXJhdGVTdGF0cyhwLCByb2xlLCB0ZWFtTGV2ZWwsIGlzSG9tZSk7CgogICAgICAgICAgICBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDU7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNQICs9IDM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDM7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkVOICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdCcm90aGVyJykpIHsKICAgICAgICAgICAgICAgIHAuc3RhdHMuU1AgPSA5OTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcC5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CiAgICAgICAgfTsKCiAgICAgICAgbGV0IGhvbWVMb2FkZWQgPSAwOwogICAgICAgIGNvbnN0IHJvbGVHbHRmcyA9IHt9OwoKICAgICAgICBjb25zdCBmaW5hbGl6ZVRlYW1zID0gKCkgPT4gewogICAgICAgICAgICByb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZ2x0ZiA9IHJvbGVHbHRmc1tyb2xlXSB8fCByb2xlR2x0ZnMuTEY7CgogICAgICAgICAgICAgICAgY29uc3QgcCA9IChyb2xlID09PSAnR0wnKQogICAgICAgICAgICAgICAgICAgID8gbmV3IHdpbmRvdy5mbHV4LkdvYWxpZShfc2NlbmUsIHJvbGUpCiAgICAgICAgICAgICAgICAgICAgOiBuZXcgd2luZG93LmZsdXguQUlQbGF5ZXIoX3NjZW5lLCByb2xlKTsKCiAgICAgICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgICAgICBwLmNoYXJhY3Rlck5hbWUgPSBlbnRyeSA/IGBDUFUgJHtlbnRyeS5uYW1lfWAgOiAnQ1BVJzsKICAgICAgICAgICAgICAgIGFwcGx5U3RhdHMocCwgcm9sZSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmICYmIGdsdGYuc2NlbmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjbG9uZSA9IFRIUkVFLlNrZWxldG9uVXRpbHMuY2xvbmUoZ2x0Zi5zY2VuZSk7CiAgICAgICAgICAgICAgICAgICAgcC5zZXRNZXNoKGNsb25lLCBnbHRmLmFuaW1hdGlvbnMgfHwgW10pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ01pc3NpbmcgR0xURiBmb3IgYXdheSByb2xlOicsIHJvbGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS5hZGRQbGF5ZXIocCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYWxsUGxheWVycyA9IFsuLi5faG9tZVRlYW0ucGxheWVycywgLi4uX2F3YXlUZWFtLnBsYXllcnNdOwogICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAocC5iYWxsUmVmID09PSBudWxsKSBwLmJhbGxSZWYgPSBfYmFsbDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyID0gX2hvbWVUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy50YWNrbGUgPSAndmVub20nOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy5zaG9vdCA9ICdzcGhlcmUnOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0VxdWlwcGVkIEhvbWUgTUYgd2l0aCBWZW5vbSBUYWNrbGUgJiBTcGhlcmUgU2hvdCcpOwogICAgICAgICAgICB9Cgpjb25zdCBhd2F5TUYgPSBfYXdheVRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgLy8gUmVtb3ZlZCBndWFyYW50ZWVkIFdpdGhlciB0YWNrbGUgZm9yIEF3YXkgTUYgdG8gcmVkdWNlIGRpZmZpY3VsdHkKICAgICAgICAgICAgX2F3YXlUZWFtLnNldEZvcm1hdGlvbignQ291bnRlcicpOwoKICAgICAgICAgICAgY29uc3QgYXdheUdMID0gX2F3YXlUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ0dMJyk7CiAgICAgICAgICAgIC8vIFJlbW92ZWQgZ3VhcmFudGVlZCBTdXBlciBHb2FsaWUgZm9yIEF3YXkgR0wgdG8gbWFrZSBzY29yaW5nIGVhc2llcgoKICAgICAgICAgICAgX2hvbWVUZWFtLmFzc2lnbk1hcmtzKF9hd2F5VGVhbSk7CiAgICAgICAgICAgIF9hd2F5VGVhbS5hc3NpZ25NYXJrcyhfaG9tZVRlYW0pOwoKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xvYWRpbmcnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIucmVnaXN0ZXJUZWFtcyhfaG9tZVRlYW0sIF9hd2F5VGVhbSwgX2JhbGwpOwoKICAgICAgICAgICAgICAgIF9tZW51TWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5NZW51TWFuYWdlcihfZ2FtZU1hbmFnZXIpOwogICAgICAgICAgICAgICAgX21lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgfQogICAgICAgIH07Cgpyb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgIGlmICghZW50cnkpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9uQ29tcGxldGUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBob21lTG9hZGVkKys7CiAgICAgICAgICAgICAgICBpZiAoaG9tZUxvYWRlZCA+PSByb2xlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBmaW5hbGl6ZVRlYW1zKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlci5sb2FkTW9kZWwoZW50cnkudXJsLCAoZ2x0ZikgPT4gewogICAgICAgICAgICAgICAgcm9sZUdsdGZzW3JvbGVdID0gZ2x0ZjsKCiAgICAgICAgICAgICAgICBjb25zdCBwID0gKHJvbGUgPT09ICdHTCcpCiAgICAgICAgICAgICAgICAgICAgPyBuZXcgd2luZG93LmZsdXguR29hbGllKF9zY2VuZSwgcm9sZSkKICAgICAgICAgICAgICAgICAgICA6IG5ldyB3aW5kb3cuZmx1eC5BSVBsYXllcihfc2NlbmUsIHJvbGUpOwoKICAgICAgICAgICAgICAgIHAuY2hhcmFjdGVyTmFtZSA9IGVudHJ5Lm5hbWU7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIHRydWUpOwoKICAgICAgICAgICAgICAgIGNvbnN0IGNsb25lID0gVEhSRUUuU2tlbGV0b25VdGlscy5jbG9uZShnbHRmLnNjZW5lKTsKICAgICAgICAgICAgICAgIHAuc2V0TWVzaChjbG9uZSwgZ2x0Zi5hbmltYXRpb25zKTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hZGRQbGF5ZXIocCk7CgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpOwogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2FkIG1vZGVsJywgZW50cnkubmFtZSwgZW50cnkudXJsLCBlcnIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayBNZXNoIChSZWQgQm94KQogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoMSwgMiwgMSk7CiAgICAgICAgICAgICAgICBjb25zdCBmYWxsYmFja01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlIH0pOwogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tNZXNoID0gbmV3IFRIUkVFLk1lc2goZmFsbGJhY2tHZW8sIGZhbGxiYWNrTWF0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU3RvcmUgZHVtbXkgaW4gcm9sZUdsdGZzIGZvciBhd2F5IHRlYW0gY2xvbmluZwogICAgICAgICAgICAgICAgcm9sZUdsdGZzW3JvbGVdID0geyBzY2VuZTogZmFsbGJhY2tNZXNoLCBhbmltYXRpb25zOiBbXSB9OwoKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSAocm9sZSA9PT0gJ0dMJykKICAgICAgICAgICAgICAgICAgICA/IG5ldyB3aW5kb3cuZmx1eC5Hb2FsaWUoX3NjZW5lLCByb2xlKQogICAgICAgICAgICAgICAgICAgIDogbmV3IHdpbmRvdy5mbHV4LkFJUGxheWVyKF9zY2VuZSwgcm9sZSk7CgogICAgICAgICAgICAgICAgcC5jaGFyYWN0ZXJOYW1lID0gZW50cnkubmFtZSArICIgKEVycm9yKSI7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIHRydWUpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBwLnNldE1lc2goZmFsbGJhY2tNZXNoLmNsb25lKCksIFtdKTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hZGRQbGF5ZXIocCk7CgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gOC4gSW5wdXQKICAgICAgICBzZXR1cElucHV0cygpOwoKICAgICAgICAvLyA5LiBMb29wCiAgICAgICAgX2Nsb2NrID0gbmV3IFRIUkVFLkNsb2NrKCk7CiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwoKICAgICAgICAvLyBIYW5kbGUgcmVzaXplCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIG9uUmVzaXplKTsKICAgICAgICBvblJlc2l6ZSgpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlUGFydGljbGVzKCkgewogICAgICAgIGNvbnN0IGNvdW50ID0gMTUwMDsgLy8gSW5jcmVhc2VkIGNvdW50CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IFtdOwogICAgICAgIGNvbnN0IG9mZnNldHMgPSBbXTsgLy8gUmFuZG9tIG9mZnNldHMgZm9yIGluZGVwZW5kZW50IGJvYmJpbmcKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgIHZlcnRpY2VzLnB1c2goCiAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA4MCwgLy8gV2lkZXIgc3ByZWFkIFgKICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDUwLCAvLyBXaWRlciBzcHJlYWQgWQogICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogODAgIC8vIFdpZGVyIHNwcmVhZCBaCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIG9mZnNldHMucHVzaChNYXRoLnJhbmRvbSgpICogMTAwKTsKICAgICAgICB9CgogICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSh2ZXJ0aWNlcywgMykpOwogICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgnYU9mZnNldCcsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKG9mZnNldHMsIDEpKTsKCiAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICB1bmlmb3JtczogX3BhcnRpY2xlVW5pZm9ybXMsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCnZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBhT2Zmc2V0OwogICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2QWxwaGE7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAvLyBCb2JiaW5nIG1vdGlvbjogU2luZSB3YXZlIGJhc2VkIG9uIHRpbWUgKyByYW5kb20gb2Zmc2V0CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYm9iID0gc2luKHVUaW1lICogMC41ICsgYU9mZnNldCkgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gYm9iOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZlYzQgbXZQb3NpdGlvbiA9IG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zLCAxLjApOwogICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG12UG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU2l6ZSBhdHRlbnVhdGlvbiAtIFNtYWxsIGFuZCBzaGltbWVyeQogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNpemVCYXNlID0gMi4wICsgc2luKHVUaW1lICogMy4wICsgYU9mZnNldCkgKiAxLjA7IAogICAgICAgICAgICAgICAgICAgIGdsX1BvaW50U2l6ZSA9IHNpemVCYXNlICogKDIwLjAgLyAtbXZQb3NpdGlvbi56KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBGYWRlIGJhc2VkIG9uIGRpc3RhbmNlL2hlaWdodAogICAgICAgICAgICAgICAgICAgIHZBbHBoYSA9IDAuNSArIDAuNSAqIHNpbih1VGltZSAqIDIuMCArIGFPZmZzZXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgLAogICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2QWxwaGE7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU29mdCBnbG93IHBhcnRpY2xlIChEdXN0IG1vdGUpCiAgICAgICAgICAgICAgICAgICAgdmVjMiBjb29yZCA9IGdsX1BvaW50Q29vcmQgLSB2ZWMyKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGlzdCA9IGxlbmd0aChjb29yZCk7CiAgICAgICAgICAgICAgICAgICAgaWYoZGlzdCA+IDAuNSkgZGlzY2FyZDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTb2Z0IGZhbGxvZmYgZm9yIHNoaW1tZXIKICAgICAgICAgICAgICAgICAgICBmbG9hdCBzdHJlbmd0aCA9IDEuMCAtIChkaXN0ICogMi4wKTsKICAgICAgICAgICAgICAgICAgICBzdHJlbmd0aCA9IHBvdyhzdHJlbmd0aCwgMi4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDeWFuL0JsdWUgdGludCwgYWRkaXRpdmUgZmVlbAogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoMC43LCAwLjksIDEuMCwgdkFscGhhICogc3RyZW5ndGggKiAwLjgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHBvaW50cyA9IG5ldyBUSFJFRS5Qb2ludHMoZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICBwb2ludHMuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgIF9zY2VuZS5hZGQocG9pbnRzKTsKICAgIH0KCmZ1bmN0aW9uIGNyZWF0ZUFyZW5hKCkgewogICAgICAgIC8vIEdyb3VwIGZvciByb3RhdGlvbgogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICBfc2NlbmUuYWRkKHdpbmRvdy5mbHV4LmFyZW5hR3JvdXApOwoKICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeShfY29uZmlnLmFyZW5hUmFkaXVzLCAzMiwgMzIpOwogICAgICAgIAogICAgICAgIC8vIC0tLSAxLiBCYXNlIFNwaGVyZSAoRmFpbnQgR3JpZCkgLS0tCiAgICAgICAgY29uc3QgdGV4TG9hZGVyID0gbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKTsKICAgICAgICBjb25zdCBhcmVuYVRleCA9IHRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9XMUxzSDY4US9maWxlLTAwMDAwMDAwMjNlYzcxZjU5NjU5MzgyOWU4MTE4NzYwLSgxKS5wbmcnKTsKICAgICAgICBhcmVuYVRleC5tYWdGaWx0ZXIgPSBUSFJFRS5OZWFyZXN0RmlsdGVyOwogICAgICAgIGFyZW5hVGV4Lm1pbkZpbHRlciA9IFRIUkVFLk5lYXJlc3RGaWx0ZXI7CiAgICAgICAgYXJlbmFUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBhcmVuYVRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGFyZW5hVGV4LnJlcGVhdC5zZXQoNiwgNCk7CgogICAgICAgIGNvbnN0IG1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiBhcmVuYVRleCwKICAgICAgICAgICAgY29sb3I6IDB4NDQ2Njg4LAogICAgICAgICAgICB3aXJlZnJhbWU6IGZhbHNlLAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4xNSwgCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgY29uc3QgYXJlbmEgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAuYWRkKGFyZW5hKTsKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2ggPSBhcmVuYTsKCiAgICAgICAgLy8gLS0tIDIuIElubmVyIEhleCBHcmlkIChXYXJwIEVmZmVjdCkgLS0tCiAgICAgICAgLy8gUmV1c2UgZXhpc3RpbmcgaGV4IGdlbmVyYXRpb24gbG9naWMgYnV0IGF0dGFjaCB0byBncm91cAogICAgICAgIGNvbnN0IGhleFRleCA9ICgoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICAgICAgYy53aWR0aCA9IDUxMjsgYy5oZWlnaHQgPSA1MTI7CiAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLDAsNTEyLDUxMik7CiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDAsIDI1NSwgMjU1LCAwLjUpJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgIGNvbnN0IHIgPSA2NDsKICAgICAgICAgICAgY29uc3QgdyA9IHIgKiAyOwogICAgICAgICAgICBjb25zdCBoID0gTWF0aC5zcXJ0KDMpICogcjsKICAgICAgICAgICAgZm9yKGxldCB5ID0gLTE7IHkgPCA1MTIvaCArIDI7IHkrKykgewogICAgICAgICAgICAgICAgZm9yKGxldCB4ID0gLTE7IHggPCA1MTIvKHcqMC43NSkgKyAyOyB4KyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjeCA9IHggKiB3ICogMC43NTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjeSA9IHkgKiBoICsgKHglMj09PTAgPyAwIDogaC8yKTsKICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8NjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZyA9IE1hdGguUEkvMyAqIGk7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oY3ggKyBNYXRoLmNvcyhhbmcpKnIsIGN5ICsgTWF0aC5zaW4oYW5nKSpyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICAgICAgfSkoKTsKICAgICAgICBoZXhUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBoZXhUZXgud3JhcFQgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBoZXhUZXgucmVwZWF0LnNldCg0LCAyKTsKCiAgICAgICAgY29uc3QgYXJlbmFVbmlmb3JtcyA9IFRIUkVFLlVuaWZvcm1zVXRpbHMubWVyZ2UoWwogICAgICAgICAgICBUSFJFRS5Vbmlmb3Jtc0xpYlsnY29tbW9uJ10sCiAgICAgICAgICAgIF9hcmVuYVVuaWZvcm1zLAogICAgICAgICAgICB7IAogICAgICAgICAgICAgICAgdE1hcDogeyB2YWx1ZTogaGV4VGV4IH0sCiAgICAgICAgICAgICAgICB1T3BhY2l0eTogeyB2YWx1ZTogMC4xIH0gCiAgICAgICAgICAgIH0KICAgICAgICBdKTsKCiAgICAgICAgY29uc3QgbWF0ZXJpYWwyID0gbmV3IFRIUkVFLlNoYWRlck1hdGVyaWFsKHsKICAgICAgICAgICAgdW5pZm9ybXM6IGFyZW5hVW5pZm9ybXMsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IGAKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVRpbWU7CiAgICAgICAgICAgICAgICB1bmlmb3JtIHZlYzMgdUltcGFjdFBvczsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUltcGFjdFN0cjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdlV2ID0gdXY7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkaXN0ID0gZGlzdGFuY2UocG9zLCB1SW1wYWN0UG9zKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYWRpdXMgPSAyMC4wOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSBkaXN0IC8gcmFkaXVzOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBidWxnZSA9ICgxLjAgLSB0KSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBub3JtYWwgPSBub3JtYWxpemUocG9zKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zICs9IG5vcm1hbCAqIChidWxnZSAqIHVJbXBhY3RTdHIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KHBvcywgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYCwKICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGAKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHRNYXA7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVJbXBhY3RTdHI7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVPcGFjaXR5OwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWM0IHRleENvbG9yID0gdGV4dHVyZTJEKHRNYXAsIHZVdik7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYWxwaGEgPSB1T3BhY2l0eSAqIHRleENvbG9yLmE7CiAgICAgICAgICAgICAgICAgICAgYWxwaGEgKz0gdUltcGFjdFN0ciAqIDAuMDI7IAogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB0ZXhDb2xvci5yZ2IgKiB2ZWMzKDAuMiwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGFscGhhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYAogICAgICAgIH0pOwoKICAgICAgICBjb25zdCBhcmVuYTIgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwyKTsKICAgICAgICBhcmVuYTIuc2NhbGUuc2V0U2NhbGFyKDAuOTgpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAuYWRkKGFyZW5hMik7CiAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMiA9IGFyZW5hMjsKCiAgICAgICAgLy8gLS0tIDMuIFRSSUJBTCBTVFJJUCAoRXF1YXRvcikgLS0tCiAgICAgICAgY29uc3QgdHJpYmFsVGV4ID0gKCgpID0+IHsKICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICBjLndpZHRoID0gMTAyNDsgYy5oZWlnaHQgPSAxMjg7CiAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLDAsMTAyNCwxMjgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQmFja2dyb3VuZCBQYXR0ZXJuCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjEpJzsKICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDEwLCAxMDI0LCAxMDgpOwoKICAgICAgICAgICAgLy8gRGV0YWlsZWQgVHJpYmFsIEdseXBocwogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgICAgICBjb25zdCBibG9ja1cgPSA2NDsKICAgICAgICAgICAgZm9yKGxldCB4PTA7IHg8MTAyNDsgeCs9YmxvY2tXKSB7CiAgICAgICAgICAgICAgICAvLyBPdXRlciBCb3gKICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCh4KzQsIDE1LCBibG9ja1ctOCwgOTgpOwogICAgICAgICAgICAgICAgLy8gSW5uZXIgQ3V0CiAgICAgICAgICAgICAgICBjdHguY2xlYXJSZWN0KHgrMTIsIDI1LCBibG9ja1ctMjQsIDc4KTsKICAgICAgICAgICAgICAgIC8vIENlbnRlciBEb3QKICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCh4KzI4LCA1MCwgOCwgMjgpOwogICAgICAgICAgICAgICAgLy8gQ29ubmVjdG9ycwogICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KHgsIDYwLCAxMiwgOCk7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoeCtibG9ja1ctMTIsIDYwLCAxMiwgOCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIH0pKCk7CiAgICAgICAgdHJpYmFsVGV4LndyYXBTID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgdHJpYmFsVGV4LndyYXBUID0gVEhSRUUuQ2xhbXBUb0VkZ2VXcmFwcGluZzsKICAgICAgICB0cmliYWxUZXgucmVwZWF0LnNldCg0LCAxKTsKCiAgICAgICAgLy8gQ3VzdG9tIFNoYWRlciBmb3IgQ29sb3IgU2hpZnRpbmcKICAgICAgICB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3JtcyA9IHsKICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgdUNvbG9yOiB7IHZhbHVlOiBuZXcgVEhSRUUuQ29sb3IoMHgwMGZmZmYpIH0sIC8vIERlZmF1bHQgQ3lhbgogICAgICAgICAgICB0VGV4OiB7IHZhbHVlOiB0cmliYWxUZXggfQogICAgICAgIH07CgogICAgICAgIGNvbnN0IHRyaWJhbE1hdCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgIHVuaWZvcm1zOiB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3JtcywKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdlV2OwogICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgIHZVdiA9IHV2OwogICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAsCiAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMzIHVDb2xvcjsKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHRUZXg7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdlV2OwogICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgIHZlYzQgdGV4ID0gdGV4dHVyZTJEKHRUZXgsIHZlYzIodlV2LnggKiAyLjAgKyB1VGltZSAqIDAuMDUsIHZVdi55KSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYWxwaGEgPSB0ZXguYSAqIDAuODsKICAgICAgICAgICAgICAgICAgICAvLyBQdWxzZQogICAgICAgICAgICAgICAgICAgIGZsb2F0IHB1bHNlID0gMC44ICsgMC4yICogc2luKHVUaW1lICogMi4wICsgdlV2LnggKiAxMC4wKTsKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KHVDb2xvciAqIHB1bHNlLCBhbHBoYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgdHJpYmFsR2VvID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTUsIF9jb25maWcuYXJlbmFSYWRpdXMgKiAwLjk1LCAxMiwgNjQsIDEsIHRydWUpOwogICAgICAgIGNvbnN0IHRyaWJhbE1lc2ggPSBuZXcgVEhSRUUuTWVzaCh0cmliYWxHZW8sIHRyaWJhbE1hdCk7CiAgICAgICAgdHJpYmFsTWVzaC5yb3RhdGlvbi54ID0gMDsgLy8gVXByaWdodCBjeWxpbmRlciBtYXRjaGVzIHNwaGVyZSBlcXVhdG9yCiAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5hZGQodHJpYmFsTWVzaCk7CgogICAgICAgIC8vIC0tLSA0LiBIT09LRUQgQVJST1dTIChBYm92ZS9CZWxvdyBTdHJpcCkgLS0tCiAgICAgICAgY29uc3QgYXJyb3dUZXggPSAoKCkgPT4gewogICAgICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgICAgIGMud2lkdGggPSA1MTI7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLDAsNTEyLDY0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKICAgICAgICAgICAgY3R4LnNoYWRvd0JsdXIgPSA1OwogICAgICAgICAgICBjdHguc2hhZG93Q29sb3IgPSAnI2ZmZmZmZic7CgogICAgICAgICAgICBjb25zdCBzdGVwID0gNjQ7CiAgICAgICAgICAgIGZvcihsZXQgeD0wOyB4PDUxMjsgeCs9c3RlcCkgewogICAgICAgICAgICAgICAgLy8gRG91YmxlIEhvb2sgQXJyb3cKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgIC8vIFRvcCBIb29rCiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHgrMjAsIDEwKTsgY3R4LmxpbmVUbyh4KzMyLCAyMCk7IGN0eC5saW5lVG8oeCs0NCwgMTApOwogICAgICAgICAgICAgICAgLy8gU2hhZnQKICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oeCszMiwgMjApOyBjdHgubGluZVRvKHgrMzIsIDQ0KTsKICAgICAgICAgICAgICAgIC8vIEJvdHRvbSBIb29rCiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHgrMjAsIDU0KTsgY3R4LmxpbmVUbyh4KzMyLCA0NCk7IGN0eC5saW5lVG8oeCs0NCwgNTQpOwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICB9KSgpOwogICAgICAgIGFycm93VGV4LndyYXBTID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgYXJyb3dUZXgucmVwZWF0LnNldCg0LCAxKTsKCiAgICAgICAgY29uc3QgYXJyb3dNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGFycm93VGV4LAogICAgICAgICAgICBjb2xvcjogMHgwMGZmZmYsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjYsCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwoKICAgICAgICAvLyBUb3AgUmluZwogICAgICAgIGNvbnN0IGFycm93R2VvVG9wID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTIsIF9jb25maWcuYXJlbmFSYWRpdXMgKiAwLjkyLCA4LCA2NCwgMSwgdHJ1ZSk7CiAgICAgICAgY29uc3QgYXJyb3dNZXNoVG9wID0gbmV3IFRIUkVFLk1lc2goYXJyb3dHZW9Ub3AsIGFycm93TWF0KTsKICAgICAgICBhcnJvd01lc2hUb3AucG9zaXRpb24ueSA9IDEyOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAuYWRkKGFycm93TWVzaFRvcCk7CgogICAgICAgIC8vIEJvdHRvbSBSaW5nCiAgICAgICAgY29uc3QgYXJyb3dNZXNoQm90ID0gbmV3IFRIUkVFLk1lc2goYXJyb3dHZW9Ub3AsIGFycm93TWF0KTsKICAgICAgICBhcnJvd01lc2hCb3QucG9zaXRpb24ueSA9IC0xMjsKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYUdyb3VwLmFkZChhcnJvd01lc2hCb3QpOwoKICAgICAgICAvLyAtLS0gNS4gVE9QIEdMWVBIUyAoRG9tZSkgLS0tCiAgICAgICAgY29uc3QgdG9wR2x5cGhUZXggPSAoKCkgPT4gewogICAgICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgICAgIGMud2lkdGggPSA1MTI7IGMuaGVpZ2h0ID0gNTEyOwogICAgICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgIGN0eC5jbGVhclJlY3QoMCwwLDUxMiw1MTIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMTAwLCAyMDAsIDI1NSwgMC41KSc7CiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoMjU2LCAyNTYsIDIwMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW50cmljYXRlIHBhdHRlcm4KICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ODsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhID0gKGkvOCkqTWF0aC5QSSoyOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IDI1NiArIE1hdGguY29zKGEpKjE1MDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAyNTYgKyBNYXRoLnNpbihhKSoxNTA7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIDQwLCAwLCBNYXRoLlBJKjIpOwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgLy8gQ29ubmVjdG9yCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKDI1NiwgMjU2KTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCwgeSk7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIH0pKCk7CgogICAgICAgIGNvbnN0IHRvcEdseXBoTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiB0b3BHbHlwaFRleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuNCwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHRvcEdseXBoR2VvID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoNjAsIDYwKTsKICAgICAgICBjb25zdCB0b3BHbHlwaCA9IG5ldyBUSFJFRS5NZXNoKHRvcEdseXBoR2VvLCB0b3BHbHlwaE1hdCk7CiAgICAgICAgdG9wR2x5cGgucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICB0b3BHbHlwaC5wb3NpdGlvbi55ID0gMzU7IC8vIE5lYXIgdG9wIG9mIGRvbWUKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYUdyb3VwLmFkZCh0b3BHbHlwaCk7CgogICAgICAgIC8vIC0tLSBORVc6IEZGWCBHT0FMIE1PREVMUyAtLS0KICAgICAgICBjb25zdCBnb2FsVXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hNTE2YmQ5MGZhN2M0ZGVkYjVkY2JmZGY4MDNmMTNkNS5nbGInOwogICAgICAgIAogICAgICAgIGNvbnN0IG9uR29hbExvYWRlZCA9IChtb2RlbCwgaXNGYWxsYmFjaykgPT4gewogICAgICAgICAgICBjb25zdCBnb2FsQSA9IG1vZGVsOwogICAgICAgICAgICAvLyBNb3ZlZCBkb3duIH4xNWZ0ICg0LjVtKSB0b3RhbCBhcyByZXF1ZXN0ZWQsIHB1c2hlZCBiYWNrIHRvIGVkZ2UKICAgICAgICAgICAgZ29hbEEucG9zaXRpb24uc2V0KDAsIC00LjUsIC00Nik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWlzRmFsbGJhY2spIHsKICAgICAgICAgICAgICAgIGdvYWxBLnNjYWxlLnNldFNjYWxhcig1NC4wKTsgLy8gSW5jcmVhc2VkIDUwJSAod2FzIDM2LjApCiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU2V0dXAgR29hbCBBCiAgICAgICAgICAgIGdvYWxBLnRyYXZlcnNlKGMgPT4gewogICAgICAgICAgICAgICAgaWYoYy5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICBjLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsgLy8gQ1JJVElDQUw6IFByZXZlbnQgY3VsbGluZwogICAgICAgICAgICAgICAgICAgIGMucmVuZGVyT3JkZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBtYXRlcmlhbCBpcyB2aXNpYmxlCiAgICAgICAgICAgICAgICAgICAgaWYgKGMubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZmZmZmYpOyAvLyBXaGl0ZSB0byBzaG93IG9yaWdpbmFsIHRleHR1cmUvY29sb3JzICh3YXMgYmx1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC50cmFuc3BhcmVudCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuc2lkZSA9IFRIUkVFLkRvdWJsZVNpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhUZXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyBBZGQgZ29hbHMgdG8gU0NFTkUsIG5vdCBhcmVuYUdyb3VwICh0aGV5IHNob3VsZG4ndCByb3RhdGUgd2l0aCB0aGUgc3BoZXJlKQogICAgICAgICAgICBfc2NlbmUuYWRkKGdvYWxBKTsKCiAgICAgICAgICAgIC8vIFNldHVwIEdvYWwgQgogICAgICAgICAgICBjb25zdCBnb2FsQiA9IGlzRmFsbGJhY2sgPyBnb2FsQS5jbG9uZSgpIDogVEhSRUUuU2tlbGV0b25VdGlscy5jbG9uZShnb2FsQSk7CgogICAgICAgICAgICBnb2FsQi5wb3NpdGlvbi5zZXQoMCwgLTQuNSwgNDYpOyAvLyBNb3ZlZCBjbG9zZXIgKHdhcyA0NSkgYW5kIGRvd24KICAgICAgICAgICAgZ29hbEIucm90YXRpb24ueSA9IE1hdGguUEk7CiAgICAgICAgICAgIC8vIEVuc3VyZSBHb2FsIEIgbWVzaGVzIGFyZSBhbHNvIHBlcnNpc3RlbnQKICAgICAgICAgICAgZ29hbEIudHJhdmVyc2UoYyA9PiB7CiAgICAgICAgICAgICAgICBpZihjLmlzTWVzaCkgYy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgX3NjZW5lLmFkZChnb2FsQik7CiAgICAgICAgfTsKCiAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKGdvYWxVcmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgIG9uR29hbExvYWRlZChnbHRmLnNjZW5lLCBmYWxzZSk7CiAgICAgICAgfSwgdW5kZWZpbmVkLCAoZXJyKSA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiR29hbCBtb2RlbCBmYWlsZWQgdG8gbG9hZC4gVXNpbmcgZmFsbGJhY2suIiwgZXJyKTsKICAgICAgICAgICAgY29uc3QgZ2VvID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KDc1LCA0NSwgMTApOyAvLyBGYWxsYmFjayBtYXNzaXZlIGJveCAoU2NhbGVkIDEuNXgpCiAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZmZmLCB3aXJlZnJhbWU6IHRydWUgfSk7CiAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrID0gbmV3IFRIUkVFLk1lc2goZ2VvLCBmYWxsYmFja01hdCk7CiAgICAgICAgICAgIG9uR29hbExvYWRlZChmYWxsYmFjaywgdHJ1ZSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIC0tLSBORVc6IE1BU1NJVkUgRklFTEQgTUFSS0lOR1MgLS0tCiAgICAgICAgY3JlYXRlRmllbGRNYXJraW5ncygpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlRmllbGRNYXJraW5ncygpIHsKICAgICAgICBjb25zdCBzaXplID0gMTAyNDsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IHNpemU7IGMuaGVpZ2h0ID0gc2l6ZTsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgY3ggPSBzaXplLzI7IGNvbnN0IGN5ID0gc2l6ZS8yOwoKICAgICAgICBjb25zdCBkcmF3ID0gKCkgPT4gewogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIHNpemUsIHNpemUpOwoKICAgICAgICAgICAgLy8gR2xvdyBTZXR0aW5ncwogICAgICAgICAgICBjdHguc2hhZG93Qmx1ciA9IDE1OwogICAgICAgICAgICBjdHguc2hhZG93Q29sb3IgPSAnIzAwZmZmZic7CiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDEwMCwgMjU1LCAyNTUsIDAuOSknOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICAgICAgY3R4LmxpbmVDYXAgPSAncm91bmQnOwoKICAgICAgICAgICAgLy8gMS4gT3V0ZXIgUnVuaWMgUmluZwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoY3gsIGN5LCA0ODAsIDAsIE1hdGguUEkqMik7CiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKCiAgICAgICAgICAgIC8vIDIuIENvbXBsZXggR2VvbWV0cmljIFN0YXIgKFRoZSAiQ29vbCBCaWcgR2x5cGgiKQogICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICBjdHgudHJhbnNsYXRlKGN4LCBjeSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMYXllciBBOiAzIE92ZXJsYXBwaW5nIFNxdWFyZXMgKDEyIHBvaW50cykKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwgMjAwLCAyNTUsIDAuNiknOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMjsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzsgaSsrKSB7CiAgICAgICAgICAgICAgICBjdHgucm90YXRlKE1hdGguUEkgLyA2KTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2VSZWN0KC0zNTAsIC0zNTAsIDcwMCwgNzAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTGF5ZXIgQjogSW5uZXIgQ2lyY2xlcwogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgxMDAsIDI1NSwgMjU1LCAwLjgpJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDU7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYygwLCAwLCAzMjAsIDAsIE1hdGguUEkqMik7IGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDAsIDAsIDEwMCwgMCwgTWF0aC5QSSoyKTsgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgLy8gTGF5ZXIgQzogQ2VudHJhbCBFbWJsZW0gKEJsaXR6YmFsbC1pc2gpCiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbygwLCAtODApOyBjdHgubGluZVRvKDYwLCA0MCk7IGN0eC5saW5lVG8oLTYwLCA0MCk7IGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oMCwgODApOyBjdHgubGluZVRvKC02MCwgLTQwKTsgY3R4LmxpbmVUbyg2MCwgLTQwKTsgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICBjdHgucmVzdG9yZSgpOwoKICAgICAgICAgICAgLy8gMy4gTWlkZmllbGQgTGluZQogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjUpJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDM7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbygwLCBjeSk7IGN0eC5saW5lVG8oc2l6ZSwgY3kpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyA0LiBHb2FsIEJveGVzIChUcmFwZXpvaWRzKQogICAgICAgICAgICBjb25zdCBkcmF3R29hbEJveCA9ICh5UG9zLCBkaXIpID0+IHsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3ggLSAxNTAsIHlQb3MpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIDE1MCwgeVBvcyk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgMjI1LCB5UG9zICsgKGRpciAqIDEyMCkpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCAtIDIyNSwgeVBvcyArIChkaXIgKiAxMjApKTsKICAgICAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgZHJhd0dvYWxCb3goNTAsIDEpOyAvLyBUb3AKICAgICAgICAgICAgZHJhd0dvYWxCb3goc2l6ZS01MCwgLTEpOyAvLyBCb3R0b20KCiAgICAgICAgICAgIC8vIDUuIFJ1bmVzIFRleHQgUmluZwogICAgICAgICAgICBjdHguZm9udCA9ICczNnB4IFNwaXJhLCBtb25vc3BhY2UnOyAKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICdyZ2JhKDAsIDI1NSwgMjU1LCAwLjgpJzsKICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBydW5lcyA9ICJZRVZPTiBTSU4gWkFOQVJLQU5EIEVURVJOQUwgQ0FMTSBTUEhFUkUgUE9PTCBCTElUWiBBQ0UgIjsKICAgICAgICAgICAgY29uc3QgcnVuZUNvdW50ID0gNDA7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHJ1bmVDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gcnVuZUNvdW50KSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgY29uc3QgciA9IDQ0MDsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBjeCArIE1hdGguY29zKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gY3kgKyBNYXRoLnNpbihhbmdsZSkgKiByOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICAgICAgY3R4LnRyYW5zbGF0ZSh4LCB5KTsKICAgICAgICAgICAgICAgIGN0eC5yb3RhdGUoYW5nbGUgKyBNYXRoLlBJLzIpOwogICAgICAgICAgICAgICAgY29uc3QgY2hhciA9IHJ1bmVzW2kgJSBydW5lcy5sZW5ndGhdOwogICAgICAgICAgICAgICAgY3R4LmZpbGxUZXh0KGNoYXIsIDAsIDApOwogICAgICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8vIEF0dGVtcHQgdG8gbG9hZCBmb250IGZpcnN0CiAgICAgICAgZG9jdW1lbnQuZm9udHMubG9hZCgnMzZweCBTcGlyYScpLnRoZW4oKCkgPT4gewogICAgICAgICAgICBkcmF3KCk7CiAgICAgICAgfSkuY2F0Y2goKCkgPT4gewogICAgICAgICAgICBkcmF3KCk7CiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHRleC5hbmlzb3Ryb3B5ID0gMTY7CgogICAgICAgIC8vIEZsb29yIFBsYW5lIChEZWVwKQogICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDkwLCA5MCk7CiAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiB0ZXgsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjksCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZwogICAgICAgIH0pOwoKICAgICAgICBjb25zdCBmaWVsZCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgbWF0KTsKICAgICAgICBmaWVsZC5yb3RhdGlvbi54ID0gLU1hdGguUEkgLyAyOwogICAgICAgIGZpZWxkLnBvc2l0aW9uLnkgPSAtOC4wOyAvLyBTdW5rIGRlZXAKICAgICAgICBfc2NlbmUuYWRkKGZpZWxkKTsKICAgIH0KCmZ1bmN0aW9uIGNyZWF0ZUhvbG9ncmFwaGljUmluZ3MoKSB7CiAgICAgICAgLy8gRmxvYXRpbmcgSG9sb2dyYXBoaWMgUmluZ3MgKE1pZC1oZWlnaHQpCiAgICAgICAgY29uc3QgcmluZ0dlbyA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KDIwLCAwLjEsIDE2LCAxMDApOwogICAgICAgIGNvbnN0IHJpbmdNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgwMGZmZmYsIHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjMsIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nIH0pOwogICAgICAgIGNvbnN0IHJpbmcxID0gbmV3IFRIUkVFLk1lc2gocmluZ0dlbywgcmluZ01hdCk7CiAgICAgICAgcmluZzEucm90YXRpb24ueCA9IE1hdGguUEkgLyAyOwogICAgICAgIHJpbmcxLnBvc2l0aW9uLnkgPSAwOwogICAgICAgIF9zY2VuZS5hZGQocmluZzEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHJpbmcyID0gbmV3IFRIUkVFLk1lc2gocmluZ0dlbywgcmluZ01hdCk7CiAgICAgICAgcmluZzIucm90YXRpb24ueCA9IE1hdGguUEkgLyAyOwogICAgICAgIHJpbmcyLnNjYWxlLnNldFNjYWxhcigxLjIpOwogICAgICAgIHJpbmcyLnBvc2l0aW9uLnkgPSA0LjA7CiAgICAgICAgX3NjZW5lLmFkZChyaW5nMik7CgogICAgICAgIC8vIEFuaW1hdGUgUmluZ3MgKGludGVncmF0ZWQgaW50byBtYWluIGxvb3AgdG8gYXZvaWQgYSBzZWNvbmQgUkFGIG9uIG1vYmlsZSkKICAgICAgICBsZXQgX3JpbmdUaW1lID0gMDsKICAgICAgICBjb25zdCBfcmluZ1VwZGF0ZSA9IChkdCkgPT4gewogICAgICAgICAgICBfcmluZ1RpbWUgKz0gZHQ7CiAgICAgICAgICAgIGlmIChyaW5nMSkgewogICAgICAgICAgICAgICAgcmluZzEucm90YXRpb24ueiArPSBkdCAqIDAuOTsKICAgICAgICAgICAgICAgIHJpbmcxLnNjYWxlLnNldFNjYWxhcigxLjAgKyBNYXRoLnNpbihfcmluZ1RpbWUgKiAwLjUpICogMC4wNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJpbmcyKSB7CiAgICAgICAgICAgICAgICByaW5nMi5yb3RhdGlvbi56IC09IGR0ICogMC43NTsKICAgICAgICAgICAgICAgIHJpbmcyLnBvc2l0aW9uLnkgPSA0LjAgKyBNYXRoLmNvcyhfcmluZ1RpbWUgKiAwLjcpICogMS4wOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycykgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycy5wdXNoKF9yaW5nVXBkYXRlKTsKICAgIH0KCiAgICAvLyAtLS0gSU5QVVQgU1lTVEVNIC0tLQovLyAtLS0gSU5QVVQgU1lTVEVNIC0tLQpjb25zdCBfa2V5cyA9IHt9OwovLyBHbG9iYWxzIG1vdmVkIHRvIGJlbG93IGhlbHBlcgoKICAgIC8vIEhlbHBlcjogQW5hbHl6ZSBjdXJ2ZSBnZW9tZXRyeSBmb3IgYW5hbG9nIGNvbnRyb2wKICAgIGNvbnN0IGFuYWx5emVTd2lwZUN1cnZlID0gKHBvaW50cykgPT4gewogICAgICAgIGlmIChwb2ludHMubGVuZ3RoIDwgMykgcmV0dXJuIHsgaW50ZW5zaXR5OiAwLCBzcGVlZDogMCwgZHg6IDAsIGR5OiAwIH07CiAgICAgICAgCiAgICAgICAgY29uc3QgcFN0YXJ0ID0gcG9pbnRzWzBdOwogICAgICAgIGNvbnN0IHBFbmQgPSBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDFdOwogICAgICAgIGNvbnN0IG1pZElkeCA9IE1hdGguZmxvb3IocG9pbnRzLmxlbmd0aCAvIDIpOwogICAgICAgIGNvbnN0IHBNaWQgPSBwb2ludHNbbWlkSWR4XTsKCiAgICAgICAgY29uc3QgZHggPSBwRW5kLnggLSBwU3RhcnQueDsKICAgICAgICBjb25zdCBkeSA9IHBFbmQueSAtIHBTdGFydC55OwogICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CiAgICAgICAgY29uc3QgZHQgPSBwRW5kLnQgLSBwU3RhcnQudDsKICAgICAgICBjb25zdCBzcGVlZCA9IChkdCA+IDApID8gZGlzdCAvIGR0IDogMDsgLy8gcHgvbXMKCiAgICAgICAgaWYgKGRpc3QgPCA1MCkgcmV0dXJuIHsgaW50ZW5zaXR5OiAwLCBzcGVlZDogc3BlZWQsIGR4LCBkeSB9OwoKICAgICAgICBjb25zdCB2U01feCA9IHBNaWQueCAtIHBTdGFydC54OwogICAgICAgIGNvbnN0IHZTTV95ID0gcE1pZC55IC0gcFN0YXJ0Lnk7CgogICAgICAgIC8vIENyb3NzIHByb2R1Y3QgZ2l2ZXMgc2lnbmVkIGFyZWEvY3VydmF0dXJlIGRpcmVjdGlvbgogICAgICAgIGNvbnN0IGNyb3NzID0gKGR4ICogdlNNX3kpIC0gKGR5ICogdlNNX3gpOwogICAgICAgIC8vIE5vcm1hbGl6ZSBieSBkaXN0YW5jZSBzcXVhcmVkIHRvIGdldCBhIGN1cnZhdHVyZSByYXRpbyBpbmRlcGVuZGVudCBvZiBzY2FsZQpjb25zdCBpbnRlbnNpdHkgPSBjcm9zcyAvIChkaXN0ICogZGlzdCk7CgogICAgICAgIHJldHVybiB7IGludGVuc2l0eSwgc3BlZWQsIGR4LCBkeSB9OwogICAgfTsKICAgIGxldCBfc3dpcGVQb2ludHMgPSBbXTsgLy8gVHJhY2sgc3dpcGUgaGlzdG9yeSBmb3IgY3VydmVzCiAgICBjb25zdCBfYWltSW5wdXQgPSB7IHg6IDAsIHk6IDAsIGFjdGl2ZTogZmFsc2UgfTsgLy8gTkVXOiBBaW0gam95c3RpY2sKCiAgICBjb25zdCBfYWN0aW9uQnVmZmVyID0geyBhY3RpdmU6IGZhbHNlLCB0aW1lc3RhbXA6IDAsIGR1cmF0aW9uOiAzMDAgfTsKCiAgICBjb25zdCBfY2FtRndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1SaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdXBBeGlzID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CgogICAgZnVuY3Rpb24gc2V0dXBJbnB1dHMoKSB7CiAgICAgICAgLy8gS2V5Ym9hcmQKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgIF9rZXlzW2Uua2V5XSA9IHRydWU7CiAgICAgICAgICAgIGlmIChlLmNvZGUgPT09ICdTcGFjZScgJiYgX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIgJiYgX2JhbGwpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIudGhyb3dCYWxsKF9iYWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBORVc6IFRhY2tsZSBvbiBTaGlmdAogICAgICAgICAgICBpZiAoZS5jb2RlID09PSAnU2hpZnRMZWZ0JyB8fCBlLmNvZGUgPT09ICdTaGlmdFJpZ2h0JykgewogICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5kYXNoKHAuaW5wdXRWZWN0b3IueCwgcC5pbnB1dFZlY3Rvci56KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9KTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5dXAnLCAoZSkgPT4geyBfa2V5c1tlLmtleV0gPSBmYWxzZTsgdXBkYXRlSW5wdXRWZWN0b3IoKTsgfSk7CgogICAgICAgIC8vIC0tLSBGTE9BVElORyBKT1lTVElDSyAoTW92ZW1lbnQpIC0tLQogICAgICAgIGNvbnN0IGhpdFpvbmUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2staGl0LXpvbmUnKTsKICAgICAgICBjb25zdCB2aXN1YWxzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2pveXN0aWNrLXZpc3VhbC1jb250YWluZXInKTsKICAgICAgICBjb25zdCBiYXNlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2pveXN0aWNrLWJhc2UnKTsKICAgICAgICBjb25zdCBrbm9iID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2pveXN0aWNrLWtub2InKTsKCiAgICAgICAgbGV0IHN0YXJ0WCA9IDAsIHN0YXJ0WSA9IDA7CiAgICAgICAgbGV0IGRyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgY29uc3QgbWF4RGlzdCA9IDQwOwoKICAgICAgICBsZXQgbW92ZVRvdWNoSWQgPSBudWxsOwogICAgICAgIGNvbnN0IG1vdmVEZWFkem9uZVB4ID0gNjsKCiAgICAgICAgLy8gRXhwb3NlIG1vdmUgam95c3RpY2sgc3RhdGUgZm9yIHNuYXBzaG90cwogICAgICAgIGNvbnN0IF9kYmcgPSB3aW5kb3cuZmx1eC5fZGVidWdJTyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIHx8IHt9OwogICAgICAgIF9kYmcuc2V0dGluZ3MgPSBfc2V0dGluZ3M7CiAgICAgICAgX2RiZy5pbnB1dCA9IF9kYmcuaW5wdXQgfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5tb3ZlID0gX2RiZy5pbnB1dC5tb3ZlIHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQubW92ZS52ZWN0b3IgPSBfaW5wdXQ7CiAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLmRyYWdnaW5nID0gZHJhZ2dpbmc7CiAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnRvdWNoSWQgPSBtb3ZlVG91Y2hJZDsKCgogICAgICAgIGNvbnN0IGhhbmRsZVN0YXJ0ID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgZHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICBzdGFydFggPSBjbGllbnRYOwoKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0Lm1vdmUpIHsKICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS5kcmFnZ2luZyA9IGRyYWdnaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzdGFydFkgPSBjbGllbnRZOwoKICAgICAgICAgICAgdmlzdWFscy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgdmlzdWFscy5zdHlsZS5sZWZ0ID0gYCR7Y2xpZW50WH1weGA7CiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUudG9wID0gYCR7Y2xpZW50WX1weGA7CgogICAgICAgICAgICBrbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoLTUwJSwgLTUwJSlgOwoKICAgICAgICAgICAgY3JlYXRlUmlwcGxlKGNsaWVudFgsIGNsaWVudFkpOwoKICAgICAgICAgICAgX2lucHV0LnggPSAwOwogICAgICAgICAgICBfaW5wdXQueSA9IDA7CiAgICAgICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgaGFuZGxlTW92ZSA9IChjbGllbnRYLCBjbGllbnRZKSA9PiB7CiAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKCiAgICAgICAgICAgIGxldCBkeCA9IGNsaWVudFggLSBzdGFydFg7CiAgICAgICAgICAgIGxldCBkeSA9IGNsaWVudFkgLSBzdGFydFk7CgogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwoKCiAgICAgICAgICAgIC8vIERlYWR6b25lIHRvIHByZXZlbnQgZHJpZnQgZnJvbSB0aW55IHRodW1iIGppdHRlcgogICAgICAgICAgICBpZiAoZGlzdCA8IG1vdmVEZWFkem9uZVB4KSB7CiAgICAgICAgICAgICAgICBkeCA9IDA7CiAgICAgICAgICAgICAgICBkeSA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkaXN0ID4gbWF4RGlzdCkgewogICAgICAgICAgICAgICAgZHggPSAoZHggLyBkaXN0KSAqIG1heERpc3Q7CiAgICAgICAgICAgICAgICBkeSA9IChkeSAvIGRpc3QpICogbWF4RGlzdDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAga25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKGNhbGMoLTUwJSArICR7ZHh9cHgpLCBjYWxjKC01MCUgKyAke2R5fXB4KSlgOwoKICAgICAgICAgICAgX2lucHV0LnggPSAoZHggLyBtYXhEaXN0KSAqIF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5OwogICAgICAgICAgICBfaW5wdXQueSA9IChkeSAvIG1heERpc3QpICogX3NldHRpbmdzLmpveXN0aWNrU2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgaGFuZGxlRW5kID0gKCkgPT4gewogICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgIGRyYWdnaW5nID0gZmFsc2U7CgogICAgICAgICAgICBtb3ZlVG91Y2hJZCA9IG51bGw7CgogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CgogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQubW92ZSkgewogICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLmRyYWdnaW5nID0gZHJhZ2dpbmc7CiAgICAgICAgICAgICAgICBfZGJnLmlucHV0Lm1vdmUudG91Y2hJZCA9IG1vdmVUb3VjaElkOwogICAgICAgICAgICB9CgoKICAgICAgICAgICAgX2lucHV0LnggPSAwOwogICAgICAgICAgICBfaW5wdXQueSA9IDA7CiAgICAgICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CiAgICAgICAgfTsKCiAgICAgICAgaWYgKGhpdFpvbmUpIHsKICAgICAgICAgICAgaGl0Wm9uZS5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzWzBdKSA/IGUuY2hhbmdlZFRvdWNoZXNbMF0gOiBlLnRvdWNoZXNbMF07CiAgICAgICAgICAgICAgICBtb3ZlVG91Y2hJZCA9IHQgPyB0LmlkZW50aWZpZXIgOiBudWxsOwogICAgICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0Lm1vdmUpIHsKICAgICAgICAgICAgICAgICAgICBfZGJnLmlucHV0Lm1vdmUudG91Y2hJZCA9IG1vdmVUb3VjaElkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaGFuZGxlU3RhcnQodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBtb3ZlVG91Y2hJZCk7CiAgICAgICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgICAgIGhhbmRsZU1vdmUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgbW92ZVRvdWNoSWQpOwogICAgICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47IC8vIElnbm9yZSBvdGhlciBmaW5nZXJzIGxpZnRpbmcKICAgICAgICAgICAgICAgIGhhbmRsZUVuZCgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgbW92ZVRvdWNoSWQpOwogICAgICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47CiAgICAgICAgICAgICAgICBoYW5kbGVFbmQoKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBoaXRab25lLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBoYW5kbGVTdGFydChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChkcmFnZ2luZykgaGFuZGxlTW92ZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGhhbmRsZUVuZCk7CiAgICAgICAgfQoKICAgICAgICAvLyAtLS0gTkVXOiBBSU0gSk9ZU1RJQ0sgKFJpZ2h0IHNpZGUpIC0tLQogICAgICAgIHNldHVwQWltSm95c3RpY2soKTsKCiAgICAgICAgLy8gLS0tIE5FVzogVEFDS0xFIEJVVFRPTiAtLS0KICAgICAgICBzZXR1cFRhY2tsZUJ1dHRvbigpOwoKICAgICAgICAvLyBTd2lwZSBEZXRlY3Rpb24KLy8gU3dpcGUgRGV0ZWN0aW9uCiAgICAgICAgbGV0IHN3aXBlU3RhcnQgPSB7IHg6IDAsIHk6IDAsIHQ6IDAgfTsKICAgICAgICBsZXQgc3dpcGVUb3VjaElkID0gbnVsbDsKICAgICAgICAKICAgICAgICAvLyBFeHBvc2Ugc3dpcGUvdGhyb3cgZ2VzdHVyZSBzdGF0ZSBmb3Igc25hcHNob3RzCiAgICAgICAgX2RiZy5pbnB1dC5zd2lwZSA9IF9kYmcuaW5wdXQuc3dpcGUgfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5zd2lwZS5zdGFydCA9IHN3aXBlU3RhcnQ7CiAgICAgICAgX2RiZy5pbnB1dC5zd2lwZS50b3VjaElkID0gc3dpcGVUb3VjaElkOwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUucG9pbnRzID0gX3N3aXBlUG9pbnRzOwpjb25zdCBvblN3aXBlU3RhcnQgPSAoeCwgeSkgPT4gewogICAgICAgICAgICBzd2lwZVN0YXJ0LnggPSB4OwogICAgICAgICAgICBzd2lwZVN0YXJ0LnkgPSB5OwogICAgICAgICAgICBzd2lwZVN0YXJ0LnQgPSBEYXRlLm5vdygpOwogICAgICAgICAgICBfc3dpcGVQb2ludHMgPSBbe3gsIHksIHQ6IERhdGUubm93KCl9XTsKICAgICAgICB9OwoKY29uc3Qgb25Td2lwZU1vdmUgPSAoeCwgeSkgPT4gewogICAgICAgICAgICBpZiAoX3N3aXBlUG9pbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIF9zd2lwZVBvaW50cy5wdXNoKHt4LCB5LCB0OiBEYXRlLm5vdygpfSk7CiAgICAgICAgICAgICAgICBjcmVhdGVTd2lwZVRyYWlsRG90KHgsIHkpOyAvLyBWaXN1YWwgRmVlZGJhY2sKICAgICAgICAgICAgfQogICAgICAgIH07Cgpjb25zdCBvblN3aXBlRW5kID0gKHgsIHkpID0+IHsKICAgICAgICAgICAgaWYgKF9zd2lwZVBvaW50cy5sZW5ndGggPCAyKSByZXR1cm47CiAgICAgICAgICAgIF9zd2lwZVBvaW50cy5wdXNoKHt4LCB5LCB0OiBEYXRlLm5vdygpfSk7CgogICAgICAgICAgICBjb25zdCB7IGludGVuc2l0eSwgc3BlZWQsIGR4LCBkeSB9ID0gYW5hbHl6ZVN3aXBlQ3VydmUoX3N3aXBlUG9pbnRzKTsKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllciAmJiBfY2FtZXJhKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgICAgICAvLyAtLS0gQ1VSVkUgQkFMTCBERVRFQ1RJT04gKEltbWVkaWF0ZSBUaHJvdykgLS0tCi8vIC0tLSBDVVJWRSBCQUxMIERFVEVDVElPTiAoSW1tZWRpYXRlIFRocm93KSAtLS0KICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgJiYgIXAuaXNUaHJvd2luZyAmJiAhcC5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQW5hbG9nIEN1cnZlIENoZWNrOiBUaHJlc2hvbGQgMC4yNSByZXF1aXJlcyBhIGRlbGliZXJhdGUgYXJjIChUaGUgIkZlYXQiKQogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhpbnRlbnNpdHkpID4gMC4yNSAmJiBkaXN0ID4gMTAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7IF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFggPSAoX2NhbVJpZ2h0LnggKiBkeCkgKyAoX2NhbUZ3ZC54ICogLWR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRaID0gKF9jYW1SaWdodC56ICogZHgpICsgKF9jYW1Gd2QueiAqIC1keSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRocm93RGlyID0gbmV3IFRIUkVFLlZlY3RvcjMod29ybGRYLCAwLCB3b3JsZFopLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTWFwIGludGVuc2l0eSB0byBzcGluIC0gRHJhc3RpY2FsbHkgcmVkdWNlZCBzZW5zaXRpdml0eQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByYXdTcGluID0gTWF0aC5hYnMoaW50ZW5zaXR5KSAqIDMwMC4wOyAKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BlZWRGYWN0b3IgPSBNYXRoLm1pbigxLjUsIHNwZWVkIC8gMS4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblBvd2VyID0gTWF0aC5taW4oNDAwLjAsIHJhd1NwaW4gKiBzcGVlZEZhY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5TaWduID0gTWF0aC5zaWduKGludGVuc2l0eSk7IAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3BpblBvd2VyICogc3BpblNpZ24sIDApOwoKCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0T3ZlcnJpZGVBaW0odGhyb3dEaXIueCwgdGhyb3dEaXIueik7CiAgICAgICAgICAgICAgICAgICAgICAgIHAudGhyb3dCYWxsKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsLCAnU0gnLCAxLjAsIHNwaW5WZWMpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNVUlZFIiwgcC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZVJpcHBsZSh4LCB5KTsKICAgICAgICAgICAgICAgICAgICAgICAgX3N3aXBlUG9pbnRzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIC0tLSBTVEFOREFSRCBEQVNIIC8gQUlNIC0tLQogICAgICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgICAgIGVsc2UgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwoKY29uc3Qgd29ybGRYMiA9IChfY2FtUmlnaHQueCAqIGR4KSArIChfY2FtRndkLnggKiAtZHkpOwogICAgICAgICAgICAgICAgY29uc3Qgd29ybGRaMiA9IChfY2FtUmlnaHQueiAqIGR4KSArIChfY2FtRndkLnogKiAtZHkpOwoKICAgICAgICAgICAgICAgIGlmIChwLmlzVGhyb3dpbmcpIHsKcC5zZXRPdmVycmlkZUFpbSh3b3JsZFgyLCB3b3JsZFoyKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJBSU0hIiwgcC5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CmlmIChkaXN0ID4gNTApIHAuZGFzaCh3b3JsZFgyLCB3b3JsZFoyKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjcmVhdGVSaXBwbGUoeCwgeSk7CiAgICAgICAgICAgIH0KX3N3aXBlUG9pbnRzID0gW107CiAgICAgICAgfTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCB0ID0gKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlc1swXSkgPyBlLmNoYW5nZWRUb3VjaGVzWzBdIDogZS50b3VjaGVzWzBdOwogICAgICAgICAgICBzd2lwZVRvdWNoSWQgPSB0ID8gdC5pZGVudGlmaWVyIDogbnVsbDsKLy8gb25Td2lwZVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsgLy8gRml4ZWQgc3ludGF4IGVycm9yCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5zd2lwZSkgeyBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7IH0KICAgICAgICAgICAgb25Td2lwZVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICAgICAgY3JlYXRlUmlwcGxlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdCA9IF9maW5kVG91Y2hCeUlkKGUudG91Y2hlcywgc3dpcGVUb3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgIG9uU3dpcGVNb3ZlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgc3dpcGVUb3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47IC8vIElnbm9yZSBvdGhlciBmaW5nZXJzIGxpZnRpbmcKICAgICAgICAgICAgb25Td2lwZUVuZCh0RW5kLmNsaWVudFgsIHRFbmQuY2xpZW50WSk7CiAgICAgICAgICAgIHN3aXBlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5zd2lwZSkgeyBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7IH0KICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCAoZSkgPT4gewppZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgc3dpcGVUb3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47IC8vIElnbm9yZSBvdGhlciBmaW5nZXJzIGxpZnRpbmcKICAgICAgICAgICAgb25Td2lwZUVuZCh0RW5kLmNsaWVudFgsIHRFbmQuY2xpZW50WSk7CiAgICAgICAgICAgIHN3aXBlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5zd2lwZSkgeyBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7IH0KICAgICAgICAKICAgICAgICB9KTsKLy8gTW91c2UgU3dpcGUKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwoKICAgICAgICAgICAgb25Td2lwZVN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgY3JlYXRlUmlwcGxlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpKSByZXR1cm47CiAgICAgICAgICAgIC8vIE9ubHkgdHJhY2sgaWYgbW91c2UgaXMgZG93biAoc2ltdWxhdGluZyBkcmFnKQogICAgICAgICAgICBpZiAoZS5idXR0b25zID09PSAxKSB7CiAgICAgICAgICAgICAgICBvblN3aXBlTW92ZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwogICAgICAgICAgICBvblN3aXBlRW5kKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gQWN0aW9uIEJ1dHRvbiAoU2hvb3QvUGFzcykKICAgICAgICBjb25zdCBhY3Rpb25CdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWJ1dHRvbicpOwoKY29uc3Qgc2V0dXBCdXR0b24gPSAoYnRuKSA9PiB7CiAgICAgICAgICAgIGlmICghYnRuKSByZXR1cm47CgogICAgICAgICAgICBsZXQgYnRuU3RhcnRYID0gMDsKICAgICAgICAgICAgbGV0IGJ0blN0YXJ0WSA9IDA7CiAgICAgICAgICAgIGxldCBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIGxldCBzd2lwZVBvaW50cyA9IFtdOwogICAgICAgICAgICBsZXQgYWN0aW9uVG91Y2hJZCA9IG51bGw7CgogICAgICAgICAgICBjb25zdCBhdHRlbXB0QWN0aW9uID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgJiYgIXAuaXNDaGFyZ2luZyAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcC5zdGFydENoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGNvbnN0IGhhbmRsZVN0YXJ0ID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci50ZWNoQ29weVN0YXRlLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci5hdHRlbXB0VGVjaENvcHkoKTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyksIDEwMCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmlzRGVtb01vZGUpIHJldHVybjsKCiAgICAgICAgICAgICAgICBsZXQgY2xpZW50WCA9IGUuY2xpZW50WDsKICAgICAgICAgICAgICAgIGxldCBjbGllbnRZID0gZS5jbGllbnRZOwogICAgICAgICAgICAgICAgaWYgKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gZS5jaGFuZ2VkVG91Y2hlc1swXTsKICAgICAgICAgICAgICAgICAgICBhY3Rpb25Ub3VjaElkID0gdC5pZGVudGlmaWVyOwogICAgICAgICAgICAgICAgICAgIGNsaWVudFggPSB0LmNsaWVudFg7CiAgICAgICAgICAgICAgICAgICAgY2xpZW50WSA9IHQuY2xpZW50WTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aW9uVG91Y2hJZCA9IG51bGw7IC8vIG1vdXNlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBidG5TdGFydFggPSBjbGllbnRYOwogICAgICAgICAgICAgICAgYnRuU3RhcnRZID0gY2xpZW50WTsKICAgICAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgc3dpcGVQb2ludHMgPSBbe3g6IGNsaWVudFgsIHk6IGNsaWVudFksIHQ6IERhdGUubm93KCl9XTsKCiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLnRpbWVzdGFtcCA9IERhdGUubm93KCk7CgogICAgICAgICAgICAgICAgaWYgKGF0dGVtcHRBY3Rpb24oKSkgewogICAgICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQXR0YWNoIGdsb2JhbCBsaXN0ZW5lcnMgdG8gdHJhY2sgc3dpcGUgb3V0c2lkZSBidXR0b24KICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBoYW5kbGVNb3ZlLCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlTW92ZSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBoYW5kbGVNb3ZlID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghaXNEcmFnZ2luZykgcmV0dXJuOwoKICAgICAgICAgICAgICAgIC8vIFRvdWNoIHBhdGggKG11bHRpLXRvdWNoIHNhZmUpCiAgICAgICAgICAgICAgICBpZiAoZS50b3VjaGVzICYmIGFjdGlvblRvdWNoSWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBhY3Rpb25Ub3VjaElkKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBzd2lwZVBvaW50cy5wdXNoKHt4OiB0LmNsaWVudFgsIHk6IHQuY2xpZW50WSwgdDogRGF0ZS5ub3coKX0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNb3VzZSBwYXRoCiAgICAgICAgICAgICAgICBjb25zdCBjbGllbnRYID0gZS5jbGllbnRYOwogICAgICAgICAgICAgICAgY29uc3QgY2xpZW50WSA9IGUuY2xpZW50WTsKICAgICAgICAgICAgICAgIHN3aXBlUG9pbnRzLnB1c2goe3g6IGNsaWVudFgsIHk6IGNsaWVudFksIHQ6IERhdGUubm93KCl9KTsKICAgICAgICAgICAgfTsKCmNvbnN0IGhhbmRsZUVuZCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgZHggPSAwOwogICAgICAgICAgICAgICAgbGV0IGR5ID0gMDsKICAgICAgICAgICAgICAgIGxldCB2YWxpZEVuZCA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIC8vIDEuIENoZWNrIFRvdWNoCiAgICAgICAgICAgICAgICBpZiAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBhY3Rpb25Ub3VjaElkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBhY3Rpb25Ub3VjaElkKTsKICAgICAgICAgICAgICAgICAgICBpZiAodEVuZCkgewogICAgICAgICAgICAgICAgICAgICAgICBkeCA9IHRFbmQuY2xpZW50WCAtIGJ0blN0YXJ0WDsKICAgICAgICAgICAgICAgICAgICAgICAgZHkgPSB0RW5kLmNsaWVudFkgLSBidG5TdGFydFk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkRW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIC8vIDIuIENoZWNrIE1vdXNlCiAgICAgICAgICAgICAgICBlbHNlIGlmICghZS5jaGFuZ2VkVG91Y2hlcyAmJiBpc0RyYWdnaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgZHggPSBlLmNsaWVudFggLSBidG5TdGFydFg7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBlLmNsaWVudFkgLSBidG5TdGFydFk7CiAgICAgICAgICAgICAgICAgICAgdmFsaWRFbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghdmFsaWRFbmQpIHJldHVybjsKCiAgICAgICAgICAgICAgICAvLyBDbGVhbnVwIGxpc3RlbmVycwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGhhbmRsZU1vdmUpOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlTW92ZSk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGhhbmRsZUVuZCk7CgogICAgICAgICAgICAgICAgaWYgKCFpc0RyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHdhc0J1ZmZlcmVkID0gX2FjdGlvbkJ1ZmZlci5hY3RpdmU7CiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEN1cnZlIEFuYWx5c2lzCiAgICAgICAgICAgICAgICAgICAgbGV0IGN1cnZlRGF0YSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgbGV0IHNwaW5WZWMgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgY3VydmUgaWYgd2UgaGF2ZSBlbm91Z2ggZGF0YQovLyBDYWxjdWxhdGUgY3VydmUgaWYgd2UgaGF2ZSBlbm91Z2ggZGF0YQogICAgICAgICAgICAgICAgICAgIGlmIChzd2lwZVBvaW50cy5sZW5ndGggPiAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuYWx5c2lzID0gYW5hbHl6ZVN3aXBlQ3VydmUoc3dpcGVQb2ludHMpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBIaWdoIHRocmVzaG9sZCBmb3IgYnV0dG9uIHJlbGVhc2UgdG9vCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhhbmFseXNpcy5pbnRlbnNpdHkpID4gMC4yNSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VydmVEYXRhID0gYW5hbHlzaXM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBzcGluIHZlY3RvciBmb3IgbW91c2UvdG91Y2ggdW5pZmllZCAoQ29uc2VydmF0aXZlIHZhbHVlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5Qb3dlciA9IE1hdGgubWluKDQwMC4wLCBNYXRoLmFicyhhbmFseXNpcy5pbnRlbnNpdHkpICogMTUwMC4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5TaWduID0gTWF0aC5zaWduKGFuYWx5c2lzLmludGVuc2l0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3BpblBvd2VyICogc3BpblNpZ24sIDApOwogICAgICAgICAgICAgICAgICAgICAgICB9Cn0KCiAgICAgICAgICAgICAgICAgICAgLy8gRVhFQ1VURQogICAgICAgICAgICAgICAgICAgIGlmIChwLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTm9ybWFsIFJlbGVhc2UKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNwaW5WZWMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFVuaWZpZWQgc3BpbiBwYXNzaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnJlbGVhc2VDaGFyZ2UoZHgsIGR5LCB7IGludGVuc2l0eTogY3VydmVEYXRhLmludGVuc2l0eSwgc3BlZWQ6IGN1cnZlRGF0YS5zcGVlZCB9KTsgCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnJlbGVhc2VDaGFyZ2UoZHgsIGR5LCBjdXJ2ZURhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHdhc0J1ZmZlcmVkICYmIHAuaGFzQmFsbCAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJ1ZmZlcmVkIFRhcCAoSW5zdGFudCBTaG90KQogICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3JjZSBzdGFydCBhbmQgcmVsZWFzZSBpbW1lZGlhdGVseQogICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXJ0Q2hhcmdlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucmVsZWFzZUNoYXJnZShkeCwgZHksIGN1cnZlRGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGhhbmRsZVN0YXJ0LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgaGFuZGxlU3RhcnQpOwogICAgICAgIH07CiAgICAgICAgc2V0dXBCdXR0b24oYWN0aW9uQnRuKTsKCi8vIEF1dG8gVG9nZ2xlCiAgICAgICAgY29uc3QgYXV0b0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhdXRvLXRvZ2dsZScpOwogICAgICAgIGlmIChhdXRvQnRuKSB7CiAgICAgICAgICAgIGNvbnN0IGhhbmRsZVRvZ2dsZSA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIudG9nZ2xlRGVtb01vZGUoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBhdXRvQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgaGFuZGxlVG9nZ2xlKTsKYXV0b0J0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIGhhbmRsZVRvZ2dsZSgpOwogICAgICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBTZXR0aW5ncyBCdXR0b24KICAgICAgICBzZXR1cFNldHRpbmdzQnV0dG9uKCk7CiAgICB9CgogICAgLy8gTkVXOiBBaW0gSm95c3RpY2sgU2V0dXAKLy8gTkVXOiBBaW0gSm95c3RpY2sgU2V0dXAKZnVuY3Rpb24gc2V0dXBBaW1Kb3lzdGljaygpIHsKICAgICAgICBjb25zdCBhaW1Lbm9iID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1qb3lzdGljay1rbm9iJyk7CiAgICAgICAgY29uc3QgYWltVmlzdWFscyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaW0tam95c3RpY2stdmlzdWFsJyk7CiAgICAgICAgY29uc3QgYWltWm9uZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaW0tam95c3RpY2stem9uZScpOwogICAgICAgIGlmICghYWltWm9uZSkgcmV0dXJuOwogICAgICAgIGxldCBhaW1TdGFydFggPSAwLCBhaW1TdGFydFkgPSAwOwogICAgICAgIGxldCBhaW1EcmFnZ2luZyA9IGZhbHNlOwogICAgICAgIGNvbnN0IGFpbU1heERpc3QgPSAzNTsKICAgICAgICBsZXQgYWltVG91Y2hJZCA9IG51bGw7CgogICAgICAgIAoKICAgICAgICAvLyBFeHBvc2UgYWltIGpveXN0aWNrIHN0YXRlIGZvciBzbmFwc2hvdHMKICAgICAgICBjb25zdCBfZGJnID0gd2luZG93LmZsdXguX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyB8fCB7fTsKICAgICAgICBfZGJnLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgICAgIF9kYmcuaW5wdXQgPSBfZGJnLmlucHV0IHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQuYWltID0gX2RiZy5pbnB1dC5haW0gfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5haW0udmVjdG9yID0gX2FpbUlucHV0OwogICAgICAgIF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7CiAgICAgICAgX2RiZy5pbnB1dC5haW0udG91Y2hJZCA9IGFpbVRvdWNoSWQ7CmNvbnN0IGhhbmRsZUFpbVN0YXJ0ID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgYWltRHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICBhaW1TdGFydFggPSBjbGllbnRYOwoKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS5kcmFnZ2luZyA9IGFpbURyYWdnaW5nOyB9CgogICAgICAgICAgICBhaW1TdGFydFkgPSBjbGllbnRZOwogICAgICAgICAgICBfYWltSW5wdXQuYWN0aXZlID0gdHJ1ZTsKCiAgICAgICAgICAgIGlmIChhaW1WaXN1YWxzKSB7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgYWltVmlzdWFscy5zdHlsZS5sZWZ0ID0gYCR7Y2xpZW50WH1weGA7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLnRvcCA9IGAke2NsaWVudFl9cHhgOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhaW1Lbm9iKSB7CiAgICAgICAgICAgICAgICBhaW1Lbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoLTUwJSwgLTUwJSlgOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgaGFuZGxlQWltTW92ZSA9IChjbGllbnRYLCBjbGllbnRZKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKCiAgICAgICAgICAgIGxldCBkeCA9IGNsaWVudFggLSBhaW1TdGFydFg7CiAgICAgICAgICAgIGxldCBkeSA9IGNsaWVudFkgLSBhaW1TdGFydFk7CgogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwoKICAgICAgICAgICAgaWYgKGRpc3QgPiBhaW1NYXhEaXN0KSB7CiAgICAgICAgICAgICAgICBkeCA9IChkeCAvIGRpc3QpICogYWltTWF4RGlzdDsKICAgICAgICAgICAgICAgIGR5ID0gKGR5IC8gZGlzdCkgKiBhaW1NYXhEaXN0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYWltS25vYikgewogICAgICAgICAgICAgICAgYWltS25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKGNhbGMoLTUwJSArICR7ZHh9cHgpLCBjYWxjKC01MCUgKyAke2R5fXB4KSlgOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBOb3JtYWxpemUgYW5kIHRyYW5zZm9ybSB0byB3b3JsZCBzcGFjZQogICAgICAgICAgICBfYWltSW5wdXQueCA9IGR4IC8gYWltTWF4RGlzdDsKICAgICAgICAgICAgX2FpbUlucHV0LnkgPSBkeSAvIGFpbU1heERpc3Q7CgogICAgICAgICAgICAvLyBBcHBseSBhaW0gdG8gcGxheWVyIGlmIGNoYXJnaW5nCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICAgICBpZiAocC5pc0NoYXJnaW5nIHx8IHAuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgICAgIC8vIFRyYW5zZm9ybSBzY3JlZW4gYWltIHRvIHdvcmxkIHNwYWNlCiAgICAgICAgICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgICAgICAgICBfY2FtRndkLnkgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFggPSAoX2NhbVJpZ2h0LnggKiBfYWltSW5wdXQueCkgKyAoX2NhbUZ3ZC54ICogLV9haW1JbnB1dC55KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoX2NhbVJpZ2h0LnogKiBfYWltSW5wdXQueCkgKyAoX2NhbUZ3ZC56ICogLV9haW1JbnB1dC55KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHdvcmxkWCkgPiAwLjEgfHwgTWF0aC5hYnMod29ybGRaKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBwLnNldE92ZXJyaWRlQWltKHdvcmxkWCwgd29ybGRaKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKY29uc3QgaGFuZGxlQWltRW5kID0gKCkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgIGFpbURyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIF9haW1JbnB1dC5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgX2FpbUlucHV0LnggPSAwOwogICAgICAgICAgICBfYWltSW5wdXQueSA9IDA7CgogICAgICAgICAgICBpZiAoYWltVmlzdWFscykgewogICAgICAgICAgICAgICAgYWltVmlzdWFscy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDbGVhciBwbGF5ZXIgYWltIG92ZXJyaWRlCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5vdmVycmlkZUFpbVZlY3RvciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBhaW1ab25lLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGNvbnN0IHQgPSAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzWzBdKSA/IGUuY2hhbmdlZFRvdWNoZXNbMF0gOiBlLnRvdWNoZXNbMF07CiAgICAgICAgICAgIGFpbVRvdWNoSWQgPSB0ID8gdC5pZGVudGlmaWVyIDogbnVsbDsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsgfQogICAgICAgICAgICBoYW5kbGVBaW1TdGFydCh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBhaW1Ub3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgIGhhbmRsZUFpbU1vdmUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBhaW1Ub3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47CiAgICAgICAgICAgIGFpbVRvdWNoSWQgPSBudWxsOwogICAgICAgICAgICBoYW5kbGVBaW1FbmQoKTsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsgfQogICAgICAgICAgICBoYW5kbGVBaW1FbmQoKTsKICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgYWltVG91Y2hJZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBhaW1Ub3VjaElkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlQWltRW5kKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5haW0pIHsgX2RiZy5pbnB1dC5haW0udG91Y2hJZCA9IGFpbVRvdWNoSWQ7IF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7IH0KICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlQWltRW5kKCk7CiAgICAgICAgfSk7Ci8vIE1vdXNlIHN1cHBvcnQgZm9yIGRlc2t0b3AgdGVzdGluZwogICAgICAgIGFpbVpvbmUuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgaGFuZGxlQWltU3RhcnQoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgIH0pOwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoYWltRHJhZ2dpbmcpIGhhbmRsZUFpbU1vdmUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgIH0pOwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGFpbURyYWdnaW5nKSBoYW5kbGVBaW1FbmQoKTsKICAgICAgICB9KTsKICAgIH0KCiAgICAvLyBORVc6IFRhY2tsZSBCdXR0b24gU2V0dXAKICAgIGZ1bmN0aW9uIHNldHVwVGFja2xlQnV0dG9uKCkgewogICAgICAgIGNvbnN0IHRhY2tsZUJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0YWNrbGUtYnV0dG9uJyk7CiAgICAgICAgaWYgKCF0YWNrbGVCdG4pIHJldHVybjsKCmNvbnN0IGhhbmRsZVRhY2tsZSA9IChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsgLy8gUHJldmVudCBidWJibGluZyB0byBqb3lzdGljawoKICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaXNEZW1vTW9kZSkgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgICAgICAvLyBWaXN1YWwgRmVlZGJhY2sgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGFja2xlQnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpLCAxNTApOwoKICAgICAgICAgICAgICAgIC8vIElmIHdlIGRvbid0IGhhdmUgdGhlIGJhbGwsIGRhc2gvdGFja2xlCiAgICAgICAgICAgICAgICBpZiAoIXAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgIC8vIEdldCBjdXJyZW50IG1vdmVtZW50IGRpcmVjdGlvbiBvciBmb3J3YXJkCiAgICAgICAgICAgICAgICAgICAgbGV0IGRhc2hYID0gcC5pbnB1dFZlY3Rvci54OwogICAgICAgICAgICAgICAgICAgIGxldCBkYXNoWiA9IHAuaW5wdXRWZWN0b3IuejsKCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgbm90IG1vdmluZywgZGFzaCBmb3J3YXJkIHJlbGF0aXZlIHRvIHBsYXllciBmYWNpbmcKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGFzaFgpIDwgMC4xICYmIE1hdGguYWJzKGRhc2haKSA8IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24ocC5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgICAgICAgICBkYXNoWCA9IGZ3ZC54OwogICAgICAgICAgICAgICAgICAgICAgICBkYXNoWiA9IGZ3ZC56OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcC5kYXNoKGRhc2hYLCBkYXNoWik7CgogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgc2hvdyB0ZXh0IGlmIGRhc2ggYWN0dWFsbHkgaGFwcGVuZWQgKGNvb2xkb3duIGNoZWNrIGluc2lkZSBkYXNoKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlRBQ0tMRSEiLCBwLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQnJlYWsgdGFja2xlIGlmIGVuZ2FnZWQKICAgICAgICAgICAgICAgICAgICBwLmRhc2gocC5pbnB1dFZlY3Rvci54LCBwLmlucHV0VmVjdG9yLnopOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdGFja2xlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBoYW5kbGVUYWNrbGUsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgdGFja2xlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIGhhbmRsZVRhY2tsZSk7CiAgICB9CgogICAgLy8gTkVXOiBTZXR0aW5ncyBCdXR0b24gU2V0dXAKLy8gTkVXOiBTZXR0aW5ncyBCdXR0b24gU2V0dXAKZnVuY3Rpb24gc2V0dXBTZXR0aW5nc0J1dHRvbigpIHsKICAgICAgICBjb25zdCBzZXR0aW5nc0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXR0aW5ncy1idXR0b24nKTsKICAgICAgICBjb25zdCBzZXR0aW5nc1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NldHRpbmdzLXBhbmVsJyk7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NDbG9zZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXR0aW5ncy1jbG9zZScpOwoKICAgICAgICBpZiAoIXNldHRpbmdzQnRuIHx8ICFzZXR0aW5nc1BhbmVsKSByZXR1cm47CgogICAgICAgIHNldHRpbmdzQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPSBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJyA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgfSk7CgogICAgICAgIGlmIChzZXR0aW5nc0Nsb3NlKSB7CiAgICAgICAgICAgIHNldHRpbmdzQ2xvc2UuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gU2Vuc2l0aXZpdHkgc2xpZGVyCiAgICAgICAgY29uc3Qgc2Vuc2l0aXZpdHlTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2Vuc2l0aXZpdHktc2xpZGVyJyk7CiAgICAgICAgaWYgKHNlbnNpdGl2aXR5U2xpZGVyKSB7CiAgICAgICAgICAgIHNlbnNpdGl2aXR5U2xpZGVyLnZhbHVlID0gX3NldHRpbmdzLmpveXN0aWNrU2Vuc2l0aXZpdHkgKiAxMDA7CiAgICAgICAgICAgIHNlbnNpdGl2aXR5U2xpZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgKGUpID0+IHsKICAgICAgICAgICAgICAgIF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5ID0gZS50YXJnZXQudmFsdWUgLyAxMDA7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gQWltIGFzc2lzdCB0b2dnbGUKICAgICAgICBjb25zdCBhaW1Bc3Npc3RUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWltLWFzc2lzdC10b2dnbGUnKTsKICAgICAgICBpZiAoYWltQXNzaXN0VG9nZ2xlKSB7CiAgICAgICAgICAgIGFpbUFzc2lzdFRvZ2dsZS5jaGVja2VkID0gX3NldHRpbmdzLmFpbUFzc2lzdDsKICAgICAgICAgICAgYWltQXNzaXN0VG9nZ2xlLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBfc2V0dGluZ3MuYWltQXNzaXN0ID0gZS50YXJnZXQuY2hlY2tlZDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBDYW1lcmEgc2hha2UgdG9nZ2xlCiAgICAgICAgY29uc3Qgc2hha2VUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2hha2UtdG9nZ2xlJyk7CiAgICAgICAgaWYgKHNoYWtlVG9nZ2xlKSB7CiAgICAgICAgICAgIHNoYWtlVG9nZ2xlLmNoZWNrZWQgPSBfc2V0dGluZ3MuY2FtZXJhU2hha2U7CiAgICAgICAgICAgIHNoYWtlVG9nZ2xlLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBfc2V0dGluZ3MuY2FtZXJhU2hha2UgPSBlLnRhcmdldC5jaGVja2VkOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIFZvbHVtZSBzbGlkZXIKICAgICAgICBjb25zdCB2b2x1bWVTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndm9sdW1lLXNsaWRlcicpOwogICAgICAgIGlmICh2b2x1bWVTbGlkZXIgJiYgX2F1ZGlvTWFuYWdlcikgewogICAgICAgICAgICB2b2x1bWVTbGlkZXIuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgY29uc3Qgdm9sID0gZS50YXJnZXQudmFsdWUgLyAxMDA7CiAgICAgICAgICAgICAgICBfYXVkaW9NYW5hZ2VyLnNldFZvbHVtZSh2b2wpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIEV4aXQgdG8gTWVudQogICAgICAgIGNvbnN0IGV4aXRCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXhpdC10by1tZW51LWJ0bicpOwogICAgICAgIGlmIChleGl0QnRuKSB7CiAgICAgICAgICAgIGV4aXRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoX21lbnVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgX21lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RvcCBwcmFjdGljZSBpZiBydW5uaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIucHJhY3RpY2VNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIucHJhY3RpY2VNYW5hZ2VyLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiB1cGRhdGVJbnB1dFZlY3RvcigpIHsKICAgICAgICBsZXQgeCA9IF9pbnB1dC54IHx8IDA7CiAgICAgICAgbGV0IHogPSBfaW5wdXQueSB8fCAwOwoKICAgICAgICBpZiAoX2tleXNbJ3cnXSB8fCBfa2V5c1snQXJyb3dVcCddKSB6IC09IDE7CiAgICAgICAgaWYgKF9rZXlzWydzJ10gfHwgX2tleXNbJ0Fycm93RG93biddKSB6ICs9IDE7CiAgICAgICAgaWYgKF9rZXlzWydhJ10gfHwgX2tleXNbJ0Fycm93TGVmdCddKSB4IC09IDE7CiAgICAgICAgaWYgKF9rZXlzWydkJ10gfHwgX2tleXNbJ0Fycm93UmlnaHQnXSkgeCArPSAxOwoKICAgICAgICBjb25zdCBsZW5TcSA9IHgqeCArIHoqejsKICAgICAgICBpZiAobGVuU3EgPiAxKSB7CiAgICAgICAgICAgIGNvbnN0IGxlbiA9IE1hdGguc3FydChsZW5TcSk7CiAgICAgICAgICAgIHggLz0gbGVuOwogICAgICAgICAgICB6IC89IGxlbjsKICAgICAgICB9CgogICAgICAgIGlmIChpc05hTih4KSkgeCA9IDA7CiAgICAgICAgaWYgKGlzTmFOKHopKSB6ID0gMDsKCiAgICAgICAgaWYgKF9jYW1lcmEpIHsKICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKCiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhfY2FtRndkLCBfdXBBeGlzKS5ub3JtYWxpemUoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBfY2FtRndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgIF9jYW1SaWdodC5zZXQoMSwgMCwgMCk7CiAgICAgICAgfQoKICAgICAgICBsZXQgd29ybGRYID0gKF9jYW1Gd2QueCAqIC16KSArIChfY2FtUmlnaHQueCAqIHgpOwogICAgICAgIGxldCB3b3JsZFogPSAoX2NhbUZ3ZC56ICogLXopICsgKF9jYW1SaWdodC56ICogeCk7CgogICAgICAgIGlmIChpc05hTih3b3JsZFgpIHx8IGlzTmFOKHdvcmxkWikpIHsKICAgICAgICAgICAgd29ybGRYID0gMDsKICAgICAgICAgICAgd29ybGRaID0gMDsKICAgICAgICB9CgppZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgLy8gRklYOiBPbmx5IGFsbG93IG1vdmVtZW50IGlmIGdhbWUgaXMgYWN0aXZlIG9yIGluIHByYWN0aWNlCiAgICAgICAgICAgIGNvbnN0IGdtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBjYW5Nb3ZlID0gZ20gJiYgIWdtLmlzRGVtb01vZGUgJiYgKGdtLnN0YXRlID09PSAnYWN0aXZlJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoY2FuTW92ZSkgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5zZXRJbnB1dCh3b3JsZFgsIHdvcmxkWik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLnNldElucHV0KDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgfQp9CgogICAgZnVuY3Rpb24gY3JlYXRlUmlwcGxlKHgsIHkpIHsKICAgICAgICBjb25zdCByaXBwbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICByaXBwbGUuY2xhc3NOYW1lID0gJ3RvdWNoLXJpcHBsZSc7CiAgICAgICAgcmlwcGxlLnN0eWxlLmxlZnQgPSBgJHt4fXB4YDsKICAgICAgICByaXBwbGUuc3R5bGUudG9wID0gYCR7eX1weGA7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJykuYXBwZW5kQ2hpbGQocmlwcGxlKTsKCiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGlmIChyaXBwbGUucGFyZW50Tm9kZSkgcmlwcGxlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQocmlwcGxlKTsKICAgICAgICB9LCA2MDApOwoKICAgIH0KCiAgICAvLyBORVc6IFZpc3VhbCBTd2lwZSBUcmFpbAogICAgZnVuY3Rpb24gY3JlYXRlU3dpcGVUcmFpbERvdCh4LCB5KSB7CiAgICAgICAgY29uc3QgZG90ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgZG90LmNsYXNzTmFtZSA9ICdzd2lwZS10cmFpbC1kb3QnOwogICAgICAgIGRvdC5zdHlsZS5sZWZ0ID0gYCR7eCAtIDZ9cHhgOyAvLyBDZW50ZXIgKDEycHggd2lkdGgpCiAgICAgICAgZG90LnN0eWxlLnRvcCA9IGAke3kgLSA2fXB4YDsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKS5hcHBlbmRDaGlsZChkb3QpOwogICAgICAgIAogICAgICAgIC8vIENTUyBhbmltYXRpb24gaGFuZGxlcyByZW1vdmFsLCBidXQgd2UgY2xlYW4gdXAgRE9NIHRvIGJlIHNhZmUKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgaWYgKGRvdC5wYXJlbnROb2RlKSBkb3QucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChkb3QpOwogICAgICAgIH0sIDUwMCk7CiAgICB9CgogICAgZnVuY3Rpb24gb25SZXNpemUoKSB7CiAgICAgICAgY29uc3Qgd2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICBjb25zdCBoZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgCiAgICAgICAgaWYgKF9jYW1lcmEpIHsKICAgICAgICAgICAgX2NhbWVyYS5hc3BlY3QgPSB3aWR0aCAvIGhlaWdodDsKICAgICAgICAgICAgX2NhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFN0cmljdGx5IDAuNTAgYXMgcmVxdWVzdGVkCiAgICAgICAgY29uc3QgcmVzU2NhbGUgPSAwLjUwOwogICAgICAgIAogICAgICAgIF9jb25maWcuaW50ZXJuYWxXaWR0aCA9IE1hdGguZmxvb3Iod2lkdGggKiByZXNTY2FsZSk7CiAgICAgICAgX2NvbmZpZy5pbnRlcm5hbEhlaWdodCA9IE1hdGguZmxvb3IoaGVpZ2h0ICogcmVzU2NhbGUpOwoKICAgICAgICBpZiAoX3JlbmRlcmVyKSB7CiAgICAgICAgICAgIF9yZW5kZXJlci5zZXRTaXplKF9jb25maWcuaW50ZXJuYWxXaWR0aCwgX2NvbmZpZy5pbnRlcm5hbEhlaWdodCwgZmFsc2UpOwogICAgICAgIH0KICAgIH0KCmZ1bmN0aW9uIGFuaW1hdGUoKSB7CiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwoKICAgICAgICBjb25zdCByYXdEdCA9IF9jbG9jay5nZXREZWx0YSgpOwogICAgICAgIC8vIENsYW1wIGR0IHRvIHByZXZlbnQgc3BpcmFscyBvZiBkZWF0aCAobWF4IDAuMXMpCiAgICAgICAgY29uc3QgZHQgPSBNYXRoLm1pbihyYXdEdCwgMC4xKSAqICh3aW5kb3cuZmx1eC50aW1lU2NhbGUgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA6IDAuOCk7CgogICAgICAgIAoKICAgICAgICAvLyBQZXJmIHN0YXRzIGZvciBEZXZUb29scyBzbmFwc2hvdHMKICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX2RlYnVnSU8gJiYgd2luZG93LmZsdXguX2RlYnVnSU8ucGVyZikgewogICAgICAgICAgICBjb25zdCBwZXJmID0gd2luZG93LmZsdXguX2RlYnVnSU8ucGVyZjsKICAgICAgICAgICAgcGVyZi5mcmFtZSA9IChwZXJmLmZyYW1lIHx8IDApICsgMTsKICAgICAgICAgICAgcGVyZi5yYXdEdCA9IHJhd0R0OwogICAgICAgICAgICBwZXJmLmR0ID0gZHQ7CiAgICAgICAgICAgIGNvbnN0IGZwcyA9IGR0ID4gMCA/ICgxIC8gZHQpIDogMDsKICAgICAgICAgICAgcGVyZi5mcHMgPSBmcHM7CiAgICAgICAgICAgIHBlcmYuYXZnRnBzID0gKHBlcmYuYXZnRnBzICYmIHBlcmYuYXZnRnBzID4gMCkgPyAocGVyZi5hdmdGcHMgKiAwLjkgKyBmcHMgKiAwLjEpIDogZnBzOwogICAgICAgIH0KLy8gSW1wYWN0IEZyYW1lcwogICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmltcGFjdFBhdXNlID4gMCkgewogICAgICAgICAgICBfZ2FtZU1hbmFnZXIuaW1wYWN0UGF1c2UgLT0gZHQ7CiAgICAgICAgICAgIGlmIChfcmVuZGVyZXIgJiYgX3NjZW5lICYmIF9jYW1lcmEpIHsKICAgICAgICAgICAgICAgIF9yZW5kZXJlci5yZW5kZXIoX3NjZW5lLCBfY2FtZXJhKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwoKICAgICAgICAvLyBBY3Rpb24gQnVmZmVyIFByb2Nlc3NpbmcKICAgICAgICBpZiAoX2FjdGlvbkJ1ZmZlci5hY3RpdmUpIHsKICAgICAgICAgICAgaWYgKERhdGUubm93KCkgLSBfYWN0aW9uQnVmZmVyLnRpbWVzdGFtcCA+IF9hY3Rpb25CdWZmZXIuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCAmJiAhcC5pc0NoYXJnaW5nICYmICFwLmlzVGhyb3dpbmcgJiYgcC5zdGF0dXMubmFwIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGFydENoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWJ1dHRvbicpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYnRuKSBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBNZW51IFN0YXRlIEhhbmRsaW5nCiAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuc3RhdGUgPT09ICdtZW51JyAmJiBfY2FtZXJhKSB7CiAgICAgICAgICAgIGNvbnN0IHRpbWUgPSBEYXRlLm5vdygpICogMC4wMDA1OwogICAgICAgICAgICBjb25zdCByYWRpdXMgPSA1MDsKICAgICAgICAgICAgX2NhbWVyYS5wb3NpdGlvbi54ID0gTWF0aC5zaW4odGltZSkgKiByYWRpdXM7CiAgICAgICAgICAgIF9jYW1lcmEucG9zaXRpb24ueiA9IE1hdGguY29zKHRpbWUpICogcmFkaXVzOwogICAgICAgICAgICBfY2FtZXJhLnBvc2l0aW9uLnkgPSAyMDsKICAgICAgICAgICAgX2NhbWVyYS5sb29rQXQoMCwgMCwgMCk7CgogICAgICAgICAgICBpZiAoX3JlbmRlcmVyICYmIF9zY2VuZSkgewogICAgICAgICAgICAgICAgX3JlbmRlcmVyLnJlbmRlcihfc2NlbmUsIF9jYW1lcmEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgovLyBTdGFibGUgc3ViLXN0ZXBwaW5nIChwcmV2ZW50cyBkdCBzcGlrZXMgZnJvbSBtYWtpbmcgcGh5c2ljcy9jYW1lcmEgZmVlbCBmbG9hdHkgb24gbW9iaWxlKQogICAgICAgIGNvbnN0IF9tYXhTdGVwID0gMSAvIDYwOwogICAgICAgIGNvbnN0IF9zdGVwcyA9IE1hdGgubWluKDQsIE1hdGgubWF4KDEsIE1hdGguY2VpbChkdCAvIF9tYXhTdGVwKSkpOwogICAgICAgIGNvbnN0IF9zdGVwRHQgPSBkdCAvIF9zdGVwczsKCiAgICAgICAgZm9yIChsZXQgX3NpID0gMDsgX3NpIDwgX3N0ZXBzOyBfc2krKykgewogICAgICAgICAgICBjb25zdCBfc2R0ID0gX3N0ZXBEdDsKCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIF9nYW1lTWFuYWdlci51cGRhdGUoX3NkdCk7CgogICAgICAgICAgICAvLyBJZiBpbiBBc3NldCBGb3JnZSBtb2RlLCBza2lwIGdhbWUgbG9naWMgYW5kIHN0YW5kYXJkIHJlbmRlcmluZwogICAgICAgICAgICAvLyBEZXZUb29scyBoYW5kbGVzIHRoZSByZW5kZXJpbmcgaW4gaXRzIGhvb2tlZCB1cGRhdGUgZnVuY3Rpb24KICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaXNGb3JnZU1vZGUpIHsKICAgICAgICAgICAgICAgIC8vIEZvcmdlIG1vZGUgaGFuZGxlcyBpdHMgb3duIHJlbmRlcmluZyBsb29wIGluIERldlRvb2xzIGhvb2sKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIEVudGl0aWVzCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0pIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS51cGRhdGUoX3NkdCk7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gY2hlY2tCYWxsR3JhYihwKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChfYXdheVRlYW0pIHsKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS51cGRhdGUoX3NkdCk7CiAgICAgICAgICAgICAgICBfYXdheVRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gY2hlY2tCYWxsR3JhYihwKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChfYmFsbCkgewogICAgICAgICAgICAgICAgX2JhbGwudXBkYXRlKF9zZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCYWxsIExhYiBydW50aW1lICh0cmFqZWN0b3J5IHByZXZpZXcgLyByZWNvcmQtcmVwbGF5KQogICAgICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguYmFsbExhYiAmJiB0eXBlb2Ygd2luZG93LmZsdXguYmFsbExhYi51cGRhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmJhbGxMYWIudXBkYXRlKF9zZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgQ2FtZXJhCiAgICAgICAgICAgIHVwZGF0ZUNhbWVyYUxvZ2ljKF9zZHQpOwoKICAgICAgICAgICAgLy8gVXBkYXRlIFZpc3VhbHMKICAgICAgICAgICAgaWYgKF93YXRlck92ZXJsYXkpIF93YXRlck92ZXJsYXkudXBkYXRlKF9zZHQpOwogICAgICAgICAgICBpZiAoX2xpZ2h0U2hhZnRzKSBfbGlnaHRTaGFmdHMudXBkYXRlKF9zZHQpOwoKLy8gUnVudGltZSB1cGRhdGVycyAoRlgsIGFyZW5hIHJpbmdzLCBldGMuKQogICAgICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyAmJiB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgZm9yIChsZXQgdWkgPSAwOyB1aSA8IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMubGVuZ3RoOyB1aSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm4gPSB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzW3VpXTsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAnZnVuY3Rpb24nKSBmbihfc2R0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIEdseXBoIE1hbmFnZXIgKENyaXRpY2FsIGZvciB2aXN1YWwgY2xlYW51cCkKICAgICAgICAgICAgaWYgKF9nbHlwaE1hbmFnZXIpIF9nbHlwaE1hbmFnZXIudXBkYXRlKF9zZHQpOwoKLy8gVXBkYXRlIEdsb2JhbCBVbmlmb3JtcwogICAgICAgICAgICBpZiAoX2FyZW5hVW5pZm9ybXMpIHsKICAgICAgICAgICAgICAgIF9hcmVuYVVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IF9zZHQ7CiAgICAgICAgICAgICAgICBfYXJlbmFVbmlmb3Jtcy51SW1wYWN0U3RyLnZhbHVlICo9IE1hdGgubWF4KDAsIDEuMCAtIF9zZHQgKiA0LjApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAtLS0gTkVXOiBBcmVuYSBSb3RhdGlvbiAmIENvbG9yIFNoaWZ0IC0tLQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFHcm91cCkgewogICAgICAgICAgICAgICAgLy8gUm90YXRlIHNwaGVyZSBzbG93bHkgdG8gc2hvdyB3YXRlciBtb3ZlbWVudAogICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5yb3RhdGlvbi55ICs9IF9zZHQgKiAwLjA1OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXgudHJpYmFsVW5pZm9ybXMpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnRyaWJhbFVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IF9zZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFBvc3Nlc3Npb24gQ29sb3IgTG9naWMKICAgICAgICAgICAgICAgIGxldCB0YXJnZXRDb2xvciA9IG5ldyBUSFJFRS5Db2xvcigweDAwZmZmZik7IC8vIERlZmF1bHQgQ3lhbiAoSG9tZS9OZXV0cmFsKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoX2JhbGwgJiYgX2JhbGwuaG9sZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9iYWxsLmhvbGRlci50ZWFtICYmIF9iYWxsLmhvbGRlci50ZWFtLnNpZGUgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldENvbG9yLnNldEhleCgweGZmODgwMCk7IC8vIE9yYW5nZSAoQXdheSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNtb290aCBMZXJwCiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3Jtcy51Q29sb3IudmFsdWUubGVycCh0YXJnZXRDb2xvciwgX3NkdCAqIDIuMCk7CiAgICAgICAgICAgIH0KCmlmIChfcGFydGljbGVVbmlmb3JtcykgewogICAgICAgICAgICAgICAgX3BhcnRpY2xlVW5pZm9ybXMudVRpbWUudmFsdWUgKz0gX3NkdDsKICAgICAgICAgICAgfQogICAgICAgIH0gLy8gQ2xvc2Ugc3ViLXN0ZXAgbG9vcAoKICAgICAgICBpZiAoX3JlbmRlcmVyICYmIF9zY2VuZSAmJiBfY2FtZXJhKSB7CiAgICAgICAgICAgIF9yZW5kZXJlci5yZW5kZXIoX3NjZW5lLCBfY2FtZXJhKTsKICAgICAgICB9CiAgICAgICAgLy8gVUkgVXBkYXRlcwogICAgICAgIHVwZGF0ZVVJKCk7CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlVUkoKSB7CiAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybjsKCiAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKICAgICAgICBjb25zdCBsYmwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWxhYmVsJyk7CiAgICAgICAgY29uc3QgdGFja2xlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RhY2tsZS1idXR0b24nKTsKICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgaWYgKGJ0biAmJiBsYmwpIHsKICAgICAgICAgICAgY29uc3QgYnRuVGV4dCA9IGJ0bi5xdWVyeVNlbGVjdG9yKCcuYnRuLXRleHQnKTsKCiAgICAgICAgICAgIGlmIChwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGlmIChidG5UZXh0ICYmIGJ0blRleHQuaW5uZXJUZXh0ICE9PSAiQUNUSU9OIikgewogICAgICAgICAgICAgICAgICAgIGJ0blRleHQuaW5uZXJUZXh0ID0gIkFDVElPTiI7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ3Nob290LW1vZGUnKTsKICAgICAgICAgICAgICAgICAgICBsYmwuaW5uZXJUZXh0ID0gIk9GRkVOU0UiOwogICAgICAgICAgICAgICAgICAgIGxibC5jbGFzc0xpc3QuYWRkKCdzaG9vdC1sYWJlbCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IGlzSGlnaEVuZXJneSA9IChwLnN0YXRzLkhQIC8gcC5zdGF0cy5tYXhIUCkgPiAwLjQ7CiAgICAgICAgICAgICAgICBpZiAoaXNIaWdoRW5lcmd5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFidG4uY2xhc3NMaXN0LmNvbnRhaW5zKCdsaW1pdC1yZWFkeScpKSBidG4uY2xhc3NMaXN0LmFkZCgnbGltaXQtcmVhZHknKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJ0bi5jbGFzc0xpc3QuY29udGFpbnMoJ2xpbWl0LXJlYWR5JykpIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdsaW1pdC1yZWFkeScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChidG5UZXh0ICYmIGJ0blRleHQuaW5uZXJUZXh0ICE9PSAiU1dJTSIpIHsKICAgICAgICAgICAgICAgICAgICBidG5UZXh0LmlubmVyVGV4dCA9ICJTV0lNIjsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnc2hvb3QtbW9kZScpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdsaW1pdC1yZWFkeScpOwogICAgICAgICAgICAgICAgICAgIGxibC5pbm5lclRleHQgPSAiTk9STUFMIjsKICAgICAgICAgICAgICAgICAgICBsYmwuY2xhc3NMaXN0LnJlbW92ZSgnc2hvb3QtbGFiZWwnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVXBkYXRlIHRhY2tsZSBidXR0b24gdmlzaWJpbGl0eQogICAgICAgIGlmICh0YWNrbGVCdG4pIHsKICAgICAgICAgICAgaWYgKCFwLmhhc0JhbGwgfHwgcC5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgLy8gVXBkYXRlIHRhY2tsZSBidXR0b24gdGV4dCBiYXNlZCBvbiBjb250ZXh0CiAgICAgICAgICAgICAgICBjb25zdCB0YWNrbGVUZXh0ID0gdGFja2xlQnRuLnF1ZXJ5U2VsZWN0b3IoJy5idG4tdGV4dCcpOwogICAgICAgICAgICAgICAgaWYgKHRhY2tsZVRleHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocC5pc0VuZ2FnZWQgJiYgcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZVRleHQuaW5uZXJUZXh0ID0gJ0JSRUFLJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGFja2xlQnRuLmNsYXNzTGlzdC5hZGQoJ3VyZ2VudCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZVRleHQuaW5uZXJUZXh0ID0gJ1RBQ0tMRSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QucmVtb3ZlKCd1cmdlbnQnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YWNrbGVCdG4uc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVXBkYXRlIGRpc3RhbmNlIHRvIGdvYWwgaW5kaWNhdG9yCiAgICAgICAgY29uc3QgZGlzdEluZGljYXRvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnb2FsLWRpc3RhbmNlJyk7CiAgICAgICAgaWYgKGRpc3RJbmRpY2F0b3IgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHAudGVhbSAmJiBwLnRlYW0uc2lkZSA9PT0gMSkgPyAtMjggOiAyODsKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguYWJzKHAubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICBkaXN0SW5kaWNhdG9yLmlubmVyVGV4dCA9IGAke01hdGguZmxvb3IoZGlzdCl9bWA7CiAgICAgICAgfQogICAgfQoKZnVuY3Rpb24gdXBkYXRlQ2FtZXJhTG9naWMoZHQpIHsKICAgICAgICBpZiAoIV9jYW1lcmFNYW5hZ2VyIHx8ICFfYmFsbCkgcmV0dXJuOwoKICAgICAgICBsZXQgdGFyZ2V0TWVzaCA9IF9iYWxsLm1lc2g7CiAgICAgICAgbGV0IHRhcmdldFZlbCA9IF9iYWxsLnZlbG9jaXR5OwogICAgICAgIGxldCB0YXJnZXRJbnB1dCA9IG51bGw7CiAgICAgICAgbGV0IGlzQWltaW5nID0gZmFsc2U7CgogICAgICAgIGlmIChfYmFsbC5ob2xkZXIgJiYgX2JhbGwuaG9sZGVyLm1lc2gpIHsKICAgICAgICAgICAgdGFyZ2V0TWVzaCA9IF9iYWxsLmhvbGRlci5tZXNoOwogICAgICAgICAgICB0YXJnZXRWZWwgPSBfYmFsbC5ob2xkZXIudmVsb2NpdHk7CiAgICAgICAgICAgIGlmIChfYmFsbC5ob2xkZXIuaW5wdXRWZWN0b3IpIHsKICAgICAgICAgICAgICAgIHRhcmdldElucHV0ID0gX2JhbGwuaG9sZGVyLmlucHV0VmVjdG9yOwogICAgICAgICAgICB9Ci8vIENoZWNrIGFpbWluZyBzdGF0ZSAoQ2hhcmdpbmcgb3IgVGhyb3dpbmcpCiAgICAgICAgICAgIGlmIChfYmFsbC5ob2xkZXIuaXNDaGFyZ2luZyB8fCBfYmFsbC5ob2xkZXIuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgaXNBaW1pbmcgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQodGFyZ2V0TWVzaCwgdGFyZ2V0VmVsLCB0YXJnZXRJbnB1dCwgaXNBaW1pbmcpOwogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICB9CgpmdW5jdGlvbiBjaGVja0JhbGxHcmFiKGVudGl0eSkgewogICAgICAgIGlmICghZW50aXR5LmNhbkNhdGNoKSByZXR1cm47CiAgICAgICAgaWYgKF9iYWxsICYmICFfYmFsbC5pc0NhdGNoYWJsZSgpKSByZXR1cm47CiAgICAgICAgaWYgKGVudGl0eS5zdHVuVGltZXIgPiAwIHx8IChlbnRpdHkuc3RhdHVzICYmIGVudGl0eS5zdGF0dXMubmFwID4gMCkpIHJldHVybjsKICAgICAgICBpZiAoX2JhbGwuc3RhdGUgIT09ICdmcmVlJykgcmV0dXJuOwogICAgICAgIGlmICghX2JhbGwubWVzaCB8fCAhZW50aXR5Lm1lc2gpIHJldHVybjsKCiAgICAgICAgY29uc3QgYmFsbFBvcyA9IF9iYWxsLm1lc2gucG9zaXRpb247CiAgICAgICAgY29uc3QgZW50UG9zID0gZW50aXR5Lm1lc2gucG9zaXRpb247CgogICAgICAgIGNvbnN0IGR4ID0gYmFsbFBvcy54IC0gZW50UG9zLng7CiAgICAgICAgY29uc3QgZHogPSBiYWxsUG9zLnogLSBlbnRQb3MuejsKICAgICAgICBjb25zdCBkaXN0WFogPSBNYXRoLnNxcnQoZHgqZHggKyBkeipkeik7CiAgICAgICAgY29uc3QgZGlzdFkgPSBNYXRoLmFicyhiYWxsUG9zLnkgLSBlbnRQb3MueSk7CgogICAgICAgIC8vIC0tLSBSRUxBWEVEIFRPTEVSQU5DRVMgRk9SIEVBU0lFUiBQSUNLVVAgLS0tCiAgICAgICAgY29uc3QgdG91Y2hSYWRpdXMgPSAxLjU7IC8vIEluY3JlYXNlZCBmcm9tIDEuMCAoQXV0by1ncmFiIHJhZGl1cykKICAgICAgICBsZXQgbWFnbmV0UmFkaXVzID0gMy41OyAgLy8gSW5jcmVhc2VkIGZyb20gMS44IChNYWduZXRpYyByYWRpdXMpCiAgICAgICAgbGV0IGludGVyYWN0aW9uUmFkaXVzID0gNi4wOyAvLyBJbmNyZWFzZWQgZnJvbSAzLjUgKFR1cm4tdG8gcmFkaXVzKQogICAgICAgIGxldCBjYXRjaEhlaWdodCA9IDYuMDsgICAvLyBJbmNyZWFzZWQgZnJvbSAzLjAgKFZlcnRpY2FsIHJlYWNoKQoKICAgICAgICBpZiAoZW50aXR5LmlzRGFzaGluZykgewogICAgICAgICAgICBtYWduZXRSYWRpdXMgPSA0LjU7CiAgICAgICAgICAgIGludGVyYWN0aW9uUmFkaXVzID0gNy4wOwogICAgICAgICAgICBjYXRjaEhlaWdodCA9IDcuMDsKICAgICAgICB9CgogICAgICAgIGlmIChkaXN0WFogPiBpbnRlcmFjdGlvblJhZGl1cyB8fCBkaXN0WSA+IGNhdGNoSGVpZ2h0KSByZXR1cm47CgogICAgICAgIC8vIE9wdGltaXphdGlvbjogVXNlIHNoYXJlZCB2ZWN0b3JzIHRvIGF2b2lkIEdDCiAgICAgICAgX3RlbXBWZWMxLmNvcHkoYmFsbFBvcykuc3ViKGVudFBvcykubm9ybWFsaXplKCk7IC8vIHRvQmFsbAogICAgICAgIF90ZW1wVmVjMi5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKGVudGl0eS5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOyAvLyBwbGF5ZXJGb3J3YXJkCgogICAgICAgIGNvbnN0IGZhY2luZ0RvdCA9IF90ZW1wVmVjMi5kb3QoX3RlbXBWZWMxKTsKCiAgICAgICAgY29uc3QgY29uZVRocmVzaG9sZCA9IC0wLjQ7IC8vIE1vcmUgZ2VuZXJvdXMgY29uZSAod2FzIC0wLjIpCiAgICAgICAgY29uc3QgaXNJbkNvbmUgPSBmYWNpbmdEb3QgPiBjb25lVGhyZXNob2xkOwogICAgICAgIAogICAgICAgIC8vIEFVVE8tVFVSTjogSWYgbmVhciBidXQgZmFjaW5nIHdyb25nIHdheSwgdHVybiB0b3dhcmRzIGJhbGwKICAgICAgICBpZiAoZGlzdFhaIDwgaW50ZXJhY3Rpb25SYWRpdXMgJiYgIWlzSW5Db25lKSB7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldEFuZ2xlID0gTWF0aC5hdGFuMihfdGVtcFZlYzEueCwgX3RlbXBWZWMxLnopOwogICAgICAgICAgICBjb25zdCBxID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMSwwKSwgdGFyZ2V0QW5nbGUpOwogICAgICAgICAgICBlbnRpdHkubWVzaC5xdWF0ZXJuaW9uLnNsZXJwKHEsIDAuMik7IC8vIEZhc3RlciB0dXJuICh3YXMgMC4xKQogICAgICAgICAgICBpZiAoZW50aXR5LnN5bmNSb3RhdGlvbikgZW50aXR5LnN5bmNSb3RhdGlvbigpOwogICAgICAgIH0KCiAgICAgICAgLy8gR1JBQiBMT0dJQwogICAgICAgIC8vIDEuIFRvdWNoOiBWZXJ5IGNsb3NlIChpZ25vcmUgZmFjaW5nIC0gcHJldmVudHMgcnVubmluZyBvdmVyIGJhbGwpCiAgICAgICAgLy8gMi4gTWFnbmV0OiBDbG9zZSBhbmQgZmFjaW5nCiAgICAgICAgY29uc3QgaXNUb3VjaCA9IGRpc3RYWiA8IHRvdWNoUmFkaXVzOwogICAgICAgIGNvbnN0IGlzTWFnbmV0ID0gZGlzdFhaIDwgbWFnbmV0UmFkaXVzICYmIGlzSW5Db25lOwoKICAgICAgICBpZiAoaXNUb3VjaCB8fCBpc01hZ25ldCkgewogICAgICAgICAgICAvLyBCTEFTVCBUSFJPVUdIIExPR0lDCiAgICAgICAgICAgIGNvbnN0IGJhbGxTcGVlZCA9IF9iYWxsLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICBsZXQgY2F0Y2hDaGFuY2UgPSAxLjA7CgogICAgICAgICAgICAvLyBJZiBiYWxsIGlzIG1vdmluZyBmYXN0IChlLmcuID4gMjApLCBjaGVjayBDQQogICAgICAgICAgICBpZiAoYmFsbFNwZWVkID4gMjAuMCkgewogICAgICAgICAgICAgICAgY29uc3QgY2EgPSBlbnRpdHkuZ2V0U3RhdCgnQ0EnKTsKICAgICAgICAgICAgICAgIC8vIERpZmZpY3VsdHkgc2NhbGVzIHdpdGggc3BlZWQuIAogICAgICAgICAgICAgICAgY29uc3QgZGlmZmljdWx0eSA9IGJhbGxTcGVlZCAqIDEuMjsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChkaWZmaWN1bHR5ID4gY2EpIHsKICAgICAgICAgICAgICAgICAgICBjYXRjaENoYW5jZSA9IDAuNCArIChjYSAvIGRpZmZpY3VsdHkpICogMC42OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFBvaW50IEJsYW5rIFBlbmFsdHk6IEhhcmRlciB0byByZWFjdCBpZiBiYWxsIGlzIHJpZ2h0IG9uIHRvcCBvZiB5b3UgbW92aW5nIGZhc3QKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdFhaIDwgMS4yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoQ2hhbmNlICo9IDAuNjsgLy8gQmxhc3QgdGhyb3VnaCBsaWtlbHkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKGVudGl0eS5pc0Rhc2hpbmcpIGNhdGNoQ2hhbmNlICs9IDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChfYmFsbC5wb3dlclR5cGUgPT09ICdTSCcgJiYgX2JhbGwucG93ZXIgPiAxNS4wKSB7CiAgICAgICAgICAgICAgICAvLyBTaG90IHBvd2VyIGNoZWNrCiAgICAgICAgICAgICAgICBjb25zdCBjYSA9IGVudGl0eS5nZXRTdGF0KCdDQScpOwogICAgICAgICAgICAgICAgaWYgKF9iYWxsLnBvd2VyID4gY2EgKiAxLjIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFuY2UgPSBNYXRoLm1pbigwLjcsIChfYmFsbC5wb3dlciAtIGNhKSAqIDAuMDQpOwogICAgICAgICAgICAgICAgICAgIGNhdGNoQ2hhbmNlID0gMS4wIC0gY2hhbmNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgZnVtYmxlID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gY2F0Y2hDaGFuY2UpIHsKICAgICAgICAgICAgICAgIGZ1bWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmdW1ibGUpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIGZlZWRiYWNrIGZvciBibGFzdCB0aHJvdWdoCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxBU1QgVEhST1VHSCEiLCBlbnRQb3MsICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGVmbGVjdCBzbGlnaHRseSBidXQga2VlcCBtb3ZpbmcgZmFzdCAoQmxhc3QgVGhyb3VnaCkKICAgICAgICAgICAgICAgIC8vIERvbid0IHN0b3AgaXQgY29tcGxldGVseSBsaWtlIGEgYmxvY2ssIGp1c3QgcGVydHVyYiBpdAogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC44NSk7IAogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogNS4wOwogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkueSArPSAoTWF0aC5yYW5kb20oKSkgKiA1LjA7IC8vIFBvcCB1cAogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogNS4wOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfYmFsbC5wb3dlciAqPSAwLjc7CgogICAgICAgICAgICAgICAgZW50aXR5LmNhbkNhdGNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBTdHVuIGJyaWVmbHkKICAgICAgICAgICAgICAgIGVudGl0eS5zdHVuVGltZXIgPSAwLjU7CiAgICAgICAgICAgICAgICBpZihlbnRpdHkucGxheSkgZW50aXR5LnBsYXkoJ3JlYWN0JywgMC4xKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IGVudGl0eS5jYW5DYXRjaCA9IHRydWU7IH0sIDEwMDApOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9iYWxsLm1hZ25ldGl6ZShlbnRpdHkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIFN0YXJ0CiAgICBpbml0KCk7Cn0pKCk7","/main.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgLy8gTmFtZXNwYWNlCiAgICB3aW5kb3cuZmx1eCA9IHdpbmRvdy5mbHV4IHx8IHt9OwogICAgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyA9IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgfHwgW107CgogICAgLy8gQ29uZmlnCmNvbnN0IF9jb25maWcgPSB7CiAgICAgICAgaW50ZXJuYWxXaWR0aDogMzYwLAogICAgICAgIGludGVybmFsSGVpZ2h0OiA2NDAsCiAgICAgICAgYmdDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgZm9nQ29sb3I6IDB4MDAxZTM2LAogICAgICAgIGZvZ0RlbnNpdHk6IDAuMDAwMSwgLy8gRHJhc3RpY2FsbHkgcmVkdWNlZCB0byBlbnN1cmUgdmlzaWJpbGl0eQogICAgICAgIGFyZW5hUmFkaXVzOiA0OC4wCiAgICB9OwoKICAgIC8vIEdsb2JhbHMKLy8gR2xvYmFscwogICAgY29uc3QgX2lucHV0ID0geyB4OiAwLCB5OiAwIH07IC8vIElucHV0IHN0YXRlCiAgICAKICAgIC8vIFNoYWRlciBVbmlmb3JtcwogICAgY29uc3QgX2FyZW5hVW5pZm9ybXMgPSB7CiAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICB1SW1wYWN0UG9zOiB7IHZhbHVlOiBuZXcgVEhSRUUuVmVjdG9yMygpIH0sCiAgICAgICAgdUltcGFjdFN0cjogeyB2YWx1ZTogMC4wIH0KICAgIH07CiAgICBjb25zdCBfcGFydGljbGVVbmlmb3JtcyA9IHsKICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9CiAgICB9OwoKICAgIC8vIEV4cG9zZSBJbXBhY3QgVHJpZ2dlcgogICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0ID0gZnVuY3Rpb24ocG9zLCBzdHJlbmd0aCkgewogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RQb3MudmFsdWUuY29weShwb3MpOwogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RTdHIudmFsdWUgPSBzdHJlbmd0aCAqIDIuMDsgLy8gU2NhbGUgdXAgZm9yIHZpc2liaWxpdHkKICAgIH07Ci8vIF9pbnB1dCBhbHJlYWR5IGRlY2xhcmVkIGFib3ZlCiAgICBjb25zdCBfdGVtcFZlYzEgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBSZXVzYWJsZSBmb3IgcGh5c2ljcy9sb2dpYwogICAgY29uc3QgX3RlbXBWZWMyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsgLy8gUmV1c2FibGUgZm9yIHBoeXNpY3MvbG9naWMKICAgIGxldCBfc2NlbmUsIF9jYW1lcmEsIF9yZW5kZXJlciwgX2Nsb2NrOwogICAgbGV0IF9ob21lVGVhbSwgX2F3YXlUZWFtOwogICAgbGV0IF9iYWxsOwogICAgbGV0IF9nYW1lTWFuYWdlcjsKICAgIGxldCBfbWVudU1hbmFnZXI7CiAgICBsZXQgX2F1ZGlvTWFuYWdlcjsKCiAgICBsZXQgX2NhbWVyYU1hbmFnZXI7CiAgICBsZXQgX3dhdGVyT3ZlcmxheTsKICAgIGxldCBfbGlnaHRTaGFmdHM7CiAgICBsZXQgX3N0YWRpdW07CiAgICBsZXQgX2dseXBoTWFuYWdlcjsKCiAgICAvLyBJTVBST1ZFRDogU2V0dGluZ3Mgb2JqZWN0CiAgICBjb25zdCBfc2V0dGluZ3MgPSB7CiAgICAgICAgam95c3RpY2tTZW5zaXRpdml0eTogMS4wLAogICAgICAgIGFpbUFzc2lzdDogdHJ1ZSwKICAgICAgICBjYW1lcmFTaGFrZTogdHJ1ZSwKICAgICAgICBoaXRTdG9wOiB0cnVlLAogICAgICAgIGludmVydENhbWVyYTogZmFsc2UsCiAgICAgICAgYXV0b1JlY2VudGVyOiB0cnVlCiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRGVidWcgSU8gQnJpZGdlIChleHBvc2VkIGZvciBEZXZUb29scyBKU09OIHNuYXBzaG90cykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIHx8IHt9OwogICAgX2RlYnVnSU8uc2V0dGluZ3MgPSBfc2V0dGluZ3M7CiAgICBfZGVidWdJTy5pbnB1dCA9IF9kZWJ1Z0lPLmlucHV0IHx8IHt9OwogICAgX2RlYnVnSU8ucGVyZiA9IF9kZWJ1Z0lPLnBlcmYgfHwgeyBmcmFtZTogMCwgcmF3RHQ6IDAsIGR0OiAwLCBmcHM6IDAsIGF2Z0ZwczogMCB9OwoKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIFRvdWNoIGhlbHBlcnMgKG11bHRpLXRvdWNoIHNhZmUpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGZ1bmN0aW9uIF9maW5kVG91Y2hCeUlkKHRvdWNoTGlzdCwgaWQpIHsKICAgICAgICBpZiAoaWQgPT09IG51bGwgfHwgaWQgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgICAgaWYgKCF0b3VjaExpc3QpIHJldHVybiBudWxsOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdG91Y2hMaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IHQgPSB0b3VjaExpc3RbaV07CiAgICAgICAgICAgIGlmICh0ICYmIHQuaWRlbnRpZmllciA9PT0gaWQpIHJldHVybiB0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBfZW5kZWRUb3VjaEJ5SWQoY2hhbmdlZFRvdWNoZXMsIGlkKSB7CiAgICAgICAgaWYgKGlkID09PSBudWxsIHx8IGlkID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgICAgIGlmICghY2hhbmdlZFRvdWNoZXMpIHJldHVybiBudWxsOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hhbmdlZFRvdWNoZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgdCA9IGNoYW5nZWRUb3VjaGVzW2ldOwogICAgICAgICAgICBpZiAodCAmJiB0LmlkZW50aWZpZXIgPT09IGlkKSByZXR1cm4gdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGluaXQoKSB7CiAgICAgICAgX2NvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnYW1lLWNvbnRhaW5lcicpOwoKICAgICAgICAvLyAxLiBTY2VuZQogICAgICAgIF9zY2VuZSA9IG5ldyBUSFJFRS5TY2VuZSgpOwogICAgICAgIF9zY2VuZS5iYWNrZ3JvdW5kID0gbmV3IFRIUkVFLkNvbG9yKF9jb25maWcuYmdDb2xvcik7CiAgICAgICAgX3NjZW5lLmZvZyA9IG5ldyBUSFJFRS5Gb2dFeHAyKF9jb25maWcuZm9nQ29sb3IsIF9jb25maWcuZm9nRGVuc2l0eSk7CgogICAgICAgIC8vIDIuIENhbWVyYQogICAgICAgIGNvbnN0IGFzcGVjdCA9IF9jb25maWcuaW50ZXJuYWxXaWR0aCAvIF9jb25maWcuaW50ZXJuYWxIZWlnaHQ7Cl9jYW1lcmEgPSBuZXcgVEhSRUUuUGVyc3BlY3RpdmVDYW1lcmEoNjAsIGFzcGVjdCwgMC4xLCA1MDApOwpfY2FtZXJhLnBvc2l0aW9uLnNldCgwLCAxNCwgMjIpOwogICAgICAgIF9jYW1lcmEubG9va0F0KDAsIDAsIDApOwogICAgICAgIF9zY2VuZS5hZGQoX2NhbWVyYSk7IC8vIEVuc3VyZSBjYW1lcmEgaXMgaW4gc2NlbmUgZm9yIGNoaWxkcmVuIHRvIHJlbmRlcgoKICAgICAgICAvLyAzLiBSZW5kZXJlcgovLyAzLiBSZW5kZXJlcgogICAgICAgIF9yZW5kZXJlciA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlcmVyKHsgCiAgICAgICAgICAgIGFudGlhbGlhczogZmFsc2UsCiAgICAgICAgICAgIHBvd2VyUHJlZmVyZW5jZTogImhpZ2gtcGVyZm9ybWFuY2UiLAogICAgICAgICAgICBwcmVjaXNpb246ICJtZWRpdW1wIiwgLy8gTW9iaWxlIG9wdGltaXphdGlvbjogZmFzdGVyIHNoYWRlcnMKICAgICAgICAgICAgc3RlbmNpbDogZmFsc2UsICAgICAgIC8vIERpc2FibGUgc3RlbmNpbCBidWZmZXIgaWYgbm90IHVzZWQKICAgICAgICAgICAgZGVwdGg6IHRydWUKICAgICAgICB9KTsKICAgICAgICBfcmVuZGVyZXIuc2V0UGl4ZWxSYXRpbygxKTsgLy8gRm9yY2UgMToxIHBpeGVsIHJhdGlvLCB3ZSBoYW5kbGUgc2NhbGluZyB2aWEgc2V0U2l6ZQogICAgICAgIF9yZW5kZXJlci5hdXRvQ2xlYXIgPSBmYWxzZTsgLy8gV2UgbWFuYWdlIGNsZWFyaW5nIHZpYSBiYWNrZ3JvdW5kIG9yIG1hbnVhbCBjYWxscyBpZiBuZWVkZWQgKHRob3VnaCBzY2VuZS5iYWNrZ3JvdW5kIGhhbmRsZXMgY29sb3IpCiAgICAgICAgLy8gRXhwb3NlIHJlbmRlcmVyIGZvciBEZXZUb29scwogICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIF9nYW1lTWFuYWdlci5yZW5kZXJlciA9IF9yZW5kZXJlcjsgCiAgICAgICAgZWxzZSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPSB7IHJlbmRlcmVyOiBfcmVuZGVyZXIgfTsgLy8gVGVtcCBob29rCl9jb250YWluZXIuYXBwZW5kQ2hpbGQoX3JlbmRlcmVyLmRvbUVsZW1lbnQpOwoKLy8gLS0tIFZpZGVvIE92ZXJsYXkgRW5mb3JjZW1lbnQgLS0tCiAgICAgICAgLy8gLS0tIE92ZXJsYXkgVmlkZW8gTG9naWMgUmVtb3ZlZCAoU3dpdGNoZWQgdG8gR0lGKSAtLS0KICAgICAgICAvLyA1LiBFbnZpcm9ubWVudAogICAgICAgIGNyZWF0ZVBhcnRpY2xlcygpOwogICAgICAgIGNyZWF0ZUFyZW5hKCk7CmNyZWF0ZUFyZW5hKCk7CiAgICAgICAgY3JlYXRlSG9sb2dyYXBoaWNSaW5ncygpOwovLyA1LjUgR2FtZSBNYW5hZ2VyCl9nYW1lTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5HYW1lTWFuYWdlcihfc2NlbmUsICd1aS1sYXllcicsIF9jYW1lcmEsIF9yZW5kZXJlcik7CiAgICAgICAgCiAgICAgICAgLy8gNS41LjEgQXVkaW8gTWFuYWdlcgogICAgICAgIF9hdWRpb01hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguQXVkaW9NYW5hZ2VyKCk7CiAgICAgICAgX2dhbWVNYW5hZ2VyLmF1ZGlvTWFuYWdlciA9IF9hdWRpb01hbmFnZXI7CgogICAgICAgIC8vIDUuNiBDYW1lcmEgTWFuYWdlcgogICAgICAgIF9jYW1lcmFNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkNhbWVyYU1hbmFnZXIoX2NhbWVyYSwgX3NjZW5lKTsKICAgICAgICBfZ2FtZU1hbmFnZXIuY2FtZXJhTWFuYWdlciA9IF9jYW1lcmFNYW5hZ2VyOwoKICAgICAgICAvLyA1LjcgRGV2IFRvb2xzCmlmICh3aW5kb3cuZmx1eC5EZXZUb29scykgewogICAgICAgICAgICBuZXcgd2luZG93LmZsdXguRGV2VG9vbHMoX2dhbWVNYW5hZ2VyKTsKICAgICAgICB9Ci8vIDUuOCBXYXRlciBPdmVybGF5LCBMaWdodCBTaGFmdHMsIFN0YWRpdW0sIEdseXBocwogICAgICAgIF93YXRlck92ZXJsYXkgPSBuZXcgd2luZG93LmZsdXguV2F0ZXJPdmVybGF5KF9jYW1lcmEpOwogICAgICAgIF9saWdodFNoYWZ0cyA9IG5ldyB3aW5kb3cuZmx1eC5MaWdodFNoYWZ0cyhfc2NlbmUpOwogICAgICAgIF9zdGFkaXVtID0gbmV3IHdpbmRvdy5mbHV4LlN0YWRpdW0oX3NjZW5lKTsKICAgICAgICBfZ2x5cGhNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkdseXBoTWFuYWdlcihfc2NlbmUpOwogICAgICAgIAppZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIF9nYW1lTWFuYWdlci5nbHlwaE1hbmFnZXIgPSBfZ2x5cGhNYW5hZ2VyOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIud2F0ZXJPdmVybGF5ID0gX3dhdGVyT3ZlcmxheTsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmxpZ2h0U2hhZnRzID0gX2xpZ2h0U2hhZnRzOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIuc3RhZGl1bSA9IF9zdGFkaXVtOwogICAgICAgIH0KICAgICAgICAvLyA2LiBUZWFtcyBTZXR1cAogICAgICAgIF9ob21lVGVhbSA9IG5ldyB3aW5kb3cuZmx1eC5UZWFtKF9zY2VuZSwgJ2hvbWUnLCAxLCAweDAwYWFmZiwgdHJ1ZSk7CiAgICAgICAgX2F3YXlUZWFtID0gbmV3IHdpbmRvdy5mbHV4LlRlYW0oX3NjZW5lLCAnYXdheScsIC0xLCAweGZmNjY2NiwgZmFsc2UpOwoKICAgICAgICAvLyA3LiBCYWxsCiAgICAgICAgX2JhbGwgPSBuZXcgd2luZG93LmZsdXguQmFsbChfc2NlbmUpOwoKICAgICAgICAvLyBJTVBST1ZFRDogTGluayBiYWxsIHRvIGNhbWVyYSBmb3Igc21hcnQgZnJhbWluZwogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnNldEJhbGwoX2JhbGwpOwoKICAgICAgICAvLyA4LiBUZWFtIFJvc3RlciBNb2RlbHMKICAgICAgICBjb25zdCByb2xlcyA9IFsnTEYnLCAnUkYnLCAnTUYnLCAnTEQnLCAnUkQnLCAnR0wnXTsKICAgICAgICBjb25zdCBob21lUm9zdGVyID0gewogICAgICAgICAgICBMRjogeyBuYW1lOiAnVGlkdXMnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZGE3ODhiZWYyNThjNGYwYjhkOWVmMWFjYzE5YzU1NjcuZ2xiJyB9LAogICAgICAgICAgICBSRjogeyBuYW1lOiAnV2Fra2EnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJyB9LAogICAgICAgICAgICBNRjogeyBuYW1lOiAnTGV0dHknLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNDNhY2UzNGM2ZmQ5NDIxNTk2N2U4NDJiZjkwOWRhNWUuZ2xiJyB9LAogICAgICAgICAgICBMRDogeyBuYW1lOiAnRGF0dG8nLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZTZkNjdlY2IyZTRjNDcxNWJkNzNhNDA3OTVlMWQzZDUuZ2xiJyB9LAogICAgICAgICAgICBSRDogeyBuYW1lOiAnSmFzc3UnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJyB9LAogICAgICAgICAgICBHTDogeyBuYW1lOiAnQm90dGEnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvYWQxNTVlZmVkYzBkNDhmZGFkMDlkYTNlMWNhZTljOTcuZ2xiJyB9CiAgICAgICAgfTsKCmNvbnN0IGFwcGx5U3RhdHMgPSAocCwgcm9sZSwgaXNIb21lKSA9PiB7CmNvbnN0IHRlYW1MZXZlbCA9IGlzSG9tZSA/IDI1IDogODsgLy8gTmVyZmVkIENQVSBsZXZlbCBzaWduaWZpY2FudGx5ICh3YXMgMTUpCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LlRlYW0uZ2VuZXJhdGVTdGF0cyhwLCByb2xlLCB0ZWFtTGV2ZWwsIGlzSG9tZSk7CgogICAgICAgICAgICBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDU7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNQICs9IDM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDM7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkVOICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdCcm90aGVyJykpIHsKICAgICAgICAgICAgICAgIHAuc3RhdHMuU1AgPSA5OTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcC5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CiAgICAgICAgfTsKCiAgICAgICAgbGV0IGhvbWVMb2FkZWQgPSAwOwogICAgICAgIGNvbnN0IHJvbGVHbHRmcyA9IHt9OwoKICAgICAgICBjb25zdCBmaW5hbGl6ZVRlYW1zID0gKCkgPT4gewogICAgICAgICAgICByb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZ2x0ZiA9IHJvbGVHbHRmc1tyb2xlXSB8fCByb2xlR2x0ZnMuTEY7CgogICAgICAgICAgICAgICAgY29uc3QgcCA9IChyb2xlID09PSAnR0wnKQogICAgICAgICAgICAgICAgICAgID8gbmV3IHdpbmRvdy5mbHV4LkdvYWxpZShfc2NlbmUsIHJvbGUpCiAgICAgICAgICAgICAgICAgICAgOiBuZXcgd2luZG93LmZsdXguQUlQbGF5ZXIoX3NjZW5lLCByb2xlKTsKCiAgICAgICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgICAgICBwLmNoYXJhY3Rlck5hbWUgPSBlbnRyeSA/IGBDUFUgJHtlbnRyeS5uYW1lfWAgOiAnQ1BVJzsKICAgICAgICAgICAgICAgIGFwcGx5U3RhdHMocCwgcm9sZSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmICYmIGdsdGYuc2NlbmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjbG9uZSA9IFRIUkVFLlNrZWxldG9uVXRpbHMuY2xvbmUoZ2x0Zi5zY2VuZSk7CiAgICAgICAgICAgICAgICAgICAgcC5zZXRNZXNoKGNsb25lLCBnbHRmLmFuaW1hdGlvbnMgfHwgW10pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ01pc3NpbmcgR0xURiBmb3IgYXdheSByb2xlOicsIHJvbGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS5hZGRQbGF5ZXIocCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYWxsUGxheWVycyA9IFsuLi5faG9tZVRlYW0ucGxheWVycywgLi4uX2F3YXlUZWFtLnBsYXllcnNdOwogICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAocC5iYWxsUmVmID09PSBudWxsKSBwLmJhbGxSZWYgPSBfYmFsbDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyID0gX2hvbWVUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy50YWNrbGUgPSAndmVub20nOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy5zaG9vdCA9ICdzcGhlcmUnOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0VxdWlwcGVkIEhvbWUgTUYgd2l0aCBWZW5vbSBUYWNrbGUgJiBTcGhlcmUgU2hvdCcpOwogICAgICAgICAgICB9Cgpjb25zdCBhd2F5TUYgPSBfYXdheVRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgLy8gUmVtb3ZlZCBndWFyYW50ZWVkIFdpdGhlciB0YWNrbGUgZm9yIEF3YXkgTUYgdG8gcmVkdWNlIGRpZmZpY3VsdHkKICAgICAgICAgICAgX2F3YXlUZWFtLnNldEZvcm1hdGlvbignQ291bnRlcicpOwoKICAgICAgICAgICAgY29uc3QgYXdheUdMID0gX2F3YXlUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ0dMJyk7CiAgICAgICAgICAgIC8vIFJlbW92ZWQgZ3VhcmFudGVlZCBTdXBlciBHb2FsaWUgZm9yIEF3YXkgR0wgdG8gbWFrZSBzY29yaW5nIGVhc2llcgoKICAgICAgICAgICAgX2hvbWVUZWFtLmFzc2lnbk1hcmtzKF9hd2F5VGVhbSk7CiAgICAgICAgICAgIF9hd2F5VGVhbS5hc3NpZ25NYXJrcyhfaG9tZVRlYW0pOwoKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xvYWRpbmcnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIucmVnaXN0ZXJUZWFtcyhfaG9tZVRlYW0sIF9hd2F5VGVhbSwgX2JhbGwpOwoKICAgICAgICAgICAgICAgIF9tZW51TWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5NZW51TWFuYWdlcihfZ2FtZU1hbmFnZXIpOwogICAgICAgICAgICAgICAgX21lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgfQogICAgICAgIH07Cgpyb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgIGlmICghZW50cnkpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9uQ29tcGxldGUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBob21lTG9hZGVkKys7CiAgICAgICAgICAgICAgICBpZiAoaG9tZUxvYWRlZCA+PSByb2xlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBmaW5hbGl6ZVRlYW1zKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlci5sb2FkTW9kZWwoZW50cnkudXJsLCAoZ2x0ZikgPT4gewogICAgICAgICAgICAgICAgcm9sZUdsdGZzW3JvbGVdID0gZ2x0ZjsKCiAgICAgICAgICAgICAgICBjb25zdCBwID0gKHJvbGUgPT09ICdHTCcpCiAgICAgICAgICAgICAgICAgICAgPyBuZXcgd2luZG93LmZsdXguR29hbGllKF9zY2VuZSwgcm9sZSkKICAgICAgICAgICAgICAgICAgICA6IG5ldyB3aW5kb3cuZmx1eC5BSVBsYXllcihfc2NlbmUsIHJvbGUpOwoKICAgICAgICAgICAgICAgIHAuY2hhcmFjdGVyTmFtZSA9IGVudHJ5Lm5hbWU7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIHRydWUpOwoKICAgICAgICAgICAgICAgIGNvbnN0IGNsb25lID0gVEhSRUUuU2tlbGV0b25VdGlscy5jbG9uZShnbHRmLnNjZW5lKTsKICAgICAgICAgICAgICAgIHAuc2V0TWVzaChjbG9uZSwgZ2x0Zi5hbmltYXRpb25zKTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hZGRQbGF5ZXIocCk7CgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpOwogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2FkIG1vZGVsJywgZW50cnkubmFtZSwgZW50cnkudXJsLCBlcnIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayBNZXNoIChSZWQgQm94KQogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoMSwgMiwgMSk7CiAgICAgICAgICAgICAgICBjb25zdCBmYWxsYmFja01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlIH0pOwogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tNZXNoID0gbmV3IFRIUkVFLk1lc2goZmFsbGJhY2tHZW8sIGZhbGxiYWNrTWF0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU3RvcmUgZHVtbXkgaW4gcm9sZUdsdGZzIGZvciBhd2F5IHRlYW0gY2xvbmluZwogICAgICAgICAgICAgICAgcm9sZUdsdGZzW3JvbGVdID0geyBzY2VuZTogZmFsbGJhY2tNZXNoLCBhbmltYXRpb25zOiBbXSB9OwoKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSAocm9sZSA9PT0gJ0dMJykKICAgICAgICAgICAgICAgICAgICA/IG5ldyB3aW5kb3cuZmx1eC5Hb2FsaWUoX3NjZW5lLCByb2xlKQogICAgICAgICAgICAgICAgICAgIDogbmV3IHdpbmRvdy5mbHV4LkFJUGxheWVyKF9zY2VuZSwgcm9sZSk7CgogICAgICAgICAgICAgICAgcC5jaGFyYWN0ZXJOYW1lID0gZW50cnkubmFtZSArICIgKEVycm9yKSI7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIHRydWUpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBwLnNldE1lc2goZmFsbGJhY2tNZXNoLmNsb25lKCksIFtdKTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hZGRQbGF5ZXIocCk7CgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gOC4gSW5wdXQKICAgICAgICBzZXR1cElucHV0cygpOwoKICAgICAgICAvLyA5LiBMb29wCiAgICAgICAgX2Nsb2NrID0gbmV3IFRIUkVFLkNsb2NrKCk7CiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwoKICAgICAgICAvLyBIYW5kbGUgcmVzaXplCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIG9uUmVzaXplKTsKICAgICAgICBvblJlc2l6ZSgpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlUGFydGljbGVzKCkgewogICAgICAgIGNvbnN0IGNvdW50ID0gMTUwMDsgLy8gSW5jcmVhc2VkIGNvdW50CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IFtdOwogICAgICAgIGNvbnN0IG9mZnNldHMgPSBbXTsgLy8gUmFuZG9tIG9mZnNldHMgZm9yIGluZGVwZW5kZW50IGJvYmJpbmcKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgIHZlcnRpY2VzLnB1c2goCiAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA4MCwgLy8gV2lkZXIgc3ByZWFkIFgKICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDUwLCAvLyBXaWRlciBzcHJlYWQgWQogICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogODAgIC8vIFdpZGVyIHNwcmVhZCBaCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIG9mZnNldHMucHVzaChNYXRoLnJhbmRvbSgpICogMTAwKTsKICAgICAgICB9CgogICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSh2ZXJ0aWNlcywgMykpOwogICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgnYU9mZnNldCcsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKG9mZnNldHMsIDEpKTsKCiAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICB1bmlmb3JtczogX3BhcnRpY2xlVW5pZm9ybXMsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCnZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBhT2Zmc2V0OwogICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2QWxwaGE7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAvLyBCb2JiaW5nIG1vdGlvbjogU2luZSB3YXZlIGJhc2VkIG9uIHRpbWUgKyByYW5kb20gb2Zmc2V0CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYm9iID0gc2luKHVUaW1lICogMC41ICsgYU9mZnNldCkgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gYm9iOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZlYzQgbXZQb3NpdGlvbiA9IG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zLCAxLjApOwogICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG12UG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU2l6ZSBhdHRlbnVhdGlvbiAtIFNtYWxsIGFuZCBzaGltbWVyeQogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNpemVCYXNlID0gMi4wICsgc2luKHVUaW1lICogMy4wICsgYU9mZnNldCkgKiAxLjA7IAogICAgICAgICAgICAgICAgICAgIGdsX1BvaW50U2l6ZSA9IHNpemVCYXNlICogKDIwLjAgLyAtbXZQb3NpdGlvbi56KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBGYWRlIGJhc2VkIG9uIGRpc3RhbmNlL2hlaWdodAogICAgICAgICAgICAgICAgICAgIHZBbHBoYSA9IDAuNSArIDAuNSAqIHNpbih1VGltZSAqIDIuMCArIGFPZmZzZXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgLAogICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2QWxwaGE7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU29mdCBnbG93IHBhcnRpY2xlIChEdXN0IG1vdGUpCiAgICAgICAgICAgICAgICAgICAgdmVjMiBjb29yZCA9IGdsX1BvaW50Q29vcmQgLSB2ZWMyKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGlzdCA9IGxlbmd0aChjb29yZCk7CiAgICAgICAgICAgICAgICAgICAgaWYoZGlzdCA+IDAuNSkgZGlzY2FyZDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTb2Z0IGZhbGxvZmYgZm9yIHNoaW1tZXIKICAgICAgICAgICAgICAgICAgICBmbG9hdCBzdHJlbmd0aCA9IDEuMCAtIChkaXN0ICogMi4wKTsKICAgICAgICAgICAgICAgICAgICBzdHJlbmd0aCA9IHBvdyhzdHJlbmd0aCwgMi4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDeWFuL0JsdWUgdGludCwgYWRkaXRpdmUgZmVlbAogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoMC43LCAwLjksIDEuMCwgdkFscGhhICogc3RyZW5ndGggKiAwLjgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHBvaW50cyA9IG5ldyBUSFJFRS5Qb2ludHMoZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICBwb2ludHMuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgIF9zY2VuZS5hZGQocG9pbnRzKTsKICAgIH0KCmZ1bmN0aW9uIGNyZWF0ZUFyZW5hKCkgewogICAgICAgIC8vIEdyb3VwIGZvciByb3RhdGlvbgogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICBfc2NlbmUuYWRkKHdpbmRvdy5mbHV4LmFyZW5hR3JvdXApOwoKICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeShfY29uZmlnLmFyZW5hUmFkaXVzLCAzMiwgMzIpOwogICAgICAgIAogICAgICAgIC8vIC0tLSAxLiBCYXNlIFNwaGVyZSAoRmFpbnQgR3JpZCkgLS0tCiAgICAgICAgY29uc3QgdGV4TG9hZGVyID0gbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKTsKICAgICAgICBjb25zdCBhcmVuYVRleCA9IHRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9XMUxzSDY4US9maWxlLTAwMDAwMDAwMjNlYzcxZjU5NjU5MzgyOWU4MTE4NzYwLSgxKS5wbmcnKTsKICAgICAgICBhcmVuYVRleC5tYWdGaWx0ZXIgPSBUSFJFRS5OZWFyZXN0RmlsdGVyOwogICAgICAgIGFyZW5hVGV4Lm1pbkZpbHRlciA9IFRIUkVFLk5lYXJlc3RGaWx0ZXI7CiAgICAgICAgYXJlbmFUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBhcmVuYVRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGFyZW5hVGV4LnJlcGVhdC5zZXQoNiwgNCk7CgogICAgICAgIGNvbnN0IG1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiBhcmVuYVRleCwKICAgICAgICAgICAgY29sb3I6IDB4NDQ2Njg4LAogICAgICAgICAgICB3aXJlZnJhbWU6IGZhbHNlLAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4xNSwgCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgY29uc3QgYXJlbmEgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAuYWRkKGFyZW5hKTsKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2ggPSBhcmVuYTsKCiAgICAgICAgLy8gLS0tIDIuIElubmVyIEhleCBHcmlkIChXYXJwIEVmZmVjdCkgLS0tCiAgICAgICAgLy8gUmV1c2UgZXhpc3RpbmcgaGV4IGdlbmVyYXRpb24gbG9naWMgYnV0IGF0dGFjaCB0byBncm91cAogICAgICAgIGNvbnN0IGhleFRleCA9ICgoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICAgICAgYy53aWR0aCA9IDUxMjsgYy5oZWlnaHQgPSA1MTI7CiAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLDAsNTEyLDUxMik7CiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDAsIDI1NSwgMjU1LCAwLjUpJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgIGNvbnN0IHIgPSA2NDsKICAgICAgICAgICAgY29uc3QgdyA9IHIgKiAyOwogICAgICAgICAgICBjb25zdCBoID0gTWF0aC5zcXJ0KDMpICogcjsKICAgICAgICAgICAgZm9yKGxldCB5ID0gLTE7IHkgPCA1MTIvaCArIDI7IHkrKykgewogICAgICAgICAgICAgICAgZm9yKGxldCB4ID0gLTE7IHggPCA1MTIvKHcqMC43NSkgKyAyOyB4KyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjeCA9IHggKiB3ICogMC43NTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjeSA9IHkgKiBoICsgKHglMj09PTAgPyAwIDogaC8yKTsKICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8NjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZyA9IE1hdGguUEkvMyAqIGk7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oY3ggKyBNYXRoLmNvcyhhbmcpKnIsIGN5ICsgTWF0aC5zaW4oYW5nKSpyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICAgICAgfSkoKTsKICAgICAgICBoZXhUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBoZXhUZXgud3JhcFQgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBoZXhUZXgucmVwZWF0LnNldCg0LCAyKTsKCiAgICAgICAgY29uc3QgYXJlbmFVbmlmb3JtcyA9IFRIUkVFLlVuaWZvcm1zVXRpbHMubWVyZ2UoWwogICAgICAgICAgICBUSFJFRS5Vbmlmb3Jtc0xpYlsnY29tbW9uJ10sCiAgICAgICAgICAgIF9hcmVuYVVuaWZvcm1zLAogICAgICAgICAgICB7IAogICAgICAgICAgICAgICAgdE1hcDogeyB2YWx1ZTogaGV4VGV4IH0sCiAgICAgICAgICAgICAgICB1T3BhY2l0eTogeyB2YWx1ZTogMC4xIH0gCiAgICAgICAgICAgIH0KICAgICAgICBdKTsKCiAgICAgICAgY29uc3QgbWF0ZXJpYWwyID0gbmV3IFRIUkVFLlNoYWRlck1hdGVyaWFsKHsKICAgICAgICAgICAgdW5pZm9ybXM6IGFyZW5hVW5pZm9ybXMsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IGAKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVRpbWU7CiAgICAgICAgICAgICAgICB1bmlmb3JtIHZlYzMgdUltcGFjdFBvczsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUltcGFjdFN0cjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdlV2ID0gdXY7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkaXN0ID0gZGlzdGFuY2UocG9zLCB1SW1wYWN0UG9zKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYWRpdXMgPSAyMC4wOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSBkaXN0IC8gcmFkaXVzOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBidWxnZSA9ICgxLjAgLSB0KSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBub3JtYWwgPSBub3JtYWxpemUocG9zKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zICs9IG5vcm1hbCAqIChidWxnZSAqIHVJbXBhY3RTdHIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KHBvcywgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYCwKICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGAKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHRNYXA7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVJbXBhY3RTdHI7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVPcGFjaXR5OwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWM0IHRleENvbG9yID0gdGV4dHVyZTJEKHRNYXAsIHZVdik7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYWxwaGEgPSB1T3BhY2l0eSAqIHRleENvbG9yLmE7CiAgICAgICAgICAgICAgICAgICAgYWxwaGEgKz0gdUltcGFjdFN0ciAqIDAuMDI7IAogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB0ZXhDb2xvci5yZ2IgKiB2ZWMzKDAuMiwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGFscGhhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYAogICAgICAgIH0pOwoKICAgICAgICBjb25zdCBhcmVuYTIgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwyKTsKICAgICAgICBhcmVuYTIuc2NhbGUuc2V0U2NhbGFyKDAuOTgpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAuYWRkKGFyZW5hMik7CiAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMiA9IGFyZW5hMjsKCiAgICAgICAgLy8gLS0tIDMuIFRSSUJBTCBTVFJJUCAoRXF1YXRvcikgLS0tCiAgICAgICAgY29uc3QgdHJpYmFsVGV4ID0gKCgpID0+IHsKICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICBjLndpZHRoID0gMTAyNDsgYy5oZWlnaHQgPSAxMjg7CiAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLDAsMTAyNCwxMjgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQmFja2dyb3VuZCBQYXR0ZXJuCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjEpJzsKICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDEwLCAxMDI0LCAxMDgpOwoKICAgICAgICAgICAgLy8gRGV0YWlsZWQgVHJpYmFsIEdseXBocwogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgICAgICBjb25zdCBibG9ja1cgPSA2NDsKICAgICAgICAgICAgZm9yKGxldCB4PTA7IHg8MTAyNDsgeCs9YmxvY2tXKSB7CiAgICAgICAgICAgICAgICAvLyBPdXRlciBCb3gKICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCh4KzQsIDE1LCBibG9ja1ctOCwgOTgpOwogICAgICAgICAgICAgICAgLy8gSW5uZXIgQ3V0CiAgICAgICAgICAgICAgICBjdHguY2xlYXJSZWN0KHgrMTIsIDI1LCBibG9ja1ctMjQsIDc4KTsKICAgICAgICAgICAgICAgIC8vIENlbnRlciBEb3QKICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCh4KzI4LCA1MCwgOCwgMjgpOwogICAgICAgICAgICAgICAgLy8gQ29ubmVjdG9ycwogICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KHgsIDYwLCAxMiwgOCk7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoeCtibG9ja1ctMTIsIDYwLCAxMiwgOCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIH0pKCk7CiAgICAgICAgdHJpYmFsVGV4LndyYXBTID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgdHJpYmFsVGV4LndyYXBUID0gVEhSRUUuQ2xhbXBUb0VkZ2VXcmFwcGluZzsKICAgICAgICB0cmliYWxUZXgucmVwZWF0LnNldCg0LCAxKTsKCiAgICAgICAgLy8gQ3VzdG9tIFNoYWRlciBmb3IgQ29sb3IgU2hpZnRpbmcKICAgICAgICB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3JtcyA9IHsKICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgdUNvbG9yOiB7IHZhbHVlOiBuZXcgVEhSRUUuQ29sb3IoMHgwMGZmZmYpIH0sIC8vIERlZmF1bHQgQ3lhbgogICAgICAgICAgICB0VGV4OiB7IHZhbHVlOiB0cmliYWxUZXggfQogICAgICAgIH07CgogICAgICAgIGNvbnN0IHRyaWJhbE1hdCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgIHVuaWZvcm1zOiB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3JtcywKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdlV2OwogICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgIHZVdiA9IHV2OwogICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAsCiAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSB2ZWMzIHVDb2xvcjsKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHRUZXg7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdlV2OwogICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgIHZlYzQgdGV4ID0gdGV4dHVyZTJEKHRUZXgsIHZlYzIodlV2LnggKiAyLjAgKyB1VGltZSAqIDAuMDUsIHZVdi55KSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYWxwaGEgPSB0ZXguYSAqIDAuODsKICAgICAgICAgICAgICAgICAgICAvLyBQdWxzZQogICAgICAgICAgICAgICAgICAgIGZsb2F0IHB1bHNlID0gMC44ICsgMC4yICogc2luKHVUaW1lICogMi4wICsgdlV2LnggKiAxMC4wKTsKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KHVDb2xvciAqIHB1bHNlLCBhbHBoYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGAKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgdHJpYmFsR2VvID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTUsIF9jb25maWcuYXJlbmFSYWRpdXMgKiAwLjk1LCAxMiwgNjQsIDEsIHRydWUpOwogICAgICAgIGNvbnN0IHRyaWJhbE1lc2ggPSBuZXcgVEhSRUUuTWVzaCh0cmliYWxHZW8sIHRyaWJhbE1hdCk7CiAgICAgICAgdHJpYmFsTWVzaC5yb3RhdGlvbi54ID0gMDsgLy8gVXByaWdodCBjeWxpbmRlciBtYXRjaGVzIHNwaGVyZSBlcXVhdG9yCiAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5hZGQodHJpYmFsTWVzaCk7CgogICAgICAgIC8vIC0tLSA0LiBIT09LRUQgQVJST1dTIChBYm92ZS9CZWxvdyBTdHJpcCkgLS0tCiAgICAgICAgY29uc3QgYXJyb3dUZXggPSAoKCkgPT4gewogICAgICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgICAgIGMud2lkdGggPSA1MTI7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLDAsNTEyLDY0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKICAgICAgICAgICAgY3R4LnNoYWRvd0JsdXIgPSA1OwogICAgICAgICAgICBjdHguc2hhZG93Q29sb3IgPSAnI2ZmZmZmZic7CgogICAgICAgICAgICBjb25zdCBzdGVwID0gNjQ7CiAgICAgICAgICAgIGZvcihsZXQgeD0wOyB4PDUxMjsgeCs9c3RlcCkgewogICAgICAgICAgICAgICAgLy8gRG91YmxlIEhvb2sgQXJyb3cKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgIC8vIFRvcCBIb29rCiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHgrMjAsIDEwKTsgY3R4LmxpbmVUbyh4KzMyLCAyMCk7IGN0eC5saW5lVG8oeCs0NCwgMTApOwogICAgICAgICAgICAgICAgLy8gU2hhZnQKICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oeCszMiwgMjApOyBjdHgubGluZVRvKHgrMzIsIDQ0KTsKICAgICAgICAgICAgICAgIC8vIEJvdHRvbSBIb29rCiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHgrMjAsIDU0KTsgY3R4LmxpbmVUbyh4KzMyLCA0NCk7IGN0eC5saW5lVG8oeCs0NCwgNTQpOwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICB9KSgpOwogICAgICAgIGFycm93VGV4LndyYXBTID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgYXJyb3dUZXgucmVwZWF0LnNldCg0LCAxKTsKCiAgICAgICAgY29uc3QgYXJyb3dNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGFycm93VGV4LAogICAgICAgICAgICBjb2xvcjogMHgwMGZmZmYsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjYsCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwoKICAgICAgICAvLyBUb3AgUmluZwogICAgICAgIGNvbnN0IGFycm93R2VvVG9wID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTIsIF9jb25maWcuYXJlbmFSYWRpdXMgKiAwLjkyLCA4LCA2NCwgMSwgdHJ1ZSk7CiAgICAgICAgY29uc3QgYXJyb3dNZXNoVG9wID0gbmV3IFRIUkVFLk1lc2goYXJyb3dHZW9Ub3AsIGFycm93TWF0KTsKICAgICAgICBhcnJvd01lc2hUb3AucG9zaXRpb24ueSA9IDEyOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAuYWRkKGFycm93TWVzaFRvcCk7CgogICAgICAgIC8vIEJvdHRvbSBSaW5nCiAgICAgICAgY29uc3QgYXJyb3dNZXNoQm90ID0gbmV3IFRIUkVFLk1lc2goYXJyb3dHZW9Ub3AsIGFycm93TWF0KTsKICAgICAgICBhcnJvd01lc2hCb3QucG9zaXRpb24ueSA9IC0xMjsKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYUdyb3VwLmFkZChhcnJvd01lc2hCb3QpOwoKICAgICAgICAvLyAtLS0gNS4gVE9QIEdMWVBIUyAoRG9tZSkgLS0tCiAgICAgICAgY29uc3QgdG9wR2x5cGhUZXggPSAoKCkgPT4gewogICAgICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgICAgIGMud2lkdGggPSA1MTI7IGMuaGVpZ2h0ID0gNTEyOwogICAgICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgIGN0eC5jbGVhclJlY3QoMCwwLDUxMiw1MTIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMTAwLCAyMDAsIDI1NSwgMC41KSc7CiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoMjU2LCAyNTYsIDIwMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW50cmljYXRlIHBhdHRlcm4KICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ODsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhID0gKGkvOCkqTWF0aC5QSSoyOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IDI1NiArIE1hdGguY29zKGEpKjE1MDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAyNTYgKyBNYXRoLnNpbihhKSoxNTA7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIDQwLCAwLCBNYXRoLlBJKjIpOwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgLy8gQ29ubmVjdG9yCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKDI1NiwgMjU2KTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCwgeSk7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIH0pKCk7CgogICAgICAgIGNvbnN0IHRvcEdseXBoTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiB0b3BHbHlwaFRleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuNCwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHRvcEdseXBoR2VvID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoNjAsIDYwKTsKICAgICAgICBjb25zdCB0b3BHbHlwaCA9IG5ldyBUSFJFRS5NZXNoKHRvcEdseXBoR2VvLCB0b3BHbHlwaE1hdCk7CiAgICAgICAgdG9wR2x5cGgucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICB0b3BHbHlwaC5wb3NpdGlvbi55ID0gMzU7IC8vIE5lYXIgdG9wIG9mIGRvbWUKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYUdyb3VwLmFkZCh0b3BHbHlwaCk7CgogICAgICAgIC8vIC0tLSBORVc6IEZGWCBHT0FMIE1PREVMUyAtLS0KICAgICAgICBjb25zdCBnb2FsVXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hNTE2YmQ5MGZhN2M0ZGVkYjVkY2JmZGY4MDNmMTNkNS5nbGInOwogICAgICAgIAogICAgICAgIGNvbnN0IG9uR29hbExvYWRlZCA9IChtb2RlbCwgaXNGYWxsYmFjaykgPT4gewogICAgICAgICAgICBjb25zdCBnb2FsQSA9IG1vZGVsOwogICAgICAgICAgICAvLyBNb3ZlZCBkb3duIH4xNWZ0ICg0LjVtKSB0b3RhbCBhcyByZXF1ZXN0ZWQsIHB1c2hlZCBiYWNrIHRvIGVkZ2UKICAgICAgICAgICAgZ29hbEEucG9zaXRpb24uc2V0KDAsIC00LjUsIC00Nik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWlzRmFsbGJhY2spIHsKICAgICAgICAgICAgICAgIGdvYWxBLnNjYWxlLnNldFNjYWxhcig1NC4wKTsgLy8gSW5jcmVhc2VkIDUwJSAod2FzIDM2LjApCiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU2V0dXAgR29hbCBBCiAgICAgICAgICAgIGdvYWxBLnRyYXZlcnNlKGMgPT4gewogICAgICAgICAgICAgICAgaWYoYy5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICBjLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsgLy8gQ1JJVElDQUw6IFByZXZlbnQgY3VsbGluZwogICAgICAgICAgICAgICAgICAgIGMucmVuZGVyT3JkZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBtYXRlcmlhbCBpcyB2aXNpYmxlCiAgICAgICAgICAgICAgICAgICAgaWYgKGMubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZmZmZmYpOyAvLyBXaGl0ZSB0byBzaG93IG9yaWdpbmFsIHRleHR1cmUvY29sb3JzICh3YXMgYmx1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC50cmFuc3BhcmVudCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuc2lkZSA9IFRIUkVFLkRvdWJsZVNpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhUZXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyBBZGQgZ29hbHMgdG8gU0NFTkUsIG5vdCBhcmVuYUdyb3VwICh0aGV5IHNob3VsZG4ndCByb3RhdGUgd2l0aCB0aGUgc3BoZXJlKQogICAgICAgICAgICBfc2NlbmUuYWRkKGdvYWxBKTsKCiAgICAgICAgICAgIC8vIFNldHVwIEdvYWwgQgogICAgICAgICAgICBjb25zdCBnb2FsQiA9IGlzRmFsbGJhY2sgPyBnb2FsQS5jbG9uZSgpIDogVEhSRUUuU2tlbGV0b25VdGlscy5jbG9uZShnb2FsQSk7CgogICAgICAgICAgICBnb2FsQi5wb3NpdGlvbi5zZXQoMCwgLTQuNSwgNDYpOyAvLyBNb3ZlZCBjbG9zZXIgKHdhcyA0NSkgYW5kIGRvd24KICAgICAgICAgICAgZ29hbEIucm90YXRpb24ueSA9IE1hdGguUEk7CiAgICAgICAgICAgIC8vIEVuc3VyZSBHb2FsIEIgbWVzaGVzIGFyZSBhbHNvIHBlcnNpc3RlbnQKICAgICAgICAgICAgZ29hbEIudHJhdmVyc2UoYyA9PiB7CiAgICAgICAgICAgICAgICBpZihjLmlzTWVzaCkgYy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgX3NjZW5lLmFkZChnb2FsQik7CiAgICAgICAgfTsKCiAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKGdvYWxVcmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgIG9uR29hbExvYWRlZChnbHRmLnNjZW5lLCBmYWxzZSk7CiAgICAgICAgfSwgdW5kZWZpbmVkLCAoZXJyKSA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiR29hbCBtb2RlbCBmYWlsZWQgdG8gbG9hZC4gVXNpbmcgZmFsbGJhY2suIiwgZXJyKTsKICAgICAgICAgICAgY29uc3QgZ2VvID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KDc1LCA0NSwgMTApOyAvLyBGYWxsYmFjayBtYXNzaXZlIGJveCAoU2NhbGVkIDEuNXgpCiAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZmZmLCB3aXJlZnJhbWU6IHRydWUgfSk7CiAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrID0gbmV3IFRIUkVFLk1lc2goZ2VvLCBmYWxsYmFja01hdCk7CiAgICAgICAgICAgIG9uR29hbExvYWRlZChmYWxsYmFjaywgdHJ1ZSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIC0tLSBORVc6IE1BU1NJVkUgRklFTEQgTUFSS0lOR1MgLS0tCiAgICAgICAgY3JlYXRlRmllbGRNYXJraW5ncygpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlRmllbGRNYXJraW5ncygpIHsKICAgICAgICBjb25zdCBzaXplID0gMTAyNDsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IHNpemU7IGMuaGVpZ2h0ID0gc2l6ZTsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgY3ggPSBzaXplLzI7IGNvbnN0IGN5ID0gc2l6ZS8yOwoKICAgICAgICBjb25zdCBkcmF3ID0gKCkgPT4gewogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIHNpemUsIHNpemUpOwoKICAgICAgICAgICAgLy8gR2xvdyBTZXR0aW5ncwogICAgICAgICAgICBjdHguc2hhZG93Qmx1ciA9IDE1OwogICAgICAgICAgICBjdHguc2hhZG93Q29sb3IgPSAnIzAwZmZmZic7CiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDEwMCwgMjU1LCAyNTUsIDAuOSknOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICAgICAgY3R4LmxpbmVDYXAgPSAncm91bmQnOwoKICAgICAgICAgICAgLy8gMS4gT3V0ZXIgUnVuaWMgUmluZwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoY3gsIGN5LCA0ODAsIDAsIE1hdGguUEkqMik7CiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKCiAgICAgICAgICAgIC8vIDIuIENvbXBsZXggR2VvbWV0cmljIFN0YXIgKFRoZSAiQ29vbCBCaWcgR2x5cGgiKQogICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICBjdHgudHJhbnNsYXRlKGN4LCBjeSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMYXllciBBOiAzIE92ZXJsYXBwaW5nIFNxdWFyZXMgKDEyIHBvaW50cykKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwgMjAwLCAyNTUsIDAuNiknOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMjsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzsgaSsrKSB7CiAgICAgICAgICAgICAgICBjdHgucm90YXRlKE1hdGguUEkgLyA2KTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2VSZWN0KC0zNTAsIC0zNTAsIDcwMCwgNzAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTGF5ZXIgQjogSW5uZXIgQ2lyY2xlcwogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgxMDAsIDI1NSwgMjU1LCAwLjgpJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDU7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYygwLCAwLCAzMjAsIDAsIE1hdGguUEkqMik7IGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDAsIDAsIDEwMCwgMCwgTWF0aC5QSSoyKTsgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgLy8gTGF5ZXIgQzogQ2VudHJhbCBFbWJsZW0gKEJsaXR6YmFsbC1pc2gpCiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbygwLCAtODApOyBjdHgubGluZVRvKDYwLCA0MCk7IGN0eC5saW5lVG8oLTYwLCA0MCk7IGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oMCwgODApOyBjdHgubGluZVRvKC02MCwgLTQwKTsgY3R4LmxpbmVUbyg2MCwgLTQwKTsgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICBjdHgucmVzdG9yZSgpOwoKICAgICAgICAgICAgLy8gMy4gTWlkZmllbGQgTGluZQogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjUpJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDM7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbygwLCBjeSk7IGN0eC5saW5lVG8oc2l6ZSwgY3kpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyA0LiBHb2FsIEJveGVzIChUcmFwZXpvaWRzKQogICAgICAgICAgICBjb25zdCBkcmF3R29hbEJveCA9ICh5UG9zLCBkaXIpID0+IHsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3ggLSAxNTAsIHlQb3MpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIDE1MCwgeVBvcyk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgMjI1LCB5UG9zICsgKGRpciAqIDEyMCkpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCAtIDIyNSwgeVBvcyArIChkaXIgKiAxMjApKTsKICAgICAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgZHJhd0dvYWxCb3goNTAsIDEpOyAvLyBUb3AKICAgICAgICAgICAgZHJhd0dvYWxCb3goc2l6ZS01MCwgLTEpOyAvLyBCb3R0b20KCiAgICAgICAgICAgIC8vIDUuIFJ1bmVzIFRleHQgUmluZwogICAgICAgICAgICBjdHguZm9udCA9ICczNnB4IFNwaXJhLCBtb25vc3BhY2UnOyAKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICdyZ2JhKDAsIDI1NSwgMjU1LCAwLjgpJzsKICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBydW5lcyA9ICJZRVZPTiBTSU4gWkFOQVJLQU5EIEVURVJOQUwgQ0FMTSBTUEhFUkUgUE9PTCBCTElUWiBBQ0UgIjsKICAgICAgICAgICAgY29uc3QgcnVuZUNvdW50ID0gNDA7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHJ1bmVDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gcnVuZUNvdW50KSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgY29uc3QgciA9IDQ0MDsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBjeCArIE1hdGguY29zKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gY3kgKyBNYXRoLnNpbihhbmdsZSkgKiByOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICAgICAgY3R4LnRyYW5zbGF0ZSh4LCB5KTsKICAgICAgICAgICAgICAgIGN0eC5yb3RhdGUoYW5nbGUgKyBNYXRoLlBJLzIpOwogICAgICAgICAgICAgICAgY29uc3QgY2hhciA9IHJ1bmVzW2kgJSBydW5lcy5sZW5ndGhdOwogICAgICAgICAgICAgICAgY3R4LmZpbGxUZXh0KGNoYXIsIDAsIDApOwogICAgICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8vIEF0dGVtcHQgdG8gbG9hZCBmb250IGZpcnN0CiAgICAgICAgZG9jdW1lbnQuZm9udHMubG9hZCgnMzZweCBTcGlyYScpLnRoZW4oKCkgPT4gewogICAgICAgICAgICBkcmF3KCk7CiAgICAgICAgfSkuY2F0Y2goKCkgPT4gewogICAgICAgICAgICBkcmF3KCk7CiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHRleC5hbmlzb3Ryb3B5ID0gMTY7CgogICAgICAgIC8vIEZsb29yIFBsYW5lIChEZWVwKQogICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDkwLCA5MCk7CiAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiB0ZXgsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBvcGFjaXR5OiAwLjksCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZwogICAgICAgIH0pOwoKICAgICAgICBjb25zdCBmaWVsZCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgbWF0KTsKICAgICAgICBmaWVsZC5yb3RhdGlvbi54ID0gLU1hdGguUEkgLyAyOwogICAgICAgIGZpZWxkLnBvc2l0aW9uLnkgPSAtOC4wOyAvLyBTdW5rIGRlZXAKICAgICAgICBfc2NlbmUuYWRkKGZpZWxkKTsKICAgIH0KCmZ1bmN0aW9uIGNyZWF0ZUhvbG9ncmFwaGljUmluZ3MoKSB7CiAgICAgICAgLy8gRmxvYXRpbmcgSG9sb2dyYXBoaWMgUmluZ3MgKE1pZC1oZWlnaHQpCiAgICAgICAgY29uc3QgcmluZ0dlbyA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KDIwLCAwLjEsIDE2LCAxMDApOwogICAgICAgIGNvbnN0IHJpbmdNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgwMGZmZmYsIHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjMsIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nIH0pOwogICAgICAgIGNvbnN0IHJpbmcxID0gbmV3IFRIUkVFLk1lc2gocmluZ0dlbywgcmluZ01hdCk7CiAgICAgICAgcmluZzEucm90YXRpb24ueCA9IE1hdGguUEkgLyAyOwogICAgICAgIHJpbmcxLnBvc2l0aW9uLnkgPSAwOwogICAgICAgIF9zY2VuZS5hZGQocmluZzEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHJpbmcyID0gbmV3IFRIUkVFLk1lc2gocmluZ0dlbywgcmluZ01hdCk7CiAgICAgICAgcmluZzIucm90YXRpb24ueCA9IE1hdGguUEkgLyAyOwogICAgICAgIHJpbmcyLnNjYWxlLnNldFNjYWxhcigxLjIpOwogICAgICAgIHJpbmcyLnBvc2l0aW9uLnkgPSA0LjA7CiAgICAgICAgX3NjZW5lLmFkZChyaW5nMik7CgogICAgICAgIC8vIEFuaW1hdGUgUmluZ3MgKGludGVncmF0ZWQgaW50byBtYWluIGxvb3AgdG8gYXZvaWQgYSBzZWNvbmQgUkFGIG9uIG1vYmlsZSkKICAgICAgICBsZXQgX3JpbmdUaW1lID0gMDsKICAgICAgICBjb25zdCBfcmluZ1VwZGF0ZSA9IChkdCkgPT4gewogICAgICAgICAgICBfcmluZ1RpbWUgKz0gZHQ7CiAgICAgICAgICAgIGlmIChyaW5nMSkgewogICAgICAgICAgICAgICAgcmluZzEucm90YXRpb24ueiArPSBkdCAqIDAuOTsKICAgICAgICAgICAgICAgIHJpbmcxLnNjYWxlLnNldFNjYWxhcigxLjAgKyBNYXRoLnNpbihfcmluZ1RpbWUgKiAwLjUpICogMC4wNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJpbmcyKSB7CiAgICAgICAgICAgICAgICByaW5nMi5yb3RhdGlvbi56IC09IGR0ICogMC43NTsKICAgICAgICAgICAgICAgIHJpbmcyLnBvc2l0aW9uLnkgPSA0LjAgKyBNYXRoLmNvcyhfcmluZ1RpbWUgKiAwLjcpICogMS4wOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycykgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycy5wdXNoKF9yaW5nVXBkYXRlKTsKICAgIH0KCiAgICAvLyAtLS0gSU5QVVQgU1lTVEVNIC0tLQovLyAtLS0gSU5QVVQgU1lTVEVNIC0tLQpjb25zdCBfa2V5cyA9IHt9OwovLyBHbG9iYWxzIG1vdmVkIHRvIGJlbG93IGhlbHBlcgoKICAgIC8vIEhlbHBlcjogQW5hbHl6ZSBjdXJ2ZSBnZW9tZXRyeSBmb3IgYW5hbG9nIGNvbnRyb2wKICAgIGNvbnN0IGFuYWx5emVTd2lwZUN1cnZlID0gKHBvaW50cykgPT4gewogICAgICAgIGlmIChwb2ludHMubGVuZ3RoIDwgMykgcmV0dXJuIHsgaW50ZW5zaXR5OiAwLCBzcGVlZDogMCwgZHg6IDAsIGR5OiAwIH07CiAgICAgICAgCiAgICAgICAgY29uc3QgcFN0YXJ0ID0gcG9pbnRzWzBdOwogICAgICAgIGNvbnN0IHBFbmQgPSBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDFdOwogICAgICAgIGNvbnN0IG1pZElkeCA9IE1hdGguZmxvb3IocG9pbnRzLmxlbmd0aCAvIDIpOwogICAgICAgIGNvbnN0IHBNaWQgPSBwb2ludHNbbWlkSWR4XTsKCiAgICAgICAgY29uc3QgZHggPSBwRW5kLnggLSBwU3RhcnQueDsKICAgICAgICBjb25zdCBkeSA9IHBFbmQueSAtIHBTdGFydC55OwogICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CiAgICAgICAgY29uc3QgZHQgPSBwRW5kLnQgLSBwU3RhcnQudDsKICAgICAgICBjb25zdCBzcGVlZCA9IChkdCA+IDApID8gZGlzdCAvIGR0IDogMDsgLy8gcHgvbXMKCiAgICAgICAgaWYgKGRpc3QgPCA1MCkgcmV0dXJuIHsgaW50ZW5zaXR5OiAwLCBzcGVlZDogc3BlZWQsIGR4LCBkeSB9OwoKICAgICAgICBjb25zdCB2U01feCA9IHBNaWQueCAtIHBTdGFydC54OwogICAgICAgIGNvbnN0IHZTTV95ID0gcE1pZC55IC0gcFN0YXJ0Lnk7CgogICAgICAgIC8vIENyb3NzIHByb2R1Y3QgZ2l2ZXMgc2lnbmVkIGFyZWEvY3VydmF0dXJlIGRpcmVjdGlvbgogICAgICAgIGNvbnN0IGNyb3NzID0gKGR4ICogdlNNX3kpIC0gKGR5ICogdlNNX3gpOwogICAgICAgIC8vIE5vcm1hbGl6ZSBieSBkaXN0YW5jZSBzcXVhcmVkIHRvIGdldCBhIGN1cnZhdHVyZSByYXRpbyBpbmRlcGVuZGVudCBvZiBzY2FsZQpjb25zdCBpbnRlbnNpdHkgPSBjcm9zcyAvIChkaXN0ICogZGlzdCk7CgogICAgICAgIHJldHVybiB7IGludGVuc2l0eSwgc3BlZWQsIGR4LCBkeSB9OwogICAgfTsKICAgIGxldCBfc3dpcGVQb2ludHMgPSBbXTsgLy8gVHJhY2sgc3dpcGUgaGlzdG9yeSBmb3IgY3VydmVzCiAgICBjb25zdCBfYWltSW5wdXQgPSB7IHg6IDAsIHk6IDAsIGFjdGl2ZTogZmFsc2UgfTsgLy8gTkVXOiBBaW0gam95c3RpY2sKCiAgICBjb25zdCBfYWN0aW9uQnVmZmVyID0geyBhY3RpdmU6IGZhbHNlLCB0aW1lc3RhbXA6IDAsIGR1cmF0aW9uOiAzMDAgfTsKCiAgICBjb25zdCBfY2FtRndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1SaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdXBBeGlzID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CgogICAgZnVuY3Rpb24gc2V0dXBJbnB1dHMoKSB7CiAgICAgICAgLy8gS2V5Ym9hcmQKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgIF9rZXlzW2Uua2V5XSA9IHRydWU7CiAgICAgICAgICAgIGlmIChlLmNvZGUgPT09ICdTcGFjZScgJiYgX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIgJiYgX2JhbGwpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIudGhyb3dCYWxsKF9iYWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBORVc6IFRhY2tsZSBvbiBTaGlmdAogICAgICAgICAgICBpZiAoZS5jb2RlID09PSAnU2hpZnRMZWZ0JyB8fCBlLmNvZGUgPT09ICdTaGlmdFJpZ2h0JykgewogICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5kYXNoKHAuaW5wdXRWZWN0b3IueCwgcC5pbnB1dFZlY3Rvci56KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9KTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5dXAnLCAoZSkgPT4geyBfa2V5c1tlLmtleV0gPSBmYWxzZTsgdXBkYXRlSW5wdXRWZWN0b3IoKTsgfSk7CgogICAgICAgIC8vIC0tLSBGTE9BVElORyBKT1lTVElDSyAoTW92ZW1lbnQpIC0tLQogICAgICAgIGNvbnN0IGhpdFpvbmUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2staGl0LXpvbmUnKTsKICAgICAgICBjb25zdCB2aXN1YWxzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2pveXN0aWNrLXZpc3VhbC1jb250YWluZXInKTsKICAgICAgICBjb25zdCBiYXNlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2pveXN0aWNrLWJhc2UnKTsKICAgICAgICBjb25zdCBrbm9iID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2pveXN0aWNrLWtub2InKTsKCiAgICAgICAgbGV0IHN0YXJ0WCA9IDAsIHN0YXJ0WSA9IDA7CiAgICAgICAgbGV0IGRyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgY29uc3QgbWF4RGlzdCA9IDQwOwoKICAgICAgICBsZXQgbW92ZVRvdWNoSWQgPSBudWxsOwogICAgICAgIGNvbnN0IG1vdmVEZWFkem9uZVB4ID0gNjsKCiAgICAgICAgLy8gRXhwb3NlIG1vdmUgam95c3RpY2sgc3RhdGUgZm9yIHNuYXBzaG90cwogICAgICAgIGNvbnN0IF9kYmcgPSB3aW5kb3cuZmx1eC5fZGVidWdJTyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIHx8IHt9OwogICAgICAgIF9kYmcuc2V0dGluZ3MgPSBfc2V0dGluZ3M7CiAgICAgICAgX2RiZy5pbnB1dCA9IF9kYmcuaW5wdXQgfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5tb3ZlID0gX2RiZy5pbnB1dC5tb3ZlIHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQubW92ZS52ZWN0b3IgPSBfaW5wdXQ7CiAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLmRyYWdnaW5nID0gZHJhZ2dpbmc7CiAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnRvdWNoSWQgPSBtb3ZlVG91Y2hJZDsKCgogICAgICAgIGNvbnN0IGhhbmRsZVN0YXJ0ID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgZHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICBzdGFydFggPSBjbGllbnRYOwoKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0Lm1vdmUpIHsKICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS5kcmFnZ2luZyA9IGRyYWdnaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzdGFydFkgPSBjbGllbnRZOwoKICAgICAgICAgICAgdmlzdWFscy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgdmlzdWFscy5zdHlsZS5sZWZ0ID0gYCR7Y2xpZW50WH1weGA7CiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUudG9wID0gYCR7Y2xpZW50WX1weGA7CgogICAgICAgICAgICBrbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoLTUwJSwgLTUwJSlgOwoKICAgICAgICAgICAgY3JlYXRlUmlwcGxlKGNsaWVudFgsIGNsaWVudFkpOwoKICAgICAgICAgICAgX2lucHV0LnggPSAwOwogICAgICAgICAgICBfaW5wdXQueSA9IDA7CiAgICAgICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgaGFuZGxlTW92ZSA9IChjbGllbnRYLCBjbGllbnRZKSA9PiB7CiAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKCiAgICAgICAgICAgIGxldCBkeCA9IGNsaWVudFggLSBzdGFydFg7CiAgICAgICAgICAgIGxldCBkeSA9IGNsaWVudFkgLSBzdGFydFk7CgogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwoKCiAgICAgICAgICAgIC8vIERlYWR6b25lIHRvIHByZXZlbnQgZHJpZnQgZnJvbSB0aW55IHRodW1iIGppdHRlcgogICAgICAgICAgICBpZiAoZGlzdCA8IG1vdmVEZWFkem9uZVB4KSB7CiAgICAgICAgICAgICAgICBkeCA9IDA7CiAgICAgICAgICAgICAgICBkeSA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkaXN0ID4gbWF4RGlzdCkgewogICAgICAgICAgICAgICAgZHggPSAoZHggLyBkaXN0KSAqIG1heERpc3Q7CiAgICAgICAgICAgICAgICBkeSA9IChkeSAvIGRpc3QpICogbWF4RGlzdDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAga25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKGNhbGMoLTUwJSArICR7ZHh9cHgpLCBjYWxjKC01MCUgKyAke2R5fXB4KSlgOwoKICAgICAgICAgICAgX2lucHV0LnggPSAoZHggLyBtYXhEaXN0KSAqIF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5OwogICAgICAgICAgICBfaW5wdXQueSA9IChkeSAvIG1heERpc3QpICogX3NldHRpbmdzLmpveXN0aWNrU2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgaGFuZGxlRW5kID0gKCkgPT4gewogICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgIGRyYWdnaW5nID0gZmFsc2U7CgogICAgICAgICAgICBtb3ZlVG91Y2hJZCA9IG51bGw7CgogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CgogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQubW92ZSkgewogICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLmRyYWdnaW5nID0gZHJhZ2dpbmc7CiAgICAgICAgICAgICAgICBfZGJnLmlucHV0Lm1vdmUudG91Y2hJZCA9IG1vdmVUb3VjaElkOwogICAgICAgICAgICB9CgoKICAgICAgICAgICAgX2lucHV0LnggPSAwOwogICAgICAgICAgICBfaW5wdXQueSA9IDA7CiAgICAgICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CiAgICAgICAgfTsKCiAgICAgICAgaWYgKGhpdFpvbmUpIHsKICAgICAgICAgICAgaGl0Wm9uZS5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzWzBdKSA/IGUuY2hhbmdlZFRvdWNoZXNbMF0gOiBlLnRvdWNoZXNbMF07CiAgICAgICAgICAgICAgICBtb3ZlVG91Y2hJZCA9IHQgPyB0LmlkZW50aWZpZXIgOiBudWxsOwogICAgICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0Lm1vdmUpIHsKICAgICAgICAgICAgICAgICAgICBfZGJnLmlucHV0Lm1vdmUudG91Y2hJZCA9IG1vdmVUb3VjaElkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaGFuZGxlU3RhcnQodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWRyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBtb3ZlVG91Y2hJZCk7CiAgICAgICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgICAgIGhhbmRsZU1vdmUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgbW92ZVRvdWNoSWQpOwogICAgICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47IC8vIElnbm9yZSBvdGhlciBmaW5nZXJzIGxpZnRpbmcKICAgICAgICAgICAgICAgIGhhbmRsZUVuZCgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgbW92ZVRvdWNoSWQpOwogICAgICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47CiAgICAgICAgICAgICAgICBoYW5kbGVFbmQoKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBoaXRab25lLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBoYW5kbGVTdGFydChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChkcmFnZ2luZykgaGFuZGxlTW92ZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGhhbmRsZUVuZCk7CiAgICAgICAgfQoKICAgICAgICAvLyAtLS0gTkVXOiBBSU0gSk9ZU1RJQ0sgKFJpZ2h0IHNpZGUpIC0tLQogICAgICAgIHNldHVwQWltSm95c3RpY2soKTsKCiAgICAgICAgLy8gLS0tIE5FVzogVEFDS0xFIEJVVFRPTiAtLS0KICAgICAgICBzZXR1cFRhY2tsZUJ1dHRvbigpOwoKICAgICAgICAvLyBTd2lwZSBEZXRlY3Rpb24KLy8gU3dpcGUgRGV0ZWN0aW9uCiAgICAgICAgbGV0IHN3aXBlU3RhcnQgPSB7IHg6IDAsIHk6IDAsIHQ6IDAgfTsKICAgICAgICBsZXQgc3dpcGVUb3VjaElkID0gbnVsbDsKICAgICAgICAKICAgICAgICAvLyBFeHBvc2Ugc3dpcGUvdGhyb3cgZ2VzdHVyZSBzdGF0ZSBmb3Igc25hcHNob3RzCiAgICAgICAgX2RiZy5pbnB1dC5zd2lwZSA9IF9kYmcuaW5wdXQuc3dpcGUgfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5zd2lwZS5zdGFydCA9IHN3aXBlU3RhcnQ7CiAgICAgICAgX2RiZy5pbnB1dC5zd2lwZS50b3VjaElkID0gc3dpcGVUb3VjaElkOwogICAgICAgIF9kYmcuaW5wdXQuc3dpcGUucG9pbnRzID0gX3N3aXBlUG9pbnRzOwpjb25zdCBvblN3aXBlU3RhcnQgPSAoeCwgeSkgPT4gewogICAgICAgICAgICBzd2lwZVN0YXJ0LnggPSB4OwogICAgICAgICAgICBzd2lwZVN0YXJ0LnkgPSB5OwogICAgICAgICAgICBzd2lwZVN0YXJ0LnQgPSBEYXRlLm5vdygpOwogICAgICAgICAgICBfc3dpcGVQb2ludHMgPSBbe3gsIHksIHQ6IERhdGUubm93KCl9XTsKICAgICAgICB9OwoKY29uc3Qgb25Td2lwZU1vdmUgPSAoeCwgeSkgPT4gewogICAgICAgICAgICBpZiAoX3N3aXBlUG9pbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIF9zd2lwZVBvaW50cy5wdXNoKHt4LCB5LCB0OiBEYXRlLm5vdygpfSk7CiAgICAgICAgICAgICAgICBjcmVhdGVTd2lwZVRyYWlsRG90KHgsIHkpOyAvLyBWaXN1YWwgRmVlZGJhY2sKICAgICAgICAgICAgfQogICAgICAgIH07Cgpjb25zdCBvblN3aXBlRW5kID0gKHgsIHkpID0+IHsKICAgICAgICAgICAgaWYgKF9zd2lwZVBvaW50cy5sZW5ndGggPCAyKSByZXR1cm47CiAgICAgICAgICAgIF9zd2lwZVBvaW50cy5wdXNoKHt4LCB5LCB0OiBEYXRlLm5vdygpfSk7CgogICAgICAgICAgICBjb25zdCB7IGludGVuc2l0eSwgc3BlZWQsIGR4LCBkeSB9ID0gYW5hbHl6ZVN3aXBlQ3VydmUoX3N3aXBlUG9pbnRzKTsKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllciAmJiBfY2FtZXJhKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgICAgICAvLyAtLS0gQ1VSVkUgQkFMTCBERVRFQ1RJT04gKEltbWVkaWF0ZSBUaHJvdykgLS0tCi8vIC0tLSBDVVJWRSBCQUxMIERFVEVDVElPTiAoSW1tZWRpYXRlIFRocm93KSAtLS0KICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgJiYgIXAuaXNUaHJvd2luZyAmJiAhcC5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQW5hbG9nIEN1cnZlIENoZWNrOiBUaHJlc2hvbGQgMC4yNSByZXF1aXJlcyBhIGRlbGliZXJhdGUgYXJjIChUaGUgIkZlYXQiKQogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhpbnRlbnNpdHkpID4gMC4yNSAmJiBkaXN0ID4gMTAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7IF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFggPSAoX2NhbVJpZ2h0LnggKiBkeCkgKyAoX2NhbUZ3ZC54ICogLWR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRaID0gKF9jYW1SaWdodC56ICogZHgpICsgKF9jYW1Gd2QueiAqIC1keSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRocm93RGlyID0gbmV3IFRIUkVFLlZlY3RvcjMod29ybGRYLCAwLCB3b3JsZFopLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTWFwIGludGVuc2l0eSB0byBzcGluIC0gRHJhc3RpY2FsbHkgcmVkdWNlZCBzZW5zaXRpdml0eQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByYXdTcGluID0gTWF0aC5hYnMoaW50ZW5zaXR5KSAqIDMwMC4wOyAKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BlZWRGYWN0b3IgPSBNYXRoLm1pbigxLjUsIHNwZWVkIC8gMS4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblBvd2VyID0gTWF0aC5taW4oNDAwLjAsIHJhd1NwaW4gKiBzcGVlZEZhY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5TaWduID0gTWF0aC5zaWduKGludGVuc2l0eSk7IAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3BpblBvd2VyICogc3BpblNpZ24sIDApOwoKCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0T3ZlcnJpZGVBaW0odGhyb3dEaXIueCwgdGhyb3dEaXIueik7CiAgICAgICAgICAgICAgICAgICAgICAgIHAudGhyb3dCYWxsKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsLCAnU0gnLCAxLjAsIHNwaW5WZWMpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNVUlZFIiwgcC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZVJpcHBsZSh4LCB5KTsKICAgICAgICAgICAgICAgICAgICAgICAgX3N3aXBlUG9pbnRzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIC0tLSBTVEFOREFSRCBEQVNIIC8gQUlNIC0tLQogICAgICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgICAgIGVsc2UgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwoKY29uc3Qgd29ybGRYMiA9IChfY2FtUmlnaHQueCAqIGR4KSArIChfY2FtRndkLnggKiAtZHkpOwogICAgICAgICAgICAgICAgY29uc3Qgd29ybGRaMiA9IChfY2FtUmlnaHQueiAqIGR4KSArIChfY2FtRndkLnogKiAtZHkpOwoKICAgICAgICAgICAgICAgIGlmIChwLmlzVGhyb3dpbmcpIHsKcC5zZXRPdmVycmlkZUFpbSh3b3JsZFgyLCB3b3JsZFoyKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJBSU0hIiwgcC5tZXNoLnBvc2l0aW9uLCAiZGVmYXVsdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CmlmIChkaXN0ID4gNTApIHAuZGFzaCh3b3JsZFgyLCB3b3JsZFoyKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjcmVhdGVSaXBwbGUoeCwgeSk7CiAgICAgICAgICAgIH0KX3N3aXBlUG9pbnRzID0gW107CiAgICAgICAgfTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCB0ID0gKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlc1swXSkgPyBlLmNoYW5nZWRUb3VjaGVzWzBdIDogZS50b3VjaGVzWzBdOwogICAgICAgICAgICBzd2lwZVRvdWNoSWQgPSB0ID8gdC5pZGVudGlmaWVyIDogbnVsbDsKLy8gb25Td2lwZVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsgLy8gRml4ZWQgc3ludGF4IGVycm9yCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5zd2lwZSkgeyBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7IH0KICAgICAgICAgICAgb25Td2lwZVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICAgICAgY3JlYXRlUmlwcGxlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdCA9IF9maW5kVG91Y2hCeUlkKGUudG91Y2hlcywgc3dpcGVUb3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgIG9uU3dpcGVNb3ZlKHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgc3dpcGVUb3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47IC8vIElnbm9yZSBvdGhlciBmaW5nZXJzIGxpZnRpbmcKICAgICAgICAgICAgb25Td2lwZUVuZCh0RW5kLmNsaWVudFgsIHRFbmQuY2xpZW50WSk7CiAgICAgICAgICAgIHN3aXBlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5zd2lwZSkgeyBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7IH0KICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCAoZSkgPT4gewppZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgc3dpcGVUb3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47IC8vIElnbm9yZSBvdGhlciBmaW5nZXJzIGxpZnRpbmcKICAgICAgICAgICAgb25Td2lwZUVuZCh0RW5kLmNsaWVudFgsIHRFbmQuY2xpZW50WSk7CiAgICAgICAgICAgIHN3aXBlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5zd2lwZSkgeyBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7IH0KICAgICAgICAKICAgICAgICB9KTsKLy8gTW91c2UgU3dpcGUKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwoKICAgICAgICAgICAgb25Td2lwZVN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgY3JlYXRlUmlwcGxlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpKSByZXR1cm47CiAgICAgICAgICAgIC8vIE9ubHkgdHJhY2sgaWYgbW91c2UgaXMgZG93biAoc2ltdWxhdGluZyBkcmFnKQogICAgICAgICAgICBpZiAoZS5idXR0b25zID09PSAxKSB7CiAgICAgICAgICAgICAgICBvblN3aXBlTW92ZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2F1dG8tdG9nZ2xlJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNzZXR0aW5ncy1idXR0b24nKSkgcmV0dXJuOwogICAgICAgICAgICBvblN3aXBlRW5kKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gQWN0aW9uIEJ1dHRvbiAoU2hvb3QvUGFzcykKICAgICAgICBjb25zdCBhY3Rpb25CdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWJ1dHRvbicpOwoKY29uc3Qgc2V0dXBCdXR0b24gPSAoYnRuKSA9PiB7CiAgICAgICAgICAgIGlmICghYnRuKSByZXR1cm47CgogICAgICAgICAgICBsZXQgYnRuU3RhcnRYID0gMDsKICAgICAgICAgICAgbGV0IGJ0blN0YXJ0WSA9IDA7CiAgICAgICAgICAgIGxldCBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIGxldCBzd2lwZVBvaW50cyA9IFtdOwogICAgICAgICAgICBsZXQgYWN0aW9uVG91Y2hJZCA9IG51bGw7CgogICAgICAgICAgICBjb25zdCBhdHRlbXB0QWN0aW9uID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgJiYgIXAuaXNDaGFyZ2luZyAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcC5zdGFydENoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGNvbnN0IGhhbmRsZVN0YXJ0ID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci50ZWNoQ29weVN0YXRlLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci5hdHRlbXB0VGVjaENvcHkoKTsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyksIDEwMCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmlzRGVtb01vZGUpIHJldHVybjsKCiAgICAgICAgICAgICAgICBsZXQgY2xpZW50WCA9IGUuY2xpZW50WDsKICAgICAgICAgICAgICAgIGxldCBjbGllbnRZID0gZS5jbGllbnRZOwogICAgICAgICAgICAgICAgaWYgKGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gZS5jaGFuZ2VkVG91Y2hlc1swXTsKICAgICAgICAgICAgICAgICAgICBhY3Rpb25Ub3VjaElkID0gdC5pZGVudGlmaWVyOwogICAgICAgICAgICAgICAgICAgIGNsaWVudFggPSB0LmNsaWVudFg7CiAgICAgICAgICAgICAgICAgICAgY2xpZW50WSA9IHQuY2xpZW50WTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aW9uVG91Y2hJZCA9IG51bGw7IC8vIG1vdXNlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBidG5TdGFydFggPSBjbGllbnRYOwogICAgICAgICAgICAgICAgYnRuU3RhcnRZID0gY2xpZW50WTsKICAgICAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgc3dpcGVQb2ludHMgPSBbe3g6IGNsaWVudFgsIHk6IGNsaWVudFksIHQ6IERhdGUubm93KCl9XTsKCiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLnRpbWVzdGFtcCA9IERhdGUubm93KCk7CgogICAgICAgICAgICAgICAgaWYgKGF0dGVtcHRBY3Rpb24oKSkgewogICAgICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQXR0YWNoIGdsb2JhbCBsaXN0ZW5lcnMgdG8gdHJhY2sgc3dpcGUgb3V0c2lkZSBidXR0b24KICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBoYW5kbGVNb3ZlLCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlTW92ZSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBoYW5kbGVNb3ZlID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghaXNEcmFnZ2luZykgcmV0dXJuOwoKICAgICAgICAgICAgICAgIC8vIFRvdWNoIHBhdGggKG11bHRpLXRvdWNoIHNhZmUpCiAgICAgICAgICAgICAgICBpZiAoZS50b3VjaGVzICYmIGFjdGlvblRvdWNoSWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBhY3Rpb25Ub3VjaElkKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBzd2lwZVBvaW50cy5wdXNoKHt4OiB0LmNsaWVudFgsIHk6IHQuY2xpZW50WSwgdDogRGF0ZS5ub3coKX0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNb3VzZSBwYXRoCiAgICAgICAgICAgICAgICBjb25zdCBjbGllbnRYID0gZS5jbGllbnRYOwogICAgICAgICAgICAgICAgY29uc3QgY2xpZW50WSA9IGUuY2xpZW50WTsKICAgICAgICAgICAgICAgIHN3aXBlUG9pbnRzLnB1c2goe3g6IGNsaWVudFgsIHk6IGNsaWVudFksIHQ6IERhdGUubm93KCl9KTsKICAgICAgICAgICAgfTsKCmNvbnN0IGhhbmRsZUVuZCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgZHggPSAwOwogICAgICAgICAgICAgICAgbGV0IGR5ID0gMDsKICAgICAgICAgICAgICAgIGxldCB2YWxpZEVuZCA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIC8vIDEuIENoZWNrIFRvdWNoCiAgICAgICAgICAgICAgICBpZiAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBhY3Rpb25Ub3VjaElkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBhY3Rpb25Ub3VjaElkKTsKICAgICAgICAgICAgICAgICAgICBpZiAodEVuZCkgewogICAgICAgICAgICAgICAgICAgICAgICBkeCA9IHRFbmQuY2xpZW50WCAtIGJ0blN0YXJ0WDsKICAgICAgICAgICAgICAgICAgICAgICAgZHkgPSB0RW5kLmNsaWVudFkgLSBidG5TdGFydFk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkRW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIC8vIDIuIENoZWNrIE1vdXNlCiAgICAgICAgICAgICAgICBlbHNlIGlmICghZS5jaGFuZ2VkVG91Y2hlcyAmJiBpc0RyYWdnaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgZHggPSBlLmNsaWVudFggLSBidG5TdGFydFg7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBlLmNsaWVudFkgLSBidG5TdGFydFk7CiAgICAgICAgICAgICAgICAgICAgdmFsaWRFbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghdmFsaWRFbmQpIHJldHVybjsKCiAgICAgICAgICAgICAgICAvLyBDbGVhbnVwIGxpc3RlbmVycwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGhhbmRsZU1vdmUpOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGhhbmRsZUVuZCk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlTW92ZSk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGhhbmRsZUVuZCk7CgogICAgICAgICAgICAgICAgaWYgKCFpc0RyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHdhc0J1ZmZlcmVkID0gX2FjdGlvbkJ1ZmZlci5hY3RpdmU7CiAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEN1cnZlIEFuYWx5c2lzCiAgICAgICAgICAgICAgICAgICAgbGV0IGN1cnZlRGF0YSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgbGV0IHNwaW5WZWMgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgY3VydmUgaWYgd2UgaGF2ZSBlbm91Z2ggZGF0YQovLyBDYWxjdWxhdGUgY3VydmUgaWYgd2UgaGF2ZSBlbm91Z2ggZGF0YQogICAgICAgICAgICAgICAgICAgIGlmIChzd2lwZVBvaW50cy5sZW5ndGggPiAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuYWx5c2lzID0gYW5hbHl6ZVN3aXBlQ3VydmUoc3dpcGVQb2ludHMpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBIaWdoIHRocmVzaG9sZCBmb3IgYnV0dG9uIHJlbGVhc2UgdG9vCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhhbmFseXNpcy5pbnRlbnNpdHkpID4gMC4yNSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VydmVEYXRhID0gYW5hbHlzaXM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBzcGluIHZlY3RvciBmb3IgbW91c2UvdG91Y2ggdW5pZmllZCAoQ29uc2VydmF0aXZlIHZhbHVlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5Qb3dlciA9IE1hdGgubWluKDQwMC4wLCBNYXRoLmFicyhhbmFseXNpcy5pbnRlbnNpdHkpICogMTUwMC4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5TaWduID0gTWF0aC5zaWduKGFuYWx5c2lzLmludGVuc2l0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3BpblBvd2VyICogc3BpblNpZ24sIDApOwogICAgICAgICAgICAgICAgICAgICAgICB9Cn0KCiAgICAgICAgICAgICAgICAgICAgLy8gRVhFQ1VURQogICAgICAgICAgICAgICAgICAgIGlmIChwLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTm9ybWFsIFJlbGVhc2UKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNwaW5WZWMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFVuaWZpZWQgc3BpbiBwYXNzaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnJlbGVhc2VDaGFyZ2UoZHgsIGR5LCB7IGludGVuc2l0eTogY3VydmVEYXRhLmludGVuc2l0eSwgc3BlZWQ6IGN1cnZlRGF0YS5zcGVlZCB9KTsgCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnJlbGVhc2VDaGFyZ2UoZHgsIGR5LCBjdXJ2ZURhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHdhc0J1ZmZlcmVkICYmIHAuaGFzQmFsbCAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJ1ZmZlcmVkIFRhcCAoSW5zdGFudCBTaG90KQogICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3JjZSBzdGFydCBhbmQgcmVsZWFzZSBpbW1lZGlhdGVseQogICAgICAgICAgICAgICAgICAgICAgICBwLnN0YXJ0Q2hhcmdlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucmVsZWFzZUNoYXJnZShkeCwgZHksIGN1cnZlRGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGhhbmRsZVN0YXJ0LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgaGFuZGxlU3RhcnQpOwogICAgICAgIH07CiAgICAgICAgc2V0dXBCdXR0b24oYWN0aW9uQnRuKTsKCi8vIEF1dG8gVG9nZ2xlCiAgICAgICAgY29uc3QgYXV0b0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhdXRvLXRvZ2dsZScpOwogICAgICAgIGlmIChhdXRvQnRuKSB7CiAgICAgICAgICAgIGNvbnN0IGhhbmRsZVRvZ2dsZSA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIudG9nZ2xlRGVtb01vZGUoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBhdXRvQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgaGFuZGxlVG9nZ2xlKTsKYXV0b0J0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIGhhbmRsZVRvZ2dsZSgpOwogICAgICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBTZXR0aW5ncyBCdXR0b24KICAgICAgICBzZXR1cFNldHRpbmdzQnV0dG9uKCk7CiAgICB9CgogICAgLy8gTkVXOiBBaW0gSm95c3RpY2sgU2V0dXAKLy8gTkVXOiBBaW0gSm95c3RpY2sgU2V0dXAKZnVuY3Rpb24gc2V0dXBBaW1Kb3lzdGljaygpIHsKICAgICAgICBjb25zdCBhaW1Lbm9iID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1qb3lzdGljay1rbm9iJyk7CiAgICAgICAgY29uc3QgYWltVmlzdWFscyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaW0tam95c3RpY2stdmlzdWFsJyk7CiAgICAgICAgY29uc3QgYWltWm9uZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaW0tam95c3RpY2stem9uZScpOwogICAgICAgIGlmICghYWltWm9uZSkgcmV0dXJuOwogICAgICAgIGxldCBhaW1TdGFydFggPSAwLCBhaW1TdGFydFkgPSAwOwogICAgICAgIGxldCBhaW1EcmFnZ2luZyA9IGZhbHNlOwogICAgICAgIGNvbnN0IGFpbU1heERpc3QgPSAzNTsKICAgICAgICBsZXQgYWltVG91Y2hJZCA9IG51bGw7CgogICAgICAgIAoKICAgICAgICAvLyBFeHBvc2UgYWltIGpveXN0aWNrIHN0YXRlIGZvciBzbmFwc2hvdHMKICAgICAgICBjb25zdCBfZGJnID0gd2luZG93LmZsdXguX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyB8fCB7fTsKICAgICAgICBfZGJnLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgICAgIF9kYmcuaW5wdXQgPSBfZGJnLmlucHV0IHx8IHt9OwogICAgICAgIF9kYmcuaW5wdXQuYWltID0gX2RiZy5pbnB1dC5haW0gfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5haW0udmVjdG9yID0gX2FpbUlucHV0OwogICAgICAgIF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7CiAgICAgICAgX2RiZy5pbnB1dC5haW0udG91Y2hJZCA9IGFpbVRvdWNoSWQ7CmNvbnN0IGhhbmRsZUFpbVN0YXJ0ID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgYWltRHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICBhaW1TdGFydFggPSBjbGllbnRYOwoKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS5kcmFnZ2luZyA9IGFpbURyYWdnaW5nOyB9CgogICAgICAgICAgICBhaW1TdGFydFkgPSBjbGllbnRZOwogICAgICAgICAgICBfYWltSW5wdXQuYWN0aXZlID0gdHJ1ZTsKCiAgICAgICAgICAgIGlmIChhaW1WaXN1YWxzKSB7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgYWltVmlzdWFscy5zdHlsZS5sZWZ0ID0gYCR7Y2xpZW50WH1weGA7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLnRvcCA9IGAke2NsaWVudFl9cHhgOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhaW1Lbm9iKSB7CiAgICAgICAgICAgICAgICBhaW1Lbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoLTUwJSwgLTUwJSlgOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgaGFuZGxlQWltTW92ZSA9IChjbGllbnRYLCBjbGllbnRZKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKCiAgICAgICAgICAgIGxldCBkeCA9IGNsaWVudFggLSBhaW1TdGFydFg7CiAgICAgICAgICAgIGxldCBkeSA9IGNsaWVudFkgLSBhaW1TdGFydFk7CgogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwoKICAgICAgICAgICAgaWYgKGRpc3QgPiBhaW1NYXhEaXN0KSB7CiAgICAgICAgICAgICAgICBkeCA9IChkeCAvIGRpc3QpICogYWltTWF4RGlzdDsKICAgICAgICAgICAgICAgIGR5ID0gKGR5IC8gZGlzdCkgKiBhaW1NYXhEaXN0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYWltS25vYikgewogICAgICAgICAgICAgICAgYWltS25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKGNhbGMoLTUwJSArICR7ZHh9cHgpLCBjYWxjKC01MCUgKyAke2R5fXB4KSlgOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBOb3JtYWxpemUgYW5kIHRyYW5zZm9ybSB0byB3b3JsZCBzcGFjZQogICAgICAgICAgICBfYWltSW5wdXQueCA9IGR4IC8gYWltTWF4RGlzdDsKICAgICAgICAgICAgX2FpbUlucHV0LnkgPSBkeSAvIGFpbU1heERpc3Q7CgogICAgICAgICAgICAvLyBBcHBseSBhaW0gdG8gcGxheWVyIGlmIGNoYXJnaW5nCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICAgICBpZiAocC5pc0NoYXJnaW5nIHx8IHAuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgICAgIC8vIFRyYW5zZm9ybSBzY3JlZW4gYWltIHRvIHdvcmxkIHNwYWNlCiAgICAgICAgICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgICAgICAgICBfY2FtRndkLnkgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKF9jYW1Gd2QsIF91cEF4aXMpLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFggPSAoX2NhbVJpZ2h0LnggKiBfYWltSW5wdXQueCkgKyAoX2NhbUZ3ZC54ICogLV9haW1JbnB1dC55KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoX2NhbVJpZ2h0LnogKiBfYWltSW5wdXQueCkgKyAoX2NhbUZ3ZC56ICogLV9haW1JbnB1dC55KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHdvcmxkWCkgPiAwLjEgfHwgTWF0aC5hYnMod29ybGRaKSA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBwLnNldE92ZXJyaWRlQWltKHdvcmxkWCwgd29ybGRaKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKY29uc3QgaGFuZGxlQWltRW5kID0gKCkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgIGFpbURyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIF9haW1JbnB1dC5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgX2FpbUlucHV0LnggPSAwOwogICAgICAgICAgICBfYWltSW5wdXQueSA9IDA7CgogICAgICAgICAgICBpZiAoYWltVmlzdWFscykgewogICAgICAgICAgICAgICAgYWltVmlzdWFscy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDbGVhciBwbGF5ZXIgYWltIG92ZXJyaWRlCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5vdmVycmlkZUFpbVZlY3RvciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBhaW1ab25lLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGNvbnN0IHQgPSAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzWzBdKSA/IGUuY2hhbmdlZFRvdWNoZXNbMF0gOiBlLnRvdWNoZXNbMF07CiAgICAgICAgICAgIGFpbVRvdWNoSWQgPSB0ID8gdC5pZGVudGlmaWVyIDogbnVsbDsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsgfQogICAgICAgICAgICBoYW5kbGVBaW1TdGFydCh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBhaW1Ub3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgICAgIGhhbmRsZUFpbU1vdmUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBhaW1Ub3VjaElkKTsKICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47CiAgICAgICAgICAgIGFpbVRvdWNoSWQgPSBudWxsOwogICAgICAgICAgICBoYW5kbGVBaW1FbmQoKTsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsgfQogICAgICAgICAgICBoYW5kbGVBaW1FbmQoKTsKICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoIWFpbURyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRFbmQgPSBfZW5kZWRUb3VjaEJ5SWQoZS5jaGFuZ2VkVG91Y2hlcywgYWltVG91Y2hJZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdEVuZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBhaW1Ub3VjaElkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlQWltRW5kKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5haW0pIHsgX2RiZy5pbnB1dC5haW0udG91Y2hJZCA9IGFpbVRvdWNoSWQ7IF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7IH0KICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlQWltRW5kKCk7CiAgICAgICAgfSk7Ci8vIE1vdXNlIHN1cHBvcnQgZm9yIGRlc2t0b3AgdGVzdGluZwogICAgICAgIGFpbVpvbmUuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgaGFuZGxlQWltU3RhcnQoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgIH0pOwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoYWltRHJhZ2dpbmcpIGhhbmRsZUFpbU1vdmUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgIH0pOwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGFpbURyYWdnaW5nKSBoYW5kbGVBaW1FbmQoKTsKICAgICAgICB9KTsKICAgIH0KCiAgICAvLyBORVc6IFRhY2tsZSBCdXR0b24gU2V0dXAKICAgIGZ1bmN0aW9uIHNldHVwVGFja2xlQnV0dG9uKCkgewogICAgICAgIGNvbnN0IHRhY2tsZUJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0YWNrbGUtYnV0dG9uJyk7CiAgICAgICAgaWYgKCF0YWNrbGVCdG4pIHJldHVybjsKCmNvbnN0IGhhbmRsZVRhY2tsZSA9IChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsgLy8gUHJldmVudCBidWJibGluZyB0byBqb3lzdGljawoKICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaXNEZW1vTW9kZSkgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgICAgICAvLyBWaXN1YWwgRmVlZGJhY2sgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGFja2xlQnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpLCAxNTApOwoKICAgICAgICAgICAgICAgIC8vIElmIHdlIGRvbid0IGhhdmUgdGhlIGJhbGwsIGRhc2gvdGFja2xlCiAgICAgICAgICAgICAgICBpZiAoIXAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgIC8vIEdldCBjdXJyZW50IG1vdmVtZW50IGRpcmVjdGlvbiBvciBmb3J3YXJkCiAgICAgICAgICAgICAgICAgICAgbGV0IGRhc2hYID0gcC5pbnB1dFZlY3Rvci54OwogICAgICAgICAgICAgICAgICAgIGxldCBkYXNoWiA9IHAuaW5wdXRWZWN0b3IuejsKCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgbm90IG1vdmluZywgZGFzaCBmb3J3YXJkIHJlbGF0aXZlIHRvIHBsYXllciBmYWNpbmcKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGFzaFgpIDwgMC4xICYmIE1hdGguYWJzKGRhc2haKSA8IDAuMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24ocC5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgICAgICAgICBkYXNoWCA9IGZ3ZC54OwogICAgICAgICAgICAgICAgICAgICAgICBkYXNoWiA9IGZ3ZC56OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcC5kYXNoKGRhc2hYLCBkYXNoWik7CgogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgc2hvdyB0ZXh0IGlmIGRhc2ggYWN0dWFsbHkgaGFwcGVuZWQgKGNvb2xkb3duIGNoZWNrIGluc2lkZSBkYXNoKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlRBQ0tMRSEiLCBwLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQnJlYWsgdGFja2xlIGlmIGVuZ2FnZWQKICAgICAgICAgICAgICAgICAgICBwLmRhc2gocC5pbnB1dFZlY3Rvci54LCBwLmlucHV0VmVjdG9yLnopOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdGFja2xlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBoYW5kbGVUYWNrbGUsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgdGFja2xlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIGhhbmRsZVRhY2tsZSk7CiAgICB9CgogICAgLy8gTkVXOiBTZXR0aW5ncyBCdXR0b24gU2V0dXAKLy8gTkVXOiBTZXR0aW5ncyBCdXR0b24gU2V0dXAKZnVuY3Rpb24gc2V0dXBTZXR0aW5nc0J1dHRvbigpIHsKICAgICAgICBjb25zdCBzZXR0aW5nc0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXR0aW5ncy1idXR0b24nKTsKICAgICAgICBjb25zdCBzZXR0aW5nc1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NldHRpbmdzLXBhbmVsJyk7CiAgICAgICAgY29uc3Qgc2V0dGluZ3NDbG9zZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZXR0aW5ncy1jbG9zZScpOwoKICAgICAgICBpZiAoIXNldHRpbmdzQnRuIHx8ICFzZXR0aW5nc1BhbmVsKSByZXR1cm47CgogICAgICAgIHNldHRpbmdzQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPSBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJyA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgfSk7CgogICAgICAgIGlmIChzZXR0aW5nc0Nsb3NlKSB7CiAgICAgICAgICAgIHNldHRpbmdzQ2xvc2UuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gU2Vuc2l0aXZpdHkgc2xpZGVyCiAgICAgICAgY29uc3Qgc2Vuc2l0aXZpdHlTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2Vuc2l0aXZpdHktc2xpZGVyJyk7CiAgICAgICAgaWYgKHNlbnNpdGl2aXR5U2xpZGVyKSB7CiAgICAgICAgICAgIHNlbnNpdGl2aXR5U2xpZGVyLnZhbHVlID0gX3NldHRpbmdzLmpveXN0aWNrU2Vuc2l0aXZpdHkgKiAxMDA7CiAgICAgICAgICAgIHNlbnNpdGl2aXR5U2xpZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgKGUpID0+IHsKICAgICAgICAgICAgICAgIF9zZXR0aW5ncy5qb3lzdGlja1NlbnNpdGl2aXR5ID0gZS50YXJnZXQudmFsdWUgLyAxMDA7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gQWltIGFzc2lzdCB0b2dnbGUKICAgICAgICBjb25zdCBhaW1Bc3Npc3RUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWltLWFzc2lzdC10b2dnbGUnKTsKICAgICAgICBpZiAoYWltQXNzaXN0VG9nZ2xlKSB7CiAgICAgICAgICAgIGFpbUFzc2lzdFRvZ2dsZS5jaGVja2VkID0gX3NldHRpbmdzLmFpbUFzc2lzdDsKICAgICAgICAgICAgYWltQXNzaXN0VG9nZ2xlLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBfc2V0dGluZ3MuYWltQXNzaXN0ID0gZS50YXJnZXQuY2hlY2tlZDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBDYW1lcmEgc2hha2UgdG9nZ2xlCiAgICAgICAgY29uc3Qgc2hha2VUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2hha2UtdG9nZ2xlJyk7CiAgICAgICAgaWYgKHNoYWtlVG9nZ2xlKSB7CiAgICAgICAgICAgIHNoYWtlVG9nZ2xlLmNoZWNrZWQgPSBfc2V0dGluZ3MuY2FtZXJhU2hha2U7CiAgICAgICAgICAgIHNoYWtlVG9nZ2xlLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBfc2V0dGluZ3MuY2FtZXJhU2hha2UgPSBlLnRhcmdldC5jaGVja2VkOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIFZvbHVtZSBzbGlkZXIKICAgICAgICBjb25zdCB2b2x1bWVTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndm9sdW1lLXNsaWRlcicpOwogICAgICAgIGlmICh2b2x1bWVTbGlkZXIgJiYgX2F1ZGlvTWFuYWdlcikgewogICAgICAgICAgICB2b2x1bWVTbGlkZXIuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgY29uc3Qgdm9sID0gZS50YXJnZXQudmFsdWUgLyAxMDA7CiAgICAgICAgICAgICAgICBfYXVkaW9NYW5hZ2VyLnNldFZvbHVtZSh2b2wpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIEV4aXQgdG8gTWVudQogICAgICAgIGNvbnN0IGV4aXRCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXhpdC10by1tZW51LWJ0bicpOwogICAgICAgIGlmIChleGl0QnRuKSB7CiAgICAgICAgICAgIGV4aXRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoX21lbnVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgX21lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RvcCBwcmFjdGljZSBpZiBydW5uaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIucHJhY3RpY2VNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIucHJhY3RpY2VNYW5hZ2VyLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzZXR0aW5nc1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiB1cGRhdGVJbnB1dFZlY3RvcigpIHsKICAgICAgICBsZXQgeCA9IF9pbnB1dC54IHx8IDA7CiAgICAgICAgbGV0IHogPSBfaW5wdXQueSB8fCAwOwoKICAgICAgICBpZiAoX2tleXNbJ3cnXSB8fCBfa2V5c1snQXJyb3dVcCddKSB6IC09IDE7CiAgICAgICAgaWYgKF9rZXlzWydzJ10gfHwgX2tleXNbJ0Fycm93RG93biddKSB6ICs9IDE7CiAgICAgICAgaWYgKF9rZXlzWydhJ10gfHwgX2tleXNbJ0Fycm93TGVmdCddKSB4IC09IDE7CiAgICAgICAgaWYgKF9rZXlzWydkJ10gfHwgX2tleXNbJ0Fycm93UmlnaHQnXSkgeCArPSAxOwoKICAgICAgICBjb25zdCBsZW5TcSA9IHgqeCArIHoqejsKICAgICAgICBpZiAobGVuU3EgPiAxKSB7CiAgICAgICAgICAgIGNvbnN0IGxlbiA9IE1hdGguc3FydChsZW5TcSk7CiAgICAgICAgICAgIHggLz0gbGVuOwogICAgICAgICAgICB6IC89IGxlbjsKICAgICAgICB9CgogICAgICAgIGlmIChpc05hTih4KSkgeCA9IDA7CiAgICAgICAgaWYgKGlzTmFOKHopKSB6ID0gMDsKCiAgICAgICAgaWYgKF9jYW1lcmEpIHsKICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKCiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhfY2FtRndkLCBfdXBBeGlzKS5ub3JtYWxpemUoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBfY2FtRndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgIF9jYW1SaWdodC5zZXQoMSwgMCwgMCk7CiAgICAgICAgfQoKICAgICAgICBsZXQgd29ybGRYID0gKF9jYW1Gd2QueCAqIC16KSArIChfY2FtUmlnaHQueCAqIHgpOwogICAgICAgIGxldCB3b3JsZFogPSAoX2NhbUZ3ZC56ICogLXopICsgKF9jYW1SaWdodC56ICogeCk7CgogICAgICAgIGlmIChpc05hTih3b3JsZFgpIHx8IGlzTmFOKHdvcmxkWikpIHsKICAgICAgICAgICAgd29ybGRYID0gMDsKICAgICAgICAgICAgd29ybGRaID0gMDsKICAgICAgICB9CgppZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgLy8gRklYOiBPbmx5IGFsbG93IG1vdmVtZW50IGlmIGdhbWUgaXMgYWN0aXZlIG9yIGluIHByYWN0aWNlCiAgICAgICAgICAgIGNvbnN0IGdtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBjYW5Nb3ZlID0gZ20gJiYgIWdtLmlzRGVtb01vZGUgJiYgKGdtLnN0YXRlID09PSAnYWN0aXZlJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoY2FuTW92ZSkgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5zZXRJbnB1dCh3b3JsZFgsIHdvcmxkWik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLnNldElucHV0KDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgfQp9CgogICAgZnVuY3Rpb24gY3JlYXRlUmlwcGxlKHgsIHkpIHsKICAgICAgICBjb25zdCByaXBwbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICByaXBwbGUuY2xhc3NOYW1lID0gJ3RvdWNoLXJpcHBsZSc7CiAgICAgICAgcmlwcGxlLnN0eWxlLmxlZnQgPSBgJHt4fXB4YDsKICAgICAgICByaXBwbGUuc3R5bGUudG9wID0gYCR7eX1weGA7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJykuYXBwZW5kQ2hpbGQocmlwcGxlKTsKCiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGlmIChyaXBwbGUucGFyZW50Tm9kZSkgcmlwcGxlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQocmlwcGxlKTsKICAgICAgICB9LCA2MDApOwoKICAgIH0KCiAgICAvLyBORVc6IFZpc3VhbCBTd2lwZSBUcmFpbAogICAgZnVuY3Rpb24gY3JlYXRlU3dpcGVUcmFpbERvdCh4LCB5KSB7CiAgICAgICAgY29uc3QgZG90ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgZG90LmNsYXNzTmFtZSA9ICdzd2lwZS10cmFpbC1kb3QnOwogICAgICAgIGRvdC5zdHlsZS5sZWZ0ID0gYCR7eCAtIDZ9cHhgOyAvLyBDZW50ZXIgKDEycHggd2lkdGgpCiAgICAgICAgZG90LnN0eWxlLnRvcCA9IGAke3kgLSA2fXB4YDsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKS5hcHBlbmRDaGlsZChkb3QpOwogICAgICAgIAogICAgICAgIC8vIENTUyBhbmltYXRpb24gaGFuZGxlcyByZW1vdmFsLCBidXQgd2UgY2xlYW4gdXAgRE9NIHRvIGJlIHNhZmUKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgaWYgKGRvdC5wYXJlbnROb2RlKSBkb3QucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChkb3QpOwogICAgICAgIH0sIDUwMCk7CiAgICB9CgogICAgZnVuY3Rpb24gb25SZXNpemUoKSB7CiAgICAgICAgY29uc3Qgd2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICBjb25zdCBoZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgCiAgICAgICAgaWYgKF9jYW1lcmEpIHsKICAgICAgICAgICAgX2NhbWVyYS5hc3BlY3QgPSB3aWR0aCAvIGhlaWdodDsKICAgICAgICAgICAgX2NhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFN0cmljdGx5IDAuNTAgYXMgcmVxdWVzdGVkCiAgICAgICAgY29uc3QgcmVzU2NhbGUgPSAwLjUwOwogICAgICAgIAogICAgICAgIF9jb25maWcuaW50ZXJuYWxXaWR0aCA9IE1hdGguZmxvb3Iod2lkdGggKiByZXNTY2FsZSk7CiAgICAgICAgX2NvbmZpZy5pbnRlcm5hbEhlaWdodCA9IE1hdGguZmxvb3IoaGVpZ2h0ICogcmVzU2NhbGUpOwoKICAgICAgICBpZiAoX3JlbmRlcmVyKSB7CiAgICAgICAgICAgIF9yZW5kZXJlci5zZXRTaXplKF9jb25maWcuaW50ZXJuYWxXaWR0aCwgX2NvbmZpZy5pbnRlcm5hbEhlaWdodCwgZmFsc2UpOwogICAgICAgIH0KICAgIH0KCmZ1bmN0aW9uIGFuaW1hdGUoKSB7CiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwoKICAgICAgICBjb25zdCByYXdEdCA9IF9jbG9jay5nZXREZWx0YSgpOwogICAgICAgIC8vIENsYW1wIGR0IHRvIHByZXZlbnQgc3BpcmFscyBvZiBkZWF0aCAobWF4IDAuMXMpCiAgICAgICAgY29uc3QgZHQgPSBNYXRoLm1pbihyYXdEdCwgMC4xKSAqICh3aW5kb3cuZmx1eC50aW1lU2NhbGUgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA6IDAuOCk7CgogICAgICAgIAoKICAgICAgICAvLyBQZXJmIHN0YXRzIGZvciBEZXZUb29scyBzbmFwc2hvdHMKICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX2RlYnVnSU8gJiYgd2luZG93LmZsdXguX2RlYnVnSU8ucGVyZikgewogICAgICAgICAgICBjb25zdCBwZXJmID0gd2luZG93LmZsdXguX2RlYnVnSU8ucGVyZjsKICAgICAgICAgICAgcGVyZi5mcmFtZSA9IChwZXJmLmZyYW1lIHx8IDApICsgMTsKICAgICAgICAgICAgcGVyZi5yYXdEdCA9IHJhd0R0OwogICAgICAgICAgICBwZXJmLmR0ID0gZHQ7CiAgICAgICAgICAgIGNvbnN0IGZwcyA9IGR0ID4gMCA/ICgxIC8gZHQpIDogMDsKICAgICAgICAgICAgcGVyZi5mcHMgPSBmcHM7CiAgICAgICAgICAgIHBlcmYuYXZnRnBzID0gKHBlcmYuYXZnRnBzICYmIHBlcmYuYXZnRnBzID4gMCkgPyAocGVyZi5hdmdGcHMgKiAwLjkgKyBmcHMgKiAwLjEpIDogZnBzOwogICAgICAgIH0KLy8gSW1wYWN0IEZyYW1lcwogICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmltcGFjdFBhdXNlID4gMCkgewogICAgICAgICAgICBfZ2FtZU1hbmFnZXIuaW1wYWN0UGF1c2UgLT0gZHQ7CiAgICAgICAgICAgIGlmIChfcmVuZGVyZXIgJiYgX3NjZW5lICYmIF9jYW1lcmEpIHsKICAgICAgICAgICAgICAgIF9yZW5kZXJlci5yZW5kZXIoX3NjZW5lLCBfY2FtZXJhKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwoKICAgICAgICAvLyBBY3Rpb24gQnVmZmVyIFByb2Nlc3NpbmcKICAgICAgICBpZiAoX2FjdGlvbkJ1ZmZlci5hY3RpdmUpIHsKICAgICAgICAgICAgaWYgKERhdGUubm93KCkgLSBfYWN0aW9uQnVmZmVyLnRpbWVzdGFtcCA+IF9hY3Rpb25CdWZmZXIuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCAmJiAhcC5pc0NoYXJnaW5nICYmICFwLmlzVGhyb3dpbmcgJiYgcC5zdGF0dXMubmFwIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGFydENoYXJnZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWJ1dHRvbicpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYnRuKSBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBNZW51IFN0YXRlIEhhbmRsaW5nCiAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuc3RhdGUgPT09ICdtZW51JyAmJiBfY2FtZXJhKSB7CiAgICAgICAgICAgIGNvbnN0IHRpbWUgPSBEYXRlLm5vdygpICogMC4wMDA1OwogICAgICAgICAgICBjb25zdCByYWRpdXMgPSA1MDsKICAgICAgICAgICAgX2NhbWVyYS5wb3NpdGlvbi54ID0gTWF0aC5zaW4odGltZSkgKiByYWRpdXM7CiAgICAgICAgICAgIF9jYW1lcmEucG9zaXRpb24ueiA9IE1hdGguY29zKHRpbWUpICogcmFkaXVzOwogICAgICAgICAgICBfY2FtZXJhLnBvc2l0aW9uLnkgPSAyMDsKICAgICAgICAgICAgX2NhbWVyYS5sb29rQXQoMCwgMCwgMCk7CgogICAgICAgICAgICBpZiAoX3JlbmRlcmVyICYmIF9zY2VuZSkgewogICAgICAgICAgICAgICAgX3JlbmRlcmVyLnJlbmRlcihfc2NlbmUsIF9jYW1lcmEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgovLyBTdGFibGUgc3ViLXN0ZXBwaW5nIChwcmV2ZW50cyBkdCBzcGlrZXMgZnJvbSBtYWtpbmcgcGh5c2ljcy9jYW1lcmEgZmVlbCBmbG9hdHkgb24gbW9iaWxlKQogICAgICAgIGNvbnN0IF9tYXhTdGVwID0gMSAvIDYwOwogICAgICAgIGNvbnN0IF9zdGVwcyA9IE1hdGgubWluKDQsIE1hdGgubWF4KDEsIE1hdGguY2VpbChkdCAvIF9tYXhTdGVwKSkpOwogICAgICAgIGNvbnN0IF9zdGVwRHQgPSBkdCAvIF9zdGVwczsKCiAgICAgICAgZm9yIChsZXQgX3NpID0gMDsgX3NpIDwgX3N0ZXBzOyBfc2krKykgewogICAgICAgICAgICBjb25zdCBfc2R0ID0gX3N0ZXBEdDsKCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIF9nYW1lTWFuYWdlci51cGRhdGUoX3NkdCk7CgogICAgICAgICAgICAvLyBJZiBpbiBBc3NldCBGb3JnZSBtb2RlLCBza2lwIGdhbWUgbG9naWMgYW5kIHN0YW5kYXJkIHJlbmRlcmluZwogICAgICAgICAgICAvLyBEZXZUb29scyBoYW5kbGVzIHRoZSByZW5kZXJpbmcgaW4gaXRzIGhvb2tlZCB1cGRhdGUgZnVuY3Rpb24KICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaXNGb3JnZU1vZGUpIHsKICAgICAgICAgICAgICAgIC8vIEZvcmdlIG1vZGUgaGFuZGxlcyBpdHMgb3duIHJlbmRlcmluZyBsb29wIGluIERldlRvb2xzIGhvb2sKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIEVudGl0aWVzCiAgICAgICAgICAgIGlmIChfaG9tZVRlYW0pIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS51cGRhdGUoX3NkdCk7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gY2hlY2tCYWxsR3JhYihwKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChfYXdheVRlYW0pIHsKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS51cGRhdGUoX3NkdCk7CiAgICAgICAgICAgICAgICBfYXdheVRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gY2hlY2tCYWxsR3JhYihwKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChfYmFsbCkgewogICAgICAgICAgICAgICAgX2JhbGwudXBkYXRlKF9zZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCYWxsIExhYiBydW50aW1lICh0cmFqZWN0b3J5IHByZXZpZXcgLyByZWNvcmQtcmVwbGF5KQogICAgICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguYmFsbExhYiAmJiB0eXBlb2Ygd2luZG93LmZsdXguYmFsbExhYi51cGRhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmJhbGxMYWIudXBkYXRlKF9zZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgQ2FtZXJhCiAgICAgICAgICAgIHVwZGF0ZUNhbWVyYUxvZ2ljKF9zZHQpOwoKICAgICAgICAgICAgLy8gVXBkYXRlIFZpc3VhbHMKICAgICAgICAgICAgaWYgKF93YXRlck92ZXJsYXkpIF93YXRlck92ZXJsYXkudXBkYXRlKF9zZHQpOwogICAgICAgICAgICBpZiAoX2xpZ2h0U2hhZnRzKSBfbGlnaHRTaGFmdHMudXBkYXRlKF9zZHQpOwoKLy8gUnVudGltZSB1cGRhdGVycyAoRlgsIGFyZW5hIHJpbmdzLCBldGMuKQogICAgICAgICAgICBpZiAod2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyAmJiB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgZm9yIChsZXQgdWkgPSAwOyB1aSA8IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMubGVuZ3RoOyB1aSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm4gPSB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzW3VpXTsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAnZnVuY3Rpb24nKSBmbihfc2R0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIEdseXBoIE1hbmFnZXIgKENyaXRpY2FsIGZvciB2aXN1YWwgY2xlYW51cCkKICAgICAgICAgICAgaWYgKF9nbHlwaE1hbmFnZXIpIF9nbHlwaE1hbmFnZXIudXBkYXRlKF9zZHQpOwoKLy8gVXBkYXRlIEdsb2JhbCBVbmlmb3JtcwogICAgICAgICAgICBpZiAoX2FyZW5hVW5pZm9ybXMpIHsKICAgICAgICAgICAgICAgIF9hcmVuYVVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IF9zZHQ7CiAgICAgICAgICAgICAgICBfYXJlbmFVbmlmb3Jtcy51SW1wYWN0U3RyLnZhbHVlICo9IE1hdGgubWF4KDAsIDEuMCAtIF9zZHQgKiA0LjApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAtLS0gTkVXOiBBcmVuYSBSb3RhdGlvbiAmIENvbG9yIFNoaWZ0IC0tLQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFHcm91cCkgewogICAgICAgICAgICAgICAgLy8gUm90YXRlIHNwaGVyZSBzbG93bHkgdG8gc2hvdyB3YXRlciBtb3ZlbWVudAogICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5yb3RhdGlvbi55ICs9IF9zZHQgKiAwLjA1OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXgudHJpYmFsVW5pZm9ybXMpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnRyaWJhbFVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IF9zZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFBvc3Nlc3Npb24gQ29sb3IgTG9naWMKICAgICAgICAgICAgICAgIGxldCB0YXJnZXRDb2xvciA9IG5ldyBUSFJFRS5Db2xvcigweDAwZmZmZik7IC8vIERlZmF1bHQgQ3lhbiAoSG9tZS9OZXV0cmFsKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoX2JhbGwgJiYgX2JhbGwuaG9sZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9iYWxsLmhvbGRlci50ZWFtICYmIF9iYWxsLmhvbGRlci50ZWFtLnNpZGUgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldENvbG9yLnNldEhleCgweGZmODgwMCk7IC8vIE9yYW5nZSAoQXdheSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNtb290aCBMZXJwCiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3Jtcy51Q29sb3IudmFsdWUubGVycCh0YXJnZXRDb2xvciwgX3NkdCAqIDIuMCk7CiAgICAgICAgICAgIH0KCmlmIChfcGFydGljbGVVbmlmb3JtcykgewogICAgICAgICAgICAgICAgX3BhcnRpY2xlVW5pZm9ybXMudVRpbWUudmFsdWUgKz0gX3NkdDsKICAgICAgICAgICAgfQogICAgICAgIH0gLy8gQ2xvc2Ugc3ViLXN0ZXAgbG9vcAoKICAgICAgICBpZiAoX3JlbmRlcmVyICYmIF9zY2VuZSAmJiBfY2FtZXJhKSB7CiAgICAgICAgICAgIF9yZW5kZXJlci5yZW5kZXIoX3NjZW5lLCBfY2FtZXJhKTsKICAgICAgICB9CiAgICAgICAgLy8gVUkgVXBkYXRlcwogICAgICAgIHVwZGF0ZVVJKCk7CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlVUkoKSB7CiAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybjsKCiAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKICAgICAgICBjb25zdCBsYmwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWxhYmVsJyk7CiAgICAgICAgY29uc3QgdGFja2xlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RhY2tsZS1idXR0b24nKTsKICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKCiAgICAgICAgaWYgKGJ0biAmJiBsYmwpIHsKICAgICAgICAgICAgY29uc3QgYnRuVGV4dCA9IGJ0bi5xdWVyeVNlbGVjdG9yKCcuYnRuLXRleHQnKTsKCiAgICAgICAgICAgIGlmIChwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIGlmIChidG5UZXh0ICYmIGJ0blRleHQuaW5uZXJUZXh0ICE9PSAiQUNUSU9OIikgewogICAgICAgICAgICAgICAgICAgIGJ0blRleHQuaW5uZXJUZXh0ID0gIkFDVElPTiI7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ3Nob290LW1vZGUnKTsKICAgICAgICAgICAgICAgICAgICBsYmwuaW5uZXJUZXh0ID0gIk9GRkVOU0UiOwogICAgICAgICAgICAgICAgICAgIGxibC5jbGFzc0xpc3QuYWRkKCdzaG9vdC1sYWJlbCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IGlzSGlnaEVuZXJneSA9IChwLnN0YXRzLkhQIC8gcC5zdGF0cy5tYXhIUCkgPiAwLjQ7CiAgICAgICAgICAgICAgICBpZiAoaXNIaWdoRW5lcmd5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFidG4uY2xhc3NMaXN0LmNvbnRhaW5zKCdsaW1pdC1yZWFkeScpKSBidG4uY2xhc3NMaXN0LmFkZCgnbGltaXQtcmVhZHknKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJ0bi5jbGFzc0xpc3QuY29udGFpbnMoJ2xpbWl0LXJlYWR5JykpIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdsaW1pdC1yZWFkeScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChidG5UZXh0ICYmIGJ0blRleHQuaW5uZXJUZXh0ICE9PSAiU1dJTSIpIHsKICAgICAgICAgICAgICAgICAgICBidG5UZXh0LmlubmVyVGV4dCA9ICJTV0lNIjsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnc2hvb3QtbW9kZScpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdsaW1pdC1yZWFkeScpOwogICAgICAgICAgICAgICAgICAgIGxibC5pbm5lclRleHQgPSAiTk9STUFMIjsKICAgICAgICAgICAgICAgICAgICBsYmwuY2xhc3NMaXN0LnJlbW92ZSgnc2hvb3QtbGFiZWwnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVXBkYXRlIHRhY2tsZSBidXR0b24gdmlzaWJpbGl0eQogICAgICAgIGlmICh0YWNrbGVCdG4pIHsKICAgICAgICAgICAgaWYgKCFwLmhhc0JhbGwgfHwgcC5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgLy8gVXBkYXRlIHRhY2tsZSBidXR0b24gdGV4dCBiYXNlZCBvbiBjb250ZXh0CiAgICAgICAgICAgICAgICBjb25zdCB0YWNrbGVUZXh0ID0gdGFja2xlQnRuLnF1ZXJ5U2VsZWN0b3IoJy5idG4tdGV4dCcpOwogICAgICAgICAgICAgICAgaWYgKHRhY2tsZVRleHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocC5pc0VuZ2FnZWQgJiYgcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZVRleHQuaW5uZXJUZXh0ID0gJ0JSRUFLJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGFja2xlQnRuLmNsYXNzTGlzdC5hZGQoJ3VyZ2VudCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZVRleHQuaW5uZXJUZXh0ID0gJ1RBQ0tMRSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5jbGFzc0xpc3QucmVtb3ZlKCd1cmdlbnQnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YWNrbGVCdG4uc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVXBkYXRlIGRpc3RhbmNlIHRvIGdvYWwgaW5kaWNhdG9yCiAgICAgICAgY29uc3QgZGlzdEluZGljYXRvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnb2FsLWRpc3RhbmNlJyk7CiAgICAgICAgaWYgKGRpc3RJbmRpY2F0b3IgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHAudGVhbSAmJiBwLnRlYW0uc2lkZSA9PT0gMSkgPyAtMjggOiAyODsKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguYWJzKHAubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICBkaXN0SW5kaWNhdG9yLmlubmVyVGV4dCA9IGAke01hdGguZmxvb3IoZGlzdCl9bWA7CiAgICAgICAgfQogICAgfQoKZnVuY3Rpb24gdXBkYXRlQ2FtZXJhTG9naWMoZHQpIHsKICAgICAgICBpZiAoIV9jYW1lcmFNYW5hZ2VyIHx8ICFfYmFsbCkgcmV0dXJuOwoKICAgICAgICBsZXQgdGFyZ2V0TWVzaCA9IF9iYWxsLm1lc2g7CiAgICAgICAgbGV0IHRhcmdldFZlbCA9IF9iYWxsLnZlbG9jaXR5OwogICAgICAgIGxldCB0YXJnZXRJbnB1dCA9IG51bGw7CiAgICAgICAgbGV0IGlzQWltaW5nID0gZmFsc2U7CgogICAgICAgIGlmIChfYmFsbC5ob2xkZXIgJiYgX2JhbGwuaG9sZGVyLm1lc2gpIHsKICAgICAgICAgICAgdGFyZ2V0TWVzaCA9IF9iYWxsLmhvbGRlci5tZXNoOwogICAgICAgICAgICB0YXJnZXRWZWwgPSBfYmFsbC5ob2xkZXIudmVsb2NpdHk7CiAgICAgICAgICAgIGlmIChfYmFsbC5ob2xkZXIuaW5wdXRWZWN0b3IpIHsKICAgICAgICAgICAgICAgIHRhcmdldElucHV0ID0gX2JhbGwuaG9sZGVyLmlucHV0VmVjdG9yOwogICAgICAgICAgICB9Ci8vIENoZWNrIGFpbWluZyBzdGF0ZSAoQ2hhcmdpbmcgb3IgVGhyb3dpbmcpCiAgICAgICAgICAgIGlmIChfYmFsbC5ob2xkZXIuaXNDaGFyZ2luZyB8fCBfYmFsbC5ob2xkZXIuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgaXNBaW1pbmcgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQodGFyZ2V0TWVzaCwgdGFyZ2V0VmVsLCB0YXJnZXRJbnB1dCwgaXNBaW1pbmcpOwogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICB9CgpmdW5jdGlvbiBjaGVja0JhbGxHcmFiKGVudGl0eSkgewogICAgICAgIGlmICghZW50aXR5LmNhbkNhdGNoKSByZXR1cm47CiAgICAgICAgaWYgKF9iYWxsICYmICFfYmFsbC5pc0NhdGNoYWJsZSgpKSByZXR1cm47CiAgICAgICAgaWYgKGVudGl0eS5zdHVuVGltZXIgPiAwIHx8IChlbnRpdHkuc3RhdHVzICYmIGVudGl0eS5zdGF0dXMubmFwID4gMCkpIHJldHVybjsKICAgICAgICBpZiAoX2JhbGwuc3RhdGUgIT09ICdmcmVlJykgcmV0dXJuOwogICAgICAgIGlmICghX2JhbGwubWVzaCB8fCAhZW50aXR5Lm1lc2gpIHJldHVybjsKCiAgICAgICAgY29uc3QgYmFsbFBvcyA9IF9iYWxsLm1lc2gucG9zaXRpb247CiAgICAgICAgY29uc3QgZW50UG9zID0gZW50aXR5Lm1lc2gucG9zaXRpb247CgogICAgICAgIGNvbnN0IGR4ID0gYmFsbFBvcy54IC0gZW50UG9zLng7CiAgICAgICAgY29uc3QgZHogPSBiYWxsUG9zLnogLSBlbnRQb3MuejsKICAgICAgICBjb25zdCBkaXN0WFogPSBNYXRoLnNxcnQoZHgqZHggKyBkeipkeik7CiAgICAgICAgY29uc3QgZGlzdFkgPSBNYXRoLmFicyhiYWxsUG9zLnkgLSBlbnRQb3MueSk7CgogICAgICAgIC8vIC0tLSBSRUxBWEVEIFRPTEVSQU5DRVMgRk9SIEVBU0lFUiBQSUNLVVAgLS0tCiAgICAgICAgY29uc3QgdG91Y2hSYWRpdXMgPSAxLjU7IC8vIEluY3JlYXNlZCBmcm9tIDEuMCAoQXV0by1ncmFiIHJhZGl1cykKICAgICAgICBsZXQgbWFnbmV0UmFkaXVzID0gMy41OyAgLy8gSW5jcmVhc2VkIGZyb20gMS44IChNYWduZXRpYyByYWRpdXMpCiAgICAgICAgbGV0IGludGVyYWN0aW9uUmFkaXVzID0gNi4wOyAvLyBJbmNyZWFzZWQgZnJvbSAzLjUgKFR1cm4tdG8gcmFkaXVzKQogICAgICAgIGxldCBjYXRjaEhlaWdodCA9IDYuMDsgICAvLyBJbmNyZWFzZWQgZnJvbSAzLjAgKFZlcnRpY2FsIHJlYWNoKQoKICAgICAgICBpZiAoZW50aXR5LmlzRGFzaGluZykgewogICAgICAgICAgICBtYWduZXRSYWRpdXMgPSA0LjU7CiAgICAgICAgICAgIGludGVyYWN0aW9uUmFkaXVzID0gNy4wOwogICAgICAgICAgICBjYXRjaEhlaWdodCA9IDcuMDsKICAgICAgICB9CgogICAgICAgIGlmIChkaXN0WFogPiBpbnRlcmFjdGlvblJhZGl1cyB8fCBkaXN0WSA+IGNhdGNoSGVpZ2h0KSByZXR1cm47CgogICAgICAgIC8vIE9wdGltaXphdGlvbjogVXNlIHNoYXJlZCB2ZWN0b3JzIHRvIGF2b2lkIEdDCiAgICAgICAgX3RlbXBWZWMxLmNvcHkoYmFsbFBvcykuc3ViKGVudFBvcykubm9ybWFsaXplKCk7IC8vIHRvQmFsbAogICAgICAgIF90ZW1wVmVjMi5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKGVudGl0eS5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOyAvLyBwbGF5ZXJGb3J3YXJkCgogICAgICAgIGNvbnN0IGZhY2luZ0RvdCA9IF90ZW1wVmVjMi5kb3QoX3RlbXBWZWMxKTsKCiAgICAgICAgY29uc3QgY29uZVRocmVzaG9sZCA9IC0wLjQ7IC8vIE1vcmUgZ2VuZXJvdXMgY29uZSAod2FzIC0wLjIpCiAgICAgICAgY29uc3QgaXNJbkNvbmUgPSBmYWNpbmdEb3QgPiBjb25lVGhyZXNob2xkOwogICAgICAgIAogICAgICAgIC8vIEFVVE8tVFVSTjogSWYgbmVhciBidXQgZmFjaW5nIHdyb25nIHdheSwgdHVybiB0b3dhcmRzIGJhbGwKICAgICAgICBpZiAoZGlzdFhaIDwgaW50ZXJhY3Rpb25SYWRpdXMgJiYgIWlzSW5Db25lKSB7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldEFuZ2xlID0gTWF0aC5hdGFuMihfdGVtcFZlYzEueCwgX3RlbXBWZWMxLnopOwogICAgICAgICAgICBjb25zdCBxID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMSwwKSwgdGFyZ2V0QW5nbGUpOwogICAgICAgICAgICBlbnRpdHkubWVzaC5xdWF0ZXJuaW9uLnNsZXJwKHEsIDAuMik7IC8vIEZhc3RlciB0dXJuICh3YXMgMC4xKQogICAgICAgICAgICBpZiAoZW50aXR5LnN5bmNSb3RhdGlvbikgZW50aXR5LnN5bmNSb3RhdGlvbigpOwogICAgICAgIH0KCiAgICAgICAgLy8gR1JBQiBMT0dJQwogICAgICAgIC8vIDEuIFRvdWNoOiBWZXJ5IGNsb3NlIChpZ25vcmUgZmFjaW5nIC0gcHJldmVudHMgcnVubmluZyBvdmVyIGJhbGwpCiAgICAgICAgLy8gMi4gTWFnbmV0OiBDbG9zZSBhbmQgZmFjaW5nCiAgICAgICAgY29uc3QgaXNUb3VjaCA9IGRpc3RYWiA8IHRvdWNoUmFkaXVzOwogICAgICAgIGNvbnN0IGlzTWFnbmV0ID0gZGlzdFhaIDwgbWFnbmV0UmFkaXVzICYmIGlzSW5Db25lOwoKICAgICAgICBpZiAoaXNUb3VjaCB8fCBpc01hZ25ldCkgewogICAgICAgICAgICAvLyBCTEFTVCBUSFJPVUdIIExPR0lDCiAgICAgICAgICAgIGNvbnN0IGJhbGxTcGVlZCA9IF9iYWxsLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICBsZXQgY2F0Y2hDaGFuY2UgPSAxLjA7CgogICAgICAgICAgICAvLyBJZiBiYWxsIGlzIG1vdmluZyBmYXN0IChlLmcuID4gMjApLCBjaGVjayBDQQogICAgICAgICAgICBpZiAoYmFsbFNwZWVkID4gMjAuMCkgewogICAgICAgICAgICAgICAgY29uc3QgY2EgPSBlbnRpdHkuZ2V0U3RhdCgnQ0EnKTsKICAgICAgICAgICAgICAgIC8vIERpZmZpY3VsdHkgc2NhbGVzIHdpdGggc3BlZWQuIAogICAgICAgICAgICAgICAgY29uc3QgZGlmZmljdWx0eSA9IGJhbGxTcGVlZCAqIDEuMjsgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChkaWZmaWN1bHR5ID4gY2EpIHsKICAgICAgICAgICAgICAgICAgICBjYXRjaENoYW5jZSA9IDAuNCArIChjYSAvIGRpZmZpY3VsdHkpICogMC42OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFBvaW50IEJsYW5rIFBlbmFsdHk6IEhhcmRlciB0byByZWFjdCBpZiBiYWxsIGlzIHJpZ2h0IG9uIHRvcCBvZiB5b3UgbW92aW5nIGZhc3QKICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdFhaIDwgMS4yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoQ2hhbmNlICo9IDAuNjsgLy8gQmxhc3QgdGhyb3VnaCBsaWtlbHkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKGVudGl0eS5pc0Rhc2hpbmcpIGNhdGNoQ2hhbmNlICs9IDAuMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChfYmFsbC5wb3dlclR5cGUgPT09ICdTSCcgJiYgX2JhbGwucG93ZXIgPiAxNS4wKSB7CiAgICAgICAgICAgICAgICAvLyBTaG90IHBvd2VyIGNoZWNrCiAgICAgICAgICAgICAgICBjb25zdCBjYSA9IGVudGl0eS5nZXRTdGF0KCdDQScpOwogICAgICAgICAgICAgICAgaWYgKF9iYWxsLnBvd2VyID4gY2EgKiAxLjIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFuY2UgPSBNYXRoLm1pbigwLjcsIChfYmFsbC5wb3dlciAtIGNhKSAqIDAuMDQpOwogICAgICAgICAgICAgICAgICAgIGNhdGNoQ2hhbmNlID0gMS4wIC0gY2hhbmNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgZnVtYmxlID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gY2F0Y2hDaGFuY2UpIHsKICAgICAgICAgICAgICAgIGZ1bWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmdW1ibGUpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIGZlZWRiYWNrIGZvciBibGFzdCB0aHJvdWdoCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxBU1QgVEhST1VHSCEiLCBlbnRQb3MsICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGVmbGVjdCBzbGlnaHRseSBidXQga2VlcCBtb3ZpbmcgZmFzdCAoQmxhc3QgVGhyb3VnaCkKICAgICAgICAgICAgICAgIC8vIERvbid0IHN0b3AgaXQgY29tcGxldGVseSBsaWtlIGEgYmxvY2ssIGp1c3QgcGVydHVyYiBpdAogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC44NSk7IAogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogNS4wOwogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkueSArPSAoTWF0aC5yYW5kb20oKSkgKiA1LjA7IC8vIFBvcCB1cAogICAgICAgICAgICAgICAgX2JhbGwudmVsb2NpdHkueiArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogNS4wOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfYmFsbC5wb3dlciAqPSAwLjc7CgogICAgICAgICAgICAgICAgZW50aXR5LmNhbkNhdGNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBTdHVuIGJyaWVmbHkKICAgICAgICAgICAgICAgIGVudGl0eS5zdHVuVGltZXIgPSAwLjU7CiAgICAgICAgICAgICAgICBpZihlbnRpdHkucGxheSkgZW50aXR5LnBsYXkoJ3JlYWN0JywgMC4xKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IGVudGl0eS5jYW5DYXRjaCA9IHRydWU7IH0sIDEwMDApOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9iYWxsLm1hZ25ldGl6ZShlbnRpdHkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIFN0YXJ0CiAgICBpbml0KCk7Cn0pKCk7","Ball.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIHZlY3RvcnMgdG8gYXZvaWQgR0MKY29uc3QgX2JWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2JEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2F4aXNZID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CiAgICBjb25zdCBfdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbWFnbnVzVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCi8vIFBoeXNpY3MgQ29uZmlndXJhdGlvbiAoRXhwb3NlZCBmb3IgRGV2VG9vbHMpCndpbmRvdy5mbHV4LkJhbGxDb25maWcgPSB7CiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBDb3JlIGludGVncmF0aW9uCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBTVUJTVEVQUzogMiwgICAgICAgICAgICAgICAgLy8gUGh5c2ljcyBzdWJzdGVwcyBwZXIgZnJhbWUgKHN0YWJpbGl0eSBhdCBoaWdoIHNwZWVkcykKICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLCAgICAgICAgICAgLy8gQmVsb3cgdGhpcyBzcGVlZCwgc25hcCB0byByZXN0IChwcmV2ZW50cyBlbmRsZXNzIGRyaWZ0KQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFdhdGVyIHJlc2lzdGFuY2UgKHBoeXNpY2FsIHZlbG9jaXR5IGRyYWcsIE5PVCBzdGF0IGRlY2F5KQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMTUsICAgIC8vIExpbmVhciBkcmFnIHRlcm0gKHJvdWdobHkgeW91ciBwcmV2aW91cyBXQVRFUl9EUkFHKQogICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDIsICAgICAvLyBRdWFkcmF0aWMgZHJhZyAoc3Ryb25nZXIgYXQgaGlnaCBzcGVlZCwgaGVscHMgdGFtZSByb2NrZXRzKQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFNwaW4gJiBjdXJ2ZQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgU1BJTl9EUkFHOiAwLjQwLCAgICAgICAgICAgIC8vIFNwaW4gZGVjYXkgcGVyIHNlY29uZAogICAgICAgIE1BR05VU19FTkFCTEVEOiB0cnVlLAogICAgICAgIE1BR05VU19DT0VGRjogMC4wOCwgICAgICAgICAvLyBMaWZ0IHN0cmVuZ3RoCiAgICAgICAgTUFHTlVTX0NBUDogNjAuMCwgICAgICAgICAgIC8vIE1heCBtYWdudXMgZGVsdGEtViBwZXIgc3Vic3RlcCAocHJldmVudHMgZXhwbG9zaW9ucykKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBEZXB0aCBjb25zdHJhaW50IChrZWVwcyBiYWxsIG5lYXIgcGxheSBwbGFuZSB3aXRob3V0IGZlZWxpbmcgbGlrZSBhIGhhcmQgZmxvb3IpCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBERVBUSF9UQVJHRVRfWTogMC4wLAogICAgICAgIERFUFRIX1NQUklORzogMS4wLCAgICAgICAgICAvLyBZb3VyIHByZXZpb3VzIEdSQVZJVFlfU1BSSU5HCiAgICAgICAgREVQVEhfREFNUDogMS41LCAgICAgICAgICAgIC8vIFlvdXIgcHJldmlvdXMgR1JBVklUWV9EQU1QCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gQXJlbmEgYm91bmRhcnkgKHNvZnQgd2FsbCArIGNsYW1wKQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCkJPVU5EQVJZX1JBRElVUzogNDYuMCwKICAgICAgICBCT1VOREFSWV9IRUlHSFQ6IDIwLjAsCiAgICAgICAgR09BTF9QT0NLRVRfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBHT0FMX1BPQ0tFVF9YOiAxMi4wLCAgICAgICAgLy8gSGFsZi13aWR0aCBvZiBnb2FsIHBvY2tldCBjb3JyaWRvcgogICAgICAgIEdPQUxfUE9DS0VUX1o6IDQwLjAsICAgICAgICAvLyBTdGFydCBvZiBnb2FsIHBvY2tldCBjb3JyaWRvciAoYWJzIHopIC0gUHVzaGVkIGJhY2sKICAgICAgICBHT0FMX1BPQ0tFVF9SQURJVVM6IDU1LjAsICAgLy8gRWZmZWN0aXZlIHJhZGl1cyB3aGVuIGluIGdvYWwgcG9ja2V0CiAgICAgICAgV0FMTF9TT0ZUX0JVRkZFUjogMy4wLCAgICAgIC8vIERpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMKICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDIwLjAsICAgICAgLy8gU29mdCByZXB1bHNpb24gc3RyZW5ndGgKICAgICAgICBXQUxMX0VMQVNUSUNJVFk6IDAuMzAsICAgICAgLy8gQm91bmNlIGRhbXBlbmluZyBvbiBjbGFtcAogICAgICAgIFdBTExfRlJJQ1RJT046IDAuOTUsICAgICAgICAvLyBUYW5nZW50aWFsIGRhbXBpbmcgb24gd2FsbCBjb250YWN0CgogICAgICAgIEZMT09SX0VMQVNUSUNJVFk6IDAuNDAsICAgICAvLyBCb3VuY2UgZGFtcGVuaW5nIG9uIGNlaWxpbmcvZmxvb3IgY2xhbXAKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBUaHJvdyBtYXBwaW5nIChzdGF0IGZvcmNlIC0+IHBoeXNpY2FsIGxhdW5jaCBzcGVlZCkKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIExBVU5DSF9TUEVFRF9TQ0FMRTogMS4wLCAgICAvLyBNdWx0aXBsaWVzIGZvcmNlIHdoZW4gY29udmVydGluZyB0byB2ZWxvY2l0eQogICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDg1LjAgICAgICAvLyBQaHlzaWNhbCBzcGVlZCBjYXAgKHdhcyBoYXJkY29kZWQgaW4gQmFsbC5zaG9vdCkKICAgIH07CgoKICAgIAogICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWc7IC8vIExvY2FsIGFsaWFzIGZvciBicmV2aXR5CiAgICAvLyAtLS0gVFJBSUwgUkVOREVSRVIgLS0tCi8vIC0tLSBUUkFJTCBSRU5ERVJFUiAtLS0KICAgIGNsYXNzIFRyYWlsUmVuZGVyZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5zZWdtZW50cyA9IDMwOyAvLyBNb3JlIHNlZ21lbnRzIGZvciBzbW9vdGhlciBjdXJ2ZXMKICAgICAgICAgICAgdGhpcy5wb2ludHMgPSBbXTsKdGhpcy5iYXNlV2lkdGggPSAwLjg7IC8vIEluY3JlYXNlZCB3aWR0aCBmb3IgdmlzaWJpbGl0eQogICAgICAgICAgICB0aGlzLmN1cnJlbnRXaWR0aCA9IDAuODsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJ5CiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgICAgIGNvbnN0IHBvc0RhdGEgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuc2VnbWVudHMgKiAyICogMyk7CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHBvc0RhdGEsIDMpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluZGljZXMKICAgICAgICAgICAgY29uc3QgaW5kaWNlcyA9IFtdOwogICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50cy0xOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhc2UgPSBpKjI7CiAgICAgICAgICAgICAgICBpbmRpY2VzLnB1c2goYmFzZSwgYmFzZSsxLCBiYXNlKzIpOwogICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGJhc2UrMSwgYmFzZSszLCBiYXNlKzIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEluZGV4KGluZGljZXMpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBjb2xvcjogMHgwMGFhZmYsCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLjksIC8vIEluY3JlYXNlZCBvcGFjaXR5CiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLm1lc2gpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW5pdCBwb2ludHMKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB0aGlzLnBvaW50cy5wdXNoKG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUmV1c2FibGUgdGVtcHMgKGF2b2lkIHBlci1mcmFtZSBhbGxvY2F0aW9ucyBvbiBtb2JpbGUpCiAgICAgICAgICAgIHRoaXMuX3RtcERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuX3RtcFRvQ2FtID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5fdG1wUmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXNldChwb3MpIHsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB0aGlzLnBvaW50c1tpXS5jb3B5KHBvcyk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlR2VvbWV0cnkoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgc2V0Q29sb3IoaGV4KSB7CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KGhleCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZShjdXJyZW50UG9zLCBzcGVlZFJhdGlvID0gMC4wKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXQoY3VycmVudFBvcyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCi8vIER5bmFtaWMgV2lkdGggYmFzZWQgb24gc3BlZWQgQU5EIFNQSU4gKFBvd2VyIFZpc3VhbCkKICAgICAgICAgICAgLy8gRmFzdCBiYWxsID0gVGhpY2tlci4gU3Bpbm5pbmcgYmFsbCA9IEV2ZW4gVGhpY2tlci4KICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgY29uc3Qgc3BpblJhdGlvID0gYmFsbCA/IE1hdGgubWluKDEuMCwgYmFsbC5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkgLyAzMC4wKSA6IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB0YXJnZXRXaWR0aCA9IHRoaXMuYmFzZVdpZHRoICogKDAuOCArIHNwZWVkUmF0aW8gKiAxLjIgKyBzcGluUmF0aW8gKiAyLjApOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRXaWR0aCArPSAodGFyZ2V0V2lkdGggLSB0aGlzLmN1cnJlbnRXaWR0aCkgKiAwLjI7IC8vIFNtb290aCB0cmFuc2l0aW9uCgogICAgICAgICAgICAvLyBTaGlmdCBwb2ludHMKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuc2VnbWVudHMgLSAxOyBpID4gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBvaW50c1tpXS5jb3B5KHRoaXMucG9pbnRzW2ktMV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucG9pbnRzWzBdLmNvcHkoY3VycmVudFBvcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVwZGF0ZUdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZUdlb21ldHJ5KCkgewogICAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5hcnJheTsKICAgICAgICAgICAgY29uc3QgY2FtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSA6IG51bGw7CiAgICAgICAgICAgIGlmICghY2FtKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IGNhbS5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgdGVtcERpciA9IHRoaXMuX3RtcERpcjsKICAgICAgICAgICAgY29uc3QgdGVtcFRvQ2FtID0gdGhpcy5fdG1wVG9DYW07CiAgICAgICAgICAgIGNvbnN0IHRlbXBSaWdodCA9IHRoaXMuX3RtcFJpZ2h0OwogICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5wb2ludHNbaV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRhcGVyIHdpZHRoIGFsb25nIHRyYWlsIGxlbmd0aAogICAgICAgICAgICAgICAgY29uc3QgdGFwZXIgPSAxLjAgLSBNYXRoLnBvdyhpIC8gdGhpcy5zZWdtZW50cywgMik7IC8vIFF1YWRyYXRpYyB0YXBlcgogICAgICAgICAgICAgICAgY29uc3QgdyA9IHRoaXMuY3VycmVudFdpZHRoICogdGFwZXI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIGlmIChpIDwgdGhpcy5zZWdtZW50cyAtIDEpIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wRGlyLnN1YlZlY3RvcnModGhpcy5wb2ludHNbaV0sIHRoaXMucG9pbnRzW2krMV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wRGlyLnN1YlZlY3RvcnModGhpcy5wb2ludHNbaS0xXSwgdGhpcy5wb2ludHNbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGVtcERpci5sZW5ndGhTcSgpIDwgMC4wMDAxKSB0ZW1wRGlyLnNldCgwLCAxLCAwKTsKICAgICAgICAgICAgICAgIHRlbXBEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRlbXBUb0NhbS5zdWJWZWN0b3JzKGNhbVBvcywgcCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0ZW1wUmlnaHQuY3Jvc3NWZWN0b3JzKHRlbXBEaXIsIHRlbXBUb0NhbSkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIodyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZlcnQgMQogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDBdID0gcC54IC0gdGVtcFJpZ2h0Lng7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgMV0gPSBwLnkgLSB0ZW1wUmlnaHQueTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAyXSA9IHAueiAtIHRlbXBSaWdodC56OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZXJ0IDIKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAzXSA9IHAueCArIHRlbXBSaWdodC54OwogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDRdID0gcC55ICsgdGVtcFJpZ2h0Lnk7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgNV0gPSBwLnogKyB0ZW1wUmlnaHQuejsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgfQogICAgfQpjbGFzcyBCYWxsIHsKCiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7IAogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSBudWxsOyAvLyBUcmFjayB3aG8gdGhyZXcgaXQgbGFzdCAoZm9yIEVYUC9Bc3Npc3RzKQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOyAvLyAnZnJlZScsICdoZWxkJywgJ21hZ25ldGl6ZWQnCiAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIENvbnRpbnVvdXMgU3RhdHMKICAgICAgICAgICAgdGhpcy5wb3dlciA9IDA7ICAgICAgLy8gQ3VycmVudCBQQSBvciBTSCB2YWx1ZQogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9ICdub25lJzsgLy8gJ1BBJyBvciAnU0gnCiAgICAgICAgICAgIHRoaXMuZGVjYXlSYXRlID0gMy4wOyAvLyBTdGF0IHBvaW50cyBsb3N0IHBlciBzZWNvbmQgKFdhdGVyIHJlc2lzdGFuY2UpCiAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7IC8vIFRpbWUgYmVmb3JlIGJhbGwgY2FuIGJlIGNhdWdodCBhZ2FpbgoKICAgICAgICAgICAgLy8gTWFnbmV0IFN5c3RlbQogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1hZ25ldER1cmF0aW9uID0gMC4yOyAKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gVmlzdWFscyAoU3F1YXNoICYgU3RyZXRjaCkKICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zcGluTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubW9kZWwgPSBudWxsOwoKdGhpcy5pbml0TWVzaCgpOwogICAgICAgICAgICB0aGlzLnRyYWlsID0gbmV3IFRyYWlsUmVuZGVyZXIoc2NlbmUpOwogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDA7Cn0KaW5pdE1lc2goKSB7CiAgICAgICAgICAgIC8vIEhpZXJhcmNoeTogTWVzaCAoUG9zKSAtPiBEZWZvcm0gKFNxdWFzaC9TdHJldGNoKSAtPiBTcGluIChSb3RhdGlvbikgLT4gTW9kZWwKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7Cgp0aGlzLmRlZm9ybU5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnkgPSAwLjA7IC8vIFJlc2V0IG9mZnNldCBzbyBiYWxsIGlzIGNlbnRlcmVkIG9uIG1lc2ggcG9zaXRpb24KICAgICAgICAgICAgdGhpcy5tZXNoLmFkZCh0aGlzLmRlZm9ybU5vZGUpOyAvLyBGaXg6IEFkZCBkZWZvcm1Ob2RlIHRvIG1lc2gKCiAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLmFkZCh0aGlzLnNwaW5Ob2RlKTsKCiAgICAgICAgICAgIC8vIFByb2NlZHVyYWwgUGxhY2Vob2xkZXIgVGV4dHVyZSAoQmxpdHpiYWxsLWlzaCkKICAgICAgICAgICAgY29uc3QgcGxhY2Vob2xkZXJUZXggPSAoKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAgICAgYy53aWR0aCA9IDEyODsgYy5oZWlnaHQgPSA2NDsKICAgICAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2VlZWVlZSc7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwwLDEyOCw2NCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEJsdWUgYnVtcHMvZGV0YWlscwogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDA4OGZmJzsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDY7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBjdHguYXJjKGkqMjUsIDMyLCAxMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDA0NDg4JzsKICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAyOCwgMTI4LCA4KTsgLy8gU3RyaXBlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICAgICAgfSkoKTsKCiAgICAgICAgICAgIC8vIFBsYWNlaG9sZGVyIFZpc3VhbCAoSW1tZWRpYXRlIGZlZWRiYWNrLCBwZXJzaXN0cyB1bnRpbCB2YWxpZCBtb2RlbCBsb2FkcykKLy8gUGxhY2Vob2xkZXIgVmlzdWFsIChJbW1lZGlhdGUgZmVlZGJhY2ssIHBlcnNpc3RzIHVudGlsIHZhbGlkIG1vZGVsIGxvYWRzKQovLyBQbGFjZWhvbGRlciBWaXN1YWwgKEltbWVkaWF0ZSBmZWVkYmFjaywgcGVyc2lzdHMgdW50aWwgdmFsaWQgbW9kZWwgbG9hZHMpCmNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDAuMywgMTYsIDE2KTsgLy8gU2NhbGVkIGRvd24gfjE1JQogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBtYXA6IHBsYWNlaG9sZGVyVGV4LAogICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAKICAgICAgICAgICAgICAgIHdpcmVmcmFtZTogZmFsc2UsIC8vIFNvbGlkCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAxLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwoKICAgICAgICAgICAgLy8gTG9hZCBHTEIgTW9kZWwKICAgICAgICAgICAgY29uc3QgdXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy81MjFhZTg3ODhlNTg0ZTM3OGE3OWQ5NzMyYTA3NTM1Ni5nbGInOwogICAgICAgICAgICAKICAgICAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKHVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJERUJVRzogQmFsbCBHTEIgbG9hZGVkLiIsIGdsdGYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBtb2RlbCA9IGdsdGYuc2NlbmU7CgogICAgICAgICAgICAgICAgLy8gMS4gUmVzZXQgcm9vdCB0cmFuc2Zvcm1zCiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBtb2RlbC5yb3RhdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBtb2RlbC5zY2FsZS5zZXQoMSwgMSwgMSk7CiAgICAgICAgICAgICAgICBtb2RlbC51cGRhdGVNYXRyaXhXb3JsZCh0cnVlKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBIYXJkZW4gTWF0ZXJpYWxzICYgVmlzaWJpbGl0eQogICAgICAgICAgICAgICAgbW9kZWwudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5jYXN0U2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVjZWl2ZVNoYWRvdyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsgLy8gQ1JJVElDQUw6IFByZXZlbnQgY3VsbGluZyBpZiBib3VuZHMgYXJlIG9mZgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hdHMgPSBBcnJheS5pc0FycmF5KG5vZGUubWF0ZXJpYWwpID8gbm9kZS5tYXRlcmlhbCA6IFtub2RlLm1hdGVyaWFsXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdHMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLmNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIEZvcmNlIHdoaXRlIGJhc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnNpZGUgPSBUSFJFRS5Eb3VibGVTaWRlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5hbHBoYVRlc3QgPSAwOyAvLyBDUklUSUNBTDogRGlzYWJsZSBhbHBoYSB0ZXN0IHRvIHByZXZlbnQgY3VsbGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5kZXB0aFRlc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyAzLiBDb21wdXRlIEJvdW5kaW5nIEJveAogICAgICAgICAgICAgICAgY29uc3QgYm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KG1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNpemUgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgYm94LmdldFNpemUoc2l6ZSk7CiAgICAgICAgICAgICAgICBjb25zdCBjZW50ZXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgYm94LmdldENlbnRlcihjZW50ZXIpOwoKICAgICAgICAgICAgICAgIC8vIDQuIFZhbGlkYXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IG1heERpbSA9IE1hdGgubWF4KHNpemUueCwgc2l6ZS55LCBzaXplLnopOwogICAgICAgICAgICAgICAgaWYgKG1heERpbSA8PSAwLjAwMSB8fCAhaXNGaW5pdGUobWF4RGltKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBtb2RlbCBoYXMgaW52YWxpZCBkaW1lbnNpb25zLiBLZWVwaW5nIHBsYWNlaG9sZGVyLiIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gNS4gQ2FsY3VsYXRlIFNjYWxlCi8vIDUuIENhbGN1bGF0ZSBTY2FsZQpjb25zdCB0YXJnZXREaWFtZXRlciA9IDAuNzI7IC8vIFJlZHVjZWQgc2NhbGUgYnkgfjE1JSAod2FzIDAuODUpCiAgICAgICAgICAgICAgICBjb25zdCBzY2FsZUZhY3RvciA9IHRhcmdldERpYW1ldGVyIC8gbWF4RGltOwoKICAgICAgICAgICAgICAgIC8vIDYuIEFwcGx5IFRyYW5zZm9ybXMKICAgICAgICAgICAgICAgIG1vZGVsLnNjYWxlLnNldFNjYWxhcihzY2FsZUZhY3Rvcik7CiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5jb3B5KGNlbnRlcikubXVsdGlwbHlTY2FsYXIoLXNjYWxlRmFjdG9yKTsKCiAgICAgICAgICAgICAgICAvLyA3LiBTd2FwIFBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucmVtb3ZlKHRoaXMucGxhY2Vob2xkZXIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5KSB0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsID0gbW9kZWw7CiAgICAgICAgICAgICAgICB0aGlzLnNwaW5Ob2RlLmFkZCh0aGlzLm1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCbGl0emJhbGwgbW9kZWwgYXR0YWNoZWQuIFNjYWxlOiAke3NjYWxlRmFjdG9yLnRvRml4ZWQoNCl9YCk7CgogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBsb2FkIEJsaXR6YmFsbCBtb2RlbDoiLCBlcnIpOwogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2s6IEtlZXAgcGxhY2Vob2xkZXIgYnV0IHRpbnQgaXQgcmVkIHRvIGluZGljYXRlIGVycm9yCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZhYWFhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyBCYWxsIExhYiByZXBsYXkgb3ZlcnJpZGUgKGxldHMgRGV2VG9vbHMgZHJpdmUgdGhlIGJhbGwgZGV0ZXJtaW5pc3RpY2FsbHkpCiAgICAgICAgICAgIGNvbnN0IF9fbGFiID0gd2luZG93LmZsdXggJiYgd2luZG93LmZsdXguYmFsbExhYjsKICAgICAgICAgICAgaWYgKF9fbGFiICYmIF9fbGFiLmlzUmVwbGF5aW5nICYmIF9fbGFiLnRhcmdldEJhbGwgPT09IHRoaXMgJiYgdHlwZW9mIF9fbGFiLmFwcGx5UmVwbGF5RnJhbWUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIF9fbGFiLmFwcGx5UmVwbGF5RnJhbWUodGhpcywgZHQpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMudHJhaWwpIHRoaXMudHJhaWwuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTYWZldHk6IFJlc2V0IGlmIHBvc2l0aW9uIGNvcnJ1cHRlZAogICAgICAgICAgICBpZiAoaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLngpIHx8IGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi55KSB8fCBpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueikpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXQoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKLy8gU2FmZXR5OiBGaXggIlVucGlja2FibGUgQmFsbCIgQnVnCiAgICAgICAgICAgIC8vIDEuIEludmFsaWQgQWN0b3IgQ2hlY2sKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdoZWxkJyAmJiAoIXRoaXMuaG9sZGVyIHx8ICF0aGlzLmhvbGRlci5tZXNoKSkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdtYWduZXRpemVkJykgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLm1hZ25ldFRhcmdldCB8fCAhdGhpcy5tYWduZXRUYXJnZXQubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gMi4gTWFnbmV0aXplIFRpbWVvdXQgKFByZXZlbnQgZ2V0dGluZyBzdHVjayBpbiBtaWQtYWlyKQogICAgICAgICAgICAgICAgaWYgKHRoaXMubWFnbmV0VGltZXIgPiAyLjApIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkJhbGwgc3R1Y2sgaW4gbWFnbmV0aXplZCBzdGF0ZS4gRHJvcHBpbmcuIik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIFN0YXRlIENvbnNpc3RlbmN5CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnZnJlZScgJiYgdGhpcy5ob2xkZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaG9sZGVyID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRmFpbHNhZmU6IElmIGJhbGwgaXMgZnJlZSBhbmQgc2xvdywgZW5zdXJlIGl0J3MgY2F0Y2hhYmxlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnZnJlZScgJiYgdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMC41KSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwOwogICAgICAgICAgICB9CmlmICh0aGlzLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAvLyBUcmFpbCBpcyBhY3RpdmUgaWYgYmFsbCBpcyBtb3ZpbmcgZmFzdCBhbmQgZnJlZQogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgdGhpcy50cmFpbC5hY3RpdmUgPSAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHNwZWVkID4gMi4wKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRml4OiBPZmZzZXQgdHJhaWwgdG8gbWF0Y2ggdmlzdWFsIG1vZGVsIHBvc2l0aW9uIChkZWZvcm1Ob2RlIG9mZnNldCkKICAgICAgICAgICAgICAgIF9iVmVjLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlZm9ybU5vZGUpIF9iVmVjLnkgKz0gdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnk7CgogICAgICAgICAgICAgICAgLy8gUGFzcyBzcGVlZCByYXRpbyAoMCB0byAxIGJhc2VkIG9uIG1heCBzcGVlZCBhcHByb3ggNjApCiAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHNwZWVkIC8gNjAuMCwgMS4wKTsKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwudXBkYXRlKF9iVmVjLCByYXRpbyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaGVsZCcgJiYgdGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVIZWxkKGR0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTWFnbmV0aXplZChkdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUZyZWUoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAppZiAodGhpcy5jYXRjaEdyYWNlUGVyaW9kID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5jYXRjaEdyYWNlUGVyaW9kIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA8IDApIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7CiAgICAgICAgICAgIH0KCnRoaXMudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTYWZldHk6IEVuc3VyZSB2aXNpYmlsaXR5IGlmIG5vdCBleHBsaWNpdGx5IGludmlzaWJsZQovLyBTYWZldHk6IEVuc3VyZSB2aXNpYmlsaXR5IGlmIG5vdCBleHBsaWNpdGx5IGludmlzaWJsZQogICAgICAgICAgICBpZiAodGhpcy5tZXNoICYmICF0aGlzLmlzSW52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBGb3JjZSBtb2RlbCB2aXNpYmlsaXR5IGlmIHByZXNlbnQgKHNvbWV0aW1lcyBHTFRGIGxvYWRlciBoaWRlcyBpdCkKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1vZGVsKSB0aGlzLm1vZGVsLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKbWFnbmV0aXplKHRhcmdldCkgewogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ21hZ25ldGl6ZWQnIHx8IHRoaXMuc3RhdGUgPT09ICdoZWxkJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtYWduZXRpemVkJzsKICAgICAgICAgICAgdGhpcy5tYWduZXRUYXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICAgIHRoaXMuaG9sZGVyID0gdGFyZ2V0OyAvLyBMb2dpY2FsIHBvc3Nlc3Npb24gc28gQUkgcmVhY3RzCiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1hZ25ldFN0YXJ0UG9zLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFZlbC5jb3B5KHRoaXMudmVsb2NpdHkpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRHluYW1pYyBEdXJhdGlvbiBiYXNlZCBvbiBkaXN0YW5jZSAoU21vb3RoZXIgZm9yIGxvbmcgcmFuZ2UsIHNuYXBweSBmb3IgY2xvc2UpCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIHRoaXMubWFnbmV0RHVyYXRpb24gPSBNYXRoLm1heCgwLjE1LCBNYXRoLm1pbigwLjQsIGRpc3QgLyAxNS4wKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBLaWxsIHBoeXNpY3MKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIE5vdGlmeSBwbGF5ZXIgaW1tZWRpYXRlbHkgc28gdGhleSBzdG9wIGNoYXNpbmcgYW5kIHBsYXkgYW5pbWF0aW9uCiAgICAgICAgICAgIGlmICh0YXJnZXQucmVjZWl2ZUJhbGwpIHsKICAgICAgICAgICAgICAgIHRhcmdldC5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnJldmVhbCgpOwogICAgICAgIH0KCnVwZGF0ZU1hZ25ldGl6ZWQoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1hZ25ldFRhcmdldCB8fCAhdGhpcy5tYWduZXRUYXJnZXQubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgKz0gZHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3JtYWxpemVkIFRpbWUKICAgICAgICAgICAgbGV0IHQgPSB0aGlzLm1hZ25ldFRpbWVyIC8gdGhpcy5tYWduZXREdXJhdGlvbjsKICAgICAgICAgICAgaWYgKHQgPiAxLjApIHQgPSAxLjA7CgogICAgICAgICAgICAvLyBUYXJnZXQgIlZpcnR1YWwgSGFuZCIgUG9zaXRpb24gKEZyb250IG9mIENoZXN0KQogICAgICAgICAgICBjb25zdCBob2xkZXJQb3MgPSB0aGlzLm1hZ25ldFRhcmdldC5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBob2xkZXJRdWF0ID0gdGhpcy5tYWduZXRUYXJnZXQubWVzaC5xdWF0ZXJuaW9uOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT2Zmc2V0OiBGb3J3YXJkIDAuNiwgVXAgMS4wIChDaGVzdCBoZWlnaHQpCiAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IF9iVmVjLnNldCgwLCAxLjAsIDAuNikuYXBwbHlRdWF0ZXJuaW9uKGhvbGRlclF1YXQpOwogICAgICAgICAgICBjb25zdCB0YXJnZXRQb3MgPSBvZmZzZXQuYWRkKGhvbGRlclBvcyk7CgogICAgICAgICAgICAvLyAtLS0gUVVBRFJBVElDIEJFWklFUiBDVVJWRSAtLS0KICAgICAgICAgICAgLy8gUDAgPSBTdGFydCwgUDIgPSBUYXJnZXQKICAgICAgICAgICAgLy8gUDEgPSBDb250cm9sIFBvaW50IChQcm9qZWN0ZWQgYWxvbmcgaW5pdGlhbCB2ZWxvY2l0eSB0byBwcmVzZXJ2ZSBtb21lbnR1bSBmZWVsKQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcDAgPSB0aGlzLm1hZ25ldFN0YXJ0UG9zOwogICAgICAgICAgICBjb25zdCBwMiA9IHRhcmdldFBvczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBQMSAoQ29udHJvbCBQb2ludCkKICAgICAgICAgICAgLy8gUHJvamVjdCBmb3J3YXJkIGZyb20gUDAgYWxvbmcgc3RhcnQgdmVsb2NpdHkgdmVjdG9yCiAgICAgICAgICAgIC8vIERpc3RhbmNlIG9mIHByb2plY3Rpb24gPSA0MCUgb2YgdG90YWwgZGlzdGFuY2UgdG8gdGFyZ2V0CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBwMC5kaXN0YW5jZVRvKHAyKTsKICAgICAgICAgICAgY29uc3QgcDEgPSBfdGVtcFZlYy5jb3B5KHAwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHZlbExlbiA9IHRoaXMubWFnbmV0U3RhcnRWZWwubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHZlbExlbiA+IDEuMCkgewogICAgICAgICAgICAgICAgLy8gVXNlIHZlbG9jaXR5IHRhbmdlbnQKLy8gVXNlIHZlbG9jaXR5IHRhbmdlbnQKICAgICAgICAgICAgICAgIF9iRGlyLmNvcHkodGhpcy5tYWduZXRTdGFydFZlbCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBwMS5hZGQoX2JEaXIubXVsdGlwbHlTY2FsYXIoZGlzdCAqIDAuNCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gTm8gdmVsb2NpdHkgKHN0YXRpb25hcnkgYmFsbCksIGFyYyB1cHdhcmRzIHNsaWdodGx5CiAgICAgICAgICAgICAgICBwMS5sZXJwKHAyLCAwLjUpOwogICAgICAgICAgICAgICAgcDEueSArPSAxLjU7IAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCZXppZXI6IEIodCkgPSAoMS10KV4yICogUDAgKyAyKDEtdCl0ICogUDEgKyB0XjIgKiBQMgogICAgICAgICAgICBjb25zdCBvbmVNaW51c1QgPSAxLjAgLSB0OwogICAgICAgICAgICBjb25zdCB3MCA9IG9uZU1pbnVzVCAqIG9uZU1pbnVzVDsKICAgICAgICAgICAgY29uc3QgdzEgPSAyLjAgKiBvbmVNaW51c1QgKiB0OwogICAgICAgICAgICBjb25zdCB3MiA9IHQgKiB0OwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnggPSAodzAgKiBwMC54KSArICh3MSAqIHAxLngpICsgKHcyICogcDIueCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gKHcwICogcDAueSkgKyAodzEgKiBwMS55KSArICh3MiAqIHAyLnkpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueiA9ICh3MCAqIHAwLnopICsgKHcxICogcDEueikgKyAodzIgKiBwMi56KTsKCiAgICAgICAgICAgIC8vIEZpbmlzaAogICAgICAgICAgICBpZiAodCA+PSAxLjApIHsKICAgICAgICAgICAgICAgIHRoaXMuZ3JhYih0aGlzLm1hZ25ldFRhcmdldCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGVIZWxkKGR0KSB7CiAgICAgICAgICAgIC8vIEFUVEFDSEVEIFNUQVRFIChWaXJ0dWFsIEF0dGFjaG1lbnQpCiAgICAgICAgICAgIGlmICghdGhpcy5ob2xkZXIgfHwgIXRoaXMuaG9sZGVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gMS4gVHJ5IHRvIHVzZSBIYW5kIEJvbmUgaWYgYXZhaWxhYmxlIChSZWFsaXNtKQogICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIuaGFuZEJvbmUpIHsKICAgICAgICAgICAgICAgIC8vIEdldCB3b3JsZCBwb3NpdGlvbiBvZiB0aGUgaGFuZCBib25lCiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlci5oYW5kQm9uZS5nZXRXb3JsZFBvc2l0aW9uKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEFkanVzdCBzbGlnaHRseSB0byBzaXQgSU4gdGhlIGhhbmQgcmF0aGVyIHRoYW4gT04gdGhlIHdyaXN0CiAgICAgICAgICAgICAgICAvLyBXZSBjYW4ndCBlYXNpbHkga25vdyAiZm9yd2FyZCIgZm9yIHRoZSBib25lIHdpdGhvdXQgbW9yZSBpbmZvLCAKICAgICAgICAgICAgICAgIC8vIGJ1dCB1c3VhbGx5IEdMVEYgYm9uZXMgYXJlIG9yaWVudGVkLiBGb3Igbm93LCBleGFjdCBib25lIHBvcyBpcyBiZXR0ZXIgdGhhbiBjaGVzdC4KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIDIuIEZhbGxiYWNrOiBDYWxjdWxhdGUgIkNhcnJ5aW5nIiBQb3NpdGlvbiAoUmlnaHQgSGFuZCBTaWRlKQogICAgICAgICAgICAgICAgLy8gUmVsYXRpdmUgdG8gcGxheWVyOiBVcCAwLjggKFdhaXN0L0NoZXN0KSwgUmlnaHQgMC40LCBGb3J3YXJkIDAuNQogICAgICAgICAgICAgICAgY29uc3QgaG9sZGVyUG9zID0gdGhpcy5ob2xkZXIubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGhvbGRlclF1YXQgPSB0aGlzLmhvbGRlci5tZXNoLnF1YXRlcm5pb247CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJldXNlIF9iVmVjCi8vIFJldXNlIF9iVmVjCiAgICAgICAgICAgICAgICAvLyBPZmZzZXQ6IHg9MC4zNSAoUmlnaHQpLCB5PTEuMyAoQ2hlc3QvSGFuZHMpLCB6PTAuNSAoRm9yd2FyZCkKICAgICAgICAgICAgICAgIF9iVmVjLnNldCgwLjM1LCAxLjMsIDAuNSkuYXBwbHlRdWF0ZXJuaW9uKGhvbGRlclF1YXQpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmNvcHkoaG9sZGVyUG9zKS5hZGQoX2JWZWMpOwogICAgICAgICAgICB9CgovLyBWaXN1YWwgRmxhaXI6IFNwaW4gdGhlIGJhbGwgc2xvd2x5CiAgICAgICAgICAgIGNvbnN0IHJvdFggPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUobmV3IFRIUkVFLlZlY3RvcjMoMSwwLDApLCAyICogZHQpOwogICAgICAgICAgICBjb25zdCByb3RZID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMSwwKSwgNSAqIGR0KTsKICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uLm11bHRpcGx5KHJvdFgpLm11bHRpcGx5KHJvdFkpOwogICAgICAgIH0KCgp1cGRhdGVGcmVlKGR0KSB7CiAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgIGNvbnN0IHN1YnN0ZXBzID0gTWF0aC5tYXgoMSwgTWF0aC5mbG9vcihDLlNVQlNURVBTIHx8IDEpKTsKICAgIGNvbnN0IHN0ZXBEdCA9IGR0IC8gc3Vic3RlcHM7CgogICAgLy8gLS0tIDEpIEludGVncmF0ZSBwaHlzaWNzIGluIHN1YnN0ZXBzIGZvciBzdGFiaWxpdHkgLS0tCiAgICBmb3IgKGxldCBzID0gMDsgcyA8IHN1YnN0ZXBzOyBzKyspIHsKICAgICAgICAvLyBBKSBNYWdudXMgZWZmZWN0IChjdXJ2ZSBmcm9tIHNwaW4pCiAgICAgICAgaWYgKEMuTUFHTlVTX0VOQUJMRUQgJiYgdGhpcy5hbmd1bGFyVmVsb2NpdHkgJiYgdGhpcy52ZWxvY2l0eSkgewogICAgICAgICAgICBjb25zdCBzcGluU3EgPSB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICBjb25zdCB2ZWxTcSA9IHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHNwaW5TcSA+IDAuMjUgJiYgdmVsU3EgPiAwLjI1KSB7CiAgICAgICAgICAgICAgICBfbWFnbnVzVmVjLmNvcHkodGhpcy5hbmd1bGFyVmVsb2NpdHkpLmNyb3NzKHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKChDLk1BR05VU19DT0VGRiB8fCAwKSAqIHN0ZXBEdCk7CgogICAgICAgICAgICAgICAgLy8gQ2FwIHRvIGF2b2lkIG51bWVyaWMgYmxvd3VwcwogICAgICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTUFHTlVTX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5NQUdOVVNfQ0FQIDogNjAuMCk7CiAgICAgICAgICAgICAgICBjb25zdCBtYWdMZW4gPSBfbWFnbnVzVmVjLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgaWYgKG1hZ0xlbiA+IGNhcCkgX21hZ251c1ZlYy5tdWx0aXBseVNjYWxhcihjYXAgLyBtYWdMZW4pOwoKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKF9tYWdudXNWZWMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBCKSBTcGluIGRlY2F5CiAgICAgICAgaWYgKHRoaXMuYW5ndWxhclZlbG9jaXR5KSB7CiAgICAgICAgICAgIGNvbnN0IHNwaW5EcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gKEMuU1BJTl9EUkFHIHx8IDApICogc3RlcER0KTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoc3BpbkRyYWcpOwogICAgICAgIH0KCiAgICAgICAgLy8gQykgRGVwdGggc3ByaW5nIChrZWVwcyBiYWxsIG5lYXIgcGxhbmUpCiAgICAgICAgY29uc3QgdGFyZ2V0WSA9IChDLkRFUFRIX1RBUkdFVF9ZICE9PSB1bmRlZmluZWQgPyBDLkRFUFRIX1RBUkdFVF9ZIDogMC4wKTsKICAgICAgICBjb25zdCB5RXJyID0gKHRoaXMubWVzaC5wb3NpdGlvbi55IC0gdGFyZ2V0WSk7CiAgICAgICAgdGhpcy52ZWxvY2l0eS55IC09IHlFcnIgKiAoQy5ERVBUSF9TUFJJTkcgfHwgMCkgKiBzdGVwRHQ7CiAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IE1hdGgubWF4KDAsIDEuMCAtIChDLkRFUFRIX0RBTVAgfHwgMCkgKiBzdGVwRHQpOwoKICAgICAgICAvLyBEKSBBcHBseSBkcmFnIChsaW5lYXIgKyBxdWFkcmF0aWMpCiAgICAgICAgY29uc3QgdkxlbiA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgaWYgKHZMZW4gPiAwLjAwMDAxKSB7CiAgICAgICAgICAgIGNvbnN0IGxpbiA9IChDLldBVEVSX0RSQUdfTElORUFSICE9PSB1bmRlZmluZWQgPyBDLldBVEVSX0RSQUdfTElORUFSIDogKEMuV0FURVJfRFJBRyB8fCAwKSkgKiBzdGVwRHQ7CiAgICAgICAgICAgIGNvbnN0IHF1YWQgPSAoQy5XQVRFUl9EUkFHX1FVQUQgfHwgMCkgKiB2TGVuICogc3RlcER0OwogICAgICAgICAgICBjb25zdCBkcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gbGluIC0gcXVhZCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoZHJhZyk7CgogICAgICAgICAgICBjb25zdCBzdG9wID0gKEMuU1RPUF9TUEVFRCB8fCAwKTsKICAgICAgICAgICAgaWYgKHN0b3AgPiAwICYmIHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKSA8IHN0b3AgKiBzdG9wKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRSkgTW92ZQogICAgICAgIF90ZW1wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoc3RlcER0KTsKICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF90ZW1wVmVjKTsKCiAgICAgICAgLy8gRikgU3RhdCBwb3dlciBkZWNheSAoZ2FtZSBsb2dpYykKICAgICAgICBpZiAodGhpcy5wb3dlciA+IDApIHsKICAgICAgICAgICAgdGhpcy5wb3dlciAtPSB0aGlzLmRlY2F5UmF0ZSAqIHN0ZXBEdDsKICAgICAgICAgICAgaWYgKHRoaXMucG93ZXIgPCAwKSB0aGlzLnBvd2VyID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIEcpIEJvdW5kYXJ5IGxvZ2ljIChzb2Z0IHdhbGwgKyBjbGFtcCkKICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1lc2gucG9zaXRpb247CiAgICAgICAgY29uc3QgZGlzdFhaID0gTWF0aC5zcXJ0KHBvcy54ICogcG9zLnggKyBwb3MueiAqIHBvcy56KTsKCiAgICAgICAgY29uc3QgYm91bmRhcnlSYWRpdXMgPSAoQy5CT1VOREFSWV9SQURJVVMgIT09IHVuZGVmaW5lZCA/IEMuQk9VTkRBUllfUkFESVVTIDogMzMuMCk7CiAgICAgICAgbGV0IGVmZmVjdGl2ZUJvdW5kYXJ5ID0gYm91bmRhcnlSYWRpdXM7CgogICAgICAgIGlmIChDLkdPQUxfUE9DS0VUX0VOQUJMRUQpIHsKICAgICAgICAgICAgY29uc3QgaW5Hb2FsUG9ja2V0ID0gKE1hdGguYWJzKHBvcy54KSA8IChDLkdPQUxfUE9DS0VUX1ggfHwgMTIuMCkgJiYgTWF0aC5hYnMocG9zLnopID4gKEMuR09BTF9QT0NLRVRfWiB8fCAyNS4wKSk7CiAgICAgICAgICAgIGlmIChpbkdvYWxQb2NrZXQpIGVmZmVjdGl2ZUJvdW5kYXJ5ID0gKEMuR09BTF9QT0NLRVRfUkFESVVTIHx8IDQ1LjApOwogICAgICAgIH0KCiAgICAgICAgY29uc3Qgc29mdEJ1ZmZlciA9IE1hdGgubWF4KDAuMDEsIChDLldBTExfU09GVF9CVUZGRVIgIT09IHVuZGVmaW5lZCA/IEMuV0FMTF9TT0ZUX0JVRkZFUiA6IDMuMCkpOwoKICAgICAgICAvLyBTb2Z0IHJlcHVsc2lvbiAoY3VydmVzIHRyYWplY3RvcnkgbmVhciB3YWxsIGluc3RlYWQgb2YgcGluZy1wb25nKQogICAgICAgIGlmIChkaXN0WFogPiBlZmZlY3RpdmVCb3VuZGFyeSAtIHNvZnRCdWZmZXIpIHsKICAgICAgICAgICAgY29uc3QgcGVuZXRyYXRpb24gPSBkaXN0WFogLSAoZWZmZWN0aXZlQm91bmRhcnkgLSBzb2Z0QnVmZmVyKTsKICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBwZW5ldHJhdGlvbiAvIHNvZnRCdWZmZXIpKTsKCiAgICAgICAgICAgIF90ZW1wVmVjLnNldCgtcG9zLngsIDAsIC1wb3Mueik7CiAgICAgICAgICAgIGlmIChfdGVtcFZlYy5sZW5ndGhTcSgpID4gMC4wMDAxKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYy5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gcmF0aW8gKiByYXRpbyAqIChDLldBTExfU09GVF9GT1JDRSB8fCAwKSAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjLCBmb3JjZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEhhcmQgY2xhbXAgaWYgaXQgc3RpbGwgaGl0cwogICAgICAgIGlmIChkaXN0WFogPiBlZmZlY3RpdmVCb3VuZGFyeSkgewogICAgICAgICAgICBfdGVtcFZlYy5zZXQoLXBvcy54LCAwLCAtcG9zLnopOwogICAgICAgICAgICBpZiAoX3RlbXBWZWMubGVuZ3RoU3EoKSA+IDAuMDAwMSkgX3RlbXBWZWMubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBvdmVybGFwID0gZGlzdFhaIC0gZWZmZWN0aXZlQm91bmRhcnk7CiAgICAgICAgICAgIHBvcy5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMsIG92ZXJsYXApOwoKY29uc3QgdkRvdE4gPSB0aGlzLnZlbG9jaXR5LmRvdChfdGVtcFZlYyk7CgogICAgICAgICAgICAvLyBPbmx5IGFkanVzdCBpZiBtb3Zpbmcgb3V0d2FyZCAoYWdhaW5zdCBpbndhcmQgbm9ybWFsKQogICAgICAgICAgICBpZiAodkRvdE4gPCAwKSB7CiAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIEFyZW5hIERlZm9ybWF0aW9uIGlmIGltcGFjdCBpcyBmb3JjZWZ1bAogICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0U3BlZWQgPSBNYXRoLmFicyh2RG90Tik7CiAgICAgICAgICAgICAgICBpZiAoaW1wYWN0U3BlZWQgPiAxMC4wICYmIHdpbmRvdy5mbHV4LnRyaWdnZXJBcmVuYUltcGFjdCkgewogICAgICAgICAgICAgICAgICAgIC8vIFBhc3MgdGhlIGNvbnRhY3QgcG9pbnQgKHBvcykgYW5kIHN0cmVuZ3RoIGJhc2VkIG9uIHNwZWVkCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KHBvcywgTWF0aC5taW4oaW1wYWN0U3BlZWQgKiAwLjUsIDE1LjApKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBlID0gKEMuV0FMTF9FTEFTVElDSVRZICE9PSB1bmRlZmluZWQgPyBDLldBTExfRUxBU1RJQ0lUWSA6IDAuMyk7CiAgICAgICAgICAgICAgICBjb25zdCBpbXB1bHNlID0gX3RlbXBWZWMuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtdkRvdE4gKiAoMS4wICsgZSkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoaW1wdWxzZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRhbmdlbnRpYWwgZnJpY3Rpb24KICAgICAgICAgICAgICAgIGNvbnN0IGZyaWN0aW9uID0gKEMuV0FMTF9GUklDVElPTiAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX0ZSSUNUSU9OIDogMC45NSk7CiAgICAgICAgICAgICAgICBjb25zdCB0YW5nZW50ID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLnByb2plY3RPblBsYW5lKF90ZW1wVmVjKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc3ViKHRhbmdlbnQubXVsdGlwbHlTY2FsYXIoMS4wIC0gZnJpY3Rpb24pKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQ2VpbGluZy9GbG9vciBjbGFtcAogICAgICAgIGNvbnN0IGJoID0gKEMuQk9VTkRBUllfSEVJR0hUICE9PSB1bmRlZmluZWQgPyBDLkJPVU5EQVJZX0hFSUdIVCA6IDE1LjApOwogICAgICAgIGlmIChNYXRoLmFicyhwb3MueSkgPiBiaCkgewogICAgICAgICAgICBjb25zdCBzaWduID0gTWF0aC5zaWduKHBvcy55KSB8fCAxOwogICAgICAgICAgICBwb3MueSA9IGJoICogc2lnbjsKICAgICAgICAgICAgY29uc3QgZmUgPSAoQy5GTE9PUl9FTEFTVElDSVRZICE9PSB1bmRlZmluZWQgPyBDLkZMT09SX0VMQVNUSUNJVFkgOiAwLjQpOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLWZlOwp9CiAgICB9CgogICAgLy8gLS0tIDIpIEZYIHRoYXQgc2hvdWxkIHJ1biBvbmNlIHBlciBmcmFtZSAobm90IHBlciBzdWJzdGVwKSAtLS0KICAgIGlmICghdGhpcy5fZ2hvc3QpIHsKICAgICAgICBjb25zdCBzcGVlZFNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgIGlmIChzcGVlZFNxID4gMi4wICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5fYnViYmxlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgY29uc3QgcG0gPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKC0wLjgpOwoKICAgICAgICAgICAgICAgIC8vIFN0YW5kYXJkIGJ1YmJsZQovLyBTdGFuZGFyZCBidWJibGUKICAgICAgICAgICAgICAgIGNvbnN0IHN0ZFBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLmFkZChfYkRpci5zZXQoKE1hdGgucmFuZG9tKCktMC41KSowLjMsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4zLCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuMykpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3RkUG9zLnkgKz0gdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlJywgc3RkUG9zLCB7IHNjYWxlOiAwLjQgKyBNYXRoLnJhbmRvbSgpICogMC40IH0pOyAvLyBJbmNyZWFzZWQgc2NhbGUKCiAgICAgICAgICAgICAgICAvLyBNaWNybyBidWJibGVzIGF0IGhpZ2ggc3BlZWQKICAgICAgICAgICAgICAgIGlmIChzcGVlZFNxID4gNTAuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gTWF0aC5taW4oNCwgTWF0aC5mbG9vcihzcGVlZFNxIC8gNjApKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKY29uc3Qgaml0dGVyID0gX2JEaXIuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC40LCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuNCwgKE1hdGgucmFuZG9tKCktMC41KSowLjQpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGF3blBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLmFkZChqaXR0ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWZvcm1Ob2RlKSBzcGF3blBvcy55ICs9IHRoaXMuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlX21pY3JvJywgc3Bhd25Qb3MsIHsgc2NhbGU6IDAuMDUgKyBNYXRoLnJhbmRvbSgpICogMC4xIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDAuMDI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gMC41KSB7CmNvbnN0IGppdHRlciA9IF9iRGlyLnNldCgoTWF0aC5yYW5kb20oKS0wLjUpKjAuMiwgKE1hdGgucmFuZG9tKCktMC41KSowLjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3Bhd25Qb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQob2Zmc2V0KS5hZGQoaml0dGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3Bhd25Qb3MueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIHNwYXduUG9zLCB7IHNjYWxlOiAwLjA0ICsgTWF0aC5yYW5kb20oKSAqIDAuMDYgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4wNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLyAtLS0gMykgVmlzdWFsIHJvdGF0aW9uIC0tLQogICAgY29uc3Qgc3BpblNwZWVkID0gdGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCk7CiAgICBpZiAoc3BpblNwZWVkID4gMC41KSB7CiAgICAgICAgY29uc3QgYXhpcyA9IF90ZW1wVmVjLmNvcHkodGhpcy5hbmd1bGFyVmVsb2NpdHkpLm5vcm1hbGl6ZSgpOwogICAgICAgIGNvbnN0IHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUoYXhpcywgc3BpblNwZWVkICogZHQpOwogICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5wcmVtdWx0aXBseShxKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgIGlmIChzcGVlZCA+IDAuMSkgewogICAgICAgICAgICBfdGVtcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLmNyb3NzKF9heGlzWSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGlmIChfdGVtcFZlYy5sZW5ndGhTcSgpID4gMC4wMSkgewogICAgICAgICAgICAgICAgY29uc3QgcSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShfdGVtcFZlYywgc3BlZWQgKiBkdCk7CiAgICAgICAgICAgICAgICB0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24ucHJlbXVsdGlwbHkocSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCmdyYWIocGxheWVyKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50OiBQb3NzZXNzaW9uIChpZiB0YWtpbmcgZnJvbSBmcmVlIHN0YXRlKQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCgiUE9TU0VTU0lPTiIsICJub3JtYWwiKTsKICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIFR1cm5vdmVyIChQb3NzZXNzaW9uIENoYW5nZSkKICAgICAgICAgICAgY29uc3QgcHJldmlvdXNUZWFtID0gdGhpcy5ob2xkZXIgPyB0aGlzLmhvbGRlci50ZWFtIDogKHRoaXMubGFzdEhvbGRlciA/IHRoaXMubGFzdEhvbGRlci50ZWFtIDogbnVsbCk7CiAgICAgICAgICAgIGlmIChwcmV2aW91c1RlYW0gJiYgcHJldmlvdXNUZWFtICE9PSBwbGF5ZXIudGVhbSkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJUVVJOT1ZFUiIsIHBsYXllci5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgc29tZW9uZSBlbHNlIGhlbGQgaXQsIHRoZXkgbG9zZSBpdAogICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIgIT09IHBsYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIubG9zZUJhbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBwbGF5ZXI7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaGVsZCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOT1RFOiBXZSBkbyBOT1QgcGFyZW50IHRoZSBtZXNoIHRvIHRoZSBwbGF5ZXIgYW55bW9yZS4KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyB0aGUgYmFsbCBmcm9tIGZseWluZyBhcm91bmQgZHVlIHRvIHN3aW0gYW5pbWF0aW9ucy4KICAgICAgICAgICAgLy8gSW5zdGVhZCwgd2UgdXBkYXRlIGl0cyBwb3NpdGlvbiBtYW51YWxseSBpbiB1cGRhdGVIZWxkKCkuCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3RpZnkgcGxheWVyCiAgICAgICAgICAgIGlmIChwbGF5ZXIucmVjZWl2ZUJhbGwpIHsKICAgICAgICAgICAgICAgIHBsYXllci5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zb2xlLmxvZygiQmFsbCBncmFiYmVkIGJ5ICIgKyBwbGF5ZXIucm9sZSk7CiAgICAgICAgfQoKICAgICAgICBkcm9wKCkgewogICAgICAgICAgICB0aGlzLnJldmVhbCgpOyAvLyBFbnN1cmUgdmlzaWJsZQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm8gbmVlZCB0byBkZXRhY2ggZnJvbSBzY2VuZSBncmFwaCBzaW5jZSB3ZSBhcmVuJ3QgcGFyZW50aW5nIHRvIHBsYXllciBhbnltb3JlLgogICAgICAgICAgICAvLyBKdXN0IGNsZWFyIGhvbGRlci4KCiAgICAgICAgICAgIGlmICh0aGlzLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmxvc2VCYWxsKSB0aGlzLmhvbGRlci5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIH0KLy8gU2hvb3QvUGFzcwovLyBTaG9vdC9QYXNzCiAgICAgICAgc2hvb3QoZGlyZWN0aW9uVmVjdG9yLCBmb3JjZSwgdHlwZSA9ICdTSCcsIHRlY2huaXF1ZSA9IG51bGwsIHNwaW5WZWN0b3IgPSBudWxsKSB7CgogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSB0aGlzLmhvbGRlcjsgLy8gUmVjb3JkIGZvciBFWFAgYXR0cmlidXRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZ1bWJsZSBEZXRlY3Rpb24gKFR5cGUgJ25vbmUnIGlzIHVzZWQgYnkgUGxheWVyLmZ1bWJsZSkKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdub25lJykgewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KCJGVU1CTEUhIiwgInNsYW0iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5kcm9wKCk7IC8vIERldGFjaCBmaXJzdAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0IEdyYWNlIFBlcmlvZCB0byBwcmV2ZW50IGluc3RhbnQgaW50ZXJjZXB0aW9ucy9jYXRjaGVzCiAgICAgICAgICAgIC8vIDAuMnMgYWxsb3dzIGJhbGwgdG8gY2xlYXIgdGhlIHRocm93ZXIncyBpbW1lZGlhdGUgdmljaW5pdHkKICAgICAgICAgICAgdGhpcy5jYXRjaEdyYWNlUGVyaW9kID0gMC4yOwoKICAgICAgICAgICAgLy8gUGh5c2ljYWwgVmVsb2NpdHkgKFZpc3VhbCBzcGVlZCkKICAgICAgICAgICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcgfHwge307CiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKEMuTEFVTkNIX1NQRUVEX1NDQUxFICE9PSB1bmRlZmluZWQgPyBDLkxBVU5DSF9TUEVFRF9TQ0FMRSA6IDEuMCk7CiAgICAgICAgICAgIGNvbnN0IGNhcCA9IChDLkxBVU5DSF9TUEVFRF9DQVAgIT09IHVuZGVmaW5lZCA/IEMuTEFVTkNIX1NQRUVEX0NBUCA6IDg1LjApOwogICAgICAgICAgICBjb25zdCBzcGVlZCA9IE1hdGgubWluKGZvcmNlICogc2NhbGUsIGNhcCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuY29weShkaXJlY3Rpb25WZWN0b3IpLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKHNwZWVkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IFNwaW4gaWYgcHJvdmlkZWQKICAgICAgICAgICAgaWYgKHNwaW5WZWN0b3IpIHsKICAgICAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LmNvcHkoc3BpblZlY3Rvcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN0YXQgUG93ZXIgKEdhbWUgTG9naWMpCiAgICAgICAgICAgIHRoaXMucG93ZXIgPSBmb3JjZTsKICAgICAgICAgICAgdGhpcy5wb3dlclR5cGUgPSB0eXBlOwogICAgICAgICAgICB0aGlzLnRlY2huaXF1ZSA9IHRlY2huaXF1ZTsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVHJhaWwgQ29sb3IKICAgICAgICAgICAgaWYgKHRoaXMudHJhaWwpIHsKICAgICAgICAgICAgICAgIGxldCBjb2xvciA9IDB4MDBhYWZmOyAvLyBEZWZhdWx0IEJsdWUgKFBhc3MpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZWNobmlxdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICd2ZW5vbScpIGNvbG9yID0gMHgwMGZmMDA7IC8vIEdyZWVuIChWZW5vbSkKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ3dpdGhlcicpIGNvbG9yID0gMHg4ODg4ODg7IC8vIEdyZXkKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ25hcCcpIGNvbG9yID0gMHgwMDAwODg7IC8vIERhcmsgQmx1ZQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnc3BoZXJlJykgY29sb3IgPSAweDAwZmZmZjsgLy8gQ3lhbgogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnamVjaHQnKSBjb2xvciA9IDB4ZmYwMDAwOyAvLyBSZWQKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIGNvbG9yID0gMHg0NDQ0NDQ7IC8vIERhcmsgR3JleQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgPSAweGZmNDQwMDsgLy8gT3JhbmdlL1JlZAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLnRyYWlsLnNldENvbG9yKGNvbG9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGFuZGxlIEludmlzaWJsZSBTaG90CiAgICAgICAgICAgIGlmICh0ZWNobmlxdWUgJiYgdGVjaG5pcXVlLnR5cGUgPT09ICdpbnZpc2libGUnKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzSW52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBGWDogUG9vZgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignd2l0aGVyJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAyLjAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiSW52aXNpYmxlIFNob3QhIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCYWxsICR7dHlwZX0gd2l0aCBQb3dlcjogJHt0aGlzLnBvd2VyLnRvRml4ZWQoMSl9IFNwaW46ICR7dGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkudG9GaXhlZCgxKX1gKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjayBmb3IgQ3VydmUKICAgICAgICAgICAgaWYgKHRoaXMuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aCgpID4gMTUuMCAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQ1VSVkUhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXZlYWwoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzSW52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICAvLyBGWDogUmV2ZWFsIFBvb2YKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlciAmJiB0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCd3aXRoZXInLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlzSW52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICB9CgovLyBEdXBsaWNhdGUgcmV2ZWFsIHJlbW92ZWQKICAgICAgICAKcmVzZXQoKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7CiAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwOwogICAgICAgICAgICB0aGlzLnBvd2VyID0gMDsKICAgICAgICB9CmlzQ2F0Y2hhYmxlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jYXRjaEdyYWNlUGVyaW9kIDw9IDA7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWxzKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5kZWZvcm1Ob2RlIHx8ICF0aGlzLnNwaW5Ob2RlKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBTcXVhc2ggJiBTdHJldGNoIGJhc2VkIG9uIHZlbG9jaXR5Ci8vIDEuIFNxdWFzaCAmIFN0cmV0Y2ggYmFzZWQgb24gdmVsb2NpdHkKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT25seSBhcHBseSBzdHJldGNoIGlmIG1vdmluZyBmYXN0IGVub3VnaAogICAgICAgICAgICBpZiAoc3BlZWQgPiAxLjAgJiYgdGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAvLyBPcmllbnQgZGVmb3JtTm9kZSB0byB2ZWxvY2l0eSBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgZm9yd2FyZCBpcyBaICgwLDAsMSkKICAgICAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLnNldEZyb21Vbml0VmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLDAsMSksIGRpcik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBzdHJldGNoIGZhY3RvcgogICAgICAgICAgICAgICAgLy8gTWF4IHN0cmV0Y2ggYXQgc3BlZWQgNDAgKGFwcHJveCBtYXggc2hvdCBwb3dlcikKICAgICAgICAgICAgICAgIGNvbnN0IGZhY3RvciA9IE1hdGgubWluKHNwZWVkIC8gNDAuMCwgMS4wKTsgCiAgICAgICAgICAgICAgICBjb25zdCBzdHJldGNoID0gMS4wICsgKGZhY3RvciAqIDAuOCk7IC8vIEluY3JlYXNlZCBzdHJldGNoIG1heCB0byAxLjh4CiAgICAgICAgICAgICAgICBjb25zdCBzcXVhc2ggPSAxLjAgLyBNYXRoLnNxcnQoc3RyZXRjaCk7IC8vIE1haW50YWluIHZvbHVtZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUuc2NhbGUuc2V0KHNxdWFzaCwgc3F1YXNoLCBzdHJldGNoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFJlc2V0IGRlZm9ybWF0aW9uCiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUucXVhdGVybmlvbi5pZGVudGl0eSgpOwogICAgICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnNjYWxlLnNldCgxLCAxLCAxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gQXBwbHkgQWNjdW11bGF0ZWQgU3BpbgogICAgICAgICAgICAvLyBTaW5jZSBkZWZvcm1Ob2RlIG1pZ2h0IGJlIHJvdGF0ZWQsIHdlIG5lZWQgdG8gYXBwbHkgc3BpbiBpbiB0aGUgY29ycmVjdCBzcGFjZS4KICAgICAgICAgICAgLy8gc3Bpbk5vZGUgcm90YXRpb24gPSBkZWZvcm1Ob2RlX2ludmVyc2UgKiBhY2N1bXVsYXRlZFJvdGF0aW9uCmNvbnN0IGludkRlZm9ybSA9IHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLmNsb25lKCkuaW52ZXJ0KCk7CiAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucXVhdGVybmlvbi5jb3B5KGludkRlZm9ybS5tdWx0aXBseSh0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24pKTsKICAgICAgICB9CiAgICB9Cgp3aW5kb3cuZmx1eC5CYWxsID0gQmFsbDsKICAgIHdpbmRvdy5mbHV4LlRyYWlsUmVuZGVyZXIgPSBUcmFpbFJlbmRlcmVyOwp9KSgpOw==","./Ball.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIHZlY3RvcnMgdG8gYXZvaWQgR0MKY29uc3QgX2JWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2JEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2F4aXNZID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CiAgICBjb25zdCBfdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbWFnbnVzVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCi8vIFBoeXNpY3MgQ29uZmlndXJhdGlvbiAoRXhwb3NlZCBmb3IgRGV2VG9vbHMpCndpbmRvdy5mbHV4LkJhbGxDb25maWcgPSB7CiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBDb3JlIGludGVncmF0aW9uCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBTVUJTVEVQUzogMiwgICAgICAgICAgICAgICAgLy8gUGh5c2ljcyBzdWJzdGVwcyBwZXIgZnJhbWUgKHN0YWJpbGl0eSBhdCBoaWdoIHNwZWVkcykKICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLCAgICAgICAgICAgLy8gQmVsb3cgdGhpcyBzcGVlZCwgc25hcCB0byByZXN0IChwcmV2ZW50cyBlbmRsZXNzIGRyaWZ0KQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFdhdGVyIHJlc2lzdGFuY2UgKHBoeXNpY2FsIHZlbG9jaXR5IGRyYWcsIE5PVCBzdGF0IGRlY2F5KQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMTUsICAgIC8vIExpbmVhciBkcmFnIHRlcm0gKHJvdWdobHkgeW91ciBwcmV2aW91cyBXQVRFUl9EUkFHKQogICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDIsICAgICAvLyBRdWFkcmF0aWMgZHJhZyAoc3Ryb25nZXIgYXQgaGlnaCBzcGVlZCwgaGVscHMgdGFtZSByb2NrZXRzKQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFNwaW4gJiBjdXJ2ZQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgU1BJTl9EUkFHOiAwLjQwLCAgICAgICAgICAgIC8vIFNwaW4gZGVjYXkgcGVyIHNlY29uZAogICAgICAgIE1BR05VU19FTkFCTEVEOiB0cnVlLAogICAgICAgIE1BR05VU19DT0VGRjogMC4wOCwgICAgICAgICAvLyBMaWZ0IHN0cmVuZ3RoCiAgICAgICAgTUFHTlVTX0NBUDogNjAuMCwgICAgICAgICAgIC8vIE1heCBtYWdudXMgZGVsdGEtViBwZXIgc3Vic3RlcCAocHJldmVudHMgZXhwbG9zaW9ucykKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBEZXB0aCBjb25zdHJhaW50IChrZWVwcyBiYWxsIG5lYXIgcGxheSBwbGFuZSB3aXRob3V0IGZlZWxpbmcgbGlrZSBhIGhhcmQgZmxvb3IpCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBERVBUSF9UQVJHRVRfWTogMC4wLAogICAgICAgIERFUFRIX1NQUklORzogMS4wLCAgICAgICAgICAvLyBZb3VyIHByZXZpb3VzIEdSQVZJVFlfU1BSSU5HCiAgICAgICAgREVQVEhfREFNUDogMS41LCAgICAgICAgICAgIC8vIFlvdXIgcHJldmlvdXMgR1JBVklUWV9EQU1QCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gQXJlbmEgYm91bmRhcnkgKHNvZnQgd2FsbCArIGNsYW1wKQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCkJPVU5EQVJZX1JBRElVUzogNDYuMCwKICAgICAgICBCT1VOREFSWV9IRUlHSFQ6IDIwLjAsCiAgICAgICAgR09BTF9QT0NLRVRfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBHT0FMX1BPQ0tFVF9YOiAxMi4wLCAgICAgICAgLy8gSGFsZi13aWR0aCBvZiBnb2FsIHBvY2tldCBjb3JyaWRvcgogICAgICAgIEdPQUxfUE9DS0VUX1o6IDQwLjAsICAgICAgICAvLyBTdGFydCBvZiBnb2FsIHBvY2tldCBjb3JyaWRvciAoYWJzIHopIC0gUHVzaGVkIGJhY2sKICAgICAgICBHT0FMX1BPQ0tFVF9SQURJVVM6IDU1LjAsICAgLy8gRWZmZWN0aXZlIHJhZGl1cyB3aGVuIGluIGdvYWwgcG9ja2V0CiAgICAgICAgV0FMTF9TT0ZUX0JVRkZFUjogMy4wLCAgICAgIC8vIERpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMKICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDIwLjAsICAgICAgLy8gU29mdCByZXB1bHNpb24gc3RyZW5ndGgKICAgICAgICBXQUxMX0VMQVNUSUNJVFk6IDAuMzAsICAgICAgLy8gQm91bmNlIGRhbXBlbmluZyBvbiBjbGFtcAogICAgICAgIFdBTExfRlJJQ1RJT046IDAuOTUsICAgICAgICAvLyBUYW5nZW50aWFsIGRhbXBpbmcgb24gd2FsbCBjb250YWN0CgogICAgICAgIEZMT09SX0VMQVNUSUNJVFk6IDAuNDAsICAgICAvLyBCb3VuY2UgZGFtcGVuaW5nIG9uIGNlaWxpbmcvZmxvb3IgY2xhbXAKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBUaHJvdyBtYXBwaW5nIChzdGF0IGZvcmNlIC0+IHBoeXNpY2FsIGxhdW5jaCBzcGVlZCkKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIExBVU5DSF9TUEVFRF9TQ0FMRTogMS4wLCAgICAvLyBNdWx0aXBsaWVzIGZvcmNlIHdoZW4gY29udmVydGluZyB0byB2ZWxvY2l0eQogICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDg1LjAgICAgICAvLyBQaHlzaWNhbCBzcGVlZCBjYXAgKHdhcyBoYXJkY29kZWQgaW4gQmFsbC5zaG9vdCkKICAgIH07CgoKICAgIAogICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWc7IC8vIExvY2FsIGFsaWFzIGZvciBicmV2aXR5CiAgICAvLyAtLS0gVFJBSUwgUkVOREVSRVIgLS0tCi8vIC0tLSBUUkFJTCBSRU5ERVJFUiAtLS0KICAgIGNsYXNzIFRyYWlsUmVuZGVyZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5zZWdtZW50cyA9IDMwOyAvLyBNb3JlIHNlZ21lbnRzIGZvciBzbW9vdGhlciBjdXJ2ZXMKICAgICAgICAgICAgdGhpcy5wb2ludHMgPSBbXTsKdGhpcy5iYXNlV2lkdGggPSAwLjg7IC8vIEluY3JlYXNlZCB3aWR0aCBmb3IgdmlzaWJpbGl0eQogICAgICAgICAgICB0aGlzLmN1cnJlbnRXaWR0aCA9IDAuODsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJ5CiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgICAgIGNvbnN0IHBvc0RhdGEgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuc2VnbWVudHMgKiAyICogMyk7CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHBvc0RhdGEsIDMpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluZGljZXMKICAgICAgICAgICAgY29uc3QgaW5kaWNlcyA9IFtdOwogICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50cy0xOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhc2UgPSBpKjI7CiAgICAgICAgICAgICAgICBpbmRpY2VzLnB1c2goYmFzZSwgYmFzZSsxLCBiYXNlKzIpOwogICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGJhc2UrMSwgYmFzZSszLCBiYXNlKzIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEluZGV4KGluZGljZXMpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBjb2xvcjogMHgwMGFhZmYsCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLjksIC8vIEluY3JlYXNlZCBvcGFjaXR5CiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLm1lc2gpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW5pdCBwb2ludHMKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB0aGlzLnBvaW50cy5wdXNoKG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUmV1c2FibGUgdGVtcHMgKGF2b2lkIHBlci1mcmFtZSBhbGxvY2F0aW9ucyBvbiBtb2JpbGUpCiAgICAgICAgICAgIHRoaXMuX3RtcERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuX3RtcFRvQ2FtID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5fdG1wUmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXNldChwb3MpIHsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB0aGlzLnBvaW50c1tpXS5jb3B5KHBvcyk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlR2VvbWV0cnkoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgc2V0Q29sb3IoaGV4KSB7CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KGhleCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZShjdXJyZW50UG9zLCBzcGVlZFJhdGlvID0gMC4wKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXQoY3VycmVudFBvcyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCi8vIER5bmFtaWMgV2lkdGggYmFzZWQgb24gc3BlZWQgQU5EIFNQSU4gKFBvd2VyIFZpc3VhbCkKICAgICAgICAgICAgLy8gRmFzdCBiYWxsID0gVGhpY2tlci4gU3Bpbm5pbmcgYmFsbCA9IEV2ZW4gVGhpY2tlci4KICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgY29uc3Qgc3BpblJhdGlvID0gYmFsbCA/IE1hdGgubWluKDEuMCwgYmFsbC5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkgLyAzMC4wKSA6IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB0YXJnZXRXaWR0aCA9IHRoaXMuYmFzZVdpZHRoICogKDAuOCArIHNwZWVkUmF0aW8gKiAxLjIgKyBzcGluUmF0aW8gKiAyLjApOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRXaWR0aCArPSAodGFyZ2V0V2lkdGggLSB0aGlzLmN1cnJlbnRXaWR0aCkgKiAwLjI7IC8vIFNtb290aCB0cmFuc2l0aW9uCgogICAgICAgICAgICAvLyBTaGlmdCBwb2ludHMKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuc2VnbWVudHMgLSAxOyBpID4gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBvaW50c1tpXS5jb3B5KHRoaXMucG9pbnRzW2ktMV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucG9pbnRzWzBdLmNvcHkoY3VycmVudFBvcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVwZGF0ZUdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZUdlb21ldHJ5KCkgewogICAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5hcnJheTsKICAgICAgICAgICAgY29uc3QgY2FtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSA6IG51bGw7CiAgICAgICAgICAgIGlmICghY2FtKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IGNhbS5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgdGVtcERpciA9IHRoaXMuX3RtcERpcjsKICAgICAgICAgICAgY29uc3QgdGVtcFRvQ2FtID0gdGhpcy5fdG1wVG9DYW07CiAgICAgICAgICAgIGNvbnN0IHRlbXBSaWdodCA9IHRoaXMuX3RtcFJpZ2h0OwogICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5wb2ludHNbaV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRhcGVyIHdpZHRoIGFsb25nIHRyYWlsIGxlbmd0aAogICAgICAgICAgICAgICAgY29uc3QgdGFwZXIgPSAxLjAgLSBNYXRoLnBvdyhpIC8gdGhpcy5zZWdtZW50cywgMik7IC8vIFF1YWRyYXRpYyB0YXBlcgogICAgICAgICAgICAgICAgY29uc3QgdyA9IHRoaXMuY3VycmVudFdpZHRoICogdGFwZXI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIGlmIChpIDwgdGhpcy5zZWdtZW50cyAtIDEpIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wRGlyLnN1YlZlY3RvcnModGhpcy5wb2ludHNbaV0sIHRoaXMucG9pbnRzW2krMV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wRGlyLnN1YlZlY3RvcnModGhpcy5wb2ludHNbaS0xXSwgdGhpcy5wb2ludHNbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGVtcERpci5sZW5ndGhTcSgpIDwgMC4wMDAxKSB0ZW1wRGlyLnNldCgwLCAxLCAwKTsKICAgICAgICAgICAgICAgIHRlbXBEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRlbXBUb0NhbS5zdWJWZWN0b3JzKGNhbVBvcywgcCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0ZW1wUmlnaHQuY3Jvc3NWZWN0b3JzKHRlbXBEaXIsIHRlbXBUb0NhbSkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIodyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZlcnQgMQogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDBdID0gcC54IC0gdGVtcFJpZ2h0Lng7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgMV0gPSBwLnkgLSB0ZW1wUmlnaHQueTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAyXSA9IHAueiAtIHRlbXBSaWdodC56OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZXJ0IDIKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAzXSA9IHAueCArIHRlbXBSaWdodC54OwogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDRdID0gcC55ICsgdGVtcFJpZ2h0Lnk7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgNV0gPSBwLnogKyB0ZW1wUmlnaHQuejsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgfQogICAgfQpjbGFzcyBCYWxsIHsKCiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7IAogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSBudWxsOyAvLyBUcmFjayB3aG8gdGhyZXcgaXQgbGFzdCAoZm9yIEVYUC9Bc3Npc3RzKQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOyAvLyAnZnJlZScsICdoZWxkJywgJ21hZ25ldGl6ZWQnCiAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIENvbnRpbnVvdXMgU3RhdHMKICAgICAgICAgICAgdGhpcy5wb3dlciA9IDA7ICAgICAgLy8gQ3VycmVudCBQQSBvciBTSCB2YWx1ZQogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9ICdub25lJzsgLy8gJ1BBJyBvciAnU0gnCiAgICAgICAgICAgIHRoaXMuZGVjYXlSYXRlID0gMy4wOyAvLyBTdGF0IHBvaW50cyBsb3N0IHBlciBzZWNvbmQgKFdhdGVyIHJlc2lzdGFuY2UpCiAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7IC8vIFRpbWUgYmVmb3JlIGJhbGwgY2FuIGJlIGNhdWdodCBhZ2FpbgoKICAgICAgICAgICAgLy8gTWFnbmV0IFN5c3RlbQogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1hZ25ldER1cmF0aW9uID0gMC4yOyAKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gVmlzdWFscyAoU3F1YXNoICYgU3RyZXRjaCkKICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zcGluTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubW9kZWwgPSBudWxsOwoKdGhpcy5pbml0TWVzaCgpOwogICAgICAgICAgICB0aGlzLnRyYWlsID0gbmV3IFRyYWlsUmVuZGVyZXIoc2NlbmUpOwogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDA7Cn0KaW5pdE1lc2goKSB7CiAgICAgICAgICAgIC8vIEhpZXJhcmNoeTogTWVzaCAoUG9zKSAtPiBEZWZvcm0gKFNxdWFzaC9TdHJldGNoKSAtPiBTcGluIChSb3RhdGlvbikgLT4gTW9kZWwKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7Cgp0aGlzLmRlZm9ybU5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnkgPSAwLjA7IC8vIFJlc2V0IG9mZnNldCBzbyBiYWxsIGlzIGNlbnRlcmVkIG9uIG1lc2ggcG9zaXRpb24KICAgICAgICAgICAgdGhpcy5tZXNoLmFkZCh0aGlzLmRlZm9ybU5vZGUpOyAvLyBGaXg6IEFkZCBkZWZvcm1Ob2RlIHRvIG1lc2gKCiAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLmFkZCh0aGlzLnNwaW5Ob2RlKTsKCiAgICAgICAgICAgIC8vIFByb2NlZHVyYWwgUGxhY2Vob2xkZXIgVGV4dHVyZSAoQmxpdHpiYWxsLWlzaCkKICAgICAgICAgICAgY29uc3QgcGxhY2Vob2xkZXJUZXggPSAoKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAgICAgYy53aWR0aCA9IDEyODsgYy5oZWlnaHQgPSA2NDsKICAgICAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2VlZWVlZSc7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwwLDEyOCw2NCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEJsdWUgYnVtcHMvZGV0YWlscwogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDA4OGZmJzsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDY7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBjdHguYXJjKGkqMjUsIDMyLCAxMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDA0NDg4JzsKICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAyOCwgMTI4LCA4KTsgLy8gU3RyaXBlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICAgICAgfSkoKTsKCiAgICAgICAgICAgIC8vIFBsYWNlaG9sZGVyIFZpc3VhbCAoSW1tZWRpYXRlIGZlZWRiYWNrLCBwZXJzaXN0cyB1bnRpbCB2YWxpZCBtb2RlbCBsb2FkcykKLy8gUGxhY2Vob2xkZXIgVmlzdWFsIChJbW1lZGlhdGUgZmVlZGJhY2ssIHBlcnNpc3RzIHVudGlsIHZhbGlkIG1vZGVsIGxvYWRzKQovLyBQbGFjZWhvbGRlciBWaXN1YWwgKEltbWVkaWF0ZSBmZWVkYmFjaywgcGVyc2lzdHMgdW50aWwgdmFsaWQgbW9kZWwgbG9hZHMpCmNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDAuMywgMTYsIDE2KTsgLy8gU2NhbGVkIGRvd24gfjE1JQogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBtYXA6IHBsYWNlaG9sZGVyVGV4LAogICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAKICAgICAgICAgICAgICAgIHdpcmVmcmFtZTogZmFsc2UsIC8vIFNvbGlkCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAxLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwoKICAgICAgICAgICAgLy8gTG9hZCBHTEIgTW9kZWwKICAgICAgICAgICAgY29uc3QgdXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy81MjFhZTg3ODhlNTg0ZTM3OGE3OWQ5NzMyYTA3NTM1Ni5nbGInOwogICAgICAgICAgICAKICAgICAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKHVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJERUJVRzogQmFsbCBHTEIgbG9hZGVkLiIsIGdsdGYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBtb2RlbCA9IGdsdGYuc2NlbmU7CgogICAgICAgICAgICAgICAgLy8gMS4gUmVzZXQgcm9vdCB0cmFuc2Zvcm1zCiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBtb2RlbC5yb3RhdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBtb2RlbC5zY2FsZS5zZXQoMSwgMSwgMSk7CiAgICAgICAgICAgICAgICBtb2RlbC51cGRhdGVNYXRyaXhXb3JsZCh0cnVlKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBIYXJkZW4gTWF0ZXJpYWxzICYgVmlzaWJpbGl0eQogICAgICAgICAgICAgICAgbW9kZWwudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5jYXN0U2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVjZWl2ZVNoYWRvdyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsgLy8gQ1JJVElDQUw6IFByZXZlbnQgY3VsbGluZyBpZiBib3VuZHMgYXJlIG9mZgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hdHMgPSBBcnJheS5pc0FycmF5KG5vZGUubWF0ZXJpYWwpID8gbm9kZS5tYXRlcmlhbCA6IFtub2RlLm1hdGVyaWFsXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdHMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLmNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIEZvcmNlIHdoaXRlIGJhc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnNpZGUgPSBUSFJFRS5Eb3VibGVTaWRlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5hbHBoYVRlc3QgPSAwOyAvLyBDUklUSUNBTDogRGlzYWJsZSBhbHBoYSB0ZXN0IHRvIHByZXZlbnQgY3VsbGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5kZXB0aFRlc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyAzLiBDb21wdXRlIEJvdW5kaW5nIEJveAogICAgICAgICAgICAgICAgY29uc3QgYm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KG1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNpemUgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgYm94LmdldFNpemUoc2l6ZSk7CiAgICAgICAgICAgICAgICBjb25zdCBjZW50ZXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgYm94LmdldENlbnRlcihjZW50ZXIpOwoKICAgICAgICAgICAgICAgIC8vIDQuIFZhbGlkYXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IG1heERpbSA9IE1hdGgubWF4KHNpemUueCwgc2l6ZS55LCBzaXplLnopOwogICAgICAgICAgICAgICAgaWYgKG1heERpbSA8PSAwLjAwMSB8fCAhaXNGaW5pdGUobWF4RGltKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBtb2RlbCBoYXMgaW52YWxpZCBkaW1lbnNpb25zLiBLZWVwaW5nIHBsYWNlaG9sZGVyLiIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gNS4gQ2FsY3VsYXRlIFNjYWxlCi8vIDUuIENhbGN1bGF0ZSBTY2FsZQpjb25zdCB0YXJnZXREaWFtZXRlciA9IDAuNzI7IC8vIFJlZHVjZWQgc2NhbGUgYnkgfjE1JSAod2FzIDAuODUpCiAgICAgICAgICAgICAgICBjb25zdCBzY2FsZUZhY3RvciA9IHRhcmdldERpYW1ldGVyIC8gbWF4RGltOwoKICAgICAgICAgICAgICAgIC8vIDYuIEFwcGx5IFRyYW5zZm9ybXMKICAgICAgICAgICAgICAgIG1vZGVsLnNjYWxlLnNldFNjYWxhcihzY2FsZUZhY3Rvcik7CiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5jb3B5KGNlbnRlcikubXVsdGlwbHlTY2FsYXIoLXNjYWxlRmFjdG9yKTsKCiAgICAgICAgICAgICAgICAvLyA3LiBTd2FwIFBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucmVtb3ZlKHRoaXMucGxhY2Vob2xkZXIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5KSB0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsID0gbW9kZWw7CiAgICAgICAgICAgICAgICB0aGlzLnNwaW5Ob2RlLmFkZCh0aGlzLm1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCbGl0emJhbGwgbW9kZWwgYXR0YWNoZWQuIFNjYWxlOiAke3NjYWxlRmFjdG9yLnRvRml4ZWQoNCl9YCk7CgogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBsb2FkIEJsaXR6YmFsbCBtb2RlbDoiLCBlcnIpOwogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2s6IEtlZXAgcGxhY2Vob2xkZXIgYnV0IHRpbnQgaXQgcmVkIHRvIGluZGljYXRlIGVycm9yCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZhYWFhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyBCYWxsIExhYiByZXBsYXkgb3ZlcnJpZGUgKGxldHMgRGV2VG9vbHMgZHJpdmUgdGhlIGJhbGwgZGV0ZXJtaW5pc3RpY2FsbHkpCiAgICAgICAgICAgIGNvbnN0IF9fbGFiID0gd2luZG93LmZsdXggJiYgd2luZG93LmZsdXguYmFsbExhYjsKICAgICAgICAgICAgaWYgKF9fbGFiICYmIF9fbGFiLmlzUmVwbGF5aW5nICYmIF9fbGFiLnRhcmdldEJhbGwgPT09IHRoaXMgJiYgdHlwZW9mIF9fbGFiLmFwcGx5UmVwbGF5RnJhbWUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIF9fbGFiLmFwcGx5UmVwbGF5RnJhbWUodGhpcywgZHQpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMudHJhaWwpIHRoaXMudHJhaWwuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTYWZldHk6IFJlc2V0IGlmIHBvc2l0aW9uIGNvcnJ1cHRlZAogICAgICAgICAgICBpZiAoaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLngpIHx8IGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi55KSB8fCBpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueikpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXQoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKLy8gU2FmZXR5OiBGaXggIlVucGlja2FibGUgQmFsbCIgQnVnCiAgICAgICAgICAgIC8vIDEuIEludmFsaWQgQWN0b3IgQ2hlY2sKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdoZWxkJyAmJiAoIXRoaXMuaG9sZGVyIHx8ICF0aGlzLmhvbGRlci5tZXNoKSkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdtYWduZXRpemVkJykgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLm1hZ25ldFRhcmdldCB8fCAhdGhpcy5tYWduZXRUYXJnZXQubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gMi4gTWFnbmV0aXplIFRpbWVvdXQgKFByZXZlbnQgZ2V0dGluZyBzdHVjayBpbiBtaWQtYWlyKQogICAgICAgICAgICAgICAgaWYgKHRoaXMubWFnbmV0VGltZXIgPiAyLjApIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkJhbGwgc3R1Y2sgaW4gbWFnbmV0aXplZCBzdGF0ZS4gRHJvcHBpbmcuIik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIFN0YXRlIENvbnNpc3RlbmN5CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnZnJlZScgJiYgdGhpcy5ob2xkZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaG9sZGVyID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRmFpbHNhZmU6IElmIGJhbGwgaXMgZnJlZSBhbmQgc2xvdywgZW5zdXJlIGl0J3MgY2F0Y2hhYmxlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnZnJlZScgJiYgdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMC41KSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwOwogICAgICAgICAgICB9CmlmICh0aGlzLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAvLyBUcmFpbCBpcyBhY3RpdmUgaWYgYmFsbCBpcyBtb3ZpbmcgZmFzdCBhbmQgZnJlZQogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgdGhpcy50cmFpbC5hY3RpdmUgPSAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHNwZWVkID4gMi4wKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRml4OiBPZmZzZXQgdHJhaWwgdG8gbWF0Y2ggdmlzdWFsIG1vZGVsIHBvc2l0aW9uIChkZWZvcm1Ob2RlIG9mZnNldCkKICAgICAgICAgICAgICAgIF9iVmVjLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlZm9ybU5vZGUpIF9iVmVjLnkgKz0gdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnk7CgogICAgICAgICAgICAgICAgLy8gUGFzcyBzcGVlZCByYXRpbyAoMCB0byAxIGJhc2VkIG9uIG1heCBzcGVlZCBhcHByb3ggNjApCiAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHNwZWVkIC8gNjAuMCwgMS4wKTsKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwudXBkYXRlKF9iVmVjLCByYXRpbyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaGVsZCcgJiYgdGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVIZWxkKGR0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTWFnbmV0aXplZChkdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUZyZWUoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAppZiAodGhpcy5jYXRjaEdyYWNlUGVyaW9kID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5jYXRjaEdyYWNlUGVyaW9kIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA8IDApIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7CiAgICAgICAgICAgIH0KCnRoaXMudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTYWZldHk6IEVuc3VyZSB2aXNpYmlsaXR5IGlmIG5vdCBleHBsaWNpdGx5IGludmlzaWJsZQovLyBTYWZldHk6IEVuc3VyZSB2aXNpYmlsaXR5IGlmIG5vdCBleHBsaWNpdGx5IGludmlzaWJsZQogICAgICAgICAgICBpZiAodGhpcy5tZXNoICYmICF0aGlzLmlzSW52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBGb3JjZSBtb2RlbCB2aXNpYmlsaXR5IGlmIHByZXNlbnQgKHNvbWV0aW1lcyBHTFRGIGxvYWRlciBoaWRlcyBpdCkKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1vZGVsKSB0aGlzLm1vZGVsLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKbWFnbmV0aXplKHRhcmdldCkgewogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ21hZ25ldGl6ZWQnIHx8IHRoaXMuc3RhdGUgPT09ICdoZWxkJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtYWduZXRpemVkJzsKICAgICAgICAgICAgdGhpcy5tYWduZXRUYXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICAgIHRoaXMuaG9sZGVyID0gdGFyZ2V0OyAvLyBMb2dpY2FsIHBvc3Nlc3Npb24gc28gQUkgcmVhY3RzCiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1hZ25ldFN0YXJ0UG9zLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFZlbC5jb3B5KHRoaXMudmVsb2NpdHkpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRHluYW1pYyBEdXJhdGlvbiBiYXNlZCBvbiBkaXN0YW5jZSAoU21vb3RoZXIgZm9yIGxvbmcgcmFuZ2UsIHNuYXBweSBmb3IgY2xvc2UpCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIHRoaXMubWFnbmV0RHVyYXRpb24gPSBNYXRoLm1heCgwLjE1LCBNYXRoLm1pbigwLjQsIGRpc3QgLyAxNS4wKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBLaWxsIHBoeXNpY3MKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIE5vdGlmeSBwbGF5ZXIgaW1tZWRpYXRlbHkgc28gdGhleSBzdG9wIGNoYXNpbmcgYW5kIHBsYXkgYW5pbWF0aW9uCiAgICAgICAgICAgIGlmICh0YXJnZXQucmVjZWl2ZUJhbGwpIHsKICAgICAgICAgICAgICAgIHRhcmdldC5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnJldmVhbCgpOwogICAgICAgIH0KCnVwZGF0ZU1hZ25ldGl6ZWQoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1hZ25ldFRhcmdldCB8fCAhdGhpcy5tYWduZXRUYXJnZXQubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgKz0gZHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3JtYWxpemVkIFRpbWUKICAgICAgICAgICAgbGV0IHQgPSB0aGlzLm1hZ25ldFRpbWVyIC8gdGhpcy5tYWduZXREdXJhdGlvbjsKICAgICAgICAgICAgaWYgKHQgPiAxLjApIHQgPSAxLjA7CgogICAgICAgICAgICAvLyBUYXJnZXQgIlZpcnR1YWwgSGFuZCIgUG9zaXRpb24gKEZyb250IG9mIENoZXN0KQogICAgICAgICAgICBjb25zdCBob2xkZXJQb3MgPSB0aGlzLm1hZ25ldFRhcmdldC5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBob2xkZXJRdWF0ID0gdGhpcy5tYWduZXRUYXJnZXQubWVzaC5xdWF0ZXJuaW9uOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT2Zmc2V0OiBGb3J3YXJkIDAuNiwgVXAgMS4wIChDaGVzdCBoZWlnaHQpCiAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IF9iVmVjLnNldCgwLCAxLjAsIDAuNikuYXBwbHlRdWF0ZXJuaW9uKGhvbGRlclF1YXQpOwogICAgICAgICAgICBjb25zdCB0YXJnZXRQb3MgPSBvZmZzZXQuYWRkKGhvbGRlclBvcyk7CgogICAgICAgICAgICAvLyAtLS0gUVVBRFJBVElDIEJFWklFUiBDVVJWRSAtLS0KICAgICAgICAgICAgLy8gUDAgPSBTdGFydCwgUDIgPSBUYXJnZXQKICAgICAgICAgICAgLy8gUDEgPSBDb250cm9sIFBvaW50IChQcm9qZWN0ZWQgYWxvbmcgaW5pdGlhbCB2ZWxvY2l0eSB0byBwcmVzZXJ2ZSBtb21lbnR1bSBmZWVsKQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcDAgPSB0aGlzLm1hZ25ldFN0YXJ0UG9zOwogICAgICAgICAgICBjb25zdCBwMiA9IHRhcmdldFBvczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBQMSAoQ29udHJvbCBQb2ludCkKICAgICAgICAgICAgLy8gUHJvamVjdCBmb3J3YXJkIGZyb20gUDAgYWxvbmcgc3RhcnQgdmVsb2NpdHkgdmVjdG9yCiAgICAgICAgICAgIC8vIERpc3RhbmNlIG9mIHByb2plY3Rpb24gPSA0MCUgb2YgdG90YWwgZGlzdGFuY2UgdG8gdGFyZ2V0CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBwMC5kaXN0YW5jZVRvKHAyKTsKICAgICAgICAgICAgY29uc3QgcDEgPSBfdGVtcFZlYy5jb3B5KHAwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHZlbExlbiA9IHRoaXMubWFnbmV0U3RhcnRWZWwubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHZlbExlbiA+IDEuMCkgewogICAgICAgICAgICAgICAgLy8gVXNlIHZlbG9jaXR5IHRhbmdlbnQKLy8gVXNlIHZlbG9jaXR5IHRhbmdlbnQKICAgICAgICAgICAgICAgIF9iRGlyLmNvcHkodGhpcy5tYWduZXRTdGFydFZlbCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBwMS5hZGQoX2JEaXIubXVsdGlwbHlTY2FsYXIoZGlzdCAqIDAuNCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gTm8gdmVsb2NpdHkgKHN0YXRpb25hcnkgYmFsbCksIGFyYyB1cHdhcmRzIHNsaWdodGx5CiAgICAgICAgICAgICAgICBwMS5sZXJwKHAyLCAwLjUpOwogICAgICAgICAgICAgICAgcDEueSArPSAxLjU7IAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCZXppZXI6IEIodCkgPSAoMS10KV4yICogUDAgKyAyKDEtdCl0ICogUDEgKyB0XjIgKiBQMgogICAgICAgICAgICBjb25zdCBvbmVNaW51c1QgPSAxLjAgLSB0OwogICAgICAgICAgICBjb25zdCB3MCA9IG9uZU1pbnVzVCAqIG9uZU1pbnVzVDsKICAgICAgICAgICAgY29uc3QgdzEgPSAyLjAgKiBvbmVNaW51c1QgKiB0OwogICAgICAgICAgICBjb25zdCB3MiA9IHQgKiB0OwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnggPSAodzAgKiBwMC54KSArICh3MSAqIHAxLngpICsgKHcyICogcDIueCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gKHcwICogcDAueSkgKyAodzEgKiBwMS55KSArICh3MiAqIHAyLnkpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueiA9ICh3MCAqIHAwLnopICsgKHcxICogcDEueikgKyAodzIgKiBwMi56KTsKCiAgICAgICAgICAgIC8vIEZpbmlzaAogICAgICAgICAgICBpZiAodCA+PSAxLjApIHsKICAgICAgICAgICAgICAgIHRoaXMuZ3JhYih0aGlzLm1hZ25ldFRhcmdldCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGVIZWxkKGR0KSB7CiAgICAgICAgICAgIC8vIEFUVEFDSEVEIFNUQVRFIChWaXJ0dWFsIEF0dGFjaG1lbnQpCiAgICAgICAgICAgIGlmICghdGhpcy5ob2xkZXIgfHwgIXRoaXMuaG9sZGVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gMS4gVHJ5IHRvIHVzZSBIYW5kIEJvbmUgaWYgYXZhaWxhYmxlIChSZWFsaXNtKQogICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIuaGFuZEJvbmUpIHsKICAgICAgICAgICAgICAgIC8vIEdldCB3b3JsZCBwb3NpdGlvbiBvZiB0aGUgaGFuZCBib25lCiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlci5oYW5kQm9uZS5nZXRXb3JsZFBvc2l0aW9uKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEFkanVzdCBzbGlnaHRseSB0byBzaXQgSU4gdGhlIGhhbmQgcmF0aGVyIHRoYW4gT04gdGhlIHdyaXN0CiAgICAgICAgICAgICAgICAvLyBXZSBjYW4ndCBlYXNpbHkga25vdyAiZm9yd2FyZCIgZm9yIHRoZSBib25lIHdpdGhvdXQgbW9yZSBpbmZvLCAKICAgICAgICAgICAgICAgIC8vIGJ1dCB1c3VhbGx5IEdMVEYgYm9uZXMgYXJlIG9yaWVudGVkLiBGb3Igbm93LCBleGFjdCBib25lIHBvcyBpcyBiZXR0ZXIgdGhhbiBjaGVzdC4KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIDIuIEZhbGxiYWNrOiBDYWxjdWxhdGUgIkNhcnJ5aW5nIiBQb3NpdGlvbiAoUmlnaHQgSGFuZCBTaWRlKQogICAgICAgICAgICAgICAgLy8gUmVsYXRpdmUgdG8gcGxheWVyOiBVcCAwLjggKFdhaXN0L0NoZXN0KSwgUmlnaHQgMC40LCBGb3J3YXJkIDAuNQogICAgICAgICAgICAgICAgY29uc3QgaG9sZGVyUG9zID0gdGhpcy5ob2xkZXIubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGhvbGRlclF1YXQgPSB0aGlzLmhvbGRlci5tZXNoLnF1YXRlcm5pb247CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJldXNlIF9iVmVjCi8vIFJldXNlIF9iVmVjCiAgICAgICAgICAgICAgICAvLyBPZmZzZXQ6IHg9MC4zNSAoUmlnaHQpLCB5PTEuMyAoQ2hlc3QvSGFuZHMpLCB6PTAuNSAoRm9yd2FyZCkKICAgICAgICAgICAgICAgIF9iVmVjLnNldCgwLjM1LCAxLjMsIDAuNSkuYXBwbHlRdWF0ZXJuaW9uKGhvbGRlclF1YXQpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmNvcHkoaG9sZGVyUG9zKS5hZGQoX2JWZWMpOwogICAgICAgICAgICB9CgovLyBWaXN1YWwgRmxhaXI6IFNwaW4gdGhlIGJhbGwgc2xvd2x5CiAgICAgICAgICAgIGNvbnN0IHJvdFggPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUobmV3IFRIUkVFLlZlY3RvcjMoMSwwLDApLCAyICogZHQpOwogICAgICAgICAgICBjb25zdCByb3RZID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMSwwKSwgNSAqIGR0KTsKICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uLm11bHRpcGx5KHJvdFgpLm11bHRpcGx5KHJvdFkpOwogICAgICAgIH0KCgp1cGRhdGVGcmVlKGR0KSB7CiAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgIGNvbnN0IHN1YnN0ZXBzID0gTWF0aC5tYXgoMSwgTWF0aC5mbG9vcihDLlNVQlNURVBTIHx8IDEpKTsKICAgIGNvbnN0IHN0ZXBEdCA9IGR0IC8gc3Vic3RlcHM7CgogICAgLy8gLS0tIDEpIEludGVncmF0ZSBwaHlzaWNzIGluIHN1YnN0ZXBzIGZvciBzdGFiaWxpdHkgLS0tCiAgICBmb3IgKGxldCBzID0gMDsgcyA8IHN1YnN0ZXBzOyBzKyspIHsKICAgICAgICAvLyBBKSBNYWdudXMgZWZmZWN0IChjdXJ2ZSBmcm9tIHNwaW4pCiAgICAgICAgaWYgKEMuTUFHTlVTX0VOQUJMRUQgJiYgdGhpcy5hbmd1bGFyVmVsb2NpdHkgJiYgdGhpcy52ZWxvY2l0eSkgewogICAgICAgICAgICBjb25zdCBzcGluU3EgPSB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICBjb25zdCB2ZWxTcSA9IHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHNwaW5TcSA+IDAuMjUgJiYgdmVsU3EgPiAwLjI1KSB7CiAgICAgICAgICAgICAgICBfbWFnbnVzVmVjLmNvcHkodGhpcy5hbmd1bGFyVmVsb2NpdHkpLmNyb3NzKHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKChDLk1BR05VU19DT0VGRiB8fCAwKSAqIHN0ZXBEdCk7CgogICAgICAgICAgICAgICAgLy8gQ2FwIHRvIGF2b2lkIG51bWVyaWMgYmxvd3VwcwogICAgICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTUFHTlVTX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5NQUdOVVNfQ0FQIDogNjAuMCk7CiAgICAgICAgICAgICAgICBjb25zdCBtYWdMZW4gPSBfbWFnbnVzVmVjLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgaWYgKG1hZ0xlbiA+IGNhcCkgX21hZ251c1ZlYy5tdWx0aXBseVNjYWxhcihjYXAgLyBtYWdMZW4pOwoKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKF9tYWdudXNWZWMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBCKSBTcGluIGRlY2F5CiAgICAgICAgaWYgKHRoaXMuYW5ndWxhclZlbG9jaXR5KSB7CiAgICAgICAgICAgIGNvbnN0IHNwaW5EcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gKEMuU1BJTl9EUkFHIHx8IDApICogc3RlcER0KTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoc3BpbkRyYWcpOwogICAgICAgIH0KCiAgICAgICAgLy8gQykgRGVwdGggc3ByaW5nIChrZWVwcyBiYWxsIG5lYXIgcGxhbmUpCiAgICAgICAgY29uc3QgdGFyZ2V0WSA9IChDLkRFUFRIX1RBUkdFVF9ZICE9PSB1bmRlZmluZWQgPyBDLkRFUFRIX1RBUkdFVF9ZIDogMC4wKTsKICAgICAgICBjb25zdCB5RXJyID0gKHRoaXMubWVzaC5wb3NpdGlvbi55IC0gdGFyZ2V0WSk7CiAgICAgICAgdGhpcy52ZWxvY2l0eS55IC09IHlFcnIgKiAoQy5ERVBUSF9TUFJJTkcgfHwgMCkgKiBzdGVwRHQ7CiAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IE1hdGgubWF4KDAsIDEuMCAtIChDLkRFUFRIX0RBTVAgfHwgMCkgKiBzdGVwRHQpOwoKICAgICAgICAvLyBEKSBBcHBseSBkcmFnIChsaW5lYXIgKyBxdWFkcmF0aWMpCiAgICAgICAgY29uc3QgdkxlbiA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgaWYgKHZMZW4gPiAwLjAwMDAxKSB7CiAgICAgICAgICAgIGNvbnN0IGxpbiA9IChDLldBVEVSX0RSQUdfTElORUFSICE9PSB1bmRlZmluZWQgPyBDLldBVEVSX0RSQUdfTElORUFSIDogKEMuV0FURVJfRFJBRyB8fCAwKSkgKiBzdGVwRHQ7CiAgICAgICAgICAgIGNvbnN0IHF1YWQgPSAoQy5XQVRFUl9EUkFHX1FVQUQgfHwgMCkgKiB2TGVuICogc3RlcER0OwogICAgICAgICAgICBjb25zdCBkcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gbGluIC0gcXVhZCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoZHJhZyk7CgogICAgICAgICAgICBjb25zdCBzdG9wID0gKEMuU1RPUF9TUEVFRCB8fCAwKTsKICAgICAgICAgICAgaWYgKHN0b3AgPiAwICYmIHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKSA8IHN0b3AgKiBzdG9wKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRSkgTW92ZQogICAgICAgIF90ZW1wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoc3RlcER0KTsKICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF90ZW1wVmVjKTsKCiAgICAgICAgLy8gRikgU3RhdCBwb3dlciBkZWNheSAoZ2FtZSBsb2dpYykKICAgICAgICBpZiAodGhpcy5wb3dlciA+IDApIHsKICAgICAgICAgICAgdGhpcy5wb3dlciAtPSB0aGlzLmRlY2F5UmF0ZSAqIHN0ZXBEdDsKICAgICAgICAgICAgaWYgKHRoaXMucG93ZXIgPCAwKSB0aGlzLnBvd2VyID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIEcpIEJvdW5kYXJ5IGxvZ2ljIChzb2Z0IHdhbGwgKyBjbGFtcCkKICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1lc2gucG9zaXRpb247CiAgICAgICAgY29uc3QgZGlzdFhaID0gTWF0aC5zcXJ0KHBvcy54ICogcG9zLnggKyBwb3MueiAqIHBvcy56KTsKCiAgICAgICAgY29uc3QgYm91bmRhcnlSYWRpdXMgPSAoQy5CT1VOREFSWV9SQURJVVMgIT09IHVuZGVmaW5lZCA/IEMuQk9VTkRBUllfUkFESVVTIDogMzMuMCk7CiAgICAgICAgbGV0IGVmZmVjdGl2ZUJvdW5kYXJ5ID0gYm91bmRhcnlSYWRpdXM7CgogICAgICAgIGlmIChDLkdPQUxfUE9DS0VUX0VOQUJMRUQpIHsKICAgICAgICAgICAgY29uc3QgaW5Hb2FsUG9ja2V0ID0gKE1hdGguYWJzKHBvcy54KSA8IChDLkdPQUxfUE9DS0VUX1ggfHwgMTIuMCkgJiYgTWF0aC5hYnMocG9zLnopID4gKEMuR09BTF9QT0NLRVRfWiB8fCAyNS4wKSk7CiAgICAgICAgICAgIGlmIChpbkdvYWxQb2NrZXQpIGVmZmVjdGl2ZUJvdW5kYXJ5ID0gKEMuR09BTF9QT0NLRVRfUkFESVVTIHx8IDQ1LjApOwogICAgICAgIH0KCiAgICAgICAgY29uc3Qgc29mdEJ1ZmZlciA9IE1hdGgubWF4KDAuMDEsIChDLldBTExfU09GVF9CVUZGRVIgIT09IHVuZGVmaW5lZCA/IEMuV0FMTF9TT0ZUX0JVRkZFUiA6IDMuMCkpOwoKICAgICAgICAvLyBTb2Z0IHJlcHVsc2lvbiAoY3VydmVzIHRyYWplY3RvcnkgbmVhciB3YWxsIGluc3RlYWQgb2YgcGluZy1wb25nKQogICAgICAgIGlmIChkaXN0WFogPiBlZmZlY3RpdmVCb3VuZGFyeSAtIHNvZnRCdWZmZXIpIHsKICAgICAgICAgICAgY29uc3QgcGVuZXRyYXRpb24gPSBkaXN0WFogLSAoZWZmZWN0aXZlQm91bmRhcnkgLSBzb2Z0QnVmZmVyKTsKICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBwZW5ldHJhdGlvbiAvIHNvZnRCdWZmZXIpKTsKCiAgICAgICAgICAgIF90ZW1wVmVjLnNldCgtcG9zLngsIDAsIC1wb3Mueik7CiAgICAgICAgICAgIGlmIChfdGVtcFZlYy5sZW5ndGhTcSgpID4gMC4wMDAxKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYy5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gcmF0aW8gKiByYXRpbyAqIChDLldBTExfU09GVF9GT1JDRSB8fCAwKSAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjLCBmb3JjZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEhhcmQgY2xhbXAgaWYgaXQgc3RpbGwgaGl0cwogICAgICAgIGlmIChkaXN0WFogPiBlZmZlY3RpdmVCb3VuZGFyeSkgewogICAgICAgICAgICBfdGVtcFZlYy5zZXQoLXBvcy54LCAwLCAtcG9zLnopOwogICAgICAgICAgICBpZiAoX3RlbXBWZWMubGVuZ3RoU3EoKSA+IDAuMDAwMSkgX3RlbXBWZWMubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBvdmVybGFwID0gZGlzdFhaIC0gZWZmZWN0aXZlQm91bmRhcnk7CiAgICAgICAgICAgIHBvcy5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMsIG92ZXJsYXApOwoKY29uc3QgdkRvdE4gPSB0aGlzLnZlbG9jaXR5LmRvdChfdGVtcFZlYyk7CgogICAgICAgICAgICAvLyBPbmx5IGFkanVzdCBpZiBtb3Zpbmcgb3V0d2FyZCAoYWdhaW5zdCBpbndhcmQgbm9ybWFsKQogICAgICAgICAgICBpZiAodkRvdE4gPCAwKSB7CiAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIEFyZW5hIERlZm9ybWF0aW9uIGlmIGltcGFjdCBpcyBmb3JjZWZ1bAogICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0U3BlZWQgPSBNYXRoLmFicyh2RG90Tik7CiAgICAgICAgICAgICAgICBpZiAoaW1wYWN0U3BlZWQgPiAxMC4wICYmIHdpbmRvdy5mbHV4LnRyaWdnZXJBcmVuYUltcGFjdCkgewogICAgICAgICAgICAgICAgICAgIC8vIFBhc3MgdGhlIGNvbnRhY3QgcG9pbnQgKHBvcykgYW5kIHN0cmVuZ3RoIGJhc2VkIG9uIHNwZWVkCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KHBvcywgTWF0aC5taW4oaW1wYWN0U3BlZWQgKiAwLjUsIDE1LjApKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBlID0gKEMuV0FMTF9FTEFTVElDSVRZICE9PSB1bmRlZmluZWQgPyBDLldBTExfRUxBU1RJQ0lUWSA6IDAuMyk7CiAgICAgICAgICAgICAgICBjb25zdCBpbXB1bHNlID0gX3RlbXBWZWMuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtdkRvdE4gKiAoMS4wICsgZSkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoaW1wdWxzZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRhbmdlbnRpYWwgZnJpY3Rpb24KICAgICAgICAgICAgICAgIGNvbnN0IGZyaWN0aW9uID0gKEMuV0FMTF9GUklDVElPTiAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX0ZSSUNUSU9OIDogMC45NSk7CiAgICAgICAgICAgICAgICBjb25zdCB0YW5nZW50ID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLnByb2plY3RPblBsYW5lKF90ZW1wVmVjKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc3ViKHRhbmdlbnQubXVsdGlwbHlTY2FsYXIoMS4wIC0gZnJpY3Rpb24pKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQ2VpbGluZy9GbG9vciBjbGFtcAogICAgICAgIGNvbnN0IGJoID0gKEMuQk9VTkRBUllfSEVJR0hUICE9PSB1bmRlZmluZWQgPyBDLkJPVU5EQVJZX0hFSUdIVCA6IDE1LjApOwogICAgICAgIGlmIChNYXRoLmFicyhwb3MueSkgPiBiaCkgewogICAgICAgICAgICBjb25zdCBzaWduID0gTWF0aC5zaWduKHBvcy55KSB8fCAxOwogICAgICAgICAgICBwb3MueSA9IGJoICogc2lnbjsKICAgICAgICAgICAgY29uc3QgZmUgPSAoQy5GTE9PUl9FTEFTVElDSVRZICE9PSB1bmRlZmluZWQgPyBDLkZMT09SX0VMQVNUSUNJVFkgOiAwLjQpOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLWZlOwp9CiAgICB9CgogICAgLy8gLS0tIDIpIEZYIHRoYXQgc2hvdWxkIHJ1biBvbmNlIHBlciBmcmFtZSAobm90IHBlciBzdWJzdGVwKSAtLS0KICAgIGlmICghdGhpcy5fZ2hvc3QpIHsKICAgICAgICBjb25zdCBzcGVlZFNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgIGlmIChzcGVlZFNxID4gMi4wICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5fYnViYmxlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgY29uc3QgcG0gPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKC0wLjgpOwoKICAgICAgICAgICAgICAgIC8vIFN0YW5kYXJkIGJ1YmJsZQovLyBTdGFuZGFyZCBidWJibGUKICAgICAgICAgICAgICAgIGNvbnN0IHN0ZFBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLmFkZChfYkRpci5zZXQoKE1hdGgucmFuZG9tKCktMC41KSowLjMsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4zLCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuMykpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3RkUG9zLnkgKz0gdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlJywgc3RkUG9zLCB7IHNjYWxlOiAwLjQgKyBNYXRoLnJhbmRvbSgpICogMC40IH0pOyAvLyBJbmNyZWFzZWQgc2NhbGUKCiAgICAgICAgICAgICAgICAvLyBNaWNybyBidWJibGVzIGF0IGhpZ2ggc3BlZWQKICAgICAgICAgICAgICAgIGlmIChzcGVlZFNxID4gNTAuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gTWF0aC5taW4oNCwgTWF0aC5mbG9vcihzcGVlZFNxIC8gNjApKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKY29uc3Qgaml0dGVyID0gX2JEaXIuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC40LCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuNCwgKE1hdGgucmFuZG9tKCktMC41KSowLjQpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGF3blBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLmFkZChqaXR0ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWZvcm1Ob2RlKSBzcGF3blBvcy55ICs9IHRoaXMuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlX21pY3JvJywgc3Bhd25Qb3MsIHsgc2NhbGU6IDAuMDUgKyBNYXRoLnJhbmRvbSgpICogMC4xIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDAuMDI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gMC41KSB7CmNvbnN0IGppdHRlciA9IF9iRGlyLnNldCgoTWF0aC5yYW5kb20oKS0wLjUpKjAuMiwgKE1hdGgucmFuZG9tKCktMC41KSowLjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3Bhd25Qb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQob2Zmc2V0KS5hZGQoaml0dGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3Bhd25Qb3MueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIHNwYXduUG9zLCB7IHNjYWxlOiAwLjA0ICsgTWF0aC5yYW5kb20oKSAqIDAuMDYgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4wNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLyAtLS0gMykgVmlzdWFsIHJvdGF0aW9uIC0tLQogICAgY29uc3Qgc3BpblNwZWVkID0gdGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCk7CiAgICBpZiAoc3BpblNwZWVkID4gMC41KSB7CiAgICAgICAgY29uc3QgYXhpcyA9IF90ZW1wVmVjLmNvcHkodGhpcy5hbmd1bGFyVmVsb2NpdHkpLm5vcm1hbGl6ZSgpOwogICAgICAgIGNvbnN0IHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUoYXhpcywgc3BpblNwZWVkICogZHQpOwogICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5wcmVtdWx0aXBseShxKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgIGlmIChzcGVlZCA+IDAuMSkgewogICAgICAgICAgICBfdGVtcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLmNyb3NzKF9heGlzWSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGlmIChfdGVtcFZlYy5sZW5ndGhTcSgpID4gMC4wMSkgewogICAgICAgICAgICAgICAgY29uc3QgcSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShfdGVtcFZlYywgc3BlZWQgKiBkdCk7CiAgICAgICAgICAgICAgICB0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24ucHJlbXVsdGlwbHkocSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCmdyYWIocGxheWVyKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50OiBQb3NzZXNzaW9uIChpZiB0YWtpbmcgZnJvbSBmcmVlIHN0YXRlKQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCgiUE9TU0VTU0lPTiIsICJub3JtYWwiKTsKICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIFR1cm5vdmVyIChQb3NzZXNzaW9uIENoYW5nZSkKICAgICAgICAgICAgY29uc3QgcHJldmlvdXNUZWFtID0gdGhpcy5ob2xkZXIgPyB0aGlzLmhvbGRlci50ZWFtIDogKHRoaXMubGFzdEhvbGRlciA/IHRoaXMubGFzdEhvbGRlci50ZWFtIDogbnVsbCk7CiAgICAgICAgICAgIGlmIChwcmV2aW91c1RlYW0gJiYgcHJldmlvdXNUZWFtICE9PSBwbGF5ZXIudGVhbSkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJUVVJOT1ZFUiIsIHBsYXllci5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgc29tZW9uZSBlbHNlIGhlbGQgaXQsIHRoZXkgbG9zZSBpdAogICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIgIT09IHBsYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIubG9zZUJhbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBwbGF5ZXI7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaGVsZCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOT1RFOiBXZSBkbyBOT1QgcGFyZW50IHRoZSBtZXNoIHRvIHRoZSBwbGF5ZXIgYW55bW9yZS4KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyB0aGUgYmFsbCBmcm9tIGZseWluZyBhcm91bmQgZHVlIHRvIHN3aW0gYW5pbWF0aW9ucy4KICAgICAgICAgICAgLy8gSW5zdGVhZCwgd2UgdXBkYXRlIGl0cyBwb3NpdGlvbiBtYW51YWxseSBpbiB1cGRhdGVIZWxkKCkuCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3RpZnkgcGxheWVyCiAgICAgICAgICAgIGlmIChwbGF5ZXIucmVjZWl2ZUJhbGwpIHsKICAgICAgICAgICAgICAgIHBsYXllci5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zb2xlLmxvZygiQmFsbCBncmFiYmVkIGJ5ICIgKyBwbGF5ZXIucm9sZSk7CiAgICAgICAgfQoKICAgICAgICBkcm9wKCkgewogICAgICAgICAgICB0aGlzLnJldmVhbCgpOyAvLyBFbnN1cmUgdmlzaWJsZQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm8gbmVlZCB0byBkZXRhY2ggZnJvbSBzY2VuZSBncmFwaCBzaW5jZSB3ZSBhcmVuJ3QgcGFyZW50aW5nIHRvIHBsYXllciBhbnltb3JlLgogICAgICAgICAgICAvLyBKdXN0IGNsZWFyIGhvbGRlci4KCiAgICAgICAgICAgIGlmICh0aGlzLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmxvc2VCYWxsKSB0aGlzLmhvbGRlci5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIH0KLy8gU2hvb3QvUGFzcwovLyBTaG9vdC9QYXNzCiAgICAgICAgc2hvb3QoZGlyZWN0aW9uVmVjdG9yLCBmb3JjZSwgdHlwZSA9ICdTSCcsIHRlY2huaXF1ZSA9IG51bGwsIHNwaW5WZWN0b3IgPSBudWxsKSB7CgogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSB0aGlzLmhvbGRlcjsgLy8gUmVjb3JkIGZvciBFWFAgYXR0cmlidXRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZ1bWJsZSBEZXRlY3Rpb24gKFR5cGUgJ25vbmUnIGlzIHVzZWQgYnkgUGxheWVyLmZ1bWJsZSkKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdub25lJykgewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KCJGVU1CTEUhIiwgInNsYW0iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5kcm9wKCk7IC8vIERldGFjaCBmaXJzdAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0IEdyYWNlIFBlcmlvZCB0byBwcmV2ZW50IGluc3RhbnQgaW50ZXJjZXB0aW9ucy9jYXRjaGVzCiAgICAgICAgICAgIC8vIDAuMnMgYWxsb3dzIGJhbGwgdG8gY2xlYXIgdGhlIHRocm93ZXIncyBpbW1lZGlhdGUgdmljaW5pdHkKICAgICAgICAgICAgdGhpcy5jYXRjaEdyYWNlUGVyaW9kID0gMC4yOwoKICAgICAgICAgICAgLy8gUGh5c2ljYWwgVmVsb2NpdHkgKFZpc3VhbCBzcGVlZCkKICAgICAgICAgICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcgfHwge307CiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKEMuTEFVTkNIX1NQRUVEX1NDQUxFICE9PSB1bmRlZmluZWQgPyBDLkxBVU5DSF9TUEVFRF9TQ0FMRSA6IDEuMCk7CiAgICAgICAgICAgIGNvbnN0IGNhcCA9IChDLkxBVU5DSF9TUEVFRF9DQVAgIT09IHVuZGVmaW5lZCA/IEMuTEFVTkNIX1NQRUVEX0NBUCA6IDg1LjApOwogICAgICAgICAgICBjb25zdCBzcGVlZCA9IE1hdGgubWluKGZvcmNlICogc2NhbGUsIGNhcCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuY29weShkaXJlY3Rpb25WZWN0b3IpLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKHNwZWVkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IFNwaW4gaWYgcHJvdmlkZWQKICAgICAgICAgICAgaWYgKHNwaW5WZWN0b3IpIHsKICAgICAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LmNvcHkoc3BpblZlY3Rvcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN0YXQgUG93ZXIgKEdhbWUgTG9naWMpCiAgICAgICAgICAgIHRoaXMucG93ZXIgPSBmb3JjZTsKICAgICAgICAgICAgdGhpcy5wb3dlclR5cGUgPSB0eXBlOwogICAgICAgICAgICB0aGlzLnRlY2huaXF1ZSA9IHRlY2huaXF1ZTsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVHJhaWwgQ29sb3IKICAgICAgICAgICAgaWYgKHRoaXMudHJhaWwpIHsKICAgICAgICAgICAgICAgIGxldCBjb2xvciA9IDB4MDBhYWZmOyAvLyBEZWZhdWx0IEJsdWUgKFBhc3MpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZWNobmlxdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICd2ZW5vbScpIGNvbG9yID0gMHgwMGZmMDA7IC8vIEdyZWVuIChWZW5vbSkKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ3dpdGhlcicpIGNvbG9yID0gMHg4ODg4ODg7IC8vIEdyZXkKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ25hcCcpIGNvbG9yID0gMHgwMDAwODg7IC8vIERhcmsgQmx1ZQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnc3BoZXJlJykgY29sb3IgPSAweDAwZmZmZjsgLy8gQ3lhbgogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnamVjaHQnKSBjb2xvciA9IDB4ZmYwMDAwOyAvLyBSZWQKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIGNvbG9yID0gMHg0NDQ0NDQ7IC8vIERhcmsgR3JleQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgPSAweGZmNDQwMDsgLy8gT3JhbmdlL1JlZAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLnRyYWlsLnNldENvbG9yKGNvbG9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGFuZGxlIEludmlzaWJsZSBTaG90CiAgICAgICAgICAgIGlmICh0ZWNobmlxdWUgJiYgdGVjaG5pcXVlLnR5cGUgPT09ICdpbnZpc2libGUnKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzSW52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBGWDogUG9vZgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignd2l0aGVyJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAyLjAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiSW52aXNpYmxlIFNob3QhIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCYWxsICR7dHlwZX0gd2l0aCBQb3dlcjogJHt0aGlzLnBvd2VyLnRvRml4ZWQoMSl9IFNwaW46ICR7dGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkudG9GaXhlZCgxKX1gKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjayBmb3IgQ3VydmUKICAgICAgICAgICAgaWYgKHRoaXMuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aCgpID4gMTUuMCAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQ1VSVkUhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXZlYWwoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzSW52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICAvLyBGWDogUmV2ZWFsIFBvb2YKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlciAmJiB0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCd3aXRoZXInLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlzSW52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICB9CgovLyBEdXBsaWNhdGUgcmV2ZWFsIHJlbW92ZWQKICAgICAgICAKcmVzZXQoKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7CiAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwOwogICAgICAgICAgICB0aGlzLnBvd2VyID0gMDsKICAgICAgICB9CmlzQ2F0Y2hhYmxlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jYXRjaEdyYWNlUGVyaW9kIDw9IDA7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWxzKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5kZWZvcm1Ob2RlIHx8ICF0aGlzLnNwaW5Ob2RlKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBTcXVhc2ggJiBTdHJldGNoIGJhc2VkIG9uIHZlbG9jaXR5Ci8vIDEuIFNxdWFzaCAmIFN0cmV0Y2ggYmFzZWQgb24gdmVsb2NpdHkKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT25seSBhcHBseSBzdHJldGNoIGlmIG1vdmluZyBmYXN0IGVub3VnaAogICAgICAgICAgICBpZiAoc3BlZWQgPiAxLjAgJiYgdGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAvLyBPcmllbnQgZGVmb3JtTm9kZSB0byB2ZWxvY2l0eSBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgZm9yd2FyZCBpcyBaICgwLDAsMSkKICAgICAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLnNldEZyb21Vbml0VmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLDAsMSksIGRpcik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBzdHJldGNoIGZhY3RvcgogICAgICAgICAgICAgICAgLy8gTWF4IHN0cmV0Y2ggYXQgc3BlZWQgNDAgKGFwcHJveCBtYXggc2hvdCBwb3dlcikKICAgICAgICAgICAgICAgIGNvbnN0IGZhY3RvciA9IE1hdGgubWluKHNwZWVkIC8gNDAuMCwgMS4wKTsgCiAgICAgICAgICAgICAgICBjb25zdCBzdHJldGNoID0gMS4wICsgKGZhY3RvciAqIDAuOCk7IC8vIEluY3JlYXNlZCBzdHJldGNoIG1heCB0byAxLjh4CiAgICAgICAgICAgICAgICBjb25zdCBzcXVhc2ggPSAxLjAgLyBNYXRoLnNxcnQoc3RyZXRjaCk7IC8vIE1haW50YWluIHZvbHVtZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUuc2NhbGUuc2V0KHNxdWFzaCwgc3F1YXNoLCBzdHJldGNoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFJlc2V0IGRlZm9ybWF0aW9uCiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUucXVhdGVybmlvbi5pZGVudGl0eSgpOwogICAgICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnNjYWxlLnNldCgxLCAxLCAxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gQXBwbHkgQWNjdW11bGF0ZWQgU3BpbgogICAgICAgICAgICAvLyBTaW5jZSBkZWZvcm1Ob2RlIG1pZ2h0IGJlIHJvdGF0ZWQsIHdlIG5lZWQgdG8gYXBwbHkgc3BpbiBpbiB0aGUgY29ycmVjdCBzcGFjZS4KICAgICAgICAgICAgLy8gc3Bpbk5vZGUgcm90YXRpb24gPSBkZWZvcm1Ob2RlX2ludmVyc2UgKiBhY2N1bXVsYXRlZFJvdGF0aW9uCmNvbnN0IGludkRlZm9ybSA9IHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLmNsb25lKCkuaW52ZXJ0KCk7CiAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucXVhdGVybmlvbi5jb3B5KGludkRlZm9ybS5tdWx0aXBseSh0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24pKTsKICAgICAgICB9CiAgICB9Cgp3aW5kb3cuZmx1eC5CYWxsID0gQmFsbDsKICAgIHdpbmRvdy5mbHV4LlRyYWlsUmVuZGVyZXIgPSBUcmFpbFJlbmRlcmVyOwp9KSgpOw==","/Ball.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIHZlY3RvcnMgdG8gYXZvaWQgR0MKY29uc3QgX2JWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2JEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2F4aXNZID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CiAgICBjb25zdCBfdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbWFnbnVzVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCi8vIFBoeXNpY3MgQ29uZmlndXJhdGlvbiAoRXhwb3NlZCBmb3IgRGV2VG9vbHMpCndpbmRvdy5mbHV4LkJhbGxDb25maWcgPSB7CiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBDb3JlIGludGVncmF0aW9uCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBTVUJTVEVQUzogMiwgICAgICAgICAgICAgICAgLy8gUGh5c2ljcyBzdWJzdGVwcyBwZXIgZnJhbWUgKHN0YWJpbGl0eSBhdCBoaWdoIHNwZWVkcykKICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLCAgICAgICAgICAgLy8gQmVsb3cgdGhpcyBzcGVlZCwgc25hcCB0byByZXN0IChwcmV2ZW50cyBlbmRsZXNzIGRyaWZ0KQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFdhdGVyIHJlc2lzdGFuY2UgKHBoeXNpY2FsIHZlbG9jaXR5IGRyYWcsIE5PVCBzdGF0IGRlY2F5KQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMTUsICAgIC8vIExpbmVhciBkcmFnIHRlcm0gKHJvdWdobHkgeW91ciBwcmV2aW91cyBXQVRFUl9EUkFHKQogICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDIsICAgICAvLyBRdWFkcmF0aWMgZHJhZyAoc3Ryb25nZXIgYXQgaGlnaCBzcGVlZCwgaGVscHMgdGFtZSByb2NrZXRzKQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFNwaW4gJiBjdXJ2ZQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgU1BJTl9EUkFHOiAwLjQwLCAgICAgICAgICAgIC8vIFNwaW4gZGVjYXkgcGVyIHNlY29uZAogICAgICAgIE1BR05VU19FTkFCTEVEOiB0cnVlLAogICAgICAgIE1BR05VU19DT0VGRjogMC4wOCwgICAgICAgICAvLyBMaWZ0IHN0cmVuZ3RoCiAgICAgICAgTUFHTlVTX0NBUDogNjAuMCwgICAgICAgICAgIC8vIE1heCBtYWdudXMgZGVsdGEtViBwZXIgc3Vic3RlcCAocHJldmVudHMgZXhwbG9zaW9ucykKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBEZXB0aCBjb25zdHJhaW50IChrZWVwcyBiYWxsIG5lYXIgcGxheSBwbGFuZSB3aXRob3V0IGZlZWxpbmcgbGlrZSBhIGhhcmQgZmxvb3IpCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBERVBUSF9UQVJHRVRfWTogMC4wLAogICAgICAgIERFUFRIX1NQUklORzogMS4wLCAgICAgICAgICAvLyBZb3VyIHByZXZpb3VzIEdSQVZJVFlfU1BSSU5HCiAgICAgICAgREVQVEhfREFNUDogMS41LCAgICAgICAgICAgIC8vIFlvdXIgcHJldmlvdXMgR1JBVklUWV9EQU1QCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gQXJlbmEgYm91bmRhcnkgKHNvZnQgd2FsbCArIGNsYW1wKQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCkJPVU5EQVJZX1JBRElVUzogNDYuMCwKICAgICAgICBCT1VOREFSWV9IRUlHSFQ6IDIwLjAsCiAgICAgICAgR09BTF9QT0NLRVRfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBHT0FMX1BPQ0tFVF9YOiAxMi4wLCAgICAgICAgLy8gSGFsZi13aWR0aCBvZiBnb2FsIHBvY2tldCBjb3JyaWRvcgogICAgICAgIEdPQUxfUE9DS0VUX1o6IDQwLjAsICAgICAgICAvLyBTdGFydCBvZiBnb2FsIHBvY2tldCBjb3JyaWRvciAoYWJzIHopIC0gUHVzaGVkIGJhY2sKICAgICAgICBHT0FMX1BPQ0tFVF9SQURJVVM6IDU1LjAsICAgLy8gRWZmZWN0aXZlIHJhZGl1cyB3aGVuIGluIGdvYWwgcG9ja2V0CiAgICAgICAgV0FMTF9TT0ZUX0JVRkZFUjogMy4wLCAgICAgIC8vIERpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMKICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDIwLjAsICAgICAgLy8gU29mdCByZXB1bHNpb24gc3RyZW5ndGgKICAgICAgICBXQUxMX0VMQVNUSUNJVFk6IDAuMzAsICAgICAgLy8gQm91bmNlIGRhbXBlbmluZyBvbiBjbGFtcAogICAgICAgIFdBTExfRlJJQ1RJT046IDAuOTUsICAgICAgICAvLyBUYW5nZW50aWFsIGRhbXBpbmcgb24gd2FsbCBjb250YWN0CgogICAgICAgIEZMT09SX0VMQVNUSUNJVFk6IDAuNDAsICAgICAvLyBCb3VuY2UgZGFtcGVuaW5nIG9uIGNlaWxpbmcvZmxvb3IgY2xhbXAKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBUaHJvdyBtYXBwaW5nIChzdGF0IGZvcmNlIC0+IHBoeXNpY2FsIGxhdW5jaCBzcGVlZCkKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIExBVU5DSF9TUEVFRF9TQ0FMRTogMS4wLCAgICAvLyBNdWx0aXBsaWVzIGZvcmNlIHdoZW4gY29udmVydGluZyB0byB2ZWxvY2l0eQogICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDg1LjAgICAgICAvLyBQaHlzaWNhbCBzcGVlZCBjYXAgKHdhcyBoYXJkY29kZWQgaW4gQmFsbC5zaG9vdCkKICAgIH07CgoKICAgIAogICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWc7IC8vIExvY2FsIGFsaWFzIGZvciBicmV2aXR5CiAgICAvLyAtLS0gVFJBSUwgUkVOREVSRVIgLS0tCi8vIC0tLSBUUkFJTCBSRU5ERVJFUiAtLS0KICAgIGNsYXNzIFRyYWlsUmVuZGVyZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5zZWdtZW50cyA9IDMwOyAvLyBNb3JlIHNlZ21lbnRzIGZvciBzbW9vdGhlciBjdXJ2ZXMKICAgICAgICAgICAgdGhpcy5wb2ludHMgPSBbXTsKdGhpcy5iYXNlV2lkdGggPSAwLjg7IC8vIEluY3JlYXNlZCB3aWR0aCBmb3IgdmlzaWJpbGl0eQogICAgICAgICAgICB0aGlzLmN1cnJlbnRXaWR0aCA9IDAuODsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJ5CiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgICAgIGNvbnN0IHBvc0RhdGEgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuc2VnbWVudHMgKiAyICogMyk7CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHBvc0RhdGEsIDMpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluZGljZXMKICAgICAgICAgICAgY29uc3QgaW5kaWNlcyA9IFtdOwogICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50cy0xOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhc2UgPSBpKjI7CiAgICAgICAgICAgICAgICBpbmRpY2VzLnB1c2goYmFzZSwgYmFzZSsxLCBiYXNlKzIpOwogICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGJhc2UrMSwgYmFzZSszLCBiYXNlKzIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEluZGV4KGluZGljZXMpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBjb2xvcjogMHgwMGFhZmYsCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLjksIC8vIEluY3JlYXNlZCBvcGFjaXR5CiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLm1lc2gpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW5pdCBwb2ludHMKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB0aGlzLnBvaW50cy5wdXNoKG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUmV1c2FibGUgdGVtcHMgKGF2b2lkIHBlci1mcmFtZSBhbGxvY2F0aW9ucyBvbiBtb2JpbGUpCiAgICAgICAgICAgIHRoaXMuX3RtcERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuX3RtcFRvQ2FtID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5fdG1wUmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXNldChwb3MpIHsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB0aGlzLnBvaW50c1tpXS5jb3B5KHBvcyk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlR2VvbWV0cnkoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgc2V0Q29sb3IoaGV4KSB7CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KGhleCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZShjdXJyZW50UG9zLCBzcGVlZFJhdGlvID0gMC4wKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXQoY3VycmVudFBvcyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCi8vIER5bmFtaWMgV2lkdGggYmFzZWQgb24gc3BlZWQgQU5EIFNQSU4gKFBvd2VyIFZpc3VhbCkKICAgICAgICAgICAgLy8gRmFzdCBiYWxsID0gVGhpY2tlci4gU3Bpbm5pbmcgYmFsbCA9IEV2ZW4gVGhpY2tlci4KICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgY29uc3Qgc3BpblJhdGlvID0gYmFsbCA/IE1hdGgubWluKDEuMCwgYmFsbC5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkgLyAzMC4wKSA6IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB0YXJnZXRXaWR0aCA9IHRoaXMuYmFzZVdpZHRoICogKDAuOCArIHNwZWVkUmF0aW8gKiAxLjIgKyBzcGluUmF0aW8gKiAyLjApOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRXaWR0aCArPSAodGFyZ2V0V2lkdGggLSB0aGlzLmN1cnJlbnRXaWR0aCkgKiAwLjI7IC8vIFNtb290aCB0cmFuc2l0aW9uCgogICAgICAgICAgICAvLyBTaGlmdCBwb2ludHMKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuc2VnbWVudHMgLSAxOyBpID4gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBvaW50c1tpXS5jb3B5KHRoaXMucG9pbnRzW2ktMV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucG9pbnRzWzBdLmNvcHkoY3VycmVudFBvcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVwZGF0ZUdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZUdlb21ldHJ5KCkgewogICAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5hcnJheTsKICAgICAgICAgICAgY29uc3QgY2FtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSA6IG51bGw7CiAgICAgICAgICAgIGlmICghY2FtKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IGNhbS5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgdGVtcERpciA9IHRoaXMuX3RtcERpcjsKICAgICAgICAgICAgY29uc3QgdGVtcFRvQ2FtID0gdGhpcy5fdG1wVG9DYW07CiAgICAgICAgICAgIGNvbnN0IHRlbXBSaWdodCA9IHRoaXMuX3RtcFJpZ2h0OwogICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5wb2ludHNbaV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRhcGVyIHdpZHRoIGFsb25nIHRyYWlsIGxlbmd0aAogICAgICAgICAgICAgICAgY29uc3QgdGFwZXIgPSAxLjAgLSBNYXRoLnBvdyhpIC8gdGhpcy5zZWdtZW50cywgMik7IC8vIFF1YWRyYXRpYyB0YXBlcgogICAgICAgICAgICAgICAgY29uc3QgdyA9IHRoaXMuY3VycmVudFdpZHRoICogdGFwZXI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIGlmIChpIDwgdGhpcy5zZWdtZW50cyAtIDEpIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wRGlyLnN1YlZlY3RvcnModGhpcy5wb2ludHNbaV0sIHRoaXMucG9pbnRzW2krMV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wRGlyLnN1YlZlY3RvcnModGhpcy5wb2ludHNbaS0xXSwgdGhpcy5wb2ludHNbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGVtcERpci5sZW5ndGhTcSgpIDwgMC4wMDAxKSB0ZW1wRGlyLnNldCgwLCAxLCAwKTsKICAgICAgICAgICAgICAgIHRlbXBEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRlbXBUb0NhbS5zdWJWZWN0b3JzKGNhbVBvcywgcCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0ZW1wUmlnaHQuY3Jvc3NWZWN0b3JzKHRlbXBEaXIsIHRlbXBUb0NhbSkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIodyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZlcnQgMQogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDBdID0gcC54IC0gdGVtcFJpZ2h0Lng7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgMV0gPSBwLnkgLSB0ZW1wUmlnaHQueTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAyXSA9IHAueiAtIHRlbXBSaWdodC56OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZXJ0IDIKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAzXSA9IHAueCArIHRlbXBSaWdodC54OwogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDRdID0gcC55ICsgdGVtcFJpZ2h0Lnk7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgNV0gPSBwLnogKyB0ZW1wUmlnaHQuejsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgfQogICAgfQpjbGFzcyBCYWxsIHsKCiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7IAogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSBudWxsOyAvLyBUcmFjayB3aG8gdGhyZXcgaXQgbGFzdCAoZm9yIEVYUC9Bc3Npc3RzKQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOyAvLyAnZnJlZScsICdoZWxkJywgJ21hZ25ldGl6ZWQnCiAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIENvbnRpbnVvdXMgU3RhdHMKICAgICAgICAgICAgdGhpcy5wb3dlciA9IDA7ICAgICAgLy8gQ3VycmVudCBQQSBvciBTSCB2YWx1ZQogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9ICdub25lJzsgLy8gJ1BBJyBvciAnU0gnCiAgICAgICAgICAgIHRoaXMuZGVjYXlSYXRlID0gMy4wOyAvLyBTdGF0IHBvaW50cyBsb3N0IHBlciBzZWNvbmQgKFdhdGVyIHJlc2lzdGFuY2UpCiAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7IC8vIFRpbWUgYmVmb3JlIGJhbGwgY2FuIGJlIGNhdWdodCBhZ2FpbgoKICAgICAgICAgICAgLy8gTWFnbmV0IFN5c3RlbQogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1hZ25ldER1cmF0aW9uID0gMC4yOyAKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gVmlzdWFscyAoU3F1YXNoICYgU3RyZXRjaCkKICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zcGluTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubW9kZWwgPSBudWxsOwoKdGhpcy5pbml0TWVzaCgpOwogICAgICAgICAgICB0aGlzLnRyYWlsID0gbmV3IFRyYWlsUmVuZGVyZXIoc2NlbmUpOwogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDA7Cn0KaW5pdE1lc2goKSB7CiAgICAgICAgICAgIC8vIEhpZXJhcmNoeTogTWVzaCAoUG9zKSAtPiBEZWZvcm0gKFNxdWFzaC9TdHJldGNoKSAtPiBTcGluIChSb3RhdGlvbikgLT4gTW9kZWwKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7Cgp0aGlzLmRlZm9ybU5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnkgPSAwLjA7IC8vIFJlc2V0IG9mZnNldCBzbyBiYWxsIGlzIGNlbnRlcmVkIG9uIG1lc2ggcG9zaXRpb24KICAgICAgICAgICAgdGhpcy5tZXNoLmFkZCh0aGlzLmRlZm9ybU5vZGUpOyAvLyBGaXg6IEFkZCBkZWZvcm1Ob2RlIHRvIG1lc2gKCiAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLmFkZCh0aGlzLnNwaW5Ob2RlKTsKCiAgICAgICAgICAgIC8vIFByb2NlZHVyYWwgUGxhY2Vob2xkZXIgVGV4dHVyZSAoQmxpdHpiYWxsLWlzaCkKICAgICAgICAgICAgY29uc3QgcGxhY2Vob2xkZXJUZXggPSAoKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAgICAgYy53aWR0aCA9IDEyODsgYy5oZWlnaHQgPSA2NDsKICAgICAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2VlZWVlZSc7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwwLDEyOCw2NCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEJsdWUgYnVtcHMvZGV0YWlscwogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDA4OGZmJzsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDY7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBjdHguYXJjKGkqMjUsIDMyLCAxMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDA0NDg4JzsKICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAyOCwgMTI4LCA4KTsgLy8gU3RyaXBlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICAgICAgfSkoKTsKCiAgICAgICAgICAgIC8vIFBsYWNlaG9sZGVyIFZpc3VhbCAoSW1tZWRpYXRlIGZlZWRiYWNrLCBwZXJzaXN0cyB1bnRpbCB2YWxpZCBtb2RlbCBsb2FkcykKLy8gUGxhY2Vob2xkZXIgVmlzdWFsIChJbW1lZGlhdGUgZmVlZGJhY2ssIHBlcnNpc3RzIHVudGlsIHZhbGlkIG1vZGVsIGxvYWRzKQovLyBQbGFjZWhvbGRlciBWaXN1YWwgKEltbWVkaWF0ZSBmZWVkYmFjaywgcGVyc2lzdHMgdW50aWwgdmFsaWQgbW9kZWwgbG9hZHMpCmNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDAuMywgMTYsIDE2KTsgLy8gU2NhbGVkIGRvd24gfjE1JQogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBtYXA6IHBsYWNlaG9sZGVyVGV4LAogICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAKICAgICAgICAgICAgICAgIHdpcmVmcmFtZTogZmFsc2UsIC8vIFNvbGlkCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAxLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwoKICAgICAgICAgICAgLy8gTG9hZCBHTEIgTW9kZWwKICAgICAgICAgICAgY29uc3QgdXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy81MjFhZTg3ODhlNTg0ZTM3OGE3OWQ5NzMyYTA3NTM1Ni5nbGInOwogICAgICAgICAgICAKICAgICAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKHVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJERUJVRzogQmFsbCBHTEIgbG9hZGVkLiIsIGdsdGYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBtb2RlbCA9IGdsdGYuc2NlbmU7CgogICAgICAgICAgICAgICAgLy8gMS4gUmVzZXQgcm9vdCB0cmFuc2Zvcm1zCiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBtb2RlbC5yb3RhdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBtb2RlbC5zY2FsZS5zZXQoMSwgMSwgMSk7CiAgICAgICAgICAgICAgICBtb2RlbC51cGRhdGVNYXRyaXhXb3JsZCh0cnVlKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBIYXJkZW4gTWF0ZXJpYWxzICYgVmlzaWJpbGl0eQogICAgICAgICAgICAgICAgbW9kZWwudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5jYXN0U2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVjZWl2ZVNoYWRvdyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsgLy8gQ1JJVElDQUw6IFByZXZlbnQgY3VsbGluZyBpZiBib3VuZHMgYXJlIG9mZgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hdHMgPSBBcnJheS5pc0FycmF5KG5vZGUubWF0ZXJpYWwpID8gbm9kZS5tYXRlcmlhbCA6IFtub2RlLm1hdGVyaWFsXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdHMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLmNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIEZvcmNlIHdoaXRlIGJhc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnNpZGUgPSBUSFJFRS5Eb3VibGVTaWRlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5hbHBoYVRlc3QgPSAwOyAvLyBDUklUSUNBTDogRGlzYWJsZSBhbHBoYSB0ZXN0IHRvIHByZXZlbnQgY3VsbGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5kZXB0aFRlc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyAzLiBDb21wdXRlIEJvdW5kaW5nIEJveAogICAgICAgICAgICAgICAgY29uc3QgYm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KG1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNpemUgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgYm94LmdldFNpemUoc2l6ZSk7CiAgICAgICAgICAgICAgICBjb25zdCBjZW50ZXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgYm94LmdldENlbnRlcihjZW50ZXIpOwoKICAgICAgICAgICAgICAgIC8vIDQuIFZhbGlkYXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IG1heERpbSA9IE1hdGgubWF4KHNpemUueCwgc2l6ZS55LCBzaXplLnopOwogICAgICAgICAgICAgICAgaWYgKG1heERpbSA8PSAwLjAwMSB8fCAhaXNGaW5pdGUobWF4RGltKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBtb2RlbCBoYXMgaW52YWxpZCBkaW1lbnNpb25zLiBLZWVwaW5nIHBsYWNlaG9sZGVyLiIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gNS4gQ2FsY3VsYXRlIFNjYWxlCi8vIDUuIENhbGN1bGF0ZSBTY2FsZQpjb25zdCB0YXJnZXREaWFtZXRlciA9IDAuNzI7IC8vIFJlZHVjZWQgc2NhbGUgYnkgfjE1JSAod2FzIDAuODUpCiAgICAgICAgICAgICAgICBjb25zdCBzY2FsZUZhY3RvciA9IHRhcmdldERpYW1ldGVyIC8gbWF4RGltOwoKICAgICAgICAgICAgICAgIC8vIDYuIEFwcGx5IFRyYW5zZm9ybXMKICAgICAgICAgICAgICAgIG1vZGVsLnNjYWxlLnNldFNjYWxhcihzY2FsZUZhY3Rvcik7CiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5jb3B5KGNlbnRlcikubXVsdGlwbHlTY2FsYXIoLXNjYWxlRmFjdG9yKTsKCiAgICAgICAgICAgICAgICAvLyA3LiBTd2FwIFBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucmVtb3ZlKHRoaXMucGxhY2Vob2xkZXIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5KSB0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsID0gbW9kZWw7CiAgICAgICAgICAgICAgICB0aGlzLnNwaW5Ob2RlLmFkZCh0aGlzLm1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCbGl0emJhbGwgbW9kZWwgYXR0YWNoZWQuIFNjYWxlOiAke3NjYWxlRmFjdG9yLnRvRml4ZWQoNCl9YCk7CgogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBsb2FkIEJsaXR6YmFsbCBtb2RlbDoiLCBlcnIpOwogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2s6IEtlZXAgcGxhY2Vob2xkZXIgYnV0IHRpbnQgaXQgcmVkIHRvIGluZGljYXRlIGVycm9yCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZhYWFhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyBCYWxsIExhYiByZXBsYXkgb3ZlcnJpZGUgKGxldHMgRGV2VG9vbHMgZHJpdmUgdGhlIGJhbGwgZGV0ZXJtaW5pc3RpY2FsbHkpCiAgICAgICAgICAgIGNvbnN0IF9fbGFiID0gd2luZG93LmZsdXggJiYgd2luZG93LmZsdXguYmFsbExhYjsKICAgICAgICAgICAgaWYgKF9fbGFiICYmIF9fbGFiLmlzUmVwbGF5aW5nICYmIF9fbGFiLnRhcmdldEJhbGwgPT09IHRoaXMgJiYgdHlwZW9mIF9fbGFiLmFwcGx5UmVwbGF5RnJhbWUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIF9fbGFiLmFwcGx5UmVwbGF5RnJhbWUodGhpcywgZHQpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMudHJhaWwpIHRoaXMudHJhaWwuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTYWZldHk6IFJlc2V0IGlmIHBvc2l0aW9uIGNvcnJ1cHRlZAogICAgICAgICAgICBpZiAoaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLngpIHx8IGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi55KSB8fCBpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueikpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXQoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKLy8gU2FmZXR5OiBGaXggIlVucGlja2FibGUgQmFsbCIgQnVnCiAgICAgICAgICAgIC8vIDEuIEludmFsaWQgQWN0b3IgQ2hlY2sKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdoZWxkJyAmJiAoIXRoaXMuaG9sZGVyIHx8ICF0aGlzLmhvbGRlci5tZXNoKSkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdtYWduZXRpemVkJykgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLm1hZ25ldFRhcmdldCB8fCAhdGhpcy5tYWduZXRUYXJnZXQubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gMi4gTWFnbmV0aXplIFRpbWVvdXQgKFByZXZlbnQgZ2V0dGluZyBzdHVjayBpbiBtaWQtYWlyKQogICAgICAgICAgICAgICAgaWYgKHRoaXMubWFnbmV0VGltZXIgPiAyLjApIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkJhbGwgc3R1Y2sgaW4gbWFnbmV0aXplZCBzdGF0ZS4gRHJvcHBpbmcuIik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIFN0YXRlIENvbnNpc3RlbmN5CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnZnJlZScgJiYgdGhpcy5ob2xkZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaG9sZGVyID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRmFpbHNhZmU6IElmIGJhbGwgaXMgZnJlZSBhbmQgc2xvdywgZW5zdXJlIGl0J3MgY2F0Y2hhYmxlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnZnJlZScgJiYgdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMC41KSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwOwogICAgICAgICAgICB9CmlmICh0aGlzLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAvLyBUcmFpbCBpcyBhY3RpdmUgaWYgYmFsbCBpcyBtb3ZpbmcgZmFzdCBhbmQgZnJlZQogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgdGhpcy50cmFpbC5hY3RpdmUgPSAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHNwZWVkID4gMi4wKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRml4OiBPZmZzZXQgdHJhaWwgdG8gbWF0Y2ggdmlzdWFsIG1vZGVsIHBvc2l0aW9uIChkZWZvcm1Ob2RlIG9mZnNldCkKICAgICAgICAgICAgICAgIF9iVmVjLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlZm9ybU5vZGUpIF9iVmVjLnkgKz0gdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnk7CgogICAgICAgICAgICAgICAgLy8gUGFzcyBzcGVlZCByYXRpbyAoMCB0byAxIGJhc2VkIG9uIG1heCBzcGVlZCBhcHByb3ggNjApCiAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHNwZWVkIC8gNjAuMCwgMS4wKTsKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwudXBkYXRlKF9iVmVjLCByYXRpbyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaGVsZCcgJiYgdGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVIZWxkKGR0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTWFnbmV0aXplZChkdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUZyZWUoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAppZiAodGhpcy5jYXRjaEdyYWNlUGVyaW9kID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5jYXRjaEdyYWNlUGVyaW9kIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA8IDApIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7CiAgICAgICAgICAgIH0KCnRoaXMudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTYWZldHk6IEVuc3VyZSB2aXNpYmlsaXR5IGlmIG5vdCBleHBsaWNpdGx5IGludmlzaWJsZQovLyBTYWZldHk6IEVuc3VyZSB2aXNpYmlsaXR5IGlmIG5vdCBleHBsaWNpdGx5IGludmlzaWJsZQogICAgICAgICAgICBpZiAodGhpcy5tZXNoICYmICF0aGlzLmlzSW52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBGb3JjZSBtb2RlbCB2aXNpYmlsaXR5IGlmIHByZXNlbnQgKHNvbWV0aW1lcyBHTFRGIGxvYWRlciBoaWRlcyBpdCkKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1vZGVsKSB0aGlzLm1vZGVsLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKbWFnbmV0aXplKHRhcmdldCkgewogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ21hZ25ldGl6ZWQnIHx8IHRoaXMuc3RhdGUgPT09ICdoZWxkJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtYWduZXRpemVkJzsKICAgICAgICAgICAgdGhpcy5tYWduZXRUYXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICAgIHRoaXMuaG9sZGVyID0gdGFyZ2V0OyAvLyBMb2dpY2FsIHBvc3Nlc3Npb24gc28gQUkgcmVhY3RzCiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1hZ25ldFN0YXJ0UG9zLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFZlbC5jb3B5KHRoaXMudmVsb2NpdHkpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRHluYW1pYyBEdXJhdGlvbiBiYXNlZCBvbiBkaXN0YW5jZSAoU21vb3RoZXIgZm9yIGxvbmcgcmFuZ2UsIHNuYXBweSBmb3IgY2xvc2UpCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIHRoaXMubWFnbmV0RHVyYXRpb24gPSBNYXRoLm1heCgwLjE1LCBNYXRoLm1pbigwLjQsIGRpc3QgLyAxNS4wKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBLaWxsIHBoeXNpY3MKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIE5vdGlmeSBwbGF5ZXIgaW1tZWRpYXRlbHkgc28gdGhleSBzdG9wIGNoYXNpbmcgYW5kIHBsYXkgYW5pbWF0aW9uCiAgICAgICAgICAgIGlmICh0YXJnZXQucmVjZWl2ZUJhbGwpIHsKICAgICAgICAgICAgICAgIHRhcmdldC5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnJldmVhbCgpOwogICAgICAgIH0KCnVwZGF0ZU1hZ25ldGl6ZWQoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1hZ25ldFRhcmdldCB8fCAhdGhpcy5tYWduZXRUYXJnZXQubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgKz0gZHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3JtYWxpemVkIFRpbWUKICAgICAgICAgICAgbGV0IHQgPSB0aGlzLm1hZ25ldFRpbWVyIC8gdGhpcy5tYWduZXREdXJhdGlvbjsKICAgICAgICAgICAgaWYgKHQgPiAxLjApIHQgPSAxLjA7CgogICAgICAgICAgICAvLyBUYXJnZXQgIlZpcnR1YWwgSGFuZCIgUG9zaXRpb24gKEZyb250IG9mIENoZXN0KQogICAgICAgICAgICBjb25zdCBob2xkZXJQb3MgPSB0aGlzLm1hZ25ldFRhcmdldC5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBob2xkZXJRdWF0ID0gdGhpcy5tYWduZXRUYXJnZXQubWVzaC5xdWF0ZXJuaW9uOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT2Zmc2V0OiBGb3J3YXJkIDAuNiwgVXAgMS4wIChDaGVzdCBoZWlnaHQpCiAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IF9iVmVjLnNldCgwLCAxLjAsIDAuNikuYXBwbHlRdWF0ZXJuaW9uKGhvbGRlclF1YXQpOwogICAgICAgICAgICBjb25zdCB0YXJnZXRQb3MgPSBvZmZzZXQuYWRkKGhvbGRlclBvcyk7CgogICAgICAgICAgICAvLyAtLS0gUVVBRFJBVElDIEJFWklFUiBDVVJWRSAtLS0KICAgICAgICAgICAgLy8gUDAgPSBTdGFydCwgUDIgPSBUYXJnZXQKICAgICAgICAgICAgLy8gUDEgPSBDb250cm9sIFBvaW50IChQcm9qZWN0ZWQgYWxvbmcgaW5pdGlhbCB2ZWxvY2l0eSB0byBwcmVzZXJ2ZSBtb21lbnR1bSBmZWVsKQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcDAgPSB0aGlzLm1hZ25ldFN0YXJ0UG9zOwogICAgICAgICAgICBjb25zdCBwMiA9IHRhcmdldFBvczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBQMSAoQ29udHJvbCBQb2ludCkKICAgICAgICAgICAgLy8gUHJvamVjdCBmb3J3YXJkIGZyb20gUDAgYWxvbmcgc3RhcnQgdmVsb2NpdHkgdmVjdG9yCiAgICAgICAgICAgIC8vIERpc3RhbmNlIG9mIHByb2plY3Rpb24gPSA0MCUgb2YgdG90YWwgZGlzdGFuY2UgdG8gdGFyZ2V0CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBwMC5kaXN0YW5jZVRvKHAyKTsKICAgICAgICAgICAgY29uc3QgcDEgPSBfdGVtcFZlYy5jb3B5KHAwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHZlbExlbiA9IHRoaXMubWFnbmV0U3RhcnRWZWwubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHZlbExlbiA+IDEuMCkgewogICAgICAgICAgICAgICAgLy8gVXNlIHZlbG9jaXR5IHRhbmdlbnQKLy8gVXNlIHZlbG9jaXR5IHRhbmdlbnQKICAgICAgICAgICAgICAgIF9iRGlyLmNvcHkodGhpcy5tYWduZXRTdGFydFZlbCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBwMS5hZGQoX2JEaXIubXVsdGlwbHlTY2FsYXIoZGlzdCAqIDAuNCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gTm8gdmVsb2NpdHkgKHN0YXRpb25hcnkgYmFsbCksIGFyYyB1cHdhcmRzIHNsaWdodGx5CiAgICAgICAgICAgICAgICBwMS5sZXJwKHAyLCAwLjUpOwogICAgICAgICAgICAgICAgcDEueSArPSAxLjU7IAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCZXppZXI6IEIodCkgPSAoMS10KV4yICogUDAgKyAyKDEtdCl0ICogUDEgKyB0XjIgKiBQMgogICAgICAgICAgICBjb25zdCBvbmVNaW51c1QgPSAxLjAgLSB0OwogICAgICAgICAgICBjb25zdCB3MCA9IG9uZU1pbnVzVCAqIG9uZU1pbnVzVDsKICAgICAgICAgICAgY29uc3QgdzEgPSAyLjAgKiBvbmVNaW51c1QgKiB0OwogICAgICAgICAgICBjb25zdCB3MiA9IHQgKiB0OwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnggPSAodzAgKiBwMC54KSArICh3MSAqIHAxLngpICsgKHcyICogcDIueCk7CiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gKHcwICogcDAueSkgKyAodzEgKiBwMS55KSArICh3MiAqIHAyLnkpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueiA9ICh3MCAqIHAwLnopICsgKHcxICogcDEueikgKyAodzIgKiBwMi56KTsKCiAgICAgICAgICAgIC8vIEZpbmlzaAogICAgICAgICAgICBpZiAodCA+PSAxLjApIHsKICAgICAgICAgICAgICAgIHRoaXMuZ3JhYih0aGlzLm1hZ25ldFRhcmdldCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGVIZWxkKGR0KSB7CiAgICAgICAgICAgIC8vIEFUVEFDSEVEIFNUQVRFIChWaXJ0dWFsIEF0dGFjaG1lbnQpCiAgICAgICAgICAgIGlmICghdGhpcy5ob2xkZXIgfHwgIXRoaXMuaG9sZGVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gMS4gVHJ5IHRvIHVzZSBIYW5kIEJvbmUgaWYgYXZhaWxhYmxlIChSZWFsaXNtKQogICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIuaGFuZEJvbmUpIHsKICAgICAgICAgICAgICAgIC8vIEdldCB3b3JsZCBwb3NpdGlvbiBvZiB0aGUgaGFuZCBib25lCiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlci5oYW5kQm9uZS5nZXRXb3JsZFBvc2l0aW9uKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEFkanVzdCBzbGlnaHRseSB0byBzaXQgSU4gdGhlIGhhbmQgcmF0aGVyIHRoYW4gT04gdGhlIHdyaXN0CiAgICAgICAgICAgICAgICAvLyBXZSBjYW4ndCBlYXNpbHkga25vdyAiZm9yd2FyZCIgZm9yIHRoZSBib25lIHdpdGhvdXQgbW9yZSBpbmZvLCAKICAgICAgICAgICAgICAgIC8vIGJ1dCB1c3VhbGx5IEdMVEYgYm9uZXMgYXJlIG9yaWVudGVkLiBGb3Igbm93LCBleGFjdCBib25lIHBvcyBpcyBiZXR0ZXIgdGhhbiBjaGVzdC4KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIDIuIEZhbGxiYWNrOiBDYWxjdWxhdGUgIkNhcnJ5aW5nIiBQb3NpdGlvbiAoUmlnaHQgSGFuZCBTaWRlKQogICAgICAgICAgICAgICAgLy8gUmVsYXRpdmUgdG8gcGxheWVyOiBVcCAwLjggKFdhaXN0L0NoZXN0KSwgUmlnaHQgMC40LCBGb3J3YXJkIDAuNQogICAgICAgICAgICAgICAgY29uc3QgaG9sZGVyUG9zID0gdGhpcy5ob2xkZXIubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGhvbGRlclF1YXQgPSB0aGlzLmhvbGRlci5tZXNoLnF1YXRlcm5pb247CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJldXNlIF9iVmVjCi8vIFJldXNlIF9iVmVjCiAgICAgICAgICAgICAgICAvLyBPZmZzZXQ6IHg9MC4zNSAoUmlnaHQpLCB5PTEuMyAoQ2hlc3QvSGFuZHMpLCB6PTAuNSAoRm9yd2FyZCkKICAgICAgICAgICAgICAgIF9iVmVjLnNldCgwLjM1LCAxLjMsIDAuNSkuYXBwbHlRdWF0ZXJuaW9uKGhvbGRlclF1YXQpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmNvcHkoaG9sZGVyUG9zKS5hZGQoX2JWZWMpOwogICAgICAgICAgICB9CgovLyBWaXN1YWwgRmxhaXI6IFNwaW4gdGhlIGJhbGwgc2xvd2x5CiAgICAgICAgICAgIGNvbnN0IHJvdFggPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUobmV3IFRIUkVFLlZlY3RvcjMoMSwwLDApLCAyICogZHQpOwogICAgICAgICAgICBjb25zdCByb3RZID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsMSwwKSwgNSAqIGR0KTsKICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uLm11bHRpcGx5KHJvdFgpLm11bHRpcGx5KHJvdFkpOwogICAgICAgIH0KCgp1cGRhdGVGcmVlKGR0KSB7CiAgICBjb25zdCBDID0gd2luZG93LmZsdXguQmFsbENvbmZpZyB8fCB7fTsKICAgIGNvbnN0IHN1YnN0ZXBzID0gTWF0aC5tYXgoMSwgTWF0aC5mbG9vcihDLlNVQlNURVBTIHx8IDEpKTsKICAgIGNvbnN0IHN0ZXBEdCA9IGR0IC8gc3Vic3RlcHM7CgogICAgLy8gLS0tIDEpIEludGVncmF0ZSBwaHlzaWNzIGluIHN1YnN0ZXBzIGZvciBzdGFiaWxpdHkgLS0tCiAgICBmb3IgKGxldCBzID0gMDsgcyA8IHN1YnN0ZXBzOyBzKyspIHsKICAgICAgICAvLyBBKSBNYWdudXMgZWZmZWN0IChjdXJ2ZSBmcm9tIHNwaW4pCiAgICAgICAgaWYgKEMuTUFHTlVTX0VOQUJMRUQgJiYgdGhpcy5hbmd1bGFyVmVsb2NpdHkgJiYgdGhpcy52ZWxvY2l0eSkgewogICAgICAgICAgICBjb25zdCBzcGluU3EgPSB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICBjb25zdCB2ZWxTcSA9IHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHNwaW5TcSA+IDAuMjUgJiYgdmVsU3EgPiAwLjI1KSB7CiAgICAgICAgICAgICAgICBfbWFnbnVzVmVjLmNvcHkodGhpcy5hbmd1bGFyVmVsb2NpdHkpLmNyb3NzKHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKChDLk1BR05VU19DT0VGRiB8fCAwKSAqIHN0ZXBEdCk7CgogICAgICAgICAgICAgICAgLy8gQ2FwIHRvIGF2b2lkIG51bWVyaWMgYmxvd3VwcwogICAgICAgICAgICAgICAgY29uc3QgY2FwID0gKEMuTUFHTlVTX0NBUCAhPT0gdW5kZWZpbmVkID8gQy5NQUdOVVNfQ0FQIDogNjAuMCk7CiAgICAgICAgICAgICAgICBjb25zdCBtYWdMZW4gPSBfbWFnbnVzVmVjLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgaWYgKG1hZ0xlbiA+IGNhcCkgX21hZ251c1ZlYy5tdWx0aXBseVNjYWxhcihjYXAgLyBtYWdMZW4pOwoKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKF9tYWdudXNWZWMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBCKSBTcGluIGRlY2F5CiAgICAgICAgaWYgKHRoaXMuYW5ndWxhclZlbG9jaXR5KSB7CiAgICAgICAgICAgIGNvbnN0IHNwaW5EcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gKEMuU1BJTl9EUkFHIHx8IDApICogc3RlcER0KTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoc3BpbkRyYWcpOwogICAgICAgIH0KCiAgICAgICAgLy8gQykgRGVwdGggc3ByaW5nIChrZWVwcyBiYWxsIG5lYXIgcGxhbmUpCiAgICAgICAgY29uc3QgdGFyZ2V0WSA9IChDLkRFUFRIX1RBUkdFVF9ZICE9PSB1bmRlZmluZWQgPyBDLkRFUFRIX1RBUkdFVF9ZIDogMC4wKTsKICAgICAgICBjb25zdCB5RXJyID0gKHRoaXMubWVzaC5wb3NpdGlvbi55IC0gdGFyZ2V0WSk7CiAgICAgICAgdGhpcy52ZWxvY2l0eS55IC09IHlFcnIgKiAoQy5ERVBUSF9TUFJJTkcgfHwgMCkgKiBzdGVwRHQ7CiAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IE1hdGgubWF4KDAsIDEuMCAtIChDLkRFUFRIX0RBTVAgfHwgMCkgKiBzdGVwRHQpOwoKICAgICAgICAvLyBEKSBBcHBseSBkcmFnIChsaW5lYXIgKyBxdWFkcmF0aWMpCiAgICAgICAgY29uc3QgdkxlbiA9IHRoaXMudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgaWYgKHZMZW4gPiAwLjAwMDAxKSB7CiAgICAgICAgICAgIGNvbnN0IGxpbiA9IChDLldBVEVSX0RSQUdfTElORUFSICE9PSB1bmRlZmluZWQgPyBDLldBVEVSX0RSQUdfTElORUFSIDogKEMuV0FURVJfRFJBRyB8fCAwKSkgKiBzdGVwRHQ7CiAgICAgICAgICAgIGNvbnN0IHF1YWQgPSAoQy5XQVRFUl9EUkFHX1FVQUQgfHwgMCkgKiB2TGVuICogc3RlcER0OwogICAgICAgICAgICBjb25zdCBkcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gbGluIC0gcXVhZCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoZHJhZyk7CgogICAgICAgICAgICBjb25zdCBzdG9wID0gKEMuU1RPUF9TUEVFRCB8fCAwKTsKICAgICAgICAgICAgaWYgKHN0b3AgPiAwICYmIHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKSA8IHN0b3AgKiBzdG9wKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRSkgTW92ZQogICAgICAgIF90ZW1wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoc3RlcER0KTsKICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF90ZW1wVmVjKTsKCiAgICAgICAgLy8gRikgU3RhdCBwb3dlciBkZWNheSAoZ2FtZSBsb2dpYykKICAgICAgICBpZiAodGhpcy5wb3dlciA+IDApIHsKICAgICAgICAgICAgdGhpcy5wb3dlciAtPSB0aGlzLmRlY2F5UmF0ZSAqIHN0ZXBEdDsKICAgICAgICAgICAgaWYgKHRoaXMucG93ZXIgPCAwKSB0aGlzLnBvd2VyID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIEcpIEJvdW5kYXJ5IGxvZ2ljIChzb2Z0IHdhbGwgKyBjbGFtcCkKICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1lc2gucG9zaXRpb247CiAgICAgICAgY29uc3QgZGlzdFhaID0gTWF0aC5zcXJ0KHBvcy54ICogcG9zLnggKyBwb3MueiAqIHBvcy56KTsKCiAgICAgICAgY29uc3QgYm91bmRhcnlSYWRpdXMgPSAoQy5CT1VOREFSWV9SQURJVVMgIT09IHVuZGVmaW5lZCA/IEMuQk9VTkRBUllfUkFESVVTIDogMzMuMCk7CiAgICAgICAgbGV0IGVmZmVjdGl2ZUJvdW5kYXJ5ID0gYm91bmRhcnlSYWRpdXM7CgogICAgICAgIGlmIChDLkdPQUxfUE9DS0VUX0VOQUJMRUQpIHsKICAgICAgICAgICAgY29uc3QgaW5Hb2FsUG9ja2V0ID0gKE1hdGguYWJzKHBvcy54KSA8IChDLkdPQUxfUE9DS0VUX1ggfHwgMTIuMCkgJiYgTWF0aC5hYnMocG9zLnopID4gKEMuR09BTF9QT0NLRVRfWiB8fCAyNS4wKSk7CiAgICAgICAgICAgIGlmIChpbkdvYWxQb2NrZXQpIGVmZmVjdGl2ZUJvdW5kYXJ5ID0gKEMuR09BTF9QT0NLRVRfUkFESVVTIHx8IDQ1LjApOwogICAgICAgIH0KCiAgICAgICAgY29uc3Qgc29mdEJ1ZmZlciA9IE1hdGgubWF4KDAuMDEsIChDLldBTExfU09GVF9CVUZGRVIgIT09IHVuZGVmaW5lZCA/IEMuV0FMTF9TT0ZUX0JVRkZFUiA6IDMuMCkpOwoKICAgICAgICAvLyBTb2Z0IHJlcHVsc2lvbiAoY3VydmVzIHRyYWplY3RvcnkgbmVhciB3YWxsIGluc3RlYWQgb2YgcGluZy1wb25nKQogICAgICAgIGlmIChkaXN0WFogPiBlZmZlY3RpdmVCb3VuZGFyeSAtIHNvZnRCdWZmZXIpIHsKICAgICAgICAgICAgY29uc3QgcGVuZXRyYXRpb24gPSBkaXN0WFogLSAoZWZmZWN0aXZlQm91bmRhcnkgLSBzb2Z0QnVmZmVyKTsKICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBwZW5ldHJhdGlvbiAvIHNvZnRCdWZmZXIpKTsKCiAgICAgICAgICAgIF90ZW1wVmVjLnNldCgtcG9zLngsIDAsIC1wb3Mueik7CiAgICAgICAgICAgIGlmIChfdGVtcFZlYy5sZW5ndGhTcSgpID4gMC4wMDAxKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYy5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gcmF0aW8gKiByYXRpbyAqIChDLldBTExfU09GVF9GT1JDRSB8fCAwKSAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjLCBmb3JjZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEhhcmQgY2xhbXAgaWYgaXQgc3RpbGwgaGl0cwogICAgICAgIGlmIChkaXN0WFogPiBlZmZlY3RpdmVCb3VuZGFyeSkgewogICAgICAgICAgICBfdGVtcFZlYy5zZXQoLXBvcy54LCAwLCAtcG9zLnopOwogICAgICAgICAgICBpZiAoX3RlbXBWZWMubGVuZ3RoU3EoKSA+IDAuMDAwMSkgX3RlbXBWZWMubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBvdmVybGFwID0gZGlzdFhaIC0gZWZmZWN0aXZlQm91bmRhcnk7CiAgICAgICAgICAgIHBvcy5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMsIG92ZXJsYXApOwoKY29uc3QgdkRvdE4gPSB0aGlzLnZlbG9jaXR5LmRvdChfdGVtcFZlYyk7CgogICAgICAgICAgICAvLyBPbmx5IGFkanVzdCBpZiBtb3Zpbmcgb3V0d2FyZCAoYWdhaW5zdCBpbndhcmQgbm9ybWFsKQogICAgICAgICAgICBpZiAodkRvdE4gPCAwKSB7CiAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIEFyZW5hIERlZm9ybWF0aW9uIGlmIGltcGFjdCBpcyBmb3JjZWZ1bAogICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0U3BlZWQgPSBNYXRoLmFicyh2RG90Tik7CiAgICAgICAgICAgICAgICBpZiAoaW1wYWN0U3BlZWQgPiAxMC4wICYmIHdpbmRvdy5mbHV4LnRyaWdnZXJBcmVuYUltcGFjdCkgewogICAgICAgICAgICAgICAgICAgIC8vIFBhc3MgdGhlIGNvbnRhY3QgcG9pbnQgKHBvcykgYW5kIHN0cmVuZ3RoIGJhc2VkIG9uIHNwZWVkCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KHBvcywgTWF0aC5taW4oaW1wYWN0U3BlZWQgKiAwLjUsIDE1LjApKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBlID0gKEMuV0FMTF9FTEFTVElDSVRZICE9PSB1bmRlZmluZWQgPyBDLldBTExfRUxBU1RJQ0lUWSA6IDAuMyk7CiAgICAgICAgICAgICAgICBjb25zdCBpbXB1bHNlID0gX3RlbXBWZWMuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtdkRvdE4gKiAoMS4wICsgZSkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5hZGQoaW1wdWxzZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRhbmdlbnRpYWwgZnJpY3Rpb24KICAgICAgICAgICAgICAgIGNvbnN0IGZyaWN0aW9uID0gKEMuV0FMTF9GUklDVElPTiAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX0ZSSUNUSU9OIDogMC45NSk7CiAgICAgICAgICAgICAgICBjb25zdCB0YW5nZW50ID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLnByb2plY3RPblBsYW5lKF90ZW1wVmVjKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc3ViKHRhbmdlbnQubXVsdGlwbHlTY2FsYXIoMS4wIC0gZnJpY3Rpb24pKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQ2VpbGluZy9GbG9vciBjbGFtcAogICAgICAgIGNvbnN0IGJoID0gKEMuQk9VTkRBUllfSEVJR0hUICE9PSB1bmRlZmluZWQgPyBDLkJPVU5EQVJZX0hFSUdIVCA6IDE1LjApOwogICAgICAgIGlmIChNYXRoLmFicyhwb3MueSkgPiBiaCkgewogICAgICAgICAgICBjb25zdCBzaWduID0gTWF0aC5zaWduKHBvcy55KSB8fCAxOwogICAgICAgICAgICBwb3MueSA9IGJoICogc2lnbjsKICAgICAgICAgICAgY29uc3QgZmUgPSAoQy5GTE9PUl9FTEFTVElDSVRZICE9PSB1bmRlZmluZWQgPyBDLkZMT09SX0VMQVNUSUNJVFkgOiAwLjQpOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLWZlOwp9CiAgICB9CgogICAgLy8gLS0tIDIpIEZYIHRoYXQgc2hvdWxkIHJ1biBvbmNlIHBlciBmcmFtZSAobm90IHBlciBzdWJzdGVwKSAtLS0KICAgIGlmICghdGhpcy5fZ2hvc3QpIHsKICAgICAgICBjb25zdCBzcGVlZFNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgIGlmIChzcGVlZFNxID4gMi4wICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5fYnViYmxlVGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgY29uc3QgcG0gPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKC0wLjgpOwoKICAgICAgICAgICAgICAgIC8vIFN0YW5kYXJkIGJ1YmJsZQovLyBTdGFuZGFyZCBidWJibGUKICAgICAgICAgICAgICAgIGNvbnN0IHN0ZFBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLmFkZChfYkRpci5zZXQoKE1hdGgucmFuZG9tKCktMC41KSowLjMsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4zLCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuMykpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3RkUG9zLnkgKz0gdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlJywgc3RkUG9zLCB7IHNjYWxlOiAwLjQgKyBNYXRoLnJhbmRvbSgpICogMC40IH0pOyAvLyBJbmNyZWFzZWQgc2NhbGUKCiAgICAgICAgICAgICAgICAvLyBNaWNybyBidWJibGVzIGF0IGhpZ2ggc3BlZWQKICAgICAgICAgICAgICAgIGlmIChzcGVlZFNxID4gNTAuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gTWF0aC5taW4oNCwgTWF0aC5mbG9vcihzcGVlZFNxIC8gNjApKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKY29uc3Qgaml0dGVyID0gX2JEaXIuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC40LCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuNCwgKE1hdGgucmFuZG9tKCktMC41KSowLjQpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGF3blBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLmFkZChqaXR0ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWZvcm1Ob2RlKSBzcGF3blBvcy55ICs9IHRoaXMuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgICAgICBwbS5zcGF3bignYnViYmxlX21pY3JvJywgc3Bhd25Qb3MsIHsgc2NhbGU6IDAuMDUgKyBNYXRoLnJhbmRvbSgpICogMC4xIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDAuMDI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gMC41KSB7CmNvbnN0IGppdHRlciA9IF9iRGlyLnNldCgoTWF0aC5yYW5kb20oKS0wLjUpKjAuMiwgKE1hdGgucmFuZG9tKCktMC41KSowLjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3Bhd25Qb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQob2Zmc2V0KS5hZGQoaml0dGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3Bhd25Qb3MueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIHNwYXduUG9zLCB7IHNjYWxlOiAwLjA0ICsgTWF0aC5yYW5kb20oKSAqIDAuMDYgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4wNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLyAtLS0gMykgVmlzdWFsIHJvdGF0aW9uIC0tLQogICAgY29uc3Qgc3BpblNwZWVkID0gdGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCk7CiAgICBpZiAoc3BpblNwZWVkID4gMC41KSB7CiAgICAgICAgY29uc3QgYXhpcyA9IF90ZW1wVmVjLmNvcHkodGhpcy5hbmd1bGFyVmVsb2NpdHkpLm5vcm1hbGl6ZSgpOwogICAgICAgIGNvbnN0IHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUoYXhpcywgc3BpblNwZWVkICogZHQpOwogICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5wcmVtdWx0aXBseShxKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgIGlmIChzcGVlZCA+IDAuMSkgewogICAgICAgICAgICBfdGVtcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLmNyb3NzKF9heGlzWSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIGlmIChfdGVtcFZlYy5sZW5ndGhTcSgpID4gMC4wMSkgewogICAgICAgICAgICAgICAgY29uc3QgcSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShfdGVtcFZlYywgc3BlZWQgKiBkdCk7CiAgICAgICAgICAgICAgICB0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24ucHJlbXVsdGlwbHkocSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCmdyYWIocGxheWVyKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50OiBQb3NzZXNzaW9uIChpZiB0YWtpbmcgZnJvbSBmcmVlIHN0YXRlKQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCgiUE9TU0VTU0lPTiIsICJub3JtYWwiKTsKICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIFR1cm5vdmVyIChQb3NzZXNzaW9uIENoYW5nZSkKICAgICAgICAgICAgY29uc3QgcHJldmlvdXNUZWFtID0gdGhpcy5ob2xkZXIgPyB0aGlzLmhvbGRlci50ZWFtIDogKHRoaXMubGFzdEhvbGRlciA/IHRoaXMubGFzdEhvbGRlci50ZWFtIDogbnVsbCk7CiAgICAgICAgICAgIGlmIChwcmV2aW91c1RlYW0gJiYgcHJldmlvdXNUZWFtICE9PSBwbGF5ZXIudGVhbSkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJUVVJOT1ZFUiIsIHBsYXllci5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgc29tZW9uZSBlbHNlIGhlbGQgaXQsIHRoZXkgbG9zZSBpdAogICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIgIT09IHBsYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIubG9zZUJhbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBwbGF5ZXI7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaGVsZCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOT1RFOiBXZSBkbyBOT1QgcGFyZW50IHRoZSBtZXNoIHRvIHRoZSBwbGF5ZXIgYW55bW9yZS4KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyB0aGUgYmFsbCBmcm9tIGZseWluZyBhcm91bmQgZHVlIHRvIHN3aW0gYW5pbWF0aW9ucy4KICAgICAgICAgICAgLy8gSW5zdGVhZCwgd2UgdXBkYXRlIGl0cyBwb3NpdGlvbiBtYW51YWxseSBpbiB1cGRhdGVIZWxkKCkuCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3RpZnkgcGxheWVyCiAgICAgICAgICAgIGlmIChwbGF5ZXIucmVjZWl2ZUJhbGwpIHsKICAgICAgICAgICAgICAgIHBsYXllci5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zb2xlLmxvZygiQmFsbCBncmFiYmVkIGJ5ICIgKyBwbGF5ZXIucm9sZSk7CiAgICAgICAgfQoKICAgICAgICBkcm9wKCkgewogICAgICAgICAgICB0aGlzLnJldmVhbCgpOyAvLyBFbnN1cmUgdmlzaWJsZQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm8gbmVlZCB0byBkZXRhY2ggZnJvbSBzY2VuZSBncmFwaCBzaW5jZSB3ZSBhcmVuJ3QgcGFyZW50aW5nIHRvIHBsYXllciBhbnltb3JlLgogICAgICAgICAgICAvLyBKdXN0IGNsZWFyIGhvbGRlci4KCiAgICAgICAgICAgIGlmICh0aGlzLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmxvc2VCYWxsKSB0aGlzLmhvbGRlci5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIH0KLy8gU2hvb3QvUGFzcwovLyBTaG9vdC9QYXNzCiAgICAgICAgc2hvb3QoZGlyZWN0aW9uVmVjdG9yLCBmb3JjZSwgdHlwZSA9ICdTSCcsIHRlY2huaXF1ZSA9IG51bGwsIHNwaW5WZWN0b3IgPSBudWxsKSB7CgogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSB0aGlzLmhvbGRlcjsgLy8gUmVjb3JkIGZvciBFWFAgYXR0cmlidXRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZ1bWJsZSBEZXRlY3Rpb24gKFR5cGUgJ25vbmUnIGlzIHVzZWQgYnkgUGxheWVyLmZ1bWJsZSkKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdub25lJykgewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KCJGVU1CTEUhIiwgInNsYW0iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5kcm9wKCk7IC8vIERldGFjaCBmaXJzdAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0IEdyYWNlIFBlcmlvZCB0byBwcmV2ZW50IGluc3RhbnQgaW50ZXJjZXB0aW9ucy9jYXRjaGVzCiAgICAgICAgICAgIC8vIDAuMnMgYWxsb3dzIGJhbGwgdG8gY2xlYXIgdGhlIHRocm93ZXIncyBpbW1lZGlhdGUgdmljaW5pdHkKICAgICAgICAgICAgdGhpcy5jYXRjaEdyYWNlUGVyaW9kID0gMC4yOwoKICAgICAgICAgICAgLy8gUGh5c2ljYWwgVmVsb2NpdHkgKFZpc3VhbCBzcGVlZCkKICAgICAgICAgICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcgfHwge307CiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKEMuTEFVTkNIX1NQRUVEX1NDQUxFICE9PSB1bmRlZmluZWQgPyBDLkxBVU5DSF9TUEVFRF9TQ0FMRSA6IDEuMCk7CiAgICAgICAgICAgIGNvbnN0IGNhcCA9IChDLkxBVU5DSF9TUEVFRF9DQVAgIT09IHVuZGVmaW5lZCA/IEMuTEFVTkNIX1NQRUVEX0NBUCA6IDg1LjApOwogICAgICAgICAgICBjb25zdCBzcGVlZCA9IE1hdGgubWluKGZvcmNlICogc2NhbGUsIGNhcCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuY29weShkaXJlY3Rpb25WZWN0b3IpLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKHNwZWVkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IFNwaW4gaWYgcHJvdmlkZWQKICAgICAgICAgICAgaWYgKHNwaW5WZWN0b3IpIHsKICAgICAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LmNvcHkoc3BpblZlY3Rvcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN0YXQgUG93ZXIgKEdhbWUgTG9naWMpCiAgICAgICAgICAgIHRoaXMucG93ZXIgPSBmb3JjZTsKICAgICAgICAgICAgdGhpcy5wb3dlclR5cGUgPSB0eXBlOwogICAgICAgICAgICB0aGlzLnRlY2huaXF1ZSA9IHRlY2huaXF1ZTsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVHJhaWwgQ29sb3IKICAgICAgICAgICAgaWYgKHRoaXMudHJhaWwpIHsKICAgICAgICAgICAgICAgIGxldCBjb2xvciA9IDB4MDBhYWZmOyAvLyBEZWZhdWx0IEJsdWUgKFBhc3MpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZWNobmlxdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICd2ZW5vbScpIGNvbG9yID0gMHgwMGZmMDA7IC8vIEdyZWVuIChWZW5vbSkKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ3dpdGhlcicpIGNvbG9yID0gMHg4ODg4ODg7IC8vIEdyZXkKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ25hcCcpIGNvbG9yID0gMHgwMDAwODg7IC8vIERhcmsgQmx1ZQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnc3BoZXJlJykgY29sb3IgPSAweDAwZmZmZjsgLy8gQ3lhbgogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnamVjaHQnKSBjb2xvciA9IDB4ZmYwMDAwOyAvLyBSZWQKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIGNvbG9yID0gMHg0NDQ0NDQ7IC8vIERhcmsgR3JleQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgPSAweGZmNDQwMDsgLy8gT3JhbmdlL1JlZAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLnRyYWlsLnNldENvbG9yKGNvbG9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGFuZGxlIEludmlzaWJsZSBTaG90CiAgICAgICAgICAgIGlmICh0ZWNobmlxdWUgJiYgdGVjaG5pcXVlLnR5cGUgPT09ICdpbnZpc2libGUnKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzSW52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBGWDogUG9vZgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignd2l0aGVyJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAyLjAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiSW52aXNpYmxlIFNob3QhIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCYWxsICR7dHlwZX0gd2l0aCBQb3dlcjogJHt0aGlzLnBvd2VyLnRvRml4ZWQoMSl9IFNwaW46ICR7dGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkudG9GaXhlZCgxKX1gKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjayBmb3IgQ3VydmUKICAgICAgICAgICAgaWYgKHRoaXMuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aCgpID4gMTUuMCAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQ1VSVkUhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXZlYWwoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzSW52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICAvLyBGWDogUmV2ZWFsIFBvb2YKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlciAmJiB0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCd3aXRoZXInLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlzSW52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICB9CgovLyBEdXBsaWNhdGUgcmV2ZWFsIHJlbW92ZWQKICAgICAgICAKcmVzZXQoKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7CiAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwOwogICAgICAgICAgICB0aGlzLnBvd2VyID0gMDsKICAgICAgICB9CmlzQ2F0Y2hhYmxlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jYXRjaEdyYWNlUGVyaW9kIDw9IDA7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWxzKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5kZWZvcm1Ob2RlIHx8ICF0aGlzLnNwaW5Ob2RlKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBTcXVhc2ggJiBTdHJldGNoIGJhc2VkIG9uIHZlbG9jaXR5Ci8vIDEuIFNxdWFzaCAmIFN0cmV0Y2ggYmFzZWQgb24gdmVsb2NpdHkKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT25seSBhcHBseSBzdHJldGNoIGlmIG1vdmluZyBmYXN0IGVub3VnaAogICAgICAgICAgICBpZiAoc3BlZWQgPiAxLjAgJiYgdGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAvLyBPcmllbnQgZGVmb3JtTm9kZSB0byB2ZWxvY2l0eSBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgZm9yd2FyZCBpcyBaICgwLDAsMSkKICAgICAgICAgICAgICAgIHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLnNldEZyb21Vbml0VmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLDAsMSksIGRpcik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBzdHJldGNoIGZhY3RvcgogICAgICAgICAgICAgICAgLy8gTWF4IHN0cmV0Y2ggYXQgc3BlZWQgNDAgKGFwcHJveCBtYXggc2hvdCBwb3dlcikKICAgICAgICAgICAgICAgIGNvbnN0IGZhY3RvciA9IE1hdGgubWluKHNwZWVkIC8gNDAuMCwgMS4wKTsgCiAgICAgICAgICAgICAgICBjb25zdCBzdHJldGNoID0gMS4wICsgKGZhY3RvciAqIDAuOCk7IC8vIEluY3JlYXNlZCBzdHJldGNoIG1heCB0byAxLjh4CiAgICAgICAgICAgICAgICBjb25zdCBzcXVhc2ggPSAxLjAgLyBNYXRoLnNxcnQoc3RyZXRjaCk7IC8vIE1haW50YWluIHZvbHVtZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUuc2NhbGUuc2V0KHNxdWFzaCwgc3F1YXNoLCBzdHJldGNoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFJlc2V0IGRlZm9ybWF0aW9uCiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUucXVhdGVybmlvbi5pZGVudGl0eSgpOwogICAgICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnNjYWxlLnNldCgxLCAxLCAxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gQXBwbHkgQWNjdW11bGF0ZWQgU3BpbgogICAgICAgICAgICAvLyBTaW5jZSBkZWZvcm1Ob2RlIG1pZ2h0IGJlIHJvdGF0ZWQsIHdlIG5lZWQgdG8gYXBwbHkgc3BpbiBpbiB0aGUgY29ycmVjdCBzcGFjZS4KICAgICAgICAgICAgLy8gc3Bpbk5vZGUgcm90YXRpb24gPSBkZWZvcm1Ob2RlX2ludmVyc2UgKiBhY2N1bXVsYXRlZFJvdGF0aW9uCmNvbnN0IGludkRlZm9ybSA9IHRoaXMuZGVmb3JtTm9kZS5xdWF0ZXJuaW9uLmNsb25lKCkuaW52ZXJ0KCk7CiAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucXVhdGVybmlvbi5jb3B5KGludkRlZm9ybS5tdWx0aXBseSh0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24pKTsKICAgICAgICB9CiAgICB9Cgp3aW5kb3cuZmx1eC5CYWxsID0gQmFsbDsKICAgIHdpbmRvdy5mbHV4LlRyYWlsUmVuZGVyZXIgPSBUcmFpbFJlbmRlcmVyOwp9KSgpOw==","GameManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFNwYXJrIFRleHR1cmUgKFByb2NlZHVyYWwgQnVyc3QpCiAgICBjb25zdCBfc3BhcmtUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw2NCw2NCk7CiAgICAgICAgCiAgICAgICAgLy8gQnVyc3Qgc2hhcGUKICAgICAgICBjb25zdCBjeCA9IDMyLCBjeSA9IDMyOwogICAgICAgIGNvbnN0IHNwaWtlcyA9IDg7CiAgICAgICAgY29uc3Qgb3V0ZXIgPSAzMDsKICAgICAgICBjb25zdCBpbm5lciA9IDEwOwogICAgICAgIAogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBmb3IobGV0IGk9MDsgaTxzcGlrZXMqMjsgaSsrKXsKICAgICAgICAgICAgY29uc3QgciA9IChpJTI9PT0wKT8gb3V0ZXIgOiBpbm5lcjsKICAgICAgICAgICAgY29uc3QgYSA9IChNYXRoLlBJKmkpL3NwaWtlczsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKnIsIGN5ICsgTWF0aC5zaW4oYSkqcik7CiAgICAgICAgfQogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmNjMDAnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgLy8gV2hpdGUgQ29yZQogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHguYXJjKGN4LCBjeSwgOCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjb25zdCBfc3BhcmtNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IAogICAgICAgIG1hcDogX3NwYXJrVGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBHYW1lTWFuYWdlciB7CgogICAgICAgIApjb25zdHJ1Y3RvcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEsIHJlbmRlcmVyKSB7CndpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIgPSByZW5kZXJlcjsgLy8gU3RvcmUgcmVuZGVyZXIKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmNhbWVyYSA9IGNhbWVyYTsKICAgICAgICAgICAgdGhpcy51aUxheWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodWlMYXllcklkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc2NvcmUgPSB7IGhvbWU6IDAsIGF3YXk6IDAgfTsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5oYWxmID0gMTsKICAgICAgICAgICAgdGhpcy5oYWxmRHVyYXRpb24gPSAzMDA7IC8vIDUgbWludXRlcyAoc2Vjb25kcykKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNEZW1vTW9kZSA9IGZhbHNlOwp0aGlzLmdhbWVNb2RlID0gJ25vcm1hbCc7IC8vICdub3JtYWwnIG9yICdwcmFjdGljZScKICAgICAgICAgICAgdGhpcy5pc0ZvcmdlTW9kZSA9IGZhbHNlOyAvLyBBc3NldCBGb3JnZSBTdGF0ZQogICAgICAgICAgICAvLyBJbXBhY3QgRnJhbWVzCiAgICAgICAgICAgIHRoaXMuaW1wYWN0UGF1c2UgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsgLy8gU3RhcnQgaW4gbWVudQp0aGlzLnRlYW1zID0gewogICAgICAgICAgICAgICAgaG9tZTogbnVsbCwKICAgICAgICAgICAgICAgIGF3YXk6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZW50aXRpZXMgPSB7CiAgICAgICAgICAgICAgICBiYWxsOiBudWxsCiAgICAgICAgICAgIH07Cgp0aGlzLnVpID0gewogICAgICAgICAgICAgICAgc2NvcmVQbGF5ZXI6IG51bGwsCiAgICAgICAgICAgICAgICBzY29yZUNwdTogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWVyOiBudWxsLAogICAgICAgICAgICAgICAgaGFsZjogbnVsbCwKICAgICAgICAgICAgICAgIGFubm91bmNlbWVudDogbnVsbCwKICAgICAgICAgICAgICAgIC8vIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgICAgIHN0YXR1c1BhbmVsOiB7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyOiBudWxsLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBCYXI6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBUZXh0OiBudWxsLAogICAgICAgICAgICAgICAgICAgIGV4cEJhcjogbnVsbAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVGVjaGNvcHkgU3RhdGUKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHRpbWVyOiAwLAogICAgICAgICAgICAgICAgdGVjaDogbnVsbCwKICAgICAgICAgICAgICAgIGxlYXJuZXJzOiBbXQogICAgICAgICAgICB9OwoKdGhpcy5taW5pTWFwID0gbmV3IHdpbmRvdy5mbHV4Lk1pbmlNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgRmxvYXRpbmcgVGV4dAovLyBJbml0aWFsaXplIEZsb2F0aW5nIFRleHQKdGhpcy5mbG9hdGluZ1RleHQgPSBuZXcgd2luZG93LmZsdXguRmxvYXRpbmdUZXh0TWFuYWdlcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBVSSBjYWxjdWxhdGlvbnMKICAgICAgICAgICAgdGhpcy5fdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIFBhcnRpY2xlIE1hbmFnZXIgKFN0YXR1cyBFZmZlY3RzKQogICAgICAgICAgICAKLy8gSW5pdGlhbGl6ZSBQYXJ0aWNsZSBNYW5hZ2VyIChTdGF0dXMgRWZmZWN0cykKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyKHNjZW5lKTsKdGhpcy5nbHlwaE1hbmFnZXIgPSBudWxsOyAvLyBJbmplY3RlZCBieSBtYWluLmpzCiAgICAgICAgICAgIHRoaXMuX2luaXRQYXJ0aWNsZXMoKTsgLy8gM0QgU3BhcmsgU3lzdGVtIChMZWdhY3kvSW1wYWN0KQoKdGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIgPSBuZXcgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyKHNjZW5lKTsKICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyKHRoaXMpOyAvLyBJbml0aWFsaXplIFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgdGhpcy5faW5qZWN0U3R5bGVzKCk7CnRoaXMuX2luaXRVSSgpOwogICAgICAgIH0KCl9pbml0Q2luZW1hdGljcygpIHsKICAgICAgICAgICAgdGhpcy5tZW51U2hvdEluZGV4ID0gMDsKICAgICAgICAgICAgdGhpcy5tZW51U2hvdFRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5tZW51U2hvdHMgPSBbCiAgICAgICAgICAgICAgICAvLyAxLiAiVGhlIEFyZW5hIiAtIFdpZGUgRXN0YWJsaXNoaW5nIFNob3QgKFNsb3cgZG9sbHkgaW4pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDEwLjAsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoNjAsIDM1LCA2MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAyID0gbmV3IFRIUkVFLlZlY3RvcjMoNDAsIDI1LCA0MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNtb290aHN0ZXAgaW50ZXJwb2xhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdCA9IHQgKiB0ICogKDMgLSAyICogdCk7IAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCBzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIDIuICJUaGUgVGVhbSIgLSBUcmFja2luZyBTaG90IGFsb25nIHRoZSBmb3JtYXRpb24KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogOC4wLAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBNb3ZlIGFsb25nIHRoZSBzaWRlIG9mIHRoZSBob21lIHRlYW0gZm9ybWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHpTdGFydCA9IC0yNTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgekVuZCA9IDI1OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50WiA9IHpTdGFydCArICh6RW5kIC0gelN0YXJ0KSAqIHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24uc2V0KC0yNSwgNiwgY3VycmVudFopOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KDAsIDIsIGN1cnJlbnRaICogMC44KTsgLy8gTG9vayBzbGlnaHRseSBhaGVhZCBvZiBjZW50ZXIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gMy4gIlRoZSBTdHJpa2VyIiAtIENsb3NlIHVwIG9yYml0IG9uIGEga2V5IHBvc2l0aW9uCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDguMCwKICAgICAgICAgICAgICAgICAgICB1cGRhdGU6ICh0LCBjYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9jdXMgb24gd2hlcmUgdGhlIExGL1JGIHVzdWFsbHkgc3RhbmRzIChhcHByb3ggKy8tIDEwLCAtMTApCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IG5ldyBUSFJFRS5WZWN0b3IzKC0xMCwgMCwgLTEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSB0ICogMS4wICsgMy41OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gMTAuMDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5wb3NpdGlvbi5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQueCArIE1hdGguY29zKGFuZ2xlKSAqIGRpc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQueSArIDQuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC56ICsgTWF0aC5zaW4oYW5nbGUpICogZGlzdAogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KHRhcmdldC54LCB0YXJnZXQueSArIDEuNSwgdGFyZ2V0LnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyA0LiAiVGhlIEdvYWwiIC0gTG93IEFuZ2xlIGxvb2tpbmcgdXAgYXQgdGhlIG5ldAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiA3LjAsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgLTUsIDMyKTsgLy8gTG93IG5lYXIgZ29hbAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwMiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDgsIDIwKTsgIC8vIFJpc2luZyB1cAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdCgwLCAxNSwgNDUpOyAvLyBMb29rIHVwIGF0IHRoZSBzdHJ1Y3R1cmUKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnJvdGF0aW9uLnogPSAodCAtIDAuNSkgKiAwLjE1OyAvLyBTbGlnaHQgY2luZW1hdGljIHRpbHQKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gNS4gIlRoZSBEaXZlIiAtIFZlcnRpY2FsIGRyb3AgaW50byB0aGUgcG9vbAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiA4LjAsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgNTAsIDApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwMiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEwLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3QgPSB0ICogdCAqICgzIC0gMiAqIHQpOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCBzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5yb3RhdGlvbi56ID0gdCAqIDAuODsgLy8gU3BpcmFsIGRvd24KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9Cl07CiAgICAgICAgfQoKICAgICAgICBfaW5qZWN0U3R5bGVzKCkgewogICAgICAgICAgICBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZsdXgtZHluYW1pYy1zdHlsZXMnKSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgICAgICAgICAgIHN0eWxlLmlkID0gJ2ZsdXgtZHluYW1pYy1zdHlsZXMnOwpzdHlsZS50ZXh0Q29udGVudCA9IGAKICAgICAgICAgICAgICAgIEBrZXlmcmFtZXMgdGV4dFNsYW0gewogICAgICAgICAgICAgICAgICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoNCk7IG9wYWNpdHk6IDA7IGxldHRlci1zcGFjaW5nOiA1MHB4OyB9CiAgICAgICAgICAgICAgICAgICAgMTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IG9wYWNpdHk6IDE7IGxldHRlci1zcGFjaW5nOiA1cHg7IH0KICAgICAgICAgICAgICAgICAgICAxNSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjEpOyB9CiAgICAgICAgICAgICAgICAgICAgMjAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IH0KICAgICAgICAgICAgICAgICAgICA4MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxKTsgb3BhY2l0eTogMTsgZmlsdGVyOiBibHVyKDBweCk7IH0KICAgICAgICAgICAgICAgICAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS41KTsgb3BhY2l0eTogMDsgZmlsdGVyOiBibHVyKDEwcHgpOyB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC5hbm5vdW5jZW1lbnQtc2xhbSB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICAgICAgICAgIHRvcDogNDUlOyBsZWZ0OiA1MCU7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDEwMCU7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnSW1wYWN0Jywgc2Fucy1zZXJpZjsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDk2cHg7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgICAgICAgICAgICAgICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZmZmZiAwJSwgI2ZmZGQwMCA0NSUsICNmZjg4MDAgMTAwJSk7CiAgICAgICAgICAgICAgICAgICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAgICAgICAgICAgICAgICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgICAgICAgICAgICAgICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggcmdiYSgwLDAsMCwxKSkgZHJvcC1zaGFkb3coMCAwIDMwcHggcmdiYSgyNTUsIDEwMCwgMCwgMC42KSk7CiAgICAgICAgICAgICAgICAgICAgei1pbmRleDogMjAwMDsKICAgICAgICAgICAgICAgICAgICBhbmltYXRpb246IHRleHRTbGFtIDEuOHMgY3ViaWMtYmV6aWVyKDAuMSwgMC44LCAwLjEsIDEpIGZvcndhcmRzOwogICAgICAgICAgICAgICAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICAgICAgICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLm1vZGFsLW92ZXJsYXkgewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgY2VudGVyLCByZ2JhKDEwLCAyNSwgNjAsIDAuOTUpIDAlLCByZ2JhKDAsIDAsIDAsIDAuOTgpIDEwMCUpOwogICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7IGp1c3RpZnktY29udGVudDogY2VudGVyOyBhbGlnbi1pdGVtczogY2VudGVyOyBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDE5MDA7CiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMDsgcG9pbnRlci1ldmVudHM6IG5vbmU7IHRyYW5zaXRpb246IG9wYWNpdHkgMC44czsKICAgICAgICAgICAgICAgICAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoOHB4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5tb2RhbC1vdmVybGF5LmFjdGl2ZSB7IG9wYWNpdHk6IDE7IHBvaW50ZXItZXZlbnRzOiBhdXRvOyB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC5tb2RhbC10aXRsZSB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdHYXJhbW9uZCcsIHNlcmlmOwogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogNTJweDsgY29sb3I6ICNmZmY7CiAgICAgICAgICAgICAgICAgICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwYWFmZiwgMCAwIDQwcHggIzAwNDRhYTsKICAgICAgICAgICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAzMHB4OwogICAgICAgICAgICAgICAgICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCAjMDBhYWZmOwogICAgICAgICAgICAgICAgICAgIHBhZGRpbmctYm90dG9tOiAxMHB4OwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiA4MCU7IHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgICAgICAgICBsZXR0ZXItc3BhY2luZzogNXB4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAubW9kYWwtc2NvcmUtY29udGFpbmVyIHsKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBnYXA6IDQwcHg7CiAgICAgICAgICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogNDBweDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5tb2RhbC1zY29yZSB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdJbXBhY3QnLCBzYW5zLXNlcmlmOwogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogODBweDsgY29sb3I6ICNmZmQ3MDA7CiAgICAgICAgICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggI2I4ODYwYjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5tb2RhbC12cyB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdDb3VyaWVyIE5ldycsIG1vbm9zcGFjZTsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDI0cHg7IGNvbG9yOiAjMDBhYWZmOyBvcGFjaXR5OiAwLjc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLmZsYXNoLW92ZXJsYXkgewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDIxMDA7CiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMDsgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjFzIGVhc2Utb3V0OwogICAgICAgICAgICAgICAgICAgIG1peC1ibGVuZC1tb2RlOiBvdmVybGF5OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIEBrZXlmcmFtZXMgY2xhc2hQb3AgewogICAgICAgICAgICAgICAgICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMC41KTsgb3BhY2l0eTogMTsgfQogICAgICAgICAgICAgICAgICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuNSk7IG9wYWNpdHk6IDAuODsgfQogICAgICAgICAgICAgICAgICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgyLjApOyBvcGFjaXR5OiAwOyB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLmNsYXNoLXNwYXJrIHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDYwcHg7IGhlaWdodDogNjBweDsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAjZmZmZmZmIDAlLCAjZmZmZjAwIDQwJSwgdHJhbnNwYXJlbnQgNzAlKTsKICAgICAgICAgICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgICAgICAgICAgICAgICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgICAgICAgICAgICAgei1pbmRleDogMTUwMDsKICAgICAgICAgICAgICAgICAgICBtaXgtYmxlbmQtbW9kZTogc2NyZWVuOwogICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbjogY2xhc2hQb3AgMC4zcyBlYXNlLW91dCBmb3J3YXJkczsKICAgICAgICAgICAgICAgICAgICBib3gtc2hhZG93OiAwIDAgMjBweCAjZmZhYTAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwogICAgICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHN0eWxlKTsKICAgICAgICB9CgogICAgICAgIHJlZ2lzdGVyVGVhbXMoaG9tZVRlYW0sIGF3YXlUZWFtLCBiYWxsKSB7CiAgICAgICAgICAgIHRoaXMudGVhbXMuaG9tZSA9IGhvbWVUZWFtOwogICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkgPSBhd2F5VGVhbTsKdGhpcy5lbnRpdGllcy5iYWxsID0gYmFsbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgTWluaU1hcAogICAgICAgICAgICBpZiAodGhpcy5taW5pTWFwKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1pbmlNYXAuaW5pdChob21lVGVhbSwgYXdheVRlYW0sIGJhbGwpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2luaXRVSSgpIHsKICAgICAgICAgICAgLy8gQmluZCB0byBleGlzdGluZyBIVE1MIGVsZW1lbnRzCiAgICAgICAgICAgIHRoaXMudWkuc2NvcmVQbGF5ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NvcmUtcGxheWVyJyk7CiAgICAgICAgICAgIHRoaXMudWkuc2NvcmVDcHUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NvcmUtY3B1Jyk7CiAgICAgICAgICAgIHRoaXMudWkudGltZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGltZXItZGlzcGxheScpOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGFsZi1pbmRpY2F0b3InKTsKICAgICAgICAgICAgdGhpcy51aS5hbm5vdW5jZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYW5ub3VuY2VtZW50Jyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZWNoLWZsYXNoLW92ZXJsYXknKTsKICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaEZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hTdWIgPSB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC1zdWItdGV4dCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50ZWNoLXRpbWVyLWZpbGwnKTsKCiAgICAgICAgICAgIC8vIEJpbmQgUGxheWVyIFN0YXR1cyBQYW5lbAogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJyk7CiAgICAgICAgICAgIHRoaXMudWkuc3RhdHVzUGFuZWwubmFtZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC5jaGFyLW5hbWUnKTsKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5ocEJhciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC5ocC1iYXItZmlsbCcpOwogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmhwVGV4dCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC5ocC12YWx1ZScpOwogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmV4cEJhciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC50ZWNoLWJhci1maWxsJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFbmQgR2FtZSBNZW51IEJpbmRpbmdzCiAgICAgICAgICAgIHRoaXMudWkuZW5kTWVudSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtZ2FtZS1tZW51Jyk7CiAgICAgICAgICAgIGNvbnN0IGJ0blJlbWF0Y2ggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLWJ0bi1yZW1hdGNoJyk7CiAgICAgICAgICAgIGNvbnN0IGJ0bkV4aXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLWJ0bi1leGl0Jyk7CgogICAgICAgICAgICBpZiAoYnRuUmVtYXRjaCkgewogICAgICAgICAgICAgICAgYnRuUmVtYXRjaC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlRW5kTWVudSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRNYXRjaCh0aGlzLmdhbWVNb2RlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChidG5FeGl0KSB7CiAgICAgICAgICAgICAgICBidG5FeGl0LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVFbmRNZW51KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ21lbnUnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDcmVhdGUgTW9kYWwgT3ZlcmxheSAoRm9yIEhhbGZ0aW1lIG9ubHkgbm93KQogICAgICAgICAgICB0aGlzLnVpLm1vZGFsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwuY2xhc3NOYW1lID0gJ21vZGFsLW92ZXJsYXknOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmlubmVySFRNTCA9IGAKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXRpdGxlIj5IQUxGIFRJTUU8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXNjb3JlLWNvbnRhaW5lciI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtc2NvcmUiIGlkPSJtb2RhbC1zY29yZS1ob21lIj4wPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtdnMiPi08L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC1zY29yZSIgaWQ9Im1vZGFsLXNjb3JlLWF3YXkiPjA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBpZD0ibW9kYWwtbXNnIiBzdHlsZT0iY29sb3I6ICMwMGFhZmY7IGZvbnQtc2l6ZTogMTRweDsgbGV0dGVyLXNwYWNpbmc6IDJweDsiPlBSRVBBUklORyAyTkQgSEFMRi4uLjwvZGl2PgogICAgICAgICAgICBgOwogICAgICAgICAgICB0aGlzLnVpTGF5ZXIuYXBwZW5kQ2hpbGQodGhpcy51aS5tb2RhbCk7CgogICAgICAgICAgICAvLyBDcmVhdGUgRmxhc2ggT3ZlcmxheQogICAgICAgICAgICB0aGlzLnVpLmZsYXNoID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHRoaXMudWkuZmxhc2guY2xhc3NOYW1lID0gJ2ZsYXNoLW92ZXJsYXknOwogICAgICAgICAgICB0aGlzLnVpTGF5ZXIuYXBwZW5kQ2hpbGQodGhpcy51aS5mbGFzaCk7CgogICAgICAgICAgICAvLyBJbml0aWFsIFN0YXRlCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoKTsKICAgICAgICAgICAgaWYgKHRoaXMudWkudGltZXIpIHRoaXMudWkudGltZXIuaW5uZXJUZXh0ID0gIjAwOjAwIjsKICAgICAgICB9CiAgICAgICAgX3VwZGF0ZVNjb3JlVUkoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnNjb3JlUGxheWVyKSB0aGlzLnVpLnNjb3JlUGxheWVyLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuaG9tZTsKICAgICAgICAgICAgaWYgKHRoaXMudWkuc2NvcmVDcHUpIHRoaXMudWkuc2NvcmVDcHUuaW5uZXJUZXh0ID0gdGhpcy5zY29yZS5hd2F5OwogICAgICAgIH0KCnVwZGF0ZVByYWN0aWNlKGR0KSB7CiAgICAgICAgICAgIC8vIERlbGVnYXRlIGxvZ2ljIHRvIFByYWN0aWNlTWFuYWdlcgogICAgICAgICAgICBpZiAodGhpcy5wcmFjdGljZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewoKaWYgKHRoaXMuc3RhdGUgPT09ICdpbnRybycpIHsKICAgICAgICAgICAgICAgIHRoaXMuaW50cm9UaW1lciArPSBkdDsKCiAgICAgICAgICAgICAgICAvLyAxLiBMaWdodHMgU2VxdWVuY2UgKDAuNXMgdG8gMi41cykKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0gJiYgdGhpcy5pbnRyb1RpbWVyID4gMC41ICYmIHRoaXMuaW50cm9UaW1lciA8IDIuNSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGR1cmF0aW9uID0gMi4wOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gKHRoaXMuaW50cm9UaW1lciAtIDAuNSkgLyBkdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b3RhbCA9IHRoaXMuc3RhZGl1bS5saWdodFNwcml0ZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2ZUNvdW50ID0gTWF0aC5mbG9vcihwcm9ncmVzcyAqIHRvdGFsKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0b3RhbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpIDw9IGFjdGl2ZUNvdW50ICYmICF0aGlzLnN0YWRpdW0ubGlnaHRTcHJpdGVzW2ldLnZpc2libGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhZGl1bS50dXJuT25MaWdodChpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyLiBDYW1lcmEgTW92ZW1lbnQgKFNwaXJhbCBJbikKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLmludHJvVGltZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHVyYXRpb24gPSA1LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGN0ID0gTWF0aC5taW4oMS4wLCB0IC8gZHVyYXRpb24pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFNtb290aCBlYXNlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWFzZSA9IDEgLSBNYXRoLnBvdygxIC0gcGN0LCAzKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGFydFJhZGl1cyA9IDEyMDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbmRSYWRpdXMgPSA0MDsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYWRpdXMgPSBzdGFydFJhZGl1cyArIChlbmRSYWRpdXMgLSBzdGFydFJhZGl1cykgKiBlYXNlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0SGVpZ2h0ID0gNjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kSGVpZ2h0ID0gMjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGVpZ2h0ID0gc3RhcnRIZWlnaHQgKyAoZW5kSGVpZ2h0IC0gc3RhcnRIZWlnaHQpICogZWFzZTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IHQgKiAwLjQ7IC8vIFJvdGF0aW9uCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uc2V0KAogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLnNpbihhbmdsZSkgKiByYWRpdXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5jb3MoYW5nbGUpICogcmFkaXVzCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMy4gQ3Jvd2QgUm9hciAvIEh5cGUgKDMuMHMpCiAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnRyb1RpbWVyID4gMy4wICYmICF0aGlzLl9pbnRyb1JvYXJUcmlnZ2VyZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9pbnRyb1JvYXJUcmlnZ2VyZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQVJFIFlPVSBSRUFEWT8iLCAic2xhbSIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgxLjUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZsYXNoIGNyb3dkCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bSAmJiB0aGlzLnN0YWRpdW0uY3Jvd2QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2UgY2FuJ3QgZWFzaWx5IGZsYXNoIGluc3RhbmNlZCBtZXNoIGNvbG9yIHdpdGhvdXQgaXRlcmF0aW5nLCAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYnV0IHdlIGNhbiBzcGF3biBzb21lIHBhcnRpY2xlcwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDIwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSoxMDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEwICsgTWF0aC5yYW5kb20oKSoyMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSoxMDAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIHBvcywgeyBzY2FsZTogNS4wIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDQuIEVuZCBJbnRybyAoNS4wcykKICAgICAgICAgICAgICAgIGlmICh0aGlzLmludHJvVGltZXIgPiA1LjApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9pbnRyb1JvYXJUcmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAvLyBSZXN0b3JlIFVJCiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKS5zdHlsZS5vcGFjaXR5ID0gJzEnOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJykuc3R5bGUub3BhY2l0eSA9ICcxJzsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgYWxsIGxpZ2h0cyBvbgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS5zZXRBbGxMaWdodHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNldFJvdW5kKG51bGwpOyAvLyBHbyB0byBraWNrb2ZmCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnbWVudScpIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBQT1BVTEFURSBBUkVOQSBGT1IgQi1ST0xMIC0tLQogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHBsYXllcnMgYXJlIHZpc2libGUgYW5kIGFuaW1hdGVkCiAgICAgICAgICAgICAgICBjb25zdCBhbmltYXRlVGVhbSA9ICh0ZWFtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0ZWFtKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgdGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdlbnRsZSBib2JiaW5nIHRvIHNpbXVsYXRlIHRyZWFkaW5nIHdhdGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24ueSA9IHAuaG9tZVBvc2l0aW9uLnkgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDIgKyBwLm1lc2guaWQpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIGlkbGUgYW5pbWF0aW9uIGlzIHBsYXlpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnN0YXRlICE9PSAnaWRsZScpIHAucGxheSgnaWRsZScsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5taXhlcikgcC5taXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgYW5pbWF0ZVRlYW0odGhpcy50ZWFtcy5ob21lKTsKICAgICAgICAgICAgICAgIGFuaW1hdGVUZWFtKHRoaXMudGVhbXMuYXdheSk7CgogICAgICAgICAgICAgICAgLy8gLS0tIENJTkVNQVRJQyBCLVJPTEwgLS0tCiAgICAgICAgICAgICAgICBpZiAodGhpcy5tZW51U2hvdHMgJiYgdGhpcy5tZW51U2hvdHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNob3QgPSB0aGlzLm1lbnVTaG90c1t0aGlzLm1lbnVTaG90SW5kZXhdOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVudVNob3RUaW1lciArPSBkdDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5tZW51U2hvdFRpbWVyID49IHNob3QuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U2hvdFRpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U2hvdEluZGV4ID0gKHRoaXMubWVudVNob3RJbmRleCArIDEpICUgdGhpcy5tZW51U2hvdHMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWxpemUgdGltZSAoMCB0byAxKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLm1lbnVTaG90VGltZXIgLyBzaG90LmR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgICAgICBzaG90LnVwZGF0ZSh0LCB0aGlzLmNhbWVyYSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFtYmllbnQgRlggaW4gTWVudQogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIE1hdGgucmFuZG9tKCkgPCAwLjIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biByYW5kb20gYnViYmxlcyBmb3IgYXRtb3NwaGVyZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhbmdlID0gNjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqcmFuZ2UsIAogICAgICAgICAgICAgICAgICAgICAgICAtMTAgKyBNYXRoLnJhbmRvbSgpKjIwLCAKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSpyYW5nZQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2J1YmJsZScsIHBvcywgeyBsaWZlOiAzLjAgKyBNYXRoLnJhbmRvbSgpKjIuMCwgc2NhbGU6IDAuMyArIE1hdGgucmFuZG9tKCkqMC40IH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBCYWNrZ3JvdW5kIFN5c3RlbXMKICAgICAgICAgICAgICAgIGlmICh0aGlzLndhdGVyT3ZlcmxheSkgdGhpcy53YXRlck92ZXJsYXkudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmxpZ2h0U2hhZnRzKSB0aGlzLmxpZ2h0U2hhZnRzLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGFkaXVtKSB0aGlzLnN0YWRpdW0udXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgdGhpcy5wYXJ0aWNsZU1hbmFnZXIudXBkYXRlKGR0KTsKCiAgICAgICAgICAgICAgICAvLyBSZW5kZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlbmRlcmVyICYmIHRoaXMuc2NlbmUgJiYgdGhpcy5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbmRlcih0aGlzLnNjZW5lLCB0aGlzLmNhbWVyYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCi8vIC0tLSBMT0dJQyBVUERBVEUgKFN0YXRlIERlcGVuZGVudCkgLS0tCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnYWN0aXZlJykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZU1vZGUgPT09ICdwcmFjdGljZScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVByYWN0aWNlKGR0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50aW1lICs9IGR0OwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tIYWxmVGltZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrR29hbHMoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXBkYXRlIFRlY2hjb3B5IFdpbmRvdwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIFVJIEJhcgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hUaW1lckZpbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGN0ID0gTWF0aC5tYXgoMCwgKHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciAvIHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lKSAqIDEwMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9IGAke3BjdH0lYDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbG9yIHNoaWZ0IGJhc2VkIG9uIHVyZ2VuY3kKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBjdCA8IDMwKSB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICcjZmYwMDAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZmZmZmYsICMwMGZmZmYpJzsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZFRlY2hDb3B5V2luZG93KGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBWSVNVQUwgVVBEQVRFIChBbHdheXMgUnVuKSAtLS0KICAgICAgICAgICAgLy8gVXBkYXRlIHRoZXNlIGluIGFsbCBzdGF0ZXMgKEFjdGl2ZSwgR29hbCwgSGFsZnRpbWUsIEdhbWVPdmVyKSB0byBrZWVwIEZYIGFsaXZlCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnbWVudScgJiYgdGhpcy5zdGF0ZSAhPT0gJ2ludHJvJykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMubWluaU1hcCkgdGhpcy5taW5pTWFwLnVwZGF0ZSgpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZmxvYXRpbmdUZXh0KSB0aGlzLmZsb2F0aW5nVGV4dC51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB0aGlzLnBhcnRpY2xlTWFuYWdlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFydGljbGVzKGR0KTsgLy8gTGVnYWN5IHNwYXJrcwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVidWdWaXN1YWxpemVyKSB0aGlzLmRlYnVnVmlzdWFsaXplci51cGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgX3VwZGF0ZU9mZnNjcmVlbkluZGljYXRvcigpIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMudGVhbXMuaG9tZSA/IHRoaXMudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIgOiBudWxsOwogICAgICAgICAgICBjb25zdCBpbmRpY2F0b3IgPSB0aGlzLnVpLm9mZnNjcmVlbkluZGljYXRvcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghcCB8fCAhcC5tZXNoIHx8ICF0aGlzLmNhbWVyYSB8fCAhaW5kaWNhdG9yKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBHZXQgUGxheWVyIFBvc2l0aW9uIChDZW50ZXIgTWFzcykKICAgICAgICAgICAgY29uc3QgcG9zID0gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgIHBvcy55ICs9IDEuMDsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAyLiBQcm9qZWN0IHRvIE5vcm1hbGl6ZWQgRGV2aWNlIENvb3JkaW5hdGVzIChOREMpIFstMSwgMV0KICAgICAgICAgICAgdGhpcy5fdGVtcFZlYy5jb3B5KHBvcykucHJvamVjdCh0aGlzLmNhbWVyYSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBDaGVjayBpZiBCZWhpbmQgQ2FtZXJhCiAgICAgICAgICAgIGNvbnN0IGNhbUZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKGNhbUZ3ZCk7CiAgICAgICAgICAgIGNvbnN0IHRvUGxheWVyID0gcG9zLmNsb25lKCkuc3ViKHRoaXMuY2FtZXJhLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgY29uc3QgZG90ID0gY2FtRndkLmRvdCh0b1BsYXllcik7CiAgICAgICAgICAgIGNvbnN0IGlzQmVoaW5kID0gZG90IDwgMC4yOyAvLyBCdWZmZXIgdG8gcHJldmVudCBmbGlwcGluZyBhdCBlZGdlCgogICAgICAgICAgICAvLyA0LiBDaGVjayBCb3VuZHMKICAgICAgICAgICAgY29uc3QgaXNPZmZTY3JlZW4gPSAoCiAgICAgICAgICAgICAgICB0aGlzLl90ZW1wVmVjLnggPCAtMC45IHx8IHRoaXMuX3RlbXBWZWMueCA+IDAuOSB8fAogICAgICAgICAgICAgICAgdGhpcy5fdGVtcFZlYy55IDwgLTAuOSB8fCB0aGlzLl90ZW1wVmVjLnkgPiAwLjkgfHwKICAgICAgICAgICAgICAgIGlzQmVoaW5kCiAgICAgICAgICAgICk7CgogICAgICAgICAgICBpZiAoaXNPZmZTY3JlZW4pIHsKICAgICAgICAgICAgICAgIGluZGljYXRvci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHggPSB0aGlzLl90ZW1wVmVjLng7CiAgICAgICAgICAgICAgICBsZXQgeSA9IHRoaXMuX3RlbXBWZWMueTsKCiAgICAgICAgICAgICAgICAvLyBJZiBiZWhpbmQsIGludmVydCBjb29yZGluYXRlcyB0byBwb2ludCBjb3JyZWN0bHkKICAgICAgICAgICAgICAgIGlmIChpc0JlaGluZCkgewogICAgICAgICAgICAgICAgICAgIHggPSAteDsKICAgICAgICAgICAgICAgICAgICB5ID0gLXk7CiAgICAgICAgICAgICAgICAgICAgLy8gRml4IHNpbmd1bGFyaXR5IGlmIGV4YWN0bHkgYmVoaW5kIGNlbnRlcgogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyh4KSA8IDAuMDEgJiYgTWF0aC5hYnMoeSkgPCAwLjAxKSB5ID0gLTE7IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENsYW1wIHRvIHNjcmVlbiBlZGdlcwogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCB0byBmaW5kIHRoZSBpbnRlcnNlY3Rpb24gb2YgdGhlIHZlY3RvciAoeCx5KSB3aXRoIHRoZSBib3ggWy0wLjksIDAuOV0KICAgICAgICAgICAgICAgIGNvbnN0IHBhZGRpbmcgPSAwLjk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSB0byBnZXQgZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBjb25zdCBtYWcgPSBNYXRoLnNxcnQoeCp4ICsgeSp5KTsKICAgICAgICAgICAgICAgIGNvbnN0IG54ID0geCAvIG1hZzsKICAgICAgICAgICAgICAgIGNvbnN0IG55ID0geSAvIG1hZzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmF5Y2FzdCB0byBib3ggZWRnZXMKICAgICAgICAgICAgICAgIC8vIFZlcnRpY2FsIGVkZ2VzOiB4ID0gKy8tIHBhZGRpbmcKICAgICAgICAgICAgICAgIC8vIEhvcml6b250YWwgZWRnZXM6IHkgPSArLy0gcGFkZGluZwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBdm9pZCBkaXZpZGUgYnkgemVybwogICAgICAgICAgICAgICAgY29uc3QgdHggPSAoTWF0aC5hYnMobngpID4gMC4wMDEpID8gKG54ID4gMCA/IHBhZGRpbmcgOiAtcGFkZGluZykgLyBueCA6IDk5OTsKICAgICAgICAgICAgICAgIGNvbnN0IHR5ID0gKE1hdGguYWJzKG55KSA+IDAuMDAxKSA/IChueSA+IDAgPyBwYWRkaW5nIDogLXBhZGRpbmcpIC8gbnkgOiA5OTk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFVzZSB0aGUgbmVhcmVzdCBpbnRlcnNlY3Rpb24gKHNtYWxsZXN0IHBvc2l0aXZlIHQpCiAgICAgICAgICAgICAgICAvLyBTaW5jZSB3ZSBhcmUgcHJvamVjdGluZyBmcm9tIGNlbnRlciAoMCwwKSB0byAobngsbnkpLCB0IG11c3QgYmUgcG9zaXRpdmUuCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gTWF0aC5taW4oTWF0aC5hYnModHgpLCBNYXRoLmFicyh0eSkpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBzY3JlZW5YID0gbnggKiB0OwogICAgICAgICAgICAgICAgY29uc3Qgc2NyZWVuWSA9IG55ICogdDsKCiAgICAgICAgICAgICAgICAvLyBDb252ZXJ0IE5EQyB0byBQaXhlbHMKICAgICAgICAgICAgICAgIGNvbnN0IHdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBoZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHB4ID0gKHNjcmVlblggKiAwLjUgKyAwLjUpICogd2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBweSA9ICgtKHNjcmVlblkpICogMC41ICsgMC41KSAqIGhlaWdodDsKCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgUm90YXRpb24KICAgICAgICAgICAgICAgIC8vIEFycm93IHBvaW50cyBVUCBieSBkZWZhdWx0LgogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCBpdCB0byBwb2ludCBpbiBkaXJlY3Rpb24gKG54LCBueSkgb24gc2NyZWVuLgogICAgICAgICAgICAgICAgLy8gU2NyZWVuIFkgaXMgZG93biAoaW52ZXJ0ZWQgZnJvbSBXZWJHTCBZKS4KICAgICAgICAgICAgICAgIC8vIFNvICgwLCAxKSBpbiBOREMgaXMgVVAuICgwLCAtMSkgaW4gTkRDIGlzIERPV04uCiAgICAgICAgICAgICAgICAvLyBhdGFuMih5LCB4KSBnaXZlcyBhbmdsZSBmcm9tICtYLgogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCBhbmdsZSBmcm9tICtZIChVcCkuCiAgICAgICAgICAgICAgICAvLyBSb3RhdGlvbiA9IFBJLzIgLSBhbmdsZS4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKG55LCBueCk7CiAgICAgICAgICAgICAgICBjb25zdCByb3QgPSAoTWF0aC5QSSAvIDIpIC0gYW5nbGU7CgogICAgICAgICAgICAgICAgaW5kaWNhdG9yLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHtweH1weCwgJHtweX1weCkgcm90YXRlKCR7cm90fXJhZClgOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgaW5kaWNhdG9yLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVUaW1lcigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnVpLnRpbWVyKSByZXR1cm47CiAgICAgICAgICAgIC8vIENsYW1wIHRvIGhhbGYgZHVyYXRpb24gZm9yIGRpc3BsYXkgaWYgd2UgZ28gc2xpZ2h0bHkgb3ZlciBiZWZvcmUgdGljawogICAgICAgICAgICBjb25zdCB0ID0gTWF0aC5taW4odGhpcy50aW1lLCB0aGlzLmhhbGZEdXJhdGlvbik7CiAgICAgICAgICAgIGNvbnN0IG1pbnV0ZXMgPSBNYXRoLmZsb29yKHQgLyA2MCk7CiAgICAgICAgICAgIGNvbnN0IHNlY29uZHMgPSBNYXRoLmZsb29yKHQgJSA2MCk7CiAgICAgICAgICAgIHRoaXMudWkudGltZXIuaW5uZXJUZXh0ID0gYCR7bWludXRlcy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9OiR7c2Vjb25kcy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9YDsKICAgICAgICB9CiAgICAgICAgX2NoZWNrSGFsZlRpbWUoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnRpbWUgPj0gdGhpcy5oYWxmRHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5kSGFsZigpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKZW5kSGFsZigpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdoYWxmdGltZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdG9wIGFsbCBwbGF5ZXJzCiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFsZiA9PT0gMSkgewogICAgICAgICAgICAgICAgdGhpcy5fc2hvd01vZGFsKCJIQUxGIFRJTUUiLCAiUFJFUEFSSU5HIDJORCBIQUxGLi4uIik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBQbGF5IHdoaXN0bGUgc291bmQgaGVyZSBpZiBhdmFpbGFibGUKICAgICAgICAgICAgICAgIC8vIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnd2hpc3RsZScpOwoKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVNb2RhbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRTZWNvbmRIYWxmKCk7CiAgICAgICAgICAgICAgICB9LCA0MDAwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEVuZCBvZiAybmQgSGFsZiBvciBPdmVydGltZSBQZXJpb2QKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNjb3JlLmhvbWUgPT09IHRoaXMuc2NvcmUuYXdheSkgewogICAgICAgICAgICAgICAgICAgIC8vIFRJRUQgLSBHbyB0byBPdmVydGltZSAoR29sZGVuIEdvYWwpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd01vZGFsKCJPVkVSVElNRSIsICJHT0xERU4gR09BTCBSVUxFIEFDVElWRSIpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlTW9kYWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydE92ZXJ0aW1lKCk7CiAgICAgICAgICAgICAgICAgICAgfSwgNDAwMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIFdpbm5lciBkZWNpZGVkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmRHYW1lKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHN0YXJ0U2Vjb25kSGFsZigpIHsKICAgICAgICAgICAgdGhpcy5oYWxmID0gMjsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICIybmQgSEFMRiI7CiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsgLy8gTmV1dHJhbCBCbGl0ei1vZmYgZm9yIDJuZCBoYWxmIHN0YXJ0CiAgICAgICAgfQoKICAgICAgICBzdGFydE92ZXJ0aW1lKCkgewogICAgICAgICAgICB0aGlzLmhhbGYrKzsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICJPVkVSVElNRSI7CiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsgLy8gTmV1dHJhbCBCbGl0ei1vZmYKICAgICAgICB9CgplbmRHYW1lKCkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2dhbWVvdmVyJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN0b3AgcGxheWVycwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gcC5zZXRJbnB1dCgwLCAwKSk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKCiAgICAgICAgICAgIGxldCBtc2cgPSAiRFJBVyI7CiAgICAgICAgICAgIGlmICh0aGlzLnNjb3JlLmhvbWUgPiB0aGlzLnNjb3JlLmF3YXkpIG1zZyA9ICJWSUNUT1JZIjsKICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuYXdheSA+IHRoaXMuc2NvcmUuaG9tZSkgbXNnID0gIkRFRkVBVCI7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQb3B1bGF0ZSBFbmQgR2FtZSBNZW51CiAgICAgICAgICAgIGlmICh0aGlzLnVpLmVuZE1lbnUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRpdGxlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLXJlc3VsdC10aXRsZScpOwogICAgICAgICAgICAgICAgY29uc3QgaG9tZVNjb3JlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLXNjb3JlLWhvbWUnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF3YXlTY29yZUVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1zY29yZS1hd2F5Jyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aXRsZUVsKSB7CiAgICAgICAgICAgICAgICAgICAgdGl0bGVFbC5pbm5lclRleHQgPSBtc2c7CiAgICAgICAgICAgICAgICAgICAgdGl0bGVFbC5zdHlsZS5jb2xvciA9IChtc2cgPT09ICJWSUNUT1JZIikgPyAiIzAwZmZmZiIgOiAoKG1zZyA9PT0gIkRFRkVBVCIpID8gIiNmZjQ0NDQiIDogIiNmZmZmZmYiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChob21lU2NvcmVFbCkgaG9tZVNjb3JlRWwuaW5uZXJUZXh0ID0gdGhpcy5zY29yZS5ob21lOwogICAgICAgICAgICAgICAgaWYgKGF3YXlTY29yZUVsKSBhd2F5U2NvcmVFbC5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmF3YXk7CgogICAgICAgICAgICAgICAgdGhpcy51aS5lbmRNZW51LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgdGhpcy5zZXRNZW51TW9kZSh0cnVlKTsgLy8gSGlkZSBIVUQKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3RvcCBNdXNpYyBvbiBHYW1lIE92ZXIKICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5zdG9wQkdNKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9oaWRlRW5kTWVudSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudWkuZW5kTWVudSkgewogICAgICAgICAgICAgICAgdGhpcy51aS5lbmRNZW51LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgdGhpcy5zZXRNZW51TW9kZShmYWxzZSk7IC8vIFNob3cgSFVECiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zaG93TW9kYWwodGl0bGUsIHN1YnRleHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnVpLm1vZGFsKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLnF1ZXJ5U2VsZWN0b3IoJy5tb2RhbC10aXRsZScpLmlubmVyVGV4dCA9IHRpdGxlOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLnF1ZXJ5U2VsZWN0b3IoJyNtb2RhbC1zY29yZS1ob21lJykuaW5uZXJUZXh0ID0gdGhpcy5zY29yZS5ob21lOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLnF1ZXJ5U2VsZWN0b3IoJyNtb2RhbC1zY29yZS1hd2F5JykuaW5uZXJUZXh0ID0gdGhpcy5zY29yZS5hd2F5OwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLnF1ZXJ5U2VsZWN0b3IoJyNtb2RhbC1tc2cnKS5pbm5lclRleHQgPSBzdWJ0ZXh0OwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhpZGUgSFVEIGVsZW1lbnRzCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJykuc3R5bGUub3BhY2l0eSA9ICcwJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKS5zdHlsZS5vcGFjaXR5ID0gJzAnOwogICAgICAgIH0KCiAgICAgICAgX2hpZGVNb2RhbCgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnVpLm1vZGFsKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaG93IEhVRCBlbGVtZW50cwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaHVkLXRvcCcpLnN0eWxlLm9wYWNpdHkgPSAnMSc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJykuc3R5bGUub3BhY2l0eSA9ICcxJzsKICAgICAgICB9CgpfY2hlY2tHb2FscygpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHBvcyA9IGJhbGwubWVzaC5wb3NpdGlvbjsKCiAgICAgICAgICAgIC8vIFByZWNpc2UgR29hbCBEZXRlY3Rpb24KICAgICAgICAgICAgLy8gVmlzdWFsIEdvYWwgaXMgYXQgWiA9ICsvLSAyOC4KICAgICAgICAgICAgLy8gV2UgZGVmaW5lIGEgIkdvYWwgTW91dGgiIGJveCBtYXRjaGluZyBHb2FsaWUuanMgKFdpZHRoIDE0LCBIZWlnaHQgOCkuCi8vIFdlIGRlZmluZSBhICJHb2FsIE1vdXRoIiBib3ggbWF0Y2hpbmcgdGhlIHZpc3VhbCBuZXQuCiAgICAgICAgICAgIC8vIEFyZW5hIFJhZGl1cyBpcyAzMi4gR29hbCBpcyByb3VnaGx5IDIybSB3aWRlLCAxOG0gaGlnaC4KLy8gQXJlbmEgUmFkaXVzIGlzIDMyLiBHb2FsIGlzIHJvdWdobHkgMjJtIHdpZGUsIDE4bSBoaWdoLgogICAgICAgICAgICBjb25zdCBoYWxmV2lkdGggPSAxMS4wOyAvLyBJbmNyZWFzZWQgdG8gMTEgKFdpZHRoIDIyKSB0byBjYXRjaCBjb3JuZXJzCiAgICAgICAgICAgIGNvbnN0IGhhbGZIZWlnaHQgPSA5LjA7IC8vIEluY3JlYXNlZCB0byA5IChIZWlnaHQgMTgpIHRvIGNhdGNoIGhpZ2ggc2hvdHMKICAgICAgICAgICAgY29uc3QgZ29hbFlPZmZzZXQgPSAtNC41OyAvLyBNb3ZlZCBkb3duIHRvIG1hdGNoIHZpc3VhbCBtb2RlbCAoLTQuNW0pCgogICAgICAgICAgICBjb25zdCB0cmlnZ2VyWiA9IDQ1LjA7IC8vIFRyaWdnZXIgZWFybGllciAod2FzIDMwKSB0byBlbnN1cmUgcmVnaXN0cmF0aW9uIGJlZm9yZSBib3VuY2UKCiAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueikgPiB0cmlnZ2VyWikgewogICAgICAgICAgICAgICAgLy8gUFJFVkVOVCBPV04gR09BTCBCWSBDQVJSSUVSIChVc2VyIFJlcXVlc3QpCiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgYmFsbCBpcyBoZWxkIGJ5IHRoZSB0ZWFtIGRlZmVuZGluZyB0aGlzIGdvYWwsIGRvIG5vdCBjb3VudCBpdC4KICAgICAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIC8vIEhvbWUgKFNpZGUgMSkgZGVmZW5kcyArWi4gSWYgcG9zLnogPiAwIChIb21lIEdvYWwpIGFuZCBob2xkZXIgaXMgSG9tZSwgaWdub3JlLgogICAgICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IDAgJiYgYmFsbC5ob2xkZXIudGVhbS5zaWRlID09PSAxKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgLy8gQXdheSAoU2lkZSAtMSkgZGVmZW5kcyAtWi4gSWYgcG9zLnogPCAwIChBd2F5IEdvYWwpIGFuZCBob2xkZXIgaXMgQXdheSwgaWdub3JlLgogICAgICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IDAgJiYgYmFsbC5ob2xkZXIudGVhbS5zaWRlID09PSAtMSkgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDIuIENoZWNrIEZyYW1lIChNdXN0IGJlIHdpdGhpbiB3aWR0aC9oZWlnaHQpCi8vIDIuIENoZWNrIEZyYW1lIChNdXN0IGJlIHdpdGhpbiB3aWR0aC9oZWlnaHQsIGFjY291bnRpbmcgZm9yIFkgb2Zmc2V0KQogICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHBvcy54KSA8PSBoYWxmV2lkdGggJiYgTWF0aC5hYnMocG9zLnkgLSBnb2FsWU9mZnNldCkgPD0gaGFsZkhlaWdodCkgewogICAgICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nb2FsU2NvcmVkKCdob21lJyk7IC8vIEhvbWUgYXR0YWNrcyAtWgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ29hbFNjb3JlZCgnYXdheScpOyAvLyBBd2F5IGF0dGFja3MgK1oKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpnb2FsU2NvcmVkKHNjb3JlcikgewogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ2FjdGl2ZScpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElNUEFDVCBGUkFNRTogR09BTAogICAgICAgICAgICB0aGlzLnRyaWdnZXJJbXBhY3QoMC40LCAnc2hhdHRlcicpOyAvLyBNYXNzaXZlIGZyZWV6ZSBmb3IgZ29hbAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRVhQIFJFV0FSRDogR29hbAogICAgICAgICAgICAvLyBGaW5kIHdobyBzY29yZWQgKExhc3QgaG9sZGVyIG9mIGJhbGwpCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmIChiYWxsICYmIGJhbGwubGFzdEhvbGRlciAmJiBiYWxsLmxhc3RIb2xkZXIudGVhbS5pZCA9PT0gc2NvcmVyKSB7CiAgICAgICAgICAgICAgICBiYWxsLmxhc3RIb2xkZXIuZ2FpbkV4cCgxMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZ29hbCc7CiAgICAgICAgICAgIHRoaXMuc2NvcmVbc2NvcmVyXSsrOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAxLiBWSVNDRVJBTCBTSEFLRSAmIFBBUlRJQ0xFUwogICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMi4wKTsgLy8gSGVhdnkgc2hha2UKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIgJiYgdGhpcy5lbnRpdGllcy5iYWxsICYmIHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnb2FsUG9zID0gdGhpcy5lbnRpdGllcy5iYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgIC8vIE1hc3NpdmUgR29hbCBFeHBsb3Npb24KICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBnb2FsUG9zLCB7IHNjYWxlOiAxNS4wLCBsaWZlOiAwLjggfSk7CiAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBnb2FsUG9zLCB7IHNjYWxlOiAxMC4wIH0pOwogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzA7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdkZWJyaXMnLCBnb2FsUG9zLCB7IHNjYWxlOiAwLjggfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gMi4gU0NSRUVOIEZMQVNICiAgICAgICAgICAgIGlmICh0aGlzLnVpLmZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmZsYXNoLnN0eWxlLm9wYWNpdHkgPSAnMC44JzsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyB0aGlzLnVpLmZsYXNoLnN0eWxlLm9wYWNpdHkgPSAnMCc7IH0sIDEwMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIEdPTERFTiBHT0FMIENIRUNLCiAgICAgICAgICAgIGlmICh0aGlzLmlzT3ZlcnRpbWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiR09MREVOIEdPQUwhIiwgJ3NsYW0nKTsKICAgICAgICAgICAgICAgIC8vIEVuZCBnYW1lIGFmdGVyIHNob3J0IGRlbGF5CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgIH0sIDMwMDApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA0LiBTTEFNIEFOTk9VTkNFTUVOVCAoTm9ybWFsKQogICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkdPQUwhIiwgJ3NsYW0nKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IHNlcXVlbmNlCiAgICAgICAgICAgIC8vIFNjb3JlZC11cG9uIHRlYW0gZ2V0cyBiYWxsCiAgICAgICAgICAgIGNvbnN0IGxvc2VyID0gc2NvcmVyID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGQVNURVIgRkxPVzogUmVkdWNlZCBkZWxheSBmcm9tIDMwMDBtcyB0byAxMjAwbXMKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0Um91bmQobG9zZXIpOwogICAgICAgICAgICB9LCAyMDAwKTsgLy8gU2xpZ2h0bHkgbG9uZ2VyIHRvIGFwcHJlY2lhdGUgdGhlICJHT0FMIiBzbGFtCiAgICAgICAgfQoKc2hvd0Fubm91bmNlbWVudCh0ZXh0LCB0eXBlID0gJ25vcm1hbCcsIGR1cmF0aW9uID0gMjAwMCkgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkuYW5ub3VuY2VtZW50OwogICAgICAgICAgICBpZiAoIWVsKSByZXR1cm47CgogICAgICAgICAgICAvLyBDbGVhciBwcmV2aW91cyB0aW1lb3V0CiAgICAgICAgICAgIGlmICh0aGlzLl9hbm5vdW5jZVRpbWVvdXQpIHsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9hbm5vdW5jZVRpbWVvdXQpOwogICAgICAgICAgICAgICAgdGhpcy5fYW5ub3VuY2VUaW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUmVzZXQgQW5pbWF0aW9uIGJ5IGNsb25pbmcKICAgICAgICAgICAgY29uc3QgbmV3RWwgPSBlbC5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgICAgICAgIGVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKG5ld0VsLCBlbCk7CiAgICAgICAgICAgIHRoaXMudWkuYW5ub3VuY2VtZW50ID0gbmV3RWw7CgogICAgICAgICAgICBuZXdFbC5pbm5lclRleHQgPSB0ZXh0OwogICAgICAgICAgICBuZXdFbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IENsYXNzIGJhc2VkIG9uIHR5cGUKICAgICAgICAgICAgbmV3RWwuY2xhc3NOYW1lID0gJyc7IC8vIFJlc2V0IGNsYXNzZXMKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzbGFtJykgewogICAgICAgICAgICAgICAgbmV3RWwuY2xhc3NMaXN0LmFkZCgnYW5ub3VuY2VtZW50LXNsYW0nKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgc3R5bGUKICAgICAgICAgICAgICAgIG5ld0VsLnN0eWxlLmFuaW1hdGlvbiA9ICdub25lJzsKICAgICAgICAgICAgICAgIG5ld0VsLm9mZnNldEhlaWdodDsgLyogdHJpZ2dlciByZWZsb3cgKi8KICAgICAgICAgICAgICAgIG5ld0VsLnN0eWxlLmFuaW1hdGlvbiA9ICdhbm5vdW5jZVNsaWRlIDAuNXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXV0by1oaWRlCiAgICAgICAgICAgIGlmIChkdXJhdGlvbiA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2Fubm91bmNlVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgfSwgZHVyYXRpb24pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBoaWRlQW5ub3VuY2VtZW50KCkgewogICAgICAgICAgICBpZiAodGhpcy51aS5hbm5vdW5jZW1lbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuYW5ub3VuY2VtZW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpyZXNldFJvdW5kKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdyZXNldCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBwZXJzaXN0ZW50IHZpc3VhbHMKICAgICAgICAgICAgaWYgKHRoaXMuZ2x5cGhNYW5hZ2VyKSB0aGlzLmdseXBoTWFuYWdlci5jbGVhcigpOwogICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBDbGVhciBwYXJ0aWNsZXMgaWYgbmVlZGVkLCB0aG91Z2ggdGhleSBzZWxmLWV4cGlyZSBxdWlja2x5CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IEJhbGwKICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCkgdGhpcy5lbnRpdGllcy5iYWxsLnJlc2V0KCk7CiAgICAgICAgICAgIGlmICh0aGlzLmVudGl0aWVzLmJhbGwpIHRoaXMuZW50aXRpZXMuYmFsbC5yZXNldCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgVGVhbXMKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5yZXNldFBvc2l0aW9ucygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2xlYXIgYmFsbCBob2xkZXIKICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCkgdGhpcy5lbnRpdGllcy5iYWxsLmRyb3AoKTsKCiAgICAgICAgICAgIC8vIENSSVRJQ0FMOiBTbmFwIGNhbWVyYSB0byBwcmV2ZW50IGRpc29yaWVudGF0aW9uCiAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIC8vIEZvcmNlIHVwZGF0ZSB0YXJnZXQgZmlyc3QgKHVzdWFsbHkgYmFsbCkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVudGl0aWVzLmJhbGwgJiYgdGhpcy5lbnRpdGllcy5iYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoLCB0aGlzLmVudGl0aWVzLmJhbGwudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zbmFwVG9UYXJnZXQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRkFTVEVSIEZMT1c6IFJlZHVjZWQgZGVsYXkgZnJvbSAyMDAwbXMgdG8gMTAwbXMKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0S2lja29mZihwb3NzZXNzaW9uVGVhbUlkKTsKfSwgMTAwKTsKICAgICAgICB9CgpzdGFydEtpY2tvZmYocG9zc2Vzc2lvblRlYW1JZCkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2tpY2tvZmYnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcCBhbGwgcGxheWVycyBpbW1lZGlhdGVseSB0byBwcmV2ZW50IHByZS1tb3ZlbWVudAogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gcC5zZXRJbnB1dCgwLCAwKSk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKCiAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQkxJVFogT0ZGISIsICdzbGFtJyk7CiAgICAgICAgICAgIC8vIElmIGEgdGVhbSBoYXMgcG9zc2Vzc2lvbiAoYWZ0ZXIgZ29hbCksIGdpdmUgdG8gTUYKICAgICAgICAgICAgaWYgKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRlYW0gPSB0aGlzLnRlYW1zW3Bvc3Nlc3Npb25UZWFtSWRdOwogICAgICAgICAgICAgICAgaWYgKHRlYW0pIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtZiA9IHRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgICAgICAgICBpZiAobWYgJiYgdGhpcy5lbnRpdGllcy5iYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW50aXRpZXMuYmFsbC5ncmFiKG1mKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENSSVRJQ0FMOiBTbmFwIGNhbWVyYSB0byBuZXcgaG9sZGVyIHRvIHByZXZlbnQgc3dpbmcvZGlzb3JpZW50YXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldChtZi5tZXNoLCBtZi52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOZXV0cmFsIGtpY2tvZmYgLSBlbnN1cmUgY2FtZXJhIGlzIHNuYXBwZWQgdG8gY2VudGVyIGJhbGwKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIgJiYgdGhpcy5lbnRpdGllcy5iYWxsICYmIHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldCh0aGlzLmVudGl0aWVzLmJhbGwubWVzaCwgdGhpcy5lbnRpdGllcy5iYWxsLnZlbG9jaXR5KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZBU1RFUiBGTE9XOiBSZWR1Y2VkIGRlbGF5IGZyb20gMTAwMG1zIHRvIDgwMG1zCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5oaWRlQW5ub3VuY2VtZW50KCk7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2FjdGl2ZSc7CiAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgfQogICAgICAgIAovLyBJbml0aWFsIHN0YXJ0Ci8vIEluaXRpYWwgc3RhcnQKICAgICAgICBzdGFydE1hdGNoKG1vZGUgPSAnbm9ybWFsJykgewogICAgICAgICAgICB0aGlzLmdhbWVNb2RlID0gbW9kZTsKICAgICAgICAgICAgY29uc29sZS5sb2coIlN0YXJ0aW5nIE1hdGNoIGluIG1vZGU6IiwgbW9kZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFydCBNdXNpYwogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlCR00oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgU2NvcmUKICAgICAgICAgICAgdGhpcy5zY29yZS5ob21lID0gMDsKICAgICAgICAgICAgdGhpcy5zY29yZS5hd2F5ID0gMDsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgVGltZQogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmhhbGYgPSAxOwogICAgICAgICAgICBpZiAodGhpcy51aS5oYWxmKSB0aGlzLnVpLmhhbGYuaW5uZXJUZXh0ID0gIjFzdCI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAobW9kZSA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkuaGFsZikgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICJQUkFDIjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU3RhcnQgUHJhY3RpY2UgTWFuYWdlcgogICAgICAgICAgICAgICAgaWYgKHRoaXMucHJhY3RpY2VNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIuc3RhcnQoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBJbiBwcmFjdGljZSwgZW5zdXJlIEFJIGlzIGVuYWJsZWQgZm9yIHNwYXJyaW5nCiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWFtcy5hd2F5LmFpRW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNraXAgaW50cm8gZm9yIHByYWN0aWNlCiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0Um91bmQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBQcmFjdGljZSBNYW5hZ2VyIGlzIHN0b3BwZWQgaWYgbm9ybWFsIGdhbWUKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgdGhpcy5wcmFjdGljZU1hbmFnZXIuc3RvcCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTYWZldHk6IEVuc3VyZSBhbGwgcGxheWVycyBhcmUgdmlzaWJsZSAoaW4gY2FzZSBQcmFjdGljZSBoaWQgdGhlbSkKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4geyBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsgfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWFtcy5hd2F5LmFpRW5hYmxlZCA9IHRydWU7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7IGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSB0cnVlOyB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBTdGFydCBDaW5lbWF0aWMgSW50cm8KICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRJbnRyb1NlcXVlbmNlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHN0YXJ0SW50cm9TZXF1ZW5jZSgpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdpbnRybyc7CiAgICAgICAgICAgIHRoaXMuaW50cm9UaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuX2ludHJvUm9hclRyaWdnZXJlZCA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVHVybiBvZmYgbGlnaHRzCiAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhZGl1bS5zZXRBbGxMaWdodHMoZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIaWRlIFVJCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJykuc3R5bGUub3BhY2l0eSA9ICcwJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKS5zdHlsZS5vcGFjaXR5ID0gJzAnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgcG9zaXRpb25zIHNvIHBsYXllcnMgYXJlIG9uIGZpZWxkIGluIGRhcmsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5yZXNldFBvc2l0aW9ucygpOwogICAgICAgICAgICBpZiAodGhpcy5lbnRpdGllcy5iYWxsKSB0aGlzLmVudGl0aWVzLmJhbGwucmVzZXQoKTsKICAgICAgICB9Ci8vIER1cGxpY2F0ZSBibG9jayByZW1vdmVkCgpzZXRNZW51TW9kZShpc0FjdGl2ZSkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gaXNBY3RpdmUgPyAnbWVudScgOiAnYWN0aXZlJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChpc0FjdGl2ZSAmJiB0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIuc3RvcEJHTSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIaWRlIEhVRCBpbiBtZW51CiAgICAgICAgICAgIGNvbnN0IGh1ZFRvcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJyk7CiAgICAgICAgICAgIGNvbnN0IHN0YXR1c1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKTsKICAgICAgICAgICAgY29uc3QgY29udHJvbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWNvbnRhaW5lcicpOwogICAgICAgICAgICBjb25zdCBqb3lzdGljayA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1oaXQtem9uZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2ZsZXgnOyAvLyBvciBibG9jay9ldGMKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChodWRUb3ApIGh1ZFRvcC5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheTsKICAgICAgICAgICAgaWYgKHN0YXR1c1BhbmVsKSBzdGF0dXNQYW5lbC5zdHlsZS5kaXNwbGF5ID0gaXNBY3RpdmUgPyAnbm9uZScgOiAnYmxvY2snOyAvLyBTdGF0dXMgcGFuZWwgaGFzIHNwZWNpZmljIGxvZ2ljCiAgICAgICAgICAgIGlmIChjb250cm9scykgY29udHJvbHMuc3R5bGUuZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2ZsZXgnOwogICAgICAgICAgICBpZiAoam95c3RpY2spIGpveXN0aWNrLnN0eWxlLmRpc3BsYXkgPSBpc0FjdGl2ZSA/ICdub25lJyA6ICdibG9jayc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJZiBlbnRlcmluZyBtZW51LCByZXNldCBjYW1lcmEgdG8gYSBuaWNlIGFuZ2xlPwogICAgICAgICAgICAvLyBIYW5kbGVkIGJ5IHVwZGF0ZSBsb29wCiAgICAgICAgfQp0b2dnbGVEZW1vTW9kZSgpIHsKICAgICAgICAgICAgdGhpcy5pc0RlbW9Nb2RlID0gIXRoaXMuaXNEZW1vTW9kZTsKICAgICAgICAgICAgY29uc29sZS5sb2coIkRlbW8gTW9kZToiLCB0aGlzLmlzRGVtb01vZGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFVJIEJ1dHRvbgogICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXV0by10b2dnbGUnKTsKICAgICAgICAgICAgaWYgKGJ0bikgewogICAgICAgICAgICAgICAgYnRuLmlubmVyVGV4dCA9IHRoaXMuaXNEZW1vTW9kZSA/ICJBVVRPIFBJTE9UIiA6ICJNQU5VQUwiOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNEZW1vTW9kZSkgewogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBbm5vdW5jZW1lbnQKICAgICAgICAgICAgY29uc3QgdGV4dCA9IHRoaXMuaXNEZW1vTW9kZSA/ICJBVVRPIFBJTE9UIiA6ICJNQU5VQUwiOwogICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQodGV4dCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXN1YWwgRmxhaXI6IFNwYXduIHRleHQgYWJvdmUgYWN0aXZlIHBsYXllcgogICAgICAgICAgICBpZiAodGhpcy5pc0RlbW9Nb2RlICYmIHRoaXMuZmxvYXRpbmdUZXh0ICYmIHRoaXMudGVhbXMuaG9tZSAmJiB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyICYmIHRoaXMudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5mbG9hdGluZ1RleHQuc3Bhd24oIkFJIEVOR0FHRUQiLCB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyLm1lc2gucG9zaXRpb24sICJnb2FsIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEF1dG8taGlkZSBhbm5vdW5jZW1lbnQKc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy51aS5hbm5vdW5jZW1lbnQgJiYgdGhpcy51aS5hbm5vdW5jZW1lbnQuaW5uZXJUZXh0ID09PSB0ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlQW5ub3VuY2VtZW50KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIDE1MDApOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIFRFQ0hDT1BZIFNZU1RFTSAtLS0KCiAgICAgICAgdHJpZ2dlclRlY2hFdmVudChzb3VyY2VQbGF5ZXIsIHRlY2hOYW1lKSB7CiAgICAgICAgICAgIGlmICghc291cmNlUGxheWVyIHx8ICFzb3VyY2VQbGF5ZXIudGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gRmluZCBvcHBvc2luZyB0ZWFtCiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW1JZCA9IHNvdXJjZVBsYXllci50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSB0aGlzLnRlYW1zW29wcFRlYW1JZF07CiAgICAgICAgICAgIGlmICghb3BwVGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gRmluZCB3aG8gaXMgbWFya2luZyB0aGlzIHNvdXJjZQogICAgICAgICAgICBjb25zdCBsZWFybmVycyA9IG9wcFRlYW0ucGxheWVycy5maWx0ZXIocCA9PiBwLm1hcmtpbmcgPT09IHNvdXJjZVBsYXllcik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAobGVhcm5lcnMubGVuZ3RoID09PSAwKSByZXR1cm47CgogICAgICAgICAgICAvLyBPbmx5IHNob3cgVUkgaWYgdGhlIGxlYXJuaW5nIHRlYW0gaXMgSHVtYW4gKEhvbWUpCiAgICAgICAgICAgIC8vIChPciBpZiB3ZSBhcmUgaW4gRGVtbyBtb2RlIGFuZCB3YW50IHRvIHNlZSBpdCBoYXBwZW4gZm9yIEhvbWUgdGVhbSkKICAgICAgICAgICAgaWYgKG9wcFRlYW0uaXNIdW1hbikgewogICAgICAgICAgICAgICAgLy8gRmlsdGVyIG91dCB0aG9zZSB3aG8gYWxyZWFkeSBrbm93IGl0CiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZExlYXJuZXJzID0gbGVhcm5lcnMuZmlsdGVyKHAgPT4gIXAubGVhcm5lZFRlY2hzLmluY2x1ZGVzKHRlY2hOYW1lKSk7CiAgICAgICAgICAgICAgICBpZiAodmFsaWRMZWFybmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydFRlY2hDb3B5V2luZG93KHRlY2hOYW1lLCB2YWxpZExlYXJuZXJzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCnN0YXJ0VGVjaENvcHlXaW5kb3codGVjaE5hbWUsIGxlYXJuZXJzKSB7CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUubWF4VGltZSA9IDAuNjsgLy8gMC42cyB3aW5kb3cKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLnRpbWVyID0gdGhpcy50ZWNoQ29weVN0YXRlLm1heFRpbWU7CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS50ZWNoID0gdGVjaE5hbWU7CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS5sZWFybmVycyA9IGxlYXJuZXJzOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2hvdyBVSQogICAgICAgICAgICBpZiAodGhpcy51aS50ZWNoRmxhc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5iYWNrZ3JvdW5kID0gIiI7IC8vIFJlc2V0IGJhY2tncm91bmQKICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoLnF1ZXJ5U2VsZWN0b3IoJy50ZWNoLXRleHQnKS5pbm5lclRleHQgPSAiVEVDSENPUFkhIjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaFN1YikgewogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFN1Yi5pbm5lclRleHQgPSB0ZWNoTmFtZS5yZXBsYWNlKCdfJywgJyAnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVzZXQgYmFyCiAgICAgICAgICAgICAgICBpZiAodGhpcy51aS50ZWNoVGltZXJGaWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoVGltZXJGaWxsLnN0eWxlLndpZHRoID0gJzEwMCUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKYXR0ZW1wdFRlY2hDb3B5KCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN1Y2Nlc3MhCiAgICAgICAgICAgIGNvbnN0IHRlY2ggPSB0aGlzLnRlY2hDb3B5U3RhdGUudGVjaDsKICAgICAgICAgICAgY29uc3QgbGVhcm5lcnMgPSB0aGlzLnRlY2hDb3B5U3RhdGUubGVhcm5lcnM7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZWFybmVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgLy8gRG91YmxlIGNoZWNrIHRvIHByZXZlbnQgZHVwbGljYXRlcwogICAgICAgICAgICAgICAgaWYgKCFwLmxlYXJuZWRUZWNocy5pbmNsdWRlcyh0ZWNoKSkgewogICAgICAgICAgICAgICAgICAgIHAubGVhcm5lZFRlY2hzLnB1c2godGVjaCk7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7cC5yb2xlfSBsZWFybmVkICR7dGVjaH0hYCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMS4gRmxvYXRpbmcgVGV4dAogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmZsb2F0aW5nVGV4dCAmJiBwLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mbG9hdGluZ1RleHQuc3Bhd24oYExFQVJORUQhYCwgcC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAyLiBQYXJ0aWNsZSBFZmZlY3QgKFNwaXJhbCkKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIG11bHRpcGxlIHBhcnRpY2xlcyBmb3IgYSBzd2lybCBlZmZlY3QKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MTA7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2xlYXJuZWQnLCBwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgaSAqIDUwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmVuZFRlY2hDb3B5V2luZG93KHRydWUpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgplbmRUZWNoQ29weVdpbmRvdyhzdWNjZXNzKSB7CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaEZsYXNoKSB7CiAgICAgICAgICAgICAgICBpZiAoc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoLnF1ZXJ5U2VsZWN0b3IoJy50ZWNoLXRleHQnKS5pbm5lclRleHQgPSAiU1VDQ0VTUyEiOwogICAgICAgICAgICAgICAgICAgIC8vIEZsYXNoIHN1Y2Nlc3MgY29sb3IgKFdoaXRlIGZsYXNoKQogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoLnN0eWxlLmJhY2tncm91bmQgPSAicmdiYSgyNTUsIDI1NSwgMjU1LCAwLjgpIjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBIaWRlIGFmdGVyIHNob3J0IGRlbGF5IHRvIHNob3cgdGhlIHN1Y2Nlc3MgZmxhc2gKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7IAogICAgICAgICAgICAgICAgICAgIH0sIDMwMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIEZhaWxlZCAvIE1pc3NlZAogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9Cl91cGRhdGVQbGF5ZXJTdGF0dXNVSSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW1zLmhvbWUgfHwgIXRoaXMudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCB1aSA9IHRoaXMudWkuc3RhdHVzUGFuZWw7CiAgICAgICAgICAgIAovLyBVSSBVcGRhdGVzIChBY3Rpb24gQnV0dG9uIENvbnRleHQpCiAgICAgICAgICAgICAgICB1aS5jb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE5hbWUgJiBMZXZlbAogICAgICAgICAgICAgICAgaWYgKHVpLm5hbWUpIHVpLm5hbWUuaW5uZXJUZXh0ID0gYCR7cC5jaGFyYWN0ZXJOYW1lIHx8IHAucm9sZX0gTFYke3AubGV2ZWx9YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSFAKICAgICAgICAgICAgICAgIGlmICh1aS5ocEJhcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhwUGN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMTAwLCAocC5zdGF0cy5IUCAvIHAuc3RhdHMubWF4SFApICogMTAwKSk7CiAgICAgICAgICAgICAgICAgICAgdWkuaHBCYXIuc3R5bGUud2lkdGggPSBgJHtocFBjdH0lYDsKICAgICAgICAgICAgICAgICAgICAvLyBDb2xvciBzaGlmdAogICAgICAgICAgICAgICAgICAgIGlmIChocFBjdCA8IDI1KSB1aS5ocEJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmMDAwMCwgI2ZmNDQ0NCknOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGhwUGN0IDwgNTApIHVpLmhwQmFyLnN0eWxlLmJhY2tncm91bmQgPSAnbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjZmZmZjAwLCAjZmZmZjg4KSc7CiAgICAgICAgICAgICAgICAgICAgZWxzZSB1aS5ocEJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzAwZmYwMCwgI2NjZmZjYyknOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHVpLmhwVGV4dCkgdWkuaHBUZXh0LmlubmVyVGV4dCA9IGAke01hdGguZmxvb3IocC5zdGF0cy5IUCl9LyR7cC5zdGF0cy5tYXhIUH1gOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBFWFAKICAgICAgICAgICAgICAgIGlmICh1aS5leHBCYXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBleHBQY3QgPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxMDAsIChwLmV4cCAvIHAubmV4dExldmVsRXhwKSAqIDEwMCkpOwogICAgICAgICAgICAgICAgICAgIHVpLmV4cEJhci5zdHlsZS53aWR0aCA9IGAke2V4cFBjdH0lYDsKdWkuZXhwQmFyLnN0eWxlLndpZHRoID0gYCR7ZXhwUGN0fSVgOwogICAgICAgICAgICAgICAgfQogICAgICAgIH0KCl9pbml0UGFydGljbGVzKCkgewogICAgICAgICAgICB0aGlzLmFjdGl2ZVNwYXJrcyA9IFtdOwogICAgICAgICAgICB0aGlzLnNwYXJrUG9vbCA9IFtdOwogICAgICAgICAgICBjb25zdCBwb29sU2l6ZSA9IDQwOyAvLyBTdWZmaWNpZW50IGZvciBjb250aW51b3VzIGdyaW5kaW5nCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvb2xTaXplOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUoX3NwYXJrTWF0ZXJpYWwuY2xvbmUoKSk7CiAgICAgICAgICAgICAgICBzcHJpdGUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQoc3ByaXRlKTsKICAgICAgICAgICAgICAgIHRoaXMuc3BhcmtQb29sLnB1c2goc3ByaXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd25DbGFzaChwb3MsIGludGVuc2l0eSA9IDEuMCkgewogICAgICAgICAgICAvLyBGaW5kIGZyZWUgc3BhcmsKICAgICAgICAgICAgY29uc3Qgc3BhcmsgPSB0aGlzLnNwYXJrUG9vbC5maW5kKHMgPT4gIXMudmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghc3BhcmspIHJldHVybjsgLy8gUG9vbCBleGhhdXN0ZWQKICAgICAgICAgICAgCiAgICAgICAgICAgIHNwYXJrLnBvc2l0aW9uLmNvcHkocG9zKTsKICAgICAgICAgICAgc3BhcmsudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYW5kb21pemUgcm90YXRpb24KICAgICAgICAgICAgc3BhcmsubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgQWN0aXZlIFN0YXRlCiAgICAgICAgICAgIHRoaXMuYWN0aXZlU3BhcmtzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogc3BhcmssCiAgICAgICAgICAgICAgICBhZ2U6IDAsCiAgICAgICAgICAgICAgICBsaWZlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMTUsIC8vIEZhc3QsIHB1bmNoeSBzcGFya3MKICAgICAgICAgICAgICAgIG1heFNjYWxlOiAyLjUgKiBpbnRlbnNpdHksCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSo4LCAKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKjgsIAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqOAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVQYXJ0aWNsZXMoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuYWN0aXZlU3BhcmtzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5hY3RpdmVTcGFya3NbaV07CiAgICAgICAgICAgICAgICBwLmFnZSArPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHAuYWdlID49IHAubGlmZSkgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVTcGFya3Muc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gcC5hZ2UgLyBwLmxpZmU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEV4cGFuZAogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNjYWxlID0gMC41ICsgKHAubWF4U2NhbGUgLSAwLjUpICogdDsKICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIoY3VycmVudFNjYWxlKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmFkZSBvdXQKICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wIC0gKHQgKiB0KTsgLy8gUXVhZHJhdGljIGZhZGUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gTW92ZQogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmFkZFNjYWxlZFZlY3RvcihwLnZlbG9jaXR5LCBkdCk7CiAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwucm90YXRpb24gKz0gMTAuMCAqIGR0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKLy8gSGVscGVyIGZvciBpbXBhY3QgZnJhbWVzCgp0cmlnZ2VySW1wYWN0KGR1cmF0aW9uLCB0eXBlID0gJ2RlZmF1bHQnKSB7CiAgICAgICAgICAgIHRoaXMuaW1wYWN0UGF1c2UgPSBkdXJhdGlvbjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnYW1lLWNvbnRhaW5lcicpOwogICAgICAgICAgICBpZiAoIWNvbnRhaW5lcikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gUmVzZXQgY2xhc3NlcyB0byBlbnN1cmUgYW5pbWF0aW9uIHJlc3RhcnRzCiAgICAgICAgICAgIGNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdpbXBhY3QtZngnLCAnaW1wYWN0LWhlYXZ5JywgJ2ltcGFjdC1zaGF0dGVyJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGb3JjZSByZWZsb3cKICAgICAgICAgICAgdm9pZCBjb250YWluZXIub2Zmc2V0V2lkdGg7CgogICAgICAgICAgICBsZXQgY2xhc3NOYW1lID0gJ2ltcGFjdC1meCc7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnaGVhdnknKSBjbGFzc05hbWUgPSAnaW1wYWN0LWhlYXZ5JzsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzaGF0dGVyJykgY2xhc3NOYW1lID0gJ2ltcGFjdC1zaGF0dGVyJzsKCiAgICAgICAgICAgIGNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKGNsYXNzTmFtZSk7CgogICAgICAgICAgICAvLyBBdXRvLXJlbW92ZSBjbGFzcyBhZnRlciBkdXJhdGlvbgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKGNsYXNzTmFtZSk7CiAgICAgICAgICAgIH0sIGR1cmF0aW9uICogMTAwMCArIDEwMCk7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkdhbWVNYW5hZ2VyID0gR2FtZU1hbmFnZXI7Cn0pKCk7","./GameManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFNwYXJrIFRleHR1cmUgKFByb2NlZHVyYWwgQnVyc3QpCiAgICBjb25zdCBfc3BhcmtUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw2NCw2NCk7CiAgICAgICAgCiAgICAgICAgLy8gQnVyc3Qgc2hhcGUKICAgICAgICBjb25zdCBjeCA9IDMyLCBjeSA9IDMyOwogICAgICAgIGNvbnN0IHNwaWtlcyA9IDg7CiAgICAgICAgY29uc3Qgb3V0ZXIgPSAzMDsKICAgICAgICBjb25zdCBpbm5lciA9IDEwOwogICAgICAgIAogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBmb3IobGV0IGk9MDsgaTxzcGlrZXMqMjsgaSsrKXsKICAgICAgICAgICAgY29uc3QgciA9IChpJTI9PT0wKT8gb3V0ZXIgOiBpbm5lcjsKICAgICAgICAgICAgY29uc3QgYSA9IChNYXRoLlBJKmkpL3NwaWtlczsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKnIsIGN5ICsgTWF0aC5zaW4oYSkqcik7CiAgICAgICAgfQogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmNjMDAnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgLy8gV2hpdGUgQ29yZQogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHguYXJjKGN4LCBjeSwgOCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjb25zdCBfc3BhcmtNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IAogICAgICAgIG1hcDogX3NwYXJrVGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBHYW1lTWFuYWdlciB7CgogICAgICAgIApjb25zdHJ1Y3RvcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEsIHJlbmRlcmVyKSB7CndpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIgPSByZW5kZXJlcjsgLy8gU3RvcmUgcmVuZGVyZXIKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmNhbWVyYSA9IGNhbWVyYTsKICAgICAgICAgICAgdGhpcy51aUxheWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodWlMYXllcklkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc2NvcmUgPSB7IGhvbWU6IDAsIGF3YXk6IDAgfTsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5oYWxmID0gMTsKICAgICAgICAgICAgdGhpcy5oYWxmRHVyYXRpb24gPSAzMDA7IC8vIDUgbWludXRlcyAoc2Vjb25kcykKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNEZW1vTW9kZSA9IGZhbHNlOwp0aGlzLmdhbWVNb2RlID0gJ25vcm1hbCc7IC8vICdub3JtYWwnIG9yICdwcmFjdGljZScKICAgICAgICAgICAgdGhpcy5pc0ZvcmdlTW9kZSA9IGZhbHNlOyAvLyBBc3NldCBGb3JnZSBTdGF0ZQogICAgICAgICAgICAvLyBJbXBhY3QgRnJhbWVzCiAgICAgICAgICAgIHRoaXMuaW1wYWN0UGF1c2UgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsgLy8gU3RhcnQgaW4gbWVudQp0aGlzLnRlYW1zID0gewogICAgICAgICAgICAgICAgaG9tZTogbnVsbCwKICAgICAgICAgICAgICAgIGF3YXk6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZW50aXRpZXMgPSB7CiAgICAgICAgICAgICAgICBiYWxsOiBudWxsCiAgICAgICAgICAgIH07Cgp0aGlzLnVpID0gewogICAgICAgICAgICAgICAgc2NvcmVQbGF5ZXI6IG51bGwsCiAgICAgICAgICAgICAgICBzY29yZUNwdTogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWVyOiBudWxsLAogICAgICAgICAgICAgICAgaGFsZjogbnVsbCwKICAgICAgICAgICAgICAgIGFubm91bmNlbWVudDogbnVsbCwKICAgICAgICAgICAgICAgIC8vIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgICAgIHN0YXR1c1BhbmVsOiB7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyOiBudWxsLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBCYXI6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBUZXh0OiBudWxsLAogICAgICAgICAgICAgICAgICAgIGV4cEJhcjogbnVsbAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVGVjaGNvcHkgU3RhdGUKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHRpbWVyOiAwLAogICAgICAgICAgICAgICAgdGVjaDogbnVsbCwKICAgICAgICAgICAgICAgIGxlYXJuZXJzOiBbXQogICAgICAgICAgICB9OwoKdGhpcy5taW5pTWFwID0gbmV3IHdpbmRvdy5mbHV4Lk1pbmlNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgRmxvYXRpbmcgVGV4dAovLyBJbml0aWFsaXplIEZsb2F0aW5nIFRleHQKdGhpcy5mbG9hdGluZ1RleHQgPSBuZXcgd2luZG93LmZsdXguRmxvYXRpbmdUZXh0TWFuYWdlcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBVSSBjYWxjdWxhdGlvbnMKICAgICAgICAgICAgdGhpcy5fdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIFBhcnRpY2xlIE1hbmFnZXIgKFN0YXR1cyBFZmZlY3RzKQogICAgICAgICAgICAKLy8gSW5pdGlhbGl6ZSBQYXJ0aWNsZSBNYW5hZ2VyIChTdGF0dXMgRWZmZWN0cykKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyKHNjZW5lKTsKdGhpcy5nbHlwaE1hbmFnZXIgPSBudWxsOyAvLyBJbmplY3RlZCBieSBtYWluLmpzCiAgICAgICAgICAgIHRoaXMuX2luaXRQYXJ0aWNsZXMoKTsgLy8gM0QgU3BhcmsgU3lzdGVtIChMZWdhY3kvSW1wYWN0KQoKdGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIgPSBuZXcgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyKHNjZW5lKTsKICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyKHRoaXMpOyAvLyBJbml0aWFsaXplIFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgdGhpcy5faW5qZWN0U3R5bGVzKCk7CnRoaXMuX2luaXRVSSgpOwogICAgICAgIH0KCl9pbml0Q2luZW1hdGljcygpIHsKICAgICAgICAgICAgdGhpcy5tZW51U2hvdEluZGV4ID0gMDsKICAgICAgICAgICAgdGhpcy5tZW51U2hvdFRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5tZW51U2hvdHMgPSBbCiAgICAgICAgICAgICAgICAvLyAxLiAiVGhlIEFyZW5hIiAtIFdpZGUgRXN0YWJsaXNoaW5nIFNob3QgKFNsb3cgZG9sbHkgaW4pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDEwLjAsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoNjAsIDM1LCA2MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAyID0gbmV3IFRIUkVFLlZlY3RvcjMoNDAsIDI1LCA0MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNtb290aHN0ZXAgaW50ZXJwb2xhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdCA9IHQgKiB0ICogKDMgLSAyICogdCk7IAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCBzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIDIuICJUaGUgVGVhbSIgLSBUcmFja2luZyBTaG90IGFsb25nIHRoZSBmb3JtYXRpb24KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogOC4wLAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBNb3ZlIGFsb25nIHRoZSBzaWRlIG9mIHRoZSBob21lIHRlYW0gZm9ybWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHpTdGFydCA9IC0yNTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgekVuZCA9IDI1OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50WiA9IHpTdGFydCArICh6RW5kIC0gelN0YXJ0KSAqIHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24uc2V0KC0yNSwgNiwgY3VycmVudFopOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KDAsIDIsIGN1cnJlbnRaICogMC44KTsgLy8gTG9vayBzbGlnaHRseSBhaGVhZCBvZiBjZW50ZXIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gMy4gIlRoZSBTdHJpa2VyIiAtIENsb3NlIHVwIG9yYml0IG9uIGEga2V5IHBvc2l0aW9uCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDguMCwKICAgICAgICAgICAgICAgICAgICB1cGRhdGU6ICh0LCBjYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9jdXMgb24gd2hlcmUgdGhlIExGL1JGIHVzdWFsbHkgc3RhbmRzIChhcHByb3ggKy8tIDEwLCAtMTApCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IG5ldyBUSFJFRS5WZWN0b3IzKC0xMCwgMCwgLTEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSB0ICogMS4wICsgMy41OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gMTAuMDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5wb3NpdGlvbi5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQueCArIE1hdGguY29zKGFuZ2xlKSAqIGRpc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQueSArIDQuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC56ICsgTWF0aC5zaW4oYW5nbGUpICogZGlzdAogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KHRhcmdldC54LCB0YXJnZXQueSArIDEuNSwgdGFyZ2V0LnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyA0LiAiVGhlIEdvYWwiIC0gTG93IEFuZ2xlIGxvb2tpbmcgdXAgYXQgdGhlIG5ldAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiA3LjAsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgLTUsIDMyKTsgLy8gTG93IG5lYXIgZ29hbAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwMiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDgsIDIwKTsgIC8vIFJpc2luZyB1cAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdCgwLCAxNSwgNDUpOyAvLyBMb29rIHVwIGF0IHRoZSBzdHJ1Y3R1cmUKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnJvdGF0aW9uLnogPSAodCAtIDAuNSkgKiAwLjE1OyAvLyBTbGlnaHQgY2luZW1hdGljIHRpbHQKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gNS4gIlRoZSBEaXZlIiAtIFZlcnRpY2FsIGRyb3AgaW50byB0aGUgcG9vbAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiA4LjAsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgNTAsIDApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwMiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEwLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3QgPSB0ICogdCAqICgzIC0gMiAqIHQpOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCBzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5yb3RhdGlvbi56ID0gdCAqIDAuODsgLy8gU3BpcmFsIGRvd24KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9Cl07CiAgICAgICAgfQoKICAgICAgICBfaW5qZWN0U3R5bGVzKCkgewogICAgICAgICAgICBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZsdXgtZHluYW1pYy1zdHlsZXMnKSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgICAgICAgICAgIHN0eWxlLmlkID0gJ2ZsdXgtZHluYW1pYy1zdHlsZXMnOwpzdHlsZS50ZXh0Q29udGVudCA9IGAKICAgICAgICAgICAgICAgIEBrZXlmcmFtZXMgdGV4dFNsYW0gewogICAgICAgICAgICAgICAgICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoNCk7IG9wYWNpdHk6IDA7IGxldHRlci1zcGFjaW5nOiA1MHB4OyB9CiAgICAgICAgICAgICAgICAgICAgMTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IG9wYWNpdHk6IDE7IGxldHRlci1zcGFjaW5nOiA1cHg7IH0KICAgICAgICAgICAgICAgICAgICAxNSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjEpOyB9CiAgICAgICAgICAgICAgICAgICAgMjAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IH0KICAgICAgICAgICAgICAgICAgICA4MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxKTsgb3BhY2l0eTogMTsgZmlsdGVyOiBibHVyKDBweCk7IH0KICAgICAgICAgICAgICAgICAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS41KTsgb3BhY2l0eTogMDsgZmlsdGVyOiBibHVyKDEwcHgpOyB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC5hbm5vdW5jZW1lbnQtc2xhbSB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICAgICAgICAgIHRvcDogNDUlOyBsZWZ0OiA1MCU7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDEwMCU7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnSW1wYWN0Jywgc2Fucy1zZXJpZjsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDk2cHg7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgICAgICAgICAgICAgICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZmZmZiAwJSwgI2ZmZGQwMCA0NSUsICNmZjg4MDAgMTAwJSk7CiAgICAgICAgICAgICAgICAgICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAgICAgICAgICAgICAgICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgICAgICAgICAgICAgICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggcmdiYSgwLDAsMCwxKSkgZHJvcC1zaGFkb3coMCAwIDMwcHggcmdiYSgyNTUsIDEwMCwgMCwgMC42KSk7CiAgICAgICAgICAgICAgICAgICAgei1pbmRleDogMjAwMDsKICAgICAgICAgICAgICAgICAgICBhbmltYXRpb246IHRleHRTbGFtIDEuOHMgY3ViaWMtYmV6aWVyKDAuMSwgMC44LCAwLjEsIDEpIGZvcndhcmRzOwogICAgICAgICAgICAgICAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICAgICAgICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLm1vZGFsLW92ZXJsYXkgewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgY2VudGVyLCByZ2JhKDEwLCAyNSwgNjAsIDAuOTUpIDAlLCByZ2JhKDAsIDAsIDAsIDAuOTgpIDEwMCUpOwogICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7IGp1c3RpZnktY29udGVudDogY2VudGVyOyBhbGlnbi1pdGVtczogY2VudGVyOyBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDE5MDA7CiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMDsgcG9pbnRlci1ldmVudHM6IG5vbmU7IHRyYW5zaXRpb246IG9wYWNpdHkgMC44czsKICAgICAgICAgICAgICAgICAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoOHB4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5tb2RhbC1vdmVybGF5LmFjdGl2ZSB7IG9wYWNpdHk6IDE7IHBvaW50ZXItZXZlbnRzOiBhdXRvOyB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC5tb2RhbC10aXRsZSB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdHYXJhbW9uZCcsIHNlcmlmOwogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogNTJweDsgY29sb3I6ICNmZmY7CiAgICAgICAgICAgICAgICAgICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwYWFmZiwgMCAwIDQwcHggIzAwNDRhYTsKICAgICAgICAgICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAzMHB4OwogICAgICAgICAgICAgICAgICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCAjMDBhYWZmOwogICAgICAgICAgICAgICAgICAgIHBhZGRpbmctYm90dG9tOiAxMHB4OwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiA4MCU7IHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgICAgICAgICBsZXR0ZXItc3BhY2luZzogNXB4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAubW9kYWwtc2NvcmUtY29udGFpbmVyIHsKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBnYXA6IDQwcHg7CiAgICAgICAgICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogNDBweDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5tb2RhbC1zY29yZSB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdJbXBhY3QnLCBzYW5zLXNlcmlmOwogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogODBweDsgY29sb3I6ICNmZmQ3MDA7CiAgICAgICAgICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggI2I4ODYwYjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5tb2RhbC12cyB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdDb3VyaWVyIE5ldycsIG1vbm9zcGFjZTsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDI0cHg7IGNvbG9yOiAjMDBhYWZmOyBvcGFjaXR5OiAwLjc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLmZsYXNoLW92ZXJsYXkgewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDIxMDA7CiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMDsgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjFzIGVhc2Utb3V0OwogICAgICAgICAgICAgICAgICAgIG1peC1ibGVuZC1tb2RlOiBvdmVybGF5OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIEBrZXlmcmFtZXMgY2xhc2hQb3AgewogICAgICAgICAgICAgICAgICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMC41KTsgb3BhY2l0eTogMTsgfQogICAgICAgICAgICAgICAgICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuNSk7IG9wYWNpdHk6IDAuODsgfQogICAgICAgICAgICAgICAgICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgyLjApOyBvcGFjaXR5OiAwOyB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLmNsYXNoLXNwYXJrIHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDYwcHg7IGhlaWdodDogNjBweDsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAjZmZmZmZmIDAlLCAjZmZmZjAwIDQwJSwgdHJhbnNwYXJlbnQgNzAlKTsKICAgICAgICAgICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgICAgICAgICAgICAgICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgICAgICAgICAgICAgei1pbmRleDogMTUwMDsKICAgICAgICAgICAgICAgICAgICBtaXgtYmxlbmQtbW9kZTogc2NyZWVuOwogICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbjogY2xhc2hQb3AgMC4zcyBlYXNlLW91dCBmb3J3YXJkczsKICAgICAgICAgICAgICAgICAgICBib3gtc2hhZG93OiAwIDAgMjBweCAjZmZhYTAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwogICAgICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHN0eWxlKTsKICAgICAgICB9CgogICAgICAgIHJlZ2lzdGVyVGVhbXMoaG9tZVRlYW0sIGF3YXlUZWFtLCBiYWxsKSB7CiAgICAgICAgICAgIHRoaXMudGVhbXMuaG9tZSA9IGhvbWVUZWFtOwogICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkgPSBhd2F5VGVhbTsKdGhpcy5lbnRpdGllcy5iYWxsID0gYmFsbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgTWluaU1hcAogICAgICAgICAgICBpZiAodGhpcy5taW5pTWFwKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1pbmlNYXAuaW5pdChob21lVGVhbSwgYXdheVRlYW0sIGJhbGwpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2luaXRVSSgpIHsKICAgICAgICAgICAgLy8gQmluZCB0byBleGlzdGluZyBIVE1MIGVsZW1lbnRzCiAgICAgICAgICAgIHRoaXMudWkuc2NvcmVQbGF5ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NvcmUtcGxheWVyJyk7CiAgICAgICAgICAgIHRoaXMudWkuc2NvcmVDcHUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NvcmUtY3B1Jyk7CiAgICAgICAgICAgIHRoaXMudWkudGltZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGltZXItZGlzcGxheScpOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGFsZi1pbmRpY2F0b3InKTsKICAgICAgICAgICAgdGhpcy51aS5hbm5vdW5jZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYW5ub3VuY2VtZW50Jyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZWNoLWZsYXNoLW92ZXJsYXknKTsKICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaEZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hTdWIgPSB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC1zdWItdGV4dCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50ZWNoLXRpbWVyLWZpbGwnKTsKCiAgICAgICAgICAgIC8vIEJpbmQgUGxheWVyIFN0YXR1cyBQYW5lbAogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJyk7CiAgICAgICAgICAgIHRoaXMudWkuc3RhdHVzUGFuZWwubmFtZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC5jaGFyLW5hbWUnKTsKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5ocEJhciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC5ocC1iYXItZmlsbCcpOwogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmhwVGV4dCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC5ocC12YWx1ZScpOwogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmV4cEJhciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC50ZWNoLWJhci1maWxsJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFbmQgR2FtZSBNZW51IEJpbmRpbmdzCiAgICAgICAgICAgIHRoaXMudWkuZW5kTWVudSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtZ2FtZS1tZW51Jyk7CiAgICAgICAgICAgIGNvbnN0IGJ0blJlbWF0Y2ggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLWJ0bi1yZW1hdGNoJyk7CiAgICAgICAgICAgIGNvbnN0IGJ0bkV4aXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLWJ0bi1leGl0Jyk7CgogICAgICAgICAgICBpZiAoYnRuUmVtYXRjaCkgewogICAgICAgICAgICAgICAgYnRuUmVtYXRjaC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlRW5kTWVudSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRNYXRjaCh0aGlzLmdhbWVNb2RlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChidG5FeGl0KSB7CiAgICAgICAgICAgICAgICBidG5FeGl0LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVFbmRNZW51KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ21lbnUnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDcmVhdGUgTW9kYWwgT3ZlcmxheSAoRm9yIEhhbGZ0aW1lIG9ubHkgbm93KQogICAgICAgICAgICB0aGlzLnVpLm1vZGFsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwuY2xhc3NOYW1lID0gJ21vZGFsLW92ZXJsYXknOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmlubmVySFRNTCA9IGAKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXRpdGxlIj5IQUxGIFRJTUU8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXNjb3JlLWNvbnRhaW5lciI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtc2NvcmUiIGlkPSJtb2RhbC1zY29yZS1ob21lIj4wPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtdnMiPi08L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC1zY29yZSIgaWQ9Im1vZGFsLXNjb3JlLWF3YXkiPjA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBpZD0ibW9kYWwtbXNnIiBzdHlsZT0iY29sb3I6ICMwMGFhZmY7IGZvbnQtc2l6ZTogMTRweDsgbGV0dGVyLXNwYWNpbmc6IDJweDsiPlBSRVBBUklORyAyTkQgSEFMRi4uLjwvZGl2PgogICAgICAgICAgICBgOwogICAgICAgICAgICB0aGlzLnVpTGF5ZXIuYXBwZW5kQ2hpbGQodGhpcy51aS5tb2RhbCk7CgogICAgICAgICAgICAvLyBDcmVhdGUgRmxhc2ggT3ZlcmxheQogICAgICAgICAgICB0aGlzLnVpLmZsYXNoID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHRoaXMudWkuZmxhc2guY2xhc3NOYW1lID0gJ2ZsYXNoLW92ZXJsYXknOwogICAgICAgICAgICB0aGlzLnVpTGF5ZXIuYXBwZW5kQ2hpbGQodGhpcy51aS5mbGFzaCk7CgogICAgICAgICAgICAvLyBJbml0aWFsIFN0YXRlCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoKTsKICAgICAgICAgICAgaWYgKHRoaXMudWkudGltZXIpIHRoaXMudWkudGltZXIuaW5uZXJUZXh0ID0gIjAwOjAwIjsKICAgICAgICB9CiAgICAgICAgX3VwZGF0ZVNjb3JlVUkoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnNjb3JlUGxheWVyKSB0aGlzLnVpLnNjb3JlUGxheWVyLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuaG9tZTsKICAgICAgICAgICAgaWYgKHRoaXMudWkuc2NvcmVDcHUpIHRoaXMudWkuc2NvcmVDcHUuaW5uZXJUZXh0ID0gdGhpcy5zY29yZS5hd2F5OwogICAgICAgIH0KCnVwZGF0ZVByYWN0aWNlKGR0KSB7CiAgICAgICAgICAgIC8vIERlbGVnYXRlIGxvZ2ljIHRvIFByYWN0aWNlTWFuYWdlcgogICAgICAgICAgICBpZiAodGhpcy5wcmFjdGljZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewoKaWYgKHRoaXMuc3RhdGUgPT09ICdpbnRybycpIHsKICAgICAgICAgICAgICAgIHRoaXMuaW50cm9UaW1lciArPSBkdDsKCiAgICAgICAgICAgICAgICAvLyAxLiBMaWdodHMgU2VxdWVuY2UgKDAuNXMgdG8gMi41cykKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0gJiYgdGhpcy5pbnRyb1RpbWVyID4gMC41ICYmIHRoaXMuaW50cm9UaW1lciA8IDIuNSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGR1cmF0aW9uID0gMi4wOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gKHRoaXMuaW50cm9UaW1lciAtIDAuNSkgLyBkdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b3RhbCA9IHRoaXMuc3RhZGl1bS5saWdodFNwcml0ZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2ZUNvdW50ID0gTWF0aC5mbG9vcihwcm9ncmVzcyAqIHRvdGFsKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0b3RhbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpIDw9IGFjdGl2ZUNvdW50ICYmICF0aGlzLnN0YWRpdW0ubGlnaHRTcHJpdGVzW2ldLnZpc2libGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhZGl1bS50dXJuT25MaWdodChpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyLiBDYW1lcmEgTW92ZW1lbnQgKFNwaXJhbCBJbikKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLmludHJvVGltZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHVyYXRpb24gPSA1LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGN0ID0gTWF0aC5taW4oMS4wLCB0IC8gZHVyYXRpb24pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFNtb290aCBlYXNlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWFzZSA9IDEgLSBNYXRoLnBvdygxIC0gcGN0LCAzKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGFydFJhZGl1cyA9IDEyMDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbmRSYWRpdXMgPSA0MDsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYWRpdXMgPSBzdGFydFJhZGl1cyArIChlbmRSYWRpdXMgLSBzdGFydFJhZGl1cykgKiBlYXNlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0SGVpZ2h0ID0gNjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kSGVpZ2h0ID0gMjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGVpZ2h0ID0gc3RhcnRIZWlnaHQgKyAoZW5kSGVpZ2h0IC0gc3RhcnRIZWlnaHQpICogZWFzZTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IHQgKiAwLjQ7IC8vIFJvdGF0aW9uCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uc2V0KAogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLnNpbihhbmdsZSkgKiByYWRpdXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5jb3MoYW5nbGUpICogcmFkaXVzCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMy4gQ3Jvd2QgUm9hciAvIEh5cGUgKDMuMHMpCiAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnRyb1RpbWVyID4gMy4wICYmICF0aGlzLl9pbnRyb1JvYXJUcmlnZ2VyZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9pbnRyb1JvYXJUcmlnZ2VyZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQVJFIFlPVSBSRUFEWT8iLCAic2xhbSIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgxLjUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZsYXNoIGNyb3dkCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bSAmJiB0aGlzLnN0YWRpdW0uY3Jvd2QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2UgY2FuJ3QgZWFzaWx5IGZsYXNoIGluc3RhbmNlZCBtZXNoIGNvbG9yIHdpdGhvdXQgaXRlcmF0aW5nLCAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYnV0IHdlIGNhbiBzcGF3biBzb21lIHBhcnRpY2xlcwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDIwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSoxMDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEwICsgTWF0aC5yYW5kb20oKSoyMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSoxMDAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIHBvcywgeyBzY2FsZTogNS4wIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDQuIEVuZCBJbnRybyAoNS4wcykKICAgICAgICAgICAgICAgIGlmICh0aGlzLmludHJvVGltZXIgPiA1LjApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9pbnRyb1JvYXJUcmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAvLyBSZXN0b3JlIFVJCiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKS5zdHlsZS5vcGFjaXR5ID0gJzEnOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJykuc3R5bGUub3BhY2l0eSA9ICcxJzsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgYWxsIGxpZ2h0cyBvbgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS5zZXRBbGxMaWdodHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNldFJvdW5kKG51bGwpOyAvLyBHbyB0byBraWNrb2ZmCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnbWVudScpIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBQT1BVTEFURSBBUkVOQSBGT1IgQi1ST0xMIC0tLQogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHBsYXllcnMgYXJlIHZpc2libGUgYW5kIGFuaW1hdGVkCiAgICAgICAgICAgICAgICBjb25zdCBhbmltYXRlVGVhbSA9ICh0ZWFtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0ZWFtKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgdGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdlbnRsZSBib2JiaW5nIHRvIHNpbXVsYXRlIHRyZWFkaW5nIHdhdGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24ueSA9IHAuaG9tZVBvc2l0aW9uLnkgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDIgKyBwLm1lc2guaWQpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIGlkbGUgYW5pbWF0aW9uIGlzIHBsYXlpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnN0YXRlICE9PSAnaWRsZScpIHAucGxheSgnaWRsZScsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5taXhlcikgcC5taXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgYW5pbWF0ZVRlYW0odGhpcy50ZWFtcy5ob21lKTsKICAgICAgICAgICAgICAgIGFuaW1hdGVUZWFtKHRoaXMudGVhbXMuYXdheSk7CgogICAgICAgICAgICAgICAgLy8gLS0tIENJTkVNQVRJQyBCLVJPTEwgLS0tCiAgICAgICAgICAgICAgICBpZiAodGhpcy5tZW51U2hvdHMgJiYgdGhpcy5tZW51U2hvdHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNob3QgPSB0aGlzLm1lbnVTaG90c1t0aGlzLm1lbnVTaG90SW5kZXhdOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVudVNob3RUaW1lciArPSBkdDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5tZW51U2hvdFRpbWVyID49IHNob3QuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U2hvdFRpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U2hvdEluZGV4ID0gKHRoaXMubWVudVNob3RJbmRleCArIDEpICUgdGhpcy5tZW51U2hvdHMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWxpemUgdGltZSAoMCB0byAxKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLm1lbnVTaG90VGltZXIgLyBzaG90LmR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgICAgICBzaG90LnVwZGF0ZSh0LCB0aGlzLmNhbWVyYSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFtYmllbnQgRlggaW4gTWVudQogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIE1hdGgucmFuZG9tKCkgPCAwLjIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biByYW5kb20gYnViYmxlcyBmb3IgYXRtb3NwaGVyZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhbmdlID0gNjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqcmFuZ2UsIAogICAgICAgICAgICAgICAgICAgICAgICAtMTAgKyBNYXRoLnJhbmRvbSgpKjIwLCAKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSpyYW5nZQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2J1YmJsZScsIHBvcywgeyBsaWZlOiAzLjAgKyBNYXRoLnJhbmRvbSgpKjIuMCwgc2NhbGU6IDAuMyArIE1hdGgucmFuZG9tKCkqMC40IH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBCYWNrZ3JvdW5kIFN5c3RlbXMKICAgICAgICAgICAgICAgIGlmICh0aGlzLndhdGVyT3ZlcmxheSkgdGhpcy53YXRlck92ZXJsYXkudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmxpZ2h0U2hhZnRzKSB0aGlzLmxpZ2h0U2hhZnRzLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGFkaXVtKSB0aGlzLnN0YWRpdW0udXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgdGhpcy5wYXJ0aWNsZU1hbmFnZXIudXBkYXRlKGR0KTsKCiAgICAgICAgICAgICAgICAvLyBSZW5kZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlbmRlcmVyICYmIHRoaXMuc2NlbmUgJiYgdGhpcy5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbmRlcih0aGlzLnNjZW5lLCB0aGlzLmNhbWVyYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCi8vIC0tLSBMT0dJQyBVUERBVEUgKFN0YXRlIERlcGVuZGVudCkgLS0tCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnYWN0aXZlJykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZU1vZGUgPT09ICdwcmFjdGljZScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVByYWN0aWNlKGR0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50aW1lICs9IGR0OwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tIYWxmVGltZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrR29hbHMoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXBkYXRlIFRlY2hjb3B5IFdpbmRvdwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIFVJIEJhcgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hUaW1lckZpbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGN0ID0gTWF0aC5tYXgoMCwgKHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciAvIHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lKSAqIDEwMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9IGAke3BjdH0lYDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbG9yIHNoaWZ0IGJhc2VkIG9uIHVyZ2VuY3kKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBjdCA8IDMwKSB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICcjZmYwMDAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZmZmZmYsICMwMGZmZmYpJzsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZFRlY2hDb3B5V2luZG93KGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBWSVNVQUwgVVBEQVRFIChBbHdheXMgUnVuKSAtLS0KICAgICAgICAgICAgLy8gVXBkYXRlIHRoZXNlIGluIGFsbCBzdGF0ZXMgKEFjdGl2ZSwgR29hbCwgSGFsZnRpbWUsIEdhbWVPdmVyKSB0byBrZWVwIEZYIGFsaXZlCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnbWVudScgJiYgdGhpcy5zdGF0ZSAhPT0gJ2ludHJvJykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMubWluaU1hcCkgdGhpcy5taW5pTWFwLnVwZGF0ZSgpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZmxvYXRpbmdUZXh0KSB0aGlzLmZsb2F0aW5nVGV4dC51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB0aGlzLnBhcnRpY2xlTWFuYWdlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFydGljbGVzKGR0KTsgLy8gTGVnYWN5IHNwYXJrcwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVidWdWaXN1YWxpemVyKSB0aGlzLmRlYnVnVmlzdWFsaXplci51cGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgX3VwZGF0ZU9mZnNjcmVlbkluZGljYXRvcigpIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMudGVhbXMuaG9tZSA/IHRoaXMudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIgOiBudWxsOwogICAgICAgICAgICBjb25zdCBpbmRpY2F0b3IgPSB0aGlzLnVpLm9mZnNjcmVlbkluZGljYXRvcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghcCB8fCAhcC5tZXNoIHx8ICF0aGlzLmNhbWVyYSB8fCAhaW5kaWNhdG9yKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBHZXQgUGxheWVyIFBvc2l0aW9uIChDZW50ZXIgTWFzcykKICAgICAgICAgICAgY29uc3QgcG9zID0gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgIHBvcy55ICs9IDEuMDsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAyLiBQcm9qZWN0IHRvIE5vcm1hbGl6ZWQgRGV2aWNlIENvb3JkaW5hdGVzIChOREMpIFstMSwgMV0KICAgICAgICAgICAgdGhpcy5fdGVtcFZlYy5jb3B5KHBvcykucHJvamVjdCh0aGlzLmNhbWVyYSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBDaGVjayBpZiBCZWhpbmQgQ2FtZXJhCiAgICAgICAgICAgIGNvbnN0IGNhbUZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKGNhbUZ3ZCk7CiAgICAgICAgICAgIGNvbnN0IHRvUGxheWVyID0gcG9zLmNsb25lKCkuc3ViKHRoaXMuY2FtZXJhLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgY29uc3QgZG90ID0gY2FtRndkLmRvdCh0b1BsYXllcik7CiAgICAgICAgICAgIGNvbnN0IGlzQmVoaW5kID0gZG90IDwgMC4yOyAvLyBCdWZmZXIgdG8gcHJldmVudCBmbGlwcGluZyBhdCBlZGdlCgogICAgICAgICAgICAvLyA0LiBDaGVjayBCb3VuZHMKICAgICAgICAgICAgY29uc3QgaXNPZmZTY3JlZW4gPSAoCiAgICAgICAgICAgICAgICB0aGlzLl90ZW1wVmVjLnggPCAtMC45IHx8IHRoaXMuX3RlbXBWZWMueCA+IDAuOSB8fAogICAgICAgICAgICAgICAgdGhpcy5fdGVtcFZlYy55IDwgLTAuOSB8fCB0aGlzLl90ZW1wVmVjLnkgPiAwLjkgfHwKICAgICAgICAgICAgICAgIGlzQmVoaW5kCiAgICAgICAgICAgICk7CgogICAgICAgICAgICBpZiAoaXNPZmZTY3JlZW4pIHsKICAgICAgICAgICAgICAgIGluZGljYXRvci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHggPSB0aGlzLl90ZW1wVmVjLng7CiAgICAgICAgICAgICAgICBsZXQgeSA9IHRoaXMuX3RlbXBWZWMueTsKCiAgICAgICAgICAgICAgICAvLyBJZiBiZWhpbmQsIGludmVydCBjb29yZGluYXRlcyB0byBwb2ludCBjb3JyZWN0bHkKICAgICAgICAgICAgICAgIGlmIChpc0JlaGluZCkgewogICAgICAgICAgICAgICAgICAgIHggPSAteDsKICAgICAgICAgICAgICAgICAgICB5ID0gLXk7CiAgICAgICAgICAgICAgICAgICAgLy8gRml4IHNpbmd1bGFyaXR5IGlmIGV4YWN0bHkgYmVoaW5kIGNlbnRlcgogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyh4KSA8IDAuMDEgJiYgTWF0aC5hYnMoeSkgPCAwLjAxKSB5ID0gLTE7IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENsYW1wIHRvIHNjcmVlbiBlZGdlcwogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCB0byBmaW5kIHRoZSBpbnRlcnNlY3Rpb24gb2YgdGhlIHZlY3RvciAoeCx5KSB3aXRoIHRoZSBib3ggWy0wLjksIDAuOV0KICAgICAgICAgICAgICAgIGNvbnN0IHBhZGRpbmcgPSAwLjk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSB0byBnZXQgZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBjb25zdCBtYWcgPSBNYXRoLnNxcnQoeCp4ICsgeSp5KTsKICAgICAgICAgICAgICAgIGNvbnN0IG54ID0geCAvIG1hZzsKICAgICAgICAgICAgICAgIGNvbnN0IG55ID0geSAvIG1hZzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmF5Y2FzdCB0byBib3ggZWRnZXMKICAgICAgICAgICAgICAgIC8vIFZlcnRpY2FsIGVkZ2VzOiB4ID0gKy8tIHBhZGRpbmcKICAgICAgICAgICAgICAgIC8vIEhvcml6b250YWwgZWRnZXM6IHkgPSArLy0gcGFkZGluZwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBdm9pZCBkaXZpZGUgYnkgemVybwogICAgICAgICAgICAgICAgY29uc3QgdHggPSAoTWF0aC5hYnMobngpID4gMC4wMDEpID8gKG54ID4gMCA/IHBhZGRpbmcgOiAtcGFkZGluZykgLyBueCA6IDk5OTsKICAgICAgICAgICAgICAgIGNvbnN0IHR5ID0gKE1hdGguYWJzKG55KSA+IDAuMDAxKSA/IChueSA+IDAgPyBwYWRkaW5nIDogLXBhZGRpbmcpIC8gbnkgOiA5OTk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFVzZSB0aGUgbmVhcmVzdCBpbnRlcnNlY3Rpb24gKHNtYWxsZXN0IHBvc2l0aXZlIHQpCiAgICAgICAgICAgICAgICAvLyBTaW5jZSB3ZSBhcmUgcHJvamVjdGluZyBmcm9tIGNlbnRlciAoMCwwKSB0byAobngsbnkpLCB0IG11c3QgYmUgcG9zaXRpdmUuCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gTWF0aC5taW4oTWF0aC5hYnModHgpLCBNYXRoLmFicyh0eSkpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBzY3JlZW5YID0gbnggKiB0OwogICAgICAgICAgICAgICAgY29uc3Qgc2NyZWVuWSA9IG55ICogdDsKCiAgICAgICAgICAgICAgICAvLyBDb252ZXJ0IE5EQyB0byBQaXhlbHMKICAgICAgICAgICAgICAgIGNvbnN0IHdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBoZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHB4ID0gKHNjcmVlblggKiAwLjUgKyAwLjUpICogd2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBweSA9ICgtKHNjcmVlblkpICogMC41ICsgMC41KSAqIGhlaWdodDsKCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgUm90YXRpb24KICAgICAgICAgICAgICAgIC8vIEFycm93IHBvaW50cyBVUCBieSBkZWZhdWx0LgogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCBpdCB0byBwb2ludCBpbiBkaXJlY3Rpb24gKG54LCBueSkgb24gc2NyZWVuLgogICAgICAgICAgICAgICAgLy8gU2NyZWVuIFkgaXMgZG93biAoaW52ZXJ0ZWQgZnJvbSBXZWJHTCBZKS4KICAgICAgICAgICAgICAgIC8vIFNvICgwLCAxKSBpbiBOREMgaXMgVVAuICgwLCAtMSkgaW4gTkRDIGlzIERPV04uCiAgICAgICAgICAgICAgICAvLyBhdGFuMih5LCB4KSBnaXZlcyBhbmdsZSBmcm9tICtYLgogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCBhbmdsZSBmcm9tICtZIChVcCkuCiAgICAgICAgICAgICAgICAvLyBSb3RhdGlvbiA9IFBJLzIgLSBhbmdsZS4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKG55LCBueCk7CiAgICAgICAgICAgICAgICBjb25zdCByb3QgPSAoTWF0aC5QSSAvIDIpIC0gYW5nbGU7CgogICAgICAgICAgICAgICAgaW5kaWNhdG9yLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHtweH1weCwgJHtweX1weCkgcm90YXRlKCR7cm90fXJhZClgOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgaW5kaWNhdG9yLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVUaW1lcigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnVpLnRpbWVyKSByZXR1cm47CiAgICAgICAgICAgIC8vIENsYW1wIHRvIGhhbGYgZHVyYXRpb24gZm9yIGRpc3BsYXkgaWYgd2UgZ28gc2xpZ2h0bHkgb3ZlciBiZWZvcmUgdGljawogICAgICAgICAgICBjb25zdCB0ID0gTWF0aC5taW4odGhpcy50aW1lLCB0aGlzLmhhbGZEdXJhdGlvbik7CiAgICAgICAgICAgIGNvbnN0IG1pbnV0ZXMgPSBNYXRoLmZsb29yKHQgLyA2MCk7CiAgICAgICAgICAgIGNvbnN0IHNlY29uZHMgPSBNYXRoLmZsb29yKHQgJSA2MCk7CiAgICAgICAgICAgIHRoaXMudWkudGltZXIuaW5uZXJUZXh0ID0gYCR7bWludXRlcy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9OiR7c2Vjb25kcy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9YDsKICAgICAgICB9CiAgICAgICAgX2NoZWNrSGFsZlRpbWUoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnRpbWUgPj0gdGhpcy5oYWxmRHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5kSGFsZigpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKZW5kSGFsZigpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdoYWxmdGltZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdG9wIGFsbCBwbGF5ZXJzCiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFsZiA9PT0gMSkgewogICAgICAgICAgICAgICAgdGhpcy5fc2hvd01vZGFsKCJIQUxGIFRJTUUiLCAiUFJFUEFSSU5HIDJORCBIQUxGLi4uIik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBQbGF5IHdoaXN0bGUgc291bmQgaGVyZSBpZiBhdmFpbGFibGUKICAgICAgICAgICAgICAgIC8vIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnd2hpc3RsZScpOwoKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVNb2RhbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRTZWNvbmRIYWxmKCk7CiAgICAgICAgICAgICAgICB9LCA0MDAwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEVuZCBvZiAybmQgSGFsZiBvciBPdmVydGltZSBQZXJpb2QKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNjb3JlLmhvbWUgPT09IHRoaXMuc2NvcmUuYXdheSkgewogICAgICAgICAgICAgICAgICAgIC8vIFRJRUQgLSBHbyB0byBPdmVydGltZSAoR29sZGVuIEdvYWwpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd01vZGFsKCJPVkVSVElNRSIsICJHT0xERU4gR09BTCBSVUxFIEFDVElWRSIpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlTW9kYWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydE92ZXJ0aW1lKCk7CiAgICAgICAgICAgICAgICAgICAgfSwgNDAwMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIFdpbm5lciBkZWNpZGVkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmRHYW1lKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHN0YXJ0U2Vjb25kSGFsZigpIHsKICAgICAgICAgICAgdGhpcy5oYWxmID0gMjsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICIybmQgSEFMRiI7CiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsgLy8gTmV1dHJhbCBCbGl0ei1vZmYgZm9yIDJuZCBoYWxmIHN0YXJ0CiAgICAgICAgfQoKICAgICAgICBzdGFydE92ZXJ0aW1lKCkgewogICAgICAgICAgICB0aGlzLmhhbGYrKzsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICJPVkVSVElNRSI7CiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsgLy8gTmV1dHJhbCBCbGl0ei1vZmYKICAgICAgICB9CgplbmRHYW1lKCkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2dhbWVvdmVyJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN0b3AgcGxheWVycwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gcC5zZXRJbnB1dCgwLCAwKSk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKCiAgICAgICAgICAgIGxldCBtc2cgPSAiRFJBVyI7CiAgICAgICAgICAgIGlmICh0aGlzLnNjb3JlLmhvbWUgPiB0aGlzLnNjb3JlLmF3YXkpIG1zZyA9ICJWSUNUT1JZIjsKICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuYXdheSA+IHRoaXMuc2NvcmUuaG9tZSkgbXNnID0gIkRFRkVBVCI7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQb3B1bGF0ZSBFbmQgR2FtZSBNZW51CiAgICAgICAgICAgIGlmICh0aGlzLnVpLmVuZE1lbnUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRpdGxlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLXJlc3VsdC10aXRsZScpOwogICAgICAgICAgICAgICAgY29uc3QgaG9tZVNjb3JlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLXNjb3JlLWhvbWUnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF3YXlTY29yZUVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1zY29yZS1hd2F5Jyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aXRsZUVsKSB7CiAgICAgICAgICAgICAgICAgICAgdGl0bGVFbC5pbm5lclRleHQgPSBtc2c7CiAgICAgICAgICAgICAgICAgICAgdGl0bGVFbC5zdHlsZS5jb2xvciA9IChtc2cgPT09ICJWSUNUT1JZIikgPyAiIzAwZmZmZiIgOiAoKG1zZyA9PT0gIkRFRkVBVCIpID8gIiNmZjQ0NDQiIDogIiNmZmZmZmYiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChob21lU2NvcmVFbCkgaG9tZVNjb3JlRWwuaW5uZXJUZXh0ID0gdGhpcy5zY29yZS5ob21lOwogICAgICAgICAgICAgICAgaWYgKGF3YXlTY29yZUVsKSBhd2F5U2NvcmVFbC5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmF3YXk7CgogICAgICAgICAgICAgICAgdGhpcy51aS5lbmRNZW51LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgdGhpcy5zZXRNZW51TW9kZSh0cnVlKTsgLy8gSGlkZSBIVUQKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3RvcCBNdXNpYyBvbiBHYW1lIE92ZXIKICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5zdG9wQkdNKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9oaWRlRW5kTWVudSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudWkuZW5kTWVudSkgewogICAgICAgICAgICAgICAgdGhpcy51aS5lbmRNZW51LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgdGhpcy5zZXRNZW51TW9kZShmYWxzZSk7IC8vIFNob3cgSFVECiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zaG93TW9kYWwodGl0bGUsIHN1YnRleHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnVpLm1vZGFsKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLnF1ZXJ5U2VsZWN0b3IoJy5tb2RhbC10aXRsZScpLmlubmVyVGV4dCA9IHRpdGxlOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLnF1ZXJ5U2VsZWN0b3IoJyNtb2RhbC1zY29yZS1ob21lJykuaW5uZXJUZXh0ID0gdGhpcy5zY29yZS5ob21lOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLnF1ZXJ5U2VsZWN0b3IoJyNtb2RhbC1zY29yZS1hd2F5JykuaW5uZXJUZXh0ID0gdGhpcy5zY29yZS5hd2F5OwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLnF1ZXJ5U2VsZWN0b3IoJyNtb2RhbC1tc2cnKS5pbm5lclRleHQgPSBzdWJ0ZXh0OwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhpZGUgSFVEIGVsZW1lbnRzCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJykuc3R5bGUub3BhY2l0eSA9ICcwJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKS5zdHlsZS5vcGFjaXR5ID0gJzAnOwogICAgICAgIH0KCiAgICAgICAgX2hpZGVNb2RhbCgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnVpLm1vZGFsKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaG93IEhVRCBlbGVtZW50cwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaHVkLXRvcCcpLnN0eWxlLm9wYWNpdHkgPSAnMSc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJykuc3R5bGUub3BhY2l0eSA9ICcxJzsKICAgICAgICB9CgpfY2hlY2tHb2FscygpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHBvcyA9IGJhbGwubWVzaC5wb3NpdGlvbjsKCiAgICAgICAgICAgIC8vIFByZWNpc2UgR29hbCBEZXRlY3Rpb24KICAgICAgICAgICAgLy8gVmlzdWFsIEdvYWwgaXMgYXQgWiA9ICsvLSAyOC4KICAgICAgICAgICAgLy8gV2UgZGVmaW5lIGEgIkdvYWwgTW91dGgiIGJveCBtYXRjaGluZyBHb2FsaWUuanMgKFdpZHRoIDE0LCBIZWlnaHQgOCkuCi8vIFdlIGRlZmluZSBhICJHb2FsIE1vdXRoIiBib3ggbWF0Y2hpbmcgdGhlIHZpc3VhbCBuZXQuCiAgICAgICAgICAgIC8vIEFyZW5hIFJhZGl1cyBpcyAzMi4gR29hbCBpcyByb3VnaGx5IDIybSB3aWRlLCAxOG0gaGlnaC4KLy8gQXJlbmEgUmFkaXVzIGlzIDMyLiBHb2FsIGlzIHJvdWdobHkgMjJtIHdpZGUsIDE4bSBoaWdoLgogICAgICAgICAgICBjb25zdCBoYWxmV2lkdGggPSAxMS4wOyAvLyBJbmNyZWFzZWQgdG8gMTEgKFdpZHRoIDIyKSB0byBjYXRjaCBjb3JuZXJzCiAgICAgICAgICAgIGNvbnN0IGhhbGZIZWlnaHQgPSA5LjA7IC8vIEluY3JlYXNlZCB0byA5IChIZWlnaHQgMTgpIHRvIGNhdGNoIGhpZ2ggc2hvdHMKICAgICAgICAgICAgY29uc3QgZ29hbFlPZmZzZXQgPSAtNC41OyAvLyBNb3ZlZCBkb3duIHRvIG1hdGNoIHZpc3VhbCBtb2RlbCAoLTQuNW0pCgogICAgICAgICAgICBjb25zdCB0cmlnZ2VyWiA9IDQ1LjA7IC8vIFRyaWdnZXIgZWFybGllciAod2FzIDMwKSB0byBlbnN1cmUgcmVnaXN0cmF0aW9uIGJlZm9yZSBib3VuY2UKCiAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueikgPiB0cmlnZ2VyWikgewogICAgICAgICAgICAgICAgLy8gUFJFVkVOVCBPV04gR09BTCBCWSBDQVJSSUVSIChVc2VyIFJlcXVlc3QpCiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgYmFsbCBpcyBoZWxkIGJ5IHRoZSB0ZWFtIGRlZmVuZGluZyB0aGlzIGdvYWwsIGRvIG5vdCBjb3VudCBpdC4KICAgICAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIC8vIEhvbWUgKFNpZGUgMSkgZGVmZW5kcyArWi4gSWYgcG9zLnogPiAwIChIb21lIEdvYWwpIGFuZCBob2xkZXIgaXMgSG9tZSwgaWdub3JlLgogICAgICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IDAgJiYgYmFsbC5ob2xkZXIudGVhbS5zaWRlID09PSAxKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgLy8gQXdheSAoU2lkZSAtMSkgZGVmZW5kcyAtWi4gSWYgcG9zLnogPCAwIChBd2F5IEdvYWwpIGFuZCBob2xkZXIgaXMgQXdheSwgaWdub3JlLgogICAgICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IDAgJiYgYmFsbC5ob2xkZXIudGVhbS5zaWRlID09PSAtMSkgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDIuIENoZWNrIEZyYW1lIChNdXN0IGJlIHdpdGhpbiB3aWR0aC9oZWlnaHQpCi8vIDIuIENoZWNrIEZyYW1lIChNdXN0IGJlIHdpdGhpbiB3aWR0aC9oZWlnaHQsIGFjY291bnRpbmcgZm9yIFkgb2Zmc2V0KQogICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHBvcy54KSA8PSBoYWxmV2lkdGggJiYgTWF0aC5hYnMocG9zLnkgLSBnb2FsWU9mZnNldCkgPD0gaGFsZkhlaWdodCkgewogICAgICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nb2FsU2NvcmVkKCdob21lJyk7IC8vIEhvbWUgYXR0YWNrcyAtWgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ29hbFNjb3JlZCgnYXdheScpOyAvLyBBd2F5IGF0dGFja3MgK1oKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpnb2FsU2NvcmVkKHNjb3JlcikgewogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ2FjdGl2ZScpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElNUEFDVCBGUkFNRTogR09BTAogICAgICAgICAgICB0aGlzLnRyaWdnZXJJbXBhY3QoMC40LCAnc2hhdHRlcicpOyAvLyBNYXNzaXZlIGZyZWV6ZSBmb3IgZ29hbAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRVhQIFJFV0FSRDogR29hbAogICAgICAgICAgICAvLyBGaW5kIHdobyBzY29yZWQgKExhc3QgaG9sZGVyIG9mIGJhbGwpCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmIChiYWxsICYmIGJhbGwubGFzdEhvbGRlciAmJiBiYWxsLmxhc3RIb2xkZXIudGVhbS5pZCA9PT0gc2NvcmVyKSB7CiAgICAgICAgICAgICAgICBiYWxsLmxhc3RIb2xkZXIuZ2FpbkV4cCgxMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZ29hbCc7CiAgICAgICAgICAgIHRoaXMuc2NvcmVbc2NvcmVyXSsrOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAxLiBWSVNDRVJBTCBTSEFLRSAmIFBBUlRJQ0xFUwogICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMi4wKTsgLy8gSGVhdnkgc2hha2UKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIgJiYgdGhpcy5lbnRpdGllcy5iYWxsICYmIHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnb2FsUG9zID0gdGhpcy5lbnRpdGllcy5iYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgIC8vIE1hc3NpdmUgR29hbCBFeHBsb3Npb24KICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBnb2FsUG9zLCB7IHNjYWxlOiAxNS4wLCBsaWZlOiAwLjggfSk7CiAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBnb2FsUG9zLCB7IHNjYWxlOiAxMC4wIH0pOwogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzA7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdkZWJyaXMnLCBnb2FsUG9zLCB7IHNjYWxlOiAwLjggfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gMi4gU0NSRUVOIEZMQVNICiAgICAgICAgICAgIGlmICh0aGlzLnVpLmZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmZsYXNoLnN0eWxlLm9wYWNpdHkgPSAnMC44JzsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyB0aGlzLnVpLmZsYXNoLnN0eWxlLm9wYWNpdHkgPSAnMCc7IH0sIDEwMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIEdPTERFTiBHT0FMIENIRUNLCiAgICAgICAgICAgIGlmICh0aGlzLmlzT3ZlcnRpbWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiR09MREVOIEdPQUwhIiwgJ3NsYW0nKTsKICAgICAgICAgICAgICAgIC8vIEVuZCBnYW1lIGFmdGVyIHNob3J0IGRlbGF5CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgIH0sIDMwMDApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA0LiBTTEFNIEFOTk9VTkNFTUVOVCAoTm9ybWFsKQogICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkdPQUwhIiwgJ3NsYW0nKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IHNlcXVlbmNlCiAgICAgICAgICAgIC8vIFNjb3JlZC11cG9uIHRlYW0gZ2V0cyBiYWxsCiAgICAgICAgICAgIGNvbnN0IGxvc2VyID0gc2NvcmVyID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGQVNURVIgRkxPVzogUmVkdWNlZCBkZWxheSBmcm9tIDMwMDBtcyB0byAxMjAwbXMKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0Um91bmQobG9zZXIpOwogICAgICAgICAgICB9LCAyMDAwKTsgLy8gU2xpZ2h0bHkgbG9uZ2VyIHRvIGFwcHJlY2lhdGUgdGhlICJHT0FMIiBzbGFtCiAgICAgICAgfQoKc2hvd0Fubm91bmNlbWVudCh0ZXh0LCB0eXBlID0gJ25vcm1hbCcsIGR1cmF0aW9uID0gMjAwMCkgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkuYW5ub3VuY2VtZW50OwogICAgICAgICAgICBpZiAoIWVsKSByZXR1cm47CgogICAgICAgICAgICAvLyBDbGVhciBwcmV2aW91cyB0aW1lb3V0CiAgICAgICAgICAgIGlmICh0aGlzLl9hbm5vdW5jZVRpbWVvdXQpIHsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9hbm5vdW5jZVRpbWVvdXQpOwogICAgICAgICAgICAgICAgdGhpcy5fYW5ub3VuY2VUaW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUmVzZXQgQW5pbWF0aW9uIGJ5IGNsb25pbmcKICAgICAgICAgICAgY29uc3QgbmV3RWwgPSBlbC5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgICAgICAgIGVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKG5ld0VsLCBlbCk7CiAgICAgICAgICAgIHRoaXMudWkuYW5ub3VuY2VtZW50ID0gbmV3RWw7CgogICAgICAgICAgICBuZXdFbC5pbm5lclRleHQgPSB0ZXh0OwogICAgICAgICAgICBuZXdFbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IENsYXNzIGJhc2VkIG9uIHR5cGUKICAgICAgICAgICAgbmV3RWwuY2xhc3NOYW1lID0gJyc7IC8vIFJlc2V0IGNsYXNzZXMKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzbGFtJykgewogICAgICAgICAgICAgICAgbmV3RWwuY2xhc3NMaXN0LmFkZCgnYW5ub3VuY2VtZW50LXNsYW0nKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgc3R5bGUKICAgICAgICAgICAgICAgIG5ld0VsLnN0eWxlLmFuaW1hdGlvbiA9ICdub25lJzsKICAgICAgICAgICAgICAgIG5ld0VsLm9mZnNldEhlaWdodDsgLyogdHJpZ2dlciByZWZsb3cgKi8KICAgICAgICAgICAgICAgIG5ld0VsLnN0eWxlLmFuaW1hdGlvbiA9ICdhbm5vdW5jZVNsaWRlIDAuNXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXV0by1oaWRlCiAgICAgICAgICAgIGlmIChkdXJhdGlvbiA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2Fubm91bmNlVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgfSwgZHVyYXRpb24pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBoaWRlQW5ub3VuY2VtZW50KCkgewogICAgICAgICAgICBpZiAodGhpcy51aS5hbm5vdW5jZW1lbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuYW5ub3VuY2VtZW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpyZXNldFJvdW5kKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdyZXNldCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBwZXJzaXN0ZW50IHZpc3VhbHMKICAgICAgICAgICAgaWYgKHRoaXMuZ2x5cGhNYW5hZ2VyKSB0aGlzLmdseXBoTWFuYWdlci5jbGVhcigpOwogICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBDbGVhciBwYXJ0aWNsZXMgaWYgbmVlZGVkLCB0aG91Z2ggdGhleSBzZWxmLWV4cGlyZSBxdWlja2x5CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IEJhbGwKICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCkgdGhpcy5lbnRpdGllcy5iYWxsLnJlc2V0KCk7CiAgICAgICAgICAgIGlmICh0aGlzLmVudGl0aWVzLmJhbGwpIHRoaXMuZW50aXRpZXMuYmFsbC5yZXNldCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgVGVhbXMKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5yZXNldFBvc2l0aW9ucygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2xlYXIgYmFsbCBob2xkZXIKICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCkgdGhpcy5lbnRpdGllcy5iYWxsLmRyb3AoKTsKCiAgICAgICAgICAgIC8vIENSSVRJQ0FMOiBTbmFwIGNhbWVyYSB0byBwcmV2ZW50IGRpc29yaWVudGF0aW9uCiAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIC8vIEZvcmNlIHVwZGF0ZSB0YXJnZXQgZmlyc3QgKHVzdWFsbHkgYmFsbCkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVudGl0aWVzLmJhbGwgJiYgdGhpcy5lbnRpdGllcy5iYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoLCB0aGlzLmVudGl0aWVzLmJhbGwudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zbmFwVG9UYXJnZXQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRkFTVEVSIEZMT1c6IFJlZHVjZWQgZGVsYXkgZnJvbSAyMDAwbXMgdG8gMTAwbXMKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0S2lja29mZihwb3NzZXNzaW9uVGVhbUlkKTsKfSwgMTAwKTsKICAgICAgICB9CgpzdGFydEtpY2tvZmYocG9zc2Vzc2lvblRlYW1JZCkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2tpY2tvZmYnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcCBhbGwgcGxheWVycyBpbW1lZGlhdGVseSB0byBwcmV2ZW50IHByZS1tb3ZlbWVudAogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gcC5zZXRJbnB1dCgwLCAwKSk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKCiAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQkxJVFogT0ZGISIsICdzbGFtJyk7CiAgICAgICAgICAgIC8vIElmIGEgdGVhbSBoYXMgcG9zc2Vzc2lvbiAoYWZ0ZXIgZ29hbCksIGdpdmUgdG8gTUYKICAgICAgICAgICAgaWYgKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRlYW0gPSB0aGlzLnRlYW1zW3Bvc3Nlc3Npb25UZWFtSWRdOwogICAgICAgICAgICAgICAgaWYgKHRlYW0pIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtZiA9IHRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgICAgICAgICBpZiAobWYgJiYgdGhpcy5lbnRpdGllcy5iYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW50aXRpZXMuYmFsbC5ncmFiKG1mKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENSSVRJQ0FMOiBTbmFwIGNhbWVyYSB0byBuZXcgaG9sZGVyIHRvIHByZXZlbnQgc3dpbmcvZGlzb3JpZW50YXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldChtZi5tZXNoLCBtZi52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOZXV0cmFsIGtpY2tvZmYgLSBlbnN1cmUgY2FtZXJhIGlzIHNuYXBwZWQgdG8gY2VudGVyIGJhbGwKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIgJiYgdGhpcy5lbnRpdGllcy5iYWxsICYmIHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldCh0aGlzLmVudGl0aWVzLmJhbGwubWVzaCwgdGhpcy5lbnRpdGllcy5iYWxsLnZlbG9jaXR5KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZBU1RFUiBGTE9XOiBSZWR1Y2VkIGRlbGF5IGZyb20gMTAwMG1zIHRvIDgwMG1zCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5oaWRlQW5ub3VuY2VtZW50KCk7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2FjdGl2ZSc7CiAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgfQogICAgICAgIAovLyBJbml0aWFsIHN0YXJ0Ci8vIEluaXRpYWwgc3RhcnQKICAgICAgICBzdGFydE1hdGNoKG1vZGUgPSAnbm9ybWFsJykgewogICAgICAgICAgICB0aGlzLmdhbWVNb2RlID0gbW9kZTsKICAgICAgICAgICAgY29uc29sZS5sb2coIlN0YXJ0aW5nIE1hdGNoIGluIG1vZGU6IiwgbW9kZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFydCBNdXNpYwogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlCR00oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgU2NvcmUKICAgICAgICAgICAgdGhpcy5zY29yZS5ob21lID0gMDsKICAgICAgICAgICAgdGhpcy5zY29yZS5hd2F5ID0gMDsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgVGltZQogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmhhbGYgPSAxOwogICAgICAgICAgICBpZiAodGhpcy51aS5oYWxmKSB0aGlzLnVpLmhhbGYuaW5uZXJUZXh0ID0gIjFzdCI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAobW9kZSA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkuaGFsZikgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICJQUkFDIjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU3RhcnQgUHJhY3RpY2UgTWFuYWdlcgogICAgICAgICAgICAgICAgaWYgKHRoaXMucHJhY3RpY2VNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIuc3RhcnQoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBJbiBwcmFjdGljZSwgZW5zdXJlIEFJIGlzIGVuYWJsZWQgZm9yIHNwYXJyaW5nCiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWFtcy5hd2F5LmFpRW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNraXAgaW50cm8gZm9yIHByYWN0aWNlCiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0Um91bmQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBQcmFjdGljZSBNYW5hZ2VyIGlzIHN0b3BwZWQgaWYgbm9ybWFsIGdhbWUKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgdGhpcy5wcmFjdGljZU1hbmFnZXIuc3RvcCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTYWZldHk6IEVuc3VyZSBhbGwgcGxheWVycyBhcmUgdmlzaWJsZSAoaW4gY2FzZSBQcmFjdGljZSBoaWQgdGhlbSkKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4geyBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsgfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWFtcy5hd2F5LmFpRW5hYmxlZCA9IHRydWU7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7IGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSB0cnVlOyB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBTdGFydCBDaW5lbWF0aWMgSW50cm8KICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRJbnRyb1NlcXVlbmNlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHN0YXJ0SW50cm9TZXF1ZW5jZSgpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdpbnRybyc7CiAgICAgICAgICAgIHRoaXMuaW50cm9UaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuX2ludHJvUm9hclRyaWdnZXJlZCA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVHVybiBvZmYgbGlnaHRzCiAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhZGl1bS5zZXRBbGxMaWdodHMoZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIaWRlIFVJCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJykuc3R5bGUub3BhY2l0eSA9ICcwJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKS5zdHlsZS5vcGFjaXR5ID0gJzAnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgcG9zaXRpb25zIHNvIHBsYXllcnMgYXJlIG9uIGZpZWxkIGluIGRhcmsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5yZXNldFBvc2l0aW9ucygpOwogICAgICAgICAgICBpZiAodGhpcy5lbnRpdGllcy5iYWxsKSB0aGlzLmVudGl0aWVzLmJhbGwucmVzZXQoKTsKICAgICAgICB9Ci8vIER1cGxpY2F0ZSBibG9jayByZW1vdmVkCgpzZXRNZW51TW9kZShpc0FjdGl2ZSkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gaXNBY3RpdmUgPyAnbWVudScgOiAnYWN0aXZlJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChpc0FjdGl2ZSAmJiB0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIuc3RvcEJHTSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIaWRlIEhVRCBpbiBtZW51CiAgICAgICAgICAgIGNvbnN0IGh1ZFRvcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJyk7CiAgICAgICAgICAgIGNvbnN0IHN0YXR1c1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKTsKICAgICAgICAgICAgY29uc3QgY29udHJvbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWNvbnRhaW5lcicpOwogICAgICAgICAgICBjb25zdCBqb3lzdGljayA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1oaXQtem9uZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2ZsZXgnOyAvLyBvciBibG9jay9ldGMKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChodWRUb3ApIGh1ZFRvcC5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheTsKICAgICAgICAgICAgaWYgKHN0YXR1c1BhbmVsKSBzdGF0dXNQYW5lbC5zdHlsZS5kaXNwbGF5ID0gaXNBY3RpdmUgPyAnbm9uZScgOiAnYmxvY2snOyAvLyBTdGF0dXMgcGFuZWwgaGFzIHNwZWNpZmljIGxvZ2ljCiAgICAgICAgICAgIGlmIChjb250cm9scykgY29udHJvbHMuc3R5bGUuZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2ZsZXgnOwogICAgICAgICAgICBpZiAoam95c3RpY2spIGpveXN0aWNrLnN0eWxlLmRpc3BsYXkgPSBpc0FjdGl2ZSA/ICdub25lJyA6ICdibG9jayc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJZiBlbnRlcmluZyBtZW51LCByZXNldCBjYW1lcmEgdG8gYSBuaWNlIGFuZ2xlPwogICAgICAgICAgICAvLyBIYW5kbGVkIGJ5IHVwZGF0ZSBsb29wCiAgICAgICAgfQp0b2dnbGVEZW1vTW9kZSgpIHsKICAgICAgICAgICAgdGhpcy5pc0RlbW9Nb2RlID0gIXRoaXMuaXNEZW1vTW9kZTsKICAgICAgICAgICAgY29uc29sZS5sb2coIkRlbW8gTW9kZToiLCB0aGlzLmlzRGVtb01vZGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFVJIEJ1dHRvbgogICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXV0by10b2dnbGUnKTsKICAgICAgICAgICAgaWYgKGJ0bikgewogICAgICAgICAgICAgICAgYnRuLmlubmVyVGV4dCA9IHRoaXMuaXNEZW1vTW9kZSA/ICJBVVRPIFBJTE9UIiA6ICJNQU5VQUwiOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNEZW1vTW9kZSkgewogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBbm5vdW5jZW1lbnQKICAgICAgICAgICAgY29uc3QgdGV4dCA9IHRoaXMuaXNEZW1vTW9kZSA/ICJBVVRPIFBJTE9UIiA6ICJNQU5VQUwiOwogICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQodGV4dCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXN1YWwgRmxhaXI6IFNwYXduIHRleHQgYWJvdmUgYWN0aXZlIHBsYXllcgogICAgICAgICAgICBpZiAodGhpcy5pc0RlbW9Nb2RlICYmIHRoaXMuZmxvYXRpbmdUZXh0ICYmIHRoaXMudGVhbXMuaG9tZSAmJiB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyICYmIHRoaXMudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5mbG9hdGluZ1RleHQuc3Bhd24oIkFJIEVOR0FHRUQiLCB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyLm1lc2gucG9zaXRpb24sICJnb2FsIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEF1dG8taGlkZSBhbm5vdW5jZW1lbnQKc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy51aS5hbm5vdW5jZW1lbnQgJiYgdGhpcy51aS5hbm5vdW5jZW1lbnQuaW5uZXJUZXh0ID09PSB0ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlQW5ub3VuY2VtZW50KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIDE1MDApOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIFRFQ0hDT1BZIFNZU1RFTSAtLS0KCiAgICAgICAgdHJpZ2dlclRlY2hFdmVudChzb3VyY2VQbGF5ZXIsIHRlY2hOYW1lKSB7CiAgICAgICAgICAgIGlmICghc291cmNlUGxheWVyIHx8ICFzb3VyY2VQbGF5ZXIudGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gRmluZCBvcHBvc2luZyB0ZWFtCiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW1JZCA9IHNvdXJjZVBsYXllci50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSB0aGlzLnRlYW1zW29wcFRlYW1JZF07CiAgICAgICAgICAgIGlmICghb3BwVGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gRmluZCB3aG8gaXMgbWFya2luZyB0aGlzIHNvdXJjZQogICAgICAgICAgICBjb25zdCBsZWFybmVycyA9IG9wcFRlYW0ucGxheWVycy5maWx0ZXIocCA9PiBwLm1hcmtpbmcgPT09IHNvdXJjZVBsYXllcik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAobGVhcm5lcnMubGVuZ3RoID09PSAwKSByZXR1cm47CgogICAgICAgICAgICAvLyBPbmx5IHNob3cgVUkgaWYgdGhlIGxlYXJuaW5nIHRlYW0gaXMgSHVtYW4gKEhvbWUpCiAgICAgICAgICAgIC8vIChPciBpZiB3ZSBhcmUgaW4gRGVtbyBtb2RlIGFuZCB3YW50IHRvIHNlZSBpdCBoYXBwZW4gZm9yIEhvbWUgdGVhbSkKICAgICAgICAgICAgaWYgKG9wcFRlYW0uaXNIdW1hbikgewogICAgICAgICAgICAgICAgLy8gRmlsdGVyIG91dCB0aG9zZSB3aG8gYWxyZWFkeSBrbm93IGl0CiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZExlYXJuZXJzID0gbGVhcm5lcnMuZmlsdGVyKHAgPT4gIXAubGVhcm5lZFRlY2hzLmluY2x1ZGVzKHRlY2hOYW1lKSk7CiAgICAgICAgICAgICAgICBpZiAodmFsaWRMZWFybmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydFRlY2hDb3B5V2luZG93KHRlY2hOYW1lLCB2YWxpZExlYXJuZXJzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCnN0YXJ0VGVjaENvcHlXaW5kb3codGVjaE5hbWUsIGxlYXJuZXJzKSB7CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUubWF4VGltZSA9IDAuNjsgLy8gMC42cyB3aW5kb3cKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLnRpbWVyID0gdGhpcy50ZWNoQ29weVN0YXRlLm1heFRpbWU7CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS50ZWNoID0gdGVjaE5hbWU7CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS5sZWFybmVycyA9IGxlYXJuZXJzOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2hvdyBVSQogICAgICAgICAgICBpZiAodGhpcy51aS50ZWNoRmxhc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5iYWNrZ3JvdW5kID0gIiI7IC8vIFJlc2V0IGJhY2tncm91bmQKICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoLnF1ZXJ5U2VsZWN0b3IoJy50ZWNoLXRleHQnKS5pbm5lclRleHQgPSAiVEVDSENPUFkhIjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaFN1YikgewogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFN1Yi5pbm5lclRleHQgPSB0ZWNoTmFtZS5yZXBsYWNlKCdfJywgJyAnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVzZXQgYmFyCiAgICAgICAgICAgICAgICBpZiAodGhpcy51aS50ZWNoVGltZXJGaWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoVGltZXJGaWxsLnN0eWxlLndpZHRoID0gJzEwMCUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKYXR0ZW1wdFRlY2hDb3B5KCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN1Y2Nlc3MhCiAgICAgICAgICAgIGNvbnN0IHRlY2ggPSB0aGlzLnRlY2hDb3B5U3RhdGUudGVjaDsKICAgICAgICAgICAgY29uc3QgbGVhcm5lcnMgPSB0aGlzLnRlY2hDb3B5U3RhdGUubGVhcm5lcnM7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZWFybmVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgLy8gRG91YmxlIGNoZWNrIHRvIHByZXZlbnQgZHVwbGljYXRlcwogICAgICAgICAgICAgICAgaWYgKCFwLmxlYXJuZWRUZWNocy5pbmNsdWRlcyh0ZWNoKSkgewogICAgICAgICAgICAgICAgICAgIHAubGVhcm5lZFRlY2hzLnB1c2godGVjaCk7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7cC5yb2xlfSBsZWFybmVkICR7dGVjaH0hYCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMS4gRmxvYXRpbmcgVGV4dAogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmZsb2F0aW5nVGV4dCAmJiBwLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mbG9hdGluZ1RleHQuc3Bhd24oYExFQVJORUQhYCwgcC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAyLiBQYXJ0aWNsZSBFZmZlY3QgKFNwaXJhbCkKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIG11bHRpcGxlIHBhcnRpY2xlcyBmb3IgYSBzd2lybCBlZmZlY3QKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MTA7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2xlYXJuZWQnLCBwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgaSAqIDUwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmVuZFRlY2hDb3B5V2luZG93KHRydWUpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgplbmRUZWNoQ29weVdpbmRvdyhzdWNjZXNzKSB7CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaEZsYXNoKSB7CiAgICAgICAgICAgICAgICBpZiAoc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoLnF1ZXJ5U2VsZWN0b3IoJy50ZWNoLXRleHQnKS5pbm5lclRleHQgPSAiU1VDQ0VTUyEiOwogICAgICAgICAgICAgICAgICAgIC8vIEZsYXNoIHN1Y2Nlc3MgY29sb3IgKFdoaXRlIGZsYXNoKQogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoLnN0eWxlLmJhY2tncm91bmQgPSAicmdiYSgyNTUsIDI1NSwgMjU1LCAwLjgpIjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBIaWRlIGFmdGVyIHNob3J0IGRlbGF5IHRvIHNob3cgdGhlIHN1Y2Nlc3MgZmxhc2gKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7IAogICAgICAgICAgICAgICAgICAgIH0sIDMwMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIEZhaWxlZCAvIE1pc3NlZAogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9Cl91cGRhdGVQbGF5ZXJTdGF0dXNVSSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW1zLmhvbWUgfHwgIXRoaXMudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCB1aSA9IHRoaXMudWkuc3RhdHVzUGFuZWw7CiAgICAgICAgICAgIAovLyBVSSBVcGRhdGVzIChBY3Rpb24gQnV0dG9uIENvbnRleHQpCiAgICAgICAgICAgICAgICB1aS5jb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE5hbWUgJiBMZXZlbAogICAgICAgICAgICAgICAgaWYgKHVpLm5hbWUpIHVpLm5hbWUuaW5uZXJUZXh0ID0gYCR7cC5jaGFyYWN0ZXJOYW1lIHx8IHAucm9sZX0gTFYke3AubGV2ZWx9YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSFAKICAgICAgICAgICAgICAgIGlmICh1aS5ocEJhcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhwUGN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMTAwLCAocC5zdGF0cy5IUCAvIHAuc3RhdHMubWF4SFApICogMTAwKSk7CiAgICAgICAgICAgICAgICAgICAgdWkuaHBCYXIuc3R5bGUud2lkdGggPSBgJHtocFBjdH0lYDsKICAgICAgICAgICAgICAgICAgICAvLyBDb2xvciBzaGlmdAogICAgICAgICAgICAgICAgICAgIGlmIChocFBjdCA8IDI1KSB1aS5ocEJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmMDAwMCwgI2ZmNDQ0NCknOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGhwUGN0IDwgNTApIHVpLmhwQmFyLnN0eWxlLmJhY2tncm91bmQgPSAnbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjZmZmZjAwLCAjZmZmZjg4KSc7CiAgICAgICAgICAgICAgICAgICAgZWxzZSB1aS5ocEJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzAwZmYwMCwgI2NjZmZjYyknOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHVpLmhwVGV4dCkgdWkuaHBUZXh0LmlubmVyVGV4dCA9IGAke01hdGguZmxvb3IocC5zdGF0cy5IUCl9LyR7cC5zdGF0cy5tYXhIUH1gOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBFWFAKICAgICAgICAgICAgICAgIGlmICh1aS5leHBCYXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBleHBQY3QgPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxMDAsIChwLmV4cCAvIHAubmV4dExldmVsRXhwKSAqIDEwMCkpOwogICAgICAgICAgICAgICAgICAgIHVpLmV4cEJhci5zdHlsZS53aWR0aCA9IGAke2V4cFBjdH0lYDsKdWkuZXhwQmFyLnN0eWxlLndpZHRoID0gYCR7ZXhwUGN0fSVgOwogICAgICAgICAgICAgICAgfQogICAgICAgIH0KCl9pbml0UGFydGljbGVzKCkgewogICAgICAgICAgICB0aGlzLmFjdGl2ZVNwYXJrcyA9IFtdOwogICAgICAgICAgICB0aGlzLnNwYXJrUG9vbCA9IFtdOwogICAgICAgICAgICBjb25zdCBwb29sU2l6ZSA9IDQwOyAvLyBTdWZmaWNpZW50IGZvciBjb250aW51b3VzIGdyaW5kaW5nCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvb2xTaXplOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUoX3NwYXJrTWF0ZXJpYWwuY2xvbmUoKSk7CiAgICAgICAgICAgICAgICBzcHJpdGUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQoc3ByaXRlKTsKICAgICAgICAgICAgICAgIHRoaXMuc3BhcmtQb29sLnB1c2goc3ByaXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd25DbGFzaChwb3MsIGludGVuc2l0eSA9IDEuMCkgewogICAgICAgICAgICAvLyBGaW5kIGZyZWUgc3BhcmsKICAgICAgICAgICAgY29uc3Qgc3BhcmsgPSB0aGlzLnNwYXJrUG9vbC5maW5kKHMgPT4gIXMudmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghc3BhcmspIHJldHVybjsgLy8gUG9vbCBleGhhdXN0ZWQKICAgICAgICAgICAgCiAgICAgICAgICAgIHNwYXJrLnBvc2l0aW9uLmNvcHkocG9zKTsKICAgICAgICAgICAgc3BhcmsudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYW5kb21pemUgcm90YXRpb24KICAgICAgICAgICAgc3BhcmsubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgQWN0aXZlIFN0YXRlCiAgICAgICAgICAgIHRoaXMuYWN0aXZlU3BhcmtzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogc3BhcmssCiAgICAgICAgICAgICAgICBhZ2U6IDAsCiAgICAgICAgICAgICAgICBsaWZlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMTUsIC8vIEZhc3QsIHB1bmNoeSBzcGFya3MKICAgICAgICAgICAgICAgIG1heFNjYWxlOiAyLjUgKiBpbnRlbnNpdHksCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSo4LCAKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKjgsIAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqOAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVQYXJ0aWNsZXMoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuYWN0aXZlU3BhcmtzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5hY3RpdmVTcGFya3NbaV07CiAgICAgICAgICAgICAgICBwLmFnZSArPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHAuYWdlID49IHAubGlmZSkgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVTcGFya3Muc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gcC5hZ2UgLyBwLmxpZmU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEV4cGFuZAogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNjYWxlID0gMC41ICsgKHAubWF4U2NhbGUgLSAwLjUpICogdDsKICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIoY3VycmVudFNjYWxlKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmFkZSBvdXQKICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wIC0gKHQgKiB0KTsgLy8gUXVhZHJhdGljIGZhZGUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gTW92ZQogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmFkZFNjYWxlZFZlY3RvcihwLnZlbG9jaXR5LCBkdCk7CiAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwucm90YXRpb24gKz0gMTAuMCAqIGR0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKLy8gSGVscGVyIGZvciBpbXBhY3QgZnJhbWVzCgp0cmlnZ2VySW1wYWN0KGR1cmF0aW9uLCB0eXBlID0gJ2RlZmF1bHQnKSB7CiAgICAgICAgICAgIHRoaXMuaW1wYWN0UGF1c2UgPSBkdXJhdGlvbjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnYW1lLWNvbnRhaW5lcicpOwogICAgICAgICAgICBpZiAoIWNvbnRhaW5lcikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gUmVzZXQgY2xhc3NlcyB0byBlbnN1cmUgYW5pbWF0aW9uIHJlc3RhcnRzCiAgICAgICAgICAgIGNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdpbXBhY3QtZngnLCAnaW1wYWN0LWhlYXZ5JywgJ2ltcGFjdC1zaGF0dGVyJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGb3JjZSByZWZsb3cKICAgICAgICAgICAgdm9pZCBjb250YWluZXIub2Zmc2V0V2lkdGg7CgogICAgICAgICAgICBsZXQgY2xhc3NOYW1lID0gJ2ltcGFjdC1meCc7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnaGVhdnknKSBjbGFzc05hbWUgPSAnaW1wYWN0LWhlYXZ5JzsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzaGF0dGVyJykgY2xhc3NOYW1lID0gJ2ltcGFjdC1zaGF0dGVyJzsKCiAgICAgICAgICAgIGNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKGNsYXNzTmFtZSk7CgogICAgICAgICAgICAvLyBBdXRvLXJlbW92ZSBjbGFzcyBhZnRlciBkdXJhdGlvbgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKGNsYXNzTmFtZSk7CiAgICAgICAgICAgIH0sIGR1cmF0aW9uICogMTAwMCArIDEwMCk7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkdhbWVNYW5hZ2VyID0gR2FtZU1hbmFnZXI7Cn0pKCk7","/GameManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFNwYXJrIFRleHR1cmUgKFByb2NlZHVyYWwgQnVyc3QpCiAgICBjb25zdCBfc3BhcmtUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw2NCw2NCk7CiAgICAgICAgCiAgICAgICAgLy8gQnVyc3Qgc2hhcGUKICAgICAgICBjb25zdCBjeCA9IDMyLCBjeSA9IDMyOwogICAgICAgIGNvbnN0IHNwaWtlcyA9IDg7CiAgICAgICAgY29uc3Qgb3V0ZXIgPSAzMDsKICAgICAgICBjb25zdCBpbm5lciA9IDEwOwogICAgICAgIAogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBmb3IobGV0IGk9MDsgaTxzcGlrZXMqMjsgaSsrKXsKICAgICAgICAgICAgY29uc3QgciA9IChpJTI9PT0wKT8gb3V0ZXIgOiBpbm5lcjsKICAgICAgICAgICAgY29uc3QgYSA9IChNYXRoLlBJKmkpL3NwaWtlczsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKnIsIGN5ICsgTWF0aC5zaW4oYSkqcik7CiAgICAgICAgfQogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmNjMDAnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgLy8gV2hpdGUgQ29yZQogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHguYXJjKGN4LCBjeSwgOCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjb25zdCBfc3BhcmtNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IAogICAgICAgIG1hcDogX3NwYXJrVGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBHYW1lTWFuYWdlciB7CgogICAgICAgIApjb25zdHJ1Y3RvcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEsIHJlbmRlcmVyKSB7CndpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIgPSByZW5kZXJlcjsgLy8gU3RvcmUgcmVuZGVyZXIKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmNhbWVyYSA9IGNhbWVyYTsKICAgICAgICAgICAgdGhpcy51aUxheWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodWlMYXllcklkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc2NvcmUgPSB7IGhvbWU6IDAsIGF3YXk6IDAgfTsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5oYWxmID0gMTsKICAgICAgICAgICAgdGhpcy5oYWxmRHVyYXRpb24gPSAzMDA7IC8vIDUgbWludXRlcyAoc2Vjb25kcykKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNEZW1vTW9kZSA9IGZhbHNlOwp0aGlzLmdhbWVNb2RlID0gJ25vcm1hbCc7IC8vICdub3JtYWwnIG9yICdwcmFjdGljZScKICAgICAgICAgICAgdGhpcy5pc0ZvcmdlTW9kZSA9IGZhbHNlOyAvLyBBc3NldCBGb3JnZSBTdGF0ZQogICAgICAgICAgICAvLyBJbXBhY3QgRnJhbWVzCiAgICAgICAgICAgIHRoaXMuaW1wYWN0UGF1c2UgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsgLy8gU3RhcnQgaW4gbWVudQp0aGlzLnRlYW1zID0gewogICAgICAgICAgICAgICAgaG9tZTogbnVsbCwKICAgICAgICAgICAgICAgIGF3YXk6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZW50aXRpZXMgPSB7CiAgICAgICAgICAgICAgICBiYWxsOiBudWxsCiAgICAgICAgICAgIH07Cgp0aGlzLnVpID0gewogICAgICAgICAgICAgICAgc2NvcmVQbGF5ZXI6IG51bGwsCiAgICAgICAgICAgICAgICBzY29yZUNwdTogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWVyOiBudWxsLAogICAgICAgICAgICAgICAgaGFsZjogbnVsbCwKICAgICAgICAgICAgICAgIGFubm91bmNlbWVudDogbnVsbCwKICAgICAgICAgICAgICAgIC8vIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgICAgIHN0YXR1c1BhbmVsOiB7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyOiBudWxsLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBCYXI6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBUZXh0OiBudWxsLAogICAgICAgICAgICAgICAgICAgIGV4cEJhcjogbnVsbAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVGVjaGNvcHkgU3RhdGUKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHRpbWVyOiAwLAogICAgICAgICAgICAgICAgdGVjaDogbnVsbCwKICAgICAgICAgICAgICAgIGxlYXJuZXJzOiBbXQogICAgICAgICAgICB9OwoKdGhpcy5taW5pTWFwID0gbmV3IHdpbmRvdy5mbHV4Lk1pbmlNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgRmxvYXRpbmcgVGV4dAovLyBJbml0aWFsaXplIEZsb2F0aW5nIFRleHQKdGhpcy5mbG9hdGluZ1RleHQgPSBuZXcgd2luZG93LmZsdXguRmxvYXRpbmdUZXh0TWFuYWdlcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBVSSBjYWxjdWxhdGlvbnMKICAgICAgICAgICAgdGhpcy5fdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIFBhcnRpY2xlIE1hbmFnZXIgKFN0YXR1cyBFZmZlY3RzKQogICAgICAgICAgICAKLy8gSW5pdGlhbGl6ZSBQYXJ0aWNsZSBNYW5hZ2VyIChTdGF0dXMgRWZmZWN0cykKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyKHNjZW5lKTsKdGhpcy5nbHlwaE1hbmFnZXIgPSBudWxsOyAvLyBJbmplY3RlZCBieSBtYWluLmpzCiAgICAgICAgICAgIHRoaXMuX2luaXRQYXJ0aWNsZXMoKTsgLy8gM0QgU3BhcmsgU3lzdGVtIChMZWdhY3kvSW1wYWN0KQoKdGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIgPSBuZXcgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyKHNjZW5lKTsKICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyKHRoaXMpOyAvLyBJbml0aWFsaXplIFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgdGhpcy5faW5qZWN0U3R5bGVzKCk7CnRoaXMuX2luaXRVSSgpOwogICAgICAgIH0KCl9pbml0Q2luZW1hdGljcygpIHsKICAgICAgICAgICAgdGhpcy5tZW51U2hvdEluZGV4ID0gMDsKICAgICAgICAgICAgdGhpcy5tZW51U2hvdFRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5tZW51U2hvdHMgPSBbCiAgICAgICAgICAgICAgICAvLyAxLiAiVGhlIEFyZW5hIiAtIFdpZGUgRXN0YWJsaXNoaW5nIFNob3QgKFNsb3cgZG9sbHkgaW4pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDEwLjAsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoNjAsIDM1LCA2MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAyID0gbmV3IFRIUkVFLlZlY3RvcjMoNDAsIDI1LCA0MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNtb290aHN0ZXAgaW50ZXJwb2xhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdCA9IHQgKiB0ICogKDMgLSAyICogdCk7IAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCBzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIDIuICJUaGUgVGVhbSIgLSBUcmFja2luZyBTaG90IGFsb25nIHRoZSBmb3JtYXRpb24KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogOC4wLAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBNb3ZlIGFsb25nIHRoZSBzaWRlIG9mIHRoZSBob21lIHRlYW0gZm9ybWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHpTdGFydCA9IC0yNTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgekVuZCA9IDI1OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50WiA9IHpTdGFydCArICh6RW5kIC0gelN0YXJ0KSAqIHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24uc2V0KC0yNSwgNiwgY3VycmVudFopOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KDAsIDIsIGN1cnJlbnRaICogMC44KTsgLy8gTG9vayBzbGlnaHRseSBhaGVhZCBvZiBjZW50ZXIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gMy4gIlRoZSBTdHJpa2VyIiAtIENsb3NlIHVwIG9yYml0IG9uIGEga2V5IHBvc2l0aW9uCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDguMCwKICAgICAgICAgICAgICAgICAgICB1cGRhdGU6ICh0LCBjYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9jdXMgb24gd2hlcmUgdGhlIExGL1JGIHVzdWFsbHkgc3RhbmRzIChhcHByb3ggKy8tIDEwLCAtMTApCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IG5ldyBUSFJFRS5WZWN0b3IzKC0xMCwgMCwgLTEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSB0ICogMS4wICsgMy41OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gMTAuMDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5wb3NpdGlvbi5zZXQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQueCArIE1hdGguY29zKGFuZ2xlKSAqIGRpc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQueSArIDQuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC56ICsgTWF0aC5zaW4oYW5nbGUpICogZGlzdAogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KHRhcmdldC54LCB0YXJnZXQueSArIDEuNSwgdGFyZ2V0LnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyA0LiAiVGhlIEdvYWwiIC0gTG93IEFuZ2xlIGxvb2tpbmcgdXAgYXQgdGhlIG5ldAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiA3LjAsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgLTUsIDMyKTsgLy8gTG93IG5lYXIgZ29hbAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwMiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDgsIDIwKTsgIC8vIFJpc2luZyB1cAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdCgwLCAxNSwgNDUpOyAvLyBMb29rIHVwIGF0IHRoZSBzdHJ1Y3R1cmUKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnJvdGF0aW9uLnogPSAodCAtIDAuNSkgKiAwLjE1OyAvLyBTbGlnaHQgY2luZW1hdGljIHRpbHQKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gNS4gIlRoZSBEaXZlIiAtIFZlcnRpY2FsIGRyb3AgaW50byB0aGUgcG9vbAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiA4LjAsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHAxID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgNTAsIDApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwMiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEwLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3QgPSB0ICogdCAqICgzIC0gMiAqIHQpOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCBzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5yb3RhdGlvbi56ID0gdCAqIDAuODsgLy8gU3BpcmFsIGRvd24KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9Cl07CiAgICAgICAgfQoKICAgICAgICBfaW5qZWN0U3R5bGVzKCkgewogICAgICAgICAgICBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZsdXgtZHluYW1pYy1zdHlsZXMnKSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgICAgICAgICAgIHN0eWxlLmlkID0gJ2ZsdXgtZHluYW1pYy1zdHlsZXMnOwpzdHlsZS50ZXh0Q29udGVudCA9IGAKICAgICAgICAgICAgICAgIEBrZXlmcmFtZXMgdGV4dFNsYW0gewogICAgICAgICAgICAgICAgICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoNCk7IG9wYWNpdHk6IDA7IGxldHRlci1zcGFjaW5nOiA1MHB4OyB9CiAgICAgICAgICAgICAgICAgICAgMTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IG9wYWNpdHk6IDE7IGxldHRlci1zcGFjaW5nOiA1cHg7IH0KICAgICAgICAgICAgICAgICAgICAxNSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjEpOyB9CiAgICAgICAgICAgICAgICAgICAgMjAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IH0KICAgICAgICAgICAgICAgICAgICA4MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxKTsgb3BhY2l0eTogMTsgZmlsdGVyOiBibHVyKDBweCk7IH0KICAgICAgICAgICAgICAgICAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS41KTsgb3BhY2l0eTogMDsgZmlsdGVyOiBibHVyKDEwcHgpOyB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC5hbm5vdW5jZW1lbnQtc2xhbSB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICAgICAgICAgIHRvcDogNDUlOyBsZWZ0OiA1MCU7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDEwMCU7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnSW1wYWN0Jywgc2Fucy1zZXJpZjsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDk2cHg7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgICAgICAgICAgICAgICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZmZmZiAwJSwgI2ZmZGQwMCA0NSUsICNmZjg4MDAgMTAwJSk7CiAgICAgICAgICAgICAgICAgICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAgICAgICAgICAgICAgICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgICAgICAgICAgICAgICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggcmdiYSgwLDAsMCwxKSkgZHJvcC1zaGFkb3coMCAwIDMwcHggcmdiYSgyNTUsIDEwMCwgMCwgMC42KSk7CiAgICAgICAgICAgICAgICAgICAgei1pbmRleDogMjAwMDsKICAgICAgICAgICAgICAgICAgICBhbmltYXRpb246IHRleHRTbGFtIDEuOHMgY3ViaWMtYmV6aWVyKDAuMSwgMC44LCAwLjEsIDEpIGZvcndhcmRzOwogICAgICAgICAgICAgICAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICAgICAgICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLm1vZGFsLW92ZXJsYXkgewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgY2VudGVyLCByZ2JhKDEwLCAyNSwgNjAsIDAuOTUpIDAlLCByZ2JhKDAsIDAsIDAsIDAuOTgpIDEwMCUpOwogICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7IGp1c3RpZnktY29udGVudDogY2VudGVyOyBhbGlnbi1pdGVtczogY2VudGVyOyBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDE5MDA7CiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMDsgcG9pbnRlci1ldmVudHM6IG5vbmU7IHRyYW5zaXRpb246IG9wYWNpdHkgMC44czsKICAgICAgICAgICAgICAgICAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoOHB4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5tb2RhbC1vdmVybGF5LmFjdGl2ZSB7IG9wYWNpdHk6IDE7IHBvaW50ZXItZXZlbnRzOiBhdXRvOyB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC5tb2RhbC10aXRsZSB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdHYXJhbW9uZCcsIHNlcmlmOwogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogNTJweDsgY29sb3I6ICNmZmY7CiAgICAgICAgICAgICAgICAgICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwYWFmZiwgMCAwIDQwcHggIzAwNDRhYTsKICAgICAgICAgICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAzMHB4OwogICAgICAgICAgICAgICAgICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCAjMDBhYWZmOwogICAgICAgICAgICAgICAgICAgIHBhZGRpbmctYm90dG9tOiAxMHB4OwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiA4MCU7IHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgICAgICAgICBsZXR0ZXItc3BhY2luZzogNXB4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAubW9kYWwtc2NvcmUtY29udGFpbmVyIHsKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBnYXA6IDQwcHg7CiAgICAgICAgICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogNDBweDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5tb2RhbC1zY29yZSB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdJbXBhY3QnLCBzYW5zLXNlcmlmOwogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogODBweDsgY29sb3I6ICNmZmQ3MDA7CiAgICAgICAgICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggI2I4ODYwYjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5tb2RhbC12cyB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6ICdDb3VyaWVyIE5ldycsIG1vbm9zcGFjZTsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDI0cHg7IGNvbG9yOiAjMDBhYWZmOyBvcGFjaXR5OiAwLjc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLmZsYXNoLW92ZXJsYXkgewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDIxMDA7CiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMDsgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjFzIGVhc2Utb3V0OwogICAgICAgICAgICAgICAgICAgIG1peC1ibGVuZC1tb2RlOiBvdmVybGF5OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIEBrZXlmcmFtZXMgY2xhc2hQb3AgewogICAgICAgICAgICAgICAgICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMC41KTsgb3BhY2l0eTogMTsgfQogICAgICAgICAgICAgICAgICAgIDUwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuNSk7IG9wYWNpdHk6IDAuODsgfQogICAgICAgICAgICAgICAgICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgyLjApOyBvcGFjaXR5OiAwOyB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLmNsYXNoLXNwYXJrIHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDYwcHg7IGhlaWdodDogNjBweDsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAjZmZmZmZmIDAlLCAjZmZmZjAwIDQwJSwgdHJhbnNwYXJlbnQgNzAlKTsKICAgICAgICAgICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgICAgICAgICAgICAgICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgICAgICAgICAgICAgei1pbmRleDogMTUwMDsKICAgICAgICAgICAgICAgICAgICBtaXgtYmxlbmQtbW9kZTogc2NyZWVuOwogICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbjogY2xhc2hQb3AgMC4zcyBlYXNlLW91dCBmb3J3YXJkczsKICAgICAgICAgICAgICAgICAgICBib3gtc2hhZG93OiAwIDAgMjBweCAjZmZhYTAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwogICAgICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHN0eWxlKTsKICAgICAgICB9CgogICAgICAgIHJlZ2lzdGVyVGVhbXMoaG9tZVRlYW0sIGF3YXlUZWFtLCBiYWxsKSB7CiAgICAgICAgICAgIHRoaXMudGVhbXMuaG9tZSA9IGhvbWVUZWFtOwogICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkgPSBhd2F5VGVhbTsKdGhpcy5lbnRpdGllcy5iYWxsID0gYmFsbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgTWluaU1hcAogICAgICAgICAgICBpZiAodGhpcy5taW5pTWFwKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1pbmlNYXAuaW5pdChob21lVGVhbSwgYXdheVRlYW0sIGJhbGwpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX2luaXRVSSgpIHsKICAgICAgICAgICAgLy8gQmluZCB0byBleGlzdGluZyBIVE1MIGVsZW1lbnRzCiAgICAgICAgICAgIHRoaXMudWkuc2NvcmVQbGF5ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NvcmUtcGxheWVyJyk7CiAgICAgICAgICAgIHRoaXMudWkuc2NvcmVDcHUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NvcmUtY3B1Jyk7CiAgICAgICAgICAgIHRoaXMudWkudGltZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGltZXItZGlzcGxheScpOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGFsZi1pbmRpY2F0b3InKTsKICAgICAgICAgICAgdGhpcy51aS5hbm5vdW5jZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYW5ub3VuY2VtZW50Jyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZWNoLWZsYXNoLW92ZXJsYXknKTsKICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaEZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hTdWIgPSB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC1zdWItdGV4dCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50ZWNoLXRpbWVyLWZpbGwnKTsKCiAgICAgICAgICAgIC8vIEJpbmQgUGxheWVyIFN0YXR1cyBQYW5lbAogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJyk7CiAgICAgICAgICAgIHRoaXMudWkuc3RhdHVzUGFuZWwubmFtZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC5jaGFyLW5hbWUnKTsKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5ocEJhciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC5ocC1iYXItZmlsbCcpOwogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmhwVGV4dCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC5ocC12YWx1ZScpOwogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLmV4cEJhciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwbGF5ZXItc3RhdHVzLXBhbmVsIC50ZWNoLWJhci1maWxsJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFbmQgR2FtZSBNZW51IEJpbmRpbmdzCiAgICAgICAgICAgIHRoaXMudWkuZW5kTWVudSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtZ2FtZS1tZW51Jyk7CiAgICAgICAgICAgIGNvbnN0IGJ0blJlbWF0Y2ggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLWJ0bi1yZW1hdGNoJyk7CiAgICAgICAgICAgIGNvbnN0IGJ0bkV4aXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLWJ0bi1leGl0Jyk7CgogICAgICAgICAgICBpZiAoYnRuUmVtYXRjaCkgewogICAgICAgICAgICAgICAgYnRuUmVtYXRjaC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlRW5kTWVudSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRNYXRjaCh0aGlzLmdhbWVNb2RlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChidG5FeGl0KSB7CiAgICAgICAgICAgICAgICBidG5FeGl0LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVFbmRNZW51KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ21lbnUnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDcmVhdGUgTW9kYWwgT3ZlcmxheSAoRm9yIEhhbGZ0aW1lIG9ubHkgbm93KQogICAgICAgICAgICB0aGlzLnVpLm1vZGFsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwuY2xhc3NOYW1lID0gJ21vZGFsLW92ZXJsYXknOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmlubmVySFRNTCA9IGAKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXRpdGxlIj5IQUxGIFRJTUU8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXNjb3JlLWNvbnRhaW5lciI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtc2NvcmUiIGlkPSJtb2RhbC1zY29yZS1ob21lIj4wPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtdnMiPi08L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC1zY29yZSIgaWQ9Im1vZGFsLXNjb3JlLWF3YXkiPjA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBpZD0ibW9kYWwtbXNnIiBzdHlsZT0iY29sb3I6ICMwMGFhZmY7IGZvbnQtc2l6ZTogMTRweDsgbGV0dGVyLXNwYWNpbmc6IDJweDsiPlBSRVBBUklORyAyTkQgSEFMRi4uLjwvZGl2PgogICAgICAgICAgICBgOwogICAgICAgICAgICB0aGlzLnVpTGF5ZXIuYXBwZW5kQ2hpbGQodGhpcy51aS5tb2RhbCk7CgogICAgICAgICAgICAvLyBDcmVhdGUgRmxhc2ggT3ZlcmxheQogICAgICAgICAgICB0aGlzLnVpLmZsYXNoID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHRoaXMudWkuZmxhc2guY2xhc3NOYW1lID0gJ2ZsYXNoLW92ZXJsYXknOwogICAgICAgICAgICB0aGlzLnVpTGF5ZXIuYXBwZW5kQ2hpbGQodGhpcy51aS5mbGFzaCk7CgogICAgICAgICAgICAvLyBJbml0aWFsIFN0YXRlCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoKTsKICAgICAgICAgICAgaWYgKHRoaXMudWkudGltZXIpIHRoaXMudWkudGltZXIuaW5uZXJUZXh0ID0gIjAwOjAwIjsKICAgICAgICB9CiAgICAgICAgX3VwZGF0ZVNjb3JlVUkoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnNjb3JlUGxheWVyKSB0aGlzLnVpLnNjb3JlUGxheWVyLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuaG9tZTsKICAgICAgICAgICAgaWYgKHRoaXMudWkuc2NvcmVDcHUpIHRoaXMudWkuc2NvcmVDcHUuaW5uZXJUZXh0ID0gdGhpcy5zY29yZS5hd2F5OwogICAgICAgIH0KCnVwZGF0ZVByYWN0aWNlKGR0KSB7CiAgICAgICAgICAgIC8vIERlbGVnYXRlIGxvZ2ljIHRvIFByYWN0aWNlTWFuYWdlcgogICAgICAgICAgICBpZiAodGhpcy5wcmFjdGljZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewoKaWYgKHRoaXMuc3RhdGUgPT09ICdpbnRybycpIHsKICAgICAgICAgICAgICAgIHRoaXMuaW50cm9UaW1lciArPSBkdDsKCiAgICAgICAgICAgICAgICAvLyAxLiBMaWdodHMgU2VxdWVuY2UgKDAuNXMgdG8gMi41cykKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0gJiYgdGhpcy5pbnRyb1RpbWVyID4gMC41ICYmIHRoaXMuaW50cm9UaW1lciA8IDIuNSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGR1cmF0aW9uID0gMi4wOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gKHRoaXMuaW50cm9UaW1lciAtIDAuNSkgLyBkdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b3RhbCA9IHRoaXMuc3RhZGl1bS5saWdodFNwcml0ZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2ZUNvdW50ID0gTWF0aC5mbG9vcihwcm9ncmVzcyAqIHRvdGFsKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0b3RhbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpIDw9IGFjdGl2ZUNvdW50ICYmICF0aGlzLnN0YWRpdW0ubGlnaHRTcHJpdGVzW2ldLnZpc2libGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhZGl1bS50dXJuT25MaWdodChpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyLiBDYW1lcmEgTW92ZW1lbnQgKFNwaXJhbCBJbikKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLmludHJvVGltZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHVyYXRpb24gPSA1LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGN0ID0gTWF0aC5taW4oMS4wLCB0IC8gZHVyYXRpb24pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFNtb290aCBlYXNlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWFzZSA9IDEgLSBNYXRoLnBvdygxIC0gcGN0LCAzKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGFydFJhZGl1cyA9IDEyMDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbmRSYWRpdXMgPSA0MDsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYWRpdXMgPSBzdGFydFJhZGl1cyArIChlbmRSYWRpdXMgLSBzdGFydFJhZGl1cykgKiBlYXNlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0SGVpZ2h0ID0gNjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kSGVpZ2h0ID0gMjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGVpZ2h0ID0gc3RhcnRIZWlnaHQgKyAoZW5kSGVpZ2h0IC0gc3RhcnRIZWlnaHQpICogZWFzZTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IHQgKiAwLjQ7IC8vIFJvdGF0aW9uCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uc2V0KAogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLnNpbihhbmdsZSkgKiByYWRpdXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5jb3MoYW5nbGUpICogcmFkaXVzCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMy4gQ3Jvd2QgUm9hciAvIEh5cGUgKDMuMHMpCiAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnRyb1RpbWVyID4gMy4wICYmICF0aGlzLl9pbnRyb1JvYXJUcmlnZ2VyZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9pbnRyb1JvYXJUcmlnZ2VyZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQVJFIFlPVSBSRUFEWT8iLCAic2xhbSIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgxLjUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZsYXNoIGNyb3dkCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bSAmJiB0aGlzLnN0YWRpdW0uY3Jvd2QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2UgY2FuJ3QgZWFzaWx5IGZsYXNoIGluc3RhbmNlZCBtZXNoIGNvbG9yIHdpdGhvdXQgaXRlcmF0aW5nLCAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYnV0IHdlIGNhbiBzcGF3biBzb21lIHBhcnRpY2xlcwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDIwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSoxMDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEwICsgTWF0aC5yYW5kb20oKSoyMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSoxMDAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIHBvcywgeyBzY2FsZTogNS4wIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDQuIEVuZCBJbnRybyAoNS4wcykKICAgICAgICAgICAgICAgIGlmICh0aGlzLmludHJvVGltZXIgPiA1LjApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9pbnRyb1JvYXJUcmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAvLyBSZXN0b3JlIFVJCiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKS5zdHlsZS5vcGFjaXR5ID0gJzEnOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJykuc3R5bGUub3BhY2l0eSA9ICcxJzsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgYWxsIGxpZ2h0cyBvbgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS5zZXRBbGxMaWdodHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNldFJvdW5kKG51bGwpOyAvLyBHbyB0byBraWNrb2ZmCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnbWVudScpIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBQT1BVTEFURSBBUkVOQSBGT1IgQi1ST0xMIC0tLQogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHBsYXllcnMgYXJlIHZpc2libGUgYW5kIGFuaW1hdGVkCiAgICAgICAgICAgICAgICBjb25zdCBhbmltYXRlVGVhbSA9ICh0ZWFtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0ZWFtKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgdGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdlbnRsZSBib2JiaW5nIHRvIHNpbXVsYXRlIHRyZWFkaW5nIHdhdGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24ueSA9IHAuaG9tZVBvc2l0aW9uLnkgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDIgKyBwLm1lc2guaWQpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIGlkbGUgYW5pbWF0aW9uIGlzIHBsYXlpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnN0YXRlICE9PSAnaWRsZScpIHAucGxheSgnaWRsZScsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5taXhlcikgcC5taXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgYW5pbWF0ZVRlYW0odGhpcy50ZWFtcy5ob21lKTsKICAgICAgICAgICAgICAgIGFuaW1hdGVUZWFtKHRoaXMudGVhbXMuYXdheSk7CgogICAgICAgICAgICAgICAgLy8gLS0tIENJTkVNQVRJQyBCLVJPTEwgLS0tCiAgICAgICAgICAgICAgICBpZiAodGhpcy5tZW51U2hvdHMgJiYgdGhpcy5tZW51U2hvdHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNob3QgPSB0aGlzLm1lbnVTaG90c1t0aGlzLm1lbnVTaG90SW5kZXhdOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVudVNob3RUaW1lciArPSBkdDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5tZW51U2hvdFRpbWVyID49IHNob3QuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U2hvdFRpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51U2hvdEluZGV4ID0gKHRoaXMubWVudVNob3RJbmRleCArIDEpICUgdGhpcy5tZW51U2hvdHMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWxpemUgdGltZSAoMCB0byAxKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLm1lbnVTaG90VGltZXIgLyBzaG90LmR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgICAgICBzaG90LnVwZGF0ZSh0LCB0aGlzLmNhbWVyYSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFtYmllbnQgRlggaW4gTWVudQogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIE1hdGgucmFuZG9tKCkgPCAwLjIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biByYW5kb20gYnViYmxlcyBmb3IgYXRtb3NwaGVyZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhbmdlID0gNjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqcmFuZ2UsIAogICAgICAgICAgICAgICAgICAgICAgICAtMTAgKyBNYXRoLnJhbmRvbSgpKjIwLCAKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSpyYW5nZQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2J1YmJsZScsIHBvcywgeyBsaWZlOiAzLjAgKyBNYXRoLnJhbmRvbSgpKjIuMCwgc2NhbGU6IDAuMyArIE1hdGgucmFuZG9tKCkqMC40IH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBCYWNrZ3JvdW5kIFN5c3RlbXMKICAgICAgICAgICAgICAgIGlmICh0aGlzLndhdGVyT3ZlcmxheSkgdGhpcy53YXRlck92ZXJsYXkudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmxpZ2h0U2hhZnRzKSB0aGlzLmxpZ2h0U2hhZnRzLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGFkaXVtKSB0aGlzLnN0YWRpdW0udXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgdGhpcy5wYXJ0aWNsZU1hbmFnZXIudXBkYXRlKGR0KTsKCiAgICAgICAgICAgICAgICAvLyBSZW5kZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlbmRlcmVyICYmIHRoaXMuc2NlbmUgJiYgdGhpcy5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbmRlcih0aGlzLnNjZW5lLCB0aGlzLmNhbWVyYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCi8vIC0tLSBMT0dJQyBVUERBVEUgKFN0YXRlIERlcGVuZGVudCkgLS0tCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnYWN0aXZlJykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZU1vZGUgPT09ICdwcmFjdGljZScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVByYWN0aWNlKGR0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50aW1lICs9IGR0OwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tIYWxmVGltZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrR29hbHMoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXBkYXRlIFRlY2hjb3B5IFdpbmRvdwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIFVJIEJhcgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hUaW1lckZpbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGN0ID0gTWF0aC5tYXgoMCwgKHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciAvIHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lKSAqIDEwMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9IGAke3BjdH0lYDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbG9yIHNoaWZ0IGJhc2VkIG9uIHVyZ2VuY3kKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBjdCA8IDMwKSB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICcjZmYwMDAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZmZmZmYsICMwMGZmZmYpJzsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlY2hDb3B5U3RhdGUudGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZFRlY2hDb3B5V2luZG93KGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBWSVNVQUwgVVBEQVRFIChBbHdheXMgUnVuKSAtLS0KICAgICAgICAgICAgLy8gVXBkYXRlIHRoZXNlIGluIGFsbCBzdGF0ZXMgKEFjdGl2ZSwgR29hbCwgSGFsZnRpbWUsIEdhbWVPdmVyKSB0byBrZWVwIEZYIGFsaXZlCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnbWVudScgJiYgdGhpcy5zdGF0ZSAhPT0gJ2ludHJvJykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMubWluaU1hcCkgdGhpcy5taW5pTWFwLnVwZGF0ZSgpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZmxvYXRpbmdUZXh0KSB0aGlzLmZsb2F0aW5nVGV4dC51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB0aGlzLnBhcnRpY2xlTWFuYWdlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFydGljbGVzKGR0KTsgLy8gTGVnYWN5IHNwYXJrcwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVidWdWaXN1YWxpemVyKSB0aGlzLmRlYnVnVmlzdWFsaXplci51cGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgX3VwZGF0ZU9mZnNjcmVlbkluZGljYXRvcigpIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMudGVhbXMuaG9tZSA/IHRoaXMudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIgOiBudWxsOwogICAgICAgICAgICBjb25zdCBpbmRpY2F0b3IgPSB0aGlzLnVpLm9mZnNjcmVlbkluZGljYXRvcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghcCB8fCAhcC5tZXNoIHx8ICF0aGlzLmNhbWVyYSB8fCAhaW5kaWNhdG9yKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBHZXQgUGxheWVyIFBvc2l0aW9uIChDZW50ZXIgTWFzcykKICAgICAgICAgICAgY29uc3QgcG9zID0gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgIHBvcy55ICs9IDEuMDsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAyLiBQcm9qZWN0IHRvIE5vcm1hbGl6ZWQgRGV2aWNlIENvb3JkaW5hdGVzIChOREMpIFstMSwgMV0KICAgICAgICAgICAgdGhpcy5fdGVtcFZlYy5jb3B5KHBvcykucHJvamVjdCh0aGlzLmNhbWVyYSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBDaGVjayBpZiBCZWhpbmQgQ2FtZXJhCiAgICAgICAgICAgIGNvbnN0IGNhbUZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKGNhbUZ3ZCk7CiAgICAgICAgICAgIGNvbnN0IHRvUGxheWVyID0gcG9zLmNsb25lKCkuc3ViKHRoaXMuY2FtZXJhLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgY29uc3QgZG90ID0gY2FtRndkLmRvdCh0b1BsYXllcik7CiAgICAgICAgICAgIGNvbnN0IGlzQmVoaW5kID0gZG90IDwgMC4yOyAvLyBCdWZmZXIgdG8gcHJldmVudCBmbGlwcGluZyBhdCBlZGdlCgogICAgICAgICAgICAvLyA0LiBDaGVjayBCb3VuZHMKICAgICAgICAgICAgY29uc3QgaXNPZmZTY3JlZW4gPSAoCiAgICAgICAgICAgICAgICB0aGlzLl90ZW1wVmVjLnggPCAtMC45IHx8IHRoaXMuX3RlbXBWZWMueCA+IDAuOSB8fAogICAgICAgICAgICAgICAgdGhpcy5fdGVtcFZlYy55IDwgLTAuOSB8fCB0aGlzLl90ZW1wVmVjLnkgPiAwLjkgfHwKICAgICAgICAgICAgICAgIGlzQmVoaW5kCiAgICAgICAgICAgICk7CgogICAgICAgICAgICBpZiAoaXNPZmZTY3JlZW4pIHsKICAgICAgICAgICAgICAgIGluZGljYXRvci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHggPSB0aGlzLl90ZW1wVmVjLng7CiAgICAgICAgICAgICAgICBsZXQgeSA9IHRoaXMuX3RlbXBWZWMueTsKCiAgICAgICAgICAgICAgICAvLyBJZiBiZWhpbmQsIGludmVydCBjb29yZGluYXRlcyB0byBwb2ludCBjb3JyZWN0bHkKICAgICAgICAgICAgICAgIGlmIChpc0JlaGluZCkgewogICAgICAgICAgICAgICAgICAgIHggPSAteDsKICAgICAgICAgICAgICAgICAgICB5ID0gLXk7CiAgICAgICAgICAgICAgICAgICAgLy8gRml4IHNpbmd1bGFyaXR5IGlmIGV4YWN0bHkgYmVoaW5kIGNlbnRlcgogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyh4KSA8IDAuMDEgJiYgTWF0aC5hYnMoeSkgPCAwLjAxKSB5ID0gLTE7IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENsYW1wIHRvIHNjcmVlbiBlZGdlcwogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCB0byBmaW5kIHRoZSBpbnRlcnNlY3Rpb24gb2YgdGhlIHZlY3RvciAoeCx5KSB3aXRoIHRoZSBib3ggWy0wLjksIDAuOV0KICAgICAgICAgICAgICAgIGNvbnN0IHBhZGRpbmcgPSAwLjk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSB0byBnZXQgZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBjb25zdCBtYWcgPSBNYXRoLnNxcnQoeCp4ICsgeSp5KTsKICAgICAgICAgICAgICAgIGNvbnN0IG54ID0geCAvIG1hZzsKICAgICAgICAgICAgICAgIGNvbnN0IG55ID0geSAvIG1hZzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmF5Y2FzdCB0byBib3ggZWRnZXMKICAgICAgICAgICAgICAgIC8vIFZlcnRpY2FsIGVkZ2VzOiB4ID0gKy8tIHBhZGRpbmcKICAgICAgICAgICAgICAgIC8vIEhvcml6b250YWwgZWRnZXM6IHkgPSArLy0gcGFkZGluZwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBdm9pZCBkaXZpZGUgYnkgemVybwogICAgICAgICAgICAgICAgY29uc3QgdHggPSAoTWF0aC5hYnMobngpID4gMC4wMDEpID8gKG54ID4gMCA/IHBhZGRpbmcgOiAtcGFkZGluZykgLyBueCA6IDk5OTsKICAgICAgICAgICAgICAgIGNvbnN0IHR5ID0gKE1hdGguYWJzKG55KSA+IDAuMDAxKSA/IChueSA+IDAgPyBwYWRkaW5nIDogLXBhZGRpbmcpIC8gbnkgOiA5OTk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFVzZSB0aGUgbmVhcmVzdCBpbnRlcnNlY3Rpb24gKHNtYWxsZXN0IHBvc2l0aXZlIHQpCiAgICAgICAgICAgICAgICAvLyBTaW5jZSB3ZSBhcmUgcHJvamVjdGluZyBmcm9tIGNlbnRlciAoMCwwKSB0byAobngsbnkpLCB0IG11c3QgYmUgcG9zaXRpdmUuCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gTWF0aC5taW4oTWF0aC5hYnModHgpLCBNYXRoLmFicyh0eSkpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBzY3JlZW5YID0gbnggKiB0OwogICAgICAgICAgICAgICAgY29uc3Qgc2NyZWVuWSA9IG55ICogdDsKCiAgICAgICAgICAgICAgICAvLyBDb252ZXJ0IE5EQyB0byBQaXhlbHMKICAgICAgICAgICAgICAgIGNvbnN0IHdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBoZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHB4ID0gKHNjcmVlblggKiAwLjUgKyAwLjUpICogd2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBweSA9ICgtKHNjcmVlblkpICogMC41ICsgMC41KSAqIGhlaWdodDsKCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgUm90YXRpb24KICAgICAgICAgICAgICAgIC8vIEFycm93IHBvaW50cyBVUCBieSBkZWZhdWx0LgogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCBpdCB0byBwb2ludCBpbiBkaXJlY3Rpb24gKG54LCBueSkgb24gc2NyZWVuLgogICAgICAgICAgICAgICAgLy8gU2NyZWVuIFkgaXMgZG93biAoaW52ZXJ0ZWQgZnJvbSBXZWJHTCBZKS4KICAgICAgICAgICAgICAgIC8vIFNvICgwLCAxKSBpbiBOREMgaXMgVVAuICgwLCAtMSkgaW4gTkRDIGlzIERPV04uCiAgICAgICAgICAgICAgICAvLyBhdGFuMih5LCB4KSBnaXZlcyBhbmdsZSBmcm9tICtYLgogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCBhbmdsZSBmcm9tICtZIChVcCkuCiAgICAgICAgICAgICAgICAvLyBSb3RhdGlvbiA9IFBJLzIgLSBhbmdsZS4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKG55LCBueCk7CiAgICAgICAgICAgICAgICBjb25zdCByb3QgPSAoTWF0aC5QSSAvIDIpIC0gYW5nbGU7CgogICAgICAgICAgICAgICAgaW5kaWNhdG9yLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHtweH1weCwgJHtweX1weCkgcm90YXRlKCR7cm90fXJhZClgOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgaW5kaWNhdG9yLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVUaW1lcigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnVpLnRpbWVyKSByZXR1cm47CiAgICAgICAgICAgIC8vIENsYW1wIHRvIGhhbGYgZHVyYXRpb24gZm9yIGRpc3BsYXkgaWYgd2UgZ28gc2xpZ2h0bHkgb3ZlciBiZWZvcmUgdGljawogICAgICAgICAgICBjb25zdCB0ID0gTWF0aC5taW4odGhpcy50aW1lLCB0aGlzLmhhbGZEdXJhdGlvbik7CiAgICAgICAgICAgIGNvbnN0IG1pbnV0ZXMgPSBNYXRoLmZsb29yKHQgLyA2MCk7CiAgICAgICAgICAgIGNvbnN0IHNlY29uZHMgPSBNYXRoLmZsb29yKHQgJSA2MCk7CiAgICAgICAgICAgIHRoaXMudWkudGltZXIuaW5uZXJUZXh0ID0gYCR7bWludXRlcy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9OiR7c2Vjb25kcy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9YDsKICAgICAgICB9CiAgICAgICAgX2NoZWNrSGFsZlRpbWUoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnRpbWUgPj0gdGhpcy5oYWxmRHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5kSGFsZigpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKZW5kSGFsZigpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdoYWxmdGltZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdG9wIGFsbCBwbGF5ZXJzCiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFsZiA9PT0gMSkgewogICAgICAgICAgICAgICAgdGhpcy5fc2hvd01vZGFsKCJIQUxGIFRJTUUiLCAiUFJFUEFSSU5HIDJORCBIQUxGLi4uIik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBQbGF5IHdoaXN0bGUgc291bmQgaGVyZSBpZiBhdmFpbGFibGUKICAgICAgICAgICAgICAgIC8vIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnd2hpc3RsZScpOwoKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVNb2RhbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRTZWNvbmRIYWxmKCk7CiAgICAgICAgICAgICAgICB9LCA0MDAwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEVuZCBvZiAybmQgSGFsZiBvciBPdmVydGltZSBQZXJpb2QKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNjb3JlLmhvbWUgPT09IHRoaXMuc2NvcmUuYXdheSkgewogICAgICAgICAgICAgICAgICAgIC8vIFRJRUQgLSBHbyB0byBPdmVydGltZSAoR29sZGVuIEdvYWwpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd01vZGFsKCJPVkVSVElNRSIsICJHT0xERU4gR09BTCBSVUxFIEFDVElWRSIpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlTW9kYWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydE92ZXJ0aW1lKCk7CiAgICAgICAgICAgICAgICAgICAgfSwgNDAwMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIFdpbm5lciBkZWNpZGVkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmRHYW1lKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHN0YXJ0U2Vjb25kSGFsZigpIHsKICAgICAgICAgICAgdGhpcy5oYWxmID0gMjsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICIybmQgSEFMRiI7CiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsgLy8gTmV1dHJhbCBCbGl0ei1vZmYgZm9yIDJuZCBoYWxmIHN0YXJ0CiAgICAgICAgfQoKICAgICAgICBzdGFydE92ZXJ0aW1lKCkgewogICAgICAgICAgICB0aGlzLmhhbGYrKzsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICJPVkVSVElNRSI7CiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsgLy8gTmV1dHJhbCBCbGl0ei1vZmYKICAgICAgICB9CgplbmRHYW1lKCkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2dhbWVvdmVyJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN0b3AgcGxheWVycwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gcC5zZXRJbnB1dCgwLCAwKSk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKCiAgICAgICAgICAgIGxldCBtc2cgPSAiRFJBVyI7CiAgICAgICAgICAgIGlmICh0aGlzLnNjb3JlLmhvbWUgPiB0aGlzLnNjb3JlLmF3YXkpIG1zZyA9ICJWSUNUT1JZIjsKICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuYXdheSA+IHRoaXMuc2NvcmUuaG9tZSkgbXNnID0gIkRFRkVBVCI7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQb3B1bGF0ZSBFbmQgR2FtZSBNZW51CiAgICAgICAgICAgIGlmICh0aGlzLnVpLmVuZE1lbnUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRpdGxlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLXJlc3VsdC10aXRsZScpOwogICAgICAgICAgICAgICAgY29uc3QgaG9tZVNjb3JlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLXNjb3JlLWhvbWUnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF3YXlTY29yZUVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1zY29yZS1hd2F5Jyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aXRsZUVsKSB7CiAgICAgICAgICAgICAgICAgICAgdGl0bGVFbC5pbm5lclRleHQgPSBtc2c7CiAgICAgICAgICAgICAgICAgICAgdGl0bGVFbC5zdHlsZS5jb2xvciA9IChtc2cgPT09ICJWSUNUT1JZIikgPyAiIzAwZmZmZiIgOiAoKG1zZyA9PT0gIkRFRkVBVCIpID8gIiNmZjQ0NDQiIDogIiNmZmZmZmYiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChob21lU2NvcmVFbCkgaG9tZVNjb3JlRWwuaW5uZXJUZXh0ID0gdGhpcy5zY29yZS5ob21lOwogICAgICAgICAgICAgICAgaWYgKGF3YXlTY29yZUVsKSBhd2F5U2NvcmVFbC5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmF3YXk7CgogICAgICAgICAgICAgICAgdGhpcy51aS5lbmRNZW51LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgdGhpcy5zZXRNZW51TW9kZSh0cnVlKTsgLy8gSGlkZSBIVUQKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3RvcCBNdXNpYyBvbiBHYW1lIE92ZXIKICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5zdG9wQkdNKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9oaWRlRW5kTWVudSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudWkuZW5kTWVudSkgewogICAgICAgICAgICAgICAgdGhpcy51aS5lbmRNZW51LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgdGhpcy5zZXRNZW51TW9kZShmYWxzZSk7IC8vIFNob3cgSFVECiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zaG93TW9kYWwodGl0bGUsIHN1YnRleHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnVpLm1vZGFsKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLnF1ZXJ5U2VsZWN0b3IoJy5tb2RhbC10aXRsZScpLmlubmVyVGV4dCA9IHRpdGxlOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLnF1ZXJ5U2VsZWN0b3IoJyNtb2RhbC1zY29yZS1ob21lJykuaW5uZXJUZXh0ID0gdGhpcy5zY29yZS5ob21lOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLnF1ZXJ5U2VsZWN0b3IoJyNtb2RhbC1zY29yZS1hd2F5JykuaW5uZXJUZXh0ID0gdGhpcy5zY29yZS5hd2F5OwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLnF1ZXJ5U2VsZWN0b3IoJyNtb2RhbC1tc2cnKS5pbm5lclRleHQgPSBzdWJ0ZXh0OwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhpZGUgSFVEIGVsZW1lbnRzCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJykuc3R5bGUub3BhY2l0eSA9ICcwJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKS5zdHlsZS5vcGFjaXR5ID0gJzAnOwogICAgICAgIH0KCiAgICAgICAgX2hpZGVNb2RhbCgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnVpLm1vZGFsKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaG93IEhVRCBlbGVtZW50cwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaHVkLXRvcCcpLnN0eWxlLm9wYWNpdHkgPSAnMSc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXItc3RhdHVzLXBhbmVsJykuc3R5bGUub3BhY2l0eSA9ICcxJzsKICAgICAgICB9CgpfY2hlY2tHb2FscygpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHBvcyA9IGJhbGwubWVzaC5wb3NpdGlvbjsKCiAgICAgICAgICAgIC8vIFByZWNpc2UgR29hbCBEZXRlY3Rpb24KICAgICAgICAgICAgLy8gVmlzdWFsIEdvYWwgaXMgYXQgWiA9ICsvLSAyOC4KICAgICAgICAgICAgLy8gV2UgZGVmaW5lIGEgIkdvYWwgTW91dGgiIGJveCBtYXRjaGluZyBHb2FsaWUuanMgKFdpZHRoIDE0LCBIZWlnaHQgOCkuCi8vIFdlIGRlZmluZSBhICJHb2FsIE1vdXRoIiBib3ggbWF0Y2hpbmcgdGhlIHZpc3VhbCBuZXQuCiAgICAgICAgICAgIC8vIEFyZW5hIFJhZGl1cyBpcyAzMi4gR29hbCBpcyByb3VnaGx5IDIybSB3aWRlLCAxOG0gaGlnaC4KLy8gQXJlbmEgUmFkaXVzIGlzIDMyLiBHb2FsIGlzIHJvdWdobHkgMjJtIHdpZGUsIDE4bSBoaWdoLgogICAgICAgICAgICBjb25zdCBoYWxmV2lkdGggPSAxMS4wOyAvLyBJbmNyZWFzZWQgdG8gMTEgKFdpZHRoIDIyKSB0byBjYXRjaCBjb3JuZXJzCiAgICAgICAgICAgIGNvbnN0IGhhbGZIZWlnaHQgPSA5LjA7IC8vIEluY3JlYXNlZCB0byA5IChIZWlnaHQgMTgpIHRvIGNhdGNoIGhpZ2ggc2hvdHMKICAgICAgICAgICAgY29uc3QgZ29hbFlPZmZzZXQgPSAtNC41OyAvLyBNb3ZlZCBkb3duIHRvIG1hdGNoIHZpc3VhbCBtb2RlbCAoLTQuNW0pCgogICAgICAgICAgICBjb25zdCB0cmlnZ2VyWiA9IDQ1LjA7IC8vIFRyaWdnZXIgZWFybGllciAod2FzIDMwKSB0byBlbnN1cmUgcmVnaXN0cmF0aW9uIGJlZm9yZSBib3VuY2UKCiAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueikgPiB0cmlnZ2VyWikgewogICAgICAgICAgICAgICAgLy8gUFJFVkVOVCBPV04gR09BTCBCWSBDQVJSSUVSIChVc2VyIFJlcXVlc3QpCiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgYmFsbCBpcyBoZWxkIGJ5IHRoZSB0ZWFtIGRlZmVuZGluZyB0aGlzIGdvYWwsIGRvIG5vdCBjb3VudCBpdC4KICAgICAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIC8vIEhvbWUgKFNpZGUgMSkgZGVmZW5kcyArWi4gSWYgcG9zLnogPiAwIChIb21lIEdvYWwpIGFuZCBob2xkZXIgaXMgSG9tZSwgaWdub3JlLgogICAgICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IDAgJiYgYmFsbC5ob2xkZXIudGVhbS5zaWRlID09PSAxKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgLy8gQXdheSAoU2lkZSAtMSkgZGVmZW5kcyAtWi4gSWYgcG9zLnogPCAwIChBd2F5IEdvYWwpIGFuZCBob2xkZXIgaXMgQXdheSwgaWdub3JlLgogICAgICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IDAgJiYgYmFsbC5ob2xkZXIudGVhbS5zaWRlID09PSAtMSkgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDIuIENoZWNrIEZyYW1lIChNdXN0IGJlIHdpdGhpbiB3aWR0aC9oZWlnaHQpCi8vIDIuIENoZWNrIEZyYW1lIChNdXN0IGJlIHdpdGhpbiB3aWR0aC9oZWlnaHQsIGFjY291bnRpbmcgZm9yIFkgb2Zmc2V0KQogICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHBvcy54KSA8PSBoYWxmV2lkdGggJiYgTWF0aC5hYnMocG9zLnkgLSBnb2FsWU9mZnNldCkgPD0gaGFsZkhlaWdodCkgewogICAgICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nb2FsU2NvcmVkKCdob21lJyk7IC8vIEhvbWUgYXR0YWNrcyAtWgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ29hbFNjb3JlZCgnYXdheScpOyAvLyBBd2F5IGF0dGFja3MgK1oKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpnb2FsU2NvcmVkKHNjb3JlcikgewogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ2FjdGl2ZScpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElNUEFDVCBGUkFNRTogR09BTAogICAgICAgICAgICB0aGlzLnRyaWdnZXJJbXBhY3QoMC40LCAnc2hhdHRlcicpOyAvLyBNYXNzaXZlIGZyZWV6ZSBmb3IgZ29hbAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRVhQIFJFV0FSRDogR29hbAogICAgICAgICAgICAvLyBGaW5kIHdobyBzY29yZWQgKExhc3QgaG9sZGVyIG9mIGJhbGwpCiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmIChiYWxsICYmIGJhbGwubGFzdEhvbGRlciAmJiBiYWxsLmxhc3RIb2xkZXIudGVhbS5pZCA9PT0gc2NvcmVyKSB7CiAgICAgICAgICAgICAgICBiYWxsLmxhc3RIb2xkZXIuZ2FpbkV4cCgxMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZ29hbCc7CiAgICAgICAgICAgIHRoaXMuc2NvcmVbc2NvcmVyXSsrOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAxLiBWSVNDRVJBTCBTSEFLRSAmIFBBUlRJQ0xFUwogICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMi4wKTsgLy8gSGVhdnkgc2hha2UKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIgJiYgdGhpcy5lbnRpdGllcy5iYWxsICYmIHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnb2FsUG9zID0gdGhpcy5lbnRpdGllcy5iYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgIC8vIE1hc3NpdmUgR29hbCBFeHBsb3Npb24KICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBnb2FsUG9zLCB7IHNjYWxlOiAxNS4wLCBsaWZlOiAwLjggfSk7CiAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBnb2FsUG9zLCB7IHNjYWxlOiAxMC4wIH0pOwogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzA7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdkZWJyaXMnLCBnb2FsUG9zLCB7IHNjYWxlOiAwLjggfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gMi4gU0NSRUVOIEZMQVNICiAgICAgICAgICAgIGlmICh0aGlzLnVpLmZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmZsYXNoLnN0eWxlLm9wYWNpdHkgPSAnMC44JzsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyB0aGlzLnVpLmZsYXNoLnN0eWxlLm9wYWNpdHkgPSAnMCc7IH0sIDEwMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIEdPTERFTiBHT0FMIENIRUNLCiAgICAgICAgICAgIGlmICh0aGlzLmlzT3ZlcnRpbWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiR09MREVOIEdPQUwhIiwgJ3NsYW0nKTsKICAgICAgICAgICAgICAgIC8vIEVuZCBnYW1lIGFmdGVyIHNob3J0IGRlbGF5CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgIH0sIDMwMDApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA0LiBTTEFNIEFOTk9VTkNFTUVOVCAoTm9ybWFsKQogICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkdPQUwhIiwgJ3NsYW0nKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IHNlcXVlbmNlCiAgICAgICAgICAgIC8vIFNjb3JlZC11cG9uIHRlYW0gZ2V0cyBiYWxsCiAgICAgICAgICAgIGNvbnN0IGxvc2VyID0gc2NvcmVyID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGQVNURVIgRkxPVzogUmVkdWNlZCBkZWxheSBmcm9tIDMwMDBtcyB0byAxMjAwbXMKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0Um91bmQobG9zZXIpOwogICAgICAgICAgICB9LCAyMDAwKTsgLy8gU2xpZ2h0bHkgbG9uZ2VyIHRvIGFwcHJlY2lhdGUgdGhlICJHT0FMIiBzbGFtCiAgICAgICAgfQoKc2hvd0Fubm91bmNlbWVudCh0ZXh0LCB0eXBlID0gJ25vcm1hbCcsIGR1cmF0aW9uID0gMjAwMCkgewogICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkuYW5ub3VuY2VtZW50OwogICAgICAgICAgICBpZiAoIWVsKSByZXR1cm47CgogICAgICAgICAgICAvLyBDbGVhciBwcmV2aW91cyB0aW1lb3V0CiAgICAgICAgICAgIGlmICh0aGlzLl9hbm5vdW5jZVRpbWVvdXQpIHsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9hbm5vdW5jZVRpbWVvdXQpOwogICAgICAgICAgICAgICAgdGhpcy5fYW5ub3VuY2VUaW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUmVzZXQgQW5pbWF0aW9uIGJ5IGNsb25pbmcKICAgICAgICAgICAgY29uc3QgbmV3RWwgPSBlbC5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgICAgICAgIGVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKG5ld0VsLCBlbCk7CiAgICAgICAgICAgIHRoaXMudWkuYW5ub3VuY2VtZW50ID0gbmV3RWw7CgogICAgICAgICAgICBuZXdFbC5pbm5lclRleHQgPSB0ZXh0OwogICAgICAgICAgICBuZXdFbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IENsYXNzIGJhc2VkIG9uIHR5cGUKICAgICAgICAgICAgbmV3RWwuY2xhc3NOYW1lID0gJyc7IC8vIFJlc2V0IGNsYXNzZXMKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzbGFtJykgewogICAgICAgICAgICAgICAgbmV3RWwuY2xhc3NMaXN0LmFkZCgnYW5ub3VuY2VtZW50LXNsYW0nKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgc3R5bGUKICAgICAgICAgICAgICAgIG5ld0VsLnN0eWxlLmFuaW1hdGlvbiA9ICdub25lJzsKICAgICAgICAgICAgICAgIG5ld0VsLm9mZnNldEhlaWdodDsgLyogdHJpZ2dlciByZWZsb3cgKi8KICAgICAgICAgICAgICAgIG5ld0VsLnN0eWxlLmFuaW1hdGlvbiA9ICdhbm5vdW5jZVNsaWRlIDAuNXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXV0by1oaWRlCiAgICAgICAgICAgIGlmIChkdXJhdGlvbiA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2Fubm91bmNlVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgfSwgZHVyYXRpb24pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBoaWRlQW5ub3VuY2VtZW50KCkgewogICAgICAgICAgICBpZiAodGhpcy51aS5hbm5vdW5jZW1lbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkuYW5ub3VuY2VtZW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpyZXNldFJvdW5kKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdyZXNldCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBwZXJzaXN0ZW50IHZpc3VhbHMKICAgICAgICAgICAgaWYgKHRoaXMuZ2x5cGhNYW5hZ2VyKSB0aGlzLmdseXBoTWFuYWdlci5jbGVhcigpOwogICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBDbGVhciBwYXJ0aWNsZXMgaWYgbmVlZGVkLCB0aG91Z2ggdGhleSBzZWxmLWV4cGlyZSBxdWlja2x5CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IEJhbGwKICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCkgdGhpcy5lbnRpdGllcy5iYWxsLnJlc2V0KCk7CiAgICAgICAgICAgIGlmICh0aGlzLmVudGl0aWVzLmJhbGwpIHRoaXMuZW50aXRpZXMuYmFsbC5yZXNldCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgVGVhbXMKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5yZXNldFBvc2l0aW9ucygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2xlYXIgYmFsbCBob2xkZXIKICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCkgdGhpcy5lbnRpdGllcy5iYWxsLmRyb3AoKTsKCiAgICAgICAgICAgIC8vIENSSVRJQ0FMOiBTbmFwIGNhbWVyYSB0byBwcmV2ZW50IGRpc29yaWVudGF0aW9uCiAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgIC8vIEZvcmNlIHVwZGF0ZSB0YXJnZXQgZmlyc3QgKHVzdWFsbHkgYmFsbCkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVudGl0aWVzLmJhbGwgJiYgdGhpcy5lbnRpdGllcy5iYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoLCB0aGlzLmVudGl0aWVzLmJhbGwudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zbmFwVG9UYXJnZXQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRkFTVEVSIEZMT1c6IFJlZHVjZWQgZGVsYXkgZnJvbSAyMDAwbXMgdG8gMTAwbXMKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0S2lja29mZihwb3NzZXNzaW9uVGVhbUlkKTsKfSwgMTAwKTsKICAgICAgICB9CgpzdGFydEtpY2tvZmYocG9zc2Vzc2lvblRlYW1JZCkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2tpY2tvZmYnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcCBhbGwgcGxheWVycyBpbW1lZGlhdGVseSB0byBwcmV2ZW50IHByZS1tb3ZlbWVudAogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gcC5zZXRJbnB1dCgwLCAwKSk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKCiAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQkxJVFogT0ZGISIsICdzbGFtJyk7CiAgICAgICAgICAgIC8vIElmIGEgdGVhbSBoYXMgcG9zc2Vzc2lvbiAoYWZ0ZXIgZ29hbCksIGdpdmUgdG8gTUYKICAgICAgICAgICAgaWYgKHBvc3Nlc3Npb25UZWFtSWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRlYW0gPSB0aGlzLnRlYW1zW3Bvc3Nlc3Npb25UZWFtSWRdOwogICAgICAgICAgICAgICAgaWYgKHRlYW0pIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtZiA9IHRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgICAgICAgICBpZiAobWYgJiYgdGhpcy5lbnRpdGllcy5iYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW50aXRpZXMuYmFsbC5ncmFiKG1mKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENSSVRJQ0FMOiBTbmFwIGNhbWVyYSB0byBuZXcgaG9sZGVyIHRvIHByZXZlbnQgc3dpbmcvZGlzb3JpZW50YXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldChtZi5tZXNoLCBtZi52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOZXV0cmFsIGtpY2tvZmYgLSBlbnN1cmUgY2FtZXJhIGlzIHNuYXBwZWQgdG8gY2VudGVyIGJhbGwKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIgJiYgdGhpcy5lbnRpdGllcy5iYWxsICYmIHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldCh0aGlzLmVudGl0aWVzLmJhbGwubWVzaCwgdGhpcy5lbnRpdGllcy5iYWxsLnZlbG9jaXR5KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZBU1RFUiBGTE9XOiBSZWR1Y2VkIGRlbGF5IGZyb20gMTAwMG1zIHRvIDgwMG1zCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5oaWRlQW5ub3VuY2VtZW50KCk7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2FjdGl2ZSc7CiAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgfQogICAgICAgIAovLyBJbml0aWFsIHN0YXJ0Ci8vIEluaXRpYWwgc3RhcnQKICAgICAgICBzdGFydE1hdGNoKG1vZGUgPSAnbm9ybWFsJykgewogICAgICAgICAgICB0aGlzLmdhbWVNb2RlID0gbW9kZTsKICAgICAgICAgICAgY29uc29sZS5sb2coIlN0YXJ0aW5nIE1hdGNoIGluIG1vZGU6IiwgbW9kZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFydCBNdXNpYwogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlCR00oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgU2NvcmUKICAgICAgICAgICAgdGhpcy5zY29yZS5ob21lID0gMDsKICAgICAgICAgICAgdGhpcy5zY29yZS5hd2F5ID0gMDsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgVGltZQogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmhhbGYgPSAxOwogICAgICAgICAgICBpZiAodGhpcy51aS5oYWxmKSB0aGlzLnVpLmhhbGYuaW5uZXJUZXh0ID0gIjFzdCI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAobW9kZSA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkuaGFsZikgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICJQUkFDIjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU3RhcnQgUHJhY3RpY2UgTWFuYWdlcgogICAgICAgICAgICAgICAgaWYgKHRoaXMucHJhY3RpY2VNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIuc3RhcnQoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBJbiBwcmFjdGljZSwgZW5zdXJlIEFJIGlzIGVuYWJsZWQgZm9yIHNwYXJyaW5nCiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWFtcy5hd2F5LmFpRW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNraXAgaW50cm8gZm9yIHByYWN0aWNlCiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0Um91bmQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBQcmFjdGljZSBNYW5hZ2VyIGlzIHN0b3BwZWQgaWYgbm9ybWFsIGdhbWUKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgdGhpcy5wcmFjdGljZU1hbmFnZXIuc3RvcCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTYWZldHk6IEVuc3VyZSBhbGwgcGxheWVycyBhcmUgdmlzaWJsZSAoaW4gY2FzZSBQcmFjdGljZSBoaWQgdGhlbSkKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4geyBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsgfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWFtcy5hd2F5LmFpRW5hYmxlZCA9IHRydWU7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7IGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSB0cnVlOyB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBTdGFydCBDaW5lbWF0aWMgSW50cm8KICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRJbnRyb1NlcXVlbmNlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHN0YXJ0SW50cm9TZXF1ZW5jZSgpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdpbnRybyc7CiAgICAgICAgICAgIHRoaXMuaW50cm9UaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuX2ludHJvUm9hclRyaWdnZXJlZCA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVHVybiBvZmYgbGlnaHRzCiAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhZGl1bS5zZXRBbGxMaWdodHMoZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIaWRlIFVJCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJykuc3R5bGUub3BhY2l0eSA9ICcwJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKS5zdHlsZS5vcGFjaXR5ID0gJzAnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgcG9zaXRpb25zIHNvIHBsYXllcnMgYXJlIG9uIGZpZWxkIGluIGRhcmsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIHRoaXMudGVhbXMuYXdheS5yZXNldFBvc2l0aW9ucygpOwogICAgICAgICAgICBpZiAodGhpcy5lbnRpdGllcy5iYWxsKSB0aGlzLmVudGl0aWVzLmJhbGwucmVzZXQoKTsKICAgICAgICB9Ci8vIER1cGxpY2F0ZSBibG9jayByZW1vdmVkCgpzZXRNZW51TW9kZShpc0FjdGl2ZSkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gaXNBY3RpdmUgPyAnbWVudScgOiAnYWN0aXZlJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChpc0FjdGl2ZSAmJiB0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIuc3RvcEJHTSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIaWRlIEhVRCBpbiBtZW51CiAgICAgICAgICAgIGNvbnN0IGh1ZFRvcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJyk7CiAgICAgICAgICAgIGNvbnN0IHN0YXR1c1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKTsKICAgICAgICAgICAgY29uc3QgY29udHJvbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWNvbnRhaW5lcicpOwogICAgICAgICAgICBjb25zdCBqb3lzdGljayA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1oaXQtem9uZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2ZsZXgnOyAvLyBvciBibG9jay9ldGMKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChodWRUb3ApIGh1ZFRvcC5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheTsKICAgICAgICAgICAgaWYgKHN0YXR1c1BhbmVsKSBzdGF0dXNQYW5lbC5zdHlsZS5kaXNwbGF5ID0gaXNBY3RpdmUgPyAnbm9uZScgOiAnYmxvY2snOyAvLyBTdGF0dXMgcGFuZWwgaGFzIHNwZWNpZmljIGxvZ2ljCiAgICAgICAgICAgIGlmIChjb250cm9scykgY29udHJvbHMuc3R5bGUuZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2ZsZXgnOwogICAgICAgICAgICBpZiAoam95c3RpY2spIGpveXN0aWNrLnN0eWxlLmRpc3BsYXkgPSBpc0FjdGl2ZSA/ICdub25lJyA6ICdibG9jayc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJZiBlbnRlcmluZyBtZW51LCByZXNldCBjYW1lcmEgdG8gYSBuaWNlIGFuZ2xlPwogICAgICAgICAgICAvLyBIYW5kbGVkIGJ5IHVwZGF0ZSBsb29wCiAgICAgICAgfQp0b2dnbGVEZW1vTW9kZSgpIHsKICAgICAgICAgICAgdGhpcy5pc0RlbW9Nb2RlID0gIXRoaXMuaXNEZW1vTW9kZTsKICAgICAgICAgICAgY29uc29sZS5sb2coIkRlbW8gTW9kZToiLCB0aGlzLmlzRGVtb01vZGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFVJIEJ1dHRvbgogICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXV0by10b2dnbGUnKTsKICAgICAgICAgICAgaWYgKGJ0bikgewogICAgICAgICAgICAgICAgYnRuLmlubmVyVGV4dCA9IHRoaXMuaXNEZW1vTW9kZSA/ICJBVVRPIFBJTE9UIiA6ICJNQU5VQUwiOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNEZW1vTW9kZSkgewogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBbm5vdW5jZW1lbnQKICAgICAgICAgICAgY29uc3QgdGV4dCA9IHRoaXMuaXNEZW1vTW9kZSA/ICJBVVRPIFBJTE9UIiA6ICJNQU5VQUwiOwogICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQodGV4dCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXN1YWwgRmxhaXI6IFNwYXduIHRleHQgYWJvdmUgYWN0aXZlIHBsYXllcgogICAgICAgICAgICBpZiAodGhpcy5pc0RlbW9Nb2RlICYmIHRoaXMuZmxvYXRpbmdUZXh0ICYmIHRoaXMudGVhbXMuaG9tZSAmJiB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyICYmIHRoaXMudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5mbG9hdGluZ1RleHQuc3Bhd24oIkFJIEVOR0FHRUQiLCB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyLm1lc2gucG9zaXRpb24sICJnb2FsIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEF1dG8taGlkZSBhbm5vdW5jZW1lbnQKc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy51aS5hbm5vdW5jZW1lbnQgJiYgdGhpcy51aS5hbm5vdW5jZW1lbnQuaW5uZXJUZXh0ID09PSB0ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlQW5ub3VuY2VtZW50KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIDE1MDApOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIFRFQ0hDT1BZIFNZU1RFTSAtLS0KCiAgICAgICAgdHJpZ2dlclRlY2hFdmVudChzb3VyY2VQbGF5ZXIsIHRlY2hOYW1lKSB7CiAgICAgICAgICAgIGlmICghc291cmNlUGxheWVyIHx8ICFzb3VyY2VQbGF5ZXIudGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gRmluZCBvcHBvc2luZyB0ZWFtCiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW1JZCA9IHNvdXJjZVBsYXllci50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSB0aGlzLnRlYW1zW29wcFRlYW1JZF07CiAgICAgICAgICAgIGlmICghb3BwVGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gRmluZCB3aG8gaXMgbWFya2luZyB0aGlzIHNvdXJjZQogICAgICAgICAgICBjb25zdCBsZWFybmVycyA9IG9wcFRlYW0ucGxheWVycy5maWx0ZXIocCA9PiBwLm1hcmtpbmcgPT09IHNvdXJjZVBsYXllcik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAobGVhcm5lcnMubGVuZ3RoID09PSAwKSByZXR1cm47CgogICAgICAgICAgICAvLyBPbmx5IHNob3cgVUkgaWYgdGhlIGxlYXJuaW5nIHRlYW0gaXMgSHVtYW4gKEhvbWUpCiAgICAgICAgICAgIC8vIChPciBpZiB3ZSBhcmUgaW4gRGVtbyBtb2RlIGFuZCB3YW50IHRvIHNlZSBpdCBoYXBwZW4gZm9yIEhvbWUgdGVhbSkKICAgICAgICAgICAgaWYgKG9wcFRlYW0uaXNIdW1hbikgewogICAgICAgICAgICAgICAgLy8gRmlsdGVyIG91dCB0aG9zZSB3aG8gYWxyZWFkeSBrbm93IGl0CiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZExlYXJuZXJzID0gbGVhcm5lcnMuZmlsdGVyKHAgPT4gIXAubGVhcm5lZFRlY2hzLmluY2x1ZGVzKHRlY2hOYW1lKSk7CiAgICAgICAgICAgICAgICBpZiAodmFsaWRMZWFybmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydFRlY2hDb3B5V2luZG93KHRlY2hOYW1lLCB2YWxpZExlYXJuZXJzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCnN0YXJ0VGVjaENvcHlXaW5kb3codGVjaE5hbWUsIGxlYXJuZXJzKSB7CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUubWF4VGltZSA9IDAuNjsgLy8gMC42cyB3aW5kb3cKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLnRpbWVyID0gdGhpcy50ZWNoQ29weVN0YXRlLm1heFRpbWU7CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS50ZWNoID0gdGVjaE5hbWU7CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS5sZWFybmVycyA9IGxlYXJuZXJzOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2hvdyBVSQogICAgICAgICAgICBpZiAodGhpcy51aS50ZWNoRmxhc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5iYWNrZ3JvdW5kID0gIiI7IC8vIFJlc2V0IGJhY2tncm91bmQKICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoLnF1ZXJ5U2VsZWN0b3IoJy50ZWNoLXRleHQnKS5pbm5lclRleHQgPSAiVEVDSENPUFkhIjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaFN1YikgewogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFN1Yi5pbm5lclRleHQgPSB0ZWNoTmFtZS5yZXBsYWNlKCdfJywgJyAnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVzZXQgYmFyCiAgICAgICAgICAgICAgICBpZiAodGhpcy51aS50ZWNoVGltZXJGaWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoVGltZXJGaWxsLnN0eWxlLndpZHRoID0gJzEwMCUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKYXR0ZW1wdFRlY2hDb3B5KCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN1Y2Nlc3MhCiAgICAgICAgICAgIGNvbnN0IHRlY2ggPSB0aGlzLnRlY2hDb3B5U3RhdGUudGVjaDsKICAgICAgICAgICAgY29uc3QgbGVhcm5lcnMgPSB0aGlzLnRlY2hDb3B5U3RhdGUubGVhcm5lcnM7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZWFybmVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgLy8gRG91YmxlIGNoZWNrIHRvIHByZXZlbnQgZHVwbGljYXRlcwogICAgICAgICAgICAgICAgaWYgKCFwLmxlYXJuZWRUZWNocy5pbmNsdWRlcyh0ZWNoKSkgewogICAgICAgICAgICAgICAgICAgIHAubGVhcm5lZFRlY2hzLnB1c2godGVjaCk7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7cC5yb2xlfSBsZWFybmVkICR7dGVjaH0hYCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMS4gRmxvYXRpbmcgVGV4dAogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmZsb2F0aW5nVGV4dCAmJiBwLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mbG9hdGluZ1RleHQuc3Bhd24oYExFQVJORUQhYCwgcC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAyLiBQYXJ0aWNsZSBFZmZlY3QgKFNwaXJhbCkKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIG11bHRpcGxlIHBhcnRpY2xlcyBmb3IgYSBzd2lybCBlZmZlY3QKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MTA7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2xlYXJuZWQnLCBwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgaSAqIDUwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmVuZFRlY2hDb3B5V2luZG93KHRydWUpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgplbmRUZWNoQ29weVdpbmRvdyhzdWNjZXNzKSB7CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaEZsYXNoKSB7CiAgICAgICAgICAgICAgICBpZiAoc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoLnF1ZXJ5U2VsZWN0b3IoJy50ZWNoLXRleHQnKS5pbm5lclRleHQgPSAiU1VDQ0VTUyEiOwogICAgICAgICAgICAgICAgICAgIC8vIEZsYXNoIHN1Y2Nlc3MgY29sb3IgKFdoaXRlIGZsYXNoKQogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoLnN0eWxlLmJhY2tncm91bmQgPSAicmdiYSgyNTUsIDI1NSwgMjU1LCAwLjgpIjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBIaWRlIGFmdGVyIHNob3J0IGRlbGF5IHRvIHNob3cgdGhlIHN1Y2Nlc3MgZmxhc2gKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7IAogICAgICAgICAgICAgICAgICAgIH0sIDMwMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIEZhaWxlZCAvIE1pc3NlZAogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaEZsYXNoLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9Cl91cGRhdGVQbGF5ZXJTdGF0dXNVSSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW1zLmhvbWUgfHwgIXRoaXMudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCB1aSA9IHRoaXMudWkuc3RhdHVzUGFuZWw7CiAgICAgICAgICAgIAovLyBVSSBVcGRhdGVzIChBY3Rpb24gQnV0dG9uIENvbnRleHQpCiAgICAgICAgICAgICAgICB1aS5jb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE5hbWUgJiBMZXZlbAogICAgICAgICAgICAgICAgaWYgKHVpLm5hbWUpIHVpLm5hbWUuaW5uZXJUZXh0ID0gYCR7cC5jaGFyYWN0ZXJOYW1lIHx8IHAucm9sZX0gTFYke3AubGV2ZWx9YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSFAKICAgICAgICAgICAgICAgIGlmICh1aS5ocEJhcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhwUGN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMTAwLCAocC5zdGF0cy5IUCAvIHAuc3RhdHMubWF4SFApICogMTAwKSk7CiAgICAgICAgICAgICAgICAgICAgdWkuaHBCYXIuc3R5bGUud2lkdGggPSBgJHtocFBjdH0lYDsKICAgICAgICAgICAgICAgICAgICAvLyBDb2xvciBzaGlmdAogICAgICAgICAgICAgICAgICAgIGlmIChocFBjdCA8IDI1KSB1aS5ocEJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmMDAwMCwgI2ZmNDQ0NCknOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGhwUGN0IDwgNTApIHVpLmhwQmFyLnN0eWxlLmJhY2tncm91bmQgPSAnbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjZmZmZjAwLCAjZmZmZjg4KSc7CiAgICAgICAgICAgICAgICAgICAgZWxzZSB1aS5ocEJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzAwZmYwMCwgI2NjZmZjYyknOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHVpLmhwVGV4dCkgdWkuaHBUZXh0LmlubmVyVGV4dCA9IGAke01hdGguZmxvb3IocC5zdGF0cy5IUCl9LyR7cC5zdGF0cy5tYXhIUH1gOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBFWFAKICAgICAgICAgICAgICAgIGlmICh1aS5leHBCYXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBleHBQY3QgPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxMDAsIChwLmV4cCAvIHAubmV4dExldmVsRXhwKSAqIDEwMCkpOwogICAgICAgICAgICAgICAgICAgIHVpLmV4cEJhci5zdHlsZS53aWR0aCA9IGAke2V4cFBjdH0lYDsKdWkuZXhwQmFyLnN0eWxlLndpZHRoID0gYCR7ZXhwUGN0fSVgOwogICAgICAgICAgICAgICAgfQogICAgICAgIH0KCl9pbml0UGFydGljbGVzKCkgewogICAgICAgICAgICB0aGlzLmFjdGl2ZVNwYXJrcyA9IFtdOwogICAgICAgICAgICB0aGlzLnNwYXJrUG9vbCA9IFtdOwogICAgICAgICAgICBjb25zdCBwb29sU2l6ZSA9IDQwOyAvLyBTdWZmaWNpZW50IGZvciBjb250aW51b3VzIGdyaW5kaW5nCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvb2xTaXplOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUoX3NwYXJrTWF0ZXJpYWwuY2xvbmUoKSk7CiAgICAgICAgICAgICAgICBzcHJpdGUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQoc3ByaXRlKTsKICAgICAgICAgICAgICAgIHRoaXMuc3BhcmtQb29sLnB1c2goc3ByaXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd25DbGFzaChwb3MsIGludGVuc2l0eSA9IDEuMCkgewogICAgICAgICAgICAvLyBGaW5kIGZyZWUgc3BhcmsKICAgICAgICAgICAgY29uc3Qgc3BhcmsgPSB0aGlzLnNwYXJrUG9vbC5maW5kKHMgPT4gIXMudmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghc3BhcmspIHJldHVybjsgLy8gUG9vbCBleGhhdXN0ZWQKICAgICAgICAgICAgCiAgICAgICAgICAgIHNwYXJrLnBvc2l0aW9uLmNvcHkocG9zKTsKICAgICAgICAgICAgc3BhcmsudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYW5kb21pemUgcm90YXRpb24KICAgICAgICAgICAgc3BhcmsubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgQWN0aXZlIFN0YXRlCiAgICAgICAgICAgIHRoaXMuYWN0aXZlU3BhcmtzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogc3BhcmssCiAgICAgICAgICAgICAgICBhZ2U6IDAsCiAgICAgICAgICAgICAgICBsaWZlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMTUsIC8vIEZhc3QsIHB1bmNoeSBzcGFya3MKICAgICAgICAgICAgICAgIG1heFNjYWxlOiAyLjUgKiBpbnRlbnNpdHksCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSo4LCAKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKjgsIAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqOAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVQYXJ0aWNsZXMoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuYWN0aXZlU3BhcmtzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5hY3RpdmVTcGFya3NbaV07CiAgICAgICAgICAgICAgICBwLmFnZSArPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHAuYWdlID49IHAubGlmZSkgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVTcGFya3Muc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gcC5hZ2UgLyBwLmxpZmU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEV4cGFuZAogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNjYWxlID0gMC41ICsgKHAubWF4U2NhbGUgLSAwLjUpICogdDsKICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIoY3VycmVudFNjYWxlKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmFkZSBvdXQKICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wIC0gKHQgKiB0KTsgLy8gUXVhZHJhdGljIGZhZGUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gTW92ZQogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmFkZFNjYWxlZFZlY3RvcihwLnZlbG9jaXR5LCBkdCk7CiAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwucm90YXRpb24gKz0gMTAuMCAqIGR0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKLy8gSGVscGVyIGZvciBpbXBhY3QgZnJhbWVzCgp0cmlnZ2VySW1wYWN0KGR1cmF0aW9uLCB0eXBlID0gJ2RlZmF1bHQnKSB7CiAgICAgICAgICAgIHRoaXMuaW1wYWN0UGF1c2UgPSBkdXJhdGlvbjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnYW1lLWNvbnRhaW5lcicpOwogICAgICAgICAgICBpZiAoIWNvbnRhaW5lcikgcmV0dXJuOwoKICAgICAgICAgICAgLy8gUmVzZXQgY2xhc3NlcyB0byBlbnN1cmUgYW5pbWF0aW9uIHJlc3RhcnRzCiAgICAgICAgICAgIGNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdpbXBhY3QtZngnLCAnaW1wYWN0LWhlYXZ5JywgJ2ltcGFjdC1zaGF0dGVyJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGb3JjZSByZWZsb3cKICAgICAgICAgICAgdm9pZCBjb250YWluZXIub2Zmc2V0V2lkdGg7CgogICAgICAgICAgICBsZXQgY2xhc3NOYW1lID0gJ2ltcGFjdC1meCc7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnaGVhdnknKSBjbGFzc05hbWUgPSAnaW1wYWN0LWhlYXZ5JzsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzaGF0dGVyJykgY2xhc3NOYW1lID0gJ2ltcGFjdC1zaGF0dGVyJzsKCiAgICAgICAgICAgIGNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKGNsYXNzTmFtZSk7CgogICAgICAgICAgICAvLyBBdXRvLXJlbW92ZSBjbGFzcyBhZnRlciBkdXJhdGlvbgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKGNsYXNzTmFtZSk7CiAgICAgICAgICAgIH0sIGR1cmF0aW9uICogMTAwMCArIDEwMCk7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkdhbWVNYW5hZ2VyID0gR2FtZU1hbmFnZXI7Cn0pKCk7","AIPlayer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzCiAgICBjb25zdCBfYWlWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3RhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhbkRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhblRvT3BwID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF90ZW1wVmVjMSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlYzIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEFJUGxheWVyIGV4dGVuZHMgd2luZG93LmZsdXguUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSkgewogICAgICAgICAgICBzdXBlcihzY2VuZSwgcm9sZSk7CiAgICAgICAgICAgIHRoaXMuYmFsbFJlZiA9IG51bGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGF0cyBhcmUgbWFuYWdlZCBieSBUZWFtL01haW4gb3IgZGVmYXVsdCBQbGF5ZXIgdmFsdWVzLgogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIC8vIFN0YXRlIE1hY2hpbmUKICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB0aGlzLmRlY2lzaW9uVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLmRlY2lzaW9uSW50ZXJ2YWwgPSAwLjU7IC8vIFNsb3dlciBkZWNpc2lvbnMKCiAgICAgICAgICAgIC8vIC0tLSBQRVJDRVBUSU9OIFNZU1RFTSAoUmVhY3Rpb24gVGltZSkgLS0tCiAgICAgICAgICAgIHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5yZWFjdGlvblNwZWVkID0gMS41OyAKICAgICAgICAgICAgdGhpcy5hbnRpY2lwYXRpb25UaW1lID0gMC4yOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJvbGUgQ29uZmlnCiAgICAgICAgICAgIHRoaXMuaXNGb3J3YXJkID0gWydMRicsICdSRiddLmluY2x1ZGVzKHJvbGUpOwogICAgICAgICAgICB0aGlzLmlzTWlkZmllbGRlciA9IHJvbGUgPT09ICdNRic7CiAgICAgICAgICAgIHRoaXMuaXNEZWZlbmRlciA9IFsnTEQnLCAnUkQnXS5pbmNsdWRlcyhyb2xlKTsKCiAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLl9hc3NpZ25EZWZhdWx0VGVjaHMoKTsKICAgICAgICB9CgogICAgICAgIF9hc3NpZ25EZWZhdWx0VGVjaHMoKSB7CiAgICAgICAgICAgIGNvbnN0IHRhY2tsZVRlY2hzID0gWyd2ZW5vbScsICd3aXRoZXInLCAnZHJhaW4nXTsKICAgICAgICAgICAgY29uc3Qgc2hvb3RUZWNocyA9IFsndmVub20nLCAnc3BoZXJlJywgJ2ludmlzaWJsZSddOwogICAgICAgICAgICBjb25zdCBwYXNzVGVjaHMgPSBbJ3Zlbm9tJywgJ3dpdGhlcicsICduYXAnXTsKICAgICAgICAgICAgY29uc3QgcGFzc2l2ZVRlY2hzID0gWydicmF3bGVyJywgJ2VsaXRlX2RlZmVuc2UnXTsKCiAgICAgICAgICAgIGNvbnN0IHBpY2sgPSAoYXJyKSA9PiBhcnJbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogYXJyLmxlbmd0aCldOwogICAgICAgICAgICBjb25zdCBjaGFuY2UgPSAocHJvYikgPT4gTWF0aC5yYW5kb20oKSA8IHByb2I7CgogICAgICAgICAgICBpZiAodGhpcy5pc0RlZmVuZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMykpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4yKSkgdGhpcy50ZWNocy5wYXNzaXZlID0gcGljayhwYXNzaXZlVGVjaHMpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNNaWRmaWVsZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy5zaG9vdCA9IHBpY2soc2hvb3RUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjMpKSB0aGlzLnRlY2hzLnNob290ID0gcGljayhzaG9vdFRlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy50YWNrbGUgPSBwaWNrKHRhY2tsZVRlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy5wYXNzaXZlID0gcGljayhwYXNzaXZlVGVjaHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgLy8gU2FmZXR5OiBBdXRvLWxpbmsgYmFsbCBpZiBtaXNzaW5nCiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFsbFJlZiA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBpc0RlbW8gPSBnYW1lICYmIGdhbWUuaXNEZW1vTW9kZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGlzSW5jYXBhY2l0YXRlZCA9ICh0aGlzLnN0dW5UaW1lciA+IDApIHx8ICh0aGlzLnN0YXR1cy5uYXAgPiAwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGlzSHVtYW5UZWFtID0gdGhpcy50ZWFtICYmIHRoaXMudGVhbS5pc0h1bWFuOwogICAgICAgICAgICBjb25zdCBpc0FjdGl2ZVBsYXllciA9IHRoaXMudGVhbSAmJiAodGhpcy50ZWFtLmFjdGl2ZVBsYXllciA9PT0gdGhpcyk7CiAgICAgICAgICAgIGNvbnN0IHNob3VsZFJ1bkFJID0gKCFpc0h1bWFuVGVhbSB8fCBpc0RlbW8gfHwgKGlzSHVtYW5UZWFtICYmICFpc0FjdGl2ZVBsYXllcikpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaXNUZWFtQUlFbmFibGVkID0gdGhpcy50ZWFtID8gdGhpcy50ZWFtLmFpRW5hYmxlZCA6IHRydWU7CgogICAgICAgICAgICBpZiAoaXNJbmNhcGFjaXRhdGVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHNob3VsZFJ1bkFJICYmIGlzVGVhbUFJRW5hYmxlZCkgewogICAgICAgICAgICAgICAgLy8gLS0tIFBFUkNFUFRJT04gVVBEQVRFIC0tLQogICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYubWVzaCkgewogICAgICAgICAgICAgICAgICAgIGxldCByZWFsVGFyZ2V0ID0gdGhpcy5iYWxsUmVmLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZi5ob2xkZXIgJiYgdGhpcy5iYWxsUmVmLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQgPSB0aGlzLmJhbGxSZWYuaG9sZGVyLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZi5ob2xkZXIudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQuYWRkU2NhbGVkVmVjdG9yKHRoaXMuYmFsbFJlZi5ob2xkZXIudmVsb2NpdHksIHRoaXMuYW50aWNpcGF0aW9uVGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYmFsbFJlZi52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgICAgICByZWFsVGFyZ2V0LmFkZFNjYWxlZFZlY3Rvcih0aGlzLmJhbGxSZWYudmVsb2NpdHksIHRoaXMuYW50aWNpcGF0aW9uVGltZSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbHBoYSA9IE1hdGgubWluKDEuMCwgZHQgKiB0aGlzLnJlYWN0aW9uU3BlZWQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zLmxlcnAocmVhbFRhcmdldCwgYWxwaGEpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDEuIERlY2lzaW9uIE1ha2luZwogICAgICAgICAgICAgICAgdGhpcy5kZWNpc2lvblRpbWVyICs9IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVjaXNpb25UaW1lciA+IHRoaXMuZGVjaXNpb25JbnRlcnZhbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZGVjaXNpb25UaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZXZhbHVhdGVTdGF0ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDIuIEV4ZWN1dGUgU3RhdGUKICAgICAgICAgICAgICAgIHRoaXMuX2V4ZWN1dGVTdGF0ZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDMuIEludGVyY2VwdGlvbiBMb2dpYwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaEltbXVuaXR5VGltZXIgPiAwKSB0aGlzLnRlY2hJbW11bml0eVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnRlcmNlcHRpb25QcmVzc3VyZShkdCk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQUkgRGlzYWJsZWQgb3IgSHVtYW4gQ29udHJvbGxlZAogICAgICAgICAgICAgICAgY29uc3QgaXNEcml2ZW5CeUh1bWFuID0gaXNIdW1hblRlYW0gJiYgaXNBY3RpdmVQbGF5ZXIgJiYgIWlzRGVtbzsKICAgICAgICAgICAgICAgIGlmICghaXNEcml2ZW5CeUh1bWFuKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIFBhc3NpdmUgaW50ZXJjZXB0aW9uIHN0aWxsIGFwcGxpZXMKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5SW50ZXJjZXB0aW9uUHJlc3N1cmUoZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA0LiBCYXNlIFVwZGF0ZQogICAgICAgICAgICBzdXBlci51cGRhdGUoZHQpOwogICAgICAgIH0KCiAgICAgICAgX2V2YWx1YXRlU3RhdGUoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnQVRUQUNLX0NBUlJZJzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFiYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ1JFVFVSTl9IT01FJzsKICAgICAgICAgICAgICAgIGNvbnN0IGJpYXMgPSAodGhpcy5haVN0YXRlID09PSAnQ0hBU0UnKSA/IDAuOCA6IDEuMDsKICAgICAgICAgICAgICAgIGNvbnN0IG15RGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbikgKiBiaWFzOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgaXNDbG9zZXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAgPT09IHRoaXMpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnJvbGUgPT09ICdHTCcpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29udGludWU7CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwRGlzdCA9IHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwRGlzdCA8IG15RGlzdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNDbG9zZXN0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoaXNDbG9zZXN0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0NIQVNFJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ1NVUFBPUlQnOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIudGVhbSAhPT0gdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnREVGRU5EJzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2V4ZWN1dGVTdGF0ZShkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMuYmFsbFJlZikgewogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3dpdGNoICh0aGlzLmFpU3RhdGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ0FUVEFDS19DQVJSWSc6IHRoaXMuX3N0YXRlQXR0YWNrQ2FycnkoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1NVUFBPUlQnOiB0aGlzLl9zdGF0ZVN1cHBvcnQoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0RFRkVORCc6IHRoaXMuX3N0YXRlRGVmZW5kKGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdDSEFTRSc6IHRoaXMuX3N0YXRlQ2hhc2UoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1JFVFVSTl9IT01FJzogCiAgICAgICAgICAgICAgICBkZWZhdWx0OiB0aGlzLl9zdGF0ZVJldHVybkhvbWUoZHQpOyBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3N0YXRlQXR0YWNrQ2FycnkoZHQpIHsKICAgICAgICAgICAgY29uc3QgYXR0YWNrRGlyID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKICAgICAgICAgICAgY29uc3QgZ29hbFogPSA0NiAqIGF0dGFja0RpcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIF90YXJnZXRQb3Muc2V0KDAsIDAsIGdvYWxaKTsKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CgogICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoZGlzdFRvR29hbCA8IDIwLjAgJiYgIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdTSCcpOyAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaXNTdXJyb3VuZGVkID0gdGhpcy5faXNTdXJyb3VuZGVkKCk7CiAgICAgICAgICAgIGNvbnN0IGxvd0VOID0gdGhpcy5jdXJyZW50RU4gPCAxMDsKICAgICAgICAgICAgY29uc3QgaXNQbGF5bWFrZXIgPSB0aGlzLmlzTWlkZmllbGRlcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICgoaXNTdXJyb3VuZGVkIHx8IGxvd0VOIHx8IGlzUGxheW1ha2VyKSAmJiAhdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiZXN0TWF0ZSA9IHRoaXMuX2ZpbmRCZXN0UGFzc1RhcmdldCgpOwogICAgICAgICAgICAgICAgaWYgKGJlc3RNYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHNob3VsZFBhc3MgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdXJyb3VuZGVkIHx8IGxvd0VOKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZFBhc3MgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNQbGF5bWFrZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbXlEaXN0ID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hdGVEaXN0ID0gTWF0aC5hYnMoYmVzdE1hdGUubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZURpc3QgPCBteURpc3QgLSA1LjApIHNob3VsZFBhc3MgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoc2hvdWxkUGFzcykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KGJlc3RNYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zbWFydFRocm93KHRoaXMuYmFsbFJlZiwgJ1BBJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChpc1N1cnJvdW5kZWQgJiYgIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdTSCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfaXNTdXJyb3VuZGVkKCkgewogICAgICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9ICh0aGlzLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IobGV0IHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocC5tZXNoICYmIHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRoaXMubWVzaC5wb3NpdGlvbikgPCA0LjApIHsKICAgICAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb3VudCA+PSAyOwogICAgICAgIH0KCiAgICAgICAgX3NtYXJ0VGhyb3coYmFsbCwgZm9yY2VkVHlwZSA9IG51bGwpIHsKICAgICAgICAgICAgbGV0IHR5cGUgPSBmb3JjZWRUeXBlOwogICAgICAgICAgICBpZiAoIXR5cGUpIHsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF0dGFja0RpciA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLTEgOiAxOwogICAgICAgICAgICAgICAgY29uc3QgaXNBaW1pbmdHb2FsID0gKF90ZW1wVmVjMS56ICogYXR0YWNrRGlyID4gMC41KTsKICAgICAgICAgICAgICAgIHR5cGUgPSBpc0FpbWluZ0dvYWwgPyAnU0gnIDogJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdGVjaE5hbWUgPSAodHlwZSA9PT0gJ1NIJykgPyB0aGlzLnRlY2hzLnNob290IDogdGhpcy50ZWNocy5wYXNzOwogICAgICAgICAgICBsZXQgYmFzZUNvc3QgPSAodHlwZSA9PT0gJ1NIJykgPyAyMCA6IDEwOwogICAgICAgICAgICBsZXQgdGVjaENvc3QgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodGVjaE5hbWUuaW5jbHVkZXMoJ25hcCcpKSB0ZWNoQ29zdCA9IDMwOwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaE5hbWUuaW5jbHVkZXMoJ3NwaGVyZScpIHx8IHRlY2hOYW1lLmluY2x1ZGVzKCdpbnZpc2libGUnKSkgdGVjaENvc3QgPSAyNTsKICAgICAgICAgICAgICAgIGVsc2UgdGVjaENvc3QgPSAyMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdG90YWxDb3N0ID0gYmFzZUNvc3QgKyB0ZWNoQ29zdDsKICAgICAgICAgICAgbGV0IHRlbXBUZWNoID0gbnVsbDsKICAgICAgICAgICAgaWYgKHRlY2hOYW1lICYmIHRoaXMuc3RhdHMuSFAgPCB0b3RhbENvc3QgJiYgdGhpcy5zdGF0cy5IUCA+PSBiYXNlQ29zdCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wVGVjaCA9IHRoaXMudGVjaHMuc2hvb3Q7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWNocy5zaG9vdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRlbXBUZWNoID0gdGhpcy50ZWNocy5wYXNzOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGVjaHMucGFzcyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudGhyb3dCYWxsKGJhbGwsIHR5cGUpOwoKICAgICAgICAgICAgaWYgKHRlbXBUZWNoKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgdGhpcy50ZWNocy5zaG9vdCA9IHRlbXBUZWNoOwogICAgICAgICAgICAgICAgZWxzZSB0aGlzLnRlY2hzLnBhc3MgPSB0ZW1wVGVjaDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3N0YXRlQ2hhc2UoZHQpIHsKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zKTsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKICAgICAgICAgICAgaWYgKGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDEuMCkgewogICAgICAgICAgICAgICAgX3RhcmdldFBvcy5hZGRTY2FsZWRWZWN0b3IoYmFsbC52ZWxvY2l0eSwgMC4zKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICB9CgogICAgICAgIF9zdGF0ZVJldHVybkhvbWUoZHQpIHsKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CiAgICAgICAgfQoKICAgICAgICBfc3RhdGVTdXBwb3J0KGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CiAgICAgICAgICAgIGNvbnN0IGNhcnJpZXIgPSBiYWxsLmhvbGRlcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghY2FycmllciB8fCAhY2Fycmllci5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdGF0ZVJldHVybkhvbWUoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBiYWxsUG9zID0gY2Fycmllci5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBhdHRhY2tEaXIgPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLTEgOiAxOwogICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtNDYgOiA0NjsKCiAgICAgICAgICAgIGNvbnN0IHByZXNzdXJlID0gdGhpcy5fY2FsY3VsYXRlUHJlc3N1cmVPblBsYXllcihjYXJyaWVyKTsKCiAgICAgICAgICAgIF90YXJnZXRQb3MuY29weSh0aGlzLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgIF90YXJnZXRQb3MueiArPSBiYWxsUG9zLnogKiAwLjY7CgogICAgICAgICAgICBpZiAodGhpcy5pc0ZvcndhcmQpIHsKICAgICAgICAgICAgICAgIGxldCB0YXJnZXRaID0gYmFsbFBvcy56ICsgKGF0dGFja0RpciAqIDE1LjApOyAKICAgICAgICAgICAgICAgIGlmIChwcmVzc3VyZSA+IDAuOCkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldFogPSBiYWxsUG9zLnogKyAoYXR0YWNrRGlyICogOC4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IHRpbWUgPSBEYXRlLm5vdygpICogMC4wMDE7CiAgICAgICAgICAgICAgICBjb25zdCB3ZWF2ZSA9IE1hdGguc2luKHRpbWUgKyB0aGlzLm1lc2guaWQpICogNi4wOwogICAgICAgICAgICAgICAgX3RhcmdldFBvcy54ID0gdGhpcy5ob21lUG9zaXRpb24ueCArIHdlYXZlOwogICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gdGFyZ2V0WjsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc01pZGZpZWxkZXIpIHsKICAgICAgICAgICAgICAgIGlmIChwcmVzc3VyZSA+IDAuOCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNpZGUgPSAodGhpcy5tZXNoLnBvc2l0aW9uLnggPiBiYWxsUG9zLngpID8gMSA6IC0xOwogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueCA9IGJhbGxQb3MueCArIChzaWRlICogMTAuMCk7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gYmFsbFBvcy56IC0gKGF0dGFja0RpciAqIDIuMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1pZFogPSAoYmFsbFBvcy56ICsgZ29hbFopICogMC40NTsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSBtaWRaOwogICAgICAgICAgICAgICAgICAgIGlmIChiYWxsUG9zLnggPCAtNSkgX3RhcmdldFBvcy54ID0gNTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiYWxsUG9zLnggPiA1KSBfdGFyZ2V0UG9zLnggPSAtNTsKICAgICAgICAgICAgICAgICAgICBlbHNlIF90YXJnZXRQb3MueCA9ICh0aGlzLmhvbWVQb3NpdGlvbi54ID4gMCA/IDggOiAtOCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3Qgc2FmZXR5RGlzdCA9IDEyLjA7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSBiYWxsUG9zLnogLSAoYXR0YWNrRGlyICogc2FmZXR5RGlzdCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWFtLnNpZGUgPT09IDEpIF90YXJnZXRQb3MueiA9IE1hdGgubWluKDM4LCBfdGFyZ2V0UG9zLnopOwogICAgICAgICAgICAgICAgZWxzZSBfdGFyZ2V0UG9zLnogPSBNYXRoLm1heCgtMzgsIF90YXJnZXRQb3Mueik7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnggPSBiYWxsUG9zLnggKiAwLjYgKyB0aGlzLmhvbWVQb3NpdGlvbi54ICogMC40OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5faXNQYXRoQmxvY2tlZChfdGFyZ2V0UG9zLCBiYWxsUG9zKSkgewogICAgICAgICAgICAgICAgX3RlbXBWZWMxLmNvcHkoX3RhcmdldFBvcyk7IF90ZW1wVmVjMS54IC09IDguMDsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi5jb3B5KF90YXJnZXRQb3MpOyBfdGVtcFZlYzIueCArPSA4LjA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGJsb2NrZWRMID0gdGhpcy5faXNQYXRoQmxvY2tlZChfdGVtcFZlYzEsIGJhbGxQb3MpOwogICAgICAgICAgICAgICAgY29uc3QgYmxvY2tlZFIgPSB0aGlzLl9pc1BhdGhCbG9ja2VkKF90ZW1wVmVjMiwgYmFsbFBvcyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICghYmxvY2tlZEwgJiYgIWJsb2NrZWRSKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKF90YXJnZXRQb3MueCAtIF90ZW1wVmVjMS54KSA8IE1hdGguYWJzKF90YXJnZXRQb3MueCAtIF90ZW1wVmVjMi54KSkgewogICAgICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkoX3RlbXBWZWMxKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkoX3RlbXBWZWMyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFibG9ja2VkTCkgewogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzEpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghYmxvY2tlZFIpIHsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkoX3RlbXBWZWMyKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy5sZXJwKGJhbGxQb3MsIDAuNCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2F2b2lkVGVhbW1hdGVzKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICB9CgogICAgICAgIF9zdGF0ZURlZmVuZChkdCkgewogICAgICAgICAgICBjb25zdCB0YXJnZXRQb3MgPSB0aGlzLnBlcmNlaXZlZFRhcmdldFBvczsKICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldFBvcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgcHJlc3NSYW5nZSA9IHRoaXMuaXNEZWZlbmRlciA/IDEyLjAgOiA4LjA7CiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnRhY2tsZSAmJiB0aGlzLnN0YXRzLkhQID4gMjApIHsKICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgKz0gNS4wOyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV0IGFtSUNsb3Nlc3QgPSB0cnVlOwogICAgICAgICAgICBjb25zdCBteURpc3RTcSA9IGRpc3RUb0JhbGwgKiBkaXN0VG9CYWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgZm9yKGNvbnN0IG1hdGUgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcyB8fCAhbWF0ZS5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZS5yb2xlID09PSAnR0wnIHx8IG1hdGUuc3RhdHVzLm5hcCA+IDAgfHwgbWF0ZS5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBkU3EgPSBtYXRlLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUb1NxdWFyZWQodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZFNxIDwgbXlEaXN0U3EpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYW1JQ2xvc2VzdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhbUlDbG9zZXN0KSB7CiAgICAgICAgICAgICAgICBwcmVzc1JhbmdlID0gMTAwLjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9NeUdvYWwgPSBNYXRoLmFicyh0YXJnZXRQb3MueiAtICh0aGlzLnRlYW0uc2lkZSA9PT0gMSA/IDQ2IDogLTQ2KSk7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvTXlHb2FsIDwgNDAuMCkgewogICAgICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgPSAxNS4wOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwcmVzc1JhbmdlID0gOC4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoZGlzdFRvQmFsbCA8IHByZXNzUmFuZ2UpIHsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMy4wICYmICF0aGlzLmlzRGFzaGluZyAmJiB0aGlzLmN1cnJlbnRFTiA+IDUgJiYgTWF0aC5yYW5kb20oKSA8IDAuMDIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBfdGVtcFZlYzEuc3ViVmVjdG9ycyh0YXJnZXRQb3MsIHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlyLmFkZFNjYWxlZFZlY3Rvcih0aGlzLmJhbGxSZWYudmVsb2NpdHksIDAuMSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuZGFzaChkaXIueCwgZGlyLnopOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWFya2luZyAmJiB0aGlzLm1hcmtpbmcubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgbWFya1BvcyA9IHRoaXMubWFya2luZy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgbXlHb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyA0NiA6IC00NjsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5zZXQoMCwgMCwgbXlHb2FsWiAtIG1hcmtQb3Mueik7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkobWFya1BvcykuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjMSwgMy41KTsKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgX3RhcmdldFBvcy56ICs9IHRoaXMuYmFsbFJlZi5tZXNoLnBvc2l0aW9uLnogKiAwLjY7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5pc0RlZmVuZGVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBteUdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IDQ2IDogLTQ2OwogICAgICAgICAgICAgICAgY29uc3QgbWlkcG9pbnQgPSAodGhpcy5iYWxsUmVmLm1lc2gucG9zaXRpb24ueiArIG15R29hbFopICogMC41OwogICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gKF90YXJnZXRQb3MueiArIG1pZHBvaW50KSAqIDAuNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gTWF0aC5tYXgoLTQ0LjAsIE1hdGgubWluKDQ0LjAsIF90YXJnZXRQb3MueikpOwogICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICB9CgogICAgICAgIF9hdm9pZEdvYWxDcmVhc2UodGFyZ2V0UG9zKSB7CiAgICAgICAgICAgIGNvbnN0IGNyZWFzZVJhZGl1cyA9IDEwLjA7CiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gW3sgeDogMCwgejogLTQ2IH0sIHsgeDogMCwgejogNDYgfV07CgogICAgICAgICAgICBnb2Fscy5mb3JFYWNoKGdvYWwgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZHggPSB0YXJnZXRQb3MueCAtIGdvYWwueDsKICAgICAgICAgICAgICAgIGNvbnN0IGR6ID0gdGFyZ2V0UG9zLnogLSBnb2FsLno7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR6KmR6OwoKICAgICAgICAgICAgICAgIGlmIChkaXN0U3EgPCBjcmVhc2VSYWRpdXMgKiBjcmVhc2VSYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPiAwLjAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IGNyZWFzZVJhZGl1cyAvIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy54ID0gZ29hbC54ICsgZHggKiByYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnogPSBnb2FsLnogKyBkeiAqIHJhdGlvOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy56ID0gZ29hbC56ICsgKGdvYWwueiA+IDAgPyAtY3JlYXNlUmFkaXVzIDogY3JlYXNlUmFkaXVzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYXJlbmFSYWRpdXMgPSA0NS4wOwogICAgICAgICAgICBjb25zdCBkU3EgPSB0YXJnZXRQb3MueCAqIHRhcmdldFBvcy54ICsgdGFyZ2V0UG9zLnogKiB0YXJnZXRQb3MuejsKICAgICAgICAgICAgaWYgKGRTcSA+IGFyZW5hUmFkaXVzKmFyZW5hUmFkaXVzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkID0gTWF0aC5zcXJ0KGRTcSk7CiAgICAgICAgICAgICAgICBjb25zdCByID0gYXJlbmFSYWRpdXMgLyBkOwogICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnggKj0gcjsKICAgICAgICAgICAgICAgIHRhcmdldFBvcy56ICo9IHI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9maW5kQmVzdFBhc3NUYXJnZXQoKSB7CiAgICAgICAgICAgIGxldCBiZXN0VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IG1heFNjb3JlID0gLUluZmluaXR5OwogICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtNDYgOiA0NjsKCiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKG1hdGUgPT09IHRoaXMpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKCFtYXRlLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKG1hdGUuc3RhdHVzLm5hcCA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKG1hdGUuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhtYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA0LjApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPiAzMC4wKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2lzUGF0aEJsb2NrZWQobWF0ZS5tZXNoLnBvc2l0aW9uKSkgY29udGludWU7IAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgc2NvcmUgPSAwOwogICAgICAgICAgICAgICAgY29uc3QgbXlEaXN0VG9Hb2FsID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgICAgICBjb25zdCBtYXRlRGlzdFRvR29hbCA9IE1hdGguYWJzKG1hdGUubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBteURpc3RUb0dvYWwgLSBtYXRlRGlzdFRvR29hbDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2NvcmUgKz0gcHJvZ3Jlc3MgKiAxLjU7IAogICAgICAgICAgICAgICAgaWYgKG1hdGVEaXN0VG9Hb2FsIDwgMTUuMCkgc2NvcmUgKz0gMTAuMDsKICAgICAgICAgICAgICAgIGlmIChtYXRlRGlzdFRvR29hbCA8IDguMCkgc2NvcmUgKz0gMTUuMDsKCiAgICAgICAgICAgICAgICBjb25zdCBvcGVubmVzcyA9IHRoaXMuX2NhbGN1bGF0ZU9wZW5uZXNzKG1hdGUpOwogICAgICAgICAgICAgICAgc2NvcmUgKz0gb3Blbm5lc3MgKiAzLjA7CgogICAgICAgICAgICAgICAgaWYgKG1hdGUuaXNGb3J3YXJkKSBzY29yZSArPSA1LjA7CiAgICAgICAgICAgICAgICBzY29yZSAtPSBkaXN0ICogMC41OwoKICAgICAgICAgICAgICAgIGlmIChzY29yZSA+IG1heFNjb3JlKSB7CiAgICAgICAgICAgICAgICAgICAgbWF4U2NvcmUgPSBzY29yZTsKICAgICAgICAgICAgICAgICAgICBiZXN0VGFyZ2V0ID0gbWF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYmVzdFRhcmdldDsKICAgICAgICB9CgogICAgICAgIF9jYWxjdWxhdGVPcGVubmVzcyhwbGF5ZXIpIHsKICAgICAgICAgICAgbGV0IG1pbkRlZkRpc3QgPSA5OTk7CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZSkgcmV0dXJuIDA7CiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAodGhpcy50ZWFtLmlkID09PSAnaG9tZScpID8gZ2FtZS50ZWFtcy5hd2F5IDogZ2FtZS50ZWFtcy5ob21lOwoKICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9wcC5tZXNoIHx8IG9wcC5zdGF0dXMubmFwID4gMCB8fCBvcHAuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICBjb25zdCBkID0gcGxheWVyLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhvcHAubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZCA8IG1pbkRlZkRpc3QpIG1pbkRlZkRpc3QgPSBkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBNYXRoLm1pbihtaW5EZWZEaXN0LCA4LjApOwogICAgICAgIH0KCiAgICAgICAgX2lzUGF0aEJsb2NrZWQodGFyZ2V0UG9zLCBzdGFydFBvcyA9IG51bGwpIHsKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSBzdGFydFBvcyB8fCB0aGlzLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IGVuZCA9IHRhcmdldFBvczsKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHN0YXJ0LmRpc3RhbmNlVG8oZW5kKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIF9zY2FuRGlyLnN1YlZlY3RvcnMoZW5kLCBzdGFydCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9ICh0aGlzLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGNvbnN0IHNhZmV0eVJhZGl1cyA9IDIuNTsgCgogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2ggfHwgb3BwLnN0YXR1cy5uYXAgPiAwIHx8IG9wcC5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX3NjYW5Ub09wcC5zdWJWZWN0b3JzKG9wcC5tZXNoLnBvc2l0aW9uLCBzdGFydCk7CiAgICAgICAgICAgICAgICBjb25zdCBwcm9qZWN0aW9uID0gX3NjYW5Ub09wcC5kb3QoX3NjYW5EaXIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAocHJvamVjdGlvbiA+IDAgJiYgcHJvamVjdGlvbiA8IGRpc3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwZXJwRGlzdFNxID0gX3NjYW5Ub09wcC5sZW5ndGhTcSgpIC0gKHByb2plY3Rpb24gKiBwcm9qZWN0aW9uKTsKICAgICAgICAgICAgICAgICAgICBpZiAocGVycERpc3RTcSA8IChzYWZldHlSYWRpdXMgKiBzYWZldHlSYWRpdXMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBfbW92ZVRvKHRhcmdldCkgewogICAgICAgICAgICBfYWlWZWMuc3ViVmVjdG9ycyh0YXJnZXQsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIF9haVZlYy55ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IF9haVZlYy5sZW5ndGhTcSgpOwogICAgICAgICAgICBpZiAoZGlzdFNxID4gMS4wKSB7CiAgICAgICAgICAgICAgICBfYWlWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KF9haVZlYy54LCBfYWlWZWMueik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlJbnRlcmNlcHRpb25QcmVzc3VyZShkdCkgewogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5iYWxsUmVmOwogICAgICAgICAgICBpZiAoIWJhbGwgfHwgIWJhbGwubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKGJhbGwuc3RhdGUgIT09ICdmcmVlJyB8fCBiYWxsLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAxLjApIHJldHVybjsKICAgICAgICAgICAgaWYgKGJhbGwuaXNJbnZpc2libGUpIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSByZXR1cm47CgogICAgICAgICAgICBsZXQgcmFuZ2UgPSAyLjA7CiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnBhc3NpdmUgPT09ICdicmF3bGVyJyB8fCB0aGlzLnRlY2hzLnBhc3NpdmUgPT09ICdlbGl0ZV9kZWZlbnNlJykgewogICAgICAgICAgICAgICAgcmFuZ2UgKz0gMS41OwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgaWYgKGRpc3QgPiByYW5nZSkgcmV0dXJuOwoKICAgICAgICAgICAgX3NjYW5Ub09wcC5zdWJWZWN0b3JzKHRoaXMubWVzaC5wb3NpdGlvbiwgYmFsbC5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgX3RlbXBWZWMxLmNvcHkoYmFsbC52ZWxvY2l0eSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBoZWFkaW5nRG90ID0gX3RlbXBWZWMxLmRvdChfc2NhblRvT3BwKTsKICAgICAgICAgICAgaWYgKGhlYWRpbmdEb3QgPCAwLjcpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGRpc3RGYWN0b3IgPSBNYXRoLm1heCgwLCAxLjAgLSAoZGlzdCAvIHJhbmdlKSk7CiAgICAgICAgICAgIGNvbnN0IHByZXNzdXJlID0gMS41OwoKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBiYWxsLnBvd2VyIC09IHByZXNzdXJlOwogICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRCbG9jayA9ICh0aGlzLl9hY2N1bXVsYXRlZEJsb2NrIHx8IDApICsgcHJlc3N1cmU7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYWNjdW11bGF0ZWRCbG9jayA+PSA1LjApIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsID0gTWF0aC5mbG9vcih0aGlzLl9hY2N1bXVsYXRlZEJsb2NrKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZEJsb2NrIC09IHZhbDsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oYC0ke3ZhbH1gLCBiYWxsLm1lc2gucG9zaXRpb24sICJibG9jayIsIGJhbGwubWVzaCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IChkaXN0RmFjdG9yICogMC44KSkgeyAKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi5jb3B5KHRoaXMubWVzaC5wb3NpdGlvbikubGVycChiYWxsLm1lc2gucG9zaXRpb24sIDAuNSArIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yKTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzIueSArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLnogKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zcGF3bkNsYXNoKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNwYXduQ2xhc2goX3RlbXBWZWMyLCAwLjYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA8PSAwICYmIGJhbGwucG93ZXJUeXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICBiYWxsLnBvd2VyVHlwZSA9ICdub25lJzsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7IAogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLRUQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJhbGwudGVjaG5pcXVlICYmIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgdGhpcy50ZWNoSW1tdW5pdHlUaW1lciA9IDIuMDsKICAgICAgICAgICAgICAgIGNvbnN0IHRlY2ggPSBiYWxsLnRlY2huaXF1ZTsKICAgICAgICAgICAgICAgIGlmICh0ZWNoLnR5cGUgPT09ICd2ZW5vbScpIHRoaXMuYXBwbHlTdGF0dXMoJ3Zlbm9tJywgMTUuMCk7CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICduYXAnKSB0aGlzLmFwcGx5U3RhdHVzKCduYXAnLCA4LjApOwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaC50eXBlID09PSAnd2l0aGVyJykgdGhpcy5hcHBseVN0YXR1cygnd2l0aGVyJywgMTUuMCwgJ0JMJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jYWxjdWxhdGVQcmVzc3VyZU9uUGxheWVyKHBsYXllcikgewogICAgICAgICAgICBpZiAoIXBsYXllciB8fCAhcGxheWVyLm1lc2gpIHJldHVybiAwOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiAwOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9IChwbGF5ZXIudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgbGV0IHByZXNzdXJlID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCB8fCBvcHAuc3RhdHVzLm5hcCA+IDAgfHwgb3BwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHBsYXllci5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCAxMC4wKSB7CiAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKz0gKDEwLjAgLSBkaXN0KSAvIDEwLjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByZXNzdXJlOwogICAgICAgIH0KCiAgICAgICAgX2F2b2lkVGVhbW1hdGVzKHRhcmdldFBvcykgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSkgcmV0dXJuOwogICAgICAgICAgICBmb3IgKGNvbnN0IG1hdGUgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmIChtYXRlID09PSB0aGlzIHx8ICFtYXRlLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKG1hdGUuaGFzQmFsbCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0YXJnZXRQb3MuZGlzdGFuY2VUbyhtYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA1LjApIHsKICAgICAgICAgICAgICAgICAgICBfdGVtcFZlYzEuc3ViVmVjdG9ycyh0YXJnZXRQb3MsIG1hdGUubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLmFkZFNjYWxlZFZlY3RvcihfdGVtcFZlYzEsIDUuMCAtIGRpc3QpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkFJUGxheWVyID0gQUlQbGF5ZXI7Cn0pKCk7","./AIPlayer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzCiAgICBjb25zdCBfYWlWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3RhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhbkRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhblRvT3BwID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF90ZW1wVmVjMSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlYzIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEFJUGxheWVyIGV4dGVuZHMgd2luZG93LmZsdXguUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSkgewogICAgICAgICAgICBzdXBlcihzY2VuZSwgcm9sZSk7CiAgICAgICAgICAgIHRoaXMuYmFsbFJlZiA9IG51bGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGF0cyBhcmUgbWFuYWdlZCBieSBUZWFtL01haW4gb3IgZGVmYXVsdCBQbGF5ZXIgdmFsdWVzLgogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIC8vIFN0YXRlIE1hY2hpbmUKICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB0aGlzLmRlY2lzaW9uVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLmRlY2lzaW9uSW50ZXJ2YWwgPSAwLjU7IC8vIFNsb3dlciBkZWNpc2lvbnMKCiAgICAgICAgICAgIC8vIC0tLSBQRVJDRVBUSU9OIFNZU1RFTSAoUmVhY3Rpb24gVGltZSkgLS0tCiAgICAgICAgICAgIHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5yZWFjdGlvblNwZWVkID0gMS41OyAKICAgICAgICAgICAgdGhpcy5hbnRpY2lwYXRpb25UaW1lID0gMC4yOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJvbGUgQ29uZmlnCiAgICAgICAgICAgIHRoaXMuaXNGb3J3YXJkID0gWydMRicsICdSRiddLmluY2x1ZGVzKHJvbGUpOwogICAgICAgICAgICB0aGlzLmlzTWlkZmllbGRlciA9IHJvbGUgPT09ICdNRic7CiAgICAgICAgICAgIHRoaXMuaXNEZWZlbmRlciA9IFsnTEQnLCAnUkQnXS5pbmNsdWRlcyhyb2xlKTsKCiAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLl9hc3NpZ25EZWZhdWx0VGVjaHMoKTsKICAgICAgICB9CgogICAgICAgIF9hc3NpZ25EZWZhdWx0VGVjaHMoKSB7CiAgICAgICAgICAgIGNvbnN0IHRhY2tsZVRlY2hzID0gWyd2ZW5vbScsICd3aXRoZXInLCAnZHJhaW4nXTsKICAgICAgICAgICAgY29uc3Qgc2hvb3RUZWNocyA9IFsndmVub20nLCAnc3BoZXJlJywgJ2ludmlzaWJsZSddOwogICAgICAgICAgICBjb25zdCBwYXNzVGVjaHMgPSBbJ3Zlbm9tJywgJ3dpdGhlcicsICduYXAnXTsKICAgICAgICAgICAgY29uc3QgcGFzc2l2ZVRlY2hzID0gWydicmF3bGVyJywgJ2VsaXRlX2RlZmVuc2UnXTsKCiAgICAgICAgICAgIGNvbnN0IHBpY2sgPSAoYXJyKSA9PiBhcnJbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogYXJyLmxlbmd0aCldOwogICAgICAgICAgICBjb25zdCBjaGFuY2UgPSAocHJvYikgPT4gTWF0aC5yYW5kb20oKSA8IHByb2I7CgogICAgICAgICAgICBpZiAodGhpcy5pc0RlZmVuZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMykpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4yKSkgdGhpcy50ZWNocy5wYXNzaXZlID0gcGljayhwYXNzaXZlVGVjaHMpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNNaWRmaWVsZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy5zaG9vdCA9IHBpY2soc2hvb3RUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjMpKSB0aGlzLnRlY2hzLnNob290ID0gcGljayhzaG9vdFRlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy50YWNrbGUgPSBwaWNrKHRhY2tsZVRlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy5wYXNzaXZlID0gcGljayhwYXNzaXZlVGVjaHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgLy8gU2FmZXR5OiBBdXRvLWxpbmsgYmFsbCBpZiBtaXNzaW5nCiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFsbFJlZiA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBpc0RlbW8gPSBnYW1lICYmIGdhbWUuaXNEZW1vTW9kZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGlzSW5jYXBhY2l0YXRlZCA9ICh0aGlzLnN0dW5UaW1lciA+IDApIHx8ICh0aGlzLnN0YXR1cy5uYXAgPiAwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGlzSHVtYW5UZWFtID0gdGhpcy50ZWFtICYmIHRoaXMudGVhbS5pc0h1bWFuOwogICAgICAgICAgICBjb25zdCBpc0FjdGl2ZVBsYXllciA9IHRoaXMudGVhbSAmJiAodGhpcy50ZWFtLmFjdGl2ZVBsYXllciA9PT0gdGhpcyk7CiAgICAgICAgICAgIGNvbnN0IHNob3VsZFJ1bkFJID0gKCFpc0h1bWFuVGVhbSB8fCBpc0RlbW8gfHwgKGlzSHVtYW5UZWFtICYmICFpc0FjdGl2ZVBsYXllcikpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaXNUZWFtQUlFbmFibGVkID0gdGhpcy50ZWFtID8gdGhpcy50ZWFtLmFpRW5hYmxlZCA6IHRydWU7CgogICAgICAgICAgICBpZiAoaXNJbmNhcGFjaXRhdGVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHNob3VsZFJ1bkFJICYmIGlzVGVhbUFJRW5hYmxlZCkgewogICAgICAgICAgICAgICAgLy8gLS0tIFBFUkNFUFRJT04gVVBEQVRFIC0tLQogICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYubWVzaCkgewogICAgICAgICAgICAgICAgICAgIGxldCByZWFsVGFyZ2V0ID0gdGhpcy5iYWxsUmVmLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZi5ob2xkZXIgJiYgdGhpcy5iYWxsUmVmLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQgPSB0aGlzLmJhbGxSZWYuaG9sZGVyLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZi5ob2xkZXIudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQuYWRkU2NhbGVkVmVjdG9yKHRoaXMuYmFsbFJlZi5ob2xkZXIudmVsb2NpdHksIHRoaXMuYW50aWNpcGF0aW9uVGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYmFsbFJlZi52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgICAgICByZWFsVGFyZ2V0LmFkZFNjYWxlZFZlY3Rvcih0aGlzLmJhbGxSZWYudmVsb2NpdHksIHRoaXMuYW50aWNpcGF0aW9uVGltZSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbHBoYSA9IE1hdGgubWluKDEuMCwgZHQgKiB0aGlzLnJlYWN0aW9uU3BlZWQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zLmxlcnAocmVhbFRhcmdldCwgYWxwaGEpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDEuIERlY2lzaW9uIE1ha2luZwogICAgICAgICAgICAgICAgdGhpcy5kZWNpc2lvblRpbWVyICs9IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVjaXNpb25UaW1lciA+IHRoaXMuZGVjaXNpb25JbnRlcnZhbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZGVjaXNpb25UaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZXZhbHVhdGVTdGF0ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDIuIEV4ZWN1dGUgU3RhdGUKICAgICAgICAgICAgICAgIHRoaXMuX2V4ZWN1dGVTdGF0ZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDMuIEludGVyY2VwdGlvbiBMb2dpYwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaEltbXVuaXR5VGltZXIgPiAwKSB0aGlzLnRlY2hJbW11bml0eVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnRlcmNlcHRpb25QcmVzc3VyZShkdCk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQUkgRGlzYWJsZWQgb3IgSHVtYW4gQ29udHJvbGxlZAogICAgICAgICAgICAgICAgY29uc3QgaXNEcml2ZW5CeUh1bWFuID0gaXNIdW1hblRlYW0gJiYgaXNBY3RpdmVQbGF5ZXIgJiYgIWlzRGVtbzsKICAgICAgICAgICAgICAgIGlmICghaXNEcml2ZW5CeUh1bWFuKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIFBhc3NpdmUgaW50ZXJjZXB0aW9uIHN0aWxsIGFwcGxpZXMKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5SW50ZXJjZXB0aW9uUHJlc3N1cmUoZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA0LiBCYXNlIFVwZGF0ZQogICAgICAgICAgICBzdXBlci51cGRhdGUoZHQpOwogICAgICAgIH0KCiAgICAgICAgX2V2YWx1YXRlU3RhdGUoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnQVRUQUNLX0NBUlJZJzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFiYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ1JFVFVSTl9IT01FJzsKICAgICAgICAgICAgICAgIGNvbnN0IGJpYXMgPSAodGhpcy5haVN0YXRlID09PSAnQ0hBU0UnKSA/IDAuOCA6IDEuMDsKICAgICAgICAgICAgICAgIGNvbnN0IG15RGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbikgKiBiaWFzOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgaXNDbG9zZXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAgPT09IHRoaXMpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnJvbGUgPT09ICdHTCcpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29udGludWU7CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwRGlzdCA9IHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwRGlzdCA8IG15RGlzdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNDbG9zZXN0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoaXNDbG9zZXN0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0NIQVNFJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ1NVUFBPUlQnOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIudGVhbSAhPT0gdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnREVGRU5EJzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2V4ZWN1dGVTdGF0ZShkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMuYmFsbFJlZikgewogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3dpdGNoICh0aGlzLmFpU3RhdGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ0FUVEFDS19DQVJSWSc6IHRoaXMuX3N0YXRlQXR0YWNrQ2FycnkoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1NVUFBPUlQnOiB0aGlzLl9zdGF0ZVN1cHBvcnQoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0RFRkVORCc6IHRoaXMuX3N0YXRlRGVmZW5kKGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdDSEFTRSc6IHRoaXMuX3N0YXRlQ2hhc2UoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1JFVFVSTl9IT01FJzogCiAgICAgICAgICAgICAgICBkZWZhdWx0OiB0aGlzLl9zdGF0ZVJldHVybkhvbWUoZHQpOyBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3N0YXRlQXR0YWNrQ2FycnkoZHQpIHsKICAgICAgICAgICAgY29uc3QgYXR0YWNrRGlyID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKICAgICAgICAgICAgY29uc3QgZ29hbFogPSA0NiAqIGF0dGFja0RpcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIF90YXJnZXRQb3Muc2V0KDAsIDAsIGdvYWxaKTsKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CgogICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoZGlzdFRvR29hbCA8IDIwLjAgJiYgIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdTSCcpOyAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaXNTdXJyb3VuZGVkID0gdGhpcy5faXNTdXJyb3VuZGVkKCk7CiAgICAgICAgICAgIGNvbnN0IGxvd0VOID0gdGhpcy5jdXJyZW50RU4gPCAxMDsKICAgICAgICAgICAgY29uc3QgaXNQbGF5bWFrZXIgPSB0aGlzLmlzTWlkZmllbGRlcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICgoaXNTdXJyb3VuZGVkIHx8IGxvd0VOIHx8IGlzUGxheW1ha2VyKSAmJiAhdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiZXN0TWF0ZSA9IHRoaXMuX2ZpbmRCZXN0UGFzc1RhcmdldCgpOwogICAgICAgICAgICAgICAgaWYgKGJlc3RNYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHNob3VsZFBhc3MgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdXJyb3VuZGVkIHx8IGxvd0VOKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZFBhc3MgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNQbGF5bWFrZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbXlEaXN0ID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hdGVEaXN0ID0gTWF0aC5hYnMoYmVzdE1hdGUubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZURpc3QgPCBteURpc3QgLSA1LjApIHNob3VsZFBhc3MgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoc2hvdWxkUGFzcykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KGJlc3RNYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zbWFydFRocm93KHRoaXMuYmFsbFJlZiwgJ1BBJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChpc1N1cnJvdW5kZWQgJiYgIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdTSCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfaXNTdXJyb3VuZGVkKCkgewogICAgICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9ICh0aGlzLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IobGV0IHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocC5tZXNoICYmIHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRoaXMubWVzaC5wb3NpdGlvbikgPCA0LjApIHsKICAgICAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb3VudCA+PSAyOwogICAgICAgIH0KCiAgICAgICAgX3NtYXJ0VGhyb3coYmFsbCwgZm9yY2VkVHlwZSA9IG51bGwpIHsKICAgICAgICAgICAgbGV0IHR5cGUgPSBmb3JjZWRUeXBlOwogICAgICAgICAgICBpZiAoIXR5cGUpIHsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF0dGFja0RpciA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLTEgOiAxOwogICAgICAgICAgICAgICAgY29uc3QgaXNBaW1pbmdHb2FsID0gKF90ZW1wVmVjMS56ICogYXR0YWNrRGlyID4gMC41KTsKICAgICAgICAgICAgICAgIHR5cGUgPSBpc0FpbWluZ0dvYWwgPyAnU0gnIDogJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdGVjaE5hbWUgPSAodHlwZSA9PT0gJ1NIJykgPyB0aGlzLnRlY2hzLnNob290IDogdGhpcy50ZWNocy5wYXNzOwogICAgICAgICAgICBsZXQgYmFzZUNvc3QgPSAodHlwZSA9PT0gJ1NIJykgPyAyMCA6IDEwOwogICAgICAgICAgICBsZXQgdGVjaENvc3QgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodGVjaE5hbWUuaW5jbHVkZXMoJ25hcCcpKSB0ZWNoQ29zdCA9IDMwOwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaE5hbWUuaW5jbHVkZXMoJ3NwaGVyZScpIHx8IHRlY2hOYW1lLmluY2x1ZGVzKCdpbnZpc2libGUnKSkgdGVjaENvc3QgPSAyNTsKICAgICAgICAgICAgICAgIGVsc2UgdGVjaENvc3QgPSAyMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdG90YWxDb3N0ID0gYmFzZUNvc3QgKyB0ZWNoQ29zdDsKICAgICAgICAgICAgbGV0IHRlbXBUZWNoID0gbnVsbDsKICAgICAgICAgICAgaWYgKHRlY2hOYW1lICYmIHRoaXMuc3RhdHMuSFAgPCB0b3RhbENvc3QgJiYgdGhpcy5zdGF0cy5IUCA+PSBiYXNlQ29zdCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wVGVjaCA9IHRoaXMudGVjaHMuc2hvb3Q7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWNocy5zaG9vdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRlbXBUZWNoID0gdGhpcy50ZWNocy5wYXNzOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGVjaHMucGFzcyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudGhyb3dCYWxsKGJhbGwsIHR5cGUpOwoKICAgICAgICAgICAgaWYgKHRlbXBUZWNoKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgdGhpcy50ZWNocy5zaG9vdCA9IHRlbXBUZWNoOwogICAgICAgICAgICAgICAgZWxzZSB0aGlzLnRlY2hzLnBhc3MgPSB0ZW1wVGVjaDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3N0YXRlQ2hhc2UoZHQpIHsKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zKTsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKICAgICAgICAgICAgaWYgKGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDEuMCkgewogICAgICAgICAgICAgICAgX3RhcmdldFBvcy5hZGRTY2FsZWRWZWN0b3IoYmFsbC52ZWxvY2l0eSwgMC4zKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICB9CgogICAgICAgIF9zdGF0ZVJldHVybkhvbWUoZHQpIHsKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CiAgICAgICAgfQoKICAgICAgICBfc3RhdGVTdXBwb3J0KGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CiAgICAgICAgICAgIGNvbnN0IGNhcnJpZXIgPSBiYWxsLmhvbGRlcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghY2FycmllciB8fCAhY2Fycmllci5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdGF0ZVJldHVybkhvbWUoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBiYWxsUG9zID0gY2Fycmllci5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBhdHRhY2tEaXIgPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLTEgOiAxOwogICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtNDYgOiA0NjsKCiAgICAgICAgICAgIGNvbnN0IHByZXNzdXJlID0gdGhpcy5fY2FsY3VsYXRlUHJlc3N1cmVPblBsYXllcihjYXJyaWVyKTsKCiAgICAgICAgICAgIF90YXJnZXRQb3MuY29weSh0aGlzLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgIF90YXJnZXRQb3MueiArPSBiYWxsUG9zLnogKiAwLjY7CgogICAgICAgICAgICBpZiAodGhpcy5pc0ZvcndhcmQpIHsKICAgICAgICAgICAgICAgIGxldCB0YXJnZXRaID0gYmFsbFBvcy56ICsgKGF0dGFja0RpciAqIDE1LjApOyAKICAgICAgICAgICAgICAgIGlmIChwcmVzc3VyZSA+IDAuOCkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldFogPSBiYWxsUG9zLnogKyAoYXR0YWNrRGlyICogOC4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IHRpbWUgPSBEYXRlLm5vdygpICogMC4wMDE7CiAgICAgICAgICAgICAgICBjb25zdCB3ZWF2ZSA9IE1hdGguc2luKHRpbWUgKyB0aGlzLm1lc2guaWQpICogNi4wOwogICAgICAgICAgICAgICAgX3RhcmdldFBvcy54ID0gdGhpcy5ob21lUG9zaXRpb24ueCArIHdlYXZlOwogICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gdGFyZ2V0WjsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc01pZGZpZWxkZXIpIHsKICAgICAgICAgICAgICAgIGlmIChwcmVzc3VyZSA+IDAuOCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNpZGUgPSAodGhpcy5tZXNoLnBvc2l0aW9uLnggPiBiYWxsUG9zLngpID8gMSA6IC0xOwogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueCA9IGJhbGxQb3MueCArIChzaWRlICogMTAuMCk7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gYmFsbFBvcy56IC0gKGF0dGFja0RpciAqIDIuMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1pZFogPSAoYmFsbFBvcy56ICsgZ29hbFopICogMC40NTsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSBtaWRaOwogICAgICAgICAgICAgICAgICAgIGlmIChiYWxsUG9zLnggPCAtNSkgX3RhcmdldFBvcy54ID0gNTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiYWxsUG9zLnggPiA1KSBfdGFyZ2V0UG9zLnggPSAtNTsKICAgICAgICAgICAgICAgICAgICBlbHNlIF90YXJnZXRQb3MueCA9ICh0aGlzLmhvbWVQb3NpdGlvbi54ID4gMCA/IDggOiAtOCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3Qgc2FmZXR5RGlzdCA9IDEyLjA7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSBiYWxsUG9zLnogLSAoYXR0YWNrRGlyICogc2FmZXR5RGlzdCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWFtLnNpZGUgPT09IDEpIF90YXJnZXRQb3MueiA9IE1hdGgubWluKDM4LCBfdGFyZ2V0UG9zLnopOwogICAgICAgICAgICAgICAgZWxzZSBfdGFyZ2V0UG9zLnogPSBNYXRoLm1heCgtMzgsIF90YXJnZXRQb3Mueik7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnggPSBiYWxsUG9zLnggKiAwLjYgKyB0aGlzLmhvbWVQb3NpdGlvbi54ICogMC40OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5faXNQYXRoQmxvY2tlZChfdGFyZ2V0UG9zLCBiYWxsUG9zKSkgewogICAgICAgICAgICAgICAgX3RlbXBWZWMxLmNvcHkoX3RhcmdldFBvcyk7IF90ZW1wVmVjMS54IC09IDguMDsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi5jb3B5KF90YXJnZXRQb3MpOyBfdGVtcFZlYzIueCArPSA4LjA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGJsb2NrZWRMID0gdGhpcy5faXNQYXRoQmxvY2tlZChfdGVtcFZlYzEsIGJhbGxQb3MpOwogICAgICAgICAgICAgICAgY29uc3QgYmxvY2tlZFIgPSB0aGlzLl9pc1BhdGhCbG9ja2VkKF90ZW1wVmVjMiwgYmFsbFBvcyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICghYmxvY2tlZEwgJiYgIWJsb2NrZWRSKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKF90YXJnZXRQb3MueCAtIF90ZW1wVmVjMS54KSA8IE1hdGguYWJzKF90YXJnZXRQb3MueCAtIF90ZW1wVmVjMi54KSkgewogICAgICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkoX3RlbXBWZWMxKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkoX3RlbXBWZWMyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFibG9ja2VkTCkgewogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzEpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghYmxvY2tlZFIpIHsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkoX3RlbXBWZWMyKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy5sZXJwKGJhbGxQb3MsIDAuNCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2F2b2lkVGVhbW1hdGVzKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICB9CgogICAgICAgIF9zdGF0ZURlZmVuZChkdCkgewogICAgICAgICAgICBjb25zdCB0YXJnZXRQb3MgPSB0aGlzLnBlcmNlaXZlZFRhcmdldFBvczsKICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldFBvcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgcHJlc3NSYW5nZSA9IHRoaXMuaXNEZWZlbmRlciA/IDEyLjAgOiA4LjA7CiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnRhY2tsZSAmJiB0aGlzLnN0YXRzLkhQID4gMjApIHsKICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgKz0gNS4wOyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV0IGFtSUNsb3Nlc3QgPSB0cnVlOwogICAgICAgICAgICBjb25zdCBteURpc3RTcSA9IGRpc3RUb0JhbGwgKiBkaXN0VG9CYWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgZm9yKGNvbnN0IG1hdGUgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcyB8fCAhbWF0ZS5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZS5yb2xlID09PSAnR0wnIHx8IG1hdGUuc3RhdHVzLm5hcCA+IDAgfHwgbWF0ZS5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBkU3EgPSBtYXRlLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUb1NxdWFyZWQodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZFNxIDwgbXlEaXN0U3EpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYW1JQ2xvc2VzdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhbUlDbG9zZXN0KSB7CiAgICAgICAgICAgICAgICBwcmVzc1JhbmdlID0gMTAwLjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9NeUdvYWwgPSBNYXRoLmFicyh0YXJnZXRQb3MueiAtICh0aGlzLnRlYW0uc2lkZSA9PT0gMSA/IDQ2IDogLTQ2KSk7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvTXlHb2FsIDwgNDAuMCkgewogICAgICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgPSAxNS4wOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwcmVzc1JhbmdlID0gOC4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoZGlzdFRvQmFsbCA8IHByZXNzUmFuZ2UpIHsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMy4wICYmICF0aGlzLmlzRGFzaGluZyAmJiB0aGlzLmN1cnJlbnRFTiA+IDUgJiYgTWF0aC5yYW5kb20oKSA8IDAuMDIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBfdGVtcFZlYzEuc3ViVmVjdG9ycyh0YXJnZXRQb3MsIHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlyLmFkZFNjYWxlZFZlY3Rvcih0aGlzLmJhbGxSZWYudmVsb2NpdHksIDAuMSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuZGFzaChkaXIueCwgZGlyLnopOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWFya2luZyAmJiB0aGlzLm1hcmtpbmcubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgbWFya1BvcyA9IHRoaXMubWFya2luZy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgbXlHb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyA0NiA6IC00NjsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5zZXQoMCwgMCwgbXlHb2FsWiAtIG1hcmtQb3Mueik7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkobWFya1BvcykuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjMSwgMy41KTsKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgX3RhcmdldFBvcy56ICs9IHRoaXMuYmFsbFJlZi5tZXNoLnBvc2l0aW9uLnogKiAwLjY7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5pc0RlZmVuZGVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBteUdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IDQ2IDogLTQ2OwogICAgICAgICAgICAgICAgY29uc3QgbWlkcG9pbnQgPSAodGhpcy5iYWxsUmVmLm1lc2gucG9zaXRpb24ueiArIG15R29hbFopICogMC41OwogICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gKF90YXJnZXRQb3MueiArIG1pZHBvaW50KSAqIDAuNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gTWF0aC5tYXgoLTQ0LjAsIE1hdGgubWluKDQ0LjAsIF90YXJnZXRQb3MueikpOwogICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICB9CgogICAgICAgIF9hdm9pZEdvYWxDcmVhc2UodGFyZ2V0UG9zKSB7CiAgICAgICAgICAgIGNvbnN0IGNyZWFzZVJhZGl1cyA9IDEwLjA7CiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gW3sgeDogMCwgejogLTQ2IH0sIHsgeDogMCwgejogNDYgfV07CgogICAgICAgICAgICBnb2Fscy5mb3JFYWNoKGdvYWwgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZHggPSB0YXJnZXRQb3MueCAtIGdvYWwueDsKICAgICAgICAgICAgICAgIGNvbnN0IGR6ID0gdGFyZ2V0UG9zLnogLSBnb2FsLno7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR6KmR6OwoKICAgICAgICAgICAgICAgIGlmIChkaXN0U3EgPCBjcmVhc2VSYWRpdXMgKiBjcmVhc2VSYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPiAwLjAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IGNyZWFzZVJhZGl1cyAvIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy54ID0gZ29hbC54ICsgZHggKiByYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnogPSBnb2FsLnogKyBkeiAqIHJhdGlvOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy56ID0gZ29hbC56ICsgKGdvYWwueiA+IDAgPyAtY3JlYXNlUmFkaXVzIDogY3JlYXNlUmFkaXVzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYXJlbmFSYWRpdXMgPSA0NS4wOwogICAgICAgICAgICBjb25zdCBkU3EgPSB0YXJnZXRQb3MueCAqIHRhcmdldFBvcy54ICsgdGFyZ2V0UG9zLnogKiB0YXJnZXRQb3MuejsKICAgICAgICAgICAgaWYgKGRTcSA+IGFyZW5hUmFkaXVzKmFyZW5hUmFkaXVzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkID0gTWF0aC5zcXJ0KGRTcSk7CiAgICAgICAgICAgICAgICBjb25zdCByID0gYXJlbmFSYWRpdXMgLyBkOwogICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnggKj0gcjsKICAgICAgICAgICAgICAgIHRhcmdldFBvcy56ICo9IHI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9maW5kQmVzdFBhc3NUYXJnZXQoKSB7CiAgICAgICAgICAgIGxldCBiZXN0VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IG1heFNjb3JlID0gLUluZmluaXR5OwogICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtNDYgOiA0NjsKCiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKG1hdGUgPT09IHRoaXMpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKCFtYXRlLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKG1hdGUuc3RhdHVzLm5hcCA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKG1hdGUuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhtYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA0LjApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPiAzMC4wKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2lzUGF0aEJsb2NrZWQobWF0ZS5tZXNoLnBvc2l0aW9uKSkgY29udGludWU7IAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgc2NvcmUgPSAwOwogICAgICAgICAgICAgICAgY29uc3QgbXlEaXN0VG9Hb2FsID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgICAgICBjb25zdCBtYXRlRGlzdFRvR29hbCA9IE1hdGguYWJzKG1hdGUubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBteURpc3RUb0dvYWwgLSBtYXRlRGlzdFRvR29hbDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2NvcmUgKz0gcHJvZ3Jlc3MgKiAxLjU7IAogICAgICAgICAgICAgICAgaWYgKG1hdGVEaXN0VG9Hb2FsIDwgMTUuMCkgc2NvcmUgKz0gMTAuMDsKICAgICAgICAgICAgICAgIGlmIChtYXRlRGlzdFRvR29hbCA8IDguMCkgc2NvcmUgKz0gMTUuMDsKCiAgICAgICAgICAgICAgICBjb25zdCBvcGVubmVzcyA9IHRoaXMuX2NhbGN1bGF0ZU9wZW5uZXNzKG1hdGUpOwogICAgICAgICAgICAgICAgc2NvcmUgKz0gb3Blbm5lc3MgKiAzLjA7CgogICAgICAgICAgICAgICAgaWYgKG1hdGUuaXNGb3J3YXJkKSBzY29yZSArPSA1LjA7CiAgICAgICAgICAgICAgICBzY29yZSAtPSBkaXN0ICogMC41OwoKICAgICAgICAgICAgICAgIGlmIChzY29yZSA+IG1heFNjb3JlKSB7CiAgICAgICAgICAgICAgICAgICAgbWF4U2NvcmUgPSBzY29yZTsKICAgICAgICAgICAgICAgICAgICBiZXN0VGFyZ2V0ID0gbWF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYmVzdFRhcmdldDsKICAgICAgICB9CgogICAgICAgIF9jYWxjdWxhdGVPcGVubmVzcyhwbGF5ZXIpIHsKICAgICAgICAgICAgbGV0IG1pbkRlZkRpc3QgPSA5OTk7CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZSkgcmV0dXJuIDA7CiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAodGhpcy50ZWFtLmlkID09PSAnaG9tZScpID8gZ2FtZS50ZWFtcy5hd2F5IDogZ2FtZS50ZWFtcy5ob21lOwoKICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9wcC5tZXNoIHx8IG9wcC5zdGF0dXMubmFwID4gMCB8fCBvcHAuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICBjb25zdCBkID0gcGxheWVyLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhvcHAubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZCA8IG1pbkRlZkRpc3QpIG1pbkRlZkRpc3QgPSBkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBNYXRoLm1pbihtaW5EZWZEaXN0LCA4LjApOwogICAgICAgIH0KCiAgICAgICAgX2lzUGF0aEJsb2NrZWQodGFyZ2V0UG9zLCBzdGFydFBvcyA9IG51bGwpIHsKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSBzdGFydFBvcyB8fCB0aGlzLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IGVuZCA9IHRhcmdldFBvczsKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHN0YXJ0LmRpc3RhbmNlVG8oZW5kKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIF9zY2FuRGlyLnN1YlZlY3RvcnMoZW5kLCBzdGFydCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9ICh0aGlzLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGNvbnN0IHNhZmV0eVJhZGl1cyA9IDIuNTsgCgogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2ggfHwgb3BwLnN0YXR1cy5uYXAgPiAwIHx8IG9wcC5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX3NjYW5Ub09wcC5zdWJWZWN0b3JzKG9wcC5tZXNoLnBvc2l0aW9uLCBzdGFydCk7CiAgICAgICAgICAgICAgICBjb25zdCBwcm9qZWN0aW9uID0gX3NjYW5Ub09wcC5kb3QoX3NjYW5EaXIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAocHJvamVjdGlvbiA+IDAgJiYgcHJvamVjdGlvbiA8IGRpc3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwZXJwRGlzdFNxID0gX3NjYW5Ub09wcC5sZW5ndGhTcSgpIC0gKHByb2plY3Rpb24gKiBwcm9qZWN0aW9uKTsKICAgICAgICAgICAgICAgICAgICBpZiAocGVycERpc3RTcSA8IChzYWZldHlSYWRpdXMgKiBzYWZldHlSYWRpdXMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBfbW92ZVRvKHRhcmdldCkgewogICAgICAgICAgICBfYWlWZWMuc3ViVmVjdG9ycyh0YXJnZXQsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIF9haVZlYy55ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IF9haVZlYy5sZW5ndGhTcSgpOwogICAgICAgICAgICBpZiAoZGlzdFNxID4gMS4wKSB7CiAgICAgICAgICAgICAgICBfYWlWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KF9haVZlYy54LCBfYWlWZWMueik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlJbnRlcmNlcHRpb25QcmVzc3VyZShkdCkgewogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5iYWxsUmVmOwogICAgICAgICAgICBpZiAoIWJhbGwgfHwgIWJhbGwubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKGJhbGwuc3RhdGUgIT09ICdmcmVlJyB8fCBiYWxsLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAxLjApIHJldHVybjsKICAgICAgICAgICAgaWYgKGJhbGwuaXNJbnZpc2libGUpIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSByZXR1cm47CgogICAgICAgICAgICBsZXQgcmFuZ2UgPSAyLjA7CiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnBhc3NpdmUgPT09ICdicmF3bGVyJyB8fCB0aGlzLnRlY2hzLnBhc3NpdmUgPT09ICdlbGl0ZV9kZWZlbnNlJykgewogICAgICAgICAgICAgICAgcmFuZ2UgKz0gMS41OwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgaWYgKGRpc3QgPiByYW5nZSkgcmV0dXJuOwoKICAgICAgICAgICAgX3NjYW5Ub09wcC5zdWJWZWN0b3JzKHRoaXMubWVzaC5wb3NpdGlvbiwgYmFsbC5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgX3RlbXBWZWMxLmNvcHkoYmFsbC52ZWxvY2l0eSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBoZWFkaW5nRG90ID0gX3RlbXBWZWMxLmRvdChfc2NhblRvT3BwKTsKICAgICAgICAgICAgaWYgKGhlYWRpbmdEb3QgPCAwLjcpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGRpc3RGYWN0b3IgPSBNYXRoLm1heCgwLCAxLjAgLSAoZGlzdCAvIHJhbmdlKSk7CiAgICAgICAgICAgIGNvbnN0IHByZXNzdXJlID0gMS41OwoKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBiYWxsLnBvd2VyIC09IHByZXNzdXJlOwogICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRCbG9jayA9ICh0aGlzLl9hY2N1bXVsYXRlZEJsb2NrIHx8IDApICsgcHJlc3N1cmU7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYWNjdW11bGF0ZWRCbG9jayA+PSA1LjApIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsID0gTWF0aC5mbG9vcih0aGlzLl9hY2N1bXVsYXRlZEJsb2NrKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZEJsb2NrIC09IHZhbDsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oYC0ke3ZhbH1gLCBiYWxsLm1lc2gucG9zaXRpb24sICJibG9jayIsIGJhbGwubWVzaCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IChkaXN0RmFjdG9yICogMC44KSkgeyAKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi5jb3B5KHRoaXMubWVzaC5wb3NpdGlvbikubGVycChiYWxsLm1lc2gucG9zaXRpb24sIDAuNSArIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yKTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzIueSArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLnogKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zcGF3bkNsYXNoKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNwYXduQ2xhc2goX3RlbXBWZWMyLCAwLjYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA8PSAwICYmIGJhbGwucG93ZXJUeXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICBiYWxsLnBvd2VyVHlwZSA9ICdub25lJzsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7IAogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLRUQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJhbGwudGVjaG5pcXVlICYmIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgdGhpcy50ZWNoSW1tdW5pdHlUaW1lciA9IDIuMDsKICAgICAgICAgICAgICAgIGNvbnN0IHRlY2ggPSBiYWxsLnRlY2huaXF1ZTsKICAgICAgICAgICAgICAgIGlmICh0ZWNoLnR5cGUgPT09ICd2ZW5vbScpIHRoaXMuYXBwbHlTdGF0dXMoJ3Zlbm9tJywgMTUuMCk7CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICduYXAnKSB0aGlzLmFwcGx5U3RhdHVzKCduYXAnLCA4LjApOwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaC50eXBlID09PSAnd2l0aGVyJykgdGhpcy5hcHBseVN0YXR1cygnd2l0aGVyJywgMTUuMCwgJ0JMJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jYWxjdWxhdGVQcmVzc3VyZU9uUGxheWVyKHBsYXllcikgewogICAgICAgICAgICBpZiAoIXBsYXllciB8fCAhcGxheWVyLm1lc2gpIHJldHVybiAwOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiAwOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9IChwbGF5ZXIudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgbGV0IHByZXNzdXJlID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCB8fCBvcHAuc3RhdHVzLm5hcCA+IDAgfHwgb3BwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHBsYXllci5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCAxMC4wKSB7CiAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKz0gKDEwLjAgLSBkaXN0KSAvIDEwLjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByZXNzdXJlOwogICAgICAgIH0KCiAgICAgICAgX2F2b2lkVGVhbW1hdGVzKHRhcmdldFBvcykgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSkgcmV0dXJuOwogICAgICAgICAgICBmb3IgKGNvbnN0IG1hdGUgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmIChtYXRlID09PSB0aGlzIHx8ICFtYXRlLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKG1hdGUuaGFzQmFsbCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0YXJnZXRQb3MuZGlzdGFuY2VUbyhtYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA1LjApIHsKICAgICAgICAgICAgICAgICAgICBfdGVtcFZlYzEuc3ViVmVjdG9ycyh0YXJnZXRQb3MsIG1hdGUubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLmFkZFNjYWxlZFZlY3RvcihfdGVtcFZlYzEsIDUuMCAtIGRpc3QpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkFJUGxheWVyID0gQUlQbGF5ZXI7Cn0pKCk7","/AIPlayer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzCiAgICBjb25zdCBfYWlWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3RhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhbkRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhblRvT3BwID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF90ZW1wVmVjMSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlYzIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEFJUGxheWVyIGV4dGVuZHMgd2luZG93LmZsdXguUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSkgewogICAgICAgICAgICBzdXBlcihzY2VuZSwgcm9sZSk7CiAgICAgICAgICAgIHRoaXMuYmFsbFJlZiA9IG51bGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGF0cyBhcmUgbWFuYWdlZCBieSBUZWFtL01haW4gb3IgZGVmYXVsdCBQbGF5ZXIgdmFsdWVzLgogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIC8vIFN0YXRlIE1hY2hpbmUKICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB0aGlzLmRlY2lzaW9uVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLmRlY2lzaW9uSW50ZXJ2YWwgPSAwLjU7IC8vIFNsb3dlciBkZWNpc2lvbnMKCiAgICAgICAgICAgIC8vIC0tLSBQRVJDRVBUSU9OIFNZU1RFTSAoUmVhY3Rpb24gVGltZSkgLS0tCiAgICAgICAgICAgIHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5yZWFjdGlvblNwZWVkID0gMS41OyAKICAgICAgICAgICAgdGhpcy5hbnRpY2lwYXRpb25UaW1lID0gMC4yOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJvbGUgQ29uZmlnCiAgICAgICAgICAgIHRoaXMuaXNGb3J3YXJkID0gWydMRicsICdSRiddLmluY2x1ZGVzKHJvbGUpOwogICAgICAgICAgICB0aGlzLmlzTWlkZmllbGRlciA9IHJvbGUgPT09ICdNRic7CiAgICAgICAgICAgIHRoaXMuaXNEZWZlbmRlciA9IFsnTEQnLCAnUkQnXS5pbmNsdWRlcyhyb2xlKTsKCiAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLl9hc3NpZ25EZWZhdWx0VGVjaHMoKTsKICAgICAgICB9CgogICAgICAgIF9hc3NpZ25EZWZhdWx0VGVjaHMoKSB7CiAgICAgICAgICAgIGNvbnN0IHRhY2tsZVRlY2hzID0gWyd2ZW5vbScsICd3aXRoZXInLCAnZHJhaW4nXTsKICAgICAgICAgICAgY29uc3Qgc2hvb3RUZWNocyA9IFsndmVub20nLCAnc3BoZXJlJywgJ2ludmlzaWJsZSddOwogICAgICAgICAgICBjb25zdCBwYXNzVGVjaHMgPSBbJ3Zlbm9tJywgJ3dpdGhlcicsICduYXAnXTsKICAgICAgICAgICAgY29uc3QgcGFzc2l2ZVRlY2hzID0gWydicmF3bGVyJywgJ2VsaXRlX2RlZmVuc2UnXTsKCiAgICAgICAgICAgIGNvbnN0IHBpY2sgPSAoYXJyKSA9PiBhcnJbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogYXJyLmxlbmd0aCldOwogICAgICAgICAgICBjb25zdCBjaGFuY2UgPSAocHJvYikgPT4gTWF0aC5yYW5kb20oKSA8IHByb2I7CgogICAgICAgICAgICBpZiAodGhpcy5pc0RlZmVuZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMykpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4yKSkgdGhpcy50ZWNocy5wYXNzaXZlID0gcGljayhwYXNzaXZlVGVjaHMpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNNaWRmaWVsZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy5zaG9vdCA9IHBpY2soc2hvb3RUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjMpKSB0aGlzLnRlY2hzLnNob290ID0gcGljayhzaG9vdFRlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy50YWNrbGUgPSBwaWNrKHRhY2tsZVRlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy5wYXNzaXZlID0gcGljayhwYXNzaXZlVGVjaHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgLy8gU2FmZXR5OiBBdXRvLWxpbmsgYmFsbCBpZiBtaXNzaW5nCiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFsbFJlZiA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBjb25zdCBpc0RlbW8gPSBnYW1lICYmIGdhbWUuaXNEZW1vTW9kZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGlzSW5jYXBhY2l0YXRlZCA9ICh0aGlzLnN0dW5UaW1lciA+IDApIHx8ICh0aGlzLnN0YXR1cy5uYXAgPiAwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGlzSHVtYW5UZWFtID0gdGhpcy50ZWFtICYmIHRoaXMudGVhbS5pc0h1bWFuOwogICAgICAgICAgICBjb25zdCBpc0FjdGl2ZVBsYXllciA9IHRoaXMudGVhbSAmJiAodGhpcy50ZWFtLmFjdGl2ZVBsYXllciA9PT0gdGhpcyk7CiAgICAgICAgICAgIGNvbnN0IHNob3VsZFJ1bkFJID0gKCFpc0h1bWFuVGVhbSB8fCBpc0RlbW8gfHwgKGlzSHVtYW5UZWFtICYmICFpc0FjdGl2ZVBsYXllcikpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaXNUZWFtQUlFbmFibGVkID0gdGhpcy50ZWFtID8gdGhpcy50ZWFtLmFpRW5hYmxlZCA6IHRydWU7CgogICAgICAgICAgICBpZiAoaXNJbmNhcGFjaXRhdGVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHNob3VsZFJ1bkFJICYmIGlzVGVhbUFJRW5hYmxlZCkgewogICAgICAgICAgICAgICAgLy8gLS0tIFBFUkNFUFRJT04gVVBEQVRFIC0tLQogICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYubWVzaCkgewogICAgICAgICAgICAgICAgICAgIGxldCByZWFsVGFyZ2V0ID0gdGhpcy5iYWxsUmVmLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZi5ob2xkZXIgJiYgdGhpcy5iYWxsUmVmLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQgPSB0aGlzLmJhbGxSZWYuaG9sZGVyLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZi5ob2xkZXIudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQuYWRkU2NhbGVkVmVjdG9yKHRoaXMuYmFsbFJlZi5ob2xkZXIudmVsb2NpdHksIHRoaXMuYW50aWNpcGF0aW9uVGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYmFsbFJlZi52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgICAgICByZWFsVGFyZ2V0LmFkZFNjYWxlZFZlY3Rvcih0aGlzLmJhbGxSZWYudmVsb2NpdHksIHRoaXMuYW50aWNpcGF0aW9uVGltZSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbHBoYSA9IE1hdGgubWluKDEuMCwgZHQgKiB0aGlzLnJlYWN0aW9uU3BlZWQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zLmxlcnAocmVhbFRhcmdldCwgYWxwaGEpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDEuIERlY2lzaW9uIE1ha2luZwogICAgICAgICAgICAgICAgdGhpcy5kZWNpc2lvblRpbWVyICs9IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVjaXNpb25UaW1lciA+IHRoaXMuZGVjaXNpb25JbnRlcnZhbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZGVjaXNpb25UaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZXZhbHVhdGVTdGF0ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDIuIEV4ZWN1dGUgU3RhdGUKICAgICAgICAgICAgICAgIHRoaXMuX2V4ZWN1dGVTdGF0ZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDMuIEludGVyY2VwdGlvbiBMb2dpYwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaEltbXVuaXR5VGltZXIgPiAwKSB0aGlzLnRlY2hJbW11bml0eVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnRlcmNlcHRpb25QcmVzc3VyZShkdCk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQUkgRGlzYWJsZWQgb3IgSHVtYW4gQ29udHJvbGxlZAogICAgICAgICAgICAgICAgY29uc3QgaXNEcml2ZW5CeUh1bWFuID0gaXNIdW1hblRlYW0gJiYgaXNBY3RpdmVQbGF5ZXIgJiYgIWlzRGVtbzsKICAgICAgICAgICAgICAgIGlmICghaXNEcml2ZW5CeUh1bWFuKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIFBhc3NpdmUgaW50ZXJjZXB0aW9uIHN0aWxsIGFwcGxpZXMKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5SW50ZXJjZXB0aW9uUHJlc3N1cmUoZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA0LiBCYXNlIFVwZGF0ZQogICAgICAgICAgICBzdXBlci51cGRhdGUoZHQpOwogICAgICAgIH0KCiAgICAgICAgX2V2YWx1YXRlU3RhdGUoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CgogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnQVRUQUNLX0NBUlJZJzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFiYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ1JFVFVSTl9IT01FJzsKICAgICAgICAgICAgICAgIGNvbnN0IGJpYXMgPSAodGhpcy5haVN0YXRlID09PSAnQ0hBU0UnKSA/IDAuOCA6IDEuMDsKICAgICAgICAgICAgICAgIGNvbnN0IG15RGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbikgKiBiaWFzOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgaXNDbG9zZXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAgPT09IHRoaXMpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnJvbGUgPT09ICdHTCcpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29udGludWU7CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwRGlzdCA9IHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwRGlzdCA8IG15RGlzdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNDbG9zZXN0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoaXNDbG9zZXN0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0NIQVNFJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ1NVUFBPUlQnOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIudGVhbSAhPT0gdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnREVGRU5EJzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2V4ZWN1dGVTdGF0ZShkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMuYmFsbFJlZikgewogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3dpdGNoICh0aGlzLmFpU3RhdGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ0FUVEFDS19DQVJSWSc6IHRoaXMuX3N0YXRlQXR0YWNrQ2FycnkoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1NVUFBPUlQnOiB0aGlzLl9zdGF0ZVN1cHBvcnQoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0RFRkVORCc6IHRoaXMuX3N0YXRlRGVmZW5kKGR0KTsgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdDSEFTRSc6IHRoaXMuX3N0YXRlQ2hhc2UoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ1JFVFVSTl9IT01FJzogCiAgICAgICAgICAgICAgICBkZWZhdWx0OiB0aGlzLl9zdGF0ZVJldHVybkhvbWUoZHQpOyBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3N0YXRlQXR0YWNrQ2FycnkoZHQpIHsKICAgICAgICAgICAgY29uc3QgYXR0YWNrRGlyID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC0xIDogMTsKICAgICAgICAgICAgY29uc3QgZ29hbFogPSA0NiAqIGF0dGFja0RpcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIF90YXJnZXRQb3Muc2V0KDAsIDAsIGdvYWxaKTsKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CgogICAgICAgICAgICBjb25zdCBkaXN0VG9Hb2FsID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoZGlzdFRvR29hbCA8IDIwLjAgJiYgIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdTSCcpOyAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaXNTdXJyb3VuZGVkID0gdGhpcy5faXNTdXJyb3VuZGVkKCk7CiAgICAgICAgICAgIGNvbnN0IGxvd0VOID0gdGhpcy5jdXJyZW50RU4gPCAxMDsKICAgICAgICAgICAgY29uc3QgaXNQbGF5bWFrZXIgPSB0aGlzLmlzTWlkZmllbGRlcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICgoaXNTdXJyb3VuZGVkIHx8IGxvd0VOIHx8IGlzUGxheW1ha2VyKSAmJiAhdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiZXN0TWF0ZSA9IHRoaXMuX2ZpbmRCZXN0UGFzc1RhcmdldCgpOwogICAgICAgICAgICAgICAgaWYgKGJlc3RNYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHNob3VsZFBhc3MgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdXJyb3VuZGVkIHx8IGxvd0VOKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZFBhc3MgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNQbGF5bWFrZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbXlEaXN0ID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hdGVEaXN0ID0gTWF0aC5hYnMoYmVzdE1hdGUubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZURpc3QgPCBteURpc3QgLSA1LjApIHNob3VsZFBhc3MgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoc2hvdWxkUGFzcykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KGJlc3RNYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zbWFydFRocm93KHRoaXMuYmFsbFJlZiwgJ1BBJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChpc1N1cnJvdW5kZWQgJiYgIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgdGhpcy5fc21hcnRUaHJvdyh0aGlzLmJhbGxSZWYsICdTSCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfaXNTdXJyb3VuZGVkKCkgewogICAgICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9ICh0aGlzLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IobGV0IHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocC5tZXNoICYmIHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRoaXMubWVzaC5wb3NpdGlvbikgPCA0LjApIHsKICAgICAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb3VudCA+PSAyOwogICAgICAgIH0KCiAgICAgICAgX3NtYXJ0VGhyb3coYmFsbCwgZm9yY2VkVHlwZSA9IG51bGwpIHsKICAgICAgICAgICAgbGV0IHR5cGUgPSBmb3JjZWRUeXBlOwogICAgICAgICAgICBpZiAoIXR5cGUpIHsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIGNvbnN0IGF0dGFja0RpciA9ICh0aGlzLnRlYW0gJiYgdGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLTEgOiAxOwogICAgICAgICAgICAgICAgY29uc3QgaXNBaW1pbmdHb2FsID0gKF90ZW1wVmVjMS56ICogYXR0YWNrRGlyID4gMC41KTsKICAgICAgICAgICAgICAgIHR5cGUgPSBpc0FpbWluZ0dvYWwgPyAnU0gnIDogJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdGVjaE5hbWUgPSAodHlwZSA9PT0gJ1NIJykgPyB0aGlzLnRlY2hzLnNob290IDogdGhpcy50ZWNocy5wYXNzOwogICAgICAgICAgICBsZXQgYmFzZUNvc3QgPSAodHlwZSA9PT0gJ1NIJykgPyAyMCA6IDEwOwogICAgICAgICAgICBsZXQgdGVjaENvc3QgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodGVjaE5hbWUuaW5jbHVkZXMoJ25hcCcpKSB0ZWNoQ29zdCA9IDMwOwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaE5hbWUuaW5jbHVkZXMoJ3NwaGVyZScpIHx8IHRlY2hOYW1lLmluY2x1ZGVzKCdpbnZpc2libGUnKSkgdGVjaENvc3QgPSAyNTsKICAgICAgICAgICAgICAgIGVsc2UgdGVjaENvc3QgPSAyMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdG90YWxDb3N0ID0gYmFzZUNvc3QgKyB0ZWNoQ29zdDsKICAgICAgICAgICAgbGV0IHRlbXBUZWNoID0gbnVsbDsKICAgICAgICAgICAgaWYgKHRlY2hOYW1lICYmIHRoaXMuc3RhdHMuSFAgPCB0b3RhbENvc3QgJiYgdGhpcy5zdGF0cy5IUCA+PSBiYXNlQ29zdCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wVGVjaCA9IHRoaXMudGVjaHMuc2hvb3Q7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWNocy5zaG9vdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRlbXBUZWNoID0gdGhpcy50ZWNocy5wYXNzOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGVjaHMucGFzcyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudGhyb3dCYWxsKGJhbGwsIHR5cGUpOwoKICAgICAgICAgICAgaWYgKHRlbXBUZWNoKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgdGhpcy50ZWNocy5zaG9vdCA9IHRlbXBUZWNoOwogICAgICAgICAgICAgICAgZWxzZSB0aGlzLnRlY2hzLnBhc3MgPSB0ZW1wVGVjaDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3N0YXRlQ2hhc2UoZHQpIHsKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zKTsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKICAgICAgICAgICAgaWYgKGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDEuMCkgewogICAgICAgICAgICAgICAgX3RhcmdldFBvcy5hZGRTY2FsZWRWZWN0b3IoYmFsbC52ZWxvY2l0eSwgMC4zKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICB9CgogICAgICAgIF9zdGF0ZVJldHVybkhvbWUoZHQpIHsKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CiAgICAgICAgfQoKICAgICAgICBfc3RhdGVTdXBwb3J0KGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmJhbGxSZWY7CiAgICAgICAgICAgIGNvbnN0IGNhcnJpZXIgPSBiYWxsLmhvbGRlcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghY2FycmllciB8fCAhY2Fycmllci5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdGF0ZVJldHVybkhvbWUoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBiYWxsUG9zID0gY2Fycmllci5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBhdHRhY2tEaXIgPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLTEgOiAxOwogICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtNDYgOiA0NjsKCiAgICAgICAgICAgIGNvbnN0IHByZXNzdXJlID0gdGhpcy5fY2FsY3VsYXRlUHJlc3N1cmVPblBsYXllcihjYXJyaWVyKTsKCiAgICAgICAgICAgIF90YXJnZXRQb3MuY29weSh0aGlzLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgIF90YXJnZXRQb3MueiArPSBiYWxsUG9zLnogKiAwLjY7CgogICAgICAgICAgICBpZiAodGhpcy5pc0ZvcndhcmQpIHsKICAgICAgICAgICAgICAgIGxldCB0YXJnZXRaID0gYmFsbFBvcy56ICsgKGF0dGFja0RpciAqIDE1LjApOyAKICAgICAgICAgICAgICAgIGlmIChwcmVzc3VyZSA+IDAuOCkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldFogPSBiYWxsUG9zLnogKyAoYXR0YWNrRGlyICogOC4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IHRpbWUgPSBEYXRlLm5vdygpICogMC4wMDE7CiAgICAgICAgICAgICAgICBjb25zdCB3ZWF2ZSA9IE1hdGguc2luKHRpbWUgKyB0aGlzLm1lc2guaWQpICogNi4wOwogICAgICAgICAgICAgICAgX3RhcmdldFBvcy54ID0gdGhpcy5ob21lUG9zaXRpb24ueCArIHdlYXZlOwogICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gdGFyZ2V0WjsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc01pZGZpZWxkZXIpIHsKICAgICAgICAgICAgICAgIGlmIChwcmVzc3VyZSA+IDAuOCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNpZGUgPSAodGhpcy5tZXNoLnBvc2l0aW9uLnggPiBiYWxsUG9zLngpID8gMSA6IC0xOwogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueCA9IGJhbGxQb3MueCArIChzaWRlICogMTAuMCk7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gYmFsbFBvcy56IC0gKGF0dGFja0RpciAqIDIuMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1pZFogPSAoYmFsbFBvcy56ICsgZ29hbFopICogMC40NTsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSBtaWRaOwogICAgICAgICAgICAgICAgICAgIGlmIChiYWxsUG9zLnggPCAtNSkgX3RhcmdldFBvcy54ID0gNTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiYWxsUG9zLnggPiA1KSBfdGFyZ2V0UG9zLnggPSAtNTsKICAgICAgICAgICAgICAgICAgICBlbHNlIF90YXJnZXRQb3MueCA9ICh0aGlzLmhvbWVQb3NpdGlvbi54ID4gMCA/IDggOiAtOCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3Qgc2FmZXR5RGlzdCA9IDEyLjA7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSBiYWxsUG9zLnogLSAoYXR0YWNrRGlyICogc2FmZXR5RGlzdCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWFtLnNpZGUgPT09IDEpIF90YXJnZXRQb3MueiA9IE1hdGgubWluKDM4LCBfdGFyZ2V0UG9zLnopOwogICAgICAgICAgICAgICAgZWxzZSBfdGFyZ2V0UG9zLnogPSBNYXRoLm1heCgtMzgsIF90YXJnZXRQb3Mueik7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnggPSBiYWxsUG9zLnggKiAwLjYgKyB0aGlzLmhvbWVQb3NpdGlvbi54ICogMC40OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5faXNQYXRoQmxvY2tlZChfdGFyZ2V0UG9zLCBiYWxsUG9zKSkgewogICAgICAgICAgICAgICAgX3RlbXBWZWMxLmNvcHkoX3RhcmdldFBvcyk7IF90ZW1wVmVjMS54IC09IDguMDsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi5jb3B5KF90YXJnZXRQb3MpOyBfdGVtcFZlYzIueCArPSA4LjA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGJsb2NrZWRMID0gdGhpcy5faXNQYXRoQmxvY2tlZChfdGVtcFZlYzEsIGJhbGxQb3MpOwogICAgICAgICAgICAgICAgY29uc3QgYmxvY2tlZFIgPSB0aGlzLl9pc1BhdGhCbG9ja2VkKF90ZW1wVmVjMiwgYmFsbFBvcyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICghYmxvY2tlZEwgJiYgIWJsb2NrZWRSKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKF90YXJnZXRQb3MueCAtIF90ZW1wVmVjMS54KSA8IE1hdGguYWJzKF90YXJnZXRQb3MueCAtIF90ZW1wVmVjMi54KSkgewogICAgICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkoX3RlbXBWZWMxKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkoX3RlbXBWZWMyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFibG9ja2VkTCkgewogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzEpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghYmxvY2tlZFIpIHsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkoX3RlbXBWZWMyKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy5sZXJwKGJhbGxQb3MsIDAuNCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2F2b2lkVGVhbW1hdGVzKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICB9CgogICAgICAgIF9zdGF0ZURlZmVuZChkdCkgewogICAgICAgICAgICBjb25zdCB0YXJnZXRQb3MgPSB0aGlzLnBlcmNlaXZlZFRhcmdldFBvczsKICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldFBvcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgcHJlc3NSYW5nZSA9IHRoaXMuaXNEZWZlbmRlciA/IDEyLjAgOiA4LjA7CiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnRhY2tsZSAmJiB0aGlzLnN0YXRzLkhQID4gMjApIHsKICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgKz0gNS4wOyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV0IGFtSUNsb3Nlc3QgPSB0cnVlOwogICAgICAgICAgICBjb25zdCBteURpc3RTcSA9IGRpc3RUb0JhbGwgKiBkaXN0VG9CYWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgZm9yKGNvbnN0IG1hdGUgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcyB8fCAhbWF0ZS5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZS5yb2xlID09PSAnR0wnIHx8IG1hdGUuc3RhdHVzLm5hcCA+IDAgfHwgbWF0ZS5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBkU3EgPSBtYXRlLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUb1NxdWFyZWQodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZFNxIDwgbXlEaXN0U3EpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYW1JQ2xvc2VzdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhbUlDbG9zZXN0KSB7CiAgICAgICAgICAgICAgICBwcmVzc1JhbmdlID0gMTAwLjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9NeUdvYWwgPSBNYXRoLmFicyh0YXJnZXRQb3MueiAtICh0aGlzLnRlYW0uc2lkZSA9PT0gMSA/IDQ2IDogLTQ2KSk7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvTXlHb2FsIDwgNDAuMCkgewogICAgICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgPSAxNS4wOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwcmVzc1JhbmdlID0gOC4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoZGlzdFRvQmFsbCA8IHByZXNzUmFuZ2UpIHsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMy4wICYmICF0aGlzLmlzRGFzaGluZyAmJiB0aGlzLmN1cnJlbnRFTiA+IDUgJiYgTWF0aC5yYW5kb20oKSA8IDAuMDIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBfdGVtcFZlYzEuc3ViVmVjdG9ycyh0YXJnZXRQb3MsIHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlyLmFkZFNjYWxlZFZlY3Rvcih0aGlzLmJhbGxSZWYudmVsb2NpdHksIDAuMSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuZGFzaChkaXIueCwgZGlyLnopOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWFya2luZyAmJiB0aGlzLm1hcmtpbmcubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgbWFya1BvcyA9IHRoaXMubWFya2luZy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgbXlHb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyA0NiA6IC00NjsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5zZXQoMCwgMCwgbXlHb2FsWiAtIG1hcmtQb3Mueik7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkobWFya1BvcykuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjMSwgMy41KTsKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgX3RhcmdldFBvcy56ICs9IHRoaXMuYmFsbFJlZi5tZXNoLnBvc2l0aW9uLnogKiAwLjY7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5pc0RlZmVuZGVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBteUdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IDQ2IDogLTQ2OwogICAgICAgICAgICAgICAgY29uc3QgbWlkcG9pbnQgPSAodGhpcy5iYWxsUmVmLm1lc2gucG9zaXRpb24ueiArIG15R29hbFopICogMC41OwogICAgICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gKF90YXJnZXRQb3MueiArIG1pZHBvaW50KSAqIDAuNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gTWF0aC5tYXgoLTQ0LjAsIE1hdGgubWluKDQ0LjAsIF90YXJnZXRQb3MueikpOwogICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICB9CgogICAgICAgIF9hdm9pZEdvYWxDcmVhc2UodGFyZ2V0UG9zKSB7CiAgICAgICAgICAgIGNvbnN0IGNyZWFzZVJhZGl1cyA9IDEwLjA7CiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gW3sgeDogMCwgejogLTQ2IH0sIHsgeDogMCwgejogNDYgfV07CgogICAgICAgICAgICBnb2Fscy5mb3JFYWNoKGdvYWwgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZHggPSB0YXJnZXRQb3MueCAtIGdvYWwueDsKICAgICAgICAgICAgICAgIGNvbnN0IGR6ID0gdGFyZ2V0UG9zLnogLSBnb2FsLno7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR6KmR6OwoKICAgICAgICAgICAgICAgIGlmIChkaXN0U3EgPCBjcmVhc2VSYWRpdXMgKiBjcmVhc2VSYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3QgPiAwLjAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IGNyZWFzZVJhZGl1cyAvIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy54ID0gZ29hbC54ICsgZHggKiByYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnogPSBnb2FsLnogKyBkeiAqIHJhdGlvOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy56ID0gZ29hbC56ICsgKGdvYWwueiA+IDAgPyAtY3JlYXNlUmFkaXVzIDogY3JlYXNlUmFkaXVzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYXJlbmFSYWRpdXMgPSA0NS4wOwogICAgICAgICAgICBjb25zdCBkU3EgPSB0YXJnZXRQb3MueCAqIHRhcmdldFBvcy54ICsgdGFyZ2V0UG9zLnogKiB0YXJnZXRQb3MuejsKICAgICAgICAgICAgaWYgKGRTcSA+IGFyZW5hUmFkaXVzKmFyZW5hUmFkaXVzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkID0gTWF0aC5zcXJ0KGRTcSk7CiAgICAgICAgICAgICAgICBjb25zdCByID0gYXJlbmFSYWRpdXMgLyBkOwogICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnggKj0gcjsKICAgICAgICAgICAgICAgIHRhcmdldFBvcy56ICo9IHI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9maW5kQmVzdFBhc3NUYXJnZXQoKSB7CiAgICAgICAgICAgIGxldCBiZXN0VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IG1heFNjb3JlID0gLUluZmluaXR5OwogICAgICAgICAgICBjb25zdCBnb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtNDYgOiA0NjsKCiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKG1hdGUgPT09IHRoaXMpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKCFtYXRlLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKG1hdGUuc3RhdHVzLm5hcCA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKG1hdGUuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhtYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA0LjApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPiAzMC4wKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2lzUGF0aEJsb2NrZWQobWF0ZS5tZXNoLnBvc2l0aW9uKSkgY29udGludWU7IAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgc2NvcmUgPSAwOwogICAgICAgICAgICAgICAgY29uc3QgbXlEaXN0VG9Hb2FsID0gTWF0aC5hYnModGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgICAgICBjb25zdCBtYXRlRGlzdFRvR29hbCA9IE1hdGguYWJzKG1hdGUubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBteURpc3RUb0dvYWwgLSBtYXRlRGlzdFRvR29hbDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2NvcmUgKz0gcHJvZ3Jlc3MgKiAxLjU7IAogICAgICAgICAgICAgICAgaWYgKG1hdGVEaXN0VG9Hb2FsIDwgMTUuMCkgc2NvcmUgKz0gMTAuMDsKICAgICAgICAgICAgICAgIGlmIChtYXRlRGlzdFRvR29hbCA8IDguMCkgc2NvcmUgKz0gMTUuMDsKCiAgICAgICAgICAgICAgICBjb25zdCBvcGVubmVzcyA9IHRoaXMuX2NhbGN1bGF0ZU9wZW5uZXNzKG1hdGUpOwogICAgICAgICAgICAgICAgc2NvcmUgKz0gb3Blbm5lc3MgKiAzLjA7CgogICAgICAgICAgICAgICAgaWYgKG1hdGUuaXNGb3J3YXJkKSBzY29yZSArPSA1LjA7CiAgICAgICAgICAgICAgICBzY29yZSAtPSBkaXN0ICogMC41OwoKICAgICAgICAgICAgICAgIGlmIChzY29yZSA+IG1heFNjb3JlKSB7CiAgICAgICAgICAgICAgICAgICAgbWF4U2NvcmUgPSBzY29yZTsKICAgICAgICAgICAgICAgICAgICBiZXN0VGFyZ2V0ID0gbWF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYmVzdFRhcmdldDsKICAgICAgICB9CgogICAgICAgIF9jYWxjdWxhdGVPcGVubmVzcyhwbGF5ZXIpIHsKICAgICAgICAgICAgbGV0IG1pbkRlZkRpc3QgPSA5OTk7CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZSkgcmV0dXJuIDA7CiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAodGhpcy50ZWFtLmlkID09PSAnaG9tZScpID8gZ2FtZS50ZWFtcy5hd2F5IDogZ2FtZS50ZWFtcy5ob21lOwoKICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9wcC5tZXNoIHx8IG9wcC5zdGF0dXMubmFwID4gMCB8fCBvcHAuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICBjb25zdCBkID0gcGxheWVyLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhvcHAubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZCA8IG1pbkRlZkRpc3QpIG1pbkRlZkRpc3QgPSBkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBNYXRoLm1pbihtaW5EZWZEaXN0LCA4LjApOwogICAgICAgIH0KCiAgICAgICAgX2lzUGF0aEJsb2NrZWQodGFyZ2V0UG9zLCBzdGFydFBvcyA9IG51bGwpIHsKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSBzdGFydFBvcyB8fCB0aGlzLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IGVuZCA9IHRhcmdldFBvczsKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHN0YXJ0LmRpc3RhbmNlVG8oZW5kKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIF9zY2FuRGlyLnN1YlZlY3RvcnMoZW5kLCBzdGFydCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9ICh0aGlzLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGNvbnN0IHNhZmV0eVJhZGl1cyA9IDIuNTsgCgogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2ggfHwgb3BwLnN0YXR1cy5uYXAgPiAwIHx8IG9wcC5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX3NjYW5Ub09wcC5zdWJWZWN0b3JzKG9wcC5tZXNoLnBvc2l0aW9uLCBzdGFydCk7CiAgICAgICAgICAgICAgICBjb25zdCBwcm9qZWN0aW9uID0gX3NjYW5Ub09wcC5kb3QoX3NjYW5EaXIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAocHJvamVjdGlvbiA+IDAgJiYgcHJvamVjdGlvbiA8IGRpc3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwZXJwRGlzdFNxID0gX3NjYW5Ub09wcC5sZW5ndGhTcSgpIC0gKHByb2plY3Rpb24gKiBwcm9qZWN0aW9uKTsKICAgICAgICAgICAgICAgICAgICBpZiAocGVycERpc3RTcSA8IChzYWZldHlSYWRpdXMgKiBzYWZldHlSYWRpdXMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBfbW92ZVRvKHRhcmdldCkgewogICAgICAgICAgICBfYWlWZWMuc3ViVmVjdG9ycyh0YXJnZXQsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIF9haVZlYy55ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRpc3RTcSA9IF9haVZlYy5sZW5ndGhTcSgpOwogICAgICAgICAgICBpZiAoZGlzdFNxID4gMS4wKSB7CiAgICAgICAgICAgICAgICBfYWlWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KF9haVZlYy54LCBfYWlWZWMueik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlJbnRlcmNlcHRpb25QcmVzc3VyZShkdCkgewogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5iYWxsUmVmOwogICAgICAgICAgICBpZiAoIWJhbGwgfHwgIWJhbGwubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKGJhbGwuc3RhdGUgIT09ICdmcmVlJyB8fCBiYWxsLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAxLjApIHJldHVybjsKICAgICAgICAgICAgaWYgKGJhbGwuaXNJbnZpc2libGUpIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSByZXR1cm47CgogICAgICAgICAgICBsZXQgcmFuZ2UgPSAyLjA7CiAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnBhc3NpdmUgPT09ICdicmF3bGVyJyB8fCB0aGlzLnRlY2hzLnBhc3NpdmUgPT09ICdlbGl0ZV9kZWZlbnNlJykgewogICAgICAgICAgICAgICAgcmFuZ2UgKz0gMS41OwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgaWYgKGRpc3QgPiByYW5nZSkgcmV0dXJuOwoKICAgICAgICAgICAgX3NjYW5Ub09wcC5zdWJWZWN0b3JzKHRoaXMubWVzaC5wb3NpdGlvbiwgYmFsbC5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgX3RlbXBWZWMxLmNvcHkoYmFsbC52ZWxvY2l0eSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBoZWFkaW5nRG90ID0gX3RlbXBWZWMxLmRvdChfc2NhblRvT3BwKTsKICAgICAgICAgICAgaWYgKGhlYWRpbmdEb3QgPCAwLjcpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGRpc3RGYWN0b3IgPSBNYXRoLm1heCgwLCAxLjAgLSAoZGlzdCAvIHJhbmdlKSk7CiAgICAgICAgICAgIGNvbnN0IHByZXNzdXJlID0gMS41OwoKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBiYWxsLnBvd2VyIC09IHByZXNzdXJlOwogICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRCbG9jayA9ICh0aGlzLl9hY2N1bXVsYXRlZEJsb2NrIHx8IDApICsgcHJlc3N1cmU7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYWNjdW11bGF0ZWRCbG9jayA+PSA1LjApIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsID0gTWF0aC5mbG9vcih0aGlzLl9hY2N1bXVsYXRlZEJsb2NrKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZEJsb2NrIC09IHZhbDsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oYC0ke3ZhbH1gLCBiYWxsLm1lc2gucG9zaXRpb24sICJibG9jayIsIGJhbGwubWVzaCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IChkaXN0RmFjdG9yICogMC44KSkgeyAKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi5jb3B5KHRoaXMubWVzaC5wb3NpdGlvbikubGVycChiYWxsLm1lc2gucG9zaXRpb24sIDAuNSArIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yKTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzIueSArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLnogKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zcGF3bkNsYXNoKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNwYXduQ2xhc2goX3RlbXBWZWMyLCAwLjYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA8PSAwICYmIGJhbGwucG93ZXJUeXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICBiYWxsLnBvd2VyVHlwZSA9ICdub25lJzsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7IAogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLRUQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJhbGwudGVjaG5pcXVlICYmIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgdGhpcy50ZWNoSW1tdW5pdHlUaW1lciA9IDIuMDsKICAgICAgICAgICAgICAgIGNvbnN0IHRlY2ggPSBiYWxsLnRlY2huaXF1ZTsKICAgICAgICAgICAgICAgIGlmICh0ZWNoLnR5cGUgPT09ICd2ZW5vbScpIHRoaXMuYXBwbHlTdGF0dXMoJ3Zlbm9tJywgMTUuMCk7CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICduYXAnKSB0aGlzLmFwcGx5U3RhdHVzKCduYXAnLCA4LjApOwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaC50eXBlID09PSAnd2l0aGVyJykgdGhpcy5hcHBseVN0YXR1cygnd2l0aGVyJywgMTUuMCwgJ0JMJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jYWxjdWxhdGVQcmVzc3VyZU9uUGxheWVyKHBsYXllcikgewogICAgICAgICAgICBpZiAoIXBsYXllciB8fCAhcGxheWVyLm1lc2gpIHJldHVybiAwOwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiAwOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3Qgb3BwVGVhbSA9IChwbGF5ZXIudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgbGV0IHByZXNzdXJlID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCB8fCBvcHAuc3RhdHVzLm5hcCA+IDAgfHwgb3BwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHBsYXllci5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCAxMC4wKSB7CiAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKz0gKDEwLjAgLSBkaXN0KSAvIDEwLjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByZXNzdXJlOwogICAgICAgIH0KCiAgICAgICAgX2F2b2lkVGVhbW1hdGVzKHRhcmdldFBvcykgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSkgcmV0dXJuOwogICAgICAgICAgICBmb3IgKGNvbnN0IG1hdGUgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmIChtYXRlID09PSB0aGlzIHx8ICFtYXRlLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKG1hdGUuaGFzQmFsbCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0YXJnZXRQb3MuZGlzdGFuY2VUbyhtYXRlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCA1LjApIHsKICAgICAgICAgICAgICAgICAgICBfdGVtcFZlYzEuc3ViVmVjdG9ycyh0YXJnZXRQb3MsIG1hdGUubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLmFkZFNjYWxlZFZlY3RvcihfdGVtcFZlYzEsIDUuMCAtIGRpc3QpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkFJUGxheWVyID0gQUlQbGF5ZXI7Cn0pKCk7","Team.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIEZvcm1hdGlvbiBEZWZpbml0aW9ucyAoQ29vcmRpbmF0ZXMgZm9yIFNpZGUgMTogRGVmZW5kcyArWiwgQXR0YWNrcyAtWikKICAgIC8vIFg6IExlZnQoLSkvUmlnaHQoKyksIFo6IEZvcndhcmQoLSkvQmFjaygrKQogICAgY29uc3QgRk9STUFUSU9OUyA9IHsKICAgICAgICAnTm9ybWFsJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiA1IH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTEwLCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxMCwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdDZW50ZXIgQXR0YWNrJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAwIH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTQsIHo6IC0xNSB9LCAnUkYnOiB7IHg6IDQsIHo6IC0xNSB9CiAgICAgICAgfSwKICAgICAgICAnUmlnaHQgU2lkZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IDAsIHo6IDE1IH0sICdSRCc6IHsgeDogMTIsIHo6IDE1IH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiA1LCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxNSwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdMZWZ0IFNpZGUnOiB7CiAgICAgICAgICAgICdHTCc6IHsgeDogMCwgejogMjUgfSwKICAgICAgICAgICAgJ0xEJzogeyB4OiAtMTIsIHo6IDE1IH0sICdSRCc6IHsgeDogMCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAtMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTUsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IC01LCB6OiAtMTAgfQogICAgICAgIH0sCiAgICAgICAgJ0FsbC1PdXQgRGVmZW5zZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IC02LCB6OiAyMCB9LCAnUkQnOiB7IHg6IDYsIHo6IDIwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMTAgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTAsIHo6IDUgfSwgJ1JGJzogeyB4OiAxMCwgejogNSB9CiAgICAgICAgfSwKICAgICAgICAnRmxhdCBMaW5lJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDAgfSwgJ1JEJzogeyB4OiA4LCB6OiAwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMCB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xNSwgejogMCB9LCAnUkYnOiB7IHg6IDE1LCB6OiAwIH0KICAgICAgICB9LAogICAgICAgICdDb3VudGVyJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDIwIH0sICdSRCc6IHsgeDogOCwgejogMjAgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAxNSB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xMiwgejogLTIwIH0sICdSRic6IHsgeDogMTIsIHo6IC0yMCB9CiAgICAgICAgfSwKICAgICAgICAnRG91YmxlIFNpZGVzJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTE4LCB6OiAxNSB9LCAnUkQnOiB7IHg6IDE4LCB6OiAxNSB9LAogICAgICAgICAgICAnTUYnOiB7IHg6IDAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTgsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IDE4LCB6OiAtMTAgfQogICAgICAgIH0KICAgIH07CgoKCiAgICAvLyAtLS0gRW5lbXkgSW5kaWNhdG9yIChSZWQgQXJyb3cgU3ByaXRlKSAtLS0KICAgIC8vIFNoYXJlZCB0ZXh0dXJlL21hdGVyaWFsIHNvIHdlIGRvbid0IGNyZWF0ZSA2IGNhbnZhc2VzLgpjb25zdCBfZW5lbXlBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7CiAgICAgICAgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBjLndpZHRoLCBjLmhlaWdodCk7CiAgICAgICAgCiAgICAgICAgLy8gQXJyb3cgcG9pbnRpbmcgRE9XTgogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDYsIDEyKTsgICAKICAgICAgICBjdHgubGluZVRvKDU4LCAxMik7ICAKICAgICAgICBjdHgubGluZVRvKDMyLCA1Mik7ICAKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmYwMDAwJzsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpJzsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCmNvbnN0IF9wbGF5ZXJBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgYy53aWR0aCwgYy5oZWlnaHQpOwogICAgICAgIAogICAgICAgIC8vIEFycm93IHBvaW50aW5nIERPV04KICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyg2LCAxMik7ICAgCiAgICAgICAgY3R4LmxpbmVUbyg1OCwgMTIpOyAgCiAgICAgICAgY3R4LmxpbmVUbygzMiwgNTIpOyAgCiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwZmYwMCc7IC8vIEdyZWVuCiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsMjU1LDI1NSwwLjk1KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGMud2lkdGgsIGMuaGVpZ2h0KTsKICAgICAgICAKICAgICAgICAvLyBBcnJvdyBwb2ludGluZyBET1dOCiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oNiwgMTIpOyAgIAogICAgICAgIGN0eC5saW5lVG8oNTgsIDEyKTsgIAogICAgICAgIGN0eC5saW5lVG8oMzIsIDUyKTsgIAogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOyAvLyBXaGl0ZQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX2VuZW15QXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2VuZW15QXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CiAgICBjb25zdCBfcGxheWVyQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3BsYXllckFycm93VGV4dHVyZSwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoVGVzdDogZmFsc2UsIGRlcHRoV3JpdGU6IGZhbHNlIH0pOwogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3RlYW1tYXRlQXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CmNsYXNzIFRlYW0gewogICAgICAgIC8qKgogICAgICAgICAqIEdlbmVyYXRlcyBhbmQgYXBwbGllcyBzdGF0cyB0byBhIHBsYXllciBiYXNlZCBvbiByb2xlIGFuZCBsZXZlbC4KICAgICAgICAgKiBDZW50cmFsaXplcyBiYWxhbmNpbmcgdG8gZW5zdXJlIGhpZ2gtbGV2ZWwgcGxheSBmZWVscyBkaXN0aW5jdC4KICAgICAgICAgKi8KICAgICAgICBzdGF0aWMgZ2VuZXJhdGVTdGF0cyhwbGF5ZXIsIHJvbGUsIGxldmVsID0gMSwgaXNIdW1hbiA9IGZhbHNlKSB7CiAgICAgICAgICAgIC8vIDEuIERlZmluZSBSb2xlIEJhc2VsaW5lcyAoTGV2ZWwgMSkKICAgICAgICAgICAgLy8gQmFsYW5jZWQgdG8gYmUgd2VhayBidXQgZnVuY3Rpb25hbCBhdCBMZXZlbCAxCiAgICAgICAgICAgIGNvbnN0IGJhc2UgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLCBTUDogNTUsIEVOOiAxMCwgQVQ6IDUsIFBBOiA1LCBCTDogNSwgU0g6IDUsIENBOiA1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBSb2xlIFNwZWNpYWxpemF0aW9ucwogICAgICAgICAgICBzd2l0Y2gocm9sZSkgewogICAgICAgICAgICAgICAgY2FzZSAnTEYnOiBjYXNlICdSRic6IC8vIFN0cmlrZXJzCiAgICAgICAgICAgICAgICAgICAgYmFzZS5TSCArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLkVOICs9IDU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdNRic6IC8vIFBsYXltYWtlcnMKICAgICAgICAgICAgICAgICAgICBiYXNlLlBBICs9IDEwOyBiYXNlLkFUICs9IDg7IGJhc2UuRU4gKz0gODsgYmFzZS5TUCArPSAyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnTEQnOiBjYXNlICdSRCc6IC8vIERlZmVuZGVycwogICAgICAgICAgICAgICAgICAgIGJhc2UuQVQgKz0gMTI7IGJhc2UuQkwgKz0gMTA7IGJhc2UuUEEgKz0gNTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogLy8gR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFzZS5DQSArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLlBBICs9IDE1OyAvLyBTdHJvbmcgYXJtCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFNjYWxpbmcgRmFjdG9ycyAoUGVyIExldmVsKQogICAgICAgICAgICAvLyBEZXNpZ25lZCBzbyBMZXZlbCA1MCBpcyAiR29kIFRpZXIiIGFuZCBMZXZlbCAxIGlzICJSb29raWUiCiAgICAgICAgICAgIGNvbnN0IGdyb3d0aCA9IHsKICAgICAgICAgICAgICAgIEhQOiAxNSwgICAgLy8gKzE1MDAgSFAgYXQgTHZsIDk5CiAgICAgICAgICAgICAgICBTUDogMC41LCAgIC8vICs1MCBTUCBhdCBMdmwgOTkgKFNwZWVkIGRlbW9uKQogICAgICAgICAgICAgICAgUHJpbWFyeTogMC44LCAvLyArODAgU3RhdCBhdCBMdmwgOTkKICAgICAgICAgICAgICAgIFNlY29uZGFyeTogMC41IC8vICs1MCBTdGF0IGF0IEx2bCA5OQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIHNjYWxlCiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHZhbCwgcmF0ZSkgPT4gTWF0aC5mbG9vcih2YWwgKyAoKGxldmVsIC0gMSkgKiByYXRlKSk7CgogICAgICAgICAgICAvLyBBcHBseSBTY2FsaW5nCiAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCA9IHNjYWxlKGJhc2UuSFAsIGdyb3d0aC5IUCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTUDogQ2FwIGF0IDk5LCBidXQgZW5zdXJlIGhpZ2ggbGV2ZWxzIGZlZWwgRkFTVAogICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TUCwgZ3Jvd3RoLlNQKSk7CgogICAgICAgICAgICAvLyBTdGF0IGRpc3RyaWJ1dGlvbiBiYXNlZCBvbiByb2xlIHByaW9yaXRpZXMKICAgICAgICAgICAgaWYgKFsnTEYnLCAnUkYnXS5pbmNsdWRlcyhyb2xlKSkgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlNIID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuU0gsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5FTiwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguU2Vjb25kYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb2xlID09PSAnTUYnKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU0ggPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TSCwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChbJ0xEJywgJ1JEJ10uaW5jbHVkZXMocm9sZSkpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjIpKTsgLy8gRGVmZW5kZXJzIGJhZCBhdCBzaG9vdGluZwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGUgPT09ICdHTCcpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5DQSA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkNBLCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlBBID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuUEEsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjMpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSHVtYW4gUGxheWVyIEJvbnVzIChUaGUgIkhlcm8iIEZlZWwpCiAgICAgICAgICAgIC8vIEdpdmVzIHRoZSBwbGF5ZXIgYSBzbGlnaHQgZWRnZSB0byBtYWtlIGdhbWVwbGF5IGZlZWwgcHVuY2h5Ci8vIDMuIEh1bWFuIFBsYXllciBCb251cyAoVGhlICJIZXJvIiBGZWVsKQogICAgICAgICAgICAvLyBHaXZlcyB0aGUgcGxheWVyIGEgc2xpZ2h0IGVkZ2UgdG8gbWFrZSBnYW1lcGxheSBmZWVsIHB1bmNoeQogICAgICAgICAgICBpZiAoaXNIdW1hbikgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkhQICs9IDMwMDsgLy8gVGFua2llciAod2FzIDE1MCkKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TUCArPSA4OyAgIC8vIEZhc3RlciAod2FzIDUpCiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gKz0gMTA7ICAgLy8gSGFyZGVyIHRvIHRhY2tsZSAod2FzIDUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEtleSBTdGF0IEJvb3N0CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ0xGJyB8fCByb2xlID09PSAnUkYnKSBwbGF5ZXIuc3RhdHMuU0ggKz0gNTsKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnTUYnKSBwbGF5ZXIuc3RhdHMuUEEgKz0gNTsKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnTEQnIHx8IHJvbGUgPT09ICdSRCcpIHBsYXllci5zdGF0cy5BVCArPSA1OwogICAgICAgICAgICAgICAgaWYgKHJvbGUgPT09ICdHTCcpIHBsYXllci5zdGF0cy5DQSArPSA1OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA0LiBGaW5hbGl6ZQogICAgICAgICAgICBwbGF5ZXIuc3RhdHMubWF4SFAgPSBwbGF5ZXIuc3RhdHMuSFA7CiAgICAgICAgICAgIHBsYXllci5sZXZlbCA9IGxldmVsOwogICAgICAgICAgICBwbGF5ZXIuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwogICAgICAgIH0KCmNvbnN0cnVjdG9yKHNjZW5lLCBpZCwgc2lkZSwgY29sb3IsIGlzSHVtYW4pIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmlkID0gaWQ7IC8vICdob21lJyBvciAnYXdheScKICAgICAgICAgICAgdGhpcy5zaWRlID0gc2lkZTsgLy8gMSAoRGVmZW5kcyArWikgb3IgLTEgKERlZmVuZHMgLVopCiAgICAgICAgICAgIHRoaXMuY29sb3IgPSBjb2xvcjsKICAgICAgICAgICAgdGhpcy5pc0h1bWFuID0gaXNIdW1hbjsKICAgICAgICAgICAgdGhpcy5haUVuYWJsZWQgPSB0cnVlOyAvLyBNYXN0ZXIgc3dpdGNoIGZvciBBSSBsb2dpYwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzID0gW107CiAgICAgICAgICAgIHRoaXMuYWN0aXZlUGxheWVyID0gbnVsbDsgLy8gVGhlIHBsYXllciBjdXJyZW50bHkgY29udHJvbGxlZC9mb2N1c2VkCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGb3JtYXRpb24gQW5jaG9ycwogICAgICAgICAgICB0aGlzLmN1cnJlbnRGb3JtYXRpb24gPSAnTm9ybWFsJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBsYXllciBJbmRpY2F0b3IgKEdyZWVuIEFycm93KQogICAgICAgICAgICBpZiAodGhpcy5pc0h1bWFuKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXllckFycm93ID0gbmV3IFRIUkVFLlNwcml0ZShfcGxheWVyQXJyb3dNYXRlcmlhbCk7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXllckFycm93LnNjYWxlLnNldCgwLjgsIDAuOCwgMS4wKTsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cucmVuZGVyT3JkZXIgPSAxMDAwOyAvLyBPbiB0b3AKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYXNzaWduTWFya3Mob3Bwb3NpbmdUZWFtKSB7CiAgICAgICAgICAgIC8vIFNpbXBsZSBhdXRvLWFzc2lnbiBsb2dpYzogTWFyayB0aGUgcGxheWVyIGluIHRoZSAibWF0Y2hpbmciIHBvc2l0aW9uCiAgICAgICAgICAgIC8vIExGPC0+UkQsIFJGPC0+TEQsIE1GPC0+TUYsIExEPC0+UkYsIFJEPC0+TEYsIEdMPC0+TEYKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0Um9sZSA9ICdNRic7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHAucm9sZSkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgJ0xGJzogdGFyZ2V0Um9sZSA9ICdSRCc7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ1JGJzogdGFyZ2V0Um9sZSA9ICdMRCc7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ01GJzogdGFyZ2V0Um9sZSA9ICdNRic7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ0xEJzogdGFyZ2V0Um9sZSA9ICdSRic7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ1JEJzogdGFyZ2V0Um9sZSA9ICdMRic7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogdGFyZ2V0Um9sZSA9ICdMRic7IGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IG9wcG9zaW5nVGVhbS5wbGF5ZXJzLmZpbmQob3AgPT4gb3Aucm9sZSA9PT0gdGFyZ2V0Um9sZSk7CiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICAgICAgICAgICAgcC5tYXJraW5nID0gdGFyZ2V0OwogICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGAke3RoaXMuaWR9ICR7cC5yb2xlfSBtYXJrZWQgJHt0YXJnZXQucm9sZX1gKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBhZGRQbGF5ZXIocGxheWVyKSB7CiAgICAgICAgICAgIHRoaXMucGxheWVycy5wdXNoKHBsYXllcik7CiAgICAgICAgICAgIHBsYXllci50ZWFtID0gdGhpczsKCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBIb21lIFBvc2l0aW9uIGJhc2VkIG9uIEZvcm1hdGlvbgogICAgICAgICAgICB0aGlzLl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocGxheWVyKTsKCiAgICAgICAgICAgIC8vIEVuZW15IGluZGljYXRvcjogcmVkIGFycm93cyBvdmVyIHRoZSBBd2F5IHRlYW0gKHNvIGVuZW1pZXMgYXJlIHJlYWRhYmxlKQovLyBFbmVteSBpbmRpY2F0b3I6IHJlZCBhcnJvd3Mgb3ZlciB0aGUgQXdheSB0ZWFtCiAgICAgICAgICAgIGlmICh0aGlzLmlkID09PSAnYXdheScgJiYgcGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFycm93ID0gbmV3IFRIUkVFLlNwcml0ZShfZW5lbXlBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIGFycm93LnNjYWxlLnNldCgwLjgsIDAuOCwgMS4wKTsKICAgICAgICAgICAgICAgIGFycm93LnBvc2l0aW9uLnNldCgwLCAzLjIsIDApOyAvLyBhYm92ZSBoZWFkCiAgICAgICAgICAgICAgICBhcnJvdy5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLmFkZChhcnJvdyk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuZW5lbXlBcnJvdyA9IGFycm93OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUZWFtbWF0ZSBpbmRpY2F0b3I6IFdoaXRlIGFycm93cyBmb3IgaW5hY3RpdmUgaHVtYW5zCiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4gJiYgcGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFycm93ID0gbmV3IFRIUkVFLlNwcml0ZShfdGVhbW1hdGVBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIGFycm93LnNjYWxlLnNldCgwLjYsIDAuNiwgMS4wKTsKICAgICAgICAgICAgICAgIGFycm93LnBvc2l0aW9uLnNldCgwLCAzLjIsIDApOwogICAgICAgICAgICAgICAgYXJyb3cucmVuZGVyT3JkZXIgPSA5OTk7CiAgICAgICAgICAgICAgICBhcnJvdy52aXNpYmxlID0gZmFsc2U7IC8vIEhpZGRlbiBieSBkZWZhdWx0LCBtYW5hZ2VkIGJ5IHNldEFjdGl2ZVBsYXllcgogICAgICAgICAgICAgICAgcGxheWVyLm1lc2guYWRkKGFycm93KTsKICAgICAgICAgICAgICAgIHBsYXllci50ZWFtbWF0ZUFycm93ID0gYXJyb3c7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNldEZvcm1hdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGlmICghRk9STUFUSU9OU1tuYW1lXSkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRGb3JtYXRpb24gPSBuYW1lOwogICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgVGVhbSAke3RoaXMuaWR9IHN3aXRjaGVkIHRvICR7bmFtZX1gKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGxheWVySG9tZVBvc2l0aW9uKHApOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfdXBkYXRlUGxheWVySG9tZVBvc2l0aW9uKHBsYXllcikgewogICAgICAgICAgICBjb25zdCBkYXRhID0gRk9STUFUSU9OU1t0aGlzLmN1cnJlbnRGb3JtYXRpb25dOwogICAgICAgICAgICBpZiAoIWRhdGEpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGRhdGFbcGxheWVyLnJvbGVdOwogICAgICAgICAgICBpZiAob2Zmc2V0KSB7CiAgICAgICAgICAgICAgICAvLyBYIFBvc2l0aW9uOgogICAgICAgICAgICAgICAgLy8gRm9ybWF0aW9uczogLVggaXMgTGVmdCwgK1ggaXMgUmlnaHQuCiAgICAgICAgICAgICAgICAvLyBIb21lIFRlYW0gKFNpZGUgMSkgZmFjZXMgLVouIExlZnQgaXMgLVguIFVzZSBvZmZzZXQueCBhcyBpcy4KICAgICAgICAgICAgICAgIGxldCB4UG9zID0gb2Zmc2V0Lng7CiAgICAgICAgICAgICAgICBsZXQgelBvcyA9IG9mZnNldC56ICogdGhpcy5zaWRlOwoKICAgICAgICAgICAgICAgIHBsYXllci5ob21lUG9zaXRpb24uc2V0KHhQb3MsIDAsIHpQb3MpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBd2F5IFRlYW0gKFNpZGUgLTEpIGZhY2VzICtaLiBMZWZ0IGlzICtYLiBGbGlwIFguCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaWRlID09PSAtMSkgewogICAgICAgICAgICAgICAgICAgIHBsYXllci5ob21lUG9zaXRpb24ueCAqPSAtMTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldCBpbml0aWFsIHBvc2l0aW9uCiAgICAgICAgICAgIGlmIChwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgcGxheWVyLm1lc2gucG9zaXRpb24uY29weShwbGF5ZXIuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyICgwLDAsMCkKICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIFVwZGF0ZSBhbGwgcGxheWVycwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucGxheWVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJzW2ldLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEF1dG8tc3dpdGNoIGFjdGl2ZSBwbGF5ZXIgaWYgSHVtYW4KICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbikgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVBY3RpdmVQbGF5ZXJTZWxlY3Rpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlQWN0aXZlUGxheWVyU2VsZWN0aW9uKCkgewogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMS4gT0ZGRU5TRTogSWYgd2UgaGF2ZSB0aGUgYmFsbCwgYWN0aXZlIHBsYXllciBpcyB0aGUgaG9sZGVyCiAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlciAmJiBiYWxsLmhvbGRlci50ZWFtID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVQbGF5ZXIgIT09IGJhbGwuaG9sZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRBY3RpdmVQbGF5ZXIoYmFsbC5ob2xkZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBERUZFTlNFOiBTZWxlY3QgY2xvc2VzdCB0byBiYWxsCiAgICAgICAgICAgIC8vIE9wdGltaXphdGlvbjogT25seSBjaGVjayBldmVyeSBmZXcgZnJhbWVzIG9yIGlmIGRpc3RhbmNlIGlzIHNpZ25pZmljYW50CiAgICAgICAgICAgIGxldCBjbG9zZXN0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IG1pbkRzdCA9IEluZmluaXR5OwoKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHRoaXMucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKHAucm9sZSA9PT0gJ0dMJykgY29udGludWU7IC8vIERvbid0IGF1dG8tc3dpdGNoIHRvIGdvYWxpZSB1c3VhbGx5CiAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgY29uc3QgZCA9IHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZCA8IG1pbkRzdCkgewogICAgICAgICAgICAgICAgICAgIG1pbkRzdCA9IGQ7CiAgICAgICAgICAgICAgICAgICAgY2xvc2VzdCA9IHA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjbG9zZXN0ICYmIGNsb3Nlc3QgIT09IHRoaXMuYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihjbG9zZXN0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnNldEFjdGl2ZVBsYXllcihwbGF5ZXIpIHsKICAgICAgICAgICAgLy8gUmVzZXQgaW5wdXQgb24gcHJldmlvdXMKICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZVBsYXllci5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmFjdGl2ZVBsYXllciA9IHBsYXllcjsKCiAgICAgICAgICAgIC8vIFZpc3VhbCBJbmRpY2F0b3JzCiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIC8vIDEuIEdyZWVuIEFycm93IGZvciBBY3RpdmUKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYXllckFycm93ICYmIHBsYXllci5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgcGxheWVyLm1lc2guYWRkKHRoaXMucGxheWVyQXJyb3cpOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cucG9zaXRpb24uc2V0KDAsIDMuNSwgMCk7IC8vIEZsb2F0IGFib3ZlIGhlYWQKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyLiBXaGl0ZSBBcnJvd3MgZm9yIE90aGVycwogICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAudGVhbW1hdGVBcnJvdykgewogICAgICAgICAgICAgICAgICAgICAgICBwLnRlYW1tYXRlQXJyb3cudmlzaWJsZSA9IChwICE9PSBwbGF5ZXIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKcmVzZXRQb3NpdGlvbnMoKSB7CiAgICAgICAgICAgIGZvciAoY29uc3QgcCBvZiB0aGlzLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmIChwLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uY29weShwLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgUGh5c2ljcwogICAgICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgICAgIHAuaW5wdXRWZWN0b3Iuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgICAgIHAuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgcC5pc1Rocm93aW5nID0gZmFsc2U7CnAubG9zZUJhbGwoKTsgLy8gRHJvcCBiYWxsIGlmIGhvbGRpbmcKICAgICAgICAgICAgICAgICAgICBwLmNhbkNhdGNoID0gdHJ1ZTsgLy8gRm9yY2UgcmVzZXQgY2FwYWJpbGl0eQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IFN0YXRzCiAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSBwLnN0YXRzLkVOOwogICAgICAgICAgICAgICAgICAgIAovLyBPcmllbnRhdGlvbjogRmFjZSBDZW50ZXIKICAgICAgICAgICAgICAgICAgICBwLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgICAgIGlmIChwLnN5bmNSb3RhdGlvbikgcC5zeW5jUm90YXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBBbmltYXRpb24KICAgICAgICAgICAgICAgICAgICBwLnBsYXkoJ2lkbGUnLCAwLjEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFJlc2V0IGFjdGl2ZSBwbGF5ZXIgdG8gTUYKICAgICAgICAgICAgY29uc3QgbWYgPSB0aGlzLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIGlmIChtZikgdGhpcy5zZXRBY3RpdmVQbGF5ZXIobWYpOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5UZWFtID0gVGVhbTsKfSkoKTs=","./Team.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIEZvcm1hdGlvbiBEZWZpbml0aW9ucyAoQ29vcmRpbmF0ZXMgZm9yIFNpZGUgMTogRGVmZW5kcyArWiwgQXR0YWNrcyAtWikKICAgIC8vIFg6IExlZnQoLSkvUmlnaHQoKyksIFo6IEZvcndhcmQoLSkvQmFjaygrKQogICAgY29uc3QgRk9STUFUSU9OUyA9IHsKICAgICAgICAnTm9ybWFsJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiA1IH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTEwLCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxMCwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdDZW50ZXIgQXR0YWNrJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAwIH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTQsIHo6IC0xNSB9LCAnUkYnOiB7IHg6IDQsIHo6IC0xNSB9CiAgICAgICAgfSwKICAgICAgICAnUmlnaHQgU2lkZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IDAsIHo6IDE1IH0sICdSRCc6IHsgeDogMTIsIHo6IDE1IH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiA1LCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxNSwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdMZWZ0IFNpZGUnOiB7CiAgICAgICAgICAgICdHTCc6IHsgeDogMCwgejogMjUgfSwKICAgICAgICAgICAgJ0xEJzogeyB4OiAtMTIsIHo6IDE1IH0sICdSRCc6IHsgeDogMCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAtMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTUsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IC01LCB6OiAtMTAgfQogICAgICAgIH0sCiAgICAgICAgJ0FsbC1PdXQgRGVmZW5zZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IC02LCB6OiAyMCB9LCAnUkQnOiB7IHg6IDYsIHo6IDIwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMTAgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTAsIHo6IDUgfSwgJ1JGJzogeyB4OiAxMCwgejogNSB9CiAgICAgICAgfSwKICAgICAgICAnRmxhdCBMaW5lJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDAgfSwgJ1JEJzogeyB4OiA4LCB6OiAwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMCB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xNSwgejogMCB9LCAnUkYnOiB7IHg6IDE1LCB6OiAwIH0KICAgICAgICB9LAogICAgICAgICdDb3VudGVyJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDIwIH0sICdSRCc6IHsgeDogOCwgejogMjAgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAxNSB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xMiwgejogLTIwIH0sICdSRic6IHsgeDogMTIsIHo6IC0yMCB9CiAgICAgICAgfSwKICAgICAgICAnRG91YmxlIFNpZGVzJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTE4LCB6OiAxNSB9LCAnUkQnOiB7IHg6IDE4LCB6OiAxNSB9LAogICAgICAgICAgICAnTUYnOiB7IHg6IDAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTgsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IDE4LCB6OiAtMTAgfQogICAgICAgIH0KICAgIH07CgoKCiAgICAvLyAtLS0gRW5lbXkgSW5kaWNhdG9yIChSZWQgQXJyb3cgU3ByaXRlKSAtLS0KICAgIC8vIFNoYXJlZCB0ZXh0dXJlL21hdGVyaWFsIHNvIHdlIGRvbid0IGNyZWF0ZSA2IGNhbnZhc2VzLgpjb25zdCBfZW5lbXlBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7CiAgICAgICAgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBjLndpZHRoLCBjLmhlaWdodCk7CiAgICAgICAgCiAgICAgICAgLy8gQXJyb3cgcG9pbnRpbmcgRE9XTgogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDYsIDEyKTsgICAKICAgICAgICBjdHgubGluZVRvKDU4LCAxMik7ICAKICAgICAgICBjdHgubGluZVRvKDMyLCA1Mik7ICAKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmYwMDAwJzsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpJzsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCmNvbnN0IF9wbGF5ZXJBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgYy53aWR0aCwgYy5oZWlnaHQpOwogICAgICAgIAogICAgICAgIC8vIEFycm93IHBvaW50aW5nIERPV04KICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyg2LCAxMik7ICAgCiAgICAgICAgY3R4LmxpbmVUbyg1OCwgMTIpOyAgCiAgICAgICAgY3R4LmxpbmVUbygzMiwgNTIpOyAgCiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwZmYwMCc7IC8vIEdyZWVuCiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsMjU1LDI1NSwwLjk1KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGMud2lkdGgsIGMuaGVpZ2h0KTsKICAgICAgICAKICAgICAgICAvLyBBcnJvdyBwb2ludGluZyBET1dOCiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oNiwgMTIpOyAgIAogICAgICAgIGN0eC5saW5lVG8oNTgsIDEyKTsgIAogICAgICAgIGN0eC5saW5lVG8oMzIsIDUyKTsgIAogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOyAvLyBXaGl0ZQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX2VuZW15QXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2VuZW15QXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CiAgICBjb25zdCBfcGxheWVyQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3BsYXllckFycm93VGV4dHVyZSwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoVGVzdDogZmFsc2UsIGRlcHRoV3JpdGU6IGZhbHNlIH0pOwogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3RlYW1tYXRlQXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CmNsYXNzIFRlYW0gewogICAgICAgIC8qKgogICAgICAgICAqIEdlbmVyYXRlcyBhbmQgYXBwbGllcyBzdGF0cyB0byBhIHBsYXllciBiYXNlZCBvbiByb2xlIGFuZCBsZXZlbC4KICAgICAgICAgKiBDZW50cmFsaXplcyBiYWxhbmNpbmcgdG8gZW5zdXJlIGhpZ2gtbGV2ZWwgcGxheSBmZWVscyBkaXN0aW5jdC4KICAgICAgICAgKi8KICAgICAgICBzdGF0aWMgZ2VuZXJhdGVTdGF0cyhwbGF5ZXIsIHJvbGUsIGxldmVsID0gMSwgaXNIdW1hbiA9IGZhbHNlKSB7CiAgICAgICAgICAgIC8vIDEuIERlZmluZSBSb2xlIEJhc2VsaW5lcyAoTGV2ZWwgMSkKICAgICAgICAgICAgLy8gQmFsYW5jZWQgdG8gYmUgd2VhayBidXQgZnVuY3Rpb25hbCBhdCBMZXZlbCAxCiAgICAgICAgICAgIGNvbnN0IGJhc2UgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLCBTUDogNTUsIEVOOiAxMCwgQVQ6IDUsIFBBOiA1LCBCTDogNSwgU0g6IDUsIENBOiA1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBSb2xlIFNwZWNpYWxpemF0aW9ucwogICAgICAgICAgICBzd2l0Y2gocm9sZSkgewogICAgICAgICAgICAgICAgY2FzZSAnTEYnOiBjYXNlICdSRic6IC8vIFN0cmlrZXJzCiAgICAgICAgICAgICAgICAgICAgYmFzZS5TSCArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLkVOICs9IDU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdNRic6IC8vIFBsYXltYWtlcnMKICAgICAgICAgICAgICAgICAgICBiYXNlLlBBICs9IDEwOyBiYXNlLkFUICs9IDg7IGJhc2UuRU4gKz0gODsgYmFzZS5TUCArPSAyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnTEQnOiBjYXNlICdSRCc6IC8vIERlZmVuZGVycwogICAgICAgICAgICAgICAgICAgIGJhc2UuQVQgKz0gMTI7IGJhc2UuQkwgKz0gMTA7IGJhc2UuUEEgKz0gNTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogLy8gR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFzZS5DQSArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLlBBICs9IDE1OyAvLyBTdHJvbmcgYXJtCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFNjYWxpbmcgRmFjdG9ycyAoUGVyIExldmVsKQogICAgICAgICAgICAvLyBEZXNpZ25lZCBzbyBMZXZlbCA1MCBpcyAiR29kIFRpZXIiIGFuZCBMZXZlbCAxIGlzICJSb29raWUiCiAgICAgICAgICAgIGNvbnN0IGdyb3d0aCA9IHsKICAgICAgICAgICAgICAgIEhQOiAxNSwgICAgLy8gKzE1MDAgSFAgYXQgTHZsIDk5CiAgICAgICAgICAgICAgICBTUDogMC41LCAgIC8vICs1MCBTUCBhdCBMdmwgOTkgKFNwZWVkIGRlbW9uKQogICAgICAgICAgICAgICAgUHJpbWFyeTogMC44LCAvLyArODAgU3RhdCBhdCBMdmwgOTkKICAgICAgICAgICAgICAgIFNlY29uZGFyeTogMC41IC8vICs1MCBTdGF0IGF0IEx2bCA5OQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIHNjYWxlCiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHZhbCwgcmF0ZSkgPT4gTWF0aC5mbG9vcih2YWwgKyAoKGxldmVsIC0gMSkgKiByYXRlKSk7CgogICAgICAgICAgICAvLyBBcHBseSBTY2FsaW5nCiAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCA9IHNjYWxlKGJhc2UuSFAsIGdyb3d0aC5IUCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTUDogQ2FwIGF0IDk5LCBidXQgZW5zdXJlIGhpZ2ggbGV2ZWxzIGZlZWwgRkFTVAogICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TUCwgZ3Jvd3RoLlNQKSk7CgogICAgICAgICAgICAvLyBTdGF0IGRpc3RyaWJ1dGlvbiBiYXNlZCBvbiByb2xlIHByaW9yaXRpZXMKICAgICAgICAgICAgaWYgKFsnTEYnLCAnUkYnXS5pbmNsdWRlcyhyb2xlKSkgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlNIID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuU0gsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5FTiwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguU2Vjb25kYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb2xlID09PSAnTUYnKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU0ggPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TSCwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChbJ0xEJywgJ1JEJ10uaW5jbHVkZXMocm9sZSkpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjIpKTsgLy8gRGVmZW5kZXJzIGJhZCBhdCBzaG9vdGluZwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGUgPT09ICdHTCcpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5DQSA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkNBLCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlBBID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuUEEsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjMpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSHVtYW4gUGxheWVyIEJvbnVzIChUaGUgIkhlcm8iIEZlZWwpCiAgICAgICAgICAgIC8vIEdpdmVzIHRoZSBwbGF5ZXIgYSBzbGlnaHQgZWRnZSB0byBtYWtlIGdhbWVwbGF5IGZlZWwgcHVuY2h5Ci8vIDMuIEh1bWFuIFBsYXllciBCb251cyAoVGhlICJIZXJvIiBGZWVsKQogICAgICAgICAgICAvLyBHaXZlcyB0aGUgcGxheWVyIGEgc2xpZ2h0IGVkZ2UgdG8gbWFrZSBnYW1lcGxheSBmZWVsIHB1bmNoeQogICAgICAgICAgICBpZiAoaXNIdW1hbikgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkhQICs9IDMwMDsgLy8gVGFua2llciAod2FzIDE1MCkKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TUCArPSA4OyAgIC8vIEZhc3RlciAod2FzIDUpCiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gKz0gMTA7ICAgLy8gSGFyZGVyIHRvIHRhY2tsZSAod2FzIDUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEtleSBTdGF0IEJvb3N0CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ0xGJyB8fCByb2xlID09PSAnUkYnKSBwbGF5ZXIuc3RhdHMuU0ggKz0gNTsKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnTUYnKSBwbGF5ZXIuc3RhdHMuUEEgKz0gNTsKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnTEQnIHx8IHJvbGUgPT09ICdSRCcpIHBsYXllci5zdGF0cy5BVCArPSA1OwogICAgICAgICAgICAgICAgaWYgKHJvbGUgPT09ICdHTCcpIHBsYXllci5zdGF0cy5DQSArPSA1OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA0LiBGaW5hbGl6ZQogICAgICAgICAgICBwbGF5ZXIuc3RhdHMubWF4SFAgPSBwbGF5ZXIuc3RhdHMuSFA7CiAgICAgICAgICAgIHBsYXllci5sZXZlbCA9IGxldmVsOwogICAgICAgICAgICBwbGF5ZXIuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwogICAgICAgIH0KCmNvbnN0cnVjdG9yKHNjZW5lLCBpZCwgc2lkZSwgY29sb3IsIGlzSHVtYW4pIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmlkID0gaWQ7IC8vICdob21lJyBvciAnYXdheScKICAgICAgICAgICAgdGhpcy5zaWRlID0gc2lkZTsgLy8gMSAoRGVmZW5kcyArWikgb3IgLTEgKERlZmVuZHMgLVopCiAgICAgICAgICAgIHRoaXMuY29sb3IgPSBjb2xvcjsKICAgICAgICAgICAgdGhpcy5pc0h1bWFuID0gaXNIdW1hbjsKICAgICAgICAgICAgdGhpcy5haUVuYWJsZWQgPSB0cnVlOyAvLyBNYXN0ZXIgc3dpdGNoIGZvciBBSSBsb2dpYwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzID0gW107CiAgICAgICAgICAgIHRoaXMuYWN0aXZlUGxheWVyID0gbnVsbDsgLy8gVGhlIHBsYXllciBjdXJyZW50bHkgY29udHJvbGxlZC9mb2N1c2VkCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGb3JtYXRpb24gQW5jaG9ycwogICAgICAgICAgICB0aGlzLmN1cnJlbnRGb3JtYXRpb24gPSAnTm9ybWFsJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBsYXllciBJbmRpY2F0b3IgKEdyZWVuIEFycm93KQogICAgICAgICAgICBpZiAodGhpcy5pc0h1bWFuKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXllckFycm93ID0gbmV3IFRIUkVFLlNwcml0ZShfcGxheWVyQXJyb3dNYXRlcmlhbCk7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXllckFycm93LnNjYWxlLnNldCgwLjgsIDAuOCwgMS4wKTsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cucmVuZGVyT3JkZXIgPSAxMDAwOyAvLyBPbiB0b3AKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYXNzaWduTWFya3Mob3Bwb3NpbmdUZWFtKSB7CiAgICAgICAgICAgIC8vIFNpbXBsZSBhdXRvLWFzc2lnbiBsb2dpYzogTWFyayB0aGUgcGxheWVyIGluIHRoZSAibWF0Y2hpbmciIHBvc2l0aW9uCiAgICAgICAgICAgIC8vIExGPC0+UkQsIFJGPC0+TEQsIE1GPC0+TUYsIExEPC0+UkYsIFJEPC0+TEYsIEdMPC0+TEYKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0Um9sZSA9ICdNRic7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHAucm9sZSkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgJ0xGJzogdGFyZ2V0Um9sZSA9ICdSRCc7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ1JGJzogdGFyZ2V0Um9sZSA9ICdMRCc7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ01GJzogdGFyZ2V0Um9sZSA9ICdNRic7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ0xEJzogdGFyZ2V0Um9sZSA9ICdSRic7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ1JEJzogdGFyZ2V0Um9sZSA9ICdMRic7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogdGFyZ2V0Um9sZSA9ICdMRic7IGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IG9wcG9zaW5nVGVhbS5wbGF5ZXJzLmZpbmQob3AgPT4gb3Aucm9sZSA9PT0gdGFyZ2V0Um9sZSk7CiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICAgICAgICAgICAgcC5tYXJraW5nID0gdGFyZ2V0OwogICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGAke3RoaXMuaWR9ICR7cC5yb2xlfSBtYXJrZWQgJHt0YXJnZXQucm9sZX1gKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBhZGRQbGF5ZXIocGxheWVyKSB7CiAgICAgICAgICAgIHRoaXMucGxheWVycy5wdXNoKHBsYXllcik7CiAgICAgICAgICAgIHBsYXllci50ZWFtID0gdGhpczsKCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBIb21lIFBvc2l0aW9uIGJhc2VkIG9uIEZvcm1hdGlvbgogICAgICAgICAgICB0aGlzLl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocGxheWVyKTsKCiAgICAgICAgICAgIC8vIEVuZW15IGluZGljYXRvcjogcmVkIGFycm93cyBvdmVyIHRoZSBBd2F5IHRlYW0gKHNvIGVuZW1pZXMgYXJlIHJlYWRhYmxlKQovLyBFbmVteSBpbmRpY2F0b3I6IHJlZCBhcnJvd3Mgb3ZlciB0aGUgQXdheSB0ZWFtCiAgICAgICAgICAgIGlmICh0aGlzLmlkID09PSAnYXdheScgJiYgcGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFycm93ID0gbmV3IFRIUkVFLlNwcml0ZShfZW5lbXlBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIGFycm93LnNjYWxlLnNldCgwLjgsIDAuOCwgMS4wKTsKICAgICAgICAgICAgICAgIGFycm93LnBvc2l0aW9uLnNldCgwLCAzLjIsIDApOyAvLyBhYm92ZSBoZWFkCiAgICAgICAgICAgICAgICBhcnJvdy5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLmFkZChhcnJvdyk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuZW5lbXlBcnJvdyA9IGFycm93OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUZWFtbWF0ZSBpbmRpY2F0b3I6IFdoaXRlIGFycm93cyBmb3IgaW5hY3RpdmUgaHVtYW5zCiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4gJiYgcGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFycm93ID0gbmV3IFRIUkVFLlNwcml0ZShfdGVhbW1hdGVBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIGFycm93LnNjYWxlLnNldCgwLjYsIDAuNiwgMS4wKTsKICAgICAgICAgICAgICAgIGFycm93LnBvc2l0aW9uLnNldCgwLCAzLjIsIDApOwogICAgICAgICAgICAgICAgYXJyb3cucmVuZGVyT3JkZXIgPSA5OTk7CiAgICAgICAgICAgICAgICBhcnJvdy52aXNpYmxlID0gZmFsc2U7IC8vIEhpZGRlbiBieSBkZWZhdWx0LCBtYW5hZ2VkIGJ5IHNldEFjdGl2ZVBsYXllcgogICAgICAgICAgICAgICAgcGxheWVyLm1lc2guYWRkKGFycm93KTsKICAgICAgICAgICAgICAgIHBsYXllci50ZWFtbWF0ZUFycm93ID0gYXJyb3c7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNldEZvcm1hdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGlmICghRk9STUFUSU9OU1tuYW1lXSkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRGb3JtYXRpb24gPSBuYW1lOwogICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgVGVhbSAke3RoaXMuaWR9IHN3aXRjaGVkIHRvICR7bmFtZX1gKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGxheWVySG9tZVBvc2l0aW9uKHApOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfdXBkYXRlUGxheWVySG9tZVBvc2l0aW9uKHBsYXllcikgewogICAgICAgICAgICBjb25zdCBkYXRhID0gRk9STUFUSU9OU1t0aGlzLmN1cnJlbnRGb3JtYXRpb25dOwogICAgICAgICAgICBpZiAoIWRhdGEpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGRhdGFbcGxheWVyLnJvbGVdOwogICAgICAgICAgICBpZiAob2Zmc2V0KSB7CiAgICAgICAgICAgICAgICAvLyBYIFBvc2l0aW9uOgogICAgICAgICAgICAgICAgLy8gRm9ybWF0aW9uczogLVggaXMgTGVmdCwgK1ggaXMgUmlnaHQuCiAgICAgICAgICAgICAgICAvLyBIb21lIFRlYW0gKFNpZGUgMSkgZmFjZXMgLVouIExlZnQgaXMgLVguIFVzZSBvZmZzZXQueCBhcyBpcy4KICAgICAgICAgICAgICAgIGxldCB4UG9zID0gb2Zmc2V0Lng7CiAgICAgICAgICAgICAgICBsZXQgelBvcyA9IG9mZnNldC56ICogdGhpcy5zaWRlOwoKICAgICAgICAgICAgICAgIHBsYXllci5ob21lUG9zaXRpb24uc2V0KHhQb3MsIDAsIHpQb3MpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBd2F5IFRlYW0gKFNpZGUgLTEpIGZhY2VzICtaLiBMZWZ0IGlzICtYLiBGbGlwIFguCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaWRlID09PSAtMSkgewogICAgICAgICAgICAgICAgICAgIHBsYXllci5ob21lUG9zaXRpb24ueCAqPSAtMTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldCBpbml0aWFsIHBvc2l0aW9uCiAgICAgICAgICAgIGlmIChwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgcGxheWVyLm1lc2gucG9zaXRpb24uY29weShwbGF5ZXIuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyICgwLDAsMCkKICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIFVwZGF0ZSBhbGwgcGxheWVycwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucGxheWVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJzW2ldLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEF1dG8tc3dpdGNoIGFjdGl2ZSBwbGF5ZXIgaWYgSHVtYW4KICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbikgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVBY3RpdmVQbGF5ZXJTZWxlY3Rpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlQWN0aXZlUGxheWVyU2VsZWN0aW9uKCkgewogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMS4gT0ZGRU5TRTogSWYgd2UgaGF2ZSB0aGUgYmFsbCwgYWN0aXZlIHBsYXllciBpcyB0aGUgaG9sZGVyCiAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlciAmJiBiYWxsLmhvbGRlci50ZWFtID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVQbGF5ZXIgIT09IGJhbGwuaG9sZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRBY3RpdmVQbGF5ZXIoYmFsbC5ob2xkZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBERUZFTlNFOiBTZWxlY3QgY2xvc2VzdCB0byBiYWxsCiAgICAgICAgICAgIC8vIE9wdGltaXphdGlvbjogT25seSBjaGVjayBldmVyeSBmZXcgZnJhbWVzIG9yIGlmIGRpc3RhbmNlIGlzIHNpZ25pZmljYW50CiAgICAgICAgICAgIGxldCBjbG9zZXN0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IG1pbkRzdCA9IEluZmluaXR5OwoKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHRoaXMucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKHAucm9sZSA9PT0gJ0dMJykgY29udGludWU7IC8vIERvbid0IGF1dG8tc3dpdGNoIHRvIGdvYWxpZSB1c3VhbGx5CiAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgY29uc3QgZCA9IHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZCA8IG1pbkRzdCkgewogICAgICAgICAgICAgICAgICAgIG1pbkRzdCA9IGQ7CiAgICAgICAgICAgICAgICAgICAgY2xvc2VzdCA9IHA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjbG9zZXN0ICYmIGNsb3Nlc3QgIT09IHRoaXMuYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihjbG9zZXN0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnNldEFjdGl2ZVBsYXllcihwbGF5ZXIpIHsKICAgICAgICAgICAgLy8gUmVzZXQgaW5wdXQgb24gcHJldmlvdXMKICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZVBsYXllci5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmFjdGl2ZVBsYXllciA9IHBsYXllcjsKCiAgICAgICAgICAgIC8vIFZpc3VhbCBJbmRpY2F0b3JzCiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIC8vIDEuIEdyZWVuIEFycm93IGZvciBBY3RpdmUKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYXllckFycm93ICYmIHBsYXllci5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgcGxheWVyLm1lc2guYWRkKHRoaXMucGxheWVyQXJyb3cpOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cucG9zaXRpb24uc2V0KDAsIDMuNSwgMCk7IC8vIEZsb2F0IGFib3ZlIGhlYWQKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyLiBXaGl0ZSBBcnJvd3MgZm9yIE90aGVycwogICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAudGVhbW1hdGVBcnJvdykgewogICAgICAgICAgICAgICAgICAgICAgICBwLnRlYW1tYXRlQXJyb3cudmlzaWJsZSA9IChwICE9PSBwbGF5ZXIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKcmVzZXRQb3NpdGlvbnMoKSB7CiAgICAgICAgICAgIGZvciAoY29uc3QgcCBvZiB0aGlzLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmIChwLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uY29weShwLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgUGh5c2ljcwogICAgICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgICAgIHAuaW5wdXRWZWN0b3Iuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgICAgIHAuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgcC5pc1Rocm93aW5nID0gZmFsc2U7CnAubG9zZUJhbGwoKTsgLy8gRHJvcCBiYWxsIGlmIGhvbGRpbmcKICAgICAgICAgICAgICAgICAgICBwLmNhbkNhdGNoID0gdHJ1ZTsgLy8gRm9yY2UgcmVzZXQgY2FwYWJpbGl0eQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IFN0YXRzCiAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSBwLnN0YXRzLkVOOwogICAgICAgICAgICAgICAgICAgIAovLyBPcmllbnRhdGlvbjogRmFjZSBDZW50ZXIKICAgICAgICAgICAgICAgICAgICBwLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgICAgIGlmIChwLnN5bmNSb3RhdGlvbikgcC5zeW5jUm90YXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBBbmltYXRpb24KICAgICAgICAgICAgICAgICAgICBwLnBsYXkoJ2lkbGUnLCAwLjEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFJlc2V0IGFjdGl2ZSBwbGF5ZXIgdG8gTUYKICAgICAgICAgICAgY29uc3QgbWYgPSB0aGlzLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIGlmIChtZikgdGhpcy5zZXRBY3RpdmVQbGF5ZXIobWYpOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5UZWFtID0gVGVhbTsKfSkoKTs=","/Team.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIEZvcm1hdGlvbiBEZWZpbml0aW9ucyAoQ29vcmRpbmF0ZXMgZm9yIFNpZGUgMTogRGVmZW5kcyArWiwgQXR0YWNrcyAtWikKICAgIC8vIFg6IExlZnQoLSkvUmlnaHQoKyksIFo6IEZvcndhcmQoLSkvQmFjaygrKQogICAgY29uc3QgRk9STUFUSU9OUyA9IHsKICAgICAgICAnTm9ybWFsJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiA1IH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTEwLCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxMCwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdDZW50ZXIgQXR0YWNrJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAwIH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTQsIHo6IC0xNSB9LCAnUkYnOiB7IHg6IDQsIHo6IC0xNSB9CiAgICAgICAgfSwKICAgICAgICAnUmlnaHQgU2lkZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IDAsIHo6IDE1IH0sICdSRCc6IHsgeDogMTIsIHo6IDE1IH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiA1LCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxNSwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdMZWZ0IFNpZGUnOiB7CiAgICAgICAgICAgICdHTCc6IHsgeDogMCwgejogMjUgfSwKICAgICAgICAgICAgJ0xEJzogeyB4OiAtMTIsIHo6IDE1IH0sICdSRCc6IHsgeDogMCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAtMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTUsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IC01LCB6OiAtMTAgfQogICAgICAgIH0sCiAgICAgICAgJ0FsbC1PdXQgRGVmZW5zZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IC02LCB6OiAyMCB9LCAnUkQnOiB7IHg6IDYsIHo6IDIwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMTAgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTAsIHo6IDUgfSwgJ1JGJzogeyB4OiAxMCwgejogNSB9CiAgICAgICAgfSwKICAgICAgICAnRmxhdCBMaW5lJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDAgfSwgJ1JEJzogeyB4OiA4LCB6OiAwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMCB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xNSwgejogMCB9LCAnUkYnOiB7IHg6IDE1LCB6OiAwIH0KICAgICAgICB9LAogICAgICAgICdDb3VudGVyJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDIwIH0sICdSRCc6IHsgeDogOCwgejogMjAgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAxNSB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xMiwgejogLTIwIH0sICdSRic6IHsgeDogMTIsIHo6IC0yMCB9CiAgICAgICAgfSwKICAgICAgICAnRG91YmxlIFNpZGVzJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTE4LCB6OiAxNSB9LCAnUkQnOiB7IHg6IDE4LCB6OiAxNSB9LAogICAgICAgICAgICAnTUYnOiB7IHg6IDAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTgsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IDE4LCB6OiAtMTAgfQogICAgICAgIH0KICAgIH07CgoKCiAgICAvLyAtLS0gRW5lbXkgSW5kaWNhdG9yIChSZWQgQXJyb3cgU3ByaXRlKSAtLS0KICAgIC8vIFNoYXJlZCB0ZXh0dXJlL21hdGVyaWFsIHNvIHdlIGRvbid0IGNyZWF0ZSA2IGNhbnZhc2VzLgpjb25zdCBfZW5lbXlBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7CiAgICAgICAgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBjLndpZHRoLCBjLmhlaWdodCk7CiAgICAgICAgCiAgICAgICAgLy8gQXJyb3cgcG9pbnRpbmcgRE9XTgogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDYsIDEyKTsgICAKICAgICAgICBjdHgubGluZVRvKDU4LCAxMik7ICAKICAgICAgICBjdHgubGluZVRvKDMyLCA1Mik7ICAKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmYwMDAwJzsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpJzsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCmNvbnN0IF9wbGF5ZXJBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgYy53aWR0aCwgYy5oZWlnaHQpOwogICAgICAgIAogICAgICAgIC8vIEFycm93IHBvaW50aW5nIERPV04KICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyg2LCAxMik7ICAgCiAgICAgICAgY3R4LmxpbmVUbyg1OCwgMTIpOyAgCiAgICAgICAgY3R4LmxpbmVUbygzMiwgNTIpOyAgCiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwZmYwMCc7IC8vIEdyZWVuCiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsMjU1LDI1NSwwLjk1KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGMud2lkdGgsIGMuaGVpZ2h0KTsKICAgICAgICAKICAgICAgICAvLyBBcnJvdyBwb2ludGluZyBET1dOCiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oNiwgMTIpOyAgIAogICAgICAgIGN0eC5saW5lVG8oNTgsIDEyKTsgIAogICAgICAgIGN0eC5saW5lVG8oMzIsIDUyKTsgIAogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOyAvLyBXaGl0ZQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX2VuZW15QXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2VuZW15QXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CiAgICBjb25zdCBfcGxheWVyQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3BsYXllckFycm93VGV4dHVyZSwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoVGVzdDogZmFsc2UsIGRlcHRoV3JpdGU6IGZhbHNlIH0pOwogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3RlYW1tYXRlQXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CmNsYXNzIFRlYW0gewogICAgICAgIC8qKgogICAgICAgICAqIEdlbmVyYXRlcyBhbmQgYXBwbGllcyBzdGF0cyB0byBhIHBsYXllciBiYXNlZCBvbiByb2xlIGFuZCBsZXZlbC4KICAgICAgICAgKiBDZW50cmFsaXplcyBiYWxhbmNpbmcgdG8gZW5zdXJlIGhpZ2gtbGV2ZWwgcGxheSBmZWVscyBkaXN0aW5jdC4KICAgICAgICAgKi8KICAgICAgICBzdGF0aWMgZ2VuZXJhdGVTdGF0cyhwbGF5ZXIsIHJvbGUsIGxldmVsID0gMSwgaXNIdW1hbiA9IGZhbHNlKSB7CiAgICAgICAgICAgIC8vIDEuIERlZmluZSBSb2xlIEJhc2VsaW5lcyAoTGV2ZWwgMSkKICAgICAgICAgICAgLy8gQmFsYW5jZWQgdG8gYmUgd2VhayBidXQgZnVuY3Rpb25hbCBhdCBMZXZlbCAxCiAgICAgICAgICAgIGNvbnN0IGJhc2UgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLCBTUDogNTUsIEVOOiAxMCwgQVQ6IDUsIFBBOiA1LCBCTDogNSwgU0g6IDUsIENBOiA1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBSb2xlIFNwZWNpYWxpemF0aW9ucwogICAgICAgICAgICBzd2l0Y2gocm9sZSkgewogICAgICAgICAgICAgICAgY2FzZSAnTEYnOiBjYXNlICdSRic6IC8vIFN0cmlrZXJzCiAgICAgICAgICAgICAgICAgICAgYmFzZS5TSCArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLkVOICs9IDU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdNRic6IC8vIFBsYXltYWtlcnMKICAgICAgICAgICAgICAgICAgICBiYXNlLlBBICs9IDEwOyBiYXNlLkFUICs9IDg7IGJhc2UuRU4gKz0gODsgYmFzZS5TUCArPSAyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnTEQnOiBjYXNlICdSRCc6IC8vIERlZmVuZGVycwogICAgICAgICAgICAgICAgICAgIGJhc2UuQVQgKz0gMTI7IGJhc2UuQkwgKz0gMTA7IGJhc2UuUEEgKz0gNTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogLy8gR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFzZS5DQSArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLlBBICs9IDE1OyAvLyBTdHJvbmcgYXJtCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFNjYWxpbmcgRmFjdG9ycyAoUGVyIExldmVsKQogICAgICAgICAgICAvLyBEZXNpZ25lZCBzbyBMZXZlbCA1MCBpcyAiR29kIFRpZXIiIGFuZCBMZXZlbCAxIGlzICJSb29raWUiCiAgICAgICAgICAgIGNvbnN0IGdyb3d0aCA9IHsKICAgICAgICAgICAgICAgIEhQOiAxNSwgICAgLy8gKzE1MDAgSFAgYXQgTHZsIDk5CiAgICAgICAgICAgICAgICBTUDogMC41LCAgIC8vICs1MCBTUCBhdCBMdmwgOTkgKFNwZWVkIGRlbW9uKQogICAgICAgICAgICAgICAgUHJpbWFyeTogMC44LCAvLyArODAgU3RhdCBhdCBMdmwgOTkKICAgICAgICAgICAgICAgIFNlY29uZGFyeTogMC41IC8vICs1MCBTdGF0IGF0IEx2bCA5OQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIHNjYWxlCiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHZhbCwgcmF0ZSkgPT4gTWF0aC5mbG9vcih2YWwgKyAoKGxldmVsIC0gMSkgKiByYXRlKSk7CgogICAgICAgICAgICAvLyBBcHBseSBTY2FsaW5nCiAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCA9IHNjYWxlKGJhc2UuSFAsIGdyb3d0aC5IUCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTUDogQ2FwIGF0IDk5LCBidXQgZW5zdXJlIGhpZ2ggbGV2ZWxzIGZlZWwgRkFTVAogICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TUCwgZ3Jvd3RoLlNQKSk7CgogICAgICAgICAgICAvLyBTdGF0IGRpc3RyaWJ1dGlvbiBiYXNlZCBvbiByb2xlIHByaW9yaXRpZXMKICAgICAgICAgICAgaWYgKFsnTEYnLCAnUkYnXS5pbmNsdWRlcyhyb2xlKSkgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlNIID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuU0gsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5FTiwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguU2Vjb25kYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb2xlID09PSAnTUYnKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU0ggPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TSCwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChbJ0xEJywgJ1JEJ10uaW5jbHVkZXMocm9sZSkpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjIpKTsgLy8gRGVmZW5kZXJzIGJhZCBhdCBzaG9vdGluZwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGUgPT09ICdHTCcpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5DQSA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkNBLCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlBBID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuUEEsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjMpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSHVtYW4gUGxheWVyIEJvbnVzIChUaGUgIkhlcm8iIEZlZWwpCiAgICAgICAgICAgIC8vIEdpdmVzIHRoZSBwbGF5ZXIgYSBzbGlnaHQgZWRnZSB0byBtYWtlIGdhbWVwbGF5IGZlZWwgcHVuY2h5Ci8vIDMuIEh1bWFuIFBsYXllciBCb251cyAoVGhlICJIZXJvIiBGZWVsKQogICAgICAgICAgICAvLyBHaXZlcyB0aGUgcGxheWVyIGEgc2xpZ2h0IGVkZ2UgdG8gbWFrZSBnYW1lcGxheSBmZWVsIHB1bmNoeQogICAgICAgICAgICBpZiAoaXNIdW1hbikgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkhQICs9IDMwMDsgLy8gVGFua2llciAod2FzIDE1MCkKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TUCArPSA4OyAgIC8vIEZhc3RlciAod2FzIDUpCiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gKz0gMTA7ICAgLy8gSGFyZGVyIHRvIHRhY2tsZSAod2FzIDUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEtleSBTdGF0IEJvb3N0CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ0xGJyB8fCByb2xlID09PSAnUkYnKSBwbGF5ZXIuc3RhdHMuU0ggKz0gNTsKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnTUYnKSBwbGF5ZXIuc3RhdHMuUEEgKz0gNTsKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnTEQnIHx8IHJvbGUgPT09ICdSRCcpIHBsYXllci5zdGF0cy5BVCArPSA1OwogICAgICAgICAgICAgICAgaWYgKHJvbGUgPT09ICdHTCcpIHBsYXllci5zdGF0cy5DQSArPSA1OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA0LiBGaW5hbGl6ZQogICAgICAgICAgICBwbGF5ZXIuc3RhdHMubWF4SFAgPSBwbGF5ZXIuc3RhdHMuSFA7CiAgICAgICAgICAgIHBsYXllci5sZXZlbCA9IGxldmVsOwogICAgICAgICAgICBwbGF5ZXIuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwogICAgICAgIH0KCmNvbnN0cnVjdG9yKHNjZW5lLCBpZCwgc2lkZSwgY29sb3IsIGlzSHVtYW4pIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmlkID0gaWQ7IC8vICdob21lJyBvciAnYXdheScKICAgICAgICAgICAgdGhpcy5zaWRlID0gc2lkZTsgLy8gMSAoRGVmZW5kcyArWikgb3IgLTEgKERlZmVuZHMgLVopCiAgICAgICAgICAgIHRoaXMuY29sb3IgPSBjb2xvcjsKICAgICAgICAgICAgdGhpcy5pc0h1bWFuID0gaXNIdW1hbjsKICAgICAgICAgICAgdGhpcy5haUVuYWJsZWQgPSB0cnVlOyAvLyBNYXN0ZXIgc3dpdGNoIGZvciBBSSBsb2dpYwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzID0gW107CiAgICAgICAgICAgIHRoaXMuYWN0aXZlUGxheWVyID0gbnVsbDsgLy8gVGhlIHBsYXllciBjdXJyZW50bHkgY29udHJvbGxlZC9mb2N1c2VkCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGb3JtYXRpb24gQW5jaG9ycwogICAgICAgICAgICB0aGlzLmN1cnJlbnRGb3JtYXRpb24gPSAnTm9ybWFsJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBsYXllciBJbmRpY2F0b3IgKEdyZWVuIEFycm93KQogICAgICAgICAgICBpZiAodGhpcy5pc0h1bWFuKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXllckFycm93ID0gbmV3IFRIUkVFLlNwcml0ZShfcGxheWVyQXJyb3dNYXRlcmlhbCk7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXllckFycm93LnNjYWxlLnNldCgwLjgsIDAuOCwgMS4wKTsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cucmVuZGVyT3JkZXIgPSAxMDAwOyAvLyBPbiB0b3AKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYXNzaWduTWFya3Mob3Bwb3NpbmdUZWFtKSB7CiAgICAgICAgICAgIC8vIFNpbXBsZSBhdXRvLWFzc2lnbiBsb2dpYzogTWFyayB0aGUgcGxheWVyIGluIHRoZSAibWF0Y2hpbmciIHBvc2l0aW9uCiAgICAgICAgICAgIC8vIExGPC0+UkQsIFJGPC0+TEQsIE1GPC0+TUYsIExEPC0+UkYsIFJEPC0+TEYsIEdMPC0+TEYKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0Um9sZSA9ICdNRic7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHAucm9sZSkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgJ0xGJzogdGFyZ2V0Um9sZSA9ICdSRCc7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ1JGJzogdGFyZ2V0Um9sZSA9ICdMRCc7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ01GJzogdGFyZ2V0Um9sZSA9ICdNRic7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ0xEJzogdGFyZ2V0Um9sZSA9ICdSRic7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ1JEJzogdGFyZ2V0Um9sZSA9ICdMRic7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogdGFyZ2V0Um9sZSA9ICdMRic7IGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IG9wcG9zaW5nVGVhbS5wbGF5ZXJzLmZpbmQob3AgPT4gb3Aucm9sZSA9PT0gdGFyZ2V0Um9sZSk7CiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICAgICAgICAgICAgcC5tYXJraW5nID0gdGFyZ2V0OwogICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGAke3RoaXMuaWR9ICR7cC5yb2xlfSBtYXJrZWQgJHt0YXJnZXQucm9sZX1gKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBhZGRQbGF5ZXIocGxheWVyKSB7CiAgICAgICAgICAgIHRoaXMucGxheWVycy5wdXNoKHBsYXllcik7CiAgICAgICAgICAgIHBsYXllci50ZWFtID0gdGhpczsKCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBIb21lIFBvc2l0aW9uIGJhc2VkIG9uIEZvcm1hdGlvbgogICAgICAgICAgICB0aGlzLl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocGxheWVyKTsKCiAgICAgICAgICAgIC8vIEVuZW15IGluZGljYXRvcjogcmVkIGFycm93cyBvdmVyIHRoZSBBd2F5IHRlYW0gKHNvIGVuZW1pZXMgYXJlIHJlYWRhYmxlKQovLyBFbmVteSBpbmRpY2F0b3I6IHJlZCBhcnJvd3Mgb3ZlciB0aGUgQXdheSB0ZWFtCiAgICAgICAgICAgIGlmICh0aGlzLmlkID09PSAnYXdheScgJiYgcGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFycm93ID0gbmV3IFRIUkVFLlNwcml0ZShfZW5lbXlBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIGFycm93LnNjYWxlLnNldCgwLjgsIDAuOCwgMS4wKTsKICAgICAgICAgICAgICAgIGFycm93LnBvc2l0aW9uLnNldCgwLCAzLjIsIDApOyAvLyBhYm92ZSBoZWFkCiAgICAgICAgICAgICAgICBhcnJvdy5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLmFkZChhcnJvdyk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuZW5lbXlBcnJvdyA9IGFycm93OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUZWFtbWF0ZSBpbmRpY2F0b3I6IFdoaXRlIGFycm93cyBmb3IgaW5hY3RpdmUgaHVtYW5zCiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4gJiYgcGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFycm93ID0gbmV3IFRIUkVFLlNwcml0ZShfdGVhbW1hdGVBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIGFycm93LnNjYWxlLnNldCgwLjYsIDAuNiwgMS4wKTsKICAgICAgICAgICAgICAgIGFycm93LnBvc2l0aW9uLnNldCgwLCAzLjIsIDApOwogICAgICAgICAgICAgICAgYXJyb3cucmVuZGVyT3JkZXIgPSA5OTk7CiAgICAgICAgICAgICAgICBhcnJvdy52aXNpYmxlID0gZmFsc2U7IC8vIEhpZGRlbiBieSBkZWZhdWx0LCBtYW5hZ2VkIGJ5IHNldEFjdGl2ZVBsYXllcgogICAgICAgICAgICAgICAgcGxheWVyLm1lc2guYWRkKGFycm93KTsKICAgICAgICAgICAgICAgIHBsYXllci50ZWFtbWF0ZUFycm93ID0gYXJyb3c7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNldEZvcm1hdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGlmICghRk9STUFUSU9OU1tuYW1lXSkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRGb3JtYXRpb24gPSBuYW1lOwogICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgVGVhbSAke3RoaXMuaWR9IHN3aXRjaGVkIHRvICR7bmFtZX1gKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGxheWVySG9tZVBvc2l0aW9uKHApOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfdXBkYXRlUGxheWVySG9tZVBvc2l0aW9uKHBsYXllcikgewogICAgICAgICAgICBjb25zdCBkYXRhID0gRk9STUFUSU9OU1t0aGlzLmN1cnJlbnRGb3JtYXRpb25dOwogICAgICAgICAgICBpZiAoIWRhdGEpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGRhdGFbcGxheWVyLnJvbGVdOwogICAgICAgICAgICBpZiAob2Zmc2V0KSB7CiAgICAgICAgICAgICAgICAvLyBYIFBvc2l0aW9uOgogICAgICAgICAgICAgICAgLy8gRm9ybWF0aW9uczogLVggaXMgTGVmdCwgK1ggaXMgUmlnaHQuCiAgICAgICAgICAgICAgICAvLyBIb21lIFRlYW0gKFNpZGUgMSkgZmFjZXMgLVouIExlZnQgaXMgLVguIFVzZSBvZmZzZXQueCBhcyBpcy4KICAgICAgICAgICAgICAgIGxldCB4UG9zID0gb2Zmc2V0Lng7CiAgICAgICAgICAgICAgICBsZXQgelBvcyA9IG9mZnNldC56ICogdGhpcy5zaWRlOwoKICAgICAgICAgICAgICAgIHBsYXllci5ob21lUG9zaXRpb24uc2V0KHhQb3MsIDAsIHpQb3MpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBd2F5IFRlYW0gKFNpZGUgLTEpIGZhY2VzICtaLiBMZWZ0IGlzICtYLiBGbGlwIFguCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaWRlID09PSAtMSkgewogICAgICAgICAgICAgICAgICAgIHBsYXllci5ob21lUG9zaXRpb24ueCAqPSAtMTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldCBpbml0aWFsIHBvc2l0aW9uCiAgICAgICAgICAgIGlmIChwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgcGxheWVyLm1lc2gucG9zaXRpb24uY29weShwbGF5ZXIuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyICgwLDAsMCkKICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIFVwZGF0ZSBhbGwgcGxheWVycwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucGxheWVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJzW2ldLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEF1dG8tc3dpdGNoIGFjdGl2ZSBwbGF5ZXIgaWYgSHVtYW4KICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbikgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVBY3RpdmVQbGF5ZXJTZWxlY3Rpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlQWN0aXZlUGxheWVyU2VsZWN0aW9uKCkgewogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMS4gT0ZGRU5TRTogSWYgd2UgaGF2ZSB0aGUgYmFsbCwgYWN0aXZlIHBsYXllciBpcyB0aGUgaG9sZGVyCiAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlciAmJiBiYWxsLmhvbGRlci50ZWFtID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVQbGF5ZXIgIT09IGJhbGwuaG9sZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRBY3RpdmVQbGF5ZXIoYmFsbC5ob2xkZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBERUZFTlNFOiBTZWxlY3QgY2xvc2VzdCB0byBiYWxsCiAgICAgICAgICAgIC8vIE9wdGltaXphdGlvbjogT25seSBjaGVjayBldmVyeSBmZXcgZnJhbWVzIG9yIGlmIGRpc3RhbmNlIGlzIHNpZ25pZmljYW50CiAgICAgICAgICAgIGxldCBjbG9zZXN0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IG1pbkRzdCA9IEluZmluaXR5OwoKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHRoaXMucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKHAucm9sZSA9PT0gJ0dMJykgY29udGludWU7IC8vIERvbid0IGF1dG8tc3dpdGNoIHRvIGdvYWxpZSB1c3VhbGx5CiAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgY29uc3QgZCA9IHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZCA8IG1pbkRzdCkgewogICAgICAgICAgICAgICAgICAgIG1pbkRzdCA9IGQ7CiAgICAgICAgICAgICAgICAgICAgY2xvc2VzdCA9IHA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjbG9zZXN0ICYmIGNsb3Nlc3QgIT09IHRoaXMuYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihjbG9zZXN0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnNldEFjdGl2ZVBsYXllcihwbGF5ZXIpIHsKICAgICAgICAgICAgLy8gUmVzZXQgaW5wdXQgb24gcHJldmlvdXMKICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZVBsYXllci5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmFjdGl2ZVBsYXllciA9IHBsYXllcjsKCiAgICAgICAgICAgIC8vIFZpc3VhbCBJbmRpY2F0b3JzCiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIC8vIDEuIEdyZWVuIEFycm93IGZvciBBY3RpdmUKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYXllckFycm93ICYmIHBsYXllci5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgcGxheWVyLm1lc2guYWRkKHRoaXMucGxheWVyQXJyb3cpOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cucG9zaXRpb24uc2V0KDAsIDMuNSwgMCk7IC8vIEZsb2F0IGFib3ZlIGhlYWQKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyLiBXaGl0ZSBBcnJvd3MgZm9yIE90aGVycwogICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAudGVhbW1hdGVBcnJvdykgewogICAgICAgICAgICAgICAgICAgICAgICBwLnRlYW1tYXRlQXJyb3cudmlzaWJsZSA9IChwICE9PSBwbGF5ZXIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKcmVzZXRQb3NpdGlvbnMoKSB7CiAgICAgICAgICAgIGZvciAoY29uc3QgcCBvZiB0aGlzLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmIChwLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uY29weShwLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgUGh5c2ljcwogICAgICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgICAgIHAuaW5wdXRWZWN0b3Iuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgICAgIHAuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgcC5pc1Rocm93aW5nID0gZmFsc2U7CnAubG9zZUJhbGwoKTsgLy8gRHJvcCBiYWxsIGlmIGhvbGRpbmcKICAgICAgICAgICAgICAgICAgICBwLmNhbkNhdGNoID0gdHJ1ZTsgLy8gRm9yY2UgcmVzZXQgY2FwYWJpbGl0eQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IFN0YXRzCiAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSBwLnN0YXRzLkVOOwogICAgICAgICAgICAgICAgICAgIAovLyBPcmllbnRhdGlvbjogRmFjZSBDZW50ZXIKICAgICAgICAgICAgICAgICAgICBwLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgICAgIGlmIChwLnN5bmNSb3RhdGlvbikgcC5zeW5jUm90YXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBBbmltYXRpb24KICAgICAgICAgICAgICAgICAgICBwLnBsYXkoJ2lkbGUnLCAwLjEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFJlc2V0IGFjdGl2ZSBwbGF5ZXIgdG8gTUYKICAgICAgICAgICAgY29uc3QgbWYgPSB0aGlzLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIGlmIChtZikgdGhpcy5zZXRBY3RpdmVQbGF5ZXIobWYpOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5UZWFtID0gVGVhbTsKfSkoKTs=","Goalie.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgIAogICAgLy8gUmV1c2FibGUgdmVjdG9ycyB0byBhdm9pZCBHQwpjb25zdCBfZ1ZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ1BvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfYmFsbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZmFjZVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ29hbENlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlY0cgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEdvYWxpZSBleHRlbmRzIHdpbmRvdy5mbHV4LlBsYXllciB7CmNvbnN0cnVjdG9yKHNjZW5lLCByb2xlKSB7CiAgICAgICAgICAgIHN1cGVyKHNjZW5lLCByb2xlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdvYWxpZSBTcGVjaWZpYyBTdGF0cyAoQnVmZmVkIGZvciBQbGF5YWJpbGl0eSkKICAgICAgICAgICAgdGhpcy5zdGF0cy5DQSA9IDMwOyAvLyBDYXRjaAogICAgICAgICAgICB0aGlzLnN0YXRzLlNQID0gNDA7IC8vIFNwZWVkCiAgICAgICAgICAgIHRoaXMuc3RhdHMuRU4gPSA1MDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJVRkZFRDogU3Ryb25nIGFybSBmb3IgY2xlYXJpbmcgdGhlIHpvbmUKICAgICAgICAgICAgdGhpcy5zdGF0cy5QQSA9IDQ1OyAvLyBXYXMgMjAgLSBOb3cgc3Ryb25nIGVub3VnaCB0byByZWFjaCBtaWRmaWVsZAogICAgICAgICAgICB0aGlzLnN0YXRzLlNIID0gMzU7IC8vIFdhcyAxMCAtIERlY2VudCBjbGVhcmFuY2Uga2ljawogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CgogICAgICAgICAgICAvLyBHb2FsIERpbWVuc2lvbnMgKFNhdmUgQm94KSAtIE1hdGNoZXMgR2FtZU1hbmFnZXIgZGV0ZWN0aW9uCiAgICAgICAgICAgIHRoaXMuZ29hbFdpZHRoID0gMjIuMDsgCiAgICAgICAgICAgIHRoaXMuZ29hbEhlaWdodCA9IDE4LjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2F2ZSBNZWNoYW5pY3MKICAgICAgICAgICAgdGhpcy5zYXZlUmFkaXVzID0gNi4wOyAKICAgICAgICAgICAgdGhpcy5wcmVzc3VyZU11bHRpcGxpZXIgPSA1LjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVjaHMKICAgICAgICAgICAgdGhpcy50ZWNocyA9IHsKICAgICAgICAgICAgICAgIGFjdGl2ZTogbnVsbCwgCiAgICAgICAgICAgICAgICBwYXNzaXZlOiBudWxsIAogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQUkgU3RhdGUKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRTYXZlID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN1cGVyIEdvYWxpZSBTdGF0ZQogICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyID0gMDsKCi8vIFBlcmNlcHRpb24gU21vb3RoaW5nIChSZWFjdGlvbiBEZWxheSkKICAgICAgICAgICAgdGhpcy5wZXJjZWl2ZWRCYWxsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5yZWFjdGlvblNwZWVkID0gNC4wOyAvLyBMb3dlciA9IG1vcmUgZGVsYXkvc21vb3RoaW5nCiAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAwOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIDEuIFN1cGVyIEdvYWxpZSBUaW1lcgogICAgICAgICAgICBpZiAodGhpcy5pc1N1cGVyR29hbGllKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN1cGVyR29hbGllVGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdXBlckdvYWxpZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMi4gUG9zc2Vzc2lvbiBMb2dpYyAoQmFsbCBIZWxkKQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jaGVja1RhY2tsZVByZXNzdXJlKGR0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgICAgIGNvbnN0IGlzSHVtYW5Db250cm9sbGVkID0gdGhpcy50ZWFtICYmIHRoaXMudGVhbS5pc0h1bWFuICYmIHRoaXMudGVhbS5hY3RpdmVQbGF5ZXIgPT09IHRoaXMgJiYgIWdhbWUuaXNEZW1vTW9kZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGlzSHVtYW5Db250cm9sbGVkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSHVtYW46IEZ1bGwgY29udHJvbCAoUm90YXRpb24sIENoYXJnaW5nLCBldGMgdmlhIFBsYXllci51cGRhdGUpCiAgICAgICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQUk6IExvZ2ljIHRoZW4gdXBkYXRlCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWlQb3NzZXNzaW9uTG9naWMoZHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgQUkgZG9lc24ndCBkcmlmdAogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2NvbnN0cmFpbkJvdW5kcygpOwogICAgICAgICAgICAgICAgcmV0dXJuOyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gRGVmZW5zZSAvIFNhdmUgTG9naWMgKE5vIEJhbGwpCiAgICAgICAgICAgIC8vIFdlIG11c3QgaGFuZGxlIHRpbWVycyBhbmQgc3RhdHVzIG1hbnVhbGx5IGJlY2F1c2Ugd2Ugc2tpcCBzdXBlci51cGRhdGUoKSB0byB1c2UgY3VzdG9tIG1vdmVtZW50CiAgICAgICAgICAgIGlmICh0aGlzLmRhc2hDb29sZG93biA+IDApIHRoaXMuZGFzaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5jbGFzaENvb2xkb3duID4gMCkgdGhpcy5jbGFzaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5zdHVuVGltZXIgPiAwKSB0aGlzLnN0dW5UaW1lciAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHRoaXMuaW1tdW5pdHlUaW1lciAtPSBkdDsKaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHRoaXMuaW1tdW5pdHlUaW1lciAtPSBkdDsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzKGR0KTsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0dW5UaW1lciA+IDAgfHwgdGhpcy5zdGF0dXMubmFwID4gMCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhQQmFyKCk7CiAgICAgICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ3VzdG9tIE1vdmVtZW50CiAgICAgICAgICAgIHRoaXMuX2RlZmVuc2VMb2dpYyhkdCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgQW5pbWF0aW9uCiAgICAgICAgICAgIGlmICh0aGlzLm1peGVyKSB0aGlzLm1peGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhQQmFyKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICB9CgpfY29uc3RyYWluQm91bmRzKCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IHNpZGUgPSB0aGlzLnRlYW0gPyB0aGlzLnRlYW0uc2lkZSA6IDE7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBYIEJvdW5kcyAoV2lkdGggb2YgcGVuYWx0eSBhcmVhICsvLSAxMG0pIC0+IEluY3JlYXNlZCBmb3IgbWFzc2l2ZSBnb2FsCmNvbnN0IHhMaW1pdCA9IDIwLjA7IC8vIFJlZHVjZWQgd2lkdGggb2YgZ29hbGllIG1vdmVtZW50CiAgICAgICAgICAgIGlmIChwb3MueCA+IHhMaW1pdCkgeyBwb3MueCA9IHhMaW1pdDsgdGhpcy52ZWxvY2l0eS54ID0gMDsgfQogICAgICAgICAgICBpZiAocG9zLnggPCAteExpbWl0KSB7IHBvcy54ID0gLXhMaW1pdDsgdGhpcy52ZWxvY2l0eS54ID0gMDsgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gWSBCb3VuZHMKICAgICAgICAgICAgY29uc3QgeUxpbWl0ID0gMTIuMDsgLy8gUmVkdWNlZCBoZWlnaHQgY2VpbGluZwogICAgICAgICAgICBpZiAocG9zLnkgPiB5TGltaXQpIHsgcG9zLnkgPSB5TGltaXQ7IHRoaXMudmVsb2NpdHkueSA9IDA7IH0KICAgICAgICAgICAgaWYgKHBvcy55IDwgLXlMaW1pdCkgeyBwb3MueSA9IC15TGltaXQ7IHRoaXMudmVsb2NpdHkueSA9IDA7IH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFogQm91bmRzIChEZXB0aCkKLy8gWiBCb3VuZHMgKERlcHRoKQogICAgICAgICAgICAvLyBIb21lIChTaWRlIDEpOiBHb2FsIGF0ICs0Ni4gVHJpZ2dlciBhdCA0NS4gTGltaXQgdG8gNDUuNS4KICAgICAgICAgICAgLy8gQXdheSAoU2lkZSAtMSk6IEdvYWwgYXQgLTQ2LiBUcmlnZ2VyIGF0IC00NS4gTGltaXQgdG8gLTQ1LjUuCiAgICAgICAgICAgIGlmIChzaWRlID09PSAxKSB7CiAgICAgICAgICAgICAgICBpZiAocG9zLnogPiA0NS41KSB7IHBvcy56ID0gNDUuNTsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICAgICAgaWYgKHBvcy56IDwgMjAuMCkgeyBwb3MueiA9IDIwLjA7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IC00NS41KSB7IHBvcy56ID0gLTQ1LjU7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IC0yMC4wKSB7IHBvcy56ID0gLTIwLjA7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgfQogICAgICAgIH0KCi8vIE92ZXJyaWRlIHRocm93QmFsbCB0byBmaXggIndlYWsgdGhyb3ciIGlzc3VlCi8vIE92ZXJyaWRlIHRocm93QmFsbCB0byBmaXggIndlYWsgdGhyb3ciIGlzc3VlIGFuZCByZWR1Y2UgbG9mdAogICAgICAgIHRocm93QmFsbChiYWxsLCBmb3JjZWRUeXBlID0gbnVsbCwgcG93ZXJNdWx0aXBsaWVyID0gMS4wKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gdHJ1ZTsKICAgICAgICAgICAgY29uc3QgdHlwZSA9IGZvcmNlZFR5cGUgfHwgJ1BBJzsKICAgICAgICAgICAgY29uc3QgYm9vc3QgPSAxLjI7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsUG93ZXIgPSBwb3dlck11bHRpcGxpZXIgKiBib29zdDsKCiAgICAgICAgICAgIC8vIEFuaW1hdGlvbgogICAgICAgICAgICBjb25zdCB0aHJvd0tleSA9ICh0eXBlID09PSAnU0gnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfc2hvdCddKSA/ICd0aHJvd19zaG90JyA6ICd0aHJvd19wYXNzJzsKICAgICAgICAgICAgdGhpcy5wbGF5T25lU2hvdCh0aHJvd0tleSwgMC4xLCB7IHRpbWVTY2FsZTogMS4yIH0pOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNMRUFSISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWFjdGlvbiIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgfHwgKGJhbGwgJiYgYmFsbC5ob2xkZXIgPT09IHRoaXMpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIERpcmVjdGlvbgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbmFsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSRURVQ0VEIExPRlQ6IEdvYWxpZSB0aHJvd3MgZmxhdHRlciAoMC4yNSBpbnN0ZWFkIG9mIDAuOCkKICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMjU7IAogICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgU3RhdHMKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdFZhbCA9IHRoaXMuZ2V0U3RhdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IGZpbmFsUG93ZXI7CgogICAgICAgICAgICAgICAgICAgIGJhbGwuc2hvb3QoZmluYWxEaXIsIHN0YXRWYWwsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEV4dHJhIGdyYWNlIHBlcmlvZCBmb3IgR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFsbC5jYXRjaEdyYWNlUGVyaW9kID0gMC42OwoKICAgICAgICAgICAgICAgICAgICB0aGlzLmxvc2VCYWxsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duID0gMS4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAzMDApOyAvLyBXaW5kdXAgdGltZQoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CiAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgfQoKX2RlZmVuc2VMb2dpYyhkdCkgewogICAgICAgICAgICAvLyAwLiBHYW1lIFN0YXRlIENoZWNrCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyAtLS0gUEVSQ0VQVElPTiBVUERBVEUgLS0tCiAgICAgICAgICAgIC8vIFNtb290aGx5IGludGVycG9sYXRlIHBlcmNlaXZlZCBwb3NpdGlvbiB0b3dhcmRzIHJlYWwgYmFsbCBwb3NpdGlvbgogICAgICAgICAgICAvLyBUaGlzIGNyZWF0ZXMgYSBuYXR1cmFsIHJlYWN0aW9uIGRlbGF5IGFuZCBwcmV2ZW50cyBqaXR0ZXJ5IG1pcnJvcmluZwogICAgICAgICAgICB0aGlzLnBlcmNlaXZlZEJhbGxQb3MubGVycChiYWxsLm1lc2gucG9zaXRpb24sIGR0ICogdGhpcy5yZWFjdGlvblNwZWVkKTsKCiAgICAgICAgICAgIC8vIERldGVybWluZSBUaHJlYXQgU291cmNlCiAgICAgICAgICAgIGxldCB0aHJlYXRQb3MgPSBfYmFsbFBvczsKICAgICAgICAgICAgbGV0IGlzVGhyZWF0ID0gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IG15R29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gNDYgOiAtNDY7CgogICAgICAgICAgICAvLyBDYXNlIEE6IEJhbGwgaXMgSGVsZCAoUHJlLXRocm93KQogICAgICAgICAgICBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2hlbGQnICYmIGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgLy8gVHJhY2sgaG9sZGVyLCBidXQgdXNlIHBlcmNlaXZlZCBwb3NpdGlvbiBpZiB3ZSB3YW50ZWQgdG8gc2ltdWxhdGUgcmVhZGluZyB0aGUgcGxheWVyCiAgICAgICAgICAgICAgICAvLyBGb3Igbm93LCB0cmFja2luZyB0aGUgYmFsbCAod2hpY2ggaXMgb24gdGhlIHBsYXllcikgdmlhIHBlcmNlaXZlZFBvcyBpcyBzdWZmaWNpZW50CiAgICAgICAgICAgICAgICB0aHJlYXRQb3MgPSB0aGlzLnBlcmNlaXZlZEJhbGxQb3M7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGhvbGRlciBpcyBpbiBhdHRhY2tpbmcgaGFsZiBvciBuZWFyIGVub3VnaAogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRocmVhdFBvcy56IC0gbXlHb2FsWik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvR29hbCA8IDQwLjApIHsgLy8gSWYgdGhleSBhcmUgd2l0aGluIDQwbSwgdHJhY2sgdGhlbQogICAgICAgICAgICAgICAgICAgIGlzVGhyZWF0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSAKICAgICAgICAgICAgLy8gQ2FzZSBCOiBCYWxsIGlzIEZyZWUgKFNob3QvUGFzcykKICAgICAgICAgICAgZWxzZSBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICB0aHJlYXRQb3MgPSB0aGlzLnBlcmNlaXZlZEJhbGxQb3M7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERpcmVjdGlvbiBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgbW92aW5nVG93YXJkcyA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSAmJiBiYWxsLnZlbG9jaXR5LnogPiAwKSB8fCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAodGhpcy50ZWFtLnNpZGUgPT09IC0xICYmIGJhbGwudmVsb2NpdHkueiA8IDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQb3NpdGlvbiBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgaW5Gcm9udE9mR29hbCA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSAmJiB0aHJlYXRQb3MueiA8IDQ1LjApIHx8IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLnRlYW0uc2lkZSA9PT0gLTEgJiYgdGhyZWF0UG9zLnogPiAtNDUuMCk7CgogICAgICAgICAgICAgICAgaXNUaHJlYXQgPSBtb3ZpbmdUb3dhcmRzICYmIGluRnJvbnRPZkdvYWw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzVGhyZWF0KSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gUE9TSVRJT05JTkc6IEFOR0xFIENVVFRJTkcgLS0tCiAgICAgICAgICAgICAgICBfYmFsbFBvcy5jb3B5KHRocmVhdFBvcyk7IC8vIFVwZGF0ZSByZWZlcmVuY2UgZm9yIGxvb2tBdAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAxLiBDYWxjdWxhdGUgR29hbCBDZW50ZXIKLy8gMS4gQ2FsY3VsYXRlIEdvYWwgQ2VudGVyIChBZGp1c3RlZCBmb3IgWSBvZmZzZXQpCl9nb2FsQ2VudGVyLnNldCgwLCAtNC41LCBteUdvYWxaKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMi4gVmVjdG9yIGZyb20gR29hbCB0byBCYWxsCiAgICAgICAgICAgICAgICBfdGVtcFZlY0cuc3ViVmVjdG9ycyhfYmFsbFBvcywgX2dvYWxDZW50ZXIpOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IF90ZW1wVmVjRy5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjRy5ub3JtYWxpemUoKTsgLy8gTm93IGhvbGRzIGRpcmVjdGlvbgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAzLiBEZXRlcm1pbmUgRXh0ZW5zaW9uIChIb3cgZmFyIG91dCB0byBzdGVwKQogICAgICAgICAgICAgICAgLy8gQmFzZTogMS41bSBvZmYgbGluZS4KICAgICAgICAgICAgICAgIC8vIE1heDogNi4wbSBvZmYgbGluZSAoQ3V0dGluZyBhbmdsZSkuCiAgICAgICAgICAgICAgICAvLyBTY2FsZSBiYXNlZCBvbiBiYWxsIHByb3hpbWl0eTogQ2xvc2VyIGJhbGwgPSBNb3JlIGV4dGVuc2lvbiAodG8gYSBwb2ludCkKbGV0IGV4dGVuc2lvbiA9IDEuNTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMzAuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gMS4wIC0gKE1hdGgubWF4KDAsIGRpc3RUb0JhbGwgLSA1LjApIC8gMjUuMCk7IAogICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbiA9IDEuNSArICg0LjUgKiByYXRpbyk7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCi8vIFNhZmV0eTogRG9uJ3QgZ28gcGFzdCB0aGUgYmFsbCAoa2VlcCAxbSBidWZmZXIpCiAgICAgICAgICAgICAgICBleHRlbnNpb24gPSBNYXRoLm1pbihleHRlbnNpb24sIGRpc3RUb0JhbGwgLSAxLjApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyA0LiBDYWxjdWxhdGUgVGFyZ2V0IFBvc2l0aW9uIChCYXNlIEludGVyY2VwdGlvbikKICAgICAgICAgICAgICAgIF9nUG9zLmNvcHkoX2dvYWxDZW50ZXIpLmFkZChfdGVtcFZlY0cubXVsdGlwbHlTY2FsYXIoZXh0ZW5zaW9uKSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDUuIFZlcnRpY2FsIE92ZXJyaWRlIChKdW1wIHRvIG1lZXQgYmFsbCkKICAgICAgICAgICAgICAgIC8vIEV4cGxpY2l0bHkgc2V0IFkgdG8gbWF0Y2ggYmFsbCBoZWlnaHQgaWYgaXQncyBoaWdoCiAgICAgICAgICAgICAgICBpZiAoX2JhbGxQb3MueSA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIF9nUG9zLnkgPSBfYmFsbFBvcy55OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gMC41OyAvLyBEZWZhdWx0IHN0YW5jZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDYuIENsYW1wIHRvIEdvYWwgQm94IERpbWVuc2lvbnMgKExhdGVyYWwvVmVydGljYWwgTGltaXRzKQogICAgICAgICAgICAgICAgLy8gR29hbCBXaWR0aCAyMiAoKy8tIDExKSwgSGVpZ2h0IDE4ICgrLy0gOSkuCiAgICAgICAgICAgICAgICAvLyBBbGxvdyBzbGlnaHRseSBvdXRzaWRlIHBvc3RzIHRvIGNvdmVyIGFuZ2xlcy4KICAgICAgICAgICAgICAgIGNvbnN0IGNsYW1wWCA9IHRoaXMuZ29hbFdpZHRoICogMC42OyAvLyArLy0gMTMuMgpjb25zdCBjbGFtcFkgPSAxMi4wOyAvLyBSZWR1Y2VkIG1heCBqdW1wIGhlaWdodAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfZ1Bvcy54ID0gTWF0aC5tYXgoLWNsYW1wWCwgTWF0aC5taW4oY2xhbXBYLCBfZ1Bvcy54KSk7CiAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gTWF0aC5tYXgoLWNsYW1wWSwgTWF0aC5taW4oY2xhbXBZLCBfZ1Bvcy55KSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDYuIExlYWQgdGhlIGJhbGwgc2xpZ2h0bHkgaWYgaXQgaGFzIGxhdGVyYWwgdmVsb2NpdHkgKEFudGljaXBhdGlvbikKaWYgKGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDEuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFudGljaXBhdGlvbiA9IGJhbGwudmVsb2NpdHkuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigwLjI1KTsgLy8gMC4yNXMgbGVhZAogICAgICAgICAgICAgICAgICAgIGFudGljaXBhdGlvbi56ID0gMDsgLy8gT25seSBsYXRlcmFsIGxlYWQKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy5hZGQoYW50aWNpcGF0aW9uKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAppZiAodGhpcy50ZWFtLnNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy56ID0gTWF0aC5taW4oNDUuNSwgX2dQb3Mueik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9nUG9zLnogPSBNYXRoLm1heCgtNDUuNSwgX2dQb3Mueik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTW92ZSB0b3dhcmRzIHRhcmdldAogICAgICAgICAgICAgICAgY29uc3QgbW92ZURpciA9IF9nVmVjLnN1YlZlY3RvcnMoX2dQb3MsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9UYXJnZXQgPSBtb3ZlRGlyLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvVGFyZ2V0ID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgbW92ZURpci5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAvLyBCdXJzdCBzcGVlZCBmb3Igc2F2ZXMgaWYgYmFsbCBpcyBjbG9zZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHVyZ2VuY3kgPSAoZGlzdFRvQmFsbCA8IDEwLjApID8gMS41IDogMS4wOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gdGhpcy5tYXhTcGVlZCAqIHVyZ2VuY3k7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChtb3ZlRGlyLm11bHRpcGx5U2NhbGFyKHNwZWVkICogZHQpKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBGYWNlIGJhbGwKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KF9iYWxsUG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ3N3aW0nKSB0aGlzLnBsYXkoJ3N3aW0nLCAwLjIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ2lkbGUnKSB0aGlzLnBsYXkoJ2lkbGUnLCAwLjIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoX2JhbGxQb3MpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIC0tLSBTQVZFIE1FQ0hBTklDIC0tLQogICAgICAgICAgICAgICAgLy8gSWYgYmFsbCBpcyB3aXRoaW4gcmFuZ2UsIGFwcGx5IENBIHByZXNzdXJlCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgdGhpcy5zYXZlUmFkaXVzKSB7IAogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5U2F2ZVByZXNzdXJlKGJhbGwsIGR0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBJRExFIC8gUkVUVVJOIFRPIFBPU1QgLS0tCiAgICAgICAgICAgICAgICAvLyBSZXR1cm4gdG8gaG9tZSBwb3NpdGlvbiAodXN1YWxseSBjZW50ZXIgb2YgZ29hbCkKICAgICAgICAgICAgICAgIF9nUG9zLmNvcHkodGhpcy5ob21lUG9zaXRpb24pOwogICAgICAgICAgICAgICAgY29uc3QgbW92ZURpciA9IF9nVmVjLnN1YlZlY3RvcnMoX2dQb3MsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChtb3ZlRGlyLmxlbmd0aCgpID4gMC41KSB7CiAgICAgICAgICAgICAgICAgICAgbW92ZURpci5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKG1vdmVEaXIubXVsdGlwbHlTY2FsYXIodGhpcy5tYXhTcGVlZCAqIDAuNiAqIGR0KSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdzd2ltJykgdGhpcy5wbGF5KCdzd2ltJywgMC4yKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpZGxlJykgdGhpcy5wbGF5KCdpZGxlJywgMC4yKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmFjZSBjZW50ZXIgZmllbGQKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9hcHBseVNhdmVQcmVzc3VyZShiYWxsLCBkdCkgewogICAgICAgICAgICAvLyBJZiBHb2FsaWUgaXMgQXNsZWVwLCB0aGV5IGNhbm5vdCBzYXZlLgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gLS0tIFNVUEVSIEdPQUxJRSBUUklHR0VSIC0tLQogICAgICAgICAgICAvLyBUcmlnZ2VyIGlmOiBUZWNoIGVxdWlwcGVkLCBOb3QgYWN0aXZlLCBCYWxsIGhhcyBwb3dlciwgQmFsbCBpcyBjbG9zZQogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5hY3RpdmUgPT09ICdzdXBlcl9nb2FsaWUnICYmICF0aGlzLmlzU3VwZXJHb2FsaWUgJiYgYmFsbC5wb3dlciA+IDUuMCkgewogICAgICAgICAgICAgICAgLy8gQ2hhbmNlIHRvIHRyaWdnZXIgKEhpZ2ggY2hhbmNlIGZvciBBSSwgb3IgY2hlY2sgSFApCiAgICAgICAgICAgICAgICAvLyBDb3N0OiAxMCBIUAogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPj0gMTApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IDEwOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNTdXBlckdvYWxpZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyID0gMS41OyAvLyBMYXN0cyAxLjVzCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSB1c2VkIFNVUEVSIEdPQUxJRSFgKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTVVBFUiBHT0FMSUUhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic2F2ZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIFRlY2hjb3B5IEV2ZW50CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCh0aGlzLCAnc3VwZXJfZ29hbGllJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDYWxjdWxhdGUgRWZmZWN0aXZlIENBCiAgICAgICAgICAgIGxldCBjYSA9IHRoaXMuZ2V0U3RhdCgnQ0EnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IFN1cGVyIEdvYWxpZSBCb251cyAoZS5nLiArNTAlICsgRmxhdCAxMCkKICAgICAgICAgICAgaWYgKHRoaXMuaXNTdXBlckdvYWxpZSkgewogICAgICAgICAgICAgICAgY2EgPSAoY2EgKiAxLjUpICsgMTA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IEdyaXAgR2xvdmVzIChQYXNzaXZlKQogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5wYXNzaXZlID09PSAnZ3JpcF9nbG92ZXMnKSB7CiAgICAgICAgICAgICAgICBjYSArPSA1OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDYWxjdWxhdGUgUHJlc3N1cmUKICAgICAgICAgICAgLy8gUHJlc3N1cmUgPSBDQSAqIGR0ICogTXVsdGlwbGllcgogICAgICAgICAgICBjb25zdCBwcmVzc3VyZSA9IGNhICogZHQgKiB0aGlzLnByZXNzdXJlTXVsdGlwbGllcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlciAtPSBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrCiAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZFNhdmUgKz0gcHJlc3N1cmU7CiAgICAgICAgICAgICAgICAvLyBUSFJPVFRMRTogSW5jcmVhc2VkIHRocmVzaG9sZCB0byAxMi4wCiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYWNjdW11bGF0ZWRTYXZlID49IDEyLjApIHsgCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0shIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkU2F2ZSA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFwcGx5IEJhbGwgVGVjaG5pcXVlIHRvIEdvYWxpZSAoUmlzayBvZiBjYXRjaGluZyBzcGVjaWFsIHNob3RzKQovLyBBcHBseSBCYWxsIFRlY2huaXF1ZSB0byBHb2FsaWUgKFJpc2sgb2YgY2F0Y2hpbmcgc3BlY2lhbCBzaG90cykKICAgICAgICAgICAgaWYgKGJhbGwudGVjaG5pcXVlICYmIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgdGhpcy50ZWNoSW1tdW5pdHlUaW1lciA9IDIuMDsKICAgICAgICAgICAgICAgIGNvbnN0IHRlY2ggPSBiYWxsLnRlY2huaXF1ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRlY2gudHlwZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ3Zlbm9tJywgMTUuMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRlY2gudHlwZSA9PT0gJ25hcCcpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCduYXAnLCA4LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICd3aXRoZXInKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseVN0YXR1cygnd2l0aGVyJywgMTUuMCwgJ0NBJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIFJlc3VsdAogICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA8PSAwICYmIHRoaXMuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBDQVRDSAogICAgICAgICAgICAgICAgdGhpcy5jYXRjaEJhbGwoYmFsbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNhdGNoQmFsbChiYWxsKSB7CiAgICAgICAgICAgIGJhbGwuZ3JhYih0aGlzKTsKICAgICAgICAgICAgdGhpcy5wbGF5KCdjYXRjaCcsIDAuMSk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJTQVZFRCBieSAiICsgdGhpcy5yb2xlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVYUCBSRVdBUkQ6IFNhdmUKICAgICAgICAgICAgdGhpcy5nYWluRXhwKDUpOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNBVkVEISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCkgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QoMC4xNSwgJ2hlYXZ5Jyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCB0aHJvdyB0aW1lcgogICAgICAgICAgICB0aGlzLnRocm93VGltZXIgPSAwOwogICAgICAgIH0KCl9haVBvc3Nlc3Npb25Mb2dpYyhkdCkgewogICAgICAgICAgICB0aGlzLnRocm93VGltZXIgKz0gZHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIb2xkIGZvciBhIG1vbWVudCAoMS41cykgdGhlbiB0aHJvdwogICAgICAgICAgICBpZiAodGhpcy50aHJvd1RpbWVyID4gMS41KSB7CiAgICAgICAgICAgICAgICAvLyBGaW5kIGJlc3QgdGFyZ2V0OiBQcmVmZXIgTUYgb3IgRGVmZW5kZXJzLCBidXQgbXVzdCBiZSBzb21ld2hhdCBkaXN0YW50IHRvIGF2b2lkICJoYW5kb2ZmIiBsb29rCiAgICAgICAgICAgICAgICAvLyBGaWx0ZXIgZm9yIHRlYW1tYXRlcyA+IDggdW5pdHMgYXdheSBpZiBwb3NzaWJsZQogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRNYXRlcyA9IHRoaXMudGVhbS5wbGF5ZXJzLmZpbHRlcihwID0+IAogICAgICAgICAgICAgICAgICAgIHAgIT09IHRoaXMgJiYgCiAgICAgICAgICAgICAgICAgICAgcC5tZXNoICYmIAogICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRoaXMubWVzaC5wb3NpdGlvbikgPiA4LjAKICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgbGV0IHRhcmdldCA9IG51bGw7CgogICAgICAgICAgICAgICAgLy8gUHJpb3JpdHkgMTogTWlkZmllbGRlciAoUGxheW1ha2VyKQogICAgICAgICAgICAgICAgdGFyZ2V0ID0gdmFsaWRNYXRlcy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUHJpb3JpdHkgMjogRGVmZW5kZXJzCiAgICAgICAgICAgICAgICBpZiAoIXRhcmdldCkgdGFyZ2V0ID0gdmFsaWRNYXRlcy5maW5kKHAgPT4gcC5yb2xlID09PSAnTEQnIHx8IHAucm9sZSA9PT0gJ1JEJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFByaW9yaXR5IDM6IEFueW9uZSBvcGVuIChmYWxsYmFjayB0byBjbG9zZSByYW5nZSBpZiBubyBvbmUgaXMgZmFyKQogICAgICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHRhcmdldCA9IHRoaXMudGVhbS5wbGF5ZXJzLmZpbmQocCA9PiBwICE9PSB0aGlzICYmIHAucm9sZSAhPT0gJ0dMJyk7CgogICAgICAgICAgICAgICAgaWYgKHRhcmdldCAmJiB0YXJnZXQubWVzaCkgewogICAgICAgICAgICAgICAgICAgIC8vIEFJTUlORyBMT0dJQzogTG9mdCB0aGUgcGFzcwogICAgICAgICAgICAgICAgICAgIC8vIExvb2sgYXQgdGFyZ2V0LCBidXQgYWltIHNsaWdodGx5IHVwIHRvIGNyZWF0ZSBhbiBhcmMKICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRQb3MgPSB0YXJnZXQubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBkaXN0YW5jZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIExvZnQgZmFjdG9yOiBUaGUgZnVydGhlciBhd2F5LCB0aGUgaGlnaGVyIHdlIGFpbQogICAgICAgICAgICAgICAgICAgIC8vIDIwIHVuaXRzIGF3YXkgLT4gQWltIDUgdW5pdHMgYWJvdmUgaGVhZAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxvZnQgPSBNYXRoLm1heCgxLjAsIGRpc3QgKiAwLjI1KTsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MueSArPSBsb2Z0OwoKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KHRhcmdldFBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVGhyb3cKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgJ1BBJyk7IAogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gdGhyb3dzIHRvICR7dGFyZ2V0LnJvbGV9IChEaXN0OiAke2Rpc3QudG9GaXhlZCgxKX0pYCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIENsZWFyIGl0IGZvcndhcmQKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KDAsIDUsIDApOyAvLyBBaW0gdXAtY2VudGVyCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGhyb3dCYWxsKGJhbGwsICdTSCcpOyAvLyBIYXJkIGNsZWFyCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudGhyb3dUaW1lciA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguR29hbGllID0gR29hbGllOwp9KSgpOw==","./Goalie.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgIAogICAgLy8gUmV1c2FibGUgdmVjdG9ycyB0byBhdm9pZCBHQwpjb25zdCBfZ1ZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ1BvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfYmFsbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZmFjZVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ29hbENlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlY0cgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEdvYWxpZSBleHRlbmRzIHdpbmRvdy5mbHV4LlBsYXllciB7CmNvbnN0cnVjdG9yKHNjZW5lLCByb2xlKSB7CiAgICAgICAgICAgIHN1cGVyKHNjZW5lLCByb2xlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdvYWxpZSBTcGVjaWZpYyBTdGF0cyAoQnVmZmVkIGZvciBQbGF5YWJpbGl0eSkKICAgICAgICAgICAgdGhpcy5zdGF0cy5DQSA9IDMwOyAvLyBDYXRjaAogICAgICAgICAgICB0aGlzLnN0YXRzLlNQID0gNDA7IC8vIFNwZWVkCiAgICAgICAgICAgIHRoaXMuc3RhdHMuRU4gPSA1MDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJVRkZFRDogU3Ryb25nIGFybSBmb3IgY2xlYXJpbmcgdGhlIHpvbmUKICAgICAgICAgICAgdGhpcy5zdGF0cy5QQSA9IDQ1OyAvLyBXYXMgMjAgLSBOb3cgc3Ryb25nIGVub3VnaCB0byByZWFjaCBtaWRmaWVsZAogICAgICAgICAgICB0aGlzLnN0YXRzLlNIID0gMzU7IC8vIFdhcyAxMCAtIERlY2VudCBjbGVhcmFuY2Uga2ljawogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CgogICAgICAgICAgICAvLyBHb2FsIERpbWVuc2lvbnMgKFNhdmUgQm94KSAtIE1hdGNoZXMgR2FtZU1hbmFnZXIgZGV0ZWN0aW9uCiAgICAgICAgICAgIHRoaXMuZ29hbFdpZHRoID0gMjIuMDsgCiAgICAgICAgICAgIHRoaXMuZ29hbEhlaWdodCA9IDE4LjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2F2ZSBNZWNoYW5pY3MKICAgICAgICAgICAgdGhpcy5zYXZlUmFkaXVzID0gNi4wOyAKICAgICAgICAgICAgdGhpcy5wcmVzc3VyZU11bHRpcGxpZXIgPSA1LjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVjaHMKICAgICAgICAgICAgdGhpcy50ZWNocyA9IHsKICAgICAgICAgICAgICAgIGFjdGl2ZTogbnVsbCwgCiAgICAgICAgICAgICAgICBwYXNzaXZlOiBudWxsIAogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQUkgU3RhdGUKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRTYXZlID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN1cGVyIEdvYWxpZSBTdGF0ZQogICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyID0gMDsKCi8vIFBlcmNlcHRpb24gU21vb3RoaW5nIChSZWFjdGlvbiBEZWxheSkKICAgICAgICAgICAgdGhpcy5wZXJjZWl2ZWRCYWxsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5yZWFjdGlvblNwZWVkID0gNC4wOyAvLyBMb3dlciA9IG1vcmUgZGVsYXkvc21vb3RoaW5nCiAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAwOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIDEuIFN1cGVyIEdvYWxpZSBUaW1lcgogICAgICAgICAgICBpZiAodGhpcy5pc1N1cGVyR29hbGllKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN1cGVyR29hbGllVGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdXBlckdvYWxpZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMi4gUG9zc2Vzc2lvbiBMb2dpYyAoQmFsbCBIZWxkKQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jaGVja1RhY2tsZVByZXNzdXJlKGR0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgICAgIGNvbnN0IGlzSHVtYW5Db250cm9sbGVkID0gdGhpcy50ZWFtICYmIHRoaXMudGVhbS5pc0h1bWFuICYmIHRoaXMudGVhbS5hY3RpdmVQbGF5ZXIgPT09IHRoaXMgJiYgIWdhbWUuaXNEZW1vTW9kZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGlzSHVtYW5Db250cm9sbGVkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSHVtYW46IEZ1bGwgY29udHJvbCAoUm90YXRpb24sIENoYXJnaW5nLCBldGMgdmlhIFBsYXllci51cGRhdGUpCiAgICAgICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQUk6IExvZ2ljIHRoZW4gdXBkYXRlCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWlQb3NzZXNzaW9uTG9naWMoZHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgQUkgZG9lc24ndCBkcmlmdAogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2NvbnN0cmFpbkJvdW5kcygpOwogICAgICAgICAgICAgICAgcmV0dXJuOyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gRGVmZW5zZSAvIFNhdmUgTG9naWMgKE5vIEJhbGwpCiAgICAgICAgICAgIC8vIFdlIG11c3QgaGFuZGxlIHRpbWVycyBhbmQgc3RhdHVzIG1hbnVhbGx5IGJlY2F1c2Ugd2Ugc2tpcCBzdXBlci51cGRhdGUoKSB0byB1c2UgY3VzdG9tIG1vdmVtZW50CiAgICAgICAgICAgIGlmICh0aGlzLmRhc2hDb29sZG93biA+IDApIHRoaXMuZGFzaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5jbGFzaENvb2xkb3duID4gMCkgdGhpcy5jbGFzaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5zdHVuVGltZXIgPiAwKSB0aGlzLnN0dW5UaW1lciAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHRoaXMuaW1tdW5pdHlUaW1lciAtPSBkdDsKaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHRoaXMuaW1tdW5pdHlUaW1lciAtPSBkdDsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzKGR0KTsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0dW5UaW1lciA+IDAgfHwgdGhpcy5zdGF0dXMubmFwID4gMCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhQQmFyKCk7CiAgICAgICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ3VzdG9tIE1vdmVtZW50CiAgICAgICAgICAgIHRoaXMuX2RlZmVuc2VMb2dpYyhkdCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgQW5pbWF0aW9uCiAgICAgICAgICAgIGlmICh0aGlzLm1peGVyKSB0aGlzLm1peGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhQQmFyKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICB9CgpfY29uc3RyYWluQm91bmRzKCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IHNpZGUgPSB0aGlzLnRlYW0gPyB0aGlzLnRlYW0uc2lkZSA6IDE7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBYIEJvdW5kcyAoV2lkdGggb2YgcGVuYWx0eSBhcmVhICsvLSAxMG0pIC0+IEluY3JlYXNlZCBmb3IgbWFzc2l2ZSBnb2FsCmNvbnN0IHhMaW1pdCA9IDIwLjA7IC8vIFJlZHVjZWQgd2lkdGggb2YgZ29hbGllIG1vdmVtZW50CiAgICAgICAgICAgIGlmIChwb3MueCA+IHhMaW1pdCkgeyBwb3MueCA9IHhMaW1pdDsgdGhpcy52ZWxvY2l0eS54ID0gMDsgfQogICAgICAgICAgICBpZiAocG9zLnggPCAteExpbWl0KSB7IHBvcy54ID0gLXhMaW1pdDsgdGhpcy52ZWxvY2l0eS54ID0gMDsgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gWSBCb3VuZHMKICAgICAgICAgICAgY29uc3QgeUxpbWl0ID0gMTIuMDsgLy8gUmVkdWNlZCBoZWlnaHQgY2VpbGluZwogICAgICAgICAgICBpZiAocG9zLnkgPiB5TGltaXQpIHsgcG9zLnkgPSB5TGltaXQ7IHRoaXMudmVsb2NpdHkueSA9IDA7IH0KICAgICAgICAgICAgaWYgKHBvcy55IDwgLXlMaW1pdCkgeyBwb3MueSA9IC15TGltaXQ7IHRoaXMudmVsb2NpdHkueSA9IDA7IH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFogQm91bmRzIChEZXB0aCkKLy8gWiBCb3VuZHMgKERlcHRoKQogICAgICAgICAgICAvLyBIb21lIChTaWRlIDEpOiBHb2FsIGF0ICs0Ni4gVHJpZ2dlciBhdCA0NS4gTGltaXQgdG8gNDUuNS4KICAgICAgICAgICAgLy8gQXdheSAoU2lkZSAtMSk6IEdvYWwgYXQgLTQ2LiBUcmlnZ2VyIGF0IC00NS4gTGltaXQgdG8gLTQ1LjUuCiAgICAgICAgICAgIGlmIChzaWRlID09PSAxKSB7CiAgICAgICAgICAgICAgICBpZiAocG9zLnogPiA0NS41KSB7IHBvcy56ID0gNDUuNTsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICAgICAgaWYgKHBvcy56IDwgMjAuMCkgeyBwb3MueiA9IDIwLjA7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IC00NS41KSB7IHBvcy56ID0gLTQ1LjU7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IC0yMC4wKSB7IHBvcy56ID0gLTIwLjA7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgfQogICAgICAgIH0KCi8vIE92ZXJyaWRlIHRocm93QmFsbCB0byBmaXggIndlYWsgdGhyb3ciIGlzc3VlCi8vIE92ZXJyaWRlIHRocm93QmFsbCB0byBmaXggIndlYWsgdGhyb3ciIGlzc3VlIGFuZCByZWR1Y2UgbG9mdAogICAgICAgIHRocm93QmFsbChiYWxsLCBmb3JjZWRUeXBlID0gbnVsbCwgcG93ZXJNdWx0aXBsaWVyID0gMS4wKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gdHJ1ZTsKICAgICAgICAgICAgY29uc3QgdHlwZSA9IGZvcmNlZFR5cGUgfHwgJ1BBJzsKICAgICAgICAgICAgY29uc3QgYm9vc3QgPSAxLjI7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsUG93ZXIgPSBwb3dlck11bHRpcGxpZXIgKiBib29zdDsKCiAgICAgICAgICAgIC8vIEFuaW1hdGlvbgogICAgICAgICAgICBjb25zdCB0aHJvd0tleSA9ICh0eXBlID09PSAnU0gnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfc2hvdCddKSA/ICd0aHJvd19zaG90JyA6ICd0aHJvd19wYXNzJzsKICAgICAgICAgICAgdGhpcy5wbGF5T25lU2hvdCh0aHJvd0tleSwgMC4xLCB7IHRpbWVTY2FsZTogMS4yIH0pOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNMRUFSISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWFjdGlvbiIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgfHwgKGJhbGwgJiYgYmFsbC5ob2xkZXIgPT09IHRoaXMpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIERpcmVjdGlvbgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbmFsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSRURVQ0VEIExPRlQ6IEdvYWxpZSB0aHJvd3MgZmxhdHRlciAoMC4yNSBpbnN0ZWFkIG9mIDAuOCkKICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMjU7IAogICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgU3RhdHMKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdFZhbCA9IHRoaXMuZ2V0U3RhdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IGZpbmFsUG93ZXI7CgogICAgICAgICAgICAgICAgICAgIGJhbGwuc2hvb3QoZmluYWxEaXIsIHN0YXRWYWwsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEV4dHJhIGdyYWNlIHBlcmlvZCBmb3IgR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFsbC5jYXRjaEdyYWNlUGVyaW9kID0gMC42OwoKICAgICAgICAgICAgICAgICAgICB0aGlzLmxvc2VCYWxsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duID0gMS4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAzMDApOyAvLyBXaW5kdXAgdGltZQoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CiAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgfQoKX2RlZmVuc2VMb2dpYyhkdCkgewogICAgICAgICAgICAvLyAwLiBHYW1lIFN0YXRlIENoZWNrCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyAtLS0gUEVSQ0VQVElPTiBVUERBVEUgLS0tCiAgICAgICAgICAgIC8vIFNtb290aGx5IGludGVycG9sYXRlIHBlcmNlaXZlZCBwb3NpdGlvbiB0b3dhcmRzIHJlYWwgYmFsbCBwb3NpdGlvbgogICAgICAgICAgICAvLyBUaGlzIGNyZWF0ZXMgYSBuYXR1cmFsIHJlYWN0aW9uIGRlbGF5IGFuZCBwcmV2ZW50cyBqaXR0ZXJ5IG1pcnJvcmluZwogICAgICAgICAgICB0aGlzLnBlcmNlaXZlZEJhbGxQb3MubGVycChiYWxsLm1lc2gucG9zaXRpb24sIGR0ICogdGhpcy5yZWFjdGlvblNwZWVkKTsKCiAgICAgICAgICAgIC8vIERldGVybWluZSBUaHJlYXQgU291cmNlCiAgICAgICAgICAgIGxldCB0aHJlYXRQb3MgPSBfYmFsbFBvczsKICAgICAgICAgICAgbGV0IGlzVGhyZWF0ID0gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IG15R29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gNDYgOiAtNDY7CgogICAgICAgICAgICAvLyBDYXNlIEE6IEJhbGwgaXMgSGVsZCAoUHJlLXRocm93KQogICAgICAgICAgICBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2hlbGQnICYmIGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgLy8gVHJhY2sgaG9sZGVyLCBidXQgdXNlIHBlcmNlaXZlZCBwb3NpdGlvbiBpZiB3ZSB3YW50ZWQgdG8gc2ltdWxhdGUgcmVhZGluZyB0aGUgcGxheWVyCiAgICAgICAgICAgICAgICAvLyBGb3Igbm93LCB0cmFja2luZyB0aGUgYmFsbCAod2hpY2ggaXMgb24gdGhlIHBsYXllcikgdmlhIHBlcmNlaXZlZFBvcyBpcyBzdWZmaWNpZW50CiAgICAgICAgICAgICAgICB0aHJlYXRQb3MgPSB0aGlzLnBlcmNlaXZlZEJhbGxQb3M7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGhvbGRlciBpcyBpbiBhdHRhY2tpbmcgaGFsZiBvciBuZWFyIGVub3VnaAogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRocmVhdFBvcy56IC0gbXlHb2FsWik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvR29hbCA8IDQwLjApIHsgLy8gSWYgdGhleSBhcmUgd2l0aGluIDQwbSwgdHJhY2sgdGhlbQogICAgICAgICAgICAgICAgICAgIGlzVGhyZWF0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSAKICAgICAgICAgICAgLy8gQ2FzZSBCOiBCYWxsIGlzIEZyZWUgKFNob3QvUGFzcykKICAgICAgICAgICAgZWxzZSBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICB0aHJlYXRQb3MgPSB0aGlzLnBlcmNlaXZlZEJhbGxQb3M7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERpcmVjdGlvbiBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgbW92aW5nVG93YXJkcyA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSAmJiBiYWxsLnZlbG9jaXR5LnogPiAwKSB8fCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAodGhpcy50ZWFtLnNpZGUgPT09IC0xICYmIGJhbGwudmVsb2NpdHkueiA8IDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQb3NpdGlvbiBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgaW5Gcm9udE9mR29hbCA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSAmJiB0aHJlYXRQb3MueiA8IDQ1LjApIHx8IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLnRlYW0uc2lkZSA9PT0gLTEgJiYgdGhyZWF0UG9zLnogPiAtNDUuMCk7CgogICAgICAgICAgICAgICAgaXNUaHJlYXQgPSBtb3ZpbmdUb3dhcmRzICYmIGluRnJvbnRPZkdvYWw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzVGhyZWF0KSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gUE9TSVRJT05JTkc6IEFOR0xFIENVVFRJTkcgLS0tCiAgICAgICAgICAgICAgICBfYmFsbFBvcy5jb3B5KHRocmVhdFBvcyk7IC8vIFVwZGF0ZSByZWZlcmVuY2UgZm9yIGxvb2tBdAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAxLiBDYWxjdWxhdGUgR29hbCBDZW50ZXIKLy8gMS4gQ2FsY3VsYXRlIEdvYWwgQ2VudGVyIChBZGp1c3RlZCBmb3IgWSBvZmZzZXQpCl9nb2FsQ2VudGVyLnNldCgwLCAtNC41LCBteUdvYWxaKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMi4gVmVjdG9yIGZyb20gR29hbCB0byBCYWxsCiAgICAgICAgICAgICAgICBfdGVtcFZlY0cuc3ViVmVjdG9ycyhfYmFsbFBvcywgX2dvYWxDZW50ZXIpOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IF90ZW1wVmVjRy5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjRy5ub3JtYWxpemUoKTsgLy8gTm93IGhvbGRzIGRpcmVjdGlvbgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAzLiBEZXRlcm1pbmUgRXh0ZW5zaW9uIChIb3cgZmFyIG91dCB0byBzdGVwKQogICAgICAgICAgICAgICAgLy8gQmFzZTogMS41bSBvZmYgbGluZS4KICAgICAgICAgICAgICAgIC8vIE1heDogNi4wbSBvZmYgbGluZSAoQ3V0dGluZyBhbmdsZSkuCiAgICAgICAgICAgICAgICAvLyBTY2FsZSBiYXNlZCBvbiBiYWxsIHByb3hpbWl0eTogQ2xvc2VyIGJhbGwgPSBNb3JlIGV4dGVuc2lvbiAodG8gYSBwb2ludCkKbGV0IGV4dGVuc2lvbiA9IDEuNTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMzAuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gMS4wIC0gKE1hdGgubWF4KDAsIGRpc3RUb0JhbGwgLSA1LjApIC8gMjUuMCk7IAogICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbiA9IDEuNSArICg0LjUgKiByYXRpbyk7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCi8vIFNhZmV0eTogRG9uJ3QgZ28gcGFzdCB0aGUgYmFsbCAoa2VlcCAxbSBidWZmZXIpCiAgICAgICAgICAgICAgICBleHRlbnNpb24gPSBNYXRoLm1pbihleHRlbnNpb24sIGRpc3RUb0JhbGwgLSAxLjApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyA0LiBDYWxjdWxhdGUgVGFyZ2V0IFBvc2l0aW9uIChCYXNlIEludGVyY2VwdGlvbikKICAgICAgICAgICAgICAgIF9nUG9zLmNvcHkoX2dvYWxDZW50ZXIpLmFkZChfdGVtcFZlY0cubXVsdGlwbHlTY2FsYXIoZXh0ZW5zaW9uKSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDUuIFZlcnRpY2FsIE92ZXJyaWRlIChKdW1wIHRvIG1lZXQgYmFsbCkKICAgICAgICAgICAgICAgIC8vIEV4cGxpY2l0bHkgc2V0IFkgdG8gbWF0Y2ggYmFsbCBoZWlnaHQgaWYgaXQncyBoaWdoCiAgICAgICAgICAgICAgICBpZiAoX2JhbGxQb3MueSA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIF9nUG9zLnkgPSBfYmFsbFBvcy55OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gMC41OyAvLyBEZWZhdWx0IHN0YW5jZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDYuIENsYW1wIHRvIEdvYWwgQm94IERpbWVuc2lvbnMgKExhdGVyYWwvVmVydGljYWwgTGltaXRzKQogICAgICAgICAgICAgICAgLy8gR29hbCBXaWR0aCAyMiAoKy8tIDExKSwgSGVpZ2h0IDE4ICgrLy0gOSkuCiAgICAgICAgICAgICAgICAvLyBBbGxvdyBzbGlnaHRseSBvdXRzaWRlIHBvc3RzIHRvIGNvdmVyIGFuZ2xlcy4KICAgICAgICAgICAgICAgIGNvbnN0IGNsYW1wWCA9IHRoaXMuZ29hbFdpZHRoICogMC42OyAvLyArLy0gMTMuMgpjb25zdCBjbGFtcFkgPSAxMi4wOyAvLyBSZWR1Y2VkIG1heCBqdW1wIGhlaWdodAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfZ1Bvcy54ID0gTWF0aC5tYXgoLWNsYW1wWCwgTWF0aC5taW4oY2xhbXBYLCBfZ1Bvcy54KSk7CiAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gTWF0aC5tYXgoLWNsYW1wWSwgTWF0aC5taW4oY2xhbXBZLCBfZ1Bvcy55KSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDYuIExlYWQgdGhlIGJhbGwgc2xpZ2h0bHkgaWYgaXQgaGFzIGxhdGVyYWwgdmVsb2NpdHkgKEFudGljaXBhdGlvbikKaWYgKGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDEuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFudGljaXBhdGlvbiA9IGJhbGwudmVsb2NpdHkuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigwLjI1KTsgLy8gMC4yNXMgbGVhZAogICAgICAgICAgICAgICAgICAgIGFudGljaXBhdGlvbi56ID0gMDsgLy8gT25seSBsYXRlcmFsIGxlYWQKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy5hZGQoYW50aWNpcGF0aW9uKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAppZiAodGhpcy50ZWFtLnNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy56ID0gTWF0aC5taW4oNDUuNSwgX2dQb3Mueik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9nUG9zLnogPSBNYXRoLm1heCgtNDUuNSwgX2dQb3Mueik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTW92ZSB0b3dhcmRzIHRhcmdldAogICAgICAgICAgICAgICAgY29uc3QgbW92ZURpciA9IF9nVmVjLnN1YlZlY3RvcnMoX2dQb3MsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9UYXJnZXQgPSBtb3ZlRGlyLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvVGFyZ2V0ID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgbW92ZURpci5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAvLyBCdXJzdCBzcGVlZCBmb3Igc2F2ZXMgaWYgYmFsbCBpcyBjbG9zZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHVyZ2VuY3kgPSAoZGlzdFRvQmFsbCA8IDEwLjApID8gMS41IDogMS4wOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gdGhpcy5tYXhTcGVlZCAqIHVyZ2VuY3k7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChtb3ZlRGlyLm11bHRpcGx5U2NhbGFyKHNwZWVkICogZHQpKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBGYWNlIGJhbGwKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KF9iYWxsUG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ3N3aW0nKSB0aGlzLnBsYXkoJ3N3aW0nLCAwLjIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ2lkbGUnKSB0aGlzLnBsYXkoJ2lkbGUnLCAwLjIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoX2JhbGxQb3MpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIC0tLSBTQVZFIE1FQ0hBTklDIC0tLQogICAgICAgICAgICAgICAgLy8gSWYgYmFsbCBpcyB3aXRoaW4gcmFuZ2UsIGFwcGx5IENBIHByZXNzdXJlCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgdGhpcy5zYXZlUmFkaXVzKSB7IAogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5U2F2ZVByZXNzdXJlKGJhbGwsIGR0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBJRExFIC8gUkVUVVJOIFRPIFBPU1QgLS0tCiAgICAgICAgICAgICAgICAvLyBSZXR1cm4gdG8gaG9tZSBwb3NpdGlvbiAodXN1YWxseSBjZW50ZXIgb2YgZ29hbCkKICAgICAgICAgICAgICAgIF9nUG9zLmNvcHkodGhpcy5ob21lUG9zaXRpb24pOwogICAgICAgICAgICAgICAgY29uc3QgbW92ZURpciA9IF9nVmVjLnN1YlZlY3RvcnMoX2dQb3MsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChtb3ZlRGlyLmxlbmd0aCgpID4gMC41KSB7CiAgICAgICAgICAgICAgICAgICAgbW92ZURpci5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKG1vdmVEaXIubXVsdGlwbHlTY2FsYXIodGhpcy5tYXhTcGVlZCAqIDAuNiAqIGR0KSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdzd2ltJykgdGhpcy5wbGF5KCdzd2ltJywgMC4yKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpZGxlJykgdGhpcy5wbGF5KCdpZGxlJywgMC4yKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmFjZSBjZW50ZXIgZmllbGQKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9hcHBseVNhdmVQcmVzc3VyZShiYWxsLCBkdCkgewogICAgICAgICAgICAvLyBJZiBHb2FsaWUgaXMgQXNsZWVwLCB0aGV5IGNhbm5vdCBzYXZlLgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gLS0tIFNVUEVSIEdPQUxJRSBUUklHR0VSIC0tLQogICAgICAgICAgICAvLyBUcmlnZ2VyIGlmOiBUZWNoIGVxdWlwcGVkLCBOb3QgYWN0aXZlLCBCYWxsIGhhcyBwb3dlciwgQmFsbCBpcyBjbG9zZQogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5hY3RpdmUgPT09ICdzdXBlcl9nb2FsaWUnICYmICF0aGlzLmlzU3VwZXJHb2FsaWUgJiYgYmFsbC5wb3dlciA+IDUuMCkgewogICAgICAgICAgICAgICAgLy8gQ2hhbmNlIHRvIHRyaWdnZXIgKEhpZ2ggY2hhbmNlIGZvciBBSSwgb3IgY2hlY2sgSFApCiAgICAgICAgICAgICAgICAvLyBDb3N0OiAxMCBIUAogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPj0gMTApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IDEwOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNTdXBlckdvYWxpZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyID0gMS41OyAvLyBMYXN0cyAxLjVzCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSB1c2VkIFNVUEVSIEdPQUxJRSFgKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTVVBFUiBHT0FMSUUhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic2F2ZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIFRlY2hjb3B5IEV2ZW50CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCh0aGlzLCAnc3VwZXJfZ29hbGllJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDYWxjdWxhdGUgRWZmZWN0aXZlIENBCiAgICAgICAgICAgIGxldCBjYSA9IHRoaXMuZ2V0U3RhdCgnQ0EnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IFN1cGVyIEdvYWxpZSBCb251cyAoZS5nLiArNTAlICsgRmxhdCAxMCkKICAgICAgICAgICAgaWYgKHRoaXMuaXNTdXBlckdvYWxpZSkgewogICAgICAgICAgICAgICAgY2EgPSAoY2EgKiAxLjUpICsgMTA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IEdyaXAgR2xvdmVzIChQYXNzaXZlKQogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5wYXNzaXZlID09PSAnZ3JpcF9nbG92ZXMnKSB7CiAgICAgICAgICAgICAgICBjYSArPSA1OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDYWxjdWxhdGUgUHJlc3N1cmUKICAgICAgICAgICAgLy8gUHJlc3N1cmUgPSBDQSAqIGR0ICogTXVsdGlwbGllcgogICAgICAgICAgICBjb25zdCBwcmVzc3VyZSA9IGNhICogZHQgKiB0aGlzLnByZXNzdXJlTXVsdGlwbGllcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlciAtPSBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrCiAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZFNhdmUgKz0gcHJlc3N1cmU7CiAgICAgICAgICAgICAgICAvLyBUSFJPVFRMRTogSW5jcmVhc2VkIHRocmVzaG9sZCB0byAxMi4wCiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYWNjdW11bGF0ZWRTYXZlID49IDEyLjApIHsgCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0shIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkU2F2ZSA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFwcGx5IEJhbGwgVGVjaG5pcXVlIHRvIEdvYWxpZSAoUmlzayBvZiBjYXRjaGluZyBzcGVjaWFsIHNob3RzKQovLyBBcHBseSBCYWxsIFRlY2huaXF1ZSB0byBHb2FsaWUgKFJpc2sgb2YgY2F0Y2hpbmcgc3BlY2lhbCBzaG90cykKICAgICAgICAgICAgaWYgKGJhbGwudGVjaG5pcXVlICYmIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgdGhpcy50ZWNoSW1tdW5pdHlUaW1lciA9IDIuMDsKICAgICAgICAgICAgICAgIGNvbnN0IHRlY2ggPSBiYWxsLnRlY2huaXF1ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRlY2gudHlwZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ3Zlbm9tJywgMTUuMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRlY2gudHlwZSA9PT0gJ25hcCcpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCduYXAnLCA4LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICd3aXRoZXInKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseVN0YXR1cygnd2l0aGVyJywgMTUuMCwgJ0NBJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIFJlc3VsdAogICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA8PSAwICYmIHRoaXMuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBDQVRDSAogICAgICAgICAgICAgICAgdGhpcy5jYXRjaEJhbGwoYmFsbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNhdGNoQmFsbChiYWxsKSB7CiAgICAgICAgICAgIGJhbGwuZ3JhYih0aGlzKTsKICAgICAgICAgICAgdGhpcy5wbGF5KCdjYXRjaCcsIDAuMSk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJTQVZFRCBieSAiICsgdGhpcy5yb2xlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVYUCBSRVdBUkQ6IFNhdmUKICAgICAgICAgICAgdGhpcy5nYWluRXhwKDUpOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNBVkVEISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCkgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QoMC4xNSwgJ2hlYXZ5Jyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCB0aHJvdyB0aW1lcgogICAgICAgICAgICB0aGlzLnRocm93VGltZXIgPSAwOwogICAgICAgIH0KCl9haVBvc3Nlc3Npb25Mb2dpYyhkdCkgewogICAgICAgICAgICB0aGlzLnRocm93VGltZXIgKz0gZHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIb2xkIGZvciBhIG1vbWVudCAoMS41cykgdGhlbiB0aHJvdwogICAgICAgICAgICBpZiAodGhpcy50aHJvd1RpbWVyID4gMS41KSB7CiAgICAgICAgICAgICAgICAvLyBGaW5kIGJlc3QgdGFyZ2V0OiBQcmVmZXIgTUYgb3IgRGVmZW5kZXJzLCBidXQgbXVzdCBiZSBzb21ld2hhdCBkaXN0YW50IHRvIGF2b2lkICJoYW5kb2ZmIiBsb29rCiAgICAgICAgICAgICAgICAvLyBGaWx0ZXIgZm9yIHRlYW1tYXRlcyA+IDggdW5pdHMgYXdheSBpZiBwb3NzaWJsZQogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRNYXRlcyA9IHRoaXMudGVhbS5wbGF5ZXJzLmZpbHRlcihwID0+IAogICAgICAgICAgICAgICAgICAgIHAgIT09IHRoaXMgJiYgCiAgICAgICAgICAgICAgICAgICAgcC5tZXNoICYmIAogICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRoaXMubWVzaC5wb3NpdGlvbikgPiA4LjAKICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgbGV0IHRhcmdldCA9IG51bGw7CgogICAgICAgICAgICAgICAgLy8gUHJpb3JpdHkgMTogTWlkZmllbGRlciAoUGxheW1ha2VyKQogICAgICAgICAgICAgICAgdGFyZ2V0ID0gdmFsaWRNYXRlcy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUHJpb3JpdHkgMjogRGVmZW5kZXJzCiAgICAgICAgICAgICAgICBpZiAoIXRhcmdldCkgdGFyZ2V0ID0gdmFsaWRNYXRlcy5maW5kKHAgPT4gcC5yb2xlID09PSAnTEQnIHx8IHAucm9sZSA9PT0gJ1JEJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFByaW9yaXR5IDM6IEFueW9uZSBvcGVuIChmYWxsYmFjayB0byBjbG9zZSByYW5nZSBpZiBubyBvbmUgaXMgZmFyKQogICAgICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHRhcmdldCA9IHRoaXMudGVhbS5wbGF5ZXJzLmZpbmQocCA9PiBwICE9PSB0aGlzICYmIHAucm9sZSAhPT0gJ0dMJyk7CgogICAgICAgICAgICAgICAgaWYgKHRhcmdldCAmJiB0YXJnZXQubWVzaCkgewogICAgICAgICAgICAgICAgICAgIC8vIEFJTUlORyBMT0dJQzogTG9mdCB0aGUgcGFzcwogICAgICAgICAgICAgICAgICAgIC8vIExvb2sgYXQgdGFyZ2V0LCBidXQgYWltIHNsaWdodGx5IHVwIHRvIGNyZWF0ZSBhbiBhcmMKICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRQb3MgPSB0YXJnZXQubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBkaXN0YW5jZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIExvZnQgZmFjdG9yOiBUaGUgZnVydGhlciBhd2F5LCB0aGUgaGlnaGVyIHdlIGFpbQogICAgICAgICAgICAgICAgICAgIC8vIDIwIHVuaXRzIGF3YXkgLT4gQWltIDUgdW5pdHMgYWJvdmUgaGVhZAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxvZnQgPSBNYXRoLm1heCgxLjAsIGRpc3QgKiAwLjI1KTsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MueSArPSBsb2Z0OwoKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KHRhcmdldFBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVGhyb3cKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgJ1BBJyk7IAogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gdGhyb3dzIHRvICR7dGFyZ2V0LnJvbGV9IChEaXN0OiAke2Rpc3QudG9GaXhlZCgxKX0pYCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIENsZWFyIGl0IGZvcndhcmQKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KDAsIDUsIDApOyAvLyBBaW0gdXAtY2VudGVyCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGhyb3dCYWxsKGJhbGwsICdTSCcpOyAvLyBIYXJkIGNsZWFyCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudGhyb3dUaW1lciA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguR29hbGllID0gR29hbGllOwp9KSgpOw==","/Goalie.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgIAogICAgLy8gUmV1c2FibGUgdmVjdG9ycyB0byBhdm9pZCBHQwpjb25zdCBfZ1ZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ1BvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfYmFsbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZmFjZVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ29hbENlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlY0cgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEdvYWxpZSBleHRlbmRzIHdpbmRvdy5mbHV4LlBsYXllciB7CmNvbnN0cnVjdG9yKHNjZW5lLCByb2xlKSB7CiAgICAgICAgICAgIHN1cGVyKHNjZW5lLCByb2xlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdvYWxpZSBTcGVjaWZpYyBTdGF0cyAoQnVmZmVkIGZvciBQbGF5YWJpbGl0eSkKICAgICAgICAgICAgdGhpcy5zdGF0cy5DQSA9IDMwOyAvLyBDYXRjaAogICAgICAgICAgICB0aGlzLnN0YXRzLlNQID0gNDA7IC8vIFNwZWVkCiAgICAgICAgICAgIHRoaXMuc3RhdHMuRU4gPSA1MDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJVRkZFRDogU3Ryb25nIGFybSBmb3IgY2xlYXJpbmcgdGhlIHpvbmUKICAgICAgICAgICAgdGhpcy5zdGF0cy5QQSA9IDQ1OyAvLyBXYXMgMjAgLSBOb3cgc3Ryb25nIGVub3VnaCB0byByZWFjaCBtaWRmaWVsZAogICAgICAgICAgICB0aGlzLnN0YXRzLlNIID0gMzU7IC8vIFdhcyAxMCAtIERlY2VudCBjbGVhcmFuY2Uga2ljawogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CgogICAgICAgICAgICAvLyBHb2FsIERpbWVuc2lvbnMgKFNhdmUgQm94KSAtIE1hdGNoZXMgR2FtZU1hbmFnZXIgZGV0ZWN0aW9uCiAgICAgICAgICAgIHRoaXMuZ29hbFdpZHRoID0gMjIuMDsgCiAgICAgICAgICAgIHRoaXMuZ29hbEhlaWdodCA9IDE4LjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2F2ZSBNZWNoYW5pY3MKICAgICAgICAgICAgdGhpcy5zYXZlUmFkaXVzID0gNi4wOyAKICAgICAgICAgICAgdGhpcy5wcmVzc3VyZU11bHRpcGxpZXIgPSA1LjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVjaHMKICAgICAgICAgICAgdGhpcy50ZWNocyA9IHsKICAgICAgICAgICAgICAgIGFjdGl2ZTogbnVsbCwgCiAgICAgICAgICAgICAgICBwYXNzaXZlOiBudWxsIAogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQUkgU3RhdGUKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRTYXZlID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN1cGVyIEdvYWxpZSBTdGF0ZQogICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyID0gMDsKCi8vIFBlcmNlcHRpb24gU21vb3RoaW5nIChSZWFjdGlvbiBEZWxheSkKICAgICAgICAgICAgdGhpcy5wZXJjZWl2ZWRCYWxsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5yZWFjdGlvblNwZWVkID0gNC4wOyAvLyBMb3dlciA9IG1vcmUgZGVsYXkvc21vb3RoaW5nCiAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAwOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIDEuIFN1cGVyIEdvYWxpZSBUaW1lcgogICAgICAgICAgICBpZiAodGhpcy5pc1N1cGVyR29hbGllKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN1cGVyR29hbGllVGltZXIgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdXBlckdvYWxpZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMi4gUG9zc2Vzc2lvbiBMb2dpYyAoQmFsbCBIZWxkKQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jaGVja1RhY2tsZVByZXNzdXJlKGR0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgICAgIGNvbnN0IGlzSHVtYW5Db250cm9sbGVkID0gdGhpcy50ZWFtICYmIHRoaXMudGVhbS5pc0h1bWFuICYmIHRoaXMudGVhbS5hY3RpdmVQbGF5ZXIgPT09IHRoaXMgJiYgIWdhbWUuaXNEZW1vTW9kZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGlzSHVtYW5Db250cm9sbGVkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSHVtYW46IEZ1bGwgY29udHJvbCAoUm90YXRpb24sIENoYXJnaW5nLCBldGMgdmlhIFBsYXllci51cGRhdGUpCiAgICAgICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQUk6IExvZ2ljIHRoZW4gdXBkYXRlCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWlQb3NzZXNzaW9uTG9naWMoZHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgQUkgZG9lc24ndCBkcmlmdAogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2NvbnN0cmFpbkJvdW5kcygpOwogICAgICAgICAgICAgICAgcmV0dXJuOyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gRGVmZW5zZSAvIFNhdmUgTG9naWMgKE5vIEJhbGwpCiAgICAgICAgICAgIC8vIFdlIG11c3QgaGFuZGxlIHRpbWVycyBhbmQgc3RhdHVzIG1hbnVhbGx5IGJlY2F1c2Ugd2Ugc2tpcCBzdXBlci51cGRhdGUoKSB0byB1c2UgY3VzdG9tIG1vdmVtZW50CiAgICAgICAgICAgIGlmICh0aGlzLmRhc2hDb29sZG93biA+IDApIHRoaXMuZGFzaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5jbGFzaENvb2xkb3duID4gMCkgdGhpcy5jbGFzaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5zdHVuVGltZXIgPiAwKSB0aGlzLnN0dW5UaW1lciAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHRoaXMuaW1tdW5pdHlUaW1lciAtPSBkdDsKaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHRoaXMuaW1tdW5pdHlUaW1lciAtPSBkdDsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzKGR0KTsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0dW5UaW1lciA+IDAgfHwgdGhpcy5zdGF0dXMubmFwID4gMCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhQQmFyKCk7CiAgICAgICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ3VzdG9tIE1vdmVtZW50CiAgICAgICAgICAgIHRoaXMuX2RlZmVuc2VMb2dpYyhkdCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgQW5pbWF0aW9uCiAgICAgICAgICAgIGlmICh0aGlzLm1peGVyKSB0aGlzLm1peGVyLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhQQmFyKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICB9CgpfY29uc3RyYWluQm91bmRzKCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IHNpZGUgPSB0aGlzLnRlYW0gPyB0aGlzLnRlYW0uc2lkZSA6IDE7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBYIEJvdW5kcyAoV2lkdGggb2YgcGVuYWx0eSBhcmVhICsvLSAxMG0pIC0+IEluY3JlYXNlZCBmb3IgbWFzc2l2ZSBnb2FsCmNvbnN0IHhMaW1pdCA9IDIwLjA7IC8vIFJlZHVjZWQgd2lkdGggb2YgZ29hbGllIG1vdmVtZW50CiAgICAgICAgICAgIGlmIChwb3MueCA+IHhMaW1pdCkgeyBwb3MueCA9IHhMaW1pdDsgdGhpcy52ZWxvY2l0eS54ID0gMDsgfQogICAgICAgICAgICBpZiAocG9zLnggPCAteExpbWl0KSB7IHBvcy54ID0gLXhMaW1pdDsgdGhpcy52ZWxvY2l0eS54ID0gMDsgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gWSBCb3VuZHMKICAgICAgICAgICAgY29uc3QgeUxpbWl0ID0gMTIuMDsgLy8gUmVkdWNlZCBoZWlnaHQgY2VpbGluZwogICAgICAgICAgICBpZiAocG9zLnkgPiB5TGltaXQpIHsgcG9zLnkgPSB5TGltaXQ7IHRoaXMudmVsb2NpdHkueSA9IDA7IH0KICAgICAgICAgICAgaWYgKHBvcy55IDwgLXlMaW1pdCkgeyBwb3MueSA9IC15TGltaXQ7IHRoaXMudmVsb2NpdHkueSA9IDA7IH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFogQm91bmRzIChEZXB0aCkKLy8gWiBCb3VuZHMgKERlcHRoKQogICAgICAgICAgICAvLyBIb21lIChTaWRlIDEpOiBHb2FsIGF0ICs0Ni4gVHJpZ2dlciBhdCA0NS4gTGltaXQgdG8gNDUuNS4KICAgICAgICAgICAgLy8gQXdheSAoU2lkZSAtMSk6IEdvYWwgYXQgLTQ2LiBUcmlnZ2VyIGF0IC00NS4gTGltaXQgdG8gLTQ1LjUuCiAgICAgICAgICAgIGlmIChzaWRlID09PSAxKSB7CiAgICAgICAgICAgICAgICBpZiAocG9zLnogPiA0NS41KSB7IHBvcy56ID0gNDUuNTsgdGhpcy52ZWxvY2l0eS56ID0gMDsgfQogICAgICAgICAgICAgICAgaWYgKHBvcy56IDwgMjAuMCkgeyBwb3MueiA9IDIwLjA7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IC00NS41KSB7IHBvcy56ID0gLTQ1LjU7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IC0yMC4wKSB7IHBvcy56ID0gLTIwLjA7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgfQogICAgICAgIH0KCi8vIE92ZXJyaWRlIHRocm93QmFsbCB0byBmaXggIndlYWsgdGhyb3ciIGlzc3VlCi8vIE92ZXJyaWRlIHRocm93QmFsbCB0byBmaXggIndlYWsgdGhyb3ciIGlzc3VlIGFuZCByZWR1Y2UgbG9mdAogICAgICAgIHRocm93QmFsbChiYWxsLCBmb3JjZWRUeXBlID0gbnVsbCwgcG93ZXJNdWx0aXBsaWVyID0gMS4wKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gdHJ1ZTsKICAgICAgICAgICAgY29uc3QgdHlwZSA9IGZvcmNlZFR5cGUgfHwgJ1BBJzsKICAgICAgICAgICAgY29uc3QgYm9vc3QgPSAxLjI7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsUG93ZXIgPSBwb3dlck11bHRpcGxpZXIgKiBib29zdDsKCiAgICAgICAgICAgIC8vIEFuaW1hdGlvbgogICAgICAgICAgICBjb25zdCB0aHJvd0tleSA9ICh0eXBlID09PSAnU0gnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfc2hvdCddKSA/ICd0aHJvd19zaG90JyA6ICd0aHJvd19wYXNzJzsKICAgICAgICAgICAgdGhpcy5wbGF5T25lU2hvdCh0aHJvd0tleSwgMC4xLCB7IHRpbWVTY2FsZTogMS4yIH0pOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNMRUFSISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWFjdGlvbiIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgfHwgKGJhbGwgJiYgYmFsbC5ob2xkZXIgPT09IHRoaXMpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIERpcmVjdGlvbgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbmFsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSRURVQ0VEIExPRlQ6IEdvYWxpZSB0aHJvd3MgZmxhdHRlciAoMC4yNSBpbnN0ZWFkIG9mIDAuOCkKICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMjU7IAogICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgU3RhdHMKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdFZhbCA9IHRoaXMuZ2V0U3RhdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IGZpbmFsUG93ZXI7CgogICAgICAgICAgICAgICAgICAgIGJhbGwuc2hvb3QoZmluYWxEaXIsIHN0YXRWYWwsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEV4dHJhIGdyYWNlIHBlcmlvZCBmb3IgR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFsbC5jYXRjaEdyYWNlUGVyaW9kID0gMC42OwoKICAgICAgICAgICAgICAgICAgICB0aGlzLmxvc2VCYWxsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duID0gMS4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAzMDApOyAvLyBXaW5kdXAgdGltZQoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CiAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgfQoKX2RlZmVuc2VMb2dpYyhkdCkgewogICAgICAgICAgICAvLyAwLiBHYW1lIFN0YXRlIENoZWNrCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyAtLS0gUEVSQ0VQVElPTiBVUERBVEUgLS0tCiAgICAgICAgICAgIC8vIFNtb290aGx5IGludGVycG9sYXRlIHBlcmNlaXZlZCBwb3NpdGlvbiB0b3dhcmRzIHJlYWwgYmFsbCBwb3NpdGlvbgogICAgICAgICAgICAvLyBUaGlzIGNyZWF0ZXMgYSBuYXR1cmFsIHJlYWN0aW9uIGRlbGF5IGFuZCBwcmV2ZW50cyBqaXR0ZXJ5IG1pcnJvcmluZwogICAgICAgICAgICB0aGlzLnBlcmNlaXZlZEJhbGxQb3MubGVycChiYWxsLm1lc2gucG9zaXRpb24sIGR0ICogdGhpcy5yZWFjdGlvblNwZWVkKTsKCiAgICAgICAgICAgIC8vIERldGVybWluZSBUaHJlYXQgU291cmNlCiAgICAgICAgICAgIGxldCB0aHJlYXRQb3MgPSBfYmFsbFBvczsKICAgICAgICAgICAgbGV0IGlzVGhyZWF0ID0gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IG15R29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gNDYgOiAtNDY7CgogICAgICAgICAgICAvLyBDYXNlIEE6IEJhbGwgaXMgSGVsZCAoUHJlLXRocm93KQogICAgICAgICAgICBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2hlbGQnICYmIGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgLy8gVHJhY2sgaG9sZGVyLCBidXQgdXNlIHBlcmNlaXZlZCBwb3NpdGlvbiBpZiB3ZSB3YW50ZWQgdG8gc2ltdWxhdGUgcmVhZGluZyB0aGUgcGxheWVyCiAgICAgICAgICAgICAgICAvLyBGb3Igbm93LCB0cmFja2luZyB0aGUgYmFsbCAod2hpY2ggaXMgb24gdGhlIHBsYXllcikgdmlhIHBlcmNlaXZlZFBvcyBpcyBzdWZmaWNpZW50CiAgICAgICAgICAgICAgICB0aHJlYXRQb3MgPSB0aGlzLnBlcmNlaXZlZEJhbGxQb3M7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGhvbGRlciBpcyBpbiBhdHRhY2tpbmcgaGFsZiBvciBuZWFyIGVub3VnaAogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRocmVhdFBvcy56IC0gbXlHb2FsWik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvR29hbCA8IDQwLjApIHsgLy8gSWYgdGhleSBhcmUgd2l0aGluIDQwbSwgdHJhY2sgdGhlbQogICAgICAgICAgICAgICAgICAgIGlzVGhyZWF0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSAKICAgICAgICAgICAgLy8gQ2FzZSBCOiBCYWxsIGlzIEZyZWUgKFNob3QvUGFzcykKICAgICAgICAgICAgZWxzZSBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICB0aHJlYXRQb3MgPSB0aGlzLnBlcmNlaXZlZEJhbGxQb3M7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERpcmVjdGlvbiBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgbW92aW5nVG93YXJkcyA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSAmJiBiYWxsLnZlbG9jaXR5LnogPiAwKSB8fCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAodGhpcy50ZWFtLnNpZGUgPT09IC0xICYmIGJhbGwudmVsb2NpdHkueiA8IDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQb3NpdGlvbiBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgaW5Gcm9udE9mR29hbCA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSAmJiB0aHJlYXRQb3MueiA8IDQ1LjApIHx8IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLnRlYW0uc2lkZSA9PT0gLTEgJiYgdGhyZWF0UG9zLnogPiAtNDUuMCk7CgogICAgICAgICAgICAgICAgaXNUaHJlYXQgPSBtb3ZpbmdUb3dhcmRzICYmIGluRnJvbnRPZkdvYWw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzVGhyZWF0KSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gUE9TSVRJT05JTkc6IEFOR0xFIENVVFRJTkcgLS0tCiAgICAgICAgICAgICAgICBfYmFsbFBvcy5jb3B5KHRocmVhdFBvcyk7IC8vIFVwZGF0ZSByZWZlcmVuY2UgZm9yIGxvb2tBdAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAxLiBDYWxjdWxhdGUgR29hbCBDZW50ZXIKLy8gMS4gQ2FsY3VsYXRlIEdvYWwgQ2VudGVyIChBZGp1c3RlZCBmb3IgWSBvZmZzZXQpCl9nb2FsQ2VudGVyLnNldCgwLCAtNC41LCBteUdvYWxaKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMi4gVmVjdG9yIGZyb20gR29hbCB0byBCYWxsCiAgICAgICAgICAgICAgICBfdGVtcFZlY0cuc3ViVmVjdG9ycyhfYmFsbFBvcywgX2dvYWxDZW50ZXIpOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IF90ZW1wVmVjRy5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjRy5ub3JtYWxpemUoKTsgLy8gTm93IGhvbGRzIGRpcmVjdGlvbgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAzLiBEZXRlcm1pbmUgRXh0ZW5zaW9uIChIb3cgZmFyIG91dCB0byBzdGVwKQogICAgICAgICAgICAgICAgLy8gQmFzZTogMS41bSBvZmYgbGluZS4KICAgICAgICAgICAgICAgIC8vIE1heDogNi4wbSBvZmYgbGluZSAoQ3V0dGluZyBhbmdsZSkuCiAgICAgICAgICAgICAgICAvLyBTY2FsZSBiYXNlZCBvbiBiYWxsIHByb3hpbWl0eTogQ2xvc2VyIGJhbGwgPSBNb3JlIGV4dGVuc2lvbiAodG8gYSBwb2ludCkKbGV0IGV4dGVuc2lvbiA9IDEuNTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMzAuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gMS4wIC0gKE1hdGgubWF4KDAsIGRpc3RUb0JhbGwgLSA1LjApIC8gMjUuMCk7IAogICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbiA9IDEuNSArICg0LjUgKiByYXRpbyk7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCi8vIFNhZmV0eTogRG9uJ3QgZ28gcGFzdCB0aGUgYmFsbCAoa2VlcCAxbSBidWZmZXIpCiAgICAgICAgICAgICAgICBleHRlbnNpb24gPSBNYXRoLm1pbihleHRlbnNpb24sIGRpc3RUb0JhbGwgLSAxLjApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyA0LiBDYWxjdWxhdGUgVGFyZ2V0IFBvc2l0aW9uIChCYXNlIEludGVyY2VwdGlvbikKICAgICAgICAgICAgICAgIF9nUG9zLmNvcHkoX2dvYWxDZW50ZXIpLmFkZChfdGVtcFZlY0cubXVsdGlwbHlTY2FsYXIoZXh0ZW5zaW9uKSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDUuIFZlcnRpY2FsIE92ZXJyaWRlIChKdW1wIHRvIG1lZXQgYmFsbCkKICAgICAgICAgICAgICAgIC8vIEV4cGxpY2l0bHkgc2V0IFkgdG8gbWF0Y2ggYmFsbCBoZWlnaHQgaWYgaXQncyBoaWdoCiAgICAgICAgICAgICAgICBpZiAoX2JhbGxQb3MueSA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIF9nUG9zLnkgPSBfYmFsbFBvcy55OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gMC41OyAvLyBEZWZhdWx0IHN0YW5jZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDYuIENsYW1wIHRvIEdvYWwgQm94IERpbWVuc2lvbnMgKExhdGVyYWwvVmVydGljYWwgTGltaXRzKQogICAgICAgICAgICAgICAgLy8gR29hbCBXaWR0aCAyMiAoKy8tIDExKSwgSGVpZ2h0IDE4ICgrLy0gOSkuCiAgICAgICAgICAgICAgICAvLyBBbGxvdyBzbGlnaHRseSBvdXRzaWRlIHBvc3RzIHRvIGNvdmVyIGFuZ2xlcy4KICAgICAgICAgICAgICAgIGNvbnN0IGNsYW1wWCA9IHRoaXMuZ29hbFdpZHRoICogMC42OyAvLyArLy0gMTMuMgpjb25zdCBjbGFtcFkgPSAxMi4wOyAvLyBSZWR1Y2VkIG1heCBqdW1wIGhlaWdodAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfZ1Bvcy54ID0gTWF0aC5tYXgoLWNsYW1wWCwgTWF0aC5taW4oY2xhbXBYLCBfZ1Bvcy54KSk7CiAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gTWF0aC5tYXgoLWNsYW1wWSwgTWF0aC5taW4oY2xhbXBZLCBfZ1Bvcy55KSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDYuIExlYWQgdGhlIGJhbGwgc2xpZ2h0bHkgaWYgaXQgaGFzIGxhdGVyYWwgdmVsb2NpdHkgKEFudGljaXBhdGlvbikKaWYgKGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDEuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFudGljaXBhdGlvbiA9IGJhbGwudmVsb2NpdHkuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigwLjI1KTsgLy8gMC4yNXMgbGVhZAogICAgICAgICAgICAgICAgICAgIGFudGljaXBhdGlvbi56ID0gMDsgLy8gT25seSBsYXRlcmFsIGxlYWQKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy5hZGQoYW50aWNpcGF0aW9uKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAppZiAodGhpcy50ZWFtLnNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy56ID0gTWF0aC5taW4oNDUuNSwgX2dQb3Mueik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9nUG9zLnogPSBNYXRoLm1heCgtNDUuNSwgX2dQb3Mueik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTW92ZSB0b3dhcmRzIHRhcmdldAogICAgICAgICAgICAgICAgY29uc3QgbW92ZURpciA9IF9nVmVjLnN1YlZlY3RvcnMoX2dQb3MsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0VG9UYXJnZXQgPSBtb3ZlRGlyLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvVGFyZ2V0ID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgbW92ZURpci5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAvLyBCdXJzdCBzcGVlZCBmb3Igc2F2ZXMgaWYgYmFsbCBpcyBjbG9zZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHVyZ2VuY3kgPSAoZGlzdFRvQmFsbCA8IDEwLjApID8gMS41IDogMS4wOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gdGhpcy5tYXhTcGVlZCAqIHVyZ2VuY3k7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChtb3ZlRGlyLm11bHRpcGx5U2NhbGFyKHNwZWVkICogZHQpKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBGYWNlIGJhbGwKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KF9iYWxsUG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ3N3aW0nKSB0aGlzLnBsYXkoJ3N3aW0nLCAwLjIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ2lkbGUnKSB0aGlzLnBsYXkoJ2lkbGUnLCAwLjIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoX2JhbGxQb3MpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIC0tLSBTQVZFIE1FQ0hBTklDIC0tLQogICAgICAgICAgICAgICAgLy8gSWYgYmFsbCBpcyB3aXRoaW4gcmFuZ2UsIGFwcGx5IENBIHByZXNzdXJlCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgdGhpcy5zYXZlUmFkaXVzKSB7IAogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5U2F2ZVByZXNzdXJlKGJhbGwsIGR0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBJRExFIC8gUkVUVVJOIFRPIFBPU1QgLS0tCiAgICAgICAgICAgICAgICAvLyBSZXR1cm4gdG8gaG9tZSBwb3NpdGlvbiAodXN1YWxseSBjZW50ZXIgb2YgZ29hbCkKICAgICAgICAgICAgICAgIF9nUG9zLmNvcHkodGhpcy5ob21lUG9zaXRpb24pOwogICAgICAgICAgICAgICAgY29uc3QgbW92ZURpciA9IF9nVmVjLnN1YlZlY3RvcnMoX2dQb3MsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChtb3ZlRGlyLmxlbmd0aCgpID4gMC41KSB7CiAgICAgICAgICAgICAgICAgICAgbW92ZURpci5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKG1vdmVEaXIubXVsdGlwbHlTY2FsYXIodGhpcy5tYXhTcGVlZCAqIDAuNiAqIGR0KSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdzd2ltJykgdGhpcy5wbGF5KCdzd2ltJywgMC4yKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpZGxlJykgdGhpcy5wbGF5KCdpZGxlJywgMC4yKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmFjZSBjZW50ZXIgZmllbGQKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9hcHBseVNhdmVQcmVzc3VyZShiYWxsLCBkdCkgewogICAgICAgICAgICAvLyBJZiBHb2FsaWUgaXMgQXNsZWVwLCB0aGV5IGNhbm5vdCBzYXZlLgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gLS0tIFNVUEVSIEdPQUxJRSBUUklHR0VSIC0tLQogICAgICAgICAgICAvLyBUcmlnZ2VyIGlmOiBUZWNoIGVxdWlwcGVkLCBOb3QgYWN0aXZlLCBCYWxsIGhhcyBwb3dlciwgQmFsbCBpcyBjbG9zZQogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5hY3RpdmUgPT09ICdzdXBlcl9nb2FsaWUnICYmICF0aGlzLmlzU3VwZXJHb2FsaWUgJiYgYmFsbC5wb3dlciA+IDUuMCkgewogICAgICAgICAgICAgICAgLy8gQ2hhbmNlIHRvIHRyaWdnZXIgKEhpZ2ggY2hhbmNlIGZvciBBSSwgb3IgY2hlY2sgSFApCiAgICAgICAgICAgICAgICAvLyBDb3N0OiAxMCBIUAogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPj0gMTApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IDEwOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNTdXBlckdvYWxpZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyID0gMS41OyAvLyBMYXN0cyAxLjVzCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSB1c2VkIFNVUEVSIEdPQUxJRSFgKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTVVBFUiBHT0FMSUUhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic2F2ZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIFRlY2hjb3B5IEV2ZW50CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCh0aGlzLCAnc3VwZXJfZ29hbGllJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDYWxjdWxhdGUgRWZmZWN0aXZlIENBCiAgICAgICAgICAgIGxldCBjYSA9IHRoaXMuZ2V0U3RhdCgnQ0EnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IFN1cGVyIEdvYWxpZSBCb251cyAoZS5nLiArNTAlICsgRmxhdCAxMCkKICAgICAgICAgICAgaWYgKHRoaXMuaXNTdXBlckdvYWxpZSkgewogICAgICAgICAgICAgICAgY2EgPSAoY2EgKiAxLjUpICsgMTA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IEdyaXAgR2xvdmVzIChQYXNzaXZlKQogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5wYXNzaXZlID09PSAnZ3JpcF9nbG92ZXMnKSB7CiAgICAgICAgICAgICAgICBjYSArPSA1OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDYWxjdWxhdGUgUHJlc3N1cmUKICAgICAgICAgICAgLy8gUHJlc3N1cmUgPSBDQSAqIGR0ICogTXVsdGlwbGllcgogICAgICAgICAgICBjb25zdCBwcmVzc3VyZSA9IGNhICogZHQgKiB0aGlzLnByZXNzdXJlTXVsdGlwbGllcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlciAtPSBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVmlzdWFsIEZlZWRiYWNrCiAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZFNhdmUgKz0gcHJlc3N1cmU7CiAgICAgICAgICAgICAgICAvLyBUSFJPVFRMRTogSW5jcmVhc2VkIHRocmVzaG9sZCB0byAxMi4wCiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYWNjdW11bGF0ZWRTYXZlID49IDEyLjApIHsgCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0shIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkU2F2ZSA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFwcGx5IEJhbGwgVGVjaG5pcXVlIHRvIEdvYWxpZSAoUmlzayBvZiBjYXRjaGluZyBzcGVjaWFsIHNob3RzKQovLyBBcHBseSBCYWxsIFRlY2huaXF1ZSB0byBHb2FsaWUgKFJpc2sgb2YgY2F0Y2hpbmcgc3BlY2lhbCBzaG90cykKICAgICAgICAgICAgaWYgKGJhbGwudGVjaG5pcXVlICYmIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPD0gMCkgewogICAgICAgICAgICAgICAgdGhpcy50ZWNoSW1tdW5pdHlUaW1lciA9IDIuMDsKICAgICAgICAgICAgICAgIGNvbnN0IHRlY2ggPSBiYWxsLnRlY2huaXF1ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRlY2gudHlwZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ3Zlbm9tJywgMTUuMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRlY2gudHlwZSA9PT0gJ25hcCcpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCduYXAnLCA4LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICd3aXRoZXInKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseVN0YXR1cygnd2l0aGVyJywgMTUuMCwgJ0NBJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIFJlc3VsdAogICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA8PSAwICYmIHRoaXMuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBDQVRDSAogICAgICAgICAgICAgICAgdGhpcy5jYXRjaEJhbGwoYmFsbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNhdGNoQmFsbChiYWxsKSB7CiAgICAgICAgICAgIGJhbGwuZ3JhYih0aGlzKTsKICAgICAgICAgICAgdGhpcy5wbGF5KCdjYXRjaCcsIDAuMSk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJTQVZFRCBieSAiICsgdGhpcy5yb2xlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVYUCBSRVdBUkQ6IFNhdmUKICAgICAgICAgICAgdGhpcy5nYWluRXhwKDUpOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNBVkVEISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCkgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QoMC4xNSwgJ2hlYXZ5Jyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCB0aHJvdyB0aW1lcgogICAgICAgICAgICB0aGlzLnRocm93VGltZXIgPSAwOwogICAgICAgIH0KCl9haVBvc3Nlc3Npb25Mb2dpYyhkdCkgewogICAgICAgICAgICB0aGlzLnRocm93VGltZXIgKz0gZHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIb2xkIGZvciBhIG1vbWVudCAoMS41cykgdGhlbiB0aHJvdwogICAgICAgICAgICBpZiAodGhpcy50aHJvd1RpbWVyID4gMS41KSB7CiAgICAgICAgICAgICAgICAvLyBGaW5kIGJlc3QgdGFyZ2V0OiBQcmVmZXIgTUYgb3IgRGVmZW5kZXJzLCBidXQgbXVzdCBiZSBzb21ld2hhdCBkaXN0YW50IHRvIGF2b2lkICJoYW5kb2ZmIiBsb29rCiAgICAgICAgICAgICAgICAvLyBGaWx0ZXIgZm9yIHRlYW1tYXRlcyA+IDggdW5pdHMgYXdheSBpZiBwb3NzaWJsZQogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRNYXRlcyA9IHRoaXMudGVhbS5wbGF5ZXJzLmZpbHRlcihwID0+IAogICAgICAgICAgICAgICAgICAgIHAgIT09IHRoaXMgJiYgCiAgICAgICAgICAgICAgICAgICAgcC5tZXNoICYmIAogICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRoaXMubWVzaC5wb3NpdGlvbikgPiA4LjAKICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgbGV0IHRhcmdldCA9IG51bGw7CgogICAgICAgICAgICAgICAgLy8gUHJpb3JpdHkgMTogTWlkZmllbGRlciAoUGxheW1ha2VyKQogICAgICAgICAgICAgICAgdGFyZ2V0ID0gdmFsaWRNYXRlcy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUHJpb3JpdHkgMjogRGVmZW5kZXJzCiAgICAgICAgICAgICAgICBpZiAoIXRhcmdldCkgdGFyZ2V0ID0gdmFsaWRNYXRlcy5maW5kKHAgPT4gcC5yb2xlID09PSAnTEQnIHx8IHAucm9sZSA9PT0gJ1JEJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFByaW9yaXR5IDM6IEFueW9uZSBvcGVuIChmYWxsYmFjayB0byBjbG9zZSByYW5nZSBpZiBubyBvbmUgaXMgZmFyKQogICAgICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHRhcmdldCA9IHRoaXMudGVhbS5wbGF5ZXJzLmZpbmQocCA9PiBwICE9PSB0aGlzICYmIHAucm9sZSAhPT0gJ0dMJyk7CgogICAgICAgICAgICAgICAgaWYgKHRhcmdldCAmJiB0YXJnZXQubWVzaCkgewogICAgICAgICAgICAgICAgICAgIC8vIEFJTUlORyBMT0dJQzogTG9mdCB0aGUgcGFzcwogICAgICAgICAgICAgICAgICAgIC8vIExvb2sgYXQgdGFyZ2V0LCBidXQgYWltIHNsaWdodGx5IHVwIHRvIGNyZWF0ZSBhbiBhcmMKICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRQb3MgPSB0YXJnZXQubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBkaXN0YW5jZQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIExvZnQgZmFjdG9yOiBUaGUgZnVydGhlciBhd2F5LCB0aGUgaGlnaGVyIHdlIGFpbQogICAgICAgICAgICAgICAgICAgIC8vIDIwIHVuaXRzIGF3YXkgLT4gQWltIDUgdW5pdHMgYWJvdmUgaGVhZAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxvZnQgPSBNYXRoLm1heCgxLjAsIGRpc3QgKiAwLjI1KTsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MueSArPSBsb2Z0OwoKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KHRhcmdldFBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVGhyb3cKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgJ1BBJyk7IAogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gdGhyb3dzIHRvICR7dGFyZ2V0LnJvbGV9IChEaXN0OiAke2Rpc3QudG9GaXhlZCgxKX0pYCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIENsZWFyIGl0IGZvcndhcmQKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KDAsIDUsIDApOyAvLyBBaW0gdXAtY2VudGVyCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGhyb3dCYWxsKGJhbGwsICdTSCcpOyAvLyBIYXJkIGNsZWFyCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudGhyb3dUaW1lciA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguR29hbGllID0gR29hbGllOwp9KSgpOw==","MiniMap.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNaW5pTWFwIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcCcpOwogICAgICAgICAgICB0aGlzLmRvdHMgPSBuZXcgTWFwKCk7IC8vIE1hcCBlbnRpdHkgdG8gRE9NIGVsZW1lbnQKICAgICAgICAgICAgdGhpcy53aWR0aCA9IDEwMDsgLy8gTWF0Y2hlcyBDU1Mgd2lkdGgKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSAxMDA7IC8vIE1hdGNoZXMgQ1NTIGhlaWdodAogICAgICAgICAgICB0aGlzLndvcmxkUmFkaXVzID0gMzA7IC8vIEFyZW5hIHJhZGl1cwogICAgICAgIH0KCiAgICAgICAgcmVnaXN0ZXIoZW50aXR5LCB0eXBlKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICBkb3QuY2xhc3NOYW1lID0gYG1hcC1kb3QgJHt0eXBlfWA7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZENoaWxkKGRvdCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmRvdHMuc2V0KGVudGl0eSwgZG90KTsKICAgICAgICB9CgogICAgICAgIGluaXQoaG9tZVRlYW0sIGF3YXlUZWFtLCBiYWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuaW5uZXJIVE1MID0gJyc7IC8vIENsZWFyIGV4aXN0aW5nCiAgICAgICAgICAgIHRoaXMuZG90cy5jbGVhcigpOwoKICAgICAgICAgICAgLy8gUmVnaXN0ZXIgSG9tZSBUZWFtCiAgICAgICAgICAgIGhvbWVUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHRoaXMucmVnaXN0ZXIocCwgJ2hvbWUnKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZWdpc3RlciBBd2F5IFRlYW0KICAgICAgICAgICAgYXdheVRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gdGhpcy5yZWdpc3RlcihwLCAnYXdheScpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlZ2lzdGVyIEJhbGwKICAgICAgICAgICAgdGhpcy5yZWdpc3RlcihiYWxsLCAnYmFsbCcpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBoYWxmVyA9IHRoaXMud2lkdGggLyAyOwogICAgICAgICAgICBjb25zdCBoYWxmSCA9IHRoaXMuaGVpZ2h0IC8gMjsKICAgICAgICAgICAgLy8gU2NhbGU6IE1hcCBSYWRpdXMgKDUwcHgpIC8gV29ybGQgUmFkaXVzICgzMCB1bml0cykKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSBoYWxmVyAvIHRoaXMud29ybGRSYWRpdXM7IAoKZm9yIChjb25zdCBbZW50aXR5LCBkb3RdIG9mIHRoaXMuZG90cykgewogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgLy8gSW52aXNpYmxlIEJhbGwgTG9naWMKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuaXNJbnZpc2libGUpIHsKICAgICAgICAgICAgICAgICAgICBkb3Quc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZG90LnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gZW50aXR5Lm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE1hcCBMb2dpYzoKICAgICAgICAgICAgICAgIC8vIFdvcmxkIFogaXMgVXAvRG93bi4gLVogaXMgVG9wIChBdHRhY2sgRGlyZWN0aW9uIGZvciBIb21lKSwgK1ogaXMgQm90dG9tLgogICAgICAgICAgICAgICAgLy8gV29ybGQgWCBpcyBMZWZ0L1JpZ2h0LgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgcmF3IHBvc2l0aW9uIHJlbGF0aXZlIHRvIGNlbnRlcgogICAgICAgICAgICAgICAgbGV0IGR4ID0gcG9zLnggKiBzY2FsZTsKICAgICAgICAgICAgICAgIGxldCBkeSA9IHBvcy56ICogc2NhbGU7CgogICAgICAgICAgICAgICAgLy8gQ2xhbXAgdG8gY2lyY2xlIChrZWVwIGRvdHMgaW5zaWRlIHRoZSBtYXApCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwogICAgICAgICAgICAgICAgY29uc3QgbWF4RGlzdCA9IGhhbGZXIC0gMjsgLy8gLTIgZm9yIGRvdCByYWRpdXMgcGFkZGluZwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguYXRhbjIoZHksIGR4KTsKICAgICAgICAgICAgICAgICAgICBkeCA9IE1hdGguY29zKGFuZ2xlKSAqIG1heERpc3Q7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBNYXRoLnNpbihhbmdsZSkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENvbnZlcnQgdG8gQ1NTIGNvb3JkaW5hdGVzICgwLDAgaXMgVG9wLUxlZnQpCiAgICAgICAgICAgICAgICAvLyBDZW50ZXIgaXMgKDUwLCA1MCkKICAgICAgICAgICAgICAgIGNvbnN0IGNzc1ggPSBoYWxmVyArIGR4OwogICAgICAgICAgICAgICAgY29uc3QgY3NzWSA9IGhhbGZIICsgZHk7CgogICAgICAgICAgICAgICAgZG90LnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHtjc3NYfXB4LCAke2Nzc1l9cHgpYDsKICAgICAgICAgICAgICAgIAovLyBTdGF0dXMgVXBkYXRlcwogICAgICAgICAgICAgICAgaWYgKGVudGl0eS5zdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgICAvLyBOYXAgKFNsZWVwKSB0dXJucyBkb3QgZGFyay9ibGFjawogICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkb3QuY2xhc3NMaXN0LmNvbnRhaW5zKCduYXAnKSkgZG90LmNsYXNzTGlzdC5hZGQoJ25hcCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb3QuY2xhc3NMaXN0LmNvbnRhaW5zKCduYXAnKSkgZG90LmNsYXNzTGlzdC5yZW1vdmUoJ25hcCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBY3RpdmUgUGxheWVyIE1hcmtlciAoR3JlZW4pCi8vIEFjdGl2ZSBQbGF5ZXIgTWFya2VyIChHcmVlbikKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IChnYW1lICYmIGdhbWUudGVhbXMuaG9tZSAmJiBnYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyID09PSBlbnRpdHkpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWRvdC5jbGFzc0xpc3QuY29udGFpbnMoJ2FjdGl2ZS1wbGF5ZXInKSkgZG90LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZS1wbGF5ZXInKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvdC5jbGFzc0xpc3QuY29udGFpbnMoJ2FjdGl2ZS1wbGF5ZXInKSkgZG90LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZS1wbGF5ZXInKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBCYWxsIENhcnJpZXIgTWFya2VyIChHbG93KQogICAgICAgICAgICAgICAgaWYgKGVudGl0eS5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFkb3QuY2xhc3NMaXN0LmNvbnRhaW5zKCdiYWxsLWNhcnJpZXInKSkgZG90LmNsYXNzTGlzdC5hZGQoJ2JhbGwtY2FycmllcicpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZG90LmNsYXNzTGlzdC5jb250YWlucygnYmFsbC1jYXJyaWVyJykpIGRvdC5jbGFzc0xpc3QucmVtb3ZlKCdiYWxsLWNhcnJpZXInKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgICAgICAgICAgCgogICAgCgogICAgd2luZG93LmZsdXguTWluaU1hcCA9IE1pbmlNYXA7Cn0pKCk7","./MiniMap.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNaW5pTWFwIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcCcpOwogICAgICAgICAgICB0aGlzLmRvdHMgPSBuZXcgTWFwKCk7IC8vIE1hcCBlbnRpdHkgdG8gRE9NIGVsZW1lbnQKICAgICAgICAgICAgdGhpcy53aWR0aCA9IDEwMDsgLy8gTWF0Y2hlcyBDU1Mgd2lkdGgKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSAxMDA7IC8vIE1hdGNoZXMgQ1NTIGhlaWdodAogICAgICAgICAgICB0aGlzLndvcmxkUmFkaXVzID0gMzA7IC8vIEFyZW5hIHJhZGl1cwogICAgICAgIH0KCiAgICAgICAgcmVnaXN0ZXIoZW50aXR5LCB0eXBlKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICBkb3QuY2xhc3NOYW1lID0gYG1hcC1kb3QgJHt0eXBlfWA7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZENoaWxkKGRvdCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmRvdHMuc2V0KGVudGl0eSwgZG90KTsKICAgICAgICB9CgogICAgICAgIGluaXQoaG9tZVRlYW0sIGF3YXlUZWFtLCBiYWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuaW5uZXJIVE1MID0gJyc7IC8vIENsZWFyIGV4aXN0aW5nCiAgICAgICAgICAgIHRoaXMuZG90cy5jbGVhcigpOwoKICAgICAgICAgICAgLy8gUmVnaXN0ZXIgSG9tZSBUZWFtCiAgICAgICAgICAgIGhvbWVUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHRoaXMucmVnaXN0ZXIocCwgJ2hvbWUnKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZWdpc3RlciBBd2F5IFRlYW0KICAgICAgICAgICAgYXdheVRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gdGhpcy5yZWdpc3RlcihwLCAnYXdheScpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlZ2lzdGVyIEJhbGwKICAgICAgICAgICAgdGhpcy5yZWdpc3RlcihiYWxsLCAnYmFsbCcpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBoYWxmVyA9IHRoaXMud2lkdGggLyAyOwogICAgICAgICAgICBjb25zdCBoYWxmSCA9IHRoaXMuaGVpZ2h0IC8gMjsKICAgICAgICAgICAgLy8gU2NhbGU6IE1hcCBSYWRpdXMgKDUwcHgpIC8gV29ybGQgUmFkaXVzICgzMCB1bml0cykKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSBoYWxmVyAvIHRoaXMud29ybGRSYWRpdXM7IAoKZm9yIChjb25zdCBbZW50aXR5LCBkb3RdIG9mIHRoaXMuZG90cykgewogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgLy8gSW52aXNpYmxlIEJhbGwgTG9naWMKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuaXNJbnZpc2libGUpIHsKICAgICAgICAgICAgICAgICAgICBkb3Quc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZG90LnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gZW50aXR5Lm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE1hcCBMb2dpYzoKICAgICAgICAgICAgICAgIC8vIFdvcmxkIFogaXMgVXAvRG93bi4gLVogaXMgVG9wIChBdHRhY2sgRGlyZWN0aW9uIGZvciBIb21lKSwgK1ogaXMgQm90dG9tLgogICAgICAgICAgICAgICAgLy8gV29ybGQgWCBpcyBMZWZ0L1JpZ2h0LgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgcmF3IHBvc2l0aW9uIHJlbGF0aXZlIHRvIGNlbnRlcgogICAgICAgICAgICAgICAgbGV0IGR4ID0gcG9zLnggKiBzY2FsZTsKICAgICAgICAgICAgICAgIGxldCBkeSA9IHBvcy56ICogc2NhbGU7CgogICAgICAgICAgICAgICAgLy8gQ2xhbXAgdG8gY2lyY2xlIChrZWVwIGRvdHMgaW5zaWRlIHRoZSBtYXApCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwogICAgICAgICAgICAgICAgY29uc3QgbWF4RGlzdCA9IGhhbGZXIC0gMjsgLy8gLTIgZm9yIGRvdCByYWRpdXMgcGFkZGluZwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguYXRhbjIoZHksIGR4KTsKICAgICAgICAgICAgICAgICAgICBkeCA9IE1hdGguY29zKGFuZ2xlKSAqIG1heERpc3Q7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBNYXRoLnNpbihhbmdsZSkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENvbnZlcnQgdG8gQ1NTIGNvb3JkaW5hdGVzICgwLDAgaXMgVG9wLUxlZnQpCiAgICAgICAgICAgICAgICAvLyBDZW50ZXIgaXMgKDUwLCA1MCkKICAgICAgICAgICAgICAgIGNvbnN0IGNzc1ggPSBoYWxmVyArIGR4OwogICAgICAgICAgICAgICAgY29uc3QgY3NzWSA9IGhhbGZIICsgZHk7CgogICAgICAgICAgICAgICAgZG90LnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHtjc3NYfXB4LCAke2Nzc1l9cHgpYDsKICAgICAgICAgICAgICAgIAovLyBTdGF0dXMgVXBkYXRlcwogICAgICAgICAgICAgICAgaWYgKGVudGl0eS5zdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgICAvLyBOYXAgKFNsZWVwKSB0dXJucyBkb3QgZGFyay9ibGFjawogICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkb3QuY2xhc3NMaXN0LmNvbnRhaW5zKCduYXAnKSkgZG90LmNsYXNzTGlzdC5hZGQoJ25hcCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb3QuY2xhc3NMaXN0LmNvbnRhaW5zKCduYXAnKSkgZG90LmNsYXNzTGlzdC5yZW1vdmUoJ25hcCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBY3RpdmUgUGxheWVyIE1hcmtlciAoR3JlZW4pCi8vIEFjdGl2ZSBQbGF5ZXIgTWFya2VyIChHcmVlbikKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IChnYW1lICYmIGdhbWUudGVhbXMuaG9tZSAmJiBnYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyID09PSBlbnRpdHkpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWRvdC5jbGFzc0xpc3QuY29udGFpbnMoJ2FjdGl2ZS1wbGF5ZXInKSkgZG90LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZS1wbGF5ZXInKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvdC5jbGFzc0xpc3QuY29udGFpbnMoJ2FjdGl2ZS1wbGF5ZXInKSkgZG90LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZS1wbGF5ZXInKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBCYWxsIENhcnJpZXIgTWFya2VyIChHbG93KQogICAgICAgICAgICAgICAgaWYgKGVudGl0eS5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFkb3QuY2xhc3NMaXN0LmNvbnRhaW5zKCdiYWxsLWNhcnJpZXInKSkgZG90LmNsYXNzTGlzdC5hZGQoJ2JhbGwtY2FycmllcicpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZG90LmNsYXNzTGlzdC5jb250YWlucygnYmFsbC1jYXJyaWVyJykpIGRvdC5jbGFzc0xpc3QucmVtb3ZlKCdiYWxsLWNhcnJpZXInKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgICAgICAgICAgCgogICAgCgogICAgd2luZG93LmZsdXguTWluaU1hcCA9IE1pbmlNYXA7Cn0pKCk7","/MiniMap.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNaW5pTWFwIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcCcpOwogICAgICAgICAgICB0aGlzLmRvdHMgPSBuZXcgTWFwKCk7IC8vIE1hcCBlbnRpdHkgdG8gRE9NIGVsZW1lbnQKICAgICAgICAgICAgdGhpcy53aWR0aCA9IDEwMDsgLy8gTWF0Y2hlcyBDU1Mgd2lkdGgKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSAxMDA7IC8vIE1hdGNoZXMgQ1NTIGhlaWdodAogICAgICAgICAgICB0aGlzLndvcmxkUmFkaXVzID0gMzA7IC8vIEFyZW5hIHJhZGl1cwogICAgICAgIH0KCiAgICAgICAgcmVnaXN0ZXIoZW50aXR5LCB0eXBlKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICBkb3QuY2xhc3NOYW1lID0gYG1hcC1kb3QgJHt0eXBlfWA7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZENoaWxkKGRvdCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmRvdHMuc2V0KGVudGl0eSwgZG90KTsKICAgICAgICB9CgogICAgICAgIGluaXQoaG9tZVRlYW0sIGF3YXlUZWFtLCBiYWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuaW5uZXJIVE1MID0gJyc7IC8vIENsZWFyIGV4aXN0aW5nCiAgICAgICAgICAgIHRoaXMuZG90cy5jbGVhcigpOwoKICAgICAgICAgICAgLy8gUmVnaXN0ZXIgSG9tZSBUZWFtCiAgICAgICAgICAgIGhvbWVUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHRoaXMucmVnaXN0ZXIocCwgJ2hvbWUnKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZWdpc3RlciBBd2F5IFRlYW0KICAgICAgICAgICAgYXdheVRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gdGhpcy5yZWdpc3RlcihwLCAnYXdheScpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlZ2lzdGVyIEJhbGwKICAgICAgICAgICAgdGhpcy5yZWdpc3RlcihiYWxsLCAnYmFsbCcpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBoYWxmVyA9IHRoaXMud2lkdGggLyAyOwogICAgICAgICAgICBjb25zdCBoYWxmSCA9IHRoaXMuaGVpZ2h0IC8gMjsKICAgICAgICAgICAgLy8gU2NhbGU6IE1hcCBSYWRpdXMgKDUwcHgpIC8gV29ybGQgUmFkaXVzICgzMCB1bml0cykKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSBoYWxmVyAvIHRoaXMud29ybGRSYWRpdXM7IAoKZm9yIChjb25zdCBbZW50aXR5LCBkb3RdIG9mIHRoaXMuZG90cykgewogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgLy8gSW52aXNpYmxlIEJhbGwgTG9naWMKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuaXNJbnZpc2libGUpIHsKICAgICAgICAgICAgICAgICAgICBkb3Quc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZG90LnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCkgY29udGludWU7CgogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gZW50aXR5Lm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE1hcCBMb2dpYzoKICAgICAgICAgICAgICAgIC8vIFdvcmxkIFogaXMgVXAvRG93bi4gLVogaXMgVG9wIChBdHRhY2sgRGlyZWN0aW9uIGZvciBIb21lKSwgK1ogaXMgQm90dG9tLgogICAgICAgICAgICAgICAgLy8gV29ybGQgWCBpcyBMZWZ0L1JpZ2h0LgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgcmF3IHBvc2l0aW9uIHJlbGF0aXZlIHRvIGNlbnRlcgogICAgICAgICAgICAgICAgbGV0IGR4ID0gcG9zLnggKiBzY2FsZTsKICAgICAgICAgICAgICAgIGxldCBkeSA9IHBvcy56ICogc2NhbGU7CgogICAgICAgICAgICAgICAgLy8gQ2xhbXAgdG8gY2lyY2xlIChrZWVwIGRvdHMgaW5zaWRlIHRoZSBtYXApCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwogICAgICAgICAgICAgICAgY29uc3QgbWF4RGlzdCA9IGhhbGZXIC0gMjsgLy8gLTIgZm9yIGRvdCByYWRpdXMgcGFkZGluZwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguYXRhbjIoZHksIGR4KTsKICAgICAgICAgICAgICAgICAgICBkeCA9IE1hdGguY29zKGFuZ2xlKSAqIG1heERpc3Q7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBNYXRoLnNpbihhbmdsZSkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENvbnZlcnQgdG8gQ1NTIGNvb3JkaW5hdGVzICgwLDAgaXMgVG9wLUxlZnQpCiAgICAgICAgICAgICAgICAvLyBDZW50ZXIgaXMgKDUwLCA1MCkKICAgICAgICAgICAgICAgIGNvbnN0IGNzc1ggPSBoYWxmVyArIGR4OwogICAgICAgICAgICAgICAgY29uc3QgY3NzWSA9IGhhbGZIICsgZHk7CgogICAgICAgICAgICAgICAgZG90LnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHtjc3NYfXB4LCAke2Nzc1l9cHgpYDsKICAgICAgICAgICAgICAgIAovLyBTdGF0dXMgVXBkYXRlcwogICAgICAgICAgICAgICAgaWYgKGVudGl0eS5zdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgICAvLyBOYXAgKFNsZWVwKSB0dXJucyBkb3QgZGFyay9ibGFjawogICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkb3QuY2xhc3NMaXN0LmNvbnRhaW5zKCduYXAnKSkgZG90LmNsYXNzTGlzdC5hZGQoJ25hcCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb3QuY2xhc3NMaXN0LmNvbnRhaW5zKCduYXAnKSkgZG90LmNsYXNzTGlzdC5yZW1vdmUoJ25hcCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBY3RpdmUgUGxheWVyIE1hcmtlciAoR3JlZW4pCi8vIEFjdGl2ZSBQbGF5ZXIgTWFya2VyIChHcmVlbikKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IChnYW1lICYmIGdhbWUudGVhbXMuaG9tZSAmJiBnYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyID09PSBlbnRpdHkpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWRvdC5jbGFzc0xpc3QuY29udGFpbnMoJ2FjdGl2ZS1wbGF5ZXInKSkgZG90LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZS1wbGF5ZXInKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvdC5jbGFzc0xpc3QuY29udGFpbnMoJ2FjdGl2ZS1wbGF5ZXInKSkgZG90LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZS1wbGF5ZXInKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBCYWxsIENhcnJpZXIgTWFya2VyIChHbG93KQogICAgICAgICAgICAgICAgaWYgKGVudGl0eS5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFkb3QuY2xhc3NMaXN0LmNvbnRhaW5zKCdiYWxsLWNhcnJpZXInKSkgZG90LmNsYXNzTGlzdC5hZGQoJ2JhbGwtY2FycmllcicpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZG90LmNsYXNzTGlzdC5jb250YWlucygnYmFsbC1jYXJyaWVyJykpIGRvdC5jbGFzc0xpc3QucmVtb3ZlKCdiYWxsLWNhcnJpZXInKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgICAgICAgICAgCgogICAgCgogICAgd2luZG93LmZsdXguTWluaU1hcCA9IE1pbmlNYXA7Cn0pKCk7","FloatingTextManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBGbG9hdGluZ1RleHRNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgY29udGFpbmVySWQsIGNhbWVyYSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKTsKICAgICAgICAgICAgdGhpcy50ZXh0cyA9IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBwcm9qZWN0aW9uCiAgICAgICAgICAgIHRoaXMuX3RlbXBWID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICB9CgpzcGF3bih0ZXh0LCB3b3JsZFBvcywgdHlwZSA9ICdkZWZhdWx0JywgdGFyZ2V0ID0gbnVsbCkgewogICAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyIHx8ICF0aGlzLmNhbWVyYSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIFdyYXBwZXIgKFBvc2l0aW9uaW5nKQogICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHdyYXBwZXIuY2xhc3NOYW1lID0gJ2Zsb2F0aW5nLXRleHQtd3JhcHBlcic7CgogICAgICAgICAgICAvLyBDcmVhdGUgSW5uZXIgKEFuaW1hdGlvbi9TdHlsaW5nKQogICAgICAgICAgICBjb25zdCBpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgaW5uZXIuaW5uZXJUZXh0ID0gdGV4dDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNtYXJ0IENsYXNzIEFzc2lnbm1lbnQKICAgICAgICAgICAgbGV0IGNsYXNzZXMgPSBbJ2Zsb2F0aW5nLXRleHQtaW5uZXInXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFkZCBiYXNlIHR5cGUKICAgICAgICAgICAgY2xhc3Nlcy5wdXNoKHR5cGUpOwoKICAgICAgICAgICAgLy8gS2V5d29yZCBEZXRlY3Rpb24gZm9yIEF1dG8tU3R5bGluZwogICAgICAgICAgICBjb25zdCB1cHBlciA9IHRleHQudG9TdHJpbmcoKS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICAKaWYgKHVwcGVyLmluY2x1ZGVzKCdQT0lTT04nKSB8fCB1cHBlci5pbmNsdWRlcygnVkVOT00nKSkgY2xhc3Nlcy5wdXNoKCd2ZW5vbScpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnU0xFRVAnKSB8fCB1cHBlci5pbmNsdWRlcygnTkFQJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1paWicpKSBjbGFzc2VzLnB1c2goJ3NsZWVwJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHVwcGVyLmluY2x1ZGVzKCdXSVRIRVInKSkgY2xhc3Nlcy5wdXNoKCd3aXRoZXInKTsKICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ3RlY2gnIHx8IHVwcGVyLmluY2x1ZGVzKCdTSE9UJykgfHwgdXBwZXIuaW5jbHVkZXMoJ0pFQ0hUJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1RBQ0tMRScpKSBjbGFzc2VzLnB1c2goJ3RlY2gnKTsKICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ2NvbWljLWltcGFjdCcpIGNsYXNzZXMucHVzaCgnY29taWMtaW1wYWN0Jyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdjb21pYy1hY3Rpb24nKSBjbGFzc2VzLnB1c2goJ2NvbWljLWFjdGlvbicpOwogICAgICAgICAgICBlbHNlIGlmICghaXNOYU4ocGFyc2VJbnQodGV4dCkpICYmIHR5cGUgIT09ICdzY29yZScpIGNsYXNzZXMucHVzaCgnZGFtYWdlJyk7IC8vIE51bWVyaWMgaXMgdXN1YWxseSBkYW1hZ2UKICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ3NhdmUnIHx8IHR5cGUgPT09ICdibG9jaycpIGNsYXNzZXMucHVzaCgnc2F2ZScpOwoKICAgICAgICAgICAgaW5uZXIuY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCcgJyk7CiAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaW5uZXIpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hcHBlbmRDaGlsZCh3cmFwcGVyKTsKCiAgICAgICAgICAgIC8vIFBoeXNpY3MgSW5zdGFuY2UKICAgICAgICAgICAgY29uc3QgaW5zdGFuY2UgPSB7CiAgICAgICAgICAgICAgICBlbDogd3JhcHBlciwgCiAgICAgICAgICAgICAgICB3b3JsZFBvczogd29ybGRQb3MuY2xvbmUoKSwKICAgICAgICAgICAgICAgIG9mZnNldDogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksCiAgICAgICAgICAgICAgICBncmF2aXR5OiAwLAogICAgICAgICAgICAgICAgZHJhZzogMCwKICAgICAgICAgICAgICAgIGVsYXN0aWNpdHk6IDAuNiwKICAgICAgICAgICAgICAgIGZsb29yWTogLTk5OSwgLy8gVmlydHVhbCBmbG9vciByZWxhdGl2ZSB0byBzdGFydAogICAgICAgICAgICAgICAgCmxpZmU6IDEuMCwgIC8vIFJlZHVjZWQgZnJvbSAxLjUKICAgICAgICAgICAgICAgIG1heExpZmU6IDEuMCwKICAgICAgICAgICAgICAgIHRhcmdldDogdGFyZ2V0CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBDdXN0b21pemUgUGh5c2ljcyBiYXNlZCBvbiBUeXBlCmlmIChjbGFzc2VzLmluY2x1ZGVzKCdkYW1hZ2UnKSB8fCBjbGFzc2VzLmluY2x1ZGVzKCdzYXZlJykgfHwgY2xhc3Nlcy5pbmNsdWRlcygnYmxvY2snKSkgewogICAgICAgICAgICAgICAgLy8gREVCUklTIFBIWVNJQ1MgKFBvcCwgQXJjLCBCb3VuY2UpCiAgICAgICAgICAgICAgICBpbnN0YW5jZS50YXJnZXQgPSBudWxsOyAvLyBEZXRhY2ggZnJvbSBlbnRpdHkgc28gaXQgZmFsbHMgbmF0dXJhbGx5CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gNDAuMDsgLy8gSGVhdnkgZ3Jhdml0eSBmb3Igc25hcHB5IGZlZWwKICAgICAgICAgICAgICAgIGluc3RhbmNlLmRyYWcgPSAwLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5mbG9vclkgPSAtNC4wOyAvLyBCb3VuY2Ugb2ZmIGEgdmlydHVhbCBmbG9vciBiZWxvdyBpbXBhY3QKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRXhwbG9zaXZlIEJ1cnN0CiAgICAgICAgICAgICAgICBjb25zdCBzcHJlYWQgPSA2LjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc3ByZWFkLAogICAgICAgICAgICAgICAgICAgIDE1LjAgKyBNYXRoLnJhbmRvbSgpICogNS4wLCAvLyBIaWdoIGluaXRpYWwgcG9wCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc3ByZWFkCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuMDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnY29taWMtaW1wYWN0JykpIHsKICAgICAgICAgICAgICAgIC8vIENPTUlDIFBPUCAoU3RheSBpbiBwbGFjZSBtb3N0bHksIHNsaWdodCBkcmlmdCkKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMiwgMS4wLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIpOwppbnN0YW5jZS5saWZlID0gMC41OyAvLyBSZWR1Y2VkIGZyb20gMC44CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMC41OwoKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdjb21pYy1hY3Rpb24nKSkgewogICAgICAgICAgICAgICAgLy8gQ09NSUMgWklQIChGYXN0IG1vdmVtZW50KQogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMi4wLCAwKTsKaW5zdGFuY2UubGlmZSA9IDAuNDsgLy8gUmVkdWNlZCBmcm9tIDAuNgogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDAuNDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygndGVjaCcpKSB7CiAgICAgICAgICAgICAgICAvLyBURUNIIEZMT0FUIChTbG93IHJpc2UpCiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAyLjAsIDApOyAvLyBTdGVhZHkgcmlzZQogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDIuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAyLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5vZmZzZXQueSA9IDIuMDsgLy8gU3RhcnQgaGlnaGVyCgogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3NsZWVwJykpIHsKICAgICAgICAgICAgICAgIC8vIFNMRUVQIERSSUZUIChTbG93IG1lYW5kZXJpbmcpCiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gLTAuNTsgLy8gU2xpZ2h0IGFudGktZ3Jhdml0eQogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAuNSwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMy4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDMuMDsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBERUZBVUxUIChTdGF0dXMsIGV0YykKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAzLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDUuMDsgLy8gU2xpZ2h0IGFyYwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYW5kb21pemUgc3RhcnQgcG9zIHNsaWdodGx5IHRvIHByZXZlbnQgc3RhY2tpbmcKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLndvcmxkUG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgIH0KaW5zdGFuY2Uud29ybGRQb3MueSArPSAxLjA7CiAgICAgICAgICAgIHRoaXMudGV4dHMucHVzaChpbnN0YW5jZSk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUG9zaXRpb24oaW5zdGFuY2UpOwogICAgICAgIH0KCi8vIHNwYXduVmVyc3VzIHJlbW92ZWQKCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLnRleHRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gdGhpcy50ZXh0c1tpXTsKICAgICAgICAgICAgICAgIHQubGlmZSAtPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSWYgYXR0YWNoZWQgdG8gYSB0YXJnZXQsIHVwZGF0ZSBiYXNlIHBvc2l0aW9uIChvbmx5IGZvciBub24tZGVicmlzKQogICAgICAgICAgICAgICAgaWYgKHQudGFyZ2V0ICYmIHQudGFyZ2V0LnBhcmVudCkgeyAKICAgICAgICAgICAgICAgICAgICB0LndvcmxkUG9zLmNvcHkodC50YXJnZXQucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHQud29ybGRQb3MueSArPSAxLjA7IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFBoeXNpY3MgSW50ZWdyYXRpb24KICAgICAgICAgICAgICAgIGlmICh0LmdyYXZpdHkgIT09IDAgfHwgdC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMCkgewogICAgICAgICAgICAgICAgICAgIC8vIEdyYXZpdHkKICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnkgLT0gdC5ncmF2aXR5ICogZHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRHJhZyAoQWlyIHJlc2lzdGFuY2UpCiAgICAgICAgICAgICAgICAgICAgaWYgKHQuZHJhZyA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihNYXRoLm1heCgwLCAxLjAgLSAodC5kcmFnICogZHQpKSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBNb3ZlCiAgICAgICAgICAgICAgICAgICAgdC5vZmZzZXQuYWRkU2NhbGVkVmVjdG9yKHQudmVsb2NpdHksIGR0KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQm91bmNlIExvZ2ljCiAgICAgICAgICAgICAgICAgICAgaWYgKHQub2Zmc2V0LnkgPCB0LmZsb29yWSkgewogICAgICAgICAgICAgICAgICAgICAgICB0Lm9mZnNldC55ID0gdC5mbG9vclk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJvdW5jZSB2ZWxvY2l0eQogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnkgKj0gLXQuZWxhc3RpY2l0eTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR3JvdW5kIGZyaWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueCAqPSAwLjc7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueiAqPSAwLjc7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9wIGJvdW5jaW5nIGlmIGVuZXJneSBpcyBsb3cKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHQudmVsb2NpdHkueSkgPCAyLjApIHQudmVsb2NpdHkueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0LmxpZmUgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0LmVsLnBhcmVudE5vZGUpIHQuZWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0LmVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRleHRzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVQb3NpdGlvbih0KTsKICAgICAgICAgICAgICAgICAgICAvLyBGYWRlIG91dCBpbiBsYXN0IDMwJQogICAgICAgICAgICAgICAgICAgIGlmICh0LmxpZmUgPCB0Lm1heExpZmUgKiAwLjMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5lbC5zdHlsZS5vcGFjaXR5ID0gdC5saWZlIC8gKHQubWF4TGlmZSAqIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQb3NpdGlvbih0KSB7CiAgICAgICAgICAgIC8vIFByb2plY3Qgd29ybGQgcG9zICsgb2Zmc2V0IHRvIHNjcmVlbgogICAgICAgICAgICB0aGlzLl90ZW1wVi5jb3B5KHQud29ybGRQb3MpLmFkZCh0Lm9mZnNldCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFuZGFyZCBUaHJlZS5qcyBwcm9qZWN0aW9uCiAgICAgICAgICAgIHRoaXMuX3RlbXBWLnByb2plY3QodGhpcy5jYW1lcmEpOwoKICAgICAgICAgICAgY29uc3QgeCA9ICh0aGlzLl90ZW1wVi54ICogLjUgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRXaWR0aDsKICAgICAgICAgICAgY29uc3QgeSA9ICgtKHRoaXMuX3RlbXBWLnkgKiAuNSkgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRIZWlnaHQ7CgogICAgICAgICAgICAvLyBIaWRlIGlmIGJlaGluZCBjYW1lcmEKICAgICAgICAgICAgaWYgKHRoaXMuX3RlbXBWLnogPiAxKSB7CiAgICAgICAgICAgICAgICB0LmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0LmVsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgdC5lbC5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKCR7eH1weCwgJHt5fXB4KWA7CiAgICAgICAgICAgIH0KfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkZsb2F0aW5nVGV4dE1hbmFnZXIgPSBGbG9hdGluZ1RleHRNYW5hZ2VyOwp9KSgpOw==","./FloatingTextManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBGbG9hdGluZ1RleHRNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgY29udGFpbmVySWQsIGNhbWVyYSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKTsKICAgICAgICAgICAgdGhpcy50ZXh0cyA9IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBwcm9qZWN0aW9uCiAgICAgICAgICAgIHRoaXMuX3RlbXBWID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICB9CgpzcGF3bih0ZXh0LCB3b3JsZFBvcywgdHlwZSA9ICdkZWZhdWx0JywgdGFyZ2V0ID0gbnVsbCkgewogICAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyIHx8ICF0aGlzLmNhbWVyYSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIFdyYXBwZXIgKFBvc2l0aW9uaW5nKQogICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHdyYXBwZXIuY2xhc3NOYW1lID0gJ2Zsb2F0aW5nLXRleHQtd3JhcHBlcic7CgogICAgICAgICAgICAvLyBDcmVhdGUgSW5uZXIgKEFuaW1hdGlvbi9TdHlsaW5nKQogICAgICAgICAgICBjb25zdCBpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgaW5uZXIuaW5uZXJUZXh0ID0gdGV4dDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNtYXJ0IENsYXNzIEFzc2lnbm1lbnQKICAgICAgICAgICAgbGV0IGNsYXNzZXMgPSBbJ2Zsb2F0aW5nLXRleHQtaW5uZXInXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFkZCBiYXNlIHR5cGUKICAgICAgICAgICAgY2xhc3Nlcy5wdXNoKHR5cGUpOwoKICAgICAgICAgICAgLy8gS2V5d29yZCBEZXRlY3Rpb24gZm9yIEF1dG8tU3R5bGluZwogICAgICAgICAgICBjb25zdCB1cHBlciA9IHRleHQudG9TdHJpbmcoKS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICAKaWYgKHVwcGVyLmluY2x1ZGVzKCdQT0lTT04nKSB8fCB1cHBlci5pbmNsdWRlcygnVkVOT00nKSkgY2xhc3Nlcy5wdXNoKCd2ZW5vbScpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnU0xFRVAnKSB8fCB1cHBlci5pbmNsdWRlcygnTkFQJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1paWicpKSBjbGFzc2VzLnB1c2goJ3NsZWVwJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHVwcGVyLmluY2x1ZGVzKCdXSVRIRVInKSkgY2xhc3Nlcy5wdXNoKCd3aXRoZXInKTsKICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ3RlY2gnIHx8IHVwcGVyLmluY2x1ZGVzKCdTSE9UJykgfHwgdXBwZXIuaW5jbHVkZXMoJ0pFQ0hUJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1RBQ0tMRScpKSBjbGFzc2VzLnB1c2goJ3RlY2gnKTsKICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ2NvbWljLWltcGFjdCcpIGNsYXNzZXMucHVzaCgnY29taWMtaW1wYWN0Jyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdjb21pYy1hY3Rpb24nKSBjbGFzc2VzLnB1c2goJ2NvbWljLWFjdGlvbicpOwogICAgICAgICAgICBlbHNlIGlmICghaXNOYU4ocGFyc2VJbnQodGV4dCkpICYmIHR5cGUgIT09ICdzY29yZScpIGNsYXNzZXMucHVzaCgnZGFtYWdlJyk7IC8vIE51bWVyaWMgaXMgdXN1YWxseSBkYW1hZ2UKICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ3NhdmUnIHx8IHR5cGUgPT09ICdibG9jaycpIGNsYXNzZXMucHVzaCgnc2F2ZScpOwoKICAgICAgICAgICAgaW5uZXIuY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCcgJyk7CiAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaW5uZXIpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hcHBlbmRDaGlsZCh3cmFwcGVyKTsKCiAgICAgICAgICAgIC8vIFBoeXNpY3MgSW5zdGFuY2UKICAgICAgICAgICAgY29uc3QgaW5zdGFuY2UgPSB7CiAgICAgICAgICAgICAgICBlbDogd3JhcHBlciwgCiAgICAgICAgICAgICAgICB3b3JsZFBvczogd29ybGRQb3MuY2xvbmUoKSwKICAgICAgICAgICAgICAgIG9mZnNldDogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksCiAgICAgICAgICAgICAgICBncmF2aXR5OiAwLAogICAgICAgICAgICAgICAgZHJhZzogMCwKICAgICAgICAgICAgICAgIGVsYXN0aWNpdHk6IDAuNiwKICAgICAgICAgICAgICAgIGZsb29yWTogLTk5OSwgLy8gVmlydHVhbCBmbG9vciByZWxhdGl2ZSB0byBzdGFydAogICAgICAgICAgICAgICAgCmxpZmU6IDEuMCwgIC8vIFJlZHVjZWQgZnJvbSAxLjUKICAgICAgICAgICAgICAgIG1heExpZmU6IDEuMCwKICAgICAgICAgICAgICAgIHRhcmdldDogdGFyZ2V0CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBDdXN0b21pemUgUGh5c2ljcyBiYXNlZCBvbiBUeXBlCmlmIChjbGFzc2VzLmluY2x1ZGVzKCdkYW1hZ2UnKSB8fCBjbGFzc2VzLmluY2x1ZGVzKCdzYXZlJykgfHwgY2xhc3Nlcy5pbmNsdWRlcygnYmxvY2snKSkgewogICAgICAgICAgICAgICAgLy8gREVCUklTIFBIWVNJQ1MgKFBvcCwgQXJjLCBCb3VuY2UpCiAgICAgICAgICAgICAgICBpbnN0YW5jZS50YXJnZXQgPSBudWxsOyAvLyBEZXRhY2ggZnJvbSBlbnRpdHkgc28gaXQgZmFsbHMgbmF0dXJhbGx5CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gNDAuMDsgLy8gSGVhdnkgZ3Jhdml0eSBmb3Igc25hcHB5IGZlZWwKICAgICAgICAgICAgICAgIGluc3RhbmNlLmRyYWcgPSAwLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5mbG9vclkgPSAtNC4wOyAvLyBCb3VuY2Ugb2ZmIGEgdmlydHVhbCBmbG9vciBiZWxvdyBpbXBhY3QKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRXhwbG9zaXZlIEJ1cnN0CiAgICAgICAgICAgICAgICBjb25zdCBzcHJlYWQgPSA2LjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc3ByZWFkLAogICAgICAgICAgICAgICAgICAgIDE1LjAgKyBNYXRoLnJhbmRvbSgpICogNS4wLCAvLyBIaWdoIGluaXRpYWwgcG9wCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc3ByZWFkCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuMDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnY29taWMtaW1wYWN0JykpIHsKICAgICAgICAgICAgICAgIC8vIENPTUlDIFBPUCAoU3RheSBpbiBwbGFjZSBtb3N0bHksIHNsaWdodCBkcmlmdCkKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMiwgMS4wLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIpOwppbnN0YW5jZS5saWZlID0gMC41OyAvLyBSZWR1Y2VkIGZyb20gMC44CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMC41OwoKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdjb21pYy1hY3Rpb24nKSkgewogICAgICAgICAgICAgICAgLy8gQ09NSUMgWklQIChGYXN0IG1vdmVtZW50KQogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMi4wLCAwKTsKaW5zdGFuY2UubGlmZSA9IDAuNDsgLy8gUmVkdWNlZCBmcm9tIDAuNgogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDAuNDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygndGVjaCcpKSB7CiAgICAgICAgICAgICAgICAvLyBURUNIIEZMT0FUIChTbG93IHJpc2UpCiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAyLjAsIDApOyAvLyBTdGVhZHkgcmlzZQogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDIuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAyLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5vZmZzZXQueSA9IDIuMDsgLy8gU3RhcnQgaGlnaGVyCgogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3NsZWVwJykpIHsKICAgICAgICAgICAgICAgIC8vIFNMRUVQIERSSUZUIChTbG93IG1lYW5kZXJpbmcpCiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gLTAuNTsgLy8gU2xpZ2h0IGFudGktZ3Jhdml0eQogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAuNSwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMy4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDMuMDsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBERUZBVUxUIChTdGF0dXMsIGV0YykKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAzLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDUuMDsgLy8gU2xpZ2h0IGFyYwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYW5kb21pemUgc3RhcnQgcG9zIHNsaWdodGx5IHRvIHByZXZlbnQgc3RhY2tpbmcKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLndvcmxkUG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgIH0KaW5zdGFuY2Uud29ybGRQb3MueSArPSAxLjA7CiAgICAgICAgICAgIHRoaXMudGV4dHMucHVzaChpbnN0YW5jZSk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUG9zaXRpb24oaW5zdGFuY2UpOwogICAgICAgIH0KCi8vIHNwYXduVmVyc3VzIHJlbW92ZWQKCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLnRleHRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gdGhpcy50ZXh0c1tpXTsKICAgICAgICAgICAgICAgIHQubGlmZSAtPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSWYgYXR0YWNoZWQgdG8gYSB0YXJnZXQsIHVwZGF0ZSBiYXNlIHBvc2l0aW9uIChvbmx5IGZvciBub24tZGVicmlzKQogICAgICAgICAgICAgICAgaWYgKHQudGFyZ2V0ICYmIHQudGFyZ2V0LnBhcmVudCkgeyAKICAgICAgICAgICAgICAgICAgICB0LndvcmxkUG9zLmNvcHkodC50YXJnZXQucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHQud29ybGRQb3MueSArPSAxLjA7IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFBoeXNpY3MgSW50ZWdyYXRpb24KICAgICAgICAgICAgICAgIGlmICh0LmdyYXZpdHkgIT09IDAgfHwgdC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMCkgewogICAgICAgICAgICAgICAgICAgIC8vIEdyYXZpdHkKICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnkgLT0gdC5ncmF2aXR5ICogZHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRHJhZyAoQWlyIHJlc2lzdGFuY2UpCiAgICAgICAgICAgICAgICAgICAgaWYgKHQuZHJhZyA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihNYXRoLm1heCgwLCAxLjAgLSAodC5kcmFnICogZHQpKSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBNb3ZlCiAgICAgICAgICAgICAgICAgICAgdC5vZmZzZXQuYWRkU2NhbGVkVmVjdG9yKHQudmVsb2NpdHksIGR0KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQm91bmNlIExvZ2ljCiAgICAgICAgICAgICAgICAgICAgaWYgKHQub2Zmc2V0LnkgPCB0LmZsb29yWSkgewogICAgICAgICAgICAgICAgICAgICAgICB0Lm9mZnNldC55ID0gdC5mbG9vclk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJvdW5jZSB2ZWxvY2l0eQogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnkgKj0gLXQuZWxhc3RpY2l0eTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR3JvdW5kIGZyaWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueCAqPSAwLjc7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueiAqPSAwLjc7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9wIGJvdW5jaW5nIGlmIGVuZXJneSBpcyBsb3cKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHQudmVsb2NpdHkueSkgPCAyLjApIHQudmVsb2NpdHkueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0LmxpZmUgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0LmVsLnBhcmVudE5vZGUpIHQuZWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0LmVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRleHRzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVQb3NpdGlvbih0KTsKICAgICAgICAgICAgICAgICAgICAvLyBGYWRlIG91dCBpbiBsYXN0IDMwJQogICAgICAgICAgICAgICAgICAgIGlmICh0LmxpZmUgPCB0Lm1heExpZmUgKiAwLjMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5lbC5zdHlsZS5vcGFjaXR5ID0gdC5saWZlIC8gKHQubWF4TGlmZSAqIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQb3NpdGlvbih0KSB7CiAgICAgICAgICAgIC8vIFByb2plY3Qgd29ybGQgcG9zICsgb2Zmc2V0IHRvIHNjcmVlbgogICAgICAgICAgICB0aGlzLl90ZW1wVi5jb3B5KHQud29ybGRQb3MpLmFkZCh0Lm9mZnNldCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFuZGFyZCBUaHJlZS5qcyBwcm9qZWN0aW9uCiAgICAgICAgICAgIHRoaXMuX3RlbXBWLnByb2plY3QodGhpcy5jYW1lcmEpOwoKICAgICAgICAgICAgY29uc3QgeCA9ICh0aGlzLl90ZW1wVi54ICogLjUgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRXaWR0aDsKICAgICAgICAgICAgY29uc3QgeSA9ICgtKHRoaXMuX3RlbXBWLnkgKiAuNSkgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRIZWlnaHQ7CgogICAgICAgICAgICAvLyBIaWRlIGlmIGJlaGluZCBjYW1lcmEKICAgICAgICAgICAgaWYgKHRoaXMuX3RlbXBWLnogPiAxKSB7CiAgICAgICAgICAgICAgICB0LmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0LmVsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgdC5lbC5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKCR7eH1weCwgJHt5fXB4KWA7CiAgICAgICAgICAgIH0KfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkZsb2F0aW5nVGV4dE1hbmFnZXIgPSBGbG9hdGluZ1RleHRNYW5hZ2VyOwp9KSgpOw==","/FloatingTextManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBGbG9hdGluZ1RleHRNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgY29udGFpbmVySWQsIGNhbWVyYSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKTsKICAgICAgICAgICAgdGhpcy50ZXh0cyA9IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBwcm9qZWN0aW9uCiAgICAgICAgICAgIHRoaXMuX3RlbXBWID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICB9CgpzcGF3bih0ZXh0LCB3b3JsZFBvcywgdHlwZSA9ICdkZWZhdWx0JywgdGFyZ2V0ID0gbnVsbCkgewogICAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyIHx8ICF0aGlzLmNhbWVyYSkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIFdyYXBwZXIgKFBvc2l0aW9uaW5nKQogICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHdyYXBwZXIuY2xhc3NOYW1lID0gJ2Zsb2F0aW5nLXRleHQtd3JhcHBlcic7CgogICAgICAgICAgICAvLyBDcmVhdGUgSW5uZXIgKEFuaW1hdGlvbi9TdHlsaW5nKQogICAgICAgICAgICBjb25zdCBpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgaW5uZXIuaW5uZXJUZXh0ID0gdGV4dDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNtYXJ0IENsYXNzIEFzc2lnbm1lbnQKICAgICAgICAgICAgbGV0IGNsYXNzZXMgPSBbJ2Zsb2F0aW5nLXRleHQtaW5uZXInXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFkZCBiYXNlIHR5cGUKICAgICAgICAgICAgY2xhc3Nlcy5wdXNoKHR5cGUpOwoKICAgICAgICAgICAgLy8gS2V5d29yZCBEZXRlY3Rpb24gZm9yIEF1dG8tU3R5bGluZwogICAgICAgICAgICBjb25zdCB1cHBlciA9IHRleHQudG9TdHJpbmcoKS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICAKaWYgKHVwcGVyLmluY2x1ZGVzKCdQT0lTT04nKSB8fCB1cHBlci5pbmNsdWRlcygnVkVOT00nKSkgY2xhc3Nlcy5wdXNoKCd2ZW5vbScpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnU0xFRVAnKSB8fCB1cHBlci5pbmNsdWRlcygnTkFQJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1paWicpKSBjbGFzc2VzLnB1c2goJ3NsZWVwJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHVwcGVyLmluY2x1ZGVzKCdXSVRIRVInKSkgY2xhc3Nlcy5wdXNoKCd3aXRoZXInKTsKICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ3RlY2gnIHx8IHVwcGVyLmluY2x1ZGVzKCdTSE9UJykgfHwgdXBwZXIuaW5jbHVkZXMoJ0pFQ0hUJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1RBQ0tMRScpKSBjbGFzc2VzLnB1c2goJ3RlY2gnKTsKICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ2NvbWljLWltcGFjdCcpIGNsYXNzZXMucHVzaCgnY29taWMtaW1wYWN0Jyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdjb21pYy1hY3Rpb24nKSBjbGFzc2VzLnB1c2goJ2NvbWljLWFjdGlvbicpOwogICAgICAgICAgICBlbHNlIGlmICghaXNOYU4ocGFyc2VJbnQodGV4dCkpICYmIHR5cGUgIT09ICdzY29yZScpIGNsYXNzZXMucHVzaCgnZGFtYWdlJyk7IC8vIE51bWVyaWMgaXMgdXN1YWxseSBkYW1hZ2UKICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ3NhdmUnIHx8IHR5cGUgPT09ICdibG9jaycpIGNsYXNzZXMucHVzaCgnc2F2ZScpOwoKICAgICAgICAgICAgaW5uZXIuY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCcgJyk7CiAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaW5uZXIpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hcHBlbmRDaGlsZCh3cmFwcGVyKTsKCiAgICAgICAgICAgIC8vIFBoeXNpY3MgSW5zdGFuY2UKICAgICAgICAgICAgY29uc3QgaW5zdGFuY2UgPSB7CiAgICAgICAgICAgICAgICBlbDogd3JhcHBlciwgCiAgICAgICAgICAgICAgICB3b3JsZFBvczogd29ybGRQb3MuY2xvbmUoKSwKICAgICAgICAgICAgICAgIG9mZnNldDogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksCiAgICAgICAgICAgICAgICBncmF2aXR5OiAwLAogICAgICAgICAgICAgICAgZHJhZzogMCwKICAgICAgICAgICAgICAgIGVsYXN0aWNpdHk6IDAuNiwKICAgICAgICAgICAgICAgIGZsb29yWTogLTk5OSwgLy8gVmlydHVhbCBmbG9vciByZWxhdGl2ZSB0byBzdGFydAogICAgICAgICAgICAgICAgCmxpZmU6IDEuMCwgIC8vIFJlZHVjZWQgZnJvbSAxLjUKICAgICAgICAgICAgICAgIG1heExpZmU6IDEuMCwKICAgICAgICAgICAgICAgIHRhcmdldDogdGFyZ2V0CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBDdXN0b21pemUgUGh5c2ljcyBiYXNlZCBvbiBUeXBlCmlmIChjbGFzc2VzLmluY2x1ZGVzKCdkYW1hZ2UnKSB8fCBjbGFzc2VzLmluY2x1ZGVzKCdzYXZlJykgfHwgY2xhc3Nlcy5pbmNsdWRlcygnYmxvY2snKSkgewogICAgICAgICAgICAgICAgLy8gREVCUklTIFBIWVNJQ1MgKFBvcCwgQXJjLCBCb3VuY2UpCiAgICAgICAgICAgICAgICBpbnN0YW5jZS50YXJnZXQgPSBudWxsOyAvLyBEZXRhY2ggZnJvbSBlbnRpdHkgc28gaXQgZmFsbHMgbmF0dXJhbGx5CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gNDAuMDsgLy8gSGVhdnkgZ3Jhdml0eSBmb3Igc25hcHB5IGZlZWwKICAgICAgICAgICAgICAgIGluc3RhbmNlLmRyYWcgPSAwLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5mbG9vclkgPSAtNC4wOyAvLyBCb3VuY2Ugb2ZmIGEgdmlydHVhbCBmbG9vciBiZWxvdyBpbXBhY3QKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRXhwbG9zaXZlIEJ1cnN0CiAgICAgICAgICAgICAgICBjb25zdCBzcHJlYWQgPSA2LjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc3ByZWFkLAogICAgICAgICAgICAgICAgICAgIDE1LjAgKyBNYXRoLnJhbmRvbSgpICogNS4wLCAvLyBIaWdoIGluaXRpYWwgcG9wCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc3ByZWFkCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuMDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnY29taWMtaW1wYWN0JykpIHsKICAgICAgICAgICAgICAgIC8vIENPTUlDIFBPUCAoU3RheSBpbiBwbGFjZSBtb3N0bHksIHNsaWdodCBkcmlmdCkKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMiwgMS4wLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIpOwppbnN0YW5jZS5saWZlID0gMC41OyAvLyBSZWR1Y2VkIGZyb20gMC44CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMC41OwoKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCdjb21pYy1hY3Rpb24nKSkgewogICAgICAgICAgICAgICAgLy8gQ09NSUMgWklQIChGYXN0IG1vdmVtZW50KQogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS52ZWxvY2l0eS5zZXQoMCwgMi4wLCAwKTsKaW5zdGFuY2UubGlmZSA9IDAuNDsgLy8gUmVkdWNlZCBmcm9tIDAuNgogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDAuNDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygndGVjaCcpKSB7CiAgICAgICAgICAgICAgICAvLyBURUNIIEZMT0FUIChTbG93IHJpc2UpCiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAyLjAsIDApOyAvLyBTdGVhZHkgcmlzZQogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDIuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAyLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5vZmZzZXQueSA9IDIuMDsgLy8gU3RhcnQgaGlnaGVyCgogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3NsZWVwJykpIHsKICAgICAgICAgICAgICAgIC8vIFNMRUVQIERSSUZUIChTbG93IG1lYW5kZXJpbmcpCiAgICAgICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gLTAuNTsgLy8gU2xpZ2h0IGFudGktZ3Jhdml0eQogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAuNSwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMy4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDMuMDsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBERUZBVUxUIChTdGF0dXMsIGV0YykKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAzLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDUuMDsgLy8gU2xpZ2h0IGFyYwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYW5kb21pemUgc3RhcnQgcG9zIHNsaWdodGx5IHRvIHByZXZlbnQgc3RhY2tpbmcKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLndvcmxkUG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgIH0KaW5zdGFuY2Uud29ybGRQb3MueSArPSAxLjA7CiAgICAgICAgICAgIHRoaXMudGV4dHMucHVzaChpbnN0YW5jZSk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUG9zaXRpb24oaW5zdGFuY2UpOwogICAgICAgIH0KCi8vIHNwYXduVmVyc3VzIHJlbW92ZWQKCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLnRleHRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gdGhpcy50ZXh0c1tpXTsKICAgICAgICAgICAgICAgIHQubGlmZSAtPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSWYgYXR0YWNoZWQgdG8gYSB0YXJnZXQsIHVwZGF0ZSBiYXNlIHBvc2l0aW9uIChvbmx5IGZvciBub24tZGVicmlzKQogICAgICAgICAgICAgICAgaWYgKHQudGFyZ2V0ICYmIHQudGFyZ2V0LnBhcmVudCkgeyAKICAgICAgICAgICAgICAgICAgICB0LndvcmxkUG9zLmNvcHkodC50YXJnZXQucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIHQud29ybGRQb3MueSArPSAxLjA7IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFBoeXNpY3MgSW50ZWdyYXRpb24KICAgICAgICAgICAgICAgIGlmICh0LmdyYXZpdHkgIT09IDAgfHwgdC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMCkgewogICAgICAgICAgICAgICAgICAgIC8vIEdyYXZpdHkKICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnkgLT0gdC5ncmF2aXR5ICogZHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRHJhZyAoQWlyIHJlc2lzdGFuY2UpCiAgICAgICAgICAgICAgICAgICAgaWYgKHQuZHJhZyA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihNYXRoLm1heCgwLCAxLjAgLSAodC5kcmFnICogZHQpKSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBNb3ZlCiAgICAgICAgICAgICAgICAgICAgdC5vZmZzZXQuYWRkU2NhbGVkVmVjdG9yKHQudmVsb2NpdHksIGR0KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQm91bmNlIExvZ2ljCiAgICAgICAgICAgICAgICAgICAgaWYgKHQub2Zmc2V0LnkgPCB0LmZsb29yWSkgewogICAgICAgICAgICAgICAgICAgICAgICB0Lm9mZnNldC55ID0gdC5mbG9vclk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJvdW5jZSB2ZWxvY2l0eQogICAgICAgICAgICAgICAgICAgICAgICB0LnZlbG9jaXR5LnkgKj0gLXQuZWxhc3RpY2l0eTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR3JvdW5kIGZyaWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueCAqPSAwLjc7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueiAqPSAwLjc7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9wIGJvdW5jaW5nIGlmIGVuZXJneSBpcyBsb3cKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHQudmVsb2NpdHkueSkgPCAyLjApIHQudmVsb2NpdHkueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0LmxpZmUgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0LmVsLnBhcmVudE5vZGUpIHQuZWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0LmVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRleHRzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVQb3NpdGlvbih0KTsKICAgICAgICAgICAgICAgICAgICAvLyBGYWRlIG91dCBpbiBsYXN0IDMwJQogICAgICAgICAgICAgICAgICAgIGlmICh0LmxpZmUgPCB0Lm1heExpZmUgKiAwLjMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5lbC5zdHlsZS5vcGFjaXR5ID0gdC5saWZlIC8gKHQubWF4TGlmZSAqIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQb3NpdGlvbih0KSB7CiAgICAgICAgICAgIC8vIFByb2plY3Qgd29ybGQgcG9zICsgb2Zmc2V0IHRvIHNjcmVlbgogICAgICAgICAgICB0aGlzLl90ZW1wVi5jb3B5KHQud29ybGRQb3MpLmFkZCh0Lm9mZnNldCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFuZGFyZCBUaHJlZS5qcyBwcm9qZWN0aW9uCiAgICAgICAgICAgIHRoaXMuX3RlbXBWLnByb2plY3QodGhpcy5jYW1lcmEpOwoKICAgICAgICAgICAgY29uc3QgeCA9ICh0aGlzLl90ZW1wVi54ICogLjUgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRXaWR0aDsKICAgICAgICAgICAgY29uc3QgeSA9ICgtKHRoaXMuX3RlbXBWLnkgKiAuNSkgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRIZWlnaHQ7CgogICAgICAgICAgICAvLyBIaWRlIGlmIGJlaGluZCBjYW1lcmEKICAgICAgICAgICAgaWYgKHRoaXMuX3RlbXBWLnogPiAxKSB7CiAgICAgICAgICAgICAgICB0LmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0LmVsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgdC5lbC5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKCR7eH1weCwgJHt5fXB4KWA7CiAgICAgICAgICAgIH0KfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkZsb2F0aW5nVGV4dE1hbmFnZXIgPSBGbG9hdGluZ1RleHRNYW5hZ2VyOwp9KSgpOw==","CameraManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzIHRvIGF2b2lkIEdhcmJhZ2UgQ29sbGVjdGlvbgogICAgY29uc3QgX2lkZWFsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9pZGVhbExvb2sgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF92ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGFyZ2V0V29ybGRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9nb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICBjbGFzcyBDYW1lcmFNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihjYW1lcmEsIHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CgogICAgICAgICAgICAvLyAtLS0gSU1QUk9WRUQgQ09ORklHVVJBVElPTiAtLS0KLy8gLS0tIElNUFJPVkVEIENPTkZJR1VSQVRJT04gLS0tCiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gewogICAgICAgICAgICAgICAgLy8gRklYRUQgUEVSU1BFQ1RJVkUgU0VUVElOR1MKICAgICAgICAgICAgICAgIGJhc2VEaXN0YW5jZTogMjAuMCwgICAvLyBTbGlnaHRseSBjbG9zZXIgZm9yIGltbWVyc2lvbgogICAgICAgICAgICAgICAgYmFzZUhlaWdodDogMTIuMCwgICAgIC8vIExvd2VyIGFuZ2xlIGZvciBjaGFzZSBmZWVsCgogICAgICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEZhc3RlciwgbW9yZSByZXNwb25zaXZlIHNtb290aGluZwogICAgICAgICAgICAgICAgZm9sbG93U3BlZWQ6IDYuMCwgICAgIC8vIFNuYXBwaWVyIGZvbGxvdwogICAgICAgICAgICAgICAgbG9va1NwZWVkOiA0LjAsICAgICAgIC8vIFJlc3BvbnNpdmUgbG9vay1hdAoKICAgICAgICAgICAgICAgIC8vIER5bmFtaWMgRk9WCiAgICAgICAgICAgICAgICBmb3ZCYXNlOiA1MCwKICAgICAgICAgICAgICAgIGZvdk1heDogNzAsICAgICAgICAgICAvLyBIaWdoZXIgbWF4IGZvciBzcGVlZCBzZW5zYXRpb24KCiAgICAgICAgICAgICAgICAvLyBJTVBST1ZFRDogTG9vay1haGVhZCBzZXR0aW5ncwogICAgICAgICAgICAgICAgbG9va0FoZWFkRGlzdGFuY2U6IDEwLjAsIC8vIExvb2sgZnVydGhlciBhaGVhZAogICAgICAgICAgICAgICAgbG9va0FoZWFkU21vb3RoaW5nOiA0LjAsCgogICAgICAgICAgICAgICAgLy8gU21hcnQgZnJhbWluZwogICAgICAgICAgICAgICAgYmFsbFRyYWNrV2VpZ2h0OiAwLjE1LCAKICAgICAgICAgICAgICAgIHRocmVhdEF3YXJlbmVzczogdHJ1ZQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gU3RhdGUKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmJhbGwgPSBudWxsOyAvLyBEaXJlY3QgYmFsbCByZWZlcmVuY2UgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICAgICAgdGhpcy50YXJnZXRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnRhcmdldElucHV0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZElucHV0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZExvb2tBaGVhZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBDYW1lcmEgU3RhdGUKICAgICAgICAgICAgdGhpcy5wb3MgPSBjYW1lcmEucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIE9yYml0IFN0YXRlCiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IE1hdGguUEk7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0WWF3ID0gTWF0aC5QSTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBNYW51YWwgb3JiaXQgZnJvbSB0b3VjaCAocmlnaHQgc2lkZSBvZiBzY3JlZW4pCiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSAwOwogICAgICAgICAgICB0aGlzLm9yYml0U2Vuc2l0aXZpdHkgPSAwLjAwNDsKICAgICAgICAgICAgdGhpcy5hdXRvUmVjZW50ZXJUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyRGVsYXkgPSAzLjA7CgovLyBTaGFrZQogICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gMDsKICAgICAgICAgICAgdGhpcy5zaGFrZVJvbGwgPSAwOyAvLyBORVc6IFJvdGF0aW9uYWwgc2hha2UKdGhpcy5zaGFrZU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSA9IDA7CiAgICAgICAgICAgIHRoaXMucm9sbEltcHVsc2UgPSAwOyAvLyBORVc6IER5bmFtaWMgdGlsdCBmb3IgY3VydmVzCgogICAgICAgICAgICAvLyBDaW5lbWF0aWMgU3RhdGUKICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVHlwZSA9ICdkZWZhdWx0JzsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNFbmRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IER5bmFtaWMgcHVsbC1iYWNrIGJhc2VkIG9uIGFjdGlvbgogICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4UHVsbEJhY2sgPSA4OwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBTZXQgYmFsbCByZWZlcmVuY2UgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICBzZXRCYWxsKGJhbGwpIHsKICAgICAgICAgICAgdGhpcy5iYWxsID0gYmFsbDsKICAgICAgICB9CgogICAgICAgIC8vIElNUFJPVkVEOiBHZXQgY2FtZXJhLXJlbGF0aXZlIGlucHV0IHRyYW5zZm9ybWF0aW9uCiAgICAgICAgZ2V0Q2FtZXJhUmVsYXRpdmVJbnB1dChpbnB1dFgsIGlucHV0WikgewogICAgICAgICAgICB0aGlzLmNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKCiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKSwgX2NhbUZ3ZCkubm9ybWFsaXplKCk7CgogICAgICAgICAgICAvLyBUcmFuc2Zvcm0gaW5wdXQgdG8gd29ybGQgc3BhY2UKICAgICAgICAgICAgY29uc3Qgd29ybGRYID0gKGlucHV0WCAqIF9jYW1SaWdodC54KSArIChpbnB1dFogKiBfY2FtRndkLngpOwogICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoaW5wdXRYICogX2NhbVJpZ2h0LnopICsgKGlucHV0WiAqIF9jYW1Gd2Queik7CgogICAgICAgICAgICByZXR1cm4geyB4OiB3b3JsZFgsIHo6IHdvcmxkWiB9OwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBNYW51YWwgb3JiaXQgaW5wdXQgZnJvbSB0b3VjaAogICAgICAgIGhhbmRsZU9yYml0SW5wdXQoZHgsIGR5KSB7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgKz0gZHggKiB0aGlzLm9yYml0U2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCArPSBkeSAqIHRoaXMub3JiaXRTZW5zaXRpdml0eSAqIDAuNTsKCiAgICAgICAgICAgIC8vIENsYW1wIHBpdGNoCiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IE1hdGgubWF4KC0wLjMsIE1hdGgubWluKDAuNSwgdGhpcy5tYW51YWxPcmJpdFBpdGNoKSk7CgogICAgICAgICAgICAvLyBSZXNldCBhdXRvLXJlY2VudGVyIHRpbWVyCiAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyVGltZXIgPSAwOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBSZWNlbnRlciBjYW1lcmEKICAgICAgICByZWNlbnRlcigpIHsKICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyA9IDA7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IDA7CiAgICAgICAgfQoKICAgICAgICBwbGF5Q2luZW1hdGljKHR5cGUsIHRhcmdldCwgZHVyYXRpb24gPSAxLjUpIHsKICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY0R1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1R5cGUgPSB0eXBlOwoKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydFBvcy5jb3B5KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydExvb2suY29weSh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLmFkZEZvdkltcHVsc2UoLTE1KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVDaW5lbWF0aWMoZHQpIHsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUaW1lciArPSBkdDsKICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBNYXRoLm1pbigxLjAsIHRoaXMuY2luZW1hdGljVGltZXIgLyB0aGlzLmNpbmVtYXRpY0R1cmF0aW9uKTsKCiAgICAgICAgICAgIGNvbnN0IHQgPSAxIC0gTWF0aC5wb3coMSAtIHByb2dyZXNzLCAzKTsKCiAgICAgICAgICAgIGxldCBhY3RpdmVUYXJnZXQgPSB0aGlzLnRhcmdldDsKICAgICAgICAgICAgbGV0IGlzQmFsbFRyYWNraW5nID0gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCA6IG51bGw7CgogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2ggJiYgYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnICYmIGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDIuMCkgewogICAgICAgICAgICAgICAgYWN0aXZlVGFyZ2V0ID0gYmFsbC5tZXNoOwogICAgICAgICAgICAgICAgaXNCYWxsVHJhY2tpbmcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWFjdGl2ZVRhcmdldCkgewogICAgICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhY3RpdmVUYXJnZXQuZ2V0V29ybGRQb3NpdGlvbihfdGFyZ2V0V29ybGRQb3MpOwoKICAgICAgICAgICAgY29uc3QgZW5kTG9vayA9IF90YXJnZXRXb3JsZFBvcy5jbG9uZSgpOwogICAgICAgICAgICBsZXQgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgbGV0IHJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIGlmIChpc0JhbGxUcmFja2luZykgewogICAgICAgICAgICAgICAgZW5kTG9vay5hZGRTY2FsZWRWZWN0b3IoYmFsbC52ZWxvY2l0eSwgMC4zKTsKCiAgICAgICAgICAgICAgICBmd2QuY29weShiYWxsLnZlbG9jaXR5KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgIGlmIChmd2QubGVuZ3RoU3EoKSA8IDAuMDEpIGZ3ZC5zZXQoMCwwLDEpOwogICAgICAgICAgICAgICAgZndkLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgIHJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIGZ3ZCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbmRMb29rLnkgKz0gMS41OwogICAgICAgICAgICAgICAgZndkLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24oYWN0aXZlVGFyZ2V0LnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgcmlnaHQuc2V0KDEsIDAsIDApLmFwcGx5UXVhdGVybmlvbihhY3RpdmVUYXJnZXQucXVhdGVybmlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGVuZFBvcyA9IF90YXJnZXRXb3JsZFBvcy5jbG9uZSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ2plY2h0JykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGlzQmFsbFRyYWNraW5nID8gMTQuMCA6IDEwLjA7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmd2QuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtZGlzdCkuYWRkKHJpZ2h0LmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMy4wKSk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSA2LjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5jaW5lbWF0aWNUeXBlID09PSAnc3BoZXJlJykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGlzQmFsbFRyYWNraW5nID8gMTYuMCA6IDEyLjA7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmd2QuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtZGlzdCk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSAxMC4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ2ludmlzaWJsZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSAxMi4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QgKiAwLjUpLmFkZChyaWdodC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKGRpc3QpKTsKICAgICAgICAgICAgICAgIGVuZFBvcy5hZGQob2Zmc2V0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy55ICs9IDUuMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE0LjAgOiAxMC4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gNS4wOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnBvcy5sZXJwKGVuZFBvcywgZHQgKiA0LjApOwogICAgICAgICAgICB0aGlzLmxvb2tBdC5sZXJwKGVuZExvb2ssIGR0ICogNi4wKTsKCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLmNvcHkodGhpcy5wb3MpOwogICAgICAgICAgICB0aGlzLmNhbWVyYS5sb29rQXQodGhpcy5sb29rQXQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2luZW1hdGljVGltZXIgPj0gdGhpcy5jaW5lbWF0aWNEdXJhdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKc2V0VGFyZ2V0KG1lc2gsIHZlbG9jaXR5LCBpbnB1dCwgaXNBaW1pbmcgPSBmYWxzZSkgewogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG1lc2g7CiAgICAgICAgICAgIGlmICh2ZWxvY2l0eSkgdGhpcy50YXJnZXRWZWwuY29weSh2ZWxvY2l0eSk7CiAgICAgICAgICAgIGlmIChpbnB1dCkgdGhpcy50YXJnZXRJbnB1dC5jb3B5KGlucHV0KTsKICAgICAgICAgICAgZWxzZSB0aGlzLnRhcmdldElucHV0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5pc0FpbWluZyA9IGlzQWltaW5nOwogICAgICAgIH0KCiAgICAgICAgLy8gS2VlcCBmb3IgY29tcGF0aWJpbGl0eQogICAgICAgIGhhbmRsZUlucHV0KGR4LCBkeSkgewogICAgICAgICAgICB0aGlzLmhhbmRsZU9yYml0SW5wdXQoZHgsIGR5KTsKICAgICAgICB9CgogICAgICAgIGdldFlhdygpIHsgcmV0dXJuIHRoaXMuY3VycmVudFlhdzsgfQoKICAgICAgICBhZGRTaGFrZShhbW91bnQpIHsKCiAgICAgICAgICAgIHRoaXMuc2hha2VJbnRlbnNpdHkgPSBNYXRoLm1pbih0aGlzLnNoYWtlSW50ZW5zaXR5ICsgYW1vdW50LCA0LjApOyAvLyBJbmNyZWFzZWQgY2FwCiAgICAgICAgICAgIHRoaXMuc2hha2VSb2xsID0gTWF0aC5taW4odGhpcy5zaGFrZVJvbGwgKyBhbW91bnQgKiAwLjIsIDAuOCk7IC8vIEFkZCByb2xsCiAgICAgICAgfQogICAgICAgIGFkZEZvdkltcHVsc2UoYW1vdW50KSB7CiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSA9IE1hdGgubWluKHRoaXMuZm92SW1wdWxzZSArIGFtb3VudCwgMzApOwoKICAgICAgICB9CiAgICAgICAgYWRkUm9sbEltcHVsc2UoYW1vdW50KSB7CiAgICAgICAgICAgIHRoaXMucm9sbEltcHVsc2UgKz0gYW1vdW50OwogICAgICAgICAgICAvLyBDbGFtcAogICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlID0gTWF0aC5tYXgoLTAuNSwgTWF0aC5taW4oMC41LCB0aGlzLnJvbGxJbXB1bHNlKSk7Cn0KCiAgICAgICAgc25hcFRvVGFyZ2V0KCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGFyZ2V0KSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIHRoaXMuX2NhbGN1bGF0ZUlkZWFsU3RhdGUoMCk7CgogICAgICAgICAgICB0aGlzLnBvcy5jb3B5KF9pZGVhbFBvcyk7CiAgICAgICAgICAgIHRoaXMubG9va0F0LmNvcHkoX2lkZWFsTG9vayk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IHRoaXMudGFyZ2V0WWF3OwoKICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uY29weSh0aGlzLnBvcyk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmxvb2tBdCh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLnNtb290aGVkSW5wdXQuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLCAwLCAwKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0NpbmVtYXRpYykgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQ2luZW1hdGljKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLnRhcmdldCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgc2FmZUR0ID0gTWF0aC5taW4oZHQsIDAuMDUpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEF1dG8tcmVjZW50ZXIgbG9naWMgKE9ubHkgaWYgbm90IGFpbWluZykKICAgICAgICAgICAgaWYgKCF0aGlzLmlzQWltaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyICs9IHNhZmVEdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1dG9SZWNlbnRlclRpbWVyID4gdGhpcy5hdXRvUmVjZW50ZXJEZWxheSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY2VudGVyU3BlZWQgPSAyLjAgKiBzYWZlRHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyAqPSAoMS4wIC0gcmVjZW50ZXJTcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFBpdGNoICo9ICgxLjAgLSByZWNlbnRlclNwZWVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IFNtYXJ0IHB1bGwtYmFjayBiYXNlZCBvbiBiYWxsIHNwZWVkCiAgICAgICAgICAgIGlmICh0aGlzLmJhbGwgJiYgdGhpcy5iYWxsLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsU3BlZWQgPSB0aGlzLmJhbGwudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRQdWxsQmFjayA9IE1hdGgubWluKHRoaXMubWF4UHVsbEJhY2ssIGJhbGxTcGVlZCAqIDAuMyk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayArPSAodGFyZ2V0UHVsbEJhY2sgLSB0aGlzLmN1cnJlbnRQdWxsQmFjaykgKiBzYWZlRHQgKiAzLjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayAqPSAoMS4wIC0gc2FmZUR0ICogMi4wKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMS4gVXBkYXRlIFRhcmdldCBJbmZvCiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBTdGF0ZQogICAgICAgICAgICB0aGlzLl9jYWxjdWxhdGVJZGVhbFN0YXRlKHNhZmVEdCk7CgogICAgICAgICAgICAvLyAzLiBJTVBST1ZFRDogRmFzdGVyLCBtb3JlIHJlc3BvbnNpdmUgc21vb3RoaW5nCi8vIDMuIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKICAgICAgICAgICAgLy8gRHluYW1pYyBmb2xsb3cgc3BlZWQgYmFzZWQgb24gZGlzdGFuY2UgZXJyb3IgKENhdGNoLXVwIGxvZ2ljKQogICAgICAgICAgICBjb25zdCBkaXN0RXJyb3IgPSB0aGlzLnBvcy5kaXN0YW5jZVRvKF9pZGVhbFBvcyk7CiAgICAgICAgICAgIGNvbnN0IGR5bmFtaWNGb2xsb3cgPSB0aGlzLmNvbmZpZy5mb2xsb3dTcGVlZCArIChkaXN0RXJyb3IgKiAwLjIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3Qgc3BlZWRNdWx0ID0gdGhpcy5pc0FpbWluZyA/IDIuMCA6IDEuMDsKICAgICAgICAgICAgY29uc3QgbG9va0ZhY3RvciA9IDEuMCAtIE1hdGguZXhwKC10aGlzLmNvbmZpZy5sb29rU3BlZWQgKiBzcGVlZE11bHQgKiBzYWZlRHQpOwogICAgICAgICAgICBjb25zdCBwb3NGYWN0b3IgPSAxLjAgLSBNYXRoLmV4cCgtZHluYW1pY0ZvbGxvdyAqIHNwZWVkTXVsdCAqIHNhZmVEdCk7CgogICAgICAgICAgICB0aGlzLnBvcy5sZXJwKF9pZGVhbFBvcywgcG9zRmFjdG9yKTsKICAgICAgICAgICAgdGhpcy5wb3MubGVycChfaWRlYWxQb3MsIHBvc0ZhY3Rvcik7CiAgICAgICAgICAgIHRoaXMubG9va0F0LmxlcnAoX2lkZWFsTG9vaywgbG9va0ZhY3Rvcik7CgogICAgICAgICAgICAvLyA0LiBTY3JlZW4gU2hha2UgKFBvc2l0aW9uICYgUm90YXRpb24pCiAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlSW50ZW5zaXR5ID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgZGVjYXkgPSA4LjAgKiBzYWZlRHQ7IC8vIEZhc3QgZGVjYXkgZm9yIHNuYXBweSBmZWVsCiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5IC09IGRlY2F5OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hha2VJbnRlbnNpdHkgPCAwKSB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gMDsKCiAgICAgICAgICAgICAgICBjb25zdCBzaGFrZU1hZyA9IHRoaXMuc2hha2VJbnRlbnNpdHkgKiAwLjU7CiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlT2Zmc2V0LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZU1hZywKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZU1hZywKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZU1hZwogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hha2VPZmZzZXQuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSb2xsIFNoYWtlCiAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlUm9sbCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hha2VSb2xsIC09IDUuMCAqIHNhZmVEdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlUm9sbCA8IDApIHRoaXMuc2hha2VSb2xsID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhLnJvdGF0aW9uLnogPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiB0aGlzLnNoYWtlUm9sbDsKfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhLnJvdGF0aW9uLnogPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBDdXJ2ZSBUaWx0IChSb2xsIEltcHVsc2UpCiAgICAgICAgICAgIGlmIChNYXRoLmFicyh0aGlzLnJvbGxJbXB1bHNlKSA+IDAuMDAxKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5yb3RhdGlvbi56ICs9IHRoaXMucm9sbEltcHVsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlICo9ICgxLjAgLSA0LjAgKiBzYWZlRHQpOyAvLyBEZWNheQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA1LiBEeW5hbWljIEZPVgovLyA1LiBEeW5hbWljIEZPVgogICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudGFyZ2V0VmVsLmxlbmd0aCgpOwogICAgICAgICAgICBjb25zdCBzcGVlZFJhdGlvID0gTWF0aC5taW4oc3BlZWQgLyAyNS4wLCAxLjApOwogICAgICAgICAgICBjb25zdCB3YXJwID0gc3BlZWRSYXRpbyAqIHNwZWVkUmF0aW87CgogICAgICAgICAgICAvLyBab29tIGluIHNsaWdodGx5IHdoZW4gYWltaW5nCiAgICAgICAgICAgIGNvbnN0IGFpbVpvb20gPSB0aGlzLmlzQWltaW5nID8gLTEwIDogMDsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0Rm92ID0gdGhpcy5jb25maWcuZm92QmFzZSArICh0aGlzLmNvbmZpZy5mb3ZNYXggLSB0aGlzLmNvbmZpZy5mb3ZCYXNlKSAqIHdhcnAgKyB0aGlzLmZvdkltcHVsc2UgKyBhaW1ab29tOwoKICAgICAgICAgICAgdGhpcy5mb3ZJbXB1bHNlICo9IE1hdGgubWF4KDAsIDEuMCAtICg2LjAgKiBzYWZlRHQpKTsKCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmZvdiArPSAodGFyZ2V0Rm92IC0gdGhpcy5jYW1lcmEuZm92KSAqIDQuMCAqIHNhZmVEdDsKICAgICAgICAgICAgdGhpcy5jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwoKICAgICAgICAgICAgLy8gNi4gQXBwbHkgdG8gQ2FtZXJhCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLmNvcHkodGhpcy5wb3MpLmFkZCh0aGlzLnNoYWtlT2Zmc2V0KTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKICAgICAgICB9CgpfY2FsY3VsYXRlSWRlYWxTdGF0ZShkdCkgewogICAgICAgICAgICBjb25zdCB0UG9zID0gX3RhcmdldFdvcmxkUG9zOwoKICAgICAgICAgICAgLy8gLS0tIEFJTSBNT0RFIE9WRVJSSURFIC0tLQogICAgICAgICAgICBpZiAodGhpcy5pc0FpbWluZykgewogICAgICAgICAgICAgICAgLy8gUmVsYXhlZCBBaW0gTW9kZTogWm9vbSBpbiBidXQgbWFpbnRhaW4gb3JpZW50YXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IGFpbURpc3QgPSAxNC4wOyAKICAgICAgICAgICAgICAgIGNvbnN0IGFpbUhlaWdodCA9IDYuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXNlIE1hbnVhbCBPcmJpdCBMb2dpYyAoQ29uc2lzdGVudCB3aXRoIFN0YW5kYXJkIE1vZGUpCiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVEaXN0YW5jZSA9IGFpbURpc3Q7CiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVIZWlnaHQgPSBhaW1IZWlnaHQgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmFzZSBaIG9mZnNldCAoQ2FtZXJhIGRlZmF1bHRzIHRvICtaKQogICAgICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBcHBseSBPcmJpdCBSb3RhdGlvbgogICAgICAgICAgICAgICAgY29uc3QgZmluYWxYID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgY29uc3QgZmluYWxaID0gY2FtWiAqIE1hdGguY29zKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbFopOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmNvcHkodFBvcyk7CiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLnkgKz0gMS4wOyAvLyBMb29rIGF0IHBsYXllciBjZW50ZXIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzYWJsZSBsb29rLWFoZWFkIHRvIGtlZXAgZnJhbWluZyBzdGFibGUgd2hpbGUgYWltaW5nCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFNUQU5EQVJEIE1PREUgLS0tCgogICAgICAgICAgICAvLyAwLiBUaHJlYXQgQXNzZXNzbWVudCAoRHluYW1pYyBQdWxsLWJhY2spCiAgICAgICAgICAgIGxldCB0aHJlYXRQdWxsYmFjayA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLmNvbmZpZy50aHJlYXRBd2FyZW5lc3MpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRocmVhdCA9IHRoaXMuX2NhbGN1bGF0ZVRocmVhdExldmVsKHRQb3MpOwogICAgICAgICAgICAgICAgdGhyZWF0UHVsbGJhY2sgPSB0aHJlYXQgKiA2LjA7IC8vIFB1bGwgYmFjayB1cCB0byA2IHVuaXRzCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBBcHBseSBtYW51YWwgb3JiaXQKICAgICAgICAgICAgLy8gMS4gQ2FsY3VsYXRlIElkZWFsIFBvc2l0aW9uIHdpdGggcHVsbC1iYWNrCiAgICAgICAgICAgIGNvbnN0IGVmZmVjdGl2ZURpc3RhbmNlID0gdGhpcy5jb25maWcuYmFzZURpc3RhbmNlICsgdGhpcy5jdXJyZW50UHVsbEJhY2sgKyB0aHJlYXRQdWxsYmFjazsKICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlSGVpZ2h0ID0gdGhpcy5jb25maWcuYmFzZUhlaWdodCArIHRoaXMuY3VycmVudFB1bGxCYWNrICogMC4zICsgdGhyZWF0UHVsbGJhY2sgKiAwLjUgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKCiAgICAgICAgICAgIC8vIEJhc2Ugb2Zmc2V0IChDYW1lcmEgdXN1YWxseSBzaXRzIGF0ICtaIHJlbGF0aXZlIHRvIHRhcmdldCkKICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwoKICAgICAgICAgICAgLy8gQXBwbHkgT3JiaXQgUm90YXRpb24KICAgICAgICAgICAgY29uc3QgZmluYWxDYW1YID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICBjb25zdCBmaW5hbENhbVogPSBjYW1aICogTWF0aC5jb3ModGhpcy5tYW51YWxPcmJpdFlhdyk7CgogICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsQ2FtWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbENhbVopOwoKICAgICAgICAgICAgLy8gQ2xhbXAgdG8gYXJlbmEgYm91bmRzIChyb3VnaGx5KSB0byBwcmV2ZW50IGNsaXBwaW5nIHRocm91Z2ggd2FsbHMKICAgICAgICAgICAgaWYgKF9pZGVhbFBvcy56ID4gNDguMCkgX2lkZWFsUG9zLnogPSA0OC4wOwogICAgICAgICAgICBpZiAoX2lkZWFsUG9zLnogPCAtNDguMCkgX2lkZWFsUG9zLnogPSAtNDguMDsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBMb29rQXQgd2l0aCBJTVBST1ZFRCBsb29rLWFoZWFkCiAgICAgICAgICAgIF9pZGVhbExvb2suY29weSh0UG9zKTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBWZWxvY2l0eS1iYXNlZCBsb29rLWFoZWFkCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFZlbC5sZW5ndGhTcSgpID4gMC41KSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudGFyZ2V0VmVsLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3QgbG9va0FoZWFkRmFjdG9yID0gTWF0aC5taW4oMS4wLCBzcGVlZCAvIDE1LjApICogdGhpcy5jb25maWcubG9va0FoZWFkRGlzdGFuY2U7CgogICAgICAgICAgICAgICAgY29uc3QgdmVsRGlyID0gdGhpcy50YXJnZXRWZWwuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIF9sb29rQWhlYWQuY29weSh2ZWxEaXIpLm11bHRpcGx5U2NhbGFyKGxvb2tBaGVhZEZhY3Rvcik7CgogICAgICAgICAgICAgICAgLy8gU21vb3RoIHRoZSBsb29rLWFoZWFkCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLmxlcnAoX2xvb2tBaGVhZCwgZHQgKiB0aGlzLmNvbmZpZy5sb29rQWhlYWRTbW9vdGhpbmcpOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay5hZGQodGhpcy5zbW9vdGhlZExvb2tBaGVhZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLm11bHRpcGx5U2NhbGFyKDEuMCAtIGR0ICogMy4wKTsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2suYWRkKHRoaXMuc21vb3RoZWRMb29rQWhlYWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfaWRlYWxMb29rLnkgKj0gMC41OyAvLyBMb29rIHNsaWdodGx5IGxvd2VyIHRoYW4gYWN0dWFsIHRhcmdldCBoZWlnaHQKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBJbmNsdWRlIGJhbGwgaW4gZnJhbWluZyB3aGVuIG5lYXJieQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5tZXNoICYmIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxQb3MgPSB0aGlzLmJhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSB0UG9zLmRpc3RhbmNlVG8oYmFsbFBvcyk7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCAyNSAmJiBkaXN0VG9CYWxsID4gMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxXZWlnaHQgPSBNYXRoLm1heCgwLCAxIC0gZGlzdFRvQmFsbCAvIDI1KSAqIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodDsKICAgICAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmxlcnAoYmFsbFBvcywgYmFsbFdlaWdodCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIElucHV0IEFudGljaXBhdGlvbiAoU21vb3RoZWQpCiAgICAgICAgICAgIHRoaXMuc21vb3RoZWRJbnB1dC5sZXJwKHRoaXMudGFyZ2V0SW5wdXQsIGR0ICogMy4wKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnNtb290aGVkSW5wdXQubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueCArPSB0aGlzLnNtb290aGVkSW5wdXQueCAqIDQuMDsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueiArPSB0aGlzLnNtb290aGVkSW5wdXQueiAqIDQuMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NhbGN1bGF0ZVRocmVhdExldmVsKGNlbnRlclBvcykgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSkgcmV0dXJuIDA7CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgZGVuc2l0eSA9IDA7CiAgICAgICAgICAgIGNvbnN0IGNoZWNrVGVhbSA9ICh0ZWFtKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXRlYW0pIHJldHVybjsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBpZiAocC5tZXNoICYmIHAubWVzaCAhPT0gdGhpcy50YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZFNxID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG9TcXVhcmVkKGNlbnRlclBvcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkU3EgPCA2NC4wKSB7IC8vIDhtIHJhZGl1cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVuc2l0eSArPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGNoZWNrVGVhbShnYW1lLnRlYW1zLmhvbWUpOwogICAgICAgICAgICBjaGVja1RlYW0oZ2FtZS50ZWFtcy5hd2F5KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBNYXRoLm1pbigxLjAsIGRlbnNpdHkgLyA0LjApOyAvLyBDYXAgYXQgNCBwbGF5ZXJzCiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IEdldCBmb3J3YXJkIGRpcmVjdGlvbiBmb3IgVUkgcmVmZXJlbmNlCiAgICAgICAgZ2V0Rm9yd2FyZERpcmVjdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX2NhbUZ3ZC5jbG9uZSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBHZXQgcmlnaHQgZGlyZWN0aW9uCiAgICAgICAgZ2V0UmlnaHREaXJlY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IHRoaXMuZ2V0Rm9yd2FyZERpcmVjdGlvbigpOwogICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApLCBmd2QpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICByZXR1cm4gX2NhbVJpZ2h0LmNsb25lKCk7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkNhbWVyYU1hbmFnZXIgPSBDYW1lcmFNYW5hZ2VyOwp9KSgpOwo=","./CameraManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzIHRvIGF2b2lkIEdhcmJhZ2UgQ29sbGVjdGlvbgogICAgY29uc3QgX2lkZWFsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9pZGVhbExvb2sgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF92ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGFyZ2V0V29ybGRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9nb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICBjbGFzcyBDYW1lcmFNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihjYW1lcmEsIHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CgogICAgICAgICAgICAvLyAtLS0gSU1QUk9WRUQgQ09ORklHVVJBVElPTiAtLS0KLy8gLS0tIElNUFJPVkVEIENPTkZJR1VSQVRJT04gLS0tCiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gewogICAgICAgICAgICAgICAgLy8gRklYRUQgUEVSU1BFQ1RJVkUgU0VUVElOR1MKICAgICAgICAgICAgICAgIGJhc2VEaXN0YW5jZTogMjAuMCwgICAvLyBTbGlnaHRseSBjbG9zZXIgZm9yIGltbWVyc2lvbgogICAgICAgICAgICAgICAgYmFzZUhlaWdodDogMTIuMCwgICAgIC8vIExvd2VyIGFuZ2xlIGZvciBjaGFzZSBmZWVsCgogICAgICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEZhc3RlciwgbW9yZSByZXNwb25zaXZlIHNtb290aGluZwogICAgICAgICAgICAgICAgZm9sbG93U3BlZWQ6IDYuMCwgICAgIC8vIFNuYXBwaWVyIGZvbGxvdwogICAgICAgICAgICAgICAgbG9va1NwZWVkOiA0LjAsICAgICAgIC8vIFJlc3BvbnNpdmUgbG9vay1hdAoKICAgICAgICAgICAgICAgIC8vIER5bmFtaWMgRk9WCiAgICAgICAgICAgICAgICBmb3ZCYXNlOiA1MCwKICAgICAgICAgICAgICAgIGZvdk1heDogNzAsICAgICAgICAgICAvLyBIaWdoZXIgbWF4IGZvciBzcGVlZCBzZW5zYXRpb24KCiAgICAgICAgICAgICAgICAvLyBJTVBST1ZFRDogTG9vay1haGVhZCBzZXR0aW5ncwogICAgICAgICAgICAgICAgbG9va0FoZWFkRGlzdGFuY2U6IDEwLjAsIC8vIExvb2sgZnVydGhlciBhaGVhZAogICAgICAgICAgICAgICAgbG9va0FoZWFkU21vb3RoaW5nOiA0LjAsCgogICAgICAgICAgICAgICAgLy8gU21hcnQgZnJhbWluZwogICAgICAgICAgICAgICAgYmFsbFRyYWNrV2VpZ2h0OiAwLjE1LCAKICAgICAgICAgICAgICAgIHRocmVhdEF3YXJlbmVzczogdHJ1ZQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gU3RhdGUKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmJhbGwgPSBudWxsOyAvLyBEaXJlY3QgYmFsbCByZWZlcmVuY2UgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICAgICAgdGhpcy50YXJnZXRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnRhcmdldElucHV0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZElucHV0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZExvb2tBaGVhZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBDYW1lcmEgU3RhdGUKICAgICAgICAgICAgdGhpcy5wb3MgPSBjYW1lcmEucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIE9yYml0IFN0YXRlCiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IE1hdGguUEk7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0WWF3ID0gTWF0aC5QSTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBNYW51YWwgb3JiaXQgZnJvbSB0b3VjaCAocmlnaHQgc2lkZSBvZiBzY3JlZW4pCiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSAwOwogICAgICAgICAgICB0aGlzLm9yYml0U2Vuc2l0aXZpdHkgPSAwLjAwNDsKICAgICAgICAgICAgdGhpcy5hdXRvUmVjZW50ZXJUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyRGVsYXkgPSAzLjA7CgovLyBTaGFrZQogICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gMDsKICAgICAgICAgICAgdGhpcy5zaGFrZVJvbGwgPSAwOyAvLyBORVc6IFJvdGF0aW9uYWwgc2hha2UKdGhpcy5zaGFrZU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSA9IDA7CiAgICAgICAgICAgIHRoaXMucm9sbEltcHVsc2UgPSAwOyAvLyBORVc6IER5bmFtaWMgdGlsdCBmb3IgY3VydmVzCgogICAgICAgICAgICAvLyBDaW5lbWF0aWMgU3RhdGUKICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVHlwZSA9ICdkZWZhdWx0JzsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNFbmRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IER5bmFtaWMgcHVsbC1iYWNrIGJhc2VkIG9uIGFjdGlvbgogICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4UHVsbEJhY2sgPSA4OwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBTZXQgYmFsbCByZWZlcmVuY2UgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICBzZXRCYWxsKGJhbGwpIHsKICAgICAgICAgICAgdGhpcy5iYWxsID0gYmFsbDsKICAgICAgICB9CgogICAgICAgIC8vIElNUFJPVkVEOiBHZXQgY2FtZXJhLXJlbGF0aXZlIGlucHV0IHRyYW5zZm9ybWF0aW9uCiAgICAgICAgZ2V0Q2FtZXJhUmVsYXRpdmVJbnB1dChpbnB1dFgsIGlucHV0WikgewogICAgICAgICAgICB0aGlzLmNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKCiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKSwgX2NhbUZ3ZCkubm9ybWFsaXplKCk7CgogICAgICAgICAgICAvLyBUcmFuc2Zvcm0gaW5wdXQgdG8gd29ybGQgc3BhY2UKICAgICAgICAgICAgY29uc3Qgd29ybGRYID0gKGlucHV0WCAqIF9jYW1SaWdodC54KSArIChpbnB1dFogKiBfY2FtRndkLngpOwogICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoaW5wdXRYICogX2NhbVJpZ2h0LnopICsgKGlucHV0WiAqIF9jYW1Gd2Queik7CgogICAgICAgICAgICByZXR1cm4geyB4OiB3b3JsZFgsIHo6IHdvcmxkWiB9OwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBNYW51YWwgb3JiaXQgaW5wdXQgZnJvbSB0b3VjaAogICAgICAgIGhhbmRsZU9yYml0SW5wdXQoZHgsIGR5KSB7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgKz0gZHggKiB0aGlzLm9yYml0U2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCArPSBkeSAqIHRoaXMub3JiaXRTZW5zaXRpdml0eSAqIDAuNTsKCiAgICAgICAgICAgIC8vIENsYW1wIHBpdGNoCiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IE1hdGgubWF4KC0wLjMsIE1hdGgubWluKDAuNSwgdGhpcy5tYW51YWxPcmJpdFBpdGNoKSk7CgogICAgICAgICAgICAvLyBSZXNldCBhdXRvLXJlY2VudGVyIHRpbWVyCiAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyVGltZXIgPSAwOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBSZWNlbnRlciBjYW1lcmEKICAgICAgICByZWNlbnRlcigpIHsKICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyA9IDA7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IDA7CiAgICAgICAgfQoKICAgICAgICBwbGF5Q2luZW1hdGljKHR5cGUsIHRhcmdldCwgZHVyYXRpb24gPSAxLjUpIHsKICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY0R1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1R5cGUgPSB0eXBlOwoKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydFBvcy5jb3B5KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydExvb2suY29weSh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLmFkZEZvdkltcHVsc2UoLTE1KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVDaW5lbWF0aWMoZHQpIHsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUaW1lciArPSBkdDsKICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBNYXRoLm1pbigxLjAsIHRoaXMuY2luZW1hdGljVGltZXIgLyB0aGlzLmNpbmVtYXRpY0R1cmF0aW9uKTsKCiAgICAgICAgICAgIGNvbnN0IHQgPSAxIC0gTWF0aC5wb3coMSAtIHByb2dyZXNzLCAzKTsKCiAgICAgICAgICAgIGxldCBhY3RpdmVUYXJnZXQgPSB0aGlzLnRhcmdldDsKICAgICAgICAgICAgbGV0IGlzQmFsbFRyYWNraW5nID0gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCA6IG51bGw7CgogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2ggJiYgYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnICYmIGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDIuMCkgewogICAgICAgICAgICAgICAgYWN0aXZlVGFyZ2V0ID0gYmFsbC5tZXNoOwogICAgICAgICAgICAgICAgaXNCYWxsVHJhY2tpbmcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWFjdGl2ZVRhcmdldCkgewogICAgICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhY3RpdmVUYXJnZXQuZ2V0V29ybGRQb3NpdGlvbihfdGFyZ2V0V29ybGRQb3MpOwoKICAgICAgICAgICAgY29uc3QgZW5kTG9vayA9IF90YXJnZXRXb3JsZFBvcy5jbG9uZSgpOwogICAgICAgICAgICBsZXQgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgbGV0IHJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIGlmIChpc0JhbGxUcmFja2luZykgewogICAgICAgICAgICAgICAgZW5kTG9vay5hZGRTY2FsZWRWZWN0b3IoYmFsbC52ZWxvY2l0eSwgMC4zKTsKCiAgICAgICAgICAgICAgICBmd2QuY29weShiYWxsLnZlbG9jaXR5KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgIGlmIChmd2QubGVuZ3RoU3EoKSA8IDAuMDEpIGZ3ZC5zZXQoMCwwLDEpOwogICAgICAgICAgICAgICAgZndkLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgIHJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIGZ3ZCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbmRMb29rLnkgKz0gMS41OwogICAgICAgICAgICAgICAgZndkLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24oYWN0aXZlVGFyZ2V0LnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgcmlnaHQuc2V0KDEsIDAsIDApLmFwcGx5UXVhdGVybmlvbihhY3RpdmVUYXJnZXQucXVhdGVybmlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGVuZFBvcyA9IF90YXJnZXRXb3JsZFBvcy5jbG9uZSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ2plY2h0JykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGlzQmFsbFRyYWNraW5nID8gMTQuMCA6IDEwLjA7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmd2QuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtZGlzdCkuYWRkKHJpZ2h0LmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMy4wKSk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSA2LjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5jaW5lbWF0aWNUeXBlID09PSAnc3BoZXJlJykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGlzQmFsbFRyYWNraW5nID8gMTYuMCA6IDEyLjA7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmd2QuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtZGlzdCk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSAxMC4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ2ludmlzaWJsZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSAxMi4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QgKiAwLjUpLmFkZChyaWdodC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKGRpc3QpKTsKICAgICAgICAgICAgICAgIGVuZFBvcy5hZGQob2Zmc2V0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy55ICs9IDUuMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE0LjAgOiAxMC4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gNS4wOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnBvcy5sZXJwKGVuZFBvcywgZHQgKiA0LjApOwogICAgICAgICAgICB0aGlzLmxvb2tBdC5sZXJwKGVuZExvb2ssIGR0ICogNi4wKTsKCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLmNvcHkodGhpcy5wb3MpOwogICAgICAgICAgICB0aGlzLmNhbWVyYS5sb29rQXQodGhpcy5sb29rQXQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2luZW1hdGljVGltZXIgPj0gdGhpcy5jaW5lbWF0aWNEdXJhdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKc2V0VGFyZ2V0KG1lc2gsIHZlbG9jaXR5LCBpbnB1dCwgaXNBaW1pbmcgPSBmYWxzZSkgewogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG1lc2g7CiAgICAgICAgICAgIGlmICh2ZWxvY2l0eSkgdGhpcy50YXJnZXRWZWwuY29weSh2ZWxvY2l0eSk7CiAgICAgICAgICAgIGlmIChpbnB1dCkgdGhpcy50YXJnZXRJbnB1dC5jb3B5KGlucHV0KTsKICAgICAgICAgICAgZWxzZSB0aGlzLnRhcmdldElucHV0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5pc0FpbWluZyA9IGlzQWltaW5nOwogICAgICAgIH0KCiAgICAgICAgLy8gS2VlcCBmb3IgY29tcGF0aWJpbGl0eQogICAgICAgIGhhbmRsZUlucHV0KGR4LCBkeSkgewogICAgICAgICAgICB0aGlzLmhhbmRsZU9yYml0SW5wdXQoZHgsIGR5KTsKICAgICAgICB9CgogICAgICAgIGdldFlhdygpIHsgcmV0dXJuIHRoaXMuY3VycmVudFlhdzsgfQoKICAgICAgICBhZGRTaGFrZShhbW91bnQpIHsKCiAgICAgICAgICAgIHRoaXMuc2hha2VJbnRlbnNpdHkgPSBNYXRoLm1pbih0aGlzLnNoYWtlSW50ZW5zaXR5ICsgYW1vdW50LCA0LjApOyAvLyBJbmNyZWFzZWQgY2FwCiAgICAgICAgICAgIHRoaXMuc2hha2VSb2xsID0gTWF0aC5taW4odGhpcy5zaGFrZVJvbGwgKyBhbW91bnQgKiAwLjIsIDAuOCk7IC8vIEFkZCByb2xsCiAgICAgICAgfQogICAgICAgIGFkZEZvdkltcHVsc2UoYW1vdW50KSB7CiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSA9IE1hdGgubWluKHRoaXMuZm92SW1wdWxzZSArIGFtb3VudCwgMzApOwoKICAgICAgICB9CiAgICAgICAgYWRkUm9sbEltcHVsc2UoYW1vdW50KSB7CiAgICAgICAgICAgIHRoaXMucm9sbEltcHVsc2UgKz0gYW1vdW50OwogICAgICAgICAgICAvLyBDbGFtcAogICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlID0gTWF0aC5tYXgoLTAuNSwgTWF0aC5taW4oMC41LCB0aGlzLnJvbGxJbXB1bHNlKSk7Cn0KCiAgICAgICAgc25hcFRvVGFyZ2V0KCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGFyZ2V0KSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIHRoaXMuX2NhbGN1bGF0ZUlkZWFsU3RhdGUoMCk7CgogICAgICAgICAgICB0aGlzLnBvcy5jb3B5KF9pZGVhbFBvcyk7CiAgICAgICAgICAgIHRoaXMubG9va0F0LmNvcHkoX2lkZWFsTG9vayk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IHRoaXMudGFyZ2V0WWF3OwoKICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uY29weSh0aGlzLnBvcyk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmxvb2tBdCh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLnNtb290aGVkSW5wdXQuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLCAwLCAwKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0NpbmVtYXRpYykgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQ2luZW1hdGljKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLnRhcmdldCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgc2FmZUR0ID0gTWF0aC5taW4oZHQsIDAuMDUpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEF1dG8tcmVjZW50ZXIgbG9naWMgKE9ubHkgaWYgbm90IGFpbWluZykKICAgICAgICAgICAgaWYgKCF0aGlzLmlzQWltaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyICs9IHNhZmVEdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1dG9SZWNlbnRlclRpbWVyID4gdGhpcy5hdXRvUmVjZW50ZXJEZWxheSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY2VudGVyU3BlZWQgPSAyLjAgKiBzYWZlRHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyAqPSAoMS4wIC0gcmVjZW50ZXJTcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFBpdGNoICo9ICgxLjAgLSByZWNlbnRlclNwZWVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IFNtYXJ0IHB1bGwtYmFjayBiYXNlZCBvbiBiYWxsIHNwZWVkCiAgICAgICAgICAgIGlmICh0aGlzLmJhbGwgJiYgdGhpcy5iYWxsLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsU3BlZWQgPSB0aGlzLmJhbGwudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRQdWxsQmFjayA9IE1hdGgubWluKHRoaXMubWF4UHVsbEJhY2ssIGJhbGxTcGVlZCAqIDAuMyk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayArPSAodGFyZ2V0UHVsbEJhY2sgLSB0aGlzLmN1cnJlbnRQdWxsQmFjaykgKiBzYWZlRHQgKiAzLjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayAqPSAoMS4wIC0gc2FmZUR0ICogMi4wKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMS4gVXBkYXRlIFRhcmdldCBJbmZvCiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBTdGF0ZQogICAgICAgICAgICB0aGlzLl9jYWxjdWxhdGVJZGVhbFN0YXRlKHNhZmVEdCk7CgogICAgICAgICAgICAvLyAzLiBJTVBST1ZFRDogRmFzdGVyLCBtb3JlIHJlc3BvbnNpdmUgc21vb3RoaW5nCi8vIDMuIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKICAgICAgICAgICAgLy8gRHluYW1pYyBmb2xsb3cgc3BlZWQgYmFzZWQgb24gZGlzdGFuY2UgZXJyb3IgKENhdGNoLXVwIGxvZ2ljKQogICAgICAgICAgICBjb25zdCBkaXN0RXJyb3IgPSB0aGlzLnBvcy5kaXN0YW5jZVRvKF9pZGVhbFBvcyk7CiAgICAgICAgICAgIGNvbnN0IGR5bmFtaWNGb2xsb3cgPSB0aGlzLmNvbmZpZy5mb2xsb3dTcGVlZCArIChkaXN0RXJyb3IgKiAwLjIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3Qgc3BlZWRNdWx0ID0gdGhpcy5pc0FpbWluZyA/IDIuMCA6IDEuMDsKICAgICAgICAgICAgY29uc3QgbG9va0ZhY3RvciA9IDEuMCAtIE1hdGguZXhwKC10aGlzLmNvbmZpZy5sb29rU3BlZWQgKiBzcGVlZE11bHQgKiBzYWZlRHQpOwogICAgICAgICAgICBjb25zdCBwb3NGYWN0b3IgPSAxLjAgLSBNYXRoLmV4cCgtZHluYW1pY0ZvbGxvdyAqIHNwZWVkTXVsdCAqIHNhZmVEdCk7CgogICAgICAgICAgICB0aGlzLnBvcy5sZXJwKF9pZGVhbFBvcywgcG9zRmFjdG9yKTsKICAgICAgICAgICAgdGhpcy5wb3MubGVycChfaWRlYWxQb3MsIHBvc0ZhY3Rvcik7CiAgICAgICAgICAgIHRoaXMubG9va0F0LmxlcnAoX2lkZWFsTG9vaywgbG9va0ZhY3Rvcik7CgogICAgICAgICAgICAvLyA0LiBTY3JlZW4gU2hha2UgKFBvc2l0aW9uICYgUm90YXRpb24pCiAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlSW50ZW5zaXR5ID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgZGVjYXkgPSA4LjAgKiBzYWZlRHQ7IC8vIEZhc3QgZGVjYXkgZm9yIHNuYXBweSBmZWVsCiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5IC09IGRlY2F5OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hha2VJbnRlbnNpdHkgPCAwKSB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gMDsKCiAgICAgICAgICAgICAgICBjb25zdCBzaGFrZU1hZyA9IHRoaXMuc2hha2VJbnRlbnNpdHkgKiAwLjU7CiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlT2Zmc2V0LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZU1hZywKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZU1hZywKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZU1hZwogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hha2VPZmZzZXQuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSb2xsIFNoYWtlCiAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlUm9sbCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hha2VSb2xsIC09IDUuMCAqIHNhZmVEdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlUm9sbCA8IDApIHRoaXMuc2hha2VSb2xsID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhLnJvdGF0aW9uLnogPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiB0aGlzLnNoYWtlUm9sbDsKfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhLnJvdGF0aW9uLnogPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBDdXJ2ZSBUaWx0IChSb2xsIEltcHVsc2UpCiAgICAgICAgICAgIGlmIChNYXRoLmFicyh0aGlzLnJvbGxJbXB1bHNlKSA+IDAuMDAxKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5yb3RhdGlvbi56ICs9IHRoaXMucm9sbEltcHVsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlICo9ICgxLjAgLSA0LjAgKiBzYWZlRHQpOyAvLyBEZWNheQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA1LiBEeW5hbWljIEZPVgovLyA1LiBEeW5hbWljIEZPVgogICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudGFyZ2V0VmVsLmxlbmd0aCgpOwogICAgICAgICAgICBjb25zdCBzcGVlZFJhdGlvID0gTWF0aC5taW4oc3BlZWQgLyAyNS4wLCAxLjApOwogICAgICAgICAgICBjb25zdCB3YXJwID0gc3BlZWRSYXRpbyAqIHNwZWVkUmF0aW87CgogICAgICAgICAgICAvLyBab29tIGluIHNsaWdodGx5IHdoZW4gYWltaW5nCiAgICAgICAgICAgIGNvbnN0IGFpbVpvb20gPSB0aGlzLmlzQWltaW5nID8gLTEwIDogMDsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0Rm92ID0gdGhpcy5jb25maWcuZm92QmFzZSArICh0aGlzLmNvbmZpZy5mb3ZNYXggLSB0aGlzLmNvbmZpZy5mb3ZCYXNlKSAqIHdhcnAgKyB0aGlzLmZvdkltcHVsc2UgKyBhaW1ab29tOwoKICAgICAgICAgICAgdGhpcy5mb3ZJbXB1bHNlICo9IE1hdGgubWF4KDAsIDEuMCAtICg2LjAgKiBzYWZlRHQpKTsKCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmZvdiArPSAodGFyZ2V0Rm92IC0gdGhpcy5jYW1lcmEuZm92KSAqIDQuMCAqIHNhZmVEdDsKICAgICAgICAgICAgdGhpcy5jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwoKICAgICAgICAgICAgLy8gNi4gQXBwbHkgdG8gQ2FtZXJhCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLmNvcHkodGhpcy5wb3MpLmFkZCh0aGlzLnNoYWtlT2Zmc2V0KTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKICAgICAgICB9CgpfY2FsY3VsYXRlSWRlYWxTdGF0ZShkdCkgewogICAgICAgICAgICBjb25zdCB0UG9zID0gX3RhcmdldFdvcmxkUG9zOwoKICAgICAgICAgICAgLy8gLS0tIEFJTSBNT0RFIE9WRVJSSURFIC0tLQogICAgICAgICAgICBpZiAodGhpcy5pc0FpbWluZykgewogICAgICAgICAgICAgICAgLy8gUmVsYXhlZCBBaW0gTW9kZTogWm9vbSBpbiBidXQgbWFpbnRhaW4gb3JpZW50YXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IGFpbURpc3QgPSAxNC4wOyAKICAgICAgICAgICAgICAgIGNvbnN0IGFpbUhlaWdodCA9IDYuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXNlIE1hbnVhbCBPcmJpdCBMb2dpYyAoQ29uc2lzdGVudCB3aXRoIFN0YW5kYXJkIE1vZGUpCiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVEaXN0YW5jZSA9IGFpbURpc3Q7CiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVIZWlnaHQgPSBhaW1IZWlnaHQgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmFzZSBaIG9mZnNldCAoQ2FtZXJhIGRlZmF1bHRzIHRvICtaKQogICAgICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBcHBseSBPcmJpdCBSb3RhdGlvbgogICAgICAgICAgICAgICAgY29uc3QgZmluYWxYID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgY29uc3QgZmluYWxaID0gY2FtWiAqIE1hdGguY29zKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbFopOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmNvcHkodFBvcyk7CiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLnkgKz0gMS4wOyAvLyBMb29rIGF0IHBsYXllciBjZW50ZXIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzYWJsZSBsb29rLWFoZWFkIHRvIGtlZXAgZnJhbWluZyBzdGFibGUgd2hpbGUgYWltaW5nCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFNUQU5EQVJEIE1PREUgLS0tCgogICAgICAgICAgICAvLyAwLiBUaHJlYXQgQXNzZXNzbWVudCAoRHluYW1pYyBQdWxsLWJhY2spCiAgICAgICAgICAgIGxldCB0aHJlYXRQdWxsYmFjayA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLmNvbmZpZy50aHJlYXRBd2FyZW5lc3MpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRocmVhdCA9IHRoaXMuX2NhbGN1bGF0ZVRocmVhdExldmVsKHRQb3MpOwogICAgICAgICAgICAgICAgdGhyZWF0UHVsbGJhY2sgPSB0aHJlYXQgKiA2LjA7IC8vIFB1bGwgYmFjayB1cCB0byA2IHVuaXRzCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBBcHBseSBtYW51YWwgb3JiaXQKICAgICAgICAgICAgLy8gMS4gQ2FsY3VsYXRlIElkZWFsIFBvc2l0aW9uIHdpdGggcHVsbC1iYWNrCiAgICAgICAgICAgIGNvbnN0IGVmZmVjdGl2ZURpc3RhbmNlID0gdGhpcy5jb25maWcuYmFzZURpc3RhbmNlICsgdGhpcy5jdXJyZW50UHVsbEJhY2sgKyB0aHJlYXRQdWxsYmFjazsKICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlSGVpZ2h0ID0gdGhpcy5jb25maWcuYmFzZUhlaWdodCArIHRoaXMuY3VycmVudFB1bGxCYWNrICogMC4zICsgdGhyZWF0UHVsbGJhY2sgKiAwLjUgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKCiAgICAgICAgICAgIC8vIEJhc2Ugb2Zmc2V0IChDYW1lcmEgdXN1YWxseSBzaXRzIGF0ICtaIHJlbGF0aXZlIHRvIHRhcmdldCkKICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwoKICAgICAgICAgICAgLy8gQXBwbHkgT3JiaXQgUm90YXRpb24KICAgICAgICAgICAgY29uc3QgZmluYWxDYW1YID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICBjb25zdCBmaW5hbENhbVogPSBjYW1aICogTWF0aC5jb3ModGhpcy5tYW51YWxPcmJpdFlhdyk7CgogICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsQ2FtWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbENhbVopOwoKICAgICAgICAgICAgLy8gQ2xhbXAgdG8gYXJlbmEgYm91bmRzIChyb3VnaGx5KSB0byBwcmV2ZW50IGNsaXBwaW5nIHRocm91Z2ggd2FsbHMKICAgICAgICAgICAgaWYgKF9pZGVhbFBvcy56ID4gNDguMCkgX2lkZWFsUG9zLnogPSA0OC4wOwogICAgICAgICAgICBpZiAoX2lkZWFsUG9zLnogPCAtNDguMCkgX2lkZWFsUG9zLnogPSAtNDguMDsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBMb29rQXQgd2l0aCBJTVBST1ZFRCBsb29rLWFoZWFkCiAgICAgICAgICAgIF9pZGVhbExvb2suY29weSh0UG9zKTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBWZWxvY2l0eS1iYXNlZCBsb29rLWFoZWFkCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFZlbC5sZW5ndGhTcSgpID4gMC41KSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudGFyZ2V0VmVsLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3QgbG9va0FoZWFkRmFjdG9yID0gTWF0aC5taW4oMS4wLCBzcGVlZCAvIDE1LjApICogdGhpcy5jb25maWcubG9va0FoZWFkRGlzdGFuY2U7CgogICAgICAgICAgICAgICAgY29uc3QgdmVsRGlyID0gdGhpcy50YXJnZXRWZWwuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIF9sb29rQWhlYWQuY29weSh2ZWxEaXIpLm11bHRpcGx5U2NhbGFyKGxvb2tBaGVhZEZhY3Rvcik7CgogICAgICAgICAgICAgICAgLy8gU21vb3RoIHRoZSBsb29rLWFoZWFkCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLmxlcnAoX2xvb2tBaGVhZCwgZHQgKiB0aGlzLmNvbmZpZy5sb29rQWhlYWRTbW9vdGhpbmcpOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay5hZGQodGhpcy5zbW9vdGhlZExvb2tBaGVhZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLm11bHRpcGx5U2NhbGFyKDEuMCAtIGR0ICogMy4wKTsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2suYWRkKHRoaXMuc21vb3RoZWRMb29rQWhlYWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfaWRlYWxMb29rLnkgKj0gMC41OyAvLyBMb29rIHNsaWdodGx5IGxvd2VyIHRoYW4gYWN0dWFsIHRhcmdldCBoZWlnaHQKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBJbmNsdWRlIGJhbGwgaW4gZnJhbWluZyB3aGVuIG5lYXJieQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5tZXNoICYmIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxQb3MgPSB0aGlzLmJhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSB0UG9zLmRpc3RhbmNlVG8oYmFsbFBvcyk7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCAyNSAmJiBkaXN0VG9CYWxsID4gMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxXZWlnaHQgPSBNYXRoLm1heCgwLCAxIC0gZGlzdFRvQmFsbCAvIDI1KSAqIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodDsKICAgICAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmxlcnAoYmFsbFBvcywgYmFsbFdlaWdodCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIElucHV0IEFudGljaXBhdGlvbiAoU21vb3RoZWQpCiAgICAgICAgICAgIHRoaXMuc21vb3RoZWRJbnB1dC5sZXJwKHRoaXMudGFyZ2V0SW5wdXQsIGR0ICogMy4wKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnNtb290aGVkSW5wdXQubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueCArPSB0aGlzLnNtb290aGVkSW5wdXQueCAqIDQuMDsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueiArPSB0aGlzLnNtb290aGVkSW5wdXQueiAqIDQuMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NhbGN1bGF0ZVRocmVhdExldmVsKGNlbnRlclBvcykgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSkgcmV0dXJuIDA7CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgZGVuc2l0eSA9IDA7CiAgICAgICAgICAgIGNvbnN0IGNoZWNrVGVhbSA9ICh0ZWFtKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXRlYW0pIHJldHVybjsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBpZiAocC5tZXNoICYmIHAubWVzaCAhPT0gdGhpcy50YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZFNxID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG9TcXVhcmVkKGNlbnRlclBvcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkU3EgPCA2NC4wKSB7IC8vIDhtIHJhZGl1cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVuc2l0eSArPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGNoZWNrVGVhbShnYW1lLnRlYW1zLmhvbWUpOwogICAgICAgICAgICBjaGVja1RlYW0oZ2FtZS50ZWFtcy5hd2F5KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBNYXRoLm1pbigxLjAsIGRlbnNpdHkgLyA0LjApOyAvLyBDYXAgYXQgNCBwbGF5ZXJzCiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IEdldCBmb3J3YXJkIGRpcmVjdGlvbiBmb3IgVUkgcmVmZXJlbmNlCiAgICAgICAgZ2V0Rm9yd2FyZERpcmVjdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX2NhbUZ3ZC5jbG9uZSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBHZXQgcmlnaHQgZGlyZWN0aW9uCiAgICAgICAgZ2V0UmlnaHREaXJlY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IHRoaXMuZ2V0Rm9yd2FyZERpcmVjdGlvbigpOwogICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApLCBmd2QpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICByZXR1cm4gX2NhbVJpZ2h0LmNsb25lKCk7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkNhbWVyYU1hbmFnZXIgPSBDYW1lcmFNYW5hZ2VyOwp9KSgpOwo=","/CameraManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzIHRvIGF2b2lkIEdhcmJhZ2UgQ29sbGVjdGlvbgogICAgY29uc3QgX2lkZWFsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9pZGVhbExvb2sgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF92ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGFyZ2V0V29ybGRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9nb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICBjbGFzcyBDYW1lcmFNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihjYW1lcmEsIHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CgogICAgICAgICAgICAvLyAtLS0gSU1QUk9WRUQgQ09ORklHVVJBVElPTiAtLS0KLy8gLS0tIElNUFJPVkVEIENPTkZJR1VSQVRJT04gLS0tCiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gewogICAgICAgICAgICAgICAgLy8gRklYRUQgUEVSU1BFQ1RJVkUgU0VUVElOR1MKICAgICAgICAgICAgICAgIGJhc2VEaXN0YW5jZTogMjAuMCwgICAvLyBTbGlnaHRseSBjbG9zZXIgZm9yIGltbWVyc2lvbgogICAgICAgICAgICAgICAgYmFzZUhlaWdodDogMTIuMCwgICAgIC8vIExvd2VyIGFuZ2xlIGZvciBjaGFzZSBmZWVsCgogICAgICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEZhc3RlciwgbW9yZSByZXNwb25zaXZlIHNtb290aGluZwogICAgICAgICAgICAgICAgZm9sbG93U3BlZWQ6IDYuMCwgICAgIC8vIFNuYXBwaWVyIGZvbGxvdwogICAgICAgICAgICAgICAgbG9va1NwZWVkOiA0LjAsICAgICAgIC8vIFJlc3BvbnNpdmUgbG9vay1hdAoKICAgICAgICAgICAgICAgIC8vIER5bmFtaWMgRk9WCiAgICAgICAgICAgICAgICBmb3ZCYXNlOiA1MCwKICAgICAgICAgICAgICAgIGZvdk1heDogNzAsICAgICAgICAgICAvLyBIaWdoZXIgbWF4IGZvciBzcGVlZCBzZW5zYXRpb24KCiAgICAgICAgICAgICAgICAvLyBJTVBST1ZFRDogTG9vay1haGVhZCBzZXR0aW5ncwogICAgICAgICAgICAgICAgbG9va0FoZWFkRGlzdGFuY2U6IDEwLjAsIC8vIExvb2sgZnVydGhlciBhaGVhZAogICAgICAgICAgICAgICAgbG9va0FoZWFkU21vb3RoaW5nOiA0LjAsCgogICAgICAgICAgICAgICAgLy8gU21hcnQgZnJhbWluZwogICAgICAgICAgICAgICAgYmFsbFRyYWNrV2VpZ2h0OiAwLjE1LCAKICAgICAgICAgICAgICAgIHRocmVhdEF3YXJlbmVzczogdHJ1ZQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gU3RhdGUKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmJhbGwgPSBudWxsOyAvLyBEaXJlY3QgYmFsbCByZWZlcmVuY2UgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICAgICAgdGhpcy50YXJnZXRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnRhcmdldElucHV0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZElucHV0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZExvb2tBaGVhZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBDYW1lcmEgU3RhdGUKICAgICAgICAgICAgdGhpcy5wb3MgPSBjYW1lcmEucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIE9yYml0IFN0YXRlCiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IE1hdGguUEk7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0WWF3ID0gTWF0aC5QSTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBNYW51YWwgb3JiaXQgZnJvbSB0b3VjaCAocmlnaHQgc2lkZSBvZiBzY3JlZW4pCiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSAwOwogICAgICAgICAgICB0aGlzLm9yYml0U2Vuc2l0aXZpdHkgPSAwLjAwNDsKICAgICAgICAgICAgdGhpcy5hdXRvUmVjZW50ZXJUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyRGVsYXkgPSAzLjA7CgovLyBTaGFrZQogICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gMDsKICAgICAgICAgICAgdGhpcy5zaGFrZVJvbGwgPSAwOyAvLyBORVc6IFJvdGF0aW9uYWwgc2hha2UKdGhpcy5zaGFrZU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSA9IDA7CiAgICAgICAgICAgIHRoaXMucm9sbEltcHVsc2UgPSAwOyAvLyBORVc6IER5bmFtaWMgdGlsdCBmb3IgY3VydmVzCgogICAgICAgICAgICAvLyBDaW5lbWF0aWMgU3RhdGUKICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVHlwZSA9ICdkZWZhdWx0JzsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNFbmRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IER5bmFtaWMgcHVsbC1iYWNrIGJhc2VkIG9uIGFjdGlvbgogICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4UHVsbEJhY2sgPSA4OwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBTZXQgYmFsbCByZWZlcmVuY2UgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICBzZXRCYWxsKGJhbGwpIHsKICAgICAgICAgICAgdGhpcy5iYWxsID0gYmFsbDsKICAgICAgICB9CgogICAgICAgIC8vIElNUFJPVkVEOiBHZXQgY2FtZXJhLXJlbGF0aXZlIGlucHV0IHRyYW5zZm9ybWF0aW9uCiAgICAgICAgZ2V0Q2FtZXJhUmVsYXRpdmVJbnB1dChpbnB1dFgsIGlucHV0WikgewogICAgICAgICAgICB0aGlzLmNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKCiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKSwgX2NhbUZ3ZCkubm9ybWFsaXplKCk7CgogICAgICAgICAgICAvLyBUcmFuc2Zvcm0gaW5wdXQgdG8gd29ybGQgc3BhY2UKICAgICAgICAgICAgY29uc3Qgd29ybGRYID0gKGlucHV0WCAqIF9jYW1SaWdodC54KSArIChpbnB1dFogKiBfY2FtRndkLngpOwogICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoaW5wdXRYICogX2NhbVJpZ2h0LnopICsgKGlucHV0WiAqIF9jYW1Gd2Queik7CgogICAgICAgICAgICByZXR1cm4geyB4OiB3b3JsZFgsIHo6IHdvcmxkWiB9OwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBNYW51YWwgb3JiaXQgaW5wdXQgZnJvbSB0b3VjaAogICAgICAgIGhhbmRsZU9yYml0SW5wdXQoZHgsIGR5KSB7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgKz0gZHggKiB0aGlzLm9yYml0U2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCArPSBkeSAqIHRoaXMub3JiaXRTZW5zaXRpdml0eSAqIDAuNTsKCiAgICAgICAgICAgIC8vIENsYW1wIHBpdGNoCiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IE1hdGgubWF4KC0wLjMsIE1hdGgubWluKDAuNSwgdGhpcy5tYW51YWxPcmJpdFBpdGNoKSk7CgogICAgICAgICAgICAvLyBSZXNldCBhdXRvLXJlY2VudGVyIHRpbWVyCiAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyVGltZXIgPSAwOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBSZWNlbnRlciBjYW1lcmEKICAgICAgICByZWNlbnRlcigpIHsKICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyA9IDA7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IDA7CiAgICAgICAgfQoKICAgICAgICBwbGF5Q2luZW1hdGljKHR5cGUsIHRhcmdldCwgZHVyYXRpb24gPSAxLjUpIHsKICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY0R1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1R5cGUgPSB0eXBlOwoKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydFBvcy5jb3B5KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydExvb2suY29weSh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLmFkZEZvdkltcHVsc2UoLTE1KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVDaW5lbWF0aWMoZHQpIHsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUaW1lciArPSBkdDsKICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBNYXRoLm1pbigxLjAsIHRoaXMuY2luZW1hdGljVGltZXIgLyB0aGlzLmNpbmVtYXRpY0R1cmF0aW9uKTsKCiAgICAgICAgICAgIGNvbnN0IHQgPSAxIC0gTWF0aC5wb3coMSAtIHByb2dyZXNzLCAzKTsKCiAgICAgICAgICAgIGxldCBhY3RpdmVUYXJnZXQgPSB0aGlzLnRhcmdldDsKICAgICAgICAgICAgbGV0IGlzQmFsbFRyYWNraW5nID0gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCA6IG51bGw7CgogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2ggJiYgYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnICYmIGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDIuMCkgewogICAgICAgICAgICAgICAgYWN0aXZlVGFyZ2V0ID0gYmFsbC5tZXNoOwogICAgICAgICAgICAgICAgaXNCYWxsVHJhY2tpbmcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWFjdGl2ZVRhcmdldCkgewogICAgICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhY3RpdmVUYXJnZXQuZ2V0V29ybGRQb3NpdGlvbihfdGFyZ2V0V29ybGRQb3MpOwoKICAgICAgICAgICAgY29uc3QgZW5kTG9vayA9IF90YXJnZXRXb3JsZFBvcy5jbG9uZSgpOwogICAgICAgICAgICBsZXQgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgbGV0IHJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIGlmIChpc0JhbGxUcmFja2luZykgewogICAgICAgICAgICAgICAgZW5kTG9vay5hZGRTY2FsZWRWZWN0b3IoYmFsbC52ZWxvY2l0eSwgMC4zKTsKCiAgICAgICAgICAgICAgICBmd2QuY29weShiYWxsLnZlbG9jaXR5KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgIGlmIChmd2QubGVuZ3RoU3EoKSA8IDAuMDEpIGZ3ZC5zZXQoMCwwLDEpOwogICAgICAgICAgICAgICAgZndkLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgIHJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIGZ3ZCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbmRMb29rLnkgKz0gMS41OwogICAgICAgICAgICAgICAgZndkLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24oYWN0aXZlVGFyZ2V0LnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgcmlnaHQuc2V0KDEsIDAsIDApLmFwcGx5UXVhdGVybmlvbihhY3RpdmVUYXJnZXQucXVhdGVybmlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGVuZFBvcyA9IF90YXJnZXRXb3JsZFBvcy5jbG9uZSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ2plY2h0JykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGlzQmFsbFRyYWNraW5nID8gMTQuMCA6IDEwLjA7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmd2QuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtZGlzdCkuYWRkKHJpZ2h0LmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMy4wKSk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSA2LjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5jaW5lbWF0aWNUeXBlID09PSAnc3BoZXJlJykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGlzQmFsbFRyYWNraW5nID8gMTYuMCA6IDEyLjA7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmd2QuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtZGlzdCk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSAxMC4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ2ludmlzaWJsZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSAxMi4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QgKiAwLjUpLmFkZChyaWdodC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKGRpc3QpKTsKICAgICAgICAgICAgICAgIGVuZFBvcy5hZGQob2Zmc2V0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy55ICs9IDUuMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE0LjAgOiAxMC4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gNS4wOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnBvcy5sZXJwKGVuZFBvcywgZHQgKiA0LjApOwogICAgICAgICAgICB0aGlzLmxvb2tBdC5sZXJwKGVuZExvb2ssIGR0ICogNi4wKTsKCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLmNvcHkodGhpcy5wb3MpOwogICAgICAgICAgICB0aGlzLmNhbWVyYS5sb29rQXQodGhpcy5sb29rQXQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2luZW1hdGljVGltZXIgPj0gdGhpcy5jaW5lbWF0aWNEdXJhdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKc2V0VGFyZ2V0KG1lc2gsIHZlbG9jaXR5LCBpbnB1dCwgaXNBaW1pbmcgPSBmYWxzZSkgewogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG1lc2g7CiAgICAgICAgICAgIGlmICh2ZWxvY2l0eSkgdGhpcy50YXJnZXRWZWwuY29weSh2ZWxvY2l0eSk7CiAgICAgICAgICAgIGlmIChpbnB1dCkgdGhpcy50YXJnZXRJbnB1dC5jb3B5KGlucHV0KTsKICAgICAgICAgICAgZWxzZSB0aGlzLnRhcmdldElucHV0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5pc0FpbWluZyA9IGlzQWltaW5nOwogICAgICAgIH0KCiAgICAgICAgLy8gS2VlcCBmb3IgY29tcGF0aWJpbGl0eQogICAgICAgIGhhbmRsZUlucHV0KGR4LCBkeSkgewogICAgICAgICAgICB0aGlzLmhhbmRsZU9yYml0SW5wdXQoZHgsIGR5KTsKICAgICAgICB9CgogICAgICAgIGdldFlhdygpIHsgcmV0dXJuIHRoaXMuY3VycmVudFlhdzsgfQoKICAgICAgICBhZGRTaGFrZShhbW91bnQpIHsKCiAgICAgICAgICAgIHRoaXMuc2hha2VJbnRlbnNpdHkgPSBNYXRoLm1pbih0aGlzLnNoYWtlSW50ZW5zaXR5ICsgYW1vdW50LCA0LjApOyAvLyBJbmNyZWFzZWQgY2FwCiAgICAgICAgICAgIHRoaXMuc2hha2VSb2xsID0gTWF0aC5taW4odGhpcy5zaGFrZVJvbGwgKyBhbW91bnQgKiAwLjIsIDAuOCk7IC8vIEFkZCByb2xsCiAgICAgICAgfQogICAgICAgIGFkZEZvdkltcHVsc2UoYW1vdW50KSB7CiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSA9IE1hdGgubWluKHRoaXMuZm92SW1wdWxzZSArIGFtb3VudCwgMzApOwoKICAgICAgICB9CiAgICAgICAgYWRkUm9sbEltcHVsc2UoYW1vdW50KSB7CiAgICAgICAgICAgIHRoaXMucm9sbEltcHVsc2UgKz0gYW1vdW50OwogICAgICAgICAgICAvLyBDbGFtcAogICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlID0gTWF0aC5tYXgoLTAuNSwgTWF0aC5taW4oMC41LCB0aGlzLnJvbGxJbXB1bHNlKSk7Cn0KCiAgICAgICAgc25hcFRvVGFyZ2V0KCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGFyZ2V0KSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIHRoaXMuX2NhbGN1bGF0ZUlkZWFsU3RhdGUoMCk7CgogICAgICAgICAgICB0aGlzLnBvcy5jb3B5KF9pZGVhbFBvcyk7CiAgICAgICAgICAgIHRoaXMubG9va0F0LmNvcHkoX2lkZWFsTG9vayk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IHRoaXMudGFyZ2V0WWF3OwoKICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uY29weSh0aGlzLnBvcyk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmxvb2tBdCh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLnNtb290aGVkSW5wdXQuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLCAwLCAwKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0NpbmVtYXRpYykgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQ2luZW1hdGljKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLnRhcmdldCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgc2FmZUR0ID0gTWF0aC5taW4oZHQsIDAuMDUpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEF1dG8tcmVjZW50ZXIgbG9naWMgKE9ubHkgaWYgbm90IGFpbWluZykKICAgICAgICAgICAgaWYgKCF0aGlzLmlzQWltaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyICs9IHNhZmVEdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1dG9SZWNlbnRlclRpbWVyID4gdGhpcy5hdXRvUmVjZW50ZXJEZWxheSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY2VudGVyU3BlZWQgPSAyLjAgKiBzYWZlRHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyAqPSAoMS4wIC0gcmVjZW50ZXJTcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFBpdGNoICo9ICgxLjAgLSByZWNlbnRlclNwZWVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IFNtYXJ0IHB1bGwtYmFjayBiYXNlZCBvbiBiYWxsIHNwZWVkCiAgICAgICAgICAgIGlmICh0aGlzLmJhbGwgJiYgdGhpcy5iYWxsLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsU3BlZWQgPSB0aGlzLmJhbGwudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRQdWxsQmFjayA9IE1hdGgubWluKHRoaXMubWF4UHVsbEJhY2ssIGJhbGxTcGVlZCAqIDAuMyk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayArPSAodGFyZ2V0UHVsbEJhY2sgLSB0aGlzLmN1cnJlbnRQdWxsQmFjaykgKiBzYWZlRHQgKiAzLjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayAqPSAoMS4wIC0gc2FmZUR0ICogMi4wKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMS4gVXBkYXRlIFRhcmdldCBJbmZvCiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBTdGF0ZQogICAgICAgICAgICB0aGlzLl9jYWxjdWxhdGVJZGVhbFN0YXRlKHNhZmVEdCk7CgogICAgICAgICAgICAvLyAzLiBJTVBST1ZFRDogRmFzdGVyLCBtb3JlIHJlc3BvbnNpdmUgc21vb3RoaW5nCi8vIDMuIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKICAgICAgICAgICAgLy8gRHluYW1pYyBmb2xsb3cgc3BlZWQgYmFzZWQgb24gZGlzdGFuY2UgZXJyb3IgKENhdGNoLXVwIGxvZ2ljKQogICAgICAgICAgICBjb25zdCBkaXN0RXJyb3IgPSB0aGlzLnBvcy5kaXN0YW5jZVRvKF9pZGVhbFBvcyk7CiAgICAgICAgICAgIGNvbnN0IGR5bmFtaWNGb2xsb3cgPSB0aGlzLmNvbmZpZy5mb2xsb3dTcGVlZCArIChkaXN0RXJyb3IgKiAwLjIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3Qgc3BlZWRNdWx0ID0gdGhpcy5pc0FpbWluZyA/IDIuMCA6IDEuMDsKICAgICAgICAgICAgY29uc3QgbG9va0ZhY3RvciA9IDEuMCAtIE1hdGguZXhwKC10aGlzLmNvbmZpZy5sb29rU3BlZWQgKiBzcGVlZE11bHQgKiBzYWZlRHQpOwogICAgICAgICAgICBjb25zdCBwb3NGYWN0b3IgPSAxLjAgLSBNYXRoLmV4cCgtZHluYW1pY0ZvbGxvdyAqIHNwZWVkTXVsdCAqIHNhZmVEdCk7CgogICAgICAgICAgICB0aGlzLnBvcy5sZXJwKF9pZGVhbFBvcywgcG9zRmFjdG9yKTsKICAgICAgICAgICAgdGhpcy5wb3MubGVycChfaWRlYWxQb3MsIHBvc0ZhY3Rvcik7CiAgICAgICAgICAgIHRoaXMubG9va0F0LmxlcnAoX2lkZWFsTG9vaywgbG9va0ZhY3Rvcik7CgogICAgICAgICAgICAvLyA0LiBTY3JlZW4gU2hha2UgKFBvc2l0aW9uICYgUm90YXRpb24pCiAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlSW50ZW5zaXR5ID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgZGVjYXkgPSA4LjAgKiBzYWZlRHQ7IC8vIEZhc3QgZGVjYXkgZm9yIHNuYXBweSBmZWVsCiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5IC09IGRlY2F5OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hha2VJbnRlbnNpdHkgPCAwKSB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gMDsKCiAgICAgICAgICAgICAgICBjb25zdCBzaGFrZU1hZyA9IHRoaXMuc2hha2VJbnRlbnNpdHkgKiAwLjU7CiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlT2Zmc2V0LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZU1hZywKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZU1hZywKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZU1hZwogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hha2VPZmZzZXQuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSb2xsIFNoYWtlCiAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlUm9sbCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hha2VSb2xsIC09IDUuMCAqIHNhZmVEdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlUm9sbCA8IDApIHRoaXMuc2hha2VSb2xsID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhLnJvdGF0aW9uLnogPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiB0aGlzLnNoYWtlUm9sbDsKfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhLnJvdGF0aW9uLnogPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBDdXJ2ZSBUaWx0IChSb2xsIEltcHVsc2UpCiAgICAgICAgICAgIGlmIChNYXRoLmFicyh0aGlzLnJvbGxJbXB1bHNlKSA+IDAuMDAxKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5yb3RhdGlvbi56ICs9IHRoaXMucm9sbEltcHVsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlICo9ICgxLjAgLSA0LjAgKiBzYWZlRHQpOyAvLyBEZWNheQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA1LiBEeW5hbWljIEZPVgovLyA1LiBEeW5hbWljIEZPVgogICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudGFyZ2V0VmVsLmxlbmd0aCgpOwogICAgICAgICAgICBjb25zdCBzcGVlZFJhdGlvID0gTWF0aC5taW4oc3BlZWQgLyAyNS4wLCAxLjApOwogICAgICAgICAgICBjb25zdCB3YXJwID0gc3BlZWRSYXRpbyAqIHNwZWVkUmF0aW87CgogICAgICAgICAgICAvLyBab29tIGluIHNsaWdodGx5IHdoZW4gYWltaW5nCiAgICAgICAgICAgIGNvbnN0IGFpbVpvb20gPSB0aGlzLmlzQWltaW5nID8gLTEwIDogMDsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0Rm92ID0gdGhpcy5jb25maWcuZm92QmFzZSArICh0aGlzLmNvbmZpZy5mb3ZNYXggLSB0aGlzLmNvbmZpZy5mb3ZCYXNlKSAqIHdhcnAgKyB0aGlzLmZvdkltcHVsc2UgKyBhaW1ab29tOwoKICAgICAgICAgICAgdGhpcy5mb3ZJbXB1bHNlICo9IE1hdGgubWF4KDAsIDEuMCAtICg2LjAgKiBzYWZlRHQpKTsKCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmZvdiArPSAodGFyZ2V0Rm92IC0gdGhpcy5jYW1lcmEuZm92KSAqIDQuMCAqIHNhZmVEdDsKICAgICAgICAgICAgdGhpcy5jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwoKICAgICAgICAgICAgLy8gNi4gQXBwbHkgdG8gQ2FtZXJhCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLmNvcHkodGhpcy5wb3MpLmFkZCh0aGlzLnNoYWtlT2Zmc2V0KTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKICAgICAgICB9CgpfY2FsY3VsYXRlSWRlYWxTdGF0ZShkdCkgewogICAgICAgICAgICBjb25zdCB0UG9zID0gX3RhcmdldFdvcmxkUG9zOwoKICAgICAgICAgICAgLy8gLS0tIEFJTSBNT0RFIE9WRVJSSURFIC0tLQogICAgICAgICAgICBpZiAodGhpcy5pc0FpbWluZykgewogICAgICAgICAgICAgICAgLy8gUmVsYXhlZCBBaW0gTW9kZTogWm9vbSBpbiBidXQgbWFpbnRhaW4gb3JpZW50YXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IGFpbURpc3QgPSAxNC4wOyAKICAgICAgICAgICAgICAgIGNvbnN0IGFpbUhlaWdodCA9IDYuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXNlIE1hbnVhbCBPcmJpdCBMb2dpYyAoQ29uc2lzdGVudCB3aXRoIFN0YW5kYXJkIE1vZGUpCiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVEaXN0YW5jZSA9IGFpbURpc3Q7CiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVIZWlnaHQgPSBhaW1IZWlnaHQgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmFzZSBaIG9mZnNldCAoQ2FtZXJhIGRlZmF1bHRzIHRvICtaKQogICAgICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBcHBseSBPcmJpdCBSb3RhdGlvbgogICAgICAgICAgICAgICAgY29uc3QgZmluYWxYID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgY29uc3QgZmluYWxaID0gY2FtWiAqIE1hdGguY29zKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbFopOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmNvcHkodFBvcyk7CiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLnkgKz0gMS4wOyAvLyBMb29rIGF0IHBsYXllciBjZW50ZXIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzYWJsZSBsb29rLWFoZWFkIHRvIGtlZXAgZnJhbWluZyBzdGFibGUgd2hpbGUgYWltaW5nCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFNUQU5EQVJEIE1PREUgLS0tCgogICAgICAgICAgICAvLyAwLiBUaHJlYXQgQXNzZXNzbWVudCAoRHluYW1pYyBQdWxsLWJhY2spCiAgICAgICAgICAgIGxldCB0aHJlYXRQdWxsYmFjayA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLmNvbmZpZy50aHJlYXRBd2FyZW5lc3MpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRocmVhdCA9IHRoaXMuX2NhbGN1bGF0ZVRocmVhdExldmVsKHRQb3MpOwogICAgICAgICAgICAgICAgdGhyZWF0UHVsbGJhY2sgPSB0aHJlYXQgKiA2LjA7IC8vIFB1bGwgYmFjayB1cCB0byA2IHVuaXRzCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBBcHBseSBtYW51YWwgb3JiaXQKICAgICAgICAgICAgLy8gMS4gQ2FsY3VsYXRlIElkZWFsIFBvc2l0aW9uIHdpdGggcHVsbC1iYWNrCiAgICAgICAgICAgIGNvbnN0IGVmZmVjdGl2ZURpc3RhbmNlID0gdGhpcy5jb25maWcuYmFzZURpc3RhbmNlICsgdGhpcy5jdXJyZW50UHVsbEJhY2sgKyB0aHJlYXRQdWxsYmFjazsKICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlSGVpZ2h0ID0gdGhpcy5jb25maWcuYmFzZUhlaWdodCArIHRoaXMuY3VycmVudFB1bGxCYWNrICogMC4zICsgdGhyZWF0UHVsbGJhY2sgKiAwLjUgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKCiAgICAgICAgICAgIC8vIEJhc2Ugb2Zmc2V0IChDYW1lcmEgdXN1YWxseSBzaXRzIGF0ICtaIHJlbGF0aXZlIHRvIHRhcmdldCkKICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwoKICAgICAgICAgICAgLy8gQXBwbHkgT3JiaXQgUm90YXRpb24KICAgICAgICAgICAgY29uc3QgZmluYWxDYW1YID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICBjb25zdCBmaW5hbENhbVogPSBjYW1aICogTWF0aC5jb3ModGhpcy5tYW51YWxPcmJpdFlhdyk7CgogICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsQ2FtWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbENhbVopOwoKICAgICAgICAgICAgLy8gQ2xhbXAgdG8gYXJlbmEgYm91bmRzIChyb3VnaGx5KSB0byBwcmV2ZW50IGNsaXBwaW5nIHRocm91Z2ggd2FsbHMKICAgICAgICAgICAgaWYgKF9pZGVhbFBvcy56ID4gNDguMCkgX2lkZWFsUG9zLnogPSA0OC4wOwogICAgICAgICAgICBpZiAoX2lkZWFsUG9zLnogPCAtNDguMCkgX2lkZWFsUG9zLnogPSAtNDguMDsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBMb29rQXQgd2l0aCBJTVBST1ZFRCBsb29rLWFoZWFkCiAgICAgICAgICAgIF9pZGVhbExvb2suY29weSh0UG9zKTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBWZWxvY2l0eS1iYXNlZCBsb29rLWFoZWFkCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFZlbC5sZW5ndGhTcSgpID4gMC41KSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudGFyZ2V0VmVsLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3QgbG9va0FoZWFkRmFjdG9yID0gTWF0aC5taW4oMS4wLCBzcGVlZCAvIDE1LjApICogdGhpcy5jb25maWcubG9va0FoZWFkRGlzdGFuY2U7CgogICAgICAgICAgICAgICAgY29uc3QgdmVsRGlyID0gdGhpcy50YXJnZXRWZWwuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIF9sb29rQWhlYWQuY29weSh2ZWxEaXIpLm11bHRpcGx5U2NhbGFyKGxvb2tBaGVhZEZhY3Rvcik7CgogICAgICAgICAgICAgICAgLy8gU21vb3RoIHRoZSBsb29rLWFoZWFkCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLmxlcnAoX2xvb2tBaGVhZCwgZHQgKiB0aGlzLmNvbmZpZy5sb29rQWhlYWRTbW9vdGhpbmcpOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay5hZGQodGhpcy5zbW9vdGhlZExvb2tBaGVhZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLm11bHRpcGx5U2NhbGFyKDEuMCAtIGR0ICogMy4wKTsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2suYWRkKHRoaXMuc21vb3RoZWRMb29rQWhlYWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfaWRlYWxMb29rLnkgKj0gMC41OyAvLyBMb29rIHNsaWdodGx5IGxvd2VyIHRoYW4gYWN0dWFsIHRhcmdldCBoZWlnaHQKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBJbmNsdWRlIGJhbGwgaW4gZnJhbWluZyB3aGVuIG5lYXJieQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5tZXNoICYmIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxQb3MgPSB0aGlzLmJhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSB0UG9zLmRpc3RhbmNlVG8oYmFsbFBvcyk7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCAyNSAmJiBkaXN0VG9CYWxsID4gMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxXZWlnaHQgPSBNYXRoLm1heCgwLCAxIC0gZGlzdFRvQmFsbCAvIDI1KSAqIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodDsKICAgICAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmxlcnAoYmFsbFBvcywgYmFsbFdlaWdodCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIElucHV0IEFudGljaXBhdGlvbiAoU21vb3RoZWQpCiAgICAgICAgICAgIHRoaXMuc21vb3RoZWRJbnB1dC5sZXJwKHRoaXMudGFyZ2V0SW5wdXQsIGR0ICogMy4wKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnNtb290aGVkSW5wdXQubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueCArPSB0aGlzLnNtb290aGVkSW5wdXQueCAqIDQuMDsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueiArPSB0aGlzLnNtb290aGVkSW5wdXQueiAqIDQuMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NhbGN1bGF0ZVRocmVhdExldmVsKGNlbnRlclBvcykgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSkgcmV0dXJuIDA7CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgZGVuc2l0eSA9IDA7CiAgICAgICAgICAgIGNvbnN0IGNoZWNrVGVhbSA9ICh0ZWFtKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXRlYW0pIHJldHVybjsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBpZiAocC5tZXNoICYmIHAubWVzaCAhPT0gdGhpcy50YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZFNxID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG9TcXVhcmVkKGNlbnRlclBvcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkU3EgPCA2NC4wKSB7IC8vIDhtIHJhZGl1cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVuc2l0eSArPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGNoZWNrVGVhbShnYW1lLnRlYW1zLmhvbWUpOwogICAgICAgICAgICBjaGVja1RlYW0oZ2FtZS50ZWFtcy5hd2F5KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBNYXRoLm1pbigxLjAsIGRlbnNpdHkgLyA0LjApOyAvLyBDYXAgYXQgNCBwbGF5ZXJzCiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IEdldCBmb3J3YXJkIGRpcmVjdGlvbiBmb3IgVUkgcmVmZXJlbmNlCiAgICAgICAgZ2V0Rm9yd2FyZERpcmVjdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX2NhbUZ3ZC5jbG9uZSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBHZXQgcmlnaHQgZGlyZWN0aW9uCiAgICAgICAgZ2V0UmlnaHREaXJlY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IHRoaXMuZ2V0Rm9yd2FyZERpcmVjdGlvbigpOwogICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApLCBmd2QpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICByZXR1cm4gX2NhbVJpZ2h0LmNsb25lKCk7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkNhbWVyYU1hbmFnZXIgPSBDYW1lcmFNYW5hZ2VyOwp9KSgpOwo=","ParticleManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUT1JTIC0tLQogICAgCiAgICAvLyAxLiBWZW5vbSBCdWJibGUgKEdyZWVuLCBzaGlueSwgc2hhcnApCiAgICBjb25zdCBfdmVub21UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMzIsIDMyLCA0LCAzMiwgMzIsIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgxNTAsIDI1NSwgMTAwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgwLCAyMDAsIDAsIDAuNSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCA1MCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45KSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDIwLCAyMCwgNiwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDIuIFNsZWVwIFp6egogICAgY29uc3QgX25hcFRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZvbnQgPSAnYm9sZCBpdGFsaWMgNDhweCBzYW5zLXNlcmlmJzsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gJyMwMDAwZmYnOwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gNDsKICAgICAgICBjdHguZmlsbFRleHQoJ1onLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gMy4gV2l0aGVyIFNtb2tlCi8vIDMuIFdpdGhlciBTbW9rZSAoT3B0aW1pemVkIHRvIDMyeDMyKQogICAgY29uc3QgX3dpdGhlclRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSAzMjsgYy5oZWlnaHQgPSAzMjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgxNiwgMTYsIDAsIDE2LCAxNiwgMTYpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDgwLCA4MCwgODAsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjUsICdyZ2JhKDQwLCA0MCwgNDAsIDAuNCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCAwLCAwLCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNC4gU2hvY2t3YXZlIFJpbmcgKE9wdGltaXplZCB0byA2NHg2NCkKICAgIGNvbnN0IF9zaG9ja3dhdmVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGN4ID0gMzIsIGN5ID0gMzI7CiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChjeCwgY3ksIDIwLCBjeCwgY3ksIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCA2NCwgNjQpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNS4gRmxhc2ggU3RhciAoT3B0aW1pemVkIHRvIDMyeDMyKQogICAgY29uc3QgX2ZsYXNoVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBjeCA9IDE2LCBjeSA9IDE2OwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmZmZic7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGZvcihsZXQgaT0wOyBpPDQ7IGkrKykgewogICAgICAgICAgICBjb25zdCBhID0gKGkgKiBNYXRoLlBJIC8gMik7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3gsIGN5KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKjE1LCBjeSArIE1hdGguc2luKGEpKjE1KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEgKyAwLjIpKjUsIGN5ICsgTWF0aC5zaW4oYSArIDAuMikqNSk7CiAgICAgICAgfQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChjeCwgY3ksIDAsIGN4LCBjeSwgMTApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDEpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoY3gsIGN5LCAxMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDYuIERlYnJpcyBTaGFyZCAoTmV3KQogICAgY29uc3QgX2RlYnJpc1RleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSAzMjsgYy5oZWlnaHQgPSAzMjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbygxNiwgMCk7IGN0eC5saW5lVG8oMzIsIDE2KTsgY3R4LmxpbmVUbygxNiwgMzIpOyBjdHgubGluZVRvKDAsIDE2KTsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNy4gQnViYmxlIFRleHR1cmUgKE5ldzogQWVzdGhldGljICYgU3VidGxlKQovLyA3LiBCdWJibGUgVGV4dHVyZSAoTmV3OiBBZXN0aGV0aWMgJiBTdWJ0bGUpCiAgICBjb25zdCBfYnViYmxlVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICAvLyBDbGVhcgogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgNjQsIDY0KTsKCiAgICAgICAgLy8gVGlnaHRlciwgU2hpbW1lcnkgQnViYmxlCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgzMiwgMzIsIDAsIDMyLCAzMiwgMjgpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDAuOTUpJyk7IC8vIFNoYXJwIGhpZ2hsaWdodCBjZW50ZXIKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjMsICdyZ2JhKDIwMCwgMjQwLCAyNTUsIDAuNCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjgsICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCAwLCAwLCAwKScpOwogICAgICAgIAogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYygzMiwgMzIsIDMwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIC8vIFNoYXJwIFNwZWN1bGFyIERvdAogICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgyNTUsIDI1NSwgMjU1LCAxLjApJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IAogICAgICAgIGN0eC5hcmMoMjAsIDIwLCA0LCAwLCBNYXRoLlBJICogMik7IAogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA4LiBNaWNybyBCdWJibGUgKE5ldzogU2hhcnAsIGhpZ2gtdmlzIGNhdml0YXRpb24pCiAgICBjb25zdCBfbWljcm9CdWJibGVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgMzIsIDMyKTsKICAgICAgICAKICAgICAgICAvLyBJbnRlbnNlIGJyaWdodCBjb3JlCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgxNiwgMTYsIDAsIDE2LCAxNiwgMTYpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDEuMCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjMsICdyZ2JhKDIyMCwgMjU1LCAyNTUsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjYsICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLjAsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDE2LCAxNiwgMTYsIDAsIE1hdGguUEkqMik7IGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA5LiBEYXNoIFN0cmVhbSAoTmV3OiBTcGVlZCBsaW5lKQogICAgY29uc3QgX2Rhc2hTdHJlYW1UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gMTY7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlTGluZWFyR3JhZGllbnQoMCwgMCwgNjQsIDApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDAsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoMjAwLCAyNTUsIDI1NSwgMC44KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDAsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIAogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCA0LCA2NCwgOCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjbGFzcyBQYXJ0aWNsZU1hbmFnZXIgewoKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMucGFydGljbGVzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNb2JpbGUgT3B0aW1pemF0aW9uOiBDaGVjayBzY3JlZW4gd2lkdGgKICAgICAgICAgICAgY29uc3QgaXNNb2JpbGUgPSB3aW5kb3cuaW5uZXJXaWR0aCA8IDgwMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNoYXJlZCBNYXRlcmlhbHMKICAgICAgICAgICAgLy8gTm90ZTogYWxwaGFUZXN0IGFkZGVkIHRvIE5vcm1hbEJsZW5kaW5nIG1hdGVyaWFscyB0byBoZWxwIEdQVSBkaXNjYXJkIHRyYW5zcGFyZW50IHBpeGVscwogICAgICAgICAgICB0aGlzLm1hdGVyaWFscyA9IHsKICAgICAgICAgICAgICAgIHZlbm9tOiBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyBtYXA6IF92ZW5vbVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIG5hcDogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfbmFwVGV4LCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhXcml0ZTogZmFsc2UsIGJsZW5kaW5nOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywgYWxwaGFUZXN0OiAwLjEgfSksCiAgICAgICAgICAgICAgICB3aXRoZXI6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3dpdGhlclRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsIGFscGhhVGVzdDogMC4wNSB9KSwKICAgICAgICAgICAgICAgIGxlYXJuZWQ6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3Zlbm9tVGV4LCBjb2xvcjogMHgwMGZmZmYsIHRyYW5zcGFyZW50OiB0cnVlLCBkZXB0aFdyaXRlOiBmYWxzZSwgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcgfSksCiAgICAgICAgICAgICAgICBzaG9ja3dhdmU6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3Nob2Nrd2F2ZVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIGZsYXNoOiBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyBtYXA6IF9mbGFzaFRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIGRlYnJpczogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfZGVicmlzVGV4LCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhXcml0ZTogZmFsc2UsIGJsZW5kaW5nOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywgYWxwaGFUZXN0OiAwLjEgfSksCiAgICAgICAgICAgICAgICBidWJibGU6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2J1YmJsZVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIGJ1YmJsZV9taWNybzogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfbWljcm9CdWJibGVUZXgsIHRyYW5zcGFyZW50OiB0cnVlLCBkZXB0aFdyaXRlOiBmYWxzZSwgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcgfSksCiAgICAgICAgICAgICAgICBkYXNoX3N0cmVhbTogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfZGFzaFN0cmVhbVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gT2JqZWN0IFBvb2wKICAgICAgICAgICAgdGhpcy5wb29sID0gW107CiAgICAgICAgICAgIC8vIFJlZHVjZSBwb29sIHNpemUgb24gbW9iaWxlIHRvIHByZXZlbnQgZXhjZXNzaXZlIG92ZXJkcmF3CiAgICAgICAgICAgIHRoaXMucG9vbFNpemUgPSBpc01vYmlsZSA/IDEyMCA6IDMwMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgLy8gQ2xvbmUgbWF0ZXJpYWwgdG8gYWxsb3cgaW5kaXZpZHVhbCBvcGFjaXR5L3JvdGF0aW9uCiAgICAgICAgICAgICAgICAvLyBXZSBjbG9uZSAndmVub20nIGFzIGEgcGxhY2Vob2xkZXIsIGl0IGdldHMgb3ZlcndyaXR0ZW4gaW4gc3Bhd24oKQogICAgICAgICAgICAgICAgY29uc3QgbWF0ID0gdGhpcy5tYXRlcmlhbHMudmVub20uY2xvbmUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUobWF0KTsgCiAgICAgICAgICAgICAgICBzcHJpdGUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgc3ByaXRlLnNjYWxlLnNldCgwLDAsMCk7IAogICAgICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBEaXNhYmxlIGZydXN0dW0gY3VsbGluZyBmb3IgcGFydGljbGVzIHRvIGF2b2lkIENQVSBvdmVyaGVhZCBvZiBib3VuZGluZyBib3ggY2FsYwogICAgICAgICAgICAgICAgLy8gc2luY2UgdGhleSBhcmUgYWx3YXlzIGluIGZyb250IG9mIGNhbWVyYSB1c3VhbGx5LCBvciBjaGVhcCB0byBkcmF3LgogICAgICAgICAgICAgICAgLy8gQWN0dWFsbHksIGtlZXBpbmcgY3VsbGluZyBpcyBiZXR0ZXIgaWYgdGhleSBnbyBvZmYgc2NyZWVuLgogICAgICAgICAgICAgICAgLy8gc3ByaXRlLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsgCiAgICAgICAgICAgICAgICB0aGlzLnNjZW5lLmFkZChzcHJpdGUpOwogICAgICAgICAgICAgICAgdGhpcy5wb29sLnB1c2goc3ByaXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMucG9vbC5maW5kKHMgPT4gIXMudmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghcCkgcmV0dXJuOwoKICAgICAgICAgICAgcC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHRlbXBsYXRlID0gdGhpcy5tYXRlcmlhbHNbdHlwZV0gfHwgdGhpcy5tYXRlcmlhbHMudmVub207CiAgICAgICAgICAgIHAubWF0ZXJpYWwubWFwID0gdGVtcGxhdGUubWFwOwogICAgICAgICAgICBwLm1hdGVyaWFsLmJsZW5kaW5nID0gdGVtcGxhdGUuYmxlbmRpbmc7CiAgICAgICAgICAgIHAubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRlbXBsYXRlLmRlcHRoV3JpdGU7CiAgICAgICAgICAgIHAubWF0ZXJpYWwudHJhbnNwYXJlbnQgPSB0ZW1wbGF0ZS50cmFuc3BhcmVudDsKCiAgICAgICAgICAgIHAucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgcC5tYXRlcmlhbC5yb3RhdGlvbiA9IDA7CiAgICAgICAgICAgIHAubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZmZmZmKTsKICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwoKICAgICAgICAgICAgY29uc3QgZGF0YSA9IHsKICAgICAgICAgICAgICAgIG1lc2g6IHAsCiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgICAgICAgYWdlOiAwLAogICAgICAgICAgICAgICAgbGlmZTogb3B0aW9ucy5saWZlIHx8IDEuMCwKICAgICAgICAgICAgICAgIG1heExpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksCiAgICAgICAgICAgICAgICBzdGFydFNjYWxlOiBvcHRpb25zLnNjYWxlIHx8IDEuMCwKICAgICAgICAgICAgICAgIGdyYXZpdHk6IDAsCiAgICAgICAgICAgICAgICBkcmFnOiAwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBDb25maWd1cmF0aW9uIHBlciB0eXBlCiAgICAgICAgICAgIGlmICh0eXBlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICBkYXRhLmxpZmUgPSAxLjAgKyBNYXRoLnJhbmRvbSgpICogMC41OwogICAgICAgICAgICAgICAgZGF0YS52ZWxvY2l0eS5zZXQoMCwgMS4wICsgTWF0aC5yYW5kb20oKSwgMCk7CiAgICAgICAgICAgICAgICBkYXRhLnN0YXJ0U2NhbGUgPSAwLjMgKyBNYXRoLnJhbmRvbSgpICogMC4yOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMC44OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ25hcCcpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgIGRhdGEudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yLCAwLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yKTsKICAgICAgICAgICAgICAgIGRhdGEuc3RhcnRTY2FsZSA9IDAuNDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDEuNTsKICAgICAgICAgICAgICAgIGRhdGEudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC41LCAwLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC41KTsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDAuNjsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3Nob2Nrd2F2ZScpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IG9wdGlvbnMubGlmZSB8fCAwLjQ7CiAgICAgICAgICAgICAgICBkYXRhLm1heExpZmUgPSBkYXRhLmxpZmU7CiAgICAgICAgICAgICAgICBkYXRhLnN0YXJ0U2NhbGUgPSBvcHRpb25zLnNjYWxlIHx8IDIuMDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdmbGFzaCcpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDAuMjsKICAgICAgICAgICAgICAgIGRhdGEubWF4TGlmZSA9IDAuMjsKICAgICAgICAgICAgICAgIGRhdGEuc3RhcnRTY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMy4wOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwoKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZGVicmlzJykgewogICAgICAgICAgICAgICAgZGF0YS5saWZlID0gMS41OwogICAgICAgICAgICAgICAgZGF0YS5tYXhMaWZlID0gMS41OwogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSA1LjAgKyBNYXRoLnJhbmRvbSgpICogMTAuMDsKICAgICAgICAgICAgICAgIGRhdGEudmVsb2NpdHkuc2V0KAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcGVlZCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAqIHNwZWVkICogMC41KSArIDIuMCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogc3BlZWQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBkYXRhLmdyYXZpdHkgPSAyMC4wOwogICAgICAgICAgICAgICAgZGF0YS5kcmFnID0gMS4wOwogICAgICAgICAgICAgICAgZGF0YS5zdGFydFNjYWxlID0gKG9wdGlvbnMuc2NhbGUgfHwgMC4zKSAqICgwLjUgKyBNYXRoLnJhbmRvbSgpKTsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2J1YmJsZScpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDEuMCArIE1hdGgucmFuZG9tKCkgKiAxLjA7CiAgICAgICAgICAgICAgICBkYXRhLm1heExpZmUgPSBkYXRhLmxpZmU7CiAgICAgICAgICAgICAgICBkYXRhLnZlbG9jaXR5LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjUsCiAgICAgICAgICAgICAgICAgICAgMC41ICsgTWF0aC5yYW5kb20oKSAqIDEuMCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjUKICAgICAgICAgICAgICAgICk7CmRhdGEuc3RhcnRTY2FsZSA9IChvcHRpb25zLnNjYWxlIHx8IDAuMTUpICogKDAuOCArIE1hdGgucmFuZG9tKCkgKiAwLjQpOyAvLyBTbWFsbGVyLCB0aWdodGVyIGJ1YmJsZXMKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDAuOTsgLy8gTW9yZSBvcGFxdWUKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4YWFjY2ZmKTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2J1YmJsZV9taWNybycpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDAuNCArIE1hdGgucmFuZG9tKCkgKiAwLjQ7CiAgICAgICAgICAgICAgICBkYXRhLm1heExpZmUgPSBkYXRhLmxpZmU7CiAgICAgICAgICAgICAgICBkYXRhLnZlbG9jaXR5LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxLjUsCiAgICAgICAgICAgICAgICAgICAgMS41ICsgTWF0aC5yYW5kb20oKSAqIDIuMCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxLjUKICAgICAgICAgICAgICAgICk7CmRhdGEuc3RhcnRTY2FsZSA9IChvcHRpb25zLnNjYWxlIHx8IDAuMTUpICogKDAuOCArIE1hdGgucmFuZG9tKCkgKiAwLjUpOyAvLyBMYXJnZXIgbWljcm8gYnViYmxlcwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZmZmZmYpOwoKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZGFzaF9zdHJlYW0nKSB7CiAgICAgICAgICAgICAgICBkYXRhLmxpZmUgPSAwLjM7CiAgICAgICAgICAgICAgICBkYXRhLm1heExpZmUgPSAwLjM7CiAgICAgICAgICAgICAgICBkYXRhLnN0YXJ0U2NhbGUgPSBvcHRpb25zLnNjYWxlIHx8IDIuMDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDAuODsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGUgIT09ICdzaG9ja3dhdmUnKSB7CiAgICAgICAgICAgICAgICBwLnNjYWxlLnNldFNjYWxhcihkYXRhLnN0YXJ0U2NhbGUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcC5zY2FsZS5zZXRTY2FsYXIoMC4xKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXMucHVzaChkYXRhKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5wYXJ0aWNsZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnBhcnRpY2xlc1tpXTsKICAgICAgICAgICAgICAgIHAuYWdlICs9IGR0OwoKICAgICAgICAgICAgICAgIGlmIChwLmFnZSA+PSBwLmxpZmUpIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gcC5hZ2UgLyBwLmxpZmU7CgogICAgICAgICAgICAgICAgaWYgKHAuZ3Jhdml0eSA+IDApIHAudmVsb2NpdHkueSAtPSBwLmdyYXZpdHkgKiBkdDsKICAgICAgICAgICAgICAgIGlmIChwLmRyYWcgPiAwKSBwLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtIChwLmRyYWcgKiBkdCkpKTsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5hZGRTY2FsZWRWZWN0b3IocC52ZWxvY2l0eSwgZHQpOwoKICAgICAgICAgICAgICAgIGlmIChwLnR5cGUgPT09ICdzaG9ja3dhdmUnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcyA9IHAuc3RhcnRTY2FsZSAqIE1hdGgucG93KHQsIDAuNSkgKiA1LjA7IAogICAgICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIocyk7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjAgLSBNYXRoLnBvdyh0LCAyKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocC50eXBlID09PSAnZmxhc2gnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcyA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKHMpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5yb3RhdGlvbiArPSA1LjAgKiBkdDsKCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAudHlwZSA9PT0gJ2RlYnJpcycpIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwucm90YXRpb24gKz0gMTAuMCAqIGR0OwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIocC5zdGFydFNjYWxlICogKDEuMCAtIHQpKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocC50eXBlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnggKz0gTWF0aC5zaW4ocC5hZ2UgKiAxMCArIHAubWVzaC5pZCkgKiBkdCAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IDAuOCAqICgxLjAgLSBNYXRoLnBvdyh0LCAzKSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAudHlwZSA9PT0gJ25hcCcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzID0gcC5zdGFydFNjYWxlICogKDAuNSArIHQgKiAxLjUpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIocyk7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjAgLSBNYXRoLnBvdyh0LCAyKTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24ueCArPSBNYXRoLnNpbihwLmFnZSAqIDIpICogZHQgKiAwLjM7CgogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLnR5cGUgPT09ICdidWJibGUnKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnggKz0gTWF0aC5zaW4ocC5hZ2UgKiA1LjAgKyBwLm1lc2guaWQpICogZHQgKiAwLjI7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnogKz0gTWF0aC5jb3MocC5hZ2UgKiA0LjAgKyBwLm1lc2guaWQpICogZHQgKiAwLjI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcyA9IHAuc3RhcnRTY2FsZSAqICgxLjAgKyB0ICogMC4yKTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKHMpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMC42ICogKDEuMCAtIE1hdGgucG93KHQsIDIpKTsKCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAudHlwZSA9PT0gJ2J1YmJsZV9taWNybycpIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24ueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBkdCAqIDIuMDsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24ueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBkdCAqIDIuMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBzID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIocyk7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAwLjkgKiAoMS4wIC0gdCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgczIgPSBwLnN0YXJ0U2NhbGU7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnNjYWxlLnNldChzMiAqICgxLjAgKyB0KSwgczIgKiAwLjIsIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICB3aW5kb3cuZmx1eC5QYXJ0aWNsZU1hbmFnZXIgPSBQYXJ0aWNsZU1hbmFnZXI7Cn0pKCk7","./ParticleManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUT1JTIC0tLQogICAgCiAgICAvLyAxLiBWZW5vbSBCdWJibGUgKEdyZWVuLCBzaGlueSwgc2hhcnApCiAgICBjb25zdCBfdmVub21UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMzIsIDMyLCA0LCAzMiwgMzIsIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgxNTAsIDI1NSwgMTAwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgwLCAyMDAsIDAsIDAuNSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCA1MCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45KSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDIwLCAyMCwgNiwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDIuIFNsZWVwIFp6egogICAgY29uc3QgX25hcFRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZvbnQgPSAnYm9sZCBpdGFsaWMgNDhweCBzYW5zLXNlcmlmJzsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gJyMwMDAwZmYnOwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gNDsKICAgICAgICBjdHguZmlsbFRleHQoJ1onLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gMy4gV2l0aGVyIFNtb2tlCi8vIDMuIFdpdGhlciBTbW9rZSAoT3B0aW1pemVkIHRvIDMyeDMyKQogICAgY29uc3QgX3dpdGhlclRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSAzMjsgYy5oZWlnaHQgPSAzMjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgxNiwgMTYsIDAsIDE2LCAxNiwgMTYpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDgwLCA4MCwgODAsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjUsICdyZ2JhKDQwLCA0MCwgNDAsIDAuNCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCAwLCAwLCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNC4gU2hvY2t3YXZlIFJpbmcgKE9wdGltaXplZCB0byA2NHg2NCkKICAgIGNvbnN0IF9zaG9ja3dhdmVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGN4ID0gMzIsIGN5ID0gMzI7CiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChjeCwgY3ksIDIwLCBjeCwgY3ksIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCA2NCwgNjQpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNS4gRmxhc2ggU3RhciAoT3B0aW1pemVkIHRvIDMyeDMyKQogICAgY29uc3QgX2ZsYXNoVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBjeCA9IDE2LCBjeSA9IDE2OwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmZmZic7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGZvcihsZXQgaT0wOyBpPDQ7IGkrKykgewogICAgICAgICAgICBjb25zdCBhID0gKGkgKiBNYXRoLlBJIC8gMik7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3gsIGN5KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKjE1LCBjeSArIE1hdGguc2luKGEpKjE1KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEgKyAwLjIpKjUsIGN5ICsgTWF0aC5zaW4oYSArIDAuMikqNSk7CiAgICAgICAgfQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChjeCwgY3ksIDAsIGN4LCBjeSwgMTApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDEpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoY3gsIGN5LCAxMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDYuIERlYnJpcyBTaGFyZCAoTmV3KQogICAgY29uc3QgX2RlYnJpc1RleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSAzMjsgYy5oZWlnaHQgPSAzMjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbygxNiwgMCk7IGN0eC5saW5lVG8oMzIsIDE2KTsgY3R4LmxpbmVUbygxNiwgMzIpOyBjdHgubGluZVRvKDAsIDE2KTsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNy4gQnViYmxlIFRleHR1cmUgKE5ldzogQWVzdGhldGljICYgU3VidGxlKQovLyA3LiBCdWJibGUgVGV4dHVyZSAoTmV3OiBBZXN0aGV0aWMgJiBTdWJ0bGUpCiAgICBjb25zdCBfYnViYmxlVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICAvLyBDbGVhcgogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgNjQsIDY0KTsKCiAgICAgICAgLy8gVGlnaHRlciwgU2hpbW1lcnkgQnViYmxlCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgzMiwgMzIsIDAsIDMyLCAzMiwgMjgpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDAuOTUpJyk7IC8vIFNoYXJwIGhpZ2hsaWdodCBjZW50ZXIKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjMsICdyZ2JhKDIwMCwgMjQwLCAyNTUsIDAuNCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjgsICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCAwLCAwLCAwKScpOwogICAgICAgIAogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYygzMiwgMzIsIDMwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIC8vIFNoYXJwIFNwZWN1bGFyIERvdAogICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgyNTUsIDI1NSwgMjU1LCAxLjApJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IAogICAgICAgIGN0eC5hcmMoMjAsIDIwLCA0LCAwLCBNYXRoLlBJICogMik7IAogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA4LiBNaWNybyBCdWJibGUgKE5ldzogU2hhcnAsIGhpZ2gtdmlzIGNhdml0YXRpb24pCiAgICBjb25zdCBfbWljcm9CdWJibGVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgMzIsIDMyKTsKICAgICAgICAKICAgICAgICAvLyBJbnRlbnNlIGJyaWdodCBjb3JlCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgxNiwgMTYsIDAsIDE2LCAxNiwgMTYpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDEuMCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjMsICdyZ2JhKDIyMCwgMjU1LCAyNTUsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjYsICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLjAsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDE2LCAxNiwgMTYsIDAsIE1hdGguUEkqMik7IGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA5LiBEYXNoIFN0cmVhbSAoTmV3OiBTcGVlZCBsaW5lKQogICAgY29uc3QgX2Rhc2hTdHJlYW1UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gMTY7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlTGluZWFyR3JhZGllbnQoMCwgMCwgNjQsIDApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDAsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoMjAwLCAyNTUsIDI1NSwgMC44KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDAsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIAogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCA0LCA2NCwgOCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjbGFzcyBQYXJ0aWNsZU1hbmFnZXIgewoKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMucGFydGljbGVzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNb2JpbGUgT3B0aW1pemF0aW9uOiBDaGVjayBzY3JlZW4gd2lkdGgKICAgICAgICAgICAgY29uc3QgaXNNb2JpbGUgPSB3aW5kb3cuaW5uZXJXaWR0aCA8IDgwMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNoYXJlZCBNYXRlcmlhbHMKICAgICAgICAgICAgLy8gTm90ZTogYWxwaGFUZXN0IGFkZGVkIHRvIE5vcm1hbEJsZW5kaW5nIG1hdGVyaWFscyB0byBoZWxwIEdQVSBkaXNjYXJkIHRyYW5zcGFyZW50IHBpeGVscwogICAgICAgICAgICB0aGlzLm1hdGVyaWFscyA9IHsKICAgICAgICAgICAgICAgIHZlbm9tOiBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyBtYXA6IF92ZW5vbVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIG5hcDogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfbmFwVGV4LCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhXcml0ZTogZmFsc2UsIGJsZW5kaW5nOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywgYWxwaGFUZXN0OiAwLjEgfSksCiAgICAgICAgICAgICAgICB3aXRoZXI6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3dpdGhlclRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsIGFscGhhVGVzdDogMC4wNSB9KSwKICAgICAgICAgICAgICAgIGxlYXJuZWQ6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3Zlbm9tVGV4LCBjb2xvcjogMHgwMGZmZmYsIHRyYW5zcGFyZW50OiB0cnVlLCBkZXB0aFdyaXRlOiBmYWxzZSwgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcgfSksCiAgICAgICAgICAgICAgICBzaG9ja3dhdmU6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3Nob2Nrd2F2ZVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIGZsYXNoOiBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyBtYXA6IF9mbGFzaFRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIGRlYnJpczogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfZGVicmlzVGV4LCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhXcml0ZTogZmFsc2UsIGJsZW5kaW5nOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywgYWxwaGFUZXN0OiAwLjEgfSksCiAgICAgICAgICAgICAgICBidWJibGU6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2J1YmJsZVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIGJ1YmJsZV9taWNybzogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfbWljcm9CdWJibGVUZXgsIHRyYW5zcGFyZW50OiB0cnVlLCBkZXB0aFdyaXRlOiBmYWxzZSwgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcgfSksCiAgICAgICAgICAgICAgICBkYXNoX3N0cmVhbTogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfZGFzaFN0cmVhbVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gT2JqZWN0IFBvb2wKICAgICAgICAgICAgdGhpcy5wb29sID0gW107CiAgICAgICAgICAgIC8vIFJlZHVjZSBwb29sIHNpemUgb24gbW9iaWxlIHRvIHByZXZlbnQgZXhjZXNzaXZlIG92ZXJkcmF3CiAgICAgICAgICAgIHRoaXMucG9vbFNpemUgPSBpc01vYmlsZSA/IDEyMCA6IDMwMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgLy8gQ2xvbmUgbWF0ZXJpYWwgdG8gYWxsb3cgaW5kaXZpZHVhbCBvcGFjaXR5L3JvdGF0aW9uCiAgICAgICAgICAgICAgICAvLyBXZSBjbG9uZSAndmVub20nIGFzIGEgcGxhY2Vob2xkZXIsIGl0IGdldHMgb3ZlcndyaXR0ZW4gaW4gc3Bhd24oKQogICAgICAgICAgICAgICAgY29uc3QgbWF0ID0gdGhpcy5tYXRlcmlhbHMudmVub20uY2xvbmUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUobWF0KTsgCiAgICAgICAgICAgICAgICBzcHJpdGUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgc3ByaXRlLnNjYWxlLnNldCgwLDAsMCk7IAogICAgICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBEaXNhYmxlIGZydXN0dW0gY3VsbGluZyBmb3IgcGFydGljbGVzIHRvIGF2b2lkIENQVSBvdmVyaGVhZCBvZiBib3VuZGluZyBib3ggY2FsYwogICAgICAgICAgICAgICAgLy8gc2luY2UgdGhleSBhcmUgYWx3YXlzIGluIGZyb250IG9mIGNhbWVyYSB1c3VhbGx5LCBvciBjaGVhcCB0byBkcmF3LgogICAgICAgICAgICAgICAgLy8gQWN0dWFsbHksIGtlZXBpbmcgY3VsbGluZyBpcyBiZXR0ZXIgaWYgdGhleSBnbyBvZmYgc2NyZWVuLgogICAgICAgICAgICAgICAgLy8gc3ByaXRlLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsgCiAgICAgICAgICAgICAgICB0aGlzLnNjZW5lLmFkZChzcHJpdGUpOwogICAgICAgICAgICAgICAgdGhpcy5wb29sLnB1c2goc3ByaXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMucG9vbC5maW5kKHMgPT4gIXMudmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghcCkgcmV0dXJuOwoKICAgICAgICAgICAgcC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHRlbXBsYXRlID0gdGhpcy5tYXRlcmlhbHNbdHlwZV0gfHwgdGhpcy5tYXRlcmlhbHMudmVub207CiAgICAgICAgICAgIHAubWF0ZXJpYWwubWFwID0gdGVtcGxhdGUubWFwOwogICAgICAgICAgICBwLm1hdGVyaWFsLmJsZW5kaW5nID0gdGVtcGxhdGUuYmxlbmRpbmc7CiAgICAgICAgICAgIHAubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRlbXBsYXRlLmRlcHRoV3JpdGU7CiAgICAgICAgICAgIHAubWF0ZXJpYWwudHJhbnNwYXJlbnQgPSB0ZW1wbGF0ZS50cmFuc3BhcmVudDsKCiAgICAgICAgICAgIHAucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgcC5tYXRlcmlhbC5yb3RhdGlvbiA9IDA7CiAgICAgICAgICAgIHAubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZmZmZmKTsKICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwoKICAgICAgICAgICAgY29uc3QgZGF0YSA9IHsKICAgICAgICAgICAgICAgIG1lc2g6IHAsCiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgICAgICAgYWdlOiAwLAogICAgICAgICAgICAgICAgbGlmZTogb3B0aW9ucy5saWZlIHx8IDEuMCwKICAgICAgICAgICAgICAgIG1heExpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksCiAgICAgICAgICAgICAgICBzdGFydFNjYWxlOiBvcHRpb25zLnNjYWxlIHx8IDEuMCwKICAgICAgICAgICAgICAgIGdyYXZpdHk6IDAsCiAgICAgICAgICAgICAgICBkcmFnOiAwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBDb25maWd1cmF0aW9uIHBlciB0eXBlCiAgICAgICAgICAgIGlmICh0eXBlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICBkYXRhLmxpZmUgPSAxLjAgKyBNYXRoLnJhbmRvbSgpICogMC41OwogICAgICAgICAgICAgICAgZGF0YS52ZWxvY2l0eS5zZXQoMCwgMS4wICsgTWF0aC5yYW5kb20oKSwgMCk7CiAgICAgICAgICAgICAgICBkYXRhLnN0YXJ0U2NhbGUgPSAwLjMgKyBNYXRoLnJhbmRvbSgpICogMC4yOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMC44OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ25hcCcpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgIGRhdGEudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yLCAwLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yKTsKICAgICAgICAgICAgICAgIGRhdGEuc3RhcnRTY2FsZSA9IDAuNDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDEuNTsKICAgICAgICAgICAgICAgIGRhdGEudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC41LCAwLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC41KTsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDAuNjsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3Nob2Nrd2F2ZScpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IG9wdGlvbnMubGlmZSB8fCAwLjQ7CiAgICAgICAgICAgICAgICBkYXRhLm1heExpZmUgPSBkYXRhLmxpZmU7CiAgICAgICAgICAgICAgICBkYXRhLnN0YXJ0U2NhbGUgPSBvcHRpb25zLnNjYWxlIHx8IDIuMDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdmbGFzaCcpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDAuMjsKICAgICAgICAgICAgICAgIGRhdGEubWF4TGlmZSA9IDAuMjsKICAgICAgICAgICAgICAgIGRhdGEuc3RhcnRTY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMy4wOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwoKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZGVicmlzJykgewogICAgICAgICAgICAgICAgZGF0YS5saWZlID0gMS41OwogICAgICAgICAgICAgICAgZGF0YS5tYXhMaWZlID0gMS41OwogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSA1LjAgKyBNYXRoLnJhbmRvbSgpICogMTAuMDsKICAgICAgICAgICAgICAgIGRhdGEudmVsb2NpdHkuc2V0KAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcGVlZCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAqIHNwZWVkICogMC41KSArIDIuMCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogc3BlZWQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBkYXRhLmdyYXZpdHkgPSAyMC4wOwogICAgICAgICAgICAgICAgZGF0YS5kcmFnID0gMS4wOwogICAgICAgICAgICAgICAgZGF0YS5zdGFydFNjYWxlID0gKG9wdGlvbnMuc2NhbGUgfHwgMC4zKSAqICgwLjUgKyBNYXRoLnJhbmRvbSgpKTsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2J1YmJsZScpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDEuMCArIE1hdGgucmFuZG9tKCkgKiAxLjA7CiAgICAgICAgICAgICAgICBkYXRhLm1heExpZmUgPSBkYXRhLmxpZmU7CiAgICAgICAgICAgICAgICBkYXRhLnZlbG9jaXR5LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjUsCiAgICAgICAgICAgICAgICAgICAgMC41ICsgTWF0aC5yYW5kb20oKSAqIDEuMCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjUKICAgICAgICAgICAgICAgICk7CmRhdGEuc3RhcnRTY2FsZSA9IChvcHRpb25zLnNjYWxlIHx8IDAuMTUpICogKDAuOCArIE1hdGgucmFuZG9tKCkgKiAwLjQpOyAvLyBTbWFsbGVyLCB0aWdodGVyIGJ1YmJsZXMKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDAuOTsgLy8gTW9yZSBvcGFxdWUKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4YWFjY2ZmKTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2J1YmJsZV9taWNybycpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDAuNCArIE1hdGgucmFuZG9tKCkgKiAwLjQ7CiAgICAgICAgICAgICAgICBkYXRhLm1heExpZmUgPSBkYXRhLmxpZmU7CiAgICAgICAgICAgICAgICBkYXRhLnZlbG9jaXR5LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxLjUsCiAgICAgICAgICAgICAgICAgICAgMS41ICsgTWF0aC5yYW5kb20oKSAqIDIuMCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxLjUKICAgICAgICAgICAgICAgICk7CmRhdGEuc3RhcnRTY2FsZSA9IChvcHRpb25zLnNjYWxlIHx8IDAuMTUpICogKDAuOCArIE1hdGgucmFuZG9tKCkgKiAwLjUpOyAvLyBMYXJnZXIgbWljcm8gYnViYmxlcwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZmZmZmYpOwoKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZGFzaF9zdHJlYW0nKSB7CiAgICAgICAgICAgICAgICBkYXRhLmxpZmUgPSAwLjM7CiAgICAgICAgICAgICAgICBkYXRhLm1heExpZmUgPSAwLjM7CiAgICAgICAgICAgICAgICBkYXRhLnN0YXJ0U2NhbGUgPSBvcHRpb25zLnNjYWxlIHx8IDIuMDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDAuODsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGUgIT09ICdzaG9ja3dhdmUnKSB7CiAgICAgICAgICAgICAgICBwLnNjYWxlLnNldFNjYWxhcihkYXRhLnN0YXJ0U2NhbGUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcC5zY2FsZS5zZXRTY2FsYXIoMC4xKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXMucHVzaChkYXRhKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5wYXJ0aWNsZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnBhcnRpY2xlc1tpXTsKICAgICAgICAgICAgICAgIHAuYWdlICs9IGR0OwoKICAgICAgICAgICAgICAgIGlmIChwLmFnZSA+PSBwLmxpZmUpIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gcC5hZ2UgLyBwLmxpZmU7CgogICAgICAgICAgICAgICAgaWYgKHAuZ3Jhdml0eSA+IDApIHAudmVsb2NpdHkueSAtPSBwLmdyYXZpdHkgKiBkdDsKICAgICAgICAgICAgICAgIGlmIChwLmRyYWcgPiAwKSBwLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtIChwLmRyYWcgKiBkdCkpKTsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5hZGRTY2FsZWRWZWN0b3IocC52ZWxvY2l0eSwgZHQpOwoKICAgICAgICAgICAgICAgIGlmIChwLnR5cGUgPT09ICdzaG9ja3dhdmUnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcyA9IHAuc3RhcnRTY2FsZSAqIE1hdGgucG93KHQsIDAuNSkgKiA1LjA7IAogICAgICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIocyk7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjAgLSBNYXRoLnBvdyh0LCAyKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocC50eXBlID09PSAnZmxhc2gnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcyA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKHMpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5yb3RhdGlvbiArPSA1LjAgKiBkdDsKCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAudHlwZSA9PT0gJ2RlYnJpcycpIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwucm90YXRpb24gKz0gMTAuMCAqIGR0OwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIocC5zdGFydFNjYWxlICogKDEuMCAtIHQpKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocC50eXBlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnggKz0gTWF0aC5zaW4ocC5hZ2UgKiAxMCArIHAubWVzaC5pZCkgKiBkdCAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IDAuOCAqICgxLjAgLSBNYXRoLnBvdyh0LCAzKSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAudHlwZSA9PT0gJ25hcCcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzID0gcC5zdGFydFNjYWxlICogKDAuNSArIHQgKiAxLjUpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIocyk7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjAgLSBNYXRoLnBvdyh0LCAyKTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24ueCArPSBNYXRoLnNpbihwLmFnZSAqIDIpICogZHQgKiAwLjM7CgogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLnR5cGUgPT09ICdidWJibGUnKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnggKz0gTWF0aC5zaW4ocC5hZ2UgKiA1LjAgKyBwLm1lc2guaWQpICogZHQgKiAwLjI7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnogKz0gTWF0aC5jb3MocC5hZ2UgKiA0LjAgKyBwLm1lc2guaWQpICogZHQgKiAwLjI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcyA9IHAuc3RhcnRTY2FsZSAqICgxLjAgKyB0ICogMC4yKTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKHMpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMC42ICogKDEuMCAtIE1hdGgucG93KHQsIDIpKTsKCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAudHlwZSA9PT0gJ2J1YmJsZV9taWNybycpIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24ueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBkdCAqIDIuMDsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24ueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBkdCAqIDIuMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBzID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIocyk7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAwLjkgKiAoMS4wIC0gdCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgczIgPSBwLnN0YXJ0U2NhbGU7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnNjYWxlLnNldChzMiAqICgxLjAgKyB0KSwgczIgKiAwLjIsIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICB3aW5kb3cuZmx1eC5QYXJ0aWNsZU1hbmFnZXIgPSBQYXJ0aWNsZU1hbmFnZXI7Cn0pKCk7","/ParticleManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUT1JTIC0tLQogICAgCiAgICAvLyAxLiBWZW5vbSBCdWJibGUgKEdyZWVuLCBzaGlueSwgc2hhcnApCiAgICBjb25zdCBfdmVub21UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMzIsIDMyLCA0LCAzMiwgMzIsIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgxNTAsIDI1NSwgMTAwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgwLCAyMDAsIDAsIDAuNSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCA1MCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45KSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDIwLCAyMCwgNiwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDIuIFNsZWVwIFp6egogICAgY29uc3QgX25hcFRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZvbnQgPSAnYm9sZCBpdGFsaWMgNDhweCBzYW5zLXNlcmlmJzsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gJyMwMDAwZmYnOwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gNDsKICAgICAgICBjdHguZmlsbFRleHQoJ1onLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gMy4gV2l0aGVyIFNtb2tlCi8vIDMuIFdpdGhlciBTbW9rZSAoT3B0aW1pemVkIHRvIDMyeDMyKQogICAgY29uc3QgX3dpdGhlclRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSAzMjsgYy5oZWlnaHQgPSAzMjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgxNiwgMTYsIDAsIDE2LCAxNiwgMTYpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDgwLCA4MCwgODAsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjUsICdyZ2JhKDQwLCA0MCwgNDAsIDAuNCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCAwLCAwLCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNC4gU2hvY2t3YXZlIFJpbmcgKE9wdGltaXplZCB0byA2NHg2NCkKICAgIGNvbnN0IF9zaG9ja3dhdmVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGN4ID0gMzIsIGN5ID0gMzI7CiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChjeCwgY3ksIDIwLCBjeCwgY3ksIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCA2NCwgNjQpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNS4gRmxhc2ggU3RhciAoT3B0aW1pemVkIHRvIDMyeDMyKQogICAgY29uc3QgX2ZsYXNoVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBjeCA9IDE2LCBjeSA9IDE2OwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZmZmZic7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGZvcihsZXQgaT0wOyBpPDQ7IGkrKykgewogICAgICAgICAgICBjb25zdCBhID0gKGkgKiBNYXRoLlBJIC8gMik7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3gsIGN5KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKjE1LCBjeSArIE1hdGguc2luKGEpKjE1KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEgKyAwLjIpKjUsIGN5ICsgTWF0aC5zaW4oYSArIDAuMikqNSk7CiAgICAgICAgfQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChjeCwgY3ksIDAsIGN4LCBjeSwgMTApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDEpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoY3gsIGN5LCAxMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDYuIERlYnJpcyBTaGFyZCAoTmV3KQogICAgY29uc3QgX2RlYnJpc1RleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSAzMjsgYy5oZWlnaHQgPSAzMjsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbygxNiwgMCk7IGN0eC5saW5lVG8oMzIsIDE2KTsgY3R4LmxpbmVUbygxNiwgMzIpOyBjdHgubGluZVRvKDAsIDE2KTsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNy4gQnViYmxlIFRleHR1cmUgKE5ldzogQWVzdGhldGljICYgU3VidGxlKQovLyA3LiBCdWJibGUgVGV4dHVyZSAoTmV3OiBBZXN0aGV0aWMgJiBTdWJ0bGUpCiAgICBjb25zdCBfYnViYmxlVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICAvLyBDbGVhcgogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgNjQsIDY0KTsKCiAgICAgICAgLy8gVGlnaHRlciwgU2hpbW1lcnkgQnViYmxlCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgzMiwgMzIsIDAsIDMyLCAzMiwgMjgpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDAuOTUpJyk7IC8vIFNoYXJwIGhpZ2hsaWdodCBjZW50ZXIKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjMsICdyZ2JhKDIwMCwgMjQwLCAyNTUsIDAuNCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjgsICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCAwLCAwLCAwKScpOwogICAgICAgIAogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYygzMiwgMzIsIDMwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIC8vIFNoYXJwIFNwZWN1bGFyIERvdAogICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgyNTUsIDI1NSwgMjU1LCAxLjApJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IAogICAgICAgIGN0eC5hcmMoMjAsIDIwLCA0LCAwLCBNYXRoLlBJICogMik7IAogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA4LiBNaWNybyBCdWJibGUgKE5ldzogU2hhcnAsIGhpZ2gtdmlzIGNhdml0YXRpb24pCiAgICBjb25zdCBfbWljcm9CdWJibGVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgMzIsIDMyKTsKICAgICAgICAKICAgICAgICAvLyBJbnRlbnNlIGJyaWdodCBjb3JlCiAgICAgICAgY29uc3QgZyA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudCgxNiwgMTYsIDAsIDE2LCAxNiwgMTYpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDEuMCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjMsICdyZ2JhKDIyMCwgMjU1LCAyNTUsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjYsICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLjAsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgCiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDE2LCAxNiwgMTYsIDAsIE1hdGguUEkqMik7IGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA5LiBEYXNoIFN0cmVhbSAoTmV3OiBTcGVlZCBsaW5lKQogICAgY29uc3QgX2Rhc2hTdHJlYW1UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gMTY7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlTGluZWFyR3JhZGllbnQoMCwgMCwgNjQsIDApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDAsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoMjAwLCAyNTUsIDI1NSwgMC44KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDAsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIAogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCA0LCA2NCwgOCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjbGFzcyBQYXJ0aWNsZU1hbmFnZXIgewoKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMucGFydGljbGVzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNb2JpbGUgT3B0aW1pemF0aW9uOiBDaGVjayBzY3JlZW4gd2lkdGgKICAgICAgICAgICAgY29uc3QgaXNNb2JpbGUgPSB3aW5kb3cuaW5uZXJXaWR0aCA8IDgwMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNoYXJlZCBNYXRlcmlhbHMKICAgICAgICAgICAgLy8gTm90ZTogYWxwaGFUZXN0IGFkZGVkIHRvIE5vcm1hbEJsZW5kaW5nIG1hdGVyaWFscyB0byBoZWxwIEdQVSBkaXNjYXJkIHRyYW5zcGFyZW50IHBpeGVscwogICAgICAgICAgICB0aGlzLm1hdGVyaWFscyA9IHsKICAgICAgICAgICAgICAgIHZlbm9tOiBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyBtYXA6IF92ZW5vbVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIG5hcDogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfbmFwVGV4LCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhXcml0ZTogZmFsc2UsIGJsZW5kaW5nOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywgYWxwaGFUZXN0OiAwLjEgfSksCiAgICAgICAgICAgICAgICB3aXRoZXI6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3dpdGhlclRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsIGFscGhhVGVzdDogMC4wNSB9KSwKICAgICAgICAgICAgICAgIGxlYXJuZWQ6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3Zlbm9tVGV4LCBjb2xvcjogMHgwMGZmZmYsIHRyYW5zcGFyZW50OiB0cnVlLCBkZXB0aFdyaXRlOiBmYWxzZSwgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcgfSksCiAgICAgICAgICAgICAgICBzaG9ja3dhdmU6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3Nob2Nrd2F2ZVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIGZsYXNoOiBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyBtYXA6IF9mbGFzaFRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIGRlYnJpczogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfZGVicmlzVGV4LCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhXcml0ZTogZmFsc2UsIGJsZW5kaW5nOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywgYWxwaGFUZXN0OiAwLjEgfSksCiAgICAgICAgICAgICAgICBidWJibGU6IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2J1YmJsZVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KSwKICAgICAgICAgICAgICAgIGJ1YmJsZV9taWNybzogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfbWljcm9CdWJibGVUZXgsIHRyYW5zcGFyZW50OiB0cnVlLCBkZXB0aFdyaXRlOiBmYWxzZSwgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcgfSksCiAgICAgICAgICAgICAgICBkYXNoX3N0cmVhbTogbmV3IFRIUkVFLlNwcml0ZU1hdGVyaWFsKHsgbWFwOiBfZGFzaFN0cmVhbVRleCwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gT2JqZWN0IFBvb2wKICAgICAgICAgICAgdGhpcy5wb29sID0gW107CiAgICAgICAgICAgIC8vIFJlZHVjZSBwb29sIHNpemUgb24gbW9iaWxlIHRvIHByZXZlbnQgZXhjZXNzaXZlIG92ZXJkcmF3CiAgICAgICAgICAgIHRoaXMucG9vbFNpemUgPSBpc01vYmlsZSA/IDEyMCA6IDMwMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgLy8gQ2xvbmUgbWF0ZXJpYWwgdG8gYWxsb3cgaW5kaXZpZHVhbCBvcGFjaXR5L3JvdGF0aW9uCiAgICAgICAgICAgICAgICAvLyBXZSBjbG9uZSAndmVub20nIGFzIGEgcGxhY2Vob2xkZXIsIGl0IGdldHMgb3ZlcndyaXR0ZW4gaW4gc3Bhd24oKQogICAgICAgICAgICAgICAgY29uc3QgbWF0ID0gdGhpcy5tYXRlcmlhbHMudmVub20uY2xvbmUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBUSFJFRS5TcHJpdGUobWF0KTsgCiAgICAgICAgICAgICAgICBzcHJpdGUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgc3ByaXRlLnNjYWxlLnNldCgwLDAsMCk7IAogICAgICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBEaXNhYmxlIGZydXN0dW0gY3VsbGluZyBmb3IgcGFydGljbGVzIHRvIGF2b2lkIENQVSBvdmVyaGVhZCBvZiBib3VuZGluZyBib3ggY2FsYwogICAgICAgICAgICAgICAgLy8gc2luY2UgdGhleSBhcmUgYWx3YXlzIGluIGZyb250IG9mIGNhbWVyYSB1c3VhbGx5LCBvciBjaGVhcCB0byBkcmF3LgogICAgICAgICAgICAgICAgLy8gQWN0dWFsbHksIGtlZXBpbmcgY3VsbGluZyBpcyBiZXR0ZXIgaWYgdGhleSBnbyBvZmYgc2NyZWVuLgogICAgICAgICAgICAgICAgLy8gc3ByaXRlLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsgCiAgICAgICAgICAgICAgICB0aGlzLnNjZW5lLmFkZChzcHJpdGUpOwogICAgICAgICAgICAgICAgdGhpcy5wb29sLnB1c2goc3ByaXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMucG9vbC5maW5kKHMgPT4gIXMudmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghcCkgcmV0dXJuOwoKICAgICAgICAgICAgcC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHRlbXBsYXRlID0gdGhpcy5tYXRlcmlhbHNbdHlwZV0gfHwgdGhpcy5tYXRlcmlhbHMudmVub207CiAgICAgICAgICAgIHAubWF0ZXJpYWwubWFwID0gdGVtcGxhdGUubWFwOwogICAgICAgICAgICBwLm1hdGVyaWFsLmJsZW5kaW5nID0gdGVtcGxhdGUuYmxlbmRpbmc7CiAgICAgICAgICAgIHAubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRlbXBsYXRlLmRlcHRoV3JpdGU7CiAgICAgICAgICAgIHAubWF0ZXJpYWwudHJhbnNwYXJlbnQgPSB0ZW1wbGF0ZS50cmFuc3BhcmVudDsKCiAgICAgICAgICAgIHAucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgcC5tYXRlcmlhbC5yb3RhdGlvbiA9IDA7CiAgICAgICAgICAgIHAubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZmZmZmKTsKICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwoKICAgICAgICAgICAgY29uc3QgZGF0YSA9IHsKICAgICAgICAgICAgICAgIG1lc2g6IHAsCiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgICAgICAgYWdlOiAwLAogICAgICAgICAgICAgICAgbGlmZTogb3B0aW9ucy5saWZlIHx8IDEuMCwKICAgICAgICAgICAgICAgIG1heExpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksCiAgICAgICAgICAgICAgICBzdGFydFNjYWxlOiBvcHRpb25zLnNjYWxlIHx8IDEuMCwKICAgICAgICAgICAgICAgIGdyYXZpdHk6IDAsCiAgICAgICAgICAgICAgICBkcmFnOiAwCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBDb25maWd1cmF0aW9uIHBlciB0eXBlCiAgICAgICAgICAgIGlmICh0eXBlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICBkYXRhLmxpZmUgPSAxLjAgKyBNYXRoLnJhbmRvbSgpICogMC41OwogICAgICAgICAgICAgICAgZGF0YS52ZWxvY2l0eS5zZXQoMCwgMS4wICsgTWF0aC5yYW5kb20oKSwgMCk7CiAgICAgICAgICAgICAgICBkYXRhLnN0YXJ0U2NhbGUgPSAwLjMgKyBNYXRoLnJhbmRvbSgpICogMC4yOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMC44OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ25hcCcpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgIGRhdGEudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yLCAwLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yKTsKICAgICAgICAgICAgICAgIGRhdGEuc3RhcnRTY2FsZSA9IDAuNDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDEuNTsKICAgICAgICAgICAgICAgIGRhdGEudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMC41LCAwLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC41KTsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDAuNjsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3Nob2Nrd2F2ZScpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IG9wdGlvbnMubGlmZSB8fCAwLjQ7CiAgICAgICAgICAgICAgICBkYXRhLm1heExpZmUgPSBkYXRhLmxpZmU7CiAgICAgICAgICAgICAgICBkYXRhLnN0YXJ0U2NhbGUgPSBvcHRpb25zLnNjYWxlIHx8IDIuMDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdmbGFzaCcpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDAuMjsKICAgICAgICAgICAgICAgIGRhdGEubWF4TGlmZSA9IDAuMjsKICAgICAgICAgICAgICAgIGRhdGEuc3RhcnRTY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMy4wOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwoKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZGVicmlzJykgewogICAgICAgICAgICAgICAgZGF0YS5saWZlID0gMS41OwogICAgICAgICAgICAgICAgZGF0YS5tYXhMaWZlID0gMS41OwogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSA1LjAgKyBNYXRoLnJhbmRvbSgpICogMTAuMDsKICAgICAgICAgICAgICAgIGRhdGEudmVsb2NpdHkuc2V0KAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcGVlZCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAqIHNwZWVkICogMC41KSArIDIuMCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogc3BlZWQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBkYXRhLmdyYXZpdHkgPSAyMC4wOwogICAgICAgICAgICAgICAgZGF0YS5kcmFnID0gMS4wOwogICAgICAgICAgICAgICAgZGF0YS5zdGFydFNjYWxlID0gKG9wdGlvbnMuc2NhbGUgfHwgMC4zKSAqICgwLjUgKyBNYXRoLnJhbmRvbSgpKTsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2J1YmJsZScpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDEuMCArIE1hdGgucmFuZG9tKCkgKiAxLjA7CiAgICAgICAgICAgICAgICBkYXRhLm1heExpZmUgPSBkYXRhLmxpZmU7CiAgICAgICAgICAgICAgICBkYXRhLnZlbG9jaXR5LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjUsCiAgICAgICAgICAgICAgICAgICAgMC41ICsgTWF0aC5yYW5kb20oKSAqIDEuMCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjUKICAgICAgICAgICAgICAgICk7CmRhdGEuc3RhcnRTY2FsZSA9IChvcHRpb25zLnNjYWxlIHx8IDAuMTUpICogKDAuOCArIE1hdGgucmFuZG9tKCkgKiAwLjQpOyAvLyBTbWFsbGVyLCB0aWdodGVyIGJ1YmJsZXMKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDAuOTsgLy8gTW9yZSBvcGFxdWUKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4YWFjY2ZmKTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2J1YmJsZV9taWNybycpIHsKICAgICAgICAgICAgICAgIGRhdGEubGlmZSA9IDAuNCArIE1hdGgucmFuZG9tKCkgKiAwLjQ7CiAgICAgICAgICAgICAgICBkYXRhLm1heExpZmUgPSBkYXRhLmxpZmU7CiAgICAgICAgICAgICAgICBkYXRhLnZlbG9jaXR5LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxLjUsCiAgICAgICAgICAgICAgICAgICAgMS41ICsgTWF0aC5yYW5kb20oKSAqIDIuMCwKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxLjUKICAgICAgICAgICAgICAgICk7CmRhdGEuc3RhcnRTY2FsZSA9IChvcHRpb25zLnNjYWxlIHx8IDAuMTUpICogKDAuOCArIE1hdGgucmFuZG9tKCkgKiAwLjUpOyAvLyBMYXJnZXIgbWljcm8gYnViYmxlcwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5vcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgcC5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZmZmZmYpOwoKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZGFzaF9zdHJlYW0nKSB7CiAgICAgICAgICAgICAgICBkYXRhLmxpZmUgPSAwLjM7CiAgICAgICAgICAgICAgICBkYXRhLm1heExpZmUgPSAwLjM7CiAgICAgICAgICAgICAgICBkYXRhLnN0YXJ0U2NhbGUgPSBvcHRpb25zLnNjYWxlIHx8IDIuMDsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwub3BhY2l0eSA9IDAuODsKICAgICAgICAgICAgICAgIHAubWF0ZXJpYWwucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGUgIT09ICdzaG9ja3dhdmUnKSB7CiAgICAgICAgICAgICAgICBwLnNjYWxlLnNldFNjYWxhcihkYXRhLnN0YXJ0U2NhbGUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcC5zY2FsZS5zZXRTY2FsYXIoMC4xKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXMucHVzaChkYXRhKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5wYXJ0aWNsZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnBhcnRpY2xlc1tpXTsKICAgICAgICAgICAgICAgIHAuYWdlICs9IGR0OwoKICAgICAgICAgICAgICAgIGlmIChwLmFnZSA+PSBwLmxpZmUpIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gcC5hZ2UgLyBwLmxpZmU7CgogICAgICAgICAgICAgICAgaWYgKHAuZ3Jhdml0eSA+IDApIHAudmVsb2NpdHkueSAtPSBwLmdyYXZpdHkgKiBkdDsKICAgICAgICAgICAgICAgIGlmIChwLmRyYWcgPiAwKSBwLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KDAsIDEuMCAtIChwLmRyYWcgKiBkdCkpKTsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5hZGRTY2FsZWRWZWN0b3IocC52ZWxvY2l0eSwgZHQpOwoKICAgICAgICAgICAgICAgIGlmIChwLnR5cGUgPT09ICdzaG9ja3dhdmUnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcyA9IHAuc3RhcnRTY2FsZSAqIE1hdGgucG93KHQsIDAuNSkgKiA1LjA7IAogICAgICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIocyk7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjAgLSBNYXRoLnBvdyh0LCAyKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocC50eXBlID09PSAnZmxhc2gnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcyA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKHMpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5yb3RhdGlvbiArPSA1LjAgKiBkdDsKCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAudHlwZSA9PT0gJ2RlYnJpcycpIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwucm90YXRpb24gKz0gMTAuMCAqIGR0OwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIocC5zdGFydFNjYWxlICogKDEuMCAtIHQpKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocC50eXBlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnggKz0gTWF0aC5zaW4ocC5hZ2UgKiAxMCArIHAubWVzaC5pZCkgKiBkdCAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IDAuOCAqICgxLjAgLSBNYXRoLnBvdyh0LCAzKSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAudHlwZSA9PT0gJ25hcCcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzID0gcC5zdGFydFNjYWxlICogKDAuNSArIHQgKiAxLjUpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIocyk7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjAgLSBNYXRoLnBvdyh0LCAyKTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24ueCArPSBNYXRoLnNpbihwLmFnZSAqIDIpICogZHQgKiAwLjM7CgogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLnR5cGUgPT09ICdidWJibGUnKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnggKz0gTWF0aC5zaW4ocC5hZ2UgKiA1LjAgKyBwLm1lc2guaWQpICogZHQgKiAwLjI7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnogKz0gTWF0aC5jb3MocC5hZ2UgKiA0LjAgKyBwLm1lc2guaWQpICogZHQgKiAwLjI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcyA9IHAuc3RhcnRTY2FsZSAqICgxLjAgKyB0ICogMC4yKTsKICAgICAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKHMpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gMC42ICogKDEuMCAtIE1hdGgucG93KHQsIDIpKTsKCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHAudHlwZSA9PT0gJ2J1YmJsZV9taWNybycpIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24ueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBkdCAqIDIuMDsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24ueiArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBkdCAqIDIuMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBzID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgICAgIHAubWVzaC5zY2FsZS5zZXRTY2FsYXIocyk7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAwLjkgKiAoMS4wIC0gdCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgczIgPSBwLnN0YXJ0U2NhbGU7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnNjYWxlLnNldChzMiAqICgxLjAgKyB0KSwgczIgKiAwLjIsIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICB3aW5kb3cuZmx1eC5QYXJ0aWNsZU1hbmFnZXIgPSBQYXJ0aWNsZU1hbmFnZXI7Cn0pKCk7","DevTools.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFRvb2x0aXAgRGVzY3JpcHRpb25zIGZvciBMb25nLVByZXNzCiAgICBjb25zdCBUT09MVElQX0RFU0NSSVBUSU9OUyA9IHsKICAgICAgICAnU1VCU1RFUFMnOiAiUGh5c2ljcyBpdGVyYXRpb25zIHBlciBmcmFtZS4gSGlnaGVyID0gbW9yZSBzdGFibGUsIG1vcmUgQ1BVLiIsCiAgICAgICAgJ1NUT1BfU1BFRUQnOiAiVmVsb2NpdHkgdGhyZXNob2xkIGJlbG93IHdoaWNoIHRoZSBiYWxsIHNuYXBzIHRvIGEgaGFsdC4iLAogICAgICAgICdXQVRFUl9EUkFHX0xJTkVBUic6ICJCYXNlIHdhdGVyIHJlc2lzdGFuY2UuIFNsb3dzIGJhbGwgbGluZWFybHkuIiwKICAgICAgICAnV0FURVJfRFJBR19RVUFEJzogIlF1YWRyYXRpYyBkcmFnLiBTbG93cyBoaWdoLXNwZWVkIGJhbGxzIHNpZ25pZmljYW50bHkuIiwKICAgICAgICAnU1BJTl9EUkFHJzogIkhvdyBmYXN0IHRoZSBiYWxsJ3Mgc3BpbiBkZWNheXMgb3ZlciB0aW1lLiIsCiAgICAgICAgJ01BR05VU19FTkFCTEVEJzogIkVuYWJsZXMgdGhlIE1hZ251cyBlZmZlY3QgKGN1cnZlIGZyb20gc3BpbikuIiwKICAgICAgICAnTUFHTlVTX0NPRUZGJzogIlN0cmVuZ3RoIG9mIHRoZSBjdXJ2ZSBmb3JjZSByZWxhdGl2ZSB0byBzcGluL3NwZWVkLiIsCiAgICAgICAgJ01BR05VU19DQVAnOiAiTWF4aW11bSBjdXJ2ZSBmb3JjZSBhbGxvd2VkIChwcmV2ZW50cyBwaHlzaWNzIGV4cGxvc2lvbnMpLiIsCiAgICAgICAgJ0RFUFRIX1RBUkdFVF9ZJzogIklkZWFsIFkgaGVpZ2h0IHRoZSBiYWxsIHRyaWVzIHRvIGZsb2F0IGF0LiIsCiAgICAgICAgJ0RFUFRIX1NQUklORyc6ICJTdHJlbmd0aCBvZiB0aGUgZm9yY2UgcHVsbGluZyBiYWxsIHRvIFRhcmdldCBZLiIsCiAgICAgICAgJ0RFUFRIX0RBTVAnOiAiRGFtcGluZyBvbiB2ZXJ0aWNhbCBtb3ZlbWVudCB0byBwcmV2ZW50IG9zY2lsbGF0aW9uLiIsCiAgICAgICAgJ0JPVU5EQVJZX1JBRElVUyc6ICJSYWRpdXMgb2YgdGhlIGNpcmN1bGFyIGFyZW5hIHdhbGwuIiwKICAgICAgICAnQk9VTkRBUllfSEVJR0hUJzogIkhlaWdodCBvZiB0aGUgYXJlbmEgY2VpbGluZy9mbG9vci4iLAogICAgICAgICdXQUxMX1NPRlRfQlVGRkVSJzogIkRpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMuIiwKICAgICAgICAnV0FMTF9TT0ZUX0ZPUkNFJzogIkZvcmNlIHB1c2hpbmcgYmFsbCBhd2F5IGZyb20gd2FsbCBiZWZvcmUgaW1wYWN0LiIsCiAgICAgICAgJ1dBTExfRUxBU1RJQ0lUWSc6ICJCb3VuY2luZXNzIG9mIHRoZSB3YWxsICgwID0gZGVhZCB0aHVkLCAxID0gcGVyZmVjdCBib3VuY2UpLiIsCiAgICAgICAgJ1dBTExfRlJJQ1RJT04nOiAiRnJpY3Rpb24gd2hlbiBzbGlkaW5nIGFsb25nIHRoZSB3YWxsLiIsCiAgICAgICAgJ0ZMT09SX0VMQVNUSUNJVFknOiAiQm91bmNpbmVzcyBvZiB0aGUgZmxvb3IvY2VpbGluZy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9FTkFCTEVEJzogIkVuYWJsZXMgdGhlIGV4dGVuZGVkIGNvcnJpZG9yIGZvciB0aGUgZ29hbC4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9YJzogIkhhbGYtd2lkdGggb2YgdGhlIGdvYWwgcG9ja2V0IGNvcnJpZG9yLiIsCiAgICAgICAgJ0dPQUxfUE9DS0VUX1onOiAiWi1kZXB0aCB3aGVyZSB0aGUgcG9ja2V0IHN0YXJ0cy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9SQURJVVMnOiAiRWZmZWN0aXZlIHJhZGl1cyBpbnNpZGUgdGhlIHBvY2tldC4iLAogICAgICAgICdMQVVOQ0hfU1BFRURfU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBTdGF0IFBvd2VyIHRvIFBoeXNpY3MgVmVsb2NpdHkuIiwKICAgICAgICAnTEFVTkNIX1NQRUVEX0NBUCc6ICJNYXhpbXVtIHBoeXNpY2FsIHNwZWVkIHRoZSBiYWxsIGNhbiBiZSB0aHJvd24uIiwKICAgICAgICAnU1dJUEVfTUlOX1BYJzogIk1pbmltdW0gc3dpcGUgZGlzdGFuY2UgdG8gcmVnaXN0ZXIgYSB0aHJvdy4iLAogICAgICAgICdBSU1fRFhfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgaG9yaXpvbnRhbCBhaW0gZnJvbSBzd2lwZS4iLAogICAgICAgICdBSU1fRFlfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgdmVydGljYWwgYWltIGZyb20gc3dpcGUuIiwKICAgICAgICAnUE9XRVJfQkFTRSc6ICJCYXNlIHBvd2VyIG11bHRpcGxpZXIgZm9yIGEgcXVpY2sgdGFwLiIsCiAgICAgICAgJ1BPV0VSX1JBTkdFJzogIkFkZGl0aW9uYWwgcG93ZXIgbXVsdGlwbGllciBhdCBmdWxsIGNoYXJnZS4iLAogICAgICAgICdQT1dFUl9NQVhfQk9OVVNfUkFUSU8nOiAiQ2hhcmdlIHRocmVzaG9sZCBmb3IgJ01heCBQb3dlcicgYm9udXMuIiwKICAgICAgICAnUE9XRVJfTUFYX01VTFRJUExJRVInOiAiTXVsdGlwbGllciBhcHBsaWVkIHdoZW4gaGl0dGluZyBNYXggUG93ZXIuIiwKICAgICAgICAnQ1VSVkVfRU5BQkxFRCc6ICJFbmFibGVzIGN1cnZlIHNob3RzIHZpYSBjdXJ2ZWQgc3dpcGVzLiIsCiAgICAgICAgJ0NVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQnOiAiSG93IGN1cnZlZCBhIHN3aXBlIG11c3QgYmUgdG8gdHJpZ2dlciBzcGluLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBzd2lwZSBjdXJ2ZSB0byBiYWxsIHNwaW4uIiwKICAgICAgICAnQ1VSVkVfU1BFRURfTVVMVCc6ICJNdWx0aXBsaWVyIGZvciBzcGluIGJhc2VkIG9uIHN3aXBlIHNwZWVkLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fQ0FQJzogIk1heGltdW0gc3BpbiBhbGxvd2VkIGZyb20gYSBjdXJ2ZSB0aHJvdy4iLAogICAgICAgICdDVVJWRV9QRVJGRUNUX1NQSU4nOiAiU3BpbiB0aHJlc2hvbGQgdG8gdHJpZ2dlciAnUGVyZmVjdCBDdXJ2ZScgRlguIiwKICAgICAgICAndGltZVNjYWxlJzogIkdsb2JhbCBnYW1lIHNwZWVkIG11bHRpcGxpZXIuIiwKICAgICAgICAnZGVtb01vZGUnOiAiVG9nZ2xlIEFJIHZzIEFJIGF1dG8tcGxheS4iLAogICAgICAgICdyZXNvbHV0aW9uJzogIkludGVybmFsIHJlbmRlciByZXNvbHV0aW9uIHNjYWxlICgwLjUgPSBoYWxmIHJlcykuIiwKICAgICAgICAnYXJlbmFPcGFjaXR5JzogIk9wYWNpdHkgb2YgdGhlIG91dGVyIGFyZW5hIGdyaWQuIiwKICAgICAgICAnYXJlbmEyT3BhY2l0eSc6ICJPcGFjaXR5IG9mIHRoZSBpbm5lciBoZXggZ3JpZC4iCiAgICB9OwoKICAgIGNsYXNzIERldlRvb2xzIHsKICAgICAgICBjb25zdHJ1Y3RvcihnYW1lTWFuYWdlcikgewogICAgICAgICAgICB0aGlzLmdhbWUgPSBnYW1lTWFuYWdlcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIGxpbC1ndWkgYXR0YWNoZXMgdG8gd2luZG93LmxpbCBieSBkZWZhdWx0IGluIFVNRCBidWlsZAogICAgICAgICAgICBpZiAoIXdpbmRvdy5saWwgfHwgIXdpbmRvdy5saWwuR1VJKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkRldlRvb2xzOiBsaWwtZ3VpIG5vdCBmb3VuZC4iKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dhbWUtY29udGFpbmVyJyk7CiAgICAgICAgICAgIHRoaXMuZ3VpID0gbmV3IHdpbmRvdy5saWwuR1VJKHsgdGl0bGU6ICdGbHV4IERldlRvb2xzJywgY29udGFpbmVyOiBjb250YWluZXIgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQb3NpdGlvbiBhcyBhIGNvbGxhcHNlZCB0YWIgb24gdGhlIHJpZ2h0IGZyYW1lCi8vIFBvc2l0aW9uIGFzIGEgc2xpZGluZyB0YWIgb24gdGhlIHJpZ2h0IGZyYW1lCi8vIFBvc2l0aW9uIGFzIGEgc2xpZGluZyB0YWIgb24gdGhlIHJpZ2h0IGZyYW1lCi8vIFdyYXBwZXIgZm9yIHNsaWRpbmcgYW5pbWF0aW9uCiAgICAgICAgICAgIGNvbnN0IHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUudG9wID0gJzEwMHB4JzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5yaWdodCA9ICctMjYwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLndpZHRoID0gJzI2MHB4JzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS50cmFuc2l0aW9uID0gJ3JpZ2h0IDAuM3MgY3ViaWMtYmV6aWVyKDAuMiwgMC44LCAwLjIsIDEuMCknOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnpJbmRleCA9ICc5OTk5JzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLmZsZXhEaXJlY3Rpb24gPSAnY29sdW1uJzsKICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHdyYXBwZXIpOwoKICAgICAgICAgICAgY29uc3QgZG9tID0gdGhpcy5ndWkuZG9tRWxlbWVudDsKICAgICAgICAgICAgZG9tLnN0eWxlLndpZHRoID0gJzEwMCUnOwogICAgICAgICAgICBkb20uc3R5bGUuc2V0UHJvcGVydHkoJy0td2lkdGgnLCAnMTAwJScpOwogICAgICAgICAgICBkb20uc3R5bGUubWF4SGVpZ2h0ID0gJzgwdmgnOwogICAgICAgICAgICBkb20uc3R5bGUub3ZlcmZsb3dZID0gJ2F1dG8nOwogICAgICAgICAgICBkb20uc3R5bGUub3ZlcmZsb3dYID0gJ2hpZGRlbic7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNb3ZlIEdVSSBpbnRvIHdyYXBwZXIKICAgICAgICAgICAgd3JhcHBlci5hcHBlbmRDaGlsZChkb20pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ3JlYXRlIFRvZ2dsZSBIYW5kbGUKICAgICAgICAgICAgY29uc3QgaGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5sZWZ0ID0gJy00MHB4JzsgLy8gUHJvdHJ1ZGUgdG8gdGhlIGxlZnQKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLnRvcCA9ICcwJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLndpZHRoID0gJzQwcHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuaGVpZ2h0ID0gJzQwcHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gJ3JnYmEoMCwgMjAsIDQwLCAwLjkpJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlciA9ICcxcHggc29saWQgIzAwZmZmZic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5ib3JkZXJSaWdodCA9ICdub25lJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlclRvcExlZnRSYWRpdXMgPSAnOHB4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlckJvdHRvbUxlZnRSYWRpdXMgPSAnOHB4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmN1cnNvciA9ICdwb2ludGVyJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5qdXN0aWZ5Q29udGVudCA9ICdjZW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYWxpZ25JdGVtcyA9ICdjZW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuY29sb3IgPSAnIzAwZmZmZic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5mb250U2l6ZSA9ICcyMHB4JzsKICAgICAgICAgICAgaGFuZGxlLmlubmVySFRNTCA9ICfimpknOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm94U2hhZG93ID0gJy01cHggMCAxMHB4IHJnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgICAgIAogICAgICAgICAgICB3cmFwcGVyLmFwcGVuZENoaWxkKGhhbmRsZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUb2dnbGUgTG9naWMKICAgICAgICAgICAgbGV0IGlzT3BlbiA9IGZhbHNlOwogICAgICAgICAgICBoYW5kbGUuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsgLy8gUHJldmVudCBnYW1lIGlucHV0cwogICAgICAgICAgICAgICAgaXNPcGVuID0gIWlzT3BlbjsKICAgICAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUucmlnaHQgPSBpc09wZW4gPyAnMHB4JyA6ICctMjYwcHgnOwogICAgICAgICAgICAgICAgaGFuZGxlLmlubmVySFRNTCA9IGlzT3BlbiA/ICfCuycgOiAn4pqZJzsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIERlZmF1bHQgZ2xvYmFsIHRpbWVTY2FsZSBpZiBub3Qgc2V0CmlmICh3aW5kb3cuZmx1eC50aW1lU2NhbGUgPT09IHVuZGVmaW5lZCkgd2luZG93LmZsdXgudGltZVNjYWxlID0gMC44OwoKdGhpcy5fc2V0dXBHZW5lcmFsKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwR2FtZVN0YXRlKCk7CnRoaXMuX3NldHVwT3ZlcmxheXMoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBUZWFtcygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFBsYXllckluc3BlY3RvcigpOwogICAgICAgICAgICB0aGlzLl9zZXR1cEJhbGxTYW5kYm94KCk7CnRoaXMuX3NldHVwRlhMYWIoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBWaXN1YWxEZWJ1ZygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFZpc3VhbHMoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBUb29sdGlwcygpOwogICAgICAgIH0KCiAgICAgICAgX3NldHVwVG9vbHRpcHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBUb29sdGlwIERPTQogICAgICAgICAgICB0aGlzLnRvb2x0aXBFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMudG9vbHRpcEVsLnN0eWxlLCB7CiAgICAgICAgICAgICAgICBwb3NpdGlvbjogJ2ZpeGVkJywKICAgICAgICAgICAgICAgIHRvcDogJzUwJScsCiAgICAgICAgICAgICAgICBsZWZ0OiAnNTAlJywKICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogJ3RyYW5zbGF0ZSgtNTAlLCAtNTAlKScsCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICdyZ2JhKDAsIDEwLCAzMCwgMC45NSknLAogICAgICAgICAgICAgICAgYm9yZGVyOiAnMnB4IHNvbGlkICMwMGZmZmYnLAogICAgICAgICAgICAgICAgcGFkZGluZzogJzIwcHgnLAogICAgICAgICAgICAgICAgY29sb3I6ICcjZmZmJywKICAgICAgICAgICAgICAgIGZvbnRGYW1pbHk6ICdtb25vc3BhY2UnLAogICAgICAgICAgICAgICAgZm9udFNpemU6ICcxNHB4JywKICAgICAgICAgICAgICAgIG1heFdpZHRoOiAnMzAwcHgnLAogICAgICAgICAgICAgICAgekluZGV4OiAnMTAwMDAnLAogICAgICAgICAgICAgICAgZGlzcGxheTogJ25vbmUnLAogICAgICAgICAgICAgICAgcG9pbnRlckV2ZW50czogJ25vbmUnLAogICAgICAgICAgICAgICAgYm94U2hhZG93OiAnMCAwIDIwcHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKScsCiAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6ICc4cHgnLAogICAgICAgICAgICAgICAgdGV4dEFsaWduOiAnY2VudGVyJwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLnRvb2x0aXBFbCk7CgogICAgICAgICAgICAvLyBSZWN1cnNpdmUgZnVuY3Rpb24gdG8gYXR0YWNoIGxpc3RlbmVycwogICAgICAgICAgICBjb25zdCBhdHRhY2ggPSAoZ3VpKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBDb250cm9sbGVycwogICAgICAgICAgICAgICAgaWYgKGd1aS5jb250cm9sbGVycykgewogICAgICAgICAgICAgICAgICAgIGd1aS5jb250cm9sbGVycy5mb3JFYWNoKGMgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkb20gPSBjLmRvbUVsZW1lbnQuY2xvc2VzdCgnLmNvbnRyb2xsZXInKTsgLy8gbGlsLWd1aSBzdHJ1Y3R1cmUKICAgICAgICAgICAgICAgICAgICAgICAgaWYoZG9tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IGRvbS5xdWVyeVNlbGVjdG9yKCcubmFtZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobGFiZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hZGRMb25nUHJlc3MobGFiZWwsIGMucHJvcGVydHksIGMuX25hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBTdWItZm9sZGVycwogICAgICAgICAgICAgICAgaWYoZ3VpLmZvbGRlcnMpIHsKICAgICAgICAgICAgICAgICAgICBndWkuZm9sZGVycy5mb3JFYWNoKGYgPT4gYXR0YWNoKGYpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFdhaXQgYSB0aWNrIGZvciBHVUkgdG8gZnVsbHkgcmVuZGVyIERPTQogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGF0dGFjaCh0aGlzLmd1aSksIDEwMCk7CiAgICAgICAgfQoKICAgICAgICBfYWRkTG9uZ1ByZXNzKGVsZW1lbnQsIHByb3BlcnR5LCBuYW1lKSB7CiAgICAgICAgICAgIGxldCB0aW1lciA9IG51bGw7CiAgICAgICAgICAgIGNvbnN0IGR1cmF0aW9uID0gNTAwOyAvLyAwLjVzCgogICAgICAgICAgICBjb25zdCBzdGFydCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dUb29sdGlwKHByb3BlcnR5LCBuYW1lKTsKICAgICAgICAgICAgICAgIH0sIGR1cmF0aW9uKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGNvbnN0IGVuZCA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGlmKHRpbWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTsKICAgICAgICAgICAgICAgICAgICB0aW1lciA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9oaWRlVG9vbHRpcCgpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBzdGFydCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHN0YXJ0LCB7cGFzc2l2ZTogdHJ1ZX0pOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgZW5kKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgZW5kKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGVuZCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCBlbmQpOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dUb29sdGlwKHByb3AsIG5hbWUpIHsKICAgICAgICAgICAgY29uc3QgZGVzYyA9IFRPT0xUSVBfREVTQ1JJUFRJT05TW3Byb3BdOwogICAgICAgICAgICBpZihkZXNjKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRvb2x0aXBFbC5pbm5lckhUTUwgPSBgPHN0cm9uZyBzdHlsZT0iY29sb3I6IzAwZmZmZjsgZm9udC1zaXplOjE2cHg7Ij4ke25hbWUgfHwgcHJvcH08L3N0cm9uZz48YnI+PGJyPiR7ZGVzY31gOwogICAgICAgICAgICAgICAgdGhpcy50b29sdGlwRWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9oaWRlVG9vbHRpcCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudG9vbHRpcEVsKSB0aGlzLnRvb2x0aXBFbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KCgpfc2V0dXBHZW5lcmFsKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0dlbmVyYWwnKTsKICAgICAgICAgICAgCmNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIHRpbWVTY2FsZTogd2luZG93LmZsdXgudGltZVNjYWxlLAogICAgICAgICAgICAgICAgZGVtb01vZGU6IHRoaXMuZ2FtZS5pc0RlbW9Nb2RlLAogICAgICAgICAgICAgICAgdG9nZ2xlSFVEOiB0cnVlLAogICAgICAgICAgICAgICAgcmVzb2x1dGlvbjogMC41MCwKYXJlbmFPcGFjaXR5OiAwLjMsCiAgICAgICAgICAgICAgICBhcmVuYTJPcGFjaXR5OiAwLjI1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3RpbWVTY2FsZScsIDAuMCwgNS4wKS5uYW1lKCdHYW1lIFNwZWVkJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSB2OwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZGVtb01vZGUnKS5uYW1lKCdEZW1vIE1vZGUnKS5saXN0ZW4oKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuaXNEZW1vTW9kZSAhPT0gdikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS50b2dnbGVEZW1vTW9kZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndG9nZ2xlSFVEJykubmFtZSgnU2hvdyBIVUQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGh1ZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpOwogICAgICAgICAgICAgICAgaWYgKGh1ZCkgewogICAgICAgICAgICAgICAgICAgIGh1ZC5zdHlsZS52aXNpYmlsaXR5ID0gdiA/ICd2aXNpYmxlJyA6ICdoaWRkZW4nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAncmVzb2x1dGlvbicsIDAuMSwgMi4wKS5uYW1lKCdSZXNvbHV0aW9uIFNjYWxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB3ID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBoID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgY29uc3QgcmVuZGVyZXIgPSB0aGlzLmdhbWUucmVuZGVyZXI7CiAgICAgICAgICAgICAgICBpZiAocmVuZGVyZXIpIHsKICAgICAgICAgICAgICAgICAgICByZW5kZXJlci5zZXRTaXplKHcgKiB2LCBoICogdiwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCmZvbGRlci5hZGQocGFyYW1zLCAnYXJlbmFPcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ0FyZW5hIDEgT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IHY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYmxlbmRNb2RlcyA9IHsKICAgICAgICAgICAgICAgICdOb3JtYWwnOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywKICAgICAgICAgICAgICAgICdBZGRpdGl2ZSc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnTXVsdGlwbHknOiBUSFJFRS5NdWx0aXBseUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICdOb0JsZW5kaW5nJzogVEhSRUUuTm9CbGVuZGluZwogICAgICAgICAgICB9OwpwYXJhbXMuYXJlbmFCbGVuZCA9ICdOb3JtYWwnOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYUJsZW5kJywgT2JqZWN0LmtleXMoYmxlbmRNb2RlcykpLm5hbWUoJ0FyZW5hIDEgQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2ggJiYgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsLmJsZW5kaW5nID0gYmxlbmRNb2Rlc1t2XTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEFyZW5hIDIgQ29udHJvbHMKZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYTJPcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ0FyZW5hIDIgT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIgJiYgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eS52YWx1ZSA9IHY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKcGFyYW1zLmFyZW5hMkJsZW5kID0gJ0FkZGl0aXZlJzsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYTJCbGVuZCcsIE9iamVjdC5rZXlzKGJsZW5kTW9kZXMpKS5uYW1lKCdBcmVuYSAyIEJsZW5kJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoMiAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC5ibGVuZGluZyA9IGJsZW5kTW9kZXNbdl07CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgZGVmYXVsdHMKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gcGFyYW1zLmFyZW5hT3BhY2l0eTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoMiAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLm9wYWNpdHkgPSBwYXJhbXMuYXJlbmEyT3BhY2l0eTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9zZXR1cE92ZXJsYXlzKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ092ZXJsYXlzICYgRlgnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDEuIEdJRiBPdmVybGF5CiAgICAgICAgICAgIGNvbnN0IGdpZkVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NjcmVlbi1vdmVybGF5LWdpZicpOwogICAgICAgICAgICBpZiAoZ2lmRWwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdpZlBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB0cnVlLApvcGFjaXR5OiAwLjYyLAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnb3ZlcmxheScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdTY3JlZW4gR0lGJyk7CiAgICAgICAgICAgICAgICBnRm9sZGVyLmFkZChnaWZQYXJhbXMsICd2aXNpYmxlJykub25DaGFuZ2UodiA9PiBnaWZFbC5zdHlsZS5kaXNwbGF5ID0gdiA/ICdibG9jaycgOiAnbm9uZScpOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMS4wKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLm9wYWNpdHkgPSB2KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYmxlbmRNb2RlcyA9IFsKICAgICAgICAgICAgICAgICAgICAnbm9ybWFsJywgJ211bHRpcGx5JywgJ3NjcmVlbicsICdvdmVybGF5JywgCiAgICAgICAgICAgICAgICAgICAgJ2RhcmtlbicsICdsaWdodGVuJywgJ2NvbG9yLWRvZGdlJywgJ2NvbG9yLWJ1cm4nLCAKICAgICAgICAgICAgICAgICAgICAnaGFyZC1saWdodCcsICdzb2Z0LWxpZ2h0JywgJ2RpZmZlcmVuY2UnLCAnZXhjbHVzaW9uJywgCiAgICAgICAgICAgICAgICAgICAgJ2h1ZScsICdzYXR1cmF0aW9uJywgJ2NvbG9yJywgJ2x1bWlub3NpdHknCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAnYmxlbmQnLCBibGVuZE1vZGVzKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLm1peEJsZW5kTW9kZSA9IHYpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBXYXRlciBPdmVybGF5CiAgICAgICAgICAgIGNvbnN0IHdvID0gdGhpcy5nYW1lLndhdGVyT3ZlcmxheTsKICAgICAgICAgICAgaWYgKHdvICYmIHdvLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdXYXRlciBTaGFkZXInKTsKICAgICAgICAgICAgICAgIGNvbnN0IHdQYXJhbXMgPSB7IAogICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkgPyB3by5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eS52YWx1ZSA6IDAuNSwKICAgICAgICAgICAgICAgICAgICBibGVuZDogJ0FkZGl0aXZlJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ3Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IHdvLm1lc2gudmlzaWJsZSA9IHYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAod28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkpIHsKICAgICAgICAgICAgICAgICAgICB3Rm9sZGVyLmFkZCh3UGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMi4wKS5vbkNoYW5nZSh2ID0+IHdvLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlID0gdik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGhyZWVCbGVuZHMgPSB7CiAgICAgICAgICAgICAgICAgICAgJ05vcm1hbCc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdBZGRpdGl2ZSc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICAnTXVsdGlwbHknOiBUSFJFRS5NdWx0aXBseUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdOb0JsZW5kaW5nJzogVEhSRUUuTm9CbGVuZGluZwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICB3by5tYXRlcmlhbC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgIHdvLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBMaWdodCBTaGFmdHMKICAgICAgICAgICAgY29uc3QgbHMgPSB0aGlzLmdhbWUubGlnaHRTaGFmdHM7CiAgICAgICAgICAgIGlmIChscyAmJiBscy5jb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGxQYXJhbXMgPSB7IHZpc2libGU6IHRydWUgfTsKICAgICAgICAgICAgICAgIGZvbGRlci5hZGQobFBhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdMaWdodCBTaGFmdHMnKS5vbkNoYW5nZSh2ID0+IGxzLmNvbnRhaW5lci52aXNpYmxlID0gdik7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpfc2V0dXBHYW1lU3RhdGUoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignR2FtZSBTdGF0ZScpOwogICAgICAgICAgICBjb25zdCBnbSA9IHRoaXMuZ2FtZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIGZvcmNlSG9tZUdvYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5nb2FsU2NvcmVkKCdob21lJyk7IAogICAgICAgICAgICAgICAgICAgIGVsc2UgY29uc29sZS53YXJuKCJHYW1lIG11c3QgYmUgYWN0aXZlIHRvIHRyaWdnZXIgZ29hbCIpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGZvcmNlQXdheUdvYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5nb2FsU2NvcmVkKCdhd2F5Jyk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb25zb2xlLndhcm4oIkdhbWUgbXVzdCBiZSBhY3RpdmUgdG8gdHJpZ2dlciBnb2FsIik7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZm9yY2VIYWxmdGltZTogKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmKGdtLnN0YXRlID09PSAnYWN0aXZlJykgZ20uZW5kSGFsZigpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHJlc2V0Um91bmQ6ICgpID0+IGdtLnJlc2V0Um91bmQoKSwKICAgICAgICAgICAgICAgIGV4aXRUb01lbnU6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPSAnbWVudSc7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgcHJhY3RpY2UgaWYgcnVubmluZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlSG9tZUdvYWwnKS5uYW1lKCdUcmlnZ2VyIEhvbWUgR29hbCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlQXdheUdvYWwnKS5uYW1lKCdUcmlnZ2VyIEF3YXkgR29hbCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlSGFsZnRpbWUnKS5uYW1lKCdGb3JjZSBIYWxmdGltZScpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3Jlc2V0Um91bmQnKS5uYW1lKCdSZXNldCBSb3VuZCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2V4aXRUb01lbnUnKS5uYW1lKCdFeGl0IHRvIE1lbnUnKTsKICAgICAgICB9CgogICAgICAgIF9zZXR1cFRlYW1zKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1RlYW1zJyk7CiAgICAgICAgICAgIGlmICghdGhpcy5nYW1lLnRlYW1zLmhvbWUgfHwgIXRoaXMuZ2FtZS50ZWFtcy5hd2F5KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBob21lID0gdGhpcy5nYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGNvbnN0IGF3YXkgPSB0aGlzLmdhbWUudGVhbXMuYXdheTsKCiAgICAgICAgICAgIC8vIEhvbWUKICAgICAgICAgICAgY29uc3QgaEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0hvbWUgVGVhbScpOwogICAgICAgICAgICBoRm9sZGVyLmFkZChob21lLCAnaXNIdW1hbicpLm5hbWUoJ0lzIEh1bWFuIENvbnRyb2xsZWQnKS5saXN0ZW4oKTsKICAgICAgICAgICAgaEZvbGRlci5hZGQoaG9tZSwgJ2FpRW5hYmxlZCcpLm5hbWUoJ0FJIExvZ2ljIEVuYWJsZWQnKS5saXN0ZW4oKTsKCiAgICAgICAgICAgIC8vIEF3YXkKICAgICAgICAgICAgY29uc3QgYUZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0F3YXkgVGVhbScpOwogICAgICAgICAgICBhRm9sZGVyLmFkZChhd2F5LCAnaXNIdW1hbicpLm5hbWUoJ0lzIEh1bWFuIENvbnRyb2xsZWQnKS5saXN0ZW4oKTsKICAgICAgICAgICAgYUZvbGRlci5hZGQoYXdheSwgJ2FpRW5hYmxlZCcpLm5hbWUoJ0FJIExvZ2ljIEVuYWJsZWQnKS5saXN0ZW4oKTsKCiAgICAgICAgfQoKX3NldHVwUGxheWVySW5zcGVjdG9yKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1BsYXllciBJbnNwZWN0b3IgKEhvbWUgQWN0aXZlKScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGVscGVyIHRvIGdldCBjdXJyZW50IGFjdGl2ZSBwbGF5ZXIgc2FmZWx5CiAgICAgICAgICAgIGNvbnN0IGdldEFjdGl2ZSA9ICgpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5nYW1lLnRlYW1zLmhvbWUgJiYgdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSAKICAgICAgICAgICAgICAgICAgICA/IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciAKICAgICAgICAgICAgICAgICAgICA6IG51bGw7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBQcm94eSBvYmplY3QgdG8gYmluZCBHVUkgdG8gZHluYW1pYyB0YXJnZXQKICAgICAgICAgICAgY29uc3QgcHJveHkgPSB7CiAgICAgICAgICAgICAgICBnZXQgUm9sZSgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5yb2xlIDogJy0nOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGdldCBHb2RNb2RlKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLmlzR29kTW9kZSA6IGZhbHNlOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgR29kTW9kZSh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmlzR29kTW9kZSA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBSdW50aW1lIFZhbHVlcwogICAgICAgICAgICAgICAgZ2V0IEhQKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkhQIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEhQKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuSFAgPSB2OyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGdldCBDdXJyZW50RU4oKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuY3VycmVudEVOIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEN1cnJlbnRFTih2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmN1cnJlbnRFTiA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBCYXNlIFN0YXRzCiAgICAgICAgICAgICAgICBnZXQgTWF4SFAoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMubWF4SFAgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgTWF4SFAodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5tYXhIUCA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgU1AoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuU1AgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgU1AodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5TUCA9IHY7IAogICAgICAgICAgICAgICAgICAgICAgICBwLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsgCiAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEVOKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkVOIDogMDsgCiAgICAgICAgICAgICAgICB9LCAKICAgICAgICAgICAgICAgIHNldCBFTih2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHMuRU4gPSB2OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEFUKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkFUIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEFUKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQVQgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFBBKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlBBIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFBBKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuUEEgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEJMKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkJMIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEJMKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQkwgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFNIKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlNIIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFNIKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuU0ggPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IENBKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkNBIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IENBKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQ0EgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLy8gQWN0aW9ucwogICAgICAgICAgICAgICAgTGV2ZWxVcDogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5sZXZlbFVwKCk7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEZ1bGxIZWFsOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsgCiAgICAgICAgICAgICAgICAgICAgaWYocCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7IAogICAgICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuZ2V0U3RhdCgnRU4nKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLnZlbm9tID0gMDsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLm5hcCA9IDA7IAogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGsgaW4gcC5zdGF0dXMud2l0aGVyKSBwLnN0YXR1cy53aXRoZXJba10gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZih3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJGVUxMIEhFQUwiLCBwLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIERyYWluRU46ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBwLmZ1bWJsZSgpOyAvLyBUcmlnZ2VyIGZ1bWJsZSBsb2dpYwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocHJveHksICdSb2xlJykubGlzdGVuKCkuZGlzYWJsZSgpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHByb3h5LCAnR29kTW9kZScpLm5hbWUoJ0dvZCBNb2RlIChJbmYgSFAvRU4pJykubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBydEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ1J1bnRpbWUgU3RhdHVzJyk7CiAgICAgICAgICAgIHJ0Rm9sZGVyLmFkZChwcm94eSwgJ0hQJywgMCwgOTk5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHJ0Rm9sZGVyLmFkZChwcm94eSwgJ0N1cnJlbnRFTicsIDAsIDEwMCkubmFtZSgnQ3VycmVudCBFTicpLmxpc3RlbigpOwoKICAgICAgICAgICAgY29uc3Qgc3RhdEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0Jhc2UgU3RhdHMnKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdNYXhIUCcsIDEwMCwgOTk5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnRU4nLCAwLCA5OSkubmFtZSgnTWF4IEVOJykubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnU1AnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQVQnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnUEEnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQkwnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnU0gnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQ0EnLCAwLCA5OSkubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBhY3Rpb25Gb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdBY3Rpb25zJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdMZXZlbFVwJykubmFtZSgnSW5zdGFudCBMZXZlbCBVcCcpOwogICAgICAgICAgICBhY3Rpb25Gb2xkZXIuYWRkKHByb3h5LCAnRnVsbEhlYWwnKS5uYW1lKCdGdWxsIEhlYWwgJiBDdXJlJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdEcmFpbkVOJykubmFtZSgnRHJhaW4gRU4gKEZ1bWJsZSknKTsKICAgICAgICB9Cgpfc2V0dXBCYWxsU2FuZGJveCgpIHsKICAgIGNvbnN0IHJvb3QgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0JhbGwgTGFiIChUaHJvdyAmIFBoeXNpY3MpJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBTaGFyZWQgc3RhdGUgb2JqZWN0IChsaXZlcyBvbiB3aW5kb3cuZmx1eCBzbyBpdCBzdXJ2aXZlcyByZWxvYWRzKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBsYWIgPSB3aW5kb3cuZmx1eC5iYWxsTGFiID0gd2luZG93LmZsdXguYmFsbExhYiB8fCB7fTsKICAgIGxhYi5nYW1lID0gdGhpcy5nYW1lOwoKICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnOwogICAgY29uc3QgVEMgPSB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZzsKCiAgICBpZiAoIUMgfHwgIVRDKSB7CiAgICAgICAgY29uc29sZS53YXJuKCJCYWxsIExhYjogTWlzc2luZyBCYWxsQ29uZmlnIG9yIFRocm93Q29uZmlnLiIpOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEhlbHBlcnMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgZ2V0QmFsbCA9ICgpID0+IHRoaXMuZ2FtZSAmJiB0aGlzLmdhbWUuZW50aXRpZXMgPyB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICBjb25zdCBnZXRBY3RpdmUgPSAoKSA9PiB0aGlzLmdhbWUgJiYgdGhpcy5nYW1lLnRlYW1zICYmIHRoaXMuZ2FtZS50ZWFtcy5ob21lID8gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKCiAgICBjb25zdCBlbnN1cmVQcmV2aWV3TGluZSA9ICgpID0+IHsKICAgICAgICBpZiAobGFiLnByZXZpZXdMaW5lKSByZXR1cm47CiAgICAgICAgaWYgKCF0aGlzLmdhbWUgfHwgIXRoaXMuZ2FtZS5zY2VuZSkgcmV0dXJuOwoKICAgICAgICBjb25zdCBnZW9tID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgdHJhbnNwYXJlbnQ6IHRydWUsIG9wYWNpdHk6IDAuOTUgfSk7CiAgICAgICAgY29uc3QgbGluZSA9IG5ldyBUSFJFRS5MaW5lKGdlb20sIG1hdCk7CiAgICAgICAgbGluZS5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgbGluZS5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKGxpbmUpOwogICAgICAgIGxhYi5wcmV2aWV3TGluZSA9IGxpbmU7CiAgICB9OwoKICAgIGNvbnN0IGNsZWFyUHJldmlld0xpbmUgPSAoKSA9PiB7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3TGluZSAmJiBsYWIucHJldmlld0xpbmUuZ2VvbWV0cnkpIHsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBBIHNhZmUgImdob3N0IGJhbGwiIHRoYXQgY2FuIHVzZSBCYWxsLnVwZGF0ZUZyZWUgd2l0aG91dCBzcGF3bmluZyBGWAogICAgY29uc3QgbWFrZUdob3N0QmFsbCA9IChwb3MsIHZlbCwgc3BpbikgPT4gewogICAgICAgIGNvbnN0IGdiID0gewogICAgICAgICAgICBtZXNoOiB7IHBvc2l0aW9uOiBwb3MuY2xvbmUoKSB9LAogICAgICAgICAgICB2ZWxvY2l0eTogdmVsLmNsb25lKCksCiAgICAgICAgICAgIGFuZ3VsYXJWZWxvY2l0eTogKHNwaW4gPyBzcGluLmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpKSwKICAgICAgICAgICAgYWNjdW11bGF0ZWRSb3RhdGlvbjogbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwKICAgICAgICAgICAgcG93ZXI6IDAsCiAgICAgICAgICAgIGRlY2F5UmF0ZTogMCwKICAgICAgICAgICAgX2J1YmJsZVRpbWVyOiA5OTksCiAgICAgICAgICAgIF9naG9zdDogdHJ1ZSwKICAgICAgICAgICAgZGVmb3JtTm9kZTogbnVsbAogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGdiOwogICAgfTsKCiAgICAvLyBVc2UgQmFsbC51cGRhdGVGcmVlIGZvciBmYWl0aGZ1bCB0cmFqZWN0b3J5IHByZWRpY3Rpb24KICAgIGNvbnN0IHNpbXVsYXRlID0gKGdob3N0QmFsbCwgc3RlcHMsIHN0ZXBEdCkgPT4gewogICAgICAgIGNvbnN0IHB0cyA9IFtdOwogICAgICAgIHB0cy5wdXNoKGdob3N0QmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCkpOwogICAgICAgIGNvbnN0IHByb3RvID0gd2luZG93LmZsdXguQmFsbCAmJiB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZTsKICAgICAgICBpZiAoIXByb3RvIHx8IHR5cGVvZiBwcm90by51cGRhdGVGcmVlICE9PSAnZnVuY3Rpb24nKSByZXR1cm4gcHRzOwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ZXBzOyBpKyspIHsKICAgICAgICAgICAgcHJvdG8udXBkYXRlRnJlZS5jYWxsKGdob3N0QmFsbCwgc3RlcER0KTsKICAgICAgICAgICAgcHRzLnB1c2goZ2hvc3RCYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwdHM7CiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gUHJldmlldyArIHJlY29yZC9yZXBsYXkgcnVudGltZSBsb29wCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KbGFiLnByZXZpZXcgPSBsYWIucHJldmlldyB8fCB7CiAgICAgICAgZW5hYmxlZDogZmFsc2UsCiAgICAgICAgc291cmNlOiAnQ2Fubm9uJywKICAgICAgICBzdGVwczogMTIwLAogICAgICAgIHN0ZXBEdDogMS82MCwKICAgICAgICByZWZyZXNoSHo6IDEwLAogICAgICAgIHNob3dPbkhlbGRPbmx5OiBmYWxzZQogICAgfTsKCiAgICBsYWIuY2Fubm9uID0gbGFiLmNhbm5vbiB8fCB7CiAgICAgICAgeWF3OiAwLAogICAgICAgIHBpdGNoOiAwLAogICAgICAgIHBvd2VyOiAyMCwKICAgICAgICB0eXBlOiAnU0gnLAogICAgICAgIHNwaW5YOiAwLAogICAgICAgIHNwaW5ZOiAwLAogICAgICAgIHNwaW5aOiAwLAogICAgICAgIGZpcmVCdXJzdDogMSwKICAgICAgICBzcHJlYWREZWc6IDAKICAgIH07CgogICAgbGFiLnJlY29yZGluZyA9IGxhYi5yZWNvcmRpbmcgfHwgewogICAgICAgIGlzUmVjb3JkaW5nOiBmYWxzZSwKICAgICAgICBmcmFtZXM6IFtdLAogICAgICAgIG1heFNlY29uZHM6IDEyCiAgICB9OwoKICAgIGxhYi5yZXBsYXkgPSBsYWIucmVwbGF5IHx8IHsKICAgICAgICBpc1JlcGxheWluZzogZmFsc2UsCiAgICAgICAgZnJhbWVzOiBbXSwKICAgICAgICBpZHg6IDAsCiAgICAgICAgbG9vcDogdHJ1ZSwKICAgICAgICBzcGVlZDogMS4wCiAgICB9OwoKICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgbGFiLnRhcmdldEJhbGwgPSBudWxsOwoKICAgIGxhYi5hcHBseVJlcGxheUZyYW1lID0gKGJhbGwsIGR0KSA9PiB7CiAgICAgICAgY29uc3QgcmVwID0gbGFiLnJlcGxheTsKICAgICAgICBpZiAoIXJlcCB8fCAhcmVwLmlzUmVwbGF5aW5nIHx8ICFyZXAuZnJhbWVzIHx8IHJlcC5mcmFtZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBBZHZhbmNlIHRpbWUgYnkgc3RlcHBpbmcgaW5kaWNlcyAoZnJhbWUtYmFzZWQpCiAgICAgICAgY29uc3Qgc3RlcCA9IE1hdGgubWF4KDEsIE1hdGguZmxvb3IocmVwLnNwZWVkKSk7CiAgICAgICAgcmVwLmlkeCArPSBzdGVwOwoKICAgICAgICBpZiAocmVwLmlkeCA+PSByZXAuZnJhbWVzLmxlbmd0aCkgewogICAgICAgICAgICBpZiAocmVwLmxvb3ApIHJlcC5pZHggPSAwOwogICAgICAgICAgICBlbHNlIHsgcmVwLmlzUmVwbGF5aW5nID0gZmFsc2U7IGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOyByZXR1cm47IH0KICAgICAgICB9CgogICAgICAgIGNvbnN0IGYgPSByZXAuZnJhbWVzW3JlcC5pZHhdOwogICAgICAgIGlmICghZikgcmV0dXJuOwoKICAgICAgICBiYWxsLmRyb3AoKTsgLy8gZW5zdXJlIG5vIGhvbGRlciBsb2dpYyBmaWdodHMgdXMKICAgICAgICBiYWxsLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIGJhbGwubWVzaC5wb3NpdGlvbi5zZXQoZi5weCwgZi5weSwgZi5weik7CiAgICAgICAgYmFsbC52ZWxvY2l0eS5zZXQoZi52eCwgZi52eSwgZi52eik7CiAgICAgICAgYmFsbC5hbmd1bGFyVmVsb2NpdHkuc2V0KGYuc3gsIGYuc3ksIGYuc3opOwogICAgfTsKCiAgICBsYWIuX3ByZXZpZXdUaW1lciA9IGxhYi5fcHJldmlld1RpbWVyIHx8IDA7CgogICAgbGFiLnVwZGF0ZSA9IChkdCkgPT4gewogICAgICAgIC8vIC0tLSByZWNvcmRpbmcgLS0tCiAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICBpZiAoYiAmJiBsYWIucmVjb3JkaW5nICYmIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcpIHsKICAgICAgICAgICAgY29uc3QgciA9IGxhYi5yZWNvcmRpbmc7CiAgICAgICAgICAgIGNvbnN0IG1heEZyYW1lcyA9IE1hdGguZmxvb3IoKHIubWF4U2Vjb25kcyB8fCAxMikgLyAoZHQgfHwgKDEvNjApKSk7CiAgICAgICAgICAgIGlmIChyLmZyYW1lcy5sZW5ndGggPiBtYXhGcmFtZXMpIHIuZnJhbWVzLnNoaWZ0KCk7CiAgICAgICAgICAgIHIuZnJhbWVzLnB1c2goewogICAgICAgICAgICAgICAgcHg6IGIubWVzaC5wb3NpdGlvbi54LCBweTogYi5tZXNoLnBvc2l0aW9uLnksIHB6OiBiLm1lc2gucG9zaXRpb24ueiwKICAgICAgICAgICAgICAgIHZ4OiBiLnZlbG9jaXR5LngsIHZ5OiBiLnZlbG9jaXR5LnksIHZ6OiBiLnZlbG9jaXR5LnosCiAgICAgICAgICAgICAgICBzeDogYi5hbmd1bGFyVmVsb2NpdHkueCwgc3k6IGIuYW5ndWxhclZlbG9jaXR5LnksIHN6OiBiLmFuZ3VsYXJWZWxvY2l0eS56CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIHByZXZpZXcgcmVmcmVzaCAtLS0KICAgICAgICBsYWIuX3ByZXZpZXdUaW1lciArPSBkdDsKICAgICAgICBjb25zdCByZWZyZXNoSW50ZXJ2YWwgPSAxLjAgLyBNYXRoLm1heCgxLCAobGFiLnByZXZpZXcucmVmcmVzaEh6IHx8IDEwKSk7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LmVuYWJsZWQgJiYgbGFiLl9wcmV2aWV3VGltZXIgPj0gcmVmcmVzaEludGVydmFsKSB7CiAgICAgICAgICAgIGxhYi5fcHJldmlld1RpbWVyID0gMDsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfQogICAgfTsKCiAgICBsYWIucmVmcmVzaFByZXZpZXcgPSAoKSA9PiB7CiAgICAgICAgaWYgKCFsYWIucHJldmlldy5lbmFibGVkKSB7IGNsZWFyUHJldmlld0xpbmUoKTsgcmV0dXJuOyB9CiAgICAgICAgZW5zdXJlUHJldmlld0xpbmUoKTsKCiAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgaWYgKCFiIHx8ICFiLm1lc2gpIHJldHVybjsKCiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LnNob3dPbkhlbGRPbmx5ICYmIGIuc3RhdGUgIT09ICdoZWxkJykgewogICAgICAgICAgICBjbGVhclByZXZpZXdMaW5lKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIERlY2lkZSBwcmV2aWV3IHNvdXJjZQogICAgICAgIGxldCBzdGFydFBvcyA9IGIubWVzaC5wb3NpdGlvbjsKICAgICAgICBsZXQgc3RhcnRWZWwgPSBiLnZlbG9jaXR5OwogICAgICAgIGxldCBzdGFydFNwaW4gPSBiLmFuZ3VsYXJWZWxvY2l0eTsKCiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LnNvdXJjZSA9PT0gJ0Nhbm5vbicpIHsKICAgICAgICAgICAgLy8gQ2Fubm9uIGFsd2F5cyBsYXVuY2hlcyBmcm9tIGJhbGwgcG9zaXRpb24gKG9yIHBsYXllciBpZiBoZWxkKQogICAgICAgICAgICBjb25zdCB5YXdSYWQgPSAobGFiLmNhbm5vbi55YXcgfHwgMCkgKiBNYXRoLlBJIC8gMTgwOwogICAgICAgICAgICBjb25zdCBwaXRjaFJhZCA9IChsYWIuY2Fubm9uLnBpdGNoIHx8IDApICogTWF0aC5QSSAvIDE4MDsKCiAgICAgICAgICAgIGNvbnN0IGRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgTWF0aC5zaW4oeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIE1hdGguc2luKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIC1NYXRoLmNvcyh5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpCiAgICAgICAgICAgICkubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBjYXAgPSAod2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfQ0FQICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkxBVU5DSF9TUEVFRF9DQVAgOiA4NS4wKTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAod2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfU0NBTEUgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX1NDQUxFIDogMS4wKTsKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSBNYXRoLm1pbigobGFiLmNhbm5vbi5wb3dlciB8fCAyMCkgKiBzY2FsZSwgY2FwKTsKCiAgICAgICAgICAgIHN0YXJ0UG9zID0gKGIuc3RhdGUgPT09ICdoZWxkJyAmJiBwICYmIHAubWVzaCkgPyBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMS4yLCAwKSkgOiBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgc3RhcnRWZWwgPSBkaXIubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICBzdGFydFNwaW4gPSBuZXcgVEhSRUUuVmVjdG9yMyhsYWIuY2Fubm9uLnNwaW5YIHx8IDAsIGxhYi5jYW5ub24uc3BpblkgfHwgMCwgbGFiLmNhbm5vbi5zcGluWiB8fCAwKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGdob3N0ID0gbWFrZUdob3N0QmFsbChzdGFydFBvcy5jbG9uZSgpLCBzdGFydFZlbC5jbG9uZSgpLCBzdGFydFNwaW4pOwogICAgICAgIGNvbnN0IHB0cyA9IHNpbXVsYXRlKGdob3N0LCBNYXRoLmZsb29yKGxhYi5wcmV2aWV3LnN0ZXBzIHx8IDEyMCksIChsYWIucHJldmlldy5zdGVwRHQgfHwgKDEvNjApKSk7CgogICAgICAgIGlmIChsYWIucHJldmlld0xpbmUpIHsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCkuc2V0RnJvbVBvaW50cyhwdHMpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IEJhbGwgUGh5c2ljcyAoQmFsbENvbmZpZykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcGh5cyA9IHJvb3QuYWRkRm9sZGVyKCdCYWxsIFBoeXNpY3MgKEJhbGxDb25maWcpJyk7CgogICAgY29uc3QgaW50ZWcgPSBwaHlzLmFkZEZvbGRlcignSW50ZWdyYXRpb24nKTsKICAgIGludGVnLmFkZChDLCAnU1VCU1RFUFMnLCAxLCAxMiwgMSkubmFtZSgnU3Vic3RlcHMnKTsKICAgIGludGVnLmFkZChDLCAnU1RPUF9TUEVFRCcsIDAuMCwgMC4yKS5uYW1lKCdTdG9wIFNwZWVkJyk7CgogICAgY29uc3QgZHJhZyA9IHBoeXMuYWRkRm9sZGVyKCdXYXRlciBEcmFnJyk7CiAgICBkcmFnLmFkZChDLCAnV0FURVJfRFJBR19MSU5FQVInLCAwLjAsIDIuMCkubmFtZSgnTGluZWFyIERyYWcnKTsKICAgIGRyYWcuYWRkKEMsICdXQVRFUl9EUkFHX1FVQUQnLCAwLjAsIDAuMDUpLm5hbWUoJ1F1YWRyYXRpYyBEcmFnJyk7CgogICAgY29uc3Qgc3BpbiA9IHBoeXMuYWRkRm9sZGVyKCdTcGluJyk7CiAgICBzcGluLmFkZChDLCAnU1BJTl9EUkFHJywgMC4wLCAzLjApLm5hbWUoJ1NwaW4gRGVjYXknKTsKCiAgICBjb25zdCBtYWdudXMgPSBwaHlzLmFkZEZvbGRlcignTWFnbnVzJyk7CiAgICBtYWdudXMuYWRkKEMsICdNQUdOVVNfRU5BQkxFRCcpLm5hbWUoJ0VuYWJsZWQnKTsKICAgIG1hZ251cy5hZGQoQywgJ01BR05VU19DT0VGRicsIDAuMCwgMC41KS5uYW1lKCdDb2VmZicpOwogICAgbWFnbnVzLmFkZChDLCAnTUFHTlVTX0NBUCcsIDAuMCwgMjAwLjApLm5hbWUoJ0NhcCcpOwoKICAgIGNvbnN0IGRlcHRoID0gcGh5cy5hZGRGb2xkZXIoJ0RlcHRoIENvbnN0cmFpbnQnKTsKICAgIGRlcHRoLmFkZChDLCAnREVQVEhfVEFSR0VUX1knLCAtNS4wLCA1LjApLm5hbWUoJ1RhcmdldCBZJyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX1NQUklORycsIDAuMCwgMTAuMCkubmFtZSgnU3ByaW5nJyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX0RBTVAnLCAwLjAsIDYuMCkubmFtZSgnRGFtcCcpOwoKICAgIGNvbnN0IGFyZW5hID0gcGh5cy5hZGRGb2xkZXIoJ0FyZW5hIEJvdW5kYXJ5Jyk7CiAgICBhcmVuYS5hZGQoQywgJ0JPVU5EQVJZX1JBRElVUycsIDEwLjAsIDEyMC4wKS5uYW1lKCdSYWRpdXMnKTsKICAgIGFyZW5hLmFkZChDLCAnQk9VTkRBUllfSEVJR0hUJywgMi4wLCA0MC4wKS5uYW1lKCdIZWlnaHQnKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9TT0ZUX0JVRkZFUicsIDAuMCwgMjAuMCkubmFtZSgnU29mdCBCdWZmZXInKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9TT0ZUX0ZPUkNFJywgMC4wLCAyMDAuMCkubmFtZSgnU29mdCBGb3JjZScpOwogICAgYXJlbmEuYWRkKEMsICdXQUxMX0VMQVNUSUNJVFknLCAwLjAsIDEuMCkubmFtZSgnV2FsbCBCb3VuY2UnKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9GUklDVElPTicsIDAuMCwgMS4wKS5uYW1lKCdXYWxsIEZyaWN0aW9uJyk7CiAgICBhcmVuYS5hZGQoQywgJ0ZMT09SX0VMQVNUSUNJVFknLCAwLjAsIDEuMCkubmFtZSgnQ2VpbC9GbG9vciBCb3VuY2UnKTsKCiAgICBjb25zdCBwb2NrZXQgPSBhcmVuYS5hZGRGb2xkZXIoJ0dvYWwgUG9ja2V0Jyk7CiAgICBwb2NrZXQuYWRkKEMsICdHT0FMX1BPQ0tFVF9FTkFCTEVEJykubmFtZSgnRW5hYmxlZCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfWCcsIDAuMCwgNDAuMCkubmFtZSgnUG9ja2V0IEhhbGYtWCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfWicsIDAuMCwgNTAuMCkubmFtZSgnUG9ja2V0IFN0YXJ0IHxafCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfUkFESVVTJywgMTAuMCwgMTIwLjApLm5hbWUoJ1BvY2tldCBSYWRpdXMnKTsKCiAgICBjb25zdCBsYXVuY2ggPSBwaHlzLmFkZEZvbGRlcignTGF1bmNoIE1hcHBpbmcnKTsKICAgIGxhdW5jaC5hZGQoQywgJ0xBVU5DSF9TUEVFRF9TQ0FMRScsIDAuMSwgNS4wKS5uYW1lKCdTcGVlZCBTY2FsZScpOwogICAgbGF1bmNoLmFkZChDLCAnTEFVTkNIX1NQRUVEX0NBUCcsIDEwLjAsIDIwMC4wKS5uYW1lKCdTcGVlZCBDYXAnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogVGhyb3cgbWFwcGluZyAoUGxheWVyLnJlbGVhc2VDaGFyZ2UgLT4gQmFsbC5zaG9vdCkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgdGhyb3dNYXAgPSByb290LmFkZEZvbGRlcignVGhyb3cgTWFwcGluZyAoVGhyb3dDb25maWcpJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdTV0lQRV9NSU5fUFgnLCAwLCAxMjAsIDEpLm5hbWUoJ1N3aXBlIE1pbiBQWCcpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnQUlNX0RYX1NDQUxFJywgMC4xLCA1LjApLm5hbWUoJ0FpbSBYIFNjYWxlJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdBSU1fRFlfU0NBTEUnLCAwLjEsIDUuMCkubmFtZSgnQWltIFkgU2NhbGUnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX0JBU0UnLCAwLjEsIDMuMCkubmFtZSgnUG93ZXIgQmFzZScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnUE9XRVJfUkFOR0UnLCAwLjAsIDMuMCkubmFtZSgnUG93ZXIgUmFuZ2UnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX01BWF9CT05VU19SQVRJTycsIDAuMCwgMS4wKS5uYW1lKCdNYXggQm9udXMgUmF0aW8nKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX01BWF9NVUxUSVBMSUVSJywgMS4wLCA2LjApLm5hbWUoJ01heCBNdWx0aXBsaWVyJyk7CgogICAgY29uc3QgY3VydmVNYXAgPSB0aHJvd01hcC5hZGRGb2xkZXIoJ0N1cnZlJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9FTkFCTEVEJykubmFtZSgnRW5hYmxlZCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRCcsIDAuMCwgMS4wKS5uYW1lKCdJbnB1dCBUaHJlc2hvbGQnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX1NQSU5fU0NBTEUnLCAwLjAsIDQwMDAuMCkubmFtZSgnU3BpbiBTY2FsZScpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfU1BFRURfTVVMVCcsIDAuMCwgNS4wKS5uYW1lKCdTd2lwZSBTcGVlZCBNdWx0Jyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9TUElOX0NBUCcsIDAuMCwgNjAwMC4wKS5uYW1lKCdTcGluIENhcCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfUEVSRkVDVF9TUElOJywgMC4wLCAyMDAwLjApLm5hbWUoJ1BlcmZlY3QgVGhyZXNob2xkJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFRlbGVwb3J0IC8gU3RhdGUgdG9vbHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgdHAgPSByb290LmFkZEZvbGRlcignVGVsZXBvcnQgLyBSZXNldCcpOwogICAgY29uc3QgdHBQYXJhbXMgPSB7CiAgICAgICAgVG9DZW50ZXI6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgaWYgKGIpIGIucmVzZXQoKTsgfSwKICAgICAgICBUb0FjdGl2ZVBsYXllcjogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBjb25zdCBwID0gZ2V0QWN0aXZlKCk7IGlmIChiICYmIHApIGIuZ3JhYihwKTsgfSwKICAgICAgICBUb0hvbWVHb2FsOiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGlmIChiKSB7IGIuZHJvcCgpOyBiLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDI1KTsgYi52ZWxvY2l0eS5zZXQoMCwwLDApOyBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOyB9IH0sCiAgICAgICAgVG9Bd2F5R29hbDogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMjUpOyBiLnZlbG9jaXR5LnNldCgwLDAsMCk7IGIuYW5ndWxhclZlbG9jaXR5LnNldCgwLDAsMCk7IH0gfSwKICAgICAgICBUb1NreTogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAxMCwgMCk7IGIudmVsb2NpdHkuc2V0KDAsMCwwKTsgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsgfSB9LAogICAgICAgIENsZWFyUHJldmlldzogKCkgPT4gY2xlYXJQcmV2aWV3TGluZSgpCiAgICB9OwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9DZW50ZXInKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvQWN0aXZlUGxheWVyJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0hvbWVHb2FsJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0F3YXlHb2FsJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb1NreScpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnQ2xlYXJQcmV2aWV3Jyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFNob3QgQ2Fubm9uIChmb3JjZSBmaXJlIHdpdGggcGFyYW1zKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBjYW5ub24gPSByb290LmFkZEZvbGRlcignU2hvdCBDYW5ub24nKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3lhdycsIC0xODAsIDE4MCwgMSkubmFtZSgnWWF3IChkZWcpJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdwaXRjaCcsIC04OSwgODksIDEpLm5hbWUoJ1BpdGNoIChkZWcpJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdwb3dlcicsIDAsIDEyMCwgMC4xKS5uYW1lKCdQb3dlcicpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAndHlwZScsIFsnUEEnLCdTSCddKS5uYW1lKCdUeXBlJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcGluWCcsIC0zMDAwLCAzMDAwLCAxKS5uYW1lKCdTcGluIFgnKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwaW5ZJywgLTMwMDAsIDMwMDAsIDEpLm5hbWUoJ1NwaW4gWScpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnc3BpblonLCAtMzAwMCwgMzAwMCwgMSkubmFtZSgnU3BpbiBaJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdmaXJlQnVyc3QnLCAxLCAxMCwgMSkubmFtZSgnQnVyc3QgQ291bnQnKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwcmVhZERlZycsIDAsIDMwLCAwLjUpLm5hbWUoJ1NwcmVhZCAoZGVnKScpOwoKICAgIGNvbnN0IGZpcmVQYXJhbXMgPSB7CiAgICAgICAgRmlyZTogKCkgPT4gewogICAgICAgICAgICBjb25zdCBiID0gZ2V0QmFsbCgpOwogICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgIGlmICghYikgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgeWF3UmFkID0gKGxhYi5jYW5ub24ueWF3IHx8IDApICogTWF0aC5QSSAvIDE4MDsKICAgICAgICAgICAgY29uc3QgcGl0Y2hSYWQgPSAobGFiLmNhbm5vbi5waXRjaCB8fCAwKSAqIE1hdGguUEkgLyAxODA7CgogICAgICAgICAgICBjb25zdCBiYXNlRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICBNYXRoLnNpbih5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpLAogICAgICAgICAgICAgICAgTWF0aC5zaW4ocGl0Y2hSYWQpLAogICAgICAgICAgICAgICAgLU1hdGguY29zKHlhd1JhZCkgKiBNYXRoLmNvcyhwaXRjaFJhZCkKICAgICAgICAgICAgKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gKGIuc3RhdGUgPT09ICdoZWxkJyAmJiBwICYmIHAubWVzaCkgPyBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMS4yLCAwKSkgOiBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKCiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgKGxhYi5jYW5ub24uZmlyZUJ1cnN0IHx8IDEpOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IGJhc2VEaXIuY2xvbmUoKTsKICAgICAgICAgICAgICAgIGlmIChsYWIuY2Fubm9uLnNwcmVhZERlZyA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcHJlYWQgPSAobGFiLmNhbm5vbi5zcHJlYWREZWcgKiBNYXRoLlBJIC8gMTgwKTsKICAgICAgICAgICAgICAgICAgICBkaXIueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogc3ByZWFkOwogICAgICAgICAgICAgICAgICAgIGRpci55ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcHJlYWQ7CiAgICAgICAgICAgICAgICAgICAgZGlyLnogKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIHNwcmVhZDsKICAgICAgICAgICAgICAgICAgICBkaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYi5kcm9wKCk7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24uY29weShzdGFydCk7CiAgICAgICAgICAgICAgICBiLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOwoKICAgICAgICAgICAgICAgIGNvbnN0IHNwaW4gPSBuZXcgVEhSRUUuVmVjdG9yMyhsYWIuY2Fubm9uLnNwaW5YIHx8IDAsIGxhYi5jYW5ub24uc3BpblkgfHwgMCwgbGFiLmNhbm5vbi5zcGluWiB8fCAwKTsKICAgICAgICAgICAgICAgIGIuc2hvb3QoZGlyLCBsYWIuY2Fubm9uLnBvd2VyIHx8IDIwLCBsYWIuY2Fubm9uLnR5cGUgfHwgJ1NIJywgbnVsbCwgc3Bpbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgY2Fubm9uLmFkZChmaXJlUGFyYW1zLCAnRmlyZScpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBUcmFqZWN0b3J5IFByZXZpZXcKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcHJldmlldyA9IHJvb3QuYWRkRm9sZGVyKCdUcmFqZWN0b3J5IFByZXZpZXcnKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnZW5hYmxlZCcpLm5hbWUoJ0VuYWJsZWQnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3NvdXJjZScsIFsnQ2Fubm9uJywgJ0xpdmUgQmFsbCddKS5uYW1lKCdTb3VyY2UnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3N0ZXBzJywgMTAsIDYwMCwgMSkubmFtZSgnU3RlcHMnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3N0ZXBEdCcsIDEvMjQwLCAxLzE1LCAxLzI0MCkubmFtZSgnU3RlcCBkdCcpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAncmVmcmVzaEh6JywgMSwgNjAsIDEpLm5hbWUoJ1JlZnJlc2ggSHonKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc2hvd09uSGVsZE9ubHknKS5uYW1lKCdPbmx5IHdoZW4gSGVsZCcpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKCiAgICBjb25zdCBwcmV2aWV3QnRucyA9IHsKICAgICAgICBSZWZyZXNoOiAoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSwKICAgICAgICBIaWRlOiAoKSA9PiB7IGxhYi5wcmV2aWV3LmVuYWJsZWQgPSBmYWxzZTsgY2xlYXJQcmV2aWV3TGluZSgpOyB9CiAgICB9OwogICAgcHJldmlldy5hZGQocHJldmlld0J0bnMsICdSZWZyZXNoJyk7CiAgICBwcmV2aWV3LmFkZChwcmV2aWV3QnRucywgJ0hpZGUnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogUmVjb3JkIC8gUmVwbGF5CiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHJyID0gcm9vdC5hZGRGb2xkZXIoJ1JlY29yZCAvIFJlcGxheScpOwogICAgY29uc3QgcnJQYXJhbXMgPSB7CiAgICAgICAgUmVjb3JkOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcgPSB0cnVlOwogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmZyYW1lcyA9IFtdOwogICAgICAgIH0sCiAgICAgICAgU3RvcDogKCkgPT4gewogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmlzUmVjb3JkaW5nID0gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICBVc2VSZWNvcmRpbmdGb3JSZXBsYXk6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlcGxheS5mcmFtZXMgPSAobGFiLnJlY29yZGluZy5mcmFtZXMgfHwgW10pLnNsaWNlKCk7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaWR4ID0gMDsKICAgICAgICB9LAogICAgICAgIFBsYXk6ICgpID0+IHsKICAgICAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICAgICAgaWYgKCFiKSByZXR1cm47CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaXNSZXBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICBsYWIudGFyZ2V0QmFsbCA9IGI7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaWR4ID0gMDsKICAgICAgICB9LAogICAgICAgIFBhdXNlOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgbGFiLmlzUmVwbGF5aW5nID0gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICBDbGVhcjogKCkgPT4gewogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmZyYW1lcyA9IFtdOwogICAgICAgICAgICBsYWIucmVwbGF5LmZyYW1lcyA9IFtdOwogICAgICAgICAgICBsYWIucmVwbGF5LmlkeCA9IDA7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgbGFiLmlzUmVwbGF5aW5nID0gZmFsc2U7CiAgICAgICAgfQogICAgfTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1JlY29yZCcpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnU3RvcCcpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnVXNlUmVjb3JkaW5nRm9yUmVwbGF5JykubmFtZSgnQ29weSBSZWMgLT4gUmVwbGF5Jyk7CiAgICByci5hZGQobGFiLnJlcGxheSwgJ2xvb3AnKS5uYW1lKCdMb29wJyk7CiAgICByci5hZGQobGFiLnJlcGxheSwgJ3NwZWVkJywgMC4yNSwgNi4wLCAwLjI1KS5uYW1lKCdSZXBsYXkgU3BlZWQnKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1BsYXknKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1BhdXNlJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdDbGVhcicpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBQcmVzZXRzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHByZXNldHMgPSByb290LmFkZEZvbGRlcignUHJlc2V0cycpOwogICAgY29uc3QgUCA9IHsKICAgICAgICBWYW5pbGxhOiAoKSA9PiB7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oQywgewogICAgICAgICAgICAgICAgU1VCU1RFUFM6IDIsCiAgICAgICAgICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMTUsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX1FVQUQ6IDAuMDAyLAogICAgICAgICAgICAgICAgU1BJTl9EUkFHOiAwLjQwLAogICAgICAgICAgICAgICAgTUFHTlVTX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ09FRkY6IDAuMDgsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ0FQOiA2MC4wLAogICAgICAgICAgICAgICAgREVQVEhfVEFSR0VUX1k6IDAuMCwKICAgICAgICAgICAgICAgIERFUFRIX1NQUklORzogMS4wLAogICAgICAgICAgICAgICAgREVQVEhfREFNUDogMS41LAogICAgICAgICAgICAgICAgQk9VTkRBUllfUkFESVVTOiAzMy4wLAogICAgICAgICAgICAgICAgQk9VTkRBUllfSEVJR0hUOiAxNS4wLAogICAgICAgICAgICAgICAgV0FMTF9TT0ZUX0JVRkZFUjogMy4wLAogICAgICAgICAgICAgICAgV0FMTF9TT0ZUX0ZPUkNFOiAyMC4wLAogICAgICAgICAgICAgICAgV0FMTF9FTEFTVElDSVRZOiAwLjMwLAogICAgICAgICAgICAgICAgV0FMTF9GUklDVElPTjogMC45NSwKICAgICAgICAgICAgICAgIEZMT09SX0VMQVNUSUNJVFk6IDAuNDAsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgR09BTF9QT0NLRVRfWDogMTIuMCwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX1o6IDI1LjAsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9SQURJVVM6IDQ1LjAsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfU0NBTEU6IDEuMCwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDg1LjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0sCiAgICAgICAgQXJjYWRlQ3VydmU6ICgpID0+IHsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihDLCB7CiAgICAgICAgICAgICAgICBNQUdOVVNfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIE1BR05VU19DT0VGRjogMC4xNiwKICAgICAgICAgICAgICAgIE1BR05VU19DQVA6IDkwLjAsCiAgICAgICAgICAgICAgICBTUElOX0RSQUc6IDAuMjUsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX0xJTkVBUjogMC4xMiwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDEsCiAgICAgICAgICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDM1LjAsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfQ0FQOiAxMTAuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihUQywgewogICAgICAgICAgICAgICAgQ1VSVkVfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIENVUlZFX1NQSU5fU0NBTEU6IDE1MDAuMCwKICAgICAgICAgICAgICAgIENVUlZFX1NQSU5fQ0FQOiAzMDAwLjAsCiAgICAgICAgICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDcwMC4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsYWIucmVmcmVzaFByZXZpZXcoKTsKICAgICAgICB9LAogICAgICAgIFNuYXBweVJlYWxpc3RpYzogKCkgPT4gewogICAgICAgICAgICBPYmplY3QuYXNzaWduKEMsIHsKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfTElORUFSOiAwLjI1LAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19RVUFEOiAwLjAwNiwKICAgICAgICAgICAgICAgIE1BR05VU19DT0VGRjogMC4wNSwKICAgICAgICAgICAgICAgIE1BR05VU19DQVA6IDQwLjAsCiAgICAgICAgICAgICAgICBTUElOX0RSQUc6IDAuNzUsCiAgICAgICAgICAgICAgICBTVE9QX1NQRUVEOiAwLjA1LAogICAgICAgICAgICAgICAgTEFVTkNIX1NQRUVEX0NBUDogNzAuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfQogICAgfTsKICAgIHByZXNldHMuYWRkKFAsICdWYW5pbGxhJyk7CiAgICBwcmVzZXRzLmFkZChQLCAnQXJjYWRlQ3VydmUnKTsKICAgIHByZXNldHMuYWRkKFAsICdTbmFwcHlSZWFsaXN0aWMnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogU25hcHNob3QgLyBFeHBvcnQKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3Qgc25hcHNob3QgPSByb290LmFkZEZvbGRlcignU25hcHNob3QgLyBFeHBvcnQnKTsKCiAgICBjb25zdCBfcm91bmQgPSAobiwgcGxhY2VzID0gNCkgPT4gewogICAgICAgIGlmICghTnVtYmVyLmlzRmluaXRlKG4pKSByZXR1cm4gbnVsbDsKICAgICAgICBjb25zdCBwID0gTWF0aC5wb3coMTAsIHBsYWNlcyk7CiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQobiAqIHApIC8gcDsKICAgIH07CgogICAgY29uc3QgX3YzID0gKHYsIHBsYWNlcyA9IDQpID0+IHsKICAgICAgICBpZiAoIXYpIHJldHVybiBudWxsOwogICAgICAgIHJldHVybiBbX3JvdW5kKHYueCwgcGxhY2VzKSwgX3JvdW5kKHYueSwgcGxhY2VzKSwgX3JvdW5kKHYueiwgcGxhY2VzKV07CiAgICB9OwoKICAgIGNvbnN0IF9jbG9uZUpzb24gPSAob2JqKSA9PiB7CiAgICAgICAgaWYgKCFvYmopIHJldHVybiBudWxsOwogICAgICAgIHRyeSB7IHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KG9iaikpOyB9IGNhdGNoIChlKSB7IHJldHVybiBudWxsOyB9CiAgICB9OwoKICAgIGNvbnN0IF9wbGF5ZXJTbmFwID0gKHApID0+IHsKICAgICAgICBpZiAoIXApIHJldHVybiBudWxsOwogICAgICAgIGNvbnN0IGFuaW0gPSAocC5hY3RpdmVBY3Rpb24gJiYgcC5hY3RpdmVBY3Rpb24uX2NsaXApID8gcC5hY3RpdmVBY3Rpb24uX2NsaXAubmFtZSA6IChwLnN0YXRlIHx8IG51bGwpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG5hbWU6IHAuY2hhcmFjdGVyTmFtZSB8fCBwLm5hbWUgfHwgbnVsbCwKICAgICAgICAgICAgcm9sZTogcC5yb2xlIHx8IG51bGwsCiAgICAgICAgICAgIHN0YXRlOiBwLnN0YXRlIHx8IG51bGwsCiAgICAgICAgICAgIGhhc0JhbGw6ICEhcC5oYXNCYWxsLAogICAgICAgICAgICBpc1Rocm93aW5nOiAhIXAuaXNUaHJvd2luZywKICAgICAgICAgICAgaXNDaGFyZ2luZzogISFwLmlzQ2hhcmdpbmcsCiAgICAgICAgICAgIGlzRGFzaGluZzogISFwLmlzRGFzaGluZywKICAgICAgICAgICAgZGFzaENvb2xkb3duOiBfcm91bmQocC5kYXNoQ29vbGRvd24sIDQpLAogICAgICAgICAgICBwb3M6IF92MyhwLm1lc2ggJiYgcC5tZXNoLnBvc2l0aW9uKSwKICAgICAgICAgICAgdmVsOiBfdjMocC52ZWxvY2l0eSksCiAgICAgICAgICAgIGlucHV0OiBfdjMocC5pbnB1dFZlY3RvciksCiAgICAgICAgICAgIHN0YXRzOiBwLnN0YXRzID8gX2Nsb25lSnNvbihwLnN0YXRzKSA6IG51bGwsCiAgICAgICAgICAgIGFuaW0KICAgICAgICB9OwogICAgfTsKCiAgICBjb25zdCBfdGVhbVNuYXAgPSAodCkgPT4gewogICAgICAgIGlmICghdCkgcmV0dXJuIG51bGw7CiAgICAgICAgY29uc3QgYWN0aXZlID0gdC5hY3RpdmVQbGF5ZXIgPyBfcGxheWVyU25hcCh0LmFjdGl2ZVBsYXllcikgOiBudWxsOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGlkOiB0LmlkIHx8IG51bGwsCiAgICAgICAgICAgIHNpZGU6IHQuc2lkZSwKICAgICAgICAgICAgaXNIdW1hbjogISF0LmlzSHVtYW4sCiAgICAgICAgICAgIGFpRW5hYmxlZDogISF0LmFpRW5hYmxlZCwKICAgICAgICAgICAgY3VycmVudEZvcm1hdGlvbjogdC5jdXJyZW50Rm9ybWF0aW9uIHx8IG51bGwsCiAgICAgICAgICAgIGFjdGl2ZVBsYXllcjogYWN0aXZlLAogICAgICAgICAgICBwbGF5ZXJzOiBBcnJheS5pc0FycmF5KHQucGxheWVycykgPyB0LnBsYXllcnMubWFwKF9wbGF5ZXJTbmFwKSA6IFtdCiAgICAgICAgfTsKICAgIH07CgogICAgY29uc3QgYnVpbGRTbmFwc2hvdCA9ICgpID0+IHsKICAgICAgICBjb25zdCBnYW1lID0gdGhpcy5nYW1lIHx8IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSB8fCBudWxsOwogICAgICAgIGNvbnN0IGJhbGwgPSBnYW1lICYmIGdhbWUuZW50aXRpZXMgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgIGNvbnN0IGNhbU1nciA9IGdhbWUgPyBnYW1lLmNhbWVyYU1hbmFnZXIgOiBudWxsOwogICAgICAgIGNvbnN0IGNhbSA9IChjYW1NZ3IgJiYgY2FtTWdyLmNhbWVyYSkgPyBjYW1NZ3IuY2FtZXJhIDogKGdhbWUgPyBnYW1lLmNhbWVyYSA6IG51bGwpOwoKICAgICAgICBjb25zdCBiYWxsU25hcCA9IGJhbGwgPyB7CiAgICAgICAgICAgIHN0YXRlOiBiYWxsLnN0YXRlIHx8IG51bGwsCiAgICAgICAgICAgIGlzSW52aXNpYmxlOiAhIWJhbGwuaXNJbnZpc2libGUsCiAgICAgICAgICAgIGhvbGRlcjogYmFsbC5ob2xkZXIgPyAoYmFsbC5ob2xkZXIuY2hhcmFjdGVyTmFtZSB8fCBiYWxsLmhvbGRlci5uYW1lIHx8IG51bGwpIDogbnVsbCwKICAgICAgICAgICAgbGFzdEhvbGRlcjogYmFsbC5sYXN0SG9sZGVyID8gKGJhbGwubGFzdEhvbGRlci5jaGFyYWN0ZXJOYW1lIHx8IGJhbGwubGFzdEhvbGRlci5uYW1lIHx8IG51bGwpIDogbnVsbCwKICAgICAgICAgICAgcG9zOiBfdjMoYmFsbC5tZXNoICYmIGJhbGwubWVzaC5wb3NpdGlvbiksCiAgICAgICAgICAgIHZlbDogX3YzKGJhbGwudmVsb2NpdHkpLAogICAgICAgICAgICBhbmdWZWw6IF92MyhiYWxsLmFuZ3VsYXJWZWxvY2l0eSksCiAgICAgICAgICAgIHBvd2VyOiBfcm91bmQoYmFsbC5wb3dlciwgNCksCiAgICAgICAgICAgIHNob3RUeXBlOiBiYWxsLnNob3RUeXBlIHx8IG51bGwKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgY29uc3QgY2FtZXJhU25hcCA9IGNhbSA/IHsKICAgICAgICAgICAgcG9zOiBfdjMoY2FtLnBvc2l0aW9uKSwKICAgICAgICAgICAgcm90OiBjYW0ucm90YXRpb24gPyBbX3JvdW5kKGNhbS5yb3RhdGlvbi54LCA0KSwgX3JvdW5kKGNhbS5yb3RhdGlvbi55LCA0KSwgX3JvdW5kKGNhbS5yb3RhdGlvbi56LCA0KV0gOiBudWxsLAogICAgICAgICAgICBmb3Y6IF9yb3VuZChjYW0uZm92LCA0KSwKICAgICAgICAgICAgbmVhcjogX3JvdW5kKGNhbS5uZWFyLCA2KSwKICAgICAgICAgICAgZmFyOiBfcm91bmQoY2FtLmZhciwgNCkKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgY29uc3QgY2FtTWdyU25hcCA9IGNhbU1nciA/IHsKICAgICAgICAgICAgbW9kZTogY2FtTWdyLm1vZGUgfHwgbnVsbCwKICAgICAgICAgICAgdGFyZ2V0TmFtZTogKGNhbU1nci50YXJnZXQgJiYgKGNhbU1nci50YXJnZXQuY2hhcmFjdGVyTmFtZSB8fCBjYW1NZ3IudGFyZ2V0Lm5hbWUpKSB8fCBudWxsLAogICAgICAgICAgICBzZXR0aW5nczogY2FtTWdyLnNldHRpbmdzID8gX2Nsb25lSnNvbihjYW1NZ3Iuc2V0dGluZ3MpIDogbnVsbAogICAgICAgIH0gOiBudWxsOwoKICAgICAgICBjb25zdCBkZWJ1Z0lPID0gd2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX2RlYnVnSU8gPyB3aW5kb3cuZmx1eC5fZGVidWdJTyA6IG51bGw7CiAgICAgICAgY29uc3QgaW5wdXRTbmFwID0gZGVidWdJTyA/IHsKICAgICAgICAgICAgc2V0dGluZ3M6IGRlYnVnSU8uc2V0dGluZ3MgPyBfY2xvbmVKc29uKGRlYnVnSU8uc2V0dGluZ3MpIDogbnVsbCwKICAgICAgICAgICAgcGVyZjogZGVidWdJTy5wZXJmID8gX2Nsb25lSnNvbihkZWJ1Z0lPLnBlcmYpIDogbnVsbCwKICAgICAgICAgICAgbW92ZTogKGRlYnVnSU8uaW5wdXQgJiYgZGVidWdJTy5pbnB1dC5tb3ZlKSA/IHsKICAgICAgICAgICAgICAgIHRvdWNoSWQ6IGRlYnVnSU8uaW5wdXQubW92ZS50b3VjaElkID8/IG51bGwsCiAgICAgICAgICAgICAgICBkcmFnZ2luZzogISFkZWJ1Z0lPLmlucHV0Lm1vdmUuZHJhZ2dpbmcsCiAgICAgICAgICAgICAgICB2ZWN0b3I6IGRlYnVnSU8uaW5wdXQubW92ZS52ZWN0b3IgPyBfY2xvbmVKc29uKGRlYnVnSU8uaW5wdXQubW92ZS52ZWN0b3IpIDogbnVsbAogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgYWltOiAoZGVidWdJTy5pbnB1dCAmJiBkZWJ1Z0lPLmlucHV0LmFpbSkgPyB7CiAgICAgICAgICAgICAgICB0b3VjaElkOiBkZWJ1Z0lPLmlucHV0LmFpbS50b3VjaElkID8/IG51bGwsCiAgICAgICAgICAgICAgICBkcmFnZ2luZzogISFkZWJ1Z0lPLmlucHV0LmFpbS5kcmFnZ2luZywKICAgICAgICAgICAgICAgIHZlY3RvcjogZGVidWdJTy5pbnB1dC5haW0udmVjdG9yID8gX2Nsb25lSnNvbihkZWJ1Z0lPLmlucHV0LmFpbS52ZWN0b3IpIDogbnVsbAogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgc3dpcGU6IChkZWJ1Z0lPLmlucHV0ICYmIGRlYnVnSU8uaW5wdXQuc3dpcGUpID8gewogICAgICAgICAgICAgICAgdG91Y2hJZDogZGVidWdJTy5pbnB1dC5zd2lwZS50b3VjaElkID8/IG51bGwsCiAgICAgICAgICAgICAgICBzdGFydDogZGVidWdJTy5pbnB1dC5zd2lwZS5zdGFydCA/IF9jbG9uZUpzb24oZGVidWdJTy5pbnB1dC5zd2lwZS5zdGFydCkgOiBudWxsLAogICAgICAgICAgICAgICAgcG9pbnRzOiBBcnJheS5pc0FycmF5KGRlYnVnSU8uaW5wdXQuc3dpcGUucG9pbnRzKSA/IGRlYnVnSU8uaW5wdXQuc3dpcGUucG9pbnRzLnNsaWNlKC0zMikubWFwKF9jbG9uZUpzb24pIDogW10KICAgICAgICAgICAgfSA6IG51bGwKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbWV0YTogewogICAgICAgICAgICAgICAgdGltZXN0YW1wSVNPOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksCiAgICAgICAgICAgICAgICBocmVmOiAodHlwZW9mIGxvY2F0aW9uICE9PSAndW5kZWZpbmVkJyAmJiBsb2NhdGlvbi5ocmVmKSA/IGxvY2F0aW9uLmhyZWYgOiBudWxsLAogICAgICAgICAgICAgICAgdXNlckFnZW50OiAodHlwZW9mIG5hdmlnYXRvciAhPT0gJ3VuZGVmaW5lZCcgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudCkgPyBuYXZpZ2F0b3IudXNlckFnZW50IDogbnVsbAogICAgICAgICAgICB9LAogICAgICAgICAgICBnYW1lOiBnYW1lID8gewogICAgICAgICAgICAgICAgc2NvcmU6IGdhbWUuc2NvcmUgPyBfY2xvbmVKc29uKGdhbWUuc2NvcmUpIDogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWU6IF9yb3VuZChnYW1lLnRpbWUsIDQpLAogICAgICAgICAgICAgICAgaGFsZjogZ2FtZS5oYWxmID8/IG51bGwsCiAgICAgICAgICAgICAgICBoYWxmRHVyYXRpb246IF9yb3VuZChnYW1lLmhhbGZEdXJhdGlvbiwgNCksCiAgICAgICAgICAgICAgICBpc092ZXJ0aW1lOiAhIWdhbWUuaXNPdmVydGltZSwKICAgICAgICAgICAgICAgIGlzRGVtb01vZGU6ICEhZ2FtZS5pc0RlbW9Nb2RlCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBjb25maWc6IHsKICAgICAgICAgICAgICAgIEJhbGxDb25maWc6ICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnKSA/IF9jbG9uZUpzb24od2luZG93LmZsdXguQmFsbENvbmZpZykgOiBudWxsLAogICAgICAgICAgICAgICAgVGhyb3dDb25maWc6ICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZykgPyBfY2xvbmVKc29uKHdpbmRvdy5mbHV4LlRocm93Q29uZmlnKSA6IG51bGwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2FtZXJhOiBjYW1lcmFTbmFwLAogICAgICAgICAgICBjYW1lcmFNYW5hZ2VyOiBjYW1NZ3JTbmFwLAogICAgICAgICAgICBiYWxsOiBiYWxsU25hcCwKICAgICAgICAgICAgdGVhbXM6IGdhbWUgPyB7CiAgICAgICAgICAgICAgICBob21lOiBfdGVhbVNuYXAoZ2FtZS50ZWFtcyAmJiBnYW1lLnRlYW1zLmhvbWUpLAogICAgICAgICAgICAgICAgYXdheTogX3RlYW1TbmFwKGdhbWUudGVhbXMgJiYgZ2FtZS50ZWFtcy5hd2F5KQogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgaW5wdXQ6IGlucHV0U25hcAogICAgICAgIH07CiAgICB9OwoKICAgIGNvbnN0IF9jb3B5VGV4dCA9IGFzeW5jICh0ZXh0KSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKG5hdmlnYXRvci5jbGlwYm9hcmQgJiYgbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQpIHsKICAgICAgICAgICAgICAgIGF3YWl0IG5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KHRleHQpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIC8vIEZhbGxiYWNrCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgdGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZXh0YXJlYScpOwogICAgICAgICAgICB0YS52YWx1ZSA9IHRleHQ7CiAgICAgICAgICAgIHRhLnN0eWxlLnBvc2l0aW9uID0gJ2ZpeGVkJzsKICAgICAgICAgICAgdGEuc3R5bGUubGVmdCA9ICctOTk5OXB4JzsKICAgICAgICAgICAgdGEuc3R5bGUudG9wID0gJy05OTk5cHgnOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRhKTsKICAgICAgICAgICAgdGEuZm9jdXMoKTsKICAgICAgICAgICAgdGEuc2VsZWN0KCk7CiAgICAgICAgICAgIGNvbnN0IG9rID0gZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0YSk7CiAgICAgICAgICAgIHJldHVybiBvazsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CgogICAgY29uc3QgX2Rvd25sb2FkVGV4dCA9IChmaWxlbmFtZSwgdGV4dCkgPT4gewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbdGV4dF0sIHsgdHlwZTogJ2FwcGxpY2F0aW9uL2pzb24nIH0pOwogICAgICAgICAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOwogICAgICAgICAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgICAgICBhLmhyZWYgPSB1cmw7CiAgICAgICAgICAgIGEuZG93bmxvYWQgPSBmaWxlbmFtZTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhKTsKICAgICAgICAgICAgYS5jbGljaygpOwogICAgICAgICAgICBhLnJlbW92ZSgpOwogICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKHVybCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1NuYXBzaG90IGRvd25sb2FkIGZhaWxlZDonLCBlKTsKICAgICAgICB9CiAgICB9OwoKICAgIGNvbnN0IHNuYXBzaG90QWN0aW9ucyA9IHsKICAgICAgICBDb3B5U25hcHNob3Q6IGFzeW5jICgpID0+IHsKICAgICAgICAgICAgY29uc3Qgc25hcCA9IGJ1aWxkU25hcHNob3QoKTsKICAgICAgICAgICAgY29uc3QgdGV4dCA9IEpTT04uc3RyaW5naWZ5KHNuYXAsIG51bGwsIDIpOwogICAgICAgICAgICBjb25zdCBvayA9IGF3YWl0IF9jb3B5VGV4dCh0ZXh0KTsKICAgICAgICAgICAgY29uc29sZS5sb2coJ1tTbmFwc2hvdF0nLCBzbmFwKTsKICAgICAgICAgICAgaWYgKCFvaykgY29uc29sZS53YXJuKCdTbmFwc2hvdDogY29weSBmYWlsZWQgKHNlZSBjb25zb2xlKS4nKTsKICAgICAgICB9LAogICAgICAgIERvd25sb2FkU25hcHNob3Q6ICgpID0+IHsKICAgICAgICAgICAgY29uc3Qgc25hcCA9IGJ1aWxkU25hcHNob3QoKTsKICAgICAgICAgICAgY29uc3QgdGV4dCA9IEpTT04uc3RyaW5naWZ5KHNuYXAsIG51bGwsIDIpOwogICAgICAgICAgICBfZG93bmxvYWRUZXh0KCdzbmFwc2hvdC5qc29uJywgdGV4dCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbU25hcHNob3RdJywgc25hcCk7CiAgICAgICAgfQogICAgfTsKCiAgICBzbmFwc2hvdC5hZGQoc25hcHNob3RBY3Rpb25zLCAnQ29weVNuYXBzaG90JykubmFtZSgnQ29weSBKU09OIFNuYXBzaG90Jyk7CiAgICBzbmFwc2hvdC5hZGQoc25hcHNob3RBY3Rpb25zLCAnRG93bmxvYWRTbmFwc2hvdCcpLm5hbWUoJ0Rvd25sb2FkIHNuYXBzaG90Lmpzb24nKTsKCn0KICAgIH0KCndpbmRvdy5mbHV4LkRldlRvb2xzID0gRGV2VG9vbHM7CgpEZXZUb29scy5wcm90b3R5cGUuX3NldHVwVmlzdWFsRGVidWcgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1Zpc3VhbCBEZWJ1Z2dpbmcnKTsKICAgICAgICBjb25zdCBkdiA9IHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXI7CiAgICAgICAgaWYgKCFkdikgcmV0dXJuOwoKICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIGVuYWJsZWQ6IGR2LmVuYWJsZWQsCiAgICAgICAgICAgIGhpdGJveGVzOiBkdi5zaG93SGl0Ym94ZXMsCiAgICAgICAgICAgIHZlY3RvcnM6IGR2LnNob3dWZWN0b3JzLAogICAgICAgICAgICBhaTogZHYuc2hvd0FJLAogICAgICAgICAgICBnb2FsVm9sdW1lOiBkdi5zaG93R29hbFZvbHVtZQogICAgICAgIH07CgogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZW5hYmxlZCcpLm5hbWUoJ0VuYWJsZSBWaXN1YWxpemVyJykub25DaGFuZ2UodiA9PiBkdi5lbmFibGVkID0gdik7CiAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdoaXRib3hlcycpLm5hbWUoJ1Nob3cgSGl0Ym94ZXMnKS5vbkNoYW5nZSh2ID0+IGR2LnNob3dIaXRib3hlcyA9IHYpOwogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndmVjdG9ycycpLm5hbWUoJ1Nob3cgVmVjdG9ycycpLm9uQ2hhbmdlKHYgPT4gZHYuc2hvd1ZlY3RvcnMgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2FpJykubmFtZSgnU2hvdyBBSSBQZXJjZXB0aW9uJykub25DaGFuZ2UodiA9PiBkdi5zaG93QUkgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2dvYWxWb2x1bWUnKS5uYW1lKCdTaG93IEdvYWwgVm9sdW1lJykub25DaGFuZ2UodiA9PiBkdi5zaG93R29hbFZvbHVtZSA9IHYpOwogICAgfTsKCiAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwRlhMYWIgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0ZYIExhYiAmIFVJIFRlc3QnKTsKICAgICAgICAKICAgICAgICBjb25zdCBnZXRUYXJnZXRQb3MgPSAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIHJldHVybiBwICYmIHAubWVzaCA/IHAubWVzaC5wb3NpdGlvbiA6IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDIsIDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGZ4UGFyYW1zID0gewogICAgICAgICAgICBTcGF3blZlbm9tOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCd2ZW5vbScsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25OYXA6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ25hcCcsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25XaXRoZXI6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3dpdGhlcicsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25MZWFybmVkOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bkNsYXNoOiAoKSA9PiB0aGlzLmdhbWUuc3Bhd25DbGFzaChnZXRUYXJnZXRQb3MoKSksCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgZnhTdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdQYXJ0aWNsZXMnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3blZlbm9tJyk7CiAgICAgICAgZnhTdWIuYWRkKGZ4UGFyYW1zLCAnU3Bhd25OYXAnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3bldpdGhlcicpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduTGVhcm5lZCcpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduQ2xhc2gnKTsKCiAgICAgICAgY29uc3QgdHh0UGFyYW1zID0gewogICAgICAgICAgICBUZXh0OiAiVEVTVCIsCiAgICAgICAgICAgIFR5cGU6ICJkYW1hZ2UiLAogICAgICAgICAgICBTcGF3bjogKCkgPT4gewogICAgICAgICAgICAgICAgaWYodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bih0eHRQYXJhbXMuVGV4dCwgZ2V0VGFyZ2V0UG9zKCksIHR4dFBhcmFtcy5UeXBlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgY29uc3QgdHh0U3ViID0gZm9sZGVyLmFkZEZvbGRlcignRmxvYXRpbmcgVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVHlwZScsIFsnZGFtYWdlJywgJ2hlYWwnLCAnc3RhdHVzJywgJ3RlY2gnLCAnY29taWMtaW1wYWN0JywgJ2NvbWljLWFjdGlvbicsICdzYXZlJywgJ2Jsb2NrJywgJ2RlZmF1bHQnXSk7CiAgICAgICAgdHh0U3ViLmFkZCh0eHRQYXJhbXMsICdTcGF3bicpLm5hbWUoJ1NwYXduIFRleHQnKTsKCiAgICAgICAgY29uc3QgY2FtUGFyYW1zID0gewogICAgICAgICAgICBTaGFrZVNtYWxsOiAoKSA9PiB0aGlzLmdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpLAogICAgICAgICAgICBTaGFrZUJpZzogKCkgPT4gdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMi4wKSwKICAgICAgICAgICAgSW1wYWN0TGlnaHQ6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMSwgJ2RlZmF1bHQnKSwKICAgICAgICAgICAgSW1wYWN0SGVhdnk6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMiwgJ2hlYXZ5JyksCiAgICAgICAgICAgIEltcGFjdFNoYXR0ZXI6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuNCwgJ3NoYXR0ZXInKSwKICAgICAgICB9OwoKICAgICAgICBjb25zdCBjYW1TdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdDYW1lcmEgJiBJbXBhY3QnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlU21hbGwnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlQmlnJyk7CiAgICAgICAgY2FtU3ViLmFkZChjYW1QYXJhbXMsICdJbXBhY3RMaWdodCcpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnSW1wYWN0SGVhdnknKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ0ltcGFjdFNoYXR0ZXInKTsKICAgIH07CgoKRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFZpc3VhbHMgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0Fzc2V0IEZvcmdlJyk7CiAgICAgICAgCiAgICAgICAgY29uc3QgZm9yZ2VTdGF0ZSA9IHsKICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgYXNzZXROYW1lOiAnVGlkdXMnLAogICAgICAgICAgICBhbmltTmFtZTogJ2lkbGUnLAogICAgICAgICAgICBwb3NYOiAwLCBwb3NZOiAwLCBwb3NaOiAwLAogICAgICAgICAgICByb3RYOiAwLCByb3RZOiAwLCByb3RaOiAwLAogICAgICAgICAgICBzY2FsZTogMS4wLAogICAgICAgICAgICBjYW1EaXN0OiA1LCBjYW1IZWlnaHQ6IDEuNSwgY2FtUm90OiAwCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgYXNzZXRzID0gewogICAgICAgICAgICAnVGlkdXMnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2RhNzg4YmVmMjU4YzRmMGI4ZDllZjFhY2MxOWM1NTY3LmdsYicsCiAgICAgICAgICAgICdXYWtrYSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJywKICAgICAgICAgICAgJ0xldHR5JzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy80M2FjZTM0YzZmZDk0MjE1OTY3ZTg0MmJmOTA5ZGE1ZS5nbGInLAogICAgICAgICAgICAnRGF0dG8nOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2U2ZDY3ZWNiMmU0YzQ3MTViZDczYTQwNzk1ZTFkM2Q1LmdsYicsCiAgICAgICAgICAgICdKYXNzdSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJywKICAgICAgICAgICAgJ0JvdHRhJzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hZDE1NWVmZWRjMGQ0OGZkYWQwOWRhM2UxY2FlOWM5Ny5nbGInLAogICAgICAgICAgICAnQmFsbCc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTIxYWU4Nzg4ZTU4NGUzNzhhNzlkOTczMmEwNzUzNTYuZ2xiJywKICAgICAgICAgICAgJ0dvYWwnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2E1MTZiZDkwZmE3YzRkZWRiNWRjYmZkZjgwM2YxM2Q1LmdsYicKICAgICAgICB9OwoKICAgICAgICBsZXQgY3VycmVudEFzc2V0ID0gbnVsbDsKCiAgICAgICAgY29uc3QgdXBkYXRlVHJhbnNmb3JtID0gKCkgPT4gewogICAgICAgICAgICBpZiAoY3VycmVudEFzc2V0KSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQucG9zaXRpb24uc2V0KGZvcmdlU3RhdGUucG9zWCwgZm9yZ2VTdGF0ZS5wb3NZLCBmb3JnZVN0YXRlLnBvc1opOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0LnJvdGF0aW9uLnNldChmb3JnZVN0YXRlLnJvdFgsIGZvcmdlU3RhdGUucm90WSwgZm9yZ2VTdGF0ZS5yb3RaKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRBc3NldC5zY2FsZS5zZXRTY2FsYXIoZm9yZ2VTdGF0ZS5zY2FsZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjb25zdCB1cGRhdGVDYW1lcmEgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghZm9yZ2VTdGF0ZS5hY3RpdmUpIHJldHVybjsKICAgICAgICAgICAgLy8gT3JiaXQgYXJvdW5kICgxMDAwLCBZLCAxMDAwKQogICAgICAgICAgICBjb25zdCBjeCA9IDEwMDAgKyBNYXRoLnNpbihmb3JnZVN0YXRlLmNhbVJvdCkgKiBmb3JnZVN0YXRlLmNhbURpc3Q7CiAgICAgICAgICAgIGNvbnN0IGN6ID0gMTAwMCArIE1hdGguY29zKGZvcmdlU3RhdGUuY2FtUm90KSAqIGZvcmdlU3RhdGUuY2FtRGlzdDsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhbWVyYS5wb3NpdGlvbi5zZXQoY3gsIGZvcmdlU3RhdGUuY2FtSGVpZ2h0LCBjeik7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW1lcmEubG9va0F0KDEwMDAsIGZvcmdlU3RhdGUucG9zWSArIDEsIDEwMDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IHBsYXlBbmltYXRpb24gPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghdGhpcy52aXpNaXhlciB8fCAhdGhpcy52aXpDbGlwcykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnZpek1peGVyLnN0b3BBbGxBY3Rpb24oKTsKICAgICAgICAgICAgaWYgKGZvcmdlU3RhdGUuYW5pbU5hbWUgPT09ICdub25lJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUgPT09IGZvcmdlU3RhdGUuYW5pbU5hbWUpOwogICAgICAgICAgICBpZiAoIWNsaXApIGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhmb3JnZVN0YXRlLmFuaW1OYW1lLnRvTG93ZXJDYXNlKCkpKTsKICAgICAgICAgICAgaWYgKGNsaXApIHRoaXMudml6TWl4ZXIuY2xpcEFjdGlvbihjbGlwKS5wbGF5KCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3Qgc3Bhd25Bc3NldCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBwcmV2aW91cwogICAgICAgICAgICB3aGlsZSh0aGlzLnZpekdyb3VwLmNoaWxkcmVuLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy52aXpHcm91cC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucmVtb3ZlKGNoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52aXpNaXhlciA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnRBc3NldCA9IG51bGw7CgogICAgICAgICAgICBjb25zdCB1cmwgPSBhc3NldHNbZm9yZ2VTdGF0ZS5hc3NldE5hbWVdOwogICAgICAgICAgICBpZiAoIXVybCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc29sZS5sb2coIkZvcmdlOiBTcGF3bmluZyIsIGZvcmdlU3RhdGUuYXNzZXROYW1lKTsKCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbCh1cmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSBhcmUgc3RpbGwgaW4gZm9yZ2UgbW9kZSBiZWZvcmUgYWRkaW5nCiAgICAgICAgICAgICAgICBpZiAoIWZvcmdlU3RhdGUuYWN0aXZlKSByZXR1cm47CgogICAgICAgICAgICAgICAgY29uc3QgbW9kZWwgPSBnbHRmLnNjZW5lOwogICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cC5hZGQobW9kZWwpOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0ID0gbW9kZWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IG1vZGVsIHRyYW5zZm9ybSByZWxhdGl2ZSB0byBncm91cAogICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIG1vZGVsLnJvdGF0aW9uLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZVRyYW5zZm9ybSgpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmLmFuaW1hdGlvbnMgJiYgZ2x0Zi5hbmltYXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpek1peGVyID0gbmV3IFRIUkVFLkFuaW1hdGlvbk1peGVyKG1vZGVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekNsaXBzID0gZ2x0Zi5hbmltYXRpb25zOwogICAgICAgICAgICAgICAgICAgIHBsYXlBbmltYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgdG9nZ2xlRm9yZ2UgPSAoaXNBY3RpdmUpID0+IHsKICAgICAgICAgICAgZm9yZ2VTdGF0ZS5hY3RpdmUgPSBpc0FjdGl2ZTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlzRm9yZ2VNb2RlID0gaXNBY3RpdmU7IC8vIENyaXRpY2FsOiBUZWxsIG1haW4uanMgdG8gc3RvcCBnYW1lIGxvb3AKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBHYW1lIFZpc2liaWxpdHkgKEhpZGUgZXZlcnl0aGluZyBpbiB0aGUgbWFpbiBhcmVuYSkKICAgICAgICAgICAgY29uc3QgZ2FtZUxheWVyID0gW3RoaXMuZ2FtZS50ZWFtcy5ob21lLCB0aGlzLmdhbWUudGVhbXMuYXdheSwgdGhpcy5nYW1lLmVudGl0aWVzLmJhbGxdOwogICAgICAgICAgICBnYW1lTGF5ZXIuZm9yRWFjaCh0ID0+IHsKICAgICAgICAgICAgICAgIGlmKHQgJiYgdC5wbGF5ZXJzKSB0LnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsgfSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmKHQgJiYgdC5tZXNoKSB0Lm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCkgd2luZG93LmZsdXguYXJlbmFNZXNoLnZpc2libGUgPSAhaXNBY3RpdmU7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIpIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLnN0YWRpdW0gJiYgdGhpcy5nYW1lLnN0YWRpdW0uY29udGFpbmVyKSB0aGlzLmdhbWUuc3RhZGl1bS5jb250YWluZXIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLndhdGVyT3ZlcmxheSAmJiB0aGlzLmdhbWUud2F0ZXJPdmVybGF5Lm1lc2gpIHRoaXMuZ2FtZS53YXRlck92ZXJsYXkubWVzaC52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBVSQogICAgICAgICAgICBjb25zdCB1aSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpOwogICAgICAgICAgICBpZih1aSkgdWkuc3R5bGUuZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2ZsZXgnOwoKICAgICAgICAgICAgaWYgKGlzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIEZvcmdlIFNjZW5lIGlmIG5lZWRlZAogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwUGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy52aXpHcm91cFBhcmVudCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucG9zaXRpb24uc2V0KDEwMDAsIDAsIDEwMDApOyAvLyBGYXIgYXdheSBmcm9tIGFyZW5hCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQodGhpcy52aXpHcm91cCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdyaWQgPSBuZXcgVEhSRUUuR3JpZEhlbHBlcigyMCwgMjAsIDB4MDBmZmZmLCAweDQ0NDQ0NCk7CiAgICAgICAgICAgICAgICAgICAgZ3JpZC5wb3NpdGlvbi5zZXQoMTAwMCwgMCwgMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQoZ3JpZCk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMudml6TGlnaHQgPSBuZXcgVEhSRUUuRGlyZWN0aW9uYWxMaWdodCgweGZmZmZmZiwgMS4wKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnBvc2l0aW9uLnNldCgxMDA1LCAxMCwgMTAwNSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZCh0aGlzLnZpekxpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekFtYmllbnQgPSBuZXcgVEhSRUUuQW1iaWVudExpZ2h0KDB4NDA0MDQwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKHRoaXMudml6QW1iaWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXBQYXJlbnQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy52aXpBbWJpZW50LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzcGF3bkFzc2V0KCk7CiAgICAgICAgICAgICAgICB1cGRhdGVDYW1lcmEoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBHYW1lCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpHcm91cFBhcmVudCkgdGhpcy52aXpHcm91cFBhcmVudC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpMaWdodCkgdGhpcy52aXpMaWdodC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpBbWJpZW50KSB0aGlzLnZpekFtYmllbnQudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYSBiYWNrIHRvIGdhbWUgdGFyZ2V0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIpIHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZm9sZGVyLmFkZChmb3JnZVN0YXRlLCAnYWN0aXZlJykubmFtZSgnRW5hYmxlIEZvcmdlJykub25DaGFuZ2UodG9nZ2xlRm9yZ2UpOwogICAgICAgIGZvbGRlci5hZGQoZm9yZ2VTdGF0ZSwgJ2Fzc2V0TmFtZScsIE9iamVjdC5rZXlzKGFzc2V0cykpLm5hbWUoJ1NlbGVjdCBBc3NldCcpLm9uQ2hhbmdlKHNwYXduQXNzZXQpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRmID0gZm9sZGVyLmFkZEZvbGRlcignVHJhbnNmb3JtJyk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NYJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NZJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NaJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdyb3RYJywgMCwgNi4yOCkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3JvdFknLCAwLCA2LjI4KS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwogICAgICAgIHRmLmFkZChmb3JnZVN0YXRlLCAncm90WicsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdzY2FsZScsIDAuMSwgMy4wKS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwoKICAgICAgICBmb2xkZXIuYWRkKGZvcmdlU3RhdGUsICdhbmltTmFtZScsIFsnbm9uZScsICdpZGxlJywgJ3N3aW0nLCAndGhyb3cnLCAnY2F0Y2gnLCAncmVhY3QnXSkubmFtZSgnQW5pbWF0aW9uJykub25DaGFuZ2UocGxheUFuaW1hdGlvbik7CgogICAgICAgIGNvbnN0IGNmID0gZm9sZGVyLmFkZEZvbGRlcignQ2FtZXJhJyk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1EaXN0JywgMiwgMTUpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1IZWlnaHQnLCAwLCAxMCkub25DaGFuZ2UodXBkYXRlQ2FtZXJhKTsKICAgICAgICBjZi5hZGQoZm9yZ2VTdGF0ZSwgJ2NhbVJvdCcsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CgogICAgICAgIC8vIEhvb2sgR2FtZSBMb29wCiAgICAgICAgY29uc3Qgb3JpZ2luYWxVcGRhdGUgPSB0aGlzLmdhbWUudXBkYXRlLmJpbmQodGhpcy5nYW1lKTsKICAgICAgICB0aGlzLmdhbWUudXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIGlmIChmb3JnZVN0YXRlLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgLy8gRm9yZ2UgTW9kZTogT25seSB1cGRhdGUgZm9yZ2UgY29tcG9uZW50cyBhbmQgcmVuZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpNaXhlcikgdGhpcy52aXpNaXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGb3JjZSBDYW1lcmEgVXBkYXRlIGhlcmUgc2luY2UgbWFpbi5qcyBsb29wIGlzIHNraXBwZWQKICAgICAgICAgICAgICAgIHVwZGF0ZUNhbWVyYSgpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucmVuZGVyZXIgJiYgdGhpcy5nYW1lLnNjZW5lICYmIHRoaXMuZ2FtZS5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIucmVuZGVyKHRoaXMuZ2FtZS5zY2VuZSwgdGhpcy5nYW1lLmNhbWVyYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOb3JtYWwgTW9kZTogUnVuIHN0YW5kYXJkIGdhbWUgdXBkYXRlCiAgICAgICAgICAgICAgICBvcmlnaW5hbFVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKfSkoKTs=","./DevTools.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFRvb2x0aXAgRGVzY3JpcHRpb25zIGZvciBMb25nLVByZXNzCiAgICBjb25zdCBUT09MVElQX0RFU0NSSVBUSU9OUyA9IHsKICAgICAgICAnU1VCU1RFUFMnOiAiUGh5c2ljcyBpdGVyYXRpb25zIHBlciBmcmFtZS4gSGlnaGVyID0gbW9yZSBzdGFibGUsIG1vcmUgQ1BVLiIsCiAgICAgICAgJ1NUT1BfU1BFRUQnOiAiVmVsb2NpdHkgdGhyZXNob2xkIGJlbG93IHdoaWNoIHRoZSBiYWxsIHNuYXBzIHRvIGEgaGFsdC4iLAogICAgICAgICdXQVRFUl9EUkFHX0xJTkVBUic6ICJCYXNlIHdhdGVyIHJlc2lzdGFuY2UuIFNsb3dzIGJhbGwgbGluZWFybHkuIiwKICAgICAgICAnV0FURVJfRFJBR19RVUFEJzogIlF1YWRyYXRpYyBkcmFnLiBTbG93cyBoaWdoLXNwZWVkIGJhbGxzIHNpZ25pZmljYW50bHkuIiwKICAgICAgICAnU1BJTl9EUkFHJzogIkhvdyBmYXN0IHRoZSBiYWxsJ3Mgc3BpbiBkZWNheXMgb3ZlciB0aW1lLiIsCiAgICAgICAgJ01BR05VU19FTkFCTEVEJzogIkVuYWJsZXMgdGhlIE1hZ251cyBlZmZlY3QgKGN1cnZlIGZyb20gc3BpbikuIiwKICAgICAgICAnTUFHTlVTX0NPRUZGJzogIlN0cmVuZ3RoIG9mIHRoZSBjdXJ2ZSBmb3JjZSByZWxhdGl2ZSB0byBzcGluL3NwZWVkLiIsCiAgICAgICAgJ01BR05VU19DQVAnOiAiTWF4aW11bSBjdXJ2ZSBmb3JjZSBhbGxvd2VkIChwcmV2ZW50cyBwaHlzaWNzIGV4cGxvc2lvbnMpLiIsCiAgICAgICAgJ0RFUFRIX1RBUkdFVF9ZJzogIklkZWFsIFkgaGVpZ2h0IHRoZSBiYWxsIHRyaWVzIHRvIGZsb2F0IGF0LiIsCiAgICAgICAgJ0RFUFRIX1NQUklORyc6ICJTdHJlbmd0aCBvZiB0aGUgZm9yY2UgcHVsbGluZyBiYWxsIHRvIFRhcmdldCBZLiIsCiAgICAgICAgJ0RFUFRIX0RBTVAnOiAiRGFtcGluZyBvbiB2ZXJ0aWNhbCBtb3ZlbWVudCB0byBwcmV2ZW50IG9zY2lsbGF0aW9uLiIsCiAgICAgICAgJ0JPVU5EQVJZX1JBRElVUyc6ICJSYWRpdXMgb2YgdGhlIGNpcmN1bGFyIGFyZW5hIHdhbGwuIiwKICAgICAgICAnQk9VTkRBUllfSEVJR0hUJzogIkhlaWdodCBvZiB0aGUgYXJlbmEgY2VpbGluZy9mbG9vci4iLAogICAgICAgICdXQUxMX1NPRlRfQlVGRkVSJzogIkRpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMuIiwKICAgICAgICAnV0FMTF9TT0ZUX0ZPUkNFJzogIkZvcmNlIHB1c2hpbmcgYmFsbCBhd2F5IGZyb20gd2FsbCBiZWZvcmUgaW1wYWN0LiIsCiAgICAgICAgJ1dBTExfRUxBU1RJQ0lUWSc6ICJCb3VuY2luZXNzIG9mIHRoZSB3YWxsICgwID0gZGVhZCB0aHVkLCAxID0gcGVyZmVjdCBib3VuY2UpLiIsCiAgICAgICAgJ1dBTExfRlJJQ1RJT04nOiAiRnJpY3Rpb24gd2hlbiBzbGlkaW5nIGFsb25nIHRoZSB3YWxsLiIsCiAgICAgICAgJ0ZMT09SX0VMQVNUSUNJVFknOiAiQm91bmNpbmVzcyBvZiB0aGUgZmxvb3IvY2VpbGluZy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9FTkFCTEVEJzogIkVuYWJsZXMgdGhlIGV4dGVuZGVkIGNvcnJpZG9yIGZvciB0aGUgZ29hbC4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9YJzogIkhhbGYtd2lkdGggb2YgdGhlIGdvYWwgcG9ja2V0IGNvcnJpZG9yLiIsCiAgICAgICAgJ0dPQUxfUE9DS0VUX1onOiAiWi1kZXB0aCB3aGVyZSB0aGUgcG9ja2V0IHN0YXJ0cy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9SQURJVVMnOiAiRWZmZWN0aXZlIHJhZGl1cyBpbnNpZGUgdGhlIHBvY2tldC4iLAogICAgICAgICdMQVVOQ0hfU1BFRURfU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBTdGF0IFBvd2VyIHRvIFBoeXNpY3MgVmVsb2NpdHkuIiwKICAgICAgICAnTEFVTkNIX1NQRUVEX0NBUCc6ICJNYXhpbXVtIHBoeXNpY2FsIHNwZWVkIHRoZSBiYWxsIGNhbiBiZSB0aHJvd24uIiwKICAgICAgICAnU1dJUEVfTUlOX1BYJzogIk1pbmltdW0gc3dpcGUgZGlzdGFuY2UgdG8gcmVnaXN0ZXIgYSB0aHJvdy4iLAogICAgICAgICdBSU1fRFhfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgaG9yaXpvbnRhbCBhaW0gZnJvbSBzd2lwZS4iLAogICAgICAgICdBSU1fRFlfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgdmVydGljYWwgYWltIGZyb20gc3dpcGUuIiwKICAgICAgICAnUE9XRVJfQkFTRSc6ICJCYXNlIHBvd2VyIG11bHRpcGxpZXIgZm9yIGEgcXVpY2sgdGFwLiIsCiAgICAgICAgJ1BPV0VSX1JBTkdFJzogIkFkZGl0aW9uYWwgcG93ZXIgbXVsdGlwbGllciBhdCBmdWxsIGNoYXJnZS4iLAogICAgICAgICdQT1dFUl9NQVhfQk9OVVNfUkFUSU8nOiAiQ2hhcmdlIHRocmVzaG9sZCBmb3IgJ01heCBQb3dlcicgYm9udXMuIiwKICAgICAgICAnUE9XRVJfTUFYX01VTFRJUExJRVInOiAiTXVsdGlwbGllciBhcHBsaWVkIHdoZW4gaGl0dGluZyBNYXggUG93ZXIuIiwKICAgICAgICAnQ1VSVkVfRU5BQkxFRCc6ICJFbmFibGVzIGN1cnZlIHNob3RzIHZpYSBjdXJ2ZWQgc3dpcGVzLiIsCiAgICAgICAgJ0NVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQnOiAiSG93IGN1cnZlZCBhIHN3aXBlIG11c3QgYmUgdG8gdHJpZ2dlciBzcGluLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBzd2lwZSBjdXJ2ZSB0byBiYWxsIHNwaW4uIiwKICAgICAgICAnQ1VSVkVfU1BFRURfTVVMVCc6ICJNdWx0aXBsaWVyIGZvciBzcGluIGJhc2VkIG9uIHN3aXBlIHNwZWVkLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fQ0FQJzogIk1heGltdW0gc3BpbiBhbGxvd2VkIGZyb20gYSBjdXJ2ZSB0aHJvdy4iLAogICAgICAgICdDVVJWRV9QRVJGRUNUX1NQSU4nOiAiU3BpbiB0aHJlc2hvbGQgdG8gdHJpZ2dlciAnUGVyZmVjdCBDdXJ2ZScgRlguIiwKICAgICAgICAndGltZVNjYWxlJzogIkdsb2JhbCBnYW1lIHNwZWVkIG11bHRpcGxpZXIuIiwKICAgICAgICAnZGVtb01vZGUnOiAiVG9nZ2xlIEFJIHZzIEFJIGF1dG8tcGxheS4iLAogICAgICAgICdyZXNvbHV0aW9uJzogIkludGVybmFsIHJlbmRlciByZXNvbHV0aW9uIHNjYWxlICgwLjUgPSBoYWxmIHJlcykuIiwKICAgICAgICAnYXJlbmFPcGFjaXR5JzogIk9wYWNpdHkgb2YgdGhlIG91dGVyIGFyZW5hIGdyaWQuIiwKICAgICAgICAnYXJlbmEyT3BhY2l0eSc6ICJPcGFjaXR5IG9mIHRoZSBpbm5lciBoZXggZ3JpZC4iCiAgICB9OwoKICAgIGNsYXNzIERldlRvb2xzIHsKICAgICAgICBjb25zdHJ1Y3RvcihnYW1lTWFuYWdlcikgewogICAgICAgICAgICB0aGlzLmdhbWUgPSBnYW1lTWFuYWdlcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIGxpbC1ndWkgYXR0YWNoZXMgdG8gd2luZG93LmxpbCBieSBkZWZhdWx0IGluIFVNRCBidWlsZAogICAgICAgICAgICBpZiAoIXdpbmRvdy5saWwgfHwgIXdpbmRvdy5saWwuR1VJKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkRldlRvb2xzOiBsaWwtZ3VpIG5vdCBmb3VuZC4iKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dhbWUtY29udGFpbmVyJyk7CiAgICAgICAgICAgIHRoaXMuZ3VpID0gbmV3IHdpbmRvdy5saWwuR1VJKHsgdGl0bGU6ICdGbHV4IERldlRvb2xzJywgY29udGFpbmVyOiBjb250YWluZXIgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQb3NpdGlvbiBhcyBhIGNvbGxhcHNlZCB0YWIgb24gdGhlIHJpZ2h0IGZyYW1lCi8vIFBvc2l0aW9uIGFzIGEgc2xpZGluZyB0YWIgb24gdGhlIHJpZ2h0IGZyYW1lCi8vIFBvc2l0aW9uIGFzIGEgc2xpZGluZyB0YWIgb24gdGhlIHJpZ2h0IGZyYW1lCi8vIFdyYXBwZXIgZm9yIHNsaWRpbmcgYW5pbWF0aW9uCiAgICAgICAgICAgIGNvbnN0IHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUudG9wID0gJzEwMHB4JzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5yaWdodCA9ICctMjYwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLndpZHRoID0gJzI2MHB4JzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS50cmFuc2l0aW9uID0gJ3JpZ2h0IDAuM3MgY3ViaWMtYmV6aWVyKDAuMiwgMC44LCAwLjIsIDEuMCknOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnpJbmRleCA9ICc5OTk5JzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLmZsZXhEaXJlY3Rpb24gPSAnY29sdW1uJzsKICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHdyYXBwZXIpOwoKICAgICAgICAgICAgY29uc3QgZG9tID0gdGhpcy5ndWkuZG9tRWxlbWVudDsKICAgICAgICAgICAgZG9tLnN0eWxlLndpZHRoID0gJzEwMCUnOwogICAgICAgICAgICBkb20uc3R5bGUuc2V0UHJvcGVydHkoJy0td2lkdGgnLCAnMTAwJScpOwogICAgICAgICAgICBkb20uc3R5bGUubWF4SGVpZ2h0ID0gJzgwdmgnOwogICAgICAgICAgICBkb20uc3R5bGUub3ZlcmZsb3dZID0gJ2F1dG8nOwogICAgICAgICAgICBkb20uc3R5bGUub3ZlcmZsb3dYID0gJ2hpZGRlbic7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNb3ZlIEdVSSBpbnRvIHdyYXBwZXIKICAgICAgICAgICAgd3JhcHBlci5hcHBlbmRDaGlsZChkb20pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ3JlYXRlIFRvZ2dsZSBIYW5kbGUKICAgICAgICAgICAgY29uc3QgaGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5sZWZ0ID0gJy00MHB4JzsgLy8gUHJvdHJ1ZGUgdG8gdGhlIGxlZnQKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLnRvcCA9ICcwJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLndpZHRoID0gJzQwcHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuaGVpZ2h0ID0gJzQwcHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gJ3JnYmEoMCwgMjAsIDQwLCAwLjkpJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlciA9ICcxcHggc29saWQgIzAwZmZmZic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5ib3JkZXJSaWdodCA9ICdub25lJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlclRvcExlZnRSYWRpdXMgPSAnOHB4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlckJvdHRvbUxlZnRSYWRpdXMgPSAnOHB4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmN1cnNvciA9ICdwb2ludGVyJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5qdXN0aWZ5Q29udGVudCA9ICdjZW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYWxpZ25JdGVtcyA9ICdjZW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuY29sb3IgPSAnIzAwZmZmZic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5mb250U2l6ZSA9ICcyMHB4JzsKICAgICAgICAgICAgaGFuZGxlLmlubmVySFRNTCA9ICfimpknOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm94U2hhZG93ID0gJy01cHggMCAxMHB4IHJnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgICAgIAogICAgICAgICAgICB3cmFwcGVyLmFwcGVuZENoaWxkKGhhbmRsZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUb2dnbGUgTG9naWMKICAgICAgICAgICAgbGV0IGlzT3BlbiA9IGZhbHNlOwogICAgICAgICAgICBoYW5kbGUuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsgLy8gUHJldmVudCBnYW1lIGlucHV0cwogICAgICAgICAgICAgICAgaXNPcGVuID0gIWlzT3BlbjsKICAgICAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUucmlnaHQgPSBpc09wZW4gPyAnMHB4JyA6ICctMjYwcHgnOwogICAgICAgICAgICAgICAgaGFuZGxlLmlubmVySFRNTCA9IGlzT3BlbiA/ICfCuycgOiAn4pqZJzsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIERlZmF1bHQgZ2xvYmFsIHRpbWVTY2FsZSBpZiBub3Qgc2V0CmlmICh3aW5kb3cuZmx1eC50aW1lU2NhbGUgPT09IHVuZGVmaW5lZCkgd2luZG93LmZsdXgudGltZVNjYWxlID0gMC44OwoKdGhpcy5fc2V0dXBHZW5lcmFsKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwR2FtZVN0YXRlKCk7CnRoaXMuX3NldHVwT3ZlcmxheXMoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBUZWFtcygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFBsYXllckluc3BlY3RvcigpOwogICAgICAgICAgICB0aGlzLl9zZXR1cEJhbGxTYW5kYm94KCk7CnRoaXMuX3NldHVwRlhMYWIoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBWaXN1YWxEZWJ1ZygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFZpc3VhbHMoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBUb29sdGlwcygpOwogICAgICAgIH0KCiAgICAgICAgX3NldHVwVG9vbHRpcHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBUb29sdGlwIERPTQogICAgICAgICAgICB0aGlzLnRvb2x0aXBFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMudG9vbHRpcEVsLnN0eWxlLCB7CiAgICAgICAgICAgICAgICBwb3NpdGlvbjogJ2ZpeGVkJywKICAgICAgICAgICAgICAgIHRvcDogJzUwJScsCiAgICAgICAgICAgICAgICBsZWZ0OiAnNTAlJywKICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogJ3RyYW5zbGF0ZSgtNTAlLCAtNTAlKScsCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICdyZ2JhKDAsIDEwLCAzMCwgMC45NSknLAogICAgICAgICAgICAgICAgYm9yZGVyOiAnMnB4IHNvbGlkICMwMGZmZmYnLAogICAgICAgICAgICAgICAgcGFkZGluZzogJzIwcHgnLAogICAgICAgICAgICAgICAgY29sb3I6ICcjZmZmJywKICAgICAgICAgICAgICAgIGZvbnRGYW1pbHk6ICdtb25vc3BhY2UnLAogICAgICAgICAgICAgICAgZm9udFNpemU6ICcxNHB4JywKICAgICAgICAgICAgICAgIG1heFdpZHRoOiAnMzAwcHgnLAogICAgICAgICAgICAgICAgekluZGV4OiAnMTAwMDAnLAogICAgICAgICAgICAgICAgZGlzcGxheTogJ25vbmUnLAogICAgICAgICAgICAgICAgcG9pbnRlckV2ZW50czogJ25vbmUnLAogICAgICAgICAgICAgICAgYm94U2hhZG93OiAnMCAwIDIwcHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKScsCiAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6ICc4cHgnLAogICAgICAgICAgICAgICAgdGV4dEFsaWduOiAnY2VudGVyJwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLnRvb2x0aXBFbCk7CgogICAgICAgICAgICAvLyBSZWN1cnNpdmUgZnVuY3Rpb24gdG8gYXR0YWNoIGxpc3RlbmVycwogICAgICAgICAgICBjb25zdCBhdHRhY2ggPSAoZ3VpKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBDb250cm9sbGVycwogICAgICAgICAgICAgICAgaWYgKGd1aS5jb250cm9sbGVycykgewogICAgICAgICAgICAgICAgICAgIGd1aS5jb250cm9sbGVycy5mb3JFYWNoKGMgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkb20gPSBjLmRvbUVsZW1lbnQuY2xvc2VzdCgnLmNvbnRyb2xsZXInKTsgLy8gbGlsLWd1aSBzdHJ1Y3R1cmUKICAgICAgICAgICAgICAgICAgICAgICAgaWYoZG9tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IGRvbS5xdWVyeVNlbGVjdG9yKCcubmFtZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobGFiZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hZGRMb25nUHJlc3MobGFiZWwsIGMucHJvcGVydHksIGMuX25hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBTdWItZm9sZGVycwogICAgICAgICAgICAgICAgaWYoZ3VpLmZvbGRlcnMpIHsKICAgICAgICAgICAgICAgICAgICBndWkuZm9sZGVycy5mb3JFYWNoKGYgPT4gYXR0YWNoKGYpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFdhaXQgYSB0aWNrIGZvciBHVUkgdG8gZnVsbHkgcmVuZGVyIERPTQogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGF0dGFjaCh0aGlzLmd1aSksIDEwMCk7CiAgICAgICAgfQoKICAgICAgICBfYWRkTG9uZ1ByZXNzKGVsZW1lbnQsIHByb3BlcnR5LCBuYW1lKSB7CiAgICAgICAgICAgIGxldCB0aW1lciA9IG51bGw7CiAgICAgICAgICAgIGNvbnN0IGR1cmF0aW9uID0gNTAwOyAvLyAwLjVzCgogICAgICAgICAgICBjb25zdCBzdGFydCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dUb29sdGlwKHByb3BlcnR5LCBuYW1lKTsKICAgICAgICAgICAgICAgIH0sIGR1cmF0aW9uKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGNvbnN0IGVuZCA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGlmKHRpbWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTsKICAgICAgICAgICAgICAgICAgICB0aW1lciA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9oaWRlVG9vbHRpcCgpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBzdGFydCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHN0YXJ0LCB7cGFzc2l2ZTogdHJ1ZX0pOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgZW5kKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgZW5kKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGVuZCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCBlbmQpOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dUb29sdGlwKHByb3AsIG5hbWUpIHsKICAgICAgICAgICAgY29uc3QgZGVzYyA9IFRPT0xUSVBfREVTQ1JJUFRJT05TW3Byb3BdOwogICAgICAgICAgICBpZihkZXNjKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRvb2x0aXBFbC5pbm5lckhUTUwgPSBgPHN0cm9uZyBzdHlsZT0iY29sb3I6IzAwZmZmZjsgZm9udC1zaXplOjE2cHg7Ij4ke25hbWUgfHwgcHJvcH08L3N0cm9uZz48YnI+PGJyPiR7ZGVzY31gOwogICAgICAgICAgICAgICAgdGhpcy50b29sdGlwRWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9oaWRlVG9vbHRpcCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudG9vbHRpcEVsKSB0aGlzLnRvb2x0aXBFbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KCgpfc2V0dXBHZW5lcmFsKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0dlbmVyYWwnKTsKICAgICAgICAgICAgCmNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIHRpbWVTY2FsZTogd2luZG93LmZsdXgudGltZVNjYWxlLAogICAgICAgICAgICAgICAgZGVtb01vZGU6IHRoaXMuZ2FtZS5pc0RlbW9Nb2RlLAogICAgICAgICAgICAgICAgdG9nZ2xlSFVEOiB0cnVlLAogICAgICAgICAgICAgICAgcmVzb2x1dGlvbjogMC41MCwKYXJlbmFPcGFjaXR5OiAwLjMsCiAgICAgICAgICAgICAgICBhcmVuYTJPcGFjaXR5OiAwLjI1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3RpbWVTY2FsZScsIDAuMCwgNS4wKS5uYW1lKCdHYW1lIFNwZWVkJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSB2OwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZGVtb01vZGUnKS5uYW1lKCdEZW1vIE1vZGUnKS5saXN0ZW4oKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuaXNEZW1vTW9kZSAhPT0gdikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS50b2dnbGVEZW1vTW9kZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndG9nZ2xlSFVEJykubmFtZSgnU2hvdyBIVUQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGh1ZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpOwogICAgICAgICAgICAgICAgaWYgKGh1ZCkgewogICAgICAgICAgICAgICAgICAgIGh1ZC5zdHlsZS52aXNpYmlsaXR5ID0gdiA/ICd2aXNpYmxlJyA6ICdoaWRkZW4nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAncmVzb2x1dGlvbicsIDAuMSwgMi4wKS5uYW1lKCdSZXNvbHV0aW9uIFNjYWxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB3ID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBoID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgY29uc3QgcmVuZGVyZXIgPSB0aGlzLmdhbWUucmVuZGVyZXI7CiAgICAgICAgICAgICAgICBpZiAocmVuZGVyZXIpIHsKICAgICAgICAgICAgICAgICAgICByZW5kZXJlci5zZXRTaXplKHcgKiB2LCBoICogdiwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCmZvbGRlci5hZGQocGFyYW1zLCAnYXJlbmFPcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ0FyZW5hIDEgT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IHY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYmxlbmRNb2RlcyA9IHsKICAgICAgICAgICAgICAgICdOb3JtYWwnOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywKICAgICAgICAgICAgICAgICdBZGRpdGl2ZSc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnTXVsdGlwbHknOiBUSFJFRS5NdWx0aXBseUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICdOb0JsZW5kaW5nJzogVEhSRUUuTm9CbGVuZGluZwogICAgICAgICAgICB9OwpwYXJhbXMuYXJlbmFCbGVuZCA9ICdOb3JtYWwnOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYUJsZW5kJywgT2JqZWN0LmtleXMoYmxlbmRNb2RlcykpLm5hbWUoJ0FyZW5hIDEgQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2ggJiYgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsLmJsZW5kaW5nID0gYmxlbmRNb2Rlc1t2XTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEFyZW5hIDIgQ29udHJvbHMKZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYTJPcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ0FyZW5hIDIgT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIgJiYgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eS52YWx1ZSA9IHY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKcGFyYW1zLmFyZW5hMkJsZW5kID0gJ0FkZGl0aXZlJzsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYTJCbGVuZCcsIE9iamVjdC5rZXlzKGJsZW5kTW9kZXMpKS5uYW1lKCdBcmVuYSAyIEJsZW5kJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoMiAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC5ibGVuZGluZyA9IGJsZW5kTW9kZXNbdl07CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgZGVmYXVsdHMKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gcGFyYW1zLmFyZW5hT3BhY2l0eTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoMiAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLm9wYWNpdHkgPSBwYXJhbXMuYXJlbmEyT3BhY2l0eTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9zZXR1cE92ZXJsYXlzKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ092ZXJsYXlzICYgRlgnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDEuIEdJRiBPdmVybGF5CiAgICAgICAgICAgIGNvbnN0IGdpZkVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NjcmVlbi1vdmVybGF5LWdpZicpOwogICAgICAgICAgICBpZiAoZ2lmRWwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdpZlBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB0cnVlLApvcGFjaXR5OiAwLjYyLAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnb3ZlcmxheScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdTY3JlZW4gR0lGJyk7CiAgICAgICAgICAgICAgICBnRm9sZGVyLmFkZChnaWZQYXJhbXMsICd2aXNpYmxlJykub25DaGFuZ2UodiA9PiBnaWZFbC5zdHlsZS5kaXNwbGF5ID0gdiA/ICdibG9jaycgOiAnbm9uZScpOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMS4wKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLm9wYWNpdHkgPSB2KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYmxlbmRNb2RlcyA9IFsKICAgICAgICAgICAgICAgICAgICAnbm9ybWFsJywgJ211bHRpcGx5JywgJ3NjcmVlbicsICdvdmVybGF5JywgCiAgICAgICAgICAgICAgICAgICAgJ2RhcmtlbicsICdsaWdodGVuJywgJ2NvbG9yLWRvZGdlJywgJ2NvbG9yLWJ1cm4nLCAKICAgICAgICAgICAgICAgICAgICAnaGFyZC1saWdodCcsICdzb2Z0LWxpZ2h0JywgJ2RpZmZlcmVuY2UnLCAnZXhjbHVzaW9uJywgCiAgICAgICAgICAgICAgICAgICAgJ2h1ZScsICdzYXR1cmF0aW9uJywgJ2NvbG9yJywgJ2x1bWlub3NpdHknCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAnYmxlbmQnLCBibGVuZE1vZGVzKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLm1peEJsZW5kTW9kZSA9IHYpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBXYXRlciBPdmVybGF5CiAgICAgICAgICAgIGNvbnN0IHdvID0gdGhpcy5nYW1lLndhdGVyT3ZlcmxheTsKICAgICAgICAgICAgaWYgKHdvICYmIHdvLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdXYXRlciBTaGFkZXInKTsKICAgICAgICAgICAgICAgIGNvbnN0IHdQYXJhbXMgPSB7IAogICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkgPyB3by5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eS52YWx1ZSA6IDAuNSwKICAgICAgICAgICAgICAgICAgICBibGVuZDogJ0FkZGl0aXZlJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ3Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IHdvLm1lc2gudmlzaWJsZSA9IHYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAod28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkpIHsKICAgICAgICAgICAgICAgICAgICB3Rm9sZGVyLmFkZCh3UGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMi4wKS5vbkNoYW5nZSh2ID0+IHdvLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlID0gdik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGhyZWVCbGVuZHMgPSB7CiAgICAgICAgICAgICAgICAgICAgJ05vcm1hbCc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdBZGRpdGl2ZSc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICAnTXVsdGlwbHknOiBUSFJFRS5NdWx0aXBseUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdOb0JsZW5kaW5nJzogVEhSRUUuTm9CbGVuZGluZwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICB3by5tYXRlcmlhbC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgIHdvLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBMaWdodCBTaGFmdHMKICAgICAgICAgICAgY29uc3QgbHMgPSB0aGlzLmdhbWUubGlnaHRTaGFmdHM7CiAgICAgICAgICAgIGlmIChscyAmJiBscy5jb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGxQYXJhbXMgPSB7IHZpc2libGU6IHRydWUgfTsKICAgICAgICAgICAgICAgIGZvbGRlci5hZGQobFBhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdMaWdodCBTaGFmdHMnKS5vbkNoYW5nZSh2ID0+IGxzLmNvbnRhaW5lci52aXNpYmxlID0gdik7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpfc2V0dXBHYW1lU3RhdGUoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignR2FtZSBTdGF0ZScpOwogICAgICAgICAgICBjb25zdCBnbSA9IHRoaXMuZ2FtZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIGZvcmNlSG9tZUdvYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5nb2FsU2NvcmVkKCdob21lJyk7IAogICAgICAgICAgICAgICAgICAgIGVsc2UgY29uc29sZS53YXJuKCJHYW1lIG11c3QgYmUgYWN0aXZlIHRvIHRyaWdnZXIgZ29hbCIpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGZvcmNlQXdheUdvYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5nb2FsU2NvcmVkKCdhd2F5Jyk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb25zb2xlLndhcm4oIkdhbWUgbXVzdCBiZSBhY3RpdmUgdG8gdHJpZ2dlciBnb2FsIik7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZm9yY2VIYWxmdGltZTogKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmKGdtLnN0YXRlID09PSAnYWN0aXZlJykgZ20uZW5kSGFsZigpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHJlc2V0Um91bmQ6ICgpID0+IGdtLnJlc2V0Um91bmQoKSwKICAgICAgICAgICAgICAgIGV4aXRUb01lbnU6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPSAnbWVudSc7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgcHJhY3RpY2UgaWYgcnVubmluZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlSG9tZUdvYWwnKS5uYW1lKCdUcmlnZ2VyIEhvbWUgR29hbCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlQXdheUdvYWwnKS5uYW1lKCdUcmlnZ2VyIEF3YXkgR29hbCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlSGFsZnRpbWUnKS5uYW1lKCdGb3JjZSBIYWxmdGltZScpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3Jlc2V0Um91bmQnKS5uYW1lKCdSZXNldCBSb3VuZCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2V4aXRUb01lbnUnKS5uYW1lKCdFeGl0IHRvIE1lbnUnKTsKICAgICAgICB9CgogICAgICAgIF9zZXR1cFRlYW1zKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1RlYW1zJyk7CiAgICAgICAgICAgIGlmICghdGhpcy5nYW1lLnRlYW1zLmhvbWUgfHwgIXRoaXMuZ2FtZS50ZWFtcy5hd2F5KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBob21lID0gdGhpcy5nYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGNvbnN0IGF3YXkgPSB0aGlzLmdhbWUudGVhbXMuYXdheTsKCiAgICAgICAgICAgIC8vIEhvbWUKICAgICAgICAgICAgY29uc3QgaEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0hvbWUgVGVhbScpOwogICAgICAgICAgICBoRm9sZGVyLmFkZChob21lLCAnaXNIdW1hbicpLm5hbWUoJ0lzIEh1bWFuIENvbnRyb2xsZWQnKS5saXN0ZW4oKTsKICAgICAgICAgICAgaEZvbGRlci5hZGQoaG9tZSwgJ2FpRW5hYmxlZCcpLm5hbWUoJ0FJIExvZ2ljIEVuYWJsZWQnKS5saXN0ZW4oKTsKCiAgICAgICAgICAgIC8vIEF3YXkKICAgICAgICAgICAgY29uc3QgYUZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0F3YXkgVGVhbScpOwogICAgICAgICAgICBhRm9sZGVyLmFkZChhd2F5LCAnaXNIdW1hbicpLm5hbWUoJ0lzIEh1bWFuIENvbnRyb2xsZWQnKS5saXN0ZW4oKTsKICAgICAgICAgICAgYUZvbGRlci5hZGQoYXdheSwgJ2FpRW5hYmxlZCcpLm5hbWUoJ0FJIExvZ2ljIEVuYWJsZWQnKS5saXN0ZW4oKTsKCiAgICAgICAgfQoKX3NldHVwUGxheWVySW5zcGVjdG9yKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1BsYXllciBJbnNwZWN0b3IgKEhvbWUgQWN0aXZlKScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGVscGVyIHRvIGdldCBjdXJyZW50IGFjdGl2ZSBwbGF5ZXIgc2FmZWx5CiAgICAgICAgICAgIGNvbnN0IGdldEFjdGl2ZSA9ICgpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5nYW1lLnRlYW1zLmhvbWUgJiYgdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSAKICAgICAgICAgICAgICAgICAgICA/IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciAKICAgICAgICAgICAgICAgICAgICA6IG51bGw7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBQcm94eSBvYmplY3QgdG8gYmluZCBHVUkgdG8gZHluYW1pYyB0YXJnZXQKICAgICAgICAgICAgY29uc3QgcHJveHkgPSB7CiAgICAgICAgICAgICAgICBnZXQgUm9sZSgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5yb2xlIDogJy0nOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGdldCBHb2RNb2RlKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLmlzR29kTW9kZSA6IGZhbHNlOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgR29kTW9kZSh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmlzR29kTW9kZSA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBSdW50aW1lIFZhbHVlcwogICAgICAgICAgICAgICAgZ2V0IEhQKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkhQIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEhQKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuSFAgPSB2OyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGdldCBDdXJyZW50RU4oKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuY3VycmVudEVOIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEN1cnJlbnRFTih2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmN1cnJlbnRFTiA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBCYXNlIFN0YXRzCiAgICAgICAgICAgICAgICBnZXQgTWF4SFAoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMubWF4SFAgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgTWF4SFAodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5tYXhIUCA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgU1AoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuU1AgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgU1AodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5TUCA9IHY7IAogICAgICAgICAgICAgICAgICAgICAgICBwLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsgCiAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEVOKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkVOIDogMDsgCiAgICAgICAgICAgICAgICB9LCAKICAgICAgICAgICAgICAgIHNldCBFTih2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHMuRU4gPSB2OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEFUKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkFUIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEFUKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQVQgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFBBKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlBBIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFBBKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuUEEgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEJMKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkJMIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEJMKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQkwgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFNIKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlNIIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFNIKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuU0ggPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IENBKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkNBIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IENBKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQ0EgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLy8gQWN0aW9ucwogICAgICAgICAgICAgICAgTGV2ZWxVcDogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5sZXZlbFVwKCk7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEZ1bGxIZWFsOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsgCiAgICAgICAgICAgICAgICAgICAgaWYocCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7IAogICAgICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuZ2V0U3RhdCgnRU4nKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLnZlbm9tID0gMDsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLm5hcCA9IDA7IAogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGsgaW4gcC5zdGF0dXMud2l0aGVyKSBwLnN0YXR1cy53aXRoZXJba10gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZih3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJGVUxMIEhFQUwiLCBwLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIERyYWluRU46ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBwLmZ1bWJsZSgpOyAvLyBUcmlnZ2VyIGZ1bWJsZSBsb2dpYwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocHJveHksICdSb2xlJykubGlzdGVuKCkuZGlzYWJsZSgpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHByb3h5LCAnR29kTW9kZScpLm5hbWUoJ0dvZCBNb2RlIChJbmYgSFAvRU4pJykubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBydEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ1J1bnRpbWUgU3RhdHVzJyk7CiAgICAgICAgICAgIHJ0Rm9sZGVyLmFkZChwcm94eSwgJ0hQJywgMCwgOTk5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHJ0Rm9sZGVyLmFkZChwcm94eSwgJ0N1cnJlbnRFTicsIDAsIDEwMCkubmFtZSgnQ3VycmVudCBFTicpLmxpc3RlbigpOwoKICAgICAgICAgICAgY29uc3Qgc3RhdEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0Jhc2UgU3RhdHMnKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdNYXhIUCcsIDEwMCwgOTk5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnRU4nLCAwLCA5OSkubmFtZSgnTWF4IEVOJykubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnU1AnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQVQnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnUEEnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQkwnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnU0gnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQ0EnLCAwLCA5OSkubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBhY3Rpb25Gb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdBY3Rpb25zJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdMZXZlbFVwJykubmFtZSgnSW5zdGFudCBMZXZlbCBVcCcpOwogICAgICAgICAgICBhY3Rpb25Gb2xkZXIuYWRkKHByb3h5LCAnRnVsbEhlYWwnKS5uYW1lKCdGdWxsIEhlYWwgJiBDdXJlJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdEcmFpbkVOJykubmFtZSgnRHJhaW4gRU4gKEZ1bWJsZSknKTsKICAgICAgICB9Cgpfc2V0dXBCYWxsU2FuZGJveCgpIHsKICAgIGNvbnN0IHJvb3QgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0JhbGwgTGFiIChUaHJvdyAmIFBoeXNpY3MpJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBTaGFyZWQgc3RhdGUgb2JqZWN0IChsaXZlcyBvbiB3aW5kb3cuZmx1eCBzbyBpdCBzdXJ2aXZlcyByZWxvYWRzKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBsYWIgPSB3aW5kb3cuZmx1eC5iYWxsTGFiID0gd2luZG93LmZsdXguYmFsbExhYiB8fCB7fTsKICAgIGxhYi5nYW1lID0gdGhpcy5nYW1lOwoKICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnOwogICAgY29uc3QgVEMgPSB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZzsKCiAgICBpZiAoIUMgfHwgIVRDKSB7CiAgICAgICAgY29uc29sZS53YXJuKCJCYWxsIExhYjogTWlzc2luZyBCYWxsQ29uZmlnIG9yIFRocm93Q29uZmlnLiIpOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEhlbHBlcnMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgZ2V0QmFsbCA9ICgpID0+IHRoaXMuZ2FtZSAmJiB0aGlzLmdhbWUuZW50aXRpZXMgPyB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICBjb25zdCBnZXRBY3RpdmUgPSAoKSA9PiB0aGlzLmdhbWUgJiYgdGhpcy5nYW1lLnRlYW1zICYmIHRoaXMuZ2FtZS50ZWFtcy5ob21lID8gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKCiAgICBjb25zdCBlbnN1cmVQcmV2aWV3TGluZSA9ICgpID0+IHsKICAgICAgICBpZiAobGFiLnByZXZpZXdMaW5lKSByZXR1cm47CiAgICAgICAgaWYgKCF0aGlzLmdhbWUgfHwgIXRoaXMuZ2FtZS5zY2VuZSkgcmV0dXJuOwoKICAgICAgICBjb25zdCBnZW9tID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgdHJhbnNwYXJlbnQ6IHRydWUsIG9wYWNpdHk6IDAuOTUgfSk7CiAgICAgICAgY29uc3QgbGluZSA9IG5ldyBUSFJFRS5MaW5lKGdlb20sIG1hdCk7CiAgICAgICAgbGluZS5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgbGluZS5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKGxpbmUpOwogICAgICAgIGxhYi5wcmV2aWV3TGluZSA9IGxpbmU7CiAgICB9OwoKICAgIGNvbnN0IGNsZWFyUHJldmlld0xpbmUgPSAoKSA9PiB7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3TGluZSAmJiBsYWIucHJldmlld0xpbmUuZ2VvbWV0cnkpIHsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBBIHNhZmUgImdob3N0IGJhbGwiIHRoYXQgY2FuIHVzZSBCYWxsLnVwZGF0ZUZyZWUgd2l0aG91dCBzcGF3bmluZyBGWAogICAgY29uc3QgbWFrZUdob3N0QmFsbCA9IChwb3MsIHZlbCwgc3BpbikgPT4gewogICAgICAgIGNvbnN0IGdiID0gewogICAgICAgICAgICBtZXNoOiB7IHBvc2l0aW9uOiBwb3MuY2xvbmUoKSB9LAogICAgICAgICAgICB2ZWxvY2l0eTogdmVsLmNsb25lKCksCiAgICAgICAgICAgIGFuZ3VsYXJWZWxvY2l0eTogKHNwaW4gPyBzcGluLmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpKSwKICAgICAgICAgICAgYWNjdW11bGF0ZWRSb3RhdGlvbjogbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwKICAgICAgICAgICAgcG93ZXI6IDAsCiAgICAgICAgICAgIGRlY2F5UmF0ZTogMCwKICAgICAgICAgICAgX2J1YmJsZVRpbWVyOiA5OTksCiAgICAgICAgICAgIF9naG9zdDogdHJ1ZSwKICAgICAgICAgICAgZGVmb3JtTm9kZTogbnVsbAogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGdiOwogICAgfTsKCiAgICAvLyBVc2UgQmFsbC51cGRhdGVGcmVlIGZvciBmYWl0aGZ1bCB0cmFqZWN0b3J5IHByZWRpY3Rpb24KICAgIGNvbnN0IHNpbXVsYXRlID0gKGdob3N0QmFsbCwgc3RlcHMsIHN0ZXBEdCkgPT4gewogICAgICAgIGNvbnN0IHB0cyA9IFtdOwogICAgICAgIHB0cy5wdXNoKGdob3N0QmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCkpOwogICAgICAgIGNvbnN0IHByb3RvID0gd2luZG93LmZsdXguQmFsbCAmJiB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZTsKICAgICAgICBpZiAoIXByb3RvIHx8IHR5cGVvZiBwcm90by51cGRhdGVGcmVlICE9PSAnZnVuY3Rpb24nKSByZXR1cm4gcHRzOwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ZXBzOyBpKyspIHsKICAgICAgICAgICAgcHJvdG8udXBkYXRlRnJlZS5jYWxsKGdob3N0QmFsbCwgc3RlcER0KTsKICAgICAgICAgICAgcHRzLnB1c2goZ2hvc3RCYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwdHM7CiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gUHJldmlldyArIHJlY29yZC9yZXBsYXkgcnVudGltZSBsb29wCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KbGFiLnByZXZpZXcgPSBsYWIucHJldmlldyB8fCB7CiAgICAgICAgZW5hYmxlZDogZmFsc2UsCiAgICAgICAgc291cmNlOiAnQ2Fubm9uJywKICAgICAgICBzdGVwczogMTIwLAogICAgICAgIHN0ZXBEdDogMS82MCwKICAgICAgICByZWZyZXNoSHo6IDEwLAogICAgICAgIHNob3dPbkhlbGRPbmx5OiBmYWxzZQogICAgfTsKCiAgICBsYWIuY2Fubm9uID0gbGFiLmNhbm5vbiB8fCB7CiAgICAgICAgeWF3OiAwLAogICAgICAgIHBpdGNoOiAwLAogICAgICAgIHBvd2VyOiAyMCwKICAgICAgICB0eXBlOiAnU0gnLAogICAgICAgIHNwaW5YOiAwLAogICAgICAgIHNwaW5ZOiAwLAogICAgICAgIHNwaW5aOiAwLAogICAgICAgIGZpcmVCdXJzdDogMSwKICAgICAgICBzcHJlYWREZWc6IDAKICAgIH07CgogICAgbGFiLnJlY29yZGluZyA9IGxhYi5yZWNvcmRpbmcgfHwgewogICAgICAgIGlzUmVjb3JkaW5nOiBmYWxzZSwKICAgICAgICBmcmFtZXM6IFtdLAogICAgICAgIG1heFNlY29uZHM6IDEyCiAgICB9OwoKICAgIGxhYi5yZXBsYXkgPSBsYWIucmVwbGF5IHx8IHsKICAgICAgICBpc1JlcGxheWluZzogZmFsc2UsCiAgICAgICAgZnJhbWVzOiBbXSwKICAgICAgICBpZHg6IDAsCiAgICAgICAgbG9vcDogdHJ1ZSwKICAgICAgICBzcGVlZDogMS4wCiAgICB9OwoKICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgbGFiLnRhcmdldEJhbGwgPSBudWxsOwoKICAgIGxhYi5hcHBseVJlcGxheUZyYW1lID0gKGJhbGwsIGR0KSA9PiB7CiAgICAgICAgY29uc3QgcmVwID0gbGFiLnJlcGxheTsKICAgICAgICBpZiAoIXJlcCB8fCAhcmVwLmlzUmVwbGF5aW5nIHx8ICFyZXAuZnJhbWVzIHx8IHJlcC5mcmFtZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBBZHZhbmNlIHRpbWUgYnkgc3RlcHBpbmcgaW5kaWNlcyAoZnJhbWUtYmFzZWQpCiAgICAgICAgY29uc3Qgc3RlcCA9IE1hdGgubWF4KDEsIE1hdGguZmxvb3IocmVwLnNwZWVkKSk7CiAgICAgICAgcmVwLmlkeCArPSBzdGVwOwoKICAgICAgICBpZiAocmVwLmlkeCA+PSByZXAuZnJhbWVzLmxlbmd0aCkgewogICAgICAgICAgICBpZiAocmVwLmxvb3ApIHJlcC5pZHggPSAwOwogICAgICAgICAgICBlbHNlIHsgcmVwLmlzUmVwbGF5aW5nID0gZmFsc2U7IGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOyByZXR1cm47IH0KICAgICAgICB9CgogICAgICAgIGNvbnN0IGYgPSByZXAuZnJhbWVzW3JlcC5pZHhdOwogICAgICAgIGlmICghZikgcmV0dXJuOwoKICAgICAgICBiYWxsLmRyb3AoKTsgLy8gZW5zdXJlIG5vIGhvbGRlciBsb2dpYyBmaWdodHMgdXMKICAgICAgICBiYWxsLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIGJhbGwubWVzaC5wb3NpdGlvbi5zZXQoZi5weCwgZi5weSwgZi5weik7CiAgICAgICAgYmFsbC52ZWxvY2l0eS5zZXQoZi52eCwgZi52eSwgZi52eik7CiAgICAgICAgYmFsbC5hbmd1bGFyVmVsb2NpdHkuc2V0KGYuc3gsIGYuc3ksIGYuc3opOwogICAgfTsKCiAgICBsYWIuX3ByZXZpZXdUaW1lciA9IGxhYi5fcHJldmlld1RpbWVyIHx8IDA7CgogICAgbGFiLnVwZGF0ZSA9IChkdCkgPT4gewogICAgICAgIC8vIC0tLSByZWNvcmRpbmcgLS0tCiAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICBpZiAoYiAmJiBsYWIucmVjb3JkaW5nICYmIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcpIHsKICAgICAgICAgICAgY29uc3QgciA9IGxhYi5yZWNvcmRpbmc7CiAgICAgICAgICAgIGNvbnN0IG1heEZyYW1lcyA9IE1hdGguZmxvb3IoKHIubWF4U2Vjb25kcyB8fCAxMikgLyAoZHQgfHwgKDEvNjApKSk7CiAgICAgICAgICAgIGlmIChyLmZyYW1lcy5sZW5ndGggPiBtYXhGcmFtZXMpIHIuZnJhbWVzLnNoaWZ0KCk7CiAgICAgICAgICAgIHIuZnJhbWVzLnB1c2goewogICAgICAgICAgICAgICAgcHg6IGIubWVzaC5wb3NpdGlvbi54LCBweTogYi5tZXNoLnBvc2l0aW9uLnksIHB6OiBiLm1lc2gucG9zaXRpb24ueiwKICAgICAgICAgICAgICAgIHZ4OiBiLnZlbG9jaXR5LngsIHZ5OiBiLnZlbG9jaXR5LnksIHZ6OiBiLnZlbG9jaXR5LnosCiAgICAgICAgICAgICAgICBzeDogYi5hbmd1bGFyVmVsb2NpdHkueCwgc3k6IGIuYW5ndWxhclZlbG9jaXR5LnksIHN6OiBiLmFuZ3VsYXJWZWxvY2l0eS56CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIHByZXZpZXcgcmVmcmVzaCAtLS0KICAgICAgICBsYWIuX3ByZXZpZXdUaW1lciArPSBkdDsKICAgICAgICBjb25zdCByZWZyZXNoSW50ZXJ2YWwgPSAxLjAgLyBNYXRoLm1heCgxLCAobGFiLnByZXZpZXcucmVmcmVzaEh6IHx8IDEwKSk7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LmVuYWJsZWQgJiYgbGFiLl9wcmV2aWV3VGltZXIgPj0gcmVmcmVzaEludGVydmFsKSB7CiAgICAgICAgICAgIGxhYi5fcHJldmlld1RpbWVyID0gMDsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfQogICAgfTsKCiAgICBsYWIucmVmcmVzaFByZXZpZXcgPSAoKSA9PiB7CiAgICAgICAgaWYgKCFsYWIucHJldmlldy5lbmFibGVkKSB7IGNsZWFyUHJldmlld0xpbmUoKTsgcmV0dXJuOyB9CiAgICAgICAgZW5zdXJlUHJldmlld0xpbmUoKTsKCiAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgaWYgKCFiIHx8ICFiLm1lc2gpIHJldHVybjsKCiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LnNob3dPbkhlbGRPbmx5ICYmIGIuc3RhdGUgIT09ICdoZWxkJykgewogICAgICAgICAgICBjbGVhclByZXZpZXdMaW5lKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIERlY2lkZSBwcmV2aWV3IHNvdXJjZQogICAgICAgIGxldCBzdGFydFBvcyA9IGIubWVzaC5wb3NpdGlvbjsKICAgICAgICBsZXQgc3RhcnRWZWwgPSBiLnZlbG9jaXR5OwogICAgICAgIGxldCBzdGFydFNwaW4gPSBiLmFuZ3VsYXJWZWxvY2l0eTsKCiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LnNvdXJjZSA9PT0gJ0Nhbm5vbicpIHsKICAgICAgICAgICAgLy8gQ2Fubm9uIGFsd2F5cyBsYXVuY2hlcyBmcm9tIGJhbGwgcG9zaXRpb24gKG9yIHBsYXllciBpZiBoZWxkKQogICAgICAgICAgICBjb25zdCB5YXdSYWQgPSAobGFiLmNhbm5vbi55YXcgfHwgMCkgKiBNYXRoLlBJIC8gMTgwOwogICAgICAgICAgICBjb25zdCBwaXRjaFJhZCA9IChsYWIuY2Fubm9uLnBpdGNoIHx8IDApICogTWF0aC5QSSAvIDE4MDsKCiAgICAgICAgICAgIGNvbnN0IGRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgTWF0aC5zaW4oeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIE1hdGguc2luKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIC1NYXRoLmNvcyh5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpCiAgICAgICAgICAgICkubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBjYXAgPSAod2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfQ0FQICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkxBVU5DSF9TUEVFRF9DQVAgOiA4NS4wKTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAod2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfU0NBTEUgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX1NDQUxFIDogMS4wKTsKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSBNYXRoLm1pbigobGFiLmNhbm5vbi5wb3dlciB8fCAyMCkgKiBzY2FsZSwgY2FwKTsKCiAgICAgICAgICAgIHN0YXJ0UG9zID0gKGIuc3RhdGUgPT09ICdoZWxkJyAmJiBwICYmIHAubWVzaCkgPyBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMS4yLCAwKSkgOiBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgc3RhcnRWZWwgPSBkaXIubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICBzdGFydFNwaW4gPSBuZXcgVEhSRUUuVmVjdG9yMyhsYWIuY2Fubm9uLnNwaW5YIHx8IDAsIGxhYi5jYW5ub24uc3BpblkgfHwgMCwgbGFiLmNhbm5vbi5zcGluWiB8fCAwKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGdob3N0ID0gbWFrZUdob3N0QmFsbChzdGFydFBvcy5jbG9uZSgpLCBzdGFydFZlbC5jbG9uZSgpLCBzdGFydFNwaW4pOwogICAgICAgIGNvbnN0IHB0cyA9IHNpbXVsYXRlKGdob3N0LCBNYXRoLmZsb29yKGxhYi5wcmV2aWV3LnN0ZXBzIHx8IDEyMCksIChsYWIucHJldmlldy5zdGVwRHQgfHwgKDEvNjApKSk7CgogICAgICAgIGlmIChsYWIucHJldmlld0xpbmUpIHsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCkuc2V0RnJvbVBvaW50cyhwdHMpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IEJhbGwgUGh5c2ljcyAoQmFsbENvbmZpZykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcGh5cyA9IHJvb3QuYWRkRm9sZGVyKCdCYWxsIFBoeXNpY3MgKEJhbGxDb25maWcpJyk7CgogICAgY29uc3QgaW50ZWcgPSBwaHlzLmFkZEZvbGRlcignSW50ZWdyYXRpb24nKTsKICAgIGludGVnLmFkZChDLCAnU1VCU1RFUFMnLCAxLCAxMiwgMSkubmFtZSgnU3Vic3RlcHMnKTsKICAgIGludGVnLmFkZChDLCAnU1RPUF9TUEVFRCcsIDAuMCwgMC4yKS5uYW1lKCdTdG9wIFNwZWVkJyk7CgogICAgY29uc3QgZHJhZyA9IHBoeXMuYWRkRm9sZGVyKCdXYXRlciBEcmFnJyk7CiAgICBkcmFnLmFkZChDLCAnV0FURVJfRFJBR19MSU5FQVInLCAwLjAsIDIuMCkubmFtZSgnTGluZWFyIERyYWcnKTsKICAgIGRyYWcuYWRkKEMsICdXQVRFUl9EUkFHX1FVQUQnLCAwLjAsIDAuMDUpLm5hbWUoJ1F1YWRyYXRpYyBEcmFnJyk7CgogICAgY29uc3Qgc3BpbiA9IHBoeXMuYWRkRm9sZGVyKCdTcGluJyk7CiAgICBzcGluLmFkZChDLCAnU1BJTl9EUkFHJywgMC4wLCAzLjApLm5hbWUoJ1NwaW4gRGVjYXknKTsKCiAgICBjb25zdCBtYWdudXMgPSBwaHlzLmFkZEZvbGRlcignTWFnbnVzJyk7CiAgICBtYWdudXMuYWRkKEMsICdNQUdOVVNfRU5BQkxFRCcpLm5hbWUoJ0VuYWJsZWQnKTsKICAgIG1hZ251cy5hZGQoQywgJ01BR05VU19DT0VGRicsIDAuMCwgMC41KS5uYW1lKCdDb2VmZicpOwogICAgbWFnbnVzLmFkZChDLCAnTUFHTlVTX0NBUCcsIDAuMCwgMjAwLjApLm5hbWUoJ0NhcCcpOwoKICAgIGNvbnN0IGRlcHRoID0gcGh5cy5hZGRGb2xkZXIoJ0RlcHRoIENvbnN0cmFpbnQnKTsKICAgIGRlcHRoLmFkZChDLCAnREVQVEhfVEFSR0VUX1knLCAtNS4wLCA1LjApLm5hbWUoJ1RhcmdldCBZJyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX1NQUklORycsIDAuMCwgMTAuMCkubmFtZSgnU3ByaW5nJyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX0RBTVAnLCAwLjAsIDYuMCkubmFtZSgnRGFtcCcpOwoKICAgIGNvbnN0IGFyZW5hID0gcGh5cy5hZGRGb2xkZXIoJ0FyZW5hIEJvdW5kYXJ5Jyk7CiAgICBhcmVuYS5hZGQoQywgJ0JPVU5EQVJZX1JBRElVUycsIDEwLjAsIDEyMC4wKS5uYW1lKCdSYWRpdXMnKTsKICAgIGFyZW5hLmFkZChDLCAnQk9VTkRBUllfSEVJR0hUJywgMi4wLCA0MC4wKS5uYW1lKCdIZWlnaHQnKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9TT0ZUX0JVRkZFUicsIDAuMCwgMjAuMCkubmFtZSgnU29mdCBCdWZmZXInKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9TT0ZUX0ZPUkNFJywgMC4wLCAyMDAuMCkubmFtZSgnU29mdCBGb3JjZScpOwogICAgYXJlbmEuYWRkKEMsICdXQUxMX0VMQVNUSUNJVFknLCAwLjAsIDEuMCkubmFtZSgnV2FsbCBCb3VuY2UnKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9GUklDVElPTicsIDAuMCwgMS4wKS5uYW1lKCdXYWxsIEZyaWN0aW9uJyk7CiAgICBhcmVuYS5hZGQoQywgJ0ZMT09SX0VMQVNUSUNJVFknLCAwLjAsIDEuMCkubmFtZSgnQ2VpbC9GbG9vciBCb3VuY2UnKTsKCiAgICBjb25zdCBwb2NrZXQgPSBhcmVuYS5hZGRGb2xkZXIoJ0dvYWwgUG9ja2V0Jyk7CiAgICBwb2NrZXQuYWRkKEMsICdHT0FMX1BPQ0tFVF9FTkFCTEVEJykubmFtZSgnRW5hYmxlZCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfWCcsIDAuMCwgNDAuMCkubmFtZSgnUG9ja2V0IEhhbGYtWCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfWicsIDAuMCwgNTAuMCkubmFtZSgnUG9ja2V0IFN0YXJ0IHxafCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfUkFESVVTJywgMTAuMCwgMTIwLjApLm5hbWUoJ1BvY2tldCBSYWRpdXMnKTsKCiAgICBjb25zdCBsYXVuY2ggPSBwaHlzLmFkZEZvbGRlcignTGF1bmNoIE1hcHBpbmcnKTsKICAgIGxhdW5jaC5hZGQoQywgJ0xBVU5DSF9TUEVFRF9TQ0FMRScsIDAuMSwgNS4wKS5uYW1lKCdTcGVlZCBTY2FsZScpOwogICAgbGF1bmNoLmFkZChDLCAnTEFVTkNIX1NQRUVEX0NBUCcsIDEwLjAsIDIwMC4wKS5uYW1lKCdTcGVlZCBDYXAnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogVGhyb3cgbWFwcGluZyAoUGxheWVyLnJlbGVhc2VDaGFyZ2UgLT4gQmFsbC5zaG9vdCkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgdGhyb3dNYXAgPSByb290LmFkZEZvbGRlcignVGhyb3cgTWFwcGluZyAoVGhyb3dDb25maWcpJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdTV0lQRV9NSU5fUFgnLCAwLCAxMjAsIDEpLm5hbWUoJ1N3aXBlIE1pbiBQWCcpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnQUlNX0RYX1NDQUxFJywgMC4xLCA1LjApLm5hbWUoJ0FpbSBYIFNjYWxlJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdBSU1fRFlfU0NBTEUnLCAwLjEsIDUuMCkubmFtZSgnQWltIFkgU2NhbGUnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX0JBU0UnLCAwLjEsIDMuMCkubmFtZSgnUG93ZXIgQmFzZScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnUE9XRVJfUkFOR0UnLCAwLjAsIDMuMCkubmFtZSgnUG93ZXIgUmFuZ2UnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX01BWF9CT05VU19SQVRJTycsIDAuMCwgMS4wKS5uYW1lKCdNYXggQm9udXMgUmF0aW8nKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX01BWF9NVUxUSVBMSUVSJywgMS4wLCA2LjApLm5hbWUoJ01heCBNdWx0aXBsaWVyJyk7CgogICAgY29uc3QgY3VydmVNYXAgPSB0aHJvd01hcC5hZGRGb2xkZXIoJ0N1cnZlJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9FTkFCTEVEJykubmFtZSgnRW5hYmxlZCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRCcsIDAuMCwgMS4wKS5uYW1lKCdJbnB1dCBUaHJlc2hvbGQnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX1NQSU5fU0NBTEUnLCAwLjAsIDQwMDAuMCkubmFtZSgnU3BpbiBTY2FsZScpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfU1BFRURfTVVMVCcsIDAuMCwgNS4wKS5uYW1lKCdTd2lwZSBTcGVlZCBNdWx0Jyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9TUElOX0NBUCcsIDAuMCwgNjAwMC4wKS5uYW1lKCdTcGluIENhcCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfUEVSRkVDVF9TUElOJywgMC4wLCAyMDAwLjApLm5hbWUoJ1BlcmZlY3QgVGhyZXNob2xkJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFRlbGVwb3J0IC8gU3RhdGUgdG9vbHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgdHAgPSByb290LmFkZEZvbGRlcignVGVsZXBvcnQgLyBSZXNldCcpOwogICAgY29uc3QgdHBQYXJhbXMgPSB7CiAgICAgICAgVG9DZW50ZXI6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgaWYgKGIpIGIucmVzZXQoKTsgfSwKICAgICAgICBUb0FjdGl2ZVBsYXllcjogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBjb25zdCBwID0gZ2V0QWN0aXZlKCk7IGlmIChiICYmIHApIGIuZ3JhYihwKTsgfSwKICAgICAgICBUb0hvbWVHb2FsOiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGlmIChiKSB7IGIuZHJvcCgpOyBiLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDI1KTsgYi52ZWxvY2l0eS5zZXQoMCwwLDApOyBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOyB9IH0sCiAgICAgICAgVG9Bd2F5R29hbDogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMjUpOyBiLnZlbG9jaXR5LnNldCgwLDAsMCk7IGIuYW5ndWxhclZlbG9jaXR5LnNldCgwLDAsMCk7IH0gfSwKICAgICAgICBUb1NreTogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAxMCwgMCk7IGIudmVsb2NpdHkuc2V0KDAsMCwwKTsgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsgfSB9LAogICAgICAgIENsZWFyUHJldmlldzogKCkgPT4gY2xlYXJQcmV2aWV3TGluZSgpCiAgICB9OwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9DZW50ZXInKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvQWN0aXZlUGxheWVyJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0hvbWVHb2FsJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0F3YXlHb2FsJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb1NreScpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnQ2xlYXJQcmV2aWV3Jyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFNob3QgQ2Fubm9uIChmb3JjZSBmaXJlIHdpdGggcGFyYW1zKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBjYW5ub24gPSByb290LmFkZEZvbGRlcignU2hvdCBDYW5ub24nKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3lhdycsIC0xODAsIDE4MCwgMSkubmFtZSgnWWF3IChkZWcpJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdwaXRjaCcsIC04OSwgODksIDEpLm5hbWUoJ1BpdGNoIChkZWcpJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdwb3dlcicsIDAsIDEyMCwgMC4xKS5uYW1lKCdQb3dlcicpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAndHlwZScsIFsnUEEnLCdTSCddKS5uYW1lKCdUeXBlJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcGluWCcsIC0zMDAwLCAzMDAwLCAxKS5uYW1lKCdTcGluIFgnKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwaW5ZJywgLTMwMDAsIDMwMDAsIDEpLm5hbWUoJ1NwaW4gWScpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnc3BpblonLCAtMzAwMCwgMzAwMCwgMSkubmFtZSgnU3BpbiBaJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdmaXJlQnVyc3QnLCAxLCAxMCwgMSkubmFtZSgnQnVyc3QgQ291bnQnKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwcmVhZERlZycsIDAsIDMwLCAwLjUpLm5hbWUoJ1NwcmVhZCAoZGVnKScpOwoKICAgIGNvbnN0IGZpcmVQYXJhbXMgPSB7CiAgICAgICAgRmlyZTogKCkgPT4gewogICAgICAgICAgICBjb25zdCBiID0gZ2V0QmFsbCgpOwogICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgIGlmICghYikgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgeWF3UmFkID0gKGxhYi5jYW5ub24ueWF3IHx8IDApICogTWF0aC5QSSAvIDE4MDsKICAgICAgICAgICAgY29uc3QgcGl0Y2hSYWQgPSAobGFiLmNhbm5vbi5waXRjaCB8fCAwKSAqIE1hdGguUEkgLyAxODA7CgogICAgICAgICAgICBjb25zdCBiYXNlRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICBNYXRoLnNpbih5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpLAogICAgICAgICAgICAgICAgTWF0aC5zaW4ocGl0Y2hSYWQpLAogICAgICAgICAgICAgICAgLU1hdGguY29zKHlhd1JhZCkgKiBNYXRoLmNvcyhwaXRjaFJhZCkKICAgICAgICAgICAgKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gKGIuc3RhdGUgPT09ICdoZWxkJyAmJiBwICYmIHAubWVzaCkgPyBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMS4yLCAwKSkgOiBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKCiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgKGxhYi5jYW5ub24uZmlyZUJ1cnN0IHx8IDEpOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IGJhc2VEaXIuY2xvbmUoKTsKICAgICAgICAgICAgICAgIGlmIChsYWIuY2Fubm9uLnNwcmVhZERlZyA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcHJlYWQgPSAobGFiLmNhbm5vbi5zcHJlYWREZWcgKiBNYXRoLlBJIC8gMTgwKTsKICAgICAgICAgICAgICAgICAgICBkaXIueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogc3ByZWFkOwogICAgICAgICAgICAgICAgICAgIGRpci55ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcHJlYWQ7CiAgICAgICAgICAgICAgICAgICAgZGlyLnogKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIHNwcmVhZDsKICAgICAgICAgICAgICAgICAgICBkaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYi5kcm9wKCk7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24uY29weShzdGFydCk7CiAgICAgICAgICAgICAgICBiLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOwoKICAgICAgICAgICAgICAgIGNvbnN0IHNwaW4gPSBuZXcgVEhSRUUuVmVjdG9yMyhsYWIuY2Fubm9uLnNwaW5YIHx8IDAsIGxhYi5jYW5ub24uc3BpblkgfHwgMCwgbGFiLmNhbm5vbi5zcGluWiB8fCAwKTsKICAgICAgICAgICAgICAgIGIuc2hvb3QoZGlyLCBsYWIuY2Fubm9uLnBvd2VyIHx8IDIwLCBsYWIuY2Fubm9uLnR5cGUgfHwgJ1NIJywgbnVsbCwgc3Bpbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgY2Fubm9uLmFkZChmaXJlUGFyYW1zLCAnRmlyZScpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBUcmFqZWN0b3J5IFByZXZpZXcKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcHJldmlldyA9IHJvb3QuYWRkRm9sZGVyKCdUcmFqZWN0b3J5IFByZXZpZXcnKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnZW5hYmxlZCcpLm5hbWUoJ0VuYWJsZWQnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3NvdXJjZScsIFsnQ2Fubm9uJywgJ0xpdmUgQmFsbCddKS5uYW1lKCdTb3VyY2UnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3N0ZXBzJywgMTAsIDYwMCwgMSkubmFtZSgnU3RlcHMnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3N0ZXBEdCcsIDEvMjQwLCAxLzE1LCAxLzI0MCkubmFtZSgnU3RlcCBkdCcpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAncmVmcmVzaEh6JywgMSwgNjAsIDEpLm5hbWUoJ1JlZnJlc2ggSHonKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc2hvd09uSGVsZE9ubHknKS5uYW1lKCdPbmx5IHdoZW4gSGVsZCcpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKCiAgICBjb25zdCBwcmV2aWV3QnRucyA9IHsKICAgICAgICBSZWZyZXNoOiAoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSwKICAgICAgICBIaWRlOiAoKSA9PiB7IGxhYi5wcmV2aWV3LmVuYWJsZWQgPSBmYWxzZTsgY2xlYXJQcmV2aWV3TGluZSgpOyB9CiAgICB9OwogICAgcHJldmlldy5hZGQocHJldmlld0J0bnMsICdSZWZyZXNoJyk7CiAgICBwcmV2aWV3LmFkZChwcmV2aWV3QnRucywgJ0hpZGUnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogUmVjb3JkIC8gUmVwbGF5CiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHJyID0gcm9vdC5hZGRGb2xkZXIoJ1JlY29yZCAvIFJlcGxheScpOwogICAgY29uc3QgcnJQYXJhbXMgPSB7CiAgICAgICAgUmVjb3JkOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcgPSB0cnVlOwogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmZyYW1lcyA9IFtdOwogICAgICAgIH0sCiAgICAgICAgU3RvcDogKCkgPT4gewogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmlzUmVjb3JkaW5nID0gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICBVc2VSZWNvcmRpbmdGb3JSZXBsYXk6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlcGxheS5mcmFtZXMgPSAobGFiLnJlY29yZGluZy5mcmFtZXMgfHwgW10pLnNsaWNlKCk7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaWR4ID0gMDsKICAgICAgICB9LAogICAgICAgIFBsYXk6ICgpID0+IHsKICAgICAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICAgICAgaWYgKCFiKSByZXR1cm47CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaXNSZXBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICBsYWIudGFyZ2V0QmFsbCA9IGI7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaWR4ID0gMDsKICAgICAgICB9LAogICAgICAgIFBhdXNlOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgbGFiLmlzUmVwbGF5aW5nID0gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICBDbGVhcjogKCkgPT4gewogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmZyYW1lcyA9IFtdOwogICAgICAgICAgICBsYWIucmVwbGF5LmZyYW1lcyA9IFtdOwogICAgICAgICAgICBsYWIucmVwbGF5LmlkeCA9IDA7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgbGFiLmlzUmVwbGF5aW5nID0gZmFsc2U7CiAgICAgICAgfQogICAgfTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1JlY29yZCcpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnU3RvcCcpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnVXNlUmVjb3JkaW5nRm9yUmVwbGF5JykubmFtZSgnQ29weSBSZWMgLT4gUmVwbGF5Jyk7CiAgICByci5hZGQobGFiLnJlcGxheSwgJ2xvb3AnKS5uYW1lKCdMb29wJyk7CiAgICByci5hZGQobGFiLnJlcGxheSwgJ3NwZWVkJywgMC4yNSwgNi4wLCAwLjI1KS5uYW1lKCdSZXBsYXkgU3BlZWQnKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1BsYXknKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1BhdXNlJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdDbGVhcicpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBQcmVzZXRzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHByZXNldHMgPSByb290LmFkZEZvbGRlcignUHJlc2V0cycpOwogICAgY29uc3QgUCA9IHsKICAgICAgICBWYW5pbGxhOiAoKSA9PiB7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oQywgewogICAgICAgICAgICAgICAgU1VCU1RFUFM6IDIsCiAgICAgICAgICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMTUsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX1FVQUQ6IDAuMDAyLAogICAgICAgICAgICAgICAgU1BJTl9EUkFHOiAwLjQwLAogICAgICAgICAgICAgICAgTUFHTlVTX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ09FRkY6IDAuMDgsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ0FQOiA2MC4wLAogICAgICAgICAgICAgICAgREVQVEhfVEFSR0VUX1k6IDAuMCwKICAgICAgICAgICAgICAgIERFUFRIX1NQUklORzogMS4wLAogICAgICAgICAgICAgICAgREVQVEhfREFNUDogMS41LAogICAgICAgICAgICAgICAgQk9VTkRBUllfUkFESVVTOiAzMy4wLAogICAgICAgICAgICAgICAgQk9VTkRBUllfSEVJR0hUOiAxNS4wLAogICAgICAgICAgICAgICAgV0FMTF9TT0ZUX0JVRkZFUjogMy4wLAogICAgICAgICAgICAgICAgV0FMTF9TT0ZUX0ZPUkNFOiAyMC4wLAogICAgICAgICAgICAgICAgV0FMTF9FTEFTVElDSVRZOiAwLjMwLAogICAgICAgICAgICAgICAgV0FMTF9GUklDVElPTjogMC45NSwKICAgICAgICAgICAgICAgIEZMT09SX0VMQVNUSUNJVFk6IDAuNDAsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgR09BTF9QT0NLRVRfWDogMTIuMCwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX1o6IDI1LjAsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9SQURJVVM6IDQ1LjAsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfU0NBTEU6IDEuMCwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDg1LjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0sCiAgICAgICAgQXJjYWRlQ3VydmU6ICgpID0+IHsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihDLCB7CiAgICAgICAgICAgICAgICBNQUdOVVNfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIE1BR05VU19DT0VGRjogMC4xNiwKICAgICAgICAgICAgICAgIE1BR05VU19DQVA6IDkwLjAsCiAgICAgICAgICAgICAgICBTUElOX0RSQUc6IDAuMjUsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX0xJTkVBUjogMC4xMiwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDEsCiAgICAgICAgICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDM1LjAsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfQ0FQOiAxMTAuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihUQywgewogICAgICAgICAgICAgICAgQ1VSVkVfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIENVUlZFX1NQSU5fU0NBTEU6IDE1MDAuMCwKICAgICAgICAgICAgICAgIENVUlZFX1NQSU5fQ0FQOiAzMDAwLjAsCiAgICAgICAgICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDcwMC4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsYWIucmVmcmVzaFByZXZpZXcoKTsKICAgICAgICB9LAogICAgICAgIFNuYXBweVJlYWxpc3RpYzogKCkgPT4gewogICAgICAgICAgICBPYmplY3QuYXNzaWduKEMsIHsKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfTElORUFSOiAwLjI1LAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19RVUFEOiAwLjAwNiwKICAgICAgICAgICAgICAgIE1BR05VU19DT0VGRjogMC4wNSwKICAgICAgICAgICAgICAgIE1BR05VU19DQVA6IDQwLjAsCiAgICAgICAgICAgICAgICBTUElOX0RSQUc6IDAuNzUsCiAgICAgICAgICAgICAgICBTVE9QX1NQRUVEOiAwLjA1LAogICAgICAgICAgICAgICAgTEFVTkNIX1NQRUVEX0NBUDogNzAuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfQogICAgfTsKICAgIHByZXNldHMuYWRkKFAsICdWYW5pbGxhJyk7CiAgICBwcmVzZXRzLmFkZChQLCAnQXJjYWRlQ3VydmUnKTsKICAgIHByZXNldHMuYWRkKFAsICdTbmFwcHlSZWFsaXN0aWMnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogU25hcHNob3QgLyBFeHBvcnQKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3Qgc25hcHNob3QgPSByb290LmFkZEZvbGRlcignU25hcHNob3QgLyBFeHBvcnQnKTsKCiAgICBjb25zdCBfcm91bmQgPSAobiwgcGxhY2VzID0gNCkgPT4gewogICAgICAgIGlmICghTnVtYmVyLmlzRmluaXRlKG4pKSByZXR1cm4gbnVsbDsKICAgICAgICBjb25zdCBwID0gTWF0aC5wb3coMTAsIHBsYWNlcyk7CiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQobiAqIHApIC8gcDsKICAgIH07CgogICAgY29uc3QgX3YzID0gKHYsIHBsYWNlcyA9IDQpID0+IHsKICAgICAgICBpZiAoIXYpIHJldHVybiBudWxsOwogICAgICAgIHJldHVybiBbX3JvdW5kKHYueCwgcGxhY2VzKSwgX3JvdW5kKHYueSwgcGxhY2VzKSwgX3JvdW5kKHYueiwgcGxhY2VzKV07CiAgICB9OwoKICAgIGNvbnN0IF9jbG9uZUpzb24gPSAob2JqKSA9PiB7CiAgICAgICAgaWYgKCFvYmopIHJldHVybiBudWxsOwogICAgICAgIHRyeSB7IHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KG9iaikpOyB9IGNhdGNoIChlKSB7IHJldHVybiBudWxsOyB9CiAgICB9OwoKICAgIGNvbnN0IF9wbGF5ZXJTbmFwID0gKHApID0+IHsKICAgICAgICBpZiAoIXApIHJldHVybiBudWxsOwogICAgICAgIGNvbnN0IGFuaW0gPSAocC5hY3RpdmVBY3Rpb24gJiYgcC5hY3RpdmVBY3Rpb24uX2NsaXApID8gcC5hY3RpdmVBY3Rpb24uX2NsaXAubmFtZSA6IChwLnN0YXRlIHx8IG51bGwpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG5hbWU6IHAuY2hhcmFjdGVyTmFtZSB8fCBwLm5hbWUgfHwgbnVsbCwKICAgICAgICAgICAgcm9sZTogcC5yb2xlIHx8IG51bGwsCiAgICAgICAgICAgIHN0YXRlOiBwLnN0YXRlIHx8IG51bGwsCiAgICAgICAgICAgIGhhc0JhbGw6ICEhcC5oYXNCYWxsLAogICAgICAgICAgICBpc1Rocm93aW5nOiAhIXAuaXNUaHJvd2luZywKICAgICAgICAgICAgaXNDaGFyZ2luZzogISFwLmlzQ2hhcmdpbmcsCiAgICAgICAgICAgIGlzRGFzaGluZzogISFwLmlzRGFzaGluZywKICAgICAgICAgICAgZGFzaENvb2xkb3duOiBfcm91bmQocC5kYXNoQ29vbGRvd24sIDQpLAogICAgICAgICAgICBwb3M6IF92MyhwLm1lc2ggJiYgcC5tZXNoLnBvc2l0aW9uKSwKICAgICAgICAgICAgdmVsOiBfdjMocC52ZWxvY2l0eSksCiAgICAgICAgICAgIGlucHV0OiBfdjMocC5pbnB1dFZlY3RvciksCiAgICAgICAgICAgIHN0YXRzOiBwLnN0YXRzID8gX2Nsb25lSnNvbihwLnN0YXRzKSA6IG51bGwsCiAgICAgICAgICAgIGFuaW0KICAgICAgICB9OwogICAgfTsKCiAgICBjb25zdCBfdGVhbVNuYXAgPSAodCkgPT4gewogICAgICAgIGlmICghdCkgcmV0dXJuIG51bGw7CiAgICAgICAgY29uc3QgYWN0aXZlID0gdC5hY3RpdmVQbGF5ZXIgPyBfcGxheWVyU25hcCh0LmFjdGl2ZVBsYXllcikgOiBudWxsOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGlkOiB0LmlkIHx8IG51bGwsCiAgICAgICAgICAgIHNpZGU6IHQuc2lkZSwKICAgICAgICAgICAgaXNIdW1hbjogISF0LmlzSHVtYW4sCiAgICAgICAgICAgIGFpRW5hYmxlZDogISF0LmFpRW5hYmxlZCwKICAgICAgICAgICAgY3VycmVudEZvcm1hdGlvbjogdC5jdXJyZW50Rm9ybWF0aW9uIHx8IG51bGwsCiAgICAgICAgICAgIGFjdGl2ZVBsYXllcjogYWN0aXZlLAogICAgICAgICAgICBwbGF5ZXJzOiBBcnJheS5pc0FycmF5KHQucGxheWVycykgPyB0LnBsYXllcnMubWFwKF9wbGF5ZXJTbmFwKSA6IFtdCiAgICAgICAgfTsKICAgIH07CgogICAgY29uc3QgYnVpbGRTbmFwc2hvdCA9ICgpID0+IHsKICAgICAgICBjb25zdCBnYW1lID0gdGhpcy5nYW1lIHx8IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSB8fCBudWxsOwogICAgICAgIGNvbnN0IGJhbGwgPSBnYW1lICYmIGdhbWUuZW50aXRpZXMgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgIGNvbnN0IGNhbU1nciA9IGdhbWUgPyBnYW1lLmNhbWVyYU1hbmFnZXIgOiBudWxsOwogICAgICAgIGNvbnN0IGNhbSA9IChjYW1NZ3IgJiYgY2FtTWdyLmNhbWVyYSkgPyBjYW1NZ3IuY2FtZXJhIDogKGdhbWUgPyBnYW1lLmNhbWVyYSA6IG51bGwpOwoKICAgICAgICBjb25zdCBiYWxsU25hcCA9IGJhbGwgPyB7CiAgICAgICAgICAgIHN0YXRlOiBiYWxsLnN0YXRlIHx8IG51bGwsCiAgICAgICAgICAgIGlzSW52aXNpYmxlOiAhIWJhbGwuaXNJbnZpc2libGUsCiAgICAgICAgICAgIGhvbGRlcjogYmFsbC5ob2xkZXIgPyAoYmFsbC5ob2xkZXIuY2hhcmFjdGVyTmFtZSB8fCBiYWxsLmhvbGRlci5uYW1lIHx8IG51bGwpIDogbnVsbCwKICAgICAgICAgICAgbGFzdEhvbGRlcjogYmFsbC5sYXN0SG9sZGVyID8gKGJhbGwubGFzdEhvbGRlci5jaGFyYWN0ZXJOYW1lIHx8IGJhbGwubGFzdEhvbGRlci5uYW1lIHx8IG51bGwpIDogbnVsbCwKICAgICAgICAgICAgcG9zOiBfdjMoYmFsbC5tZXNoICYmIGJhbGwubWVzaC5wb3NpdGlvbiksCiAgICAgICAgICAgIHZlbDogX3YzKGJhbGwudmVsb2NpdHkpLAogICAgICAgICAgICBhbmdWZWw6IF92MyhiYWxsLmFuZ3VsYXJWZWxvY2l0eSksCiAgICAgICAgICAgIHBvd2VyOiBfcm91bmQoYmFsbC5wb3dlciwgNCksCiAgICAgICAgICAgIHNob3RUeXBlOiBiYWxsLnNob3RUeXBlIHx8IG51bGwKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgY29uc3QgY2FtZXJhU25hcCA9IGNhbSA/IHsKICAgICAgICAgICAgcG9zOiBfdjMoY2FtLnBvc2l0aW9uKSwKICAgICAgICAgICAgcm90OiBjYW0ucm90YXRpb24gPyBbX3JvdW5kKGNhbS5yb3RhdGlvbi54LCA0KSwgX3JvdW5kKGNhbS5yb3RhdGlvbi55LCA0KSwgX3JvdW5kKGNhbS5yb3RhdGlvbi56LCA0KV0gOiBudWxsLAogICAgICAgICAgICBmb3Y6IF9yb3VuZChjYW0uZm92LCA0KSwKICAgICAgICAgICAgbmVhcjogX3JvdW5kKGNhbS5uZWFyLCA2KSwKICAgICAgICAgICAgZmFyOiBfcm91bmQoY2FtLmZhciwgNCkKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgY29uc3QgY2FtTWdyU25hcCA9IGNhbU1nciA/IHsKICAgICAgICAgICAgbW9kZTogY2FtTWdyLm1vZGUgfHwgbnVsbCwKICAgICAgICAgICAgdGFyZ2V0TmFtZTogKGNhbU1nci50YXJnZXQgJiYgKGNhbU1nci50YXJnZXQuY2hhcmFjdGVyTmFtZSB8fCBjYW1NZ3IudGFyZ2V0Lm5hbWUpKSB8fCBudWxsLAogICAgICAgICAgICBzZXR0aW5nczogY2FtTWdyLnNldHRpbmdzID8gX2Nsb25lSnNvbihjYW1NZ3Iuc2V0dGluZ3MpIDogbnVsbAogICAgICAgIH0gOiBudWxsOwoKICAgICAgICBjb25zdCBkZWJ1Z0lPID0gd2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX2RlYnVnSU8gPyB3aW5kb3cuZmx1eC5fZGVidWdJTyA6IG51bGw7CiAgICAgICAgY29uc3QgaW5wdXRTbmFwID0gZGVidWdJTyA/IHsKICAgICAgICAgICAgc2V0dGluZ3M6IGRlYnVnSU8uc2V0dGluZ3MgPyBfY2xvbmVKc29uKGRlYnVnSU8uc2V0dGluZ3MpIDogbnVsbCwKICAgICAgICAgICAgcGVyZjogZGVidWdJTy5wZXJmID8gX2Nsb25lSnNvbihkZWJ1Z0lPLnBlcmYpIDogbnVsbCwKICAgICAgICAgICAgbW92ZTogKGRlYnVnSU8uaW5wdXQgJiYgZGVidWdJTy5pbnB1dC5tb3ZlKSA/IHsKICAgICAgICAgICAgICAgIHRvdWNoSWQ6IGRlYnVnSU8uaW5wdXQubW92ZS50b3VjaElkID8/IG51bGwsCiAgICAgICAgICAgICAgICBkcmFnZ2luZzogISFkZWJ1Z0lPLmlucHV0Lm1vdmUuZHJhZ2dpbmcsCiAgICAgICAgICAgICAgICB2ZWN0b3I6IGRlYnVnSU8uaW5wdXQubW92ZS52ZWN0b3IgPyBfY2xvbmVKc29uKGRlYnVnSU8uaW5wdXQubW92ZS52ZWN0b3IpIDogbnVsbAogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgYWltOiAoZGVidWdJTy5pbnB1dCAmJiBkZWJ1Z0lPLmlucHV0LmFpbSkgPyB7CiAgICAgICAgICAgICAgICB0b3VjaElkOiBkZWJ1Z0lPLmlucHV0LmFpbS50b3VjaElkID8/IG51bGwsCiAgICAgICAgICAgICAgICBkcmFnZ2luZzogISFkZWJ1Z0lPLmlucHV0LmFpbS5kcmFnZ2luZywKICAgICAgICAgICAgICAgIHZlY3RvcjogZGVidWdJTy5pbnB1dC5haW0udmVjdG9yID8gX2Nsb25lSnNvbihkZWJ1Z0lPLmlucHV0LmFpbS52ZWN0b3IpIDogbnVsbAogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgc3dpcGU6IChkZWJ1Z0lPLmlucHV0ICYmIGRlYnVnSU8uaW5wdXQuc3dpcGUpID8gewogICAgICAgICAgICAgICAgdG91Y2hJZDogZGVidWdJTy5pbnB1dC5zd2lwZS50b3VjaElkID8/IG51bGwsCiAgICAgICAgICAgICAgICBzdGFydDogZGVidWdJTy5pbnB1dC5zd2lwZS5zdGFydCA/IF9jbG9uZUpzb24oZGVidWdJTy5pbnB1dC5zd2lwZS5zdGFydCkgOiBudWxsLAogICAgICAgICAgICAgICAgcG9pbnRzOiBBcnJheS5pc0FycmF5KGRlYnVnSU8uaW5wdXQuc3dpcGUucG9pbnRzKSA/IGRlYnVnSU8uaW5wdXQuc3dpcGUucG9pbnRzLnNsaWNlKC0zMikubWFwKF9jbG9uZUpzb24pIDogW10KICAgICAgICAgICAgfSA6IG51bGwKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbWV0YTogewogICAgICAgICAgICAgICAgdGltZXN0YW1wSVNPOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksCiAgICAgICAgICAgICAgICBocmVmOiAodHlwZW9mIGxvY2F0aW9uICE9PSAndW5kZWZpbmVkJyAmJiBsb2NhdGlvbi5ocmVmKSA/IGxvY2F0aW9uLmhyZWYgOiBudWxsLAogICAgICAgICAgICAgICAgdXNlckFnZW50OiAodHlwZW9mIG5hdmlnYXRvciAhPT0gJ3VuZGVmaW5lZCcgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudCkgPyBuYXZpZ2F0b3IudXNlckFnZW50IDogbnVsbAogICAgICAgICAgICB9LAogICAgICAgICAgICBnYW1lOiBnYW1lID8gewogICAgICAgICAgICAgICAgc2NvcmU6IGdhbWUuc2NvcmUgPyBfY2xvbmVKc29uKGdhbWUuc2NvcmUpIDogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWU6IF9yb3VuZChnYW1lLnRpbWUsIDQpLAogICAgICAgICAgICAgICAgaGFsZjogZ2FtZS5oYWxmID8/IG51bGwsCiAgICAgICAgICAgICAgICBoYWxmRHVyYXRpb246IF9yb3VuZChnYW1lLmhhbGZEdXJhdGlvbiwgNCksCiAgICAgICAgICAgICAgICBpc092ZXJ0aW1lOiAhIWdhbWUuaXNPdmVydGltZSwKICAgICAgICAgICAgICAgIGlzRGVtb01vZGU6ICEhZ2FtZS5pc0RlbW9Nb2RlCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBjb25maWc6IHsKICAgICAgICAgICAgICAgIEJhbGxDb25maWc6ICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnKSA/IF9jbG9uZUpzb24od2luZG93LmZsdXguQmFsbENvbmZpZykgOiBudWxsLAogICAgICAgICAgICAgICAgVGhyb3dDb25maWc6ICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZykgPyBfY2xvbmVKc29uKHdpbmRvdy5mbHV4LlRocm93Q29uZmlnKSA6IG51bGwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2FtZXJhOiBjYW1lcmFTbmFwLAogICAgICAgICAgICBjYW1lcmFNYW5hZ2VyOiBjYW1NZ3JTbmFwLAogICAgICAgICAgICBiYWxsOiBiYWxsU25hcCwKICAgICAgICAgICAgdGVhbXM6IGdhbWUgPyB7CiAgICAgICAgICAgICAgICBob21lOiBfdGVhbVNuYXAoZ2FtZS50ZWFtcyAmJiBnYW1lLnRlYW1zLmhvbWUpLAogICAgICAgICAgICAgICAgYXdheTogX3RlYW1TbmFwKGdhbWUudGVhbXMgJiYgZ2FtZS50ZWFtcy5hd2F5KQogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgaW5wdXQ6IGlucHV0U25hcAogICAgICAgIH07CiAgICB9OwoKICAgIGNvbnN0IF9jb3B5VGV4dCA9IGFzeW5jICh0ZXh0KSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKG5hdmlnYXRvci5jbGlwYm9hcmQgJiYgbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQpIHsKICAgICAgICAgICAgICAgIGF3YWl0IG5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KHRleHQpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIC8vIEZhbGxiYWNrCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgdGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZXh0YXJlYScpOwogICAgICAgICAgICB0YS52YWx1ZSA9IHRleHQ7CiAgICAgICAgICAgIHRhLnN0eWxlLnBvc2l0aW9uID0gJ2ZpeGVkJzsKICAgICAgICAgICAgdGEuc3R5bGUubGVmdCA9ICctOTk5OXB4JzsKICAgICAgICAgICAgdGEuc3R5bGUudG9wID0gJy05OTk5cHgnOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRhKTsKICAgICAgICAgICAgdGEuZm9jdXMoKTsKICAgICAgICAgICAgdGEuc2VsZWN0KCk7CiAgICAgICAgICAgIGNvbnN0IG9rID0gZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0YSk7CiAgICAgICAgICAgIHJldHVybiBvazsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CgogICAgY29uc3QgX2Rvd25sb2FkVGV4dCA9IChmaWxlbmFtZSwgdGV4dCkgPT4gewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbdGV4dF0sIHsgdHlwZTogJ2FwcGxpY2F0aW9uL2pzb24nIH0pOwogICAgICAgICAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOwogICAgICAgICAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgICAgICBhLmhyZWYgPSB1cmw7CiAgICAgICAgICAgIGEuZG93bmxvYWQgPSBmaWxlbmFtZTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhKTsKICAgICAgICAgICAgYS5jbGljaygpOwogICAgICAgICAgICBhLnJlbW92ZSgpOwogICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKHVybCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1NuYXBzaG90IGRvd25sb2FkIGZhaWxlZDonLCBlKTsKICAgICAgICB9CiAgICB9OwoKICAgIGNvbnN0IHNuYXBzaG90QWN0aW9ucyA9IHsKICAgICAgICBDb3B5U25hcHNob3Q6IGFzeW5jICgpID0+IHsKICAgICAgICAgICAgY29uc3Qgc25hcCA9IGJ1aWxkU25hcHNob3QoKTsKICAgICAgICAgICAgY29uc3QgdGV4dCA9IEpTT04uc3RyaW5naWZ5KHNuYXAsIG51bGwsIDIpOwogICAgICAgICAgICBjb25zdCBvayA9IGF3YWl0IF9jb3B5VGV4dCh0ZXh0KTsKICAgICAgICAgICAgY29uc29sZS5sb2coJ1tTbmFwc2hvdF0nLCBzbmFwKTsKICAgICAgICAgICAgaWYgKCFvaykgY29uc29sZS53YXJuKCdTbmFwc2hvdDogY29weSBmYWlsZWQgKHNlZSBjb25zb2xlKS4nKTsKICAgICAgICB9LAogICAgICAgIERvd25sb2FkU25hcHNob3Q6ICgpID0+IHsKICAgICAgICAgICAgY29uc3Qgc25hcCA9IGJ1aWxkU25hcHNob3QoKTsKICAgICAgICAgICAgY29uc3QgdGV4dCA9IEpTT04uc3RyaW5naWZ5KHNuYXAsIG51bGwsIDIpOwogICAgICAgICAgICBfZG93bmxvYWRUZXh0KCdzbmFwc2hvdC5qc29uJywgdGV4dCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbU25hcHNob3RdJywgc25hcCk7CiAgICAgICAgfQogICAgfTsKCiAgICBzbmFwc2hvdC5hZGQoc25hcHNob3RBY3Rpb25zLCAnQ29weVNuYXBzaG90JykubmFtZSgnQ29weSBKU09OIFNuYXBzaG90Jyk7CiAgICBzbmFwc2hvdC5hZGQoc25hcHNob3RBY3Rpb25zLCAnRG93bmxvYWRTbmFwc2hvdCcpLm5hbWUoJ0Rvd25sb2FkIHNuYXBzaG90Lmpzb24nKTsKCn0KICAgIH0KCndpbmRvdy5mbHV4LkRldlRvb2xzID0gRGV2VG9vbHM7CgpEZXZUb29scy5wcm90b3R5cGUuX3NldHVwVmlzdWFsRGVidWcgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1Zpc3VhbCBEZWJ1Z2dpbmcnKTsKICAgICAgICBjb25zdCBkdiA9IHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXI7CiAgICAgICAgaWYgKCFkdikgcmV0dXJuOwoKICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIGVuYWJsZWQ6IGR2LmVuYWJsZWQsCiAgICAgICAgICAgIGhpdGJveGVzOiBkdi5zaG93SGl0Ym94ZXMsCiAgICAgICAgICAgIHZlY3RvcnM6IGR2LnNob3dWZWN0b3JzLAogICAgICAgICAgICBhaTogZHYuc2hvd0FJLAogICAgICAgICAgICBnb2FsVm9sdW1lOiBkdi5zaG93R29hbFZvbHVtZQogICAgICAgIH07CgogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZW5hYmxlZCcpLm5hbWUoJ0VuYWJsZSBWaXN1YWxpemVyJykub25DaGFuZ2UodiA9PiBkdi5lbmFibGVkID0gdik7CiAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdoaXRib3hlcycpLm5hbWUoJ1Nob3cgSGl0Ym94ZXMnKS5vbkNoYW5nZSh2ID0+IGR2LnNob3dIaXRib3hlcyA9IHYpOwogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndmVjdG9ycycpLm5hbWUoJ1Nob3cgVmVjdG9ycycpLm9uQ2hhbmdlKHYgPT4gZHYuc2hvd1ZlY3RvcnMgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2FpJykubmFtZSgnU2hvdyBBSSBQZXJjZXB0aW9uJykub25DaGFuZ2UodiA9PiBkdi5zaG93QUkgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2dvYWxWb2x1bWUnKS5uYW1lKCdTaG93IEdvYWwgVm9sdW1lJykub25DaGFuZ2UodiA9PiBkdi5zaG93R29hbFZvbHVtZSA9IHYpOwogICAgfTsKCiAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwRlhMYWIgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0ZYIExhYiAmIFVJIFRlc3QnKTsKICAgICAgICAKICAgICAgICBjb25zdCBnZXRUYXJnZXRQb3MgPSAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIHJldHVybiBwICYmIHAubWVzaCA/IHAubWVzaC5wb3NpdGlvbiA6IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDIsIDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGZ4UGFyYW1zID0gewogICAgICAgICAgICBTcGF3blZlbm9tOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCd2ZW5vbScsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25OYXA6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ25hcCcsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25XaXRoZXI6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3dpdGhlcicsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25MZWFybmVkOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bkNsYXNoOiAoKSA9PiB0aGlzLmdhbWUuc3Bhd25DbGFzaChnZXRUYXJnZXRQb3MoKSksCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgZnhTdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdQYXJ0aWNsZXMnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3blZlbm9tJyk7CiAgICAgICAgZnhTdWIuYWRkKGZ4UGFyYW1zLCAnU3Bhd25OYXAnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3bldpdGhlcicpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduTGVhcm5lZCcpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduQ2xhc2gnKTsKCiAgICAgICAgY29uc3QgdHh0UGFyYW1zID0gewogICAgICAgICAgICBUZXh0OiAiVEVTVCIsCiAgICAgICAgICAgIFR5cGU6ICJkYW1hZ2UiLAogICAgICAgICAgICBTcGF3bjogKCkgPT4gewogICAgICAgICAgICAgICAgaWYodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bih0eHRQYXJhbXMuVGV4dCwgZ2V0VGFyZ2V0UG9zKCksIHR4dFBhcmFtcy5UeXBlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgY29uc3QgdHh0U3ViID0gZm9sZGVyLmFkZEZvbGRlcignRmxvYXRpbmcgVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVHlwZScsIFsnZGFtYWdlJywgJ2hlYWwnLCAnc3RhdHVzJywgJ3RlY2gnLCAnY29taWMtaW1wYWN0JywgJ2NvbWljLWFjdGlvbicsICdzYXZlJywgJ2Jsb2NrJywgJ2RlZmF1bHQnXSk7CiAgICAgICAgdHh0U3ViLmFkZCh0eHRQYXJhbXMsICdTcGF3bicpLm5hbWUoJ1NwYXduIFRleHQnKTsKCiAgICAgICAgY29uc3QgY2FtUGFyYW1zID0gewogICAgICAgICAgICBTaGFrZVNtYWxsOiAoKSA9PiB0aGlzLmdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpLAogICAgICAgICAgICBTaGFrZUJpZzogKCkgPT4gdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMi4wKSwKICAgICAgICAgICAgSW1wYWN0TGlnaHQ6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMSwgJ2RlZmF1bHQnKSwKICAgICAgICAgICAgSW1wYWN0SGVhdnk6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMiwgJ2hlYXZ5JyksCiAgICAgICAgICAgIEltcGFjdFNoYXR0ZXI6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuNCwgJ3NoYXR0ZXInKSwKICAgICAgICB9OwoKICAgICAgICBjb25zdCBjYW1TdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdDYW1lcmEgJiBJbXBhY3QnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlU21hbGwnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlQmlnJyk7CiAgICAgICAgY2FtU3ViLmFkZChjYW1QYXJhbXMsICdJbXBhY3RMaWdodCcpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnSW1wYWN0SGVhdnknKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ0ltcGFjdFNoYXR0ZXInKTsKICAgIH07CgoKRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFZpc3VhbHMgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0Fzc2V0IEZvcmdlJyk7CiAgICAgICAgCiAgICAgICAgY29uc3QgZm9yZ2VTdGF0ZSA9IHsKICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgYXNzZXROYW1lOiAnVGlkdXMnLAogICAgICAgICAgICBhbmltTmFtZTogJ2lkbGUnLAogICAgICAgICAgICBwb3NYOiAwLCBwb3NZOiAwLCBwb3NaOiAwLAogICAgICAgICAgICByb3RYOiAwLCByb3RZOiAwLCByb3RaOiAwLAogICAgICAgICAgICBzY2FsZTogMS4wLAogICAgICAgICAgICBjYW1EaXN0OiA1LCBjYW1IZWlnaHQ6IDEuNSwgY2FtUm90OiAwCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgYXNzZXRzID0gewogICAgICAgICAgICAnVGlkdXMnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2RhNzg4YmVmMjU4YzRmMGI4ZDllZjFhY2MxOWM1NTY3LmdsYicsCiAgICAgICAgICAgICdXYWtrYSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJywKICAgICAgICAgICAgJ0xldHR5JzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy80M2FjZTM0YzZmZDk0MjE1OTY3ZTg0MmJmOTA5ZGE1ZS5nbGInLAogICAgICAgICAgICAnRGF0dG8nOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2U2ZDY3ZWNiMmU0YzQ3MTViZDczYTQwNzk1ZTFkM2Q1LmdsYicsCiAgICAgICAgICAgICdKYXNzdSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJywKICAgICAgICAgICAgJ0JvdHRhJzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hZDE1NWVmZWRjMGQ0OGZkYWQwOWRhM2UxY2FlOWM5Ny5nbGInLAogICAgICAgICAgICAnQmFsbCc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTIxYWU4Nzg4ZTU4NGUzNzhhNzlkOTczMmEwNzUzNTYuZ2xiJywKICAgICAgICAgICAgJ0dvYWwnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2E1MTZiZDkwZmE3YzRkZWRiNWRjYmZkZjgwM2YxM2Q1LmdsYicKICAgICAgICB9OwoKICAgICAgICBsZXQgY3VycmVudEFzc2V0ID0gbnVsbDsKCiAgICAgICAgY29uc3QgdXBkYXRlVHJhbnNmb3JtID0gKCkgPT4gewogICAgICAgICAgICBpZiAoY3VycmVudEFzc2V0KSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQucG9zaXRpb24uc2V0KGZvcmdlU3RhdGUucG9zWCwgZm9yZ2VTdGF0ZS5wb3NZLCBmb3JnZVN0YXRlLnBvc1opOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0LnJvdGF0aW9uLnNldChmb3JnZVN0YXRlLnJvdFgsIGZvcmdlU3RhdGUucm90WSwgZm9yZ2VTdGF0ZS5yb3RaKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRBc3NldC5zY2FsZS5zZXRTY2FsYXIoZm9yZ2VTdGF0ZS5zY2FsZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjb25zdCB1cGRhdGVDYW1lcmEgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghZm9yZ2VTdGF0ZS5hY3RpdmUpIHJldHVybjsKICAgICAgICAgICAgLy8gT3JiaXQgYXJvdW5kICgxMDAwLCBZLCAxMDAwKQogICAgICAgICAgICBjb25zdCBjeCA9IDEwMDAgKyBNYXRoLnNpbihmb3JnZVN0YXRlLmNhbVJvdCkgKiBmb3JnZVN0YXRlLmNhbURpc3Q7CiAgICAgICAgICAgIGNvbnN0IGN6ID0gMTAwMCArIE1hdGguY29zKGZvcmdlU3RhdGUuY2FtUm90KSAqIGZvcmdlU3RhdGUuY2FtRGlzdDsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhbWVyYS5wb3NpdGlvbi5zZXQoY3gsIGZvcmdlU3RhdGUuY2FtSGVpZ2h0LCBjeik7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW1lcmEubG9va0F0KDEwMDAsIGZvcmdlU3RhdGUucG9zWSArIDEsIDEwMDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IHBsYXlBbmltYXRpb24gPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghdGhpcy52aXpNaXhlciB8fCAhdGhpcy52aXpDbGlwcykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnZpek1peGVyLnN0b3BBbGxBY3Rpb24oKTsKICAgICAgICAgICAgaWYgKGZvcmdlU3RhdGUuYW5pbU5hbWUgPT09ICdub25lJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUgPT09IGZvcmdlU3RhdGUuYW5pbU5hbWUpOwogICAgICAgICAgICBpZiAoIWNsaXApIGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhmb3JnZVN0YXRlLmFuaW1OYW1lLnRvTG93ZXJDYXNlKCkpKTsKICAgICAgICAgICAgaWYgKGNsaXApIHRoaXMudml6TWl4ZXIuY2xpcEFjdGlvbihjbGlwKS5wbGF5KCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3Qgc3Bhd25Bc3NldCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBwcmV2aW91cwogICAgICAgICAgICB3aGlsZSh0aGlzLnZpekdyb3VwLmNoaWxkcmVuLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy52aXpHcm91cC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucmVtb3ZlKGNoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52aXpNaXhlciA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnRBc3NldCA9IG51bGw7CgogICAgICAgICAgICBjb25zdCB1cmwgPSBhc3NldHNbZm9yZ2VTdGF0ZS5hc3NldE5hbWVdOwogICAgICAgICAgICBpZiAoIXVybCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc29sZS5sb2coIkZvcmdlOiBTcGF3bmluZyIsIGZvcmdlU3RhdGUuYXNzZXROYW1lKTsKCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbCh1cmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSBhcmUgc3RpbGwgaW4gZm9yZ2UgbW9kZSBiZWZvcmUgYWRkaW5nCiAgICAgICAgICAgICAgICBpZiAoIWZvcmdlU3RhdGUuYWN0aXZlKSByZXR1cm47CgogICAgICAgICAgICAgICAgY29uc3QgbW9kZWwgPSBnbHRmLnNjZW5lOwogICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cC5hZGQobW9kZWwpOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0ID0gbW9kZWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IG1vZGVsIHRyYW5zZm9ybSByZWxhdGl2ZSB0byBncm91cAogICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIG1vZGVsLnJvdGF0aW9uLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZVRyYW5zZm9ybSgpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmLmFuaW1hdGlvbnMgJiYgZ2x0Zi5hbmltYXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpek1peGVyID0gbmV3IFRIUkVFLkFuaW1hdGlvbk1peGVyKG1vZGVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekNsaXBzID0gZ2x0Zi5hbmltYXRpb25zOwogICAgICAgICAgICAgICAgICAgIHBsYXlBbmltYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgdG9nZ2xlRm9yZ2UgPSAoaXNBY3RpdmUpID0+IHsKICAgICAgICAgICAgZm9yZ2VTdGF0ZS5hY3RpdmUgPSBpc0FjdGl2ZTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlzRm9yZ2VNb2RlID0gaXNBY3RpdmU7IC8vIENyaXRpY2FsOiBUZWxsIG1haW4uanMgdG8gc3RvcCBnYW1lIGxvb3AKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBHYW1lIFZpc2liaWxpdHkgKEhpZGUgZXZlcnl0aGluZyBpbiB0aGUgbWFpbiBhcmVuYSkKICAgICAgICAgICAgY29uc3QgZ2FtZUxheWVyID0gW3RoaXMuZ2FtZS50ZWFtcy5ob21lLCB0aGlzLmdhbWUudGVhbXMuYXdheSwgdGhpcy5nYW1lLmVudGl0aWVzLmJhbGxdOwogICAgICAgICAgICBnYW1lTGF5ZXIuZm9yRWFjaCh0ID0+IHsKICAgICAgICAgICAgICAgIGlmKHQgJiYgdC5wbGF5ZXJzKSB0LnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsgfSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmKHQgJiYgdC5tZXNoKSB0Lm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCkgd2luZG93LmZsdXguYXJlbmFNZXNoLnZpc2libGUgPSAhaXNBY3RpdmU7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIpIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLnN0YWRpdW0gJiYgdGhpcy5nYW1lLnN0YWRpdW0uY29udGFpbmVyKSB0aGlzLmdhbWUuc3RhZGl1bS5jb250YWluZXIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLndhdGVyT3ZlcmxheSAmJiB0aGlzLmdhbWUud2F0ZXJPdmVybGF5Lm1lc2gpIHRoaXMuZ2FtZS53YXRlck92ZXJsYXkubWVzaC52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBVSQogICAgICAgICAgICBjb25zdCB1aSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpOwogICAgICAgICAgICBpZih1aSkgdWkuc3R5bGUuZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2ZsZXgnOwoKICAgICAgICAgICAgaWYgKGlzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIEZvcmdlIFNjZW5lIGlmIG5lZWRlZAogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwUGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy52aXpHcm91cFBhcmVudCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucG9zaXRpb24uc2V0KDEwMDAsIDAsIDEwMDApOyAvLyBGYXIgYXdheSBmcm9tIGFyZW5hCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQodGhpcy52aXpHcm91cCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdyaWQgPSBuZXcgVEhSRUUuR3JpZEhlbHBlcigyMCwgMjAsIDB4MDBmZmZmLCAweDQ0NDQ0NCk7CiAgICAgICAgICAgICAgICAgICAgZ3JpZC5wb3NpdGlvbi5zZXQoMTAwMCwgMCwgMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQoZ3JpZCk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMudml6TGlnaHQgPSBuZXcgVEhSRUUuRGlyZWN0aW9uYWxMaWdodCgweGZmZmZmZiwgMS4wKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnBvc2l0aW9uLnNldCgxMDA1LCAxMCwgMTAwNSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZCh0aGlzLnZpekxpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekFtYmllbnQgPSBuZXcgVEhSRUUuQW1iaWVudExpZ2h0KDB4NDA0MDQwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKHRoaXMudml6QW1iaWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXBQYXJlbnQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy52aXpBbWJpZW50LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzcGF3bkFzc2V0KCk7CiAgICAgICAgICAgICAgICB1cGRhdGVDYW1lcmEoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBHYW1lCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpHcm91cFBhcmVudCkgdGhpcy52aXpHcm91cFBhcmVudC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpMaWdodCkgdGhpcy52aXpMaWdodC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpBbWJpZW50KSB0aGlzLnZpekFtYmllbnQudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYSBiYWNrIHRvIGdhbWUgdGFyZ2V0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIpIHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZm9sZGVyLmFkZChmb3JnZVN0YXRlLCAnYWN0aXZlJykubmFtZSgnRW5hYmxlIEZvcmdlJykub25DaGFuZ2UodG9nZ2xlRm9yZ2UpOwogICAgICAgIGZvbGRlci5hZGQoZm9yZ2VTdGF0ZSwgJ2Fzc2V0TmFtZScsIE9iamVjdC5rZXlzKGFzc2V0cykpLm5hbWUoJ1NlbGVjdCBBc3NldCcpLm9uQ2hhbmdlKHNwYXduQXNzZXQpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRmID0gZm9sZGVyLmFkZEZvbGRlcignVHJhbnNmb3JtJyk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NYJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NZJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NaJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdyb3RYJywgMCwgNi4yOCkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3JvdFknLCAwLCA2LjI4KS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwogICAgICAgIHRmLmFkZChmb3JnZVN0YXRlLCAncm90WicsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdzY2FsZScsIDAuMSwgMy4wKS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwoKICAgICAgICBmb2xkZXIuYWRkKGZvcmdlU3RhdGUsICdhbmltTmFtZScsIFsnbm9uZScsICdpZGxlJywgJ3N3aW0nLCAndGhyb3cnLCAnY2F0Y2gnLCAncmVhY3QnXSkubmFtZSgnQW5pbWF0aW9uJykub25DaGFuZ2UocGxheUFuaW1hdGlvbik7CgogICAgICAgIGNvbnN0IGNmID0gZm9sZGVyLmFkZEZvbGRlcignQ2FtZXJhJyk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1EaXN0JywgMiwgMTUpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1IZWlnaHQnLCAwLCAxMCkub25DaGFuZ2UodXBkYXRlQ2FtZXJhKTsKICAgICAgICBjZi5hZGQoZm9yZ2VTdGF0ZSwgJ2NhbVJvdCcsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CgogICAgICAgIC8vIEhvb2sgR2FtZSBMb29wCiAgICAgICAgY29uc3Qgb3JpZ2luYWxVcGRhdGUgPSB0aGlzLmdhbWUudXBkYXRlLmJpbmQodGhpcy5nYW1lKTsKICAgICAgICB0aGlzLmdhbWUudXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIGlmIChmb3JnZVN0YXRlLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgLy8gRm9yZ2UgTW9kZTogT25seSB1cGRhdGUgZm9yZ2UgY29tcG9uZW50cyBhbmQgcmVuZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpNaXhlcikgdGhpcy52aXpNaXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGb3JjZSBDYW1lcmEgVXBkYXRlIGhlcmUgc2luY2UgbWFpbi5qcyBsb29wIGlzIHNraXBwZWQKICAgICAgICAgICAgICAgIHVwZGF0ZUNhbWVyYSgpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucmVuZGVyZXIgJiYgdGhpcy5nYW1lLnNjZW5lICYmIHRoaXMuZ2FtZS5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIucmVuZGVyKHRoaXMuZ2FtZS5zY2VuZSwgdGhpcy5nYW1lLmNhbWVyYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOb3JtYWwgTW9kZTogUnVuIHN0YW5kYXJkIGdhbWUgdXBkYXRlCiAgICAgICAgICAgICAgICBvcmlnaW5hbFVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKfSkoKTs=","/DevTools.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFRvb2x0aXAgRGVzY3JpcHRpb25zIGZvciBMb25nLVByZXNzCiAgICBjb25zdCBUT09MVElQX0RFU0NSSVBUSU9OUyA9IHsKICAgICAgICAnU1VCU1RFUFMnOiAiUGh5c2ljcyBpdGVyYXRpb25zIHBlciBmcmFtZS4gSGlnaGVyID0gbW9yZSBzdGFibGUsIG1vcmUgQ1BVLiIsCiAgICAgICAgJ1NUT1BfU1BFRUQnOiAiVmVsb2NpdHkgdGhyZXNob2xkIGJlbG93IHdoaWNoIHRoZSBiYWxsIHNuYXBzIHRvIGEgaGFsdC4iLAogICAgICAgICdXQVRFUl9EUkFHX0xJTkVBUic6ICJCYXNlIHdhdGVyIHJlc2lzdGFuY2UuIFNsb3dzIGJhbGwgbGluZWFybHkuIiwKICAgICAgICAnV0FURVJfRFJBR19RVUFEJzogIlF1YWRyYXRpYyBkcmFnLiBTbG93cyBoaWdoLXNwZWVkIGJhbGxzIHNpZ25pZmljYW50bHkuIiwKICAgICAgICAnU1BJTl9EUkFHJzogIkhvdyBmYXN0IHRoZSBiYWxsJ3Mgc3BpbiBkZWNheXMgb3ZlciB0aW1lLiIsCiAgICAgICAgJ01BR05VU19FTkFCTEVEJzogIkVuYWJsZXMgdGhlIE1hZ251cyBlZmZlY3QgKGN1cnZlIGZyb20gc3BpbikuIiwKICAgICAgICAnTUFHTlVTX0NPRUZGJzogIlN0cmVuZ3RoIG9mIHRoZSBjdXJ2ZSBmb3JjZSByZWxhdGl2ZSB0byBzcGluL3NwZWVkLiIsCiAgICAgICAgJ01BR05VU19DQVAnOiAiTWF4aW11bSBjdXJ2ZSBmb3JjZSBhbGxvd2VkIChwcmV2ZW50cyBwaHlzaWNzIGV4cGxvc2lvbnMpLiIsCiAgICAgICAgJ0RFUFRIX1RBUkdFVF9ZJzogIklkZWFsIFkgaGVpZ2h0IHRoZSBiYWxsIHRyaWVzIHRvIGZsb2F0IGF0LiIsCiAgICAgICAgJ0RFUFRIX1NQUklORyc6ICJTdHJlbmd0aCBvZiB0aGUgZm9yY2UgcHVsbGluZyBiYWxsIHRvIFRhcmdldCBZLiIsCiAgICAgICAgJ0RFUFRIX0RBTVAnOiAiRGFtcGluZyBvbiB2ZXJ0aWNhbCBtb3ZlbWVudCB0byBwcmV2ZW50IG9zY2lsbGF0aW9uLiIsCiAgICAgICAgJ0JPVU5EQVJZX1JBRElVUyc6ICJSYWRpdXMgb2YgdGhlIGNpcmN1bGFyIGFyZW5hIHdhbGwuIiwKICAgICAgICAnQk9VTkRBUllfSEVJR0hUJzogIkhlaWdodCBvZiB0aGUgYXJlbmEgY2VpbGluZy9mbG9vci4iLAogICAgICAgICdXQUxMX1NPRlRfQlVGRkVSJzogIkRpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMuIiwKICAgICAgICAnV0FMTF9TT0ZUX0ZPUkNFJzogIkZvcmNlIHB1c2hpbmcgYmFsbCBhd2F5IGZyb20gd2FsbCBiZWZvcmUgaW1wYWN0LiIsCiAgICAgICAgJ1dBTExfRUxBU1RJQ0lUWSc6ICJCb3VuY2luZXNzIG9mIHRoZSB3YWxsICgwID0gZGVhZCB0aHVkLCAxID0gcGVyZmVjdCBib3VuY2UpLiIsCiAgICAgICAgJ1dBTExfRlJJQ1RJT04nOiAiRnJpY3Rpb24gd2hlbiBzbGlkaW5nIGFsb25nIHRoZSB3YWxsLiIsCiAgICAgICAgJ0ZMT09SX0VMQVNUSUNJVFknOiAiQm91bmNpbmVzcyBvZiB0aGUgZmxvb3IvY2VpbGluZy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9FTkFCTEVEJzogIkVuYWJsZXMgdGhlIGV4dGVuZGVkIGNvcnJpZG9yIGZvciB0aGUgZ29hbC4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9YJzogIkhhbGYtd2lkdGggb2YgdGhlIGdvYWwgcG9ja2V0IGNvcnJpZG9yLiIsCiAgICAgICAgJ0dPQUxfUE9DS0VUX1onOiAiWi1kZXB0aCB3aGVyZSB0aGUgcG9ja2V0IHN0YXJ0cy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9SQURJVVMnOiAiRWZmZWN0aXZlIHJhZGl1cyBpbnNpZGUgdGhlIHBvY2tldC4iLAogICAgICAgICdMQVVOQ0hfU1BFRURfU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBTdGF0IFBvd2VyIHRvIFBoeXNpY3MgVmVsb2NpdHkuIiwKICAgICAgICAnTEFVTkNIX1NQRUVEX0NBUCc6ICJNYXhpbXVtIHBoeXNpY2FsIHNwZWVkIHRoZSBiYWxsIGNhbiBiZSB0aHJvd24uIiwKICAgICAgICAnU1dJUEVfTUlOX1BYJzogIk1pbmltdW0gc3dpcGUgZGlzdGFuY2UgdG8gcmVnaXN0ZXIgYSB0aHJvdy4iLAogICAgICAgICdBSU1fRFhfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgaG9yaXpvbnRhbCBhaW0gZnJvbSBzd2lwZS4iLAogICAgICAgICdBSU1fRFlfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgdmVydGljYWwgYWltIGZyb20gc3dpcGUuIiwKICAgICAgICAnUE9XRVJfQkFTRSc6ICJCYXNlIHBvd2VyIG11bHRpcGxpZXIgZm9yIGEgcXVpY2sgdGFwLiIsCiAgICAgICAgJ1BPV0VSX1JBTkdFJzogIkFkZGl0aW9uYWwgcG93ZXIgbXVsdGlwbGllciBhdCBmdWxsIGNoYXJnZS4iLAogICAgICAgICdQT1dFUl9NQVhfQk9OVVNfUkFUSU8nOiAiQ2hhcmdlIHRocmVzaG9sZCBmb3IgJ01heCBQb3dlcicgYm9udXMuIiwKICAgICAgICAnUE9XRVJfTUFYX01VTFRJUExJRVInOiAiTXVsdGlwbGllciBhcHBsaWVkIHdoZW4gaGl0dGluZyBNYXggUG93ZXIuIiwKICAgICAgICAnQ1VSVkVfRU5BQkxFRCc6ICJFbmFibGVzIGN1cnZlIHNob3RzIHZpYSBjdXJ2ZWQgc3dpcGVzLiIsCiAgICAgICAgJ0NVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQnOiAiSG93IGN1cnZlZCBhIHN3aXBlIG11c3QgYmUgdG8gdHJpZ2dlciBzcGluLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBzd2lwZSBjdXJ2ZSB0byBiYWxsIHNwaW4uIiwKICAgICAgICAnQ1VSVkVfU1BFRURfTVVMVCc6ICJNdWx0aXBsaWVyIGZvciBzcGluIGJhc2VkIG9uIHN3aXBlIHNwZWVkLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fQ0FQJzogIk1heGltdW0gc3BpbiBhbGxvd2VkIGZyb20gYSBjdXJ2ZSB0aHJvdy4iLAogICAgICAgICdDVVJWRV9QRVJGRUNUX1NQSU4nOiAiU3BpbiB0aHJlc2hvbGQgdG8gdHJpZ2dlciAnUGVyZmVjdCBDdXJ2ZScgRlguIiwKICAgICAgICAndGltZVNjYWxlJzogIkdsb2JhbCBnYW1lIHNwZWVkIG11bHRpcGxpZXIuIiwKICAgICAgICAnZGVtb01vZGUnOiAiVG9nZ2xlIEFJIHZzIEFJIGF1dG8tcGxheS4iLAogICAgICAgICdyZXNvbHV0aW9uJzogIkludGVybmFsIHJlbmRlciByZXNvbHV0aW9uIHNjYWxlICgwLjUgPSBoYWxmIHJlcykuIiwKICAgICAgICAnYXJlbmFPcGFjaXR5JzogIk9wYWNpdHkgb2YgdGhlIG91dGVyIGFyZW5hIGdyaWQuIiwKICAgICAgICAnYXJlbmEyT3BhY2l0eSc6ICJPcGFjaXR5IG9mIHRoZSBpbm5lciBoZXggZ3JpZC4iCiAgICB9OwoKICAgIGNsYXNzIERldlRvb2xzIHsKICAgICAgICBjb25zdHJ1Y3RvcihnYW1lTWFuYWdlcikgewogICAgICAgICAgICB0aGlzLmdhbWUgPSBnYW1lTWFuYWdlcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIGxpbC1ndWkgYXR0YWNoZXMgdG8gd2luZG93LmxpbCBieSBkZWZhdWx0IGluIFVNRCBidWlsZAogICAgICAgICAgICBpZiAoIXdpbmRvdy5saWwgfHwgIXdpbmRvdy5saWwuR1VJKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkRldlRvb2xzOiBsaWwtZ3VpIG5vdCBmb3VuZC4iKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dhbWUtY29udGFpbmVyJyk7CiAgICAgICAgICAgIHRoaXMuZ3VpID0gbmV3IHdpbmRvdy5saWwuR1VJKHsgdGl0bGU6ICdGbHV4IERldlRvb2xzJywgY29udGFpbmVyOiBjb250YWluZXIgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQb3NpdGlvbiBhcyBhIGNvbGxhcHNlZCB0YWIgb24gdGhlIHJpZ2h0IGZyYW1lCi8vIFBvc2l0aW9uIGFzIGEgc2xpZGluZyB0YWIgb24gdGhlIHJpZ2h0IGZyYW1lCi8vIFBvc2l0aW9uIGFzIGEgc2xpZGluZyB0YWIgb24gdGhlIHJpZ2h0IGZyYW1lCi8vIFdyYXBwZXIgZm9yIHNsaWRpbmcgYW5pbWF0aW9uCiAgICAgICAgICAgIGNvbnN0IHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUudG9wID0gJzEwMHB4JzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5yaWdodCA9ICctMjYwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLndpZHRoID0gJzI2MHB4JzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS50cmFuc2l0aW9uID0gJ3JpZ2h0IDAuM3MgY3ViaWMtYmV6aWVyKDAuMiwgMC44LCAwLjIsIDEuMCknOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnpJbmRleCA9ICc5OTk5JzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLmZsZXhEaXJlY3Rpb24gPSAnY29sdW1uJzsKICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHdyYXBwZXIpOwoKICAgICAgICAgICAgY29uc3QgZG9tID0gdGhpcy5ndWkuZG9tRWxlbWVudDsKICAgICAgICAgICAgZG9tLnN0eWxlLndpZHRoID0gJzEwMCUnOwogICAgICAgICAgICBkb20uc3R5bGUuc2V0UHJvcGVydHkoJy0td2lkdGgnLCAnMTAwJScpOwogICAgICAgICAgICBkb20uc3R5bGUubWF4SGVpZ2h0ID0gJzgwdmgnOwogICAgICAgICAgICBkb20uc3R5bGUub3ZlcmZsb3dZID0gJ2F1dG8nOwogICAgICAgICAgICBkb20uc3R5bGUub3ZlcmZsb3dYID0gJ2hpZGRlbic7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNb3ZlIEdVSSBpbnRvIHdyYXBwZXIKICAgICAgICAgICAgd3JhcHBlci5hcHBlbmRDaGlsZChkb20pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ3JlYXRlIFRvZ2dsZSBIYW5kbGUKICAgICAgICAgICAgY29uc3QgaGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5sZWZ0ID0gJy00MHB4JzsgLy8gUHJvdHJ1ZGUgdG8gdGhlIGxlZnQKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLnRvcCA9ICcwJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLndpZHRoID0gJzQwcHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuaGVpZ2h0ID0gJzQwcHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gJ3JnYmEoMCwgMjAsIDQwLCAwLjkpJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlciA9ICcxcHggc29saWQgIzAwZmZmZic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5ib3JkZXJSaWdodCA9ICdub25lJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlclRvcExlZnRSYWRpdXMgPSAnOHB4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlckJvdHRvbUxlZnRSYWRpdXMgPSAnOHB4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmN1cnNvciA9ICdwb2ludGVyJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5qdXN0aWZ5Q29udGVudCA9ICdjZW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYWxpZ25JdGVtcyA9ICdjZW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuY29sb3IgPSAnIzAwZmZmZic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5mb250U2l6ZSA9ICcyMHB4JzsKICAgICAgICAgICAgaGFuZGxlLmlubmVySFRNTCA9ICfimpknOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm94U2hhZG93ID0gJy01cHggMCAxMHB4IHJnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgICAgIAogICAgICAgICAgICB3cmFwcGVyLmFwcGVuZENoaWxkKGhhbmRsZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUb2dnbGUgTG9naWMKICAgICAgICAgICAgbGV0IGlzT3BlbiA9IGZhbHNlOwogICAgICAgICAgICBoYW5kbGUuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsgLy8gUHJldmVudCBnYW1lIGlucHV0cwogICAgICAgICAgICAgICAgaXNPcGVuID0gIWlzT3BlbjsKICAgICAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUucmlnaHQgPSBpc09wZW4gPyAnMHB4JyA6ICctMjYwcHgnOwogICAgICAgICAgICAgICAgaGFuZGxlLmlubmVySFRNTCA9IGlzT3BlbiA/ICfCuycgOiAn4pqZJzsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIERlZmF1bHQgZ2xvYmFsIHRpbWVTY2FsZSBpZiBub3Qgc2V0CmlmICh3aW5kb3cuZmx1eC50aW1lU2NhbGUgPT09IHVuZGVmaW5lZCkgd2luZG93LmZsdXgudGltZVNjYWxlID0gMC44OwoKdGhpcy5fc2V0dXBHZW5lcmFsKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwR2FtZVN0YXRlKCk7CnRoaXMuX3NldHVwT3ZlcmxheXMoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBUZWFtcygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFBsYXllckluc3BlY3RvcigpOwogICAgICAgICAgICB0aGlzLl9zZXR1cEJhbGxTYW5kYm94KCk7CnRoaXMuX3NldHVwRlhMYWIoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBWaXN1YWxEZWJ1ZygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFZpc3VhbHMoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBUb29sdGlwcygpOwogICAgICAgIH0KCiAgICAgICAgX3NldHVwVG9vbHRpcHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBUb29sdGlwIERPTQogICAgICAgICAgICB0aGlzLnRvb2x0aXBFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMudG9vbHRpcEVsLnN0eWxlLCB7CiAgICAgICAgICAgICAgICBwb3NpdGlvbjogJ2ZpeGVkJywKICAgICAgICAgICAgICAgIHRvcDogJzUwJScsCiAgICAgICAgICAgICAgICBsZWZ0OiAnNTAlJywKICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogJ3RyYW5zbGF0ZSgtNTAlLCAtNTAlKScsCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICdyZ2JhKDAsIDEwLCAzMCwgMC45NSknLAogICAgICAgICAgICAgICAgYm9yZGVyOiAnMnB4IHNvbGlkICMwMGZmZmYnLAogICAgICAgICAgICAgICAgcGFkZGluZzogJzIwcHgnLAogICAgICAgICAgICAgICAgY29sb3I6ICcjZmZmJywKICAgICAgICAgICAgICAgIGZvbnRGYW1pbHk6ICdtb25vc3BhY2UnLAogICAgICAgICAgICAgICAgZm9udFNpemU6ICcxNHB4JywKICAgICAgICAgICAgICAgIG1heFdpZHRoOiAnMzAwcHgnLAogICAgICAgICAgICAgICAgekluZGV4OiAnMTAwMDAnLAogICAgICAgICAgICAgICAgZGlzcGxheTogJ25vbmUnLAogICAgICAgICAgICAgICAgcG9pbnRlckV2ZW50czogJ25vbmUnLAogICAgICAgICAgICAgICAgYm94U2hhZG93OiAnMCAwIDIwcHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKScsCiAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6ICc4cHgnLAogICAgICAgICAgICAgICAgdGV4dEFsaWduOiAnY2VudGVyJwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLnRvb2x0aXBFbCk7CgogICAgICAgICAgICAvLyBSZWN1cnNpdmUgZnVuY3Rpb24gdG8gYXR0YWNoIGxpc3RlbmVycwogICAgICAgICAgICBjb25zdCBhdHRhY2ggPSAoZ3VpKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBDb250cm9sbGVycwogICAgICAgICAgICAgICAgaWYgKGd1aS5jb250cm9sbGVycykgewogICAgICAgICAgICAgICAgICAgIGd1aS5jb250cm9sbGVycy5mb3JFYWNoKGMgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkb20gPSBjLmRvbUVsZW1lbnQuY2xvc2VzdCgnLmNvbnRyb2xsZXInKTsgLy8gbGlsLWd1aSBzdHJ1Y3R1cmUKICAgICAgICAgICAgICAgICAgICAgICAgaWYoZG9tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IGRvbS5xdWVyeVNlbGVjdG9yKCcubmFtZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobGFiZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hZGRMb25nUHJlc3MobGFiZWwsIGMucHJvcGVydHksIGMuX25hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBTdWItZm9sZGVycwogICAgICAgICAgICAgICAgaWYoZ3VpLmZvbGRlcnMpIHsKICAgICAgICAgICAgICAgICAgICBndWkuZm9sZGVycy5mb3JFYWNoKGYgPT4gYXR0YWNoKGYpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFdhaXQgYSB0aWNrIGZvciBHVUkgdG8gZnVsbHkgcmVuZGVyIERPTQogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGF0dGFjaCh0aGlzLmd1aSksIDEwMCk7CiAgICAgICAgfQoKICAgICAgICBfYWRkTG9uZ1ByZXNzKGVsZW1lbnQsIHByb3BlcnR5LCBuYW1lKSB7CiAgICAgICAgICAgIGxldCB0aW1lciA9IG51bGw7CiAgICAgICAgICAgIGNvbnN0IGR1cmF0aW9uID0gNTAwOyAvLyAwLjVzCgogICAgICAgICAgICBjb25zdCBzdGFydCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dUb29sdGlwKHByb3BlcnR5LCBuYW1lKTsKICAgICAgICAgICAgICAgIH0sIGR1cmF0aW9uKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGNvbnN0IGVuZCA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGlmKHRpbWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTsKICAgICAgICAgICAgICAgICAgICB0aW1lciA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9oaWRlVG9vbHRpcCgpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBzdGFydCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHN0YXJ0LCB7cGFzc2l2ZTogdHJ1ZX0pOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgZW5kKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgZW5kKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGVuZCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCBlbmQpOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dUb29sdGlwKHByb3AsIG5hbWUpIHsKICAgICAgICAgICAgY29uc3QgZGVzYyA9IFRPT0xUSVBfREVTQ1JJUFRJT05TW3Byb3BdOwogICAgICAgICAgICBpZihkZXNjKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRvb2x0aXBFbC5pbm5lckhUTUwgPSBgPHN0cm9uZyBzdHlsZT0iY29sb3I6IzAwZmZmZjsgZm9udC1zaXplOjE2cHg7Ij4ke25hbWUgfHwgcHJvcH08L3N0cm9uZz48YnI+PGJyPiR7ZGVzY31gOwogICAgICAgICAgICAgICAgdGhpcy50b29sdGlwRWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9oaWRlVG9vbHRpcCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudG9vbHRpcEVsKSB0aGlzLnRvb2x0aXBFbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KCgpfc2V0dXBHZW5lcmFsKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0dlbmVyYWwnKTsKICAgICAgICAgICAgCmNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIHRpbWVTY2FsZTogd2luZG93LmZsdXgudGltZVNjYWxlLAogICAgICAgICAgICAgICAgZGVtb01vZGU6IHRoaXMuZ2FtZS5pc0RlbW9Nb2RlLAogICAgICAgICAgICAgICAgdG9nZ2xlSFVEOiB0cnVlLAogICAgICAgICAgICAgICAgcmVzb2x1dGlvbjogMC41MCwKYXJlbmFPcGFjaXR5OiAwLjMsCiAgICAgICAgICAgICAgICBhcmVuYTJPcGFjaXR5OiAwLjI1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3RpbWVTY2FsZScsIDAuMCwgNS4wKS5uYW1lKCdHYW1lIFNwZWVkJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSB2OwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZGVtb01vZGUnKS5uYW1lKCdEZW1vIE1vZGUnKS5saXN0ZW4oKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuaXNEZW1vTW9kZSAhPT0gdikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS50b2dnbGVEZW1vTW9kZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndG9nZ2xlSFVEJykubmFtZSgnU2hvdyBIVUQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGh1ZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpOwogICAgICAgICAgICAgICAgaWYgKGh1ZCkgewogICAgICAgICAgICAgICAgICAgIGh1ZC5zdHlsZS52aXNpYmlsaXR5ID0gdiA/ICd2aXNpYmxlJyA6ICdoaWRkZW4nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAncmVzb2x1dGlvbicsIDAuMSwgMi4wKS5uYW1lKCdSZXNvbHV0aW9uIFNjYWxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB3ID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBoID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgY29uc3QgcmVuZGVyZXIgPSB0aGlzLmdhbWUucmVuZGVyZXI7CiAgICAgICAgICAgICAgICBpZiAocmVuZGVyZXIpIHsKICAgICAgICAgICAgICAgICAgICByZW5kZXJlci5zZXRTaXplKHcgKiB2LCBoICogdiwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCmZvbGRlci5hZGQocGFyYW1zLCAnYXJlbmFPcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ0FyZW5hIDEgT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IHY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYmxlbmRNb2RlcyA9IHsKICAgICAgICAgICAgICAgICdOb3JtYWwnOiBUSFJFRS5Ob3JtYWxCbGVuZGluZywKICAgICAgICAgICAgICAgICdBZGRpdGl2ZSc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnTXVsdGlwbHknOiBUSFJFRS5NdWx0aXBseUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICdOb0JsZW5kaW5nJzogVEhSRUUuTm9CbGVuZGluZwogICAgICAgICAgICB9OwpwYXJhbXMuYXJlbmFCbGVuZCA9ICdOb3JtYWwnOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYUJsZW5kJywgT2JqZWN0LmtleXMoYmxlbmRNb2RlcykpLm5hbWUoJ0FyZW5hIDEgQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2ggJiYgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsLmJsZW5kaW5nID0gYmxlbmRNb2Rlc1t2XTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEFyZW5hIDIgQ29udHJvbHMKZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYTJPcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ0FyZW5hIDIgT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIgJiYgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eS52YWx1ZSA9IHY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKcGFyYW1zLmFyZW5hMkJsZW5kID0gJ0FkZGl0aXZlJzsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYTJCbGVuZCcsIE9iamVjdC5rZXlzKGJsZW5kTW9kZXMpKS5uYW1lKCdBcmVuYSAyIEJsZW5kJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoMiAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC5ibGVuZGluZyA9IGJsZW5kTW9kZXNbdl07CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMi5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgZGVmYXVsdHMKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gcGFyYW1zLmFyZW5hT3BhY2l0eTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoMiAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLm9wYWNpdHkgPSBwYXJhbXMuYXJlbmEyT3BhY2l0eTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9zZXR1cE92ZXJsYXlzKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ092ZXJsYXlzICYgRlgnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDEuIEdJRiBPdmVybGF5CiAgICAgICAgICAgIGNvbnN0IGdpZkVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NjcmVlbi1vdmVybGF5LWdpZicpOwogICAgICAgICAgICBpZiAoZ2lmRWwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdpZlBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB0cnVlLApvcGFjaXR5OiAwLjYyLAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnb3ZlcmxheScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdTY3JlZW4gR0lGJyk7CiAgICAgICAgICAgICAgICBnRm9sZGVyLmFkZChnaWZQYXJhbXMsICd2aXNpYmxlJykub25DaGFuZ2UodiA9PiBnaWZFbC5zdHlsZS5kaXNwbGF5ID0gdiA/ICdibG9jaycgOiAnbm9uZScpOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMS4wKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLm9wYWNpdHkgPSB2KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYmxlbmRNb2RlcyA9IFsKICAgICAgICAgICAgICAgICAgICAnbm9ybWFsJywgJ211bHRpcGx5JywgJ3NjcmVlbicsICdvdmVybGF5JywgCiAgICAgICAgICAgICAgICAgICAgJ2RhcmtlbicsICdsaWdodGVuJywgJ2NvbG9yLWRvZGdlJywgJ2NvbG9yLWJ1cm4nLCAKICAgICAgICAgICAgICAgICAgICAnaGFyZC1saWdodCcsICdzb2Z0LWxpZ2h0JywgJ2RpZmZlcmVuY2UnLCAnZXhjbHVzaW9uJywgCiAgICAgICAgICAgICAgICAgICAgJ2h1ZScsICdzYXR1cmF0aW9uJywgJ2NvbG9yJywgJ2x1bWlub3NpdHknCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAnYmxlbmQnLCBibGVuZE1vZGVzKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLm1peEJsZW5kTW9kZSA9IHYpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBXYXRlciBPdmVybGF5CiAgICAgICAgICAgIGNvbnN0IHdvID0gdGhpcy5nYW1lLndhdGVyT3ZlcmxheTsKICAgICAgICAgICAgaWYgKHdvICYmIHdvLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdXYXRlciBTaGFkZXInKTsKICAgICAgICAgICAgICAgIGNvbnN0IHdQYXJhbXMgPSB7IAogICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkgPyB3by5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eS52YWx1ZSA6IDAuNSwKICAgICAgICAgICAgICAgICAgICBibGVuZDogJ0FkZGl0aXZlJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ3Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IHdvLm1lc2gudmlzaWJsZSA9IHYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAod28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkpIHsKICAgICAgICAgICAgICAgICAgICB3Rm9sZGVyLmFkZCh3UGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMi4wKS5vbkNoYW5nZSh2ID0+IHdvLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlID0gdik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGhyZWVCbGVuZHMgPSB7CiAgICAgICAgICAgICAgICAgICAgJ05vcm1hbCc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdBZGRpdGl2ZSc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICAnTXVsdGlwbHknOiBUSFJFRS5NdWx0aXBseUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdOb0JsZW5kaW5nJzogVEhSRUUuTm9CbGVuZGluZwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICB3by5tYXRlcmlhbC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgIHdvLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBMaWdodCBTaGFmdHMKICAgICAgICAgICAgY29uc3QgbHMgPSB0aGlzLmdhbWUubGlnaHRTaGFmdHM7CiAgICAgICAgICAgIGlmIChscyAmJiBscy5jb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGxQYXJhbXMgPSB7IHZpc2libGU6IHRydWUgfTsKICAgICAgICAgICAgICAgIGZvbGRlci5hZGQobFBhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdMaWdodCBTaGFmdHMnKS5vbkNoYW5nZSh2ID0+IGxzLmNvbnRhaW5lci52aXNpYmxlID0gdik7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpfc2V0dXBHYW1lU3RhdGUoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignR2FtZSBTdGF0ZScpOwogICAgICAgICAgICBjb25zdCBnbSA9IHRoaXMuZ2FtZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIGZvcmNlSG9tZUdvYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5nb2FsU2NvcmVkKCdob21lJyk7IAogICAgICAgICAgICAgICAgICAgIGVsc2UgY29uc29sZS53YXJuKCJHYW1lIG11c3QgYmUgYWN0aXZlIHRvIHRyaWdnZXIgZ29hbCIpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGZvcmNlQXdheUdvYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5nb2FsU2NvcmVkKCdhd2F5Jyk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb25zb2xlLndhcm4oIkdhbWUgbXVzdCBiZSBhY3RpdmUgdG8gdHJpZ2dlciBnb2FsIik7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZm9yY2VIYWxmdGltZTogKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmKGdtLnN0YXRlID09PSAnYWN0aXZlJykgZ20uZW5kSGFsZigpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHJlc2V0Um91bmQ6ICgpID0+IGdtLnJlc2V0Um91bmQoKSwKICAgICAgICAgICAgICAgIGV4aXRUb01lbnU6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPSAnbWVudSc7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgcHJhY3RpY2UgaWYgcnVubmluZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlSG9tZUdvYWwnKS5uYW1lKCdUcmlnZ2VyIEhvbWUgR29hbCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlQXdheUdvYWwnKS5uYW1lKCdUcmlnZ2VyIEF3YXkgR29hbCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlSGFsZnRpbWUnKS5uYW1lKCdGb3JjZSBIYWxmdGltZScpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3Jlc2V0Um91bmQnKS5uYW1lKCdSZXNldCBSb3VuZCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2V4aXRUb01lbnUnKS5uYW1lKCdFeGl0IHRvIE1lbnUnKTsKICAgICAgICB9CgogICAgICAgIF9zZXR1cFRlYW1zKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1RlYW1zJyk7CiAgICAgICAgICAgIGlmICghdGhpcy5nYW1lLnRlYW1zLmhvbWUgfHwgIXRoaXMuZ2FtZS50ZWFtcy5hd2F5KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBob21lID0gdGhpcy5nYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGNvbnN0IGF3YXkgPSB0aGlzLmdhbWUudGVhbXMuYXdheTsKCiAgICAgICAgICAgIC8vIEhvbWUKICAgICAgICAgICAgY29uc3QgaEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0hvbWUgVGVhbScpOwogICAgICAgICAgICBoRm9sZGVyLmFkZChob21lLCAnaXNIdW1hbicpLm5hbWUoJ0lzIEh1bWFuIENvbnRyb2xsZWQnKS5saXN0ZW4oKTsKICAgICAgICAgICAgaEZvbGRlci5hZGQoaG9tZSwgJ2FpRW5hYmxlZCcpLm5hbWUoJ0FJIExvZ2ljIEVuYWJsZWQnKS5saXN0ZW4oKTsKCiAgICAgICAgICAgIC8vIEF3YXkKICAgICAgICAgICAgY29uc3QgYUZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0F3YXkgVGVhbScpOwogICAgICAgICAgICBhRm9sZGVyLmFkZChhd2F5LCAnaXNIdW1hbicpLm5hbWUoJ0lzIEh1bWFuIENvbnRyb2xsZWQnKS5saXN0ZW4oKTsKICAgICAgICAgICAgYUZvbGRlci5hZGQoYXdheSwgJ2FpRW5hYmxlZCcpLm5hbWUoJ0FJIExvZ2ljIEVuYWJsZWQnKS5saXN0ZW4oKTsKCiAgICAgICAgfQoKX3NldHVwUGxheWVySW5zcGVjdG9yKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1BsYXllciBJbnNwZWN0b3IgKEhvbWUgQWN0aXZlKScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGVscGVyIHRvIGdldCBjdXJyZW50IGFjdGl2ZSBwbGF5ZXIgc2FmZWx5CiAgICAgICAgICAgIGNvbnN0IGdldEFjdGl2ZSA9ICgpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5nYW1lLnRlYW1zLmhvbWUgJiYgdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSAKICAgICAgICAgICAgICAgICAgICA/IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciAKICAgICAgICAgICAgICAgICAgICA6IG51bGw7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBQcm94eSBvYmplY3QgdG8gYmluZCBHVUkgdG8gZHluYW1pYyB0YXJnZXQKICAgICAgICAgICAgY29uc3QgcHJveHkgPSB7CiAgICAgICAgICAgICAgICBnZXQgUm9sZSgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5yb2xlIDogJy0nOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGdldCBHb2RNb2RlKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLmlzR29kTW9kZSA6IGZhbHNlOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgR29kTW9kZSh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmlzR29kTW9kZSA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBSdW50aW1lIFZhbHVlcwogICAgICAgICAgICAgICAgZ2V0IEhQKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkhQIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEhQKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuSFAgPSB2OyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGdldCBDdXJyZW50RU4oKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuY3VycmVudEVOIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEN1cnJlbnRFTih2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmN1cnJlbnRFTiA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBCYXNlIFN0YXRzCiAgICAgICAgICAgICAgICBnZXQgTWF4SFAoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMubWF4SFAgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgTWF4SFAodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5tYXhIUCA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgU1AoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuU1AgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgU1AodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5TUCA9IHY7IAogICAgICAgICAgICAgICAgICAgICAgICBwLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsgCiAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEVOKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkVOIDogMDsgCiAgICAgICAgICAgICAgICB9LCAKICAgICAgICAgICAgICAgIHNldCBFTih2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHMuRU4gPSB2OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEFUKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkFUIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEFUKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQVQgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFBBKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlBBIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFBBKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuUEEgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEJMKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkJMIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEJMKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQkwgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFNIKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlNIIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFNIKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuU0ggPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IENBKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkNBIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IENBKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQ0EgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLy8gQWN0aW9ucwogICAgICAgICAgICAgICAgTGV2ZWxVcDogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5sZXZlbFVwKCk7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEZ1bGxIZWFsOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsgCiAgICAgICAgICAgICAgICAgICAgaWYocCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7IAogICAgICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuZ2V0U3RhdCgnRU4nKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLnZlbm9tID0gMDsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLm5hcCA9IDA7IAogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGsgaW4gcC5zdGF0dXMud2l0aGVyKSBwLnN0YXR1cy53aXRoZXJba10gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZih3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJGVUxMIEhFQUwiLCBwLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIERyYWluRU46ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBwLmZ1bWJsZSgpOyAvLyBUcmlnZ2VyIGZ1bWJsZSBsb2dpYwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocHJveHksICdSb2xlJykubGlzdGVuKCkuZGlzYWJsZSgpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHByb3h5LCAnR29kTW9kZScpLm5hbWUoJ0dvZCBNb2RlIChJbmYgSFAvRU4pJykubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBydEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ1J1bnRpbWUgU3RhdHVzJyk7CiAgICAgICAgICAgIHJ0Rm9sZGVyLmFkZChwcm94eSwgJ0hQJywgMCwgOTk5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHJ0Rm9sZGVyLmFkZChwcm94eSwgJ0N1cnJlbnRFTicsIDAsIDEwMCkubmFtZSgnQ3VycmVudCBFTicpLmxpc3RlbigpOwoKICAgICAgICAgICAgY29uc3Qgc3RhdEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0Jhc2UgU3RhdHMnKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdNYXhIUCcsIDEwMCwgOTk5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnRU4nLCAwLCA5OSkubmFtZSgnTWF4IEVOJykubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnU1AnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQVQnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnUEEnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQkwnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnU0gnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQ0EnLCAwLCA5OSkubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBhY3Rpb25Gb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdBY3Rpb25zJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdMZXZlbFVwJykubmFtZSgnSW5zdGFudCBMZXZlbCBVcCcpOwogICAgICAgICAgICBhY3Rpb25Gb2xkZXIuYWRkKHByb3h5LCAnRnVsbEhlYWwnKS5uYW1lKCdGdWxsIEhlYWwgJiBDdXJlJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdEcmFpbkVOJykubmFtZSgnRHJhaW4gRU4gKEZ1bWJsZSknKTsKICAgICAgICB9Cgpfc2V0dXBCYWxsU2FuZGJveCgpIHsKICAgIGNvbnN0IHJvb3QgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0JhbGwgTGFiIChUaHJvdyAmIFBoeXNpY3MpJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBTaGFyZWQgc3RhdGUgb2JqZWN0IChsaXZlcyBvbiB3aW5kb3cuZmx1eCBzbyBpdCBzdXJ2aXZlcyByZWxvYWRzKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBsYWIgPSB3aW5kb3cuZmx1eC5iYWxsTGFiID0gd2luZG93LmZsdXguYmFsbExhYiB8fCB7fTsKICAgIGxhYi5nYW1lID0gdGhpcy5nYW1lOwoKICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnOwogICAgY29uc3QgVEMgPSB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZzsKCiAgICBpZiAoIUMgfHwgIVRDKSB7CiAgICAgICAgY29uc29sZS53YXJuKCJCYWxsIExhYjogTWlzc2luZyBCYWxsQ29uZmlnIG9yIFRocm93Q29uZmlnLiIpOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEhlbHBlcnMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgZ2V0QmFsbCA9ICgpID0+IHRoaXMuZ2FtZSAmJiB0aGlzLmdhbWUuZW50aXRpZXMgPyB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICBjb25zdCBnZXRBY3RpdmUgPSAoKSA9PiB0aGlzLmdhbWUgJiYgdGhpcy5nYW1lLnRlYW1zICYmIHRoaXMuZ2FtZS50ZWFtcy5ob21lID8gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKCiAgICBjb25zdCBlbnN1cmVQcmV2aWV3TGluZSA9ICgpID0+IHsKICAgICAgICBpZiAobGFiLnByZXZpZXdMaW5lKSByZXR1cm47CiAgICAgICAgaWYgKCF0aGlzLmdhbWUgfHwgIXRoaXMuZ2FtZS5zY2VuZSkgcmV0dXJuOwoKICAgICAgICBjb25zdCBnZW9tID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgdHJhbnNwYXJlbnQ6IHRydWUsIG9wYWNpdHk6IDAuOTUgfSk7CiAgICAgICAgY29uc3QgbGluZSA9IG5ldyBUSFJFRS5MaW5lKGdlb20sIG1hdCk7CiAgICAgICAgbGluZS5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgbGluZS5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKGxpbmUpOwogICAgICAgIGxhYi5wcmV2aWV3TGluZSA9IGxpbmU7CiAgICB9OwoKICAgIGNvbnN0IGNsZWFyUHJldmlld0xpbmUgPSAoKSA9PiB7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3TGluZSAmJiBsYWIucHJldmlld0xpbmUuZ2VvbWV0cnkpIHsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBBIHNhZmUgImdob3N0IGJhbGwiIHRoYXQgY2FuIHVzZSBCYWxsLnVwZGF0ZUZyZWUgd2l0aG91dCBzcGF3bmluZyBGWAogICAgY29uc3QgbWFrZUdob3N0QmFsbCA9IChwb3MsIHZlbCwgc3BpbikgPT4gewogICAgICAgIGNvbnN0IGdiID0gewogICAgICAgICAgICBtZXNoOiB7IHBvc2l0aW9uOiBwb3MuY2xvbmUoKSB9LAogICAgICAgICAgICB2ZWxvY2l0eTogdmVsLmNsb25lKCksCiAgICAgICAgICAgIGFuZ3VsYXJWZWxvY2l0eTogKHNwaW4gPyBzcGluLmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpKSwKICAgICAgICAgICAgYWNjdW11bGF0ZWRSb3RhdGlvbjogbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwKICAgICAgICAgICAgcG93ZXI6IDAsCiAgICAgICAgICAgIGRlY2F5UmF0ZTogMCwKICAgICAgICAgICAgX2J1YmJsZVRpbWVyOiA5OTksCiAgICAgICAgICAgIF9naG9zdDogdHJ1ZSwKICAgICAgICAgICAgZGVmb3JtTm9kZTogbnVsbAogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGdiOwogICAgfTsKCiAgICAvLyBVc2UgQmFsbC51cGRhdGVGcmVlIGZvciBmYWl0aGZ1bCB0cmFqZWN0b3J5IHByZWRpY3Rpb24KICAgIGNvbnN0IHNpbXVsYXRlID0gKGdob3N0QmFsbCwgc3RlcHMsIHN0ZXBEdCkgPT4gewogICAgICAgIGNvbnN0IHB0cyA9IFtdOwogICAgICAgIHB0cy5wdXNoKGdob3N0QmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCkpOwogICAgICAgIGNvbnN0IHByb3RvID0gd2luZG93LmZsdXguQmFsbCAmJiB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZTsKICAgICAgICBpZiAoIXByb3RvIHx8IHR5cGVvZiBwcm90by51cGRhdGVGcmVlICE9PSAnZnVuY3Rpb24nKSByZXR1cm4gcHRzOwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ZXBzOyBpKyspIHsKICAgICAgICAgICAgcHJvdG8udXBkYXRlRnJlZS5jYWxsKGdob3N0QmFsbCwgc3RlcER0KTsKICAgICAgICAgICAgcHRzLnB1c2goZ2hvc3RCYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwdHM7CiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gUHJldmlldyArIHJlY29yZC9yZXBsYXkgcnVudGltZSBsb29wCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KbGFiLnByZXZpZXcgPSBsYWIucHJldmlldyB8fCB7CiAgICAgICAgZW5hYmxlZDogZmFsc2UsCiAgICAgICAgc291cmNlOiAnQ2Fubm9uJywKICAgICAgICBzdGVwczogMTIwLAogICAgICAgIHN0ZXBEdDogMS82MCwKICAgICAgICByZWZyZXNoSHo6IDEwLAogICAgICAgIHNob3dPbkhlbGRPbmx5OiBmYWxzZQogICAgfTsKCiAgICBsYWIuY2Fubm9uID0gbGFiLmNhbm5vbiB8fCB7CiAgICAgICAgeWF3OiAwLAogICAgICAgIHBpdGNoOiAwLAogICAgICAgIHBvd2VyOiAyMCwKICAgICAgICB0eXBlOiAnU0gnLAogICAgICAgIHNwaW5YOiAwLAogICAgICAgIHNwaW5ZOiAwLAogICAgICAgIHNwaW5aOiAwLAogICAgICAgIGZpcmVCdXJzdDogMSwKICAgICAgICBzcHJlYWREZWc6IDAKICAgIH07CgogICAgbGFiLnJlY29yZGluZyA9IGxhYi5yZWNvcmRpbmcgfHwgewogICAgICAgIGlzUmVjb3JkaW5nOiBmYWxzZSwKICAgICAgICBmcmFtZXM6IFtdLAogICAgICAgIG1heFNlY29uZHM6IDEyCiAgICB9OwoKICAgIGxhYi5yZXBsYXkgPSBsYWIucmVwbGF5IHx8IHsKICAgICAgICBpc1JlcGxheWluZzogZmFsc2UsCiAgICAgICAgZnJhbWVzOiBbXSwKICAgICAgICBpZHg6IDAsCiAgICAgICAgbG9vcDogdHJ1ZSwKICAgICAgICBzcGVlZDogMS4wCiAgICB9OwoKICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgbGFiLnRhcmdldEJhbGwgPSBudWxsOwoKICAgIGxhYi5hcHBseVJlcGxheUZyYW1lID0gKGJhbGwsIGR0KSA9PiB7CiAgICAgICAgY29uc3QgcmVwID0gbGFiLnJlcGxheTsKICAgICAgICBpZiAoIXJlcCB8fCAhcmVwLmlzUmVwbGF5aW5nIHx8ICFyZXAuZnJhbWVzIHx8IHJlcC5mcmFtZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBBZHZhbmNlIHRpbWUgYnkgc3RlcHBpbmcgaW5kaWNlcyAoZnJhbWUtYmFzZWQpCiAgICAgICAgY29uc3Qgc3RlcCA9IE1hdGgubWF4KDEsIE1hdGguZmxvb3IocmVwLnNwZWVkKSk7CiAgICAgICAgcmVwLmlkeCArPSBzdGVwOwoKICAgICAgICBpZiAocmVwLmlkeCA+PSByZXAuZnJhbWVzLmxlbmd0aCkgewogICAgICAgICAgICBpZiAocmVwLmxvb3ApIHJlcC5pZHggPSAwOwogICAgICAgICAgICBlbHNlIHsgcmVwLmlzUmVwbGF5aW5nID0gZmFsc2U7IGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOyByZXR1cm47IH0KICAgICAgICB9CgogICAgICAgIGNvbnN0IGYgPSByZXAuZnJhbWVzW3JlcC5pZHhdOwogICAgICAgIGlmICghZikgcmV0dXJuOwoKICAgICAgICBiYWxsLmRyb3AoKTsgLy8gZW5zdXJlIG5vIGhvbGRlciBsb2dpYyBmaWdodHMgdXMKICAgICAgICBiYWxsLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIGJhbGwubWVzaC5wb3NpdGlvbi5zZXQoZi5weCwgZi5weSwgZi5weik7CiAgICAgICAgYmFsbC52ZWxvY2l0eS5zZXQoZi52eCwgZi52eSwgZi52eik7CiAgICAgICAgYmFsbC5hbmd1bGFyVmVsb2NpdHkuc2V0KGYuc3gsIGYuc3ksIGYuc3opOwogICAgfTsKCiAgICBsYWIuX3ByZXZpZXdUaW1lciA9IGxhYi5fcHJldmlld1RpbWVyIHx8IDA7CgogICAgbGFiLnVwZGF0ZSA9IChkdCkgPT4gewogICAgICAgIC8vIC0tLSByZWNvcmRpbmcgLS0tCiAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICBpZiAoYiAmJiBsYWIucmVjb3JkaW5nICYmIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcpIHsKICAgICAgICAgICAgY29uc3QgciA9IGxhYi5yZWNvcmRpbmc7CiAgICAgICAgICAgIGNvbnN0IG1heEZyYW1lcyA9IE1hdGguZmxvb3IoKHIubWF4U2Vjb25kcyB8fCAxMikgLyAoZHQgfHwgKDEvNjApKSk7CiAgICAgICAgICAgIGlmIChyLmZyYW1lcy5sZW5ndGggPiBtYXhGcmFtZXMpIHIuZnJhbWVzLnNoaWZ0KCk7CiAgICAgICAgICAgIHIuZnJhbWVzLnB1c2goewogICAgICAgICAgICAgICAgcHg6IGIubWVzaC5wb3NpdGlvbi54LCBweTogYi5tZXNoLnBvc2l0aW9uLnksIHB6OiBiLm1lc2gucG9zaXRpb24ueiwKICAgICAgICAgICAgICAgIHZ4OiBiLnZlbG9jaXR5LngsIHZ5OiBiLnZlbG9jaXR5LnksIHZ6OiBiLnZlbG9jaXR5LnosCiAgICAgICAgICAgICAgICBzeDogYi5hbmd1bGFyVmVsb2NpdHkueCwgc3k6IGIuYW5ndWxhclZlbG9jaXR5LnksIHN6OiBiLmFuZ3VsYXJWZWxvY2l0eS56CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIHByZXZpZXcgcmVmcmVzaCAtLS0KICAgICAgICBsYWIuX3ByZXZpZXdUaW1lciArPSBkdDsKICAgICAgICBjb25zdCByZWZyZXNoSW50ZXJ2YWwgPSAxLjAgLyBNYXRoLm1heCgxLCAobGFiLnByZXZpZXcucmVmcmVzaEh6IHx8IDEwKSk7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LmVuYWJsZWQgJiYgbGFiLl9wcmV2aWV3VGltZXIgPj0gcmVmcmVzaEludGVydmFsKSB7CiAgICAgICAgICAgIGxhYi5fcHJldmlld1RpbWVyID0gMDsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfQogICAgfTsKCiAgICBsYWIucmVmcmVzaFByZXZpZXcgPSAoKSA9PiB7CiAgICAgICAgaWYgKCFsYWIucHJldmlldy5lbmFibGVkKSB7IGNsZWFyUHJldmlld0xpbmUoKTsgcmV0dXJuOyB9CiAgICAgICAgZW5zdXJlUHJldmlld0xpbmUoKTsKCiAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgaWYgKCFiIHx8ICFiLm1lc2gpIHJldHVybjsKCiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LnNob3dPbkhlbGRPbmx5ICYmIGIuc3RhdGUgIT09ICdoZWxkJykgewogICAgICAgICAgICBjbGVhclByZXZpZXdMaW5lKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIERlY2lkZSBwcmV2aWV3IHNvdXJjZQogICAgICAgIGxldCBzdGFydFBvcyA9IGIubWVzaC5wb3NpdGlvbjsKICAgICAgICBsZXQgc3RhcnRWZWwgPSBiLnZlbG9jaXR5OwogICAgICAgIGxldCBzdGFydFNwaW4gPSBiLmFuZ3VsYXJWZWxvY2l0eTsKCiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LnNvdXJjZSA9PT0gJ0Nhbm5vbicpIHsKICAgICAgICAgICAgLy8gQ2Fubm9uIGFsd2F5cyBsYXVuY2hlcyBmcm9tIGJhbGwgcG9zaXRpb24gKG9yIHBsYXllciBpZiBoZWxkKQogICAgICAgICAgICBjb25zdCB5YXdSYWQgPSAobGFiLmNhbm5vbi55YXcgfHwgMCkgKiBNYXRoLlBJIC8gMTgwOwogICAgICAgICAgICBjb25zdCBwaXRjaFJhZCA9IChsYWIuY2Fubm9uLnBpdGNoIHx8IDApICogTWF0aC5QSSAvIDE4MDsKCiAgICAgICAgICAgIGNvbnN0IGRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgTWF0aC5zaW4oeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIE1hdGguc2luKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIC1NYXRoLmNvcyh5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpCiAgICAgICAgICAgICkubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBjYXAgPSAod2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfQ0FQICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkxBVU5DSF9TUEVFRF9DQVAgOiA4NS4wKTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAod2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfU0NBTEUgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX1NDQUxFIDogMS4wKTsKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSBNYXRoLm1pbigobGFiLmNhbm5vbi5wb3dlciB8fCAyMCkgKiBzY2FsZSwgY2FwKTsKCiAgICAgICAgICAgIHN0YXJ0UG9zID0gKGIuc3RhdGUgPT09ICdoZWxkJyAmJiBwICYmIHAubWVzaCkgPyBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMS4yLCAwKSkgOiBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgc3RhcnRWZWwgPSBkaXIubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICBzdGFydFNwaW4gPSBuZXcgVEhSRUUuVmVjdG9yMyhsYWIuY2Fubm9uLnNwaW5YIHx8IDAsIGxhYi5jYW5ub24uc3BpblkgfHwgMCwgbGFiLmNhbm5vbi5zcGluWiB8fCAwKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGdob3N0ID0gbWFrZUdob3N0QmFsbChzdGFydFBvcy5jbG9uZSgpLCBzdGFydFZlbC5jbG9uZSgpLCBzdGFydFNwaW4pOwogICAgICAgIGNvbnN0IHB0cyA9IHNpbXVsYXRlKGdob3N0LCBNYXRoLmZsb29yKGxhYi5wcmV2aWV3LnN0ZXBzIHx8IDEyMCksIChsYWIucHJldmlldy5zdGVwRHQgfHwgKDEvNjApKSk7CgogICAgICAgIGlmIChsYWIucHJldmlld0xpbmUpIHsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCkuc2V0RnJvbVBvaW50cyhwdHMpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IEJhbGwgUGh5c2ljcyAoQmFsbENvbmZpZykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcGh5cyA9IHJvb3QuYWRkRm9sZGVyKCdCYWxsIFBoeXNpY3MgKEJhbGxDb25maWcpJyk7CgogICAgY29uc3QgaW50ZWcgPSBwaHlzLmFkZEZvbGRlcignSW50ZWdyYXRpb24nKTsKICAgIGludGVnLmFkZChDLCAnU1VCU1RFUFMnLCAxLCAxMiwgMSkubmFtZSgnU3Vic3RlcHMnKTsKICAgIGludGVnLmFkZChDLCAnU1RPUF9TUEVFRCcsIDAuMCwgMC4yKS5uYW1lKCdTdG9wIFNwZWVkJyk7CgogICAgY29uc3QgZHJhZyA9IHBoeXMuYWRkRm9sZGVyKCdXYXRlciBEcmFnJyk7CiAgICBkcmFnLmFkZChDLCAnV0FURVJfRFJBR19MSU5FQVInLCAwLjAsIDIuMCkubmFtZSgnTGluZWFyIERyYWcnKTsKICAgIGRyYWcuYWRkKEMsICdXQVRFUl9EUkFHX1FVQUQnLCAwLjAsIDAuMDUpLm5hbWUoJ1F1YWRyYXRpYyBEcmFnJyk7CgogICAgY29uc3Qgc3BpbiA9IHBoeXMuYWRkRm9sZGVyKCdTcGluJyk7CiAgICBzcGluLmFkZChDLCAnU1BJTl9EUkFHJywgMC4wLCAzLjApLm5hbWUoJ1NwaW4gRGVjYXknKTsKCiAgICBjb25zdCBtYWdudXMgPSBwaHlzLmFkZEZvbGRlcignTWFnbnVzJyk7CiAgICBtYWdudXMuYWRkKEMsICdNQUdOVVNfRU5BQkxFRCcpLm5hbWUoJ0VuYWJsZWQnKTsKICAgIG1hZ251cy5hZGQoQywgJ01BR05VU19DT0VGRicsIDAuMCwgMC41KS5uYW1lKCdDb2VmZicpOwogICAgbWFnbnVzLmFkZChDLCAnTUFHTlVTX0NBUCcsIDAuMCwgMjAwLjApLm5hbWUoJ0NhcCcpOwoKICAgIGNvbnN0IGRlcHRoID0gcGh5cy5hZGRGb2xkZXIoJ0RlcHRoIENvbnN0cmFpbnQnKTsKICAgIGRlcHRoLmFkZChDLCAnREVQVEhfVEFSR0VUX1knLCAtNS4wLCA1LjApLm5hbWUoJ1RhcmdldCBZJyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX1NQUklORycsIDAuMCwgMTAuMCkubmFtZSgnU3ByaW5nJyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX0RBTVAnLCAwLjAsIDYuMCkubmFtZSgnRGFtcCcpOwoKICAgIGNvbnN0IGFyZW5hID0gcGh5cy5hZGRGb2xkZXIoJ0FyZW5hIEJvdW5kYXJ5Jyk7CiAgICBhcmVuYS5hZGQoQywgJ0JPVU5EQVJZX1JBRElVUycsIDEwLjAsIDEyMC4wKS5uYW1lKCdSYWRpdXMnKTsKICAgIGFyZW5hLmFkZChDLCAnQk9VTkRBUllfSEVJR0hUJywgMi4wLCA0MC4wKS5uYW1lKCdIZWlnaHQnKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9TT0ZUX0JVRkZFUicsIDAuMCwgMjAuMCkubmFtZSgnU29mdCBCdWZmZXInKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9TT0ZUX0ZPUkNFJywgMC4wLCAyMDAuMCkubmFtZSgnU29mdCBGb3JjZScpOwogICAgYXJlbmEuYWRkKEMsICdXQUxMX0VMQVNUSUNJVFknLCAwLjAsIDEuMCkubmFtZSgnV2FsbCBCb3VuY2UnKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9GUklDVElPTicsIDAuMCwgMS4wKS5uYW1lKCdXYWxsIEZyaWN0aW9uJyk7CiAgICBhcmVuYS5hZGQoQywgJ0ZMT09SX0VMQVNUSUNJVFknLCAwLjAsIDEuMCkubmFtZSgnQ2VpbC9GbG9vciBCb3VuY2UnKTsKCiAgICBjb25zdCBwb2NrZXQgPSBhcmVuYS5hZGRGb2xkZXIoJ0dvYWwgUG9ja2V0Jyk7CiAgICBwb2NrZXQuYWRkKEMsICdHT0FMX1BPQ0tFVF9FTkFCTEVEJykubmFtZSgnRW5hYmxlZCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfWCcsIDAuMCwgNDAuMCkubmFtZSgnUG9ja2V0IEhhbGYtWCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfWicsIDAuMCwgNTAuMCkubmFtZSgnUG9ja2V0IFN0YXJ0IHxafCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfUkFESVVTJywgMTAuMCwgMTIwLjApLm5hbWUoJ1BvY2tldCBSYWRpdXMnKTsKCiAgICBjb25zdCBsYXVuY2ggPSBwaHlzLmFkZEZvbGRlcignTGF1bmNoIE1hcHBpbmcnKTsKICAgIGxhdW5jaC5hZGQoQywgJ0xBVU5DSF9TUEVFRF9TQ0FMRScsIDAuMSwgNS4wKS5uYW1lKCdTcGVlZCBTY2FsZScpOwogICAgbGF1bmNoLmFkZChDLCAnTEFVTkNIX1NQRUVEX0NBUCcsIDEwLjAsIDIwMC4wKS5uYW1lKCdTcGVlZCBDYXAnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogVGhyb3cgbWFwcGluZyAoUGxheWVyLnJlbGVhc2VDaGFyZ2UgLT4gQmFsbC5zaG9vdCkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgdGhyb3dNYXAgPSByb290LmFkZEZvbGRlcignVGhyb3cgTWFwcGluZyAoVGhyb3dDb25maWcpJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdTV0lQRV9NSU5fUFgnLCAwLCAxMjAsIDEpLm5hbWUoJ1N3aXBlIE1pbiBQWCcpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnQUlNX0RYX1NDQUxFJywgMC4xLCA1LjApLm5hbWUoJ0FpbSBYIFNjYWxlJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdBSU1fRFlfU0NBTEUnLCAwLjEsIDUuMCkubmFtZSgnQWltIFkgU2NhbGUnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX0JBU0UnLCAwLjEsIDMuMCkubmFtZSgnUG93ZXIgQmFzZScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnUE9XRVJfUkFOR0UnLCAwLjAsIDMuMCkubmFtZSgnUG93ZXIgUmFuZ2UnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX01BWF9CT05VU19SQVRJTycsIDAuMCwgMS4wKS5uYW1lKCdNYXggQm9udXMgUmF0aW8nKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX01BWF9NVUxUSVBMSUVSJywgMS4wLCA2LjApLm5hbWUoJ01heCBNdWx0aXBsaWVyJyk7CgogICAgY29uc3QgY3VydmVNYXAgPSB0aHJvd01hcC5hZGRGb2xkZXIoJ0N1cnZlJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9FTkFCTEVEJykubmFtZSgnRW5hYmxlZCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRCcsIDAuMCwgMS4wKS5uYW1lKCdJbnB1dCBUaHJlc2hvbGQnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX1NQSU5fU0NBTEUnLCAwLjAsIDQwMDAuMCkubmFtZSgnU3BpbiBTY2FsZScpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfU1BFRURfTVVMVCcsIDAuMCwgNS4wKS5uYW1lKCdTd2lwZSBTcGVlZCBNdWx0Jyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9TUElOX0NBUCcsIDAuMCwgNjAwMC4wKS5uYW1lKCdTcGluIENhcCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfUEVSRkVDVF9TUElOJywgMC4wLCAyMDAwLjApLm5hbWUoJ1BlcmZlY3QgVGhyZXNob2xkJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFRlbGVwb3J0IC8gU3RhdGUgdG9vbHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgdHAgPSByb290LmFkZEZvbGRlcignVGVsZXBvcnQgLyBSZXNldCcpOwogICAgY29uc3QgdHBQYXJhbXMgPSB7CiAgICAgICAgVG9DZW50ZXI6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgaWYgKGIpIGIucmVzZXQoKTsgfSwKICAgICAgICBUb0FjdGl2ZVBsYXllcjogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBjb25zdCBwID0gZ2V0QWN0aXZlKCk7IGlmIChiICYmIHApIGIuZ3JhYihwKTsgfSwKICAgICAgICBUb0hvbWVHb2FsOiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGlmIChiKSB7IGIuZHJvcCgpOyBiLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDI1KTsgYi52ZWxvY2l0eS5zZXQoMCwwLDApOyBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOyB9IH0sCiAgICAgICAgVG9Bd2F5R29hbDogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMjUpOyBiLnZlbG9jaXR5LnNldCgwLDAsMCk7IGIuYW5ndWxhclZlbG9jaXR5LnNldCgwLDAsMCk7IH0gfSwKICAgICAgICBUb1NreTogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAxMCwgMCk7IGIudmVsb2NpdHkuc2V0KDAsMCwwKTsgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsgfSB9LAogICAgICAgIENsZWFyUHJldmlldzogKCkgPT4gY2xlYXJQcmV2aWV3TGluZSgpCiAgICB9OwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9DZW50ZXInKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvQWN0aXZlUGxheWVyJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0hvbWVHb2FsJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0F3YXlHb2FsJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb1NreScpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnQ2xlYXJQcmV2aWV3Jyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFNob3QgQ2Fubm9uIChmb3JjZSBmaXJlIHdpdGggcGFyYW1zKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBjYW5ub24gPSByb290LmFkZEZvbGRlcignU2hvdCBDYW5ub24nKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3lhdycsIC0xODAsIDE4MCwgMSkubmFtZSgnWWF3IChkZWcpJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdwaXRjaCcsIC04OSwgODksIDEpLm5hbWUoJ1BpdGNoIChkZWcpJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdwb3dlcicsIDAsIDEyMCwgMC4xKS5uYW1lKCdQb3dlcicpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAndHlwZScsIFsnUEEnLCdTSCddKS5uYW1lKCdUeXBlJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcGluWCcsIC0zMDAwLCAzMDAwLCAxKS5uYW1lKCdTcGluIFgnKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwaW5ZJywgLTMwMDAsIDMwMDAsIDEpLm5hbWUoJ1NwaW4gWScpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnc3BpblonLCAtMzAwMCwgMzAwMCwgMSkubmFtZSgnU3BpbiBaJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdmaXJlQnVyc3QnLCAxLCAxMCwgMSkubmFtZSgnQnVyc3QgQ291bnQnKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwcmVhZERlZycsIDAsIDMwLCAwLjUpLm5hbWUoJ1NwcmVhZCAoZGVnKScpOwoKICAgIGNvbnN0IGZpcmVQYXJhbXMgPSB7CiAgICAgICAgRmlyZTogKCkgPT4gewogICAgICAgICAgICBjb25zdCBiID0gZ2V0QmFsbCgpOwogICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgIGlmICghYikgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgeWF3UmFkID0gKGxhYi5jYW5ub24ueWF3IHx8IDApICogTWF0aC5QSSAvIDE4MDsKICAgICAgICAgICAgY29uc3QgcGl0Y2hSYWQgPSAobGFiLmNhbm5vbi5waXRjaCB8fCAwKSAqIE1hdGguUEkgLyAxODA7CgogICAgICAgICAgICBjb25zdCBiYXNlRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICBNYXRoLnNpbih5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpLAogICAgICAgICAgICAgICAgTWF0aC5zaW4ocGl0Y2hSYWQpLAogICAgICAgICAgICAgICAgLU1hdGguY29zKHlhd1JhZCkgKiBNYXRoLmNvcyhwaXRjaFJhZCkKICAgICAgICAgICAgKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gKGIuc3RhdGUgPT09ICdoZWxkJyAmJiBwICYmIHAubWVzaCkgPyBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMS4yLCAwKSkgOiBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKCiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgKGxhYi5jYW5ub24uZmlyZUJ1cnN0IHx8IDEpOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IGJhc2VEaXIuY2xvbmUoKTsKICAgICAgICAgICAgICAgIGlmIChsYWIuY2Fubm9uLnNwcmVhZERlZyA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcHJlYWQgPSAobGFiLmNhbm5vbi5zcHJlYWREZWcgKiBNYXRoLlBJIC8gMTgwKTsKICAgICAgICAgICAgICAgICAgICBkaXIueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogc3ByZWFkOwogICAgICAgICAgICAgICAgICAgIGRpci55ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcHJlYWQ7CiAgICAgICAgICAgICAgICAgICAgZGlyLnogKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIHNwcmVhZDsKICAgICAgICAgICAgICAgICAgICBkaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYi5kcm9wKCk7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24uY29weShzdGFydCk7CiAgICAgICAgICAgICAgICBiLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOwoKICAgICAgICAgICAgICAgIGNvbnN0IHNwaW4gPSBuZXcgVEhSRUUuVmVjdG9yMyhsYWIuY2Fubm9uLnNwaW5YIHx8IDAsIGxhYi5jYW5ub24uc3BpblkgfHwgMCwgbGFiLmNhbm5vbi5zcGluWiB8fCAwKTsKICAgICAgICAgICAgICAgIGIuc2hvb3QoZGlyLCBsYWIuY2Fubm9uLnBvd2VyIHx8IDIwLCBsYWIuY2Fubm9uLnR5cGUgfHwgJ1NIJywgbnVsbCwgc3Bpbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgY2Fubm9uLmFkZChmaXJlUGFyYW1zLCAnRmlyZScpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBUcmFqZWN0b3J5IFByZXZpZXcKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcHJldmlldyA9IHJvb3QuYWRkRm9sZGVyKCdUcmFqZWN0b3J5IFByZXZpZXcnKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnZW5hYmxlZCcpLm5hbWUoJ0VuYWJsZWQnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3NvdXJjZScsIFsnQ2Fubm9uJywgJ0xpdmUgQmFsbCddKS5uYW1lKCdTb3VyY2UnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3N0ZXBzJywgMTAsIDYwMCwgMSkubmFtZSgnU3RlcHMnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3N0ZXBEdCcsIDEvMjQwLCAxLzE1LCAxLzI0MCkubmFtZSgnU3RlcCBkdCcpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAncmVmcmVzaEh6JywgMSwgNjAsIDEpLm5hbWUoJ1JlZnJlc2ggSHonKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc2hvd09uSGVsZE9ubHknKS5uYW1lKCdPbmx5IHdoZW4gSGVsZCcpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKCiAgICBjb25zdCBwcmV2aWV3QnRucyA9IHsKICAgICAgICBSZWZyZXNoOiAoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSwKICAgICAgICBIaWRlOiAoKSA9PiB7IGxhYi5wcmV2aWV3LmVuYWJsZWQgPSBmYWxzZTsgY2xlYXJQcmV2aWV3TGluZSgpOyB9CiAgICB9OwogICAgcHJldmlldy5hZGQocHJldmlld0J0bnMsICdSZWZyZXNoJyk7CiAgICBwcmV2aWV3LmFkZChwcmV2aWV3QnRucywgJ0hpZGUnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogUmVjb3JkIC8gUmVwbGF5CiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHJyID0gcm9vdC5hZGRGb2xkZXIoJ1JlY29yZCAvIFJlcGxheScpOwogICAgY29uc3QgcnJQYXJhbXMgPSB7CiAgICAgICAgUmVjb3JkOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcgPSB0cnVlOwogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmZyYW1lcyA9IFtdOwogICAgICAgIH0sCiAgICAgICAgU3RvcDogKCkgPT4gewogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmlzUmVjb3JkaW5nID0gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICBVc2VSZWNvcmRpbmdGb3JSZXBsYXk6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlcGxheS5mcmFtZXMgPSAobGFiLnJlY29yZGluZy5mcmFtZXMgfHwgW10pLnNsaWNlKCk7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaWR4ID0gMDsKICAgICAgICB9LAogICAgICAgIFBsYXk6ICgpID0+IHsKICAgICAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICAgICAgaWYgKCFiKSByZXR1cm47CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaXNSZXBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICBsYWIudGFyZ2V0QmFsbCA9IGI7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaWR4ID0gMDsKICAgICAgICB9LAogICAgICAgIFBhdXNlOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgbGFiLmlzUmVwbGF5aW5nID0gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICBDbGVhcjogKCkgPT4gewogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmZyYW1lcyA9IFtdOwogICAgICAgICAgICBsYWIucmVwbGF5LmZyYW1lcyA9IFtdOwogICAgICAgICAgICBsYWIucmVwbGF5LmlkeCA9IDA7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgbGFiLmlzUmVwbGF5aW5nID0gZmFsc2U7CiAgICAgICAgfQogICAgfTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1JlY29yZCcpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnU3RvcCcpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnVXNlUmVjb3JkaW5nRm9yUmVwbGF5JykubmFtZSgnQ29weSBSZWMgLT4gUmVwbGF5Jyk7CiAgICByci5hZGQobGFiLnJlcGxheSwgJ2xvb3AnKS5uYW1lKCdMb29wJyk7CiAgICByci5hZGQobGFiLnJlcGxheSwgJ3NwZWVkJywgMC4yNSwgNi4wLCAwLjI1KS5uYW1lKCdSZXBsYXkgU3BlZWQnKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1BsYXknKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1BhdXNlJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdDbGVhcicpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBQcmVzZXRzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHByZXNldHMgPSByb290LmFkZEZvbGRlcignUHJlc2V0cycpOwogICAgY29uc3QgUCA9IHsKICAgICAgICBWYW5pbGxhOiAoKSA9PiB7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oQywgewogICAgICAgICAgICAgICAgU1VCU1RFUFM6IDIsCiAgICAgICAgICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMTUsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX1FVQUQ6IDAuMDAyLAogICAgICAgICAgICAgICAgU1BJTl9EUkFHOiAwLjQwLAogICAgICAgICAgICAgICAgTUFHTlVTX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ09FRkY6IDAuMDgsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ0FQOiA2MC4wLAogICAgICAgICAgICAgICAgREVQVEhfVEFSR0VUX1k6IDAuMCwKICAgICAgICAgICAgICAgIERFUFRIX1NQUklORzogMS4wLAogICAgICAgICAgICAgICAgREVQVEhfREFNUDogMS41LAogICAgICAgICAgICAgICAgQk9VTkRBUllfUkFESVVTOiAzMy4wLAogICAgICAgICAgICAgICAgQk9VTkRBUllfSEVJR0hUOiAxNS4wLAogICAgICAgICAgICAgICAgV0FMTF9TT0ZUX0JVRkZFUjogMy4wLAogICAgICAgICAgICAgICAgV0FMTF9TT0ZUX0ZPUkNFOiAyMC4wLAogICAgICAgICAgICAgICAgV0FMTF9FTEFTVElDSVRZOiAwLjMwLAogICAgICAgICAgICAgICAgV0FMTF9GUklDVElPTjogMC45NSwKICAgICAgICAgICAgICAgIEZMT09SX0VMQVNUSUNJVFk6IDAuNDAsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgR09BTF9QT0NLRVRfWDogMTIuMCwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX1o6IDI1LjAsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9SQURJVVM6IDQ1LjAsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfU0NBTEU6IDEuMCwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDg1LjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0sCiAgICAgICAgQXJjYWRlQ3VydmU6ICgpID0+IHsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihDLCB7CiAgICAgICAgICAgICAgICBNQUdOVVNfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIE1BR05VU19DT0VGRjogMC4xNiwKICAgICAgICAgICAgICAgIE1BR05VU19DQVA6IDkwLjAsCiAgICAgICAgICAgICAgICBTUElOX0RSQUc6IDAuMjUsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX0xJTkVBUjogMC4xMiwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDEsCiAgICAgICAgICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDM1LjAsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfQ0FQOiAxMTAuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihUQywgewogICAgICAgICAgICAgICAgQ1VSVkVfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIENVUlZFX1NQSU5fU0NBTEU6IDE1MDAuMCwKICAgICAgICAgICAgICAgIENVUlZFX1NQSU5fQ0FQOiAzMDAwLjAsCiAgICAgICAgICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDcwMC4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsYWIucmVmcmVzaFByZXZpZXcoKTsKICAgICAgICB9LAogICAgICAgIFNuYXBweVJlYWxpc3RpYzogKCkgPT4gewogICAgICAgICAgICBPYmplY3QuYXNzaWduKEMsIHsKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfTElORUFSOiAwLjI1LAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19RVUFEOiAwLjAwNiwKICAgICAgICAgICAgICAgIE1BR05VU19DT0VGRjogMC4wNSwKICAgICAgICAgICAgICAgIE1BR05VU19DQVA6IDQwLjAsCiAgICAgICAgICAgICAgICBTUElOX0RSQUc6IDAuNzUsCiAgICAgICAgICAgICAgICBTVE9QX1NQRUVEOiAwLjA1LAogICAgICAgICAgICAgICAgTEFVTkNIX1NQRUVEX0NBUDogNzAuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfQogICAgfTsKICAgIHByZXNldHMuYWRkKFAsICdWYW5pbGxhJyk7CiAgICBwcmVzZXRzLmFkZChQLCAnQXJjYWRlQ3VydmUnKTsKICAgIHByZXNldHMuYWRkKFAsICdTbmFwcHlSZWFsaXN0aWMnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogU25hcHNob3QgLyBFeHBvcnQKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3Qgc25hcHNob3QgPSByb290LmFkZEZvbGRlcignU25hcHNob3QgLyBFeHBvcnQnKTsKCiAgICBjb25zdCBfcm91bmQgPSAobiwgcGxhY2VzID0gNCkgPT4gewogICAgICAgIGlmICghTnVtYmVyLmlzRmluaXRlKG4pKSByZXR1cm4gbnVsbDsKICAgICAgICBjb25zdCBwID0gTWF0aC5wb3coMTAsIHBsYWNlcyk7CiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQobiAqIHApIC8gcDsKICAgIH07CgogICAgY29uc3QgX3YzID0gKHYsIHBsYWNlcyA9IDQpID0+IHsKICAgICAgICBpZiAoIXYpIHJldHVybiBudWxsOwogICAgICAgIHJldHVybiBbX3JvdW5kKHYueCwgcGxhY2VzKSwgX3JvdW5kKHYueSwgcGxhY2VzKSwgX3JvdW5kKHYueiwgcGxhY2VzKV07CiAgICB9OwoKICAgIGNvbnN0IF9jbG9uZUpzb24gPSAob2JqKSA9PiB7CiAgICAgICAgaWYgKCFvYmopIHJldHVybiBudWxsOwogICAgICAgIHRyeSB7IHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KG9iaikpOyB9IGNhdGNoIChlKSB7IHJldHVybiBudWxsOyB9CiAgICB9OwoKICAgIGNvbnN0IF9wbGF5ZXJTbmFwID0gKHApID0+IHsKICAgICAgICBpZiAoIXApIHJldHVybiBudWxsOwogICAgICAgIGNvbnN0IGFuaW0gPSAocC5hY3RpdmVBY3Rpb24gJiYgcC5hY3RpdmVBY3Rpb24uX2NsaXApID8gcC5hY3RpdmVBY3Rpb24uX2NsaXAubmFtZSA6IChwLnN0YXRlIHx8IG51bGwpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG5hbWU6IHAuY2hhcmFjdGVyTmFtZSB8fCBwLm5hbWUgfHwgbnVsbCwKICAgICAgICAgICAgcm9sZTogcC5yb2xlIHx8IG51bGwsCiAgICAgICAgICAgIHN0YXRlOiBwLnN0YXRlIHx8IG51bGwsCiAgICAgICAgICAgIGhhc0JhbGw6ICEhcC5oYXNCYWxsLAogICAgICAgICAgICBpc1Rocm93aW5nOiAhIXAuaXNUaHJvd2luZywKICAgICAgICAgICAgaXNDaGFyZ2luZzogISFwLmlzQ2hhcmdpbmcsCiAgICAgICAgICAgIGlzRGFzaGluZzogISFwLmlzRGFzaGluZywKICAgICAgICAgICAgZGFzaENvb2xkb3duOiBfcm91bmQocC5kYXNoQ29vbGRvd24sIDQpLAogICAgICAgICAgICBwb3M6IF92MyhwLm1lc2ggJiYgcC5tZXNoLnBvc2l0aW9uKSwKICAgICAgICAgICAgdmVsOiBfdjMocC52ZWxvY2l0eSksCiAgICAgICAgICAgIGlucHV0OiBfdjMocC5pbnB1dFZlY3RvciksCiAgICAgICAgICAgIHN0YXRzOiBwLnN0YXRzID8gX2Nsb25lSnNvbihwLnN0YXRzKSA6IG51bGwsCiAgICAgICAgICAgIGFuaW0KICAgICAgICB9OwogICAgfTsKCiAgICBjb25zdCBfdGVhbVNuYXAgPSAodCkgPT4gewogICAgICAgIGlmICghdCkgcmV0dXJuIG51bGw7CiAgICAgICAgY29uc3QgYWN0aXZlID0gdC5hY3RpdmVQbGF5ZXIgPyBfcGxheWVyU25hcCh0LmFjdGl2ZVBsYXllcikgOiBudWxsOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGlkOiB0LmlkIHx8IG51bGwsCiAgICAgICAgICAgIHNpZGU6IHQuc2lkZSwKICAgICAgICAgICAgaXNIdW1hbjogISF0LmlzSHVtYW4sCiAgICAgICAgICAgIGFpRW5hYmxlZDogISF0LmFpRW5hYmxlZCwKICAgICAgICAgICAgY3VycmVudEZvcm1hdGlvbjogdC5jdXJyZW50Rm9ybWF0aW9uIHx8IG51bGwsCiAgICAgICAgICAgIGFjdGl2ZVBsYXllcjogYWN0aXZlLAogICAgICAgICAgICBwbGF5ZXJzOiBBcnJheS5pc0FycmF5KHQucGxheWVycykgPyB0LnBsYXllcnMubWFwKF9wbGF5ZXJTbmFwKSA6IFtdCiAgICAgICAgfTsKICAgIH07CgogICAgY29uc3QgYnVpbGRTbmFwc2hvdCA9ICgpID0+IHsKICAgICAgICBjb25zdCBnYW1lID0gdGhpcy5nYW1lIHx8IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSB8fCBudWxsOwogICAgICAgIGNvbnN0IGJhbGwgPSBnYW1lICYmIGdhbWUuZW50aXRpZXMgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgIGNvbnN0IGNhbU1nciA9IGdhbWUgPyBnYW1lLmNhbWVyYU1hbmFnZXIgOiBudWxsOwogICAgICAgIGNvbnN0IGNhbSA9IChjYW1NZ3IgJiYgY2FtTWdyLmNhbWVyYSkgPyBjYW1NZ3IuY2FtZXJhIDogKGdhbWUgPyBnYW1lLmNhbWVyYSA6IG51bGwpOwoKICAgICAgICBjb25zdCBiYWxsU25hcCA9IGJhbGwgPyB7CiAgICAgICAgICAgIHN0YXRlOiBiYWxsLnN0YXRlIHx8IG51bGwsCiAgICAgICAgICAgIGlzSW52aXNpYmxlOiAhIWJhbGwuaXNJbnZpc2libGUsCiAgICAgICAgICAgIGhvbGRlcjogYmFsbC5ob2xkZXIgPyAoYmFsbC5ob2xkZXIuY2hhcmFjdGVyTmFtZSB8fCBiYWxsLmhvbGRlci5uYW1lIHx8IG51bGwpIDogbnVsbCwKICAgICAgICAgICAgbGFzdEhvbGRlcjogYmFsbC5sYXN0SG9sZGVyID8gKGJhbGwubGFzdEhvbGRlci5jaGFyYWN0ZXJOYW1lIHx8IGJhbGwubGFzdEhvbGRlci5uYW1lIHx8IG51bGwpIDogbnVsbCwKICAgICAgICAgICAgcG9zOiBfdjMoYmFsbC5tZXNoICYmIGJhbGwubWVzaC5wb3NpdGlvbiksCiAgICAgICAgICAgIHZlbDogX3YzKGJhbGwudmVsb2NpdHkpLAogICAgICAgICAgICBhbmdWZWw6IF92MyhiYWxsLmFuZ3VsYXJWZWxvY2l0eSksCiAgICAgICAgICAgIHBvd2VyOiBfcm91bmQoYmFsbC5wb3dlciwgNCksCiAgICAgICAgICAgIHNob3RUeXBlOiBiYWxsLnNob3RUeXBlIHx8IG51bGwKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgY29uc3QgY2FtZXJhU25hcCA9IGNhbSA/IHsKICAgICAgICAgICAgcG9zOiBfdjMoY2FtLnBvc2l0aW9uKSwKICAgICAgICAgICAgcm90OiBjYW0ucm90YXRpb24gPyBbX3JvdW5kKGNhbS5yb3RhdGlvbi54LCA0KSwgX3JvdW5kKGNhbS5yb3RhdGlvbi55LCA0KSwgX3JvdW5kKGNhbS5yb3RhdGlvbi56LCA0KV0gOiBudWxsLAogICAgICAgICAgICBmb3Y6IF9yb3VuZChjYW0uZm92LCA0KSwKICAgICAgICAgICAgbmVhcjogX3JvdW5kKGNhbS5uZWFyLCA2KSwKICAgICAgICAgICAgZmFyOiBfcm91bmQoY2FtLmZhciwgNCkKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgY29uc3QgY2FtTWdyU25hcCA9IGNhbU1nciA/IHsKICAgICAgICAgICAgbW9kZTogY2FtTWdyLm1vZGUgfHwgbnVsbCwKICAgICAgICAgICAgdGFyZ2V0TmFtZTogKGNhbU1nci50YXJnZXQgJiYgKGNhbU1nci50YXJnZXQuY2hhcmFjdGVyTmFtZSB8fCBjYW1NZ3IudGFyZ2V0Lm5hbWUpKSB8fCBudWxsLAogICAgICAgICAgICBzZXR0aW5nczogY2FtTWdyLnNldHRpbmdzID8gX2Nsb25lSnNvbihjYW1NZ3Iuc2V0dGluZ3MpIDogbnVsbAogICAgICAgIH0gOiBudWxsOwoKICAgICAgICBjb25zdCBkZWJ1Z0lPID0gd2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX2RlYnVnSU8gPyB3aW5kb3cuZmx1eC5fZGVidWdJTyA6IG51bGw7CiAgICAgICAgY29uc3QgaW5wdXRTbmFwID0gZGVidWdJTyA/IHsKICAgICAgICAgICAgc2V0dGluZ3M6IGRlYnVnSU8uc2V0dGluZ3MgPyBfY2xvbmVKc29uKGRlYnVnSU8uc2V0dGluZ3MpIDogbnVsbCwKICAgICAgICAgICAgcGVyZjogZGVidWdJTy5wZXJmID8gX2Nsb25lSnNvbihkZWJ1Z0lPLnBlcmYpIDogbnVsbCwKICAgICAgICAgICAgbW92ZTogKGRlYnVnSU8uaW5wdXQgJiYgZGVidWdJTy5pbnB1dC5tb3ZlKSA/IHsKICAgICAgICAgICAgICAgIHRvdWNoSWQ6IGRlYnVnSU8uaW5wdXQubW92ZS50b3VjaElkID8/IG51bGwsCiAgICAgICAgICAgICAgICBkcmFnZ2luZzogISFkZWJ1Z0lPLmlucHV0Lm1vdmUuZHJhZ2dpbmcsCiAgICAgICAgICAgICAgICB2ZWN0b3I6IGRlYnVnSU8uaW5wdXQubW92ZS52ZWN0b3IgPyBfY2xvbmVKc29uKGRlYnVnSU8uaW5wdXQubW92ZS52ZWN0b3IpIDogbnVsbAogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgYWltOiAoZGVidWdJTy5pbnB1dCAmJiBkZWJ1Z0lPLmlucHV0LmFpbSkgPyB7CiAgICAgICAgICAgICAgICB0b3VjaElkOiBkZWJ1Z0lPLmlucHV0LmFpbS50b3VjaElkID8/IG51bGwsCiAgICAgICAgICAgICAgICBkcmFnZ2luZzogISFkZWJ1Z0lPLmlucHV0LmFpbS5kcmFnZ2luZywKICAgICAgICAgICAgICAgIHZlY3RvcjogZGVidWdJTy5pbnB1dC5haW0udmVjdG9yID8gX2Nsb25lSnNvbihkZWJ1Z0lPLmlucHV0LmFpbS52ZWN0b3IpIDogbnVsbAogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgc3dpcGU6IChkZWJ1Z0lPLmlucHV0ICYmIGRlYnVnSU8uaW5wdXQuc3dpcGUpID8gewogICAgICAgICAgICAgICAgdG91Y2hJZDogZGVidWdJTy5pbnB1dC5zd2lwZS50b3VjaElkID8/IG51bGwsCiAgICAgICAgICAgICAgICBzdGFydDogZGVidWdJTy5pbnB1dC5zd2lwZS5zdGFydCA/IF9jbG9uZUpzb24oZGVidWdJTy5pbnB1dC5zd2lwZS5zdGFydCkgOiBudWxsLAogICAgICAgICAgICAgICAgcG9pbnRzOiBBcnJheS5pc0FycmF5KGRlYnVnSU8uaW5wdXQuc3dpcGUucG9pbnRzKSA/IGRlYnVnSU8uaW5wdXQuc3dpcGUucG9pbnRzLnNsaWNlKC0zMikubWFwKF9jbG9uZUpzb24pIDogW10KICAgICAgICAgICAgfSA6IG51bGwKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbWV0YTogewogICAgICAgICAgICAgICAgdGltZXN0YW1wSVNPOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksCiAgICAgICAgICAgICAgICBocmVmOiAodHlwZW9mIGxvY2F0aW9uICE9PSAndW5kZWZpbmVkJyAmJiBsb2NhdGlvbi5ocmVmKSA/IGxvY2F0aW9uLmhyZWYgOiBudWxsLAogICAgICAgICAgICAgICAgdXNlckFnZW50OiAodHlwZW9mIG5hdmlnYXRvciAhPT0gJ3VuZGVmaW5lZCcgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudCkgPyBuYXZpZ2F0b3IudXNlckFnZW50IDogbnVsbAogICAgICAgICAgICB9LAogICAgICAgICAgICBnYW1lOiBnYW1lID8gewogICAgICAgICAgICAgICAgc2NvcmU6IGdhbWUuc2NvcmUgPyBfY2xvbmVKc29uKGdhbWUuc2NvcmUpIDogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWU6IF9yb3VuZChnYW1lLnRpbWUsIDQpLAogICAgICAgICAgICAgICAgaGFsZjogZ2FtZS5oYWxmID8/IG51bGwsCiAgICAgICAgICAgICAgICBoYWxmRHVyYXRpb246IF9yb3VuZChnYW1lLmhhbGZEdXJhdGlvbiwgNCksCiAgICAgICAgICAgICAgICBpc092ZXJ0aW1lOiAhIWdhbWUuaXNPdmVydGltZSwKICAgICAgICAgICAgICAgIGlzRGVtb01vZGU6ICEhZ2FtZS5pc0RlbW9Nb2RlCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBjb25maWc6IHsKICAgICAgICAgICAgICAgIEJhbGxDb25maWc6ICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnKSA/IF9jbG9uZUpzb24od2luZG93LmZsdXguQmFsbENvbmZpZykgOiBudWxsLAogICAgICAgICAgICAgICAgVGhyb3dDb25maWc6ICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZykgPyBfY2xvbmVKc29uKHdpbmRvdy5mbHV4LlRocm93Q29uZmlnKSA6IG51bGwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2FtZXJhOiBjYW1lcmFTbmFwLAogICAgICAgICAgICBjYW1lcmFNYW5hZ2VyOiBjYW1NZ3JTbmFwLAogICAgICAgICAgICBiYWxsOiBiYWxsU25hcCwKICAgICAgICAgICAgdGVhbXM6IGdhbWUgPyB7CiAgICAgICAgICAgICAgICBob21lOiBfdGVhbVNuYXAoZ2FtZS50ZWFtcyAmJiBnYW1lLnRlYW1zLmhvbWUpLAogICAgICAgICAgICAgICAgYXdheTogX3RlYW1TbmFwKGdhbWUudGVhbXMgJiYgZ2FtZS50ZWFtcy5hd2F5KQogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgaW5wdXQ6IGlucHV0U25hcAogICAgICAgIH07CiAgICB9OwoKICAgIGNvbnN0IF9jb3B5VGV4dCA9IGFzeW5jICh0ZXh0KSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKG5hdmlnYXRvci5jbGlwYm9hcmQgJiYgbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQpIHsKICAgICAgICAgICAgICAgIGF3YWl0IG5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KHRleHQpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIC8vIEZhbGxiYWNrCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgdGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZXh0YXJlYScpOwogICAgICAgICAgICB0YS52YWx1ZSA9IHRleHQ7CiAgICAgICAgICAgIHRhLnN0eWxlLnBvc2l0aW9uID0gJ2ZpeGVkJzsKICAgICAgICAgICAgdGEuc3R5bGUubGVmdCA9ICctOTk5OXB4JzsKICAgICAgICAgICAgdGEuc3R5bGUudG9wID0gJy05OTk5cHgnOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRhKTsKICAgICAgICAgICAgdGEuZm9jdXMoKTsKICAgICAgICAgICAgdGEuc2VsZWN0KCk7CiAgICAgICAgICAgIGNvbnN0IG9rID0gZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0YSk7CiAgICAgICAgICAgIHJldHVybiBvazsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CgogICAgY29uc3QgX2Rvd25sb2FkVGV4dCA9IChmaWxlbmFtZSwgdGV4dCkgPT4gewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbdGV4dF0sIHsgdHlwZTogJ2FwcGxpY2F0aW9uL2pzb24nIH0pOwogICAgICAgICAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOwogICAgICAgICAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgICAgICBhLmhyZWYgPSB1cmw7CiAgICAgICAgICAgIGEuZG93bmxvYWQgPSBmaWxlbmFtZTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhKTsKICAgICAgICAgICAgYS5jbGljaygpOwogICAgICAgICAgICBhLnJlbW92ZSgpOwogICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKHVybCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1NuYXBzaG90IGRvd25sb2FkIGZhaWxlZDonLCBlKTsKICAgICAgICB9CiAgICB9OwoKICAgIGNvbnN0IHNuYXBzaG90QWN0aW9ucyA9IHsKICAgICAgICBDb3B5U25hcHNob3Q6IGFzeW5jICgpID0+IHsKICAgICAgICAgICAgY29uc3Qgc25hcCA9IGJ1aWxkU25hcHNob3QoKTsKICAgICAgICAgICAgY29uc3QgdGV4dCA9IEpTT04uc3RyaW5naWZ5KHNuYXAsIG51bGwsIDIpOwogICAgICAgICAgICBjb25zdCBvayA9IGF3YWl0IF9jb3B5VGV4dCh0ZXh0KTsKICAgICAgICAgICAgY29uc29sZS5sb2coJ1tTbmFwc2hvdF0nLCBzbmFwKTsKICAgICAgICAgICAgaWYgKCFvaykgY29uc29sZS53YXJuKCdTbmFwc2hvdDogY29weSBmYWlsZWQgKHNlZSBjb25zb2xlKS4nKTsKICAgICAgICB9LAogICAgICAgIERvd25sb2FkU25hcHNob3Q6ICgpID0+IHsKICAgICAgICAgICAgY29uc3Qgc25hcCA9IGJ1aWxkU25hcHNob3QoKTsKICAgICAgICAgICAgY29uc3QgdGV4dCA9IEpTT04uc3RyaW5naWZ5KHNuYXAsIG51bGwsIDIpOwogICAgICAgICAgICBfZG93bmxvYWRUZXh0KCdzbmFwc2hvdC5qc29uJywgdGV4dCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbU25hcHNob3RdJywgc25hcCk7CiAgICAgICAgfQogICAgfTsKCiAgICBzbmFwc2hvdC5hZGQoc25hcHNob3RBY3Rpb25zLCAnQ29weVNuYXBzaG90JykubmFtZSgnQ29weSBKU09OIFNuYXBzaG90Jyk7CiAgICBzbmFwc2hvdC5hZGQoc25hcHNob3RBY3Rpb25zLCAnRG93bmxvYWRTbmFwc2hvdCcpLm5hbWUoJ0Rvd25sb2FkIHNuYXBzaG90Lmpzb24nKTsKCn0KICAgIH0KCndpbmRvdy5mbHV4LkRldlRvb2xzID0gRGV2VG9vbHM7CgpEZXZUb29scy5wcm90b3R5cGUuX3NldHVwVmlzdWFsRGVidWcgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1Zpc3VhbCBEZWJ1Z2dpbmcnKTsKICAgICAgICBjb25zdCBkdiA9IHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXI7CiAgICAgICAgaWYgKCFkdikgcmV0dXJuOwoKICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIGVuYWJsZWQ6IGR2LmVuYWJsZWQsCiAgICAgICAgICAgIGhpdGJveGVzOiBkdi5zaG93SGl0Ym94ZXMsCiAgICAgICAgICAgIHZlY3RvcnM6IGR2LnNob3dWZWN0b3JzLAogICAgICAgICAgICBhaTogZHYuc2hvd0FJLAogICAgICAgICAgICBnb2FsVm9sdW1lOiBkdi5zaG93R29hbFZvbHVtZQogICAgICAgIH07CgogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZW5hYmxlZCcpLm5hbWUoJ0VuYWJsZSBWaXN1YWxpemVyJykub25DaGFuZ2UodiA9PiBkdi5lbmFibGVkID0gdik7CiAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdoaXRib3hlcycpLm5hbWUoJ1Nob3cgSGl0Ym94ZXMnKS5vbkNoYW5nZSh2ID0+IGR2LnNob3dIaXRib3hlcyA9IHYpOwogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndmVjdG9ycycpLm5hbWUoJ1Nob3cgVmVjdG9ycycpLm9uQ2hhbmdlKHYgPT4gZHYuc2hvd1ZlY3RvcnMgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2FpJykubmFtZSgnU2hvdyBBSSBQZXJjZXB0aW9uJykub25DaGFuZ2UodiA9PiBkdi5zaG93QUkgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2dvYWxWb2x1bWUnKS5uYW1lKCdTaG93IEdvYWwgVm9sdW1lJykub25DaGFuZ2UodiA9PiBkdi5zaG93R29hbFZvbHVtZSA9IHYpOwogICAgfTsKCiAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwRlhMYWIgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0ZYIExhYiAmIFVJIFRlc3QnKTsKICAgICAgICAKICAgICAgICBjb25zdCBnZXRUYXJnZXRQb3MgPSAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIHJldHVybiBwICYmIHAubWVzaCA/IHAubWVzaC5wb3NpdGlvbiA6IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDIsIDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGZ4UGFyYW1zID0gewogICAgICAgICAgICBTcGF3blZlbm9tOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCd2ZW5vbScsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25OYXA6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ25hcCcsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25XaXRoZXI6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3dpdGhlcicsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25MZWFybmVkOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bkNsYXNoOiAoKSA9PiB0aGlzLmdhbWUuc3Bhd25DbGFzaChnZXRUYXJnZXRQb3MoKSksCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgZnhTdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdQYXJ0aWNsZXMnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3blZlbm9tJyk7CiAgICAgICAgZnhTdWIuYWRkKGZ4UGFyYW1zLCAnU3Bhd25OYXAnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3bldpdGhlcicpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduTGVhcm5lZCcpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduQ2xhc2gnKTsKCiAgICAgICAgY29uc3QgdHh0UGFyYW1zID0gewogICAgICAgICAgICBUZXh0OiAiVEVTVCIsCiAgICAgICAgICAgIFR5cGU6ICJkYW1hZ2UiLAogICAgICAgICAgICBTcGF3bjogKCkgPT4gewogICAgICAgICAgICAgICAgaWYodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bih0eHRQYXJhbXMuVGV4dCwgZ2V0VGFyZ2V0UG9zKCksIHR4dFBhcmFtcy5UeXBlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgY29uc3QgdHh0U3ViID0gZm9sZGVyLmFkZEZvbGRlcignRmxvYXRpbmcgVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVHlwZScsIFsnZGFtYWdlJywgJ2hlYWwnLCAnc3RhdHVzJywgJ3RlY2gnLCAnY29taWMtaW1wYWN0JywgJ2NvbWljLWFjdGlvbicsICdzYXZlJywgJ2Jsb2NrJywgJ2RlZmF1bHQnXSk7CiAgICAgICAgdHh0U3ViLmFkZCh0eHRQYXJhbXMsICdTcGF3bicpLm5hbWUoJ1NwYXduIFRleHQnKTsKCiAgICAgICAgY29uc3QgY2FtUGFyYW1zID0gewogICAgICAgICAgICBTaGFrZVNtYWxsOiAoKSA9PiB0aGlzLmdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpLAogICAgICAgICAgICBTaGFrZUJpZzogKCkgPT4gdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMi4wKSwKICAgICAgICAgICAgSW1wYWN0TGlnaHQ6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMSwgJ2RlZmF1bHQnKSwKICAgICAgICAgICAgSW1wYWN0SGVhdnk6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMiwgJ2hlYXZ5JyksCiAgICAgICAgICAgIEltcGFjdFNoYXR0ZXI6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuNCwgJ3NoYXR0ZXInKSwKICAgICAgICB9OwoKICAgICAgICBjb25zdCBjYW1TdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdDYW1lcmEgJiBJbXBhY3QnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlU21hbGwnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlQmlnJyk7CiAgICAgICAgY2FtU3ViLmFkZChjYW1QYXJhbXMsICdJbXBhY3RMaWdodCcpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnSW1wYWN0SGVhdnknKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ0ltcGFjdFNoYXR0ZXInKTsKICAgIH07CgoKRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFZpc3VhbHMgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0Fzc2V0IEZvcmdlJyk7CiAgICAgICAgCiAgICAgICAgY29uc3QgZm9yZ2VTdGF0ZSA9IHsKICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgYXNzZXROYW1lOiAnVGlkdXMnLAogICAgICAgICAgICBhbmltTmFtZTogJ2lkbGUnLAogICAgICAgICAgICBwb3NYOiAwLCBwb3NZOiAwLCBwb3NaOiAwLAogICAgICAgICAgICByb3RYOiAwLCByb3RZOiAwLCByb3RaOiAwLAogICAgICAgICAgICBzY2FsZTogMS4wLAogICAgICAgICAgICBjYW1EaXN0OiA1LCBjYW1IZWlnaHQ6IDEuNSwgY2FtUm90OiAwCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgYXNzZXRzID0gewogICAgICAgICAgICAnVGlkdXMnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2RhNzg4YmVmMjU4YzRmMGI4ZDllZjFhY2MxOWM1NTY3LmdsYicsCiAgICAgICAgICAgICdXYWtrYSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJywKICAgICAgICAgICAgJ0xldHR5JzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy80M2FjZTM0YzZmZDk0MjE1OTY3ZTg0MmJmOTA5ZGE1ZS5nbGInLAogICAgICAgICAgICAnRGF0dG8nOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2U2ZDY3ZWNiMmU0YzQ3MTViZDczYTQwNzk1ZTFkM2Q1LmdsYicsCiAgICAgICAgICAgICdKYXNzdSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJywKICAgICAgICAgICAgJ0JvdHRhJzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hZDE1NWVmZWRjMGQ0OGZkYWQwOWRhM2UxY2FlOWM5Ny5nbGInLAogICAgICAgICAgICAnQmFsbCc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTIxYWU4Nzg4ZTU4NGUzNzhhNzlkOTczMmEwNzUzNTYuZ2xiJywKICAgICAgICAgICAgJ0dvYWwnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2E1MTZiZDkwZmE3YzRkZWRiNWRjYmZkZjgwM2YxM2Q1LmdsYicKICAgICAgICB9OwoKICAgICAgICBsZXQgY3VycmVudEFzc2V0ID0gbnVsbDsKCiAgICAgICAgY29uc3QgdXBkYXRlVHJhbnNmb3JtID0gKCkgPT4gewogICAgICAgICAgICBpZiAoY3VycmVudEFzc2V0KSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQucG9zaXRpb24uc2V0KGZvcmdlU3RhdGUucG9zWCwgZm9yZ2VTdGF0ZS5wb3NZLCBmb3JnZVN0YXRlLnBvc1opOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0LnJvdGF0aW9uLnNldChmb3JnZVN0YXRlLnJvdFgsIGZvcmdlU3RhdGUucm90WSwgZm9yZ2VTdGF0ZS5yb3RaKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRBc3NldC5zY2FsZS5zZXRTY2FsYXIoZm9yZ2VTdGF0ZS5zY2FsZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjb25zdCB1cGRhdGVDYW1lcmEgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghZm9yZ2VTdGF0ZS5hY3RpdmUpIHJldHVybjsKICAgICAgICAgICAgLy8gT3JiaXQgYXJvdW5kICgxMDAwLCBZLCAxMDAwKQogICAgICAgICAgICBjb25zdCBjeCA9IDEwMDAgKyBNYXRoLnNpbihmb3JnZVN0YXRlLmNhbVJvdCkgKiBmb3JnZVN0YXRlLmNhbURpc3Q7CiAgICAgICAgICAgIGNvbnN0IGN6ID0gMTAwMCArIE1hdGguY29zKGZvcmdlU3RhdGUuY2FtUm90KSAqIGZvcmdlU3RhdGUuY2FtRGlzdDsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhbWVyYS5wb3NpdGlvbi5zZXQoY3gsIGZvcmdlU3RhdGUuY2FtSGVpZ2h0LCBjeik7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW1lcmEubG9va0F0KDEwMDAsIGZvcmdlU3RhdGUucG9zWSArIDEsIDEwMDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IHBsYXlBbmltYXRpb24gPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghdGhpcy52aXpNaXhlciB8fCAhdGhpcy52aXpDbGlwcykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnZpek1peGVyLnN0b3BBbGxBY3Rpb24oKTsKICAgICAgICAgICAgaWYgKGZvcmdlU3RhdGUuYW5pbU5hbWUgPT09ICdub25lJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUgPT09IGZvcmdlU3RhdGUuYW5pbU5hbWUpOwogICAgICAgICAgICBpZiAoIWNsaXApIGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhmb3JnZVN0YXRlLmFuaW1OYW1lLnRvTG93ZXJDYXNlKCkpKTsKICAgICAgICAgICAgaWYgKGNsaXApIHRoaXMudml6TWl4ZXIuY2xpcEFjdGlvbihjbGlwKS5wbGF5KCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3Qgc3Bhd25Bc3NldCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBwcmV2aW91cwogICAgICAgICAgICB3aGlsZSh0aGlzLnZpekdyb3VwLmNoaWxkcmVuLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy52aXpHcm91cC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucmVtb3ZlKGNoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52aXpNaXhlciA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnRBc3NldCA9IG51bGw7CgogICAgICAgICAgICBjb25zdCB1cmwgPSBhc3NldHNbZm9yZ2VTdGF0ZS5hc3NldE5hbWVdOwogICAgICAgICAgICBpZiAoIXVybCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc29sZS5sb2coIkZvcmdlOiBTcGF3bmluZyIsIGZvcmdlU3RhdGUuYXNzZXROYW1lKTsKCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbCh1cmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSBhcmUgc3RpbGwgaW4gZm9yZ2UgbW9kZSBiZWZvcmUgYWRkaW5nCiAgICAgICAgICAgICAgICBpZiAoIWZvcmdlU3RhdGUuYWN0aXZlKSByZXR1cm47CgogICAgICAgICAgICAgICAgY29uc3QgbW9kZWwgPSBnbHRmLnNjZW5lOwogICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cC5hZGQobW9kZWwpOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0ID0gbW9kZWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IG1vZGVsIHRyYW5zZm9ybSByZWxhdGl2ZSB0byBncm91cAogICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIG1vZGVsLnJvdGF0aW9uLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZVRyYW5zZm9ybSgpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmLmFuaW1hdGlvbnMgJiYgZ2x0Zi5hbmltYXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpek1peGVyID0gbmV3IFRIUkVFLkFuaW1hdGlvbk1peGVyKG1vZGVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekNsaXBzID0gZ2x0Zi5hbmltYXRpb25zOwogICAgICAgICAgICAgICAgICAgIHBsYXlBbmltYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgdG9nZ2xlRm9yZ2UgPSAoaXNBY3RpdmUpID0+IHsKICAgICAgICAgICAgZm9yZ2VTdGF0ZS5hY3RpdmUgPSBpc0FjdGl2ZTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlzRm9yZ2VNb2RlID0gaXNBY3RpdmU7IC8vIENyaXRpY2FsOiBUZWxsIG1haW4uanMgdG8gc3RvcCBnYW1lIGxvb3AKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBHYW1lIFZpc2liaWxpdHkgKEhpZGUgZXZlcnl0aGluZyBpbiB0aGUgbWFpbiBhcmVuYSkKICAgICAgICAgICAgY29uc3QgZ2FtZUxheWVyID0gW3RoaXMuZ2FtZS50ZWFtcy5ob21lLCB0aGlzLmdhbWUudGVhbXMuYXdheSwgdGhpcy5nYW1lLmVudGl0aWVzLmJhbGxdOwogICAgICAgICAgICBnYW1lTGF5ZXIuZm9yRWFjaCh0ID0+IHsKICAgICAgICAgICAgICAgIGlmKHQgJiYgdC5wbGF5ZXJzKSB0LnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsgfSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmKHQgJiYgdC5tZXNoKSB0Lm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCkgd2luZG93LmZsdXguYXJlbmFNZXNoLnZpc2libGUgPSAhaXNBY3RpdmU7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIpIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLnN0YWRpdW0gJiYgdGhpcy5nYW1lLnN0YWRpdW0uY29udGFpbmVyKSB0aGlzLmdhbWUuc3RhZGl1bS5jb250YWluZXIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLndhdGVyT3ZlcmxheSAmJiB0aGlzLmdhbWUud2F0ZXJPdmVybGF5Lm1lc2gpIHRoaXMuZ2FtZS53YXRlck92ZXJsYXkubWVzaC52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBVSQogICAgICAgICAgICBjb25zdCB1aSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpOwogICAgICAgICAgICBpZih1aSkgdWkuc3R5bGUuZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2ZsZXgnOwoKICAgICAgICAgICAgaWYgKGlzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIEZvcmdlIFNjZW5lIGlmIG5lZWRlZAogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwUGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy52aXpHcm91cFBhcmVudCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucG9zaXRpb24uc2V0KDEwMDAsIDAsIDEwMDApOyAvLyBGYXIgYXdheSBmcm9tIGFyZW5hCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQodGhpcy52aXpHcm91cCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdyaWQgPSBuZXcgVEhSRUUuR3JpZEhlbHBlcigyMCwgMjAsIDB4MDBmZmZmLCAweDQ0NDQ0NCk7CiAgICAgICAgICAgICAgICAgICAgZ3JpZC5wb3NpdGlvbi5zZXQoMTAwMCwgMCwgMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQoZ3JpZCk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMudml6TGlnaHQgPSBuZXcgVEhSRUUuRGlyZWN0aW9uYWxMaWdodCgweGZmZmZmZiwgMS4wKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnBvc2l0aW9uLnNldCgxMDA1LCAxMCwgMTAwNSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZCh0aGlzLnZpekxpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekFtYmllbnQgPSBuZXcgVEhSRUUuQW1iaWVudExpZ2h0KDB4NDA0MDQwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKHRoaXMudml6QW1iaWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXBQYXJlbnQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy52aXpBbWJpZW50LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzcGF3bkFzc2V0KCk7CiAgICAgICAgICAgICAgICB1cGRhdGVDYW1lcmEoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBHYW1lCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpHcm91cFBhcmVudCkgdGhpcy52aXpHcm91cFBhcmVudC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpMaWdodCkgdGhpcy52aXpMaWdodC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpBbWJpZW50KSB0aGlzLnZpekFtYmllbnQudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYSBiYWNrIHRvIGdhbWUgdGFyZ2V0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIpIHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZm9sZGVyLmFkZChmb3JnZVN0YXRlLCAnYWN0aXZlJykubmFtZSgnRW5hYmxlIEZvcmdlJykub25DaGFuZ2UodG9nZ2xlRm9yZ2UpOwogICAgICAgIGZvbGRlci5hZGQoZm9yZ2VTdGF0ZSwgJ2Fzc2V0TmFtZScsIE9iamVjdC5rZXlzKGFzc2V0cykpLm5hbWUoJ1NlbGVjdCBBc3NldCcpLm9uQ2hhbmdlKHNwYXduQXNzZXQpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRmID0gZm9sZGVyLmFkZEZvbGRlcignVHJhbnNmb3JtJyk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NYJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NZJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NaJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdyb3RYJywgMCwgNi4yOCkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3JvdFknLCAwLCA2LjI4KS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwogICAgICAgIHRmLmFkZChmb3JnZVN0YXRlLCAncm90WicsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdzY2FsZScsIDAuMSwgMy4wKS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwoKICAgICAgICBmb2xkZXIuYWRkKGZvcmdlU3RhdGUsICdhbmltTmFtZScsIFsnbm9uZScsICdpZGxlJywgJ3N3aW0nLCAndGhyb3cnLCAnY2F0Y2gnLCAncmVhY3QnXSkubmFtZSgnQW5pbWF0aW9uJykub25DaGFuZ2UocGxheUFuaW1hdGlvbik7CgogICAgICAgIGNvbnN0IGNmID0gZm9sZGVyLmFkZEZvbGRlcignQ2FtZXJhJyk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1EaXN0JywgMiwgMTUpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1IZWlnaHQnLCAwLCAxMCkub25DaGFuZ2UodXBkYXRlQ2FtZXJhKTsKICAgICAgICBjZi5hZGQoZm9yZ2VTdGF0ZSwgJ2NhbVJvdCcsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CgogICAgICAgIC8vIEhvb2sgR2FtZSBMb29wCiAgICAgICAgY29uc3Qgb3JpZ2luYWxVcGRhdGUgPSB0aGlzLmdhbWUudXBkYXRlLmJpbmQodGhpcy5nYW1lKTsKICAgICAgICB0aGlzLmdhbWUudXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIGlmIChmb3JnZVN0YXRlLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgLy8gRm9yZ2UgTW9kZTogT25seSB1cGRhdGUgZm9yZ2UgY29tcG9uZW50cyBhbmQgcmVuZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpNaXhlcikgdGhpcy52aXpNaXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGb3JjZSBDYW1lcmEgVXBkYXRlIGhlcmUgc2luY2UgbWFpbi5qcyBsb29wIGlzIHNraXBwZWQKICAgICAgICAgICAgICAgIHVwZGF0ZUNhbWVyYSgpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucmVuZGVyZXIgJiYgdGhpcy5nYW1lLnNjZW5lICYmIHRoaXMuZ2FtZS5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIucmVuZGVyKHRoaXMuZ2FtZS5zY2VuZSwgdGhpcy5nYW1lLmNhbWVyYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOb3JtYWwgTW9kZTogUnVuIHN0YW5kYXJkIGdhbWUgdXBkYXRlCiAgICAgICAgICAgICAgICBvcmlnaW5hbFVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKfSkoKTs=","DebugVisualizer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBEZWJ1Z1Zpc3VhbGl6ZXIgewpjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dWZWN0b3JzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0FJID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0dvYWxWb2x1bWUgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMudmlzdWFscyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hdGVyaWFscwogICAgICAgICAgICB0aGlzLm1hdFRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4yIH0pOwogICAgICAgICAgICB0aGlzLm1hdENhdGNoID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZjAwLCB3aXJlZnJhbWU6IHRydWUsIHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjIgfSk7CiAgICAgICAgICAgIHRoaXMubWF0VmVsID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZjAwIH0pOyAvLyBZZWxsb3cgVmVsb2NpdHkKICAgICAgICAgICAgdGhpcy5tYXRJbnB1dCA9IG5ldyBUSFJFRS5MaW5lQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiB9KTsgLy8gQ3lhbiBJbnB1dAogICAgICAgICAgICB0aGlzLm1hdEFJID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmYwMGZmIH0pOyAvLyBNYWdlbnRhIEFJIFBlcmNlcHRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJpZXMKICAgICAgICAgICAgdGhpcy5nZW9DeWxpbmRlciA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEsIDEsIDAuMSwgMTYpOwogICAgICAgICAgICB0aGlzLmdlb0N5bGluZGVyLnRyYW5zbGF0ZSgwLCAwLjA1LCAwKTsKCiAgICAgICAgICAgIC8vIEdvYWwgVm9sdW1lIFZpc3VhbGl6YXRpb24gKFJlZCBUcmFuc3BhcmVudCBCb3gpCiAgICAgICAgICAgIGNvbnN0IGdvYWxHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoMjIsIDE4LCAxMCk7CiAgICAgICAgICAgIGNvbnN0IGdvYWxNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmMDAwMCwgCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLjI1LCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UgCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMSA9IG5ldyBUSFJFRS5NZXNoKGdvYWxHZW8sIGdvYWxNYXQpOwogICAgICAgICAgICB0aGlzLmdvYWxWb2wxLnBvc2l0aW9uLnNldCgwLCAtNC41LCAtNTApOyAvLyBIb21lIEdvYWwgWm9uZSAoLTQ1IHRvIC01NSkKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuZ29hbFZvbDEpOwoKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMiA9IG5ldyBUSFJFRS5NZXNoKGdvYWxHZW8sIGdvYWxNYXQpOwogICAgICAgICAgICB0aGlzLmdvYWxWb2wyLnBvc2l0aW9uLnNldCgwLCAtNC41LCA1MCk7IC8vIEF3YXkgR29hbCBab25lICg0NSB0byA1NSkKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMi52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuZ29hbFZvbDIpOwogICAgICAgIH0KCnVwZGF0ZSgpIHsKICAgICAgICAgICAgLy8gVXBkYXRlIHN0YXRpYyBkZWJ1Z3MKICAgICAgICAgICAgaWYgKHRoaXMuZ29hbFZvbDEpIHRoaXMuZ29hbFZvbDEudmlzaWJsZSA9IHRoaXMuZW5hYmxlZCAmJiB0aGlzLnNob3dHb2FsVm9sdW1lOwogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMikgdGhpcy5nb2FsVm9sMi52aXNpYmxlID0gdGhpcy5lbmFibGVkICYmIHRoaXMuc2hvd0dvYWxWb2x1bWU7CgogICAgICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMudmlzdWFscy5zaXplID4gMCkgdGhpcy5jbGVhcigpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIWdhbWUudGVhbXMuaG9tZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZW50aXRpZXMgPSBbCiAgICAgICAgICAgICAgICAuLi5nYW1lLnRlYW1zLmhvbWUucGxheWVycywKICAgICAgICAgICAgICAgIC4uLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLAogICAgICAgICAgICAgICAgZ2FtZS5lbnRpdGllcy5iYWxsCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBlbnRpdGllcy5mb3JFYWNoKGUgPT4gewogICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHYgPSB0aGlzLnZpc3VhbHMuZ2V0KGUpOwogICAgICAgICAgICAgICAgaWYgKCF2KSB7CiAgICAgICAgICAgICAgICAgICAgdiA9IHRoaXMuY3JlYXRlVmlzdWFsKGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmlzdWFscy5zZXQoZSwgdik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbChlLCB2KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBjcmVhdGVWaXN1YWwoZW50aXR5KSB7CiAgICAgICAgICAgIGNvbnN0IGdyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKGdyb3VwKTsKCiAgICAgICAgICAgIC8vIEhpdGJveGVzCiAgICAgICAgICAgIGNvbnN0IHRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoKHRoaXMuZ2VvQ3lsaW5kZXIsIHRoaXMubWF0VGFja2xlKTsKICAgICAgICAgICAgY29uc3QgY2F0Y2hSID0gbmV3IFRIUkVFLk1lc2godGhpcy5nZW9DeWxpbmRlciwgdGhpcy5tYXRDYXRjaCk7CiAgICAgICAgICAgIGdyb3VwLmFkZCh0YWNrbGUpOwogICAgICAgICAgICBncm91cC5hZGQoY2F0Y2hSKTsKCiAgICAgICAgICAgIC8vIExpbmVzCiAgICAgICAgICAgIGNvbnN0IHZlbExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRWZWwpOwogICAgICAgICAgICBjb25zdCBpbnB1dExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRJbnB1dCk7CiAgICAgICAgICAgIGNvbnN0IGFpTGluZSA9IHRoaXMuY3JlYXRlTGluZSh0aGlzLm1hdEFJKTsgLy8gTGluZSB0byBwZXJjZWl2ZWQgdGFyZ2V0CiAgICAgICAgICAgIAogICAgICAgICAgICBncm91cC5hZGQodmVsTGluZSk7CiAgICAgICAgICAgIGdyb3VwLmFkZChpbnB1dExpbmUpOwogICAgICAgICAgICBncm91cC5hZGQoYWlMaW5lKTsKCiAgICAgICAgICAgIHJldHVybiB7IGdyb3VwLCB0YWNrbGUsIGNhdGNoUiwgdmVsTGluZSwgaW5wdXRMaW5lLCBhaUxpbmUgfTsKICAgICAgICB9CgogICAgICAgIGNyZWF0ZUxpbmUobWF0KSB7CiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpLnNldEZyb21Qb2ludHMoW25ldyBUSFJFRS5WZWN0b3IzKCksIG5ldyBUSFJFRS5WZWN0b3IzKCldKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5MaW5lKGdlbywgbWF0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUxpbmUobGluZSwgc3RhcnQsIGVuZCkgewogICAgICAgICAgICBjb25zdCBwb3MgPSBsaW5lLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24uYXJyYXk7CiAgICAgICAgICAgIHBvc1swXSA9IHN0YXJ0Lng7IHBvc1sxXSA9IHN0YXJ0Lnk7IHBvc1syXSA9IHN0YXJ0Lno7CiAgICAgICAgICAgIHBvc1szXSA9IGVuZC54OyBwb3NbNF0gPSBlbmQueTsgcG9zWzVdID0gZW5kLno7CiAgICAgICAgICAgIGxpbmUuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGxpbmUudmlzaWJsZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWwoZSwgdikgewogICAgICAgICAgICB2Lmdyb3VwLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGl0Ym94ZXMgKExvY2FsIHRvIGVudGl0eSBwb3NpdGlvbikKICAgICAgICAgICAgdi50YWNrbGUucG9zaXRpb24uY29weShlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB2LmNhdGNoUi5wb3NpdGlvbi5jb3B5KGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5zaG93SGl0Ym94ZXMgJiYgZS5yb2xlKSB7CiAgICAgICAgICAgICAgICB2LnRhY2tsZS52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnN0IHJUID0gZS50YWNrbGVSYWRpdXMgfHwgMi41OwogICAgICAgICAgICAgICAgdi50YWNrbGUuc2NhbGUuc2V0KHJULCAxLCByVCk7CgogICAgICAgICAgICAgICAgdi5jYXRjaFIudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBMb2dpYyBmcm9tIG1haW4uanMgY2hlY2tCYWxsR3JhYgogICAgICAgICAgICAgICAgY29uc3QgckMgPSBlLmlzRGFzaGluZyA/IDQuMCA6IDIuNTsgCiAgICAgICAgICAgICAgICB2LmNhdGNoUi5zY2FsZS5zZXQockMsIDEsIHJDKTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnBvc2l0aW9uLnkgPSBlLm1lc2gucG9zaXRpb24ueSArIDAuMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYudGFja2xlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVmVjdG9ycyAoR2xvYmFsIGxpbmVzKQogICAgICAgICAgICBjb25zdCBvcmlnaW4gPSBlLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgb3JpZ2luLnkgKz0gMS4wOyAvLyBMaWZ0IHVwCgogICAgICAgICAgICBpZiAodGhpcy5zaG93VmVjdG9ycykgewogICAgICAgICAgICAgICAgLy8gVmVsb2NpdHkKICAgICAgICAgICAgICAgIGlmIChlLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTGluZSh2LnZlbExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElucHV0CiAgICAgICAgICAgICAgICBpZiAoZS5pbnB1dFZlY3RvciAmJiBlLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUuaW5wdXRWZWN0b3IuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigzLjApKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxpbmUodi5pbnB1dExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdi5pbnB1dExpbmUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdi52ZWxMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuaW5wdXRMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQUkKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd0FJICYmIGUucGVyY2VpdmVkVGFyZ2V0UG9zKSB7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGxpbmUgdG8gcGVyY2VpdmVkIHRhcmdldAogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVMaW5lKHYuYWlMaW5lLCBvcmlnaW4sIGUucGVyY2VpdmVkVGFyZ2V0UG9zKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYuYWlMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2xlYXIoKSB7CiAgICAgICAgICAgIHRoaXMudmlzdWFscy5mb3JFYWNoKHYgPT4gewogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5yZW1vdmUodi5ncm91cCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnZpc3VhbHMuY2xlYXIoKTsKICAgICAgICB9CiAgICB9CiAgICB3aW5kb3cuZmx1eC5EZWJ1Z1Zpc3VhbGl6ZXIgPSBEZWJ1Z1Zpc3VhbGl6ZXI7Cn0pKCk7","./DebugVisualizer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBEZWJ1Z1Zpc3VhbGl6ZXIgewpjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dWZWN0b3JzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0FJID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0dvYWxWb2x1bWUgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMudmlzdWFscyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hdGVyaWFscwogICAgICAgICAgICB0aGlzLm1hdFRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4yIH0pOwogICAgICAgICAgICB0aGlzLm1hdENhdGNoID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZjAwLCB3aXJlZnJhbWU6IHRydWUsIHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjIgfSk7CiAgICAgICAgICAgIHRoaXMubWF0VmVsID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZjAwIH0pOyAvLyBZZWxsb3cgVmVsb2NpdHkKICAgICAgICAgICAgdGhpcy5tYXRJbnB1dCA9IG5ldyBUSFJFRS5MaW5lQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiB9KTsgLy8gQ3lhbiBJbnB1dAogICAgICAgICAgICB0aGlzLm1hdEFJID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmYwMGZmIH0pOyAvLyBNYWdlbnRhIEFJIFBlcmNlcHRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJpZXMKICAgICAgICAgICAgdGhpcy5nZW9DeWxpbmRlciA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEsIDEsIDAuMSwgMTYpOwogICAgICAgICAgICB0aGlzLmdlb0N5bGluZGVyLnRyYW5zbGF0ZSgwLCAwLjA1LCAwKTsKCiAgICAgICAgICAgIC8vIEdvYWwgVm9sdW1lIFZpc3VhbGl6YXRpb24gKFJlZCBUcmFuc3BhcmVudCBCb3gpCiAgICAgICAgICAgIGNvbnN0IGdvYWxHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoMjIsIDE4LCAxMCk7CiAgICAgICAgICAgIGNvbnN0IGdvYWxNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmMDAwMCwgCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLjI1LCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UgCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMSA9IG5ldyBUSFJFRS5NZXNoKGdvYWxHZW8sIGdvYWxNYXQpOwogICAgICAgICAgICB0aGlzLmdvYWxWb2wxLnBvc2l0aW9uLnNldCgwLCAtNC41LCAtNTApOyAvLyBIb21lIEdvYWwgWm9uZSAoLTQ1IHRvIC01NSkKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuZ29hbFZvbDEpOwoKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMiA9IG5ldyBUSFJFRS5NZXNoKGdvYWxHZW8sIGdvYWxNYXQpOwogICAgICAgICAgICB0aGlzLmdvYWxWb2wyLnBvc2l0aW9uLnNldCgwLCAtNC41LCA1MCk7IC8vIEF3YXkgR29hbCBab25lICg0NSB0byA1NSkKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMi52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuZ29hbFZvbDIpOwogICAgICAgIH0KCnVwZGF0ZSgpIHsKICAgICAgICAgICAgLy8gVXBkYXRlIHN0YXRpYyBkZWJ1Z3MKICAgICAgICAgICAgaWYgKHRoaXMuZ29hbFZvbDEpIHRoaXMuZ29hbFZvbDEudmlzaWJsZSA9IHRoaXMuZW5hYmxlZCAmJiB0aGlzLnNob3dHb2FsVm9sdW1lOwogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMikgdGhpcy5nb2FsVm9sMi52aXNpYmxlID0gdGhpcy5lbmFibGVkICYmIHRoaXMuc2hvd0dvYWxWb2x1bWU7CgogICAgICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMudmlzdWFscy5zaXplID4gMCkgdGhpcy5jbGVhcigpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIWdhbWUudGVhbXMuaG9tZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZW50aXRpZXMgPSBbCiAgICAgICAgICAgICAgICAuLi5nYW1lLnRlYW1zLmhvbWUucGxheWVycywKICAgICAgICAgICAgICAgIC4uLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLAogICAgICAgICAgICAgICAgZ2FtZS5lbnRpdGllcy5iYWxsCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBlbnRpdGllcy5mb3JFYWNoKGUgPT4gewogICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHYgPSB0aGlzLnZpc3VhbHMuZ2V0KGUpOwogICAgICAgICAgICAgICAgaWYgKCF2KSB7CiAgICAgICAgICAgICAgICAgICAgdiA9IHRoaXMuY3JlYXRlVmlzdWFsKGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmlzdWFscy5zZXQoZSwgdik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbChlLCB2KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBjcmVhdGVWaXN1YWwoZW50aXR5KSB7CiAgICAgICAgICAgIGNvbnN0IGdyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKGdyb3VwKTsKCiAgICAgICAgICAgIC8vIEhpdGJveGVzCiAgICAgICAgICAgIGNvbnN0IHRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoKHRoaXMuZ2VvQ3lsaW5kZXIsIHRoaXMubWF0VGFja2xlKTsKICAgICAgICAgICAgY29uc3QgY2F0Y2hSID0gbmV3IFRIUkVFLk1lc2godGhpcy5nZW9DeWxpbmRlciwgdGhpcy5tYXRDYXRjaCk7CiAgICAgICAgICAgIGdyb3VwLmFkZCh0YWNrbGUpOwogICAgICAgICAgICBncm91cC5hZGQoY2F0Y2hSKTsKCiAgICAgICAgICAgIC8vIExpbmVzCiAgICAgICAgICAgIGNvbnN0IHZlbExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRWZWwpOwogICAgICAgICAgICBjb25zdCBpbnB1dExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRJbnB1dCk7CiAgICAgICAgICAgIGNvbnN0IGFpTGluZSA9IHRoaXMuY3JlYXRlTGluZSh0aGlzLm1hdEFJKTsgLy8gTGluZSB0byBwZXJjZWl2ZWQgdGFyZ2V0CiAgICAgICAgICAgIAogICAgICAgICAgICBncm91cC5hZGQodmVsTGluZSk7CiAgICAgICAgICAgIGdyb3VwLmFkZChpbnB1dExpbmUpOwogICAgICAgICAgICBncm91cC5hZGQoYWlMaW5lKTsKCiAgICAgICAgICAgIHJldHVybiB7IGdyb3VwLCB0YWNrbGUsIGNhdGNoUiwgdmVsTGluZSwgaW5wdXRMaW5lLCBhaUxpbmUgfTsKICAgICAgICB9CgogICAgICAgIGNyZWF0ZUxpbmUobWF0KSB7CiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpLnNldEZyb21Qb2ludHMoW25ldyBUSFJFRS5WZWN0b3IzKCksIG5ldyBUSFJFRS5WZWN0b3IzKCldKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5MaW5lKGdlbywgbWF0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUxpbmUobGluZSwgc3RhcnQsIGVuZCkgewogICAgICAgICAgICBjb25zdCBwb3MgPSBsaW5lLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24uYXJyYXk7CiAgICAgICAgICAgIHBvc1swXSA9IHN0YXJ0Lng7IHBvc1sxXSA9IHN0YXJ0Lnk7IHBvc1syXSA9IHN0YXJ0Lno7CiAgICAgICAgICAgIHBvc1szXSA9IGVuZC54OyBwb3NbNF0gPSBlbmQueTsgcG9zWzVdID0gZW5kLno7CiAgICAgICAgICAgIGxpbmUuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGxpbmUudmlzaWJsZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWwoZSwgdikgewogICAgICAgICAgICB2Lmdyb3VwLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGl0Ym94ZXMgKExvY2FsIHRvIGVudGl0eSBwb3NpdGlvbikKICAgICAgICAgICAgdi50YWNrbGUucG9zaXRpb24uY29weShlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB2LmNhdGNoUi5wb3NpdGlvbi5jb3B5KGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5zaG93SGl0Ym94ZXMgJiYgZS5yb2xlKSB7CiAgICAgICAgICAgICAgICB2LnRhY2tsZS52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnN0IHJUID0gZS50YWNrbGVSYWRpdXMgfHwgMi41OwogICAgICAgICAgICAgICAgdi50YWNrbGUuc2NhbGUuc2V0KHJULCAxLCByVCk7CgogICAgICAgICAgICAgICAgdi5jYXRjaFIudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBMb2dpYyBmcm9tIG1haW4uanMgY2hlY2tCYWxsR3JhYgogICAgICAgICAgICAgICAgY29uc3QgckMgPSBlLmlzRGFzaGluZyA/IDQuMCA6IDIuNTsgCiAgICAgICAgICAgICAgICB2LmNhdGNoUi5zY2FsZS5zZXQockMsIDEsIHJDKTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnBvc2l0aW9uLnkgPSBlLm1lc2gucG9zaXRpb24ueSArIDAuMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYudGFja2xlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVmVjdG9ycyAoR2xvYmFsIGxpbmVzKQogICAgICAgICAgICBjb25zdCBvcmlnaW4gPSBlLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgb3JpZ2luLnkgKz0gMS4wOyAvLyBMaWZ0IHVwCgogICAgICAgICAgICBpZiAodGhpcy5zaG93VmVjdG9ycykgewogICAgICAgICAgICAgICAgLy8gVmVsb2NpdHkKICAgICAgICAgICAgICAgIGlmIChlLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTGluZSh2LnZlbExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElucHV0CiAgICAgICAgICAgICAgICBpZiAoZS5pbnB1dFZlY3RvciAmJiBlLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUuaW5wdXRWZWN0b3IuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigzLjApKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxpbmUodi5pbnB1dExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdi5pbnB1dExpbmUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdi52ZWxMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuaW5wdXRMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQUkKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd0FJICYmIGUucGVyY2VpdmVkVGFyZ2V0UG9zKSB7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGxpbmUgdG8gcGVyY2VpdmVkIHRhcmdldAogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVMaW5lKHYuYWlMaW5lLCBvcmlnaW4sIGUucGVyY2VpdmVkVGFyZ2V0UG9zKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYuYWlMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2xlYXIoKSB7CiAgICAgICAgICAgIHRoaXMudmlzdWFscy5mb3JFYWNoKHYgPT4gewogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5yZW1vdmUodi5ncm91cCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnZpc3VhbHMuY2xlYXIoKTsKICAgICAgICB9CiAgICB9CiAgICB3aW5kb3cuZmx1eC5EZWJ1Z1Zpc3VhbGl6ZXIgPSBEZWJ1Z1Zpc3VhbGl6ZXI7Cn0pKCk7","/DebugVisualizer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBEZWJ1Z1Zpc3VhbGl6ZXIgewpjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dWZWN0b3JzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0FJID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0dvYWxWb2x1bWUgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMudmlzdWFscyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hdGVyaWFscwogICAgICAgICAgICB0aGlzLm1hdFRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4yIH0pOwogICAgICAgICAgICB0aGlzLm1hdENhdGNoID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZjAwLCB3aXJlZnJhbWU6IHRydWUsIHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjIgfSk7CiAgICAgICAgICAgIHRoaXMubWF0VmVsID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZjAwIH0pOyAvLyBZZWxsb3cgVmVsb2NpdHkKICAgICAgICAgICAgdGhpcy5tYXRJbnB1dCA9IG5ldyBUSFJFRS5MaW5lQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiB9KTsgLy8gQ3lhbiBJbnB1dAogICAgICAgICAgICB0aGlzLm1hdEFJID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmYwMGZmIH0pOyAvLyBNYWdlbnRhIEFJIFBlcmNlcHRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJpZXMKICAgICAgICAgICAgdGhpcy5nZW9DeWxpbmRlciA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEsIDEsIDAuMSwgMTYpOwogICAgICAgICAgICB0aGlzLmdlb0N5bGluZGVyLnRyYW5zbGF0ZSgwLCAwLjA1LCAwKTsKCiAgICAgICAgICAgIC8vIEdvYWwgVm9sdW1lIFZpc3VhbGl6YXRpb24gKFJlZCBUcmFuc3BhcmVudCBCb3gpCiAgICAgICAgICAgIGNvbnN0IGdvYWxHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoMjIsIDE4LCAxMCk7CiAgICAgICAgICAgIGNvbnN0IGdvYWxNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmMDAwMCwgCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLjI1LCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UgCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMSA9IG5ldyBUSFJFRS5NZXNoKGdvYWxHZW8sIGdvYWxNYXQpOwogICAgICAgICAgICB0aGlzLmdvYWxWb2wxLnBvc2l0aW9uLnNldCgwLCAtNC41LCAtNTApOyAvLyBIb21lIEdvYWwgWm9uZSAoLTQ1IHRvIC01NSkKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuZ29hbFZvbDEpOwoKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMiA9IG5ldyBUSFJFRS5NZXNoKGdvYWxHZW8sIGdvYWxNYXQpOwogICAgICAgICAgICB0aGlzLmdvYWxWb2wyLnBvc2l0aW9uLnNldCgwLCAtNC41LCA1MCk7IC8vIEF3YXkgR29hbCBab25lICg0NSB0byA1NSkKICAgICAgICAgICAgdGhpcy5nb2FsVm9sMi52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuZ29hbFZvbDIpOwogICAgICAgIH0KCnVwZGF0ZSgpIHsKICAgICAgICAgICAgLy8gVXBkYXRlIHN0YXRpYyBkZWJ1Z3MKICAgICAgICAgICAgaWYgKHRoaXMuZ29hbFZvbDEpIHRoaXMuZ29hbFZvbDEudmlzaWJsZSA9IHRoaXMuZW5hYmxlZCAmJiB0aGlzLnNob3dHb2FsVm9sdW1lOwogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMikgdGhpcy5nb2FsVm9sMi52aXNpYmxlID0gdGhpcy5lbmFibGVkICYmIHRoaXMuc2hvd0dvYWxWb2x1bWU7CgogICAgICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMudmlzdWFscy5zaXplID4gMCkgdGhpcy5jbGVhcigpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIWdhbWUudGVhbXMuaG9tZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZW50aXRpZXMgPSBbCiAgICAgICAgICAgICAgICAuLi5nYW1lLnRlYW1zLmhvbWUucGxheWVycywKICAgICAgICAgICAgICAgIC4uLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLAogICAgICAgICAgICAgICAgZ2FtZS5lbnRpdGllcy5iYWxsCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBlbnRpdGllcy5mb3JFYWNoKGUgPT4gewogICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHYgPSB0aGlzLnZpc3VhbHMuZ2V0KGUpOwogICAgICAgICAgICAgICAgaWYgKCF2KSB7CiAgICAgICAgICAgICAgICAgICAgdiA9IHRoaXMuY3JlYXRlVmlzdWFsKGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmlzdWFscy5zZXQoZSwgdik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbChlLCB2KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBjcmVhdGVWaXN1YWwoZW50aXR5KSB7CiAgICAgICAgICAgIGNvbnN0IGdyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKGdyb3VwKTsKCiAgICAgICAgICAgIC8vIEhpdGJveGVzCiAgICAgICAgICAgIGNvbnN0IHRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoKHRoaXMuZ2VvQ3lsaW5kZXIsIHRoaXMubWF0VGFja2xlKTsKICAgICAgICAgICAgY29uc3QgY2F0Y2hSID0gbmV3IFRIUkVFLk1lc2godGhpcy5nZW9DeWxpbmRlciwgdGhpcy5tYXRDYXRjaCk7CiAgICAgICAgICAgIGdyb3VwLmFkZCh0YWNrbGUpOwogICAgICAgICAgICBncm91cC5hZGQoY2F0Y2hSKTsKCiAgICAgICAgICAgIC8vIExpbmVzCiAgICAgICAgICAgIGNvbnN0IHZlbExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRWZWwpOwogICAgICAgICAgICBjb25zdCBpbnB1dExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRJbnB1dCk7CiAgICAgICAgICAgIGNvbnN0IGFpTGluZSA9IHRoaXMuY3JlYXRlTGluZSh0aGlzLm1hdEFJKTsgLy8gTGluZSB0byBwZXJjZWl2ZWQgdGFyZ2V0CiAgICAgICAgICAgIAogICAgICAgICAgICBncm91cC5hZGQodmVsTGluZSk7CiAgICAgICAgICAgIGdyb3VwLmFkZChpbnB1dExpbmUpOwogICAgICAgICAgICBncm91cC5hZGQoYWlMaW5lKTsKCiAgICAgICAgICAgIHJldHVybiB7IGdyb3VwLCB0YWNrbGUsIGNhdGNoUiwgdmVsTGluZSwgaW5wdXRMaW5lLCBhaUxpbmUgfTsKICAgICAgICB9CgogICAgICAgIGNyZWF0ZUxpbmUobWF0KSB7CiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpLnNldEZyb21Qb2ludHMoW25ldyBUSFJFRS5WZWN0b3IzKCksIG5ldyBUSFJFRS5WZWN0b3IzKCldKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5MaW5lKGdlbywgbWF0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUxpbmUobGluZSwgc3RhcnQsIGVuZCkgewogICAgICAgICAgICBjb25zdCBwb3MgPSBsaW5lLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24uYXJyYXk7CiAgICAgICAgICAgIHBvc1swXSA9IHN0YXJ0Lng7IHBvc1sxXSA9IHN0YXJ0Lnk7IHBvc1syXSA9IHN0YXJ0Lno7CiAgICAgICAgICAgIHBvc1szXSA9IGVuZC54OyBwb3NbNF0gPSBlbmQueTsgcG9zWzVdID0gZW5kLno7CiAgICAgICAgICAgIGxpbmUuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGxpbmUudmlzaWJsZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWwoZSwgdikgewogICAgICAgICAgICB2Lmdyb3VwLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGl0Ym94ZXMgKExvY2FsIHRvIGVudGl0eSBwb3NpdGlvbikKICAgICAgICAgICAgdi50YWNrbGUucG9zaXRpb24uY29weShlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB2LmNhdGNoUi5wb3NpdGlvbi5jb3B5KGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5zaG93SGl0Ym94ZXMgJiYgZS5yb2xlKSB7CiAgICAgICAgICAgICAgICB2LnRhY2tsZS52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnN0IHJUID0gZS50YWNrbGVSYWRpdXMgfHwgMi41OwogICAgICAgICAgICAgICAgdi50YWNrbGUuc2NhbGUuc2V0KHJULCAxLCByVCk7CgogICAgICAgICAgICAgICAgdi5jYXRjaFIudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBMb2dpYyBmcm9tIG1haW4uanMgY2hlY2tCYWxsR3JhYgogICAgICAgICAgICAgICAgY29uc3QgckMgPSBlLmlzRGFzaGluZyA/IDQuMCA6IDIuNTsgCiAgICAgICAgICAgICAgICB2LmNhdGNoUi5zY2FsZS5zZXQockMsIDEsIHJDKTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnBvc2l0aW9uLnkgPSBlLm1lc2gucG9zaXRpb24ueSArIDAuMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYudGFja2xlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVmVjdG9ycyAoR2xvYmFsIGxpbmVzKQogICAgICAgICAgICBjb25zdCBvcmlnaW4gPSBlLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgb3JpZ2luLnkgKz0gMS4wOyAvLyBMaWZ0IHVwCgogICAgICAgICAgICBpZiAodGhpcy5zaG93VmVjdG9ycykgewogICAgICAgICAgICAgICAgLy8gVmVsb2NpdHkKICAgICAgICAgICAgICAgIGlmIChlLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTGluZSh2LnZlbExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElucHV0CiAgICAgICAgICAgICAgICBpZiAoZS5pbnB1dFZlY3RvciAmJiBlLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUuaW5wdXRWZWN0b3IuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigzLjApKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxpbmUodi5pbnB1dExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdi5pbnB1dExpbmUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdi52ZWxMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuaW5wdXRMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQUkKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd0FJICYmIGUucGVyY2VpdmVkVGFyZ2V0UG9zKSB7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGxpbmUgdG8gcGVyY2VpdmVkIHRhcmdldAogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVMaW5lKHYuYWlMaW5lLCBvcmlnaW4sIGUucGVyY2VpdmVkVGFyZ2V0UG9zKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYuYWlMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2xlYXIoKSB7CiAgICAgICAgICAgIHRoaXMudmlzdWFscy5mb3JFYWNoKHYgPT4gewogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5yZW1vdmUodi5ncm91cCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnZpc3VhbHMuY2xlYXIoKTsKICAgICAgICB9CiAgICB9CiAgICB3aW5kb3cuZmx1eC5EZWJ1Z1Zpc3VhbGl6ZXIgPSBEZWJ1Z1Zpc3VhbGl6ZXI7Cn0pKCk7","MenuManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNZW51TWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3IoZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZU1hbmFnZXI7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tbWVudScpOwogICAgICAgICAgICB0aGlzLml0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLm1lbnUtaXRlbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zZXR1cEV2ZW50cygpOwogICAgICAgIH0KCiAgICAgICAgc2V0dXBFdmVudHMoKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIFByZXZlbnQgY2xpY2stdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlU2VsZWN0aW9uKGl0ZW0uZGF0YXNldC5hY3Rpb24pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignbW91c2VlbnRlcicsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAvLyBPcHRpb25hbDogUGxheSBob3ZlciBzb3VuZAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaGFuZGxlU2VsZWN0aW9uKGFjdGlvbikgewogICAgICAgICAgICBjb25zb2xlLmxvZygiTWVudSBTZWxlY3Rpb246IiwgYWN0aW9uKTsKICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ25vcm1hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ25vcm1hbCcpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhcnRNYXRjaCgncHJhY3RpY2UnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdiYWxsX2xhYicpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGwgPSAnYmFsbF9sYWInOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ3ByYWN0aWNlJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnb3B0aW9ucycpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJPcHRpb25zIGNsaWNrZWQgKE5vdCBpbXBsZW1lbnRlZCkiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2hvdygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGlkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZShmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguTWVudU1hbmFnZXIgPSBNZW51TWFuYWdlcjsKfSkoKTs=","./MenuManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNZW51TWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3IoZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZU1hbmFnZXI7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tbWVudScpOwogICAgICAgICAgICB0aGlzLml0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLm1lbnUtaXRlbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zZXR1cEV2ZW50cygpOwogICAgICAgIH0KCiAgICAgICAgc2V0dXBFdmVudHMoKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIFByZXZlbnQgY2xpY2stdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlU2VsZWN0aW9uKGl0ZW0uZGF0YXNldC5hY3Rpb24pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignbW91c2VlbnRlcicsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAvLyBPcHRpb25hbDogUGxheSBob3ZlciBzb3VuZAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaGFuZGxlU2VsZWN0aW9uKGFjdGlvbikgewogICAgICAgICAgICBjb25zb2xlLmxvZygiTWVudSBTZWxlY3Rpb246IiwgYWN0aW9uKTsKICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ25vcm1hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ25vcm1hbCcpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhcnRNYXRjaCgncHJhY3RpY2UnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdiYWxsX2xhYicpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGwgPSAnYmFsbF9sYWInOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ3ByYWN0aWNlJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnb3B0aW9ucycpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJPcHRpb25zIGNsaWNrZWQgKE5vdCBpbXBsZW1lbnRlZCkiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2hvdygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGlkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZShmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguTWVudU1hbmFnZXIgPSBNZW51TWFuYWdlcjsKfSkoKTs=","/MenuManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNZW51TWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3IoZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZU1hbmFnZXI7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tbWVudScpOwogICAgICAgICAgICB0aGlzLml0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLm1lbnUtaXRlbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zZXR1cEV2ZW50cygpOwogICAgICAgIH0KCiAgICAgICAgc2V0dXBFdmVudHMoKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIFByZXZlbnQgY2xpY2stdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlU2VsZWN0aW9uKGl0ZW0uZGF0YXNldC5hY3Rpb24pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignbW91c2VlbnRlcicsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAvLyBPcHRpb25hbDogUGxheSBob3ZlciBzb3VuZAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaGFuZGxlU2VsZWN0aW9uKGFjdGlvbikgewogICAgICAgICAgICBjb25zb2xlLmxvZygiTWVudSBTZWxlY3Rpb246IiwgYWN0aW9uKTsKICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ25vcm1hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ25vcm1hbCcpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhcnRNYXRjaCgncHJhY3RpY2UnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdiYWxsX2xhYicpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGwgPSAnYmFsbF9sYWInOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ3ByYWN0aWNlJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnb3B0aW9ucycpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJPcHRpb25zIGNsaWNrZWQgKE5vdCBpbXBsZW1lbnRlZCkiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2hvdygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGlkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZShmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguTWVudU1hbmFnZXIgPSBNZW51TWFuYWdlcjsKfSkoKTs=","PracticeManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQcmFjdGljZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREcmlsbCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZSA9IHt9OyAKICAgICAgICAgICAgCnRoaXMuZHJpbGxzID0gewogICAgICAgICAgICAgICAgJ2ZyZWUnOiB7IG5hbWU6ICdGUkVFIFJPQU0nLCBzZXR1cDogdGhpcy5fc2V0dXBGcmVlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BGcmVlLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdiYWxsX2xhYic6IHsgbmFtZTogJ0JBTEwgTEFCJywgc2V0dXA6IHRoaXMuX3NldHVwQmFsbExhYi5iaW5kKHRoaXMpLCBsb29wOiB0aGlzLl9sb29wQmFsbExhYi5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAnc2hvb3RpbmcnOiB7IG5hbWU6ICdTSE9PVElORyBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cFNob290aW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BTaG9vdGluZy5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncGFzc2luZyc6IHsgbmFtZTogJ1BBU1NJTkcgRFJJTEwnLCBzZXR1cDogdGhpcy5fc2V0dXBQYXNzaW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BQYXNzaW5nLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdkZWZlbnNlJzogeyBuYW1lOiAnREVGRU5TRSBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cERlZmVuc2UuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcERlZmVuc2UuYmluZCh0aGlzKSB9LAogICAgICAgICAgICAgICAgJ2N1cnZlJzogeyBuYW1lOiAnQ1VSVkUgU0hPVCcsIHNldHVwOiB0aGlzLl9zZXR1cEN1cnZlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BDdXJ2ZS5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncmFwaWRfZmlyZSc6IHsgbmFtZTogJ1JBUElEIEZJUkUnLCBzZXR1cDogdGhpcy5fc2V0dXBSYXBpZEZpcmUuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcFJhcGlkRmlyZS5iaW5kKHRoaXMpIH0KICAgICAgICAgICAgfTsKCnRoaXMudWkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2Utb3ZlcmxheScpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dlc3R1cmUtaGludCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gewogICAgICAgICAgICAgICAgaW5mU3RhdHM6IHRydWUsCiAgICAgICAgICAgICAgICBhaUR1bW15OiB0cnVlLAogICAgICAgICAgICAgICAgc2hvd0hpdGJveGVzOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy50YXJnZXRSaW5nID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107IC8vIEFycmF5IHRvIHRyYWNrIHZpc3VhbCBjb3BpZXMgb2YgdGhyb3duIGJhbGxzCiAgICAgICAgICAgIHRoaXMuX2luaXRWaXN1YWxzKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwRXZlbnRzKCk7CiAgICAgICAgfQoKICAgICAgICBfaW5pdFZpc3VhbHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBhIGdsb3dpbmcgcmluZyBmb3IgdGFyZ2V0cwogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMS41LCAxLjgsIDMyKTsKICAgICAgICAgICAgZ2VvbWV0cnkucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBmZmZmLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gQWRkIHRvIHNjZW5lIHZpYSBnYW1lIG1hbmFnZXIgcmVmZXJlbmNlCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc2NlbmUpIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy50YXJnZXRSaW5nKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0KCkgewp0aGlzLmlzUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAvLyBJZiBtZW51IHJlcXVlc3RlZCBhIHNwZWNpZmljIGRyaWxsIChlLmcuLCBCYWxsIExhYiksIGhvbm9yIGl0IG9uY2UuCiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGw7CiAgICAgICAgICAgIGlmIChyZXEgJiYgdGhpcy5kcmlsbHNbcmVxXSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChyZXEpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXgucmVxdWVzdGVkUHJhY3RpY2VEcmlsbCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldERyaWxsKCdmcmVlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBIVUQgaXMgdmlzaWJsZQogICAgICAgICAgICBjb25zdCBodWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKTsKICAgICAgICAgICAgaWYoaHVkKSBodWQuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICB9CgogICAgICAgIHN0b3AoKSB7CgogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlUGFuZWwoKTsKICAgICAgICAgICAgdGhpcy5faGlkZVJlc3RvcmVCdG4oKTsKdGhpcy5fY2xlYXJEcmlsbCgpOwogICAgICAgICAgICAKLy8gQ2xlYXIgR2hvc3QgQmFsbHMKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYi5tZXNoKSB0aGlzLmdhbWUuc2NlbmUucmVtb3ZlKGIubWVzaCk7CiAgICAgICAgICAgICAgICBpZiAoYi50cmFpbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50cmFpbC5tZXNoLmdlb21ldHJ5KSBiLnRyYWlsLm1lc2guZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gZmFsc2U7CgogICAgICAgICAgICAvLyBSZXN0b3JlIEF3YXkgVGVhbSBWaXNpYmlsaXR5IGZvciBOb3JtYWwgTWF0Y2gKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSAwOyAvLyBFbnN1cmUgdGhleSBhcmVuJ3Qgc3R1Y2sgdW5kZXIgZmxvb3IKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGlzYWJsZSBkZWJ1ZyB2aXN1YWxzIGlmIHRoZXkgd2VyZSBvbgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXREcmlsbChrZXkpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmRyaWxsc1trZXldKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuX2NsZWFyRHJpbGwoKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RHJpbGwgPSBrZXk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkucXVlcnlTZWxlY3RvckFsbCgnLmRyaWxsLWJ0bicpLmZvckVhY2goYnRuID0+IHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJywgYnRuLmRhdGFzZXQuZHJpbGwgPT09IGtleSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUnVuIFNldHVwCiAgICAgICAgICAgIHRoaXMuZHJpbGxzW2tleV0uc2V0dXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFubm91bmNlbWVudAogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnNob3dBbm5vdW5jZW1lbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zaG93QW5ub3VuY2VtZW50KHRoaXMuZHJpbGxzW2tleV0ubmFtZSwgJ25vcm1hbCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzUnVubmluZykgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ29tbW9uIFByYWN0aWNlIExvZ2ljIChJbmZpbml0ZSBTdGF0cykKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5pbmZTdGF0cykgewogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbmZpbml0ZVN0YXRzKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERyaWxsIExvZ2ljCiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnREcmlsbCAmJiB0aGlzLmRyaWxsc1t0aGlzLmN1cnJlbnREcmlsbF0ubG9vcCkgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbHNbdGhpcy5jdXJyZW50RHJpbGxdLmxvb3AoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXN1YWxzIEFuaW1hdGlvbgovLyBWaXN1YWxzIEFuaW1hdGlvbgogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nICYmIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucm90YXRpb24ueiArPSBkdDsgLy8gU3BpbgogICAgICAgICAgICAgICAgY29uc3QgcyA9IDEuMCArIE1hdGguc2luKERhdGUubm93KCkgKiAwLjAwNSkgKiAwLjE7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcuc2NhbGUuc2V0KHMsIHMsIHMpOwogICAgICAgICAgICB9CgovLyBVcGRhdGUgR2hvc3QgQmFsbHMKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2hvc3RCYWxscy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2hvc3RCYWxsc1tpXTsKICAgICAgICAgICAgICAgIGIubGlmZSAtPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gLS0tIFBIWVNJQ1MgJiBWSVNVQUxTIERFTEVHQVRJT04gLS0tCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguQmFsbCAmJiB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZS51cGRhdGVGcmVlKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlRnJlZS5jYWxsKGIsIGR0KTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZS51cGRhdGVWaXN1YWxzLmNhbGwoYiwgZHQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBUcmFpbAogICAgICAgICAgICAgICAgaWYgKGIudHJhaWwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFpbFBvcyA9IGIubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChiLmRlZm9ybU5vZGUpIHRyYWlsUG9zLnkgKz0gYi5kZWZvcm1Ob2RlLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICAgICAgYi50cmFpbC51cGRhdGUodHJhaWxQb3MpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIC0tLSBHT0FMIERFVEVDVElPTiBGT1IgR0hPU1QgQkFMTFMgLS0tCiAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBiLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICAvLyBDaGVjayBaIGRlcHRoIChHb2FsIGlzIGF0ICsvLSAyOCwgdHJpZ2dlciBhdCAyOSkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueikgPiAyOS4wKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gR29hbCBCb3ggRGltZW5zaW9ucyAoTWF0Y2hlcyBHYW1lTWFuYWdlcikKICAgICAgICAgICAgICAgICAgICBjb25zdCBoYWxmV2lkdGggPSAxMS4wOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhbGZIZWlnaHQgPSA5LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbFlPZmZzZXQgPSAtNC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueCkgPD0gaGFsZldpZHRoICYmIE1hdGguYWJzKHBvcy55IC0gZ29hbFlPZmZzZXQpIDw9IGhhbGZIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR09BTCEKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIEdvYWwgRlgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIHBvcywgeyBzY2FsZTogOC4wLCBsaWZlOiAwLjUgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIHBvcywgeyBzY2FsZTogNS4wIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVicmlzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGs9MDsgazwxMDsgaysrKSB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdkZWJyaXMnLCBwb3MsIHsgc2NhbGU6IDAuNSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiR09BTCIsIHBvcywgImdvYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAvLyBLaWxsIGJhbGwgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgICAgICAgICAgYi5saWZlID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2xlYW51cAogICAgICAgICAgICAgICAgaWYgKGIubGlmZSA8PSAwIHx8IGIubWVzaC5wb3NpdGlvbi55IDwgLTEwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLnJlbW92ZShiLm1lc2gpOwogICAgICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGIudHJhaWwubWVzaC5nZW9tZXRyeSkgYi50cmFpbC5tZXNoLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3NldHVwRXZlbnRzKCkgewoKICAgICAgICAgICAgLy8gTWluaW1pemUgLyBSZXN0b3JlCiAgICAgICAgICAgIGNvbnN0IG1pbkJ0biA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI3AtbWluaW1pemUnKTsKICAgICAgICAgICAgaWYgKG1pbkJ0bikgewogICAgICAgICAgICAgICAgbWluQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVQYW5lbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dSZXN0b3JlQnRuKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgcmVzdG9yZUJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcmFjdGljZS1yZXN0b3JlLWJ0bicpOwogICAgICAgICAgICBpZiAocmVzdG9yZUJ0bikgewogICAgICAgICAgICAgICAgcmVzdG9yZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93UGFuZWwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUmVzdG9yZUJ0bigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERyaWxsIEJ1dHRvbnMKICAgICAgICAgICAgdGhpcy51aS5xdWVyeVNlbGVjdG9yQWxsKCcuZHJpbGwtYnRuJykuZm9yRWFjaChidG4gPT4gewogICAgICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RHJpbGwoYnRuLmRhdGFzZXQuZHJpbGwpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUmVzZXQgQmFsbAogICAgICAgICAgICBjb25zdCByZXNldEJ0biA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI3AtcmVzZXQtYmFsbCcpOwogICAgICAgICAgICBpZiAocmVzZXRCdG4pIHsKICAgICAgICAgICAgICAgIHJlc2V0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRXhpdAogICAgICAgICAgICBjb25zdCBleGl0QnRuID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjcC1leGl0Jyk7CiAgICAgICAgICAgIGlmIChleGl0QnRuKSB7CiAgICAgICAgICAgICAgICBleGl0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlci5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9wdGlvbnMgVG9nZ2xlcwogICAgICAgICAgICB0aGlzLl9iaW5kVG9nZ2xlKCdvcHQtaW5mLXN0YXQnLCAnaW5mU3RhdHMnKTsKICAgICAgICAgICAgdGhpcy5fYmluZFRvZ2dsZSgnb3B0LWFpLWR1bW15JywgJ2FpRHVtbXknLCAodmFsKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgQUkgRHVtbXkgc3RhdGUgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LmFpRW5hYmxlZCA9ICF2YWw7IC8vIElmIGR1bW15IGlzIFRSVUUsIEFJIGlzIEZBTFNFCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9iaW5kVG9nZ2xlKCdvcHQtaGl0Ym94ZXMnLCAnc2hvd0hpdGJveGVzJywgKHZhbCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLmVuYWJsZWQgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5zaG93SGl0Ym94ZXMgPSB2YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gS2V5Ym9hcmQgU2hvcnRjdXQgZm9yIFJlc2V0IChSKQovLyBLZXlib2FyZCBTaG9ydGN1dCBmb3IgUmVzZXQgKFIpCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzUnVubmluZyAmJiBlLmtleS50b0xvd2VyQ2FzZSgpID09PSAncicgJiYgIWUucmVwZWF0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKX2JpbmRUb2dnbGUoaWQsIG9wdGlvbktleSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgY29uc3QgZWwgPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoYCMke2lkfWApOwogICAgICAgICAgICBpZiAoIWVsKSByZXR1cm47CgogICAgICAgICAgICAvLyBIZWxwZXIgdG8gdXBkYXRlIHZpc3VhbHMKICAgICAgICAgICAgY29uc3QgdXBkYXRlVmlzdWFsID0gKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgaXNBY3RpdmUgPSB0aGlzLm9wdGlvbnNbb3B0aW9uS2V5XTsKICAgICAgICAgICAgICAgIGVsLmNsYXNzTGlzdC50b2dnbGUoJ2FjdGl2ZScsIGlzQWN0aXZlKTsKICAgICAgICAgICAgICAgIGNvbnN0IGJveCA9IGVsLnF1ZXJ5U2VsZWN0b3IoJy5jaGVja2JveCcpOwogICAgICAgICAgICAgICAgaWYgKGJveCkgYm94LmlubmVyVGV4dCA9IGlzQWN0aXZlID8gJ+KWoycgOiAn4pahJzsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgdmlzdWFsIHN0YXRlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIHVwZGF0ZVZpc3VhbCgpOwoKICAgICAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9uc1tvcHRpb25LZXldID0gIXRoaXMub3B0aW9uc1tvcHRpb25LZXldOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB1cGRhdGVWaXN1YWwoKTsKCiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKHRoaXMub3B0aW9uc1tvcHRpb25LZXldKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKCiAgICAgICAgX3NldHVwQmFsbExhYigpIHsKICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIkJBTEwgTEFCOiBPcGVuIERldlRvb2xzIOKGkiBCYWxsIExhYi4gVXNlIFNob3QgQ2Fubm9uICsgdHJhamVjdG9yeSBwcmV2aWV3ICsgcmVjb3JkL3JlcGxheS4iKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKCiAgICAgICAgICAgIGNvbnN0IGhvbWUgPSB0aGlzLmdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgY29uc3QgYXdheSA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5OwogICAgICAgICAgICBjb25zdCBwID0gaG9tZSA/IGhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKICAgICAgICAgICAgaWYgKCFwKSByZXR1cm47CgogICAgICAgICAgICAvLyBTb2xvIG1vZGU6IGhpZGUgZXZlcnlvbmUgZXhjZXB0IHRoZSBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmIChob21lICYmIGhvbWUucGxheWVycykgewogICAgICAgICAgICAgICAgaG9tZS5wbGF5ZXJzLmZvckVhY2gobWF0ZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGUubWVzaCkgbWF0ZS5tZXNoLnZpc2libGUgPSAobWF0ZSA9PT0gcCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXdheSAmJiBhd2F5LnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGF3YXkucGxheWVycy5mb3JFYWNoKG9wcCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wcC5tZXNoKSBvcHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUGxhY2UgYWN0aXZlIHBsYXllciBhdCBjZW50ZXIgZmFjaW5nIHRoZSBhd2F5IGdvYWwKICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLTI4KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgaWYgKHAuc3luY1JvdGF0aW9uKSBwLnN5bmNSb3RhdGlvbigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCaWcgc3RhdHMgc28geW91IGNhbiB0ZXN0IGV4dHJlbWVzCiAgICAgICAgICAgIGlmIChwLnN0YXRzKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlBBID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkVOID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLm1heEhQID0gTWF0aC5tYXgocC5zdGF0cy5tYXhIUCB8fCA5OTksIDk5OSk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkhQID0gcC5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQSBjbGVhciB0YXJnZXQgbWFya2VyIChwdXJlbHkgdmlzdWFsKQogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uc2V0KDAsIDAuMSwgLTE4KTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZjAwZmYpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KCiAgICAgICAgX2xvb3BCYWxsTGFiKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgaWYgKCFiIHx8ICFwKSByZXR1cm47CgogICAgICAgICAgICAvLyBBdXRvLXJlc2V0IGJhbGwgYmFjayB0byBwbGF5ZXIgb25jZSBpdCBjb21lcyB0byByZXN0LAogICAgICAgICAgICAvLyBzbyB5b3UgY2FuIHNwYW0gdmFyaWF0aW9ucyB3aXRob3V0IHRvdWNoaW5nIGFueXRoaW5nLgogICAgICAgICAgICBpZiAoYi5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzdG9wcGVkID0gKGIudmVsb2NpdHkubGVuZ3RoU3EoKSA8IDAuMDEpICYmIChiLnBvd2VyIDw9IDAuMDEpOwogICAgICAgICAgICAgICAgaWYgKHN0b3BwZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gKHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgfHwgMCkgKyBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA+IDAuNDUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbGlnaHQgdGFyZ2V0IGJvYiAoaGVscHMgZGVwdGggcGVyY2VwdGlvbikKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZyAmJiB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnkgPSAwLjEgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDMpICogMC4wNTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5SW5maW5pdGVTdGF0cygpIHsKICAgICAgICAgICAgY29uc3QgaG9tZSA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBpZiAoaG9tZSkgewogICAgICAgICAgICAgICAgaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7CiAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSBwLnN0YXRzLkVOOwogICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLnZlbm9tID0gMDsKICAgICAgICAgICAgICAgICAgICBwLnN0YXR1cy5uYXAgPSAwOwogICAgICAgICAgICAgICAgICAgIHAuc3R1blRpbWVyID0gMDsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2xlYXJEcmlsbCgpIHsKCiAgICAgICAgICAgIC8vIFJlc2V0IHBvc2l0aW9ucywgY2xlYXIgZHVtbWllcywgcmVzZXQgc2NvcmUKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCkgY2xlYXJUaW1lb3V0KHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCk7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZSA9IHsgc2NvcmU6IDAsIHRpbWVyOiAwLCBzdGFnZTogMCwgcmVzZXR0aW5nOiBmYWxzZSB9OwogICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKDApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2xlYXIgR2x5cGhzCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZ2x5cGhNYW5hZ2VyKSB0aGlzLmdhbWUuZ2x5cGhNYW5hZ2VyLmNsZWFyKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUmVzZXQgdGVhbXMgdG8gZGVmYXVsdCBwb3NpdGlvbnMKCiAgICAgICAgICAgIC8vIFJlc2V0IHRlYW1zIHRvIGRlZmF1bHQgcG9zaXRpb25zCiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5ob21lLnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBBSSBEdW1teSBzZXR0aW5nCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gIXRoaXMub3B0aW9ucy5haUR1bW15OwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEhpZGUgYXdheSB0ZWFtIGJ5IGRlZmF1bHQgaW4gZHJpbGxzIHVubGVzcyBzcGVjaWZpZWQKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAtMTAwLCAwKTsgLy8gTW92ZSBhd2F5CiAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5zdXJlIEhvbWUgdGVhbSBpcyB2aXNpYmxlCiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF9yZXNldEJhbGxUb1BsYXllcigpIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAocCAmJiBiKSB7CiAgICAgICAgICAgICAgICBiLnJlc2V0KCk7CiAgICAgICAgICAgICAgICBiLmdyYWIocCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiUkVTRVQiLCBwLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNuYXAgY2FtZXJhCiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIpIHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlU2NvcmVVSSh2YWwpIHsKICAgICAgICAgICAgY29uc3QgZWwgPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoJyNkcmlsbC1zY29yZScpOwogICAgICAgICAgICBpZiAoZWwpIGVsLmlubmVyVGV4dCA9IGBTQ09SRTogJHt2YWx9YDsKICAgICAgICB9CgogICAgICAgIF9zZXRJbnN0cnVjdGlvbih0ZXh0KSB7CiAgICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI2RyaWxsLWluc3RydWN0aW9uJyk7CiAgICAgICAgICAgICBpZiAoZWwpIGVsLmlubmVyVGV4dCA9IHRleHQ7CiAgICAgICAgfQoKICAgICAgICAvLyAtLS0gRFJJTExTIC0tLQoKICAgICAgICBfc2V0dXBGcmVlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiRnJlZSBwcmFjdGljZS4gSW5maW5pdGUgSFAvRU4uIik7CiAgICAgICAgICAgIC8vIFNob3cgZXZlcnlvbmUKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uY29weShwLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KICAgICAgICBfbG9vcEZyZWUoZHQpIHt9CgogICAgICAgIF9zZXR1cFNob290aW5nKCkgewoKICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlNjb3JlIG9uIHRoZSBHb2FsaWUhIik7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsgLy8gQ2xlYXIgcmVzZXQgZmxhZwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0dXA6IEFjdGl2ZSBQbGF5ZXIgYXQgMThtLCBHb2FsaWUgaW4gbmV0LgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnR0wnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChwICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOyAvLyAxOG0gb3V0IChIb21lIGF0dGFja3MgLVopCiAgICAgICAgICAgICAgICBwLm1lc2gubG9va0F0KDAsIDAsIC0yOCk7CiAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGcgJiYgZy5tZXNoKSB7CiAgICAgICAgICAgICAgICBnLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBnLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC0yNyk7CiAgICAgICAgICAgICAgICBnLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgZy52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBfbG9vcFNob290aW5nKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICAvLyBDaGVjayBpZiBnb2FsIHNjb3JlZCAoR2FtZU1hbmFnZXIgaGFuZGxlcyB0aGUgYWN0dWFsIGdvYWwgZXZlbnQsIGJ1dCB3ZSB0cmFjayByZXNldCkKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zdGF0ZSA9PT0gJ2dvYWwnKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5zY29yZSsrOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXRlID0gJ2FjdGl2ZSc7IC8vIEhpamFjayBzdGF0ZSBiYWNrCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwU2hvb3RpbmcoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElmIGdvYWxpZSBjYXRjaGVzCiAgICAgICAgICAgIGNvbnN0IGcgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICBpZiAoZyAmJiBnLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU0FWRUQiLCBnLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwU2hvb3RpbmcoKSwgMTAwMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zZXR1cFBhc3NpbmcoKSB7CgogICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlBhc3MgdG8gdGhlIG1vdmluZyB0YXJnZXQhIik7CiAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAgLy8gU2V0dXA6IEFjdGl2ZSBQbGF5ZXIgY2VudGVyLiAxIFRlYW1tYXRlIHJ1bm5pbmcgcGF0dGVybnMuCiAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geCAhPT0gcCAmJiB4LnJvbGUgIT09ICdHTCcpOwogICAgICAgICAgICAgCiAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICAgCiAgICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMTApOwogICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICB0YXJnZXQubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTEwKTsKICAgICAgICAgICAgICAgICB0YXJnZXQubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICB0YXJnZXQudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIAogICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgogICAgICAgIF9sb29wUGFzc2luZyhkdCkgewogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5kcmlsbFN0YXRlLnRhcmdldDsKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgdGFyZ2V0IGluIGNpcmNsZQogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUudGltZXIgKz0gZHQ7CiAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnggPSBNYXRoLnNpbih0aGlzLmRyaWxsU3RhdGUudGltZXIpICogMTA7CiAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnogPSAtMTAgKyBNYXRoLmNvcyh0aGlzLmRyaWxsU3RhdGUudGltZXIgKiAwLjUpICogNTsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gubG9va0F0KDAsMCwxMCk7CgogICAgICAgICAgICAvLyBVcGRhdGUgUmluZwogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uY29weSh0YXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHgwMGZmZmYpOyAvLyBDeWFuCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0YXJnZXQuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuc2NvcmUrKzsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkodGhpcy5kcmlsbFN0YXRlLnNjb3JlKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJOSUNFIFBBU1MhIiwgdGFyZ2V0Lm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXQubG9zZUJhbGwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZXR1cFBhc3NpbmcoKTsgLy8gUmUtc2V0dXAgdG8gcmVzZXQgcG9zaXRpb25zCiAgICAgICAgICAgICAgICB9LCA4MDApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9zZXR1cERlZmVuc2UoKSB7CgogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVGFja2xlIHRoZSBhdHRhY2tlciEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYXR0YWNrZXIgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmF0dGFja2VyID0gYXR0YWNrZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAyMCk7IC8vIE5lYXIgb3duIGdvYWwKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXR0YWNrZXIpIHsKICAgICAgICAgICAgICAgIGF0dGFja2VyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBhdHRhY2tlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOwogICAgICAgICAgICAgICAgYXR0YWNrZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEdpdmUgYmFsbCB0byBhdHRhY2tlcgogICAgICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgYi5yZXNldCgpOwogICAgICAgICAgICAgICAgYi5ncmFiKGF0dGFja2VyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBfbG9vcERlZmVuc2UoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGF0dGFja2VyID0gdGhpcy5kcmlsbFN0YXRlLmF0dGFja2VyOwogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFhdHRhY2tlciB8fCAhcCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXR0YWNrZXIgcnVucyB0byBnb2FsICgrWikKICAgICAgICAgICAgY29uc3QgZ29hbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDI4KTsKICAgICAgICAgICAgY29uc3QgZGlyID0gZ29hbFBvcy5jbG9uZSgpLnN1YihhdHRhY2tlci5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBSaW5nIG9uIEF0dGFja2VyCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi5jb3B5KGF0dGFja2VyLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnkgPSAwLjE7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmYwMDAwKTsgLy8gUmVkIGZvciBlbmVteQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYXR0YWNrZXIuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgYXR0YWNrZXIuc2V0SW5wdXQoZGlyLngsIGRpci56KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEJhbGwgbG9zdCAoVGFja2xlZCkKICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgfHwgdGhpcy5nYW1lLmVudGl0aWVzLmJhbGwuc3RhdGUgPT09ICdmcmVlJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5zY29yZSsrOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkodGhpcy5kcmlsbFN0YXRlLnNjb3JlKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU1RPUFBFRCEiLCBwLm1lc2gucG9zaXRpb24sICJibG9jayIpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBEZWZlbnNlKCksIDEwMDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGYWlsIGNvbmRpdGlvbjogQXR0YWNrZXIgc2NvcmVzIChHYW1lTWFuYWdlciBoYW5kbGVzIGdvYWwgY2hlY2spCiAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YXRlID09PSAnZ29hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXRlID0gJ2FjdGl2ZSc7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiRkFJTEVEIiwgcC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwRGVmZW5zZSgpLCAxMDAwKTsKICAgICAgICAgICAgfQp9CgogICAgICAgIF9zZXR1cEN1cnZlKCkgewp0aGlzLl9zZXRJbnN0cnVjdGlvbigiU3dpcGUgYSBDVVJWRSAoICkgKSB0byBieXBhc3MgdGhlIGRlZmVuZGVyISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBTaG93IGdlc3R1cmUgaGludAogICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2xlYXIgYW55IGV4aXN0aW5nIHRpbWVvdXQKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBdXRvIGhpZGUgYWZ0ZXIgNHMKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCA0MDAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgLy8gVXNlIGEgZGVmZW5kZXIgZHVtbXkKICAgICAgICAgICAgY29uc3QgZGVmZW5kZXIgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdMRCcpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuZGVmZW5kZXIgPSBkZWZlbmRlcjsKCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDE1KTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLTI4KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRlZmVuZGVyKSB7CiAgICAgICAgICAgICAgICBkZWZlbmRlci5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgZGVmZW5kZXIubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgNSk7IC8vIDEwbSBpbiBmcm9udCBvZiBwbGF5ZXIKICAgICAgICAgICAgICAgIGRlZmVuZGVyLm1lc2gubG9va0F0KDAsIDAsIDE1KTsgLy8gRmFjZSBwbGF5ZXIKICAgICAgICAgICAgICAgIGRlZmVuZGVyLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAvLyBCb29zdCBCTCB0byBlbnN1cmUgc3RyYWlnaHQgc2hvdHMgYXJlIGJsb2NrZWQKICAgICAgICAgICAgICAgIGRlZmVuZGVyLnN0YXRzLkJMID0gOTk7IAogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHRoZXkgZG9uJ3QgbW92ZQogICAgICAgICAgICAgICAgZGVmZW5kZXIuYWlTdGF0ZSA9ICdJRExFJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVGFyZ2V0IFJpbmcgYmVoaW5kIGRlZmVuZGVyCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi5zZXQoMCwgMC4xLCAtMTApOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweDAwZmZmZik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQoKX2xvb3BDdXJ2ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBjb25zdCBkZWZlbmRlciA9IHRoaXMuZHJpbGxTdGF0ZS5kZWZlbmRlcjsKCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGJhbGwgcGFzc2VkIHRoZSBkZWZlbmRlciBsaW5lICh6IDwgMCkKICAgICAgICAgICAgaWYgKGJhbGwubWVzaC5wb3NpdGlvbi56IDwgMCkgewogICAgICAgICAgICAgICAgLy8gU3VjY2VzcyB6b25lIChXaXRoaW4gNW0gd2lkdGgpCiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoYmFsbC5tZXNoLnBvc2l0aW9uLngpIDwgNSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5zY29yZSsrOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkodGhpcy5kcmlsbFN0YXRlLnNjb3JlKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiQ1VSVkVEISIsIGJhbGwubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwQ3VydmUoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayBpZiBibG9ja2VkIChCYWxsIHN0b3BwZWQgb3IgcG93ZXIgZHJhaW5lZCBzaWduaWZpY2FudGx5IG5lYXIgZGVmZW5kZXIpCiAgICAgICAgICAgIGlmIChkZWZlbmRlciAmJiBiYWxsLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhkZWZlbmRlci5tZXNoLnBvc2l0aW9uKSA8IDMuMCkgewogICAgICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCB8fCBiYWxsLnZlbG9jaXR5Lmxlbmd0aCgpIDwgMS4wKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLRUQiLCBkZWZlbmRlci5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmUtc2hvdyBoaW50IG9uIGZhaWx1cmUgdG8gZ3VpZGUgcGxheWVyCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9LCA0MDAwKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBDdXJ2ZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE1pc3NlZCAvIE91dCBvZiBib3VuZHMKICAgICAgICAgICAgaWYgKGJhbGwubWVzaC5wb3NpdGlvbi56IDwgLTE1KSB7CiAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIk1JU1NFRCIsIGJhbGwubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIC8vIFJlLXNob3cgaGludCBvbiBtaXNzCiAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCA0MDAwKTsKICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBDdXJ2ZSgpLCAxMDAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9zZXR1cFJhcGlkRmlyZSgpIHsKICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlVOTElNSVRFRCBBTU1PISBTcGFtIHRocm93cyEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gRmluZCBUaWR1cyBvciBkZWZhdWx0IHRvIExGCiAgICAgICAgICAgIGxldCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geC5jaGFyYWN0ZXJOYW1lICYmIHguY2hhcmFjdGVyTmFtZS5pbmNsdWRlcygnVGlkdXMnKSk7CiAgICAgICAgICAgIGlmICghcCkgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ0xGJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXQgYWN0aXZlIHBsYXllcgogICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUuc2V0QWN0aXZlUGxheWVyKHApOwogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLTI4KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQm9vc3Qgc3RhdHMgZm9yIGZ1bgogICAgICAgICAgICAgICAgcC5zdGF0cy5TSCA9IDk5OwogICAgICAgICAgICAgICAgcC5zdGF0cy5QQSA9IDk5OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBISURFIEVWRVJZT05FIChBbG9uZSBNb2RlKQogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gobWF0ZSA9PiB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSAhPT0gcCAmJiBtYXRlLm1lc2gpIG1hdGUubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gob3BwID0+IHsKICAgICAgICAgICAgICAgIGlmIChvcHAubWVzaCkgb3BwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQoKX2xvb3BSYXBpZEZpcmUoZHQpIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwoKICAgICAgICAgICAgaWYgKCFwIHx8ICFiKSByZXR1cm47CgogICAgICAgICAgICAvLyBEZXRlY3QgaWYgYmFsbCB3YXMganVzdCB0aHJvd24gKGlzIGZyZWUpCiAgICAgICAgICAgIGlmIChiLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIC8vIDEuIFNwYXduIEdob3N0IEJhbGwgKFZpc3VhbCBDb3B5KQogICAgICAgICAgICAgICAgLy8gQ2xvbmUgdGhlIG1lc2ggaGllcmFyY2h5IHRvIHByZXNlcnZlIERlZm9ybS9TcGluIG5vZGVzCiAgICAgICAgICAgICAgICBjb25zdCBnaG9zdE1lc2ggPSBiLm1lc2guY2xvbmUoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHZpc2liaWxpdHkgYW5kIGFkZCB0byBzY2VuZQogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZChnaG9zdE1lc2gpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSZS1iaW5kIGludGVybmFsIHJlZmVyZW5jZXMgZm9yIHRoZSBwaHlzaWNzIGVuZ2luZQogICAgICAgICAgICAgICAgLy8gSGllcmFyY2h5OiBNZXNoIC0+IERlZm9ybU5vZGUgLT4gU3Bpbk5vZGUKICAgICAgICAgICAgICAgIGNvbnN0IGRlZm9ybU5vZGUgPSBnaG9zdE1lc2guY2hpbGRyZW5bMF07CiAgICAgICAgICAgICAgICBjb25zdCBzcGluTm9kZSA9IGRlZm9ybU5vZGUgPyBkZWZvcm1Ob2RlLmNoaWxkcmVuWzBdIDogbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBEZXRlcm1pbmUgVHJhaWwgQ29sb3IgYmFzZWQgb24gVGVjaAogICAgICAgICAgICAgICAgbGV0IHRyYWlsQ29sb3IgPSAweGZmNDQwMDsgLy8gRGVmYXVsdCBTSCAoT3JhbmdlKQogICAgICAgICAgICAgICAgaWYgKGIudGVjaG5pcXVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICd2ZW5vbScpIHRyYWlsQ29sb3IgPSAweGFhMDBmZjsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnd2l0aGVyJykgdHJhaWxDb2xvciA9IDB4ODg4ODg4OwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICduYXAnKSB0cmFpbENvbG9yID0gMHgwMDAwODg7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ3NwaGVyZScpIHRyYWlsQ29sb3IgPSAweDAwZmZmZjsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnamVjaHQnKSB0cmFpbENvbG9yID0gMHhmZjAwMDA7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIHRyYWlsQ29sb3IgPSAweDQ0NDQ0NDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYi5wb3dlclR5cGUgPT09ICdQQScpIHsKICAgICAgICAgICAgICAgICAgICB0cmFpbENvbG9yID0gMHgwMGFhZmY7IC8vIFBhc3MgKEJsdWUpCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIFRyYWlsCiAgICAgICAgICAgICAgICBjb25zdCB0cmFpbCA9IG5ldyB3aW5kb3cuZmx1eC5UcmFpbFJlbmRlcmVyKHRoaXMuZ2FtZS5zY2VuZSk7CiAgICAgICAgICAgICAgICB0cmFpbC5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgdHJhaWwuc2V0Q29sb3IodHJhaWxDb2xvcik7CiAgICAgICAgICAgICAgICB0cmFpbC5yZXNldChnaG9zdE1lc2gucG9zaXRpb24pOwoKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhICJNb2NrIiBCYWxsIG9iamVjdCB0aGF0IHNhdGlzZmllcyBCYWxsLmpzIHBoeXNpY3MgcmVxdWlyZW1lbnRzCiAgICAgICAgICAgICAgICBjb25zdCBnaG9zdEJhbGwgPSB7CiAgICAgICAgICAgICAgICAgICAgbWVzaDogZ2hvc3RNZXNoLAogICAgICAgICAgICAgICAgICAgIGRlZm9ybU5vZGU6IGRlZm9ybU5vZGUsCiAgICAgICAgICAgICAgICAgICAgc3Bpbk5vZGU6IHNwaW5Ob2RlLAogICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBiLnZlbG9jaXR5LmNsb25lKCksCiAgICAgICAgICAgICAgICAgICAgYW5ndWxhclZlbG9jaXR5OiBiLmFuZ3VsYXJWZWxvY2l0eSA/IGIuYW5ndWxhclZlbG9jaXR5LmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpLAogICAgICAgICAgICAgICAgICAgIGFjY3VtdWxhdGVkUm90YXRpb246IGIuYWNjdW11bGF0ZWRSb3RhdGlvbiA/IGIuYWNjdW11bGF0ZWRSb3RhdGlvbi5jbG9uZSgpIDogbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwKICAgICAgICAgICAgICAgICAgICBzdGF0ZTogJ2ZyZWUnLAogICAgICAgICAgICAgICAgICAgIHBvd2VyOiBiLnBvd2VyLAogICAgICAgICAgICAgICAgICAgIHBvd2VyVHlwZTogYi5wb3dlclR5cGUsCiAgICAgICAgICAgICAgICAgICAgdGVjaG5pcXVlOiBiLnRlY2huaXF1ZSwKICAgICAgICAgICAgICAgICAgICBpc0ludmlzaWJsZTogYi5pc0ludmlzaWJsZSwKICAgICAgICAgICAgICAgICAgICBsaWZlOiA1LjAsIC8vIEVub3VnaCB0aW1lIHRvIHJlYWNoIGdvYWwKICAgICAgICAgICAgICAgICAgICB0cmFpbDogdHJhaWwsCiAgICAgICAgICAgICAgICAgICAgX2J1YmJsZVRpbWVyOiAwLAogICAgICAgICAgICAgICAgICAgIF9naG9zdDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAvLyBNb2NrIG1ldGhvZHMKICAgICAgICAgICAgICAgICAgICByZXNldDogKCkgPT4ge30sIAogICAgICAgICAgICAgICAgICAgIGRyb3A6ICgpID0+IHt9LAogICAgICAgICAgICAgICAgICAgIHJldmVhbDogKCkgPT4ge30KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdmlzaWJpbGl0eQogICAgICAgICAgICAgICAgZ2hvc3RNZXNoLnZpc2libGUgPSAhYi5pc0ludmlzaWJsZTsKCiAgICAgICAgICAgICAgICB0aGlzLmdob3N0QmFsbHMucHVzaChnaG9zdEJhbGwpOwoKLy8gMi4gUmVzZXQgUmVhbCBCYWxsIHRvIFBsYXllciBJTlNUQU5UTFkKICAgICAgICAgICAgICAgIGIudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGSVg6IEZvcmNlIGJhbGwgcG9zaXRpb24gdG8gYmUgZXhwbGljaXRseSBpbiBmcm9udCBvZiB0aGUgcGxheWVyCiAgICAgICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIGFueSBsb2dpYyBmcm9tIHRoaW5raW5nIHRoZSBiYWxsIGlzIGJlaGluZCBhbmQgdHJpZ2dlcmluZyBhIHR1cm4KICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihwLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24uY29weShwLm1lc2gucG9zaXRpb24pLmFkZChmd2QubXVsdGlwbHlTY2FsYXIoMC44KSk7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24ueSArPSAxLjA7CgogICAgICAgICAgICAgICAgLy8gTWFudWFsIEF0dGFjaCAoQnlwYXNzICdjYXRjaCcgYW5pbWF0aW9uKQogICAgICAgICAgICAgICAgYi5ob2xkZXIgPSBwOwogICAgICAgICAgICAgICAgYi5zdGF0ZSA9ICdoZWxkJzsKICAgICAgICAgICAgICAgIHAuaGFzQmFsbCA9IHRydWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IFBsYXllciBUaHJvdyBTdGF0ZSBzbyB0aGV5IGNhbiBmaXJlIGFnYWluIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICBwLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHAuY2F0Y2hDb29sZG93biA9IDA7CgogICAgICAgICAgICAgICAgLy8gU3luYyByb3RhdGlvbiB0byBwcmV2ZW50IHNuYXBwaW5nCiAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBpbmZpbml0ZSBzdGF0cwogICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dQYW5lbCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHRoaXMudWkuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgfQoKICAgICAgICBfaGlkZVBhbmVsKCkgewogICAgICAgICAgICBpZiAodGhpcy51aSkgdGhpcy51aS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICB9CgogICAgICAgIF9zaG93UmVzdG9yZUJ0bigpIHsKICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChidG4pIGJ0bi5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlUmVzdG9yZUJ0bigpIHsKICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChidG4pIGJ0bi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KICAgIH0Kd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyID0gUHJhY3RpY2VNYW5hZ2VyOwp9KSgpOw==","./PracticeManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQcmFjdGljZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREcmlsbCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZSA9IHt9OyAKICAgICAgICAgICAgCnRoaXMuZHJpbGxzID0gewogICAgICAgICAgICAgICAgJ2ZyZWUnOiB7IG5hbWU6ICdGUkVFIFJPQU0nLCBzZXR1cDogdGhpcy5fc2V0dXBGcmVlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BGcmVlLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdiYWxsX2xhYic6IHsgbmFtZTogJ0JBTEwgTEFCJywgc2V0dXA6IHRoaXMuX3NldHVwQmFsbExhYi5iaW5kKHRoaXMpLCBsb29wOiB0aGlzLl9sb29wQmFsbExhYi5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAnc2hvb3RpbmcnOiB7IG5hbWU6ICdTSE9PVElORyBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cFNob290aW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BTaG9vdGluZy5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncGFzc2luZyc6IHsgbmFtZTogJ1BBU1NJTkcgRFJJTEwnLCBzZXR1cDogdGhpcy5fc2V0dXBQYXNzaW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BQYXNzaW5nLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdkZWZlbnNlJzogeyBuYW1lOiAnREVGRU5TRSBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cERlZmVuc2UuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcERlZmVuc2UuYmluZCh0aGlzKSB9LAogICAgICAgICAgICAgICAgJ2N1cnZlJzogeyBuYW1lOiAnQ1VSVkUgU0hPVCcsIHNldHVwOiB0aGlzLl9zZXR1cEN1cnZlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BDdXJ2ZS5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncmFwaWRfZmlyZSc6IHsgbmFtZTogJ1JBUElEIEZJUkUnLCBzZXR1cDogdGhpcy5fc2V0dXBSYXBpZEZpcmUuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcFJhcGlkRmlyZS5iaW5kKHRoaXMpIH0KICAgICAgICAgICAgfTsKCnRoaXMudWkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2Utb3ZlcmxheScpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dlc3R1cmUtaGludCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gewogICAgICAgICAgICAgICAgaW5mU3RhdHM6IHRydWUsCiAgICAgICAgICAgICAgICBhaUR1bW15OiB0cnVlLAogICAgICAgICAgICAgICAgc2hvd0hpdGJveGVzOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy50YXJnZXRSaW5nID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107IC8vIEFycmF5IHRvIHRyYWNrIHZpc3VhbCBjb3BpZXMgb2YgdGhyb3duIGJhbGxzCiAgICAgICAgICAgIHRoaXMuX2luaXRWaXN1YWxzKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwRXZlbnRzKCk7CiAgICAgICAgfQoKICAgICAgICBfaW5pdFZpc3VhbHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBhIGdsb3dpbmcgcmluZyBmb3IgdGFyZ2V0cwogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMS41LCAxLjgsIDMyKTsKICAgICAgICAgICAgZ2VvbWV0cnkucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBmZmZmLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gQWRkIHRvIHNjZW5lIHZpYSBnYW1lIG1hbmFnZXIgcmVmZXJlbmNlCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc2NlbmUpIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy50YXJnZXRSaW5nKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0KCkgewp0aGlzLmlzUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAvLyBJZiBtZW51IHJlcXVlc3RlZCBhIHNwZWNpZmljIGRyaWxsIChlLmcuLCBCYWxsIExhYiksIGhvbm9yIGl0IG9uY2UuCiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGw7CiAgICAgICAgICAgIGlmIChyZXEgJiYgdGhpcy5kcmlsbHNbcmVxXSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChyZXEpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXgucmVxdWVzdGVkUHJhY3RpY2VEcmlsbCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldERyaWxsKCdmcmVlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBIVUQgaXMgdmlzaWJsZQogICAgICAgICAgICBjb25zdCBodWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKTsKICAgICAgICAgICAgaWYoaHVkKSBodWQuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICB9CgogICAgICAgIHN0b3AoKSB7CgogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlUGFuZWwoKTsKICAgICAgICAgICAgdGhpcy5faGlkZVJlc3RvcmVCdG4oKTsKdGhpcy5fY2xlYXJEcmlsbCgpOwogICAgICAgICAgICAKLy8gQ2xlYXIgR2hvc3QgQmFsbHMKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYi5tZXNoKSB0aGlzLmdhbWUuc2NlbmUucmVtb3ZlKGIubWVzaCk7CiAgICAgICAgICAgICAgICBpZiAoYi50cmFpbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50cmFpbC5tZXNoLmdlb21ldHJ5KSBiLnRyYWlsLm1lc2guZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gZmFsc2U7CgogICAgICAgICAgICAvLyBSZXN0b3JlIEF3YXkgVGVhbSBWaXNpYmlsaXR5IGZvciBOb3JtYWwgTWF0Y2gKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSAwOyAvLyBFbnN1cmUgdGhleSBhcmVuJ3Qgc3R1Y2sgdW5kZXIgZmxvb3IKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGlzYWJsZSBkZWJ1ZyB2aXN1YWxzIGlmIHRoZXkgd2VyZSBvbgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXREcmlsbChrZXkpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmRyaWxsc1trZXldKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuX2NsZWFyRHJpbGwoKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RHJpbGwgPSBrZXk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkucXVlcnlTZWxlY3RvckFsbCgnLmRyaWxsLWJ0bicpLmZvckVhY2goYnRuID0+IHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJywgYnRuLmRhdGFzZXQuZHJpbGwgPT09IGtleSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUnVuIFNldHVwCiAgICAgICAgICAgIHRoaXMuZHJpbGxzW2tleV0uc2V0dXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFubm91bmNlbWVudAogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnNob3dBbm5vdW5jZW1lbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zaG93QW5ub3VuY2VtZW50KHRoaXMuZHJpbGxzW2tleV0ubmFtZSwgJ25vcm1hbCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzUnVubmluZykgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ29tbW9uIFByYWN0aWNlIExvZ2ljIChJbmZpbml0ZSBTdGF0cykKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5pbmZTdGF0cykgewogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbmZpbml0ZVN0YXRzKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERyaWxsIExvZ2ljCiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnREcmlsbCAmJiB0aGlzLmRyaWxsc1t0aGlzLmN1cnJlbnREcmlsbF0ubG9vcCkgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbHNbdGhpcy5jdXJyZW50RHJpbGxdLmxvb3AoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXN1YWxzIEFuaW1hdGlvbgovLyBWaXN1YWxzIEFuaW1hdGlvbgogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nICYmIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucm90YXRpb24ueiArPSBkdDsgLy8gU3BpbgogICAgICAgICAgICAgICAgY29uc3QgcyA9IDEuMCArIE1hdGguc2luKERhdGUubm93KCkgKiAwLjAwNSkgKiAwLjE7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcuc2NhbGUuc2V0KHMsIHMsIHMpOwogICAgICAgICAgICB9CgovLyBVcGRhdGUgR2hvc3QgQmFsbHMKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2hvc3RCYWxscy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2hvc3RCYWxsc1tpXTsKICAgICAgICAgICAgICAgIGIubGlmZSAtPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gLS0tIFBIWVNJQ1MgJiBWSVNVQUxTIERFTEVHQVRJT04gLS0tCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguQmFsbCAmJiB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZS51cGRhdGVGcmVlKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlRnJlZS5jYWxsKGIsIGR0KTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZS51cGRhdGVWaXN1YWxzLmNhbGwoYiwgZHQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBUcmFpbAogICAgICAgICAgICAgICAgaWYgKGIudHJhaWwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFpbFBvcyA9IGIubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChiLmRlZm9ybU5vZGUpIHRyYWlsUG9zLnkgKz0gYi5kZWZvcm1Ob2RlLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICAgICAgYi50cmFpbC51cGRhdGUodHJhaWxQb3MpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIC0tLSBHT0FMIERFVEVDVElPTiBGT1IgR0hPU1QgQkFMTFMgLS0tCiAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBiLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICAvLyBDaGVjayBaIGRlcHRoIChHb2FsIGlzIGF0ICsvLSAyOCwgdHJpZ2dlciBhdCAyOSkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueikgPiAyOS4wKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gR29hbCBCb3ggRGltZW5zaW9ucyAoTWF0Y2hlcyBHYW1lTWFuYWdlcikKICAgICAgICAgICAgICAgICAgICBjb25zdCBoYWxmV2lkdGggPSAxMS4wOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhbGZIZWlnaHQgPSA5LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbFlPZmZzZXQgPSAtNC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueCkgPD0gaGFsZldpZHRoICYmIE1hdGguYWJzKHBvcy55IC0gZ29hbFlPZmZzZXQpIDw9IGhhbGZIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR09BTCEKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIEdvYWwgRlgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIHBvcywgeyBzY2FsZTogOC4wLCBsaWZlOiAwLjUgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIHBvcywgeyBzY2FsZTogNS4wIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVicmlzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGs9MDsgazwxMDsgaysrKSB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdkZWJyaXMnLCBwb3MsIHsgc2NhbGU6IDAuNSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiR09BTCIsIHBvcywgImdvYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAvLyBLaWxsIGJhbGwgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgICAgICAgICAgYi5saWZlID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2xlYW51cAogICAgICAgICAgICAgICAgaWYgKGIubGlmZSA8PSAwIHx8IGIubWVzaC5wb3NpdGlvbi55IDwgLTEwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLnJlbW92ZShiLm1lc2gpOwogICAgICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGIudHJhaWwubWVzaC5nZW9tZXRyeSkgYi50cmFpbC5tZXNoLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3NldHVwRXZlbnRzKCkgewoKICAgICAgICAgICAgLy8gTWluaW1pemUgLyBSZXN0b3JlCiAgICAgICAgICAgIGNvbnN0IG1pbkJ0biA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI3AtbWluaW1pemUnKTsKICAgICAgICAgICAgaWYgKG1pbkJ0bikgewogICAgICAgICAgICAgICAgbWluQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVQYW5lbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dSZXN0b3JlQnRuKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgcmVzdG9yZUJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcmFjdGljZS1yZXN0b3JlLWJ0bicpOwogICAgICAgICAgICBpZiAocmVzdG9yZUJ0bikgewogICAgICAgICAgICAgICAgcmVzdG9yZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93UGFuZWwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUmVzdG9yZUJ0bigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERyaWxsIEJ1dHRvbnMKICAgICAgICAgICAgdGhpcy51aS5xdWVyeVNlbGVjdG9yQWxsKCcuZHJpbGwtYnRuJykuZm9yRWFjaChidG4gPT4gewogICAgICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RHJpbGwoYnRuLmRhdGFzZXQuZHJpbGwpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUmVzZXQgQmFsbAogICAgICAgICAgICBjb25zdCByZXNldEJ0biA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI3AtcmVzZXQtYmFsbCcpOwogICAgICAgICAgICBpZiAocmVzZXRCdG4pIHsKICAgICAgICAgICAgICAgIHJlc2V0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRXhpdAogICAgICAgICAgICBjb25zdCBleGl0QnRuID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjcC1leGl0Jyk7CiAgICAgICAgICAgIGlmIChleGl0QnRuKSB7CiAgICAgICAgICAgICAgICBleGl0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlci5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9wdGlvbnMgVG9nZ2xlcwogICAgICAgICAgICB0aGlzLl9iaW5kVG9nZ2xlKCdvcHQtaW5mLXN0YXQnLCAnaW5mU3RhdHMnKTsKICAgICAgICAgICAgdGhpcy5fYmluZFRvZ2dsZSgnb3B0LWFpLWR1bW15JywgJ2FpRHVtbXknLCAodmFsKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgQUkgRHVtbXkgc3RhdGUgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LmFpRW5hYmxlZCA9ICF2YWw7IC8vIElmIGR1bW15IGlzIFRSVUUsIEFJIGlzIEZBTFNFCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9iaW5kVG9nZ2xlKCdvcHQtaGl0Ym94ZXMnLCAnc2hvd0hpdGJveGVzJywgKHZhbCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLmVuYWJsZWQgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5zaG93SGl0Ym94ZXMgPSB2YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gS2V5Ym9hcmQgU2hvcnRjdXQgZm9yIFJlc2V0IChSKQovLyBLZXlib2FyZCBTaG9ydGN1dCBmb3IgUmVzZXQgKFIpCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzUnVubmluZyAmJiBlLmtleS50b0xvd2VyQ2FzZSgpID09PSAncicgJiYgIWUucmVwZWF0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKX2JpbmRUb2dnbGUoaWQsIG9wdGlvbktleSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgY29uc3QgZWwgPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoYCMke2lkfWApOwogICAgICAgICAgICBpZiAoIWVsKSByZXR1cm47CgogICAgICAgICAgICAvLyBIZWxwZXIgdG8gdXBkYXRlIHZpc3VhbHMKICAgICAgICAgICAgY29uc3QgdXBkYXRlVmlzdWFsID0gKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgaXNBY3RpdmUgPSB0aGlzLm9wdGlvbnNbb3B0aW9uS2V5XTsKICAgICAgICAgICAgICAgIGVsLmNsYXNzTGlzdC50b2dnbGUoJ2FjdGl2ZScsIGlzQWN0aXZlKTsKICAgICAgICAgICAgICAgIGNvbnN0IGJveCA9IGVsLnF1ZXJ5U2VsZWN0b3IoJy5jaGVja2JveCcpOwogICAgICAgICAgICAgICAgaWYgKGJveCkgYm94LmlubmVyVGV4dCA9IGlzQWN0aXZlID8gJ+KWoycgOiAn4pahJzsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgdmlzdWFsIHN0YXRlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIHVwZGF0ZVZpc3VhbCgpOwoKICAgICAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9uc1tvcHRpb25LZXldID0gIXRoaXMub3B0aW9uc1tvcHRpb25LZXldOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB1cGRhdGVWaXN1YWwoKTsKCiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKHRoaXMub3B0aW9uc1tvcHRpb25LZXldKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKCiAgICAgICAgX3NldHVwQmFsbExhYigpIHsKICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIkJBTEwgTEFCOiBPcGVuIERldlRvb2xzIOKGkiBCYWxsIExhYi4gVXNlIFNob3QgQ2Fubm9uICsgdHJhamVjdG9yeSBwcmV2aWV3ICsgcmVjb3JkL3JlcGxheS4iKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKCiAgICAgICAgICAgIGNvbnN0IGhvbWUgPSB0aGlzLmdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgY29uc3QgYXdheSA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5OwogICAgICAgICAgICBjb25zdCBwID0gaG9tZSA/IGhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKICAgICAgICAgICAgaWYgKCFwKSByZXR1cm47CgogICAgICAgICAgICAvLyBTb2xvIG1vZGU6IGhpZGUgZXZlcnlvbmUgZXhjZXB0IHRoZSBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmIChob21lICYmIGhvbWUucGxheWVycykgewogICAgICAgICAgICAgICAgaG9tZS5wbGF5ZXJzLmZvckVhY2gobWF0ZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGUubWVzaCkgbWF0ZS5tZXNoLnZpc2libGUgPSAobWF0ZSA9PT0gcCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXdheSAmJiBhd2F5LnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGF3YXkucGxheWVycy5mb3JFYWNoKG9wcCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wcC5tZXNoKSBvcHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUGxhY2UgYWN0aXZlIHBsYXllciBhdCBjZW50ZXIgZmFjaW5nIHRoZSBhd2F5IGdvYWwKICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLTI4KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgaWYgKHAuc3luY1JvdGF0aW9uKSBwLnN5bmNSb3RhdGlvbigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCaWcgc3RhdHMgc28geW91IGNhbiB0ZXN0IGV4dHJlbWVzCiAgICAgICAgICAgIGlmIChwLnN0YXRzKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlBBID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkVOID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLm1heEhQID0gTWF0aC5tYXgocC5zdGF0cy5tYXhIUCB8fCA5OTksIDk5OSk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkhQID0gcC5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQSBjbGVhciB0YXJnZXQgbWFya2VyIChwdXJlbHkgdmlzdWFsKQogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uc2V0KDAsIDAuMSwgLTE4KTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZjAwZmYpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KCiAgICAgICAgX2xvb3BCYWxsTGFiKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgaWYgKCFiIHx8ICFwKSByZXR1cm47CgogICAgICAgICAgICAvLyBBdXRvLXJlc2V0IGJhbGwgYmFjayB0byBwbGF5ZXIgb25jZSBpdCBjb21lcyB0byByZXN0LAogICAgICAgICAgICAvLyBzbyB5b3UgY2FuIHNwYW0gdmFyaWF0aW9ucyB3aXRob3V0IHRvdWNoaW5nIGFueXRoaW5nLgogICAgICAgICAgICBpZiAoYi5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzdG9wcGVkID0gKGIudmVsb2NpdHkubGVuZ3RoU3EoKSA8IDAuMDEpICYmIChiLnBvd2VyIDw9IDAuMDEpOwogICAgICAgICAgICAgICAgaWYgKHN0b3BwZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gKHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgfHwgMCkgKyBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA+IDAuNDUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbGlnaHQgdGFyZ2V0IGJvYiAoaGVscHMgZGVwdGggcGVyY2VwdGlvbikKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZyAmJiB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnkgPSAwLjEgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDMpICogMC4wNTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5SW5maW5pdGVTdGF0cygpIHsKICAgICAgICAgICAgY29uc3QgaG9tZSA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBpZiAoaG9tZSkgewogICAgICAgICAgICAgICAgaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7CiAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSBwLnN0YXRzLkVOOwogICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLnZlbm9tID0gMDsKICAgICAgICAgICAgICAgICAgICBwLnN0YXR1cy5uYXAgPSAwOwogICAgICAgICAgICAgICAgICAgIHAuc3R1blRpbWVyID0gMDsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2xlYXJEcmlsbCgpIHsKCiAgICAgICAgICAgIC8vIFJlc2V0IHBvc2l0aW9ucywgY2xlYXIgZHVtbWllcywgcmVzZXQgc2NvcmUKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCkgY2xlYXJUaW1lb3V0KHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCk7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZSA9IHsgc2NvcmU6IDAsIHRpbWVyOiAwLCBzdGFnZTogMCwgcmVzZXR0aW5nOiBmYWxzZSB9OwogICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKDApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2xlYXIgR2x5cGhzCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZ2x5cGhNYW5hZ2VyKSB0aGlzLmdhbWUuZ2x5cGhNYW5hZ2VyLmNsZWFyKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUmVzZXQgdGVhbXMgdG8gZGVmYXVsdCBwb3NpdGlvbnMKCiAgICAgICAgICAgIC8vIFJlc2V0IHRlYW1zIHRvIGRlZmF1bHQgcG9zaXRpb25zCiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5ob21lLnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBBSSBEdW1teSBzZXR0aW5nCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gIXRoaXMub3B0aW9ucy5haUR1bW15OwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEhpZGUgYXdheSB0ZWFtIGJ5IGRlZmF1bHQgaW4gZHJpbGxzIHVubGVzcyBzcGVjaWZpZWQKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAtMTAwLCAwKTsgLy8gTW92ZSBhd2F5CiAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5zdXJlIEhvbWUgdGVhbSBpcyB2aXNpYmxlCiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF9yZXNldEJhbGxUb1BsYXllcigpIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAocCAmJiBiKSB7CiAgICAgICAgICAgICAgICBiLnJlc2V0KCk7CiAgICAgICAgICAgICAgICBiLmdyYWIocCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiUkVTRVQiLCBwLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNuYXAgY2FtZXJhCiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIpIHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlU2NvcmVVSSh2YWwpIHsKICAgICAgICAgICAgY29uc3QgZWwgPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoJyNkcmlsbC1zY29yZScpOwogICAgICAgICAgICBpZiAoZWwpIGVsLmlubmVyVGV4dCA9IGBTQ09SRTogJHt2YWx9YDsKICAgICAgICB9CgogICAgICAgIF9zZXRJbnN0cnVjdGlvbih0ZXh0KSB7CiAgICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI2RyaWxsLWluc3RydWN0aW9uJyk7CiAgICAgICAgICAgICBpZiAoZWwpIGVsLmlubmVyVGV4dCA9IHRleHQ7CiAgICAgICAgfQoKICAgICAgICAvLyAtLS0gRFJJTExTIC0tLQoKICAgICAgICBfc2V0dXBGcmVlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiRnJlZSBwcmFjdGljZS4gSW5maW5pdGUgSFAvRU4uIik7CiAgICAgICAgICAgIC8vIFNob3cgZXZlcnlvbmUKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uY29weShwLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KICAgICAgICBfbG9vcEZyZWUoZHQpIHt9CgogICAgICAgIF9zZXR1cFNob290aW5nKCkgewoKICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlNjb3JlIG9uIHRoZSBHb2FsaWUhIik7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsgLy8gQ2xlYXIgcmVzZXQgZmxhZwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0dXA6IEFjdGl2ZSBQbGF5ZXIgYXQgMThtLCBHb2FsaWUgaW4gbmV0LgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnR0wnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChwICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOyAvLyAxOG0gb3V0IChIb21lIGF0dGFja3MgLVopCiAgICAgICAgICAgICAgICBwLm1lc2gubG9va0F0KDAsIDAsIC0yOCk7CiAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGcgJiYgZy5tZXNoKSB7CiAgICAgICAgICAgICAgICBnLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBnLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC0yNyk7CiAgICAgICAgICAgICAgICBnLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgZy52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBfbG9vcFNob290aW5nKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICAvLyBDaGVjayBpZiBnb2FsIHNjb3JlZCAoR2FtZU1hbmFnZXIgaGFuZGxlcyB0aGUgYWN0dWFsIGdvYWwgZXZlbnQsIGJ1dCB3ZSB0cmFjayByZXNldCkKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zdGF0ZSA9PT0gJ2dvYWwnKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5zY29yZSsrOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXRlID0gJ2FjdGl2ZSc7IC8vIEhpamFjayBzdGF0ZSBiYWNrCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwU2hvb3RpbmcoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElmIGdvYWxpZSBjYXRjaGVzCiAgICAgICAgICAgIGNvbnN0IGcgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICBpZiAoZyAmJiBnLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU0FWRUQiLCBnLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwU2hvb3RpbmcoKSwgMTAwMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zZXR1cFBhc3NpbmcoKSB7CgogICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlBhc3MgdG8gdGhlIG1vdmluZyB0YXJnZXQhIik7CiAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAgLy8gU2V0dXA6IEFjdGl2ZSBQbGF5ZXIgY2VudGVyLiAxIFRlYW1tYXRlIHJ1bm5pbmcgcGF0dGVybnMuCiAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geCAhPT0gcCAmJiB4LnJvbGUgIT09ICdHTCcpOwogICAgICAgICAgICAgCiAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICAgCiAgICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMTApOwogICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICB0YXJnZXQubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTEwKTsKICAgICAgICAgICAgICAgICB0YXJnZXQubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICB0YXJnZXQudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIAogICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgogICAgICAgIF9sb29wUGFzc2luZyhkdCkgewogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5kcmlsbFN0YXRlLnRhcmdldDsKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgdGFyZ2V0IGluIGNpcmNsZQogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUudGltZXIgKz0gZHQ7CiAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnggPSBNYXRoLnNpbih0aGlzLmRyaWxsU3RhdGUudGltZXIpICogMTA7CiAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnogPSAtMTAgKyBNYXRoLmNvcyh0aGlzLmRyaWxsU3RhdGUudGltZXIgKiAwLjUpICogNTsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gubG9va0F0KDAsMCwxMCk7CgogICAgICAgICAgICAvLyBVcGRhdGUgUmluZwogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uY29weSh0YXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHgwMGZmZmYpOyAvLyBDeWFuCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0YXJnZXQuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuc2NvcmUrKzsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkodGhpcy5kcmlsbFN0YXRlLnNjb3JlKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJOSUNFIFBBU1MhIiwgdGFyZ2V0Lm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXQubG9zZUJhbGwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZXR1cFBhc3NpbmcoKTsgLy8gUmUtc2V0dXAgdG8gcmVzZXQgcG9zaXRpb25zCiAgICAgICAgICAgICAgICB9LCA4MDApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9zZXR1cERlZmVuc2UoKSB7CgogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVGFja2xlIHRoZSBhdHRhY2tlciEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYXR0YWNrZXIgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmF0dGFja2VyID0gYXR0YWNrZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAyMCk7IC8vIE5lYXIgb3duIGdvYWwKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXR0YWNrZXIpIHsKICAgICAgICAgICAgICAgIGF0dGFja2VyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBhdHRhY2tlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOwogICAgICAgICAgICAgICAgYXR0YWNrZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEdpdmUgYmFsbCB0byBhdHRhY2tlcgogICAgICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgYi5yZXNldCgpOwogICAgICAgICAgICAgICAgYi5ncmFiKGF0dGFja2VyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBfbG9vcERlZmVuc2UoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGF0dGFja2VyID0gdGhpcy5kcmlsbFN0YXRlLmF0dGFja2VyOwogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFhdHRhY2tlciB8fCAhcCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXR0YWNrZXIgcnVucyB0byBnb2FsICgrWikKICAgICAgICAgICAgY29uc3QgZ29hbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDI4KTsKICAgICAgICAgICAgY29uc3QgZGlyID0gZ29hbFBvcy5jbG9uZSgpLnN1YihhdHRhY2tlci5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBSaW5nIG9uIEF0dGFja2VyCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi5jb3B5KGF0dGFja2VyLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnkgPSAwLjE7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmYwMDAwKTsgLy8gUmVkIGZvciBlbmVteQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYXR0YWNrZXIuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgYXR0YWNrZXIuc2V0SW5wdXQoZGlyLngsIGRpci56KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEJhbGwgbG9zdCAoVGFja2xlZCkKICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgfHwgdGhpcy5nYW1lLmVudGl0aWVzLmJhbGwuc3RhdGUgPT09ICdmcmVlJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5zY29yZSsrOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkodGhpcy5kcmlsbFN0YXRlLnNjb3JlKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU1RPUFBFRCEiLCBwLm1lc2gucG9zaXRpb24sICJibG9jayIpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBEZWZlbnNlKCksIDEwMDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGYWlsIGNvbmRpdGlvbjogQXR0YWNrZXIgc2NvcmVzIChHYW1lTWFuYWdlciBoYW5kbGVzIGdvYWwgY2hlY2spCiAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YXRlID09PSAnZ29hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXRlID0gJ2FjdGl2ZSc7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiRkFJTEVEIiwgcC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwRGVmZW5zZSgpLCAxMDAwKTsKICAgICAgICAgICAgfQp9CgogICAgICAgIF9zZXR1cEN1cnZlKCkgewp0aGlzLl9zZXRJbnN0cnVjdGlvbigiU3dpcGUgYSBDVVJWRSAoICkgKSB0byBieXBhc3MgdGhlIGRlZmVuZGVyISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBTaG93IGdlc3R1cmUgaGludAogICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2xlYXIgYW55IGV4aXN0aW5nIHRpbWVvdXQKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBdXRvIGhpZGUgYWZ0ZXIgNHMKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCA0MDAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgLy8gVXNlIGEgZGVmZW5kZXIgZHVtbXkKICAgICAgICAgICAgY29uc3QgZGVmZW5kZXIgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdMRCcpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuZGVmZW5kZXIgPSBkZWZlbmRlcjsKCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDE1KTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLTI4KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRlZmVuZGVyKSB7CiAgICAgICAgICAgICAgICBkZWZlbmRlci5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgZGVmZW5kZXIubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgNSk7IC8vIDEwbSBpbiBmcm9udCBvZiBwbGF5ZXIKICAgICAgICAgICAgICAgIGRlZmVuZGVyLm1lc2gubG9va0F0KDAsIDAsIDE1KTsgLy8gRmFjZSBwbGF5ZXIKICAgICAgICAgICAgICAgIGRlZmVuZGVyLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAvLyBCb29zdCBCTCB0byBlbnN1cmUgc3RyYWlnaHQgc2hvdHMgYXJlIGJsb2NrZWQKICAgICAgICAgICAgICAgIGRlZmVuZGVyLnN0YXRzLkJMID0gOTk7IAogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHRoZXkgZG9uJ3QgbW92ZQogICAgICAgICAgICAgICAgZGVmZW5kZXIuYWlTdGF0ZSA9ICdJRExFJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVGFyZ2V0IFJpbmcgYmVoaW5kIGRlZmVuZGVyCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi5zZXQoMCwgMC4xLCAtMTApOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweDAwZmZmZik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQoKX2xvb3BDdXJ2ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBjb25zdCBkZWZlbmRlciA9IHRoaXMuZHJpbGxTdGF0ZS5kZWZlbmRlcjsKCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGJhbGwgcGFzc2VkIHRoZSBkZWZlbmRlciBsaW5lICh6IDwgMCkKICAgICAgICAgICAgaWYgKGJhbGwubWVzaC5wb3NpdGlvbi56IDwgMCkgewogICAgICAgICAgICAgICAgLy8gU3VjY2VzcyB6b25lIChXaXRoaW4gNW0gd2lkdGgpCiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoYmFsbC5tZXNoLnBvc2l0aW9uLngpIDwgNSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5zY29yZSsrOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkodGhpcy5kcmlsbFN0YXRlLnNjb3JlKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiQ1VSVkVEISIsIGJhbGwubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwQ3VydmUoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayBpZiBibG9ja2VkIChCYWxsIHN0b3BwZWQgb3IgcG93ZXIgZHJhaW5lZCBzaWduaWZpY2FudGx5IG5lYXIgZGVmZW5kZXIpCiAgICAgICAgICAgIGlmIChkZWZlbmRlciAmJiBiYWxsLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhkZWZlbmRlci5tZXNoLnBvc2l0aW9uKSA8IDMuMCkgewogICAgICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCB8fCBiYWxsLnZlbG9jaXR5Lmxlbmd0aCgpIDwgMS4wKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLRUQiLCBkZWZlbmRlci5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmUtc2hvdyBoaW50IG9uIGZhaWx1cmUgdG8gZ3VpZGUgcGxheWVyCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9LCA0MDAwKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBDdXJ2ZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE1pc3NlZCAvIE91dCBvZiBib3VuZHMKICAgICAgICAgICAgaWYgKGJhbGwubWVzaC5wb3NpdGlvbi56IDwgLTE1KSB7CiAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIk1JU1NFRCIsIGJhbGwubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIC8vIFJlLXNob3cgaGludCBvbiBtaXNzCiAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCA0MDAwKTsKICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBDdXJ2ZSgpLCAxMDAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9zZXR1cFJhcGlkRmlyZSgpIHsKICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlVOTElNSVRFRCBBTU1PISBTcGFtIHRocm93cyEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gRmluZCBUaWR1cyBvciBkZWZhdWx0IHRvIExGCiAgICAgICAgICAgIGxldCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geC5jaGFyYWN0ZXJOYW1lICYmIHguY2hhcmFjdGVyTmFtZS5pbmNsdWRlcygnVGlkdXMnKSk7CiAgICAgICAgICAgIGlmICghcCkgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ0xGJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXQgYWN0aXZlIHBsYXllcgogICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUuc2V0QWN0aXZlUGxheWVyKHApOwogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLTI4KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQm9vc3Qgc3RhdHMgZm9yIGZ1bgogICAgICAgICAgICAgICAgcC5zdGF0cy5TSCA9IDk5OwogICAgICAgICAgICAgICAgcC5zdGF0cy5QQSA9IDk5OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBISURFIEVWRVJZT05FIChBbG9uZSBNb2RlKQogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gobWF0ZSA9PiB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSAhPT0gcCAmJiBtYXRlLm1lc2gpIG1hdGUubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gob3BwID0+IHsKICAgICAgICAgICAgICAgIGlmIChvcHAubWVzaCkgb3BwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQoKX2xvb3BSYXBpZEZpcmUoZHQpIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwoKICAgICAgICAgICAgaWYgKCFwIHx8ICFiKSByZXR1cm47CgogICAgICAgICAgICAvLyBEZXRlY3QgaWYgYmFsbCB3YXMganVzdCB0aHJvd24gKGlzIGZyZWUpCiAgICAgICAgICAgIGlmIChiLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIC8vIDEuIFNwYXduIEdob3N0IEJhbGwgKFZpc3VhbCBDb3B5KQogICAgICAgICAgICAgICAgLy8gQ2xvbmUgdGhlIG1lc2ggaGllcmFyY2h5IHRvIHByZXNlcnZlIERlZm9ybS9TcGluIG5vZGVzCiAgICAgICAgICAgICAgICBjb25zdCBnaG9zdE1lc2ggPSBiLm1lc2guY2xvbmUoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHZpc2liaWxpdHkgYW5kIGFkZCB0byBzY2VuZQogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZChnaG9zdE1lc2gpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSZS1iaW5kIGludGVybmFsIHJlZmVyZW5jZXMgZm9yIHRoZSBwaHlzaWNzIGVuZ2luZQogICAgICAgICAgICAgICAgLy8gSGllcmFyY2h5OiBNZXNoIC0+IERlZm9ybU5vZGUgLT4gU3Bpbk5vZGUKICAgICAgICAgICAgICAgIGNvbnN0IGRlZm9ybU5vZGUgPSBnaG9zdE1lc2guY2hpbGRyZW5bMF07CiAgICAgICAgICAgICAgICBjb25zdCBzcGluTm9kZSA9IGRlZm9ybU5vZGUgPyBkZWZvcm1Ob2RlLmNoaWxkcmVuWzBdIDogbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBEZXRlcm1pbmUgVHJhaWwgQ29sb3IgYmFzZWQgb24gVGVjaAogICAgICAgICAgICAgICAgbGV0IHRyYWlsQ29sb3IgPSAweGZmNDQwMDsgLy8gRGVmYXVsdCBTSCAoT3JhbmdlKQogICAgICAgICAgICAgICAgaWYgKGIudGVjaG5pcXVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICd2ZW5vbScpIHRyYWlsQ29sb3IgPSAweGFhMDBmZjsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnd2l0aGVyJykgdHJhaWxDb2xvciA9IDB4ODg4ODg4OwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICduYXAnKSB0cmFpbENvbG9yID0gMHgwMDAwODg7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ3NwaGVyZScpIHRyYWlsQ29sb3IgPSAweDAwZmZmZjsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnamVjaHQnKSB0cmFpbENvbG9yID0gMHhmZjAwMDA7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIHRyYWlsQ29sb3IgPSAweDQ0NDQ0NDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYi5wb3dlclR5cGUgPT09ICdQQScpIHsKICAgICAgICAgICAgICAgICAgICB0cmFpbENvbG9yID0gMHgwMGFhZmY7IC8vIFBhc3MgKEJsdWUpCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIFRyYWlsCiAgICAgICAgICAgICAgICBjb25zdCB0cmFpbCA9IG5ldyB3aW5kb3cuZmx1eC5UcmFpbFJlbmRlcmVyKHRoaXMuZ2FtZS5zY2VuZSk7CiAgICAgICAgICAgICAgICB0cmFpbC5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgdHJhaWwuc2V0Q29sb3IodHJhaWxDb2xvcik7CiAgICAgICAgICAgICAgICB0cmFpbC5yZXNldChnaG9zdE1lc2gucG9zaXRpb24pOwoKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhICJNb2NrIiBCYWxsIG9iamVjdCB0aGF0IHNhdGlzZmllcyBCYWxsLmpzIHBoeXNpY3MgcmVxdWlyZW1lbnRzCiAgICAgICAgICAgICAgICBjb25zdCBnaG9zdEJhbGwgPSB7CiAgICAgICAgICAgICAgICAgICAgbWVzaDogZ2hvc3RNZXNoLAogICAgICAgICAgICAgICAgICAgIGRlZm9ybU5vZGU6IGRlZm9ybU5vZGUsCiAgICAgICAgICAgICAgICAgICAgc3Bpbk5vZGU6IHNwaW5Ob2RlLAogICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBiLnZlbG9jaXR5LmNsb25lKCksCiAgICAgICAgICAgICAgICAgICAgYW5ndWxhclZlbG9jaXR5OiBiLmFuZ3VsYXJWZWxvY2l0eSA/IGIuYW5ndWxhclZlbG9jaXR5LmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpLAogICAgICAgICAgICAgICAgICAgIGFjY3VtdWxhdGVkUm90YXRpb246IGIuYWNjdW11bGF0ZWRSb3RhdGlvbiA/IGIuYWNjdW11bGF0ZWRSb3RhdGlvbi5jbG9uZSgpIDogbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwKICAgICAgICAgICAgICAgICAgICBzdGF0ZTogJ2ZyZWUnLAogICAgICAgICAgICAgICAgICAgIHBvd2VyOiBiLnBvd2VyLAogICAgICAgICAgICAgICAgICAgIHBvd2VyVHlwZTogYi5wb3dlclR5cGUsCiAgICAgICAgICAgICAgICAgICAgdGVjaG5pcXVlOiBiLnRlY2huaXF1ZSwKICAgICAgICAgICAgICAgICAgICBpc0ludmlzaWJsZTogYi5pc0ludmlzaWJsZSwKICAgICAgICAgICAgICAgICAgICBsaWZlOiA1LjAsIC8vIEVub3VnaCB0aW1lIHRvIHJlYWNoIGdvYWwKICAgICAgICAgICAgICAgICAgICB0cmFpbDogdHJhaWwsCiAgICAgICAgICAgICAgICAgICAgX2J1YmJsZVRpbWVyOiAwLAogICAgICAgICAgICAgICAgICAgIF9naG9zdDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAvLyBNb2NrIG1ldGhvZHMKICAgICAgICAgICAgICAgICAgICByZXNldDogKCkgPT4ge30sIAogICAgICAgICAgICAgICAgICAgIGRyb3A6ICgpID0+IHt9LAogICAgICAgICAgICAgICAgICAgIHJldmVhbDogKCkgPT4ge30KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdmlzaWJpbGl0eQogICAgICAgICAgICAgICAgZ2hvc3RNZXNoLnZpc2libGUgPSAhYi5pc0ludmlzaWJsZTsKCiAgICAgICAgICAgICAgICB0aGlzLmdob3N0QmFsbHMucHVzaChnaG9zdEJhbGwpOwoKLy8gMi4gUmVzZXQgUmVhbCBCYWxsIHRvIFBsYXllciBJTlNUQU5UTFkKICAgICAgICAgICAgICAgIGIudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGSVg6IEZvcmNlIGJhbGwgcG9zaXRpb24gdG8gYmUgZXhwbGljaXRseSBpbiBmcm9udCBvZiB0aGUgcGxheWVyCiAgICAgICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIGFueSBsb2dpYyBmcm9tIHRoaW5raW5nIHRoZSBiYWxsIGlzIGJlaGluZCBhbmQgdHJpZ2dlcmluZyBhIHR1cm4KICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihwLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24uY29weShwLm1lc2gucG9zaXRpb24pLmFkZChmd2QubXVsdGlwbHlTY2FsYXIoMC44KSk7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24ueSArPSAxLjA7CgogICAgICAgICAgICAgICAgLy8gTWFudWFsIEF0dGFjaCAoQnlwYXNzICdjYXRjaCcgYW5pbWF0aW9uKQogICAgICAgICAgICAgICAgYi5ob2xkZXIgPSBwOwogICAgICAgICAgICAgICAgYi5zdGF0ZSA9ICdoZWxkJzsKICAgICAgICAgICAgICAgIHAuaGFzQmFsbCA9IHRydWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IFBsYXllciBUaHJvdyBTdGF0ZSBzbyB0aGV5IGNhbiBmaXJlIGFnYWluIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICBwLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHAuY2F0Y2hDb29sZG93biA9IDA7CgogICAgICAgICAgICAgICAgLy8gU3luYyByb3RhdGlvbiB0byBwcmV2ZW50IHNuYXBwaW5nCiAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBpbmZpbml0ZSBzdGF0cwogICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dQYW5lbCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHRoaXMudWkuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgfQoKICAgICAgICBfaGlkZVBhbmVsKCkgewogICAgICAgICAgICBpZiAodGhpcy51aSkgdGhpcy51aS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICB9CgogICAgICAgIF9zaG93UmVzdG9yZUJ0bigpIHsKICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChidG4pIGJ0bi5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlUmVzdG9yZUJ0bigpIHsKICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChidG4pIGJ0bi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KICAgIH0Kd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyID0gUHJhY3RpY2VNYW5hZ2VyOwp9KSgpOw==","/PracticeManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQcmFjdGljZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREcmlsbCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZSA9IHt9OyAKICAgICAgICAgICAgCnRoaXMuZHJpbGxzID0gewogICAgICAgICAgICAgICAgJ2ZyZWUnOiB7IG5hbWU6ICdGUkVFIFJPQU0nLCBzZXR1cDogdGhpcy5fc2V0dXBGcmVlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BGcmVlLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdiYWxsX2xhYic6IHsgbmFtZTogJ0JBTEwgTEFCJywgc2V0dXA6IHRoaXMuX3NldHVwQmFsbExhYi5iaW5kKHRoaXMpLCBsb29wOiB0aGlzLl9sb29wQmFsbExhYi5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAnc2hvb3RpbmcnOiB7IG5hbWU6ICdTSE9PVElORyBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cFNob290aW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BTaG9vdGluZy5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncGFzc2luZyc6IHsgbmFtZTogJ1BBU1NJTkcgRFJJTEwnLCBzZXR1cDogdGhpcy5fc2V0dXBQYXNzaW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BQYXNzaW5nLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdkZWZlbnNlJzogeyBuYW1lOiAnREVGRU5TRSBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cERlZmVuc2UuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcERlZmVuc2UuYmluZCh0aGlzKSB9LAogICAgICAgICAgICAgICAgJ2N1cnZlJzogeyBuYW1lOiAnQ1VSVkUgU0hPVCcsIHNldHVwOiB0aGlzLl9zZXR1cEN1cnZlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BDdXJ2ZS5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncmFwaWRfZmlyZSc6IHsgbmFtZTogJ1JBUElEIEZJUkUnLCBzZXR1cDogdGhpcy5fc2V0dXBSYXBpZEZpcmUuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcFJhcGlkRmlyZS5iaW5kKHRoaXMpIH0KICAgICAgICAgICAgfTsKCnRoaXMudWkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2Utb3ZlcmxheScpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dlc3R1cmUtaGludCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gewogICAgICAgICAgICAgICAgaW5mU3RhdHM6IHRydWUsCiAgICAgICAgICAgICAgICBhaUR1bW15OiB0cnVlLAogICAgICAgICAgICAgICAgc2hvd0hpdGJveGVzOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy50YXJnZXRSaW5nID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107IC8vIEFycmF5IHRvIHRyYWNrIHZpc3VhbCBjb3BpZXMgb2YgdGhyb3duIGJhbGxzCiAgICAgICAgICAgIHRoaXMuX2luaXRWaXN1YWxzKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwRXZlbnRzKCk7CiAgICAgICAgfQoKICAgICAgICBfaW5pdFZpc3VhbHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBhIGdsb3dpbmcgcmluZyBmb3IgdGFyZ2V0cwogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMS41LCAxLjgsIDMyKTsKICAgICAgICAgICAgZ2VvbWV0cnkucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBmZmZmLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gQWRkIHRvIHNjZW5lIHZpYSBnYW1lIG1hbmFnZXIgcmVmZXJlbmNlCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc2NlbmUpIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy50YXJnZXRSaW5nKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0KCkgewp0aGlzLmlzUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAvLyBJZiBtZW51IHJlcXVlc3RlZCBhIHNwZWNpZmljIGRyaWxsIChlLmcuLCBCYWxsIExhYiksIGhvbm9yIGl0IG9uY2UuCiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGw7CiAgICAgICAgICAgIGlmIChyZXEgJiYgdGhpcy5kcmlsbHNbcmVxXSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChyZXEpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXgucmVxdWVzdGVkUHJhY3RpY2VEcmlsbCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldERyaWxsKCdmcmVlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBIVUQgaXMgdmlzaWJsZQogICAgICAgICAgICBjb25zdCBodWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKTsKICAgICAgICAgICAgaWYoaHVkKSBodWQuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICB9CgogICAgICAgIHN0b3AoKSB7CgogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlUGFuZWwoKTsKICAgICAgICAgICAgdGhpcy5faGlkZVJlc3RvcmVCdG4oKTsKdGhpcy5fY2xlYXJEcmlsbCgpOwogICAgICAgICAgICAKLy8gQ2xlYXIgR2hvc3QgQmFsbHMKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYi5tZXNoKSB0aGlzLmdhbWUuc2NlbmUucmVtb3ZlKGIubWVzaCk7CiAgICAgICAgICAgICAgICBpZiAoYi50cmFpbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50cmFpbC5tZXNoLmdlb21ldHJ5KSBiLnRyYWlsLm1lc2guZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gZmFsc2U7CgogICAgICAgICAgICAvLyBSZXN0b3JlIEF3YXkgVGVhbSBWaXNpYmlsaXR5IGZvciBOb3JtYWwgTWF0Y2gKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50ZWFtcy5hd2F5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSAwOyAvLyBFbnN1cmUgdGhleSBhcmVuJ3Qgc3R1Y2sgdW5kZXIgZmxvb3IKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGlzYWJsZSBkZWJ1ZyB2aXN1YWxzIGlmIHRoZXkgd2VyZSBvbgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcikgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXREcmlsbChrZXkpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmRyaWxsc1trZXldKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuX2NsZWFyRHJpbGwoKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RHJpbGwgPSBrZXk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHsKICAgICAgICAgICAgICAgIHRoaXMudWkucXVlcnlTZWxlY3RvckFsbCgnLmRyaWxsLWJ0bicpLmZvckVhY2goYnRuID0+IHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJywgYnRuLmRhdGFzZXQuZHJpbGwgPT09IGtleSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUnVuIFNldHVwCiAgICAgICAgICAgIHRoaXMuZHJpbGxzW2tleV0uc2V0dXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFubm91bmNlbWVudAogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnNob3dBbm5vdW5jZW1lbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zaG93QW5ub3VuY2VtZW50KHRoaXMuZHJpbGxzW2tleV0ubmFtZSwgJ25vcm1hbCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzUnVubmluZykgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQ29tbW9uIFByYWN0aWNlIExvZ2ljIChJbmZpbml0ZSBTdGF0cykKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5pbmZTdGF0cykgewogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbmZpbml0ZVN0YXRzKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERyaWxsIExvZ2ljCiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnREcmlsbCAmJiB0aGlzLmRyaWxsc1t0aGlzLmN1cnJlbnREcmlsbF0ubG9vcCkgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbHNbdGhpcy5jdXJyZW50RHJpbGxdLmxvb3AoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWaXN1YWxzIEFuaW1hdGlvbgovLyBWaXN1YWxzIEFuaW1hdGlvbgogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nICYmIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucm90YXRpb24ueiArPSBkdDsgLy8gU3BpbgogICAgICAgICAgICAgICAgY29uc3QgcyA9IDEuMCArIE1hdGguc2luKERhdGUubm93KCkgKiAwLjAwNSkgKiAwLjE7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcuc2NhbGUuc2V0KHMsIHMsIHMpOwogICAgICAgICAgICB9CgovLyBVcGRhdGUgR2hvc3QgQmFsbHMKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2hvc3RCYWxscy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2hvc3RCYWxsc1tpXTsKICAgICAgICAgICAgICAgIGIubGlmZSAtPSBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gLS0tIFBIWVNJQ1MgJiBWSVNVQUxTIERFTEVHQVRJT04gLS0tCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguQmFsbCAmJiB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZS51cGRhdGVGcmVlKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlRnJlZS5jYWxsKGIsIGR0KTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZS51cGRhdGVWaXN1YWxzLmNhbGwoYiwgZHQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBUcmFpbAogICAgICAgICAgICAgICAgaWYgKGIudHJhaWwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFpbFBvcyA9IGIubWVzaC5wb3NpdGlvbi5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChiLmRlZm9ybU5vZGUpIHRyYWlsUG9zLnkgKz0gYi5kZWZvcm1Ob2RlLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICAgICAgYi50cmFpbC51cGRhdGUodHJhaWxQb3MpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIC0tLSBHT0FMIERFVEVDVElPTiBGT1IgR0hPU1QgQkFMTFMgLS0tCiAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBiLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICAvLyBDaGVjayBaIGRlcHRoIChHb2FsIGlzIGF0ICsvLSAyOCwgdHJpZ2dlciBhdCAyOSkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueikgPiAyOS4wKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gR29hbCBCb3ggRGltZW5zaW9ucyAoTWF0Y2hlcyBHYW1lTWFuYWdlcikKICAgICAgICAgICAgICAgICAgICBjb25zdCBoYWxmV2lkdGggPSAxMS4wOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhbGZIZWlnaHQgPSA5LjA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbFlPZmZzZXQgPSAtNC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueCkgPD0gaGFsZldpZHRoICYmIE1hdGguYWJzKHBvcy55IC0gZ29hbFlPZmZzZXQpIDw9IGhhbGZIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR09BTCEKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwYXduIEdvYWwgRlgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3Nob2Nrd2F2ZScsIHBvcywgeyBzY2FsZTogOC4wLCBsaWZlOiAwLjUgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdmbGFzaCcsIHBvcywgeyBzY2FsZTogNS4wIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVicmlzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGs9MDsgazwxMDsgaysrKSB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdkZWJyaXMnLCBwb3MsIHsgc2NhbGU6IDAuNSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiR09BTCIsIHBvcywgImdvYWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAvLyBLaWxsIGJhbGwgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgICAgICAgICAgYi5saWZlID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2xlYW51cAogICAgICAgICAgICAgICAgaWYgKGIubGlmZSA8PSAwIHx8IGIubWVzaC5wb3NpdGlvbi55IDwgLTEwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLnJlbW92ZShiLm1lc2gpOwogICAgICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGIudHJhaWwubWVzaC5nZW9tZXRyeSkgYi50cmFpbC5tZXNoLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3NldHVwRXZlbnRzKCkgewoKICAgICAgICAgICAgLy8gTWluaW1pemUgLyBSZXN0b3JlCiAgICAgICAgICAgIGNvbnN0IG1pbkJ0biA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI3AtbWluaW1pemUnKTsKICAgICAgICAgICAgaWYgKG1pbkJ0bikgewogICAgICAgICAgICAgICAgbWluQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVQYW5lbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Nob3dSZXN0b3JlQnRuKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgcmVzdG9yZUJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcmFjdGljZS1yZXN0b3JlLWJ0bicpOwogICAgICAgICAgICBpZiAocmVzdG9yZUJ0bikgewogICAgICAgICAgICAgICAgcmVzdG9yZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93UGFuZWwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUmVzdG9yZUJ0bigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERyaWxsIEJ1dHRvbnMKICAgICAgICAgICAgdGhpcy51aS5xdWVyeVNlbGVjdG9yQWxsKCcuZHJpbGwtYnRuJykuZm9yRWFjaChidG4gPT4gewogICAgICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RHJpbGwoYnRuLmRhdGFzZXQuZHJpbGwpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUmVzZXQgQmFsbAogICAgICAgICAgICBjb25zdCByZXNldEJ0biA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI3AtcmVzZXQtYmFsbCcpOwogICAgICAgICAgICBpZiAocmVzZXRCdG4pIHsKICAgICAgICAgICAgICAgIHJlc2V0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRXhpdAogICAgICAgICAgICBjb25zdCBleGl0QnRuID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjcC1leGl0Jyk7CiAgICAgICAgICAgIGlmIChleGl0QnRuKSB7CiAgICAgICAgICAgICAgICBleGl0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlci5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9wdGlvbnMgVG9nZ2xlcwogICAgICAgICAgICB0aGlzLl9iaW5kVG9nZ2xlKCdvcHQtaW5mLXN0YXQnLCAnaW5mU3RhdHMnKTsKICAgICAgICAgICAgdGhpcy5fYmluZFRvZ2dsZSgnb3B0LWFpLWR1bW15JywgJ2FpRHVtbXknLCAodmFsKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgQUkgRHVtbXkgc3RhdGUgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LmFpRW5hYmxlZCA9ICF2YWw7IC8vIElmIGR1bW15IGlzIFRSVUUsIEFJIGlzIEZBTFNFCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9iaW5kVG9nZ2xlKCdvcHQtaGl0Ym94ZXMnLCAnc2hvd0hpdGJveGVzJywgKHZhbCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyLmVuYWJsZWQgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5zaG93SGl0Ym94ZXMgPSB2YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gS2V5Ym9hcmQgU2hvcnRjdXQgZm9yIFJlc2V0IChSKQovLyBLZXlib2FyZCBTaG9ydGN1dCBmb3IgUmVzZXQgKFIpCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzUnVubmluZyAmJiBlLmtleS50b0xvd2VyQ2FzZSgpID09PSAncicgJiYgIWUucmVwZWF0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKX2JpbmRUb2dnbGUoaWQsIG9wdGlvbktleSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgY29uc3QgZWwgPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoYCMke2lkfWApOwogICAgICAgICAgICBpZiAoIWVsKSByZXR1cm47CgogICAgICAgICAgICAvLyBIZWxwZXIgdG8gdXBkYXRlIHZpc3VhbHMKICAgICAgICAgICAgY29uc3QgdXBkYXRlVmlzdWFsID0gKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgaXNBY3RpdmUgPSB0aGlzLm9wdGlvbnNbb3B0aW9uS2V5XTsKICAgICAgICAgICAgICAgIGVsLmNsYXNzTGlzdC50b2dnbGUoJ2FjdGl2ZScsIGlzQWN0aXZlKTsKICAgICAgICAgICAgICAgIGNvbnN0IGJveCA9IGVsLnF1ZXJ5U2VsZWN0b3IoJy5jaGVja2JveCcpOwogICAgICAgICAgICAgICAgaWYgKGJveCkgYm94LmlubmVyVGV4dCA9IGlzQWN0aXZlID8gJ+KWoycgOiAn4pahJzsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgdmlzdWFsIHN0YXRlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIHVwZGF0ZVZpc3VhbCgpOwoKICAgICAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9uc1tvcHRpb25LZXldID0gIXRoaXMub3B0aW9uc1tvcHRpb25LZXldOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB1cGRhdGVWaXN1YWwoKTsKCiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKHRoaXMub3B0aW9uc1tvcHRpb25LZXldKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKCiAgICAgICAgX3NldHVwQmFsbExhYigpIHsKICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIkJBTEwgTEFCOiBPcGVuIERldlRvb2xzIOKGkiBCYWxsIExhYi4gVXNlIFNob3QgQ2Fubm9uICsgdHJhamVjdG9yeSBwcmV2aWV3ICsgcmVjb3JkL3JlcGxheS4iKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKCiAgICAgICAgICAgIGNvbnN0IGhvbWUgPSB0aGlzLmdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgY29uc3QgYXdheSA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5OwogICAgICAgICAgICBjb25zdCBwID0gaG9tZSA/IGhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKICAgICAgICAgICAgaWYgKCFwKSByZXR1cm47CgogICAgICAgICAgICAvLyBTb2xvIG1vZGU6IGhpZGUgZXZlcnlvbmUgZXhjZXB0IHRoZSBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmIChob21lICYmIGhvbWUucGxheWVycykgewogICAgICAgICAgICAgICAgaG9tZS5wbGF5ZXJzLmZvckVhY2gobWF0ZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGUubWVzaCkgbWF0ZS5tZXNoLnZpc2libGUgPSAobWF0ZSA9PT0gcCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXdheSAmJiBhd2F5LnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGF3YXkucGxheWVycy5mb3JFYWNoKG9wcCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wcC5tZXNoKSBvcHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUGxhY2UgYWN0aXZlIHBsYXllciBhdCBjZW50ZXIgZmFjaW5nIHRoZSBhd2F5IGdvYWwKICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLTI4KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgaWYgKHAuc3luY1JvdGF0aW9uKSBwLnN5bmNSb3RhdGlvbigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCaWcgc3RhdHMgc28geW91IGNhbiB0ZXN0IGV4dHJlbWVzCiAgICAgICAgICAgIGlmIChwLnN0YXRzKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlBBID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkVOID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLm1heEhQID0gTWF0aC5tYXgocC5zdGF0cy5tYXhIUCB8fCA5OTksIDk5OSk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkhQID0gcC5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQSBjbGVhciB0YXJnZXQgbWFya2VyIChwdXJlbHkgdmlzdWFsKQogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uc2V0KDAsIDAuMSwgLTE4KTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZjAwZmYpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KCiAgICAgICAgX2xvb3BCYWxsTGFiKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgaWYgKCFiIHx8ICFwKSByZXR1cm47CgogICAgICAgICAgICAvLyBBdXRvLXJlc2V0IGJhbGwgYmFjayB0byBwbGF5ZXIgb25jZSBpdCBjb21lcyB0byByZXN0LAogICAgICAgICAgICAvLyBzbyB5b3UgY2FuIHNwYW0gdmFyaWF0aW9ucyB3aXRob3V0IHRvdWNoaW5nIGFueXRoaW5nLgogICAgICAgICAgICBpZiAoYi5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzdG9wcGVkID0gKGIudmVsb2NpdHkubGVuZ3RoU3EoKSA8IDAuMDEpICYmIChiLnBvd2VyIDw9IDAuMDEpOwogICAgICAgICAgICAgICAgaWYgKHN0b3BwZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gKHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgfHwgMCkgKyBkdDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA+IDAuNDUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbGlnaHQgdGFyZ2V0IGJvYiAoaGVscHMgZGVwdGggcGVyY2VwdGlvbikKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZyAmJiB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnkgPSAwLjEgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDMpICogMC4wNTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5SW5maW5pdGVTdGF0cygpIHsKICAgICAgICAgICAgY29uc3QgaG9tZSA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBpZiAoaG9tZSkgewogICAgICAgICAgICAgICAgaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7CiAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSBwLnN0YXRzLkVOOwogICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLnZlbm9tID0gMDsKICAgICAgICAgICAgICAgICAgICBwLnN0YXR1cy5uYXAgPSAwOwogICAgICAgICAgICAgICAgICAgIHAuc3R1blRpbWVyID0gMDsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2xlYXJEcmlsbCgpIHsKCiAgICAgICAgICAgIC8vIFJlc2V0IHBvc2l0aW9ucywgY2xlYXIgZHVtbWllcywgcmVzZXQgc2NvcmUKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCkgY2xlYXJUaW1lb3V0KHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCk7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZSA9IHsgc2NvcmU6IDAsIHRpbWVyOiAwLCBzdGFnZTogMCwgcmVzZXR0aW5nOiBmYWxzZSB9OwogICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKDApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2xlYXIgR2x5cGhzCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZ2x5cGhNYW5hZ2VyKSB0aGlzLmdhbWUuZ2x5cGhNYW5hZ2VyLmNsZWFyKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUmVzZXQgdGVhbXMgdG8gZGVmYXVsdCBwb3NpdGlvbnMKCiAgICAgICAgICAgIC8vIFJlc2V0IHRlYW1zIHRvIGRlZmF1bHQgcG9zaXRpb25zCiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5ob21lLnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBBSSBEdW1teSBzZXR0aW5nCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gIXRoaXMub3B0aW9ucy5haUR1bW15OwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEhpZGUgYXdheSB0ZWFtIGJ5IGRlZmF1bHQgaW4gZHJpbGxzIHVubGVzcyBzcGVjaWZpZWQKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAtMTAwLCAwKTsgLy8gTW92ZSBhd2F5CiAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5zdXJlIEhvbWUgdGVhbSBpcyB2aXNpYmxlCiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF9yZXNldEJhbGxUb1BsYXllcigpIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAocCAmJiBiKSB7CiAgICAgICAgICAgICAgICBiLnJlc2V0KCk7CiAgICAgICAgICAgICAgICBiLmdyYWIocCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiUkVTRVQiLCBwLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNuYXAgY2FtZXJhCiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIpIHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlU2NvcmVVSSh2YWwpIHsKICAgICAgICAgICAgY29uc3QgZWwgPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoJyNkcmlsbC1zY29yZScpOwogICAgICAgICAgICBpZiAoZWwpIGVsLmlubmVyVGV4dCA9IGBTQ09SRTogJHt2YWx9YDsKICAgICAgICB9CgogICAgICAgIF9zZXRJbnN0cnVjdGlvbih0ZXh0KSB7CiAgICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI2RyaWxsLWluc3RydWN0aW9uJyk7CiAgICAgICAgICAgICBpZiAoZWwpIGVsLmlubmVyVGV4dCA9IHRleHQ7CiAgICAgICAgfQoKICAgICAgICAvLyAtLS0gRFJJTExTIC0tLQoKICAgICAgICBfc2V0dXBGcmVlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiRnJlZSBwcmFjdGljZS4gSW5maW5pdGUgSFAvRU4uIik7CiAgICAgICAgICAgIC8vIFNob3cgZXZlcnlvbmUKICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uY29weShwLmhvbWVQb3NpdGlvbik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KICAgICAgICBfbG9vcEZyZWUoZHQpIHt9CgogICAgICAgIF9zZXR1cFNob290aW5nKCkgewoKICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlNjb3JlIG9uIHRoZSBHb2FsaWUhIik7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsgLy8gQ2xlYXIgcmVzZXQgZmxhZwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0dXA6IEFjdGl2ZSBQbGF5ZXIgYXQgMThtLCBHb2FsaWUgaW4gbmV0LgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnR0wnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChwICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOyAvLyAxOG0gb3V0IChIb21lIGF0dGFja3MgLVopCiAgICAgICAgICAgICAgICBwLm1lc2gubG9va0F0KDAsIDAsIC0yOCk7CiAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGcgJiYgZy5tZXNoKSB7CiAgICAgICAgICAgICAgICBnLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBnLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC0yNyk7CiAgICAgICAgICAgICAgICBnLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgZy52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBfbG9vcFNob290aW5nKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICAvLyBDaGVjayBpZiBnb2FsIHNjb3JlZCAoR2FtZU1hbmFnZXIgaGFuZGxlcyB0aGUgYWN0dWFsIGdvYWwgZXZlbnQsIGJ1dCB3ZSB0cmFjayByZXNldCkKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zdGF0ZSA9PT0gJ2dvYWwnKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5zY29yZSsrOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXRlID0gJ2FjdGl2ZSc7IC8vIEhpamFjayBzdGF0ZSBiYWNrCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwU2hvb3RpbmcoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElmIGdvYWxpZSBjYXRjaGVzCiAgICAgICAgICAgIGNvbnN0IGcgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICBpZiAoZyAmJiBnLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU0FWRUQiLCBnLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwU2hvb3RpbmcoKSwgMTAwMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zZXR1cFBhc3NpbmcoKSB7CgogICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlBhc3MgdG8gdGhlIG1vdmluZyB0YXJnZXQhIik7CiAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAgLy8gU2V0dXA6IEFjdGl2ZSBQbGF5ZXIgY2VudGVyLiAxIFRlYW1tYXRlIHJ1bm5pbmcgcGF0dGVybnMuCiAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geCAhPT0gcCAmJiB4LnJvbGUgIT09ICdHTCcpOwogICAgICAgICAgICAgCiAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICAgCiAgICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMTApOwogICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICB0YXJnZXQubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTEwKTsKICAgICAgICAgICAgICAgICB0YXJnZXQubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICB0YXJnZXQudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIAogICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgogICAgICAgIF9sb29wUGFzc2luZyhkdCkgewogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5kcmlsbFN0YXRlLnRhcmdldDsKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgdGFyZ2V0IGluIGNpcmNsZQogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUudGltZXIgKz0gZHQ7CiAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnggPSBNYXRoLnNpbih0aGlzLmRyaWxsU3RhdGUudGltZXIpICogMTA7CiAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnogPSAtMTAgKyBNYXRoLmNvcyh0aGlzLmRyaWxsU3RhdGUudGltZXIgKiAwLjUpICogNTsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gubG9va0F0KDAsMCwxMCk7CgogICAgICAgICAgICAvLyBVcGRhdGUgUmluZwogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRSaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24uY29weSh0YXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHgwMGZmZmYpOyAvLyBDeWFuCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0YXJnZXQuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuc2NvcmUrKzsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkodGhpcy5kcmlsbFN0YXRlLnNjb3JlKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJOSUNFIFBBU1MhIiwgdGFyZ2V0Lm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXQubG9zZUJhbGwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZXR1cFBhc3NpbmcoKTsgLy8gUmUtc2V0dXAgdG8gcmVzZXQgcG9zaXRpb25zCiAgICAgICAgICAgICAgICB9LCA4MDApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9zZXR1cERlZmVuc2UoKSB7CgogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVGFja2xlIHRoZSBhdHRhY2tlciEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYXR0YWNrZXIgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmF0dGFja2VyID0gYXR0YWNrZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAyMCk7IC8vIE5lYXIgb3duIGdvYWwKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXR0YWNrZXIpIHsKICAgICAgICAgICAgICAgIGF0dGFja2VyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBhdHRhY2tlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOwogICAgICAgICAgICAgICAgYXR0YWNrZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEdpdmUgYmFsbCB0byBhdHRhY2tlcgogICAgICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgYi5yZXNldCgpOwogICAgICAgICAgICAgICAgYi5ncmFiKGF0dGFja2VyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBfbG9vcERlZmVuc2UoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGF0dGFja2VyID0gdGhpcy5kcmlsbFN0YXRlLmF0dGFja2VyOwogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFhdHRhY2tlciB8fCAhcCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXR0YWNrZXIgcnVucyB0byBnb2FsICgrWikKICAgICAgICAgICAgY29uc3QgZ29hbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDI4KTsKICAgICAgICAgICAgY29uc3QgZGlyID0gZ29hbFBvcy5jbG9uZSgpLnN1YihhdHRhY2tlci5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBSaW5nIG9uIEF0dGFja2VyCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi5jb3B5KGF0dGFja2VyLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnkgPSAwLjE7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmYwMDAwKTsgLy8gUmVkIGZvciBlbmVteQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYXR0YWNrZXIuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgYXR0YWNrZXIuc2V0SW5wdXQoZGlyLngsIGRpci56KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEJhbGwgbG9zdCAoVGFja2xlZCkKICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgfHwgdGhpcy5nYW1lLmVudGl0aWVzLmJhbGwuc3RhdGUgPT09ICdmcmVlJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5zY29yZSsrOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkodGhpcy5kcmlsbFN0YXRlLnNjb3JlKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU1RPUFBFRCEiLCBwLm1lc2gucG9zaXRpb24sICJibG9jayIpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBEZWZlbnNlKCksIDEwMDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGYWlsIGNvbmRpdGlvbjogQXR0YWNrZXIgc2NvcmVzIChHYW1lTWFuYWdlciBoYW5kbGVzIGdvYWwgY2hlY2spCiAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YXRlID09PSAnZ29hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXRlID0gJ2FjdGl2ZSc7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiRkFJTEVEIiwgcC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwRGVmZW5zZSgpLCAxMDAwKTsKICAgICAgICAgICAgfQp9CgogICAgICAgIF9zZXR1cEN1cnZlKCkgewp0aGlzLl9zZXRJbnN0cnVjdGlvbigiU3dpcGUgYSBDVVJWRSAoICkgKSB0byBieXBhc3MgdGhlIGRlZmVuZGVyISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBTaG93IGdlc3R1cmUgaGludAogICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2xlYXIgYW55IGV4aXN0aW5nIHRpbWVvdXQKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBdXRvIGhpZGUgYWZ0ZXIgNHMKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCA0MDAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgLy8gVXNlIGEgZGVmZW5kZXIgZHVtbXkKICAgICAgICAgICAgY29uc3QgZGVmZW5kZXIgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdMRCcpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuZGVmZW5kZXIgPSBkZWZlbmRlcjsKCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDE1KTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLTI4KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRlZmVuZGVyKSB7CiAgICAgICAgICAgICAgICBkZWZlbmRlci5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgZGVmZW5kZXIubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgNSk7IC8vIDEwbSBpbiBmcm9udCBvZiBwbGF5ZXIKICAgICAgICAgICAgICAgIGRlZmVuZGVyLm1lc2gubG9va0F0KDAsIDAsIDE1KTsgLy8gRmFjZSBwbGF5ZXIKICAgICAgICAgICAgICAgIGRlZmVuZGVyLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAvLyBCb29zdCBCTCB0byBlbnN1cmUgc3RyYWlnaHQgc2hvdHMgYXJlIGJsb2NrZWQKICAgICAgICAgICAgICAgIGRlZmVuZGVyLnN0YXRzLkJMID0gOTk7IAogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHRoZXkgZG9uJ3QgbW92ZQogICAgICAgICAgICAgICAgZGVmZW5kZXIuYWlTdGF0ZSA9ICdJRExFJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVGFyZ2V0IFJpbmcgYmVoaW5kIGRlZmVuZGVyCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi5zZXQoMCwgMC4xLCAtMTApOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweDAwZmZmZik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQoKX2xvb3BDdXJ2ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBjb25zdCBkZWZlbmRlciA9IHRoaXMuZHJpbGxTdGF0ZS5kZWZlbmRlcjsKCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGJhbGwgcGFzc2VkIHRoZSBkZWZlbmRlciBsaW5lICh6IDwgMCkKICAgICAgICAgICAgaWYgKGJhbGwubWVzaC5wb3NpdGlvbi56IDwgMCkgewogICAgICAgICAgICAgICAgLy8gU3VjY2VzcyB6b25lIChXaXRoaW4gNW0gd2lkdGgpCiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoYmFsbC5tZXNoLnBvc2l0aW9uLngpIDwgNSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5zY29yZSsrOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkodGhpcy5kcmlsbFN0YXRlLnNjb3JlKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiQ1VSVkVEISIsIGJhbGwubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3NldHVwQ3VydmUoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayBpZiBibG9ja2VkIChCYWxsIHN0b3BwZWQgb3IgcG93ZXIgZHJhaW5lZCBzaWduaWZpY2FudGx5IG5lYXIgZGVmZW5kZXIpCiAgICAgICAgICAgIGlmIChkZWZlbmRlciAmJiBiYWxsLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhkZWZlbmRlci5tZXNoLnBvc2l0aW9uKSA8IDMuMCkgewogICAgICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCB8fCBiYWxsLnZlbG9jaXR5Lmxlbmd0aCgpIDwgMS4wKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLRUQiLCBkZWZlbmRlci5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmUtc2hvdyBoaW50IG9uIGZhaWx1cmUgdG8gZ3VpZGUgcGxheWVyCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9LCA0MDAwKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBDdXJ2ZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE1pc3NlZCAvIE91dCBvZiBib3VuZHMKICAgICAgICAgICAgaWYgKGJhbGwubWVzaC5wb3NpdGlvbi56IDwgLTE1KSB7CiAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIk1JU1NFRCIsIGJhbGwubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIC8vIFJlLXNob3cgaGludCBvbiBtaXNzCiAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCA0MDAwKTsKICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBDdXJ2ZSgpLCAxMDAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9zZXR1cFJhcGlkRmlyZSgpIHsKICAgICAgICAgICAgdGhpcy5fc2V0SW5zdHJ1Y3Rpb24oIlVOTElNSVRFRCBBTU1PISBTcGFtIHRocm93cyEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gRmluZCBUaWR1cyBvciBkZWZhdWx0IHRvIExGCiAgICAgICAgICAgIGxldCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geC5jaGFyYWN0ZXJOYW1lICYmIHguY2hhcmFjdGVyTmFtZS5pbmNsdWRlcygnVGlkdXMnKSk7CiAgICAgICAgICAgIGlmICghcCkgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ0xGJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXQgYWN0aXZlIHBsYXllcgogICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmhvbWUuc2V0QWN0aXZlUGxheWVyKHApOwogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLTI4KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQm9vc3Qgc3RhdHMgZm9yIGZ1bgogICAgICAgICAgICAgICAgcC5zdGF0cy5TSCA9IDk5OwogICAgICAgICAgICAgICAgcC5zdGF0cy5QQSA9IDk5OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBISURFIEVWRVJZT05FIChBbG9uZSBNb2RlKQogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gobWF0ZSA9PiB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSAhPT0gcCAmJiBtYXRlLm1lc2gpIG1hdGUubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gob3BwID0+IHsKICAgICAgICAgICAgICAgIGlmIChvcHAubWVzaCkgb3BwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQoKX2xvb3BSYXBpZEZpcmUoZHQpIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgYiA9IHRoaXMuZ2FtZS5lbnRpdGllcy5iYWxsOwoKICAgICAgICAgICAgaWYgKCFwIHx8ICFiKSByZXR1cm47CgogICAgICAgICAgICAvLyBEZXRlY3QgaWYgYmFsbCB3YXMganVzdCB0aHJvd24gKGlzIGZyZWUpCiAgICAgICAgICAgIGlmIChiLnN0YXRlID09PSAnZnJlZScpIHsKICAgICAgICAgICAgICAgIC8vIDEuIFNwYXduIEdob3N0IEJhbGwgKFZpc3VhbCBDb3B5KQogICAgICAgICAgICAgICAgLy8gQ2xvbmUgdGhlIG1lc2ggaGllcmFyY2h5IHRvIHByZXNlcnZlIERlZm9ybS9TcGluIG5vZGVzCiAgICAgICAgICAgICAgICBjb25zdCBnaG9zdE1lc2ggPSBiLm1lc2guY2xvbmUoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHZpc2liaWxpdHkgYW5kIGFkZCB0byBzY2VuZQogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZChnaG9zdE1lc2gpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSZS1iaW5kIGludGVybmFsIHJlZmVyZW5jZXMgZm9yIHRoZSBwaHlzaWNzIGVuZ2luZQogICAgICAgICAgICAgICAgLy8gSGllcmFyY2h5OiBNZXNoIC0+IERlZm9ybU5vZGUgLT4gU3Bpbk5vZGUKICAgICAgICAgICAgICAgIGNvbnN0IGRlZm9ybU5vZGUgPSBnaG9zdE1lc2guY2hpbGRyZW5bMF07CiAgICAgICAgICAgICAgICBjb25zdCBzcGluTm9kZSA9IGRlZm9ybU5vZGUgPyBkZWZvcm1Ob2RlLmNoaWxkcmVuWzBdIDogbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBEZXRlcm1pbmUgVHJhaWwgQ29sb3IgYmFzZWQgb24gVGVjaAogICAgICAgICAgICAgICAgbGV0IHRyYWlsQ29sb3IgPSAweGZmNDQwMDsgLy8gRGVmYXVsdCBTSCAoT3JhbmdlKQogICAgICAgICAgICAgICAgaWYgKGIudGVjaG5pcXVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICd2ZW5vbScpIHRyYWlsQ29sb3IgPSAweGFhMDBmZjsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnd2l0aGVyJykgdHJhaWxDb2xvciA9IDB4ODg4ODg4OwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICduYXAnKSB0cmFpbENvbG9yID0gMHgwMDAwODg7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ3NwaGVyZScpIHRyYWlsQ29sb3IgPSAweDAwZmZmZjsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnamVjaHQnKSB0cmFpbENvbG9yID0gMHhmZjAwMDA7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIHRyYWlsQ29sb3IgPSAweDQ0NDQ0NDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYi5wb3dlclR5cGUgPT09ICdQQScpIHsKICAgICAgICAgICAgICAgICAgICB0cmFpbENvbG9yID0gMHgwMGFhZmY7IC8vIFBhc3MgKEJsdWUpCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIFRyYWlsCiAgICAgICAgICAgICAgICBjb25zdCB0cmFpbCA9IG5ldyB3aW5kb3cuZmx1eC5UcmFpbFJlbmRlcmVyKHRoaXMuZ2FtZS5zY2VuZSk7CiAgICAgICAgICAgICAgICB0cmFpbC5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgdHJhaWwuc2V0Q29sb3IodHJhaWxDb2xvcik7CiAgICAgICAgICAgICAgICB0cmFpbC5yZXNldChnaG9zdE1lc2gucG9zaXRpb24pOwoKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhICJNb2NrIiBCYWxsIG9iamVjdCB0aGF0IHNhdGlzZmllcyBCYWxsLmpzIHBoeXNpY3MgcmVxdWlyZW1lbnRzCiAgICAgICAgICAgICAgICBjb25zdCBnaG9zdEJhbGwgPSB7CiAgICAgICAgICAgICAgICAgICAgbWVzaDogZ2hvc3RNZXNoLAogICAgICAgICAgICAgICAgICAgIGRlZm9ybU5vZGU6IGRlZm9ybU5vZGUsCiAgICAgICAgICAgICAgICAgICAgc3Bpbk5vZGU6IHNwaW5Ob2RlLAogICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBiLnZlbG9jaXR5LmNsb25lKCksCiAgICAgICAgICAgICAgICAgICAgYW5ndWxhclZlbG9jaXR5OiBiLmFuZ3VsYXJWZWxvY2l0eSA/IGIuYW5ndWxhclZlbG9jaXR5LmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpLAogICAgICAgICAgICAgICAgICAgIGFjY3VtdWxhdGVkUm90YXRpb246IGIuYWNjdW11bGF0ZWRSb3RhdGlvbiA/IGIuYWNjdW11bGF0ZWRSb3RhdGlvbi5jbG9uZSgpIDogbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwKICAgICAgICAgICAgICAgICAgICBzdGF0ZTogJ2ZyZWUnLAogICAgICAgICAgICAgICAgICAgIHBvd2VyOiBiLnBvd2VyLAogICAgICAgICAgICAgICAgICAgIHBvd2VyVHlwZTogYi5wb3dlclR5cGUsCiAgICAgICAgICAgICAgICAgICAgdGVjaG5pcXVlOiBiLnRlY2huaXF1ZSwKICAgICAgICAgICAgICAgICAgICBpc0ludmlzaWJsZTogYi5pc0ludmlzaWJsZSwKICAgICAgICAgICAgICAgICAgICBsaWZlOiA1LjAsIC8vIEVub3VnaCB0aW1lIHRvIHJlYWNoIGdvYWwKICAgICAgICAgICAgICAgICAgICB0cmFpbDogdHJhaWwsCiAgICAgICAgICAgICAgICAgICAgX2J1YmJsZVRpbWVyOiAwLAogICAgICAgICAgICAgICAgICAgIF9naG9zdDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAvLyBNb2NrIG1ldGhvZHMKICAgICAgICAgICAgICAgICAgICByZXNldDogKCkgPT4ge30sIAogICAgICAgICAgICAgICAgICAgIGRyb3A6ICgpID0+IHt9LAogICAgICAgICAgICAgICAgICAgIHJldmVhbDogKCkgPT4ge30KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdmlzaWJpbGl0eQogICAgICAgICAgICAgICAgZ2hvc3RNZXNoLnZpc2libGUgPSAhYi5pc0ludmlzaWJsZTsKCiAgICAgICAgICAgICAgICB0aGlzLmdob3N0QmFsbHMucHVzaChnaG9zdEJhbGwpOwoKLy8gMi4gUmVzZXQgUmVhbCBCYWxsIHRvIFBsYXllciBJTlNUQU5UTFkKICAgICAgICAgICAgICAgIGIudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGSVg6IEZvcmNlIGJhbGwgcG9zaXRpb24gdG8gYmUgZXhwbGljaXRseSBpbiBmcm9udCBvZiB0aGUgcGxheWVyCiAgICAgICAgICAgICAgICAvLyBUaGlzIHByZXZlbnRzIGFueSBsb2dpYyBmcm9tIHRoaW5raW5nIHRoZSBiYWxsIGlzIGJlaGluZCBhbmQgdHJpZ2dlcmluZyBhIHR1cm4KICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihwLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24uY29weShwLm1lc2gucG9zaXRpb24pLmFkZChmd2QubXVsdGlwbHlTY2FsYXIoMC44KSk7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24ueSArPSAxLjA7CgogICAgICAgICAgICAgICAgLy8gTWFudWFsIEF0dGFjaCAoQnlwYXNzICdjYXRjaCcgYW5pbWF0aW9uKQogICAgICAgICAgICAgICAgYi5ob2xkZXIgPSBwOwogICAgICAgICAgICAgICAgYi5zdGF0ZSA9ICdoZWxkJzsKICAgICAgICAgICAgICAgIHAuaGFzQmFsbCA9IHRydWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IFBsYXllciBUaHJvdyBTdGF0ZSBzbyB0aGV5IGNhbiBmaXJlIGFnYWluIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICBwLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHAuY2F0Y2hDb29sZG93biA9IDA7CgogICAgICAgICAgICAgICAgLy8gU3luYyByb3RhdGlvbiB0byBwcmV2ZW50IHNuYXBwaW5nCiAgICAgICAgICAgICAgICBpZiAocC5zeW5jUm90YXRpb24pIHAuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBpbmZpbml0ZSBzdGF0cwogICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dQYW5lbCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudWkpIHRoaXMudWkuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgfQoKICAgICAgICBfaGlkZVBhbmVsKCkgewogICAgICAgICAgICBpZiAodGhpcy51aSkgdGhpcy51aS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICB9CgogICAgICAgIF9zaG93UmVzdG9yZUJ0bigpIHsKICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChidG4pIGJ0bi5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlUmVzdG9yZUJ0bigpIHsKICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJyk7CiAgICAgICAgICAgIGlmIChidG4pIGJ0bi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KICAgIH0Kd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyID0gUHJhY3RpY2VNYW5hZ2VyOwp9KSgpOw==","WaterOverlay.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gSGlnaC1RdWFsaXR5IE5vaXNlIFRleHR1cmUgR2VuZXJhdG9yIC0tLQogICAgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBzaXplID0gNTEyOwogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gc2l6ZTsgYy5oZWlnaHQgPSBzaXplOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMwMDAwMDAnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzaXplLCBzaXplKTsKICAgICAgICAKICAgICAgICAvLyBHZW5lcmF0ZSBzZWFtbGVzcyBub2lzZSAoUGVybGluLWlzaCB2aWEgbGF5ZXJlZCByYW5kb20gY2lyY2xlcy9ncmFkaWVudHMpCiAgICAgICAgY29uc3QgZHJhd05vaXNlTGF5ZXIgPSAoc2NhbGUsIGFscGhhKSA9PiB7CiAgICAgICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IGFscGhhOwogICAgICAgICAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ2xpZ2h0ZXInOyAvLyBBZGRpdGl2ZQogICAgICAgICAgICBjb25zdCBjb3VudCA9IDMwMCAqIHNjYWxlOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCByID0gKE1hdGgucmFuZG9tKCkgKiAzMCArIDEwKSAvIHNjYWxlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgsIHksIDAsIHgsIHksIHIpOwogICAgICAgICAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJyM4ODg4ODgnKTsKICAgICAgICAgICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICd0cmFuc3BhcmVudCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyh4LCB5LCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBXcmFwIGFyb3VuZCBmb3Igc2VhbWxlc3MgdGlsaW5nCiAgICAgICAgICAgICAgICBbW3gtc2l6ZSwgeV0sIFt4K3NpemUsIHldLCBbeCwgeS1zaXplXSwgW3gsIHkrc2l6ZV1dLmZvckVhY2gocG9zID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnMiA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChwb3NbMF0sIHBvc1sxXSwgMCwgcG9zWzBdLCBwb3NbMV0sIHIpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgwLCAnIzg4ODg4OCcpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgxLCAndHJhbnNwYXJlbnQnKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzI7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKHBvc1swXSwgcG9zWzFdLCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIAogICAgICAgIGRyYXdOb2lzZUxheWVyKDEuMCwgMC4zKTsKICAgICAgICBkcmF3Tm9pc2VMYXllcigyLjAsIDAuMik7CiAgICAgICAgZHJhd05vaXNlTGF5ZXIoNC4wLCAwLjEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9KSgpOwoKICAgIGNsYXNzIFdhdGVyT3ZlcmxheSB7CiAgICAgICAgY29uc3RydWN0b3IoY2FtZXJhKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVsbHNjcmVlbiBxdWFkCiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMik7CiAgICAgICAgICAgIApjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7Cgpjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHROb2lzZTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CgogICAgICAgICAgICAgICAgLy8gRkZYIFBhbGV0dGUgKEFkZGl0aXZlIEZyaWVuZGx5KQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0RFRVAgPSB2ZWMzKDAuMCwgMC4wMiwgMC4xKTsgICAgIC8vIFN1YnRsZSBEZWVwIEJsdWUgRWRnZQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0dMT1cgPSB2ZWMzKDAuMCwgMC41LCAwLjgpOyAgICAgIC8vIEN5YW4gR2xvdwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1JBWSAgPSB2ZWMzKDAuNCwgMC43LCAxLjApOyAgICAgIC8vIExpZ2h0IFNoYWZ0cwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1BZUkUgPSB2ZWMzKDEuMCwgMC45LCAwLjYpOyAgICAgIC8vIFB5cmVmbHkgR29sZAoKICAgICAgICAgICAgICAgIC8vIEJheWVyIDR4NCBEaXRoZXJpbmcKICAgICAgICAgICAgICAgIGZsb2F0IGJheWVyNHg0KHZlYzIgdXYpIHsKICAgICAgICAgICAgICAgICAgICBpbnQgeCA9IGludChtb2QodXYueCwgNC4wKSk7CiAgICAgICAgICAgICAgICAgICAgaW50IHkgPSBpbnQobW9kKHV2LnksIDQuMCkpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHYgPSAwLjA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHkgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeCA9PSAwKSB2ID0gMC4wOyBlbHNlIGlmICh4ID09IDEpIHYgPSA4LjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDIuMDsgZWxzZSB2ID0gMTAuMDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHkgPT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeCA9PSAwKSB2ID0gMTIuMDsgZWxzZSBpZiAoeCA9PSAxKSB2ID0gNC4wOyBlbHNlIGlmICh4ID09IDIpIHYgPSAxNC4wOyBlbHNlIHYgPSA2LjA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh5ID09IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHggPT0gMCkgdiA9IDMuMDsgZWxzZSBpZiAoeCA9PSAxKSB2ID0gMTEuMDsgZWxzZSBpZiAoeCA9PSAyKSB2ID0gMS4wOyBlbHNlIHYgPSA5LjA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHggPT0gMCkgdiA9IDE1LjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDcuMDsgZWxzZSBpZiAoeCA9PSAyKSB2ID0gMTMuMDsgZWxzZSB2ID0gNS4wOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdiAvIDE2LjA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgIHZlYzIgdXYgPSB2VXY7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdCA9IHVUaW1lICogMC4xOwoKICAgICAgICAgICAgICAgICAgICAvLyAxLiBEaXN0b3J0aW9uIChMb29rdXAgMSkKICAgICAgICAgICAgICAgICAgICBmbG9hdCB3YXJwID0gdGV4dHVyZTJEKHROb2lzZSwgdXYgKiAwLjQgKyB2ZWMyKHQgKiAwLjA0LCB0ICogMC4wMikpLnI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gQ2F1c3RpY3MgKExvb2t1cCAyKQogICAgICAgICAgICAgICAgICAgIHZlYzIgY1VWID0gdXYgKiAyLjAgKyB2ZWMyKHdhcnAgKiAwLjUsIHdhcnAgKiAwLjIpIC0gdmVjMih0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYyA9IHRleHR1cmUyRCh0Tm9pc2UsIGNVVikucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjID0gKGMgLSAwLjQpICogMi41OwogICAgICAgICAgICAgICAgICAgIGMgPSBtYXgoMC4wLCBjKTsKICAgICAgICAgICAgICAgICAgICBjID0gYyAqIGM7CiAgICAgICAgICAgICAgICAgICAgYyA9IGMgKiBjOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IGNhdXN0aWMgPSBjICogMTIuMDsKICAgICAgICAgICAgICAgICAgICB2ZWMzIGNhdXN0aWNDb2xvciA9IHZlYzMoY2F1c3RpYyAqIDAuOCwgY2F1c3RpYywgY2F1c3RpYyAqIDEuMik7CgogICAgICAgICAgICAgICAgICAgIC8vIDMuIFJheXMgKExvb2t1cCAzKQogICAgICAgICAgICAgICAgICAgIHZlYzIgcmF5VVYgPSB2ZWMyKHV2LnggKyB3YXJwICogMC4xLCB1di55ICogMC4xNSAtIHQgKiAwLjA1KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYXlzID0gdGV4dHVyZTJEKHROb2lzZSwgcmF5VVYpLnI7CiAgICAgICAgICAgICAgICAgICAgcmF5cyA9IHJheXMgKiByYXlzOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheU1hc2sgPSAxLjAgLSBhYnModXYueSAqIDIuMCAtIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgcmF5cyAqPSBtYXgoMC4wLCByYXlNYXNrKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gNC4gUHlyZWZsaWVzCiAgICAgICAgICAgICAgICAgICAgdmVjMiBwID0gdXYgKiA1LjA7CiAgICAgICAgICAgICAgICAgICAgdmVjMiBpZCA9IGZsb29yKHApOwogICAgICAgICAgICAgICAgICAgIHZlYzIgc3ViID0gZnJhY3QocCkgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgbiA9IGZyYWN0KHNpbihkb3QoaWQsIHZlYzIoMTIuOTg5OCwgNzguMjMzKSkpICogNDM3NTguNTQ1Myk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgcHggPSBmcmFjdChuICogMTMuMCArIHQgKiAwLjMpIC0gMC41OwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHB5ID0gZnJhY3QobiAqIDcuMCArIHQgKiAwLjIpIC0gMC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZlYzIgZmx5UG9zID0gdmVjMihweCwgcHkpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGQyID0gZG90KHN1YiAtIGZseVBvcywgc3ViIC0gZmx5UG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCBmbHkgPSAwLjAwMDggLyAoZDIgKyAwLjAwMDUpOwogICAgICAgICAgICAgICAgICAgIGZseSAqPSBzdGVwKDAuNywgbik7IAogICAgICAgICAgICAgICAgICAgIGZseSAqPSAwLjUgKyAwLjUgKiBzaW4odCAqIDUuMCArIG4gKiAxMC4wKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQ29tcG9zaXRpb24KICAgICAgICAgICAgICAgICAgICB2ZWMzIGZpbmFsQ29sID0gdmVjMygwLjApOwoKICAgICAgICAgICAgICAgICAgICAvLyBWaWduZXR0ZQogICAgICAgICAgICAgICAgICAgIHZlYzIgdmQgPSB1diAtIDAuNTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB2U3EgPSBkb3QodmQsIHZkKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB2aWcgPSB2U3EgKiAxLjI7IAogICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sICs9IENfREVFUCAqIHZpZzsKCiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gY2F1c3RpY0NvbG9yICogQ19HTE9XICogMC42OwogICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sICs9IHJheXMgKiBDX1JBWSAqIDAuMzsKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBmbHkgKiBDX1BZUkU7CgogICAgICAgICAgICAgICAgICAgIC8vIFBTWCBEaXRoZXJpbmcKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkaXRoZXIgPSBiYXllcjR4NChnbF9GcmFnQ29vcmQueHkpOwogICAgICAgICAgICAgICAgICAgIC8vIE1vZHVsYXRlIGludGVuc2l0eSB3aXRoIGRpdGhlciBwYXR0ZXJuIGZvciB0ZXh0dXJlCiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gKGRpdGhlciAtIDAuNSkgKiAwLjA4OwoKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGZpbmFsQ29sLCB1T3BhY2l0eSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7Cgp0aGlzLm1hdGVyaWFsID0gbmV3IFRIUkVFLlNoYWRlck1hdGVyaWFsKHsKICAgICAgICAgICAgICAgIHVuaWZvcm1zOiB7CiAgICAgICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgICAgICB1T3BhY2l0eTogeyB2YWx1ZTogMC41IH0sCiAgICAgICAgICAgICAgICAgICAgdE5vaXNlOiB7IHZhbHVlOiB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHZlcnRleFNoYWRlcjogdmVydCwKICAgICAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBmcmFnLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyAvLyBBZGRpdGl2ZSBibGVuZGluZyBwcmV2ZW50cyBkYXJrIG9jY2x1c2lvbgogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMubWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCB0aGlzLm1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy5tZXNoLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5tZXNoLnJlbmRlck9yZGVyID0gOTk5OTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFkZCB0byBjYW1lcmEgc28gaXQgc3RheXMgb24gc2NyZWVuCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmFkZCh0aGlzLm1lc2gpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwudW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIHdpbmRvdy5mbHV4LldhdGVyT3ZlcmxheSA9IFdhdGVyT3ZlcmxheTsKfSkoKTs=","./WaterOverlay.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gSGlnaC1RdWFsaXR5IE5vaXNlIFRleHR1cmUgR2VuZXJhdG9yIC0tLQogICAgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBzaXplID0gNTEyOwogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gc2l6ZTsgYy5oZWlnaHQgPSBzaXplOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMwMDAwMDAnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzaXplLCBzaXplKTsKICAgICAgICAKICAgICAgICAvLyBHZW5lcmF0ZSBzZWFtbGVzcyBub2lzZSAoUGVybGluLWlzaCB2aWEgbGF5ZXJlZCByYW5kb20gY2lyY2xlcy9ncmFkaWVudHMpCiAgICAgICAgY29uc3QgZHJhd05vaXNlTGF5ZXIgPSAoc2NhbGUsIGFscGhhKSA9PiB7CiAgICAgICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IGFscGhhOwogICAgICAgICAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ2xpZ2h0ZXInOyAvLyBBZGRpdGl2ZQogICAgICAgICAgICBjb25zdCBjb3VudCA9IDMwMCAqIHNjYWxlOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCByID0gKE1hdGgucmFuZG9tKCkgKiAzMCArIDEwKSAvIHNjYWxlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgsIHksIDAsIHgsIHksIHIpOwogICAgICAgICAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJyM4ODg4ODgnKTsKICAgICAgICAgICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICd0cmFuc3BhcmVudCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyh4LCB5LCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBXcmFwIGFyb3VuZCBmb3Igc2VhbWxlc3MgdGlsaW5nCiAgICAgICAgICAgICAgICBbW3gtc2l6ZSwgeV0sIFt4K3NpemUsIHldLCBbeCwgeS1zaXplXSwgW3gsIHkrc2l6ZV1dLmZvckVhY2gocG9zID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnMiA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChwb3NbMF0sIHBvc1sxXSwgMCwgcG9zWzBdLCBwb3NbMV0sIHIpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgwLCAnIzg4ODg4OCcpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgxLCAndHJhbnNwYXJlbnQnKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzI7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKHBvc1swXSwgcG9zWzFdLCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIAogICAgICAgIGRyYXdOb2lzZUxheWVyKDEuMCwgMC4zKTsKICAgICAgICBkcmF3Tm9pc2VMYXllcigyLjAsIDAuMik7CiAgICAgICAgZHJhd05vaXNlTGF5ZXIoNC4wLCAwLjEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9KSgpOwoKICAgIGNsYXNzIFdhdGVyT3ZlcmxheSB7CiAgICAgICAgY29uc3RydWN0b3IoY2FtZXJhKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVsbHNjcmVlbiBxdWFkCiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMik7CiAgICAgICAgICAgIApjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7Cgpjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHROb2lzZTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CgogICAgICAgICAgICAgICAgLy8gRkZYIFBhbGV0dGUgKEFkZGl0aXZlIEZyaWVuZGx5KQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0RFRVAgPSB2ZWMzKDAuMCwgMC4wMiwgMC4xKTsgICAgIC8vIFN1YnRsZSBEZWVwIEJsdWUgRWRnZQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0dMT1cgPSB2ZWMzKDAuMCwgMC41LCAwLjgpOyAgICAgIC8vIEN5YW4gR2xvdwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1JBWSAgPSB2ZWMzKDAuNCwgMC43LCAxLjApOyAgICAgIC8vIExpZ2h0IFNoYWZ0cwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1BZUkUgPSB2ZWMzKDEuMCwgMC45LCAwLjYpOyAgICAgIC8vIFB5cmVmbHkgR29sZAoKICAgICAgICAgICAgICAgIC8vIEJheWVyIDR4NCBEaXRoZXJpbmcKICAgICAgICAgICAgICAgIGZsb2F0IGJheWVyNHg0KHZlYzIgdXYpIHsKICAgICAgICAgICAgICAgICAgICBpbnQgeCA9IGludChtb2QodXYueCwgNC4wKSk7CiAgICAgICAgICAgICAgICAgICAgaW50IHkgPSBpbnQobW9kKHV2LnksIDQuMCkpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHYgPSAwLjA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHkgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeCA9PSAwKSB2ID0gMC4wOyBlbHNlIGlmICh4ID09IDEpIHYgPSA4LjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDIuMDsgZWxzZSB2ID0gMTAuMDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHkgPT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeCA9PSAwKSB2ID0gMTIuMDsgZWxzZSBpZiAoeCA9PSAxKSB2ID0gNC4wOyBlbHNlIGlmICh4ID09IDIpIHYgPSAxNC4wOyBlbHNlIHYgPSA2LjA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh5ID09IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHggPT0gMCkgdiA9IDMuMDsgZWxzZSBpZiAoeCA9PSAxKSB2ID0gMTEuMDsgZWxzZSBpZiAoeCA9PSAyKSB2ID0gMS4wOyBlbHNlIHYgPSA5LjA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHggPT0gMCkgdiA9IDE1LjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDcuMDsgZWxzZSBpZiAoeCA9PSAyKSB2ID0gMTMuMDsgZWxzZSB2ID0gNS4wOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdiAvIDE2LjA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgIHZlYzIgdXYgPSB2VXY7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdCA9IHVUaW1lICogMC4xOwoKICAgICAgICAgICAgICAgICAgICAvLyAxLiBEaXN0b3J0aW9uIChMb29rdXAgMSkKICAgICAgICAgICAgICAgICAgICBmbG9hdCB3YXJwID0gdGV4dHVyZTJEKHROb2lzZSwgdXYgKiAwLjQgKyB2ZWMyKHQgKiAwLjA0LCB0ICogMC4wMikpLnI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gQ2F1c3RpY3MgKExvb2t1cCAyKQogICAgICAgICAgICAgICAgICAgIHZlYzIgY1VWID0gdXYgKiAyLjAgKyB2ZWMyKHdhcnAgKiAwLjUsIHdhcnAgKiAwLjIpIC0gdmVjMih0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYyA9IHRleHR1cmUyRCh0Tm9pc2UsIGNVVikucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjID0gKGMgLSAwLjQpICogMi41OwogICAgICAgICAgICAgICAgICAgIGMgPSBtYXgoMC4wLCBjKTsKICAgICAgICAgICAgICAgICAgICBjID0gYyAqIGM7CiAgICAgICAgICAgICAgICAgICAgYyA9IGMgKiBjOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IGNhdXN0aWMgPSBjICogMTIuMDsKICAgICAgICAgICAgICAgICAgICB2ZWMzIGNhdXN0aWNDb2xvciA9IHZlYzMoY2F1c3RpYyAqIDAuOCwgY2F1c3RpYywgY2F1c3RpYyAqIDEuMik7CgogICAgICAgICAgICAgICAgICAgIC8vIDMuIFJheXMgKExvb2t1cCAzKQogICAgICAgICAgICAgICAgICAgIHZlYzIgcmF5VVYgPSB2ZWMyKHV2LnggKyB3YXJwICogMC4xLCB1di55ICogMC4xNSAtIHQgKiAwLjA1KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYXlzID0gdGV4dHVyZTJEKHROb2lzZSwgcmF5VVYpLnI7CiAgICAgICAgICAgICAgICAgICAgcmF5cyA9IHJheXMgKiByYXlzOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheU1hc2sgPSAxLjAgLSBhYnModXYueSAqIDIuMCAtIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgcmF5cyAqPSBtYXgoMC4wLCByYXlNYXNrKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gNC4gUHlyZWZsaWVzCiAgICAgICAgICAgICAgICAgICAgdmVjMiBwID0gdXYgKiA1LjA7CiAgICAgICAgICAgICAgICAgICAgdmVjMiBpZCA9IGZsb29yKHApOwogICAgICAgICAgICAgICAgICAgIHZlYzIgc3ViID0gZnJhY3QocCkgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgbiA9IGZyYWN0KHNpbihkb3QoaWQsIHZlYzIoMTIuOTg5OCwgNzguMjMzKSkpICogNDM3NTguNTQ1Myk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgcHggPSBmcmFjdChuICogMTMuMCArIHQgKiAwLjMpIC0gMC41OwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHB5ID0gZnJhY3QobiAqIDcuMCArIHQgKiAwLjIpIC0gMC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZlYzIgZmx5UG9zID0gdmVjMihweCwgcHkpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGQyID0gZG90KHN1YiAtIGZseVBvcywgc3ViIC0gZmx5UG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCBmbHkgPSAwLjAwMDggLyAoZDIgKyAwLjAwMDUpOwogICAgICAgICAgICAgICAgICAgIGZseSAqPSBzdGVwKDAuNywgbik7IAogICAgICAgICAgICAgICAgICAgIGZseSAqPSAwLjUgKyAwLjUgKiBzaW4odCAqIDUuMCArIG4gKiAxMC4wKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQ29tcG9zaXRpb24KICAgICAgICAgICAgICAgICAgICB2ZWMzIGZpbmFsQ29sID0gdmVjMygwLjApOwoKICAgICAgICAgICAgICAgICAgICAvLyBWaWduZXR0ZQogICAgICAgICAgICAgICAgICAgIHZlYzIgdmQgPSB1diAtIDAuNTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB2U3EgPSBkb3QodmQsIHZkKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB2aWcgPSB2U3EgKiAxLjI7IAogICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sICs9IENfREVFUCAqIHZpZzsKCiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gY2F1c3RpY0NvbG9yICogQ19HTE9XICogMC42OwogICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sICs9IHJheXMgKiBDX1JBWSAqIDAuMzsKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBmbHkgKiBDX1BZUkU7CgogICAgICAgICAgICAgICAgICAgIC8vIFBTWCBEaXRoZXJpbmcKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkaXRoZXIgPSBiYXllcjR4NChnbF9GcmFnQ29vcmQueHkpOwogICAgICAgICAgICAgICAgICAgIC8vIE1vZHVsYXRlIGludGVuc2l0eSB3aXRoIGRpdGhlciBwYXR0ZXJuIGZvciB0ZXh0dXJlCiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gKGRpdGhlciAtIDAuNSkgKiAwLjA4OwoKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGZpbmFsQ29sLCB1T3BhY2l0eSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7Cgp0aGlzLm1hdGVyaWFsID0gbmV3IFRIUkVFLlNoYWRlck1hdGVyaWFsKHsKICAgICAgICAgICAgICAgIHVuaWZvcm1zOiB7CiAgICAgICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgICAgICB1T3BhY2l0eTogeyB2YWx1ZTogMC41IH0sCiAgICAgICAgICAgICAgICAgICAgdE5vaXNlOiB7IHZhbHVlOiB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHZlcnRleFNoYWRlcjogdmVydCwKICAgICAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBmcmFnLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyAvLyBBZGRpdGl2ZSBibGVuZGluZyBwcmV2ZW50cyBkYXJrIG9jY2x1c2lvbgogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMubWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCB0aGlzLm1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy5tZXNoLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5tZXNoLnJlbmRlck9yZGVyID0gOTk5OTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFkZCB0byBjYW1lcmEgc28gaXQgc3RheXMgb24gc2NyZWVuCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmFkZCh0aGlzLm1lc2gpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwudW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIHdpbmRvdy5mbHV4LldhdGVyT3ZlcmxheSA9IFdhdGVyT3ZlcmxheTsKfSkoKTs=","/WaterOverlay.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gSGlnaC1RdWFsaXR5IE5vaXNlIFRleHR1cmUgR2VuZXJhdG9yIC0tLQogICAgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBzaXplID0gNTEyOwogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gc2l6ZTsgYy5oZWlnaHQgPSBzaXplOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMwMDAwMDAnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzaXplLCBzaXplKTsKICAgICAgICAKICAgICAgICAvLyBHZW5lcmF0ZSBzZWFtbGVzcyBub2lzZSAoUGVybGluLWlzaCB2aWEgbGF5ZXJlZCByYW5kb20gY2lyY2xlcy9ncmFkaWVudHMpCiAgICAgICAgY29uc3QgZHJhd05vaXNlTGF5ZXIgPSAoc2NhbGUsIGFscGhhKSA9PiB7CiAgICAgICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IGFscGhhOwogICAgICAgICAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ2xpZ2h0ZXInOyAvLyBBZGRpdGl2ZQogICAgICAgICAgICBjb25zdCBjb3VudCA9IDMwMCAqIHNjYWxlOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCByID0gKE1hdGgucmFuZG9tKCkgKiAzMCArIDEwKSAvIHNjYWxlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgsIHksIDAsIHgsIHksIHIpOwogICAgICAgICAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJyM4ODg4ODgnKTsKICAgICAgICAgICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICd0cmFuc3BhcmVudCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyh4LCB5LCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBXcmFwIGFyb3VuZCBmb3Igc2VhbWxlc3MgdGlsaW5nCiAgICAgICAgICAgICAgICBbW3gtc2l6ZSwgeV0sIFt4K3NpemUsIHldLCBbeCwgeS1zaXplXSwgW3gsIHkrc2l6ZV1dLmZvckVhY2gocG9zID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnMiA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChwb3NbMF0sIHBvc1sxXSwgMCwgcG9zWzBdLCBwb3NbMV0sIHIpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgwLCAnIzg4ODg4OCcpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgxLCAndHJhbnNwYXJlbnQnKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzI7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKHBvc1swXSwgcG9zWzFdLCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIAogICAgICAgIGRyYXdOb2lzZUxheWVyKDEuMCwgMC4zKTsKICAgICAgICBkcmF3Tm9pc2VMYXllcigyLjAsIDAuMik7CiAgICAgICAgZHJhd05vaXNlTGF5ZXIoNC4wLCAwLjEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9KSgpOwoKICAgIGNsYXNzIFdhdGVyT3ZlcmxheSB7CiAgICAgICAgY29uc3RydWN0b3IoY2FtZXJhKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVsbHNjcmVlbiBxdWFkCiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMik7CiAgICAgICAgICAgIApjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7Cgpjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHROb2lzZTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CgogICAgICAgICAgICAgICAgLy8gRkZYIFBhbGV0dGUgKEFkZGl0aXZlIEZyaWVuZGx5KQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0RFRVAgPSB2ZWMzKDAuMCwgMC4wMiwgMC4xKTsgICAgIC8vIFN1YnRsZSBEZWVwIEJsdWUgRWRnZQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0dMT1cgPSB2ZWMzKDAuMCwgMC41LCAwLjgpOyAgICAgIC8vIEN5YW4gR2xvdwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1JBWSAgPSB2ZWMzKDAuNCwgMC43LCAxLjApOyAgICAgIC8vIExpZ2h0IFNoYWZ0cwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1BZUkUgPSB2ZWMzKDEuMCwgMC45LCAwLjYpOyAgICAgIC8vIFB5cmVmbHkgR29sZAoKICAgICAgICAgICAgICAgIC8vIEJheWVyIDR4NCBEaXRoZXJpbmcKICAgICAgICAgICAgICAgIGZsb2F0IGJheWVyNHg0KHZlYzIgdXYpIHsKICAgICAgICAgICAgICAgICAgICBpbnQgeCA9IGludChtb2QodXYueCwgNC4wKSk7CiAgICAgICAgICAgICAgICAgICAgaW50IHkgPSBpbnQobW9kKHV2LnksIDQuMCkpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHYgPSAwLjA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHkgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeCA9PSAwKSB2ID0gMC4wOyBlbHNlIGlmICh4ID09IDEpIHYgPSA4LjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDIuMDsgZWxzZSB2ID0gMTAuMDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHkgPT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeCA9PSAwKSB2ID0gMTIuMDsgZWxzZSBpZiAoeCA9PSAxKSB2ID0gNC4wOyBlbHNlIGlmICh4ID09IDIpIHYgPSAxNC4wOyBlbHNlIHYgPSA2LjA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh5ID09IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHggPT0gMCkgdiA9IDMuMDsgZWxzZSBpZiAoeCA9PSAxKSB2ID0gMTEuMDsgZWxzZSBpZiAoeCA9PSAyKSB2ID0gMS4wOyBlbHNlIHYgPSA5LjA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHggPT0gMCkgdiA9IDE1LjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDcuMDsgZWxzZSBpZiAoeCA9PSAyKSB2ID0gMTMuMDsgZWxzZSB2ID0gNS4wOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdiAvIDE2LjA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdm9pZCBtYWluKCkgewogICAgICAgICAgICAgICAgICAgIHZlYzIgdXYgPSB2VXY7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdCA9IHVUaW1lICogMC4xOwoKICAgICAgICAgICAgICAgICAgICAvLyAxLiBEaXN0b3J0aW9uIChMb29rdXAgMSkKICAgICAgICAgICAgICAgICAgICBmbG9hdCB3YXJwID0gdGV4dHVyZTJEKHROb2lzZSwgdXYgKiAwLjQgKyB2ZWMyKHQgKiAwLjA0LCB0ICogMC4wMikpLnI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gQ2F1c3RpY3MgKExvb2t1cCAyKQogICAgICAgICAgICAgICAgICAgIHZlYzIgY1VWID0gdXYgKiAyLjAgKyB2ZWMyKHdhcnAgKiAwLjUsIHdhcnAgKiAwLjIpIC0gdmVjMih0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYyA9IHRleHR1cmUyRCh0Tm9pc2UsIGNVVikucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjID0gKGMgLSAwLjQpICogMi41OwogICAgICAgICAgICAgICAgICAgIGMgPSBtYXgoMC4wLCBjKTsKICAgICAgICAgICAgICAgICAgICBjID0gYyAqIGM7CiAgICAgICAgICAgICAgICAgICAgYyA9IGMgKiBjOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IGNhdXN0aWMgPSBjICogMTIuMDsKICAgICAgICAgICAgICAgICAgICB2ZWMzIGNhdXN0aWNDb2xvciA9IHZlYzMoY2F1c3RpYyAqIDAuOCwgY2F1c3RpYywgY2F1c3RpYyAqIDEuMik7CgogICAgICAgICAgICAgICAgICAgIC8vIDMuIFJheXMgKExvb2t1cCAzKQogICAgICAgICAgICAgICAgICAgIHZlYzIgcmF5VVYgPSB2ZWMyKHV2LnggKyB3YXJwICogMC4xLCB1di55ICogMC4xNSAtIHQgKiAwLjA1KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYXlzID0gdGV4dHVyZTJEKHROb2lzZSwgcmF5VVYpLnI7CiAgICAgICAgICAgICAgICAgICAgcmF5cyA9IHJheXMgKiByYXlzOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheU1hc2sgPSAxLjAgLSBhYnModXYueSAqIDIuMCAtIDEuMCk7CiAgICAgICAgICAgICAgICAgICAgcmF5cyAqPSBtYXgoMC4wLCByYXlNYXNrKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gNC4gUHlyZWZsaWVzCiAgICAgICAgICAgICAgICAgICAgdmVjMiBwID0gdXYgKiA1LjA7CiAgICAgICAgICAgICAgICAgICAgdmVjMiBpZCA9IGZsb29yKHApOwogICAgICAgICAgICAgICAgICAgIHZlYzIgc3ViID0gZnJhY3QocCkgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgbiA9IGZyYWN0KHNpbihkb3QoaWQsIHZlYzIoMTIuOTg5OCwgNzguMjMzKSkpICogNDM3NTguNTQ1Myk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgcHggPSBmcmFjdChuICogMTMuMCArIHQgKiAwLjMpIC0gMC41OwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHB5ID0gZnJhY3QobiAqIDcuMCArIHQgKiAwLjIpIC0gMC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZlYzIgZmx5UG9zID0gdmVjMihweCwgcHkpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IGQyID0gZG90KHN1YiAtIGZseVBvcywgc3ViIC0gZmx5UG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCBmbHkgPSAwLjAwMDggLyAoZDIgKyAwLjAwMDUpOwogICAgICAgICAgICAgICAgICAgIGZseSAqPSBzdGVwKDAuNywgbik7IAogICAgICAgICAgICAgICAgICAgIGZseSAqPSAwLjUgKyAwLjUgKiBzaW4odCAqIDUuMCArIG4gKiAxMC4wKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQ29tcG9zaXRpb24KICAgICAgICAgICAgICAgICAgICB2ZWMzIGZpbmFsQ29sID0gdmVjMygwLjApOwoKICAgICAgICAgICAgICAgICAgICAvLyBWaWduZXR0ZQogICAgICAgICAgICAgICAgICAgIHZlYzIgdmQgPSB1diAtIDAuNTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB2U3EgPSBkb3QodmQsIHZkKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB2aWcgPSB2U3EgKiAxLjI7IAogICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sICs9IENfREVFUCAqIHZpZzsKCiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gY2F1c3RpY0NvbG9yICogQ19HTE9XICogMC42OwogICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sICs9IHJheXMgKiBDX1JBWSAqIDAuMzsKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBmbHkgKiBDX1BZUkU7CgogICAgICAgICAgICAgICAgICAgIC8vIFBTWCBEaXRoZXJpbmcKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkaXRoZXIgPSBiYXllcjR4NChnbF9GcmFnQ29vcmQueHkpOwogICAgICAgICAgICAgICAgICAgIC8vIE1vZHVsYXRlIGludGVuc2l0eSB3aXRoIGRpdGhlciBwYXR0ZXJuIGZvciB0ZXh0dXJlCiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gKGRpdGhlciAtIDAuNSkgKiAwLjA4OwoKICAgICAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGZpbmFsQ29sLCB1T3BhY2l0eSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7Cgp0aGlzLm1hdGVyaWFsID0gbmV3IFRIUkVFLlNoYWRlck1hdGVyaWFsKHsKICAgICAgICAgICAgICAgIHVuaWZvcm1zOiB7CiAgICAgICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgICAgICB1T3BhY2l0eTogeyB2YWx1ZTogMC41IH0sCiAgICAgICAgICAgICAgICAgICAgdE5vaXNlOiB7IHZhbHVlOiB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHZlcnRleFNoYWRlcjogdmVydCwKICAgICAgICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiBmcmFnLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyAvLyBBZGRpdGl2ZSBibGVuZGluZyBwcmV2ZW50cyBkYXJrIG9jY2x1c2lvbgogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMubWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCB0aGlzLm1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy5tZXNoLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5tZXNoLnJlbmRlck9yZGVyID0gOTk5OTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFkZCB0byBjYW1lcmEgc28gaXQgc3RheXMgb24gc2NyZWVuCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmFkZCh0aGlzLm1lc2gpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwudW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIHdpbmRvdy5mbHV4LldhdGVyT3ZlcmxheSA9IFdhdGVyT3ZlcmxheTsKfSkoKTs=","GlyphManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUSU9OIC0tLQogICAgY29uc3QgX2NyZWF0ZUdseXBoVGV4dHVyZSA9IChjb2xvclN0ciwgdHlwZSkgPT4gewogICAgICAgIGNvbnN0IHNpemUgPSAyNTY7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSBzaXplOyBjLmhlaWdodCA9IHNpemU7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgc2l6ZSwgc2l6ZSk7CiAgICAgICAgCiAgICAgICAgLy8gR2xvdyBzZXR0aW5ncwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gMTU7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gY29sb3JTdHI7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3JTdHI7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGNvbG9yU3RyOwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKCiAgICAgICAgY29uc3QgY3ggPSBzaXplIC8gMjsKICAgICAgICBjb25zdCBjeSA9IHNpemUgLyAyOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ3JpbmcnKSB7CiAgICAgICAgICAgIC8vIE91dGVyIFJpbmcKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDY7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDExMCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBJbm5lciBSaW5nCiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoY3gsIGN5LCA5MCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBSdW5lcwpjdHguZm9udCA9ICcyNHB4IFNwaXJhLCBzYW5zLXNlcmlmJzsKICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTAwOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IGN4ICsgTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjeSArIE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICBjdHgudHJhbnNsYXRlKHgsIHkpOwogICAgICAgICAgICAgICAgY3R4LnJvdGF0ZShhbmdsZSArIE1hdGguUEkvMik7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGEgc2ltcGxlIHJ1bmUtbGlrZSBzaGFwZQogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygtNSwgLTUpOyBjdHgubGluZVRvKDUsIDApOyBjdHgubGluZVRvKC01LCA1KTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdydW5lJykgewogICAgICAgICAgICAvLyBDZW50cmFsIENvbXBsZXggUnVuZQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgNjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKGN4LCBjeSAtIDYwKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCwgY3kgKyA2MCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3ggLSA2MCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgNjAsIGN5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9OwoKICAgIGNvbnN0IF90ZWNoVGV4dHVyZSA9IF9jcmVhdGVHbHlwaFRleHR1cmUoJyMwMGZmZmYnLCAncmluZycpOyAvLyBDeWFuIFJpbmcKICAgIGNvbnN0IF9zdGF0dXNUZXh0dXJlID0gX2NyZWF0ZUdseXBoVGV4dHVyZSgnI2ZmMDBmZicsICdydW5lJyk7IC8vIE1hZ2VudGEgUnVuZQogICAgY29uc3QgX2NoYXJnZVRleHR1cmUgPSBfY3JlYXRlR2x5cGhUZXh0dXJlKCcjZmZmZjAwJywgJ3JpbmcnKTsgLy8gR29sZCBSaW5nCgogICAgY2xhc3MgR2x5cGhNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZ2x5cGhzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNYXRlcmlhbHMKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbHMgPSB7CiAgICAgICAgICAgICAgICB0ZWNoOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF90ZWNoVGV4dHVyZSwgCiAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBzdGF0dXM6IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgICAgIG1hcDogX3N0YXR1c1RleHR1cmUsIAogICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmZmZmYKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgY2hhcmdlOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF9jaGFyZ2VUZXh0dXJlLCAKICAgICAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgCiAgICAgICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUG9vbAogICAgICAgICAgICB0aGlzLnBvb2wgPSBbXTsKICAgICAgICAgICAgdGhpcy5wb29sU2l6ZSA9IDMwOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLCAxKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgdGhpcy5tYXRlcmlhbHMudGVjaCk7CiAgICAgICAgICAgICAgICBtZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1lc2gucmVuZGVyT3JkZXIgPSAyMDAwOyAvLyBEcmF3IG9uIHRvcCBvZiB3YXRlci9hcmVuYQogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQobWVzaCk7CiAgICAgICAgICAgICAgICB0aGlzLnBvb2wucHVzaChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgbWVzaCA9IHRoaXMucG9vbC5maW5kKG0gPT4gIW0udmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghbWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgbWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgbWVzaC5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWxzW3R5cGVdIHx8IHRoaXMubWF0ZXJpYWxzLnRlY2g7CiAgICAgICAgICAgIG1lc2gucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgTWF0ZXJpYWwgT3BhY2l0eQogICAgICAgICAgICBtZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CgogICAgICAgICAgICAvLyBEZWZhdWx0cwogICAgICAgICAgICBjb25zdCBzY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMS4wOwogICAgICAgICAgICBtZXNoLnNjYWxlLnNldChzY2FsZSwgc2NhbGUsIHNjYWxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9yaWVudGF0aW9uCiAgICAgICAgICAgIGlmIChvcHRpb25zLmZhY2VDYW1lcmEpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMub3JpZW50YXRpb24gPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgLy8gRmFjZSBjYW1lcmEgWS1heGlzIHJvdGF0aW9uIG9ubHkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKGNhbVBvcy54IC0gcG9zLngsIGNhbVBvcy56IC0gcG9zLnopOwogICAgICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24ueSA9IGFuZ2xlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCAoR3JvdW5kKQogICAgICAgICAgICAgICAgbWVzaC5yb3RhdGlvbi5zZXQoLU1hdGguUEkgLyAyLCAwLCBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLm9mZnNldFkpIHsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24ueSArPSBvcHRpb25zLm9mZnNldFk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2x5cGhzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogbWVzaCwKICAgICAgICAgICAgICAgIGFnZTogMCwKICAgICAgICAgICAgICAgIGxpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICBtYXhMaWZlOiBvcHRpb25zLmxpZmUgfHwgMS4wLAogICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogb3B0aW9ucy5yb3RhdGlvblNwZWVkIHx8IDEuMCwKICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IG9wdGlvbnMuc2NhbGVTcGVlZCB8fCAwLAogICAgICAgICAgICAgICAgZmFkZTogb3B0aW9ucy5mYWRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmZhZGUgOiB0cnVlLAogICAgICAgICAgICAgICAgZm9sbG93VGFyZ2V0OiBvcHRpb25zLnBhcmVudCB8fCBudWxsLAogICAgICAgICAgICAgICAgb2Zmc2V0WTogb3B0aW9ucy5vZmZzZXRZIHx8IDAKICAgICAgICAgICAgfSk7CiAgICAgICAgfQp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2x5cGhzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nbHlwaHNbaV07CiAgICAgICAgICAgICAgICBnLmFnZSArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAoZy5hZ2UgPj0gZy5saWZlKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdseXBocy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IGcuYWdlIC8gZy5tYXhMaWZlOwoKICAgICAgICAgICAgICAgIC8vIEZvbGxvdyB0YXJnZXQKICAgICAgICAgICAgICAgIGlmIChnLmZvbGxvd1RhcmdldCAmJiBnLmZvbGxvd1RhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLmNvcHkoZy5mb2xsb3dUYXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnkgKz0gZy5vZmZzZXRZOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGdyb3VuZCBvcmllbnRlZCwga2VlcCBuZWFyIGZsb29yCiAgICAgICAgICAgICAgICAgICAgaWYgKGcubWVzaC5yb3RhdGlvbi54ID09PSAtTWF0aC5QSS8yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBnLm1lc2gucG9zaXRpb24ueSA9IDAuMSArIGcub2Zmc2V0WTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uCiAgICAgICAgICAgICAgICBnLm1lc2gucm90YXRpb24ueiArPSBnLnJvdGF0aW9uU3BlZWQgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGcuc2NhbGVTcGVlZCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBnLm1lc2guc2NhbGUueCArIGcuc2NhbGVTcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgICAgIGcubWVzaC5zY2FsZS5zZXQocywgcywgcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmFkZQogICAgICAgICAgICAgICAgaWYgKGcuZmFkZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBvcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0IDwgMC4xKSBvcGFjaXR5ID0gdCAvIDAuMTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ID4gMC43KSBvcGFjaXR5ID0gMS4wIC0gKCh0IC0gMC43KSAvIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjbGVhcigpIHsKICAgICAgICAgICAgLy8gSGlkZSBhbGwgYWN0aXZlIGdseXBocyBhbmQgcmVzZXQgbGlzdAogICAgICAgICAgICBmb3IgKGNvbnN0IGcgb2YgdGhpcy5nbHlwaHMpIHsKICAgICAgICAgICAgICAgIGlmIChnLm1lc2gpIGcubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5nbHlwaHMgPSBbXTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguR2x5cGhNYW5hZ2VyID0gR2x5cGhNYW5hZ2VyOwp9KSgpOw==","./GlyphManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUSU9OIC0tLQogICAgY29uc3QgX2NyZWF0ZUdseXBoVGV4dHVyZSA9IChjb2xvclN0ciwgdHlwZSkgPT4gewogICAgICAgIGNvbnN0IHNpemUgPSAyNTY7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSBzaXplOyBjLmhlaWdodCA9IHNpemU7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgc2l6ZSwgc2l6ZSk7CiAgICAgICAgCiAgICAgICAgLy8gR2xvdyBzZXR0aW5ncwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gMTU7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gY29sb3JTdHI7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3JTdHI7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGNvbG9yU3RyOwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKCiAgICAgICAgY29uc3QgY3ggPSBzaXplIC8gMjsKICAgICAgICBjb25zdCBjeSA9IHNpemUgLyAyOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ3JpbmcnKSB7CiAgICAgICAgICAgIC8vIE91dGVyIFJpbmcKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDY7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDExMCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBJbm5lciBSaW5nCiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoY3gsIGN5LCA5MCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBSdW5lcwpjdHguZm9udCA9ICcyNHB4IFNwaXJhLCBzYW5zLXNlcmlmJzsKICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTAwOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IGN4ICsgTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjeSArIE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICBjdHgudHJhbnNsYXRlKHgsIHkpOwogICAgICAgICAgICAgICAgY3R4LnJvdGF0ZShhbmdsZSArIE1hdGguUEkvMik7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGEgc2ltcGxlIHJ1bmUtbGlrZSBzaGFwZQogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygtNSwgLTUpOyBjdHgubGluZVRvKDUsIDApOyBjdHgubGluZVRvKC01LCA1KTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdydW5lJykgewogICAgICAgICAgICAvLyBDZW50cmFsIENvbXBsZXggUnVuZQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgNjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKGN4LCBjeSAtIDYwKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCwgY3kgKyA2MCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3ggLSA2MCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgNjAsIGN5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9OwoKICAgIGNvbnN0IF90ZWNoVGV4dHVyZSA9IF9jcmVhdGVHbHlwaFRleHR1cmUoJyMwMGZmZmYnLCAncmluZycpOyAvLyBDeWFuIFJpbmcKICAgIGNvbnN0IF9zdGF0dXNUZXh0dXJlID0gX2NyZWF0ZUdseXBoVGV4dHVyZSgnI2ZmMDBmZicsICdydW5lJyk7IC8vIE1hZ2VudGEgUnVuZQogICAgY29uc3QgX2NoYXJnZVRleHR1cmUgPSBfY3JlYXRlR2x5cGhUZXh0dXJlKCcjZmZmZjAwJywgJ3JpbmcnKTsgLy8gR29sZCBSaW5nCgogICAgY2xhc3MgR2x5cGhNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZ2x5cGhzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNYXRlcmlhbHMKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbHMgPSB7CiAgICAgICAgICAgICAgICB0ZWNoOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF90ZWNoVGV4dHVyZSwgCiAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBzdGF0dXM6IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgICAgIG1hcDogX3N0YXR1c1RleHR1cmUsIAogICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmZmZmYKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgY2hhcmdlOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF9jaGFyZ2VUZXh0dXJlLCAKICAgICAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgCiAgICAgICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUG9vbAogICAgICAgICAgICB0aGlzLnBvb2wgPSBbXTsKICAgICAgICAgICAgdGhpcy5wb29sU2l6ZSA9IDMwOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLCAxKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgdGhpcy5tYXRlcmlhbHMudGVjaCk7CiAgICAgICAgICAgICAgICBtZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1lc2gucmVuZGVyT3JkZXIgPSAyMDAwOyAvLyBEcmF3IG9uIHRvcCBvZiB3YXRlci9hcmVuYQogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQobWVzaCk7CiAgICAgICAgICAgICAgICB0aGlzLnBvb2wucHVzaChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgbWVzaCA9IHRoaXMucG9vbC5maW5kKG0gPT4gIW0udmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghbWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgbWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgbWVzaC5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWxzW3R5cGVdIHx8IHRoaXMubWF0ZXJpYWxzLnRlY2g7CiAgICAgICAgICAgIG1lc2gucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgTWF0ZXJpYWwgT3BhY2l0eQogICAgICAgICAgICBtZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CgogICAgICAgICAgICAvLyBEZWZhdWx0cwogICAgICAgICAgICBjb25zdCBzY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMS4wOwogICAgICAgICAgICBtZXNoLnNjYWxlLnNldChzY2FsZSwgc2NhbGUsIHNjYWxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9yaWVudGF0aW9uCiAgICAgICAgICAgIGlmIChvcHRpb25zLmZhY2VDYW1lcmEpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMub3JpZW50YXRpb24gPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgLy8gRmFjZSBjYW1lcmEgWS1heGlzIHJvdGF0aW9uIG9ubHkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKGNhbVBvcy54IC0gcG9zLngsIGNhbVBvcy56IC0gcG9zLnopOwogICAgICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24ueSA9IGFuZ2xlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCAoR3JvdW5kKQogICAgICAgICAgICAgICAgbWVzaC5yb3RhdGlvbi5zZXQoLU1hdGguUEkgLyAyLCAwLCBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLm9mZnNldFkpIHsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24ueSArPSBvcHRpb25zLm9mZnNldFk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2x5cGhzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogbWVzaCwKICAgICAgICAgICAgICAgIGFnZTogMCwKICAgICAgICAgICAgICAgIGxpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICBtYXhMaWZlOiBvcHRpb25zLmxpZmUgfHwgMS4wLAogICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogb3B0aW9ucy5yb3RhdGlvblNwZWVkIHx8IDEuMCwKICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IG9wdGlvbnMuc2NhbGVTcGVlZCB8fCAwLAogICAgICAgICAgICAgICAgZmFkZTogb3B0aW9ucy5mYWRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmZhZGUgOiB0cnVlLAogICAgICAgICAgICAgICAgZm9sbG93VGFyZ2V0OiBvcHRpb25zLnBhcmVudCB8fCBudWxsLAogICAgICAgICAgICAgICAgb2Zmc2V0WTogb3B0aW9ucy5vZmZzZXRZIHx8IDAKICAgICAgICAgICAgfSk7CiAgICAgICAgfQp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2x5cGhzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nbHlwaHNbaV07CiAgICAgICAgICAgICAgICBnLmFnZSArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAoZy5hZ2UgPj0gZy5saWZlKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdseXBocy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IGcuYWdlIC8gZy5tYXhMaWZlOwoKICAgICAgICAgICAgICAgIC8vIEZvbGxvdyB0YXJnZXQKICAgICAgICAgICAgICAgIGlmIChnLmZvbGxvd1RhcmdldCAmJiBnLmZvbGxvd1RhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLmNvcHkoZy5mb2xsb3dUYXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnkgKz0gZy5vZmZzZXRZOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGdyb3VuZCBvcmllbnRlZCwga2VlcCBuZWFyIGZsb29yCiAgICAgICAgICAgICAgICAgICAgaWYgKGcubWVzaC5yb3RhdGlvbi54ID09PSAtTWF0aC5QSS8yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBnLm1lc2gucG9zaXRpb24ueSA9IDAuMSArIGcub2Zmc2V0WTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uCiAgICAgICAgICAgICAgICBnLm1lc2gucm90YXRpb24ueiArPSBnLnJvdGF0aW9uU3BlZWQgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGcuc2NhbGVTcGVlZCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBnLm1lc2guc2NhbGUueCArIGcuc2NhbGVTcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgICAgIGcubWVzaC5zY2FsZS5zZXQocywgcywgcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmFkZQogICAgICAgICAgICAgICAgaWYgKGcuZmFkZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBvcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0IDwgMC4xKSBvcGFjaXR5ID0gdCAvIDAuMTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ID4gMC43KSBvcGFjaXR5ID0gMS4wIC0gKCh0IC0gMC43KSAvIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjbGVhcigpIHsKICAgICAgICAgICAgLy8gSGlkZSBhbGwgYWN0aXZlIGdseXBocyBhbmQgcmVzZXQgbGlzdAogICAgICAgICAgICBmb3IgKGNvbnN0IGcgb2YgdGhpcy5nbHlwaHMpIHsKICAgICAgICAgICAgICAgIGlmIChnLm1lc2gpIGcubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5nbHlwaHMgPSBbXTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguR2x5cGhNYW5hZ2VyID0gR2x5cGhNYW5hZ2VyOwp9KSgpOw==","/GlyphManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUSU9OIC0tLQogICAgY29uc3QgX2NyZWF0ZUdseXBoVGV4dHVyZSA9IChjb2xvclN0ciwgdHlwZSkgPT4gewogICAgICAgIGNvbnN0IHNpemUgPSAyNTY7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSBzaXplOyBjLmhlaWdodCA9IHNpemU7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgc2l6ZSwgc2l6ZSk7CiAgICAgICAgCiAgICAgICAgLy8gR2xvdyBzZXR0aW5ncwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gMTU7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gY29sb3JTdHI7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3JTdHI7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGNvbG9yU3RyOwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKCiAgICAgICAgY29uc3QgY3ggPSBzaXplIC8gMjsKICAgICAgICBjb25zdCBjeSA9IHNpemUgLyAyOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ3JpbmcnKSB7CiAgICAgICAgICAgIC8vIE91dGVyIFJpbmcKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDY7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDExMCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBJbm5lciBSaW5nCiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoY3gsIGN5LCA5MCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBSdW5lcwpjdHguZm9udCA9ICcyNHB4IFNwaXJhLCBzYW5zLXNlcmlmJzsKICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTAwOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IGN4ICsgTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjeSArIE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICBjdHgudHJhbnNsYXRlKHgsIHkpOwogICAgICAgICAgICAgICAgY3R4LnJvdGF0ZShhbmdsZSArIE1hdGguUEkvMik7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGEgc2ltcGxlIHJ1bmUtbGlrZSBzaGFwZQogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygtNSwgLTUpOyBjdHgubGluZVRvKDUsIDApOyBjdHgubGluZVRvKC01LCA1KTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdydW5lJykgewogICAgICAgICAgICAvLyBDZW50cmFsIENvbXBsZXggUnVuZQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgNjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKGN4LCBjeSAtIDYwKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCwgY3kgKyA2MCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3ggLSA2MCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgNjAsIGN5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9OwoKICAgIGNvbnN0IF90ZWNoVGV4dHVyZSA9IF9jcmVhdGVHbHlwaFRleHR1cmUoJyMwMGZmZmYnLCAncmluZycpOyAvLyBDeWFuIFJpbmcKICAgIGNvbnN0IF9zdGF0dXNUZXh0dXJlID0gX2NyZWF0ZUdseXBoVGV4dHVyZSgnI2ZmMDBmZicsICdydW5lJyk7IC8vIE1hZ2VudGEgUnVuZQogICAgY29uc3QgX2NoYXJnZVRleHR1cmUgPSBfY3JlYXRlR2x5cGhUZXh0dXJlKCcjZmZmZjAwJywgJ3JpbmcnKTsgLy8gR29sZCBSaW5nCgogICAgY2xhc3MgR2x5cGhNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZ2x5cGhzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNYXRlcmlhbHMKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbHMgPSB7CiAgICAgICAgICAgICAgICB0ZWNoOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF90ZWNoVGV4dHVyZSwgCiAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBzdGF0dXM6IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgICAgIG1hcDogX3N0YXR1c1RleHR1cmUsIAogICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmZmZmYKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgY2hhcmdlOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF9jaGFyZ2VUZXh0dXJlLCAKICAgICAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgCiAgICAgICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUG9vbAogICAgICAgICAgICB0aGlzLnBvb2wgPSBbXTsKICAgICAgICAgICAgdGhpcy5wb29sU2l6ZSA9IDMwOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLCAxKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgdGhpcy5tYXRlcmlhbHMudGVjaCk7CiAgICAgICAgICAgICAgICBtZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1lc2gucmVuZGVyT3JkZXIgPSAyMDAwOyAvLyBEcmF3IG9uIHRvcCBvZiB3YXRlci9hcmVuYQogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQobWVzaCk7CiAgICAgICAgICAgICAgICB0aGlzLnBvb2wucHVzaChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgbWVzaCA9IHRoaXMucG9vbC5maW5kKG0gPT4gIW0udmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghbWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgbWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgbWVzaC5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWxzW3R5cGVdIHx8IHRoaXMubWF0ZXJpYWxzLnRlY2g7CiAgICAgICAgICAgIG1lc2gucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgTWF0ZXJpYWwgT3BhY2l0eQogICAgICAgICAgICBtZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CgogICAgICAgICAgICAvLyBEZWZhdWx0cwogICAgICAgICAgICBjb25zdCBzY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMS4wOwogICAgICAgICAgICBtZXNoLnNjYWxlLnNldChzY2FsZSwgc2NhbGUsIHNjYWxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9yaWVudGF0aW9uCiAgICAgICAgICAgIGlmIChvcHRpb25zLmZhY2VDYW1lcmEpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMub3JpZW50YXRpb24gPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgLy8gRmFjZSBjYW1lcmEgWS1heGlzIHJvdGF0aW9uIG9ubHkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKGNhbVBvcy54IC0gcG9zLngsIGNhbVBvcy56IC0gcG9zLnopOwogICAgICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24ueSA9IGFuZ2xlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCAoR3JvdW5kKQogICAgICAgICAgICAgICAgbWVzaC5yb3RhdGlvbi5zZXQoLU1hdGguUEkgLyAyLCAwLCBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLm9mZnNldFkpIHsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24ueSArPSBvcHRpb25zLm9mZnNldFk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2x5cGhzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogbWVzaCwKICAgICAgICAgICAgICAgIGFnZTogMCwKICAgICAgICAgICAgICAgIGxpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICBtYXhMaWZlOiBvcHRpb25zLmxpZmUgfHwgMS4wLAogICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogb3B0aW9ucy5yb3RhdGlvblNwZWVkIHx8IDEuMCwKICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IG9wdGlvbnMuc2NhbGVTcGVlZCB8fCAwLAogICAgICAgICAgICAgICAgZmFkZTogb3B0aW9ucy5mYWRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmZhZGUgOiB0cnVlLAogICAgICAgICAgICAgICAgZm9sbG93VGFyZ2V0OiBvcHRpb25zLnBhcmVudCB8fCBudWxsLAogICAgICAgICAgICAgICAgb2Zmc2V0WTogb3B0aW9ucy5vZmZzZXRZIHx8IDAKICAgICAgICAgICAgfSk7CiAgICAgICAgfQp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2x5cGhzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nbHlwaHNbaV07CiAgICAgICAgICAgICAgICBnLmFnZSArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAoZy5hZ2UgPj0gZy5saWZlKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdseXBocy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IGcuYWdlIC8gZy5tYXhMaWZlOwoKICAgICAgICAgICAgICAgIC8vIEZvbGxvdyB0YXJnZXQKICAgICAgICAgICAgICAgIGlmIChnLmZvbGxvd1RhcmdldCAmJiBnLmZvbGxvd1RhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLmNvcHkoZy5mb2xsb3dUYXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnkgKz0gZy5vZmZzZXRZOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGdyb3VuZCBvcmllbnRlZCwga2VlcCBuZWFyIGZsb29yCiAgICAgICAgICAgICAgICAgICAgaWYgKGcubWVzaC5yb3RhdGlvbi54ID09PSAtTWF0aC5QSS8yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBnLm1lc2gucG9zaXRpb24ueSA9IDAuMSArIGcub2Zmc2V0WTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uCiAgICAgICAgICAgICAgICBnLm1lc2gucm90YXRpb24ueiArPSBnLnJvdGF0aW9uU3BlZWQgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGcuc2NhbGVTcGVlZCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBnLm1lc2guc2NhbGUueCArIGcuc2NhbGVTcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgICAgIGcubWVzaC5zY2FsZS5zZXQocywgcywgcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmFkZQogICAgICAgICAgICAgICAgaWYgKGcuZmFkZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBvcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0IDwgMC4xKSBvcGFjaXR5ID0gdCAvIDAuMTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ID4gMC43KSBvcGFjaXR5ID0gMS4wIC0gKCh0IC0gMC43KSAvIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjbGVhcigpIHsKICAgICAgICAgICAgLy8gSGlkZSBhbGwgYWN0aXZlIGdseXBocyBhbmQgcmVzZXQgbGlzdAogICAgICAgICAgICBmb3IgKGNvbnN0IGcgb2YgdGhpcy5nbHlwaHMpIHsKICAgICAgICAgICAgICAgIGlmIChnLm1lc2gpIGcubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5nbHlwaHMgPSBbXTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguR2x5cGhNYW5hZ2VyID0gR2x5cGhNYW5hZ2VyOwp9KSgpOw==","AudioManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBBdWRpb01hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgICB0aGlzLmJnbSA9IG5ldyBBdWRpbygpOwogICAgICAgICAgICB0aGlzLmJnbS5zcmMgPSAnaHR0cHM6Ly9maWxlcy5jYXRib3gubW9lL3NwMnloeS5tcDMnOwogICAgICAgICAgICB0aGlzLmJnbS5sb29wID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5iZ20udm9sdW1lID0gMC41OwogICAgICAgICAgICB0aGlzLmlzTXV0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5oYXNJbnRlcmFjdGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvdWxkQmVQbGF5aW5nID0gZmFsc2U7IC8vIEludGVudCBmbGFnCgogICAgICAgICAgICAvLyBQcmVsb2FkCiAgICAgICAgICAgIHRoaXMuYmdtLmxvYWQoKTsKCiAgICAgICAgICAgIC8vIC0tLSBIRVJDVUxFQU4gTE9PUCBFTkZPUkNFTUVOVCAtLS0KICAgICAgICAgICAgLy8gMS4gTWFudWFsIExvb3AgUmVkdW5kYW5jeQogICAgICAgICAgICB0aGlzLmJnbS5hZGRFdmVudExpc3RlbmVyKCdlbmRlZCcsICgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJBdWRpb01hbmFnZXI6IEJHTSBlbmRlZCBldmVudCBjYXVnaHQuIEZvcmNpbmcgbWFudWFsIGxvb3AgcmVzZXQuIik7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgIXRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmJnbS5wbGF5KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAgIT09IHVuZGVmaW5lZCkgcC5jYXRjaChlID0+IGNvbnNvbGUud2FybigiTWFudWFsIGxvb3AgcmVwbGF5IGZhaWxlZDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gMi4gUGF1c2UgV2F0Y2hkb2cgKElmIHBhdXNlZCBidXQgc2hvdWxkIGJlIHBsYXlpbmcsIEZPUkNFIFBMQVkpCiAgICAgICAgICAgIHRoaXMuYmdtLmFkZEV2ZW50TGlzdGVuZXIoJ3BhdXNlJywgKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hvdWxkQmVQbGF5aW5nICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTbWFsbCB0aW1lb3V0IHRvIGFsbG93IGludGVudGlvbmFsIG9wZXJhdGlvbnMgdG8gZmluaXNoIGlmIGFueQogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgdGhpcy5iZ20ucGF1c2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiQXVkaW9NYW5hZ2VyOiBVbmV4cGVjdGVkIHBhdXNlIGRldGVjdGVkLiBBdHRlbXB0aW5nIHJlc3VtZS4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBsYXkoKS5jYXRjaChlID0+IGNvbnNvbGUud2FybigiUmVzdW1lIGZhaWxlZDoiLCBlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCAxMDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIDMuIFBlcmlvZGljIFdhdGNoZG9nIChUaGUgIk5ldmVyIFN0b3AiIEd1YXJhbnRlZSkKICAgICAgICAgICAgc2V0SW50ZXJ2YWwoKCkgPT4gdGhpcy5fd2F0Y2hkb2coKSwgMTAwMCk7CiAgICAgICAgfQoKICAgICAgICBfd2F0Y2hkb2coKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNob3VsZEJlUGxheWluZyAmJiAhdGhpcy5pc011dGVkKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5iZ20ucGF1c2VkIHx8IHRoaXMuYmdtLmVuZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkF1ZGlvTWFuYWdlcjogV2F0Y2hkb2cgZm9yY2luZyBwbGF5LiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBsYXkoKS5jYXRjaCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNpbGVudCBjYXRjaCwgbGlrZWx5IHdhaXRpbmcgZm9yIGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBsYXlCR00oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0ZWQpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcGxheVByb21pc2UgPSB0aGlzLmJnbS5wbGF5KCk7CiAgICAgICAgICAgIGlmIChwbGF5UHJvbWlzZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBwbGF5UHJvbWlzZS5jYXRjaChlcnJvciA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkF1ZGlvTWFuYWdlcjogQXV0b3BsYXkgcHJldmVudGVkLiBFbmdhZ2luZyBpbnRlcmFjdGlvbiBsb2NrLiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3dhaXRGb3JJbnRlcmFjdGlvbigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF93YWl0Rm9ySW50ZXJhY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl93YWl0aW5nRm9ySW50ZXJhY3Rpb24pIHJldHVybjsKICAgICAgICAgICAgdGhpcy5fd2FpdGluZ0ZvckludGVyYWN0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IG9uSW50ZXJhY3QgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmhhc0ludGVyYWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBUcnkgdG8gcGxheQogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hvdWxkQmVQbGF5aW5nICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkudGhlbigoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN1Y2Nlc3MhIERldGFjaCBsaXN0ZW5lcnMKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fd2FpdGluZ0ZvckludGVyYWN0aW9uID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlbW92ZUludGVyYWN0aW9uTGlzdGVuZXJzKG9uSW50ZXJhY3QpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiQXVkaW9NYW5hZ2VyOiBBdWRpbyB1bmxvY2tlZCBzdWNjZXNzZnVsbHkuIik7CiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQXVkaW9NYW5hZ2VyOiBJbnRlcmFjdGlvbiBwbGF5IGZhaWxlZC4gS2VlcGluZyBsaXN0ZW5lcnMgYXR0YWNoZWQuIiwgZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERvIE5PVCBkZXRhY2ggbGlzdGVuZXJzLCB3YWl0IGZvciBuZXh0IGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIE5vdCBzdXBwb3NlZCB0byBwbGF5PyBKdXN0IGRldGFjaC4KICAgICAgICAgICAgICAgICAgICB0aGlzLl93YWl0aW5nRm9ySW50ZXJhY3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVJbnRlcmFjdGlvbkxpc3RlbmVycyhvbkludGVyYWN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVzZSBjYXB0dXJlIHRvIGNhdGNoIGl0IGVhcmx5LCBidXQgZG9uJ3QgdXNlICdvbmNlOiB0cnVlJyBzbyB3ZSBjYW4gcmV0cnkgaWYgZmFpbGVkCiAgICAgICAgICAgIGNvbnN0IG9wdHMgPSB7IGNhcHR1cmU6IHRydWUsIHBhc3NpdmU6IHRydWUgfTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBvbkludGVyYWN0LCBvcHRzKTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIG9uSW50ZXJhY3QsIG9wdHMpOwogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgb25JbnRlcmFjdCwgb3B0cyk7CiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIG9uSW50ZXJhY3QsIG9wdHMpOwogICAgICAgIH0KCiAgICAgICAgX3JlbW92ZUludGVyYWN0aW9uTGlzdGVuZXJzKGhhbmRsZXIpIHsKICAgICAgICAgICAgY29uc3Qgb3B0cyA9IHsgY2FwdHVyZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZSB9OwogICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIGhhbmRsZXIsIG9wdHMpOwogICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlciwgb3B0cyk7CiAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBoYW5kbGVyLCBvcHRzKTsKICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgaGFuZGxlciwgb3B0cyk7CiAgICAgICAgfQoKICAgICAgICBzdG9wQkdNKCkgewogICAgICAgICAgICB0aGlzLnNob3VsZEJlUGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmJnbS5wYXVzZSgpOwogICAgICAgICAgICB0aGlzLmJnbS5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgfQoKICAgICAgICBwYXVzZUJHTSgpIHsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICB9CgogICAgICAgIHJlc3VtZUJHTSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUJHTSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXRWb2x1bWUodm9sdW1lKSB7CiAgICAgICAgICAgIHRoaXMuYmdtLnZvbHVtZSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHZvbHVtZSkpOwogICAgICAgIH0KCiAgICAgICAgdG9nZ2xlTXV0ZSgpIHsKICAgICAgICAgICAgdGhpcy5pc011dGVkID0gIXRoaXMuaXNNdXRlZDsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBhdXNlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXlCR00oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5pc011dGVkOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5BdWRpb01hbmFnZXIgPSBBdWRpb01hbmFnZXI7Cn0pKCk7","./AudioManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBBdWRpb01hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgICB0aGlzLmJnbSA9IG5ldyBBdWRpbygpOwogICAgICAgICAgICB0aGlzLmJnbS5zcmMgPSAnaHR0cHM6Ly9maWxlcy5jYXRib3gubW9lL3NwMnloeS5tcDMnOwogICAgICAgICAgICB0aGlzLmJnbS5sb29wID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5iZ20udm9sdW1lID0gMC41OwogICAgICAgICAgICB0aGlzLmlzTXV0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5oYXNJbnRlcmFjdGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvdWxkQmVQbGF5aW5nID0gZmFsc2U7IC8vIEludGVudCBmbGFnCgogICAgICAgICAgICAvLyBQcmVsb2FkCiAgICAgICAgICAgIHRoaXMuYmdtLmxvYWQoKTsKCiAgICAgICAgICAgIC8vIC0tLSBIRVJDVUxFQU4gTE9PUCBFTkZPUkNFTUVOVCAtLS0KICAgICAgICAgICAgLy8gMS4gTWFudWFsIExvb3AgUmVkdW5kYW5jeQogICAgICAgICAgICB0aGlzLmJnbS5hZGRFdmVudExpc3RlbmVyKCdlbmRlZCcsICgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJBdWRpb01hbmFnZXI6IEJHTSBlbmRlZCBldmVudCBjYXVnaHQuIEZvcmNpbmcgbWFudWFsIGxvb3AgcmVzZXQuIik7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgIXRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmJnbS5wbGF5KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAgIT09IHVuZGVmaW5lZCkgcC5jYXRjaChlID0+IGNvbnNvbGUud2FybigiTWFudWFsIGxvb3AgcmVwbGF5IGZhaWxlZDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gMi4gUGF1c2UgV2F0Y2hkb2cgKElmIHBhdXNlZCBidXQgc2hvdWxkIGJlIHBsYXlpbmcsIEZPUkNFIFBMQVkpCiAgICAgICAgICAgIHRoaXMuYmdtLmFkZEV2ZW50TGlzdGVuZXIoJ3BhdXNlJywgKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hvdWxkQmVQbGF5aW5nICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTbWFsbCB0aW1lb3V0IHRvIGFsbG93IGludGVudGlvbmFsIG9wZXJhdGlvbnMgdG8gZmluaXNoIGlmIGFueQogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgdGhpcy5iZ20ucGF1c2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiQXVkaW9NYW5hZ2VyOiBVbmV4cGVjdGVkIHBhdXNlIGRldGVjdGVkLiBBdHRlbXB0aW5nIHJlc3VtZS4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBsYXkoKS5jYXRjaChlID0+IGNvbnNvbGUud2FybigiUmVzdW1lIGZhaWxlZDoiLCBlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCAxMDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIDMuIFBlcmlvZGljIFdhdGNoZG9nIChUaGUgIk5ldmVyIFN0b3AiIEd1YXJhbnRlZSkKICAgICAgICAgICAgc2V0SW50ZXJ2YWwoKCkgPT4gdGhpcy5fd2F0Y2hkb2coKSwgMTAwMCk7CiAgICAgICAgfQoKICAgICAgICBfd2F0Y2hkb2coKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNob3VsZEJlUGxheWluZyAmJiAhdGhpcy5pc011dGVkKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5iZ20ucGF1c2VkIHx8IHRoaXMuYmdtLmVuZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkF1ZGlvTWFuYWdlcjogV2F0Y2hkb2cgZm9yY2luZyBwbGF5LiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBsYXkoKS5jYXRjaCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNpbGVudCBjYXRjaCwgbGlrZWx5IHdhaXRpbmcgZm9yIGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBsYXlCR00oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0ZWQpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcGxheVByb21pc2UgPSB0aGlzLmJnbS5wbGF5KCk7CiAgICAgICAgICAgIGlmIChwbGF5UHJvbWlzZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBwbGF5UHJvbWlzZS5jYXRjaChlcnJvciA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkF1ZGlvTWFuYWdlcjogQXV0b3BsYXkgcHJldmVudGVkLiBFbmdhZ2luZyBpbnRlcmFjdGlvbiBsb2NrLiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3dhaXRGb3JJbnRlcmFjdGlvbigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF93YWl0Rm9ySW50ZXJhY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl93YWl0aW5nRm9ySW50ZXJhY3Rpb24pIHJldHVybjsKICAgICAgICAgICAgdGhpcy5fd2FpdGluZ0ZvckludGVyYWN0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IG9uSW50ZXJhY3QgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmhhc0ludGVyYWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBUcnkgdG8gcGxheQogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hvdWxkQmVQbGF5aW5nICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkudGhlbigoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN1Y2Nlc3MhIERldGFjaCBsaXN0ZW5lcnMKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fd2FpdGluZ0ZvckludGVyYWN0aW9uID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlbW92ZUludGVyYWN0aW9uTGlzdGVuZXJzKG9uSW50ZXJhY3QpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiQXVkaW9NYW5hZ2VyOiBBdWRpbyB1bmxvY2tlZCBzdWNjZXNzZnVsbHkuIik7CiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQXVkaW9NYW5hZ2VyOiBJbnRlcmFjdGlvbiBwbGF5IGZhaWxlZC4gS2VlcGluZyBsaXN0ZW5lcnMgYXR0YWNoZWQuIiwgZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERvIE5PVCBkZXRhY2ggbGlzdGVuZXJzLCB3YWl0IGZvciBuZXh0IGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIE5vdCBzdXBwb3NlZCB0byBwbGF5PyBKdXN0IGRldGFjaC4KICAgICAgICAgICAgICAgICAgICB0aGlzLl93YWl0aW5nRm9ySW50ZXJhY3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVJbnRlcmFjdGlvbkxpc3RlbmVycyhvbkludGVyYWN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVzZSBjYXB0dXJlIHRvIGNhdGNoIGl0IGVhcmx5LCBidXQgZG9uJ3QgdXNlICdvbmNlOiB0cnVlJyBzbyB3ZSBjYW4gcmV0cnkgaWYgZmFpbGVkCiAgICAgICAgICAgIGNvbnN0IG9wdHMgPSB7IGNhcHR1cmU6IHRydWUsIHBhc3NpdmU6IHRydWUgfTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBvbkludGVyYWN0LCBvcHRzKTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIG9uSW50ZXJhY3QsIG9wdHMpOwogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgb25JbnRlcmFjdCwgb3B0cyk7CiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIG9uSW50ZXJhY3QsIG9wdHMpOwogICAgICAgIH0KCiAgICAgICAgX3JlbW92ZUludGVyYWN0aW9uTGlzdGVuZXJzKGhhbmRsZXIpIHsKICAgICAgICAgICAgY29uc3Qgb3B0cyA9IHsgY2FwdHVyZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZSB9OwogICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIGhhbmRsZXIsIG9wdHMpOwogICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlciwgb3B0cyk7CiAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBoYW5kbGVyLCBvcHRzKTsKICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgaGFuZGxlciwgb3B0cyk7CiAgICAgICAgfQoKICAgICAgICBzdG9wQkdNKCkgewogICAgICAgICAgICB0aGlzLnNob3VsZEJlUGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmJnbS5wYXVzZSgpOwogICAgICAgICAgICB0aGlzLmJnbS5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgfQoKICAgICAgICBwYXVzZUJHTSgpIHsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICB9CgogICAgICAgIHJlc3VtZUJHTSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUJHTSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXRWb2x1bWUodm9sdW1lKSB7CiAgICAgICAgICAgIHRoaXMuYmdtLnZvbHVtZSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHZvbHVtZSkpOwogICAgICAgIH0KCiAgICAgICAgdG9nZ2xlTXV0ZSgpIHsKICAgICAgICAgICAgdGhpcy5pc011dGVkID0gIXRoaXMuaXNNdXRlZDsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBhdXNlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXlCR00oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5pc011dGVkOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5BdWRpb01hbmFnZXIgPSBBdWRpb01hbmFnZXI7Cn0pKCk7","/AudioManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBBdWRpb01hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgICB0aGlzLmJnbSA9IG5ldyBBdWRpbygpOwogICAgICAgICAgICB0aGlzLmJnbS5zcmMgPSAnaHR0cHM6Ly9maWxlcy5jYXRib3gubW9lL3NwMnloeS5tcDMnOwogICAgICAgICAgICB0aGlzLmJnbS5sb29wID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5iZ20udm9sdW1lID0gMC41OwogICAgICAgICAgICB0aGlzLmlzTXV0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5oYXNJbnRlcmFjdGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvdWxkQmVQbGF5aW5nID0gZmFsc2U7IC8vIEludGVudCBmbGFnCgogICAgICAgICAgICAvLyBQcmVsb2FkCiAgICAgICAgICAgIHRoaXMuYmdtLmxvYWQoKTsKCiAgICAgICAgICAgIC8vIC0tLSBIRVJDVUxFQU4gTE9PUCBFTkZPUkNFTUVOVCAtLS0KICAgICAgICAgICAgLy8gMS4gTWFudWFsIExvb3AgUmVkdW5kYW5jeQogICAgICAgICAgICB0aGlzLmJnbS5hZGRFdmVudExpc3RlbmVyKCdlbmRlZCcsICgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJBdWRpb01hbmFnZXI6IEJHTSBlbmRlZCBldmVudCBjYXVnaHQuIEZvcmNpbmcgbWFudWFsIGxvb3AgcmVzZXQuIik7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgIXRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmJnbS5wbGF5KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAgIT09IHVuZGVmaW5lZCkgcC5jYXRjaChlID0+IGNvbnNvbGUud2FybigiTWFudWFsIGxvb3AgcmVwbGF5IGZhaWxlZDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gMi4gUGF1c2UgV2F0Y2hkb2cgKElmIHBhdXNlZCBidXQgc2hvdWxkIGJlIHBsYXlpbmcsIEZPUkNFIFBMQVkpCiAgICAgICAgICAgIHRoaXMuYmdtLmFkZEV2ZW50TGlzdGVuZXIoJ3BhdXNlJywgKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hvdWxkQmVQbGF5aW5nICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTbWFsbCB0aW1lb3V0IHRvIGFsbG93IGludGVudGlvbmFsIG9wZXJhdGlvbnMgdG8gZmluaXNoIGlmIGFueQogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgdGhpcy5iZ20ucGF1c2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiQXVkaW9NYW5hZ2VyOiBVbmV4cGVjdGVkIHBhdXNlIGRldGVjdGVkLiBBdHRlbXB0aW5nIHJlc3VtZS4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBsYXkoKS5jYXRjaChlID0+IGNvbnNvbGUud2FybigiUmVzdW1lIGZhaWxlZDoiLCBlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCAxMDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIDMuIFBlcmlvZGljIFdhdGNoZG9nIChUaGUgIk5ldmVyIFN0b3AiIEd1YXJhbnRlZSkKICAgICAgICAgICAgc2V0SW50ZXJ2YWwoKCkgPT4gdGhpcy5fd2F0Y2hkb2coKSwgMTAwMCk7CiAgICAgICAgfQoKICAgICAgICBfd2F0Y2hkb2coKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNob3VsZEJlUGxheWluZyAmJiAhdGhpcy5pc011dGVkKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5iZ20ucGF1c2VkIHx8IHRoaXMuYmdtLmVuZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkF1ZGlvTWFuYWdlcjogV2F0Y2hkb2cgZm9yY2luZyBwbGF5LiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBsYXkoKS5jYXRjaCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNpbGVudCBjYXRjaCwgbGlrZWx5IHdhaXRpbmcgZm9yIGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBsYXlCR00oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0ZWQpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgcGxheVByb21pc2UgPSB0aGlzLmJnbS5wbGF5KCk7CiAgICAgICAgICAgIGlmIChwbGF5UHJvbWlzZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBwbGF5UHJvbWlzZS5jYXRjaChlcnJvciA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkF1ZGlvTWFuYWdlcjogQXV0b3BsYXkgcHJldmVudGVkLiBFbmdhZ2luZyBpbnRlcmFjdGlvbiBsb2NrLiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3dhaXRGb3JJbnRlcmFjdGlvbigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF93YWl0Rm9ySW50ZXJhY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl93YWl0aW5nRm9ySW50ZXJhY3Rpb24pIHJldHVybjsKICAgICAgICAgICAgdGhpcy5fd2FpdGluZ0ZvckludGVyYWN0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IG9uSW50ZXJhY3QgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmhhc0ludGVyYWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBUcnkgdG8gcGxheQogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hvdWxkQmVQbGF5aW5nICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkudGhlbigoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN1Y2Nlc3MhIERldGFjaCBsaXN0ZW5lcnMKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fd2FpdGluZ0ZvckludGVyYWN0aW9uID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlbW92ZUludGVyYWN0aW9uTGlzdGVuZXJzKG9uSW50ZXJhY3QpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiQXVkaW9NYW5hZ2VyOiBBdWRpbyB1bmxvY2tlZCBzdWNjZXNzZnVsbHkuIik7CiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQXVkaW9NYW5hZ2VyOiBJbnRlcmFjdGlvbiBwbGF5IGZhaWxlZC4gS2VlcGluZyBsaXN0ZW5lcnMgYXR0YWNoZWQuIiwgZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERvIE5PVCBkZXRhY2ggbGlzdGVuZXJzLCB3YWl0IGZvciBuZXh0IGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIE5vdCBzdXBwb3NlZCB0byBwbGF5PyBKdXN0IGRldGFjaC4KICAgICAgICAgICAgICAgICAgICB0aGlzLl93YWl0aW5nRm9ySW50ZXJhY3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVJbnRlcmFjdGlvbkxpc3RlbmVycyhvbkludGVyYWN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVzZSBjYXB0dXJlIHRvIGNhdGNoIGl0IGVhcmx5LCBidXQgZG9uJ3QgdXNlICdvbmNlOiB0cnVlJyBzbyB3ZSBjYW4gcmV0cnkgaWYgZmFpbGVkCiAgICAgICAgICAgIGNvbnN0IG9wdHMgPSB7IGNhcHR1cmU6IHRydWUsIHBhc3NpdmU6IHRydWUgfTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBvbkludGVyYWN0LCBvcHRzKTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIG9uSW50ZXJhY3QsIG9wdHMpOwogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgb25JbnRlcmFjdCwgb3B0cyk7CiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIG9uSW50ZXJhY3QsIG9wdHMpOwogICAgICAgIH0KCiAgICAgICAgX3JlbW92ZUludGVyYWN0aW9uTGlzdGVuZXJzKGhhbmRsZXIpIHsKICAgICAgICAgICAgY29uc3Qgb3B0cyA9IHsgY2FwdHVyZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZSB9OwogICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIGhhbmRsZXIsIG9wdHMpOwogICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlciwgb3B0cyk7CiAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBoYW5kbGVyLCBvcHRzKTsKICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgaGFuZGxlciwgb3B0cyk7CiAgICAgICAgfQoKICAgICAgICBzdG9wQkdNKCkgewogICAgICAgICAgICB0aGlzLnNob3VsZEJlUGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmJnbS5wYXVzZSgpOwogICAgICAgICAgICB0aGlzLmJnbS5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgfQoKICAgICAgICBwYXVzZUJHTSgpIHsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICB9CgogICAgICAgIHJlc3VtZUJHTSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUJHTSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXRWb2x1bWUodm9sdW1lKSB7CiAgICAgICAgICAgIHRoaXMuYmdtLnZvbHVtZSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHZvbHVtZSkpOwogICAgICAgIH0KCiAgICAgICAgdG9nZ2xlTXV0ZSgpIHsKICAgICAgICAgICAgdGhpcy5pc011dGVkID0gIXRoaXMuaXNNdXRlZDsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBhdXNlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXlCR00oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5pc011dGVkOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5BdWRpb01hbmFnZXIgPSBBdWRpb01hbmFnZXI7Cn0pKCk7","LightShafts.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBMaWdodFNoYWZ0cyB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgIHROb2lzZTogeyB2YWx1ZTogbnVsbCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9pbml0KCk7CiAgICAgICAgfQoKX2luaXQoKSB7CiAgICAgICAgICAgIC8vIEdlb21ldHJ5OiBBIGNsdXN0ZXIgb2YgY29uZXMvY3lsaW5kZXJzCiAgICAgICAgICAgIC8vIFdlIHVzZSBhIHNpbmdsZSBnZW9tZXRyeSB3aXRoIGluc3RhbmNpbmcgb3IgbWVyZ2VkIGdlb21ldHJ5IGZvciBwZXJmb3JtYW5jZSwKICAgICAgICAgICAgLy8gYnV0IGZvciBzaW1wbGljaXR5IGFuZCBhZXN0aGV0aWMgY29udHJvbCwgbGV0J3MgdXNlIGEgZmV3IGxhcmdlIHBsYW5lcyBvciBhIGN5bGluZGVyLgogICAgICAgICAgICAvLyBBIGxhcmdlIGN5bGluZGVyIHdpdGggb3BlbiBlbmRzIHdvcmtzIHdlbGwgZm9yIGEgInBvb2wiIHNoYWZ0IGVmZmVjdC4KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluY3JlYXNlZCBsZW5ndGggdG8gOTAgdG8gYWNjb21tb2RhdGUgdGlsdCB3aXRob3V0IGNsaXBwaW5nIHRvcC9ib3R0b20KICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgzMCwgMjAsIDkwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaGFkZXIKICAgICAgICAgICAgY29uc3QgdmVydCA9IGAKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdlBvczsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2UG9zID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3NpdGlvbiwgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIGNvbnN0IGZyYWcgPSBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdE5vaXNlOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2UG9zOwoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBmYWRlIChTb2Z0IHRvcCBhbmQgYm90dG9tKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gc21vb3Roc3RlcCgwLjAsIDAuMywgdlV2LnkpICogc21vb3Roc3RlcCgxLjAsIDAuNiwgdlV2LnkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTY3JvbGxpbmcgUmF5cwogICAgICAgICAgICAgICAgICAgIC8vIExheWVyIDE6IFNsb3csIGJyb2FkIHJheXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBuMSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZlYzIodlV2LnggKiAyLjAgKyB1VGltZSAqIDAuMDIsIHZVdi55ICogMC41IC0gdVRpbWUgKiAwLjA1KSkucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMYXllciAyOiBGYXN0LCBpbnRlcmZlcmVuY2UgcmF5cwogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4yID0gdGV4dHVyZTJEKHROb2lzZSwgdmVjMih2VXYueCAqIDMuMCAtIHVUaW1lICogMC4wMywgdlV2LnkgKiAwLjUgLSB1VGltZSAqIDAuMSkpLnI7CgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheXMgPSBuMSAqIG4yOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IGludGVuc2l0eSBzaWduaWZpY2FudGx5IChSZW1vdmVkIHBvdyB0byBwcmV2ZW50IGNydXNoaW5nKQogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogMy4wOyAKCiAgICAgICAgICAgICAgICAgICAgLy8gR2xpc3RlbmluZyBTcGFya2xlcyAoSGlnaCBmcmVxdWVuY3kgbm9pc2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BhcmtsZSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZVdiAqIHZlYzIoOC4wLCAyLjApICsgdmVjMih1VGltZSAqIDAuMSwgdVRpbWUgKiAwLjMpKS5yOwogICAgICAgICAgICAgICAgICAgIHNwYXJrbGUgPSBwb3coc3BhcmtsZSwgNS4wKSAqIDEwLjA7IC8vIFNoYXJwIHBvaW50cwoKICAgICAgICAgICAgICAgICAgICAvLyBDb2xvcjogQ3lhbi9CbHVlL1doaXRlIChCcmlnaHRlciBiYXNlKQogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKDAuNiwgMC45LCAxLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENvbWJpbmUgKEhpZ2hlciBtdWx0aXBsaWVycykKICAgICAgICAgICAgICAgICAgICBmbG9hdCBmaW5hbEFscGhhID0gKHJheXMgKiAwLjggKyBzcGFya2xlICogMC40KSAqIGFscGhhOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIERpc3RhbmNlIGZhZGUgKG9wdGlvbmFsLCBoYW5kbGVkIGJ5IGZvZyB1c3VhbGx5IGJ1dCB3ZSB3YW50IGFkZGl0aXZlKQogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGZpbmFsQWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHRoaXMudW5pZm9ybXMsCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IHZlcnQsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogZnJhZywKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBDb250YWluZXIgZm9yIHRoZSBhbmdsZSAoUmVhbGlzdGljIExpZ2h0IFNvdXJjZSkKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgLy8gQW5nbGU6IENvbWluZyBmcm9tIHRvcC1sZWZ0IChzaW11bGF0aW5nIHN1cmZhY2Ugc3VuIHBlbmV0cmF0aW5nIGRlZXAgd2F0ZXIpCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJvdGF0aW9uLnogPSBNYXRoLlBJIC8gNTsgLy8gfjM2IGRlZ3JlZXMgdGlsdAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDEwOyAvLyB+MTggZGVncmVlcyBmb3J3YXJkCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnBvc2l0aW9uLnNldCgxMiwgOCwgMCk7IC8vIE9mZnNldCBzb3VyY2UgdG8gaGl0IGFyZW5hIGNlbnRlcgogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNvbnRhaW5lcik7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSAxMDA7IAogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5tZXNoKTsKCiAgICAgICAgICAgIC8vIEFkZCBhIHNlY29uZCBsYXllciBmb3IgY29yZSBpbnRlbnNpdHkKICAgICAgICAgICAgY29uc3QgY29yZUdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEyLCA4LCA5MCwgMTYsIDEsIHRydWUpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoID0gbmV3IFRIUkVFLk1lc2goY29yZUdlbywgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoLnJlbmRlck9yZGVyID0gMTAwOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jb3JlTWVzaCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExhenkgbG9hZCB0ZXh0dXJlCiAgICAgICAgICAgIGlmICghdGhpcy51bmlmb3Jtcy50Tm9pc2UudmFsdWUgJiYgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnROb2lzZS52YWx1ZSA9IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZTsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3cmFwcGluZyBpcyBjb3JyZWN0IGZvciB0aGUgY3lsaW5kZXIgVVZzCiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZS53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbG93bHkgcm90YXRlIHNoYWZ0cyBmb3IgZHluYW1pYyBmZWVsCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC5yb3RhdGlvbi55ICs9IGR0ICogMC4wMjsKICAgICAgICAgICAgaWYgKHRoaXMuY29yZU1lc2gpIHRoaXMuY29yZU1lc2gucm90YXRpb24ueSAtPSBkdCAqIDAuMDM7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkxpZ2h0U2hhZnRzID0gTGlnaHRTaGFmdHM7Cn0pKCk7","./LightShafts.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBMaWdodFNoYWZ0cyB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgIHROb2lzZTogeyB2YWx1ZTogbnVsbCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9pbml0KCk7CiAgICAgICAgfQoKX2luaXQoKSB7CiAgICAgICAgICAgIC8vIEdlb21ldHJ5OiBBIGNsdXN0ZXIgb2YgY29uZXMvY3lsaW5kZXJzCiAgICAgICAgICAgIC8vIFdlIHVzZSBhIHNpbmdsZSBnZW9tZXRyeSB3aXRoIGluc3RhbmNpbmcgb3IgbWVyZ2VkIGdlb21ldHJ5IGZvciBwZXJmb3JtYW5jZSwKICAgICAgICAgICAgLy8gYnV0IGZvciBzaW1wbGljaXR5IGFuZCBhZXN0aGV0aWMgY29udHJvbCwgbGV0J3MgdXNlIGEgZmV3IGxhcmdlIHBsYW5lcyBvciBhIGN5bGluZGVyLgogICAgICAgICAgICAvLyBBIGxhcmdlIGN5bGluZGVyIHdpdGggb3BlbiBlbmRzIHdvcmtzIHdlbGwgZm9yIGEgInBvb2wiIHNoYWZ0IGVmZmVjdC4KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluY3JlYXNlZCBsZW5ndGggdG8gOTAgdG8gYWNjb21tb2RhdGUgdGlsdCB3aXRob3V0IGNsaXBwaW5nIHRvcC9ib3R0b20KICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgzMCwgMjAsIDkwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaGFkZXIKICAgICAgICAgICAgY29uc3QgdmVydCA9IGAKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdlBvczsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2UG9zID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3NpdGlvbiwgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIGNvbnN0IGZyYWcgPSBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdE5vaXNlOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2UG9zOwoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBmYWRlIChTb2Z0IHRvcCBhbmQgYm90dG9tKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gc21vb3Roc3RlcCgwLjAsIDAuMywgdlV2LnkpICogc21vb3Roc3RlcCgxLjAsIDAuNiwgdlV2LnkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTY3JvbGxpbmcgUmF5cwogICAgICAgICAgICAgICAgICAgIC8vIExheWVyIDE6IFNsb3csIGJyb2FkIHJheXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBuMSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZlYzIodlV2LnggKiAyLjAgKyB1VGltZSAqIDAuMDIsIHZVdi55ICogMC41IC0gdVRpbWUgKiAwLjA1KSkucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMYXllciAyOiBGYXN0LCBpbnRlcmZlcmVuY2UgcmF5cwogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4yID0gdGV4dHVyZTJEKHROb2lzZSwgdmVjMih2VXYueCAqIDMuMCAtIHVUaW1lICogMC4wMywgdlV2LnkgKiAwLjUgLSB1VGltZSAqIDAuMSkpLnI7CgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheXMgPSBuMSAqIG4yOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IGludGVuc2l0eSBzaWduaWZpY2FudGx5IChSZW1vdmVkIHBvdyB0byBwcmV2ZW50IGNydXNoaW5nKQogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogMy4wOyAKCiAgICAgICAgICAgICAgICAgICAgLy8gR2xpc3RlbmluZyBTcGFya2xlcyAoSGlnaCBmcmVxdWVuY3kgbm9pc2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BhcmtsZSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZVdiAqIHZlYzIoOC4wLCAyLjApICsgdmVjMih1VGltZSAqIDAuMSwgdVRpbWUgKiAwLjMpKS5yOwogICAgICAgICAgICAgICAgICAgIHNwYXJrbGUgPSBwb3coc3BhcmtsZSwgNS4wKSAqIDEwLjA7IC8vIFNoYXJwIHBvaW50cwoKICAgICAgICAgICAgICAgICAgICAvLyBDb2xvcjogQ3lhbi9CbHVlL1doaXRlIChCcmlnaHRlciBiYXNlKQogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKDAuNiwgMC45LCAxLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENvbWJpbmUgKEhpZ2hlciBtdWx0aXBsaWVycykKICAgICAgICAgICAgICAgICAgICBmbG9hdCBmaW5hbEFscGhhID0gKHJheXMgKiAwLjggKyBzcGFya2xlICogMC40KSAqIGFscGhhOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIERpc3RhbmNlIGZhZGUgKG9wdGlvbmFsLCBoYW5kbGVkIGJ5IGZvZyB1c3VhbGx5IGJ1dCB3ZSB3YW50IGFkZGl0aXZlKQogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGZpbmFsQWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHRoaXMudW5pZm9ybXMsCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IHZlcnQsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogZnJhZywKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBDb250YWluZXIgZm9yIHRoZSBhbmdsZSAoUmVhbGlzdGljIExpZ2h0IFNvdXJjZSkKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgLy8gQW5nbGU6IENvbWluZyBmcm9tIHRvcC1sZWZ0IChzaW11bGF0aW5nIHN1cmZhY2Ugc3VuIHBlbmV0cmF0aW5nIGRlZXAgd2F0ZXIpCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJvdGF0aW9uLnogPSBNYXRoLlBJIC8gNTsgLy8gfjM2IGRlZ3JlZXMgdGlsdAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDEwOyAvLyB+MTggZGVncmVlcyBmb3J3YXJkCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnBvc2l0aW9uLnNldCgxMiwgOCwgMCk7IC8vIE9mZnNldCBzb3VyY2UgdG8gaGl0IGFyZW5hIGNlbnRlcgogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNvbnRhaW5lcik7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSAxMDA7IAogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5tZXNoKTsKCiAgICAgICAgICAgIC8vIEFkZCBhIHNlY29uZCBsYXllciBmb3IgY29yZSBpbnRlbnNpdHkKICAgICAgICAgICAgY29uc3QgY29yZUdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEyLCA4LCA5MCwgMTYsIDEsIHRydWUpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoID0gbmV3IFRIUkVFLk1lc2goY29yZUdlbywgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoLnJlbmRlck9yZGVyID0gMTAwOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jb3JlTWVzaCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExhenkgbG9hZCB0ZXh0dXJlCiAgICAgICAgICAgIGlmICghdGhpcy51bmlmb3Jtcy50Tm9pc2UudmFsdWUgJiYgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnROb2lzZS52YWx1ZSA9IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZTsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3cmFwcGluZyBpcyBjb3JyZWN0IGZvciB0aGUgY3lsaW5kZXIgVVZzCiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZS53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbG93bHkgcm90YXRlIHNoYWZ0cyBmb3IgZHluYW1pYyBmZWVsCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC5yb3RhdGlvbi55ICs9IGR0ICogMC4wMjsKICAgICAgICAgICAgaWYgKHRoaXMuY29yZU1lc2gpIHRoaXMuY29yZU1lc2gucm90YXRpb24ueSAtPSBkdCAqIDAuMDM7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkxpZ2h0U2hhZnRzID0gTGlnaHRTaGFmdHM7Cn0pKCk7","/LightShafts.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBMaWdodFNoYWZ0cyB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgIHROb2lzZTogeyB2YWx1ZTogbnVsbCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9pbml0KCk7CiAgICAgICAgfQoKX2luaXQoKSB7CiAgICAgICAgICAgIC8vIEdlb21ldHJ5OiBBIGNsdXN0ZXIgb2YgY29uZXMvY3lsaW5kZXJzCiAgICAgICAgICAgIC8vIFdlIHVzZSBhIHNpbmdsZSBnZW9tZXRyeSB3aXRoIGluc3RhbmNpbmcgb3IgbWVyZ2VkIGdlb21ldHJ5IGZvciBwZXJmb3JtYW5jZSwKICAgICAgICAgICAgLy8gYnV0IGZvciBzaW1wbGljaXR5IGFuZCBhZXN0aGV0aWMgY29udHJvbCwgbGV0J3MgdXNlIGEgZmV3IGxhcmdlIHBsYW5lcyBvciBhIGN5bGluZGVyLgogICAgICAgICAgICAvLyBBIGxhcmdlIGN5bGluZGVyIHdpdGggb3BlbiBlbmRzIHdvcmtzIHdlbGwgZm9yIGEgInBvb2wiIHNoYWZ0IGVmZmVjdC4KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluY3JlYXNlZCBsZW5ndGggdG8gOTAgdG8gYWNjb21tb2RhdGUgdGlsdCB3aXRob3V0IGNsaXBwaW5nIHRvcC9ib3R0b20KICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgzMCwgMjAsIDkwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaGFkZXIKICAgICAgICAgICAgY29uc3QgdmVydCA9IGAKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdlBvczsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2UG9zID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3NpdGlvbiwgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIGNvbnN0IGZyYWcgPSBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdE5vaXNlOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2UG9zOwoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBmYWRlIChTb2Z0IHRvcCBhbmQgYm90dG9tKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gc21vb3Roc3RlcCgwLjAsIDAuMywgdlV2LnkpICogc21vb3Roc3RlcCgxLjAsIDAuNiwgdlV2LnkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTY3JvbGxpbmcgUmF5cwogICAgICAgICAgICAgICAgICAgIC8vIExheWVyIDE6IFNsb3csIGJyb2FkIHJheXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBuMSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZlYzIodlV2LnggKiAyLjAgKyB1VGltZSAqIDAuMDIsIHZVdi55ICogMC41IC0gdVRpbWUgKiAwLjA1KSkucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMYXllciAyOiBGYXN0LCBpbnRlcmZlcmVuY2UgcmF5cwogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4yID0gdGV4dHVyZTJEKHROb2lzZSwgdmVjMih2VXYueCAqIDMuMCAtIHVUaW1lICogMC4wMywgdlV2LnkgKiAwLjUgLSB1VGltZSAqIDAuMSkpLnI7CgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheXMgPSBuMSAqIG4yOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IGludGVuc2l0eSBzaWduaWZpY2FudGx5IChSZW1vdmVkIHBvdyB0byBwcmV2ZW50IGNydXNoaW5nKQogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogMy4wOyAKCiAgICAgICAgICAgICAgICAgICAgLy8gR2xpc3RlbmluZyBTcGFya2xlcyAoSGlnaCBmcmVxdWVuY3kgbm9pc2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BhcmtsZSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZVdiAqIHZlYzIoOC4wLCAyLjApICsgdmVjMih1VGltZSAqIDAuMSwgdVRpbWUgKiAwLjMpKS5yOwogICAgICAgICAgICAgICAgICAgIHNwYXJrbGUgPSBwb3coc3BhcmtsZSwgNS4wKSAqIDEwLjA7IC8vIFNoYXJwIHBvaW50cwoKICAgICAgICAgICAgICAgICAgICAvLyBDb2xvcjogQ3lhbi9CbHVlL1doaXRlIChCcmlnaHRlciBiYXNlKQogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKDAuNiwgMC45LCAxLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENvbWJpbmUgKEhpZ2hlciBtdWx0aXBsaWVycykKICAgICAgICAgICAgICAgICAgICBmbG9hdCBmaW5hbEFscGhhID0gKHJheXMgKiAwLjggKyBzcGFya2xlICogMC40KSAqIGFscGhhOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIERpc3RhbmNlIGZhZGUgKG9wdGlvbmFsLCBoYW5kbGVkIGJ5IGZvZyB1c3VhbGx5IGJ1dCB3ZSB3YW50IGFkZGl0aXZlKQogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGZpbmFsQWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHRoaXMudW5pZm9ybXMsCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IHZlcnQsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogZnJhZywKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBDb250YWluZXIgZm9yIHRoZSBhbmdsZSAoUmVhbGlzdGljIExpZ2h0IFNvdXJjZSkKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgLy8gQW5nbGU6IENvbWluZyBmcm9tIHRvcC1sZWZ0IChzaW11bGF0aW5nIHN1cmZhY2Ugc3VuIHBlbmV0cmF0aW5nIGRlZXAgd2F0ZXIpCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJvdGF0aW9uLnogPSBNYXRoLlBJIC8gNTsgLy8gfjM2IGRlZ3JlZXMgdGlsdAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDEwOyAvLyB+MTggZGVncmVlcyBmb3J3YXJkCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnBvc2l0aW9uLnNldCgxMiwgOCwgMCk7IC8vIE9mZnNldCBzb3VyY2UgdG8gaGl0IGFyZW5hIGNlbnRlcgogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNvbnRhaW5lcik7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSAxMDA7IAogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5tZXNoKTsKCiAgICAgICAgICAgIC8vIEFkZCBhIHNlY29uZCBsYXllciBmb3IgY29yZSBpbnRlbnNpdHkKICAgICAgICAgICAgY29uc3QgY29yZUdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEyLCA4LCA5MCwgMTYsIDEsIHRydWUpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoID0gbmV3IFRIUkVFLk1lc2goY29yZUdlbywgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoLnJlbmRlck9yZGVyID0gMTAwOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jb3JlTWVzaCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExhenkgbG9hZCB0ZXh0dXJlCiAgICAgICAgICAgIGlmICghdGhpcy51bmlmb3Jtcy50Tm9pc2UudmFsdWUgJiYgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnROb2lzZS52YWx1ZSA9IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZTsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3cmFwcGluZyBpcyBjb3JyZWN0IGZvciB0aGUgY3lsaW5kZXIgVVZzCiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZS53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbG93bHkgcm90YXRlIHNoYWZ0cyBmb3IgZHluYW1pYyBmZWVsCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC5yb3RhdGlvbi55ICs9IGR0ICogMC4wMjsKICAgICAgICAgICAgaWYgKHRoaXMuY29yZU1lc2gpIHRoaXMuY29yZU1lc2gucm90YXRpb24ueSAtPSBkdCAqIDAuMDM7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkxpZ2h0U2hhZnRzID0gTGlnaHRTaGFmdHM7Cn0pKCk7","Stadium.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFJldXNhYmxlIEdsb3cgZm9yIExpZ2h0cwogICAgY29uc3QgX2dsb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAzMik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjQsICdyZ2JhKDAsIDE3MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgNjQsIDY0KTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIGNvbnN0IF9nbG93TWF0ZXJpYWwgPSBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyAKICAgICAgICBtYXA6IF9nbG93VGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBTdGFkaXVtIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuY29udGFpbmVyKTsKCiAgICAgICAgICAgIC8vIENvbmZpZyBmb3IgIkhlcmN1bGVhbiIgc2NhbGUKLy8gQ29uZmlnIGZvciAiSGVyY3VsZWFuIiBzY2FsZQogICAgICAgICAgICB0aGlzLmNvbmZpZyA9IHsKICAgICAgICAgICAgICAgIHJhZGl1czogNjAsICAgICAgIC8vIFN0YXJ0IG91dHNpZGUgdGhlIGFyZW5hICg0OCByYWRpdXMpCiAgICAgICAgICAgICAgICB0aWVyczogNiwgICAgICAgICAvLyBOdW1iZXIgb2Ygc2VhdGluZyByaW5ncwogICAgICAgICAgICAgICAgdGllckhlaWdodDogMTIsCiAgICAgICAgICAgICAgICB0aWVyRGVwdGg6IDE1LAogICAgICAgICAgICAgICAgY3Jvd2RDb3VudDogODAwMCwgLy8gSW5jcmVhc2VkIGRlbnNpdHkKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDA4MGMxMCwgLy8gRGVlcCBkYXJrIGJsdWUvYmxhY2sKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4MDBhYWZmCiAgICAgICAgICAgIH07Cgp0aGlzLnJpbmdzID0gW107CiAgICAgICAgICAgIHRoaXMubGlnaHRTcHJpdGVzID0gW107IC8vIFN0b3JlIGxpZ2h0IHNwcml0ZXMgZm9yIGNpbmVtYXRpYyBjb250cm9sCiAgICAgICAgICAgIHRoaXMuY3Jvd2QgPSBudWxsOwogICAgICAgICAgICB0aGlzLmNyb3dkID0gbnVsbDsKCnRoaXMuX2J1aWxkQXJjaGl0ZWN0dXJlKCk7CiAgICAgICAgICAgIHRoaXMuX2J1aWxkQ3Jvd2QoKTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRIZXJjdWxlYW5SaW5ncygpOwogICAgICAgICAgICB0aGlzLl9idWlsZFN0YWRpdW1MaWdodHMoKTsKICAgICAgICB9CgogICAgICAgIF9idWlsZEFyY2hpdGVjdHVyZSgpIHsKICAgICAgICAgICAgLy8gMS4gVGhlIFZvaWQgQm93bCAoQmFja2dyb3VuZCBPY2NsdWRlcikKICAgICAgICAgICAgLy8gTWFzc2l2ZSBjeWxpbmRlciB0byBibG9jayB0aGUgdm9pZAogICAgICAgICAgICBjb25zdCBib3dsR2VvID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoMTgwLCA1MCwgMTIwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIGNvbnN0IGJvd2xNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgIGNvbG9yOiB0aGlzLmNvbmZpZy5zdHJ1Y3R1cmVDb2xvciwgCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgICAgIGZvZzogdHJ1ZSAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IGJvd2wgPSBuZXcgVEhSRUUuTWVzaChib3dsR2VvLCBib3dsTWF0KTsKICAgICAgICAgICAgYm93bC5wb3NpdGlvbi55ID0gMjA7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChib3dsKTsKCiAgICAgICAgICAgIC8vIDIuIFNlYXRpbmcgVGllcnMgKENvbmNlbnRyaWMgUmluZ3MpCiAgICAgICAgICAgIGNvbnN0IHRpZXJNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgxMTFhMjIsIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUgfSk7CiAgICAgICAgICAgIGNvbnN0IHJpbU1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwNDQ2NiB9KTsKCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMuY29uZmlnLnRpZXJzOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAoaSAqIHRoaXMuY29uZmlnLnRpZXJIZWlnaHQpIC0gMzA7CiAgICAgICAgICAgICAgICBjb25zdCBySW5uZXIgPSB0aGlzLmNvbmZpZy5yYWRpdXMgKyAoaSAqICh0aGlzLmNvbmZpZy50aWVyRGVwdGggKiAwLjgpKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJPdXRlciA9IHJJbm5lciArIHRoaXMuY29uZmlnLnRpZXJEZXB0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmxvb3IgUmluZwogICAgICAgICAgICAgICAgY29uc3QgcmluZ0dlbyA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkocklubmVyLCByT3V0ZXIsIDY0KTsKICAgICAgICAgICAgICAgIHJpbmdHZW8ucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKHJpbmdHZW8sIHRpZXJNYXQpOwogICAgICAgICAgICAgICAgbWVzaC5wb3NpdGlvbi55ID0geTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gR2xvd2luZyBSaW0gKFRoZSAiVGVjaCIgZmVlbCkKICAgICAgICAgICAgICAgIGNvbnN0IHJpbUdlbyA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KHJJbm5lciwgMC44LCA0LCA2NCk7CiAgICAgICAgICAgICAgICByaW1HZW8ucm90YXRlWChNYXRoLlBJIC8gMik7CiAgICAgICAgICAgICAgICBjb25zdCByaW0gPSBuZXcgVEhSRUUuTWVzaChyaW1HZW8sIHJpbU1hdCk7CiAgICAgICAgICAgICAgICByaW0ucG9zaXRpb24ueSA9IHk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQocmltKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gTWFzc2l2ZSBQaWxsYXJzIChUaGUgIkhlcmN1bGVhbiIgU3VwcG9ydCkKICAgICAgICAgICAgY29uc3QgcGlsbGFyR2VvID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KDgsIDIwMCwgOCk7CiAgICAgICAgICAgIGNvbnN0IHBpbGxhck1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDA1MDUwNSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTQwOyAvLyBGYXIgb3V0CiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gocGlsbGFyR2VvLCBwaWxsYXJNYXQpOwogICAgICAgICAgICAgICAgbWVzaC5wb3NpdGlvbi5zZXQoTWF0aC5jb3MoYW5nbGUpKnIsIDAsIE1hdGguc2luKGFuZ2xlKSpyKTsKICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KDAsMCwwKTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9idWlsZENyb3dkKCkgewogICAgICAgICAgICAvLyBJbnN0YW5jZWQgTWVzaCBmb3IgQ3Jvd2QgKExvdyBQb2x5LCBIaWdoIENvdW50KQogICAgICAgICAgICAvLyBVc2luZyBhIHNpbXBsZSB2ZXJ0aWNhbCBwbGFuZSB0aGF0IGZhY2VzIGNlbnRlcgogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjIsIDIuNSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAtLS0gQ1JPV0QgU0hBREVSIElNUExFTUVOVEFUSU9OIC0tLQogICAgICAgICAgICAvLyBBZGQgaW5zdGFuY2Utc3BlY2lmaWMgcmFuZG9tIG9mZnNldCBmb3IgYW5pbWF0aW9uIHZhcmlhdGlvbgogICAgICAgICAgICBjb25zdCBvZmZzZXRzID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLmNvbmZpZy5jcm93ZENvdW50KTsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5jb25maWcuY3Jvd2RDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBvZmZzZXRzW2ldID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdhT2Zmc2V0JywgbmV3IFRIUkVFLkluc3RhbmNlZEJ1ZmZlckF0dHJpYnV0ZShvZmZzZXRzLCAxKSk7CgogICAgICAgICAgICAvLyBDdXN0b20gU2hhZGVyIHZpYSBvbkJlZm9yZUNvbXBpbGUKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgc2lkZTogVEhSRUUuRG91YmxlU2lkZSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIG1hdC5vbkJlZm9yZUNvbXBpbGUgPSAoc2hhZGVyKSA9PiB7CiAgICAgICAgICAgICAgICBzaGFkZXIudW5pZm9ybXMudVRpbWUgPSB7IHZhbHVlOiAwIH07CiAgICAgICAgICAgICAgICB0aGlzLmNyb3dkVW5pZm9ybXMgPSBzaGFkZXIudW5pZm9ybXM7CgogICAgICAgICAgICAgICAgc2hhZGVyLnZlcnRleFNoYWRlciA9IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBhT2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkp1bXA7IC8vIFBhc3MgdG8gZnJhZ21lbnQgZm9yIGNvbG9yIHZhcmlhdGlvbgogICAgICAgICAgICAgICAgYCArIHNoYWRlci52ZXJ0ZXhTaGFkZXI7CgogICAgICAgICAgICAgICAgc2hhZGVyLnZlcnRleFNoYWRlciA9IHNoYWRlci52ZXJ0ZXhTaGFkZXIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAnI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4nLAogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICAgICAjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEFuaW1hdGlvbiBMb2dpYwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNwZWVkID0gOC4wOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSB1VGltZSAqIHNwZWVkICsgKGFPZmZzZXQgKiAxMDAuMCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSnVtcCAoU2luZSB3YXZlIGNsaXBwZWQpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQganVtcCA9IG1heCgwLjAsIHNpbih0KSk7CiAgICAgICAgICAgICAgICAgICAganVtcCA9IHBvdyhqdW1wLCAyLjApOyAvLyBTaGFycGVuIHRoZSBqdW1wIGN1cnZlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmFuZG9taXplIGp1bXAgaGVpZ2h0IHNsaWdodGx5CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgaGVpZ2h0ID0gMC41ICsgMC41ICogYU9mZnNldDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm1lZC55ICs9IGp1bXAgKiBoZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU3dheSAoU2lkZSB0byBzaWRlKQogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVkLnggKz0gY29zKHQgKiAwLjUpICogMC4xOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZKdW1wID0ganVtcDsKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIHNoYWRlci5mcmFnbWVudFNoYWRlciA9IGAKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZKdW1wOwogICAgICAgICAgICAgICAgYCArIHNoYWRlci5mcmFnbWVudFNoYWRlcjsKCiAgICAgICAgICAgICAgICBzaGFkZXIuZnJhZ21lbnRTaGFkZXIgPSBzaGFkZXIuZnJhZ21lbnRTaGFkZXIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAndmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7JywKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICAgICAgdmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQnJpZ2h0ZW4gd2hlbiBqdW1waW5nIChDaGVlcmluZyBlZmZlY3QpCiAgICAgICAgICAgICAgICAgICAgZGlmZnVzZUNvbG9yLnJnYiArPSB2ZWMzKDAuMikgKiB2SnVtcDsKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy5jcm93ZCA9IG5ldyBUSFJFRS5JbnN0YW5jZWRNZXNoKGdlbywgbWF0LCB0aGlzLmNvbmZpZy5jcm93ZENvdW50KTsKICAgICAgICAgICAgdGhpcy5jcm93ZC5pbnN0YW5jZU1hdHJpeC5zZXRVc2FnZShUSFJFRS5EeW5hbWljRHJhd1VzYWdlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9wdGltaXphdGlvbjogRW5hYmxlIGN1bGxpbmcgYW5kIG1hbnVhbGx5IHNldCBib3VuZGluZyBzcGhlcmUgdG8gY292ZXIgdGhlIHdob2xlIHN0YWRpdW0KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyBHUFUgZnJvbSBwcm9jZXNzaW5nIDI1MDAgaW5zdGFuY2VzIHdoZW4gdGhlIGVudGlyZSBzdHJ1Y3R1cmUgaXMgb3V0IG9mIHZpZXcKICAgICAgICAgICAgdGhpcy5jcm93ZC5mcnVzdHVtQ3VsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jcm93ZC5nZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSA9IG5ldyBUSFJFRS5TcGhlcmUobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksIDE1MCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBkdW1teSA9IG5ldyBUSFJFRS5PYmplY3QzRCgpOwogICAgICAgICAgICBjb25zdCBjb2xvciA9IG5ldyBUSFJFRS5Db2xvcigpOwogICAgICAgICAgICAKLy8gMS4gQ2FsY3VsYXRlIFRvdGFsIENpcmN1bWZlcmVuY2UgZm9yIGRpc3RyaWJ1dGlvbiB0byBlbnN1cmUgYWxsIHRpZXJzIGdldCBwZW9wbGUKICAgICAgICAgICAgbGV0IHRvdGFsQ2lyYyA9IDA7CiAgICAgICAgICAgIGNvbnN0IHRpZXJSYWRpaSA9IFtdOwogICAgICAgICAgICBmb3IobGV0IHQ9MDsgdDx0aGlzLmNvbmZpZy50aWVyczsgdCsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCByTWluID0gdGhpcy5jb25maWcucmFkaXVzICsgKHQgKiAodGhpcy5jb25maWcudGllckRlcHRoICogMC44KSkgKyAyOwogICAgICAgICAgICAgICAgY29uc3QgY2lyYyA9IDIgKiBNYXRoLlBJICogck1pbjsKICAgICAgICAgICAgICAgIHRvdGFsQ2lyYyArPSBjaXJjOwogICAgICAgICAgICAgICAgdGllclJhZGlpLnB1c2goeyByTWluOiByTWluLCBjaXJjOiBjaXJjIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgaWR4ID0gMDsKICAgICAgICAgICAgZm9yKGxldCB0PTA7IHQ8dGhpcy5jb25maWcudGllcnM7IHQrKykgewogICAgICAgICAgICAgICAgY29uc3QgeUJhc2UgPSAodCAqIHRoaXMuY29uZmlnLnRpZXJIZWlnaHQpIC0gMzA7CiAgICAgICAgICAgICAgICBjb25zdCB7IHJNaW4sIGNpcmMgfSA9IHRpZXJSYWRpaVt0XTsKICAgICAgICAgICAgICAgIGNvbnN0IHJNYXggPSByTWluICsgdGhpcy5jb25maWcudGllckRlcHRoIC0gMjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzdHJpYnV0ZSBwcm9wb3J0aW9uYWxseSBzbyB1cHBlciByb3dzIGRvbid0IGdldCBjdXQgb2ZmCiAgICAgICAgICAgICAgICBjb25zdCBjb3VudFBlclRpZXIgPSBNYXRoLmZsb29yKHRoaXMuY29uZmlnLmNyb3dkQ291bnQgKiAoY2lyYyAvIHRvdGFsQ2lyYykpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudFBlclRpZXI7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChpZHggPj0gdGhpcy5jb25maWcuY3Jvd2RDb3VudCkgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSByTWluICsgTWF0aC5yYW5kb20oKSAqIChyTWF4IC0gck1pbik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZHVtbXkucG9zaXRpb24uc2V0KAogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmNvcyhhbmdsZSkgKiByLAogICAgICAgICAgICAgICAgICAgICAgICB5QmFzZSArIDEuMjUsIC8vIENlbnRlciBvZiBxdWFkCiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguc2luKGFuZ2xlKSAqIHIKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyCiAgICAgICAgICAgICAgICAgICAgZHVtbXkubG9va0F0KDAsIHlCYXNlLCAwKTsKICAgICAgICAgICAgICAgICAgICBkdW1teS51cGRhdGVNYXRyaXgoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLmNyb3dkLnNldE1hdHJpeEF0KGlkeCwgZHVtbXkubWF0cml4KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSYW5kb20gVGVhbSBDb2xvcnMgKFNpbXVsYXRpbmcgZmFucykKICAgICAgICAgICAgICAgICAgICBjb25zdCByYW5kID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmFuZCA8IDAuNDUpIGNvbG9yLnNldEhleCgweDAwODhmZik7IC8vIEhvbWUgQmx1ZQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHJhbmQgPCAwLjkpIGNvbG9yLnNldEhleCgweGZmNDQ0NCk7IC8vIEF3YXkgUmVkCiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb2xvci5zZXRIZXgoMHhmZmZmZmYpOyAvLyBOZXV0cmFsL0ZsYXNoCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVmFyeSBicmlnaHRuZXNzIGZvciBkZXB0aAogICAgICAgICAgICAgICAgICAgIGNvbG9yLm11bHRpcGx5U2NhbGFyKDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2Quc2V0Q29sb3JBdChpZHgsIGNvbG9yKTsKICAgICAgICAgICAgICAgICAgICBpZHgrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHRoaXMuY3Jvd2QpOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkSGVyY3VsZWFuUmluZ3MoKSB7CiAgICAgICAgICAgIC8vIE1hc3NpdmUgZmxvYXRpbmcgcmluZ3MgdGhhdCByb3RhdGUgc2xvd2x5CiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4NDQ1NTY2LCAKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuMywKICAgICAgICAgICAgICAgIHdpcmVmcmFtZTogdHJ1ZSAvLyBUZWNoL0hvbG9ncmFwaGljIGZlZWwKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyAxLiBFcXVhdG9yaWFsIFJpbmcgKE1hc3NpdmUpCiAgICAgICAgICAgIGNvbnN0IGdlbzEgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxMTAsIDEsIDE2LCAxMDApOwogICAgICAgICAgICBjb25zdCByaW5nMSA9IG5ldyBUSFJFRS5NZXNoKGdlbzEsIG1hdCk7CiAgICAgICAgICAgIHJpbmcxLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmcxKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzEsIGF4aXM6ICd6Jywgc3BlZWQ6IDAuMDEgfSk7CgogICAgICAgICAgICAvLyAyLiBUaWx0ZWQgUmluZwogICAgICAgICAgICBjb25zdCBnZW8yID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkoMTMwLCAyLCAxNiwgMTAwKTsKICAgICAgICAgICAgY29uc3QgcmluZzIgPSBuZXcgVEhSRUUuTWVzaChnZW8yLCBtYXQpOwogICAgICAgICAgICByaW5nMi5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDM7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW5nMik7CiAgICAgICAgICAgIHRoaXMucmluZ3MucHVzaCh7IG1lc2g6IHJpbmcyLCBheGlzOiAneScsIHNwZWVkOiAtMC4wMDggfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBWZXJ0aWNhbCBSaW5nCiAgICAgICAgICAgIGNvbnN0IGdlbzMgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxNTAsIDMsIDE2LCAxMDApOwpjb25zdCByaW5nMyA9IG5ldyBUSFJFRS5NZXNoKGdlbzMsIG1hdCk7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW5nMyk7CiAgICAgICAgICAgIHRoaXMucmluZ3MucHVzaCh7IG1lc2g6IHJpbmczLCBheGlzOiAneScsIHNwZWVkOiAwLjAwNSB9KTsKICAgICAgICB9CgogICAgICAgIF9idWlsZFN0YWRpdW1MaWdodHMoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gMTY7IC8vIE51bWJlciBvZiBsaWdodHMgYXJvdW5kIHRoZSBlcXVhdG9yCiAgICAgICAgICAgIGNvbnN0IHJhZGl1cyA9IDM2OyAvLyBKdXN0IG91dHNpZGUgdGhlIGFyZW5hIGJvdW5kYXJ5ICgzMikKICAgICAgICAgICAgY29uc3QgeVBvcyA9IDA7IC8vIE1pZGRsZSBvZiB0aGUgc3BoZXJlCiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBsaWdodEdlbyA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeSgwLjQsIDgsIDgpOwogICAgICAgICAgICBjb25zdCBsaWdodE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmZmZmZiB9KTsKCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gKGkgLyBjb3VudCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLmNvcyhhbmdsZSkgKiByYWRpdXM7CiAgICAgICAgICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4oYW5nbGUpICogcmFkaXVzOwoKICAgICAgICAgICAgICAgIC8vIDEuIFBoeXNpY2FsIEZpeHR1cmUgKFRoZSBidWxiKQogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGxpZ2h0R2VvLCBsaWdodE1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnNldCh4LCB5UG9zLCB6KTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBWaXN1YWwgR2xvdyAoRmxhcmUpCiAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSBuZXcgVEhSRUUuU3ByaXRlKF9nbG93TWF0ZXJpYWwpOwovLyAyLiBWaXN1YWwgR2xvdyAoRmxhcmUpCgogICAgICAgICAgICAgICAgc3ByaXRlLnBvc2l0aW9uLnNldCh4LCB5UG9zLCB6KTsKICAgICAgICAgICAgICAgIHNwcml0ZS5zY2FsZS5zZXQoOCwgOCwgMSk7IC8vIExhcmdlIGdsb3cKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChzcHJpdGUpOwogICAgICAgICAgICAgICAgdGhpcy5saWdodFNwcml0ZXMucHVzaChzcHJpdGUpOwoKLy8gMy4gQWN0dWFsIFBvaW50IExpZ2h0IC0gUkVNT1ZFRCBmb3Igb3B0aW1pemF0aW9uCiAgICAgICAgICAgICAgICAvLyBTaW5jZSB3ZSB1c2UgTWVzaEJhc2ljTWF0ZXJpYWwgKFVubGl0KSwgcmVhbCBsaWdodHMgd2FzdGUgQ1BVL0dQVSByZXNvdXJjZXMuCiAgICAgICAgICAgICAgICAvLyBUaGUgc3ByaXRlIGdsb3cgYWJvdmUgcHJvdmlkZXMgdGhlIHZpc3VhbCBlZmZlY3QuCiAgICAgICAgICAgIH0KICAgICAgICB9CnVwZGF0ZShkdCkgewogICAgICAgICAgICAvLyBBbmltYXRlIFJpbmdzCiAgICAgICAgICAgIHRoaXMucmluZ3MuZm9yRWFjaChyID0+IHsKICAgICAgICAgICAgICAgIGlmIChyLm1lc2ggJiYgci5heGlzKSB7CiAgICAgICAgICAgICAgICAgICAgci5tZXNoLnJvdGF0aW9uW3IuYXhpc10gKz0gci5zcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBDcm93ZCBTaGFkZXIKICAgICAgICAgICAgaWYgKHRoaXMuY3Jvd2RVbmlmb3JtcykgewogICAgICAgICAgICAgICAgdGhpcy5jcm93ZFVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgTGlnaHQgUG9wcyAoQ2luZW1hdGljKQogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcy5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICAgICAgaWYgKHMudmlzaWJsZSAmJiBzLnNjYWxlLnggPiA4LjApIHsKICAgICAgICAgICAgICAgICAgICAvLyBEZWNheSBwb3AgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgcy5zY2FsZS54IC09IGR0ICogMzAuMDsKICAgICAgICAgICAgICAgICAgICBzLnNjYWxlLnkgLT0gZHQgKiAzMC4wOwogICAgICAgICAgICAgICAgICAgIGlmIChzLnNjYWxlLnggPCA4LjApIHMuc2NhbGUuc2V0KDgsIDgsIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIHNldEFsbExpZ2h0cyh2aXNpYmxlKSB7CiAgICAgICAgICAgIHRoaXMubGlnaHRTcHJpdGVzLmZvckVhY2gocyA9PiB7CiAgICAgICAgICAgICAgICBzLnZpc2libGUgPSB2aXNpYmxlOwogICAgICAgICAgICAgICAgcy5zY2FsZS5zZXQoOCwgOCwgMSk7IC8vIFJlc2V0IHNjYWxlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgdHVybk9uTGlnaHQoaW5kZXgpIHsKICAgICAgICAgICAgaWYgKHRoaXMubGlnaHRTcHJpdGVzW2luZGV4XSkgewogICAgICAgICAgICAgICAgY29uc3QgcyA9IHRoaXMubGlnaHRTcHJpdGVzW2luZGV4XTsKICAgICAgICAgICAgICAgIHMudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBzLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICBzLnNjYWxlLnNldCgyMCwgMjAsIDEpOyAvLyBQb3AgZWZmZWN0CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguU3RhZGl1bSA9IFN0YWRpdW07Cn0pKCk7","./Stadium.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFJldXNhYmxlIEdsb3cgZm9yIExpZ2h0cwogICAgY29uc3QgX2dsb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAzMik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjQsICdyZ2JhKDAsIDE3MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgNjQsIDY0KTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIGNvbnN0IF9nbG93TWF0ZXJpYWwgPSBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyAKICAgICAgICBtYXA6IF9nbG93VGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBTdGFkaXVtIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuY29udGFpbmVyKTsKCiAgICAgICAgICAgIC8vIENvbmZpZyBmb3IgIkhlcmN1bGVhbiIgc2NhbGUKLy8gQ29uZmlnIGZvciAiSGVyY3VsZWFuIiBzY2FsZQogICAgICAgICAgICB0aGlzLmNvbmZpZyA9IHsKICAgICAgICAgICAgICAgIHJhZGl1czogNjAsICAgICAgIC8vIFN0YXJ0IG91dHNpZGUgdGhlIGFyZW5hICg0OCByYWRpdXMpCiAgICAgICAgICAgICAgICB0aWVyczogNiwgICAgICAgICAvLyBOdW1iZXIgb2Ygc2VhdGluZyByaW5ncwogICAgICAgICAgICAgICAgdGllckhlaWdodDogMTIsCiAgICAgICAgICAgICAgICB0aWVyRGVwdGg6IDE1LAogICAgICAgICAgICAgICAgY3Jvd2RDb3VudDogODAwMCwgLy8gSW5jcmVhc2VkIGRlbnNpdHkKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDA4MGMxMCwgLy8gRGVlcCBkYXJrIGJsdWUvYmxhY2sKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4MDBhYWZmCiAgICAgICAgICAgIH07Cgp0aGlzLnJpbmdzID0gW107CiAgICAgICAgICAgIHRoaXMubGlnaHRTcHJpdGVzID0gW107IC8vIFN0b3JlIGxpZ2h0IHNwcml0ZXMgZm9yIGNpbmVtYXRpYyBjb250cm9sCiAgICAgICAgICAgIHRoaXMuY3Jvd2QgPSBudWxsOwogICAgICAgICAgICB0aGlzLmNyb3dkID0gbnVsbDsKCnRoaXMuX2J1aWxkQXJjaGl0ZWN0dXJlKCk7CiAgICAgICAgICAgIHRoaXMuX2J1aWxkQ3Jvd2QoKTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRIZXJjdWxlYW5SaW5ncygpOwogICAgICAgICAgICB0aGlzLl9idWlsZFN0YWRpdW1MaWdodHMoKTsKICAgICAgICB9CgogICAgICAgIF9idWlsZEFyY2hpdGVjdHVyZSgpIHsKICAgICAgICAgICAgLy8gMS4gVGhlIFZvaWQgQm93bCAoQmFja2dyb3VuZCBPY2NsdWRlcikKICAgICAgICAgICAgLy8gTWFzc2l2ZSBjeWxpbmRlciB0byBibG9jayB0aGUgdm9pZAogICAgICAgICAgICBjb25zdCBib3dsR2VvID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoMTgwLCA1MCwgMTIwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIGNvbnN0IGJvd2xNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgIGNvbG9yOiB0aGlzLmNvbmZpZy5zdHJ1Y3R1cmVDb2xvciwgCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgICAgIGZvZzogdHJ1ZSAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IGJvd2wgPSBuZXcgVEhSRUUuTWVzaChib3dsR2VvLCBib3dsTWF0KTsKICAgICAgICAgICAgYm93bC5wb3NpdGlvbi55ID0gMjA7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChib3dsKTsKCiAgICAgICAgICAgIC8vIDIuIFNlYXRpbmcgVGllcnMgKENvbmNlbnRyaWMgUmluZ3MpCiAgICAgICAgICAgIGNvbnN0IHRpZXJNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgxMTFhMjIsIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUgfSk7CiAgICAgICAgICAgIGNvbnN0IHJpbU1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwNDQ2NiB9KTsKCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMuY29uZmlnLnRpZXJzOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAoaSAqIHRoaXMuY29uZmlnLnRpZXJIZWlnaHQpIC0gMzA7CiAgICAgICAgICAgICAgICBjb25zdCBySW5uZXIgPSB0aGlzLmNvbmZpZy5yYWRpdXMgKyAoaSAqICh0aGlzLmNvbmZpZy50aWVyRGVwdGggKiAwLjgpKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJPdXRlciA9IHJJbm5lciArIHRoaXMuY29uZmlnLnRpZXJEZXB0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmxvb3IgUmluZwogICAgICAgICAgICAgICAgY29uc3QgcmluZ0dlbyA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkocklubmVyLCByT3V0ZXIsIDY0KTsKICAgICAgICAgICAgICAgIHJpbmdHZW8ucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKHJpbmdHZW8sIHRpZXJNYXQpOwogICAgICAgICAgICAgICAgbWVzaC5wb3NpdGlvbi55ID0geTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gR2xvd2luZyBSaW0gKFRoZSAiVGVjaCIgZmVlbCkKICAgICAgICAgICAgICAgIGNvbnN0IHJpbUdlbyA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KHJJbm5lciwgMC44LCA0LCA2NCk7CiAgICAgICAgICAgICAgICByaW1HZW8ucm90YXRlWChNYXRoLlBJIC8gMik7CiAgICAgICAgICAgICAgICBjb25zdCByaW0gPSBuZXcgVEhSRUUuTWVzaChyaW1HZW8sIHJpbU1hdCk7CiAgICAgICAgICAgICAgICByaW0ucG9zaXRpb24ueSA9IHk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQocmltKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gTWFzc2l2ZSBQaWxsYXJzIChUaGUgIkhlcmN1bGVhbiIgU3VwcG9ydCkKICAgICAgICAgICAgY29uc3QgcGlsbGFyR2VvID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KDgsIDIwMCwgOCk7CiAgICAgICAgICAgIGNvbnN0IHBpbGxhck1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDA1MDUwNSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTQwOyAvLyBGYXIgb3V0CiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gocGlsbGFyR2VvLCBwaWxsYXJNYXQpOwogICAgICAgICAgICAgICAgbWVzaC5wb3NpdGlvbi5zZXQoTWF0aC5jb3MoYW5nbGUpKnIsIDAsIE1hdGguc2luKGFuZ2xlKSpyKTsKICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KDAsMCwwKTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9idWlsZENyb3dkKCkgewogICAgICAgICAgICAvLyBJbnN0YW5jZWQgTWVzaCBmb3IgQ3Jvd2QgKExvdyBQb2x5LCBIaWdoIENvdW50KQogICAgICAgICAgICAvLyBVc2luZyBhIHNpbXBsZSB2ZXJ0aWNhbCBwbGFuZSB0aGF0IGZhY2VzIGNlbnRlcgogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjIsIDIuNSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAtLS0gQ1JPV0QgU0hBREVSIElNUExFTUVOVEFUSU9OIC0tLQogICAgICAgICAgICAvLyBBZGQgaW5zdGFuY2Utc3BlY2lmaWMgcmFuZG9tIG9mZnNldCBmb3IgYW5pbWF0aW9uIHZhcmlhdGlvbgogICAgICAgICAgICBjb25zdCBvZmZzZXRzID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLmNvbmZpZy5jcm93ZENvdW50KTsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5jb25maWcuY3Jvd2RDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBvZmZzZXRzW2ldID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdhT2Zmc2V0JywgbmV3IFRIUkVFLkluc3RhbmNlZEJ1ZmZlckF0dHJpYnV0ZShvZmZzZXRzLCAxKSk7CgogICAgICAgICAgICAvLyBDdXN0b20gU2hhZGVyIHZpYSBvbkJlZm9yZUNvbXBpbGUKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgc2lkZTogVEhSRUUuRG91YmxlU2lkZSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIG1hdC5vbkJlZm9yZUNvbXBpbGUgPSAoc2hhZGVyKSA9PiB7CiAgICAgICAgICAgICAgICBzaGFkZXIudW5pZm9ybXMudVRpbWUgPSB7IHZhbHVlOiAwIH07CiAgICAgICAgICAgICAgICB0aGlzLmNyb3dkVW5pZm9ybXMgPSBzaGFkZXIudW5pZm9ybXM7CgogICAgICAgICAgICAgICAgc2hhZGVyLnZlcnRleFNoYWRlciA9IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBhT2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkp1bXA7IC8vIFBhc3MgdG8gZnJhZ21lbnQgZm9yIGNvbG9yIHZhcmlhdGlvbgogICAgICAgICAgICAgICAgYCArIHNoYWRlci52ZXJ0ZXhTaGFkZXI7CgogICAgICAgICAgICAgICAgc2hhZGVyLnZlcnRleFNoYWRlciA9IHNoYWRlci52ZXJ0ZXhTaGFkZXIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAnI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4nLAogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICAgICAjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEFuaW1hdGlvbiBMb2dpYwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNwZWVkID0gOC4wOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSB1VGltZSAqIHNwZWVkICsgKGFPZmZzZXQgKiAxMDAuMCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSnVtcCAoU2luZSB3YXZlIGNsaXBwZWQpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQganVtcCA9IG1heCgwLjAsIHNpbih0KSk7CiAgICAgICAgICAgICAgICAgICAganVtcCA9IHBvdyhqdW1wLCAyLjApOyAvLyBTaGFycGVuIHRoZSBqdW1wIGN1cnZlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmFuZG9taXplIGp1bXAgaGVpZ2h0IHNsaWdodGx5CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgaGVpZ2h0ID0gMC41ICsgMC41ICogYU9mZnNldDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm1lZC55ICs9IGp1bXAgKiBoZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU3dheSAoU2lkZSB0byBzaWRlKQogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVkLnggKz0gY29zKHQgKiAwLjUpICogMC4xOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZKdW1wID0ganVtcDsKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIHNoYWRlci5mcmFnbWVudFNoYWRlciA9IGAKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZKdW1wOwogICAgICAgICAgICAgICAgYCArIHNoYWRlci5mcmFnbWVudFNoYWRlcjsKCiAgICAgICAgICAgICAgICBzaGFkZXIuZnJhZ21lbnRTaGFkZXIgPSBzaGFkZXIuZnJhZ21lbnRTaGFkZXIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAndmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7JywKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICAgICAgdmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQnJpZ2h0ZW4gd2hlbiBqdW1waW5nIChDaGVlcmluZyBlZmZlY3QpCiAgICAgICAgICAgICAgICAgICAgZGlmZnVzZUNvbG9yLnJnYiArPSB2ZWMzKDAuMikgKiB2SnVtcDsKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy5jcm93ZCA9IG5ldyBUSFJFRS5JbnN0YW5jZWRNZXNoKGdlbywgbWF0LCB0aGlzLmNvbmZpZy5jcm93ZENvdW50KTsKICAgICAgICAgICAgdGhpcy5jcm93ZC5pbnN0YW5jZU1hdHJpeC5zZXRVc2FnZShUSFJFRS5EeW5hbWljRHJhd1VzYWdlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9wdGltaXphdGlvbjogRW5hYmxlIGN1bGxpbmcgYW5kIG1hbnVhbGx5IHNldCBib3VuZGluZyBzcGhlcmUgdG8gY292ZXIgdGhlIHdob2xlIHN0YWRpdW0KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyBHUFUgZnJvbSBwcm9jZXNzaW5nIDI1MDAgaW5zdGFuY2VzIHdoZW4gdGhlIGVudGlyZSBzdHJ1Y3R1cmUgaXMgb3V0IG9mIHZpZXcKICAgICAgICAgICAgdGhpcy5jcm93ZC5mcnVzdHVtQ3VsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jcm93ZC5nZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSA9IG5ldyBUSFJFRS5TcGhlcmUobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksIDE1MCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBkdW1teSA9IG5ldyBUSFJFRS5PYmplY3QzRCgpOwogICAgICAgICAgICBjb25zdCBjb2xvciA9IG5ldyBUSFJFRS5Db2xvcigpOwogICAgICAgICAgICAKLy8gMS4gQ2FsY3VsYXRlIFRvdGFsIENpcmN1bWZlcmVuY2UgZm9yIGRpc3RyaWJ1dGlvbiB0byBlbnN1cmUgYWxsIHRpZXJzIGdldCBwZW9wbGUKICAgICAgICAgICAgbGV0IHRvdGFsQ2lyYyA9IDA7CiAgICAgICAgICAgIGNvbnN0IHRpZXJSYWRpaSA9IFtdOwogICAgICAgICAgICBmb3IobGV0IHQ9MDsgdDx0aGlzLmNvbmZpZy50aWVyczsgdCsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCByTWluID0gdGhpcy5jb25maWcucmFkaXVzICsgKHQgKiAodGhpcy5jb25maWcudGllckRlcHRoICogMC44KSkgKyAyOwogICAgICAgICAgICAgICAgY29uc3QgY2lyYyA9IDIgKiBNYXRoLlBJICogck1pbjsKICAgICAgICAgICAgICAgIHRvdGFsQ2lyYyArPSBjaXJjOwogICAgICAgICAgICAgICAgdGllclJhZGlpLnB1c2goeyByTWluOiByTWluLCBjaXJjOiBjaXJjIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgaWR4ID0gMDsKICAgICAgICAgICAgZm9yKGxldCB0PTA7IHQ8dGhpcy5jb25maWcudGllcnM7IHQrKykgewogICAgICAgICAgICAgICAgY29uc3QgeUJhc2UgPSAodCAqIHRoaXMuY29uZmlnLnRpZXJIZWlnaHQpIC0gMzA7CiAgICAgICAgICAgICAgICBjb25zdCB7IHJNaW4sIGNpcmMgfSA9IHRpZXJSYWRpaVt0XTsKICAgICAgICAgICAgICAgIGNvbnN0IHJNYXggPSByTWluICsgdGhpcy5jb25maWcudGllckRlcHRoIC0gMjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzdHJpYnV0ZSBwcm9wb3J0aW9uYWxseSBzbyB1cHBlciByb3dzIGRvbid0IGdldCBjdXQgb2ZmCiAgICAgICAgICAgICAgICBjb25zdCBjb3VudFBlclRpZXIgPSBNYXRoLmZsb29yKHRoaXMuY29uZmlnLmNyb3dkQ291bnQgKiAoY2lyYyAvIHRvdGFsQ2lyYykpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudFBlclRpZXI7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChpZHggPj0gdGhpcy5jb25maWcuY3Jvd2RDb3VudCkgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSByTWluICsgTWF0aC5yYW5kb20oKSAqIChyTWF4IC0gck1pbik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZHVtbXkucG9zaXRpb24uc2V0KAogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmNvcyhhbmdsZSkgKiByLAogICAgICAgICAgICAgICAgICAgICAgICB5QmFzZSArIDEuMjUsIC8vIENlbnRlciBvZiBxdWFkCiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguc2luKGFuZ2xlKSAqIHIKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyCiAgICAgICAgICAgICAgICAgICAgZHVtbXkubG9va0F0KDAsIHlCYXNlLCAwKTsKICAgICAgICAgICAgICAgICAgICBkdW1teS51cGRhdGVNYXRyaXgoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLmNyb3dkLnNldE1hdHJpeEF0KGlkeCwgZHVtbXkubWF0cml4KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSYW5kb20gVGVhbSBDb2xvcnMgKFNpbXVsYXRpbmcgZmFucykKICAgICAgICAgICAgICAgICAgICBjb25zdCByYW5kID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmFuZCA8IDAuNDUpIGNvbG9yLnNldEhleCgweDAwODhmZik7IC8vIEhvbWUgQmx1ZQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHJhbmQgPCAwLjkpIGNvbG9yLnNldEhleCgweGZmNDQ0NCk7IC8vIEF3YXkgUmVkCiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb2xvci5zZXRIZXgoMHhmZmZmZmYpOyAvLyBOZXV0cmFsL0ZsYXNoCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVmFyeSBicmlnaHRuZXNzIGZvciBkZXB0aAogICAgICAgICAgICAgICAgICAgIGNvbG9yLm11bHRpcGx5U2NhbGFyKDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2Quc2V0Q29sb3JBdChpZHgsIGNvbG9yKTsKICAgICAgICAgICAgICAgICAgICBpZHgrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHRoaXMuY3Jvd2QpOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkSGVyY3VsZWFuUmluZ3MoKSB7CiAgICAgICAgICAgIC8vIE1hc3NpdmUgZmxvYXRpbmcgcmluZ3MgdGhhdCByb3RhdGUgc2xvd2x5CiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4NDQ1NTY2LCAKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuMywKICAgICAgICAgICAgICAgIHdpcmVmcmFtZTogdHJ1ZSAvLyBUZWNoL0hvbG9ncmFwaGljIGZlZWwKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyAxLiBFcXVhdG9yaWFsIFJpbmcgKE1hc3NpdmUpCiAgICAgICAgICAgIGNvbnN0IGdlbzEgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxMTAsIDEsIDE2LCAxMDApOwogICAgICAgICAgICBjb25zdCByaW5nMSA9IG5ldyBUSFJFRS5NZXNoKGdlbzEsIG1hdCk7CiAgICAgICAgICAgIHJpbmcxLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmcxKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzEsIGF4aXM6ICd6Jywgc3BlZWQ6IDAuMDEgfSk7CgogICAgICAgICAgICAvLyAyLiBUaWx0ZWQgUmluZwogICAgICAgICAgICBjb25zdCBnZW8yID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkoMTMwLCAyLCAxNiwgMTAwKTsKICAgICAgICAgICAgY29uc3QgcmluZzIgPSBuZXcgVEhSRUUuTWVzaChnZW8yLCBtYXQpOwogICAgICAgICAgICByaW5nMi5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDM7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW5nMik7CiAgICAgICAgICAgIHRoaXMucmluZ3MucHVzaCh7IG1lc2g6IHJpbmcyLCBheGlzOiAneScsIHNwZWVkOiAtMC4wMDggfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBWZXJ0aWNhbCBSaW5nCiAgICAgICAgICAgIGNvbnN0IGdlbzMgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxNTAsIDMsIDE2LCAxMDApOwpjb25zdCByaW5nMyA9IG5ldyBUSFJFRS5NZXNoKGdlbzMsIG1hdCk7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW5nMyk7CiAgICAgICAgICAgIHRoaXMucmluZ3MucHVzaCh7IG1lc2g6IHJpbmczLCBheGlzOiAneScsIHNwZWVkOiAwLjAwNSB9KTsKICAgICAgICB9CgogICAgICAgIF9idWlsZFN0YWRpdW1MaWdodHMoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gMTY7IC8vIE51bWJlciBvZiBsaWdodHMgYXJvdW5kIHRoZSBlcXVhdG9yCiAgICAgICAgICAgIGNvbnN0IHJhZGl1cyA9IDM2OyAvLyBKdXN0IG91dHNpZGUgdGhlIGFyZW5hIGJvdW5kYXJ5ICgzMikKICAgICAgICAgICAgY29uc3QgeVBvcyA9IDA7IC8vIE1pZGRsZSBvZiB0aGUgc3BoZXJlCiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBsaWdodEdlbyA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeSgwLjQsIDgsIDgpOwogICAgICAgICAgICBjb25zdCBsaWdodE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmZmZmZiB9KTsKCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gKGkgLyBjb3VudCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLmNvcyhhbmdsZSkgKiByYWRpdXM7CiAgICAgICAgICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4oYW5nbGUpICogcmFkaXVzOwoKICAgICAgICAgICAgICAgIC8vIDEuIFBoeXNpY2FsIEZpeHR1cmUgKFRoZSBidWxiKQogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGxpZ2h0R2VvLCBsaWdodE1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnNldCh4LCB5UG9zLCB6KTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBWaXN1YWwgR2xvdyAoRmxhcmUpCiAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSBuZXcgVEhSRUUuU3ByaXRlKF9nbG93TWF0ZXJpYWwpOwovLyAyLiBWaXN1YWwgR2xvdyAoRmxhcmUpCgogICAgICAgICAgICAgICAgc3ByaXRlLnBvc2l0aW9uLnNldCh4LCB5UG9zLCB6KTsKICAgICAgICAgICAgICAgIHNwcml0ZS5zY2FsZS5zZXQoOCwgOCwgMSk7IC8vIExhcmdlIGdsb3cKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChzcHJpdGUpOwogICAgICAgICAgICAgICAgdGhpcy5saWdodFNwcml0ZXMucHVzaChzcHJpdGUpOwoKLy8gMy4gQWN0dWFsIFBvaW50IExpZ2h0IC0gUkVNT1ZFRCBmb3Igb3B0aW1pemF0aW9uCiAgICAgICAgICAgICAgICAvLyBTaW5jZSB3ZSB1c2UgTWVzaEJhc2ljTWF0ZXJpYWwgKFVubGl0KSwgcmVhbCBsaWdodHMgd2FzdGUgQ1BVL0dQVSByZXNvdXJjZXMuCiAgICAgICAgICAgICAgICAvLyBUaGUgc3ByaXRlIGdsb3cgYWJvdmUgcHJvdmlkZXMgdGhlIHZpc3VhbCBlZmZlY3QuCiAgICAgICAgICAgIH0KICAgICAgICB9CnVwZGF0ZShkdCkgewogICAgICAgICAgICAvLyBBbmltYXRlIFJpbmdzCiAgICAgICAgICAgIHRoaXMucmluZ3MuZm9yRWFjaChyID0+IHsKICAgICAgICAgICAgICAgIGlmIChyLm1lc2ggJiYgci5heGlzKSB7CiAgICAgICAgICAgICAgICAgICAgci5tZXNoLnJvdGF0aW9uW3IuYXhpc10gKz0gci5zcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBDcm93ZCBTaGFkZXIKICAgICAgICAgICAgaWYgKHRoaXMuY3Jvd2RVbmlmb3JtcykgewogICAgICAgICAgICAgICAgdGhpcy5jcm93ZFVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgTGlnaHQgUG9wcyAoQ2luZW1hdGljKQogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcy5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICAgICAgaWYgKHMudmlzaWJsZSAmJiBzLnNjYWxlLnggPiA4LjApIHsKICAgICAgICAgICAgICAgICAgICAvLyBEZWNheSBwb3AgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgcy5zY2FsZS54IC09IGR0ICogMzAuMDsKICAgICAgICAgICAgICAgICAgICBzLnNjYWxlLnkgLT0gZHQgKiAzMC4wOwogICAgICAgICAgICAgICAgICAgIGlmIChzLnNjYWxlLnggPCA4LjApIHMuc2NhbGUuc2V0KDgsIDgsIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIHNldEFsbExpZ2h0cyh2aXNpYmxlKSB7CiAgICAgICAgICAgIHRoaXMubGlnaHRTcHJpdGVzLmZvckVhY2gocyA9PiB7CiAgICAgICAgICAgICAgICBzLnZpc2libGUgPSB2aXNpYmxlOwogICAgICAgICAgICAgICAgcy5zY2FsZS5zZXQoOCwgOCwgMSk7IC8vIFJlc2V0IHNjYWxlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgdHVybk9uTGlnaHQoaW5kZXgpIHsKICAgICAgICAgICAgaWYgKHRoaXMubGlnaHRTcHJpdGVzW2luZGV4XSkgewogICAgICAgICAgICAgICAgY29uc3QgcyA9IHRoaXMubGlnaHRTcHJpdGVzW2luZGV4XTsKICAgICAgICAgICAgICAgIHMudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBzLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICBzLnNjYWxlLnNldCgyMCwgMjAsIDEpOyAvLyBQb3AgZWZmZWN0CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguU3RhZGl1bSA9IFN0YWRpdW07Cn0pKCk7","/Stadium.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFJldXNhYmxlIEdsb3cgZm9yIExpZ2h0cwogICAgY29uc3QgX2dsb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAzMik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjQsICdyZ2JhKDAsIDE3MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgNjQsIDY0KTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIGNvbnN0IF9nbG93TWF0ZXJpYWwgPSBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyAKICAgICAgICBtYXA6IF9nbG93VGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBTdGFkaXVtIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuY29udGFpbmVyKTsKCiAgICAgICAgICAgIC8vIENvbmZpZyBmb3IgIkhlcmN1bGVhbiIgc2NhbGUKLy8gQ29uZmlnIGZvciAiSGVyY3VsZWFuIiBzY2FsZQogICAgICAgICAgICB0aGlzLmNvbmZpZyA9IHsKICAgICAgICAgICAgICAgIHJhZGl1czogNjAsICAgICAgIC8vIFN0YXJ0IG91dHNpZGUgdGhlIGFyZW5hICg0OCByYWRpdXMpCiAgICAgICAgICAgICAgICB0aWVyczogNiwgICAgICAgICAvLyBOdW1iZXIgb2Ygc2VhdGluZyByaW5ncwogICAgICAgICAgICAgICAgdGllckhlaWdodDogMTIsCiAgICAgICAgICAgICAgICB0aWVyRGVwdGg6IDE1LAogICAgICAgICAgICAgICAgY3Jvd2RDb3VudDogODAwMCwgLy8gSW5jcmVhc2VkIGRlbnNpdHkKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDA4MGMxMCwgLy8gRGVlcCBkYXJrIGJsdWUvYmxhY2sKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4MDBhYWZmCiAgICAgICAgICAgIH07Cgp0aGlzLnJpbmdzID0gW107CiAgICAgICAgICAgIHRoaXMubGlnaHRTcHJpdGVzID0gW107IC8vIFN0b3JlIGxpZ2h0IHNwcml0ZXMgZm9yIGNpbmVtYXRpYyBjb250cm9sCiAgICAgICAgICAgIHRoaXMuY3Jvd2QgPSBudWxsOwogICAgICAgICAgICB0aGlzLmNyb3dkID0gbnVsbDsKCnRoaXMuX2J1aWxkQXJjaGl0ZWN0dXJlKCk7CiAgICAgICAgICAgIHRoaXMuX2J1aWxkQ3Jvd2QoKTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRIZXJjdWxlYW5SaW5ncygpOwogICAgICAgICAgICB0aGlzLl9idWlsZFN0YWRpdW1MaWdodHMoKTsKICAgICAgICB9CgogICAgICAgIF9idWlsZEFyY2hpdGVjdHVyZSgpIHsKICAgICAgICAgICAgLy8gMS4gVGhlIFZvaWQgQm93bCAoQmFja2dyb3VuZCBPY2NsdWRlcikKICAgICAgICAgICAgLy8gTWFzc2l2ZSBjeWxpbmRlciB0byBibG9jayB0aGUgdm9pZAogICAgICAgICAgICBjb25zdCBib3dsR2VvID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoMTgwLCA1MCwgMTIwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIGNvbnN0IGJvd2xNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgIGNvbG9yOiB0aGlzLmNvbmZpZy5zdHJ1Y3R1cmVDb2xvciwgCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgICAgIGZvZzogdHJ1ZSAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IGJvd2wgPSBuZXcgVEhSRUUuTWVzaChib3dsR2VvLCBib3dsTWF0KTsKICAgICAgICAgICAgYm93bC5wb3NpdGlvbi55ID0gMjA7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChib3dsKTsKCiAgICAgICAgICAgIC8vIDIuIFNlYXRpbmcgVGllcnMgKENvbmNlbnRyaWMgUmluZ3MpCiAgICAgICAgICAgIGNvbnN0IHRpZXJNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgxMTFhMjIsIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUgfSk7CiAgICAgICAgICAgIGNvbnN0IHJpbU1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwNDQ2NiB9KTsKCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMuY29uZmlnLnRpZXJzOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAoaSAqIHRoaXMuY29uZmlnLnRpZXJIZWlnaHQpIC0gMzA7CiAgICAgICAgICAgICAgICBjb25zdCBySW5uZXIgPSB0aGlzLmNvbmZpZy5yYWRpdXMgKyAoaSAqICh0aGlzLmNvbmZpZy50aWVyRGVwdGggKiAwLjgpKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJPdXRlciA9IHJJbm5lciArIHRoaXMuY29uZmlnLnRpZXJEZXB0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmxvb3IgUmluZwogICAgICAgICAgICAgICAgY29uc3QgcmluZ0dlbyA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkocklubmVyLCByT3V0ZXIsIDY0KTsKICAgICAgICAgICAgICAgIHJpbmdHZW8ucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKHJpbmdHZW8sIHRpZXJNYXQpOwogICAgICAgICAgICAgICAgbWVzaC5wb3NpdGlvbi55ID0geTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gR2xvd2luZyBSaW0gKFRoZSAiVGVjaCIgZmVlbCkKICAgICAgICAgICAgICAgIGNvbnN0IHJpbUdlbyA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KHJJbm5lciwgMC44LCA0LCA2NCk7CiAgICAgICAgICAgICAgICByaW1HZW8ucm90YXRlWChNYXRoLlBJIC8gMik7CiAgICAgICAgICAgICAgICBjb25zdCByaW0gPSBuZXcgVEhSRUUuTWVzaChyaW1HZW8sIHJpbU1hdCk7CiAgICAgICAgICAgICAgICByaW0ucG9zaXRpb24ueSA9IHk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQocmltKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gTWFzc2l2ZSBQaWxsYXJzIChUaGUgIkhlcmN1bGVhbiIgU3VwcG9ydCkKICAgICAgICAgICAgY29uc3QgcGlsbGFyR2VvID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KDgsIDIwMCwgOCk7CiAgICAgICAgICAgIGNvbnN0IHBpbGxhck1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDA1MDUwNSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTQwOyAvLyBGYXIgb3V0CiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gocGlsbGFyR2VvLCBwaWxsYXJNYXQpOwogICAgICAgICAgICAgICAgbWVzaC5wb3NpdGlvbi5zZXQoTWF0aC5jb3MoYW5nbGUpKnIsIDAsIE1hdGguc2luKGFuZ2xlKSpyKTsKICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KDAsMCwwKTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9idWlsZENyb3dkKCkgewogICAgICAgICAgICAvLyBJbnN0YW5jZWQgTWVzaCBmb3IgQ3Jvd2QgKExvdyBQb2x5LCBIaWdoIENvdW50KQogICAgICAgICAgICAvLyBVc2luZyBhIHNpbXBsZSB2ZXJ0aWNhbCBwbGFuZSB0aGF0IGZhY2VzIGNlbnRlcgogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjIsIDIuNSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAtLS0gQ1JPV0QgU0hBREVSIElNUExFTUVOVEFUSU9OIC0tLQogICAgICAgICAgICAvLyBBZGQgaW5zdGFuY2Utc3BlY2lmaWMgcmFuZG9tIG9mZnNldCBmb3IgYW5pbWF0aW9uIHZhcmlhdGlvbgogICAgICAgICAgICBjb25zdCBvZmZzZXRzID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLmNvbmZpZy5jcm93ZENvdW50KTsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5jb25maWcuY3Jvd2RDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBvZmZzZXRzW2ldID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdhT2Zmc2V0JywgbmV3IFRIUkVFLkluc3RhbmNlZEJ1ZmZlckF0dHJpYnV0ZShvZmZzZXRzLCAxKSk7CgogICAgICAgICAgICAvLyBDdXN0b20gU2hhZGVyIHZpYSBvbkJlZm9yZUNvbXBpbGUKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgc2lkZTogVEhSRUUuRG91YmxlU2lkZSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIG1hdC5vbkJlZm9yZUNvbXBpbGUgPSAoc2hhZGVyKSA9PiB7CiAgICAgICAgICAgICAgICBzaGFkZXIudW5pZm9ybXMudVRpbWUgPSB7IHZhbHVlOiAwIH07CiAgICAgICAgICAgICAgICB0aGlzLmNyb3dkVW5pZm9ybXMgPSBzaGFkZXIudW5pZm9ybXM7CgogICAgICAgICAgICAgICAgc2hhZGVyLnZlcnRleFNoYWRlciA9IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBhT2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkp1bXA7IC8vIFBhc3MgdG8gZnJhZ21lbnQgZm9yIGNvbG9yIHZhcmlhdGlvbgogICAgICAgICAgICAgICAgYCArIHNoYWRlci52ZXJ0ZXhTaGFkZXI7CgogICAgICAgICAgICAgICAgc2hhZGVyLnZlcnRleFNoYWRlciA9IHNoYWRlci52ZXJ0ZXhTaGFkZXIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAnI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4nLAogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICAgICAjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEFuaW1hdGlvbiBMb2dpYwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNwZWVkID0gOC4wOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSB1VGltZSAqIHNwZWVkICsgKGFPZmZzZXQgKiAxMDAuMCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSnVtcCAoU2luZSB3YXZlIGNsaXBwZWQpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQganVtcCA9IG1heCgwLjAsIHNpbih0KSk7CiAgICAgICAgICAgICAgICAgICAganVtcCA9IHBvdyhqdW1wLCAyLjApOyAvLyBTaGFycGVuIHRoZSBqdW1wIGN1cnZlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmFuZG9taXplIGp1bXAgaGVpZ2h0IHNsaWdodGx5CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgaGVpZ2h0ID0gMC41ICsgMC41ICogYU9mZnNldDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm1lZC55ICs9IGp1bXAgKiBoZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU3dheSAoU2lkZSB0byBzaWRlKQogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVkLnggKz0gY29zKHQgKiAwLjUpICogMC4xOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZKdW1wID0ganVtcDsKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIHNoYWRlci5mcmFnbWVudFNoYWRlciA9IGAKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZKdW1wOwogICAgICAgICAgICAgICAgYCArIHNoYWRlci5mcmFnbWVudFNoYWRlcjsKCiAgICAgICAgICAgICAgICBzaGFkZXIuZnJhZ21lbnRTaGFkZXIgPSBzaGFkZXIuZnJhZ21lbnRTaGFkZXIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAndmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7JywKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICAgICAgdmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQnJpZ2h0ZW4gd2hlbiBqdW1waW5nIChDaGVlcmluZyBlZmZlY3QpCiAgICAgICAgICAgICAgICAgICAgZGlmZnVzZUNvbG9yLnJnYiArPSB2ZWMzKDAuMikgKiB2SnVtcDsKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy5jcm93ZCA9IG5ldyBUSFJFRS5JbnN0YW5jZWRNZXNoKGdlbywgbWF0LCB0aGlzLmNvbmZpZy5jcm93ZENvdW50KTsKICAgICAgICAgICAgdGhpcy5jcm93ZC5pbnN0YW5jZU1hdHJpeC5zZXRVc2FnZShUSFJFRS5EeW5hbWljRHJhd1VzYWdlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9wdGltaXphdGlvbjogRW5hYmxlIGN1bGxpbmcgYW5kIG1hbnVhbGx5IHNldCBib3VuZGluZyBzcGhlcmUgdG8gY292ZXIgdGhlIHdob2xlIHN0YWRpdW0KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyBHUFUgZnJvbSBwcm9jZXNzaW5nIDI1MDAgaW5zdGFuY2VzIHdoZW4gdGhlIGVudGlyZSBzdHJ1Y3R1cmUgaXMgb3V0IG9mIHZpZXcKICAgICAgICAgICAgdGhpcy5jcm93ZC5mcnVzdHVtQ3VsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jcm93ZC5nZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSA9IG5ldyBUSFJFRS5TcGhlcmUobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksIDE1MCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBkdW1teSA9IG5ldyBUSFJFRS5PYmplY3QzRCgpOwogICAgICAgICAgICBjb25zdCBjb2xvciA9IG5ldyBUSFJFRS5Db2xvcigpOwogICAgICAgICAgICAKLy8gMS4gQ2FsY3VsYXRlIFRvdGFsIENpcmN1bWZlcmVuY2UgZm9yIGRpc3RyaWJ1dGlvbiB0byBlbnN1cmUgYWxsIHRpZXJzIGdldCBwZW9wbGUKICAgICAgICAgICAgbGV0IHRvdGFsQ2lyYyA9IDA7CiAgICAgICAgICAgIGNvbnN0IHRpZXJSYWRpaSA9IFtdOwogICAgICAgICAgICBmb3IobGV0IHQ9MDsgdDx0aGlzLmNvbmZpZy50aWVyczsgdCsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCByTWluID0gdGhpcy5jb25maWcucmFkaXVzICsgKHQgKiAodGhpcy5jb25maWcudGllckRlcHRoICogMC44KSkgKyAyOwogICAgICAgICAgICAgICAgY29uc3QgY2lyYyA9IDIgKiBNYXRoLlBJICogck1pbjsKICAgICAgICAgICAgICAgIHRvdGFsQ2lyYyArPSBjaXJjOwogICAgICAgICAgICAgICAgdGllclJhZGlpLnB1c2goeyByTWluOiByTWluLCBjaXJjOiBjaXJjIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgaWR4ID0gMDsKICAgICAgICAgICAgZm9yKGxldCB0PTA7IHQ8dGhpcy5jb25maWcudGllcnM7IHQrKykgewogICAgICAgICAgICAgICAgY29uc3QgeUJhc2UgPSAodCAqIHRoaXMuY29uZmlnLnRpZXJIZWlnaHQpIC0gMzA7CiAgICAgICAgICAgICAgICBjb25zdCB7IHJNaW4sIGNpcmMgfSA9IHRpZXJSYWRpaVt0XTsKICAgICAgICAgICAgICAgIGNvbnN0IHJNYXggPSByTWluICsgdGhpcy5jb25maWcudGllckRlcHRoIC0gMjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzdHJpYnV0ZSBwcm9wb3J0aW9uYWxseSBzbyB1cHBlciByb3dzIGRvbid0IGdldCBjdXQgb2ZmCiAgICAgICAgICAgICAgICBjb25zdCBjb3VudFBlclRpZXIgPSBNYXRoLmZsb29yKHRoaXMuY29uZmlnLmNyb3dkQ291bnQgKiAoY2lyYyAvIHRvdGFsQ2lyYykpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudFBlclRpZXI7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChpZHggPj0gdGhpcy5jb25maWcuY3Jvd2RDb3VudCkgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSByTWluICsgTWF0aC5yYW5kb20oKSAqIChyTWF4IC0gck1pbik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZHVtbXkucG9zaXRpb24uc2V0KAogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmNvcyhhbmdsZSkgKiByLAogICAgICAgICAgICAgICAgICAgICAgICB5QmFzZSArIDEuMjUsIC8vIENlbnRlciBvZiBxdWFkCiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguc2luKGFuZ2xlKSAqIHIKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyCiAgICAgICAgICAgICAgICAgICAgZHVtbXkubG9va0F0KDAsIHlCYXNlLCAwKTsKICAgICAgICAgICAgICAgICAgICBkdW1teS51cGRhdGVNYXRyaXgoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLmNyb3dkLnNldE1hdHJpeEF0KGlkeCwgZHVtbXkubWF0cml4KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSYW5kb20gVGVhbSBDb2xvcnMgKFNpbXVsYXRpbmcgZmFucykKICAgICAgICAgICAgICAgICAgICBjb25zdCByYW5kID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmFuZCA8IDAuNDUpIGNvbG9yLnNldEhleCgweDAwODhmZik7IC8vIEhvbWUgQmx1ZQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHJhbmQgPCAwLjkpIGNvbG9yLnNldEhleCgweGZmNDQ0NCk7IC8vIEF3YXkgUmVkCiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb2xvci5zZXRIZXgoMHhmZmZmZmYpOyAvLyBOZXV0cmFsL0ZsYXNoCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVmFyeSBicmlnaHRuZXNzIGZvciBkZXB0aAogICAgICAgICAgICAgICAgICAgIGNvbG9yLm11bHRpcGx5U2NhbGFyKDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2Quc2V0Q29sb3JBdChpZHgsIGNvbG9yKTsKICAgICAgICAgICAgICAgICAgICBpZHgrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHRoaXMuY3Jvd2QpOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkSGVyY3VsZWFuUmluZ3MoKSB7CiAgICAgICAgICAgIC8vIE1hc3NpdmUgZmxvYXRpbmcgcmluZ3MgdGhhdCByb3RhdGUgc2xvd2x5CiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4NDQ1NTY2LCAKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuMywKICAgICAgICAgICAgICAgIHdpcmVmcmFtZTogdHJ1ZSAvLyBUZWNoL0hvbG9ncmFwaGljIGZlZWwKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyAxLiBFcXVhdG9yaWFsIFJpbmcgKE1hc3NpdmUpCiAgICAgICAgICAgIGNvbnN0IGdlbzEgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxMTAsIDEsIDE2LCAxMDApOwogICAgICAgICAgICBjb25zdCByaW5nMSA9IG5ldyBUSFJFRS5NZXNoKGdlbzEsIG1hdCk7CiAgICAgICAgICAgIHJpbmcxLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmcxKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzEsIGF4aXM6ICd6Jywgc3BlZWQ6IDAuMDEgfSk7CgogICAgICAgICAgICAvLyAyLiBUaWx0ZWQgUmluZwogICAgICAgICAgICBjb25zdCBnZW8yID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkoMTMwLCAyLCAxNiwgMTAwKTsKICAgICAgICAgICAgY29uc3QgcmluZzIgPSBuZXcgVEhSRUUuTWVzaChnZW8yLCBtYXQpOwogICAgICAgICAgICByaW5nMi5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDM7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW5nMik7CiAgICAgICAgICAgIHRoaXMucmluZ3MucHVzaCh7IG1lc2g6IHJpbmcyLCBheGlzOiAneScsIHNwZWVkOiAtMC4wMDggfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBWZXJ0aWNhbCBSaW5nCiAgICAgICAgICAgIGNvbnN0IGdlbzMgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxNTAsIDMsIDE2LCAxMDApOwpjb25zdCByaW5nMyA9IG5ldyBUSFJFRS5NZXNoKGdlbzMsIG1hdCk7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW5nMyk7CiAgICAgICAgICAgIHRoaXMucmluZ3MucHVzaCh7IG1lc2g6IHJpbmczLCBheGlzOiAneScsIHNwZWVkOiAwLjAwNSB9KTsKICAgICAgICB9CgogICAgICAgIF9idWlsZFN0YWRpdW1MaWdodHMoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gMTY7IC8vIE51bWJlciBvZiBsaWdodHMgYXJvdW5kIHRoZSBlcXVhdG9yCiAgICAgICAgICAgIGNvbnN0IHJhZGl1cyA9IDM2OyAvLyBKdXN0IG91dHNpZGUgdGhlIGFyZW5hIGJvdW5kYXJ5ICgzMikKICAgICAgICAgICAgY29uc3QgeVBvcyA9IDA7IC8vIE1pZGRsZSBvZiB0aGUgc3BoZXJlCiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBsaWdodEdlbyA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeSgwLjQsIDgsIDgpOwogICAgICAgICAgICBjb25zdCBsaWdodE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmZmZmZiB9KTsKCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gKGkgLyBjb3VudCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLmNvcyhhbmdsZSkgKiByYWRpdXM7CiAgICAgICAgICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4oYW5nbGUpICogcmFkaXVzOwoKICAgICAgICAgICAgICAgIC8vIDEuIFBoeXNpY2FsIEZpeHR1cmUgKFRoZSBidWxiKQogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGxpZ2h0R2VvLCBsaWdodE1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnNldCh4LCB5UG9zLCB6KTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBWaXN1YWwgR2xvdyAoRmxhcmUpCiAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSBuZXcgVEhSRUUuU3ByaXRlKF9nbG93TWF0ZXJpYWwpOwovLyAyLiBWaXN1YWwgR2xvdyAoRmxhcmUpCgogICAgICAgICAgICAgICAgc3ByaXRlLnBvc2l0aW9uLnNldCh4LCB5UG9zLCB6KTsKICAgICAgICAgICAgICAgIHNwcml0ZS5zY2FsZS5zZXQoOCwgOCwgMSk7IC8vIExhcmdlIGdsb3cKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChzcHJpdGUpOwogICAgICAgICAgICAgICAgdGhpcy5saWdodFNwcml0ZXMucHVzaChzcHJpdGUpOwoKLy8gMy4gQWN0dWFsIFBvaW50IExpZ2h0IC0gUkVNT1ZFRCBmb3Igb3B0aW1pemF0aW9uCiAgICAgICAgICAgICAgICAvLyBTaW5jZSB3ZSB1c2UgTWVzaEJhc2ljTWF0ZXJpYWwgKFVubGl0KSwgcmVhbCBsaWdodHMgd2FzdGUgQ1BVL0dQVSByZXNvdXJjZXMuCiAgICAgICAgICAgICAgICAvLyBUaGUgc3ByaXRlIGdsb3cgYWJvdmUgcHJvdmlkZXMgdGhlIHZpc3VhbCBlZmZlY3QuCiAgICAgICAgICAgIH0KICAgICAgICB9CnVwZGF0ZShkdCkgewogICAgICAgICAgICAvLyBBbmltYXRlIFJpbmdzCiAgICAgICAgICAgIHRoaXMucmluZ3MuZm9yRWFjaChyID0+IHsKICAgICAgICAgICAgICAgIGlmIChyLm1lc2ggJiYgci5heGlzKSB7CiAgICAgICAgICAgICAgICAgICAgci5tZXNoLnJvdGF0aW9uW3IuYXhpc10gKz0gci5zcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBDcm93ZCBTaGFkZXIKICAgICAgICAgICAgaWYgKHRoaXMuY3Jvd2RVbmlmb3JtcykgewogICAgICAgICAgICAgICAgdGhpcy5jcm93ZFVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgTGlnaHQgUG9wcyAoQ2luZW1hdGljKQogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcy5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICAgICAgaWYgKHMudmlzaWJsZSAmJiBzLnNjYWxlLnggPiA4LjApIHsKICAgICAgICAgICAgICAgICAgICAvLyBEZWNheSBwb3AgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgcy5zY2FsZS54IC09IGR0ICogMzAuMDsKICAgICAgICAgICAgICAgICAgICBzLnNjYWxlLnkgLT0gZHQgKiAzMC4wOwogICAgICAgICAgICAgICAgICAgIGlmIChzLnNjYWxlLnggPCA4LjApIHMuc2NhbGUuc2V0KDgsIDgsIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIHNldEFsbExpZ2h0cyh2aXNpYmxlKSB7CiAgICAgICAgICAgIHRoaXMubGlnaHRTcHJpdGVzLmZvckVhY2gocyA9PiB7CiAgICAgICAgICAgICAgICBzLnZpc2libGUgPSB2aXNpYmxlOwogICAgICAgICAgICAgICAgcy5zY2FsZS5zZXQoOCwgOCwgMSk7IC8vIFJlc2V0IHNjYWxlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgdHVybk9uTGlnaHQoaW5kZXgpIHsKICAgICAgICAgICAgaWYgKHRoaXMubGlnaHRTcHJpdGVzW2luZGV4XSkgewogICAgICAgICAgICAgICAgY29uc3QgcyA9IHRoaXMubGlnaHRTcHJpdGVzW2luZGV4XTsKICAgICAgICAgICAgICAgIHMudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBzLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICBzLnNjYWxlLnNldCgyMCwgMjAsIDEpOyAvLyBQb3AgZWZmZWN0CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguU3RhZGl1bSA9IFN0YWRpdW07Cn0pKCk7"}}</script></head>
<body>
<div id="game-container">
<img id="screen-overlay-gif" src="https://i.postimg.cc/htrkgHTr/grok-video-2026-01-09-06-22-47-ezgif-com-resize.gif">
        <div id="ui-layer">
            <!-- Cinematic Letterboxing -->
            <div id="cinematic-bars">
                <div class="bar top"></div>
                <div class="bar bottom"></div>
            </div>

            <!-- Tech Copy / Event Flash System -->
            <div id="tech-flash-overlay">
                <div class="flash-line top"></div>
                <div class="tech-content-wrapper">
                    <div class="tech-text">TECHCOPY!</div>
                    <div class="tech-sub-text"></div>
                    <div class="tech-timer-track">
                        <div class="tech-timer-fill"></div>
                    </div>
                </div>
                <div class="flash-line bottom"></div>
            </div>

            <div id="loading">Loading Blitzball...</div>

            <!-- Top HUD -->
            <div id="hud-top">
                <div class="team-wing home">
                    <div class="crystal-bg"></div>
                    <div class="team-data">
                        <div class="team-name">BESAID</div>
                        <div class="team-sub">AUROCHS</div>
                    </div>
                    <div class="score-box">
                        <div id="score-player" class="score-digit">0</div>
                    </div>
                </div>

                <div class="timer-complex">
                    <div class="timer-crystal-ring"></div>
                    <div class="timer-content">
                        <div id="half-indicator">1st</div>
                        <div id="timer-display">00:00</div>
                    </div>
                </div>

                <div class="team-wing away">
                    <div class="score-box">
                        <div id="score-cpu" class="score-digit">0</div>
                    </div>
                    <div class="team-data">
                        <div class="team-name">LUCA</div>
                        <div class="team-sub">GOERS</div>
                    </div>
                    <div class="crystal-bg"></div>
                </div>
            </div>

            <!-- NEW: Goal Distance Indicator -->
            <div id="goal-distance-container">
                <div class="distance-label">GOAL</div>
                <div id="goal-distance">0m</div>
            </div>

            <!-- Mini-Map -->
            <div id="minimap-container">
                <div class="radar-rim"></div>
                <div id="minimap"></div>
                <div class="radar-label">SPHERE POOL</div>
            </div>

            <!-- Player Status Panel -->
            <div id="player-status-panel">
                <div class="char-name">TIDUS</div>
                <div class="hp-gauge-container">
                    <div class="hp-label">HP</div>
                    <div class="hp-bar-track">
                        <div class="hp-bar-fill" style="width: 100%;"></div>
                    </div>
                    <div class="hp-value">120/120</div>
                </div>
                <div class="tech-gauge-container">
                    <div class="tech-label">EXP</div>
                    <div class="tech-bar-track">
                        <div class="tech-bar-fill" style="width: 45%;"></div>
                    </div>
                </div>
            </div>

            <!-- NEW: Charge Power Meter -->
            <div id="charge-meter-container">
                <div class="charge-label">POWER</div>
                <div class="charge-meter-track">
                    <div id="charge-meter-fill"></div>
                </div>
                <div class="charge-hint">RELEASE!</div>
            </div>

            <!-- Announcement -->
            <div id="announcement">GOAL!</div>

            <!-- Controls -->
            <!-- Movement Joystick (Left) -->
            <div id="joystick-hit-zone"></div>
            <div id="joystick-visual-container">
                <div id="joystick-base"></div>
                <div id="joystick-knob"></div>
            </div>

            <!-- NEW: Aim Joystick (Right) -->
            <div id="aim-joystick-zone"></div>
            <div id="aim-joystick-visual">
                <div id="aim-joystick-base"></div>
                <div id="aim-joystick-knob"></div>
            </div>

            <div id="camera-zone"></div>

            <!-- Action Command -->
            <div id="action-container">
                <div class="command-menu-bg"></div>
                <div class="command-ring"></div>
                <div id="action-label">COMMAND</div>
                <div id="action-buttons-wrapper" style="position: relative; width: 100px; height: 100px;">
                    <div id="action-button">
                        <div class="limit-ring"></div>
                        <span class="btn-text">WAIT</span>
                        <div class="btn-glare"></div>
                    </div>
                    <div id="pass-button">
                        <div class="limit-ring"></div>
                        <span class="btn-text">PASS</span>
                        <div class="btn-glare"></div>
                    </div>
                </div>
            </div>

            <!-- NEW: Tackle Button -->
            <div id="tackle-button">
                <span class="btn-text">TACKLE</span>
                <div class="btn-glare"></div>
            </div>

            <!-- Auto/Demo Toggle -->
            <div id="auto-toggle" class="glass-btn">MANUAL</div>

            <!-- NEW: Settings Button -->
            <div id="settings-button" class="glass-btn">SETTINGS</div>

            <div id="practice-restore-btn">MENU</div>
<div id="controls-hint">WASD or Drag to Swim | Swipe to Dash</div>

            <!-- Gesture Hint Overlay -->
            <div id="gesture-hint">
                <svg width="200" height="300" viewBox="0 0 200 300" style="overflow: visible;">
                    <path class="curve-arrow" d="M100 250 Q 180 150 100 50" stroke="#00ffff" stroke-width="6" fill="none" stroke-linecap="round" stroke-dasharray="15 15"></path>
                    <polygon points="100,40 115,65 85,65" fill="#00ffff" filter="drop-shadow(0 0 5px #00ffff)"></polygon>
                </svg>
                <div class="gesture-text">SWIPE CURVE</div>
                <div class="gesture-hand"></div>
<div class="gesture-hand"></div>
            </div>

            <!-- Offscreen Player Indicator -->
            <div id="offscreen-indicator">
                <div class="arrow"></div>
            </div>

            <!-- NEW: Settings Panel -->
            <!-- NEW: Settings Panel -->
<div id="settings-panel" style="display: none;">
                <div class="settings-header">
                    <span>SETTINGS</span>
                    <button id="settings-close">X</button>
                </div>
                <div class="settings-content">
                    <div class="setting-row">
                        <label>Sensitivity</label>
                        <input type="range" id="sensitivity-slider" min="50" max="150" value="100">
                    </div>
                    <div class="setting-row">
                        <label>Aim Assist</label>
                        <input type="checkbox" id="aim-assist-toggle" checked="">
                    </div>
                    <div class="setting-row">
                        <label>Camera Shake</label>
                        <input type="checkbox" id="shake-toggle" checked="">
                    </div>
                    <div class="setting-row">
                        <label>Music Volume</label>
                        <input type="range" id="volume-slider" min="0" max="100" value="50">
                    </div>
                    <div class="setting-row" style="justify-content: center; margin-top: 20px; background: transparent;">
                        <button id="exit-to-menu-btn" class="glass-btn" style="width: 100%; border-color: #ff4444; color: #ff4444;">EXIT TO MENU</button>
                    </div>
                </div>
            </div>


            <!-- Practice Overlay -->
            <div id="practice-overlay">
                <div class="practice-panel">
                    <div class="panel-header">
                        <div class="panel-minimize-btn" id="p-minimize">-</div>
                        <div class="panel-title-group">
                            <span class="panel-title">BLITZ TRAINING</span>
                            <span class="panel-subtitle">SPHERE POOL SIMULATION</span>
                        </div>
                        <div class="panel-deco-line"></div>
                    </div>

                    <div class="panel-content">
                        <div class="panel-section">
                            <div class="section-label">DRILL SELECTION</div>
                            <div class="drill-list">
<div class="drill-btn active" data-drill="free">
                                    <span class="icon"></span> FREE ROAM
                                </div>
                                <div class="drill-btn" data-drill="ball_lab">
                                    <span class="icon"></span> BALL LAB
                                </div>
                                <div class="drill-btn" data-drill="shooting">
                                    <span class="icon"></span> SHOOTING
                                </div>
                                <div class="drill-btn" data-drill="passing">
                                    <span class="icon"></span> PASSING
                                </div>
<div class="drill-btn" data-drill="defense">
                                    <span class="icon"></span> DEFENSE
                                </div>
                                <div class="drill-btn" data-drill="curve">
<span class="icon"></span> CURVE BALL
                                </div>
                                <div class="drill-btn" data-drill="rapid_fire">
                                    <span class="icon"></span> RAPID FIRE
                                </div>
                            </div>
                        </div>

                        <div class="panel-section">
                            <div class="section-label">SYSTEM OVERRIDE</div>
                            <div class="option-list">
<div class="option-toggle active" id="opt-inf-stat">
                                    <span class="checkbox"></span> INF STATS
                                </div>
                                <div class="option-toggle active" id="opt-ai-dummy">
                                    <span class="checkbox"></span> AI DUMMY
                                </div>
                                <div class="option-toggle" id="opt-hitboxes">
                                    <span class="checkbox"></span> HITBOXES
                                </div>
                            </div>

                            <div class="section-label" style="margin-top: 15px;">COMMANDS</div>
                            <div class="action-btn" id="p-reset-ball">RESET BALL (R)</div>
                            <div class="action-btn" id="p-exit">EXIT PRACTICE</div>
                        </div>
                    </div>

                    <div class="panel-footer">
                        <div id="drill-instruction">SELECT A DRILL TO BEGIN SIMULATION</div>
                        <div id="drill-score">SCORE: 0</div>
                    </div>
                </div>
            </div>

            <!-- Main Menu -->
            <div id="main-menu" class="active">
                <div class="menu-bg-overlay"></div>
                <div class="ffx-logo-container">
                    <div class="ffx-logo-main">BLITZBALL</div>
                    <div class="ffx-logo-sub">REMASTERED</div>
                </div>
                <div class="menu-options">
                    <div class="menu-item" data-action="normal">
                        <span class="cursor">&gt;</span>
                        <span class="label">NORMAL MATCH</span>
                    </div>
                    <div class="menu-item" data-action="practice">
                        <span class="cursor">&gt;</span>
                        <span class="label">PRACTICE</span>
                    </div>
                    <div class="menu-item" data-action="ball_lab">
                        <span class="cursor">&gt;</span>
                        <span class="label">BALL LAB</span>
                    </div>
                    <div class="menu-item" data-action="options">
                        <span class="cursor">&gt;</span>
                        <span class="label">OPTIONS</span>
                    </div>
                </div>
                <div class="menu-footer">FLUX ENGINE v2.0</div>
</div>

            <!-- NEW: End Game Menu -->
            <div id="end-game-menu">
                <div class="end-bg-layer"></div>
                <div class="end-content">
                    <div class="result-header">
                        <div class="result-title" id="end-result-title">VICTORY</div>
                        <div class="result-subtitle">MATCH COMPLETE</div>
                    </div>
                    
                    <div class="final-score-container">
                        <div class="final-team home">
                            <div class="final-score-digit" id="end-score-home">3</div>
                            <div class="final-team-name">BESAID</div>
                        </div>
                        <div class="final-vs">
                            <div class="vs-line"></div>
                            <span>VS</span>
                            <div class="vs-line"></div>
                        </div>
                        <div class="final-team away">
                            <div class="final-score-digit" id="end-score-away">1</div>
                            <div class="final-team-name">LUCA</div>
                        </div>
                    </div>

                    <div class="end-options">
                        <div class="menu-item" id="end-btn-rematch">
                            <span class="cursor">&gt;</span>
                            <span class="label">REMATCH</span>
                        </div>
                        <div class="menu-item" id="end-btn-exit">
                            <span class="cursor">&gt;</span>
                            <span class="label">EXIT TO MENU</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Scripts -->
    <script>(function() {
    window.flux = window.flux || {};

    const _loader = new THREE.GLTFLoader();

    // Helper to convert a single material to Basic (Unlit/PSX)
// Helper to convert a single material to Basic (Unlit/PSX)
    function convertMaterial(oldMat, isSkinned) {
        
        // Preserve texture: Check map, then emissiveMap
        const texture = oldMat.map || oldMat.emissiveMap || null;

        // FORCE OPAQUE VISIBILITY
        // We override transparency to ensure models are always visible (fixing the "invisible model" issue).
        const params = {
            map: texture,
            color: 0xffffff,        // FORCE WHITE: Remove any tint from GLTF
            skinning: isSkinned,
            side: THREE.DoubleSide, // Render both sides to prevent backface culling invisibility
            transparent: false,     // Disable transparency to prevent sorting issues
            opacity: 1.0,           // Force full opacity
            alphaTest: 0.5,         // Strong alpha test for cutouts (nets/grates)
            vertexColors: oldMat.vertexColors, // Preserve vertex colors
            depthTest: true,
            depthWrite: true,       // Force depth write so it occludes properly
            fog: true
        };

        // Ensure texture encoding is correct for Three.js
        if (params.map) params.map.encoding = THREE.sRGBEncoding;

        return new THREE.MeshBasicMaterial(params);
    }

    window.flux.AssetLoader = {
        loadModel: function(url, onLoad, onProgress, onError) {
            _loader.load(url, function(gltf) {
                gltf.scene.traverse(function(node) {
                    if (node.isMesh) {
node.castShadow = false;
                        node.receiveShadow = false;
                        node.frustumCulled = false; // Prevent invisibility
                        if (node.material) {
                            if (Array.isArray(node.material)) {
                                node.material = node.material.map(m => convertMaterial(m, node.isSkinnedMesh));
                            } else {
                                node.material = convertMaterial(node.material, node.isSkinnedMesh);
                            }
                        }
                    }
                });
                if (onLoad) onLoad(gltf);
            }, onProgress, onError);
        }
    };
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Ball Lab / DevTools: throw & curve mapping knobs
    // (Defaults match current feel; DevTools can tweak at runtime.)
    window.flux.ThrowConfig = window.flux.ThrowConfig || {
        SWIPE_MIN_PX: 20,
        AIM_DX_SCALE: 1.0,
        AIM_DY_SCALE: 1.0,

        POWER_BASE: 1.0,
        POWER_RANGE: 0.8,          // Base multiplier = POWER_BASE + ratio*POWER_RANGE
        POWER_MAX_BONUS_RATIO: 0.95,
        POWER_MAX_MULTIPLIER: 2.5,

        CURVE_ENABLED: true,
        CURVE_INTENSITY_THRESHOLD: 0.25,
        CURVE_SPIN_SCALE: 1000.0,
        CURVE_SPEED_MULT: 1.5,
        CURVE_SPIN_CAP: 1500.0,
        CURVE_PERFECT_SPIN: 500.0
    };

// Reusable math objects
const _pVec = new THREE.Vector3();
    const _pVec2 = new THREE.Vector3();
    const _pQuat = new THREE.Quaternion();
    const _pQuat2 = new THREE.Quaternion();
    const _pTargetQuat = new THREE.Quaternion();
    const _pEuler = new THREE.Euler();
    const _pAxisY = new THREE.Vector3(0, 1, 0);
    const _pAxisZ = new THREE.Vector3(0, 0, 1);
    const _pInvQuat = new THREE.Quaternion();
    const _pTmpQuat = new THREE.Quaternion();
    const _pTmpEuler = new THREE.Euler();


class Player {
        constructor(scene, role = 'MF') {
            this.scene = scene;
            this.role = role;
            this.team = null; // Assigned by Team.addPlayer
            this.homePosition = new THREE.Vector3();

            this.mesh = null;
            this.mixer = null;
            this.actions = {};
            this.activeAction = null;
            this.state = 'idle';
                        this._animLocked = false;
            this._lockedState = null;
            this._lastLocomotion = 'idle';
this.inputVector = new THREE.Vector3(0, 0, 0);

            // Physics (Drift/Inertia Model)
            this.velocity = new THREE.Vector3(0, 0, 0);
            this.acceleration = 12.0;
            this.drag = 3.0;
            this.maxSpeed = 8.0;
            // Bone reference for holding ball
            this.handBone = null;
// Procedural animation bone refs (filled in setMesh)
this.bones = {
    hips: null,
    spine: null,
    chest: null,
    neck: null,
    head: null,
    rUpperArm: null,
    rForeArm: null,
    rHand: null,
    lUpperArm: null,
    lForeArm: null,
    lHand: null
};
this._boneBaseQuats = null; // Optional future use
this._procAnimTime = 0;
this._smoothedSpeed = 0;
this._movingLatch = false;

this.canCatch = true;
            this.catchCooldown = 0; // Replaces setTimeout for safety

            // Blitzball Stats
            this.stats = {
                HP: 100,
                maxHP: 100,
                EN: 30,
                AT: 10,
                PA: 15,
                BL: 10,
                SH: 15,
                CA: 10,
                SP: 60
            };

            // Leveling System
            this.level = 1;
            this.exp = 0;
            this.nextLevelExp = 100;

            // Status Effects & Techniques
            this.status = {
                venom: 0,
                nap: 0,
                wither: { PA: 0, SH: 0, AT: 0, BL: 0, CA: 0, SP: 0 }
            };

            this.marking = null;
            this.learnedTechs = [];

            this.techs = {
                tackle: null,
                shoot: null,
                pass: null,
                passive: null
            };

            // Visuals
            this.baseColorHex = 0xffffff;
            this.originalMaterials = [];
            this.auraMesh = null;
            this.rotationOffset = 0;
this.baseScale = 1.17; // Increased ~8%

            // Real-time Stats
            this.currentEN = this.stats.EN;
this.tackleRadius = 2.0; // Reduced from 2.5 to reduce swarm lock

            this.speed = 4.0;
            this._updateDerivedStats();

            this.hasBall = false;
            this.isThrowing = false;

            // Dash State
            this.isDashing = false;
            this.dashTime = 0;
            this.dashTotalTime = 0.5;
this.dashCooldown = 0;
            this.dashVec = new THREE.Vector3();

            // Feedback Accumulators
            this._accumulatedDamage = 0;
            this._damageTimer = 0;

            // HP Bar
            this.hpBar = null;
            this.hpBarFill = null;

            // Gameplay Flow Timers
            this.stunTimer = 0;
            this.immunityTimer = 0;

            // Banking & Verticality
            this.bankingAmount = 0;
            this.targetY = 0;

            // Encounter System
            this.isEngaged = false;
            this.clashTimer = 0;

            this.encounterTimer = 0; // Track duration of current engagement
            // Charge Mechanic
            this.isCharging = false;
            this.chargeTime = 0;
            this.maxChargeTime = 1.5;

            // FIXED: Improved Rotation State with hysteresis
            this.currentYaw = 0;
            this.targetYaw = 0;
            this.lastValidYaw = 0; // Store last known good yaw for deadzone handling
            this.pitchAmount = 0;
            this.bankingAmount = 0;
            this.facingDeadzone = 0.3; // Minimum input/velocity magnitude to update facing

            // Particle Emission Timers
            this._particleTimers = {
                venom: 0,
                nap: 0,
                wither: 0
            };

            // DevTools Flags
            this.isGodMode = false;

            // Pass Target Indicator
// Pass Target Indicator
            this.passTargetIndicator = null;
            
            // Bubble Trail Timer
            this._bubbleTimer = 0;

this._dashParticleTimer = 0;
            this.struggleIntensity = 0; // Continuous pressure factor (0.0 to 1.0)
        }

        syncRotation() {
            if (!this.mesh) return;
            const euler = new THREE.Euler().setFromQuaternion(this.mesh.quaternion, 'YXZ');
            this.currentYaw = euler.y - this.rotationOffset;
            this.targetYaw = this.currentYaw;
            this.lastValidYaw = this.currentYaw;
            this.bankingAmount = 0;
            this.pitchAmount = 0;
        }

        getStat(name) {
            let val = this.stats[name];
            if (this.status.wither[name] > 0) {
                val *= 0.5;
            }
            return val;
        }

        applyStatus(type, duration, subType = null) {
            if (type === 'venom') {
                const wasActive = this.status.venom > 1.0;
                this.status.venom = Math.max(this.status.venom, duration);

                if (!wasActive) {
                    console.log(`${this.role} poisoned!`);
                    if (window.flux.gameInstance.floatingText)
                        window.flux.gameInstance.floatingText.spawn("POISON", this.mesh.position, "status");
                }
            } else if (type === 'nap') {
                const wasActive = this.status.nap > 1.0;
                this.status.nap = Math.max(this.status.nap, duration);

                if (!wasActive) {
                    if (this.hasBall) this.fumble();
                    console.log(`${this.role} fell asleep!`);
                    if (window.flux.gameInstance.floatingText)
                        window.flux.gameInstance.floatingText.spawn("SLEEP", this.mesh.position, "status");
                }
            } else if (type === 'wither' && subType) {
                const currentVal = this.status.wither[subType] || 0;
                const wasActive = currentVal > 1.0;
                this.status.wither[subType] = Math.max(currentVal, duration);

                if (!wasActive) {
                    console.log(`${this.role} withered ${subType}!`);
                    if (window.flux.gameInstance.floatingText)
                        window.flux.gameInstance.floatingText.spawn(`WITHER ${subType}`, this.mesh.position, "status");
                }
            }
        }

        _updateDerivedStats() {
            const sp = this.getStat('SP');
            this.maxSpeed = 5.0 + (sp / 15.0);
            this.currentEN = this.getStat('EN');
        }

setMesh(sourceMesh, animations) {
            this.mesh = sourceMesh;
            this.scene.add(this.mesh);
            this._createHPBar();
            this._createAura();
            this._createPassTargetIndicator();

            // Custom Character Scaling
            if (this.characterName) {
                if (this.characterName.includes('Tidus')) this.baseScale = 1.6;
                else if (this.characterName.includes('Wakka')) this.baseScale = 1.4;
            }

            this.mesh.scale.setScalar(this.baseScale);

            this.mesh.traverse((node) => {
                if (node.isMesh && node.material) {
                    const convertOne = (mat) => {
                        const m = new THREE.MeshBasicMaterial({
                            map: mat.map || null,
                            color: new THREE.Color(0xffffff), // FORCE WHITE: Ignore source color
                            transparent: !!mat.transparent,
                            opacity: (mat.opacity !== undefined ? mat.opacity : 1),
                            alphaTest: (mat.alphaTest !== undefined ? mat.alphaTest : 0),
                            side: mat.side,
                            depthTest: mat.depthTest,
                            depthWrite: mat.depthWrite,
                            fog: true,
                            skinning: !!node.isSkinnedMesh
                        });
                        this.originalMaterials.push({ material: m, baseColor: m.color.clone() });
                        return m;
                    };
                    node.material = Array.isArray(node.material)
                        ? node.material.map(convertOne)
                        : convertOne(node.material);
                }

                if (node.isBone) {
                    const name = (node.name || '').toLowerCase();

                    // Core spine/head chain (Mixamo-friendly)
                    if (!this.bones.hips && name.includes('hips')) this.bones.hips = node;
                    if (!this.bones.spine && name.includes('spine') && !name.includes('spine2') && !name.includes('spine_2')) this.bones.spine = node;
                    if (!this.bones.chest && (name.includes('chest') || name.includes('spine2') || name.includes('spine_2'))) this.bones.chest = node;
                    if (!this.bones.neck && name.includes('neck')) this.bones.neck = node;
                    if (!this.bones.head && name.includes('head')) this.bones.head = node;

                    const isRight = name.includes('right') || name.endsWith('r') || name.includes('_r') || name.includes('.r');
                    const isLeft  = name.includes('left')  || name.endsWith('l') || name.includes('_l') || name.includes('.l');

                    // Arms/hands (Mixamo: mixamorigRightArm/RightForeArm/RightHand)
                    if (!this.bones.rUpperArm && (name.includes('rightarm') || (isRight && name.includes('upperarm')))) this.bones.rUpperArm = node;
                    if (!this.bones.rForeArm && (name.includes('rightforearm') || (isRight && name.includes('forearm')))) this.bones.rForeArm = node;
                    if (!this.bones.rHand && ((name.includes('hand') && isRight) || name.includes('righthand'))) this.bones.rHand = node;

                    if (!this.bones.lUpperArm && (name.includes('leftarm') || (isLeft && name.includes('upperarm')))) this.bones.lUpperArm = node;
                    if (!this.bones.lForeArm && (name.includes('leftforearm') || (isLeft && name.includes('forearm')))) this.bones.lForeArm = node;
                    if (!this.bones.lHand && ((name.includes('hand') && isLeft) || name.includes('lefthand'))) this.bones.lHand = node;

                    // Back-compat: ball attachment uses handBone
                    if (!this.handBone && this.bones.rHand) this.handBone = this.bones.rHand;
                }
            });

            this.mixer = new THREE.AnimationMixer(this.mesh);

            if (animations) {
                const _normClipName = (s) => (s || '')
                    .toLowerCase()
                    .replace(/[_\-]+/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();

                // Helper to strip leg tracks from action clips
                const _stripLegs = (clip) => {
                    const tracks = [];
                    clip.tracks.forEach(t => {
                        // Regex to match leg bones (Mixamo style: RightUpLeg, RightLeg, RightFoot, RightToeBase)
                        // Also generic "Leg", "Foot"
                        if (!t.name.match(/(UpLeg|Leg|Foot|Toe)/i)) {
                            tracks.push(t);
                        }
                    });
                    clip.tracks = tracks;
                    return clip;
                };

                animations.forEach((clip) => {
                    const name = _normClipName(clip.name);
                    const has = (re) => re.test(name);
                    
                    let isLocomotion = false;
                    let actionKey = null;

                    // --- Core locomotion ---
                    if (has(/tread|treading|idle|float/)) {
                        actionKey = 'idle';
                        isLocomotion = true;
                    } else if (has(/dash|sprint|burst|fast\s*swim|swim\s*fast/)) {
                        actionKey = 'dash';
                        isLocomotion = true;
                    } else if (has(/swim|freestyle|crawl/)) {
                        actionKey = 'swim';
                        isLocomotion = true;
                    
                    // --- Throwing (pass/shot variants if present) ---
                    } else if (has(/throw|toss|pitch/)) {
                        if (has(/shoot|shot|goal/)) actionKey = 'throw_shot';
                        else if (has(/pass/)) actionKey = 'throw_pass';
                        else actionKey = 'throw';

                    // --- Catching (jump/air variants if present) ---
                    } else if (has(/catch|receive|grab|intercept/)) {
                        if (has(/jump|leap|air|dive/)) actionKey = 'catch_jump';
                        else actionKey = 'catch';

                    // --- Hit / React ---
                    } else if (has(/react|hit|hurt|damage|stagger|knock/)) {
                        actionKey = 'react';

                    // --- Optional states ---
                    } else if (has(/charge|aim|ready|windup|hold/)) {
                        actionKey = 'charge';
                    } else if (has(/tackle|check|ram/)) {
                        actionKey = 'tackle';
                    } else if (has(/block|save/)) {
                        actionKey = 'block';
                    } else if (has(/celebrate|victory|cheer/)) {
                        actionKey = 'celebrate';
                    } else {
                        actionKey = clip.name;
                    }

                    // Strip legs from non-locomotion clips to allow treading water overlay
                    if (!isLocomotion && actionKey) {
                        _stripLegs(clip);
                    }

                    if (actionKey) {
                        this.actions[actionKey] = this.mixer.clipAction(clip);
                    }
                });
            }

            // Start default locomotion
            if (this.actions['idle']) {
                this.playLocomotion('idle');
            } else {
                // Fallback
                const first = Object.values(this.actions)[0];
                if(first) first.play();
            }

            // One-shot animation listener
            if (this.mixer) {
                this.mixer.addEventListener('finished', (e) => {
                    if (!this._animLocked) return;
                    if (!e || !e.action) return;
                    
                    // Check if the finished action is our current one-shot
                    if (e.action === this.activeOneShot) {
                        this._animLocked = false;
                        this._lockedState = null;
                        this.activeOneShot = null;

                        // Return to locomotion updates
                        if (!this.isThrowing) {
                            this._updateLocomotionAnim(0.15);
                        }
                    }
                });
            }
        }

        // New method for base layer (legs/body movement)
        playLocomotion(actionName, duration = 0.5) {
            const newAction = this.actions[actionName];
            if (!newAction || newAction === this.activeLocomotion) return;

            if (this.activeLocomotion) {
                this.activeLocomotion.fadeOut(duration);
            }

            newAction.reset();
            newAction.fadeIn(duration);
            newAction.play();
            this.activeLocomotion = newAction;
            this._lastLocomotion = actionName;
        }

        // Overhauled play method to handle layering
        play(actionName, duration = 0.5) {
            // If it's a locomotion state, route to playLocomotion
            if (['idle', 'swim', 'dash'].includes(actionName)) {
                this.playLocomotion(actionName, duration);
                return;
            }

            // Otherwise treat as an action layer
            const newAction = this.actions[actionName];
            if (!newAction) return;

            // If we have an active one-shot, fade it out
            if (this.activeOneShot && this.activeOneShot !== newAction) {
                this.activeOneShot.fadeOut(0.1);
            }

            newAction.reset();
            newAction.fadeIn(0.1); // Fast transition for actions
            newAction.play();
            
            this.activeOneShot = newAction;
            this.state = actionName;
        }

        _updateLocomotionAnim(duration = 0.2) {
            // Note: We NO LONGER check _animLocked here.
            // Locomotion should update continuously based on speed, 
            // running underneath the upper body action.
            
            const vx = this.velocity ? this.velocity.x : 0;
            const vz = this.velocity ? this.velocity.z : 0;
            const speed = Math.sqrt(vx * vx + vz * vz);

            // Smooth speed
            const smoothK = 1.0 - Math.pow(0.001, duration);
            this._smoothedSpeed += (speed - this._smoothedSpeed) * smoothK;

            const speedNorm = (this.maxSpeed > 0.0001) ? THREE.MathUtils.clamp(this._smoothedSpeed / this.maxSpeed, 0, 1) : 0;

            // Hysteresis
            const enterMove = 0.18;
            const exitMove = 0.10;

            const inputMoving = this.inputVector && this.inputVector.lengthSq() > 0.06;
            const velMoving = this._smoothedSpeed > (this._movingLatch ? exitMove : enterMove);

            this._movingLatch = inputMoving || velMoving;

            let target = this._movingLatch ? 'swim' : 'idle';
            if (this._movingLatch && this.isDashing && this.actions['dash']) target = 'dash';

            // Update playback rate
            const applyRate = (key) => {
                const a = this.actions[key];
                if (!a) return;
                if (key === 'swim') a.timeScale = THREE.MathUtils.lerp(0.85, 1.70, speedNorm);
                else if (key === 'dash') a.timeScale = THREE.MathUtils.lerp(1.10, 2.20, speedNorm);
                else if (key === 'idle') a.timeScale = THREE.MathUtils.lerp(0.95, 1.05, speedNorm);
            };

            applyRate(target);

            if (this._lastLocomotion !== target) {
                const a = this.actions[target];
                if (a) {
                    try { a.setLoop(THREE.LoopRepeat); } catch (_) {}
                    a.clampWhenFinished = false;
                }
                this.playLocomotion(target, duration);
            }
        }

        playOneShot(actionName, duration = 0.1, opts = {}) {
            const a = this.actions[actionName];
            if (!a) return false;

            this._animLocked = true;
            this._lockedState = actionName;

            try {
                a.reset();
                a.setLoop(THREE.LoopOnce);
                a.clampWhenFinished = true;
                a.timeScale = (opts.timeScale !== undefined ? opts.timeScale : 1.0);
            } catch (_) {}

            // Use the new play method which handles layering
            this.play(actionName, duration);
            return true;
        }
        setInput(x, z) {
            if (this.status.nap > 0) {
                this.inputVector.set(0, 0, 0);
                return;
            }
            this.inputVector.set(x, 0, z);
        }

receiveBall() {
            this.canCatch = false;
            
            // CRITICAL FIX: Reset states that might prevent shooting
            this.isThrowing = false;
            this.isCharging = false;
            this._hideChargeUI();

            if (this.status.nap > 0) {
                this.status.nap = 0;
            }

            this.hasBall = true;
            this.immunityTimer = 2.0;

            const ball = window.flux.gameInstance.entities.ball;
            if (ball && ball.lastHolder && ball.lastHolder.team === this.team && ball.lastHolder !== this) {
                ball.lastHolder.gainExp(2);
                this.gainExp(1);
            }

            const ballY = (this.ballRef && this.ballRef.mesh) ? this.ballRef.mesh.position.y : 0;
            const catchKey = (ballY > 0.25 && this.actions['catch_jump']) ? 'catch_jump' : 'catch';
            this.playOneShot(catchKey, 0.1);

            if (window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("SNAP!", this.mesh.position, "comic-action");
            }
        }

throwBall(ball, forcedType = null, powerMultiplier = 1.0, forcedSpin = null) {
            if (!this.hasBall || this.isThrowing) return;
            if (this.status.nap > 0) return;

            this.isThrowing = true;

            // Lock aim direction at start of throw
            this.lockedAimVector = new THREE.Vector3();

            if (this.inputVector.lengthSq() > 0.1) {
                this.lockedAimVector.copy(this.inputVector).normalize();
            } else {
                this.lockedAimVector.set(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
            }

const goalZ = (this.team && this.team.side === 1) ? -46 : 46;
            const distToGoal = Math.abs(this.mesh.position.z - goalZ);

            let type = forcedType;
            if (!type) {
                type = (distToGoal < 25) ? 'SH' : 'PA';
            }

            const isFinisher = (type === 'SH' && distToGoal < 12.0);

            let techName = (type === 'SH') ? this.techs.shoot : this.techs.pass;

            if (this.status.venom > 0 && techName) {
                if (window.flux.gameInstance.floatingText)
                    window.flux.gameInstance.floatingText.spawn("SILENCED", this.mesh.position, "status");
                techName = null;
            }

            let windupTime = 100;
            let animSpeed = 1.5;

            if (powerMultiplier > 1.1) {
                windupTime += 200;
            }

            if (isFinisher && !techName) {
                windupTime = 50;
                animSpeed = 3.0;
            }

if (techName) {
                windupTime = 400;
                animSpeed = 0.8;

                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.playCinematic(techName, this.mesh, 1.2);
                }

                this.immunityTimer = 1.5;

                if (window.flux.gameInstance.floatingText) {
                    const label = techName.replace('_', ' ').toUpperCase();
                    window.flux.gameInstance.floatingText.spawn(label, this.mesh.position, "tech");
                }

                // NEW: Spawn Tech Glyph (Vertical Casting Circle)
                if (window.flux.gameInstance.glyphManager) {
                    window.flux.gameInstance.glyphManager.spawn('tech', this.mesh.position, {
                        parent: this,
                        life: 1.2,
                        rotationSpeed: 4.0,
                        scaleSpeed: 1.5,
                        offsetY: 1.2,
                        faceCamera: true
                    });
                }
            }

            // Pick best throw clip (pass/shot variants if present)
            const throwKey =
                (type === 'SH' && this.actions['throw_shot']) ? 'throw_shot' :
                (type === 'PA' && this.actions['throw_pass']) ? 'throw_pass' :
                'throw';

            this.playOneShot(throwKey, 0.1, { timeScale: animSpeed });

            if (window.flux.gameInstance.floatingText && !techName) {
                window.flux.gameInstance.floatingText.spawn("WHOOSH", this.mesh.position, "comic-action");
            }

setTimeout(() => {
                // Safety: If ball holder is still us, proceed. If hasBall is false but holder is us, assume sync lag and proceed.
                if (this.hasBall || (ball && ball.holder === this)) {
const throwAction = this.actions[throwKey];
                    if (throwAction) throwAction.timeScale = 1.0;

                    let finalDir = new THREE.Vector3();
                    let referenceDir = new THREE.Vector3();

if (this.overrideAimVector) {
                        finalDir.copy(this.overrideAimVector).normalize();
                        referenceDir.copy(finalDir);

                        // REMOVED: Instant rotation snap. 
                        // The update loop handles smooth rotation via targetYaw.
                        // This prevents the "flipping around" visual glitch.
                    } else {
                        finalDir.copy(this.lockedAimVector);
                        referenceDir.copy(this.lockedAimVector);
                    }

const spin = new THREE.Vector3(0, 0, 0);

                    if (forcedSpin) {
                        spin.copy(forcedSpin);
                    } else if (this.inputVector.lengthSq() > 0.1) {
                        const inputDir = this.inputVector.clone().normalize();
                        const crossY = new THREE.Vector3().crossVectors(referenceDir, inputDir).y;

                        if (Math.abs(crossY) > 0.1) {
                            spin.set(0, crossY * 12.0, 0);
                        }
                    }

                    let baseCost = (type === 'SH') ? 20 : 10;
                    let techCost = 0;
                    let techBonus = 0;
                    let techPayload = null;

                    if (techName) {
                        switch (techName) {
                            case 'venom':
                                techCost = (type === 'SH' ? 20 : 10);
                                techBonus = 3;
                                techPayload = { type: 'venom', level: 1 };
                                break;
                            case 'wither':
                                techCost = (type === 'SH' ? 20 : 10);
                                techBonus = 3;
                                techPayload = { type: 'wither', level: 1 };
                                break;
                            case 'nap':
                                techCost = (type === 'SH' ? 35 : 30);
                                techBonus = 3;
                                techPayload = { type: 'nap', level: 1 };
                                break;
                            case 'sphere':
                                if (type === 'SH') {
                                    techCost = 25;
                                    const rng = Math.floor(Math.random() * 11) + 5;
                                    techBonus = rng;
                                    techPayload = { type: 'sphere', level: 1, bonus: rng };
                                    if (window.flux.gameInstance.floatingText)
                                        window.flux.gameInstance.floatingText.spawn(`SPHERE +${rng}`, this.mesh.position, "goal");
                                }
                                break;
                            case 'jecht':
                                if (type === 'SH') {
                                    techCost = 40;
                                    techBonus = 5;
                                    techPayload = { type: 'jecht', level: 1 };
                                    this._performJechtKnockback();
                                }
                                break;
                            case 'invisible':
                                if (type === 'SH') {
                                    techCost = 25;
                                    techBonus = 2;
                                    techPayload = { type: 'invisible', level: 1 };
                                }
                                break;
                        }
                    }

                    const totalCost = baseCost + techCost;

                    let powerFactor = 1.0;
                    if (this.stats.HP < totalCost) {
                        powerFactor = 0.5;
                        this.stats.HP = 0;
                        techPayload = null;
                        techBonus = 0;
                        if (window.flux.gameInstance.floatingText)
                            window.flux.gameInstance.floatingText.spawn("TIRED", this.mesh.position, "damage");
                    } else {
                        this.stats.HP -= totalCost;
                    }

                    let statVal = this.getStat(type);
                    statVal += techBonus;
                    statVal *= powerFactor;
                    statVal *= powerMultiplier;

const goalZ = (this.team && this.team.side === 1) ? -46 : 46;
                    const goalDir = new THREE.Vector3(0, 0, goalZ - this.mesh.position.z).normalize();
                    const goalDot = finalDir.dot(goalDir);

                    if (type === 'SH') {
                        const goalPos = new THREE.Vector3(0, 2, goalZ);
                        const toGoal = goalPos.clone().sub(this.mesh.position).normalize();

                        const sh = this.getStat('SH');
                        let assistFactor = Math.min(0.9, Math.max(0.1, sh / 100.0));

                        if (this.overrideAimVector) {
                            assistFactor *= 0.1;
                        }

                        if (goalDot > 0.2) {
                            finalDir.lerp(toGoal, assistFactor);
                        }

                        if (isFinisher) {
                            finalDir.y += 0.05;
                            if (window.flux.gameInstance.floatingText) {
                                window.flux.gameInstance.floatingText.spawn("SLAM!", this.mesh.position, "comic-impact");
                            }
} else {
                            finalDir.y += 0.25;
                        }
                        
// Goalie Loft Bonus (Prevent interception by immediate defender)
                        if (this.role === 'GL') finalDir.y += 0.8; // High loft for clearance

                    } else {
                        const target = this._findPassTargetInCone(finalDir);

                        if (target) {
                            const toMate = target.mesh.position.clone().sub(this.mesh.position);
                            if (target.velocity.lengthSq() > 0.1) {
                                toMate.addScaledVector(target.velocity, 0.5);
                            }
                            toMate.normalize();

                            const pa = this.getStat('PA');
                            let assistFactor = Math.min(1.0, 0.3 + (pa / 80.0));

                            if (this.overrideAimVector) {
                                assistFactor *= 0.1;
                            }

                            finalDir.lerp(toMate, assistFactor);

                            const dist = this.mesh.position.distanceTo(target.mesh.position);
                            finalDir.y += Math.min(0.6, dist * 0.03);
                        } else {
finalDir.y += 0.2;
                        }
                        
                        // Goalie Loft Bonus for Passing
// Goalie Loft Bonus for Passing
                        if (this.role === 'GL') finalDir.y += 0.8; // High loft for clearance
                    }

                    finalDir.normalize();

                    if (techPayload && window.flux.gameInstance && window.flux.gameInstance.triggerTechEvent) {
                        window.flux.gameInstance.triggerTechEvent(this, techName);
                    }

ball.shoot(finalDir, statVal, type, techPayload, spin);
                    
                    // Extra grace period for Goalie to prevent point-blank interceptions
                    if (this.role === 'GL') {
                        ball.catchGracePeriod = 0.6; // 0.6s immunity (approx 10-12m travel)
                    }

this.loseBall();

this.catchCooldown = 1.0; // 1s cooldown
                    this.canCatch = false;
                }
            }, windupTime);

            setTimeout(() => {
                this.isThrowing = false;
                this.overrideAimVector = null;
                this._updateLocomotionAnim(0.2);
            }, windupTime + 500);
        }

        _findPassTargetInCone(aimDir) {
            if (!this.team) return null;

            let bestTarget = null;
            let maxScore = -Infinity;

            for (const mate of this.team.players) {
                if (mate === this || !mate.mesh) continue;

                const toMate = mate.mesh.position.clone().sub(this.mesh.position).normalize();
                const dot = aimDir.dot(toMate);

                if (dot > 0.7) {
                    const dist = this.mesh.position.distanceTo(mate.mesh.position);
                    const score = (dot * 10) - (dist * 0.1);

                    if (score > maxScore) {
                        maxScore = score;
                        bestTarget = mate;
                    }
                }
            }
            return bestTarget;
        }

startCharge() {
            if (!this.hasBall || this.isThrowing || this.status.nap > 0) return;
            this.isCharging = true;
            this.chargeTime = 0;

// Visuals handled in update

            // Show charge UI
            this._updateChargeUI(0);

            // NEW: Spawn Charge Glyph (Ground Ring)
            if (window.flux.gameInstance && window.flux.gameInstance.glyphManager) {
                window.flux.gameInstance.glyphManager.spawn('charge', this.mesh.position, {
                    parent: this,
                    life: this.maxChargeTime,
                    rotationSpeed: 3.0,
                    scaleSpeed: 0.2,
                    offsetY: 0.1
                });
            }
        }

releaseCharge(dx, dy, curveInput = null) {
            if (!this.isCharging) return;
            this.isCharging = false;

            // Power Calculation
            const ratio = Math.min(this.chargeTime / this.maxChargeTime, 1.0);
            const TC = window.flux.ThrowConfig || {};

            // Base multiplier (defaults: 1.0 to 1.8)
            let multiplier = (TC.POWER_BASE !== undefined ? TC.POWER_BASE : 1.0) + (ratio * (TC.POWER_RANGE !== undefined ? TC.POWER_RANGE : 0.8));// MAX POWER BONUS: If held near max, significant boost
            if (ratio > (TC.POWER_MAX_BONUS_RATIO !== undefined ? TC.POWER_MAX_BONUS_RATIO : 0.95)) {
                multiplier = (TC.POWER_MAX_MULTIPLIER !== undefined ? TC.POWER_MAX_MULTIPLIER : 2.5); // Critical Power
                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("MAX POWER!", this.mesh.position, "comic-impact");
                }
                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.addFovImpulse(-10);
                    window.flux.gameInstance.cameraManager.addShake(1.0);
                }
            }

            this._hideChargeUI();

            // Aim Vector Calculation
            let aimVec = null;
            const swipeLen = Math.sqrt(dx*dx + dy*dy);

            if (swipeLen > (TC.SWIPE_MIN_PX !== undefined ? TC.SWIPE_MIN_PX : 20)) {
                const camera = window.flux.gameInstance.camera;
                const fwd = new THREE.Vector3();
                const right = new THREE.Vector3();

                if (camera) {
                    camera.getWorldDirection(fwd);
                    fwd.y = 0;
                    if (fwd.lengthSq() < 0.001) fwd.set(0, 0, -1);
                    else fwd.normalize();

                    right.crossVectors(fwd, new THREE.Vector3(0, 1, 0)).normalize();

                    const worldVec = new THREE.Vector3();
                    worldVec.addScaledVector(right, dx * (TC.AIM_DX_SCALE !== undefined ? TC.AIM_DX_SCALE : 1.0));
                    worldVec.addScaledVector(fwd, -dy * (TC.AIM_DY_SCALE !== undefined ? TC.AIM_DY_SCALE : 1.0));
                    worldVec.normalize();

                    aimVec = worldVec;
                    this.overrideAimVector = aimVec;
                } else {
                    aimVec = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
                    this.overrideAimVector = null;
                }
            } else {
                aimVec = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
                this.overrideAimVector = null;
            }

// --- ANALOG CURVE LOGIC ---
            // Formula: Curve = Intensity * Speed
            let spinVec = null;
            
if ((TC.CURVE_ENABLED !== false) && curveInput && Math.abs(curveInput.intensity) > (TC.CURVE_INTENSITY_THRESHOLD !== undefined ? TC.CURVE_INTENSITY_THRESHOLD : 0.25)) {
                const rawIntensity = Math.abs(curveInput.intensity);
                const sign = Math.sign(curveInput.intensity); // Positive = Right Hump = Left Curve
                const swipeSpeed = curveInput.speed || 1.0;

                // 1. Base Spin from Arc (Tuned for realism, no cyclones)
// 1. Base Spin from Arc (Herculean Boost)
                let spinMag = rawIntensity * (TC.CURVE_SPIN_SCALE !== undefined ? TC.CURVE_SPIN_SCALE : 1000.0);

                // 2. Speed Bonus (Quickness adds RPM)
                const speedBonus = Math.max(1.0, swipeSpeed * (TC.CURVE_SPEED_MULT !== undefined ? TC.CURVE_SPEED_MULT : 1.5));
                spinMag *= speedBonus;

                // Cap (Increased to 1500 for massive arcs)
                spinMag = Math.min((TC.CURVE_SPIN_CAP !== undefined ? TC.CURVE_SPIN_CAP : 1500.0), spinMag);

                // Apply Spin
                // Right Hump (Positive Intensity) -> Left Curve (Positive Spin Y)
                spinVec = new THREE.Vector3(0, spinMag * sign, 0);
                
if (spinMag > (TC.CURVE_PERFECT_SPIN !== undefined ? TC.CURVE_PERFECT_SPIN : 500.0) && window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("PERFECT CURVE", this.mesh.position, "tech");
                    if (window.flux.gameInstance.cameraManager) {
                        window.flux.gameInstance.cameraManager.addShake(0.5);
                        window.flux.gameInstance.cameraManager.addRollImpulse(sign * -0.3); // Tilt camera into the curve
                    }
                }
            }

            // Determine Type (Pass vs Shoot)
// Determine Type (Pass vs Shoot)
            const goalZ = (this.team && this.team.side === 1) ? -46 : 46;
            const goalDir = new THREE.Vector3(0, 0, goalZ - this.mesh.position.z).normalize();
            const dotGoal = aimVec.dot(goalDir);

            let type = 'PA';
            const distToGoal = Math.abs(this.mesh.position.z - goalZ);

            if (dotGoal > 0.8 && distToGoal < 35.0) {
                type = 'SH';
            } else if (dotGoal > 0.5 && distToGoal < 20.0) {
                type = 'SH';
            }

            // Smart Pass Override
            const targetMate = this._findPassTargetInCone(aimVec);
            if (targetMate && type === 'SH') {
                const distMate = this.mesh.position.distanceTo(targetMate.mesh.position);
                if (distMate < 12.0) type = 'PA';
            }

            const ball = window.flux.gameInstance.entities.ball;
            if (ball) {
                this.throwBall(ball, type, multiplier, spinVec);
            }
        }

        // NEW: Charge UI methods
        _updateChargeUI(ratio) {
            const meter = document.getElementById('charge-meter-fill');
            if (meter) {
                meter.style.width = `${ratio * 100}%`;
                if (ratio > 0.9) {
                    meter.style.background = 'linear-gradient(90deg, #ff0, #f80)';
                } else if (ratio > 0.5) {
                    meter.style.background = 'linear-gradient(90deg, #0f0, #ff0)';
                } else {
                    meter.style.background = 'linear-gradient(90deg, #0af, #0f0)';
                }
            }
            const container = document.getElementById('charge-meter-container');
            if (container) container.style.display = 'block';
        }

        _hideChargeUI() {
            const container = document.getElementById('charge-meter-container');
            if (container) container.style.display = 'none';
        }

        setOverrideAim(x, z) {
            if (!this.overrideAimVector) this.overrideAimVector = new THREE.Vector3();
            this.overrideAimVector.set(x, 0, z).normalize();
        }

loseBall() {
            this.hasBall = false;
            this._hidePassTargetIndicators();
            // Fix: Ensure player can catch again if they lose possession unexpectedly
            this.canCatch = true;
            // Safety: Reset states to prevent locking
            this.isThrowing = false;
            this.isCharging = false;
            this._hideChargeUI();
        }

update(dt) {
            if (!this.mesh) return;

            // SYNC FIX: If ball thinks I hold it, but I don't, force receive
            if (this.ballRef && this.ballRef.holder === this && !this.hasBall) {
                console.warn("Syncing ball possession to player");
                this.receiveBall();
            }

            if (this.isGodMode) {
                this.stats.HP = this.stats.maxHP;
                this.currentEN = this.getStat('EN');
                this.status.venom = 0;
                this.status.nap = 0;
            }

            if (this.mixer) {
                this.mixer.update(dt);
            }
            // Animation: keep locomotion/charge updated unless a one-shot is locking animations.
            this._updateLocomotionAnim(0.2);


            this._updateStatus(dt);

            // Charge Logic
// Charge Logic
            if (this.isCharging) {
                if (!this.hasBall || this.status.nap > 0 || this.stunTimer > 0) {
                    this.isCharging = false;
                    this.mesh.position.y = 0;
                    this.mesh.scale.setScalar(this.baseScale);
                    this._hideChargeUI();
                } else {
this.chargeTime += dt;
                    
                    // AUTO-RELEASE: If held too long (3s), force release to prevent stuck state
                    if (this.chargeTime > 3.0) {
                        this.releaseCharge(0, 0); // Force weak shot
                        return;
                    }

                    const ratio = Math.min(this.chargeTime / this.maxChargeTime, 1.0);
                    
                    // Levitation (Powering up)
                    const hover = (Math.sin(Date.now() * 0.02) * 0.1) + (ratio * 0.8);
                    
                    // Vibration (Intensity increases with charge)
                    const shake = 0.05 + (0.1 * ratio);
                    
                    // Apply Y offset (Hover + Jitter)
                    this.mesh.position.y = hover + (Math.random() - 0.5) * shake;
                    
                    // Apply Rotation Jitter (via banking/pitch variables)
                    // This avoids positional drift while giving a "struggling to contain power" look
                    this.bankingAmount += (Math.random() - 0.5) * shake;
                    this.pitchAmount += (Math.random() - 0.5) * shake;

                    // Ensure scale stays normal (Remove swelling effect)
                    this.mesh.scale.setScalar(this.baseScale);

                    this._updateChargeUI(ratio);
                }
            }
if (this.dashCooldown > 0) this.dashCooldown -= dt;
            if (this.clashCooldown > 0) this.clashCooldown -= dt;
            if (this.stunTimer > 0) this.stunTimer -= dt;
            if (this.immunityTimer > 0) this.immunityTimer -= dt;
            if (this.catchCooldown > 0) {
                this.catchCooldown -= dt;
                if (this.catchCooldown <= 0) this.canCatch = true;
            }
            // Dash Logic
// Dash Logic
            if (this.isDashing) {
                this.dashTime -= dt;
                
this._dashParticleTimer -= dt;
                if (this._dashParticleTimer <= 0) {
                    this._dashParticleTimer = 0.01; // Increased density (was 0.03)
                    if (window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                        const back = this.velocity.clone().normalize().negate();
                        if (back.lengthSq() < 0.1) back.set(0, 0, 1);
                        
                        // Spawn multiple particles per tick for a "stream"
                        for(let i=0; i<2; i++) {
                            const pos = this.mesh.position.clone().add(back.multiplyScalar(0.5));
                            pos.y += 1.0 + (Math.random() - 0.5) * 0.5;
                            pos.x += (Math.random() - 0.5) * 0.5;
                            pos.z += (Math.random() - 0.5) * 0.5;
                            
                            window.flux.gameInstance.particleManager.spawn('dash_stream', pos, { scale: 2.0 + Math.random() });
                        }
                    }
                }

                // Smooth Rotation during Dash
                let diff = this.targetYaw - this.currentYaw;
                while (diff > Math.PI) diff -= Math.PI * 2;
                while (diff < -Math.PI) diff += Math.PI * 2;
                
                const turnSpeed = 15.0; // Fast turning for dash
                const change = Math.max(-turnSpeed * dt, Math.min(turnSpeed * dt, diff));
                this.currentYaw += change;

                this._checkTackleCollision();
                
                if (this.dashTime <= 0) {
                    this.isDashing = false;
                    this.mesh.position.y = 0;
                    this.dashType = null;
                } else {
                    if (this.dashType === 'vertical') {
                        _pVec.copy(this.dashVec).multiplyScalar(dt);
                        this.mesh.position.add(_pVec);
                        const t = 1 - (this.dashTime / this.dashTotalTime);
                        this.mesh.position.y = Math.sin(t * Math.PI) * 3.0;
                    } else {
                        // Horizontal Dash Movement
                        _pVec.copy(this.velocity).multiplyScalar(dt);
                        this.mesh.position.add(_pVec);
                        this.mesh.position.y = 0;

                        // Visual Tackle Lean (Shoulder Bash Animation)
                        const t = 1 - (this.dashTime / this.dashTotalTime); // 0 to 1
                        const lean = Math.sin(t * Math.PI); // Peak at 1.0 in middle
                        
                        // Re-apply base facing + Aggressive Shoulder Check
// Re-apply base facing + Aggressive Shoulder Check
                        _pQuat.setFromAxisAngle(_pAxisY, this.currentYaw + this.rotationOffset);
                        
                        let pitch = 0;
                        let yaw = 0;
                        let roll = 0;
                        let lungeAmt = 0;

                        if (this.dashType === 'horizontal' || this.dashType === 'break') {
                             // TACKLE/BREAK: Aggressive Shoulder Check
                             pitch = 1.2 * lean; // Head down / Lean forward
                             yaw = 0.8 * lean;   // Turn shoulder into target
                             roll = -0.6 * lean; // Dip shoulder
                             lungeAmt = 0.8 * lean; // Thrust mesh forward visually
                        } else if (this.dashType === 'sprint') {
                             // SPRINT: Aerodynamic lean
                             pitch = 0.5 * lean; 
                             lungeAmt = 0.2 * lean;
                        }

                        // Apply Lunge (Visual Offset)
                        if (lungeAmt > 0) {
                             _pVec.set(0, 0, lungeAmt).applyQuaternion(_pQuat);
                             this.mesh.position.add(_pVec);
                        }

                        _pEuler.set(pitch, yaw, roll);
                        _pQuat2.setFromEuler(_pEuler);
                        this.mesh.quaternion.multiplyQuaternions(_pQuat, _pQuat2);

                        this.velocity.multiplyScalar(0.96);

                        this.velocity.multiplyScalar(0.96);
                    }
                }
                return;
            }
            // Stun/Nap Check
            if (this.status.nap > 0 || this.stunTimer > 0) {
                const dragFactor = Math.max(0, 1 - (2.0 * dt));
                this.velocity.multiplyScalar(dragFactor);

                _pVec.copy(this.velocity).multiplyScalar(dt);
                this.mesh.position.add(_pVec);

                if (!this._animLocked && this.state !== 'idle' && this.state !== 'catch') this.play('idle', 0.5);

                this._updateHPBar();
                this._updatePassTargetIndicators();
                return;
            }

            this._checkTacklePressure(dt);

            if (this.isThrowing) {
                this.velocity.multiplyScalar(Math.max(0, 1.0 - (2.0 * dt)));

                this._applySoftCollision(dt);
                this._applyGoalCrease(dt);

                _pVec.copy(this.velocity).multiplyScalar(dt);
                this.mesh.position.add(_pVec);

this._updateVerticality(dt);
                this._updateBanking(dt); // Enable rotation during throw

            } else {
                this._updatePhysics(dt);
                this._updateVerticality(dt);
                this._updateBanking(dt);
            }

this._updateHPBar();
            this._updatePassTargetIndicators();

            // Bubble Trail Logic
// Bubble Trail Logic (Dynamic)
            const speedSq = this.velocity.lengthSq();
            if (speedSq > 1.0 && window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                this._bubbleTimer -= dt;
                if (this._bubbleTimer <= 0) {
                    const pm = window.flux.gameInstance.particleManager;
                    const backDir = this.velocity.clone().normalize().negate();
                    
                    // 1. Standard Wake (Always spawn)
                    const offset = backDir.clone().multiplyScalar(0.8);
                    offset.y = 0.5 + Math.random() * 0.5; 
                    offset.x += (Math.random()-0.5) * 0.5;
                    offset.z += (Math.random()-0.5) * 0.5;
                    pm.spawn('bubble', this.mesh.position.clone().add(offset), { scale: 0.15 + Math.random() * 0.25 });

                    // 2. Cavitation (High Speed) - Add on top
                    const isHighSpeed = speedSq > 40.0; 
                    if (isHighSpeed) {
                        for(let i=0; i<3; i++) {
                            const mOffset = backDir.clone().multiplyScalar(0.5 + Math.random()*0.5);
                            mOffset.x += (Math.random()-0.5)*0.8;
                            mOffset.y = 0.5 + (Math.random()-0.5)*0.8; 
                            mOffset.z += (Math.random()-0.5)*0.8;
                            
                            pm.spawn('bubble_micro', this.mesh.position.clone().add(mOffset), { scale: 0.06 + Math.random()*0.08 });
                        }
                        this._bubbleTimer = 0.03; 
                    } else {
                        this._bubbleTimer = 0.1; 
                    }
                }
            }
            // Procedural 'alive' pose: look/aim/ball-hold offsets (applied after mixer update)
            this._applyProceduralPose(dt);

}


_applyProceduralPose(dt) {
    if (!this.mesh) return;

    // Advance local time (used for subtle sways)
    this._procAnimTime += dt;

    const b = this.bones;
    if (!b) return;

    const game = window.flux.gameInstance;
    const ball = (game && game.entities) ? game.entities.ball : null;

    let shouldApply = false;

    // Build a desired world-space direction we want the torso/head to bias toward.
    // NOTE: We apply this AFTER the animation mixer has posed bones, as a small additive offset.
    _pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();

    if (this.hasBall) {
        // Aim direction (prefer explicit aim vector)
        if (this.overrideAimVector) {
            _pVec.copy(this.overrideAimVector).normalize();
        } else if (this.lockedAimVector) {
            _pVec.copy(this.lockedAimVector).normalize();
        } else if (this.inputVector && this.inputVector.lengthSq() > 0.08) {
            _pVec.copy(this.inputVector).normalize();
        } else {
            _pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
        }
        shouldApply = true;
    } else if (ball && ball.mesh) {
        // Look at the ball if it's in the "awareness" radius
        const dist = this.mesh.position.distanceTo(ball.mesh.position);
        if (dist < 20.0) {
            _pVec.subVectors(ball.mesh.position, this.mesh.position);
            shouldApply = true;
        }
    }

    if (!shouldApply) return;

    // Convert the direction into the player's local space so yaw/pitch are stable.
    _pInvQuat.copy(this.mesh.quaternion).invert();
    _pVec.applyQuaternion(_pInvQuat).normalize();

    const lx = _pVec.x, ly = _pVec.y, lz = _pVec.z;
    const yaw = Math.atan2(lx, lz);
    const pitch = Math.atan2(ly, Math.sqrt(lx * lx + lz * lz) + 1e-6);

    const yawC = THREE.MathUtils.clamp(yaw, -0.9, 0.9);
    const pitchC = THREE.MathUtils.clamp(pitch, -0.6, 0.6);

    const speedNorm = (this.maxSpeed > 0.0001) ? THREE.MathUtils.clamp(this._smoothedSpeed / this.maxSpeed, 0, 1) : 0;
    const aimW = (this.hasBall ? (this.isCharging ? 1.0 : 0.65) : 0.35) * (1.0 - 0.35 * speedNorm);
    const headW = (this.hasBall ? 0.55 : 0.75) * (1.0 - 0.25 * speedNorm);

    // Torso bias (spine/chest)
    if (b.chest) {
        _pTmpEuler.set(-pitchC * 0.20 * aimW, yawC * 0.35 * aimW, 0);
        _pTmpQuat.setFromEuler(_pTmpEuler);
        b.chest.quaternion.multiply(_pTmpQuat);
    } else if (b.spine) {
        _pTmpEuler.set(-pitchC * 0.15 * aimW, yawC * 0.25 * aimW, 0);
        _pTmpQuat.setFromEuler(_pTmpEuler);
        b.spine.quaternion.multiply(_pTmpQuat);
    }

    // Head/neck look
    if (b.neck) {
        _pTmpEuler.set(-pitchC * 0.25 * headW, yawC * 0.45 * headW, 0);
        _pTmpQuat.setFromEuler(_pTmpEuler);
        b.neck.quaternion.multiply(_pTmpQuat);
    }
    if (b.head) {
        _pTmpEuler.set(-pitchC * 0.30 * headW, yawC * 0.55 * headW, 0);
        _pTmpQuat.setFromEuler(_pTmpEuler);
        b.head.quaternion.multiply(_pTmpQuat);
    }

    // Ball-hold / aim arm pose (keeps "swim" animation but reads as holding/aiming)
    if (this.hasBall && !this.isThrowing && !this._animLocked) {
        const t = this._procAnimTime;
        const lift = THREE.MathUtils.clamp(0.35 + (this.isCharging ? 0.55 : 0.25) - speedNorm * 0.2, 0.15, 0.95);
        const sway = Math.sin(t * 5.0) * 0.05 * (0.5 + lift);

        const raiseX = -0.55 * lift + sway;
        const raiseZ = -0.25 * lift;

        if (b.rUpperArm) {
            _pTmpEuler.set(raiseX, yawC * 0.10 * lift, raiseZ);
            _pTmpQuat.setFromEuler(_pTmpEuler);
            b.rUpperArm.quaternion.multiply(_pTmpQuat);
        }
        if (b.rForeArm) {
            _pTmpEuler.set(-0.35 * lift + sway * 0.5, 0, 0);
            _pTmpQuat.setFromEuler(_pTmpEuler);
            b.rForeArm.quaternion.multiply(_pTmpQuat);
        }

        // Counterbalance left arm slightly for a more dynamic silhouette
        if (b.lUpperArm) {
            _pTmpEuler.set(0.15 * lift, -yawC * 0.05 * lift, 0.15 * lift);
            _pTmpQuat.setFromEuler(_pTmpEuler);
            b.lUpperArm.quaternion.multiply(_pTmpQuat);
        }
    }
}


        _updateStatus(dt) {
            const pm = window.flux.gameInstance ? window.flux.gameInstance.particleManager : null;

            if (this.status.venom > 0) {
                this.status.venom -= dt;
                this.stats.HP -= 5 * dt;
                if (this.stats.HP < 0) this.stats.HP = 0;

                this._particleTimers.venom -= dt;
                if (this._particleTimers.venom <= 0 && pm) {
                    pm.spawn('venom', this.mesh.position);
                    this._particleTimers.venom = 0.15;
                }
            } else {
                if (!this.hasBall && this.stats.HP < this.stats.maxHP) {
                    this.stats.HP += 5 * dt;
                    if (this.stats.HP > this.stats.maxHP) this.stats.HP = this.stats.maxHP;
                }
            }

            if (this.hasBall) {
                this.stats.HP -= 2.0 * dt;
                if (this.stats.HP < 0) this.stats.HP = 0;
            }

            if (this.status.nap > 0) {
                this.status.nap -= dt;

                this._particleTimers.nap -= dt;
                if (this._particleTimers.nap <= 0 && pm) {
                    pm.spawn('nap', this.mesh.position);
                    this._particleTimers.nap = 0.8;
                }
            }

            let isWithering = false;
            for (let key in this.status.wither) {
                if (this.status.wither[key] > 0) {
                    this.status.wither[key] -= dt;
                    isWithering = true;
                }
            }

            if (isWithering) {
                this._particleTimers.wither -= dt;
                if (this._particleTimers.wither <= 0 && pm) {
                    pm.spawn('wither', this.mesh.position);
                    this._particleTimers.wither = 0.2;
                }
            }

            this._updateVisuals();
        }

_updateVisuals() {
            // REMOVED: Yellow sphere/tint logic as per request.
            // Always revert to base color.
            this.originalMaterials.forEach(entry => {
                entry.material.color.copy(entry.baseColor);
            });
        }

        _createAura() {
            // Aura removed per user request
            this.auraMesh = null;
        }

        // NEW: Pass target indicator
        _createPassTargetIndicator() {
            // Create a ring that highlights potential pass targets
            const geo = new THREE.RingGeometry(0.8, 1.0, 16);
            const mat = new THREE.MeshBasicMaterial({
                color: 0x00ff00,
                transparent: true,
                opacity: 0.6,
                side: THREE.DoubleSide
            });
            this.passTargetIndicator = new THREE.Mesh(geo, mat);
            this.passTargetIndicator.rotation.x = -Math.PI / 2;
            this.passTargetIndicator.position.y = 0.1;
            this.passTargetIndicator.visible = false;
            this.scene.add(this.passTargetIndicator);
        }

        _updatePassTargetIndicators() {
            if (!this.hasBall || !this.team) {
                this._hidePassTargetIndicators();
                return;
            }

            // Find best pass target
            const aimDir = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion);
            const target = this._findPassTargetInCone(aimDir);

            if (target && target.mesh && this.passTargetIndicator) {
                this.passTargetIndicator.visible = true;
                this.passTargetIndicator.position.x = target.mesh.position.x;
                this.passTargetIndicator.position.z = target.mesh.position.z;
                this.passTargetIndicator.position.y = 0.1;
                this.passTargetIndicator.rotation.z += 0.05;
            } else {
                this._hidePassTargetIndicators();
            }
        }

        _hidePassTargetIndicators() {
            if (this.passTargetIndicator) {
                this.passTargetIndicator.visible = false;
            }
        }

_applySoftCollision(dt) {
            if (!this.mesh || !window.flux.gameInstance) return;

            const game = window.flux.gameInstance;
            const teams = [game.teams.home, game.teams.away];

            const repulsionRadius = 0.5; // Reduced to 0.5 to fix invisible wall issues
            const stiffness = 15.0;

            teams.forEach(team => {
                if (!team) return;
                team.players.forEach(other => {
                    if (other === this || !other.mesh) return;

                    const dx = this.mesh.position.x - other.mesh.position.x;
                    const dy = this.mesh.position.y - other.mesh.position.y;
                    const dz = this.mesh.position.z - other.mesh.position.z;

                    const distSq = dx*dx + dy*dy + dz*dz;
                    const minDist = repulsionRadius * 2.0;

                    if (distSq < minDist * minDist && distSq > 0.0001) {
                        const dist = Math.sqrt(distSq);
                        const overlap = minDist - dist;

                        const force = overlap * stiffness;

                        const nx = dx / dist;
                        const ny = dy / dist;
                        const nz = dz / dist;

                        this.velocity.x += nx * force * dt;
                        this.velocity.y += ny * force * dt;
                        this.velocity.z += nz * force * dt;
                    }
                });
            });
        }

_updatePhysics(dt) {
            this._applySoftCollision(dt);
            this._applyGoalCrease(dt);

            const inputLenSq = this.inputVector.lengthSq();
            const isInputActive = inputLenSq > 0.01;

            let currentMaxSpeed = this.maxSpeed;
            
            // STRUGGLE STATE: Hinder movement based on pressure
            // Instead of a binary 0.8 multiplier, we scale based on intensity.
            // Max struggle (1.0) reduces speed to 40%.
            if (this.struggleIntensity > 0) {
                currentMaxSpeed *= (1.0 - (this.struggleIntensity * 0.6));
            } else if (this.isEngaged) {
                // Fallback slight reduction if engaged but low pressure
                currentMaxSpeed *= 0.9;
            }
            
            if (this.isCharging) currentMaxSpeed *= 0.9;

            if (isInputActive) {
                _pVec.copy(this.inputVector).normalize();

                // Apply Struggle Jitter to direction
                // Simulates wrestling for control
                if (this.struggleIntensity > 0.3) {
                    const jitter = (Math.random() - 0.5) * this.struggleIntensity * 0.8;
                    _pVec.x += jitter;
                    _pVec.z += jitter;
                    _pVec.normalize();
                }

                const targetVelX = _pVec.x * currentMaxSpeed;
                const targetVelZ = _pVec.z * currentMaxSpeed;

                const currentSpeed = this.velocity.length();
                const speedRatio = Math.min(1.0, currentSpeed / this.maxSpeed);

                // Agility is reduced when struggling
                let agility = THREE.MathUtils.lerp(10.0, 2.0, speedRatio);
                if (this.struggleIntensity > 0) agility *= 0.5;

                const t = 1.0 - Math.pow(0.01, dt * agility);

                this.velocity.x += (targetVelX - this.velocity.x) * t;
                this.velocity.z += (targetVelZ - this.velocity.z) * t;

            } else {
                const brakeFactor = 2.0;
                const t = 1.0 - Math.pow(0.1, dt * brakeFactor);

                this.velocity.x += (0 - this.velocity.x) * t;
                this.velocity.z += (0 - this.velocity.z) * t;

                if (this.velocity.lengthSq() < 0.01) {
                    this.velocity.set(0, this.velocity.y, 0);
                }
            }

            this.velocity.y *= Math.max(0, 1.0 - (2.0 * dt));

            _pVec.copy(this.velocity).multiplyScalar(dt);
            this.mesh.position.add(_pVec);
        }

        _updateVerticality(dt) {
            let targetY = 0;

            const ball = window.flux.gameInstance.entities.ball;

            if (ball && ball.mesh && !this.hasBall) {
                const distToBall = this.mesh.position.distanceTo(ball.mesh.position);
                if (distToBall < 15.0) {
                    targetY = ball.mesh.position.y;
                }
            }

            if (this.hasBall) {
                targetY = 0.5;
            }

            const yDiff = targetY - this.mesh.position.y;

            const lift = yDiff * 10.0 * dt;
            this.velocity.y += lift;

            if (this.mesh.position.y > 8.0) {
                this.mesh.position.y = 8.0;
                this.velocity.y *= -0.5;
            } else if (this.mesh.position.y < -8.0) {
                this.mesh.position.y = -8.0;
                this.velocity.y *= -0.5;
            }
        }

        // FIXED: Improved banking with hysteresis to prevent facing flips
// FIXED: Improved banking with hysteresis to prevent facing flips
        _updateBanking(dt) {
            const inputLenSq = this.inputVector.lengthSq();
            const velLenSq = this.velocity.lengthSq();

            let targetYaw = this.targetYaw;
            let shouldUpdateYaw = false;

            // PRIORITY 1: Explicit Aim (Aim Stick / Swipe)
            if (this.overrideAimVector) {
                targetYaw = Math.atan2(this.overrideAimVector.x, this.overrideAimVector.z);
                shouldUpdateYaw = true;
            }
            // PRIORITY 2: Movement Input
            else if (inputLenSq > this.facingDeadzone * this.facingDeadzone) {
                targetYaw = Math.atan2(this.inputVector.x, this.inputVector.z);
                shouldUpdateYaw = true;
            } 
            // PRIORITY 3: Velocity (Drifting)
            else if (velLenSq > this.facingDeadzone * this.facingDeadzone) {
                targetYaw = Math.atan2(this.velocity.x, this.velocity.z);
                shouldUpdateYaw = true;
            }

            // If we should update, do so. Otherwise keep last valid yaw
            if (shouldUpdateYaw) {
                this.lastValidYaw = targetYaw;
            } else {
                targetYaw = this.lastValidYaw;
            }

            // Smooth Yaw with wrap-around handling
            let diff = targetYaw - this.currentYaw;
            while (diff > Math.PI) diff -= Math.PI * 2;
            while (diff < -Math.PI) diff += Math.PI * 2;

            const speedRatio = Math.min(1.0, this.velocity.length() / this.maxSpeed);
const turnSpeed = THREE.MathUtils.lerp(8.0, 4.0, speedRatio); // Reduced from 12.0/6.0 to reduce flipping

            // Prevent sudden snaps when diff is very large (teleport/reset scenarios)
            const maxYawChange = Math.PI * dt * turnSpeed;
            const yawChange = Math.max(-maxYawChange, Math.min(maxYawChange, diff * dt * turnSpeed));

            this.currentYaw += yawChange;
            this.targetYaw = targetYaw;

            // Banking
            const bankSensitivity = 0.8;
            const maxBank = 0.75;

            let targetBank = -diff * bankSensitivity;
            targetBank = Math.max(-maxBank, Math.min(maxBank, targetBank));

            const bankLerp = 1.0 - Math.pow(0.02, dt);
            this.bankingAmount += (targetBank - this.bankingAmount) * bankLerp;

            // Pitch
            const pitchSensitivity = 0.1;
            const maxPitch = 1.0;

            let targetPitch = -this.velocity.y * pitchSensitivity;
            targetPitch = Math.max(-maxPitch, Math.min(maxPitch, targetPitch));

            const pitchLerp = 1.0 - Math.pow(0.05, dt);
            this.pitchAmount += (targetPitch - this.pitchAmount) * pitchLerp;

            // Apply Rotation
            const finalYaw = this.currentYaw + this.rotationOffset;

            this.mesh.quaternion.setFromAxisAngle(_pAxisY, finalYaw);

            _pQuat.setFromAxisAngle(new THREE.Vector3(1, 0, 0), this.pitchAmount);
            this.mesh.quaternion.multiply(_pQuat);

            _pQuat.setFromAxisAngle(new THREE.Vector3(0, 0, 1), this.bankingAmount);
            this.mesh.quaternion.multiply(_pQuat);

            // Idle Bob
            if (velLenSq < 0.1 && !this.isEngaged) {
                const time = Date.now() * 0.0015;
                const bobPitch = Math.sin(time) * 0.03;
                const bobRoll = Math.cos(time * 0.7) * 0.02;

_pEuler.set(bobPitch, 0, bobRoll);
                _pQuat.setFromEuler(_pEuler);
                this.mesh.quaternion.multiply(_pQuat);
            }
        }

_checkTacklePressure(dt) {
            this.struggleIntensity = 0;
            
            if (!this.hasBall) {
                this.isEngaged = false;
                this.encounterTimer = 0;
                return;
            }

            if (this.immunityTimer > 0) return;
            if (this.isDashing) return;

            const game = window.flux.gameInstance;
            if (!game || !this.team) return;

            const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
            const opponentTeam = game.teams[opponentTeamId];
            if (!opponentTeam) return;

            let totalPressure = 0;
            let engagedCount = 0;
            const effectiveRadius = this.tackleRadius; 

            // Forward vector for shielding check
            _pVec.copy(_pAxisZ).applyQuaternion(this.mesh.quaternion); 

            for (const entity of opponentTeam.players) {
                if (!entity.mesh || entity.status.nap > 0 || entity.stunTimer > 0) continue;
                
                const dist = this.mesh.position.distanceTo(entity.mesh.position);
                if (dist < effectiveRadius) {
                    engagedCount++;
                    
                    // Calculate Pressure Intensity (0 to 1 based on distance)
                    const proximity = 1.0 - (dist / effectiveRadius);
                    
                    // Base Pressure from AT stat
                    let pressure = entity.getStat('AT') * proximity;

                    // Directional Shielding (Continuous)
                    const toOpp = entity.mesh.position.clone().sub(this.mesh.position).normalize();
                    const dot = _pVec.dot(toOpp);
                    
                    // If opponent is BEHIND (dot < -0.2), pressure is reduced (Shielding)
                    let isShielded = false;
                    if (dot < -0.2) {
                        pressure *= 0.5;
                        isShielded = true;
                    }

                    // Tech Modifiers (Continuous application chance)
                    if (entity.techs.tackle === 'venom') {
                        if (Math.random() < dt * 0.5) this.applyStatus('venom', 5.0);
                        pressure *= 1.2;
                    } else if (entity.techs.tackle === 'wither') {
                        if (Math.random() < dt * 0.5) this.applyStatus('wither', 5.0, 'EN');
                        pressure *= 1.2;
                    } else if (entity.techs.tackle === 'drain') {
                        const drainAmt = pressure * dt * 0.5;
                        this.stats.HP -= drainAmt;
                        entity.stats.HP += drainAmt;
                    }

                    totalPressure += pressure;

                    // Visuals: Sparks occasionally based on pressure
                    if (Math.random() < dt * 4.0 * proximity) { 
                         if (game.spawnClash) {
                            const mid = this.mesh.position.clone().lerp(entity.mesh.position, 0.5);
                            mid.y += 1.0;
                            game.spawnClash(mid, 0.5);
                        }
                    }
                    
                    // Occasional Shield Text
                    if (isShielded && Math.random() < dt * 1.0 && game.floatingText) {
                        // game.floatingText.spawn("SHIELD", this.mesh.position, "block"); // Too spammy, maybe just sound later
                    }
                }
            }

            this.isEngaged = (engagedCount > 0);

            if (this.isEngaged) {
                this.encounterTimer += dt;

                // Apply EN Drain (Continuous)
                // Scaling: 20 AT pressure -> approx 10 EN lost per second
                const drainRate = totalPressure * 0.5; 
                this.currentEN -= drainRate * dt;
                
                // Update Struggle Intensity for Physics (0.0 to 1.0)
                // Max struggle at roughly 30 pressure
                this.struggleIntensity = Math.min(1.0, totalPressure / 30.0);

                // Visual Feedback for Drain (Accumulate to avoid spam)
                this._accumulatedDamage += drainRate * dt;
                if (this._accumulatedDamage > 5.0) {
                    if (game.floatingText) {
                        game.floatingText.spawn(`-${Math.floor(this._accumulatedDamage)}`, this.mesh.position, "damage");
                    }
                    this._accumulatedDamage = 0;
                }
                
                // Hint for player if engaged too long
                if (this.encounterTimer > 1.0 && this.encounterTimer < 1.1 && this.team.isHuman && this.team.activePlayer === this) {
                     if (game.floatingText) game.floatingText.spawn("BREAK!", this.mesh.position, "tech");
                }
            } else {
                this.encounterTimer = 0;
            }

            if (this.currentEN <= 0) {
                this.fumble();
            }
        }

        _performJechtKnockback() {
            if (!this.team) return;
            const game = window.flux.gameInstance;
            const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
            const opponentTeam = game.teams[opponentTeamId];

            if (!opponentTeam) return;

            const range = 6.0;
            const force = 25.0;

            if (game.floatingText) {
                game.floatingText.spawn("JECHT SHOT!", this.mesh.position, "goal");
            }

            opponentTeam.players.forEach(p => {
                if (!p.mesh) return;
                const dist = this.mesh.position.distanceTo(p.mesh.position);
                if (dist < range) {
                    const dir = p.mesh.position.clone().sub(this.mesh.position).normalize();
                    dir.y = 0.5;
                    dir.normalize();

p.velocity.add(dir.multiplyScalar(force));

                    p.stunTimer = 2.0; // Ensure they stay down
                    p.isDashing = false;
                    const reactAction = p.actions && p.actions['react'];
                    if (reactAction) {
                        reactAction.setLoop(THREE.LoopOnce);
                        reactAction.clampWhenFinished = true;
                        p.playOneShot('react', 0.1);
} else {
                        p.play('catch', 0.5);
                    }

                    if (game.floatingText) {
                        game.floatingText.spawn("SMACK!", p.mesh.position, "damage");
                    }
                    if (game.triggerImpact) game.triggerImpact(0.15, 'shatter');
                }
            });
        }

        fumble() {
            console.log("FUMBLE! EN Depleted.");
            if (window.flux.gameInstance.floatingText && this.mesh) {
                window.flux.gameInstance.floatingText.spawn("CRASH!", this.mesh.position, "comic-impact");
            }

            this.stunTimer = 1.5;

            const backDir = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize().negate();
            backDir.x += (Math.random() - 0.5) * 0.5;
            backDir.z += (Math.random() - 0.5) * 0.5;
            backDir.normalize();

            this.velocity.add(backDir.multiplyScalar(12.0));

            if (this.hasBall) {
                const ball = window.flux.gameInstance.entities.ball;
                if (ball) {
                    const ejectDir = new THREE.Vector3(Math.random()-0.5, 0.8, Math.random()-0.5).normalize();
                    ball.shoot(ejectDir, 6.0, 'none');
this.loseBall();
                    this.canCatch = false;

                    this.currentEN = 0;
                }
            }
        }

        dash(x, z) {
            if (this.isDashing || this.dashCooldown > 0) return;
            if (this.status.nap > 0) return;

            // OFFENSE: BREAK TACKLE
            if (this.hasBall && this.isEngaged) {
                const cost = 15;

                if (this.currentEN < cost) {
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("FAILED!", this.mesh.position, "damage");
                    }
                    this.fumble();
                    return;
                }

                this.currentEN -= cost;
                this.isDashing = true;
                this.dashTime = 0.4;
                this.dashCooldown = 2.0;
                this.dashType = 'break';

_pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
this.velocity.add(_pVec.multiplyScalar(10.0)); // Nerfed from 15.0 for realism

                const game = window.flux.gameInstance;
                const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
                const opponentTeam = game.teams[opponentTeamId];

                opponentTeam.players.forEach(p => {
                    if (!p.mesh) return;
                    const dist = this.mesh.position.distanceTo(p.mesh.position);
                    if (dist < this.tackleRadius * 1.5) {
                        const pushDir = p.mesh.position.clone().sub(this.mesh.position).normalize();
                        pushDir.y = 0.5;
                        p.velocity.add(pushDir.multiplyScalar(15.0));

                        p.stunTimer = 2.0;
                        p.play('catch', 0.2);

                        if (game.floatingText) {
                            game.floatingText.spawn("STUN!", p.mesh.position, "damage");
                        }
                    }
                });

if (game.floatingText) {
                    game.floatingText.spawn("BREAK!", this.mesh.position, "tech");
                }
                
// NEW: Spawn Break Glyph (Explosive Burst)
                if (game.glyphManager) {
                    game.glyphManager.spawn('status', this.mesh.position, {
                        parent: this,
                        life: 0.5,
                        rotationSpeed: 8.0,
                        scaleSpeed: 3.0,
                        offsetY: 0.5
                    });
                }
                
// Particle Burst (Break Tackle)
                if (game.particleManager) {
                    game.particleManager.spawn('shockwave', this.mesh.position, { scale: 2.0, life: 0.3 });
                    game.particleManager.spawn('flash', this.mesh.position, { scale: 2.5 });
                    // Bubble Burst
                    for(let i=0; i<30; i++) {
const bPos = this.mesh.position.clone().add(_pVec.set((Math.random()-0.5), 1.0+(Math.random()-0.5), (Math.random()-0.5)));
                    game.particleManager.spawn('bubble', bPos, { scale: 0.2 + Math.random() * 0.4 });
                    }
                }

                if (game.triggerImpact) game.triggerImpact(0.15, 'heavy');

                return;
            }

            // OFFENSE: SPRINT
            if (this.hasBall) {
                const cost = 5;
                if (this.currentEN < cost) {
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("NO EN!", this.mesh.position, "damage");
                    }
                    return;
                }

                this.currentEN -= cost;
                this.isDashing = true;
                this.dashTime = 0.4;
                this.dashCooldown = 1.5;
                this.dashType = 'sprint';

const burstDir = this.velocity.clone().normalize();
                if (burstDir.lengthSq() < 0.1) burstDir.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);

this.velocity.add(burstDir.multiplyScalar(12.0)); // Nerfed from 15.0

                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.addFovImpulse(20);
                }
                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("DASH!", this.mesh.position, "tech");
                }
                return;
            }

            // DEFENSE: BLOCK / TACKLE
            const ball = window.flux.gameInstance.entities.ball;
            let isBlockContext = false;
            if (ball && ball.mesh) {
                const dist = this.mesh.position.distanceTo(ball.mesh.position);
                if (dist < 8.0 && ball.mesh.position.y > 2.5) {
                    isBlockContext = true;
                }
            }

            this.isDashing = true;
            this.dashTime = this.dashTotalTime;
            this.dashCooldown = 1.5;

            const len = Math.sqrt(x*x + z*z);
            const nx = (len > 0) ? x/len : 0;
            const nz = (len > 0) ? z/len : 0;

if (len > 0) {
                // Smooth turn for dash instead of snap
                this.targetYaw = Math.atan2(nx, nz);
            }
            if (isBlockContext) {
                this.dashType = 'vertical';

                const dirToBall = ball.mesh.position.clone().sub(this.mesh.position);
                dirToBall.y = 0;

                if (dirToBall.lengthSq() > 0.01) {
                    dirToBall.normalize();
                    this.dashVec.copy(dirToBall).multiplyScalar(8.0);
                } else {
                    this.dashVec.set(0, 0, 0);
                }

                const catchAction = this.actions['catch'];
                if (catchAction) {
                    catchAction.setLoop(THREE.LoopOnce);
                    catchAction.clampWhenFinished = true;
                    catchAction.timeScale = 1.5;
                }
                this.play('catch', 0.1);

                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("BLOCK!", this.mesh.position, "default");
                }

            } else {
                this.dashType = 'horizontal';
                this._hasHitTackle = false;

                // Apply velocity impulse in dash direction
// Apply velocity impulse in dash direction
                _pVec.set(nx, 0, nz);
                if (_pVec.lengthSq() < 0.1) {
                    _pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
                }
this.velocity.add(_pVec.multiplyScalar(14.0)); // Nerfed from 20.0

                const lungeAction = this.actions['throw'];
                if (lungeAction) {
                    lungeAction.setLoop(THREE.LoopOnce);
                    lungeAction.clampWhenFinished = true;
                    lungeAction.timeScale = 2.0;
                }
                this.play('throw', 0.1);

                if (window.flux.gameInstance.triggerImpact) window.flux.gameInstance.triggerImpact(0.05, 'default');
            }

if (window.flux.gameInstance.cameraManager) {
                window.flux.gameInstance.cameraManager.addFovImpulse(10);
                window.flux.gameInstance.cameraManager.addShake(0.3); 
            }
            // Dash Effect
            if (window.flux.gameInstance.particleManager) {
                const dashPos = this.mesh.position.clone();
                dashPos.y += 1.0;
                window.flux.gameInstance.particleManager.spawn('shockwave', dashPos, { scale: 1.5, life: 0.3 });
                // Speed lines
                const back = this.velocity.clone().normalize().negate();
                for(let i=0; i<3; i++) {
                    const p = dashPos.clone().add(back.multiplyScalar(Math.random()));
                    p.x += (Math.random()-0.5);
                    window.flux.gameInstance.particleManager.spawn('dash_stream', p, { scale: 1.5 });
                }
            }
        }

        _createHPBar() {
            const container = new THREE.Group();

            const bgGeo = new THREE.PlaneGeometry(1.2, 0.15);
            const bgMat = new THREE.MeshBasicMaterial({ color: 0x000000, side: THREE.DoubleSide, depthTest: false });
            const bg = new THREE.Mesh(bgGeo, bgMat);
            container.add(bg);

            const fillGeo = new THREE.PlaneGeometry(1.16, 0.11);
            fillGeo.translate(0.58, 0, 0);
            const fillMat = new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.DoubleSide, depthTest: false });
            this.hpBarFill = new THREE.Mesh(fillGeo, fillMat);
            this.hpBarFill.position.set(-0.58, 0, 0.01);
            container.add(this.hpBarFill);

            this.hpBar = container;
            this.scene.add(this.hpBar);
        }

_updateHPBar() {
            if (!this.hpBar || !this.mesh) return;

            // Visibility Check: Only show in Active/Practice states
            const game = window.flux.gameInstance;
            const allowedState = game && (game.state === 'active' || game.state === 'kickoff');
            
            if (!allowedState) {
                this.hpBar.visible = false;
                return;
            }

            this.hpBar.position.copy(this.mesh.position);
            this.hpBar.position.y += 2.2;

            if (window.flux.gameInstance && window.flux.gameInstance.camera) {
                this.hpBar.lookAt(window.flux.gameInstance.camera.position);
            }

            const pct = Math.max(0, this.stats.HP / this.stats.maxHP);
            this.hpBarFill.scale.setX(pct);

            if (pct > 0.5) this.hpBarFill.material.color.setHex(0x00ff00);
            else if (pct > 0.25) this.hpBarFill.material.color.setHex(0xffff00);
            else this.hpBarFill.material.color.setHex(0xff0000);

            // Hide if full HP to reduce clutter, unless in practice mode
            const alwaysShow = game && game.gameMode === 'practice';
            this.hpBar.visible = (pct < 0.98 || alwaysShow);
        }

        gainExp(amount) {
            if (!window.flux.gameInstance || window.flux.gameInstance.state !== 'active') return;

            this.exp += amount;

            if (this.exp >= this.nextLevelExp) {
                this.levelUp();
            }
        }

        levelUp() {
            this.level++;
            this.exp -= this.nextLevelExp;
            this.nextLevelExp = Math.floor(this.nextLevelExp * 1.5);

            const keys = ['HP', 'EN', 'AT', 'PA', 'BL', 'SH', 'CA', 'SP'];

            const hpGain = Math.floor(Math.random() * 20) + 10;
            this.stats.maxHP += hpGain;
            this.stats.HP = this.stats.maxHP;

            keys.forEach(k => {
                if (k === 'HP') return;
                if (Math.random() > 0.4) {
                    const gain = Math.floor(Math.random() * 2) + 1;
                    this.stats[k] += gain;
                }
            });

            this._updateDerivedStats();

            console.log(`${this.role} reached Level ${this.level}!`);

            if (window.flux.gameInstance.floatingText && this.mesh) {
                window.flux.gameInstance.floatingText.spawn("LEVEL UP!", this.mesh.position, "tech");
            }
        }

        _checkTackleCollision() {
            if (!this.team || this._hasHitTackle) return;

            const game = window.flux.gameInstance;
            if (!game) return;

            const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
            const opponentTeam = game.teams[opponentTeamId];

            for (const opp of opponentTeam.players) {
                if (!opp.mesh) continue;
                const dist = this.mesh.position.distanceTo(opp.mesh.position);

if (dist < 3.0) { // Increased from 2.0 for easier hits
                    this._resolveTackleHit(opp);
                    this._hasHitTackle = true;
                    return;
                }
            }
        }

        _resolveTackleHit(opp) {
            this.isDashing = false;
            this.velocity.multiplyScalar(-0.5);
            this.play('idle', 0.2);

            const at = this.getStat('AT');
            let damage = at * 3.0;

            if (this.techs.tackle === 'venom') {
                opp.applyStatus('venom', 10.0);
                damage += 5;
            } else if (this.techs.tackle === 'wither') {
                opp.applyStatus('wither', 10.0, 'EN');
                damage += 5;
            } else if (this.techs.tackle === 'drain') {
                this.stats.HP += 20;
                opp.stats.HP -= 20;
                if (window.flux.gameInstance.floatingText)
                    window.flux.gameInstance.floatingText.spawn("DRAIN", this.mesh.position, "heal");
            }

            if (opp.hasBall) {
                opp.currentEN -= damage;

if (window.flux.gameInstance.floatingText) {
                    // Removed "EN" suffix for cleaner look
                    window.flux.gameInstance.floatingText.spawn(`${Math.floor(damage)}`, opp.mesh.position, "damage");
                    window.flux.gameInstance.floatingText.spawn("BAM!", opp.mesh.position, "comic-impact");
                }

                if (opp.currentEN <= 0) {
                    opp.fumble();
                } else {
                    opp.stunTimer = 0.5;
                    opp.playOneShot('react', 0.1);
}

                if (this.techs.tackle && window.flux.gameInstance.triggerTechEvent) {
                    window.flux.gameInstance.triggerTechEvent(this, this.techs.tackle);
                }

            } else {
                opp.stunTimer = 1.0;
                opp.playOneShot('react', 0.1);
if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("SMACK!", opp.mesh.position, "comic-impact");
                }
            }

            const pushDir = opp.mesh.position.clone().sub(this.mesh.position).normalize();
            pushDir.y = 0.2;
            opp.velocity.add(pushDir.multiplyScalar(12.0));

            if (window.flux.gameInstance.triggerImpact) window.flux.gameInstance.triggerImpact(0.1, 'heavy');
            if (window.flux.gameInstance.cameraManager) window.flux.gameInstance.cameraManager.addShake(0.8);
            if (window.flux.gameInstance.spawnClash) {
const mid = this.mesh.position.clone().add(opp.mesh.position).multiplyScalar(0.5);
                window.flux.gameInstance.spawnClash(mid);
            }
            
// Bubble Burst (Tackle Hit)
// Bubble Burst (Tackle Hit)
            if (window.flux.gameInstance.particleManager) {
                const mid = this.mesh.position.clone().lerp(opp.mesh.position, 0.5);
                mid.y += 1.0;
                for(let i=0; i<30; i++) {
                    const bubblePos = mid.clone().add(new THREE.Vector3((Math.random()-0.5)*1.5, (Math.random()-0.5)*1.5, (Math.random()-0.5)*1.5));
                    window.flux.gameInstance.particleManager.spawn('bubble', bubblePos, { scale: 0.15 + Math.random() * 0.35 });
                }
            }
        }

        _applyGoalCrease(dt) {

            const goals = [

                new THREE.Vector3(0, 0, 46),
                new THREE.Vector3(0, 0, -46)
            ];

            const radius = 10.0;

            goals.forEach(goal => {
                const dx = this.mesh.position.x - goal.x;
                const dz = this.mesh.position.z - goal.z;
                const distSq = dx*dx + dz*dz;

                if (distSq < radius * radius) {
                    const dist = Math.sqrt(distSq);
                    const pushX = dist > 0 ? dx / dist : 1;
                    const pushZ = dist > 0 ? dz / dist : 0;

                    const force = 50.0;
                    this.velocity.x += pushX * force * dt;
                    this.velocity.z += pushZ * force * dt;

                    if (dist < radius - 0.5) {
                        const clampRatio = radius / (dist + 0.001);
                        this.mesh.position.x = goal.x + dx * clampRatio;
                        this.mesh.position.z = goal.z + dz * clampRatio;
                    }
                }
            });
        }
    }

    window.flux.Player = Player;
})();
</script>
    <script>(function() {
    window.flux = window.flux || {};

// Formation Definitions (Coordinates for Side 1: Defends +Z, Attacks -Z)
    // X: Left(-)/Right(+), Z: Forward(-)/Back(+)
    const FORMATIONS = {
        'Normal': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 15 }, 'RD': { x: 8, z: 15 },
            'MF': { x: 0, z: 5 },
            'LF': { x: -10, z: -10 }, 'RF': { x: 10, z: -10 }
        },
        'Center Attack': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 15 }, 'RD': { x: 8, z: 15 },
            'MF': { x: 0, z: 0 },
            'LF': { x: -4, z: -15 }, 'RF': { x: 4, z: -15 }
        },
        'Right Side': {
            'GL': { x: 0, z: 25 },
            'LD': { x: 0, z: 15 }, 'RD': { x: 12, z: 15 },
            'MF': { x: 10, z: 5 },
            'LF': { x: 5, z: -10 }, 'RF': { x: 15, z: -10 }
        },
        'Left Side': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -12, z: 15 }, 'RD': { x: 0, z: 15 },
            'MF': { x: -10, z: 5 },
            'LF': { x: -15, z: -10 }, 'RF': { x: -5, z: -10 }
        },
        'All-Out Defense': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -6, z: 20 }, 'RD': { x: 6, z: 20 },
            'MF': { x: 0, z: 10 },
            'LF': { x: -10, z: 5 }, 'RF': { x: 10, z: 5 }
        },
        'Flat Line': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 0 }, 'RD': { x: 8, z: 0 },
            'MF': { x: 0, z: 0 },
            'LF': { x: -15, z: 0 }, 'RF': { x: 15, z: 0 }
        },
        'Counter': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 20 }, 'RD': { x: 8, z: 20 },
            'MF': { x: 0, z: 15 },
            'LF': { x: -12, z: -20 }, 'RF': { x: 12, z: -20 }
        },
        'Double Sides': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -18, z: 15 }, 'RD': { x: 18, z: 15 },
            'MF': { x: 0, z: 5 },
            'LF': { x: -18, z: -10 }, 'RF': { x: 18, z: -10 }
        }
    };



    // --- Enemy Indicator (Red Arrow Sprite) ---
    // Shared texture/material so we don't create 6 canvases.
const _enemyArrowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64;
        c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, c.width, c.height);
        
        // Arrow pointing DOWN
        ctx.beginPath();
        ctx.moveTo(6, 12);   
        ctx.lineTo(58, 12);  
        ctx.lineTo(32, 52);  
        ctx.closePath();
        ctx.fillStyle = '#ff0000';
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = 'rgba(255,255,255,0.95)';
        ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

const _playerArrowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, c.width, c.height);
        
        // Arrow pointing DOWN
        ctx.beginPath();
        ctx.moveTo(6, 12);   
        ctx.lineTo(58, 12);  
        ctx.lineTo(32, 52);  
        ctx.closePath();
        ctx.fillStyle = '#00ff00'; // Green
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = 'rgba(255,255,255,0.95)';
        ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

    const _teammateArrowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, c.width, c.height);
        
        // Arrow pointing DOWN
        ctx.beginPath();
        ctx.moveTo(6, 12);   
        ctx.lineTo(58, 12);  
        ctx.lineTo(32, 52);  
        ctx.closePath();
        ctx.fillStyle = '#ffffff'; // White
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = 'rgba(0,0,0,0.5)';
        ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

    const _enemyArrowMaterial = new THREE.SpriteMaterial({ map: _enemyArrowTexture, transparent: true, depthTest: false, depthWrite: false });
    const _playerArrowMaterial = new THREE.SpriteMaterial({ map: _playerArrowTexture, transparent: true, depthTest: false, depthWrite: false });
    const _teammateArrowMaterial = new THREE.SpriteMaterial({ map: _teammateArrowTexture, transparent: true, depthTest: false, depthWrite: false });
class Team {
        /**
         * Generates and applies stats to a player based on role and level.
         * Centralizes balancing to ensure high-level play feels distinct.
         */
        static generateStats(player, role, level = 1, isHuman = false) {
            // 1. Define Role Baselines (Level 1)
            // Balanced to be weak but functional at Level 1
            const base = {
                HP: 100, SP: 55, EN: 10, AT: 5, PA: 5, BL: 5, SH: 5, CA: 5
            };

            // Role Specializations
            switch(role) {
                case 'LF': case 'RF': // Strikers
                    base.SH += 10; base.SP += 5; base.EN += 5;
                    break;
                case 'MF': // Playmakers
                    base.PA += 10; base.AT += 8; base.EN += 8; base.SP += 2;
                    break;
                case 'LD': case 'RD': // Defenders
                    base.AT += 12; base.BL += 10; base.PA += 5;
                    break;
                case 'GL': // Goalie
                    base.CA += 10; base.SP += 5; base.PA += 15; // Strong arm
                    break;
            }

            // 2. Scaling Factors (Per Level)
            // Designed so Level 50 is "God Tier" and Level 1 is "Rookie"
            const growth = {
                HP: 15,    // +1500 HP at Lvl 99
                SP: 0.5,   // +50 SP at Lvl 99 (Speed demon)
                Primary: 0.8, // +80 Stat at Lvl 99
                Secondary: 0.5 // +50 Stat at Lvl 99
            };

            // Helper to scale
            const scale = (val, rate) => Math.floor(val + ((level - 1) * rate));

            // Apply Scaling
            player.stats.HP = scale(base.HP, growth.HP);
            
            // SP: Cap at 99, but ensure high levels feel FAST
            player.stats.SP = Math.min(99, scale(base.SP, growth.SP));

            // Stat distribution based on role priorities
            if (['LF', 'RF'].includes(role)) {
                player.stats.SH = Math.min(99, scale(base.SH, growth.Primary));
                player.stats.EN = Math.min(99, scale(base.EN, growth.Primary));
                player.stats.AT = Math.min(99, scale(base.AT, growth.Secondary));
                player.stats.PA = Math.min(99, scale(base.PA, growth.Secondary));
                player.stats.BL = Math.min(99, scale(base.BL, growth.Secondary));
            } else if (role === 'MF') {
                player.stats.PA = Math.min(99, scale(base.PA, growth.Primary));
                player.stats.AT = Math.min(99, scale(base.AT, growth.Primary));
                player.stats.EN = Math.min(99, scale(base.EN, growth.Primary));
                player.stats.SH = Math.min(99, scale(base.SH, growth.Secondary));
                player.stats.BL = Math.min(99, scale(base.BL, growth.Secondary));
            } else if (['LD', 'RD'].includes(role)) {
                player.stats.AT = Math.min(99, scale(base.AT, growth.Primary));
                player.stats.BL = Math.min(99, scale(base.BL, growth.Primary));
                player.stats.PA = Math.min(99, scale(base.PA, growth.Secondary));
                player.stats.EN = Math.min(99, scale(base.EN, growth.Secondary));
                player.stats.SH = Math.min(99, scale(base.SH, 0.2)); // Defenders bad at shooting
            } else if (role === 'GL') {
                player.stats.CA = Math.min(99, scale(base.CA, growth.Primary));
                player.stats.PA = Math.min(99, scale(base.PA, growth.Secondary));
                player.stats.SH = Math.min(99, scale(base.SH, 0.3));
            }

            // 3. Human Player Bonus (The "Hero" Feel)
            // Gives the player a slight edge to make gameplay feel punchy
// 3. Human Player Bonus (The "Hero" Feel)
            // Gives the player a slight edge to make gameplay feel punchy
            if (isHuman) {
                player.stats.HP += 300; // Tankier (was 150)
                player.stats.SP += 8;   // Faster (was 5)
                player.stats.EN += 10;   // Harder to tackle (was 5)
                
                // Key Stat Boost
                if (role === 'LF' || role === 'RF') player.stats.SH += 5;
                if (role === 'MF') player.stats.PA += 5;
                if (role === 'LD' || role === 'RD') player.stats.AT += 5;
                if (role === 'GL') player.stats.CA += 5;
            }

            // 4. Finalize
            player.stats.maxHP = player.stats.HP;
            player.level = level;
            player._updateDerivedStats();
        }

constructor(scene, id, side, color, isHuman) {
            this.scene = scene;
            this.id = id; // 'home' or 'away'
            this.side = side; // 1 (Defends +Z) or -1 (Defends -Z)
            this.color = color;
            this.isHuman = isHuman;
            this.aiEnabled = true; // Master switch for AI logic
            
            this.players = [];
            this.activePlayer = null; // The player currently controlled/focused
            
            // Formation Anchors
            this.currentFormation = 'Normal';
            
            // Player Indicator (Green Arrow)
            if (this.isHuman) {
                this.playerArrow = new THREE.Sprite(_playerArrowMaterial);
                this.playerArrow.scale.set(0.8, 0.8, 1.0);
                this.playerArrow.renderOrder = 1000; // On top
            }
        }

        assignMarks(opposingTeam) {
            // Simple auto-assign logic: Mark the player in the "matching" position
            // LF<->RD, RF<->LD, MF<->MF, LD<->RF, RD<->LF, GL<->LF
            this.players.forEach(p => {
                let targetRole = 'MF';
                switch (p.role) {
                    case 'LF': targetRole = 'RD'; break;
                    case 'RF': targetRole = 'LD'; break;
                    case 'MF': targetRole = 'MF'; break;
                    case 'LD': targetRole = 'RF'; break;
                    case 'RD': targetRole = 'LF'; break;
                    case 'GL': targetRole = 'LF'; break;
                }

                const target = opposingTeam.players.find(op => op.role === targetRole);
                if (target) {
                    p.marking = target;
                    // console.log(`${this.id} ${p.role} marked ${target.role}`);
                }
            });
        }

        addPlayer(player) {
            this.players.push(player);
            player.team = this;

            // Calculate Home Position based on Formation
            this._updatePlayerHomePosition(player);

            // Enemy indicator: red arrows over the Away team (so enemies are readable)
// Enemy indicator: red arrows over the Away team
            if (this.id === 'away' && player.mesh) {
                const arrow = new THREE.Sprite(_enemyArrowMaterial);
                arrow.scale.set(0.8, 0.8, 1.0);
                arrow.position.set(0, 3.2, 0); // above head
                arrow.renderOrder = 999;
                player.mesh.add(arrow);
                player.enemyArrow = arrow;
            }

            // Teammate indicator: White arrows for inactive humans
            if (this.isHuman && player.mesh) {
                const arrow = new THREE.Sprite(_teammateArrowMaterial);
                arrow.scale.set(0.6, 0.6, 1.0);
                arrow.position.set(0, 3.2, 0);
                arrow.renderOrder = 999;
                arrow.visible = false; // Hidden by default, managed by setActivePlayer
                player.mesh.add(arrow);
                player.teammateArrow = arrow;
            }
        }

        setFormation(name) {
            if (!FORMATIONS[name]) return;
            this.currentFormation = name;
            // console.log(`Team ${this.id} switched to ${name}`);
            
            this.players.forEach(p => {
                this._updatePlayerHomePosition(p);
            });
        }

_updatePlayerHomePosition(player) {
            const data = FORMATIONS[this.currentFormation];
            if (!data) return;

            const offset = data[player.role];
            if (offset) {
                // X Position:
                // Formations: -X is Left, +X is Right.
                // Home Team (Side 1) faces -Z. Left is -X. Use offset.x as is.
                let xPos = offset.x;
                let zPos = offset.z * this.side;

                player.homePosition.set(xPos, 0, zPos);
                
                // Away Team (Side -1) faces +Z. Left is +X. Flip X.
                if (this.side === -1) {
                    player.homePosition.x *= -1; 
                }
            }
            
            // Set initial position
            if (player.mesh) {
                player.mesh.position.copy(player.homePosition);
                // Face center (0,0,0)
                player.mesh.lookAt(0, 0, 0);
            }
        }

        update(dt) {
            // Update all players
            for (let i = 0; i < this.players.length; i++) {
                this.players[i].update(dt);
            }

            // Auto-switch active player if Human
            if (this.isHuman) {
                this.updateActivePlayerSelection();
            }
        }

        updateActivePlayerSelection() {
            const ball = window.flux.gameInstance.entities.ball;
            if (!ball) return;

            // 1. OFFENSE: If we have the ball, active player is the holder
            if (ball.holder && ball.holder.team === this) {
                if (this.activePlayer !== ball.holder) {
                    this.setActivePlayer(ball.holder);
                }
                return;
            }

            // 2. DEFENSE: Select closest to ball
            // Optimization: Only check every few frames or if distance is significant
            let closest = null;
            let minDst = Infinity;

            for (const p of this.players) {
                if (p.role === 'GL') continue; // Don't auto-switch to goalie usually
                if (!p.mesh) continue;

                const d = p.mesh.position.distanceTo(ball.mesh.position);
                if (d < minDst) {
                    minDst = d;
                    closest = p;
                }
            }

            if (closest && closest !== this.activePlayer) {
                this.setActivePlayer(closest);
            }
        }

setActivePlayer(player) {
            // Reset input on previous
            if (this.activePlayer) {
                this.activePlayer.setInput(0, 0);
            }
            this.activePlayer = player;

            // Visual Indicators
            if (this.isHuman) {
                // 1. Green Arrow for Active
                if (this.playerArrow && player.mesh) {
                    player.mesh.add(this.playerArrow);
                    this.playerArrow.position.set(0, 3.5, 0); // Float above head
                }

                // 2. White Arrows for Others
                this.players.forEach(p => {
                    if (p.teammateArrow) {
                        p.teammateArrow.visible = (p !== player);
                    }
                });
            }
        }

resetPositions() {
            for (const p of this.players) {
                if (p.mesh) {
                    p.mesh.position.copy(p.homePosition);
                    
                    // Reset Physics
                    p.velocity.set(0, 0, 0);
                    p.inputVector.set(0, 0, 0);
                    p.isDashing = false;
                    p.isThrowing = false;
p.loseBall(); // Drop ball if holding
                    p.canCatch = true; // Force reset capability
                    
                    // Reset Stats
                    p.currentEN = p.stats.EN;
                    
// Orientation: Face Center
                    p.mesh.lookAt(0, 0, 0);
                    if (p.syncRotation) p.syncRotation();
                    
                    // Reset Animation
                    p.play('idle', 0.1);
                }
            }
            // Reset active player to MF
            const mf = this.players.find(p => p.role === 'MF');
            if (mf) this.setActivePlayer(mf);
        }
    }

    window.flux.Team = Team;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Reusable vectors
    const _aiVec = new THREE.Vector3();
    const _targetPos = new THREE.Vector3();
    const _scanDir = new THREE.Vector3();
    const _scanToOpp = new THREE.Vector3();
    const _tempVec1 = new THREE.Vector3();
    const _tempVec2 = new THREE.Vector3();

    class AIPlayer extends window.flux.Player {
        constructor(scene, role) {
            super(scene, role);
            this.ballRef = null;
            
            // Stats are managed by Team/Main or default Player values.
            this._updateDerivedStats();

            // State Machine
            this.aiState = 'IDLE';
            this.decisionTimer = 0;
            this.decisionInterval = 0.5; // Slower decisions

            // --- PERCEPTION SYSTEM (Reaction Time) ---
            this.perceivedTargetPos = new THREE.Vector3();
            this.reactionSpeed = 1.5; 
            this.anticipationTime = 0.2; 
            
            // Role Config
            this.isForward = ['LF', 'RF'].includes(role);
            this.isMidfielder = role === 'MF';
            this.isDefender = ['LD', 'RD'].includes(role);

            this.techImmunityTimer = 0;
            this._assignDefaultTechs();
        }

        _assignDefaultTechs() {
            const tackleTechs = ['venom', 'wither', 'drain'];
            const shootTechs = ['venom', 'sphere', 'invisible'];
            const passTechs = ['venom', 'wither', 'nap'];
            const passiveTechs = ['brawler', 'elite_defense'];

            const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
            const chance = (prob) => Math.random() < prob;

            if (this.isDefender) {
                if (chance(0.3)) this.techs.tackle = pick(tackleTechs);
                if (chance(0.1)) this.techs.pass = pick(passTechs);
                if (chance(0.2)) this.techs.passive = pick(passiveTechs);
            } else if (this.isMidfielder) {
                if (chance(0.2)) this.techs.tackle = pick(tackleTechs);
                if (chance(0.2)) this.techs.pass = pick(passTechs);
                if (chance(0.1)) this.techs.shoot = pick(shootTechs);
                if (chance(0.1)) this.techs.passive = pick(passiveTechs);
            } else if (this.isForward) {
                if (chance(0.3)) this.techs.shoot = pick(shootTechs);
                if (chance(0.1)) this.techs.tackle = pick(tackleTechs);
                if (chance(0.1)) this.techs.passive = pick(passiveTechs);
            }
        }

        update(dt) {
            // Safety: Auto-link ball if missing
            if (!this.ballRef && window.flux.gameInstance && window.flux.gameInstance.entities) {
                this.ballRef = window.flux.gameInstance.entities.ball;
            }

            const game = window.flux.gameInstance;
            const isDemo = game && game.isDemoMode;
            
            const isIncapacitated = (this.stunTimer > 0) || (this.status.nap > 0);
            
            const isHumanTeam = this.team && this.team.isHuman;
            const isActivePlayer = this.team && (this.team.activePlayer === this);
            const shouldRunAI = (!isHumanTeam || isDemo || (isHumanTeam && !isActivePlayer));
            
            const isTeamAIEnabled = this.team ? this.team.aiEnabled : true;

            if (isIncapacitated) {
                this.setInput(0, 0);
            } else if (shouldRunAI && isTeamAIEnabled) {
                // --- PERCEPTION UPDATE ---
                if (this.ballRef && this.ballRef.mesh) {
                    let realTarget = this.ballRef.mesh.position.clone();

                    if (this.ballRef.holder && this.ballRef.holder.mesh) {
                        realTarget = this.ballRef.holder.mesh.position.clone();
                        if (this.ballRef.holder.velocity) {
                            realTarget.addScaledVector(this.ballRef.holder.velocity, this.anticipationTime);
                        }
                    } else if (this.ballRef.velocity) {
                        realTarget.addScaledVector(this.ballRef.velocity, this.anticipationTime * 0.5);
                    }

                    const alpha = Math.min(1.0, dt * this.reactionSpeed);
                    this.perceivedTargetPos.lerp(realTarget, alpha);
                }

                // 1. Decision Making
                this.decisionTimer += dt;
                if (this.decisionTimer > this.decisionInterval) {
                    this.decisionTimer = 0;
                    this._evaluateState();
                }

                // 2. Execute State
                this._executeState(dt);
                
                // 3. Interception Logic
                if (this.techImmunityTimer > 0) this.techImmunityTimer -= dt;
                this._applyInterceptionPressure(dt);

            } else {
                // AI Disabled or Human Controlled
                const isDrivenByHuman = isHumanTeam && isActivePlayer && !isDemo;
                if (!isDrivenByHuman) {
                    this.setInput(0, 0);
                }
                // Passive interception still applies
                this._applyInterceptionPressure(dt);
            }

            // 4. Base Update
            super.update(dt);
        }

        _evaluateState() {
            if (!this.ballRef) return;
            const ball = this.ballRef;

            if (this.hasBall) {
                this.aiState = 'ATTACK_CARRY';
                return;
            }

            if (!ball.holder) {
                this.aiState = 'RETURN_HOME';
                const bias = (this.aiState === 'CHASE') ? 0.8 : 1.0;
                const myDist = this.mesh.position.distanceTo(ball.mesh.position) * bias;
                
                let isClosest = true;
                if (this.team && this.team.players) {
                    for (const p of this.team.players) {
                        if (p === this) continue;
                        if (!p.mesh) continue;
                        if (p.role === 'GL') continue;
                        if (p.status && p.status.nap > 0) continue;

                        const pDist = p.mesh.position.distanceTo(ball.mesh.position);
                        if (pDist < myDist) {
                            isClosest = false;
                            break;
                        }
                    }
                }

                if (isClosest) {
                    this.aiState = 'CHASE';
                }
                return;
            }

            if (ball.holder.team === this.team) {
                this.aiState = 'SUPPORT';
                return;
            }

            if (ball.holder.team !== this.team) {
                this.aiState = 'DEFEND';
                return;
            }
        }

        _executeState(dt) {
            if (!this.ballRef) {
                this.setInput(0, 0);
                return;
            }

            switch (this.aiState) {
                case 'ATTACK_CARRY': this._stateAttackCarry(dt); break;
                case 'SUPPORT': this._stateSupport(dt); break;
                case 'DEFEND': this._stateDefend(dt); break;
                case 'CHASE': this._stateChase(dt); break;
                case 'RETURN_HOME': 
                default: this._stateReturnHome(dt); break;
            }
        }

        _stateAttackCarry(dt) {
            const attackDir = (this.team.side === 1) ? -1 : 1;
            const goalZ = 46 * attackDir;
            
            _targetPos.set(0, 0, goalZ);
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);

            const distToGoal = Math.abs(this.mesh.position.z - goalZ);
            
            if (distToGoal < 20.0 && !this.isThrowing) {
                this._smartThrow(this.ballRef, 'SH'); 
                return;
            }
            
            const isSurrounded = this._isSurrounded();
            const lowEN = this.currentEN < 10;
            const isPlaymaker = this.isMidfielder;
            
            if ((isSurrounded || lowEN || isPlaymaker) && !this.isThrowing) {
                const bestMate = this._findBestPassTarget();
                if (bestMate) {
                    let shouldPass = false;
                    if (isSurrounded || lowEN) {
                        shouldPass = true;
                    } else if (isPlaymaker) {
                        const myDist = Math.abs(this.mesh.position.z - goalZ);
                        const mateDist = Math.abs(bestMate.mesh.position.z - goalZ);
                        if (mateDist < myDist - 5.0) shouldPass = true;
                    }
                    
                    if (shouldPass) {
                        this.mesh.lookAt(bestMate.mesh.position);
                        this._smartThrow(this.ballRef, 'PA');
                        return;
                    }
                }
            }
            
            if (isSurrounded && !this.isThrowing) {
                this._smartThrow(this.ballRef, 'SH');
            }
        }

        _isSurrounded() {
            let count = 0;
            const game = window.flux.gameInstance;
            if (!game) return false;
            const oppTeam = (this.team.id === 'home') ? game.teams.away : game.teams.home;
            
            for(let p of oppTeam.players) {
                if (p.mesh && p.mesh.position.distanceTo(this.mesh.position) < 4.0) {
                    count++;
                }
            }
            return count >= 2;
        }

        _smartThrow(ball, forcedType = null) {
            let type = forcedType;
            if (!type) {
                _tempVec1.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
                const attackDir = (this.team && this.team.side === 1) ? -1 : 1;
                const isAimingGoal = (_tempVec1.z * attackDir > 0.5);
                type = isAimingGoal ? 'SH' : 'PA';
            }

            const techName = (type === 'SH') ? this.techs.shoot : this.techs.pass;
            let baseCost = (type === 'SH') ? 20 : 10;
            let techCost = 0;
            
            if (techName) {
                if (techName.includes('nap')) techCost = 30;
                else if (techName.includes('sphere') || techName.includes('invisible')) techCost = 25;
                else techCost = 20;
            }

            const totalCost = baseCost + techCost;
            let tempTech = null;
            if (techName && this.stats.HP < totalCost && this.stats.HP >= baseCost) {
                if (type === 'SH') {
                    tempTech = this.techs.shoot;
                    this.techs.shoot = null;
                } else {
                    tempTech = this.techs.pass;
                    this.techs.pass = null;
                }
            }

            this.throwBall(ball, type);

            if (tempTech) {
                if (type === 'SH') this.techs.shoot = tempTech;
                else this.techs.pass = tempTech;
            }
        }

        _stateChase(dt) {
            _targetPos.copy(this.perceivedTargetPos);
            const ball = this.ballRef;
            if (ball.velocity.lengthSq() > 1.0) {
                _targetPos.addScaledVector(ball.velocity, 0.3);
            }
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);
        }

        _stateReturnHome(dt) {
            _targetPos.copy(this.homePosition);
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);
        }

        _stateSupport(dt) {
            const ball = this.ballRef;
            const carrier = ball.holder;
            
            if (!carrier || !carrier.mesh) {
                this._stateReturnHome(dt);
                return;
            }

            const ballPos = carrier.mesh.position;
            const attackDir = (this.team.side === 1) ? -1 : 1;
            const goalZ = (this.team.side === 1) ? -46 : 46;

            const pressure = this._calculatePressureOnPlayer(carrier);

            _targetPos.copy(this.homePosition);
            _targetPos.z += ballPos.z * 0.6;

            if (this.isForward) {
                let targetZ = ballPos.z + (attackDir * 15.0); 
                if (pressure > 0.8) {
                    targetZ = ballPos.z + (attackDir * 8.0);
                }
                const time = Date.now() * 0.001;
                const weave = Math.sin(time + this.mesh.id) * 6.0;
                _targetPos.x = this.homePosition.x + weave;
                _targetPos.z = targetZ;

            } else if (this.isMidfielder) {
                if (pressure > 0.8) {
                    const side = (this.mesh.position.x > ballPos.x) ? 1 : -1;
                    _targetPos.x = ballPos.x + (side * 10.0);
                    _targetPos.z = ballPos.z - (attackDir * 2.0);
                } else {
                    const midZ = (ballPos.z + goalZ) * 0.45;
                    _targetPos.z = midZ;
                    if (ballPos.x < -5) _targetPos.x = 5;
                    else if (ballPos.x > 5) _targetPos.x = -5;
                    else _targetPos.x = (this.homePosition.x > 0 ? 8 : -8);
                }

            } else {
                const safetyDist = 12.0;
                _targetPos.z = ballPos.z - (attackDir * safetyDist);
                if (this.team.side === 1) _targetPos.z = Math.min(38, _targetPos.z);
                else _targetPos.z = Math.max(-38, _targetPos.z);
                _targetPos.x = ballPos.x * 0.6 + this.homePosition.x * 0.4;
            }

            if (this._isPathBlocked(_targetPos, ballPos)) {
                _tempVec1.copy(_targetPos); _tempVec1.x -= 8.0;
                _tempVec2.copy(_targetPos); _tempVec2.x += 8.0;
                
                const blockedL = this._isPathBlocked(_tempVec1, ballPos);
                const blockedR = this._isPathBlocked(_tempVec2, ballPos);
                
                if (!blockedL && !blockedR) {
                    if (Math.abs(_targetPos.x - _tempVec1.x) < Math.abs(_targetPos.x - _tempVec2.x)) {
                        _targetPos.copy(_tempVec1);
                    } else {
                        _targetPos.copy(_tempVec2);
                    }
                } else if (!blockedL) {
                    _targetPos.copy(_tempVec1);
                } else if (!blockedR) {
                    _targetPos.copy(_tempVec2);
                } else {
                    _targetPos.lerp(ballPos, 0.4);
                }
            }

            this._avoidTeammates(_targetPos);
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);
        }

        _stateDefend(dt) {
            const targetPos = this.perceivedTargetPos;
            const distToBall = this.mesh.position.distanceTo(targetPos);
            
            let pressRange = this.isDefender ? 12.0 : 8.0;
            if (this.techs.tackle && this.stats.HP > 20) {
                pressRange += 5.0; 
            }

            let amIClosest = true;
            const myDistSq = distToBall * distToBall;
            
            if (this.team && this.team.players) {
                for(const mate of this.team.players) {
                    if (mate === this || !mate.mesh) continue;
                    if (mate.role === 'GL' || mate.status.nap > 0 || mate.stunTimer > 0) continue;
                    
                    const dSq = mate.mesh.position.distanceToSquared(targetPos);
                    if (dSq < myDistSq) {
                        amIClosest = false;
                        break;
                    }
                }
            }

            if (amIClosest) {
                pressRange = 100.0;
            } else {
                const distToMyGoal = Math.abs(targetPos.z - (this.team.side === 1 ? 46 : -46));
                if (distToMyGoal < 40.0) {
                    pressRange = 15.0;
                } else {
                    pressRange = 8.0;
                }
            }
            
            if (distToBall < pressRange) {
                if (distToBall < 3.0 && !this.isDashing && this.currentEN > 5 && Math.random() < 0.02) {
                    const dir = _tempVec1.subVectors(targetPos, this.mesh.position).normalize();
                    if (this.ballRef && this.ballRef.velocity) {
                        dir.addScaledVector(this.ballRef.velocity, 0.1).normalize();
                    }
                    this.dash(dir.x, dir.z);
                    return;
                }

                _targetPos.copy(targetPos);
                this._avoidGoalCrease(_targetPos);
                this._moveTo(_targetPos);
                return;
            }

            if (this.marking && this.marking.mesh) {
                const markPos = this.marking.mesh.position;
                const myGoalZ = (this.team.side === 1) ? 46 : -46;
                _tempVec1.set(0, 0, myGoalZ - markPos.z);
                _tempVec1.normalize();
                _targetPos.copy(markPos).addScaledVector(_tempVec1, 3.5);
                this._avoidGoalCrease(_targetPos);
                this._moveTo(_targetPos);
                return;
            }

            _targetPos.copy(this.homePosition);
            _targetPos.z += this.ballRef.mesh.position.z * 0.6;
            
            if (this.isDefender) {
                const myGoalZ = (this.team.side === 1) ? 46 : -46;
                const midpoint = (this.ballRef.mesh.position.z + myGoalZ) * 0.5;
                _targetPos.z = (_targetPos.z + midpoint) * 0.5;
            }

            _targetPos.z = Math.max(-44.0, Math.min(44.0, _targetPos.z));
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);
        }

        _avoidGoalCrease(targetPos) {
            const creaseRadius = 10.0;
            const goals = [{ x: 0, z: -46 }, { x: 0, z: 46 }];

            goals.forEach(goal => {
                const dx = targetPos.x - goal.x;
                const dz = targetPos.z - goal.z;
                const distSq = dx*dx + dz*dz;

                if (distSq < creaseRadius * creaseRadius) {
                    const dist = Math.sqrt(distSq);
                    if (dist > 0.001) {
                        const ratio = creaseRadius / dist;
                        targetPos.x = goal.x + dx * ratio;
                        targetPos.z = goal.z + dz * ratio;
                    } else {
                        targetPos.z = goal.z + (goal.z > 0 ? -creaseRadius : creaseRadius);
                    }
                }
            });

            const arenaRadius = 45.0;
            const dSq = targetPos.x * targetPos.x + targetPos.z * targetPos.z;
            if (dSq > arenaRadius*arenaRadius) {
                const d = Math.sqrt(dSq);
                const r = arenaRadius / d;
                targetPos.x *= r;
                targetPos.z *= r;
            }
        }

        _findBestPassTarget() {
            let bestTarget = null;
            let maxScore = -Infinity;
            const goalZ = (this.team.side === 1) ? -46 : 46;

            for (const mate of this.team.players) {
                if (mate === this) continue;
                if (!mate.mesh) continue;
                if (mate.status.nap > 0) continue;
                if (mate.stunTimer > 0) continue;
                
                const dist = this.mesh.position.distanceTo(mate.mesh.position);
                if (dist < 4.0) continue;
                if (dist > 30.0) continue;
                
                if (this._isPathBlocked(mate.mesh.position)) continue; 
                
                let score = 0;
                const myDistToGoal = Math.abs(this.mesh.position.z - goalZ);
                const mateDistToGoal = Math.abs(mate.mesh.position.z - goalZ);
                const progress = myDistToGoal - mateDistToGoal;
                
                score += progress * 1.5; 
                if (mateDistToGoal < 15.0) score += 10.0;
                if (mateDistToGoal < 8.0) score += 15.0;

                const openness = this._calculateOpenness(mate);
                score += openness * 3.0;

                if (mate.isForward) score += 5.0;
                score -= dist * 0.5;

                if (score > maxScore) {
                    maxScore = score;
                    bestTarget = mate;
                }
            }
            return bestTarget;
        }

        _calculateOpenness(player) {
            let minDefDist = 999;
            const game = window.flux.gameInstance;
            if (!game) return 0;
            const oppTeam = (this.team.id === 'home') ? game.teams.away : game.teams.home;

            for (const opp of oppTeam.players) {
                if (!opp.mesh || opp.status.nap > 0 || opp.stunTimer > 0) continue;
                const d = player.mesh.position.distanceTo(opp.mesh.position);
                if (d < minDefDist) minDefDist = d;
            }
            return Math.min(minDefDist, 8.0);
        }

        _isPathBlocked(targetPos, startPos = null) {
            const start = startPos || this.mesh.position;
            const end = targetPos;
            const dist = start.distanceTo(end);
            
            _scanDir.subVectors(end, start).normalize();
            
            const game = window.flux.gameInstance;
            if (!game) return false;
            const oppTeam = (this.team.id === 'home') ? game.teams.away : game.teams.home;
            const safetyRadius = 2.5; 

            for (const opp of oppTeam.players) {
                if (!opp.mesh || opp.status.nap > 0 || opp.stunTimer > 0) continue;
                
                _scanToOpp.subVectors(opp.mesh.position, start);
                const projection = _scanToOpp.dot(_scanDir);
                
                if (projection > 0 && projection < dist) {
                    const perpDistSq = _scanToOpp.lengthSq() - (projection * projection);
                    if (perpDistSq < (safetyRadius * safetyRadius)) {
                        return true;
                    }
                }
            }
            return false;
        }

        _moveTo(target) {
            _aiVec.subVectors(target, this.mesh.position);
            _aiVec.y = 0;
            
            const distSq = _aiVec.lengthSq();
            if (distSq > 1.0) {
                _aiVec.normalize();
                this.setInput(_aiVec.x, _aiVec.z);
            } else {
                this.setInput(0, 0);
                this.velocity.multiplyScalar(0.8);
            }
        }

        _applyInterceptionPressure(dt) {
            const ball = this.ballRef;
            if (!ball || !ball.mesh) return;

            if (ball.state !== 'free' || ball.velocity.lengthSq() < 1.0) return;
            if (ball.isInvisible) return;
            if (this.status.nap > 0 || this.stunTimer > 0) return;

            let range = 2.0;
            if (this.techs.passive === 'brawler' || this.techs.passive === 'elite_defense') {
                range += 1.5;
            }

            const dist = this.mesh.position.distanceTo(ball.mesh.position);
            if (dist > range) return;

            _scanToOpp.subVectors(this.mesh.position, ball.mesh.position).normalize();
            _tempVec1.copy(ball.velocity).normalize();
            
            const headingDot = _tempVec1.dot(_scanToOpp);
            if (headingDot < 0.7) return;

            const distFactor = Math.max(0, 1.0 - (dist / range));
            const pressure = 1.5;

            if (ball.power > 0) {
                ball.power -= pressure;
                this._accumulatedBlock = (this._accumulatedBlock || 0) + pressure;
                if (this._accumulatedBlock >= 5.0) { 
                    const val = Math.floor(this._accumulatedBlock);
                    this._accumulatedBlock -= val;
                    if (window.flux.gameInstance.floatingText) { 
                         window.flux.gameInstance.floatingText.spawn(`-${val}`, ball.mesh.position, "block", ball.mesh);
                    }
                }
            }

            if (Math.random() < (distFactor * 0.8)) { 
                _tempVec2.copy(this.mesh.position).lerp(ball.mesh.position, 0.5 + (Math.random()-0.5)*0.2);
                _tempVec2.x += (Math.random()-0.5) * 0.5;
                _tempVec2.y += (Math.random()-0.5) * 0.5;
                _tempVec2.z += (Math.random()-0.5) * 0.5;
                
                if (window.flux.gameInstance.spawnClash) {
                    window.flux.gameInstance.spawnClash(_tempVec2, 0.6);
                }
            }

            if (ball.power <= 0 && ball.powerType === 'SH') {
                ball.powerType = 'none';
                if (window.flux.gameInstance.floatingText) { 
                    window.flux.gameInstance.floatingText.spawn("BLOCKED", this.mesh.position, "comic-impact");
                }
            }

            if (ball.technique && this.techImmunityTimer <= 0) {
                this.techImmunityTimer = 2.0;
                const tech = ball.technique;
                if (tech.type === 'venom') this.applyStatus('venom', 15.0);
                else if (tech.type === 'nap') this.applyStatus('nap', 8.0);
                else if (tech.type === 'wither') this.applyStatus('wither', 15.0, 'BL');
            }
        }

        _calculatePressureOnPlayer(player) {
            if (!player || !player.mesh) return 0;
            const game = window.flux.gameInstance;
            if (!game) return 0;
            
            const oppTeam = (player.team.id === 'home') ? game.teams.away : game.teams.home;
            let pressure = 0;
            
            for (const opp of oppTeam.players) {
                if (!opp.mesh || opp.status.nap > 0 || opp.stunTimer > 0) continue;
                const dist = player.mesh.position.distanceTo(opp.mesh.position);
                if (dist < 10.0) {
                    pressure += (10.0 - dist) / 10.0;
                }
            }
            return pressure;
        }

        _avoidTeammates(targetPos) {
            if (!this.team) return;
            for (const mate of this.team.players) {
                if (mate === this || !mate.mesh) continue;
                if (mate.hasBall) continue;
                
                const dist = targetPos.distanceTo(mate.mesh.position);
                if (dist < 5.0) {
                    _tempVec1.subVectors(targetPos, mate.mesh.position).normalize();
                    targetPos.addScaledVector(_tempVec1, 5.0 - dist);
                }
            }
        }
    }

    window.flux.AIPlayer = AIPlayer;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};
    
    // Reusable vectors to avoid GC
const _gVec = new THREE.Vector3();
    const _gPos = new THREE.Vector3();
    const _ballPos = new THREE.Vector3();
    const _faceVec = new THREE.Vector3();
    const _goalCenter = new THREE.Vector3();
    const _tempVecG = new THREE.Vector3();

    class Goalie extends window.flux.Player {
constructor(scene, role) {
            super(scene, role);
            
            // Goalie Specific Stats (Buffed for Playability)
            this.stats.CA = 30; // Catch
            this.stats.SP = 40; // Speed
            this.stats.EN = 50;
            
            // BUFFED: Strong arm for clearing the zone
            this.stats.PA = 45; // Was 20 - Now strong enough to reach midfield
            this.stats.SH = 35; // Was 10 - Decent clearance kick
            
            this._updateDerivedStats();

            // Goal Dimensions (Save Box) - Matches GameManager detection
            this.goalWidth = 22.0; 
            this.goalHeight = 18.0; 
            
            // Save Mechanics
            this.saveRadius = 6.0; 
            this.pressureMultiplier = 5.0; 
            
            // Techs
            this.techs = {
                active: null, 
                passive: null 
            };
            
            // AI State
            this.throwTimer = 0;
            this._accumulatedSave = 0;
            
            // Super Goalie State
            this.isSuperGoalie = false;
            this.superGoalieTimer = 0;

// Perception Smoothing (Reaction Delay)
            this.perceivedBallPos = new THREE.Vector3();
            this.reactionSpeed = 4.0; // Lower = more delay/smoothing
            this.techImmunityTimer = 0;
        }

        update(dt) {
            // 1. Super Goalie Timer
            if (this.isSuperGoalie) {
                this.superGoalieTimer -= dt;
                if (this.superGoalieTimer <= 0) {
                    this.isSuperGoalie = false;
                }
            }
            
            // 2. Possession Logic (Ball Held)
            if (this.hasBall) {
                this._checkTacklePressure(dt);
                
                const game = window.flux.gameInstance;
                const isHumanControlled = this.team && this.team.isHuman && this.team.activePlayer === this && !game.isDemoMode;
                
                if (isHumanControlled) {
                    // Human: Full control (Rotation, Charging, etc via Player.update)
                    super.update(dt);
                } else {
                    // AI: Logic then update
                    if (!this.isThrowing) {
                        this._aiPossessionLogic(dt);
                    }
                    // Ensure AI doesn't drift
                    this.setInput(0, 0);
                    super.update(dt);
                }
                this._constrainBounds();
                return; 
            }

            // 3. Defense / Save Logic (No Ball)
            // We must handle timers and status manually because we skip super.update() to use custom movement
            if (this.dashCooldown > 0) this.dashCooldown -= dt;
            if (this.clashCooldown > 0) this.clashCooldown -= dt;
            if (this.stunTimer > 0) this.stunTimer -= dt;
            if (this.immunityTimer > 0) this.immunityTimer -= dt;
if (this.immunityTimer > 0) this.immunityTimer -= dt;
            this._updateStatus(dt);

            if (this.stunTimer > 0 || this.status.nap > 0) {
                if (this.mixer) this.mixer.update(dt);
                this._updateHPBar();
                this._constrainBounds();
                return;
            }

            // Custom Movement
            this._defenseLogic(dt);
            
            // Update Animation
            if (this.mixer) this.mixer.update(dt);
            this._updateHPBar();
            
            this._constrainBounds();
        }

_constrainBounds() {
            if (!this.mesh) return;
            const pos = this.mesh.position;
            const side = this.team ? this.team.side : 1;
            
            // X Bounds (Width of penalty area +/- 10m) -> Increased for massive goal
const xLimit = 20.0; // Reduced width of goalie movement
            if (pos.x > xLimit) { pos.x = xLimit; this.velocity.x = 0; }
            if (pos.x < -xLimit) { pos.x = -xLimit; this.velocity.x = 0; }
            
            // Y Bounds
            const yLimit = 12.0; // Reduced height ceiling
            if (pos.y > yLimit) { pos.y = yLimit; this.velocity.y = 0; }
            if (pos.y < -yLimit) { pos.y = -yLimit; this.velocity.y = 0; }
            
            // Z Bounds (Depth)
// Z Bounds (Depth)
            // Home (Side 1): Goal at +46. Trigger at 45. Limit to 45.5.
            // Away (Side -1): Goal at -46. Trigger at -45. Limit to -45.5.
            if (side === 1) {
                if (pos.z > 45.5) { pos.z = 45.5; this.velocity.z = 0; }
                if (pos.z < 20.0) { pos.z = 20.0; this.velocity.z = 0; }
            } else {
                if (pos.z < -45.5) { pos.z = -45.5; this.velocity.z = 0; }
                if (pos.z > -20.0) { pos.z = -20.0; this.velocity.z = 0; }
            }
        }

// Override throwBall to fix "weak throw" issue
// Override throwBall to fix "weak throw" issue and reduce loft
        throwBall(ball, forcedType = null, powerMultiplier = 1.0) {
            if (!this.hasBall || this.isThrowing) return;
            
            this.isThrowing = true;
            const type = forcedType || 'PA';
            const boost = 1.2;
            const finalPower = powerMultiplier * boost;

            // Animation
            const throwKey = (type === 'SH' && this.actions['throw_shot']) ? 'throw_shot' : 'throw_pass';
            this.playOneShot(throwKey, 0.1, { timeScale: 1.2 });

            if (window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("CLEAR!", this.mesh.position, "comic-action");
            }

            setTimeout(() => {
                if (this.hasBall || (ball && ball.holder === this)) {
                    // Calculate Direction
                    const finalDir = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
                    
                    // REDUCED LOFT: Goalie throws flatter (0.25 instead of 0.8)
                    finalDir.y += 0.25; 
                    finalDir.normalize();

                    // Calculate Stats
                    let statVal = this.getStat(type);
                    statVal *= finalPower;

                    ball.shoot(finalDir, statVal, type);
                    
                    // Extra grace period for Goalie
                    ball.catchGracePeriod = 0.6;

                    this.loseBall();
                    this.catchCooldown = 1.0;
                }
            }, 300); // Windup time

            setTimeout(() => {
                this.isThrowing = false;
                this._updateLocomotionAnim(0.2);
            }, 800);
        }

_defenseLogic(dt) {
            // 0. Game State Check
            if (window.flux.gameInstance.state !== 'active') return;

            const ball = window.flux.gameInstance.entities.ball;
            if (!ball || !ball.mesh) return;

            // --- PERCEPTION UPDATE ---
            // Smoothly interpolate perceived position towards real ball position
            // This creates a natural reaction delay and prevents jittery mirroring
            this.perceivedBallPos.lerp(ball.mesh.position, dt * this.reactionSpeed);

            // Determine Threat Source
            let threatPos = _ballPos;
            let isThreat = false;
            const myGoalZ = (this.team.side === 1) ? 46 : -46;

            // Case A: Ball is Held (Pre-throw)
            if (ball.state === 'held' && ball.holder && ball.holder.team !== this.team) {
                // Track holder, but use perceived position if we wanted to simulate reading the player
                // For now, tracking the ball (which is on the player) via perceivedPos is sufficient
                threatPos = this.perceivedBallPos;
                
                // Check if holder is in attacking half or near enough
                const distToGoal = Math.abs(threatPos.z - myGoalZ);
                if (distToGoal < 40.0) { // If they are within 40m, track them
                    isThreat = true;
                }
            } 
            // Case B: Ball is Free (Shot/Pass)
            else if (ball.state === 'free') {
                threatPos = this.perceivedBallPos;
                
                // Direction Check
                const movingTowards = (this.team.side === 1 && ball.velocity.z > 0) || 
                                      (this.team.side === -1 && ball.velocity.z < 0);
                
                // Position Check
                const inFrontOfGoal = (this.team.side === 1 && threatPos.z < 45.0) || 
                                      (this.team.side === -1 && threatPos.z > -45.0);

                isThreat = movingTowards && inFrontOfGoal;
            }
            if (isThreat) {
                // --- POSITIONING: ANGLE CUTTING ---
                _ballPos.copy(threatPos); // Update reference for lookAt
                
                // 1. Calculate Goal Center
// 1. Calculate Goal Center (Adjusted for Y offset)
_goalCenter.set(0, -4.5, myGoalZ);
                
                // 2. Vector from Goal to Ball
                _tempVecG.subVectors(_ballPos, _goalCenter);
                const distToBall = _tempVecG.length();
                _tempVecG.normalize(); // Now holds direction
                
                // 3. Determine Extension (How far out to step)
                // Base: 1.5m off line.
                // Max: 6.0m off line (Cutting angle).
                // Scale based on ball proximity: Closer ball = More extension (to a point)
let extension = 1.5;
                if (distToBall < 30.0) {
                    const ratio = 1.0 - (Math.max(0, distToBall - 5.0) / 25.0); 
                    extension = 1.5 + (4.5 * ratio); 
                }
                
// Safety: Don't go past the ball (keep 1m buffer)
                extension = Math.min(extension, distToBall - 1.0);
                
                // 4. Calculate Target Position (Base Interception)
                _gPos.copy(_goalCenter).add(_tempVecG.multiplyScalar(extension));
                
                // 5. Vertical Override (Jump to meet ball)
                // Explicitly set Y to match ball height if it's high
                if (_ballPos.y > 0.5) {
                    _gPos.y = _ballPos.y;
                } else {
                    _gPos.y = 0.5; // Default stance
                }

                // 6. Clamp to Goal Box Dimensions (Lateral/Vertical Limits)
                // Goal Width 22 (+/- 11), Height 18 (+/- 9).
                // Allow slightly outside posts to cover angles.
                const clampX = this.goalWidth * 0.6; // +/- 13.2
const clampY = 12.0; // Reduced max jump height
                
                _gPos.x = Math.max(-clampX, Math.min(clampX, _gPos.x));
                _gPos.y = Math.max(-clampY, Math.min(clampY, _gPos.y));
                
                // 6. Lead the ball slightly if it has lateral velocity (Anticipation)
if (ball.velocity.lengthSq() > 1.0) {
                    const anticipation = ball.velocity.clone().multiplyScalar(0.25); // 0.25s lead
                    anticipation.z = 0; // Only lateral lead
                    _gPos.add(anticipation);
                }

                // CLAMP Z: Prevent Goalie from going into the net or behind goal
// CLAMP Z: Prevent Goalie from going into the net or behind goal
// CLAMP Z: Prevent Goalie from going into the net or behind goal
if (this.team.side === 1) {
                    _gPos.z = Math.min(45.5, _gPos.z);
                } else {
                    _gPos.z = Math.max(-45.5, _gPos.z);
                }

                // Move towards target
                const moveDir = _gVec.subVectors(_gPos, this.mesh.position);
                const distToTarget = moveDir.length();
                
                if (distToTarget > 0.1) {
                    moveDir.normalize();
                    // Burst speed for saves if ball is close
                    const urgency = (distToBall < 10.0) ? 1.5 : 1.0;
                    const speed = this.maxSpeed * urgency;
                    
                    this.mesh.position.add(moveDir.multiplyScalar(speed * dt));
                    
                    // Face ball
                    this.mesh.lookAt(_ballPos);
                    
                    if (this.state !== 'swim') this.play('swim', 0.2);
                } else {
                    if (this.state !== 'idle') this.play('idle', 0.2);
                    this.mesh.lookAt(_ballPos);
                }

                // --- SAVE MECHANIC ---
                // If ball is within range, apply CA pressure
                const dist = this.mesh.position.distanceTo(ball.mesh.position);
                if (dist < this.saveRadius) { 
                    this._applySavePressure(ball, dt);
                }
            } else {
                // --- IDLE / RETURN TO POST ---
                // Return to home position (usually center of goal)
                _gPos.copy(this.homePosition);
                const moveDir = _gVec.subVectors(_gPos, this.mesh.position);
                
                if (moveDir.length() > 0.5) {
                    moveDir.normalize();
                    this.mesh.position.add(moveDir.multiplyScalar(this.maxSpeed * 0.6 * dt));
                    if (this.state !== 'swim') this.play('swim', 0.2);
                } else {
                    if (this.state !== 'idle') this.play('idle', 0.2);
                }
                
                // Face center field
                this.mesh.lookAt(0, 0, 0);
            }
        }

        _applySavePressure(ball, dt) {
            // If Goalie is Asleep, they cannot save.
            if (this.status.nap > 0) return;

            // --- SUPER GOALIE TRIGGER ---
            // Trigger if: Tech equipped, Not active, Ball has power, Ball is close
            if (this.techs.active === 'super_goalie' && !this.isSuperGoalie && ball.power > 5.0) {
                // Chance to trigger (High chance for AI, or check HP)
                // Cost: 10 HP
                if (this.stats.HP >= 10) {
                    this.stats.HP -= 10;
                    this.isSuperGoalie = true;
                    this.superGoalieTimer = 1.5; // Lasts 1.5s
                    
                    console.log(`${this.role} used SUPER GOALIE!`);
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("SUPER GOALIE!", this.mesh.position, "save");
                    }
                    
                    // Trigger Techcopy Event
                    if (window.flux.gameInstance && window.flux.gameInstance.triggerTechEvent) {
                        window.flux.gameInstance.triggerTechEvent(this, 'super_goalie');
                    }
                }
            }

            // Calculate Effective CA
            let ca = this.getStat('CA');
            
            // Apply Super Goalie Bonus (e.g. +50% + Flat 10)
            if (this.isSuperGoalie) {
                ca = (ca * 1.5) + 10;
            }
            
            // Apply Grip Gloves (Passive)
            if (this.techs.passive === 'grip_gloves') {
                ca += 5;
            }

            // Calculate Pressure
            // Pressure = CA * dt * Multiplier
            const pressure = ca * dt * this.pressureMultiplier;
            
            if (ball.power > 0) {
                ball.power -= pressure;
                
                // Visual Feedback
                this._accumulatedSave += pressure;
                // THROTTLE: Increased threshold to 12.0
                if (this._accumulatedSave >= 12.0) { 
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("BLOCK!", this.mesh.position, "comic-impact");
                    }
                    this._accumulatedSave = 0;
                }
            }

            // Apply Ball Technique to Goalie (Risk of catching special shots)
// Apply Ball Technique to Goalie (Risk of catching special shots)
            if (ball.technique && this.techImmunityTimer <= 0) {
                this.techImmunityTimer = 2.0;
                const tech = ball.technique;
                
                if (tech.type === 'venom') {
                    this.applyStatus('venom', 15.0);
                } else if (tech.type === 'nap') {
                    this.applyStatus('nap', 8.0);
                } else if (tech.type === 'wither') {
                    this.applyStatus('wither', 15.0, 'CA');
                }
            }

            // Check Result
            if (ball.power <= 0 && this.status.nap <= 0) {
                // CATCH
                this.catchBall(ball);
            }
        }

        catchBall(ball) {
            ball.grab(this);
            this.play('catch', 0.1);
            console.log("SAVED by " + this.role);
            
            // EXP REWARD: Save
            this.gainExp(5);

            if (window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("SAVED!", this.mesh.position, "comic-impact");
            }
            if (window.flux.gameInstance.triggerImpact) window.flux.gameInstance.triggerImpact(0.15, 'heavy');
            
            // Reset throw timer
            this.throwTimer = 0;
        }

_aiPossessionLogic(dt) {
            this.throwTimer += dt;
            
            // Hold for a moment (1.5s) then throw
            if (this.throwTimer > 1.5) {
                // Find best target: Prefer MF or Defenders, but must be somewhat distant to avoid "handoff" look
                // Filter for teammates > 8 units away if possible
                const validMates = this.team.players.filter(p => 
                    p !== this && 
                    p.mesh && 
                    p.mesh.position.distanceTo(this.mesh.position) > 8.0
                );

                let target = null;

                // Priority 1: Midfielder (Playmaker)
                target = validMates.find(p => p.role === 'MF');
                
                // Priority 2: Defenders
                if (!target) target = validMates.find(p => p.role === 'LD' || p.role === 'RD');
                
                // Priority 3: Anyone open (fallback to close range if no one is far)
                if (!target) target = this.team.players.find(p => p !== this && p.role !== 'GL');

                if (target && target.mesh) {
                    // AIMING LOGIC: Loft the pass
                    // Look at target, but aim slightly up to create an arc
                    const targetPos = target.mesh.position.clone();
                    
                    // Calculate distance
                    const dist = this.mesh.position.distanceTo(targetPos);
                    
                    // Loft factor: The further away, the higher we aim
                    // 20 units away -> Aim 5 units above head
                    const loft = Math.max(1.0, dist * 0.25);
                    targetPos.y += loft;

                    this.mesh.lookAt(targetPos);
                    
                    // Throw
                    const ball = window.flux.gameInstance.entities.ball;
                    this.throwBall(ball, 'PA'); 
                    console.log(`${this.role} throws to ${target.role} (Dist: ${dist.toFixed(1)})`);
                } else {
                    // Clear it forward
                    this.mesh.lookAt(0, 5, 0); // Aim up-center
                    const ball = window.flux.gameInstance.entities.ball;
                    this.throwBall(ball, 'SH'); // Hard clear
                }
                
                this.throwTimer = 0;
            }
        }
    }

    window.flux.Goalie = Goalie;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Reusable math vectors to avoid GC
const _bVec = new THREE.Vector3();
    const _bDir = new THREE.Vector3();
    const _axisY = new THREE.Vector3(0, 1, 0);
    const _tempVec = new THREE.Vector3();
    const _magnusVec = new THREE.Vector3();

// Physics Configuration (Exposed for DevTools)
window.flux.BallConfig = {
        // -----------------------------------------------------------------
        // Core integration
        // -----------------------------------------------------------------
        SUBSTEPS: 2,                // Physics substeps per frame (stability at high speeds)
        STOP_SPEED: 0.02,           // Below this speed, snap to rest (prevents endless drift)

        // -----------------------------------------------------------------
        // Water resistance (physical velocity drag, NOT stat decay)
        // -----------------------------------------------------------------
        WATER_DRAG_LINEAR: 0.15,    // Linear drag term (roughly your previous WATER_DRAG)
        WATER_DRAG_QUAD: 0.002,     // Quadratic drag (stronger at high speed, helps tame rockets)

        // -----------------------------------------------------------------
        // Spin & curve
        // -----------------------------------------------------------------
        SPIN_DRAG: 0.40,            // Spin decay per second
        MAGNUS_ENABLED: true,
        MAGNUS_COEFF: 0.08,         // Lift strength
        MAGNUS_CAP: 60.0,           // Max magnus delta-V per substep (prevents explosions)

        // -----------------------------------------------------------------
        // Depth constraint (keeps ball near play plane without feeling like a hard floor)
        // -----------------------------------------------------------------
        DEPTH_TARGET_Y: 0.0,
        DEPTH_SPRING: 1.0,          // Your previous GRAVITY_SPRING
        DEPTH_DAMP: 1.5,            // Your previous GRAVITY_DAMP

        // -----------------------------------------------------------------
        // Arena boundary (soft wall + clamp)
        // -----------------------------------------------------------------
BOUNDARY_RADIUS: 46.0,
        BOUNDARY_HEIGHT: 20.0,
        GOAL_POCKET_ENABLED: true,
        GOAL_POCKET_X: 12.0,        // Half-width of goal pocket corridor
        GOAL_POCKET_Z: 40.0,        // Start of goal pocket corridor (abs z) - Pushed back
        GOAL_POCKET_RADIUS: 55.0,   // Effective radius when in goal pocket
        WALL_SOFT_BUFFER: 3.0,      // Distance from wall where soft repulsion begins
        WALL_SOFT_FORCE: 20.0,      // Soft repulsion strength
        WALL_ELASTICITY: 0.30,      // Bounce dampening on clamp
        WALL_FRICTION: 0.95,        // Tangential damping on wall contact

        FLOOR_ELASTICITY: 0.40,     // Bounce dampening on ceiling/floor clamp

        // -----------------------------------------------------------------
        // Throw mapping (stat force -> physical launch speed)
        // -----------------------------------------------------------------
        LAUNCH_SPEED_SCALE: 1.0,    // Multiplies force when converting to velocity
        LAUNCH_SPEED_CAP: 85.0      // Physical speed cap (was hardcoded in Ball.shoot)
    };


    
    const C = window.flux.BallConfig; // Local alias for brevity
    // --- TRAIL RENDERER ---
// --- TRAIL RENDERER ---
    class TrailRenderer {
        constructor(scene) {
            this.scene = scene;
            this.segments = 30; // More segments for smoother curves
            this.points = [];
this.baseWidth = 0.8; // Increased width for visibility
            this.currentWidth = 0.8;
            
            // Geometry
            const geometry = new THREE.BufferGeometry();
            const posData = new Float32Array(this.segments * 2 * 3);
            geometry.setAttribute('position', new THREE.BufferAttribute(posData, 3));
            
            // Indices
            const indices = [];
            for (let i=0; i<this.segments-1; i++) {
                const base = i*2;
                indices.push(base, base+1, base+2);
                indices.push(base+1, base+3, base+2);
            }
            geometry.setIndex(indices);
            
            this.material = new THREE.MeshBasicMaterial({
                color: 0x00aaff,
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.9, // Increased opacity
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            
            this.mesh = new THREE.Mesh(geometry, this.material);
            this.mesh.frustumCulled = false;
            this.scene.add(this.mesh);
            
            // Init points
            for(let i=0; i<this.segments; i++) this.points.push(new THREE.Vector3());
            this.active = false;

            // Reusable temps (avoid per-frame allocations on mobile)
            this._tmpDir = new THREE.Vector3();
            this._tmpToCam = new THREE.Vector3();
            this._tmpRight = new THREE.Vector3();
        }
        
        reset(pos) {
            for(let i=0; i<this.segments; i++) this.points[i].copy(pos);
            this.updateGeometry();
        }
        
        setColor(hex) {
            this.material.color.setHex(hex);
        }
        
        update(currentPos, speedRatio = 0.0) {
            if (!this.active) {
                this.reset(currentPos);
                return;
            }

// Dynamic Width based on speed AND SPIN (Power Visual)
            // Fast ball = Thicker. Spinning ball = Even Thicker.
            const ball = window.flux.gameInstance ? window.flux.gameInstance.entities.ball : null;
            const spinRatio = ball ? Math.min(1.0, ball.angularVelocity.length() / 30.0) : 0;
            
            const targetWidth = this.baseWidth * (0.8 + speedRatio * 1.2 + spinRatio * 2.0);
            this.currentWidth += (targetWidth - this.currentWidth) * 0.2; // Smooth transition

            // Shift points
            for (let i = this.segments - 1; i > 0; i--) {
                this.points[i].copy(this.points[i-1]);
            }
            this.points[0].copy(currentPos);
            
            this.updateGeometry();
        }
        
        updateGeometry() {
            const positions = this.mesh.geometry.attributes.position.array;
            const cam = window.flux.gameInstance ? window.flux.gameInstance.camera : null;
            if (!cam) return;
            const camPos = cam.position;
            const tempDir = this._tmpDir;
            const tempToCam = this._tmpToCam;
            const tempRight = this._tmpRight;
            for (let i=0; i<this.segments; i++) {
                const p = this.points[i];
                
                // Taper width along trail length
                const taper = 1.0 - Math.pow(i / this.segments, 2); // Quadratic taper
                const w = this.currentWidth * taper;
                
                // Calculate direction
                if (i < this.segments - 1) {
                    tempDir.subVectors(this.points[i], this.points[i+1]);
                } else {
                    tempDir.subVectors(this.points[i-1], this.points[i]);
                }
                
                if (tempDir.lengthSq() < 0.0001) tempDir.set(0, 1, 0);
                tempDir.normalize();
                
                tempToCam.subVectors(camPos, p).normalize();
                tempRight.crossVectors(tempDir, tempToCam).normalize().multiplyScalar(w);
                
                // Vert 1
                positions[i*6 + 0] = p.x - tempRight.x;
                positions[i*6 + 1] = p.y - tempRight.y;
                positions[i*6 + 2] = p.z - tempRight.z;
                
                // Vert 2
                positions[i*6 + 3] = p.x + tempRight.x;
                positions[i*6 + 4] = p.y + tempRight.y;
                positions[i*6 + 5] = p.z + tempRight.z;
            }
            this.mesh.geometry.attributes.position.needsUpdate = true;
        }
    }
class Ball {

        constructor(scene) {
            this.scene = scene;
            this.mesh = null;
            this.holder = null; 
            this.lastHolder = null; // Track who threw it last (for EXP/Assists)
            
            this.velocity = new THREE.Vector3(0, 0, 0);
            this.angularVelocity = new THREE.Vector3(0, 0, 0);
            this.state = 'free'; // 'free', 'held', 'magnetized'
            this.isInvisible = false;

            // Continuous Stats
            this.power = 0;      // Current PA or SH value
            this.powerType = 'none'; // 'PA' or 'SH'
            this.decayRate = 3.0; // Stat points lost per second (Water resistance)
            this.catchGracePeriod = 0; // Time before ball can be caught again

            // Magnet System
            this.magnetTarget = null;
            this.magnetTimer = 0;
            this.magnetDuration = 0.2; 
            this.magnetStartPos = new THREE.Vector3();
            this.magnetStartVel = new THREE.Vector3();

            // Visuals (Squash & Stretch)
            this.accumulatedRotation = new THREE.Quaternion();
            this.deformNode = null;
            this.spinNode = null;
            this.model = null;

this.initMesh();
            this.trail = new TrailRenderer(scene);
            this._bubbleTimer = 0;
}
initMesh() {
            // Hierarchy: Mesh (Pos) -> Deform (Squash/Stretch) -> Spin (Rotation) -> Model
            this.mesh = new THREE.Group();
            this.scene.add(this.mesh);

this.deformNode = new THREE.Group();
            this.deformNode.position.y = 0.0; // Reset offset so ball is centered on mesh position
            this.mesh.add(this.deformNode); // Fix: Add deformNode to mesh

            this.spinNode = new THREE.Group();
            this.deformNode.add(this.spinNode);

            // Procedural Placeholder Texture (Blitzball-ish)
            const placeholderTex = (() => {
                const c = document.createElement('canvas');
                c.width = 128; c.height = 64;
                const ctx = c.getContext('2d');
                ctx.fillStyle = '#eeeeee';
                ctx.fillRect(0,0,128,64);
                
                // Blue bumps/details
                ctx.fillStyle = '#0088ff';
                for(let i=0; i<6; i++) {
                    ctx.beginPath();
                    ctx.arc(i*25, 32, 10, 0, Math.PI*2);
                    ctx.fill();
                }
                ctx.fillStyle = '#004488';
                ctx.fillRect(0, 28, 128, 8); // Stripe
                
                return new THREE.CanvasTexture(c);
            })();

            // Placeholder Visual (Immediate feedback, persists until valid model loads)
// Placeholder Visual (Immediate feedback, persists until valid model loads)
// Placeholder Visual (Immediate feedback, persists until valid model loads)
const geometry = new THREE.SphereGeometry(0.3, 16, 16); // Scaled down ~15%
            const material = new THREE.MeshBasicMaterial({
                map: placeholderTex,
                color: 0xffffff, 
                wireframe: false, // Solid
                transparent: false,
                opacity: 1.0
            });
            this.placeholder = new THREE.Mesh(geometry, material);

            // Load GLB Model
            const url = 'https://cdn.tinyglb.com/models/521ae8788e584e378a79d9732a075356.glb';
            
            window.flux.AssetLoader.loadModel(url, (gltf) => {
                console.log("DEBUG: Ball GLB loaded.", gltf);
                
                const model = gltf.scene;

                // 1. Reset root transforms
                model.position.set(0, 0, 0);
                model.rotation.set(0, 0, 0);
                model.scale.set(1, 1, 1);
                model.updateMatrixWorld(true);

                // 2. Harden Materials & Visibility
                model.traverse((node) => {
                    if (node.isMesh) {
                        node.castShadow = false;
                        node.receiveShadow = false;
                        node.frustumCulled = false; // CRITICAL: Prevent culling if bounds are off
                        
                        if (node.material) {
                            const mats = Array.isArray(node.material) ? node.material : [node.material];
                            mats.forEach(m => {
                                m.color.setHex(0xffffff); // Force white base
                                m.side = THREE.DoubleSide;
                                m.transparent = false;
                                m.opacity = 1.0;
                                m.alphaTest = 0; // CRITICAL: Disable alpha test to prevent culling
                                m.depthWrite = true;
                                m.depthTest = true;
                            });
                        }
                    }
                });

                // 3. Compute Bounding Box
                const box = new THREE.Box3().setFromObject(model);
                const size = new THREE.Vector3();
                box.getSize(size);
                const center = new THREE.Vector3();
                box.getCenter(center);

                // 4. Validation
                const maxDim = Math.max(size.x, size.y, size.z);
                if (maxDim <= 0.001 || !isFinite(maxDim)) {
                    console.warn("Ball model has invalid dimensions. Keeping placeholder.");
                    return; 
                }

                // 5. Calculate Scale
// 5. Calculate Scale
const targetDiameter = 0.72; // Reduced scale by ~15% (was 0.85)
                const scaleFactor = targetDiameter / maxDim;

                // 6. Apply Transforms
                model.scale.setScalar(scaleFactor);
                model.position.copy(center).multiplyScalar(-scaleFactor);

                // 7. Swap Placeholder
                if (this.placeholder) {
                    this.spinNode.remove(this.placeholder);
                    if (this.placeholder.geometry) this.placeholder.geometry.dispose();
                    this.placeholder = null;
                }

                this.model = model;
                this.spinNode.add(this.model);
                console.log(`Blitzball model attached. Scale: ${scaleFactor.toFixed(4)}`);

            }, undefined, (err) => {
                console.error("Failed to load Blitzball model:", err);
                // Fallback: Keep placeholder but tint it red to indicate error
                if (this.placeholder) {
                    this.placeholder.material.color.setHex(0xffaaaa);
                }
            });
        }

update(dt) {
            if (!this.mesh) return;

            // Ball Lab replay override (lets DevTools drive the ball deterministically)
            const __lab = window.flux && window.flux.ballLab;
            if (__lab && __lab.isReplaying && __lab.targetBall === this && typeof __lab.applyReplayFrame === 'function') {
                __lab.applyReplayFrame(this, dt);
                if (this.trail) this.trail.active = false;
                this.updateVisuals(dt);
                return;
            }

            // Safety: Reset if position corrupted
            if (isNaN(this.mesh.position.x) || isNaN(this.mesh.position.y) || isNaN(this.mesh.position.z)) {
                this.reset();
                return;
            }

// Safety: Fix "Unpickable Ball" Bug
            // 1. Invalid Actor Check
            if (this.state === 'held' && (!this.holder || !this.holder.mesh)) {
                this.drop();
            }
            if (this.state === 'magnetized') {
                if (!this.magnetTarget || !this.magnetTarget.mesh) {
                    this.drop();
                }
                // 2. Magnetize Timeout (Prevent getting stuck in mid-air)
                if (this.magnetTimer > 2.0) {
                    console.warn("Ball stuck in magnetized state. Dropping.");
                    this.drop();
                }
            }

            // 3. State Consistency
            if (this.state === 'free' && this.holder !== null) {
                this.holder = null;
            }

            // Failsafe: If ball is free and slow, ensure it's catchable immediately
            if (this.state === 'free' && this.velocity.lengthSq() < 0.5) {
                this.catchGracePeriod = 0;
            }
if (this.trail) {
                // Trail is active if ball is moving fast and free
                const speed = this.velocity.length();
                this.trail.active = (this.state === 'free' && speed > 2.0);
                
                // Fix: Offset trail to match visual model position (deformNode offset)
                _bVec.copy(this.mesh.position);
                if (this.deformNode) _bVec.y += this.deformNode.position.y;

                // Pass speed ratio (0 to 1 based on max speed approx 60)
                const ratio = Math.min(speed / 60.0, 1.0);
                this.trail.update(_bVec, ratio);
            }

            if (this.state === 'held' && this.holder && this.holder.mesh) {
                this.updateHeld(dt);
            } else if (this.state === 'magnetized') {
                this.updateMagnetized(dt);
            } else {
                this.updateFree(dt);
            }
            
if (this.catchGracePeriod > 0) {
                this.catchGracePeriod -= dt;
                if (this.catchGracePeriod < 0) this.catchGracePeriod = 0;
            }

this.updateVisuals(dt);
            
            // Safety: Ensure visibility if not explicitly invisible
// Safety: Ensure visibility if not explicitly invisible
            if (this.mesh && !this.isInvisible) {
                this.mesh.visible = true;
                // Force model visibility if present (sometimes GLTF loader hides it)
                if (this.model) this.model.visible = true;
            }
        }

magnetize(target) {
            if (this.state === 'magnetized' || this.state === 'held') return;
            
            this.state = 'magnetized';
            this.magnetTarget = target;
            this.holder = target; // Logical possession so AI reacts
            this.magnetTimer = 0;
            this.magnetStartPos.copy(this.mesh.position);
            this.magnetStartVel.copy(this.velocity);
            
            // Dynamic Duration based on distance (Smoother for long range, snappy for close)
            const dist = this.mesh.position.distanceTo(target.mesh.position);
            this.magnetDuration = Math.max(0.15, Math.min(0.4, dist / 15.0));
            
            // Kill physics
            this.velocity.set(0, 0, 0);
            this.angularVelocity.set(0, 0, 0);

            // Notify player immediately so they stop chasing and play animation
            if (target.receiveBall) {
                target.receiveBall();
            }

            this.reveal();
        }

updateMagnetized(dt) {
            if (!this.magnetTarget || !this.magnetTarget.mesh) {
                this.drop();
                return;
            }

            this.magnetTimer += dt;
            
            // Normalized Time
            let t = this.magnetTimer / this.magnetDuration;
            if (t > 1.0) t = 1.0;

            // Target "Virtual Hand" Position (Front of Chest)
            const holderPos = this.magnetTarget.mesh.position;
            const holderQuat = this.magnetTarget.mesh.quaternion;
            
            // Offset: Forward 0.6, Up 1.0 (Chest height)
            const offset = _bVec.set(0, 1.0, 0.6).applyQuaternion(holderQuat);
            const targetPos = offset.add(holderPos);

            // --- QUADRATIC BEZIER CURVE ---
            // P0 = Start, P2 = Target
            // P1 = Control Point (Projected along initial velocity to preserve momentum feel)
            
            const p0 = this.magnetStartPos;
            const p2 = targetPos;
            
            // Calculate P1 (Control Point)
            // Project forward from P0 along start velocity vector
            // Distance of projection = 40% of total distance to target
            const dist = p0.distanceTo(p2);
            const p1 = _tempVec.copy(p0);
            
            const velLen = this.magnetStartVel.lengthSq();
            if (velLen > 1.0) {
                // Use velocity tangent
// Use velocity tangent
                _bDir.copy(this.magnetStartVel).normalize();
                p1.add(_bDir.multiplyScalar(dist * 0.4));
            } else {
                // No velocity (stationary ball), arc upwards slightly
                p1.lerp(p2, 0.5);
                p1.y += 1.5; 
            }

            // Bezier: B(t) = (1-t)^2 * P0 + 2(1-t)t * P1 + t^2 * P2
            const oneMinusT = 1.0 - t;
            const w0 = oneMinusT * oneMinusT;
            const w1 = 2.0 * oneMinusT * t;
            const w2 = t * t;
            
            this.mesh.position.x = (w0 * p0.x) + (w1 * p1.x) + (w2 * p2.x);
            this.mesh.position.y = (w0 * p0.y) + (w1 * p1.y) + (w2 * p2.y);
            this.mesh.position.z = (w0 * p0.z) + (w1 * p1.z) + (w2 * p2.z);

            // Finish
            if (t >= 1.0) {
                this.grab(this.magnetTarget);
            }
        }

updateHeld(dt) {
            // ATTACHED STATE (Virtual Attachment)
            if (!this.holder || !this.holder.mesh) {
                this.drop();
                return;
            }

            this.velocity.set(0, 0, 0);
            this.angularVelocity.set(0, 0, 0);

            // 1. Try to use Hand Bone if available (Realism)
            if (this.holder.handBone) {
                // Get world position of the hand bone
                this.holder.handBone.getWorldPosition(this.mesh.position);
                
                // Adjust slightly to sit IN the hand rather than ON the wrist
                // We can't easily know "forward" for the bone without more info, 
                // but usually GLTF bones are oriented. For now, exact bone pos is better than chest.
            } else {
                // 2. Fallback: Calculate "Carrying" Position (Right Hand Side)
                // Relative to player: Up 0.8 (Waist/Chest), Right 0.4, Forward 0.5
                const holderPos = this.holder.mesh.position;
                const holderQuat = this.holder.mesh.quaternion;
                
                // Reuse _bVec
// Reuse _bVec
                // Offset: x=0.35 (Right), y=1.3 (Chest/Hands), z=0.5 (Forward)
                _bVec.set(0.35, 1.3, 0.5).applyQuaternion(holderQuat);
                this.mesh.position.copy(holderPos).add(_bVec);
            }

// Visual Flair: Spin the ball slowly
            const rotX = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0), 2 * dt);
            const rotY = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0), 5 * dt);
            this.accumulatedRotation.multiply(rotX).multiply(rotY);
        }


updateFree(dt) {
    const C = window.flux.BallConfig || {};
    const substeps = Math.max(1, Math.floor(C.SUBSTEPS || 1));
    const stepDt = dt / substeps;

    // --- 1) Integrate physics in substeps for stability ---
    for (let s = 0; s < substeps; s++) {
        // A) Magnus effect (curve from spin)
        if (C.MAGNUS_ENABLED && this.angularVelocity && this.velocity) {
            const spinSq = this.angularVelocity.lengthSq();
            const velSq = this.velocity.lengthSq();
            if (spinSq > 0.25 && velSq > 0.25) {
                _magnusVec.copy(this.angularVelocity).cross(this.velocity).multiplyScalar((C.MAGNUS_COEFF || 0) * stepDt);

                // Cap to avoid numeric blowups
                const cap = (C.MAGNUS_CAP !== undefined ? C.MAGNUS_CAP : 60.0);
                const magLen = _magnusVec.length();
                if (magLen > cap) _magnusVec.multiplyScalar(cap / magLen);

                this.velocity.add(_magnusVec);
            }
        }

        // B) Spin decay
        if (this.angularVelocity) {
            const spinDrag = Math.max(0, 1.0 - (C.SPIN_DRAG || 0) * stepDt);
            this.angularVelocity.multiplyScalar(spinDrag);
        }

        // C) Depth spring (keeps ball near plane)
        const targetY = (C.DEPTH_TARGET_Y !== undefined ? C.DEPTH_TARGET_Y : 0.0);
        const yErr = (this.mesh.position.y - targetY);
        this.velocity.y -= yErr * (C.DEPTH_SPRING || 0) * stepDt;
        this.velocity.y *= Math.max(0, 1.0 - (C.DEPTH_DAMP || 0) * stepDt);

        // D) Apply drag (linear + quadratic)
        const vLen = this.velocity.length();
        if (vLen > 0.00001) {
            const lin = (C.WATER_DRAG_LINEAR !== undefined ? C.WATER_DRAG_LINEAR : (C.WATER_DRAG || 0)) * stepDt;
            const quad = (C.WATER_DRAG_QUAD || 0) * vLen * stepDt;
            const drag = Math.max(0, 1.0 - lin - quad);
            this.velocity.multiplyScalar(drag);

            const stop = (C.STOP_SPEED || 0);
            if (stop > 0 && this.velocity.lengthSq() < stop * stop) {
                this.velocity.set(0, 0, 0);
            }
        }

        // E) Move
        _tempVec.copy(this.velocity).multiplyScalar(stepDt);
        this.mesh.position.add(_tempVec);

        // F) Stat power decay (game logic)
        if (this.power > 0) {
            this.power -= this.decayRate * stepDt;
            if (this.power < 0) this.power = 0;
        }

        // G) Boundary logic (soft wall + clamp)
        const pos = this.mesh.position;
        const distXZ = Math.sqrt(pos.x * pos.x + pos.z * pos.z);

        const boundaryRadius = (C.BOUNDARY_RADIUS !== undefined ? C.BOUNDARY_RADIUS : 33.0);
        let effectiveBoundary = boundaryRadius;

        if (C.GOAL_POCKET_ENABLED) {
            const inGoalPocket = (Math.abs(pos.x) < (C.GOAL_POCKET_X || 12.0) && Math.abs(pos.z) > (C.GOAL_POCKET_Z || 25.0));
            if (inGoalPocket) effectiveBoundary = (C.GOAL_POCKET_RADIUS || 45.0);
        }

        const softBuffer = Math.max(0.01, (C.WALL_SOFT_BUFFER !== undefined ? C.WALL_SOFT_BUFFER : 3.0));

        // Soft repulsion (curves trajectory near wall instead of ping-pong)
        if (distXZ > effectiveBoundary - softBuffer) {
            const penetration = distXZ - (effectiveBoundary - softBuffer);
            const ratio = Math.max(0, Math.min(1, penetration / softBuffer));

            _tempVec.set(-pos.x, 0, -pos.z);
            if (_tempVec.lengthSq() > 0.0001) {
                _tempVec.normalize();
                const force = ratio * ratio * (C.WALL_SOFT_FORCE || 0) * stepDt;
                this.velocity.addScaledVector(_tempVec, force);
            }
        }

        // Hard clamp if it still hits
        if (distXZ > effectiveBoundary) {
            _tempVec.set(-pos.x, 0, -pos.z);
            if (_tempVec.lengthSq() > 0.0001) _tempVec.normalize();

            const overlap = distXZ - effectiveBoundary;
            pos.addScaledVector(_tempVec, overlap);

const vDotN = this.velocity.dot(_tempVec);

            // Only adjust if moving outward (against inward normal)
            if (vDotN < 0) {
                // Trigger Arena Deformation if impact is forceful
                const impactSpeed = Math.abs(vDotN);
                if (impactSpeed > 10.0 && window.flux.triggerArenaImpact) {
                    // Pass the contact point (pos) and strength based on speed
                    window.flux.triggerArenaImpact(pos, Math.min(impactSpeed * 0.5, 15.0));
                }

                const e = (C.WALL_ELASTICITY !== undefined ? C.WALL_ELASTICITY : 0.3);
                const impulse = _tempVec.clone().multiplyScalar(-vDotN * (1.0 + e));
                this.velocity.add(impulse);
                
                // Tangential friction
                const friction = (C.WALL_FRICTION !== undefined ? C.WALL_FRICTION : 0.95);
                const tangent = this.velocity.clone().projectOnPlane(_tempVec);
                this.velocity.sub(tangent.multiplyScalar(1.0 - friction));
            }
        }

        // Ceiling/Floor clamp
        const bh = (C.BOUNDARY_HEIGHT !== undefined ? C.BOUNDARY_HEIGHT : 15.0);
        if (Math.abs(pos.y) > bh) {
            const sign = Math.sign(pos.y) || 1;
            pos.y = bh * sign;
            const fe = (C.FLOOR_ELASTICITY !== undefined ? C.FLOOR_ELASTICITY : 0.4);
            this.velocity.y *= -fe;
}
    }

    // --- 2) FX that should run once per frame (not per substep) ---
    if (!this._ghost) {
        const speedSq = this.velocity.lengthSq();
        if (speedSq > 2.0 && window.flux.gameInstance && window.flux.gameInstance.particleManager) {
            this._bubbleTimer -= dt;
            if (this._bubbleTimer <= 0) {
                const pm = window.flux.gameInstance.particleManager;
                const offset = this.velocity.clone().normalize().multiplyScalar(-0.8);

                // Standard bubble
// Standard bubble
                const stdPos = this.mesh.position.clone().add(offset).add(_bDir.set((Math.random()-0.5)*0.3, (Math.random()-0.5)*0.3, (Math.random()-0.5)*0.3));
                if (this.deformNode) stdPos.y += this.deformNode.position.y;
                pm.spawn('bubble', stdPos, { scale: 0.4 + Math.random() * 0.4 }); // Increased scale

                // Micro bubbles at high speed
                if (speedSq > 50.0) {
                    const count = Math.min(4, Math.floor(speedSq / 60));
                    for (let i = 0; i < count; i++) {
const jitter = _bDir.set((Math.random()-0.5)*0.4, (Math.random()-0.5)*0.4, (Math.random()-0.5)*0.4);
                        const spawnPos = this.mesh.position.clone().add(offset).add(jitter);
                        if (this.deformNode) spawnPos.y += this.deformNode.position.y;
                        pm.spawn('bubble_micro', spawnPos, { scale: 0.05 + Math.random() * 0.1 });
                    }
                    this._bubbleTimer = 0.02;
                } else {
                    if (Math.random() > 0.5) {
const jitter = _bDir.set((Math.random()-0.5)*0.2, (Math.random()-0.5)*0.2, (Math.random()-0.5)*0.2);
                        const spawnPos = this.mesh.position.clone().add(offset).add(jitter);
                        if (this.deformNode) spawnPos.y += this.deformNode.position.y;
                        pm.spawn('bubble_micro', spawnPos, { scale: 0.04 + Math.random() * 0.06 });
                    }
                    this._bubbleTimer = 0.05;
                }
            }
        }
    }

    // --- 3) Visual rotation ---
    const spinSpeed = this.angularVelocity.length();
    if (spinSpeed > 0.5) {
        const axis = _tempVec.copy(this.angularVelocity).normalize();
        const q = new THREE.Quaternion().setFromAxisAngle(axis, spinSpeed * dt);
        this.accumulatedRotation.premultiply(q);
    } else {
        const speed = this.velocity.length();
        if (speed > 0.1) {
            _tempVec.copy(this.velocity).cross(_axisY).normalize();
            if (_tempVec.lengthSq() > 0.01) {
                const q = new THREE.Quaternion().setFromAxisAngle(_tempVec, speed * dt);
                this.accumulatedRotation.premultiply(q);
            }
        }
    }
}

grab(player) {
            this.reveal(); 
            
            // Announcement: Possession (if taking from free state)
            if (this.state === 'free') {
                 if (window.flux.gameInstance && window.flux.gameInstance.showAnnouncement) {
                     window.flux.gameInstance.showAnnouncement("POSSESSION", "normal");
                 }
            }

            // Check Turnover (Possession Change)
            const previousTeam = this.holder ? this.holder.team : (this.lastHolder ? this.lastHolder.team : null);
            if (previousTeam && previousTeam !== player.team) {
                 if (window.flux.gameInstance && window.flux.gameInstance.floatingText) {
                     window.flux.gameInstance.floatingText.spawn("TURNOVER", player.mesh.position, "tech");
                 }
            }
            
            // If someone else held it, they lose it
            if (this.holder && this.holder !== player) {
                this.holder.loseBall();
            }

            this.holder = player;
            this.state = 'held';
            
            // NOTE: We do NOT parent the mesh to the player anymore.
            // This prevents the ball from flying around due to swim animations.
            // Instead, we update its position manually in updateHeld().
            
            // Notify player
            if (player.receiveBall) {
                player.receiveBall();
            }
            
            console.log("Ball grabbed by " + player.role);
        }

        drop() {
            this.reveal(); // Ensure visible
            
            // No need to detach from scene graph since we aren't parenting to player anymore.
            // Just clear holder.

            if (this.holder) {
                if (this.holder.loseBall) this.holder.loseBall();
                this.holder = null;
            }
            
            this.state = 'free';
        }
// Shoot/Pass
// Shoot/Pass
        shoot(directionVector, force, type = 'SH', technique = null, spinVector = null) {

            this.lastHolder = this.holder; // Record for EXP attribution
            
            // Fumble Detection (Type 'none' is used by Player.fumble)
            if (type === 'none') {
                if (window.flux.gameInstance && window.flux.gameInstance.showAnnouncement) {
                    window.flux.gameInstance.showAnnouncement("FUMBLE!", "slam");
                }
            }

            this.drop(); // Detach first
            
            // Set Grace Period to prevent instant interceptions/catches
            // 0.2s allows ball to clear the thrower's immediate vicinity
            this.catchGracePeriod = 0.2;

            // Physical Velocity (Visual speed)
            const C = window.flux.BallConfig || {};
            const scale = (C.LAUNCH_SPEED_SCALE !== undefined ? C.LAUNCH_SPEED_SCALE : 1.0);
            const cap = (C.LAUNCH_SPEED_CAP !== undefined ? C.LAUNCH_SPEED_CAP : 85.0);
            const speed = Math.min(force * scale, cap);
            this.velocity.copy(directionVector).normalize().multiplyScalar(speed);
            
            // Apply Spin if provided
            if (spinVector) {
                this.angularVelocity.copy(spinVector);
            } else {
                this.angularVelocity.set(0, 0, 0);
            }
            
            // Stat Power (Game Logic)
            this.power = force;
            this.powerType = type;
            this.technique = technique; 
            
            // Update Trail Color
            if (this.trail) {
                let color = 0x00aaff; // Default Blue (Pass)
                
                if (technique) {
                    if (technique.type === 'venom') color = 0x00ff00; // Green (Venom)
                    else if (technique.type === 'wither') color = 0x888888; // Grey
                    else if (technique.type === 'nap') color = 0x000088; // Dark Blue
                    else if (technique.type === 'sphere') color = 0x00ffff; // Cyan
                    else if (technique.type === 'jecht') color = 0xff0000; // Red
                    else if (technique.type === 'invisible') color = 0x444444; // Dark Grey
                } else if (type === 'SH') {
                    color = 0xff4400; // Orange/Red
                }
                
                this.trail.setColor(color);
            }
            
            // Handle Invisible Shot
            if (technique && technique.type === 'invisible') {
                this.isInvisible = true;
                if (this.mesh) this.mesh.visible = false;
                // FX: Poof
                if (window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                    window.flux.gameInstance.particleManager.spawn('wither', this.mesh.position, { scale: 2.0 });
                }
                console.log("Invisible Shot!");
            }
            
            console.log(`Ball ${type} with Power: ${this.power.toFixed(1)} Spin: ${this.angularVelocity.length().toFixed(1)}`);
            
            // Visual Feedback for Curve
            if (this.angularVelocity.length() > 15.0 && window.flux.gameInstance && window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("CURVE!", this.mesh.position, "tech");
            }
        }

        reveal() {
            if (this.isInvisible) {
                // FX: Reveal Poof
                if (window.flux.gameInstance && window.flux.gameInstance.particleManager && this.mesh) {
                    window.flux.gameInstance.particleManager.spawn('wither', this.mesh.position, { scale: 2.0 });
                }
            }
            this.isInvisible = false;
            if (this.mesh) this.mesh.visible = true;
        }

// Duplicate reveal removed
        
reset() {
            this.reveal();
            this.drop();
            this.mesh.position.set(0, 0, 0);
            this.velocity.set(0, 0, 0);
            this.angularVelocity.set(0, 0, 0);
            this.catchGracePeriod = 0;
            this.power = 0;
        }
isCatchable() {
            return this.catchGracePeriod <= 0;
        }

        updateVisuals(dt) {
            if (!this.deformNode || !this.spinNode) return;

            // 1. Squash & Stretch based on velocity
// 1. Squash & Stretch based on velocity
            const speed = this.velocity.length();
            
            // Only apply stretch if moving fast enough
            if (speed > 1.0 && this.state === 'free') {
                // Orient deformNode to velocity direction
                const dir = this.velocity.clone().normalize();
                // Default forward is Z (0,0,1)
                this.deformNode.quaternion.setFromUnitVectors(new THREE.Vector3(0,0,1), dir);
                
                // Calculate stretch factor
                // Max stretch at speed 40 (approx max shot power)
                const factor = Math.min(speed / 40.0, 1.0); 
                const stretch = 1.0 + (factor * 0.8); // Increased stretch max to 1.8x
                const squash = 1.0 / Math.sqrt(stretch); // Maintain volume
                
                this.deformNode.scale.set(squash, squash, stretch);
            } else {
                // Reset deformation
                this.deformNode.quaternion.identity();
                this.deformNode.scale.set(1, 1, 1);
            }

            // 2. Apply Accumulated Spin
            // Since deformNode might be rotated, we need to apply spin in the correct space.
            // spinNode rotation = deformNode_inverse * accumulatedRotation
const invDeform = this.deformNode.quaternion.clone().invert();
            this.spinNode.quaternion.copy(invDeform.multiply(this.accumulatedRotation));
        }
    }

window.flux.Ball = Ball;
    window.flux.TrailRenderer = TrailRenderer;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class MiniMap {
        constructor() {
            this.container = document.getElementById('minimap');
            this.dots = new Map(); // Map entity to DOM element
            this.width = 100; // Matches CSS width
            this.height = 100; // Matches CSS height
            this.worldRadius = 30; // Arena radius
        }

        register(entity, type) {
            if (!this.container) return;
            
            const dot = document.createElement('div');
            dot.className = `map-dot ${type}`;
            this.container.appendChild(dot);
            
            this.dots.set(entity, dot);
        }

        init(homeTeam, awayTeam, ball) {
            if (!this.container) return;
            this.container.innerHTML = ''; // Clear existing
            this.dots.clear();

            // Register Home Team
            homeTeam.players.forEach(p => this.register(p, 'home'));
            
            // Register Away Team
            awayTeam.players.forEach(p => this.register(p, 'away'));
            
            // Register Ball
            this.register(ball, 'ball');
        }

        update() {
            if (!this.container) return;

            const halfW = this.width / 2;
            const halfH = this.height / 2;
            // Scale: Map Radius (50px) / World Radius (30 units)
            const scale = halfW / this.worldRadius; 

for (const [entity, dot] of this.dots) {
                if (!entity.mesh) continue;

                // Invisible Ball Logic
                if (entity.isInvisible) {
                    dot.style.display = 'none';
                    continue;
                } else {
                    dot.style.display = 'block';
                }
                if (!entity.mesh) continue;

                const pos = entity.mesh.position;
                
                // Map Logic:
                // World Z is Up/Down. -Z is Top (Attack Direction for Home), +Z is Bottom.
                // World X is Left/Right.
                
                // Calculate raw position relative to center
                let dx = pos.x * scale;
                let dy = pos.z * scale;

                // Clamp to circle (keep dots inside the map)
                const dist = Math.sqrt(dx*dx + dy*dy);
                const maxDist = halfW - 2; // -2 for dot radius padding
                
                if (dist > maxDist) {
                    const angle = Math.atan2(dy, dx);
                    dx = Math.cos(angle) * maxDist;
                    dy = Math.sin(angle) * maxDist;
                }

                // Convert to CSS coordinates (0,0 is Top-Left)
                // Center is (50, 50)
                const cssX = halfW + dx;
                const cssY = halfH + dy;

                dot.style.transform = `translate(${cssX}px, ${cssY}px)`;
                
// Status Updates
                if (entity.status) {
                    // Nap (Sleep) turns dot dark/black
                    if (entity.status.nap > 0) {
                        if (!dot.classList.contains('nap')) dot.classList.add('nap');
                    } else {
                        if (dot.classList.contains('nap')) dot.classList.remove('nap');
                    }
                }

                // Active Player Marker (Green)
// Active Player Marker (Green)
                const game = window.flux.gameInstance;
                const isActive = (game && game.teams.home && game.teams.home.activePlayer === entity);
                
                if (isActive) {
                    if (!dot.classList.contains('active-player')) dot.classList.add('active-player');
                } else {
                    if (dot.classList.contains('active-player')) dot.classList.remove('active-player');
                }

                // Ball Carrier Marker (Glow)
                if (entity.hasBall) {
                    if (!dot.classList.contains('ball-carrier')) dot.classList.add('ball-carrier');
                } else {
                    if (dot.classList.contains('ball-carrier')) dot.classList.remove('ball-carrier');
                }
            }
        }
    }
            

    

    window.flux.MiniMap = MiniMap;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

// Spark Texture (Procedural Burst)
    const _sparkTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0,0,64,64);
        
        // Burst shape
        const cx = 32, cy = 32;
        const spikes = 8;
        const outer = 30;
        const inner = 10;
        
        ctx.beginPath();
        for(let i=0; i<spikes*2; i++){
            const r = (i%2===0)? outer : inner;
            const a = (Math.PI*i)/spikes;
            ctx.lineTo(cx + Math.cos(a)*r, cy + Math.sin(a)*r);
        }
        ctx.closePath();
        ctx.fillStyle = '#ffcc00';
        ctx.fill();
        
        // White Core
        ctx.beginPath();
        ctx.arc(cx, cy, 8, 0, Math.PI*2);
        ctx.fillStyle = '#ffffff';
        ctx.fill();
        
        return new THREE.CanvasTexture(c);
    })();

    const _sparkMaterial = new THREE.SpriteMaterial({ 
        map: _sparkTexture, 
        transparent: true, 
        blending: THREE.AdditiveBlending,
        depthWrite: false
    });

    class GameManager {

        
constructor(scene, uiLayerId, camera, renderer) {
window.flux.gameInstance = this;
            this.renderer = renderer; // Store renderer
            this.scene = scene;
            this.camera = camera;
            this.uiLayer = document.getElementById(uiLayerId);
            
            this.score = { home: 0, away: 0 };
            this.time = 0;
            this.half = 1;
            this.halfDuration = 300; // 5 minutes (seconds)
            this.isOvertime = false;
            this.isDemoMode = false;
this.gameMode = 'normal'; // 'normal' or 'practice'
            this.isForgeMode = false; // Asset Forge State
            // Impact Frames
            this.impactPause = 0;
            
            this.state = 'menu'; // Start in menu
this.teams = {
                home: null,
                away: null
            };
            
            this.entities = {
                ball: null
            };

this.ui = {
                scorePlayer: null,
                scoreCpu: null,
                timer: null,
                half: null,
                announcement: null,
                // Player Status Panel
                statusPanel: {
                    container: null,
                    name: null,
                    hpBar: null,
                    hpText: null,
                    expBar: null
                }
            };

            // Techcopy State
            this.techCopyState = {
                active: false,
                timer: 0,
                tech: null,
                learners: []
            };

this.miniMap = new window.flux.MiniMap();
            
            // Initialize Floating Text
// Initialize Floating Text
this.floatingText = new window.flux.FloatingTextManager(scene, uiLayerId, camera);
            
            // Reusable vector for UI calculations
            this._tempVec = new THREE.Vector3();

            // Initialize Particle Manager (Status Effects)
            
// Initialize Particle Manager (Status Effects)
            this.particleManager = new window.flux.ParticleManager(scene);
this.glyphManager = null; // Injected by main.js
            this._initParticles(); // 3D Spark System (Legacy/Impact)

this.debugVisualizer = new window.flux.DebugVisualizer(scene);
            this.practiceManager = new window.flux.PracticeManager(this); // Initialize Practice Manager
            this._injectStyles();
this._initUI();
        }

_initCinematics() {
            this.menuShotIndex = 0;
            this.menuShotTimer = 0;
            this.menuShots = [
                // 1. "The Arena" - Wide Establishing Shot (Slow dolly in)
                {
                    duration: 10.0,
                    update: (t, cam) => {
                        const p1 = new THREE.Vector3(60, 35, 60);
                        const p2 = new THREE.Vector3(40, 25, 40);
                        // Smoothstep interpolation
                        const st = t * t * (3 - 2 * t); 
                        cam.position.lerpVectors(p1, p2, st);
                        cam.lookAt(0, 0, 0);
                    }
                },
                // 2. "The Team" - Tracking Shot along the formation
                {
                    duration: 8.0,
                    update: (t, cam) => {
                        // Move along the side of the home team formation
                        const zStart = -25;
                        const zEnd = 25;
                        const currentZ = zStart + (zEnd - zStart) * t;
                        
                        cam.position.set(-25, 6, currentZ);
                        cam.lookAt(0, 2, currentZ * 0.8); // Look slightly ahead of center
                    }
                },
                // 3. "The Striker" - Close up orbit on a key position
                {
                    duration: 8.0,
                    update: (t, cam) => {
                        // Focus on where the LF/RF usually stands (approx +/- 10, -10)
                        const target = new THREE.Vector3(-10, 0, -10);
                        const angle = t * 1.0 + 3.5;
                        const dist = 10.0;
                        
                        cam.position.set(
                            target.x + Math.cos(angle) * dist,
                            target.y + 4.0,
                            target.z + Math.sin(angle) * dist
                        );
                        cam.lookAt(target.x, target.y + 1.5, target.z);
                    }
                },
                // 4. "The Goal" - Low Angle looking up at the net
                {
                    duration: 7.0,
                    update: (t, cam) => {
                        const p1 = new THREE.Vector3(0, -5, 32); // Low near goal
                        const p2 = new THREE.Vector3(0, 8, 20);  // Rising up
                        cam.position.lerpVectors(p1, p2, t);
                        cam.lookAt(0, 15, 45); // Look up at the structure
                        cam.rotation.z = (t - 0.5) * 0.15; // Slight cinematic tilt
                    }
                },
                // 5. "The Dive" - Vertical drop into the pool
                {
                    duration: 8.0,
                    update: (t, cam) => {
                        const p1 = new THREE.Vector3(0, 50, 0);
                        const p2 = new THREE.Vector3(0, 10, 0);
                        const st = t * t * (3 - 2 * t);
                        cam.position.lerpVectors(p1, p2, st);
                        cam.lookAt(0, 0, 0);
                        cam.rotation.z = t * 0.8; // Spiral down
                    }
                }
];
        }

        _injectStyles() {
            if (document.getElementById('flux-dynamic-styles')) return;
            const style = document.createElement('style');
            style.id = 'flux-dynamic-styles';
style.textContent = `
                @keyframes textSlam {
                    0% { transform: translate(-50%, -50%) scale(4); opacity: 0; letter-spacing: 50px; }
                    10% { transform: translate(-50%, -50%) scale(1); opacity: 1; letter-spacing: 5px; }
                    15% { transform: translate(-50%, -50%) scale(1.1); }
                    20% { transform: translate(-50%, -50%) scale(1); }
                    80% { transform: translate(-50%, -50%) scale(1); opacity: 1; filter: blur(0px); }
                    100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; filter: blur(10px); }
                }
                
                .announcement-slam {
                    position: absolute;
                    top: 45%; left: 50%;
                    transform: translate(-50%, -50%);
                    width: 100%;
                    text-align: center;
                    font-family: 'Impact', sans-serif;
                    font-size: 96px;
                    font-style: italic;
                    text-transform: uppercase;
                    background: linear-gradient(to bottom, #ffffff 0%, #ffdd00 45%, #ff8800 100%);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    filter: drop-shadow(0 0 10px rgba(0,0,0,1)) drop-shadow(0 0 30px rgba(255, 100, 0, 0.6));
                    z-index: 2000;
                    animation: textSlam 1.8s cubic-bezier(0.1, 0.8, 0.1, 1) forwards;
                    pointer-events: none;
                    white-space: nowrap;
                }

                .modal-overlay {
                    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                    background: radial-gradient(circle at center, rgba(10, 25, 60, 0.95) 0%, rgba(0, 0, 0, 0.98) 100%);
                    display: flex; justify-content: center; align-items: center; flex-direction: column;
                    z-index: 1900;
                    opacity: 0; pointer-events: none; transition: opacity 0.8s;
                    backdrop-filter: blur(8px);
                }
                .modal-overlay.active { opacity: 1; pointer-events: auto; }
                
                .modal-title {
                    font-family: 'Garamond', serif;
                    font-size: 52px; color: #fff;
                    text-transform: uppercase;
                    text-shadow: 0 0 20px #00aaff, 0 0 40px #0044aa;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #00aaff;
                    padding-bottom: 10px;
                    width: 80%; text-align: center;
                    letter-spacing: 5px;
                }
                
                .modal-score-container {
                    display: flex; align-items: center; gap: 40px;
                    margin-bottom: 40px;
                }
                .modal-score {
                    font-family: 'Impact', sans-serif;
                    font-size: 80px; color: #ffd700;
                    letter-spacing: 5px;
                    text-shadow: 0 0 20px #b8860b;
                }
                .modal-vs {
                    font-family: 'Courier New', monospace;
                    font-size: 24px; color: #00aaff; opacity: 0.7;
                }

                .flash-overlay {
                    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                    background: white;
                    z-index: 2100;
                    opacity: 0; pointer-events: none;
                    transition: opacity 0.1s ease-out;
                    mix-blend-mode: overlay;
                }

                @keyframes clashPop {
                    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
                    50% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.8; }
                    100% { transform: translate(-50%, -50%) scale(2.0); opacity: 0; }
                }

                .clash-spark {
                    position: absolute;
                    width: 60px; height: 60px;
                    background: radial-gradient(circle, #ffffff 0%, #ffff00 40%, transparent 70%);
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 1500;
                    mix-blend-mode: screen;
                    animation: clashPop 0.3s ease-out forwards;
                    box-shadow: 0 0 20px #ffaa00;
                }
            `;
            document.head.appendChild(style);
        }

        registerTeams(homeTeam, awayTeam, ball) {
            this.teams.home = homeTeam;
            this.teams.away = awayTeam;
this.entities.ball = ball;
            
            // Initialize MiniMap
            if (this.miniMap) {
                this.miniMap.init(homeTeam, awayTeam, ball);
            }
        }

_initUI() {
            // Bind to existing HTML elements
            this.ui.scorePlayer = document.getElementById('score-player');
            this.ui.scoreCpu = document.getElementById('score-cpu');
            this.ui.timer = document.getElementById('timer-display');
            this.ui.half = document.getElementById('half-indicator');
            this.ui.announcement = document.getElementById('announcement');
            
            this.ui.techFlash = document.getElementById('tech-flash-overlay');
            if (this.ui.techFlash) {
                this.ui.techSub = this.ui.techFlash.querySelector('.tech-sub-text');
            }
            this.ui.techTimerFill = document.querySelector('.tech-timer-fill');

            // Bind Player Status Panel
            this.ui.statusPanel.container = document.getElementById('player-status-panel');
            this.ui.statusPanel.name = document.querySelector('#player-status-panel .char-name');
            this.ui.statusPanel.hpBar = document.querySelector('#player-status-panel .hp-bar-fill');
            this.ui.statusPanel.hpText = document.querySelector('#player-status-panel .hp-value');
            this.ui.statusPanel.expBar = document.querySelector('#player-status-panel .tech-bar-fill');
            
            // End Game Menu Bindings
            this.ui.endMenu = document.getElementById('end-game-menu');
            const btnRematch = document.getElementById('end-btn-rematch');
            const btnExit = document.getElementById('end-btn-exit');

            if (btnRematch) {
                btnRematch.addEventListener('click', () => {
                    this._hideEndMenu();
                    this.startMatch(this.gameMode);
                });
            }
            if (btnExit) {
                btnExit.addEventListener('click', () => {
                    this._hideEndMenu();
                    if (window.flux.gameInstance.menuManager) {
                        window.flux.gameInstance.menuManager.show();
                        this.state = 'menu';
                    }
                });
            }

            // Create Modal Overlay (For Halftime only now)
            this.ui.modal = document.createElement('div');
            this.ui.modal.className = 'modal-overlay';
            this.ui.modal.innerHTML = `
                <div class="modal-title">HALF TIME</div>
                <div class="modal-score-container">
                    <div class="modal-score" id="modal-score-home">0</div>
                    <div class="modal-vs">-</div>
                    <div class="modal-score" id="modal-score-away">0</div>
                </div>
                <div id="modal-msg" style="color: #00aaff; font-size: 14px; letter-spacing: 2px;">PREPARING 2ND HALF...</div>
            `;
            this.uiLayer.appendChild(this.ui.modal);

            // Create Flash Overlay
            this.ui.flash = document.createElement('div');
            this.ui.flash.className = 'flash-overlay';
            this.uiLayer.appendChild(this.ui.flash);

            // Initial State
            this._updateScoreUI();
            if (this.ui.timer) this.ui.timer.innerText = "00:00";
        }
        _updateScoreUI() {
            if (this.ui.scorePlayer) this.ui.scorePlayer.innerText = this.score.home;
            if (this.ui.scoreCpu) this.ui.scoreCpu.innerText = this.score.away;
        }

updatePractice(dt) {
            // Delegate logic to PracticeManager
            if (this.practiceManager) {
                this.practiceManager.update(dt);
            }
        }

        update(dt) {

if (this.state === 'intro') {
                this.introTimer += dt;

                // 1. Lights Sequence (0.5s to 2.5s)
                if (this.stadium && this.introTimer > 0.5 && this.introTimer < 2.5) {
                    const duration = 2.0;
                    const progress = (this.introTimer - 0.5) / duration;
                    const total = this.stadium.lightSprites.length;
                    const activeCount = Math.floor(progress * total);
                    
                    for(let i=0; i<total; i++) {
                        if (i <= activeCount && !this.stadium.lightSprites[i].visible) {
                            this.stadium.turnOnLight(i);
                        }
                    }
                }

                // 2. Camera Movement (Spiral In)
                if (this.camera) {
                    const t = this.introTimer;
                    const duration = 5.0;
                    const pct = Math.min(1.0, t / duration);
                    
                    // Smooth ease
                    const ease = 1 - Math.pow(1 - pct, 3);
                    
                    const startRadius = 120;
                    const endRadius = 40;
                    const radius = startRadius + (endRadius - startRadius) * ease;
                    
                    const startHeight = 60;
                    const endHeight = 20;
                    const height = startHeight + (endHeight - startHeight) * ease;
                    
                    const angle = t * 0.4; // Rotation
                    
                    this.camera.position.set(
                        Math.sin(angle) * radius,
                        height,
                        Math.cos(angle) * radius
                    );
                    this.camera.lookAt(0, 0, 0);
                }

                // 3. Crowd Roar / Hype (3.0s)
                if (this.introTimer > 3.0 && !this._introRoarTriggered) {
                    this._introRoarTriggered = true;
                    this.showAnnouncement("ARE YOU READY?", "slam");
                    if (this.cameraManager) this.cameraManager.addShake(1.5);
                    
                    // Flash crowd
                    if (this.stadium && this.stadium.crowd) {
                        // We can't easily flash instanced mesh color without iterating, 
                        // but we can spawn some particles
                        if (this.particleManager) {
                            for(let i=0; i<20; i++) {
                                const pos = new THREE.Vector3(
                                    (Math.random()-0.5)*100,
                                    10 + Math.random()*20,
                                    (Math.random()-0.5)*100
                                );
                                this.particleManager.spawn('flash', pos, { scale: 5.0 });
                            }
                        }
                    }
                }

                // 4. End Intro (5.0s)
                if (this.introTimer > 5.0) {
                    this._introRoarTriggered = false;
                    // Restore UI
                    document.getElementById('hud-top').style.opacity = '1';
                    document.getElementById('player-status-panel').style.opacity = '1';
                    
                    // Ensure all lights on
                    if (this.stadium) this.stadium.setAllLights(true);
                    
                    this.resetRound(null); // Go to kickoff
                }
                return;
            }

            if (this.state === 'menu') {
                // --- POPULATE ARENA FOR B-ROLL ---
                // Ensure players are visible and animated
                const animateTeam = (team) => {
                    if (!team) return;
                    team.players.forEach(p => {
                        if (p.mesh) {
                            p.mesh.visible = true;
                            // Gentle bobbing to simulate treading water
                            p.mesh.position.y = p.homePosition.y + Math.sin(Date.now() * 0.002 + p.mesh.id) * 0.5;
                            // Ensure idle animation is playing
                            if (p.state !== 'idle') p.play('idle', 0.5);
                            if (p.mixer) p.mixer.update(dt);
                        }
                    });
                };
                animateTeam(this.teams.home);
                animateTeam(this.teams.away);

                // --- CINEMATIC B-ROLL ---
                if (this.menuShots && this.menuShots.length > 0) {
                    const shot = this.menuShots[this.menuShotIndex];
                    this.menuShotTimer += dt;
                    
                    if (this.menuShotTimer >= shot.duration) {
                        this.menuShotTimer = 0;
                        this.menuShotIndex = (this.menuShotIndex + 1) % this.menuShots.length;
                    }
                    
                    // Normalize time (0 to 1)
                    const t = this.menuShotTimer / shot.duration;
                    if (this.camera) {
                        shot.update(t, this.camera);
                    }
                }

                // Ambient FX in Menu
                if (this.particleManager && Math.random() < 0.2) {
                    // Spawn random bubbles for atmosphere
                    const range = 60;
                    const pos = new THREE.Vector3(
                        (Math.random()-0.5)*range, 
                        -10 + Math.random()*20, 
                        (Math.random()-0.5)*range
                    );
                    this.particleManager.spawn('bubble', pos, { life: 3.0 + Math.random()*2.0, scale: 0.3 + Math.random()*0.4 });
                }

                // Update Background Systems
                if (this.waterOverlay) this.waterOverlay.update(dt);
                if (this.lightShafts) this.lightShafts.update(dt);
                if (this.stadium) this.stadium.update(dt);
                if (this.particleManager) this.particleManager.update(dt);

                // Render
                if (this.renderer && this.scene && this.camera) {
                    this.renderer.render(this.scene, this.camera);
                }
                return;
            }

// --- LOGIC UPDATE (State Dependent) ---
            if (this.state === 'active') {
                if (this.gameMode === 'practice') {
                    this.updatePractice(dt);
                } else {
                    this.time += dt;
                    this._updateTimer();
                    this._checkHalfTime();
                }

                this._checkGoals();
                
                // Update Techcopy Window
                if (this.techCopyState.active) {
                    this.techCopyState.timer -= dt;
                    
                    // Update UI Bar
                    if (this.ui.techTimerFill) {
                        const pct = Math.max(0, (this.techCopyState.timer / this.techCopyState.maxTime) * 100);
                        this.ui.techTimerFill.style.width = `${pct}%`;
                        
                        // Color shift based on urgency
                        if (pct < 30) this.ui.techTimerFill.style.background = '#ff0000';
                        else this.ui.techTimerFill.style.background = 'linear-gradient(90deg, #ffffff, #00ffff)';
                    }

                    if (this.techCopyState.timer <= 0) {
                        this.endTechCopyWindow(false);
                    }
                }
            }

            // --- VISUAL UPDATE (Always Run) ---
            // Update these in all states (Active, Goal, Halftime, GameOver) to keep FX alive
            if (this.state !== 'menu' && this.state !== 'intro') {
                if (this.miniMap) this.miniMap.update();
                if (this.floatingText) this.floatingText.update(dt);
                if (this.particleManager) this.particleManager.update(dt);
                this._updateParticles(dt); // Legacy sparks
                if (this.debugVisualizer) this.debugVisualizer.update();
            }
        }
            
        _updateOffscreenIndicator() {
            const p = this.teams.home ? this.teams.home.activePlayer : null;
            const indicator = this.ui.offscreenIndicator;
            
            if (!p || !p.mesh || !this.camera || !indicator) return;

            // 1. Get Player Position (Center Mass)
            const pos = p.mesh.position.clone();
            pos.y += 1.0; 
            
            // 2. Project to Normalized Device Coordinates (NDC) [-1, 1]
            this._tempVec.copy(pos).project(this.camera);
            
            // 3. Check if Behind Camera
            const camFwd = new THREE.Vector3();
            this.camera.getWorldDirection(camFwd);
            const toPlayer = pos.clone().sub(this.camera.position).normalize();
            const dot = camFwd.dot(toPlayer);
            const isBehind = dot < 0.2; // Buffer to prevent flipping at edge

            // 4. Check Bounds
            const isOffScreen = (
                this._tempVec.x < -0.9 || this._tempVec.x > 0.9 ||
                this._tempVec.y < -0.9 || this._tempVec.y > 0.9 ||
                isBehind
            );

            if (isOffScreen) {
                indicator.style.display = 'block';
                
                let x = this._tempVec.x;
                let y = this._tempVec.y;

                // If behind, invert coordinates to point correctly
                if (isBehind) {
                    x = -x;
                    y = -y;
                    // Fix singularity if exactly behind center
                    if (Math.abs(x) < 0.01 && Math.abs(y) < 0.01) y = -1; 
                }

                // Clamp to screen edges
                // We want to find the intersection of the vector (x,y) with the box [-0.9, 0.9]
                const padding = 0.9;
                
                // Normalize to get direction
                const mag = Math.sqrt(x*x + y*y);
                const nx = x / mag;
                const ny = y / mag;
                
                // Raycast to box edges
                // Vertical edges: x = +/- padding
                // Horizontal edges: y = +/- padding
                
                // Avoid divide by zero
                const tx = (Math.abs(nx) > 0.001) ? (nx > 0 ? padding : -padding) / nx : 999;
                const ty = (Math.abs(ny) > 0.001) ? (ny > 0 ? padding : -padding) / ny : 999;
                
                // Use the nearest intersection (smallest positive t)
                // Since we are projecting from center (0,0) to (nx,ny), t must be positive.
                const t = Math.min(Math.abs(tx), Math.abs(ty));
                
                const screenX = nx * t;
                const screenY = ny * t;

                // Convert NDC to Pixels
                const width = window.innerWidth;
                const height = window.innerHeight;
                
                const px = (screenX * 0.5 + 0.5) * width;
                const py = (-(screenY) * 0.5 + 0.5) * height;

                // Calculate Rotation
                // Arrow points UP by default.
                // We want it to point in direction (nx, ny) on screen.
                // Screen Y is down (inverted from WebGL Y).
                // So (0, 1) in NDC is UP. (0, -1) in NDC is DOWN.
                // atan2(y, x) gives angle from +X.
                // We want angle from +Y (Up).
                // Rotation = PI/2 - angle.
                
                const angle = Math.atan2(ny, nx);
                const rot = (Math.PI / 2) - angle;

                indicator.style.transform = `translate(${px}px, ${py}px) rotate(${rot}rad)`;
                
            } else {

                indicator.style.display = 'none';
            }
        }

        _updateTimer() {
            if (!this.ui.timer) return;
            // Clamp to half duration for display if we go slightly over before tick
            const t = Math.min(this.time, this.halfDuration);
            const minutes = Math.floor(t / 60);
            const seconds = Math.floor(t % 60);
            this.ui.timer.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        _checkHalfTime() {
            if (this.time >= this.halfDuration) {
                this.endHalf();
            }
        }

endHalf() {
            this.state = 'halftime';
            
            // Stop all players
            if (this.teams.home) this.teams.home.players.forEach(p => p.setInput(0, 0));
            if (this.teams.away) this.teams.away.players.forEach(p => p.setInput(0, 0));

            if (this.half === 1) {
                this._showModal("HALF TIME", "PREPARING 2ND HALF...");
                
                // Optional: Play whistle sound here if available
                // if (this.audioManager) this.audioManager.playSFX('whistle');

                setTimeout(() => {
                    this._hideModal();
                    this.startSecondHalf();
                }, 4000);
            } else {
                // End of 2nd Half or Overtime Period
                if (this.score.home === this.score.away) {
                    // TIED - Go to Overtime (Golden Goal)
                    this._showModal("OVERTIME", "GOLDEN GOAL RULE ACTIVE");
                    setTimeout(() => {
                        this._hideModal();
                        this.startOvertime();
                    }, 4000);
                } else {
                    // Winner decided
                    this.endGame();
                }
            }
        }

        startSecondHalf() {
            this.half = 2;
            this.time = 0;
            this.ui.half.innerText = "2nd HALF";
            this.resetRound(null); // Neutral Blitz-off for 2nd half start
        }

        startOvertime() {
            this.half++;
            this.time = 0;
            this.isOvertime = true;
            this.ui.half.innerText = "OVERTIME";
            this.resetRound(null); // Neutral Blitz-off
        }

endGame() {
            this.state = 'gameover';
            
            // Stop players
            if (this.teams.home) this.teams.home.players.forEach(p => p.setInput(0, 0));
            if (this.teams.away) this.teams.away.players.forEach(p => p.setInput(0, 0));

            let msg = "DRAW";
            if (this.score.home > this.score.away) msg = "VICTORY";
            if (this.score.away > this.score.home) msg = "DEFEAT";
            
            // Populate End Game Menu
            if (this.ui.endMenu) {
                const titleEl = document.getElementById('end-result-title');
                const homeScoreEl = document.getElementById('end-score-home');
                const awayScoreEl = document.getElementById('end-score-away');
                
                if (titleEl) {
                    titleEl.innerText = msg;
                    titleEl.style.color = (msg === "VICTORY") ? "#00ffff" : ((msg === "DEFEAT") ? "#ff4444" : "#ffffff");
                }
                if (homeScoreEl) homeScoreEl.innerText = this.score.home;
                if (awayScoreEl) awayScoreEl.innerText = this.score.away;

                this.ui.endMenu.classList.add('active');
                this.setMenuMode(true); // Hide HUD
            }

            // Stop Music on Game Over
            if (this.audioManager) {
                this.audioManager.stopBGM();
            }
        }

        _hideEndMenu() {
            if (this.ui.endMenu) {
                this.ui.endMenu.classList.remove('active');
                this.setMenuMode(false); // Show HUD
            }
        }

        _showModal(title, subtext) {
            if (!this.ui.modal) return;
            
            this.ui.modal.querySelector('.modal-title').innerText = title;
            this.ui.modal.querySelector('#modal-score-home').innerText = this.score.home;
            this.ui.modal.querySelector('#modal-score-away').innerText = this.score.away;
            this.ui.modal.querySelector('#modal-msg').innerText = subtext;
            
            this.ui.modal.classList.add('active');
            
            // Hide HUD elements
            document.getElementById('hud-top').style.opacity = '0';
            document.getElementById('player-status-panel').style.opacity = '0';
        }

        _hideModal() {
            if (!this.ui.modal) return;
            this.ui.modal.classList.remove('active');
            
            // Show HUD elements
            document.getElementById('hud-top').style.opacity = '1';
            document.getElementById('player-status-panel').style.opacity = '1';
        }

_checkGoals() {
            const ball = this.entities.ball;
            if (!ball || !ball.mesh) return;

            const pos = ball.mesh.position;

            // Precise Goal Detection
            // Visual Goal is at Z = +/- 28.
            // We define a "Goal Mouth" box matching Goalie.js (Width 14, Height 8).
// We define a "Goal Mouth" box matching the visual net.
            // Arena Radius is 32. Goal is roughly 22m wide, 18m high.
// Arena Radius is 32. Goal is roughly 22m wide, 18m high.
            const halfWidth = 11.0; // Increased to 11 (Width 22) to catch corners
            const halfHeight = 9.0; // Increased to 9 (Height 18) to catch high shots
            const goalYOffset = -4.5; // Moved down to match visual model (-4.5m)

            const triggerZ = 45.0; // Trigger earlier (was 30) to ensure registration before bounce

            if (Math.abs(pos.z) > triggerZ) {
                // PREVENT OWN GOAL BY CARRIER (User Request)
                // If the ball is held by the team defending this goal, do not count it.
                if (ball.holder) {
                    // Home (Side 1) defends +Z. If pos.z > 0 (Home Goal) and holder is Home, ignore.
                    if (pos.z > 0 && ball.holder.team.side === 1) return;
                    // Away (Side -1) defends -Z. If pos.z < 0 (Away Goal) and holder is Away, ignore.
                    if (pos.z < 0 && ball.holder.team.side === -1) return;
                }

                // 2. Check Frame (Must be within width/height)
// 2. Check Frame (Must be within width/height, accounting for Y offset)
                if (Math.abs(pos.x) <= halfWidth && Math.abs(pos.y - goalYOffset) <= halfHeight) {
                    if (pos.z < 0) {
                        this.goalScored('home'); // Home attacks -Z
                    } else {
                        this.goalScored('away'); // Away attacks +Z
                    }
                }
            }
        }

goalScored(scorer) {
            if (this.state !== 'active') return;
            
            // IMPACT FRAME: GOAL
            this.triggerImpact(0.4, 'shatter'); // Massive freeze for goal
            
            // EXP REWARD: Goal
            // Find who scored (Last holder of ball)
            const ball = this.entities.ball;
            if (ball && ball.lastHolder && ball.lastHolder.team.id === scorer) {
                ball.lastHolder.gainExp(10);
            }

            this.state = 'goal';
            this.score[scorer]++;
            this._updateScoreUI();
            
            // 1. VISCERAL SHAKE & PARTICLES
            if (this.cameraManager) {
                this.cameraManager.addShake(2.0); // Heavy shake
            }
            if (this.particleManager && this.entities.ball && this.entities.ball.mesh) {
                const goalPos = this.entities.ball.mesh.position.clone();
                // Massive Goal Explosion
                this.particleManager.spawn('shockwave', goalPos, { scale: 15.0, life: 0.8 });
                this.particleManager.spawn('flash', goalPos, { scale: 10.0 });
                for(let i=0; i<30; i++) {
                    this.particleManager.spawn('debris', goalPos, { scale: 0.8 });
                }
            }
            // 2. SCREEN FLASH
            if (this.ui.flash) {
                this.ui.flash.style.opacity = '0.8';
                setTimeout(() => { this.ui.flash.style.opacity = '0'; }, 100);
            }

            // 3. GOLDEN GOAL CHECK
            if (this.isOvertime) {
                this.showAnnouncement("GOLDEN GOAL!", 'slam');
                // End game after short delay
                setTimeout(() => {
                    this.endGame();
                }, 3000);
                return;
            }

            // 4. SLAM ANNOUNCEMENT (Normal)
            this.showAnnouncement("GOAL!", 'slam');
            
            // Reset sequence
            // Scored-upon team gets ball
            const loser = scorer === 'home' ? 'away' : 'home';
            
            // FASTER FLOW: Reduced delay from 3000ms to 1200ms
            setTimeout(() => {
                this.resetRound(loser);
            }, 2000); // Slightly longer to appreciate the "GOAL" slam
        }

showAnnouncement(text, type = 'normal', duration = 2000) {
            const el = this.ui.announcement;
            if (!el) return;

            // Clear previous timeout
            if (this._announceTimeout) {
                clearTimeout(this._announceTimeout);
                this._announceTimeout = null;
            }

            // Reset Animation by cloning
            const newEl = el.cloneNode(true);
            el.parentNode.replaceChild(newEl, el);
            this.ui.announcement = newEl;

            newEl.innerText = text;
            newEl.style.display = 'block';
            
            // Apply Class based on type
            newEl.className = ''; // Reset classes
            if (type === 'slam') {
                newEl.classList.add('announcement-slam');
            } else {
                // Default style
                newEl.style.animation = 'none';
                newEl.offsetHeight; /* trigger reflow */
                newEl.style.animation = 'announceSlide 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            }

            // Auto-hide
            if (duration > 0) {
                this._announceTimeout = setTimeout(() => {
                    this.hideAnnouncement();
                }, duration);
            }
        }

        hideAnnouncement() {
            if (this.ui.announcement) {
                this.ui.announcement.style.display = 'none';
            }
        }

resetRound(possessionTeamId) {
            this.state = 'reset';
            
            // Clear persistent visuals
            if (this.glyphManager) this.glyphManager.clear();
            if (this.particleManager) {
                // Optional: Clear particles if needed, though they self-expire quickly
            }
            
            // Reset Ball
            if (this.entities.ball) this.entities.ball.reset();
            if (this.entities.ball) this.entities.ball.reset();
            
            // Reset Teams
            if (this.teams.home) this.teams.home.resetPositions();
            if (this.teams.away) this.teams.away.resetPositions();
            
            // Clear ball holder
            if (this.entities.ball) this.entities.ball.drop();

            // CRITICAL: Snap camera to prevent disorientation
            if (this.cameraManager) {
                // Force update target first (usually ball)
                if (this.entities.ball && this.entities.ball.mesh) {
                    this.cameraManager.setTarget(this.entities.ball.mesh, this.entities.ball.velocity);
                    this.cameraManager.snapToTarget();
                }
            }

            // FASTER FLOW: Reduced delay from 2000ms to 100ms
            setTimeout(() => {
                this.startKickoff(possessionTeamId);
}, 100);
        }

startKickoff(possessionTeamId) {
            this.state = 'kickoff';
            
            // Stop all players immediately to prevent pre-movement
            if (this.teams.home) this.teams.home.players.forEach(p => p.setInput(0, 0));
            if (this.teams.away) this.teams.away.players.forEach(p => p.setInput(0, 0));

            this.showAnnouncement("BLITZ OFF!", 'slam');
            // If a team has possession (after goal), give to MF
            if (possessionTeamId) {
                const team = this.teams[possessionTeamId];
                if (team) {
                    const mf = team.players.find(p => p.role === 'MF');
                    if (mf && this.entities.ball) {
                        this.entities.ball.grab(mf);
                        
                        // CRITICAL: Snap camera to new holder to prevent swing/disorientation
                        if (this.cameraManager) {
                            this.cameraManager.setTarget(mf.mesh, mf.velocity);
                            this.cameraManager.snapToTarget();
                        }
                    }
                }
            } else {
                // Neutral kickoff - ensure camera is snapped to center ball
                if (this.cameraManager && this.entities.ball && this.entities.ball.mesh) {
                    this.cameraManager.setTarget(this.entities.ball.mesh, this.entities.ball.velocity);
                    this.cameraManager.snapToTarget();
                }
            }
            
            // FASTER FLOW: Reduced delay from 1000ms to 800ms
            setTimeout(() => {
                this.hideAnnouncement();
                this.state = 'active';
            }, 800);
        }
        
// Initial start
// Initial start
        startMatch(mode = 'normal') {
            this.gameMode = mode;
            console.log("Starting Match in mode:", mode);
            
            // Start Music
            if (this.audioManager) {
                this.audioManager.playBGM();
            }
            
            // Reset Score
            this.score.home = 0;
            this.score.away = 0;
            this._updateScoreUI();
            
            // Reset Time
            this.time = 0;
            this.half = 1;
            if (this.ui.half) this.ui.half.innerText = "1st";
            
            if (mode === 'practice') {
                if (this.ui.half) this.ui.half.innerText = "PRAC";
                
                // Start Practice Manager
                if (this.practiceManager) {
                    this.practiceManager.start();
                }

                // In practice, ensure AI is enabled for sparring
                if (this.teams.away) {
                    this.teams.away.aiEnabled = true;
                }
                
                // Skip intro for practice
                this.resetRound();
            } else {
                // Ensure Practice Manager is stopped if normal game
                if (this.practiceManager) this.practiceManager.stop();
                
                // Safety: Ensure all players are visible (in case Practice hid them)
                if (this.teams.away) {
                    this.teams.away.players.forEach(p => { if(p.mesh) p.mesh.visible = true; });
                    this.teams.away.aiEnabled = true; 
                }
                if (this.teams.home) {
                    this.teams.home.players.forEach(p => { if(p.mesh) p.mesh.visible = true; });
                }

                // Start Cinematic Intro
                this.startIntroSequence();
            }
        }

        startIntroSequence() {
            this.state = 'intro';
            this.introTimer = 0;
            this._introRoarTriggered = false;
            
            // Turn off lights
            if (this.stadium) {
                this.stadium.setAllLights(false);
            }
            
            // Hide UI
            document.getElementById('hud-top').style.opacity = '0';
            document.getElementById('player-status-panel').style.opacity = '0';
            
            // Reset positions so players are on field in dark
            if (this.teams.home) this.teams.home.resetPositions();
            if (this.teams.away) this.teams.away.resetPositions();
            if (this.entities.ball) this.entities.ball.reset();
        }
// Duplicate block removed

setMenuMode(isActive) {
            this.state = isActive ? 'menu' : 'active';
            
            if (isActive && this.audioManager) {
                this.audioManager.stopBGM();
            }
            
            // Hide HUD in menu
            const hudTop = document.getElementById('hud-top');
            const statusPanel = document.getElementById('player-status-panel');
            const controls = document.getElementById('action-container');
            const joystick = document.getElementById('joystick-hit-zone');
            
            const display = isActive ? 'none' : 'flex'; // or block/etc
            
            if (hudTop) hudTop.style.display = display;
            if (statusPanel) statusPanel.style.display = isActive ? 'none' : 'block'; // Status panel has specific logic
            if (controls) controls.style.display = isActive ? 'none' : 'flex';
            if (joystick) joystick.style.display = isActive ? 'none' : 'block';
            
            // If entering menu, reset camera to a nice angle?
            // Handled by update loop
        }
toggleDemoMode() {
            this.isDemoMode = !this.isDemoMode;
            console.log("Demo Mode:", this.isDemoMode);
            
            // Update UI Button
            const btn = document.getElementById('auto-toggle');
            if (btn) {
                btn.innerText = this.isDemoMode ? "AUTO PILOT" : "MANUAL";
                if (this.isDemoMode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
            
            // Announcement
            const text = this.isDemoMode ? "AUTO PILOT" : "MANUAL";
            this.showAnnouncement(text);
            
            // Visual Flair: Spawn text above active player
            if (this.isDemoMode && this.floatingText && this.teams.home && this.teams.home.activePlayer && this.teams.home.activePlayer.mesh) {
                this.floatingText.spawn("AI ENGAGED", this.teams.home.activePlayer.mesh.position, "goal");
            }

            // Auto-hide announcement
setTimeout(() => {
                if (this.ui.announcement && this.ui.announcement.innerText === text) {
                    this.hideAnnouncement();
                }
            }, 1500);
        }

        // --- TECHCOPY SYSTEM ---

        triggerTechEvent(sourcePlayer, techName) {
            if (!sourcePlayer || !sourcePlayer.team) return;

            // Find opposing team
            const oppTeamId = sourcePlayer.team.id === 'home' ? 'away' : 'home';
            const oppTeam = this.teams[oppTeamId];
            if (!oppTeam) return;

            // Find who is marking this source
            const learners = oppTeam.players.filter(p => p.marking === sourcePlayer);
            
            if (learners.length === 0) return;

            // Only show UI if the learning team is Human (Home)
            // (Or if we are in Demo mode and want to see it happen for Home team)
            if (oppTeam.isHuman) {
                // Filter out those who already know it
                const validLearners = learners.filter(p => !p.learnedTechs.includes(techName));
                if (validLearners.length > 0) {
                    this.startTechCopyWindow(techName, validLearners);
                }
            }
        }

startTechCopyWindow(techName, learners) {
            this.techCopyState.active = true;
            this.techCopyState.maxTime = 0.6; // 0.6s window
            this.techCopyState.timer = this.techCopyState.maxTime;
            this.techCopyState.tech = techName;
            this.techCopyState.learners = learners;
            
            // Show UI
            if (this.ui.techFlash) {
                this.ui.techFlash.style.display = 'flex';
                this.ui.techFlash.style.background = ""; // Reset background
                this.ui.techFlash.querySelector('.tech-text').innerText = "TECHCOPY!";
                
                if (this.ui.techSub) {
                    this.ui.techSub.innerText = techName.replace('_', ' ');
                }
                
                // Reset bar
                if (this.ui.techTimerFill) {
                    this.ui.techTimerFill.style.width = '100%';
                }
            }
        }

attemptTechCopy() {
            if (!this.techCopyState.active) return false;
            
            // Success!
            const tech = this.techCopyState.tech;
            const learners = this.techCopyState.learners;
            
            learners.forEach(p => {
                // Double check to prevent duplicates
                if (!p.learnedTechs.includes(tech)) {
                    p.learnedTechs.push(tech);
                    console.log(`${p.role} learned ${tech}!`);
                    
                    // 1. Floating Text
                    if (this.floatingText && p.mesh) {
                        this.floatingText.spawn(`LEARNED!`, p.mesh.position, "tech");
                    }
                    
                    // 2. Particle Effect (Spiral)
                    if (this.particleManager && p.mesh) {
                        // Spawn multiple particles for a swirl effect
                        for(let i=0; i<10; i++) {
                            setTimeout(() => {
                                this.particleManager.spawn('learned', p.mesh.position);
                            }, i * 50);
                        }
                    }
                }
            });
            
            this.endTechCopyWindow(true);
            return true;
        }

endTechCopyWindow(success) {
            this.techCopyState.active = false;
            if (this.ui.techFlash) {
                if (success) {
                    this.ui.techFlash.querySelector('.tech-text').innerText = "SUCCESS!";
                    // Flash success color (White flash)
                    this.ui.techFlash.style.background = "rgba(255, 255, 255, 0.8)";
                    
                    // Hide after short delay to show the success flash
                    setTimeout(() => { 
                        this.ui.techFlash.style.display = 'none'; 
                    }, 300);
                } else {
                    // Failed / Missed
                    this.ui.techFlash.style.display = 'none';
                }
            }
        }
_updatePlayerStatusUI() {
            if (!this.teams.home || !this.teams.home.activePlayer) return;
            
            const p = this.teams.home.activePlayer;
            const ui = this.ui.statusPanel;
            
// UI Updates (Action Button Context)
                ui.container.style.display = 'block';
                
                // Name & Level
                if (ui.name) ui.name.innerText = `${p.characterName || p.role} LV${p.level}`;
                
                // HP
                if (ui.hpBar) {
                    const hpPct = Math.max(0, Math.min(100, (p.stats.HP / p.stats.maxHP) * 100));
                    ui.hpBar.style.width = `${hpPct}%`;
                    // Color shift
                    if (hpPct < 25) ui.hpBar.style.background = 'linear-gradient(90deg, #ff0000, #ff4444)';
                    else if (hpPct < 50) ui.hpBar.style.background = 'linear-gradient(90deg, #ffff00, #ffff88)';
                    else ui.hpBar.style.background = 'linear-gradient(90deg, #00ff00, #ccffcc)';
                }
                if (ui.hpText) ui.hpText.innerText = `${Math.floor(p.stats.HP)}/${p.stats.maxHP}`;
                
                // EXP
                if (ui.expBar) {
                    const expPct = Math.max(0, Math.min(100, (p.exp / p.nextLevelExp) * 100));
                    ui.expBar.style.width = `${expPct}%`;
ui.expBar.style.width = `${expPct}%`;
                }
        }

_initParticles() {
            this.activeSparks = [];
            this.sparkPool = [];
            const poolSize = 40; // Sufficient for continuous grinding
            
            for (let i = 0; i < poolSize; i++) {
                const sprite = new THREE.Sprite(_sparkMaterial.clone());
                sprite.visible = false;
                this.scene.add(sprite);
                this.sparkPool.push(sprite);
            }
        }

        spawnClash(pos, intensity = 1.0) {
            // Find free spark
            const spark = this.sparkPool.find(s => !s.visible);
            if (!spark) return; // Pool exhausted
            
            spark.position.copy(pos);
            spark.visible = true;
            
            // Randomize rotation
            spark.material.rotation = Math.random() * Math.PI;
            
            // Initialize Active State
            this.activeSparks.push({
                mesh: spark,
                age: 0,
                life: 0.15 + Math.random() * 0.15, // Fast, punchy sparks
                maxScale: 2.5 * intensity,
                velocity: new THREE.Vector3(
                    (Math.random()-0.5)*8, 
                    (Math.random()-0.5)*8, 
                    (Math.random()-0.5)*8
                )
            });
        }

        _updateParticles(dt) {
            for (let i = this.activeSparks.length - 1; i >= 0; i--) {
                const p = this.activeSparks[i];
                p.age += dt;
                
                if (p.age >= p.life) {
                    p.mesh.visible = false;
                    this.activeSparks.splice(i, 1);
                    continue;
                }
                
                const t = p.age / p.life;
                
                // Expand
                const currentScale = 0.5 + (p.maxScale - 0.5) * t;
                p.mesh.scale.setScalar(currentScale);
                
                // Fade out
                p.mesh.material.opacity = 1.0 - (t * t); // Quadratic fade
                
                // Move
                p.mesh.position.addScaledVector(p.velocity, dt);
                p.mesh.material.rotation += 10.0 * dt;
            }
        }

// Helper for impact frames

triggerImpact(duration, type = 'default') {
            this.impactPause = duration;
            
            const container = document.getElementById('game-container');
            if (!container) return;

            // Reset classes to ensure animation restarts
            container.classList.remove('impact-fx', 'impact-heavy', 'impact-shatter');
            
            // Force reflow
            void container.offsetWidth;

            let className = 'impact-fx';
            if (type === 'heavy') className = 'impact-heavy';
            if (type === 'shatter') className = 'impact-shatter';

            container.classList.add(className);

            // Auto-remove class after duration
            setTimeout(() => {
                container.classList.remove(className);
            }, duration * 1000 + 100);
        }
    }

    window.flux.GameManager = GameManager;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class FloatingTextManager {
        constructor(scene, containerId, camera) {
            this.scene = scene;
            this.camera = camera;
            this.container = document.getElementById(containerId);
            this.texts = [];
            
            // Reusable vector for projection
            this._tempV = new THREE.Vector3();
        }

spawn(text, worldPos, type = 'default', target = null) {
            if (!this.container || !this.camera) return;

            // Create Wrapper (Positioning)
            const wrapper = document.createElement('div');
            wrapper.className = 'floating-text-wrapper';

            // Create Inner (Animation/Styling)
            const inner = document.createElement('span');
            inner.innerText = text;
            
            // Smart Class Assignment
            let classes = ['floating-text-inner'];
            
            // Add base type
            classes.push(type);

            // Keyword Detection for Auto-Styling
            const upper = text.toString().toUpperCase();
            
if (upper.includes('POISON') || upper.includes('VENOM')) classes.push('venom');
            else if (upper.includes('SLEEP') || upper.includes('NAP') || upper.includes('ZZZ')) classes.push('sleep');
            else if (upper.includes('WITHER')) classes.push('wither');
            else if (type === 'tech' || upper.includes('SHOT') || upper.includes('JECHT') || upper.includes('TACKLE')) classes.push('tech');
            else if (type === 'comic-impact') classes.push('comic-impact');
            else if (type === 'comic-action') classes.push('comic-action');
            else if (!isNaN(parseInt(text)) && type !== 'score') classes.push('damage'); // Numeric is usually damage
            else if (type === 'save' || type === 'block') classes.push('save');

            inner.className = classes.join(' ');
            wrapper.appendChild(inner);
            this.container.appendChild(wrapper);

            // Physics Instance
            const instance = {
                el: wrapper, 
                worldPos: worldPos.clone(),
                offset: new THREE.Vector3(0, 0, 0),
                velocity: new THREE.Vector3(0, 0, 0),
                gravity: 0,
                drag: 0,
                elasticity: 0.6,
                floorY: -999, // Virtual floor relative to start
                
life: 1.0,  // Reduced from 1.5
                maxLife: 1.0,
                target: target
            };

            // Customize Physics based on Type
if (classes.includes('damage') || classes.includes('save') || classes.includes('block')) {
                // DEBRIS PHYSICS (Pop, Arc, Bounce)
                instance.target = null; // Detach from entity so it falls naturally
                instance.gravity = 40.0; // Heavy gravity for snappy feel
                instance.drag = 0.5;
                instance.floorY = -4.0; // Bounce off a virtual floor below impact
                
                // Explosive Burst
                const spread = 6.0;
                instance.velocity.set(
                    (Math.random() - 0.5) * spread,
                    15.0 + Math.random() * 5.0, // High initial pop
                    (Math.random() - 0.5) * spread
                );
                
                instance.life = 2.0;
                instance.maxLife = 2.0;

            } else if (classes.includes('comic-impact')) {
                // COMIC POP (Stay in place mostly, slight drift)
                instance.gravity = 0;
                instance.velocity.set((Math.random()-0.5)*2, 1.0, (Math.random()-0.5)*2);
instance.life = 0.5; // Reduced from 0.8
                instance.maxLife = 0.5;

            } else if (classes.includes('comic-action')) {
                // COMIC ZIP (Fast movement)
                instance.gravity = 0;
                instance.velocity.set(0, 2.0, 0);
instance.life = 0.4; // Reduced from 0.6
                instance.maxLife = 0.4;

            } else if (classes.includes('tech')) {
                // TECH FLOAT (Slow rise)
                instance.gravity = 0;
                instance.velocity.set(0, 2.0, 0); // Steady rise
                instance.life = 2.5;
                instance.maxLife = 2.5;
                instance.offset.y = 2.0; // Start higher

            } else if (classes.includes('sleep')) {
                // SLEEP DRIFT (Slow meandering)
                instance.gravity = -0.5; // Slight anti-gravity
                instance.velocity.set(0, 0.5, 0);
                instance.life = 3.0;
                instance.maxLife = 3.0;

            } else {
                // DEFAULT (Status, etc)
                instance.velocity.set(0, 3.0, 0);
                instance.gravity = 5.0; // Slight arc
            }
            
            // Randomize start pos slightly to prevent stacking
            if (!target) {
                instance.worldPos.x += (Math.random() - 0.5) * 0.5;
                instance.worldPos.z += (Math.random() - 0.5) * 0.5;
            }
instance.worldPos.y += 1.0;
            this.texts.push(instance);
            this.updatePosition(instance);
        }

// spawnVersus removed

        update(dt) {
            for (let i = this.texts.length - 1; i >= 0; i--) {
                const t = this.texts[i];
                t.life -= dt;
                
                // If attached to a target, update base position (only for non-debris)
                if (t.target && t.target.parent) { 
                    t.worldPos.copy(t.target.position);
                    t.worldPos.y += 1.0; 
                }

                // Physics Integration
                if (t.gravity !== 0 || t.velocity.lengthSq() > 0) {
                    // Gravity
                    t.velocity.y -= t.gravity * dt;
                    
                    // Drag (Air resistance)
                    if (t.drag > 0) {
                        t.velocity.multiplyScalar(Math.max(0, 1.0 - (t.drag * dt)));
                    }

                    // Move
                    t.offset.addScaledVector(t.velocity, dt);

                    // Bounce Logic
                    if (t.offset.y < t.floorY) {
                        t.offset.y = t.floorY;
                        // Bounce velocity
                        t.velocity.y *= -t.elasticity;
                        // Ground friction
                        t.velocity.x *= 0.7;
                        t.velocity.z *= 0.7;
                        
                        // Stop bouncing if energy is low
                        if (Math.abs(t.velocity.y) < 2.0) t.velocity.y = 0;
                    }
                }

                if (t.life <= 0) {
                    if (t.el.parentNode) t.el.parentNode.removeChild(t.el);
                    this.texts.splice(i, 1);
                } else {
                    this.updatePosition(t);
                    // Fade out in last 30%
                    if (t.life < t.maxLife * 0.3) {
                        t.el.style.opacity = t.life / (t.maxLife * 0.3);
                    }
                }
            }
        }

        updatePosition(t) {
            // Project world pos + offset to screen
            this._tempV.copy(t.worldPos).add(t.offset);
            
            // Standard Three.js projection
            this._tempV.project(this.camera);

            const x = (this._tempV.x * .5 + .5) * this.container.clientWidth;
            const y = (-(this._tempV.y * .5) + .5) * this.container.clientHeight;

            // Hide if behind camera
            if (this._tempV.z > 1) {
                t.el.style.display = 'none';
            } else {
                t.el.style.display = 'block';
                t.el.style.transform = `translate(${x}px, ${y}px)`;
            }
}
    }

    window.flux.FloatingTextManager = FloatingTextManager;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    // --- TEXTURE GENERATORS ---
    
    // 1. Venom Bubble (Green, shiny, sharp)
    const _venomTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(32, 32, 4, 32, 32, 30);
        g.addColorStop(0, 'rgba(150, 255, 100, 0.9)');
        g.addColorStop(0.8, 'rgba(0, 200, 0, 0.5)');
        g.addColorStop(1, 'rgba(0, 50, 0, 0)');
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(32, 32, 30, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
        ctx.beginPath(); ctx.arc(20, 20, 6, 0, Math.PI*2); ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 2. Sleep Zzz
    const _napTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.font = 'bold italic 48px sans-serif';
        ctx.fillStyle = '#ffffff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.shadowColor = '#0000ff';
        ctx.shadowBlur = 4;
        ctx.fillText('Z', 32, 32);
        return new THREE.CanvasTexture(c);
    })();

    // 3. Wither Smoke
// 3. Wither Smoke (Optimized to 32x32)
    const _witherTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
        g.addColorStop(0, 'rgba(80, 80, 80, 0.8)');
        g.addColorStop(0.5, 'rgba(40, 40, 40, 0.4)');
        g.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, 32, 32);
        return new THREE.CanvasTexture(c);
    })();

    // 4. Shockwave Ring (Optimized to 64x64)
    const _shockwaveTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        const cx = 32, cy = 32;
        const g = ctx.createRadialGradient(cx, cy, 20, cx, cy, 30);
        g.addColorStop(0, 'rgba(255, 255, 255, 0)');
        g.addColorStop(0.5, 'rgba(255, 255, 255, 1)');
        g.addColorStop(1, 'rgba(255, 255, 255, 0)');
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, 64, 64);
        return new THREE.CanvasTexture(c);
    })();

    // 5. Flash Star (Optimized to 32x32)
    const _flashTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        const cx = 16, cy = 16;
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        for(let i=0; i<4; i++) {
            const a = (i * Math.PI / 2);
            ctx.moveTo(cx, cy);
            ctx.lineTo(cx + Math.cos(a)*15, cy + Math.sin(a)*15);
            ctx.lineTo(cx + Math.cos(a + 0.2)*5, cy + Math.sin(a + 0.2)*5);
        }
        ctx.fill();
        const g = ctx.createRadialGradient(cx, cy, 0, cx, cy, 10);
        g.addColorStop(0, 'rgba(255, 255, 255, 1)');
        g.addColorStop(1, 'rgba(255, 255, 255, 0)');
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(cx, cy, 10, 0, Math.PI*2); ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 6. Debris Shard (New)
    const _debrisTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.moveTo(16, 0); ctx.lineTo(32, 16); ctx.lineTo(16, 32); ctx.lineTo(0, 16);
        ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 7. Bubble Texture (New: Aesthetic & Subtle)
// 7. Bubble Texture (New: Aesthetic & Subtle)
    const _bubbleTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        
        // Clear
        ctx.clearRect(0, 0, 64, 64);

        // Tighter, Shimmery Bubble
        const g = ctx.createRadialGradient(32, 32, 0, 32, 32, 28);
        g.addColorStop(0, 'rgba(255, 255, 255, 0.95)'); // Sharp highlight center
        g.addColorStop(0.3, 'rgba(200, 240, 255, 0.4)');
        g.addColorStop(0.8, 'rgba(100, 200, 255, 0.1)');
        g.addColorStop(1, 'rgba(0, 0, 0, 0)');
        
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(32, 32, 30, 0, Math.PI*2); ctx.fill();
        
        // Sharp Specular Dot
        ctx.fillStyle = 'rgba(255, 255, 255, 1.0)';
        ctx.beginPath(); 
        ctx.arc(20, 20, 4, 0, Math.PI * 2); 
        ctx.fill();
        
        return new THREE.CanvasTexture(c);
    })();

    // 8. Micro Bubble (New: Sharp, high-vis cavitation)
    const _microBubbleTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, 32, 32);
        
        // Intense bright core
        const g = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
        g.addColorStop(0, 'rgba(255, 255, 255, 1.0)');
        g.addColorStop(0.3, 'rgba(220, 255, 255, 0.8)');
        g.addColorStop(0.6, 'rgba(100, 200, 255, 0.3)');
        g.addColorStop(1.0, 'rgba(0, 0, 0, 0)');
        
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(16, 16, 16, 0, Math.PI*2); ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 9. Dash Stream (New: Speed line)
    const _dashStreamTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 16;
        const ctx = c.getContext('2d');
        
        const g = ctx.createLinearGradient(0, 0, 64, 0);
        g.addColorStop(0, 'rgba(0, 255, 255, 0)');
        g.addColorStop(0.5, 'rgba(200, 255, 255, 0.8)');
        g.addColorStop(1, 'rgba(0, 255, 255, 0)');
        
        ctx.fillStyle = g;
        ctx.fillRect(0, 4, 64, 8);
        
        return new THREE.CanvasTexture(c);
    })();

    class ParticleManager {

        constructor(scene) {
            this.scene = scene;
            this.particles = [];
            
            // Mobile Optimization: Check screen width
            const isMobile = window.innerWidth < 800;
            
            // Shared Materials
            // Note: alphaTest added to NormalBlending materials to help GPU discard transparent pixels
            this.materials = {
                venom: new THREE.SpriteMaterial({ map: _venomTex, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending }),
                nap: new THREE.SpriteMaterial({ map: _napTex, transparent: true, depthWrite: false, blending: THREE.NormalBlending, alphaTest: 0.1 }),
                wither: new THREE.SpriteMaterial({ map: _witherTex, transparent: true, depthWrite: false, blending: THREE.NormalBlending, alphaTest: 0.05 }),
                learned: new THREE.SpriteMaterial({ map: _venomTex, color: 0x00ffff, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending }),
                shockwave: new THREE.SpriteMaterial({ map: _shockwaveTex, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending }),
                flash: new THREE.SpriteMaterial({ map: _flashTex, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending }),
                debris: new THREE.SpriteMaterial({ map: _debrisTex, transparent: true, depthWrite: false, blending: THREE.NormalBlending, alphaTest: 0.1 }),
                bubble: new THREE.SpriteMaterial({ map: _bubbleTex, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending }),
                bubble_micro: new THREE.SpriteMaterial({ map: _microBubbleTex, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending }),
                dash_stream: new THREE.SpriteMaterial({ map: _dashStreamTex, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending })
            };

            // Object Pool
            this.pool = [];
            // Reduce pool size on mobile to prevent excessive overdraw
            this.poolSize = isMobile ? 120 : 300;
            
            for(let i=0; i<this.poolSize; i++) {
                // Clone material to allow individual opacity/rotation
                // We clone 'venom' as a placeholder, it gets overwritten in spawn()
                const mat = this.materials.venom.clone();
                const sprite = new THREE.Sprite(mat); 
                sprite.visible = false;
                sprite.scale.set(0,0,0); 
                // Optimization: Disable frustum culling for particles to avoid CPU overhead of bounding box calc
                // since they are always in front of camera usually, or cheap to draw.
                // Actually, keeping culling is better if they go off screen.
                // sprite.frustumCulled = false; 
                this.scene.add(sprite);
                this.pool.push(sprite);
            }
        }

        spawn(type, pos, options = {}) {
            const p = this.pool.find(s => !s.visible);
            if (!p) return;

            p.visible = true;
            
            const template = this.materials[type] || this.materials.venom;
            p.material.map = template.map;
            p.material.blending = template.blending;
            p.material.depthWrite = template.depthWrite;
            p.material.transparent = template.transparent;

            p.position.copy(pos);
            
            p.material.rotation = 0;
            p.material.color.setHex(0xffffff);
            p.material.opacity = 1.0;

            const data = {
                mesh: p,
                type: type,
                age: 0,
                life: options.life || 1.0,
                maxLife: options.life || 1.0,
                velocity: new THREE.Vector3(0, 0, 0),
                startScale: options.scale || 1.0,
                gravity: 0,
                drag: 0
            };

            // Configuration per type
            if (type === 'venom') {
                data.life = 1.0 + Math.random() * 0.5;
                data.velocity.set(0, 1.0 + Math.random(), 0);
                data.startScale = 0.3 + Math.random() * 0.2;
                p.material.opacity = 0.8;
                
            } else if (type === 'nap') {
                data.life = 2.0;
                data.velocity.set((Math.random()-0.5)*0.2, 0.5, (Math.random()-0.5)*0.2);
                data.startScale = 0.4;
                p.material.opacity = 1.0;

            } else if (type === 'wither') {
                data.life = 1.5;
                data.velocity.set((Math.random()-0.5)*0.5, 0.5, (Math.random()-0.5)*0.5);
                p.material.opacity = 0.6;
                p.material.rotation = Math.random() * Math.PI;

            } else if (type === 'shockwave') {
                data.life = options.life || 0.4;
                data.maxLife = data.life;
                data.startScale = options.scale || 2.0;
                p.material.opacity = 1.0;
                
            } else if (type === 'flash') {
                data.life = 0.2;
                data.maxLife = 0.2;
                data.startScale = options.scale || 3.0;
                p.material.opacity = 1.0;
                p.material.rotation = Math.random() * Math.PI;

            } else if (type === 'debris') {
                data.life = 1.5;
                data.maxLife = 1.5;
                const speed = 5.0 + Math.random() * 10.0;
                data.velocity.set(
                    (Math.random()-0.5) * speed,
                    (Math.random() * speed * 0.5) + 2.0,
                    (Math.random()-0.5) * speed
                );
                data.gravity = 20.0;
                data.drag = 1.0;
                data.startScale = (options.scale || 0.3) * (0.5 + Math.random());
                p.material.opacity = 1.0;
                p.material.rotation = Math.random() * Math.PI;

            } else if (type === 'bubble') {
                data.life = 1.0 + Math.random() * 1.0;
                data.maxLife = data.life;
                data.velocity.set(
                    (Math.random() - 0.5) * 0.5,
                    0.5 + Math.random() * 1.0,
                    (Math.random() - 0.5) * 0.5
                );
data.startScale = (options.scale || 0.15) * (0.8 + Math.random() * 0.4); // Smaller, tighter bubbles
                p.material.opacity = 0.9; // More opaque
                p.material.color.setHex(0xaaccff);

            } else if (type === 'bubble_micro') {
                data.life = 0.4 + Math.random() * 0.4;
                data.maxLife = data.life;
                data.velocity.set(
                    (Math.random() - 0.5) * 1.5,
                    1.5 + Math.random() * 2.0,
                    (Math.random() - 0.5) * 1.5
                );
data.startScale = (options.scale || 0.15) * (0.8 + Math.random() * 0.5); // Larger micro bubbles
                p.material.opacity = 1.0;
                p.material.color.setHex(0xffffff);

            } else if (type === 'dash_stream') {
                data.life = 0.3;
                data.maxLife = 0.3;
                data.startScale = options.scale || 2.0;
                p.material.opacity = 0.8;
                p.material.rotation = Math.random() * Math.PI;
            }

            if (type !== 'shockwave') {
                p.scale.setScalar(data.startScale);
            } else {
                p.scale.setScalar(0.1);
            }

            this.particles.push(data);
        }

        update(dt) {
            for (let i = this.particles.length - 1; i >= 0; i--) {
                const p = this.particles[i];
                p.age += dt;

                if (p.age >= p.life) {
                    p.mesh.visible = false;
                    p.mesh.scale.set(0,0,0);
                    this.particles.splice(i, 1);
                    continue;
                }

                const t = p.age / p.life;

                if (p.gravity > 0) p.velocity.y -= p.gravity * dt;
                if (p.drag > 0) p.velocity.multiplyScalar(Math.max(0, 1.0 - (p.drag * dt)));
                p.mesh.position.addScaledVector(p.velocity, dt);

                if (p.type === 'shockwave') {
                    const s = p.startScale * Math.pow(t, 0.5) * 5.0; 
                    p.mesh.scale.setScalar(s);
                    p.mesh.material.opacity = 1.0 - Math.pow(t, 2);
                    
                } else if (p.type === 'flash') {
                    const s = p.startScale * (1.0 - t);
                    p.mesh.scale.setScalar(s);
                    p.mesh.material.rotation += 5.0 * dt;

                } else if (p.type === 'debris') {
                    p.mesh.material.rotation += 10.0 * dt;
                    p.mesh.scale.setScalar(p.startScale * (1.0 - t));
                    
                } else if (p.type === 'venom') {
                    p.mesh.position.x += Math.sin(p.age * 10 + p.mesh.id) * dt * 0.5;
                    p.mesh.material.opacity = 0.8 * (1.0 - Math.pow(t, 3));
                    
                } else if (p.type === 'nap') {
                    const s = p.startScale * (0.5 + t * 1.5);
                    p.mesh.scale.setScalar(s);
                    p.mesh.material.opacity = 1.0 - Math.pow(t, 2);
                    p.mesh.position.x += Math.sin(p.age * 2) * dt * 0.3;

                } else if (p.type === 'bubble') {
                    p.mesh.position.x += Math.sin(p.age * 5.0 + p.mesh.id) * dt * 0.2;
                    p.mesh.position.z += Math.cos(p.age * 4.0 + p.mesh.id) * dt * 0.2;
                    
                    const s = p.startScale * (1.0 + t * 0.2);
                    p.mesh.scale.setScalar(s);
                    p.mesh.material.opacity = 0.6 * (1.0 - Math.pow(t, 2));

                } else if (p.type === 'bubble_micro') {
                    p.mesh.position.x += (Math.random() - 0.5) * dt * 2.0;
                    p.mesh.position.z += (Math.random() - 0.5) * dt * 2.0;
                    
                    const s = p.startScale * (1.0 - t);
                    p.mesh.scale.setScalar(s);
                    p.mesh.material.opacity = 0.9 * (1.0 - t);
                    
                    const s2 = p.startScale;
                    p.mesh.scale.set(s2 * (1.0 + t), s2 * 0.2, 1.0);
                }
            }
        }
    }
    window.flux.ParticleManager = ParticleManager;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // --- TEXTURE GENERATION ---
    const _createGlyphTexture = (colorStr, type) => {
        const size = 256;
        const c = document.createElement('canvas');
        c.width = size; c.height = size;
        const ctx = c.getContext('2d');
        
        ctx.clearRect(0, 0, size, size);
        
        // Glow settings
        ctx.shadowBlur = 15;
        ctx.shadowColor = colorStr;
        ctx.strokeStyle = colorStr;
        ctx.fillStyle = colorStr;
        ctx.lineCap = 'round';

        const cx = size / 2;
        const cy = size / 2;

        if (type === 'ring') {
            // Outer Ring
            ctx.lineWidth = 6;
            ctx.beginPath();
            ctx.arc(cx, cy, 110, 0, Math.PI * 2);
            ctx.stroke();

            // Inner Ring
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(cx, cy, 90, 0, Math.PI * 2);
            ctx.stroke();

            // Runes
ctx.font = '24px Spira, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            for(let i=0; i<8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const r = 100;
                const x = cx + Math.cos(angle) * r;
                const y = cy + Math.sin(angle) * r;
                
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(angle + Math.PI/2);
                // Draw a simple rune-like shape
                ctx.beginPath();
                ctx.moveTo(-5, -5); ctx.lineTo(5, 0); ctx.lineTo(-5, 5);
                ctx.stroke();
                ctx.restore();
            }
        } else if (type === 'rune') {
            // Central Complex Rune
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.arc(cx, cy, 60, 0, Math.PI * 2);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(cx, cy - 60);
            ctx.lineTo(cx, cy + 60);
            ctx.moveTo(cx - 60, cy);
            ctx.lineTo(cx + 60, cy);
            ctx.stroke();

            ctx.beginPath();
            ctx.arc(cx, cy, 20, 0, Math.PI * 2);
            ctx.fill();
        }

        const tex = new THREE.CanvasTexture(c);
        return tex;
    };

    const _techTexture = _createGlyphTexture('#00ffff', 'ring'); // Cyan Ring
    const _statusTexture = _createGlyphTexture('#ff00ff', 'rune'); // Magenta Rune
    const _chargeTexture = _createGlyphTexture('#ffff00', 'ring'); // Gold Ring

    class GlyphManager {
        constructor(scene) {
            this.scene = scene;
            this.glyphs = [];
            
            // Materials
            this.materials = {
                tech: new THREE.MeshBasicMaterial({ 
                    map: _techTexture, 
                    transparent: true, 
                    side: THREE.DoubleSide, 
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    color: 0xffffff
                }),
                status: new THREE.MeshBasicMaterial({ 
                    map: _statusTexture, 
                    transparent: true, 
                    side: THREE.DoubleSide, 
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    color: 0xffffff
                }),
                charge: new THREE.MeshBasicMaterial({ 
                    map: _chargeTexture, 
                    transparent: true, 
                    side: THREE.DoubleSide, 
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    color: 0xffffff
                })
            };

            // Pool
            this.pool = [];
            this.poolSize = 30;
            const geo = new THREE.PlaneGeometry(1, 1);
            
            for(let i=0; i<this.poolSize; i++) {
                const mesh = new THREE.Mesh(geo, this.materials.tech);
                mesh.visible = false;
                mesh.renderOrder = 2000; // Draw on top of water/arena
                this.scene.add(mesh);
                this.pool.push(mesh);
            }
        }

        spawn(type, pos, options = {}) {
            const mesh = this.pool.find(m => !m.visible);
            if (!mesh) return;

            mesh.visible = true;
            mesh.material = this.materials[type] || this.materials.tech;
            mesh.position.copy(pos);
            
            // Reset Material Opacity
            mesh.material.opacity = 1.0;

            // Defaults
            const scale = options.scale || 1.0;
            mesh.scale.set(scale, scale, scale);
            
            // Orientation
            if (options.faceCamera) {
                if (window.flux.gameInstance && window.flux.gameInstance.camera) {
                    mesh.lookAt(window.flux.gameInstance.camera.position);
                }
            } else if (options.orientation === 'vertical') {
                mesh.rotation.set(0, 0, 0);
                // Face camera Y-axis rotation only
                if (window.flux.gameInstance && window.flux.gameInstance.camera) {
                    const camPos = window.flux.gameInstance.camera.position;
                    const angle = Math.atan2(camPos.x - pos.x, camPos.z - pos.z);
                    mesh.rotation.y = angle;
                }
            } else {
                // Horizontal (Ground)
                mesh.rotation.set(-Math.PI / 2, 0, Math.random() * Math.PI);
            }

            if (options.offsetY) {
                mesh.position.y += options.offsetY;
            }

            this.glyphs.push({
                mesh: mesh,
                age: 0,
                life: options.life || 1.0,
                maxLife: options.life || 1.0,
                rotationSpeed: options.rotationSpeed || 1.0,
                scaleSpeed: options.scaleSpeed || 0,
                fade: options.fade !== undefined ? options.fade : true,
                followTarget: options.parent || null,
                offsetY: options.offsetY || 0
            });
        }
update(dt) {
            for (let i = this.glyphs.length - 1; i >= 0; i--) {
                const g = this.glyphs[i];
                g.age += dt;

                if (g.age >= g.life) {
                    g.mesh.visible = false;
                    this.glyphs.splice(i, 1);
                    continue;
                }

                const t = g.age / g.maxLife;

                // Follow target
                if (g.followTarget && g.followTarget.mesh) {
                    g.mesh.position.copy(g.followTarget.mesh.position);
                    g.mesh.position.y += g.offsetY;
                    
                    // If ground oriented, keep near floor
                    if (g.mesh.rotation.x === -Math.PI/2) {
                         g.mesh.position.y = 0.1 + g.offsetY;
                    }
                }

                // Animation
                g.mesh.rotation.z += g.rotationSpeed * dt;
                
                if (g.scaleSpeed !== 0) {
                    const s = g.mesh.scale.x + g.scaleSpeed * dt;
                    g.mesh.scale.set(s, s, s);
                }

                // Fade
                if (g.fade) {
                    let opacity = 1.0;
                    if (t < 0.1) opacity = t / 0.1;
                    else if (t > 0.7) opacity = 1.0 - ((t - 0.7) / 0.3);
                    g.mesh.material.opacity = opacity;
                }
            }
        }

        clear() {
            // Hide all active glyphs and reset list
            for (const g of this.glyphs) {
                if (g.mesh) g.mesh.visible = false;
            }
            this.glyphs = [];
        }
    }

    window.flux.GlyphManager = GlyphManager;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Reusable vectors to avoid Garbage Collection
    const _idealPos = new THREE.Vector3();
    const _idealLook = new THREE.Vector3();
    const _currentPos = new THREE.Vector3();
    const _currentLook = new THREE.Vector3();
    const _velocity = new THREE.Vector3();
    const _targetWorldPos = new THREE.Vector3();
    const _camOffset = new THREE.Vector3();
    const _lookAhead = new THREE.Vector3();
    const _goalPos = new THREE.Vector3();
    const _camFwd = new THREE.Vector3();
    const _camRight = new THREE.Vector3();

    class CameraManager {
        constructor(camera, scene) {
            this.camera = camera;
            this.scene = scene;

            // --- IMPROVED CONFIGURATION ---
// --- IMPROVED CONFIGURATION ---
            this.config = {
                // FIXED PERSPECTIVE SETTINGS
                baseDistance: 20.0,   // Slightly closer for immersion
                baseHeight: 12.0,     // Lower angle for chase feel

                // IMPROVED: Faster, more responsive smoothing
                followSpeed: 6.0,     // Snappier follow
                lookSpeed: 4.0,       // Responsive look-at

                // Dynamic FOV
                fovBase: 50,
                fovMax: 70,           // Higher max for speed sensation

                // IMPROVED: Look-ahead settings
                lookAheadDistance: 10.0, // Look further ahead
                lookAheadSmoothing: 4.0,

                // Smart framing
                ballTrackWeight: 0.15, 
                threatAwareness: true
            };

            // State
            this.target = null;
            this.ball = null; // Direct ball reference for smart framing
            this.targetVel = new THREE.Vector3();
            this.targetInput = new THREE.Vector3();
            this.smoothedInput = new THREE.Vector3();
            this.smoothedLookAhead = new THREE.Vector3();

            // Camera State
            this.pos = camera.position.clone();
            this.lookAt = new THREE.Vector3(0, 0, 0);

            // Orbit State
            this.currentYaw = Math.PI;
            this.targetYaw = Math.PI;

            // IMPROVED: Manual orbit from touch (right side of screen)
            this.manualOrbitYaw = 0;
            this.manualOrbitPitch = 0;
            this.orbitSensitivity = 0.004;
            this.autoRecenterTimer = 0;
            this.autoRecenterDelay = 3.0;

// Shake
            this.shakeIntensity = 0;
            this.shakeRoll = 0; // NEW: Rotational shake
this.shakeOffset = new THREE.Vector3();
            this.fovImpulse = 0;
            this.rollImpulse = 0; // NEW: Dynamic tilt for curves

            // Cinematic State
            this.isCinematic = false;
            this.cinematicTimer = 0;
            this.cinematicDuration = 0;
            this.cinematicType = 'default';
            this.cinematicStartPos = new THREE.Vector3();
            this.cinematicStartLook = new THREE.Vector3();
            this.cinematicEndPos = new THREE.Vector3();

            // IMPROVED: Dynamic pull-back based on action
            this.currentPullBack = 0;
            this.maxPullBack = 8;
        }

        // NEW: Set ball reference for smart framing
        setBall(ball) {
            this.ball = ball;
        }

        // IMPROVED: Get camera-relative input transformation
        getCameraRelativeInput(inputX, inputZ) {
            this.camera.getWorldDirection(_camFwd);
            _camFwd.y = 0;

            if (_camFwd.lengthSq() < 0.001) {
                _camFwd.set(0, 0, -1);
            } else {
                _camFwd.normalize();
            }

            _camRight.crossVectors(new THREE.Vector3(0, 1, 0), _camFwd).normalize();

            // Transform input to world space
            const worldX = (inputX * _camRight.x) + (inputZ * _camFwd.x);
            const worldZ = (inputX * _camRight.z) + (inputZ * _camFwd.z);

            return { x: worldX, z: worldZ };
        }

        // NEW: Manual orbit input from touch
        handleOrbitInput(dx, dy) {
            this.manualOrbitYaw += dx * this.orbitSensitivity;
            this.manualOrbitPitch += dy * this.orbitSensitivity * 0.5;

            // Clamp pitch
            this.manualOrbitPitch = Math.max(-0.3, Math.min(0.5, this.manualOrbitPitch));

            // Reset auto-recenter timer
            this.autoRecenterTimer = 0;
        }

        // NEW: Recenter camera
        recenter() {
            this.manualOrbitYaw = 0;
            this.manualOrbitPitch = 0;
        }

        playCinematic(type, target, duration = 1.5) {
            this.isCinematic = true;
            this.cinematicTimer = 0;
            this.cinematicDuration = duration;
            this.target = target;
            this.cinematicType = type;

            this.cinematicStartPos.copy(this.pos);
            this.cinematicStartLook.copy(this.lookAt);

            this.addFovImpulse(-15);
        }

        _updateCinematic(dt) {
            this.cinematicTimer += dt;
            const progress = Math.min(1.0, this.cinematicTimer / this.cinematicDuration);

            const t = 1 - Math.pow(1 - progress, 3);

            let activeTarget = this.target;
            let isBallTracking = false;
            const ball = window.flux.gameInstance ? window.flux.gameInstance.entities.ball : null;

            if (ball && ball.mesh && ball.state === 'free' && ball.velocity.lengthSq() > 2.0) {
                activeTarget = ball.mesh;
                isBallTracking = true;
            }

            if (!activeTarget) {
                this.isCinematic = false;
                return;
            }

            activeTarget.getWorldPosition(_targetWorldPos);

            const endLook = _targetWorldPos.clone();
            let fwd = new THREE.Vector3();
            let right = new THREE.Vector3();

            if (isBallTracking) {
                endLook.addScaledVector(ball.velocity, 0.3);

                fwd.copy(ball.velocity).normalize();
                fwd.y = 0;
                if (fwd.lengthSq() < 0.01) fwd.set(0,0,1);
                fwd.normalize();

                right.crossVectors(new THREE.Vector3(0,1,0), fwd).normalize();
            } else {
                endLook.y += 1.5;
                fwd.set(0, 0, 1).applyQuaternion(activeTarget.quaternion);
                right.set(1, 0, 0).applyQuaternion(activeTarget.quaternion);
            }

            const endPos = _targetWorldPos.clone();

            if (this.cinematicType === 'jecht') {
                const dist = isBallTracking ? 14.0 : 10.0;
                const offset = fwd.clone().multiplyScalar(-dist).add(right.clone().multiplyScalar(3.0));
                endPos.add(offset);
                endPos.y += 6.0;
            } else if (this.cinematicType === 'sphere') {
                const dist = isBallTracking ? 16.0 : 12.0;
                const offset = fwd.clone().multiplyScalar(-dist);
                endPos.add(offset);
                endPos.y += 10.0;
            } else if (this.cinematicType === 'invisible') {
                const dist = 12.0;
                const offset = fwd.clone().multiplyScalar(-dist * 0.5).add(right.clone().multiplyScalar(dist));
                endPos.add(offset);
                endPos.y += 5.0;
            } else {
                const dist = isBallTracking ? 14.0 : 10.0;
                const offset = fwd.clone().multiplyScalar(-dist);
                endPos.add(offset);
                endPos.y += 5.0;
            }

            this.pos.lerp(endPos, dt * 4.0);
            this.lookAt.lerp(endLook, dt * 6.0);

            this.camera.position.copy(this.pos);
            this.camera.lookAt(this.lookAt);

            if (this.cinematicTimer >= this.cinematicDuration) {
                this.isCinematic = false;
            }
        }

setTarget(mesh, velocity, input, isAiming = false) {
            this.target = mesh;
            if (velocity) this.targetVel.copy(velocity);
            if (input) this.targetInput.copy(input);
            else this.targetInput.set(0, 0, 0);
            this.isAiming = isAiming;
        }

        // Keep for compatibility
        handleInput(dx, dy) {
            this.handleOrbitInput(dx, dy);
        }

        getYaw() { return this.currentYaw; }

        addShake(amount) {

            this.shakeIntensity = Math.min(this.shakeIntensity + amount, 4.0); // Increased cap
            this.shakeRoll = Math.min(this.shakeRoll + amount * 0.2, 0.8); // Add roll
        }
        addFovImpulse(amount) {
            this.fovImpulse = Math.min(this.fovImpulse + amount, 30);

        }
        addRollImpulse(amount) {
            this.rollImpulse += amount;
            // Clamp
            this.rollImpulse = Math.max(-0.5, Math.min(0.5, this.rollImpulse));
}

        snapToTarget() {
            if (!this.target) return;
            this.target.getWorldPosition(_targetWorldPos);

            this._calculateIdealState(0);

            this.pos.copy(_idealPos);
            this.lookAt.copy(_idealLook);
            this.currentYaw = this.targetYaw;

            this.camera.position.copy(this.pos);
            this.camera.lookAt(this.lookAt);

            this.smoothedInput.set(0, 0, 0);
            this.smoothedLookAhead.set(0, 0, 0);
        }

        update(dt) {
            if (this.isCinematic) {
                this._updateCinematic(dt);
                return;
            }

            if (!this.target) return;

            const safeDt = Math.min(dt, 0.05);

            // IMPROVED: Auto-recenter logic (Only if not aiming)
            if (!this.isAiming) {
                this.autoRecenterTimer += safeDt;
                if (this.autoRecenterTimer > this.autoRecenterDelay) {
                    const recenterSpeed = 2.0 * safeDt;
                    this.manualOrbitYaw *= (1.0 - recenterSpeed);
                    this.manualOrbitPitch *= (1.0 - recenterSpeed);
                }
            }

            // IMPROVED: Smart pull-back based on ball speed
            if (this.ball && this.ball.velocity) {
                const ballSpeed = this.ball.velocity.length();
                const targetPullBack = Math.min(this.maxPullBack, ballSpeed * 0.3);
                this.currentPullBack += (targetPullBack - this.currentPullBack) * safeDt * 3.0;
            } else {
                this.currentPullBack *= (1.0 - safeDt * 2.0);
            }

            // 1. Update Target Info
            this.target.getWorldPosition(_targetWorldPos);

            // 2. Calculate Ideal State
            this._calculateIdealState(safeDt);

            // 3. IMPROVED: Faster, more responsive smoothing
// 3. IMPROVED: Faster, more responsive smoothing
            // Dynamic follow speed based on distance error (Catch-up logic)
            const distError = this.pos.distanceTo(_idealPos);
            const dynamicFollow = this.config.followSpeed + (distError * 0.2);
            
            const speedMult = this.isAiming ? 2.0 : 1.0;
            const lookFactor = 1.0 - Math.exp(-this.config.lookSpeed * speedMult * safeDt);
            const posFactor = 1.0 - Math.exp(-dynamicFollow * speedMult * safeDt);

            this.pos.lerp(_idealPos, posFactor);
            this.pos.lerp(_idealPos, posFactor);
            this.lookAt.lerp(_idealLook, lookFactor);

            // 4. Screen Shake (Position & Rotation)
            if (this.shakeIntensity > 0) {
                const decay = 8.0 * safeDt; // Fast decay for snappy feel
                this.shakeIntensity -= decay;
                if (this.shakeIntensity < 0) this.shakeIntensity = 0;

                const shakeMag = this.shakeIntensity * 0.5;
                this.shakeOffset.set(
                    (Math.random() - 0.5) * shakeMag,
                    (Math.random() - 0.5) * shakeMag,
                    (Math.random() - 0.5) * shakeMag
                );
            } else {
                this.shakeOffset.set(0, 0, 0);
            }

            // Roll Shake
            if (this.shakeRoll > 0) {
                this.shakeRoll -= 5.0 * safeDt;
                if (this.shakeRoll < 0) this.shakeRoll = 0;
                this.camera.rotation.z = (Math.random() - 0.5) * this.shakeRoll;
} else {
                this.camera.rotation.z = 0;
            }
            
            // Apply Curve Tilt (Roll Impulse)
            if (Math.abs(this.rollImpulse) > 0.001) {
                this.camera.rotation.z += this.rollImpulse;
                this.rollImpulse *= (1.0 - 4.0 * safeDt); // Decay
            }

            // 5. Dynamic FOV
// 5. Dynamic FOV
            const speed = this.targetVel.length();
            const speedRatio = Math.min(speed / 25.0, 1.0);
            const warp = speedRatio * speedRatio;

            // Zoom in slightly when aiming
            const aimZoom = this.isAiming ? -10 : 0;
            const targetFov = this.config.fovBase + (this.config.fovMax - this.config.fovBase) * warp + this.fovImpulse + aimZoom;

            this.fovImpulse *= Math.max(0, 1.0 - (6.0 * safeDt));

            this.camera.fov += (targetFov - this.camera.fov) * 4.0 * safeDt;
            this.camera.updateProjectionMatrix();

            // 6. Apply to Camera
            this.camera.position.copy(this.pos).add(this.shakeOffset);
            this.camera.lookAt(this.lookAt);
        }

_calculateIdealState(dt) {
            const tPos = _targetWorldPos;

            // --- AIM MODE OVERRIDE ---
            if (this.isAiming) {
                // Relaxed Aim Mode: Zoom in but maintain orientation
                const aimDist = 14.0; 
                const aimHeight = 6.0;
                
                // Use Manual Orbit Logic (Consistent with Standard Mode)
                const effectiveDistance = aimDist;
                const effectiveHeight = aimHeight + this.manualOrbitPitch * 10;
                
                // Base Z offset (Camera defaults to +Z)
                const camZ = effectiveDistance;
                
                // Apply Orbit Rotation
                const finalX = camZ * Math.sin(this.manualOrbitYaw);
                const finalZ = camZ * Math.cos(this.manualOrbitYaw);
                
                _idealPos.set(tPos.x + finalX, tPos.y + effectiveHeight, tPos.z + finalZ);
                
                _idealLook.copy(tPos);
                _idealLook.y += 1.0; // Look at player center
                
                // Disable look-ahead to keep framing stable while aiming
                this.smoothedLookAhead.set(0,0,0);
                
                return;
            }

            // --- STANDARD MODE ---

            // 0. Threat Assessment (Dynamic Pull-back)
            let threatPullback = 0;
            if (this.config.threatAwareness) {
                const threat = this._calculateThreatLevel(tPos);
                threatPullback = threat * 6.0; // Pull back up to 6 units
            }

            // IMPROVED: Apply manual orbit
            // 1. Calculate Ideal Position with pull-back
            const effectiveDistance = this.config.baseDistance + this.currentPullBack + threatPullback;
            const effectiveHeight = this.config.baseHeight + this.currentPullBack * 0.3 + threatPullback * 0.5 + this.manualOrbitPitch * 10;

            // Base offset (Camera usually sits at +Z relative to target)
            const camZ = effectiveDistance;

            // Apply Orbit Rotation
            const finalCamX = camZ * Math.sin(this.manualOrbitYaw);
            const finalCamZ = camZ * Math.cos(this.manualOrbitYaw);

            _idealPos.set(tPos.x + finalCamX, tPos.y + effectiveHeight, tPos.z + finalCamZ);

            // Clamp to arena bounds (roughly) to prevent clipping through walls
            if (_idealPos.z > 48.0) _idealPos.z = 48.0;
            if (_idealPos.z < -48.0) _idealPos.z = -48.0;

            // 2. Calculate Ideal LookAt with IMPROVED look-ahead
            _idealLook.copy(tPos);

            // IMPROVED: Velocity-based look-ahead
            if (this.targetVel.lengthSq() > 0.5) {
                const speed = this.targetVel.length();
                const lookAheadFactor = Math.min(1.0, speed / 15.0) * this.config.lookAheadDistance;

                const velDir = this.targetVel.clone().normalize();
                _lookAhead.copy(velDir).multiplyScalar(lookAheadFactor);

                // Smooth the look-ahead
                this.smoothedLookAhead.lerp(_lookAhead, dt * this.config.lookAheadSmoothing);
                _idealLook.add(this.smoothedLookAhead);
            } else {
                this.smoothedLookAhead.multiplyScalar(1.0 - dt * 3.0);
                _idealLook.add(this.smoothedLookAhead);
            }

            _idealLook.y *= 0.5; // Look slightly lower than actual target height

            // IMPROVED: Include ball in framing when nearby
            if (this.ball && this.ball.mesh && this.config.ballTrackWeight > 0) {
                const ballPos = this.ball.mesh.position;
                const distToBall = tPos.distanceTo(ballPos);

                if (distToBall < 25 && distToBall > 2) {
                    const ballWeight = Math.max(0, 1 - distToBall / 25) * this.config.ballTrackWeight;
                    _idealLook.lerp(ballPos, ballWeight);
                }
            }

            // 3. Input Anticipation (Smoothed)
            this.smoothedInput.lerp(this.targetInput, dt * 3.0);

            if (this.smoothedInput.lengthSq() > 0.01) {
                _idealLook.x += this.smoothedInput.x * 4.0;
                _idealLook.z += this.smoothedInput.z * 4.0;
            }
        }

        _calculateThreatLevel(centerPos) {
            if (!window.flux.gameInstance) return 0;
            const game = window.flux.gameInstance;
            
            let density = 0;
            const checkTeam = (team) => {
                if (!team) return;
                for (let i = 0; i < team.players.length; i++) {
                    const p = team.players[i];
                    if (p.mesh && p.mesh !== this.target) {
                        const dSq = p.mesh.position.distanceToSquared(centerPos);
                        if (dSq < 64.0) { // 8m radius
                            density += 1.0;
                        }
                    }
                }
            };
            checkTeam(game.teams.home);
            checkTeam(game.teams.away);
            
            return Math.min(1.0, density / 4.0); // Cap at 4 players
        }

        // NEW: Get forward direction for UI reference
        getForwardDirection() {
            this.camera.getWorldDirection(_camFwd);
            _camFwd.y = 0;
            if (_camFwd.lengthSq() < 0.001) {
                _camFwd.set(0, 0, -1);
            } else {
                _camFwd.normalize();
            }
            return _camFwd.clone();
        }

        // NEW: Get right direction
        getRightDirection() {
            const fwd = this.getForwardDirection();
            _camRight.crossVectors(new THREE.Vector3(0, 1, 0), fwd).normalize();
            return _camRight.clone();
        }
    }

    window.flux.CameraManager = CameraManager;
})();
</script>
    <script>(function() {
    window.flux = window.flux || {};

// Tooltip Descriptions for Long-Press
    const TOOLTIP_DESCRIPTIONS = {
        'SUBSTEPS': "Physics iterations per frame. Higher = more stable, more CPU.",
        'STOP_SPEED': "Velocity threshold below which the ball snaps to a halt.",
        'WATER_DRAG_LINEAR': "Base water resistance. Slows ball linearly.",
        'WATER_DRAG_QUAD': "Quadratic drag. Slows high-speed balls significantly.",
        'SPIN_DRAG': "How fast the ball's spin decays over time.",
        'MAGNUS_ENABLED': "Enables the Magnus effect (curve from spin).",
        'MAGNUS_COEFF': "Strength of the curve force relative to spin/speed.",
        'MAGNUS_CAP': "Maximum curve force allowed (prevents physics explosions).",
        'DEPTH_TARGET_Y': "Ideal Y height the ball tries to float at.",
        'DEPTH_SPRING': "Strength of the force pulling ball to Target Y.",
        'DEPTH_DAMP': "Damping on vertical movement to prevent oscillation.",
        'BOUNDARY_RADIUS': "Radius of the circular arena wall.",
        'BOUNDARY_HEIGHT': "Height of the arena ceiling/floor.",
        'WALL_SOFT_BUFFER': "Distance from wall where soft repulsion begins.",
        'WALL_SOFT_FORCE': "Force pushing ball away from wall before impact.",
        'WALL_ELASTICITY': "Bounciness of the wall (0 = dead thud, 1 = perfect bounce).",
        'WALL_FRICTION': "Friction when sliding along the wall.",
        'FLOOR_ELASTICITY': "Bounciness of the floor/ceiling.",
        'GOAL_POCKET_ENABLED': "Enables the extended corridor for the goal.",
        'GOAL_POCKET_X': "Half-width of the goal pocket corridor.",
        'GOAL_POCKET_Z': "Z-depth where the pocket starts.",
        'GOAL_POCKET_RADIUS': "Effective radius inside the pocket.",
        'LAUNCH_SPEED_SCALE': "Multiplier for converting Stat Power to Physics Velocity.",
        'LAUNCH_SPEED_CAP': "Maximum physical speed the ball can be thrown.",
        'SWIPE_MIN_PX': "Minimum swipe distance to register a throw.",
        'AIM_DX_SCALE': "Sensitivity of horizontal aim from swipe.",
        'AIM_DY_SCALE': "Sensitivity of vertical aim from swipe.",
        'POWER_BASE': "Base power multiplier for a quick tap.",
        'POWER_RANGE': "Additional power multiplier at full charge.",
        'POWER_MAX_BONUS_RATIO': "Charge threshold for 'Max Power' bonus.",
        'POWER_MAX_MULTIPLIER': "Multiplier applied when hitting Max Power.",
        'CURVE_ENABLED': "Enables curve shots via curved swipes.",
        'CURVE_INTENSITY_THRESHOLD': "How curved a swipe must be to trigger spin.",
        'CURVE_SPIN_SCALE': "Multiplier for converting swipe curve to ball spin.",
        'CURVE_SPEED_MULT': "Multiplier for spin based on swipe speed.",
        'CURVE_SPIN_CAP': "Maximum spin allowed from a curve throw.",
        'CURVE_PERFECT_SPIN': "Spin threshold to trigger 'Perfect Curve' FX.",
        'timeScale': "Global game speed multiplier.",
        'demoMode': "Toggle AI vs AI auto-play.",
        'resolution': "Internal render resolution scale (0.5 = half res).",
        'arenaOpacity': "Opacity of the outer arena grid.",
        'arena2Opacity': "Opacity of the inner hex grid."
    };

    class DevTools {
        constructor(gameManager) {
            this.game = gameManager;
            
            // lil-gui attaches to window.lil by default in UMD build
            if (!window.lil || !window.lil.GUI) {
                console.warn("DevTools: lil-gui not found.");
                return;
            }

const container = document.getElementById('game-container');
            this.gui = new window.lil.GUI({ title: 'Flux DevTools', container: container });
            
            // Position as a collapsed tab on the right frame
// Position as a sliding tab on the right frame
// Position as a sliding tab on the right frame
// Wrapper for sliding animation
            const wrapper = document.createElement('div');
            wrapper.style.position = 'absolute';
            wrapper.style.top = '100px';
            wrapper.style.right = '-260px';
            wrapper.style.width = '260px';
            wrapper.style.transition = 'right 0.3s cubic-bezier(0.2, 0.8, 0.2, 1.0)';
            wrapper.style.zIndex = '9999';
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = 'column';
            container.appendChild(wrapper);

            const dom = this.gui.domElement;
            dom.style.width = '100%';
            dom.style.setProperty('--width', '100%');
            dom.style.maxHeight = '80vh';
            dom.style.overflowY = 'auto';
            dom.style.overflowX = 'hidden';
            
            // Move GUI into wrapper
            wrapper.appendChild(dom);
            
            // Create Toggle Handle
            const handle = document.createElement('div');
            handle.style.position = 'absolute';
            handle.style.left = '-40px'; // Protrude to the left
            handle.style.top = '0';
            handle.style.width = '40px';
            handle.style.height = '40px';
            handle.style.backgroundColor = 'rgba(0, 20, 40, 0.9)';
            handle.style.border = '1px solid #00ffff';
            handle.style.borderRight = 'none';
            handle.style.borderTopLeftRadius = '8px';
            handle.style.borderBottomLeftRadius = '8px';
            handle.style.cursor = 'pointer';
            handle.style.display = 'flex';
            handle.style.justifyContent = 'center';
            handle.style.alignItems = 'center';
            handle.style.color = '#00ffff';
            handle.style.fontSize = '20px';
            handle.innerHTML = '';
            handle.style.boxShadow = '-5px 0 10px rgba(0,0,0,0.5)';
            
            wrapper.appendChild(handle);
            
            // Toggle Logic
            let isOpen = false;
            handle.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent game inputs
                isOpen = !isOpen;
                wrapper.style.right = isOpen ? '0px' : '-260px';
                handle.innerHTML = isOpen ? '' : '';
            });
            // Default global timeScale if not set
if (window.flux.timeScale === undefined) window.flux.timeScale = 0.8;

this._setupGeneral();
            this._setupGameState();
this._setupOverlays();
            this._setupTeams();
            this._setupPlayerInspector();
            this._setupBallSandbox();
this._setupFXLab();
            this._setupVisualDebug();
            this._setupVisuals();
            this._setupTooltips();
        }

        _setupTooltips() {
            // Create Tooltip DOM
            this.tooltipEl = document.createElement('div');
            Object.assign(this.tooltipEl.style, {
                position: 'fixed',
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                backgroundColor: 'rgba(0, 10, 30, 0.95)',
                border: '2px solid #00ffff',
                padding: '20px',
                color: '#fff',
                fontFamily: 'monospace',
                fontSize: '14px',
                maxWidth: '300px',
                zIndex: '10000',
                display: 'none',
                pointerEvents: 'none',
                boxShadow: '0 0 20px rgba(0, 255, 255, 0.3)',
                borderRadius: '8px',
                textAlign: 'center'
            });
            document.body.appendChild(this.tooltipEl);

            // Recursive function to attach listeners
            const attach = (gui) => {
                // Controllers
                if (gui.controllers) {
                    gui.controllers.forEach(c => {
                        const dom = c.domElement.closest('.controller'); // lil-gui structure
                        if(dom) {
                            const label = dom.querySelector('.name');
                            if(label) {
                                this._addLongPress(label, c.property, c._name);
                            }
                        }
                    });
                }
                // Sub-folders
                if(gui.folders) {
                    gui.folders.forEach(f => attach(f));
                }
            };

            // Wait a tick for GUI to fully render DOM
            setTimeout(() => attach(this.gui), 100);
        }

        _addLongPress(element, property, name) {
            let timer = null;
            const duration = 500; // 0.5s

            const start = (e) => {
                timer = setTimeout(() => {
                    this._showTooltip(property, name);
                }, duration);
            };

            const end = () => {
                if(timer) {
                    clearTimeout(timer);
                    timer = null;
                }
                this._hideTooltip();
            };

            element.addEventListener('mousedown', start);
            element.addEventListener('touchstart', start, {passive: true});
            
            element.addEventListener('mouseup', end);
            element.addEventListener('mouseleave', end);
            element.addEventListener('touchend', end);
            element.addEventListener('touchcancel', end);
        }

        _showTooltip(prop, name) {
            const desc = TOOLTIP_DESCRIPTIONS[prop];
            if(desc) {
                this.tooltipEl.innerHTML = `<strong style="color:#00ffff; font-size:16px;">${name || prop}</strong><br><br>${desc}`;
                this.tooltipEl.style.display = 'block';
            }
        }

        _hideTooltip() {
            if (this.tooltipEl) this.tooltipEl.style.display = 'none';
        }


_setupGeneral() {
            const folder = this.gui.addFolder('General');
            
const params = {
                timeScale: window.flux.timeScale,
                demoMode: this.game.isDemoMode,
                toggleHUD: true,
                resolution: 0.50,
arenaOpacity: 0.3,
                arena2Opacity: 0.25
            };

            folder.add(params, 'timeScale', 0.0, 5.0).name('Game Speed').onChange(v => {
                window.flux.timeScale = v;
            });

            folder.add(params, 'demoMode').name('Demo Mode').listen().onChange(v => {
                if (this.game.isDemoMode !== v) {
                    this.game.toggleDemoMode();
                }
            });

            folder.add(params, 'toggleHUD').name('Show HUD').onChange(v => {
                const hud = document.getElementById('ui-layer');
                if (hud) {
                    hud.style.visibility = v ? 'visible' : 'hidden';
                }
            });

            folder.add(params, 'resolution', 0.1, 2.0).name('Resolution Scale').onChange(v => {
                const w = window.innerWidth;
                const h = window.innerHeight;
                const renderer = this.game.renderer;
                if (renderer) {
                    renderer.setSize(w * v, h * v, false);
                }
            });

folder.add(params, 'arenaOpacity', 0.0, 1.0).name('Arena 1 Opacity').onChange(v => {
                if (window.flux.arenaMesh && window.flux.arenaMesh.material) {
                    window.flux.arenaMesh.material.opacity = v;
                }
            });

            const blendModes = {
                'Normal': THREE.NormalBlending,
                'Additive': THREE.AdditiveBlending,
                'Multiply': THREE.MultiplyBlending,
                'Subtractive': THREE.SubtractiveBlending,
                'NoBlending': THREE.NoBlending
            };
params.arenaBlend = 'Normal';

            folder.add(params, 'arenaBlend', Object.keys(blendModes)).name('Arena 1 Blend').onChange(v => {
                if (window.flux.arenaMesh && window.flux.arenaMesh.material) {
                    window.flux.arenaMesh.material.blending = blendModes[v];
                    window.flux.arenaMesh.material.needsUpdate = true;
                }
            });

            // Arena 2 Controls
folder.add(params, 'arena2Opacity', 0.0, 1.0).name('Arena 2 Opacity').onChange(v => {
                if (window.flux.arenaMesh2 && window.flux.arenaMesh2.material && window.flux.arenaMesh2.material.uniforms.uOpacity) {
                    window.flux.arenaMesh2.material.uniforms.uOpacity.value = v;
                }
            });

params.arena2Blend = 'Additive';
            folder.add(params, 'arena2Blend', Object.keys(blendModes)).name('Arena 2 Blend').onChange(v => {
                if (window.flux.arenaMesh2 && window.flux.arenaMesh2.material) {
                    window.flux.arenaMesh2.material.blending = blendModes[v];
                    window.flux.arenaMesh2.material.needsUpdate = true;
                }
            });
            
            // Apply defaults
            if (window.flux.arenaMesh && window.flux.arenaMesh.material) {
                window.flux.arenaMesh.material.opacity = params.arenaOpacity;
            }
            if (window.flux.arenaMesh2 && window.flux.arenaMesh2.material) {
                window.flux.arenaMesh2.material.opacity = params.arena2Opacity;
            }
        }

_setupOverlays() {
            const folder = this.gui.addFolder('Overlays & FX');
            
            // 1. GIF Overlay
            const gifEl = document.getElementById('screen-overlay-gif');
            if (gifEl) {
                const gifParams = {
                    visible: true,
opacity: 0.62,
                    blend: 'overlay'
                };
                
                const gFolder = folder.addFolder('Screen GIF');
                gFolder.add(gifParams, 'visible').onChange(v => gifEl.style.display = v ? 'block' : 'none');
                gFolder.add(gifParams, 'opacity', 0.0, 1.0).onChange(v => gifEl.style.opacity = v);
                
                const blendModes = [
                    'normal', 'multiply', 'screen', 'overlay', 
                    'darken', 'lighten', 'color-dodge', 'color-burn', 
                    'hard-light', 'soft-light', 'difference', 'exclusion', 
                    'hue', 'saturation', 'color', 'luminosity'
                ];
                gFolder.add(gifParams, 'blend', blendModes).onChange(v => gifEl.style.mixBlendMode = v);
            }

            // 2. Water Overlay
            const wo = this.game.waterOverlay;
            if (wo && wo.mesh) {
                const wFolder = folder.addFolder('Water Shader');
                const wParams = { 
                    visible: true,
                    opacity: wo.material.uniforms.uOpacity ? wo.material.uniforms.uOpacity.value : 0.5,
                    blend: 'Additive'
                };
                
                wFolder.add(wParams, 'visible').onChange(v => wo.mesh.visible = v);
                
                if (wo.material.uniforms.uOpacity) {
                    wFolder.add(wParams, 'opacity', 0.0, 2.0).onChange(v => wo.material.uniforms.uOpacity.value = v);
                }

                const threeBlends = {
                    'Normal': THREE.NormalBlending,
                    'Additive': THREE.AdditiveBlending,
                    'Subtractive': THREE.SubtractiveBlending,
                    'Multiply': THREE.MultiplyBlending,
                    'NoBlending': THREE.NoBlending
                };
                
                wFolder.add(wParams, 'blend', Object.keys(threeBlends)).onChange(v => {
                    wo.material.blending = threeBlends[v];
                    wo.material.needsUpdate = true;
                });
            }

            // 3. Light Shafts
            const ls = this.game.lightShafts;
            if (ls && ls.container) {
                const lParams = { visible: true };
                folder.add(lParams, 'visible').name('Light Shafts').onChange(v => ls.container.visible = v);
            }
        }

_setupGameState() {
            const folder = this.gui.addFolder('Game State');
            const gm = this.game;
            
            const params = {
                forceHomeGoal: () => { 
                    if(gm.state === 'active') gm.goalScored('home'); 
                    else console.warn("Game must be active to trigger goal");
                },
                forceAwayGoal: () => { 
                    if(gm.state === 'active') gm.goalScored('away');
                    else console.warn("Game must be active to trigger goal");
                },
                forceHalftime: () => {
                    if(gm.state === 'active') gm.endHalf();
                },
                resetRound: () => gm.resetRound(),
                exitToMenu: () => {
                    if (window.flux.gameInstance && window.flux.gameInstance.menuManager) {
                        window.flux.gameInstance.menuManager.show();
                        window.flux.gameInstance.state = 'menu';
                        // Stop practice if running
                        if (window.flux.gameInstance.practiceManager) {
                            window.flux.gameInstance.practiceManager.stop();
                        }
                    }
                }
            };

            folder.add(params, 'forceHomeGoal').name('Trigger Home Goal');
            folder.add(params, 'forceAwayGoal').name('Trigger Away Goal');
            folder.add(params, 'forceHalftime').name('Force Halftime');
            folder.add(params, 'resetRound').name('Reset Round');
            folder.add(params, 'exitToMenu').name('Exit to Menu');
        }

        _setupTeams() {
            const folder = this.gui.addFolder('Teams');
            if (!this.game.teams.home || !this.game.teams.away) return;

            const home = this.game.teams.home;
            const away = this.game.teams.away;

            // Home
            const hFolder = folder.addFolder('Home Team');
            hFolder.add(home, 'isHuman').name('Is Human Controlled').listen();
            hFolder.add(home, 'aiEnabled').name('AI Logic Enabled').listen();

            // Away
            const aFolder = folder.addFolder('Away Team');
            aFolder.add(away, 'isHuman').name('Is Human Controlled').listen();
            aFolder.add(away, 'aiEnabled').name('AI Logic Enabled').listen();

        }

_setupPlayerInspector() {
            const folder = this.gui.addFolder('Player Inspector (Home Active)');
            
            // Helper to get current active player safely
            const getActive = () => {
                return (this.game.teams.home && this.game.teams.home.activePlayer) 
                    ? this.game.teams.home.activePlayer 
                    : null;
            };

            // Proxy object to bind GUI to dynamic target
            const proxy = {
                get Role() { 
                    const p = getActive();
                    return p ? p.role : '-'; 
                },
                
                get GodMode() { 
                    const p = getActive();
                    return p ? p.isGodMode : false; 
                },
                set GodMode(v) { 
                    const p = getActive();
                    if(p) p.isGodMode = v; 
                },

                // Runtime Values
                get HP() { 
                    const p = getActive();
                    return p ? p.stats.HP : 0; 
                },
                set HP(v) { 
                    const p = getActive();
                    if(p) p.stats.HP = v; 
                },
                
                get CurrentEN() { 
                    const p = getActive();
                    return p ? p.currentEN : 0; 
                },
                set CurrentEN(v) { 
                    const p = getActive();
                    if(p) p.currentEN = v; 
                },

                // Base Stats
                get MaxHP() { 
                    const p = getActive();
                    return p ? p.stats.maxHP : 0; 
                },
                set MaxHP(v) { 
                    const p = getActive();
                    if(p) p.stats.maxHP = v; 
                },

                get SP() { 
                    const p = getActive();
                    return p ? p.stats.SP : 0; 
                },
                set SP(v) { 
                    const p = getActive();
                    if(p) { 
                        p.stats.SP = v; 
                        p._updateDerivedStats(); 
                    } 
                },

                get EN() { 
                    const p = getActive();
                    return p ? p.stats.EN : 0; 
                }, 
                set EN(v) { 
                    const p = getActive();
                    if(p) {
                        p.stats.EN = v;
                    }
                },

                get AT() { 
                    const p = getActive();
                    return p ? p.stats.AT : 0; 
                },
                set AT(v) { 
                    const p = getActive();
                    if(p) p.stats.AT = v; 
                },

                get PA() { 
                    const p = getActive();
                    return p ? p.stats.PA : 0; 
                },
                set PA(v) { 
                    const p = getActive();
                    if(p) p.stats.PA = v; 
                },

                get BL() { 
                    const p = getActive();
                    return p ? p.stats.BL : 0; 
                },
                set BL(v) { 
                    const p = getActive();
                    if(p) p.stats.BL = v; 
                },

                get SH() { 
                    const p = getActive();
                    return p ? p.stats.SH : 0; 
                },
                set SH(v) { 
                    const p = getActive();
                    if(p) p.stats.SH = v; 
                },

                get CA() { 
                    const p = getActive();
                    return p ? p.stats.CA : 0; 
                },
                set CA(v) { 
                    const p = getActive();
                    if(p) p.stats.CA = v; 
                },

                // Actions
                LevelUp: () => { 
                    const p = getActive();
                    if(p) p.levelUp(); 
                },
                FullHeal: () => { 
                    const p = getActive(); 
                    if(p) { 
                        p.stats.HP = p.stats.maxHP; 
                        p.currentEN = p.getStat('EN'); 
                        p.status.venom = 0; 
                        p.status.nap = 0; 
                        for(let k in p.status.wither) p.status.wither[k] = 0;
                        if(window.flux.gameInstance.floatingText) {
                            window.flux.gameInstance.floatingText.spawn("FULL HEAL", p.mesh.position, "heal");
                        }
                    } 
                },
                DrainEN: () => { 
                    const p = getActive();
                    if(p) {
                        p.currentEN = 0;
                        p.fumble(); // Trigger fumble logic
                    }
                }
            };

            folder.add(proxy, 'Role').listen().disable();
            folder.add(proxy, 'GodMode').name('God Mode (Inf HP/EN)').listen();

            const rtFolder = folder.addFolder('Runtime Status');
            rtFolder.add(proxy, 'HP', 0, 9999).listen();
            rtFolder.add(proxy, 'CurrentEN', 0, 100).name('Current EN').listen();

            const statFolder = folder.addFolder('Base Stats');
            statFolder.add(proxy, 'MaxHP', 100, 9999).listen();
            statFolder.add(proxy, 'EN', 0, 99).name('Max EN').listen();
            statFolder.add(proxy, 'SP', 0, 99).listen();
            statFolder.add(proxy, 'AT', 0, 99).listen();
            statFolder.add(proxy, 'PA', 0, 99).listen();
            statFolder.add(proxy, 'BL', 0, 99).listen();
            statFolder.add(proxy, 'SH', 0, 99).listen();
            statFolder.add(proxy, 'CA', 0, 99).listen();

            const actionFolder = folder.addFolder('Actions');
            actionFolder.add(proxy, 'LevelUp').name('Instant Level Up');
            actionFolder.add(proxy, 'FullHeal').name('Full Heal & Cure');
            actionFolder.add(proxy, 'DrainEN').name('Drain EN (Fumble)');
        }

_setupBallSandbox() {
    const root = this.gui.addFolder('Ball Lab (Throw & Physics)');

    // ------------------------------------------------------------
    // Shared state object (lives on window.flux so it survives reloads)
    // ------------------------------------------------------------
    const lab = window.flux.ballLab = window.flux.ballLab || {};
    lab.game = this.game;

    const C = window.flux.BallConfig;
    const TC = window.flux.ThrowConfig;

    if (!C || !TC) {
        console.warn("Ball Lab: Missing BallConfig or ThrowConfig.");
        return;
    }

    // ------------------------------------------------------------
    // Helpers
    // ------------------------------------------------------------
    const getBall = () => this.game && this.game.entities ? this.game.entities.ball : null;
    const getActive = () => this.game && this.game.teams && this.game.teams.home ? this.game.teams.home.activePlayer : null;

    const ensurePreviewLine = () => {
        if (lab.previewLine) return;
        if (!this.game || !this.game.scene) return;

        const geom = new THREE.BufferGeometry();
        const mat = new THREE.LineBasicMaterial({ transparent: true, opacity: 0.95 });
        const line = new THREE.Line(geom, mat);
        line.frustumCulled = false;
        line.renderOrder = 999;
        this.game.scene.add(line);
        lab.previewLine = line;
    };

    const clearPreviewLine = () => {
        if (lab.previewLine && lab.previewLine.geometry) {
            lab.previewLine.geometry.dispose();
            lab.previewLine.geometry = new THREE.BufferGeometry();
        }
    };

    // A safe "ghost ball" that can use Ball.updateFree without spawning FX
    const makeGhostBall = (pos, vel, spin) => {
        const gb = {
            mesh: { position: pos.clone() },
            velocity: vel.clone(),
            angularVelocity: (spin ? spin.clone() : new THREE.Vector3()),
            accumulatedRotation: new THREE.Quaternion(),
            power: 0,
            decayRate: 0,
            _bubbleTimer: 999,
            _ghost: true,
            deformNode: null
        };
        return gb;
    };

    // Use Ball.updateFree for faithful trajectory prediction
    const simulate = (ghostBall, steps, stepDt) => {
        const pts = [];
        pts.push(ghostBall.mesh.position.clone());
        const proto = window.flux.Ball && window.flux.Ball.prototype;
        if (!proto || typeof proto.updateFree !== 'function') return pts;

        for (let i = 0; i < steps; i++) {
            proto.updateFree.call(ghostBall, stepDt);
            pts.push(ghostBall.mesh.position.clone());
        }
        return pts;
    };

    // ------------------------------------------------------------
    // Preview + record/replay runtime loop
    // ------------------------------------------------------------
lab.preview = lab.preview || {
        enabled: false,
        source: 'Cannon',
        steps: 120,
        stepDt: 1/60,
        refreshHz: 10,
        showOnHeldOnly: false
    };

    lab.cannon = lab.cannon || {
        yaw: 0,
        pitch: 0,
        power: 20,
        type: 'SH',
        spinX: 0,
        spinY: 0,
        spinZ: 0,
        fireBurst: 1,
        spreadDeg: 0
    };

    lab.recording = lab.recording || {
        isRecording: false,
        frames: [],
        maxSeconds: 12
    };

    lab.replay = lab.replay || {
        isReplaying: false,
        frames: [],
        idx: 0,
        loop: true,
        speed: 1.0
    };

    lab.isReplaying = false;
    lab.targetBall = null;

    lab.applyReplayFrame = (ball, dt) => {
        const rep = lab.replay;
        if (!rep || !rep.isReplaying || !rep.frames || rep.frames.length === 0) {
            lab.isReplaying = false;
            return;
        }

        // Advance time by stepping indices (frame-based)
        const step = Math.max(1, Math.floor(rep.speed));
        rep.idx += step;

        if (rep.idx >= rep.frames.length) {
            if (rep.loop) rep.idx = 0;
            else { rep.isReplaying = false; lab.isReplaying = false; return; }
        }

        const f = rep.frames[rep.idx];
        if (!f) return;

        ball.drop(); // ensure no holder logic fights us
        ball.state = 'free';
        ball.mesh.position.set(f.px, f.py, f.pz);
        ball.velocity.set(f.vx, f.vy, f.vz);
        ball.angularVelocity.set(f.sx, f.sy, f.sz);
    };

    lab._previewTimer = lab._previewTimer || 0;

    lab.update = (dt) => {
        // --- recording ---
        const b = getBall();
        if (b && lab.recording && lab.recording.isRecording) {
            const r = lab.recording;
            const maxFrames = Math.floor((r.maxSeconds || 12) / (dt || (1/60)));
            if (r.frames.length > maxFrames) r.frames.shift();
            r.frames.push({
                px: b.mesh.position.x, py: b.mesh.position.y, pz: b.mesh.position.z,
                vx: b.velocity.x, vy: b.velocity.y, vz: b.velocity.z,
                sx: b.angularVelocity.x, sy: b.angularVelocity.y, sz: b.angularVelocity.z
            });
        }

        // --- preview refresh ---
        lab._previewTimer += dt;
        const refreshInterval = 1.0 / Math.max(1, (lab.preview.refreshHz || 10));
        if (lab.preview.enabled && lab._previewTimer >= refreshInterval) {
            lab._previewTimer = 0;
            lab.refreshPreview();
        }
    };

    lab.refreshPreview = () => {
        if (!lab.preview.enabled) { clearPreviewLine(); return; }
        ensurePreviewLine();

        const b = getBall();
        const p = getActive();
        if (!b || !b.mesh) return;

        if (lab.preview.showOnHeldOnly && b.state !== 'held') {
            clearPreviewLine();
            return;
        }

        // Decide preview source
        let startPos = b.mesh.position;
        let startVel = b.velocity;
        let startSpin = b.angularVelocity;

        if (lab.preview.source === 'Cannon') {
            // Cannon always launches from ball position (or player if held)
            const yawRad = (lab.cannon.yaw || 0) * Math.PI / 180;
            const pitchRad = (lab.cannon.pitch || 0) * Math.PI / 180;

            const dir = new THREE.Vector3(
                Math.sin(yawRad) * Math.cos(pitchRad),
                Math.sin(pitchRad),
                -Math.cos(yawRad) * Math.cos(pitchRad)
            ).normalize();

            const cap = (window.flux.BallConfig.LAUNCH_SPEED_CAP !== undefined ? window.flux.BallConfig.LAUNCH_SPEED_CAP : 85.0);
            const scale = (window.flux.BallConfig.LAUNCH_SPEED_SCALE !== undefined ? window.flux.BallConfig.LAUNCH_SPEED_SCALE : 1.0);
            const speed = Math.min((lab.cannon.power || 20) * scale, cap);

            startPos = (b.state === 'held' && p && p.mesh) ? p.mesh.position.clone().add(new THREE.Vector3(0, 1.2, 0)) : b.mesh.position.clone();
            startVel = dir.multiplyScalar(speed);
            startSpin = new THREE.Vector3(lab.cannon.spinX || 0, lab.cannon.spinY || 0, lab.cannon.spinZ || 0);
        }

        const ghost = makeGhostBall(startPos.clone(), startVel.clone(), startSpin);
        const pts = simulate(ghost, Math.floor(lab.preview.steps || 120), (lab.preview.stepDt || (1/60)));

        if (lab.previewLine) {
            lab.previewLine.geometry.dispose();
            lab.previewLine.geometry = new THREE.BufferGeometry().setFromPoints(pts);
        }
    };

    // ------------------------------------------------------------
    // Folder: Ball Physics (BallConfig)
    // ------------------------------------------------------------
    const phys = root.addFolder('Ball Physics (BallConfig)');

    const integ = phys.addFolder('Integration');
    integ.add(C, 'SUBSTEPS', 1, 12, 1).name('Substeps');
    integ.add(C, 'STOP_SPEED', 0.0, 0.2).name('Stop Speed');

    const drag = phys.addFolder('Water Drag');
    drag.add(C, 'WATER_DRAG_LINEAR', 0.0, 2.0).name('Linear Drag');
    drag.add(C, 'WATER_DRAG_QUAD', 0.0, 0.05).name('Quadratic Drag');

    const spin = phys.addFolder('Spin');
    spin.add(C, 'SPIN_DRAG', 0.0, 3.0).name('Spin Decay');

    const magnus = phys.addFolder('Magnus');
    magnus.add(C, 'MAGNUS_ENABLED').name('Enabled');
    magnus.add(C, 'MAGNUS_COEFF', 0.0, 0.5).name('Coeff');
    magnus.add(C, 'MAGNUS_CAP', 0.0, 200.0).name('Cap');

    const depth = phys.addFolder('Depth Constraint');
    depth.add(C, 'DEPTH_TARGET_Y', -5.0, 5.0).name('Target Y');
    depth.add(C, 'DEPTH_SPRING', 0.0, 10.0).name('Spring');
    depth.add(C, 'DEPTH_DAMP', 0.0, 6.0).name('Damp');

    const arena = phys.addFolder('Arena Boundary');
    arena.add(C, 'BOUNDARY_RADIUS', 10.0, 120.0).name('Radius');
    arena.add(C, 'BOUNDARY_HEIGHT', 2.0, 40.0).name('Height');
    arena.add(C, 'WALL_SOFT_BUFFER', 0.0, 20.0).name('Soft Buffer');
    arena.add(C, 'WALL_SOFT_FORCE', 0.0, 200.0).name('Soft Force');
    arena.add(C, 'WALL_ELASTICITY', 0.0, 1.0).name('Wall Bounce');
    arena.add(C, 'WALL_FRICTION', 0.0, 1.0).name('Wall Friction');
    arena.add(C, 'FLOOR_ELASTICITY', 0.0, 1.0).name('Ceil/Floor Bounce');

    const pocket = arena.addFolder('Goal Pocket');
    pocket.add(C, 'GOAL_POCKET_ENABLED').name('Enabled');
    pocket.add(C, 'GOAL_POCKET_X', 0.0, 40.0).name('Pocket Half-X');
    pocket.add(C, 'GOAL_POCKET_Z', 0.0, 50.0).name('Pocket Start |Z|');
    pocket.add(C, 'GOAL_POCKET_RADIUS', 10.0, 120.0).name('Pocket Radius');

    const launch = phys.addFolder('Launch Mapping');
    launch.add(C, 'LAUNCH_SPEED_SCALE', 0.1, 5.0).name('Speed Scale');
    launch.add(C, 'LAUNCH_SPEED_CAP', 10.0, 200.0).name('Speed Cap');

    // ------------------------------------------------------------
    // Folder: Throw mapping (Player.releaseCharge -> Ball.shoot)
    // ------------------------------------------------------------
    const throwMap = root.addFolder('Throw Mapping (ThrowConfig)');
    throwMap.add(TC, 'SWIPE_MIN_PX', 0, 120, 1).name('Swipe Min PX');
    throwMap.add(TC, 'AIM_DX_SCALE', 0.1, 5.0).name('Aim X Scale');
    throwMap.add(TC, 'AIM_DY_SCALE', 0.1, 5.0).name('Aim Y Scale');
    throwMap.add(TC, 'POWER_BASE', 0.1, 3.0).name('Power Base');
    throwMap.add(TC, 'POWER_RANGE', 0.0, 3.0).name('Power Range');
    throwMap.add(TC, 'POWER_MAX_BONUS_RATIO', 0.0, 1.0).name('Max Bonus Ratio');
    throwMap.add(TC, 'POWER_MAX_MULTIPLIER', 1.0, 6.0).name('Max Multiplier');

    const curveMap = throwMap.addFolder('Curve');
    curveMap.add(TC, 'CURVE_ENABLED').name('Enabled');
    curveMap.add(TC, 'CURVE_INTENSITY_THRESHOLD', 0.0, 1.0).name('Input Threshold');
    curveMap.add(TC, 'CURVE_SPIN_SCALE', 0.0, 4000.0).name('Spin Scale');
    curveMap.add(TC, 'CURVE_SPEED_MULT', 0.0, 5.0).name('Swipe Speed Mult');
    curveMap.add(TC, 'CURVE_SPIN_CAP', 0.0, 6000.0).name('Spin Cap');
    curveMap.add(TC, 'CURVE_PERFECT_SPIN', 0.0, 2000.0).name('Perfect Threshold');

    // ------------------------------------------------------------
    // Folder: Teleport / State tools
    // ------------------------------------------------------------
    const tp = root.addFolder('Teleport / Reset');
    const tpParams = {
        ToCenter: () => { const b = getBall(); if (b) b.reset(); },
        ToActivePlayer: () => { const b = getBall(); const p = getActive(); if (b && p) b.grab(p); },
        ToHomeGoal: () => { const b = getBall(); if (b) { b.drop(); b.mesh.position.set(0, 0, 25); b.velocity.set(0,0,0); b.angularVelocity.set(0,0,0); } },
        ToAwayGoal: () => { const b = getBall(); if (b) { b.drop(); b.mesh.position.set(0, 0, -25); b.velocity.set(0,0,0); b.angularVelocity.set(0,0,0); } },
        ToSky: () => { const b = getBall(); if (b) { b.drop(); b.mesh.position.set(0, 10, 0); b.velocity.set(0,0,0); b.angularVelocity.set(0,0,0); } },
        ClearPreview: () => clearPreviewLine()
    };
    tp.add(tpParams, 'ToCenter');
    tp.add(tpParams, 'ToActivePlayer');
    tp.add(tpParams, 'ToHomeGoal');
    tp.add(tpParams, 'ToAwayGoal');
    tp.add(tpParams, 'ToSky');
    tp.add(tpParams, 'ClearPreview');

    // ------------------------------------------------------------
    // Folder: Shot Cannon (force fire with params)
    // ------------------------------------------------------------
    const cannon = root.addFolder('Shot Cannon');
    cannon.add(lab.cannon, 'yaw', -180, 180, 1).name('Yaw (deg)');
    cannon.add(lab.cannon, 'pitch', -89, 89, 1).name('Pitch (deg)');
    cannon.add(lab.cannon, 'power', 0, 120, 0.1).name('Power');
    cannon.add(lab.cannon, 'type', ['PA','SH']).name('Type');
    cannon.add(lab.cannon, 'spinX', -3000, 3000, 1).name('Spin X');
    cannon.add(lab.cannon, 'spinY', -3000, 3000, 1).name('Spin Y');
    cannon.add(lab.cannon, 'spinZ', -3000, 3000, 1).name('Spin Z');
    cannon.add(lab.cannon, 'fireBurst', 1, 10, 1).name('Burst Count');
    cannon.add(lab.cannon, 'spreadDeg', 0, 30, 0.5).name('Spread (deg)');

    const fireParams = {
        Fire: () => {
            const b = getBall();
            const p = getActive();
            if (!b) return;

            const yawRad = (lab.cannon.yaw || 0) * Math.PI / 180;
            const pitchRad = (lab.cannon.pitch || 0) * Math.PI / 180;

            const baseDir = new THREE.Vector3(
                Math.sin(yawRad) * Math.cos(pitchRad),
                Math.sin(pitchRad),
                -Math.cos(yawRad) * Math.cos(pitchRad)
            ).normalize();

            const start = (b.state === 'held' && p && p.mesh) ? p.mesh.position.clone().add(new THREE.Vector3(0, 1.2, 0)) : b.mesh.position.clone();

            for (let i = 0; i < (lab.cannon.fireBurst || 1); i++) {
                const dir = baseDir.clone();
                if (lab.cannon.spreadDeg > 0) {
                    const spread = (lab.cannon.spreadDeg * Math.PI / 180);
                    dir.x += (Math.random()-0.5) * spread;
                    dir.y += (Math.random()-0.5) * spread;
                    dir.z += (Math.random()-0.5) * spread;
                    dir.normalize();
                }

                b.drop();
                b.mesh.position.copy(start);
                b.velocity.set(0,0,0);
                b.angularVelocity.set(0,0,0);

                const spin = new THREE.Vector3(lab.cannon.spinX || 0, lab.cannon.spinY || 0, lab.cannon.spinZ || 0);
                b.shoot(dir, lab.cannon.power || 20, lab.cannon.type || 'SH', null, spin);
            }
        }
    };
    cannon.add(fireParams, 'Fire');

    // ------------------------------------------------------------
    // Folder: Trajectory Preview
    // ------------------------------------------------------------
    const preview = root.addFolder('Trajectory Preview');
    preview.add(lab.preview, 'enabled').name('Enabled').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'source', ['Cannon', 'Live Ball']).name('Source').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'steps', 10, 600, 1).name('Steps').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'stepDt', 1/240, 1/15, 1/240).name('Step dt').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'refreshHz', 1, 60, 1).name('Refresh Hz');
    preview.add(lab.preview, 'showOnHeldOnly').name('Only when Held').onChange(() => lab.refreshPreview());

    const previewBtns = {
        Refresh: () => lab.refreshPreview(),
        Hide: () => { lab.preview.enabled = false; clearPreviewLine(); }
    };
    preview.add(previewBtns, 'Refresh');
    preview.add(previewBtns, 'Hide');

    // ------------------------------------------------------------
    // Folder: Record / Replay
    // ------------------------------------------------------------
    const rr = root.addFolder('Record / Replay');
    const rrParams = {
        Record: () => {
            lab.recording.isRecording = true;
            lab.recording.frames = [];
        },
        Stop: () => {
            lab.recording.isRecording = false;
        },
        UseRecordingForReplay: () => {
            lab.replay.frames = (lab.recording.frames || []).slice();
            lab.replay.idx = 0;
        },
        Play: () => {
            const b = getBall();
            if (!b) return;
            lab.replay.isReplaying = true;
            lab.isReplaying = true;
            lab.targetBall = b;
            lab.replay.idx = 0;
        },
        Pause: () => {
            lab.replay.isReplaying = false;
            lab.isReplaying = false;
        },
        Clear: () => {
            lab.recording.frames = [];
            lab.replay.frames = [];
            lab.replay.idx = 0;
            lab.replay.isReplaying = false;
            lab.isReplaying = false;
        }
    };
    rr.add(rrParams, 'Record');
    rr.add(rrParams, 'Stop');
    rr.add(rrParams, 'UseRecordingForReplay').name('Copy Rec -> Replay');
    rr.add(lab.replay, 'loop').name('Loop');
    rr.add(lab.replay, 'speed', 0.25, 6.0, 0.25).name('Replay Speed');
    rr.add(rrParams, 'Play');
    rr.add(rrParams, 'Pause');
    rr.add(rrParams, 'Clear');

    // ------------------------------------------------------------
    // Folder: Presets
    // ------------------------------------------------------------
    const presets = root.addFolder('Presets');
    const P = {
        Vanilla: () => {
            Object.assign(C, {
                SUBSTEPS: 2,
                STOP_SPEED: 0.02,
                WATER_DRAG_LINEAR: 0.15,
                WATER_DRAG_QUAD: 0.002,
                SPIN_DRAG: 0.40,
                MAGNUS_ENABLED: true,
                MAGNUS_COEFF: 0.08,
                MAGNUS_CAP: 60.0,
                DEPTH_TARGET_Y: 0.0,
                DEPTH_SPRING: 1.0,
                DEPTH_DAMP: 1.5,
                BOUNDARY_RADIUS: 33.0,
                BOUNDARY_HEIGHT: 15.0,
                WALL_SOFT_BUFFER: 3.0,
                WALL_SOFT_FORCE: 20.0,
                WALL_ELASTICITY: 0.30,
                WALL_FRICTION: 0.95,
                FLOOR_ELASTICITY: 0.40,
                GOAL_POCKET_ENABLED: true,
                GOAL_POCKET_X: 12.0,
                GOAL_POCKET_Z: 25.0,
                GOAL_POCKET_RADIUS: 45.0,
                LAUNCH_SPEED_SCALE: 1.0,
                LAUNCH_SPEED_CAP: 85.0
            });
            lab.refreshPreview();
        },
        ArcadeCurve: () => {
            Object.assign(C, {
                MAGNUS_ENABLED: true,
                MAGNUS_COEFF: 0.16,
                MAGNUS_CAP: 90.0,
                SPIN_DRAG: 0.25,
                WATER_DRAG_LINEAR: 0.12,
                WATER_DRAG_QUAD: 0.001,
                WALL_SOFT_FORCE: 35.0,
                LAUNCH_SPEED_CAP: 110.0
            });
            Object.assign(TC, {
                CURVE_ENABLED: true,
                CURVE_SPIN_SCALE: 1500.0,
                CURVE_SPIN_CAP: 3000.0,
                CURVE_PERFECT_SPIN: 700.0
            });
            lab.refreshPreview();
        },
        SnappyRealistic: () => {
            Object.assign(C, {
                WATER_DRAG_LINEAR: 0.25,
                WATER_DRAG_QUAD: 0.006,
                MAGNUS_COEFF: 0.05,
                MAGNUS_CAP: 40.0,
                SPIN_DRAG: 0.75,
                STOP_SPEED: 0.05,
                LAUNCH_SPEED_CAP: 70.0
            });
            lab.refreshPreview();
        }
    };
    presets.add(P, 'Vanilla');
    presets.add(P, 'ArcadeCurve');
    presets.add(P, 'SnappyRealistic');

    // ------------------------------------------------------------
    // Folder: Snapshot / Export
    // ------------------------------------------------------------
    const snapshot = root.addFolder('Snapshot / Export');

    const _round = (n, places = 4) => {
        if (!Number.isFinite(n)) return null;
        const p = Math.pow(10, places);
        return Math.round(n * p) / p;
    };

    const _v3 = (v, places = 4) => {
        if (!v) return null;
        return [_round(v.x, places), _round(v.y, places), _round(v.z, places)];
    };

    const _cloneJson = (obj) => {
        if (!obj) return null;
        try { return JSON.parse(JSON.stringify(obj)); } catch (e) { return null; }
    };

    const _playerSnap = (p) => {
        if (!p) return null;
        const anim = (p.activeAction && p.activeAction._clip) ? p.activeAction._clip.name : (p.state || null);
        return {
            name: p.characterName || p.name || null,
            role: p.role || null,
            state: p.state || null,
            hasBall: !!p.hasBall,
            isThrowing: !!p.isThrowing,
            isCharging: !!p.isCharging,
            isDashing: !!p.isDashing,
            dashCooldown: _round(p.dashCooldown, 4),
            pos: _v3(p.mesh && p.mesh.position),
            vel: _v3(p.velocity),
            input: _v3(p.inputVector),
            stats: p.stats ? _cloneJson(p.stats) : null,
            anim
        };
    };

    const _teamSnap = (t) => {
        if (!t) return null;
        const active = t.activePlayer ? _playerSnap(t.activePlayer) : null;
        return {
            id: t.id || null,
            side: t.side,
            isHuman: !!t.isHuman,
            aiEnabled: !!t.aiEnabled,
            currentFormation: t.currentFormation || null,
            activePlayer: active,
            players: Array.isArray(t.players) ? t.players.map(_playerSnap) : []
        };
    };

    const buildSnapshot = () => {
        const game = this.game || window.flux.gameInstance || null;
        const ball = game && game.entities ? game.entities.ball : null;
        const camMgr = game ? game.cameraManager : null;
        const cam = (camMgr && camMgr.camera) ? camMgr.camera : (game ? game.camera : null);

        const ballSnap = ball ? {
            state: ball.state || null,
            isInvisible: !!ball.isInvisible,
            holder: ball.holder ? (ball.holder.characterName || ball.holder.name || null) : null,
            lastHolder: ball.lastHolder ? (ball.lastHolder.characterName || ball.lastHolder.name || null) : null,
            pos: _v3(ball.mesh && ball.mesh.position),
            vel: _v3(ball.velocity),
            angVel: _v3(ball.angularVelocity),
            power: _round(ball.power, 4),
            shotType: ball.shotType || null
        } : null;

        const cameraSnap = cam ? {
            pos: _v3(cam.position),
            rot: cam.rotation ? [_round(cam.rotation.x, 4), _round(cam.rotation.y, 4), _round(cam.rotation.z, 4)] : null,
            fov: _round(cam.fov, 4),
            near: _round(cam.near, 6),
            far: _round(cam.far, 4)
        } : null;

        const camMgrSnap = camMgr ? {
            mode: camMgr.mode || null,
            targetName: (camMgr.target && (camMgr.target.characterName || camMgr.target.name)) || null,
            settings: camMgr.settings ? _cloneJson(camMgr.settings) : null
        } : null;

        const debugIO = window.flux && window.flux._debugIO ? window.flux._debugIO : null;
        const inputSnap = debugIO ? {
            settings: debugIO.settings ? _cloneJson(debugIO.settings) : null,
            perf: debugIO.perf ? _cloneJson(debugIO.perf) : null,
            move: (debugIO.input && debugIO.input.move) ? {
                touchId: debugIO.input.move.touchId ?? null,
                dragging: !!debugIO.input.move.dragging,
                vector: debugIO.input.move.vector ? _cloneJson(debugIO.input.move.vector) : null
            } : null,
            aim: (debugIO.input && debugIO.input.aim) ? {
                touchId: debugIO.input.aim.touchId ?? null,
                dragging: !!debugIO.input.aim.dragging,
                vector: debugIO.input.aim.vector ? _cloneJson(debugIO.input.aim.vector) : null
            } : null,
            swipe: (debugIO.input && debugIO.input.swipe) ? {
                touchId: debugIO.input.swipe.touchId ?? null,
                start: debugIO.input.swipe.start ? _cloneJson(debugIO.input.swipe.start) : null,
                points: Array.isArray(debugIO.input.swipe.points) ? debugIO.input.swipe.points.slice(-32).map(_cloneJson) : []
            } : null
        } : null;

        return {
            meta: {
                timestampISO: new Date().toISOString(),
                href: (typeof location !== 'undefined' && location.href) ? location.href : null,
                userAgent: (typeof navigator !== 'undefined' && navigator.userAgent) ? navigator.userAgent : null
            },
            game: game ? {
                score: game.score ? _cloneJson(game.score) : null,
                time: _round(game.time, 4),
                half: game.half ?? null,
                halfDuration: _round(game.halfDuration, 4),
                isOvertime: !!game.isOvertime,
                isDemoMode: !!game.isDemoMode
            } : null,
            config: {
                BallConfig: (window.flux && window.flux.BallConfig) ? _cloneJson(window.flux.BallConfig) : null,
                ThrowConfig: (window.flux && window.flux.ThrowConfig) ? _cloneJson(window.flux.ThrowConfig) : null
            },
            camera: cameraSnap,
            cameraManager: camMgrSnap,
            ball: ballSnap,
            teams: game ? {
                home: _teamSnap(game.teams && game.teams.home),
                away: _teamSnap(game.teams && game.teams.away)
            } : null,
            input: inputSnap
        };
    };

    const _copyText = async (text) => {
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
                return true;
            }
        } catch (e) {}
        // Fallback
        try {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            ta.style.top = '-9999px';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            return ok;
        } catch (e) {}
        return false;
    };

    const _downloadText = (filename, text) => {
        try {
            const blob = new Blob([text], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        } catch (e) {
            console.warn('Snapshot download failed:', e);
        }
    };

    const snapshotActions = {
        CopySnapshot: async () => {
            const snap = buildSnapshot();
            const text = JSON.stringify(snap, null, 2);
            const ok = await _copyText(text);
            console.log('[Snapshot]', snap);
            if (!ok) console.warn('Snapshot: copy failed (see console).');
        },
        DownloadSnapshot: () => {
            const snap = buildSnapshot();
            const text = JSON.stringify(snap, null, 2);
            _downloadText('snapshot.json', text);
            console.log('[Snapshot]', snap);
        }
    };

    snapshot.add(snapshotActions, 'CopySnapshot').name('Copy JSON Snapshot');
    snapshot.add(snapshotActions, 'DownloadSnapshot').name('Download snapshot.json');

}
    }

window.flux.DevTools = DevTools;

DevTools.prototype._setupVisualDebug = function() {
        const folder = this.gui.addFolder('Visual Debugging');
        const dv = this.game.debugVisualizer;
        if (!dv) return;

        const params = {
            enabled: dv.enabled,
            hitboxes: dv.showHitboxes,
            vectors: dv.showVectors,
            ai: dv.showAI,
            goalVolume: dv.showGoalVolume
        };

        folder.add(params, 'enabled').name('Enable Visualizer').onChange(v => dv.enabled = v);
        folder.add(params, 'hitboxes').name('Show Hitboxes').onChange(v => dv.showHitboxes = v);
        folder.add(params, 'vectors').name('Show Vectors').onChange(v => dv.showVectors = v);
        folder.add(params, 'ai').name('Show AI Perception').onChange(v => dv.showAI = v);
        folder.add(params, 'goalVolume').name('Show Goal Volume').onChange(v => dv.showGoalVolume = v);
    };

    DevTools.prototype._setupFXLab = function() {
        const folder = this.gui.addFolder('FX Lab & UI Test');
        
        const getTargetPos = () => {
            const p = this.game.teams.home.activePlayer;
            return p && p.mesh ? p.mesh.position : new THREE.Vector3(0, 2, 0);
        };

        const fxParams = {
            SpawnVenom: () => this.game.particleManager.spawn('venom', getTargetPos()),
            SpawnNap: () => this.game.particleManager.spawn('nap', getTargetPos()),
            SpawnWither: () => this.game.particleManager.spawn('wither', getTargetPos()),
            SpawnLearned: () => this.game.particleManager.spawn('learned', getTargetPos()),
            SpawnClash: () => this.game.spawnClash(getTargetPos()),
        };

        const fxSub = folder.addFolder('Particles');
        fxSub.add(fxParams, 'SpawnVenom');
        fxSub.add(fxParams, 'SpawnNap');
        fxSub.add(fxParams, 'SpawnWither');
        fxSub.add(fxParams, 'SpawnLearned');
        fxSub.add(fxParams, 'SpawnClash');

        const txtParams = {
            Text: "TEST",
            Type: "damage",
            Spawn: () => {
                if(this.game.floatingText) 
                    this.game.floatingText.spawn(txtParams.Text, getTargetPos(), txtParams.Type);
            }
        };
        
        const txtSub = folder.addFolder('Floating Text');
        txtSub.add(txtParams, 'Text');
        txtSub.add(txtParams, 'Type', ['damage', 'heal', 'status', 'tech', 'comic-impact', 'comic-action', 'save', 'block', 'default']);
        txtSub.add(txtParams, 'Spawn').name('Spawn Text');

        const camParams = {
            ShakeSmall: () => this.game.cameraManager.addShake(0.5),
            ShakeBig: () => this.game.cameraManager.addShake(2.0),
            ImpactLight: () => this.game.triggerImpact(0.1, 'default'),
            ImpactHeavy: () => this.game.triggerImpact(0.2, 'heavy'),
            ImpactShatter: () => this.game.triggerImpact(0.4, 'shatter'),
        };

        const camSub = folder.addFolder('Camera & Impact');
        camSub.add(camParams, 'ShakeSmall');
        camSub.add(camParams, 'ShakeBig');
        camSub.add(camParams, 'ImpactLight');
        camSub.add(camParams, 'ImpactHeavy');
        camSub.add(camParams, 'ImpactShatter');
    };


DevTools.prototype._setupVisuals = function() {
        const folder = this.gui.addFolder('Asset Forge');
        
        const forgeState = {
            active: false,
            assetName: 'Tidus',
            animName: 'idle',
            posX: 0, posY: 0, posZ: 0,
            rotX: 0, rotY: 0, rotZ: 0,
            scale: 1.0,
            camDist: 5, camHeight: 1.5, camRot: 0
        };

        const assets = {
            'Tidus': 'https://cdn.tinyglb.com/models/da788bef258c4f0b8d9ef1acc19c5567.glb',
            'Wakka': 'https://cdn.tinyglb.com/models/59114c98951647c9b8da74b0bd3636cb.glb',
            'Letty': 'https://cdn.tinyglb.com/models/43ace34c6fd94215967e842bf909da5e.glb',
            'Datto': 'https://cdn.tinyglb.com/models/e6d67ecb2e4c4715bd73a40795e1d3d5.glb',
            'Jassu': 'https://cdn.tinyglb.com/models/8216459567354e63958d4108d828de98.glb',
            'Botta': 'https://cdn.tinyglb.com/models/ad155efedc0d48fdad09da3e1cae9c97.glb',
            'Ball': 'https://cdn.tinyglb.com/models/521ae8788e584e378a79d9732a075356.glb',
            'Goal': 'https://cdn.tinyglb.com/models/a516bd90fa7c4dedb5dcbfdf803f13d5.glb'
        };

        let currentAsset = null;

        const updateTransform = () => {
            if (currentAsset) {
                currentAsset.position.set(forgeState.posX, forgeState.posY, forgeState.posZ);
                currentAsset.rotation.set(forgeState.rotX, forgeState.rotY, forgeState.rotZ);
                currentAsset.scale.setScalar(forgeState.scale);
            }
        };

        const updateCamera = () => {
            if (!forgeState.active) return;
            // Orbit around (1000, Y, 1000)
            const cx = 1000 + Math.sin(forgeState.camRot) * forgeState.camDist;
            const cz = 1000 + Math.cos(forgeState.camRot) * forgeState.camDist;
            this.game.camera.position.set(cx, forgeState.camHeight, cz);
            this.game.camera.lookAt(1000, forgeState.posY + 1, 1000);
        };

        const playAnimation = () => {
            if (!this.vizMixer || !this.vizClips) return;
            this.vizMixer.stopAllAction();
            if (forgeState.animName === 'none') return;
            
            let clip = this.vizClips.find(c => c.name === forgeState.animName);
            if (!clip) clip = this.vizClips.find(c => c.name.toLowerCase().includes(forgeState.animName.toLowerCase()));
            if (clip) this.vizMixer.clipAction(clip).play();
        };

        const spawnAsset = () => {
            if (!this.vizGroup) return;
            
            // Clear previous
            while(this.vizGroup.children.length > 0) {
                const child = this.vizGroup.children[0];
                this.vizGroup.remove(child);
            }
            
            this.vizMixer = null;
            currentAsset = null;

            const url = assets[forgeState.assetName];
            if (!url) return;

            console.log("Forge: Spawning", forgeState.assetName);

            window.flux.AssetLoader.loadModel(url, (gltf) => {
                // Check if we are still in forge mode before adding
                if (!forgeState.active) return;

                const model = gltf.scene;
                this.vizGroup.add(model);
                currentAsset = model;
                
                // Reset model transform relative to group
                model.position.set(0,0,0);
                model.rotation.set(0,0,0);
                
                updateTransform();

                if (gltf.animations && gltf.animations.length > 0) {
                    this.vizMixer = new THREE.AnimationMixer(model);
                    this.vizClips = gltf.animations;
                    playAnimation();
                }
            });
        };

        const toggleForge = (isActive) => {
            forgeState.active = isActive;
            this.game.isForgeMode = isActive; // Critical: Tell main.js to stop game loop
            
            // Toggle Game Visibility (Hide everything in the main arena)
            const gameLayer = [this.game.teams.home, this.game.teams.away, this.game.entities.ball];
            gameLayer.forEach(t => {
                if(t && t.players) t.players.forEach(p => { if(p.mesh) p.mesh.visible = !isActive; });
                else if(t && t.mesh) t.mesh.visible = !isActive;
            });
            if(window.flux.arenaMesh) window.flux.arenaMesh.visible = !isActive;
            if(window.flux.arenaMesh2) window.flux.arenaMesh2.visible = !isActive;
            if(this.game.stadium && this.game.stadium.container) this.game.stadium.container.visible = !isActive;
            if(this.game.waterOverlay && this.game.waterOverlay.mesh) this.game.waterOverlay.mesh.visible = !isActive;
            
            // Hide UI
            const ui = document.getElementById('ui-layer');
            if(ui) ui.style.display = isActive ? 'none' : 'flex';

            if (isActive) {
                // Initialize Forge Scene if needed
                if (!this.vizGroupParent) {
                    this.vizGroupParent = new THREE.Group();
                    this.game.scene.add(this.vizGroupParent);
                    
                    this.vizGroup = new THREE.Group();
                    this.vizGroup.position.set(1000, 0, 1000); // Far away from arena
                    this.vizGroupParent.add(this.vizGroup);

                    const grid = new THREE.GridHelper(20, 20, 0x00ffff, 0x444444);
                    grid.position.set(1000, 0, 1000);
                    this.vizGroupParent.add(grid);

                    this.vizLight = new THREE.DirectionalLight(0xffffff, 1.0);
                    this.vizLight.position.set(1005, 10, 1005);
                    this.game.scene.add(this.vizLight);
                    
                    this.vizAmbient = new THREE.AmbientLight(0x404040);
                    this.game.scene.add(this.vizAmbient);
                }
                
                this.vizGroupParent.visible = true;
                this.vizLight.visible = true;
                this.vizAmbient.visible = true;
                
                spawnAsset();
                updateCamera();
                
            } else {
                // Restore Game
                if (this.vizGroupParent) this.vizGroupParent.visible = false;
                if (this.vizLight) this.vizLight.visible = false;
                if (this.vizAmbient) this.vizAmbient.visible = false;
                
                // Snap camera back to game target
                if (this.game.cameraManager) this.game.cameraManager.snapToTarget();
            }
        };

        folder.add(forgeState, 'active').name('Enable Forge').onChange(toggleForge);
        folder.add(forgeState, 'assetName', Object.keys(assets)).name('Select Asset').onChange(spawnAsset);
        
        const tf = folder.addFolder('Transform');
        tf.add(forgeState, 'posX', -5, 5).onChange(updateTransform);
        tf.add(forgeState, 'posY', -5, 5).onChange(updateTransform);
        tf.add(forgeState, 'posZ', -5, 5).onChange(updateTransform);
        tf.add(forgeState, 'rotX', 0, 6.28).onChange(updateTransform);
        tf.add(forgeState, 'rotY', 0, 6.28).onChange(updateTransform);
        tf.add(forgeState, 'rotZ', 0, 6.28).onChange(updateTransform);
        tf.add(forgeState, 'scale', 0.1, 3.0).onChange(updateTransform);

        folder.add(forgeState, 'animName', ['none', 'idle', 'swim', 'throw', 'catch', 'react']).name('Animation').onChange(playAnimation);

        const cf = folder.addFolder('Camera');
        cf.add(forgeState, 'camDist', 2, 15).onChange(updateCamera);
        cf.add(forgeState, 'camHeight', 0, 10).onChange(updateCamera);
        cf.add(forgeState, 'camRot', 0, 6.28).onChange(updateCamera);

        // Hook Game Loop
        const originalUpdate = this.game.update.bind(this.game);
        this.game.update = (dt) => {
            if (forgeState.active) {
                // Forge Mode: Only update forge components and render
                if (this.vizMixer) this.vizMixer.update(dt);
                
                // Force Camera Update here since main.js loop is skipped
                updateCamera();

                if (this.game.renderer && this.game.scene && this.game.camera) {
                    this.game.renderer.render(this.game.scene, this.game.camera);
                }
            } else {
                // Normal Mode: Run standard game update
                originalUpdate(dt);
            }
        };
    };
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class DebugVisualizer {
constructor(scene) {
            this.scene = scene;
            this.enabled = false;
            this.showHitboxes = false;
            this.showVectors = false;
            this.showAI = false;
            this.showGoalVolume = false;

            this.visuals = new Map();
            
            // Materials
            this.matTackle = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true, transparent: true, opacity: 0.2 });
            this.matCatch = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true, transparent: true, opacity: 0.2 });
            this.matVel = new THREE.LineBasicMaterial({ color: 0xffff00 }); // Yellow Velocity
            this.matInput = new THREE.LineBasicMaterial({ color: 0x00ffff }); // Cyan Input
            this.matAI = new THREE.LineBasicMaterial({ color: 0xff00ff }); // Magenta AI Perception
            
            // Geometries
            this.geoCylinder = new THREE.CylinderGeometry(1, 1, 0.1, 16);
            this.geoCylinder.translate(0, 0.05, 0);

            // Goal Volume Visualization (Red Transparent Box)
            const goalGeo = new THREE.BoxGeometry(22, 18, 10);
            const goalMat = new THREE.MeshBasicMaterial({ 
                color: 0xff0000, 
                transparent: true, 
                opacity: 0.25, 
                side: THREE.DoubleSide, 
                depthWrite: false 
            });

            this.goalVol1 = new THREE.Mesh(goalGeo, goalMat);
            this.goalVol1.position.set(0, -4.5, -50); // Home Goal Zone (-45 to -55)
            this.goalVol1.visible = false;
            this.scene.add(this.goalVol1);

            this.goalVol2 = new THREE.Mesh(goalGeo, goalMat);
            this.goalVol2.position.set(0, -4.5, 50); // Away Goal Zone (45 to 55)
            this.goalVol2.visible = false;
            this.scene.add(this.goalVol2);
        }

update() {
            // Update static debugs
            if (this.goalVol1) this.goalVol1.visible = this.enabled && this.showGoalVolume;
            if (this.goalVol2) this.goalVol2.visible = this.enabled && this.showGoalVolume;

            if (!this.enabled) {
                if (this.visuals.size > 0) this.clear();
                return;
            }

            const game = window.flux.gameInstance;
            if (!game || !game.teams.home) return;

            const entities = [
                ...game.teams.home.players,
                ...game.teams.away.players,
                game.entities.ball
            ];

            entities.forEach(e => {
                if (!e || !e.mesh) return;
                
                let v = this.visuals.get(e);
                if (!v) {
                    v = this.createVisual(e);
                    this.visuals.set(e, v);
                }
                this.updateVisual(e, v);
            });
        }

        createVisual(entity) {
            const group = new THREE.Group();
            this.scene.add(group);

            // Hitboxes
            const tackle = new THREE.Mesh(this.geoCylinder, this.matTackle);
            const catchR = new THREE.Mesh(this.geoCylinder, this.matCatch);
            group.add(tackle);
            group.add(catchR);

            // Lines
            const velLine = this.createLine(this.matVel);
            const inputLine = this.createLine(this.matInput);
            const aiLine = this.createLine(this.matAI); // Line to perceived target
            
            group.add(velLine);
            group.add(inputLine);
            group.add(aiLine);

            return { group, tackle, catchR, velLine, inputLine, aiLine };
        }

        createLine(mat) {
            const geo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(), new THREE.Vector3()]);
            return new THREE.Line(geo, mat);
        }

        updateLine(line, start, end) {
            const pos = line.geometry.attributes.position.array;
            pos[0] = start.x; pos[1] = start.y; pos[2] = start.z;
            pos[3] = end.x; pos[4] = end.y; pos[5] = end.z;
            line.geometry.attributes.position.needsUpdate = true;
            line.visible = true;
        }

        updateVisual(e, v) {
            v.group.visible = true;
            
            // Hitboxes (Local to entity position)
            v.tackle.position.copy(e.mesh.position);
            v.catchR.position.copy(e.mesh.position);
            
            if (this.showHitboxes && e.role) {
                v.tackle.visible = true;
                const rT = e.tackleRadius || 2.5;
                v.tackle.scale.set(rT, 1, rT);

                v.catchR.visible = true;
                // Logic from main.js checkBallGrab
                const rC = e.isDashing ? 4.0 : 2.5; 
                v.catchR.scale.set(rC, 1, rC);
                v.catchR.position.y = e.mesh.position.y + 0.1;
            } else {
                v.tackle.visible = false;
                v.catchR.visible = false;
            }

            // Vectors (Global lines)
            const origin = e.mesh.position.clone();
            origin.y += 1.0; // Lift up

            if (this.showVectors) {
                // Velocity
                if (e.velocity) {
                    const end = origin.clone().add(e.velocity);
                    this.updateLine(v.velLine, origin, end);
                }
                // Input
                if (e.inputVector && e.inputVector.lengthSq() > 0) {
                    const end = origin.clone().add(e.inputVector.clone().multiplyScalar(3.0));
                    this.updateLine(v.inputLine, origin, end);
                } else {
                    v.inputLine.visible = false;
                }
            } else {
                v.velLine.visible = false;
                v.inputLine.visible = false;
            }

            // AI
            if (this.showAI && e.perceivedTargetPos) {
                // Draw line to perceived target
                this.updateLine(v.aiLine, origin, e.perceivedTargetPos);
            } else {
                v.aiLine.visible = false;
            }
        }

        clear() {
            this.visuals.forEach(v => {
                this.scene.remove(v.group);
            });
            this.visuals.clear();
        }
    }
    window.flux.DebugVisualizer = DebugVisualizer;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class MenuManager {
        constructor(gameManager) {
            this.game = gameManager;
            this.container = document.getElementById('main-menu');
            this.items = document.querySelectorAll('.menu-item');
            
            this.setupEvents();
        }

        setupEvents() {
            this.items.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent click-through
                    this.handleSelection(item.dataset.action);
                });
                
                item.addEventListener('mouseenter', () => {
                    // Optional: Play hover sound
                });
            });
        }

        handleSelection(action) {
            console.log("Menu Selection:", action);
            if (action === 'normal') {
                this.hide();
                this.game.startMatch('normal');
            } else if (action === 'practice') {
                this.hide();
                this.game.startMatch('practice');
            } else if (action === 'ball_lab') {
                this.hide();
                window.flux = window.flux || {};
                window.flux.requestedPracticeDrill = 'ball_lab';
                this.game.startMatch('practice');
            } else if (action === 'options') {
                console.log("Options clicked (Not implemented)");
            }
        }

        show() {
            if (this.container) {
                this.container.classList.add('active');
                this.game.setMenuMode(true);
            }
        }

        hide() {
            if (this.container) {
                this.container.classList.remove('active');
                this.game.setMenuMode(false);
            }
        }
    }

    window.flux.MenuManager = MenuManager;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    class PracticeManager {
        constructor(gameManager) {
            this.game = gameManager;
            this.isRunning = false;
            this.currentDrill = null;
            this.drillState = {}; 
            
this.drills = {
                'free': { name: 'FREE ROAM', setup: this._setupFree.bind(this), loop: this._loopFree.bind(this) },
                'ball_lab': { name: 'BALL LAB', setup: this._setupBallLab.bind(this), loop: this._loopBallLab.bind(this) },
                'shooting': { name: 'SHOOTING DRILL', setup: this._setupShooting.bind(this), loop: this._loopShooting.bind(this) },
                'passing': { name: 'PASSING DRILL', setup: this._setupPassing.bind(this), loop: this._loopPassing.bind(this) },
                'defense': { name: 'DEFENSE DRILL', setup: this._setupDefense.bind(this), loop: this._loopDefense.bind(this) },
                'curve': { name: 'CURVE SHOT', setup: this._setupCurve.bind(this), loop: this._loopCurve.bind(this) },
                'rapid_fire': { name: 'RAPID FIRE', setup: this._setupRapidFire.bind(this), loop: this._loopRapidFire.bind(this) }
            };

this.ui = document.getElementById('practice-overlay');
            this.gestureHint = document.getElementById('gesture-hint');
            
            this.options = {
                infStats: true,
                aiDummy: true,
                showHitboxes: false
            };
            
this.targetRing = null;
            this.ghostBalls = []; // Array to track visual copies of thrown balls
            this._initVisuals();
            this._setupEvents();
        }

        _initVisuals() {
            // Create a glowing ring for targets
            const geometry = new THREE.RingGeometry(1.5, 1.8, 32);
            geometry.rotateX(-Math.PI / 2);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x00ffff, 
                side: THREE.DoubleSide, 
                transparent: true, 
                opacity: 0.6,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            this.targetRing = new THREE.Mesh(geometry, material);
            this.targetRing.visible = false;
            // Add to scene via game manager reference
            if (this.game.scene) this.game.scene.add(this.targetRing);
        }

        start() {
this.isRunning = true;
            this._showPanel();
            // If menu requested a specific drill (e.g., Ball Lab), honor it once.
            const req = window.flux && window.flux.requestedPracticeDrill;
            if (req && this.drills[req]) {
                this.setDrill(req);
                window.flux.requestedPracticeDrill = null;
            } else {
                this.setDrill('free');
            }
            
            // Ensure HUD is visible
            const hud = document.getElementById('ui-layer');
            if(hud) hud.style.visibility = 'visible';
        }

        stop() {

            this.isRunning = false;
            this._hidePanel();
            this._hideRestoreBtn();
this._clearDrill();
            
// Clear Ghost Balls
            this.ghostBalls.forEach(b => {
                if (b.mesh) this.game.scene.remove(b.mesh);
                if (b.trail) {
                    this.game.scene.remove(b.trail.mesh);
                    if (b.trail.mesh.geometry) b.trail.mesh.geometry.dispose();
                }
            });
            this.ghostBalls = [];
            if (this.targetRing) this.targetRing.visible = false;

            // Restore Away Team Visibility for Normal Match
            if (this.game.teams.away) {
                this.game.teams.away.players.forEach(p => {
                    if(p.mesh) {
                        p.mesh.visible = true;
                        p.mesh.position.y = 0; // Ensure they aren't stuck under floor
                    }
                });
            }

            // Disable debug visuals if they were on
            if (this.game.debugVisualizer) {
                this.game.debugVisualizer.enabled = false;
                this.game.debugVisualizer.showHitboxes = false;
            }
        }

        setDrill(key) {
            if (!this.drills[key]) return;
            this._clearDrill();
            this.currentDrill = key;
            
            // Update UI
            if (this.ui) {
                this.ui.querySelectorAll('.drill-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.drill === key);
                });
            }

            // Run Setup
            this.drills[key].setup();
            
            // Announcement
            if (this.game.showAnnouncement) {
                this.game.showAnnouncement(this.drills[key].name, 'normal');
            }
        }

        update(dt) {
            if (!this.isRunning) return;

            // Common Practice Logic (Infinite Stats)
            if (this.options.infStats) {
                this._applyInfiniteStats();
            }

            // Drill Logic
            if (this.currentDrill && this.drills[this.currentDrill].loop) {
                this.drills[this.currentDrill].loop(dt);
            }
            
            // Visuals Animation
// Visuals Animation
            if (this.targetRing && this.targetRing.visible) {
                this.targetRing.rotation.z += dt; // Spin
                const s = 1.0 + Math.sin(Date.now() * 0.005) * 0.1;
                this.targetRing.scale.set(s, s, s);
            }

// Update Ghost Balls
            for (let i = this.ghostBalls.length - 1; i >= 0; i--) {
                const b = this.ghostBalls[i];
                b.life -= dt;
                
                // --- PHYSICS & VISUALS DELEGATION ---
                if (window.flux.Ball && window.flux.Ball.prototype.updateFree) {
                    window.flux.Ball.prototype.updateFree.call(b, dt);
                    window.flux.Ball.prototype.updateVisuals.call(b, dt);
                }

                // Update Trail
                if (b.trail) {
                    const trailPos = b.mesh.position.clone();
                    if (b.deformNode) trailPos.y += b.deformNode.position.y;
                    b.trail.update(trailPos);
                }

                // --- GOAL DETECTION FOR GHOST BALLS ---
                const pos = b.mesh.position;
                // Check Z depth (Goal is at +/- 28, trigger at 29)
                if (Math.abs(pos.z) > 29.0) {
                    // Goal Box Dimensions (Matches GameManager)
                    const halfWidth = 11.0;
                    const halfHeight = 9.0;
                    const goalYOffset = -4.5;
                    
                    if (Math.abs(pos.x) <= halfWidth && Math.abs(pos.y - goalYOffset) <= halfHeight) {
                        // GOAL!
                        if (this.game.particleManager) {
                            // Spawn Goal FX
                            this.game.particleManager.spawn('shockwave', pos, { scale: 8.0, life: 0.5 });
                            this.game.particleManager.spawn('flash', pos, { scale: 5.0 });
                            // Debris
                            for(let k=0; k<10; k++) this.game.particleManager.spawn('debris', pos, { scale: 0.5 });
                        }
                        if (this.game.floatingText) {
                            this.game.floatingText.spawn("GOAL", pos, "goal");
                        }
                        // Kill ball immediately
                        b.life = 0;
                    }
                }

                // Cleanup
                if (b.life <= 0 || b.mesh.position.y < -10) {
                    this.game.scene.remove(b.mesh);
                    if (b.trail) {
                        this.game.scene.remove(b.trail.mesh);
                        if (b.trail.mesh.geometry) b.trail.mesh.geometry.dispose();
                    }
                    this.ghostBalls.splice(i, 1);
                }
            }
        }

        _setupEvents() {

            // Minimize / Restore
            const minBtn = this.ui.querySelector('#p-minimize');
            if (minBtn) {
                minBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this._hidePanel();
                    this._showRestoreBtn();
                });
            }

            const restoreBtn = document.getElementById('practice-restore-btn');
            if (restoreBtn) {
                restoreBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this._showPanel();
                    this._hideRestoreBtn();
                });
            }

            // Drill Buttons
            this.ui.querySelectorAll('.drill-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.setDrill(btn.dataset.drill);
                });
            });

            // Reset Ball
            const resetBtn = this.ui.querySelector('#p-reset-ball');
            if (resetBtn) {
                resetBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this._resetBallToPlayer();
                });
            }

            // Exit
            const exitBtn = this.ui.querySelector('#p-exit');
            if (exitBtn) {
                exitBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (window.flux.gameInstance && window.flux.gameInstance.menuManager) {
                        window.flux.gameInstance.menuManager.show();
                        window.flux.gameInstance.state = 'menu';
                        this.stop();
                    }
                });
            }

            // Options Toggles
            this._bindToggle('opt-inf-stat', 'infStats');
            this._bindToggle('opt-ai-dummy', 'aiDummy', (val) => {
                // Update AI Dummy state immediately
                if (this.game.teams.away) {
                    this.game.teams.away.aiEnabled = !val; // If dummy is TRUE, AI is FALSE
                }
            });
            this._bindToggle('opt-hitboxes', 'showHitboxes', (val) => {
                if (this.game.debugVisualizer) {
                    this.game.debugVisualizer.enabled = val;
                    this.game.debugVisualizer.showHitboxes = val;
                }
            });

            // Keyboard Shortcut for Reset (R)
// Keyboard Shortcut for Reset (R)
            window.addEventListener('keydown', (e) => {
                if (this.isRunning && e.key.toLowerCase() === 'r' && !e.repeat) {
                    this._resetBallToPlayer();
                }
            });
        }

_bindToggle(id, optionKey, callback) {
            const el = this.ui.querySelector(`#${id}`);
            if (!el) return;

            // Helper to update visuals
            const updateVisual = () => {
                const isActive = this.options[optionKey];
                el.classList.toggle('active', isActive);
                const box = el.querySelector('.checkbox');
                if (box) box.innerText = isActive ? '' : '';
            };

            // Initialize visual state immediately
            updateVisual();

            el.addEventListener('click', (e) => {
                e.stopPropagation();
                this.options[optionKey] = !this.options[optionKey];
                
                updateVisual();

                if (callback) callback(this.options[optionKey]);
            });
        }


        _setupBallLab() {
            this._setInstruction("BALL LAB: Open DevTools  Ball Lab. Use Shot Cannon + trajectory preview + record/replay.");
            this.drillState.resetting = false;
            this.drillState._autoResetTimer = 0;

            const home = this.game.teams.home;
            const away = this.game.teams.away;
            const p = home ? home.activePlayer : null;
            if (!p) return;

            // Solo mode: hide everyone except the active player
            if (home && home.players) {
                home.players.forEach(mate => {
                    if (mate.mesh) mate.mesh.visible = (mate === p);
                });
            }
            if (away && away.players) {
                away.players.forEach(opp => {
                    if (opp.mesh) opp.mesh.visible = false;
                });
            }

            // Place active player at center facing the away goal
            if (p.mesh) {
                p.mesh.position.set(0, 0, 0);
                p.mesh.lookAt(0, 0, -28);
                p.velocity.set(0, 0, 0);
                if (p.syncRotation) p.syncRotation();
            }

            // Big stats so you can test extremes
            if (p.stats) {
                p.stats.SH = 99;
                p.stats.PA = 99;
                p.stats.EN = 99;
                p.stats.maxHP = Math.max(p.stats.maxHP || 999, 999);
                p.stats.HP = p.stats.maxHP;
            }

            // A clear target marker (purely visual)
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.set(0, 0.1, -18);
                this.targetRing.material.color.setHex(0xff00ff);
            }

            this._resetBallToPlayer();
        }

        _loopBallLab(dt) {
            const b = this.game.entities.ball;
            const p = this.game.teams.home.activePlayer;
            if (!b || !p) return;

            // Auto-reset ball back to player once it comes to rest,
            // so you can spam variations without touching anything.
            if (b.state === 'free') {
                const stopped = (b.velocity.lengthSq() < 0.01) && (b.power <= 0.01);
                if (stopped) {
                    this.drillState._autoResetTimer = (this.drillState._autoResetTimer || 0) + dt;
                    if (this.drillState._autoResetTimer > 0.45) {
                        this._resetBallToPlayer();
                        this.drillState._autoResetTimer = 0;
                    }
                } else {
                    this.drillState._autoResetTimer = 0;
                }
            } else {
                this.drillState._autoResetTimer = 0;
            }

            // Slight target bob (helps depth perception)
            if (this.targetRing && this.targetRing.visible) {
                this.targetRing.position.y = 0.1 + Math.sin(Date.now() * 0.003) * 0.05;
            }
        }

        _applyInfiniteStats() {
            const home = this.game.teams.home;
            if (home) {
                home.players.forEach(p => {
                    p.stats.HP = p.stats.maxHP;
                    p.currentEN = p.stats.EN;
                    p.status.venom = 0;
                    p.status.nap = 0;
                    p.stunTimer = 0;
                });
            }
        }

        _clearDrill() {

            // Reset positions, clear dummies, reset score
            if (this.drillState.hintTimeout) clearTimeout(this.drillState.hintTimeout);
            this.drillState = { score: 0, timer: 0, stage: 0, resetting: false };
            if (this.gestureHint) this.gestureHint.style.display = 'none';
            this._updateScoreUI(0);
            
            // Clear Glyphs
            if (this.game.glyphManager) this.game.glyphManager.clear();
            
            if (this.targetRing) this.targetRing.visible = false;

            // Reset teams to default positions

            // Reset teams to default positions
            this.game.teams.home.resetPositions();
            this.game.teams.away.resetPositions();
            
            // Apply AI Dummy setting
            if (this.game.teams.away) {
                this.game.teams.away.aiEnabled = !this.options.aiDummy;
            }
            // Hide away team by default in drills unless specified
            this.game.teams.away.players.forEach(p => {
                if(p.mesh) p.mesh.visible = false;
                p.mesh.position.set(0, -100, 0); // Move away
                p.velocity.set(0,0,0);
            });
            
            // Ensure Home team is visible
            this.game.teams.home.players.forEach(p => {
                if(p.mesh) p.mesh.visible = true;
            });
        }

        _resetBallToPlayer() {
            const p = this.game.teams.home.activePlayer;
            const b = this.game.entities.ball;
            if (p && b) {
                b.reset();
                b.grab(p);
                if (this.game.floatingText) this.game.floatingText.spawn("RESET", p.mesh.position, "tech");
                
                // Snap camera
                if (this.game.cameraManager) this.game.cameraManager.snapToTarget();
            }
        }

        _updateScoreUI(val) {
            const el = this.ui.querySelector('#drill-score');
            if (el) el.innerText = `SCORE: ${val}`;
        }

        _setInstruction(text) {
             const el = this.ui.querySelector('#drill-instruction');
             if (el) el.innerText = text;
        }

        // --- DRILLS ---

        _setupFree() {
            this._setInstruction("Free practice. Infinite HP/EN.");
            // Show everyone
            this.game.teams.away.players.forEach(p => {
                if(p.mesh) p.mesh.visible = true;
                p.mesh.position.copy(p.homePosition);
            });
            this._resetBallToPlayer();
        }
        _loopFree(dt) {}

        _setupShooting() {

            this._setInstruction("Score on the Goalie!");
            this.drillState.resetting = false; // Clear reset flag
            
            // Setup: Active Player at 18m, Goalie in net.
            const p = this.game.teams.home.activePlayer;
            const g = this.game.teams.away.players.find(x => x.role === 'GL');
            
            if (p && p.mesh) {
                p.mesh.position.set(0, 0, -10); // 18m out (Home attacks -Z)
                p.mesh.lookAt(0, 0, -28);
                p.velocity.set(0,0,0);
            }
            if (g && g.mesh) {
                g.mesh.visible = true;
                g.mesh.position.set(0, 0, -27);
                g.mesh.lookAt(0, 0, 0);
                g.velocity.set(0,0,0);
            }
            
            this._resetBallToPlayer();
        }
        
        _loopShooting(dt) {
            if (this.drillState.resetting) return;

            // Check if goal scored (GameManager handles the actual goal event, but we track reset)
            if (this.game.state === 'goal') {
                this.drillState.resetting = true;
                this.drillState.score++;
                this._updateScoreUI(this.drillState.score);
                this.game.state = 'active'; // Hijack state back
                setTimeout(() => this._setupShooting(), 1000);
                return;
            }
            
            // If goalie catches
            const g = this.game.teams.away.players.find(x => x.role === 'GL');
            if (g && g.hasBall) {
                 this.drillState.resetting = true;
                 if (this.game.floatingText) this.game.floatingText.spawn("SAVED", g.mesh.position, "damage");
                 setTimeout(() => this._setupShooting(), 1000);
            }
        }

        _setupPassing() {

             this._setInstruction("Pass to the moving target!");
             this.drillState.resetting = false;

             // Setup: Active Player center. 1 Teammate running patterns.
             const p = this.game.teams.home.activePlayer;
             const target = this.game.teams.home.players.find(x => x !== p && x.role !== 'GL');
             
             this.drillState.target = target;
             
             if (p) {
                 p.mesh.position.set(0, 0, 10);
                 p.velocity.set(0,0,0);
             }
             if (target) {
                 target.mesh.position.set(0, 0, -10);
                 target.mesh.visible = true;
                 target.velocity.set(0,0,0);
             }
             
             this._resetBallToPlayer();
        }

        _loopPassing(dt) {
            if (this.drillState.resetting) return;

            const target = this.drillState.target;
            if (!target) return;
            
            // Move target in circle
            this.drillState.timer += dt;
            target.mesh.position.x = Math.sin(this.drillState.timer) * 10;
            target.mesh.position.z = -10 + Math.cos(this.drillState.timer * 0.5) * 5;
            target.mesh.lookAt(0,0,10);

            // Update Ring
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.copy(target.mesh.position);
                this.targetRing.position.y = 0.1;
                this.targetRing.material.color.setHex(0x00ffff); // Cyan
            }

            if (target.hasBall) {
                this.drillState.resetting = true;
                this.drillState.score++;
                this._updateScoreUI(this.drillState.score);
                if (this.game.floatingText) this.game.floatingText.spawn("NICE PASS!", target.mesh.position, "heal");
                
                // Reset
                setTimeout(() => {
                    target.loseBall();
                    this._setupPassing(); // Re-setup to reset positions
                }, 800);
            }
        }
        
        _setupDefense() {

            this._setInstruction("Tackle the attacker!");
            this.drillState.resetting = false;

            const p = this.game.teams.home.activePlayer;
            const attacker = this.game.teams.away.players.find(x => x.role === 'MF');
            
            this.drillState.attacker = attacker;
            
            if (p) {
                p.mesh.position.set(0, 0, 20); // Near own goal
                p.velocity.set(0,0,0);
            }
            if (attacker) {
                attacker.mesh.visible = true;
                attacker.mesh.position.set(0, 0, -10);
                attacker.velocity.set(0,0,0);
                // Give ball to attacker
                const b = this.game.entities.ball;
                b.reset();
                b.grab(attacker);
            }
        }
        
        _loopDefense(dt) {
            if (this.drillState.resetting) return;

            const attacker = this.drillState.attacker;
            const p = this.game.teams.home.activePlayer;
            
            if (!attacker || !p) return;
            
            // Attacker runs to goal (+Z)
            const goalPos = new THREE.Vector3(0, 0, 28);
            const dir = goalPos.clone().sub(attacker.mesh.position).normalize();
            
            // Update Ring on Attacker
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.copy(attacker.mesh.position);
                this.targetRing.position.y = 0.1;
                this.targetRing.material.color.setHex(0xff0000); // Red for enemy
            }

            if (attacker.hasBall) {
                attacker.setInput(dir.x, dir.z);
            } else {
                // Ball lost (Tackled)
                if (p.hasBall || this.game.entities.ball.state === 'free') {
                    this.drillState.resetting = true;
                    this.drillState.score++;
                    this._updateScoreUI(this.drillState.score);
                    if (this.game.floatingText) this.game.floatingText.spawn("STOPPED!", p.mesh.position, "block");
                    setTimeout(() => this._setupDefense(), 1000);
                }
            }
            
            // Fail condition: Attacker scores (GameManager handles goal check)
             if (this.game.state === 'goal') {
                this.drillState.resetting = true;
                this.game.state = 'active';
                if (this.game.floatingText) this.game.floatingText.spawn("FAILED", p.mesh.position, "damage");
                setTimeout(() => this._setupDefense(), 1000);
            }
}

        _setupCurve() {
this._setInstruction("Swipe a CURVE ( ) ) to bypass the defender!");
            this.drillState.resetting = false;

            // Show gesture hint
            if (this.gestureHint) {
                this.gestureHint.style.display = 'flex';
                this.gestureHint.classList.add('active');
                
                // Clear any existing timeout
                if (this.drillState.hintTimeout) clearTimeout(this.drillState.hintTimeout);
                
                // Auto hide after 4s
                this.drillState.hintTimeout = setTimeout(() => {
                    if (this.gestureHint) {
                        this.gestureHint.style.display = 'none';
                        this.gestureHint.classList.remove('active');
                    }
                }, 4000);
            }

            const p = this.game.teams.home.activePlayer;
            // Use a defender dummy
            const defender = this.game.teams.away.players.find(x => x.role === 'LD');
            this.drillState.defender = defender;

            if (p) {
                p.mesh.position.set(0, 0, 15);
                p.mesh.lookAt(0, 0, -28);
                p.velocity.set(0,0,0);
            }

            if (defender) {
                defender.mesh.visible = true;
                defender.mesh.position.set(0, 0, 5); // 10m in front of player
                defender.mesh.lookAt(0, 0, 15); // Face player
                defender.velocity.set(0,0,0);
                // Boost BL to ensure straight shots are blocked
                defender.stats.BL = 99; 
                // Ensure they don't move
                defender.aiState = 'IDLE';
            }

            // Target Ring behind defender
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.set(0, 0.1, -10);
                this.targetRing.material.color.setHex(0x00ffff);
            }

            this._resetBallToPlayer();
        }

_loopCurve(dt) {
            if (this.drillState.resetting) return;

            const ball = this.game.entities.ball;
            const defender = this.drillState.defender;

            // Check if ball passed the defender line (z < 0)
            if (ball.mesh.position.z < 0) {
                // Success zone (Within 5m width)
                if (Math.abs(ball.mesh.position.x) < 5) {
                    this.drillState.resetting = true;
                    this.drillState.score++;
                    this._updateScoreUI(this.drillState.score);
                    if (this.game.floatingText) this.game.floatingText.spawn("CURVED!", ball.mesh.position, "tech");
                    setTimeout(() => this._setupCurve(), 1000);
                    return;
                }
            }

            // Check if blocked (Ball stopped or power drained significantly near defender)
            if (defender && ball.mesh.position.distanceTo(defender.mesh.position) < 3.0) {
                if (ball.power <= 0 || ball.velocity.length() < 1.0) {
                    this.drillState.resetting = true;
                    if (this.game.floatingText) this.game.floatingText.spawn("BLOCKED", defender.mesh.position, "damage");
                    
                    // Re-show hint on failure to guide player
                    if (this.gestureHint) {
                        this.gestureHint.style.display = 'flex';
                        this.gestureHint.classList.add('active');
                        clearTimeout(this.drillState.hintTimeout);
                        this.drillState.hintTimeout = setTimeout(() => {
                            if (this.gestureHint) {
                                this.gestureHint.style.display = 'none';
                                this.gestureHint.classList.remove('active');
                            }
                        }, 4000);
                    }

                    setTimeout(() => this._setupCurve(), 1000);
                    return;
                }
            }

            // Missed / Out of bounds
            if (ball.mesh.position.z < -15) {
                 this.drillState.resetting = true;
                 if (this.game.floatingText) this.game.floatingText.spawn("MISSED", ball.mesh.position, "damage");
                 
                 // Re-show hint on miss
                 if (this.gestureHint) {
                    this.gestureHint.style.display = 'flex';
                    this.gestureHint.classList.add('active');
                    clearTimeout(this.drillState.hintTimeout);
                    this.drillState.hintTimeout = setTimeout(() => {
                        if (this.gestureHint) {
                            this.gestureHint.style.display = 'none';
                            this.gestureHint.classList.remove('active');
                        }
                    }, 4000);
                 }

                 setTimeout(() => this._setupCurve(), 1000);
            }
        }

_setupRapidFire() {
            this._setInstruction("UNLIMITED AMMO! Spam throws!");
            this.drillState.resetting = false;

            // Find Tidus or default to LF
            let p = this.game.teams.home.players.find(x => x.characterName && x.characterName.includes('Tidus'));
            if (!p) p = this.game.teams.home.players.find(x => x.role === 'LF');
            
            // Set active player
            if (p) {
                this.game.teams.home.setActivePlayer(p);
                p.mesh.position.set(0, 0, 0);
                p.mesh.lookAt(0, 0, -28);
                p.velocity.set(0,0,0);
                
                // Boost stats for fun
                p.stats.SH = 99;
                p.stats.PA = 99;
            }

            // HIDE EVERYONE (Alone Mode)
            this.game.teams.home.players.forEach(mate => {
                if (mate !== p && mate.mesh) mate.mesh.visible = false;
            });
            this.game.teams.away.players.forEach(opp => {
                if (opp.mesh) opp.mesh.visible = false;
            });

            this._resetBallToPlayer();
        }

_loopRapidFire(dt) {
            const p = this.game.teams.home.activePlayer;
            const b = this.game.entities.ball;

            if (!p || !b) return;

            // Detect if ball was just thrown (is free)
            if (b.state === 'free') {
                // 1. Spawn Ghost Ball (Visual Copy)
                // Clone the mesh hierarchy to preserve Deform/Spin nodes
                const ghostMesh = b.mesh.clone();
                
                // Ensure visibility and add to scene
                this.game.scene.add(ghostMesh);
                
                // Re-bind internal references for the physics engine
                // Hierarchy: Mesh -> DeformNode -> SpinNode
                const deformNode = ghostMesh.children[0];
                const spinNode = deformNode ? deformNode.children[0] : null;

                // Determine Trail Color based on Tech
                let trailColor = 0xff4400; // Default SH (Orange)
                if (b.technique) {
                    if (b.technique.type === 'venom') trailColor = 0xaa00ff;
                    else if (b.technique.type === 'wither') trailColor = 0x888888;
                    else if (b.technique.type === 'nap') trailColor = 0x000088;
                    else if (b.technique.type === 'sphere') trailColor = 0x00ffff;
                    else if (b.technique.type === 'jecht') trailColor = 0xff0000;
                    else if (b.technique.type === 'invisible') trailColor = 0x444444;
                } else if (b.powerType === 'PA') {
                    trailColor = 0x00aaff; // Pass (Blue)
                }

                // Create Trail
                const trail = new window.flux.TrailRenderer(this.game.scene);
                trail.active = true;
                trail.setColor(trailColor);
                trail.reset(ghostMesh.position);

                // Create a "Mock" Ball object that satisfies Ball.js physics requirements
                const ghostBall = {
                    mesh: ghostMesh,
                    deformNode: deformNode,
                    spinNode: spinNode,
                    velocity: b.velocity.clone(),
                    angularVelocity: b.angularVelocity ? b.angularVelocity.clone() : new THREE.Vector3(),
                    accumulatedRotation: b.accumulatedRotation ? b.accumulatedRotation.clone() : new THREE.Quaternion(),
                    state: 'free',
                    power: b.power,
                    powerType: b.powerType,
                    technique: b.technique,
                    isInvisible: b.isInvisible,
                    life: 5.0, // Enough time to reach goal
                    trail: trail,
                    _bubbleTimer: 0,
                    _ghost: true,
                    // Mock methods
                    reset: () => {}, 
                    drop: () => {},
                    reveal: () => {}
                };

                // Apply visibility
                ghostMesh.visible = !b.isInvisible;

                this.ghostBalls.push(ghostBall);

// 2. Reset Real Ball to Player INSTANTLY
                b.velocity.set(0, 0, 0);
                b.angularVelocity.set(0, 0, 0);
                
                // FIX: Force ball position to be explicitly in front of the player
                // This prevents any logic from thinking the ball is behind and triggering a turn
                const fwd = new THREE.Vector3(0, 0, 1).applyQuaternion(p.mesh.quaternion);
                b.mesh.position.copy(p.mesh.position).add(fwd.multiplyScalar(0.8));
                b.mesh.position.y += 1.0;

                // Manual Attach (Bypass 'catch' animation)
                b.holder = p;
                b.state = 'held';
                p.hasBall = true;
                
                // Reset Player Throw State so they can fire again immediately
                p.isThrowing = false;
                p.catchCooldown = 0;

                // Sync rotation to prevent snapping
                if (p.syncRotation) p.syncRotation();
            }
            
            // Ensure infinite stats
            p.currentEN = p.stats.EN;
            p.stats.HP = p.stats.maxHP;
        }

        _showPanel() {
            if (this.ui) this.ui.classList.add('active');
        }

        _hidePanel() {
            if (this.ui) this.ui.classList.remove('active');
        }

        _showRestoreBtn() {
            const btn = document.getElementById('practice-restore-btn');
            if (btn) btn.style.display = 'block';
        }

        _hideRestoreBtn() {
            const btn = document.getElementById('practice-restore-btn');
            if (btn) btn.style.display = 'none';
        }
    }
window.flux.PracticeManager = PracticeManager;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    // --- High-Quality Noise Texture Generator ---
    window.flux.noiseTexture = (() => {
        const size = 512;
        const c = document.createElement('canvas');
        c.width = size; c.height = size;
        const ctx = c.getContext('2d');
        
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, size, size);
        
        // Generate seamless noise (Perlin-ish via layered random circles/gradients)
        const drawNoiseLayer = (scale, alpha) => {
            ctx.globalAlpha = alpha;
            ctx.globalCompositeOperation = 'lighter'; // Additive
            const count = 300 * scale;
            for(let i=0; i<count; i++) {
                const x = Math.random() * size;
                const y = Math.random() * size;
                const r = (Math.random() * 30 + 10) / scale;
                
                const g = ctx.createRadialGradient(x, y, 0, x, y, r);
                g.addColorStop(0, '#888888');
                g.addColorStop(1, 'transparent');
                
                ctx.fillStyle = g;
                ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
                
                // Wrap around for seamless tiling
                [[x-size, y], [x+size, y], [x, y-size], [x, y+size]].forEach(pos => {
                    const g2 = ctx.createRadialGradient(pos[0], pos[1], 0, pos[0], pos[1], r);
                    g2.addColorStop(0, '#888888');
                    g2.addColorStop(1, 'transparent');
                    ctx.fillStyle = g2;
                    ctx.beginPath(); ctx.arc(pos[0], pos[1], r, 0, Math.PI*2); ctx.fill();
                });
            }
        };
        
        drawNoiseLayer(1.0, 0.3);
        drawNoiseLayer(2.0, 0.2);
        drawNoiseLayer(4.0, 0.1);
        
        const tex = new THREE.CanvasTexture(c);
        tex.wrapS = THREE.RepeatWrapping;
        tex.wrapT = THREE.RepeatWrapping;
        return tex;
    })();

    class WaterOverlay {
        constructor(camera) {
            this.camera = camera;
            
            // Fullscreen quad
            const geometry = new THREE.PlaneGeometry(2, 2);
            
const vert = `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = vec4(position, 1.0);
                }
            `;

const frag = `
                precision mediump float;
                uniform float uTime;
                uniform float uOpacity;
                uniform sampler2D tNoise;
                varying vec2 vUv;

                // FFX Palette (Additive Friendly)
                const vec3 C_DEEP = vec3(0.0, 0.02, 0.1);     // Subtle Deep Blue Edge
                const vec3 C_GLOW = vec3(0.0, 0.5, 0.8);      // Cyan Glow
                const vec3 C_RAY  = vec3(0.4, 0.7, 1.0);      // Light Shafts
                const vec3 C_PYRE = vec3(1.0, 0.9, 0.6);      // Pyrefly Gold

                // Bayer 4x4 Dithering
                float bayer4x4(vec2 uv) {
                    int x = int(mod(uv.x, 4.0));
                    int y = int(mod(uv.y, 4.0));
                    float v = 0.0;
                    if (y == 0) {
                        if (x == 0) v = 0.0; else if (x == 1) v = 8.0; else if (x == 2) v = 2.0; else v = 10.0;
                    } else if (y == 1) {
                        if (x == 0) v = 12.0; else if (x == 1) v = 4.0; else if (x == 2) v = 14.0; else v = 6.0;
                    } else if (y == 2) {
                        if (x == 0) v = 3.0; else if (x == 1) v = 11.0; else if (x == 2) v = 1.0; else v = 9.0;
                    } else {
                        if (x == 0) v = 15.0; else if (x == 1) v = 7.0; else if (x == 2) v = 13.0; else v = 5.0;
                    }
                    return v / 16.0;
                }

                void main() {
                    vec2 uv = vUv;
                    float t = uTime * 0.1;

                    // 1. Distortion (Lookup 1)
                    float warp = texture2D(tNoise, uv * 0.4 + vec2(t * 0.04, t * 0.02)).r;
                    
                    // 2. Caustics (Lookup 2)
                    vec2 cUV = uv * 2.0 + vec2(warp * 0.5, warp * 0.2) - vec2(t * 0.05);
                    float c = texture2D(tNoise, cUV).r;
                    
                    c = (c - 0.4) * 2.5;
                    c = max(0.0, c);
                    c = c * c;
                    c = c * c;
                    
                    float caustic = c * 12.0;
                    vec3 causticColor = vec3(caustic * 0.8, caustic, caustic * 1.2);

                    // 3. Rays (Lookup 3)
                    vec2 rayUV = vec2(uv.x + warp * 0.1, uv.y * 0.15 - t * 0.05);
                    float rays = texture2D(tNoise, rayUV).r;
                    rays = rays * rays;
                    
                    float rayMask = 1.0 - abs(uv.y * 2.0 - 1.0);
                    rays *= max(0.0, rayMask);

                    // 4. Pyreflies
                    vec2 p = uv * 5.0;
                    vec2 id = floor(p);
                    vec2 sub = fract(p) - 0.5;
                    
                    float n = fract(sin(dot(id, vec2(12.9898, 78.233))) * 43758.5453);
                    
                    float px = fract(n * 13.0 + t * 0.3) - 0.5;
                    float py = fract(n * 7.0 + t * 0.2) - 0.5;
                    
                    vec2 flyPos = vec2(px, py);
                    float d2 = dot(sub - flyPos, sub - flyPos);
                    
                    float fly = 0.0008 / (d2 + 0.0005);
                    fly *= step(0.7, n); 
                    fly *= 0.5 + 0.5 * sin(t * 5.0 + n * 10.0);

                    // Composition
                    vec3 finalCol = vec3(0.0);

                    // Vignette
                    vec2 vd = uv - 0.5;
                    float vSq = dot(vd, vd);
                    float vig = vSq * 1.2; 
                    finalCol += C_DEEP * vig;

                    finalCol += causticColor * C_GLOW * 0.6;
                    finalCol += rays * C_RAY * 0.3;
                    finalCol += fly * C_PYRE;

                    // PSX Dithering
                    float dither = bayer4x4(gl_FragCoord.xy);
                    // Modulate intensity with dither pattern for texture
                    finalCol += (dither - 0.5) * 0.08;

                    gl_FragColor = vec4(finalCol, uOpacity);
                }
            `;

this.material = new THREE.ShaderMaterial({
                uniforms: {
                    uTime: { value: 0 },
                    uOpacity: { value: 0.5 },
                    tNoise: { value: window.flux.noiseTexture }
                },
                vertexShader: vert,
                fragmentShader: frag,
                transparent: true,
                depthTest: false,
                depthWrite: false,
                blending: THREE.AdditiveBlending // Additive blending prevents dark occlusion
            });

            this.mesh = new THREE.Mesh(geometry, this.material);
            this.mesh.frustumCulled = false;
            this.mesh.renderOrder = 9999;
            
            // Add to camera so it stays on screen
            this.camera.add(this.mesh);
        }
        
        update(dt) {
            if (this.material) {
                this.material.uniforms.uTime.value += dt;
            }
        }
    }
    
    window.flux.WaterOverlay = WaterOverlay;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    class LightShafts {
        constructor(scene) {
            this.scene = scene;
            this.mesh = null;
            this.uniforms = {
                uTime: { value: 0 },
                tNoise: { value: null }
            };

            this._init();
        }

_init() {
            // Geometry: A cluster of cones/cylinders
            // We use a single geometry with instancing or merged geometry for performance,
            // but for simplicity and aesthetic control, let's use a few large planes or a cylinder.
            // A large cylinder with open ends works well for a "pool" shaft effect.
            
            // Increased length to 90 to accommodate tilt without clipping top/bottom
            const geometry = new THREE.CylinderGeometry(30, 20, 90, 32, 1, true);
            
            // Shader
            const vert = `
                varying vec2 vUv;
                varying vec3 vPos;
                void main() {
                    vUv = uv;
                    vPos = position;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `;

            const frag = `
                uniform float uTime;
                uniform sampler2D tNoise;
                varying vec2 vUv;
                varying vec3 vPos;

                void main() {
                    // Vertical fade (Soft top and bottom)
                    float alpha = smoothstep(0.0, 0.3, vUv.y) * smoothstep(1.0, 0.6, vUv.y);

                    // Scrolling Rays
                    // Layer 1: Slow, broad rays
                    float n1 = texture2D(tNoise, vec2(vUv.x * 2.0 + uTime * 0.02, vUv.y * 0.5 - uTime * 0.05)).r;
                    
                    // Layer 2: Fast, interference rays
                    float n2 = texture2D(tNoise, vec2(vUv.x * 3.0 - uTime * 0.03, vUv.y * 0.5 - uTime * 0.1)).r;

                    float rays = n1 * n2;
                    // Boost intensity significantly (Removed pow to prevent crushing)
                    rays = rays * 3.0; 

                    // Glistening Sparkles (High frequency noise)
                    float sparkle = texture2D(tNoise, vUv * vec2(8.0, 2.0) + vec2(uTime * 0.1, uTime * 0.3)).r;
                    sparkle = pow(sparkle, 5.0) * 10.0; // Sharp points

                    // Color: Cyan/Blue/White (Brighter base)
                    vec3 color = vec3(0.6, 0.9, 1.0);
                    
                    // Combine (Higher multipliers)
                    float finalAlpha = (rays * 0.8 + sparkle * 0.4) * alpha;
                    
                    // Distance fade (optional, handled by fog usually but we want additive)
                    gl_FragColor = vec4(color, finalAlpha);
                }
            `;

            const material = new THREE.ShaderMaterial({
                uniforms: this.uniforms,
                vertexShader: vert,
                fragmentShader: frag,
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                side: THREE.DoubleSide
            });

            // Container for the angle (Realistic Light Source)
            this.container = new THREE.Group();
            // Angle: Coming from top-left (simulating surface sun penetrating deep water)
            this.container.rotation.z = Math.PI / 5; // ~36 degrees tilt
            this.container.rotation.x = Math.PI / 10; // ~18 degrees forward
            this.container.position.set(12, 8, 0); // Offset source to hit arena center
            this.scene.add(this.container);

            this.mesh = new THREE.Mesh(geometry, material);
            this.mesh.renderOrder = 100; 
            this.mesh.position.set(0, 0, 0);
            this.container.add(this.mesh);

            // Add a second layer for core intensity
            const coreGeo = new THREE.CylinderGeometry(12, 8, 90, 16, 1, true);
            this.coreMesh = new THREE.Mesh(coreGeo, material);
            this.coreMesh.renderOrder = 100;
            this.container.add(this.coreMesh);
        }

        update(dt) {
            this.uniforms.uTime.value += dt;
            
            // Lazy load texture
            if (!this.uniforms.tNoise.value && window.flux.noiseTexture) {
                this.uniforms.tNoise.value = window.flux.noiseTexture;
                // Ensure wrapping is correct for the cylinder UVs
                window.flux.noiseTexture.wrapS = THREE.RepeatWrapping;
                window.flux.noiseTexture.wrapT = THREE.RepeatWrapping;
            }

            // Slowly rotate shafts for dynamic feel
            if (this.mesh) this.mesh.rotation.y += dt * 0.02;
            if (this.coreMesh) this.coreMesh.rotation.y -= dt * 0.03;
        }
    }

    window.flux.LightShafts = LightShafts;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

// Reusable Glow for Lights
    const _glowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
        g.addColorStop(0, 'rgba(255, 255, 255, 1)');
        g.addColorStop(0.4, 'rgba(0, 170, 255, 0.4)');
        g.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, 64, 64);
        return new THREE.CanvasTexture(c);
    })();

    const _glowMaterial = new THREE.SpriteMaterial({ 
        map: _glowTexture, 
        transparent: true, 
        blending: THREE.AdditiveBlending,
        depthWrite: false
    });

    class Stadium {
        constructor(scene) {
            this.scene = scene;
            this.container = new THREE.Group();
            this.scene.add(this.container);

            // Config for "Herculean" scale
// Config for "Herculean" scale
            this.config = {
                radius: 60,       // Start outside the arena (48 radius)
                tiers: 6,         // Number of seating rings
                tierHeight: 12,
                tierDepth: 15,
                crowdCount: 8000, // Increased density
                structureColor: 0x080c10, // Deep dark blue/black
                lightColor: 0x00aaff
            };

this.rings = [];
            this.lightSprites = []; // Store light sprites for cinematic control
            this.crowd = null;
            this.crowd = null;

this._buildArchitecture();
            this._buildCrowd();
            this._buildHerculeanRings();
            this._buildStadiumLights();
        }

        _buildArchitecture() {
            // 1. The Void Bowl (Background Occluder)
            // Massive cylinder to block the void
            const bowlGeo = new THREE.CylinderGeometry(180, 50, 120, 32, 1, true);
            const bowlMat = new THREE.MeshBasicMaterial({ 
                color: this.config.structureColor, 
                side: THREE.BackSide,
                fog: true 
            });
            const bowl = new THREE.Mesh(bowlGeo, bowlMat);
            bowl.position.y = 20;
            this.container.add(bowl);

            // 2. Seating Tiers (Concentric Rings)
            const tierMat = new THREE.MeshBasicMaterial({ color: 0x111a22, side: THREE.DoubleSide });
            const rimMat = new THREE.MeshBasicMaterial({ color: 0x004466 });

            for(let i=0; i<this.config.tiers; i++) {
                const y = (i * this.config.tierHeight) - 30;
                const rInner = this.config.radius + (i * (this.config.tierDepth * 0.8));
                const rOuter = rInner + this.config.tierDepth;
                
                // Floor Ring
                const ringGeo = new THREE.RingGeometry(rInner, rOuter, 64);
                ringGeo.rotateX(-Math.PI / 2);
                const mesh = new THREE.Mesh(ringGeo, tierMat);
                mesh.position.y = y;
                this.container.add(mesh);
                
                // Glowing Rim (The "Tech" feel)
                const rimGeo = new THREE.TorusGeometry(rInner, 0.8, 4, 64);
                rimGeo.rotateX(Math.PI / 2);
                const rim = new THREE.Mesh(rimGeo, rimMat);
                rim.position.y = y;
                this.container.add(rim);
            }

            // 3. Massive Pillars (The "Herculean" Support)
            const pillarGeo = new THREE.BoxGeometry(8, 200, 8);
            const pillarMat = new THREE.MeshBasicMaterial({ color: 0x050505 });
            
            for(let i=0; i<8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const r = 140; // Far out
                const mesh = new THREE.Mesh(pillarGeo, pillarMat);
                mesh.position.set(Math.cos(angle)*r, 0, Math.sin(angle)*r);
                mesh.lookAt(0,0,0);
                this.container.add(mesh);
            }
        }

_buildCrowd() {
            // Instanced Mesh for Crowd (Low Poly, High Count)
            // Using a simple vertical plane that faces center
            const geo = new THREE.PlaneGeometry(1.2, 2.5);
            
            // --- CROWD SHADER IMPLEMENTATION ---
            // Add instance-specific random offset for animation variation
            const offsets = new Float32Array(this.config.crowdCount);
            for(let i=0; i<this.config.crowdCount; i++) {
                offsets[i] = Math.random();
            }
            geo.setAttribute('aOffset', new THREE.InstancedBufferAttribute(offsets, 1));

            // Custom Shader via onBeforeCompile
            const mat = new THREE.MeshBasicMaterial({ side: THREE.DoubleSide });
            
            mat.onBeforeCompile = (shader) => {
                shader.uniforms.uTime = { value: 0 };
                this.crowdUniforms = shader.uniforms;

                shader.vertexShader = `
                    uniform float uTime;
                    attribute float aOffset;
                    varying float vJump; // Pass to fragment for color variation
                ` + shader.vertexShader;

                shader.vertexShader = shader.vertexShader.replace(
                    '#include <begin_vertex>',
                    `
                    #include <begin_vertex>
                    
                    // Animation Logic
                    float speed = 8.0;
                    float t = uTime * speed + (aOffset * 100.0);
                    
                    // Jump (Sine wave clipped)
                    float jump = max(0.0, sin(t));
                    jump = pow(jump, 2.0); // Sharpen the jump curve
                    
                    // Randomize jump height slightly
                    float height = 0.5 + 0.5 * aOffset;
                    
                    transformed.y += jump * height;
                    
                    // Sway (Side to side)
                    transformed.x += cos(t * 0.5) * 0.1;
                    
                    vJump = jump;
                    `
                );

                shader.fragmentShader = `
                    varying float vJump;
                ` + shader.fragmentShader;

                shader.fragmentShader = shader.fragmentShader.replace(
                    'vec4 diffuseColor = vec4( diffuse, opacity );',
                    `
                    vec4 diffuseColor = vec4( diffuse, opacity );
                    
                    // Brighten when jumping (Cheering effect)
                    diffuseColor.rgb += vec3(0.2) * vJump;
                    `
                );
            };
            
this.crowd = new THREE.InstancedMesh(geo, mat, this.config.crowdCount);
            this.crowd.instanceMatrix.setUsage(THREE.DynamicDrawUsage);
            
            // Optimization: Enable culling and manually set bounding sphere to cover the whole stadium
            // This prevents GPU from processing 2500 instances when the entire structure is out of view
            this.crowd.frustumCulled = true;
            this.crowd.geometry.boundingSphere = new THREE.Sphere(new THREE.Vector3(0, 0, 0), 150);
            
            const dummy = new THREE.Object3D();
            const color = new THREE.Color();
            
// 1. Calculate Total Circumference for distribution to ensure all tiers get people
            let totalCirc = 0;
            const tierRadii = [];
            for(let t=0; t<this.config.tiers; t++) {
                const rMin = this.config.radius + (t * (this.config.tierDepth * 0.8)) + 2;
                const circ = 2 * Math.PI * rMin;
                totalCirc += circ;
                tierRadii.push({ rMin: rMin, circ: circ });
            }

            let idx = 0;
            for(let t=0; t<this.config.tiers; t++) {
                const yBase = (t * this.config.tierHeight) - 30;
                const { rMin, circ } = tierRadii[t];
                const rMax = rMin + this.config.tierDepth - 2;
                
                // Distribute proportionally so upper rows don't get cut off
                const countPerTier = Math.floor(this.config.crowdCount * (circ / totalCirc));
                
                for(let i=0; i<countPerTier; i++) {
                    if (idx >= this.config.crowdCount) break;

                    const angle = Math.random() * Math.PI * 2;
                    const r = rMin + Math.random() * (rMax - rMin);
                    
                    dummy.position.set(
                        Math.cos(angle) * r,
                        yBase + 1.25, // Center of quad
                        Math.sin(angle) * r
                    );
                    
                    // Face center
                    dummy.lookAt(0, yBase, 0);
                    dummy.updateMatrix();
                    
                    this.crowd.setMatrixAt(idx, dummy.matrix);
                    
                    // Random Team Colors (Simulating fans)
                    const rand = Math.random();
                    if (rand < 0.45) color.setHex(0x0088ff); // Home Blue
                    else if (rand < 0.9) color.setHex(0xff4444); // Away Red
                    else color.setHex(0xffffff); // Neutral/Flash
                    
                    // Vary brightness for depth
                    color.multiplyScalar(0.5 + Math.random() * 0.5);
                    
                    this.crowd.setColorAt(idx, color);
                    idx++;
                }
            }
            
            this.container.add(this.crowd);
        }

        _buildHerculeanRings() {
            // Massive floating rings that rotate slowly
            const mat = new THREE.MeshBasicMaterial({ 
                color: 0x445566, 
                transparent: true, 
                opacity: 0.3,
                wireframe: true // Tech/Holographic feel
            });

            // 1. Equatorial Ring (Massive)
            const geo1 = new THREE.TorusGeometry(110, 1, 16, 100);
            const ring1 = new THREE.Mesh(geo1, mat);
            ring1.rotation.x = Math.PI / 2;
            this.container.add(ring1);
            this.rings.push({ mesh: ring1, axis: 'z', speed: 0.01 });

            // 2. Tilted Ring
            const geo2 = new THREE.TorusGeometry(130, 2, 16, 100);
            const ring2 = new THREE.Mesh(geo2, mat);
            ring2.rotation.x = Math.PI / 3;
            this.container.add(ring2);
            this.rings.push({ mesh: ring2, axis: 'y', speed: -0.008 });
            
            // 3. Vertical Ring
            const geo3 = new THREE.TorusGeometry(150, 3, 16, 100);
const ring3 = new THREE.Mesh(geo3, mat);
            this.container.add(ring3);
            this.rings.push({ mesh: ring3, axis: 'y', speed: 0.005 });
        }

        _buildStadiumLights() {
            const count = 16; // Number of lights around the equator
            const radius = 36; // Just outside the arena boundary (32)
            const yPos = 0; // Middle of the sphere
            
            const lightGeo = new THREE.SphereGeometry(0.4, 8, 8);
            const lightMat = new THREE.MeshBasicMaterial({ color: 0xffffff });

            for(let i=0; i<count; i++) {
                const angle = (i / count) * Math.PI * 2;
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;

                // 1. Physical Fixture (The bulb)
                const mesh = new THREE.Mesh(lightGeo, lightMat);
                mesh.position.set(x, yPos, z);
                this.container.add(mesh);

                // 2. Visual Glow (Flare)
                const sprite = new THREE.Sprite(_glowMaterial);
// 2. Visual Glow (Flare)

                sprite.position.set(x, yPos, z);
                sprite.scale.set(8, 8, 1); // Large glow
                this.container.add(sprite);
                this.lightSprites.push(sprite);

// 3. Actual Point Light - REMOVED for optimization
                // Since we use MeshBasicMaterial (Unlit), real lights waste CPU/GPU resources.
                // The sprite glow above provides the visual effect.
            }
        }
update(dt) {
            // Animate Rings
            this.rings.forEach(r => {
                if (r.mesh && r.axis) {
                    r.mesh.rotation[r.axis] += r.speed * dt;
                }
            });

            // Update Crowd Shader
            if (this.crowdUniforms) {
                this.crowdUniforms.uTime.value += dt;
            }

            // Update Light Pops (Cinematic)
            this.lightSprites.forEach(s => {
                if (s.visible && s.scale.x > 8.0) {
                    // Decay pop effect
                    s.scale.x -= dt * 30.0;
                    s.scale.y -= dt * 30.0;
                    if (s.scale.x < 8.0) s.scale.set(8, 8, 1);
                }
            });
        }

        setAllLights(visible) {
            this.lightSprites.forEach(s => {
                s.visible = visible;
                s.scale.set(8, 8, 1); // Reset scale
            });
        }

        turnOnLight(index) {
            if (this.lightSprites[index]) {
                const s = this.lightSprites[index];
                s.visible = true;
                s.material.opacity = 1.0;
                s.scale.set(20, 20, 1); // Pop effect
            }
        }
    }

    window.flux.Stadium = Stadium;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class AudioManager {
        constructor() {
            this.bgm = new Audio();
            this.bgm.src = 'https://files.catbox.moe/sp2yhy.mp3';
            this.bgm.loop = true;
            this.bgm.volume = 0.5;
            this.isMuted = false;
            this.hasInteracted = false;
            this.shouldBePlaying = false; // Intent flag

            // Preload
            this.bgm.load();

            // --- HERCULEAN LOOP ENFORCEMENT ---
            // 1. Manual Loop Redundancy
            this.bgm.addEventListener('ended', () => {
                console.log("AudioManager: BGM ended event caught. Forcing manual loop reset.");
                this.bgm.currentTime = 0;
                if (this.shouldBePlaying && !this.isMuted) {
                    const p = this.bgm.play();
                    if (p !== undefined) p.catch(e => console.warn("Manual loop replay failed:", e));
                }
            });

            // 2. Pause Watchdog (If paused but should be playing, FORCE PLAY)
            this.bgm.addEventListener('pause', () => {
                if (this.shouldBePlaying && !this.isMuted) {
                    // Small timeout to allow intentional operations to finish if any
                    setTimeout(() => {
                        if (this.shouldBePlaying && this.bgm.paused) {
                            console.log("AudioManager: Unexpected pause detected. Attempting resume.");
                            this.bgm.play().catch(e => console.warn("Resume failed:", e));
                        }
                    }, 100);
                }
            });

            // 3. Periodic Watchdog (The "Never Stop" Guarantee)
            setInterval(() => this._watchdog(), 1000);
        }

        _watchdog() {
            if (this.shouldBePlaying && !this.isMuted) {
                if (this.bgm.paused || this.bgm.ended) {
                    console.log("AudioManager: Watchdog forcing play.");
                    this.bgm.play().catch(() => {
                        // Silent catch, likely waiting for interaction
                    });
                }
            }
        }

        playBGM() {
            if (this.isMuted) return;
            this.shouldBePlaying = true;
            
            const playPromise = this.bgm.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log("AudioManager: Autoplay prevented. Engaging interaction lock.");
                    this._waitForInteraction();
                });
            }
        }

        _waitForInteraction() {
            if (this._waitingForInteraction) return;
            this._waitingForInteraction = true;
            
            const onInteract = () => {
                this.hasInteracted = true;
                
                // Try to play
                if (this.shouldBePlaying && !this.isMuted) {
                    this.bgm.play().then(() => {
                        // Success! Detach listeners
                        this._waitingForInteraction = false;
                        this._removeInteractionListeners(onInteract);
                        console.log("AudioManager: Audio unlocked successfully.");
                    }).catch(e => {
                        console.warn("AudioManager: Interaction play failed. Keeping listeners attached.", e);
                        // Do NOT detach listeners, wait for next interaction
                    });
                } else {
                    // Not supposed to play? Just detach.
                    this._waitingForInteraction = false;
                    this._removeInteractionListeners(onInteract);
                }
            };
            
            // Use capture to catch it early, but don't use 'once: true' so we can retry if failed
            const opts = { capture: true, passive: true };
            document.addEventListener('click', onInteract, opts);
            document.addEventListener('touchstart', onInteract, opts);
            document.addEventListener('keydown', onInteract, opts);
            document.addEventListener('mousedown', onInteract, opts);
        }

        _removeInteractionListeners(handler) {
            const opts = { capture: true, passive: true };
            document.removeEventListener('click', handler, opts);
            document.removeEventListener('touchstart', handler, opts);
            document.removeEventListener('keydown', handler, opts);
            document.removeEventListener('mousedown', handler, opts);
        }

        stopBGM() {
            this.shouldBePlaying = false;
            this.bgm.pause();
            this.bgm.currentTime = 0;
        }

        pauseBGM() {
            this.shouldBePlaying = false;
            this.bgm.pause();
        }

        resumeBGM() {
            if (!this.isMuted) {
                this.playBGM();
            }
        }

        setVolume(volume) {
            this.bgm.volume = Math.max(0, Math.min(1, volume));
        }

        toggleMute() {
            this.isMuted = !this.isMuted;
            if (this.isMuted) {
                this.shouldBePlaying = false;
                this.bgm.pause();
            } else {
                this.playBGM();
            }
            return this.isMuted;
        }
    }

    window.flux.AudioManager = AudioManager;
})();</script>
    <script>(function() {
    // Namespace
    window.flux = window.flux || {};
    window.flux._runtimeUpdaters = window.flux._runtimeUpdaters || [];

    // Config
const _config = {
        internalWidth: 360,
        internalHeight: 640,
        bgColor: 0x001e36,
        fogColor: 0x001e36,
        fogDensity: 0.0001, // Drastically reduced to ensure visibility
        arenaRadius: 48.0
    };

    // Globals
// Globals
    const _input = { x: 0, y: 0 }; // Input state
    
    // Shader Uniforms
    const _arenaUniforms = {
        uTime: { value: 0 },
        uImpactPos: { value: new THREE.Vector3() },
        uImpactStr: { value: 0.0 }
    };
    const _particleUniforms = {
        uTime: { value: 0 }
    };

    // Expose Impact Trigger
    window.flux.triggerArenaImpact = function(pos, strength) {
        _arenaUniforms.uImpactPos.value.copy(pos);
        _arenaUniforms.uImpactStr.value = strength * 2.0; // Scale up for visibility
    };
// _input already declared above
    const _tempVec1 = new THREE.Vector3(); // Reusable for physics/logic
    const _tempVec2 = new THREE.Vector3(); // Reusable for physics/logic
    let _scene, _camera, _renderer, _clock;
    let _homeTeam, _awayTeam;
    let _ball;
    let _gameManager;
    let _menuManager;
    let _audioManager;

    let _cameraManager;
    let _waterOverlay;
    let _lightShafts;
    let _stadium;
    let _glyphManager;

    // IMPROVED: Settings object
    const _settings = {
        joystickSensitivity: 1.0,
        aimAssist: true,
        cameraShake: true,
        hitStop: true,
        invertCamera: false,
        autoRecenter: true
    };

    // ---------------------------------------------------------------------
    // Debug IO Bridge (exposed for DevTools JSON snapshots)
    // ---------------------------------------------------------------------
    const _debugIO = window.flux._debugIO = window.flux._debugIO || {};
    _debugIO.settings = _settings;
    _debugIO.input = _debugIO.input || {};
    _debugIO.perf = _debugIO.perf || { frame: 0, rawDt: 0, dt: 0, fps: 0, avgFps: 0 };


    // ---------------------------------------------------------------------
    // Touch helpers (multi-touch safe)
    // ---------------------------------------------------------------------
    function _findTouchById(touchList, id) {
        if (id === null || id === undefined) return null;
        if (!touchList) return null;
        for (let i = 0; i < touchList.length; i++) {
            const t = touchList[i];
            if (t && t.identifier === id) return t;
        }
        return null;
    }

    function _endedTouchById(changedTouches, id) {
        if (id === null || id === undefined) return null;
        if (!changedTouches) return null;
        for (let i = 0; i < changedTouches.length; i++) {
            const t = changedTouches[i];
            if (t && t.identifier === id) return t;
        }
        return null;
    }


    function init() {
        _container = document.getElementById('game-container');

        // 1. Scene
        _scene = new THREE.Scene();
        _scene.background = new THREE.Color(_config.bgColor);
        _scene.fog = new THREE.FogExp2(_config.fogColor, _config.fogDensity);

        // 2. Camera
        const aspect = _config.internalWidth / _config.internalHeight;
_camera = new THREE.PerspectiveCamera(60, aspect, 0.1, 500);
_camera.position.set(0, 14, 22);
        _camera.lookAt(0, 0, 0);
        _scene.add(_camera); // Ensure camera is in scene for children to render

        // 3. Renderer
// 3. Renderer
        _renderer = new THREE.WebGLRenderer({ 
            antialias: false,
            powerPreference: "high-performance",
            precision: "mediump", // Mobile optimization: faster shaders
            stencil: false,       // Disable stencil buffer if not used
            depth: true
        });
        _renderer.setPixelRatio(1); // Force 1:1 pixel ratio, we handle scaling via setSize
        _renderer.autoClear = false; // We manage clearing via background or manual calls if needed (though scene.background handles color)
        // Expose renderer for DevTools
        if (_gameManager) _gameManager.renderer = _renderer; 
        else window.flux.gameInstance = { renderer: _renderer }; // Temp hook
_container.appendChild(_renderer.domElement);

// --- Video Overlay Enforcement ---
        // --- Overlay Video Logic Removed (Switched to GIF) ---
        // 5. Environment
        createParticles();
        createArena();
createArena();
        createHolographicRings();
// 5.5 Game Manager
_gameManager = new window.flux.GameManager(_scene, 'ui-layer', _camera, _renderer);
        
        // 5.5.1 Audio Manager
        _audioManager = new window.flux.AudioManager();
        _gameManager.audioManager = _audioManager;

        // 5.6 Camera Manager
        _cameraManager = new window.flux.CameraManager(_camera, _scene);
        _gameManager.cameraManager = _cameraManager;

        // 5.7 Dev Tools
if (window.flux.DevTools) {
            new window.flux.DevTools(_gameManager);
        }
// 5.8 Water Overlay, Light Shafts, Stadium, Glyphs
        _waterOverlay = new window.flux.WaterOverlay(_camera);
        _lightShafts = new window.flux.LightShafts(_scene);
        _stadium = new window.flux.Stadium(_scene);
        _glyphManager = new window.flux.GlyphManager(_scene);
        
if (_gameManager) {
            _gameManager.glyphManager = _glyphManager;
            _gameManager.waterOverlay = _waterOverlay;
            _gameManager.lightShafts = _lightShafts;
            _gameManager.stadium = _stadium;
        }
        // 6. Teams Setup
        _homeTeam = new window.flux.Team(_scene, 'home', 1, 0x00aaff, true);
        _awayTeam = new window.flux.Team(_scene, 'away', -1, 0xff6666, false);

        // 7. Ball
        _ball = new window.flux.Ball(_scene);

        // IMPROVED: Link ball to camera for smart framing
        _cameraManager.setBall(_ball);

        // 8. Team Roster Models
        const roles = ['LF', 'RF', 'MF', 'LD', 'RD', 'GL'];
        const homeRoster = {
            LF: { name: 'Tidus', url: 'https://cdn.tinyglb.com/models/da788bef258c4f0b8d9ef1acc19c5567.glb' },
            RF: { name: 'Wakka', url: 'https://cdn.tinyglb.com/models/59114c98951647c9b8da74b0bd3636cb.glb' },
            MF: { name: 'Letty', url: 'https://cdn.tinyglb.com/models/43ace34c6fd94215967e842bf909da5e.glb' },
            LD: { name: 'Datto', url: 'https://cdn.tinyglb.com/models/e6d67ecb2e4c4715bd73a40795e1d3d5.glb' },
            RD: { name: 'Jassu', url: 'https://cdn.tinyglb.com/models/8216459567354e63958d4108d828de98.glb' },
            GL: { name: 'Botta', url: 'https://cdn.tinyglb.com/models/ad155efedc0d48fdad09da3e1cae9c97.glb' }
        };

const applyStats = (p, role, isHome) => {
const teamLevel = isHome ? 25 : 8; // Nerfed CPU level significantly (was 15)
            window.flux.Team.generateStats(p, role, teamLevel, isHome);

            if (p.characterName.includes('Tidus')) {
                p.stats.SH += 5;
                p.stats.SP += 3;
            } else if (p.characterName.includes('Wakka')) {
                p.stats.SH += 3;
                p.stats.EN += 5;
            } else if (p.characterName.includes('Brother')) {
                p.stats.SP = 99;
            }

            p._updateDerivedStats();
        };

        let homeLoaded = 0;
        const roleGltfs = {};

        const finalizeTeams = () => {
            roles.forEach(role => {
                const gltf = roleGltfs[role] || roleGltfs.LF;

                const p = (role === 'GL')
                    ? new window.flux.Goalie(_scene, role)
                    : new window.flux.AIPlayer(_scene, role);

                const entry = homeRoster[role];
                p.characterName = entry ? `CPU ${entry.name}` : 'CPU';
                applyStats(p, role, false);

                if (gltf && gltf.scene) {
                    const clone = THREE.SkeletonUtils.clone(gltf.scene);
                    p.setMesh(clone, gltf.animations || []);
                } else {
                    console.warn('Missing GLTF for away role:', role);
                }

                _awayTeam.addPlayer(p);
            });

            const allPlayers = [..._homeTeam.players, ..._awayTeam.players];
            allPlayers.forEach(p => {
                if (p.ballRef === null) p.ballRef = _ball;
            });

            _homeTeam.activePlayer = _homeTeam.players.find(p => p.role === 'MF');

            if (_homeTeam.activePlayer) {
                _homeTeam.activePlayer.techs.tackle = 'venom';
                _homeTeam.activePlayer.techs.shoot = 'sphere';
                console.log('Equipped Home MF with Venom Tackle & Sphere Shot');
            }

const awayMF = _awayTeam.players.find(p => p.role === 'MF');
            // Removed guaranteed Wither tackle for Away MF to reduce difficulty
            _awayTeam.setFormation('Counter');

            const awayGL = _awayTeam.players.find(p => p.role === 'GL');
            // Removed guaranteed Super Goalie for Away GL to make scoring easier

            _homeTeam.assignMarks(_awayTeam);
            _awayTeam.assignMarks(_homeTeam);

            document.getElementById('loading').style.display = 'none';
            if (_gameManager) {
                _gameManager.registerTeams(_homeTeam, _awayTeam, _ball);

                _menuManager = new window.flux.MenuManager(_gameManager);
                _menuManager.show();
            }
        };

roles.forEach(role => {
            const entry = homeRoster[role];
            if (!entry) return;

            const onComplete = () => {
                homeLoaded++;
                if (homeLoaded >= roles.length) {
                    finalizeTeams();
                }
            };

            window.flux.AssetLoader.loadModel(entry.url, (gltf) => {
                roleGltfs[role] = gltf;

                const p = (role === 'GL')
                    ? new window.flux.Goalie(_scene, role)
                    : new window.flux.AIPlayer(_scene, role);

                p.characterName = entry.name;
                applyStats(p, role, true);

                const clone = THREE.SkeletonUtils.clone(gltf.scene);
                p.setMesh(clone, gltf.animations);
                _homeTeam.addPlayer(p);

                onComplete();
            }, undefined, (err) => {
                console.error('Failed to load model', entry.name, entry.url, err);
                
                // Fallback Mesh (Red Box)
                const fallbackGeo = new THREE.BoxGeometry(1, 2, 1);
                const fallbackMat = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true });
                const fallbackMesh = new THREE.Mesh(fallbackGeo, fallbackMat);
                
                // Store dummy in roleGltfs for away team cloning
                roleGltfs[role] = { scene: fallbackMesh, animations: [] };

                const p = (role === 'GL')
                    ? new window.flux.Goalie(_scene, role)
                    : new window.flux.AIPlayer(_scene, role);

                p.characterName = entry.name + " (Error)";
                applyStats(p, role, true);
                
                p.setMesh(fallbackMesh.clone(), []);
                _homeTeam.addPlayer(p);

                onComplete();
            });
        });

        // 8. Input
        setupInputs();

        // 9. Loop
        _clock = new THREE.Clock();
        requestAnimationFrame(animate);

        // Handle resize
        window.addEventListener('resize', onResize);
        onResize();
    }

function createParticles() {
        const count = 1500; // Increased count
        const geometry = new THREE.BufferGeometry();
        const vertices = [];
        const offsets = []; // Random offsets for independent bobbing

        for (let i = 0; i < count; i++) {
            vertices.push(
                (Math.random() - 0.5) * 80, // Wider spread X
                (Math.random() - 0.5) * 50, // Wider spread Y
                (Math.random() - 0.5) * 80  // Wider spread Z
            );
            offsets.push(Math.random() * 100);
        }

        geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
        geometry.setAttribute('aOffset', new THREE.Float32BufferAttribute(offsets, 1));

        const material = new THREE.ShaderMaterial({
            uniforms: _particleUniforms,
            transparent: true,
            depthWrite: false,
            blending: THREE.AdditiveBlending,
vertexShader: `
                uniform float uTime;
                attribute float aOffset;
                varying float vAlpha;
                void main() {
                    vec3 pos = position;
                    // Bobbing motion: Sine wave based on time + random offset
                    float bob = sin(uTime * 0.5 + aOffset) * 2.0;
                    pos.y += bob;
                    
                    vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
                    gl_Position = projectionMatrix * mvPosition;
                    
                    // Size attenuation - Small and shimmery
                    float sizeBase = 2.0 + sin(uTime * 3.0 + aOffset) * 1.0; 
                    gl_PointSize = sizeBase * (20.0 / -mvPosition.z);
                    
                    // Fade based on distance/height
                    vAlpha = 0.5 + 0.5 * sin(uTime * 2.0 + aOffset);
                }
            `,
            fragmentShader: `
                varying float vAlpha;
                void main() {
                    // Soft glow particle (Dust mote)
                    vec2 coord = gl_PointCoord - vec2(0.5);
                    float dist = length(coord);
                    if(dist > 0.5) discard;
                    
                    // Soft falloff for shimmer
                    float strength = 1.0 - (dist * 2.0);
                    strength = pow(strength, 2.0);
                    
                    // Cyan/Blue tint, additive feel
                    gl_FragColor = vec4(0.7, 0.9, 1.0, vAlpha * strength * 0.8);
                }
            `
        });

        const points = new THREE.Points(geometry, material);
        points.frustumCulled = false;
        _scene.add(points);
    }

function createArena() {
        // Group for rotation
        window.flux.arenaGroup = new THREE.Group();
        _scene.add(window.flux.arenaGroup);

        const geometry = new THREE.SphereGeometry(_config.arenaRadius, 32, 32);
        
        // --- 1. Base Sphere (Faint Grid) ---
        const texLoader = new THREE.TextureLoader();
        const arenaTex = texLoader.load('https://i.postimg.cc/W1LsH68Q/file-0000000023ec71f596593829e8118760-(1).png');
        arenaTex.magFilter = THREE.NearestFilter;
        arenaTex.minFilter = THREE.NearestFilter;
        arenaTex.wrapS = THREE.RepeatWrapping;
        arenaTex.wrapT = THREE.RepeatWrapping;
        arenaTex.repeat.set(6, 4);

        const material = new THREE.MeshBasicMaterial({
            map: arenaTex,
            color: 0x446688,
            wireframe: false,
            transparent: true,
            opacity: 0.15, 
            blending: THREE.AdditiveBlending,
            side: THREE.BackSide,
            depthWrite: false
        });
            
        const arena = new THREE.Mesh(geometry, material);
        window.flux.arenaGroup.add(arena);
        window.flux.arenaMesh = arena;

        // --- 2. Inner Hex Grid (Warp Effect) ---
        // Reuse existing hex generation logic but attach to group
        const hexTex = (() => {
            const c = document.createElement('canvas');
            c.width = 512; c.height = 512;
            const ctx = c.getContext('2d');
            ctx.clearRect(0,0,512,512);
            ctx.strokeStyle = 'rgba(0, 255, 255, 0.5)';
            ctx.lineWidth = 2;
            const r = 64;
            const w = r * 2;
            const h = Math.sqrt(3) * r;
            for(let y = -1; y < 512/h + 2; y++) {
                for(let x = -1; x < 512/(w*0.75) + 2; x++) {
                    const cx = x * w * 0.75;
                    const cy = y * h + (x%2===0 ? 0 : h/2);
                    ctx.beginPath();
                    for(let i=0; i<6; i++) {
                        const ang = Math.PI/3 * i;
                        ctx.lineTo(cx + Math.cos(ang)*r, cy + Math.sin(ang)*r);
                    }
                    ctx.closePath();
                    ctx.stroke();
                }
            }
            return new THREE.CanvasTexture(c);
        })();
        hexTex.wrapS = THREE.RepeatWrapping;
        hexTex.wrapT = THREE.RepeatWrapping;
        hexTex.repeat.set(4, 2);

        const arenaUniforms = THREE.UniformsUtils.merge([
            THREE.UniformsLib['common'],
            _arenaUniforms,
            { 
                tMap: { value: hexTex },
                uOpacity: { value: 0.1 } 
            }
        ]);

        const material2 = new THREE.ShaderMaterial({
            uniforms: arenaUniforms,
            transparent: true,
            side: THREE.BackSide,
            blending: THREE.AdditiveBlending,
            depthWrite: false,
            vertexShader: `
                uniform float uTime;
                uniform vec3 uImpactPos;
                uniform float uImpactStr;
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    vec3 pos = position;
                    float dist = distance(pos, uImpactPos);
                    float radius = 20.0;
                    if (dist < radius) {
                        float t = dist / radius;
                        float bulge = (1.0 - t) * (1.0 - t);
                        vec3 normal = normalize(pos);
                        pos += normal * (bulge * uImpactStr);
                    }
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
                }
            `,
            fragmentShader: `
                uniform sampler2D tMap;
                uniform float uImpactStr;
                uniform float uOpacity;
                varying vec2 vUv;
                void main() {
                    vec4 texColor = texture2D(tMap, vUv);
                    float alpha = uOpacity * texColor.a;
                    alpha += uImpactStr * 0.02; 
                    vec3 color = texColor.rgb * vec3(0.2, 0.8, 1.0);
                    gl_FragColor = vec4(color, alpha);
                }
            `
        });

        const arena2 = new THREE.Mesh(geometry, material2);
        arena2.scale.setScalar(0.98);
        window.flux.arenaGroup.add(arena2);
        window.flux.arenaMesh2 = arena2;

        // --- 3. TRIBAL STRIP (Equator) ---
        const tribalTex = (() => {
            const c = document.createElement('canvas');
            c.width = 1024; c.height = 128;
            const ctx = c.getContext('2d');
            ctx.clearRect(0,0,1024,128);
            
            // Background Pattern
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.fillRect(0, 10, 1024, 108);

            // Detailed Tribal Glyphs
            ctx.fillStyle = '#ffffff';
            const blockW = 64;
            for(let x=0; x<1024; x+=blockW) {
                // Outer Box
                ctx.fillRect(x+4, 15, blockW-8, 98);
                // Inner Cut
                ctx.clearRect(x+12, 25, blockW-24, 78);
                // Center Dot
                ctx.fillRect(x+28, 50, 8, 28);
                // Connectors
                ctx.fillRect(x, 60, 12, 8);
                ctx.fillRect(x+blockW-12, 60, 12, 8);
            }
            return new THREE.CanvasTexture(c);
        })();
        tribalTex.wrapS = THREE.RepeatWrapping;
        tribalTex.wrapT = THREE.ClampToEdgeWrapping;
        tribalTex.repeat.set(4, 1);

        // Custom Shader for Color Shifting
        window.flux.tribalUniforms = {
            uTime: { value: 0 },
            uColor: { value: new THREE.Color(0x00ffff) }, // Default Cyan
            tTex: { value: tribalTex }
        };

        const tribalMat = new THREE.ShaderMaterial({
            uniforms: window.flux.tribalUniforms,
            transparent: true,
            side: THREE.DoubleSide,
            blending: THREE.AdditiveBlending,
            depthWrite: false,
            vertexShader: `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,
            fragmentShader: `
                uniform float uTime;
                uniform vec3 uColor;
                uniform sampler2D tTex;
                varying vec2 vUv;
                void main() {
                    vec4 tex = texture2D(tTex, vec2(vUv.x * 2.0 + uTime * 0.05, vUv.y));
                    float alpha = tex.a * 0.8;
                    // Pulse
                    float pulse = 0.8 + 0.2 * sin(uTime * 2.0 + vUv.x * 10.0);
                    gl_FragColor = vec4(uColor * pulse, alpha);
                }
            `
        });

        const tribalGeo = new THREE.CylinderGeometry(_config.arenaRadius * 0.95, _config.arenaRadius * 0.95, 12, 64, 1, true);
        const tribalMesh = new THREE.Mesh(tribalGeo, tribalMat);
        tribalMesh.rotation.x = 0; // Upright cylinder matches sphere equator
        window.flux.arenaGroup.add(tribalMesh);

        // --- 4. HOOKED ARROWS (Above/Below Strip) ---
        const arrowTex = (() => {
            const c = document.createElement('canvas');
            c.width = 512; c.height = 64;
            const ctx = c.getContext('2d');
            ctx.clearRect(0,0,512,64);
            
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.shadowBlur = 5;
            ctx.shadowColor = '#ffffff';

            const step = 64;
            for(let x=0; x<512; x+=step) {
                // Double Hook Arrow
                ctx.beginPath();
                // Top Hook
                ctx.moveTo(x+20, 10); ctx.lineTo(x+32, 20); ctx.lineTo(x+44, 10);
                // Shaft
                ctx.moveTo(x+32, 20); ctx.lineTo(x+32, 44);
                // Bottom Hook
                ctx.moveTo(x+20, 54); ctx.lineTo(x+32, 44); ctx.lineTo(x+44, 54);
                ctx.stroke();
            }
            return new THREE.CanvasTexture(c);
        })();
        arrowTex.wrapS = THREE.RepeatWrapping;
        arrowTex.repeat.set(4, 1);

        const arrowMat = new THREE.MeshBasicMaterial({
            map: arrowTex,
            color: 0x00ffff,
            transparent: true,
            opacity: 0.6,
            blending: THREE.AdditiveBlending,
            side: THREE.DoubleSide,
            depthWrite: false
        });

        // Top Ring
        const arrowGeoTop = new THREE.CylinderGeometry(_config.arenaRadius * 0.92, _config.arenaRadius * 0.92, 8, 64, 1, true);
        const arrowMeshTop = new THREE.Mesh(arrowGeoTop, arrowMat);
        arrowMeshTop.position.y = 12;
        window.flux.arenaGroup.add(arrowMeshTop);

        // Bottom Ring
        const arrowMeshBot = new THREE.Mesh(arrowGeoTop, arrowMat);
        arrowMeshBot.position.y = -12;
        window.flux.arenaGroup.add(arrowMeshBot);

        // --- 5. TOP GLYPHS (Dome) ---
        const topGlyphTex = (() => {
            const c = document.createElement('canvas');
            c.width = 512; c.height = 512;
            const ctx = c.getContext('2d');
            ctx.clearRect(0,0,512,512);
            
            ctx.strokeStyle = 'rgba(100, 200, 255, 0.5)';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(256, 256, 200, 0, Math.PI*2);
            ctx.stroke();
            
            // Intricate pattern
            for(let i=0; i<8; i++) {
                const a = (i/8)*Math.PI*2;
                const x = 256 + Math.cos(a)*150;
                const y = 256 + Math.sin(a)*150;
                ctx.beginPath();
                ctx.arc(x, y, 40, 0, Math.PI*2);
                ctx.stroke();
                // Connector
                ctx.beginPath();
                ctx.moveTo(256, 256);
                ctx.lineTo(x, y);
                ctx.stroke();
            }
            return new THREE.CanvasTexture(c);
        })();

        const topGlyphMat = new THREE.MeshBasicMaterial({
            map: topGlyphTex,
            transparent: true,
            opacity: 0.4,
            blending: THREE.AdditiveBlending,
            side: THREE.DoubleSide,
            depthWrite: false
        });

        const topGlyphGeo = new THREE.PlaneGeometry(60, 60);
        const topGlyph = new THREE.Mesh(topGlyphGeo, topGlyphMat);
        topGlyph.rotation.x = -Math.PI / 2;
        topGlyph.position.y = 35; // Near top of dome
        window.flux.arenaGroup.add(topGlyph);

        // --- NEW: FFX GOAL MODELS ---
        const goalUrl = 'https://cdn.tinyglb.com/models/a516bd90fa7c4dedb5dcbfdf803f13d5.glb';
        
        const onGoalLoaded = (model, isFallback) => {
            const goalA = model;
            // Moved down ~15ft (4.5m) total as requested, pushed back to edge
            goalA.position.set(0, -4.5, -46);
            
            if (!isFallback) {
                goalA.scale.setScalar(54.0); // Increased 50% (was 36.0)
            }
            // Setup Goal A
            goalA.traverse(c => {
                if(c.isMesh) {
                    c.frustumCulled = false; // CRITICAL: Prevent culling
                    c.renderOrder = 0;
                    
                    // Ensure material is visible
                    if (c.material) {
                        c.material.color.setHex(0xffffff); // White to show original texture/colors (was blue)
                        c.material.transparent = false;
                        c.material.opacity = 1.0;
                        c.material.side = THREE.DoubleSide;
                        c.material.depthWrite = true;
                        c.material.depthTest = true;
                    }
                }
            });
            // Add goals to SCENE, not arenaGroup (they shouldn't rotate with the sphere)
            _scene.add(goalA);

            // Setup Goal B
            const goalB = isFallback ? goalA.clone() : THREE.SkeletonUtils.clone(goalA);

            goalB.position.set(0, -4.5, 46); // Moved closer (was 45) and down
            goalB.rotation.y = Math.PI;
            // Ensure Goal B meshes are also persistent
            goalB.traverse(c => {
                if(c.isMesh) c.frustumCulled = false;
            });

            _scene.add(goalB);
        };

        window.flux.AssetLoader.loadModel(goalUrl, (gltf) => {
            onGoalLoaded(gltf.scene, false);
        }, undefined, (err) => {
            console.warn("Goal model failed to load. Using fallback.", err);
            const geo = new THREE.BoxGeometry(75, 45, 10); // Fallback massive box (Scaled 1.5x)
            const fallbackMat = new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true });
            const fallback = new THREE.Mesh(geo, fallbackMat);
            onGoalLoaded(fallback, true);
        });

        // --- NEW: MASSIVE FIELD MARKINGS ---
        createFieldMarkings();
    }

function createFieldMarkings() {
        const size = 1024;
        const c = document.createElement('canvas');
        c.width = size; c.height = size;
        const ctx = c.getContext('2d');
        const cx = size/2; const cy = size/2;

        const draw = () => {
            ctx.clearRect(0, 0, size, size);

            // Glow Settings
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#00ffff';
            ctx.strokeStyle = 'rgba(100, 255, 255, 0.9)';
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';

            // 1. Outer Runic Ring
            ctx.beginPath();
            ctx.arc(cx, cy, 480, 0, Math.PI*2);
            ctx.stroke();

            // 2. Complex Geometric Star (The "Cool Big Glyph")
            ctx.save();
            ctx.translate(cx, cy);
            
            // Layer A: 3 Overlapping Squares (12 points)
            ctx.strokeStyle = 'rgba(0, 200, 255, 0.6)';
            ctx.lineWidth = 2;
            for(let i=0; i<3; i++) {
                ctx.rotate(Math.PI / 6);
                ctx.strokeRect(-350, -350, 700, 700);
            }
            
            // Layer B: Inner Circles
            ctx.strokeStyle = 'rgba(100, 255, 255, 0.8)';
            ctx.lineWidth = 5;
            ctx.beginPath(); ctx.arc(0, 0, 320, 0, Math.PI*2); ctx.stroke();
            ctx.beginPath(); ctx.arc(0, 0, 100, 0, Math.PI*2); ctx.stroke();

            // Layer C: Central Emblem (Blitzball-ish)
            ctx.beginPath();
            ctx.moveTo(0, -80); ctx.lineTo(60, 40); ctx.lineTo(-60, 40); ctx.closePath();
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(0, 80); ctx.lineTo(-60, -40); ctx.lineTo(60, -40); ctx.closePath();
            ctx.stroke();

            ctx.restore();

            // 3. Midfield Line
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, cy); ctx.lineTo(size, cy);
            ctx.stroke();

            // 4. Goal Boxes (Trapezoids)
            const drawGoalBox = (yPos, dir) => {
                ctx.beginPath();
                ctx.moveTo(cx - 150, yPos);
                ctx.lineTo(cx + 150, yPos);
                ctx.lineTo(cx + 225, yPos + (dir * 120));
                ctx.lineTo(cx - 225, yPos + (dir * 120));
                ctx.closePath();
                ctx.stroke();
            };
            drawGoalBox(50, 1); // Top
            drawGoalBox(size-50, -1); // Bottom

            // 5. Runes Text Ring
            ctx.font = '36px Spira, monospace'; 
            ctx.fillStyle = 'rgba(0, 255, 255, 0.8)';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            const runes = "YEVON SIN ZANARKAND ETERNAL CALM SPHERE POOL BLITZ ACE ";
            const runeCount = 40;
            for(let i=0; i<runeCount; i++) {
                const angle = (i / runeCount) * Math.PI * 2;
                const r = 440;
                const x = cx + Math.cos(angle) * r;
                const y = cy + Math.sin(angle) * r;
                
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(angle + Math.PI/2);
                const char = runes[i % runes.length];
                ctx.fillText(char, 0, 0);
                ctx.restore();
            }
        };

        // Attempt to load font first
        document.fonts.load('36px Spira').then(() => {
            draw();
        }).catch(() => {
            draw();
        });

        const tex = new THREE.CanvasTexture(c);
        tex.anisotropy = 16;

        // Floor Plane (Deep)
        const geo = new THREE.PlaneGeometry(90, 90);
        const mat = new THREE.MeshBasicMaterial({
            map: tex,
            transparent: true,
            opacity: 0.9,
            side: THREE.DoubleSide,
            depthWrite: false,
            blending: THREE.AdditiveBlending
        });

        const field = new THREE.Mesh(geo, mat);
        field.rotation.x = -Math.PI / 2;
        field.position.y = -8.0; // Sunk deep
        _scene.add(field);
    }

function createHolographicRings() {
        // Floating Holographic Rings (Mid-height)
        const ringGeo = new THREE.TorusGeometry(20, 0.1, 16, 100);
        const ringMat = new THREE.MeshBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0.3, blending: THREE.AdditiveBlending });
        const ring1 = new THREE.Mesh(ringGeo, ringMat);
        ring1.rotation.x = Math.PI / 2;
        ring1.position.y = 0;
        _scene.add(ring1);
        
        const ring2 = new THREE.Mesh(ringGeo, ringMat);
        ring2.rotation.x = Math.PI / 2;
        ring2.scale.setScalar(1.2);
        ring2.position.y = 4.0;
        _scene.add(ring2);

        // Animate Rings (integrated into main loop to avoid a second RAF on mobile)
        let _ringTime = 0;
        const _ringUpdate = (dt) => {
            _ringTime += dt;
            if (ring1) {
                ring1.rotation.z += dt * 0.9;
                ring1.scale.setScalar(1.0 + Math.sin(_ringTime * 0.5) * 0.05);
            }
            if (ring2) {
                ring2.rotation.z -= dt * 0.75;
                ring2.position.y = 4.0 + Math.cos(_ringTime * 0.7) * 1.0;
            }
        };
        if (window.flux && window.flux._runtimeUpdaters) window.flux._runtimeUpdaters.push(_ringUpdate);
    }

    // --- INPUT SYSTEM ---
// --- INPUT SYSTEM ---
const _keys = {};
// Globals moved to below helper

    // Helper: Analyze curve geometry for analog control
    const analyzeSwipeCurve = (points) => {
        if (points.length < 3) return { intensity: 0, speed: 0, dx: 0, dy: 0 };
        
        const pStart = points[0];
        const pEnd = points[points.length - 1];
        const midIdx = Math.floor(points.length / 2);
        const pMid = points[midIdx];

        const dx = pEnd.x - pStart.x;
        const dy = pEnd.y - pStart.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        const dt = pEnd.t - pStart.t;
        const speed = (dt > 0) ? dist / dt : 0; // px/ms

        if (dist < 50) return { intensity: 0, speed: speed, dx, dy };

        const vSM_x = pMid.x - pStart.x;
        const vSM_y = pMid.y - pStart.y;

        // Cross product gives signed area/curvature direction
        const cross = (dx * vSM_y) - (dy * vSM_x);
        // Normalize by distance squared to get a curvature ratio independent of scale
const intensity = cross / (dist * dist);

        return { intensity, speed, dx, dy };
    };
    let _swipePoints = []; // Track swipe history for curves
    const _aimInput = { x: 0, y: 0, active: false }; // NEW: Aim joystick

    const _actionBuffer = { active: false, timestamp: 0, duration: 300 };

    const _camFwd = new THREE.Vector3();
    const _camRight = new THREE.Vector3();
    const _upAxis = new THREE.Vector3(0, 1, 0);

    function setupInputs() {
        // Keyboard
        window.addEventListener('keydown', (e) => {
            _keys[e.key] = true;
            if (e.code === 'Space' && _homeTeam && _homeTeam.activePlayer && _ball) {
                _homeTeam.activePlayer.throwBall(_ball);
            }
            // NEW: Tackle on Shift
            if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') {
                if (_homeTeam && _homeTeam.activePlayer) {
                    const p = _homeTeam.activePlayer;
                    if (!p.hasBall) {
                        p.dash(p.inputVector.x, p.inputVector.z);
                    }
                }
            }
            updateInputVector();
        });
        window.addEventListener('keyup', (e) => { _keys[e.key] = false; updateInputVector(); });

        // --- FLOATING JOYSTICK (Movement) ---
        const hitZone = document.getElementById('joystick-hit-zone');
        const visuals = document.getElementById('joystick-visual-container');
        const base = document.getElementById('joystick-base');
        const knob = document.getElementById('joystick-knob');

        let startX = 0, startY = 0;
        let dragging = false;
        const maxDist = 40;

        let moveTouchId = null;
        const moveDeadzonePx = 6;

        // Expose move joystick state for snapshots
        const _dbg = window.flux._debugIO = window.flux._debugIO || {};
        _dbg.settings = _settings;
        _dbg.input = _dbg.input || {};
        _dbg.input.move = _dbg.input.move || {};
        _dbg.input.move.vector = _input;
        _dbg.input.move.dragging = dragging;
        _dbg.input.move.touchId = moveTouchId;


        const handleStart = (clientX, clientY) => {
            dragging = true;
            startX = clientX;

            if (_dbg && _dbg.input && _dbg.input.move) {
                _dbg.input.move.dragging = dragging;
            }

            startY = clientY;

            visuals.style.display = 'block';
            visuals.style.left = `${clientX}px`;
            visuals.style.top = `${clientY}px`;

            knob.style.transform = `translate(-50%, -50%)`;

            createRipple(clientX, clientY);

            _input.x = 0;
            _input.y = 0;
            updateInputVector();
        };

        const handleMove = (clientX, clientY) => {
            if (!dragging) return;

            let dx = clientX - startX;
            let dy = clientY - startY;

            const dist = Math.sqrt(dx*dx + dy*dy);


            // Deadzone to prevent drift from tiny thumb jitter
            if (dist < moveDeadzonePx) {
                dx = 0;
                dy = 0;
            }

            if (dist > maxDist) {
                dx = (dx / dist) * maxDist;
                dy = (dy / dist) * maxDist;
            }

            knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;

            _input.x = (dx / maxDist) * _settings.joystickSensitivity;
            _input.y = (dy / maxDist) * _settings.joystickSensitivity;
            updateInputVector();
        };

        const handleEnd = () => {
            if (!dragging) return;
            dragging = false;

            moveTouchId = null;

            visuals.style.display = 'none';

            if (_dbg && _dbg.input && _dbg.input.move) {
                _dbg.input.move.dragging = dragging;
                _dbg.input.move.touchId = moveTouchId;
            }


            _input.x = 0;
            _input.y = 0;
            updateInputVector();
        };

        if (hitZone) {
            hitZone.addEventListener('touchstart', (e) => {
                if (e.cancelable) e.preventDefault();
                const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e.touches[0];
                moveTouchId = t ? t.identifier : null;
                if (_dbg && _dbg.input && _dbg.input.move) {
                    _dbg.input.move.touchId = moveTouchId;
                }
                handleStart(t.clientX, t.clientY);
            }, { passive: false });

            window.addEventListener('touchmove', (e) => {
                if (!dragging) return;
                if (e.cancelable) e.preventDefault();
                const t = _findTouchById(e.touches, moveTouchId);
                if (!t) return;
                handleMove(t.clientX, t.clientY);
            }, { passive: false });

            window.addEventListener('touchend', (e) => {
                if (!dragging) return;
                const tEnd = _endedTouchById(e.changedTouches, moveTouchId);
                if (!tEnd) return; // Ignore other fingers lifting
                handleEnd();
            });
            window.addEventListener('touchcancel', (e) => {
                if (!dragging) return;
                const tEnd = _endedTouchById(e.changedTouches, moveTouchId);
                if (!tEnd) return;
                handleEnd();
            });

            hitZone.addEventListener('mousedown', (e) => {
                handleStart(e.clientX, e.clientY);
            });
            window.addEventListener('mousemove', (e) => {
                if (dragging) handleMove(e.clientX, e.clientY);
            });
            window.addEventListener('mouseup', handleEnd);
        }

        // --- NEW: AIM JOYSTICK (Right side) ---
        setupAimJoystick();

        // --- NEW: TACKLE BUTTON ---
        setupTackleButton();

        // Swipe Detection
// Swipe Detection
        let swipeStart = { x: 0, y: 0, t: 0 };
        let swipeTouchId = null;
        
        // Expose swipe/throw gesture state for snapshots
        _dbg.input.swipe = _dbg.input.swipe || {};
        _dbg.input.swipe.start = swipeStart;
        _dbg.input.swipe.touchId = swipeTouchId;
        _dbg.input.swipe.points = _swipePoints;
const onSwipeStart = (x, y) => {
            swipeStart.x = x;
            swipeStart.y = y;
            swipeStart.t = Date.now();
            _swipePoints = [{x, y, t: Date.now()}];
        };

const onSwipeMove = (x, y) => {
            if (_swipePoints.length > 0) {
                _swipePoints.push({x, y, t: Date.now()});
                createSwipeTrailDot(x, y); // Visual Feedback
            }
        };

const onSwipeEnd = (x, y) => {
            if (_swipePoints.length < 2) return;
            _swipePoints.push({x, y, t: Date.now()});

            const { intensity, speed, dx, dy } = analyzeSwipeCurve(_swipePoints);
            const dist = Math.sqrt(dx*dx + dy*dy);

            if (_homeTeam && _homeTeam.activePlayer && _camera) {
                const p = _homeTeam.activePlayer;

                // --- CURVE BALL DETECTION (Immediate Throw) ---
// --- CURVE BALL DETECTION (Immediate Throw) ---
                if (p.hasBall && !p.isThrowing && !p.isCharging) {
                    // Analog Curve Check: Threshold 0.25 requires a deliberate arc (The "Feat")
                    if (Math.abs(intensity) > 0.25 && dist > 100) {
                        _camera.getWorldDirection(_camFwd);
                        _camFwd.y = 0; _camFwd.normalize();
                        _camRight.crossVectors(_camFwd, _upAxis).normalize();

                        const worldX = (_camRight.x * dx) + (_camFwd.x * -dy);
                        const worldZ = (_camRight.z * dx) + (_camFwd.z * -dy);
                        const throwDir = new THREE.Vector3(worldX, 0, worldZ).normalize();

                        // Map intensity to spin - Drastically reduced sensitivity
                        const rawSpin = Math.abs(intensity) * 300.0; 
                        const speedFactor = Math.min(1.5, speed / 1.0);
                        const spinPower = Math.min(400.0, rawSpin * speedFactor);
                        const spinSign = Math.sign(intensity); 
                        const spinVec = new THREE.Vector3(0, spinPower * spinSign, 0);


                        p.setOverrideAim(throwDir.x, throwDir.z);
                        p.throwBall(window.flux.gameInstance.entities.ball, 'SH', 1.0, spinVec);
                        
                        if (window.flux.gameInstance.floatingText) {
                            window.flux.gameInstance.floatingText.spawn("CURVE", p.mesh.position, "tech");
                        }
                        createRipple(x, y);
                        _swipePoints = [];
                        return; 
                    }
                }

                // --- STANDARD DASH / AIM ---
                _camera.getWorldDirection(_camFwd);
                _camFwd.y = 0;
                if (_camFwd.lengthSq() < 0.001) _camFwd.set(0, 0, -1);
                else _camFwd.normalize();

                _camRight.crossVectors(_camFwd, _upAxis).normalize();

const worldX2 = (_camRight.x * dx) + (_camFwd.x * -dy);
                const worldZ2 = (_camRight.z * dx) + (_camFwd.z * -dy);

                if (p.isThrowing) {
p.setOverrideAim(worldX2, worldZ2);
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("AIM!", p.mesh.position, "default");
                    }
                } else {
if (dist > 50) p.dash(worldX2, worldZ2);
                }

                createRipple(x, y);
            }
_swipePoints = [];
        };

        window.addEventListener('touchstart', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;

            const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e.touches[0];
            swipeTouchId = t ? t.identifier : null;
// onSwipeStart(t.clientX, t.clientY); // Fixed syntax error
            if (_dbg && _dbg.input && _dbg.input.swipe) { _dbg.input.swipe.touchId = swipeTouchId; }
            onSwipeStart(t.clientX, t.clientY);
            createRipple(t.clientX, t.clientY);
        }, { passive: false });

window.addEventListener('touchmove', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone')) return;
            const t = _findTouchById(e.touches, swipeTouchId);
            if (!t) return;
            onSwipeMove(t.clientX, t.clientY);
        }, { passive: false });

        window.addEventListener('touchend', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;
            const tEnd = _endedTouchById(e.changedTouches, swipeTouchId);
            if (!tEnd) return; // Ignore other fingers lifting
            onSwipeEnd(tEnd.clientX, tEnd.clientY);
            swipeTouchId = null;
            if (_dbg && _dbg.input && _dbg.input.swipe) { _dbg.input.swipe.touchId = swipeTouchId; }
        });

                window.addEventListener('touchcancel', (e) => {
if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;
            const tEnd = _endedTouchById(e.changedTouches, swipeTouchId);
            if (!tEnd) return; // Ignore other fingers lifting
            onSwipeEnd(tEnd.clientX, tEnd.clientY);
            swipeTouchId = null;
            if (_dbg && _dbg.input && _dbg.input.swipe) { _dbg.input.swipe.touchId = swipeTouchId; }
        
        });
// Mouse Swipe
        window.addEventListener('mousedown', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;

            onSwipeStart(e.clientX, e.clientY);
            createRipple(e.clientX, e.clientY);
        });

        window.addEventListener('mousemove', (e) => {
             if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone')) return;
            // Only track if mouse is down (simulating drag)
            if (e.buttons === 1) {
                onSwipeMove(e.clientX, e.clientY);
            }
        });


        window.addEventListener('mouseup', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;
            onSwipeEnd(e.clientX, e.clientY);
        });

        // Action Button (Shoot/Pass)
        const actionBtn = document.getElementById('action-button');

const setupButton = (btn) => {
            if (!btn) return;

            let btnStartX = 0;
            let btnStartY = 0;
            let isDragging = false;
            let swipePoints = [];
            let actionTouchId = null;

            const attemptAction = () => {
                if (!_homeTeam || !_homeTeam.activePlayer) return false;
                const p = _homeTeam.activePlayer;

                if (p.hasBall && !p.isCharging && !p.isThrowing && p.status.nap <= 0) {
                    p.startCharge();
                    btn.classList.add('active');
                    return true;
                }
                return false;
            };

            const handleStart = (e) => {
                if (e.cancelable) e.preventDefault();

                if (_gameManager && _gameManager.techCopyState.active) {
                    _gameManager.attemptTechCopy();
                    btn.classList.add('active');
                    setTimeout(() => btn.classList.remove('active'), 100);
                    return;
                }

                if (_gameManager && _gameManager.isDemoMode) return;

                let clientX = e.clientX;
                let clientY = e.clientY;
                if (e.changedTouches && e.changedTouches.length) {
                    const t = e.changedTouches[0];
                    actionTouchId = t.identifier;
                    clientX = t.clientX;
                    clientY = t.clientY;
                } else {
                    actionTouchId = null; // mouse
                }
                btnStartX = clientX;
                btnStartY = clientY;
                isDragging = true;
                swipePoints = [{x: clientX, y: clientY, t: Date.now()}];

                _actionBuffer.active = true;
                _actionBuffer.timestamp = Date.now();

                if (attemptAction()) {
                    _actionBuffer.active = false;
                }

                // Attach global listeners to track swipe outside button
                window.addEventListener('touchmove', handleMove, { passive: false });
                window.addEventListener('touchend', handleEnd);
                window.addEventListener('touchcancel', handleEnd);
                window.addEventListener('mousemove', handleMove);
                window.addEventListener('mouseup', handleEnd);
            };

            const handleMove = (e) => {
                if (!isDragging) return;

                // Touch path (multi-touch safe)
                if (e.touches && actionTouchId !== null) {
                    const t = _findTouchById(e.touches, actionTouchId);
                    if (!t) return;
                    swipePoints.push({x: t.clientX, y: t.clientY, t: Date.now()});
                    return;
                }

                // Mouse path
                const clientX = e.clientX;
                const clientY = e.clientY;
                swipePoints.push({x: clientX, y: clientY, t: Date.now()});
            };

const handleEnd = (e) => {
                let dx = 0;
                let dy = 0;
                let validEnd = false;

                // 1. Check Touch
                if (e.changedTouches && actionTouchId !== null) {
                    const tEnd = _endedTouchById(e.changedTouches, actionTouchId);
                    if (tEnd) {
                        dx = tEnd.clientX - btnStartX;
                        dy = tEnd.clientY - btnStartY;
                        validEnd = true;
                        actionTouchId = null;
                    }
                } 
                // 2. Check Mouse
                else if (!e.changedTouches && isDragging) {
                    dx = e.clientX - btnStartX;
                    dy = e.clientY - btnStartY;
                    validEnd = true;
                }

                if (!validEnd) return;

                // Cleanup listeners
                window.removeEventListener('touchmove', handleMove);
                window.removeEventListener('touchend', handleEnd);
                window.removeEventListener('touchcancel', handleEnd);
                window.removeEventListener('mousemove', handleMove);
                window.removeEventListener('mouseup', handleEnd);

                if (!isDragging) return;
                isDragging = false;
                
                const wasBuffered = _actionBuffer.active;
                _actionBuffer.active = false;

                if (_homeTeam && _homeTeam.activePlayer) {
                    const p = _homeTeam.activePlayer;
                    
                    // Curve Analysis
                    let curveData = null;
                    let spinVec = null;

                    // Calculate curve if we have enough data
// Calculate curve if we have enough data
                    if (swipePoints.length > 2) {
                        const analysis = analyzeSwipeCurve(swipePoints);
                        // High threshold for button release too
                        if (Math.abs(analysis.intensity) > 0.25) {
                            curveData = analysis;
                            
                            // Calculate spin vector for mouse/touch unified (Conservative values)
                            const spinPower = Math.min(400.0, Math.abs(analysis.intensity) * 1500.0);
                            const spinSign = Math.sign(analysis.intensity);
                            spinVec = new THREE.Vector3(0, spinPower * spinSign, 0);
                        }
}

                    // EXECUTE
                    if (p.isCharging) {
                        // Normal Release
                        if (spinVec) {
                            // Unified spin passing
                            p.releaseCharge(dx, dy, { intensity: curveData.intensity, speed: curveData.speed }); 
                        } else {
                            p.releaseCharge(dx, dy, curveData);
                        }
                        btn.classList.remove('active');
                    } 
                    else if (wasBuffered && p.hasBall && !p.isThrowing && p.status.nap <= 0) {
                        // Buffered Tap (Instant Shot)
                        // Force start and release immediately
                        p.startCharge();
                        p.releaseCharge(dx, dy, curveData);
                        btn.classList.remove('active');
                    }
                }
            };

            btn.addEventListener('touchstart', handleStart, { passive: false });
            btn.addEventListener('mousedown', handleStart);
        };
        setupButton(actionBtn);

// Auto Toggle
        const autoBtn = document.getElementById('auto-toggle');
        if (autoBtn) {
            const handleToggle = () => {
                if (_gameManager) {
                    _gameManager.toggleDemoMode();
                    if (_homeTeam && _homeTeam.activePlayer) {
                        _homeTeam.activePlayer.setInput(0, 0);
                    }
                }
            };

            autoBtn.addEventListener('click', handleToggle);
autoBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleToggle();
            }, { passive: false });
        }

        // NEW: Settings Button
        setupSettingsButton();
    }

    // NEW: Aim Joystick Setup
// NEW: Aim Joystick Setup
function setupAimJoystick() {
        const aimKnob = document.getElementById('aim-joystick-knob');
        const aimVisuals = document.getElementById('aim-joystick-visual');
        const aimZone = document.getElementById('aim-joystick-zone');
        if (!aimZone) return;
        let aimStartX = 0, aimStartY = 0;
        let aimDragging = false;
        const aimMaxDist = 35;
        let aimTouchId = null;

        

        // Expose aim joystick state for snapshots
        const _dbg = window.flux._debugIO = window.flux._debugIO || {};
        _dbg.settings = _settings;
        _dbg.input = _dbg.input || {};
        _dbg.input.aim = _dbg.input.aim || {};
        _dbg.input.aim.vector = _aimInput;
        _dbg.input.aim.dragging = aimDragging;
        _dbg.input.aim.touchId = aimTouchId;
const handleAimStart = (clientX, clientY) => {
            aimDragging = true;
            aimStartX = clientX;

            if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.dragging = aimDragging; }

            aimStartY = clientY;
            _aimInput.active = true;

            if (aimVisuals) {
                aimVisuals.style.display = 'block';
                aimVisuals.style.left = `${clientX}px`;
                aimVisuals.style.top = `${clientY}px`;
            }
            if (aimKnob) {
                aimKnob.style.transform = `translate(-50%, -50%)`;
            }
        };

        const handleAimMove = (clientX, clientY) => {
            if (!aimDragging) return;

            let dx = clientX - aimStartX;
            let dy = clientY - aimStartY;

            const dist = Math.sqrt(dx*dx + dy*dy);

            if (dist > aimMaxDist) {
                dx = (dx / dist) * aimMaxDist;
                dy = (dy / dist) * aimMaxDist;
            }

            if (aimKnob) {
                aimKnob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            }

            // Normalize and transform to world space
            _aimInput.x = dx / aimMaxDist;
            _aimInput.y = dy / aimMaxDist;

            // Apply aim to player if charging
            if (_homeTeam && _homeTeam.activePlayer) {
                const p = _homeTeam.activePlayer;
                if (p.isCharging || p.isThrowing) {
                    // Transform screen aim to world space
                    _camera.getWorldDirection(_camFwd);
                    _camFwd.y = 0;
                    if (_camFwd.lengthSq() < 0.001) _camFwd.set(0, 0, -1);
                    else _camFwd.normalize();
                    _camRight.crossVectors(_camFwd, _upAxis).normalize();

                    const worldX = (_camRight.x * _aimInput.x) + (_camFwd.x * -_aimInput.y);
                    const worldZ = (_camRight.z * _aimInput.x) + (_camFwd.z * -_aimInput.y);

                    if (Math.abs(worldX) > 0.1 || Math.abs(worldZ) > 0.1) {
                        p.setOverrideAim(worldX, worldZ);
                    }
                }
            }
        };

const handleAimEnd = () => {
            if (!aimDragging) return;
            aimDragging = false;
            _aimInput.active = false;
            _aimInput.x = 0;
            _aimInput.y = 0;

            if (aimVisuals) {
                aimVisuals.style.display = 'none';
            }

            // Clear player aim override
            if (_homeTeam && _homeTeam.activePlayer) {
                _homeTeam.activePlayer.overrideAimVector = null;
            }
        };

        aimZone.addEventListener('touchstart', (e) => {
            if (e.cancelable) e.preventDefault();
            const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e.touches[0];
            aimTouchId = t ? t.identifier : null;
            if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.touchId = aimTouchId; }
            handleAimStart(t.clientX, t.clientY);
        }, { passive: false });

        window.addEventListener('touchmove', (e) => {
            if (!aimDragging) return;
            if (e.cancelable) e.preventDefault();
            const t = _findTouchById(e.touches, aimTouchId);
            if (!t) return;
            handleAimMove(t.clientX, t.clientY);
        }, { passive: false });

        window.addEventListener('touchend', (e) => {
            if (!aimDragging) return;
            const tEnd = _endedTouchById(e.changedTouches, aimTouchId);
            if (!tEnd) return;
            aimTouchId = null;
            handleAimEnd();
            if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.touchId = aimTouchId; _dbg.input.aim.dragging = aimDragging; }
            handleAimEnd();
        });

                window.addEventListener('touchcancel', (e) => {
            if (!aimDragging) return;
                        const tEnd = _endedTouchById(e.changedTouches, aimTouchId);
                        if (!tEnd) return;
                        aimTouchId = null;
                        handleAimEnd();
                        if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.touchId = aimTouchId; _dbg.input.aim.dragging = aimDragging; }
                        handleAimEnd();
        });
// Mouse support for desktop testing
        aimZone.addEventListener('mousedown', (e) => {
            handleAimStart(e.clientX, e.clientY);
        });
        window.addEventListener('mousemove', (e) => {
            if (aimDragging) handleAimMove(e.clientX, e.clientY);
        });
        window.addEventListener('mouseup', (e) => {
            if (aimDragging) handleAimEnd();
        });
    }

    // NEW: Tackle Button Setup
    function setupTackleButton() {
        const tackleBtn = document.getElementById('tackle-button');
        if (!tackleBtn) return;

const handleTackle = (e) => {
            if (e.cancelable) e.preventDefault();
            e.stopPropagation(); // Prevent bubbling to joystick

            if (_gameManager && _gameManager.isDemoMode) return;

            if (_homeTeam && _homeTeam.activePlayer) {
                const p = _homeTeam.activePlayer;

                // Visual Feedback immediately
                tackleBtn.classList.add('active');
                setTimeout(() => tackleBtn.classList.remove('active'), 150);

                // If we don't have the ball, dash/tackle
                if (!p.hasBall) {
                    // Get current movement direction or forward
                    let dashX = p.inputVector.x;
                    let dashZ = p.inputVector.z;

                    // If not moving, dash forward relative to player facing
                    if (Math.abs(dashX) < 0.1 && Math.abs(dashZ) < 0.1) {
                        const fwd = new THREE.Vector3(0, 0, 1).applyQuaternion(p.mesh.quaternion);
                        dashX = fwd.x;
                        dashZ = fwd.z;
                    }

                    p.dash(dashX, dashZ);

                    if (window.flux.gameInstance.floatingText) {
                        // Only show text if dash actually happened (cooldown check inside dash)
                        if (p.isDashing) {
                            window.flux.gameInstance.floatingText.spawn("TACKLE!", p.mesh.position, "tech");
                        }
                    }
                } else if (p.isEngaged) {
                    // Break tackle if engaged
                    p.dash(p.inputVector.x, p.inputVector.z);
                }
            }
        };

        tackleBtn.addEventListener('touchstart', handleTackle, { passive: false });
        tackleBtn.addEventListener('mousedown', handleTackle);
    }

    // NEW: Settings Button Setup
// NEW: Settings Button Setup
function setupSettingsButton() {
        const settingsBtn = document.getElementById('settings-button');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsClose = document.getElementById('settings-close');

        if (!settingsBtn || !settingsPanel) return;

        settingsBtn.addEventListener('click', () => {
            settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'block' : 'none';
        });

        if (settingsClose) {
            settingsClose.addEventListener('click', () => {
                settingsPanel.style.display = 'none';
            });
        }

        // Sensitivity slider
        const sensitivitySlider = document.getElementById('sensitivity-slider');
        if (sensitivitySlider) {
            sensitivitySlider.value = _settings.joystickSensitivity * 100;
            sensitivitySlider.addEventListener('input', (e) => {
                _settings.joystickSensitivity = e.target.value / 100;
            });
        }

        // Aim assist toggle
        const aimAssistToggle = document.getElementById('aim-assist-toggle');
        if (aimAssistToggle) {
            aimAssistToggle.checked = _settings.aimAssist;
            aimAssistToggle.addEventListener('change', (e) => {
                _settings.aimAssist = e.target.checked;
            });
        }

        // Camera shake toggle
        const shakeToggle = document.getElementById('shake-toggle');
        if (shakeToggle) {
            shakeToggle.checked = _settings.cameraShake;
            shakeToggle.addEventListener('change', (e) => {
                _settings.cameraShake = e.target.checked;
            });
        }

        // Volume slider
        const volumeSlider = document.getElementById('volume-slider');
        if (volumeSlider && _audioManager) {
            volumeSlider.addEventListener('input', (e) => {
                const vol = e.target.value / 100;
                _audioManager.setVolume(vol);
            });
        }

        // Exit to Menu
        const exitBtn = document.getElementById('exit-to-menu-btn');
        if (exitBtn) {
            exitBtn.addEventListener('click', () => {
                if (_menuManager) {
                    _menuManager.show();
                    if (_gameManager) {
                        _gameManager.state = 'menu';
                        // Stop practice if running
                        if (_gameManager.practiceManager) {
                            _gameManager.practiceManager.stop();
                        }
                    }
                    settingsPanel.style.display = 'none';
                }
            });
        }
    }

    function updateInputVector() {
        let x = _input.x || 0;
        let z = _input.y || 0;

        if (_keys['w'] || _keys['ArrowUp']) z -= 1;
        if (_keys['s'] || _keys['ArrowDown']) z += 1;
        if (_keys['a'] || _keys['ArrowLeft']) x -= 1;
        if (_keys['d'] || _keys['ArrowRight']) x += 1;

        const lenSq = x*x + z*z;
        if (lenSq > 1) {
            const len = Math.sqrt(lenSq);
            x /= len;
            z /= len;
        }

        if (isNaN(x)) x = 0;
        if (isNaN(z)) z = 0;

        if (_camera) {
            _camera.getWorldDirection(_camFwd);
            _camFwd.y = 0;

            if (_camFwd.lengthSq() < 0.001) {
                _camFwd.set(0, 0, -1);
            } else {
                _camFwd.normalize();
            }

            _camRight.crossVectors(_camFwd, _upAxis).normalize();
        } else {
            _camFwd.set(0, 0, -1);
            _camRight.set(1, 0, 0);
        }

        let worldX = (_camFwd.x * -z) + (_camRight.x * x);
        let worldZ = (_camFwd.z * -z) + (_camRight.z * x);

        if (isNaN(worldX) || isNaN(worldZ)) {
            worldX = 0;
            worldZ = 0;
        }

if (_homeTeam && _homeTeam.activePlayer) {
            // FIX: Only allow movement if game is active or in practice
            const gm = window.flux.gameInstance;
            const canMove = gm && !gm.isDemoMode && (gm.state === 'active');
            
            if (canMove) {
                _homeTeam.activePlayer.setInput(worldX, worldZ);
            } else {
                _homeTeam.activePlayer.setInput(0, 0);
            }
        }
}

    function createRipple(x, y) {
        const ripple = document.createElement('div');
        ripple.className = 'touch-ripple';
        ripple.style.left = `${x}px`;
        ripple.style.top = `${y}px`;
        document.getElementById('ui-layer').appendChild(ripple);

        setTimeout(() => {
            if (ripple.parentNode) ripple.parentNode.removeChild(ripple);
        }, 600);

    }

    // NEW: Visual Swipe Trail
    function createSwipeTrailDot(x, y) {
        const dot = document.createElement('div');
        dot.className = 'swipe-trail-dot';
        dot.style.left = `${x - 6}px`; // Center (12px width)
        dot.style.top = `${y - 6}px`;
        document.getElementById('ui-layer').appendChild(dot);
        
        // CSS animation handles removal, but we clean up DOM to be safe
        setTimeout(() => {
            if (dot.parentNode) dot.parentNode.removeChild(dot);
        }, 500);
    }

    function onResize() {
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        if (_camera) {
            _camera.aspect = width / height;
            _camera.updateProjectionMatrix();
        }
        
        // Strictly 0.50 as requested
        const resScale = 0.50;
        
        _config.internalWidth = Math.floor(width * resScale);
        _config.internalHeight = Math.floor(height * resScale);

        if (_renderer) {
            _renderer.setSize(_config.internalWidth, _config.internalHeight, false);
        }
    }

function animate() {
        requestAnimationFrame(animate);

        const rawDt = _clock.getDelta();
        // Clamp dt to prevent spirals of death (max 0.1s)
        const dt = Math.min(rawDt, 0.1) * (window.flux.timeScale !== undefined ? window.flux.timeScale : 0.8);

        

        // Perf stats for DevTools snapshots
        if (window.flux && window.flux._debugIO && window.flux._debugIO.perf) {
            const perf = window.flux._debugIO.perf;
            perf.frame = (perf.frame || 0) + 1;
            perf.rawDt = rawDt;
            perf.dt = dt;
            const fps = dt > 0 ? (1 / dt) : 0;
            perf.fps = fps;
            perf.avgFps = (perf.avgFps && perf.avgFps > 0) ? (perf.avgFps * 0.9 + fps * 0.1) : fps;
        }
// Impact Frames
        if (_gameManager && _gameManager.impactPause > 0) {
            _gameManager.impactPause -= dt;
            if (_renderer && _scene && _camera) {
                _renderer.render(_scene, _camera);
            }
            return;
        }

        updateInputVector();

        // Action Buffer Processing
        if (_actionBuffer.active) {
            if (Date.now() - _actionBuffer.timestamp > _actionBuffer.duration) {
                _actionBuffer.active = false;
            } else {
                if (_homeTeam && _homeTeam.activePlayer) {
                    const p = _homeTeam.activePlayer;

                    if (p.hasBall && !p.isCharging && !p.isThrowing && p.status.nap <= 0) {
                        p.startCharge();
                        const btn = document.getElementById('action-button');
                        if (btn) btn.classList.add('active');
                        _actionBuffer.active = false;
                    }
                }
            }
        }

        // Menu State Handling
        if (_gameManager && _gameManager.state === 'menu' && _camera) {
            const time = Date.now() * 0.0005;
            const radius = 50;
            _camera.position.x = Math.sin(time) * radius;
            _camera.position.z = Math.cos(time) * radius;
            _camera.position.y = 20;
            _camera.lookAt(0, 0, 0);

            if (_renderer && _scene) {
                _renderer.render(_scene, _camera);
            }
            return;
        }

// Stable sub-stepping (prevents dt spikes from making physics/camera feel floaty on mobile)
        const _maxStep = 1 / 60;
        const _steps = Math.min(4, Math.max(1, Math.ceil(dt / _maxStep)));
        const _stepDt = dt / _steps;

        for (let _si = 0; _si < _steps; _si++) {
            const _sdt = _stepDt;

            if (_gameManager) _gameManager.update(_sdt);

            // If in Asset Forge mode, skip game logic and standard rendering
            // DevTools handles the rendering in its hooked update function
            if (_gameManager && _gameManager.isForgeMode) {
                // Forge mode handles its own rendering loop in DevTools hook
                return;
            }

            // Update Entities
            if (_homeTeam) {
                _homeTeam.update(_sdt);
                _homeTeam.players.forEach(p => checkBallGrab(p));
            }

            if (_awayTeam) {
                _awayTeam.update(_sdt);
                _awayTeam.players.forEach(p => checkBallGrab(p));
            }

            if (_ball) {
                _ball.update(_sdt);
            }

            // Ball Lab runtime (trajectory preview / record-replay)
            if (window.flux && window.flux.ballLab && typeof window.flux.ballLab.update === 'function') {
                window.flux.ballLab.update(_sdt);
            }

            // Update Camera
            updateCameraLogic(_sdt);

            // Update Visuals
            if (_waterOverlay) _waterOverlay.update(_sdt);
            if (_lightShafts) _lightShafts.update(_sdt);

// Runtime updaters (FX, arena rings, etc.)
            if (window.flux && window.flux._runtimeUpdaters && window.flux._runtimeUpdaters.length) {
                for (let ui = 0; ui < window.flux._runtimeUpdaters.length; ui++) {
                    const fn = window.flux._runtimeUpdaters[ui];
                    if (typeof fn === 'function') fn(_sdt);
                }
            }

            // Update Glyph Manager (Critical for visual cleanup)
            if (_glyphManager) _glyphManager.update(_sdt);

// Update Global Uniforms
            if (_arenaUniforms) {
                _arenaUniforms.uTime.value += _sdt;
                _arenaUniforms.uImpactStr.value *= Math.max(0, 1.0 - _sdt * 4.0);
            }
            
            // --- NEW: Arena Rotation & Color Shift ---
            if (window.flux.arenaGroup) {
                // Rotate sphere slowly to show water movement
                window.flux.arenaGroup.rotation.y += _sdt * 0.05;
            }

            if (window.flux.tribalUniforms) {
                window.flux.tribalUniforms.uTime.value += _sdt;
                
                // Possession Color Logic
                let targetColor = new THREE.Color(0x00ffff); // Default Cyan (Home/Neutral)
                
                if (_ball && _ball.holder) {
                    if (_ball.holder.team && _ball.holder.team.side === -1) {
                        targetColor.setHex(0xff8800); // Orange (Away)
                    }
                }
                
                // Smooth Lerp
                window.flux.tribalUniforms.uColor.value.lerp(targetColor, _sdt * 2.0);
            }

if (_particleUniforms) {
                _particleUniforms.uTime.value += _sdt;
            }
        } // Close sub-step loop

        if (_renderer && _scene && _camera) {
            _renderer.render(_scene, _camera);
        }
        // UI Updates
        updateUI();
    }

    function updateUI() {
        if (!_homeTeam || !_homeTeam.activePlayer) return;

        const btn = document.getElementById('action-button');
        const lbl = document.getElementById('action-label');
        const tackleBtn = document.getElementById('tackle-button');
        const p = _homeTeam.activePlayer;

        if (btn && lbl) {
            const btnText = btn.querySelector('.btn-text');

            if (p.hasBall) {
                if (btnText && btnText.innerText !== "ACTION") {
                    btnText.innerText = "ACTION";
                    btn.classList.add('shoot-mode');
                    lbl.innerText = "OFFENSE";
                    lbl.classList.add('shoot-label');
                }

                const isHighEnergy = (p.stats.HP / p.stats.maxHP) > 0.4;
                if (isHighEnergy) {
                    if (!btn.classList.contains('limit-ready')) btn.classList.add('limit-ready');
                } else {
                    if (btn.classList.contains('limit-ready')) btn.classList.remove('limit-ready');
                }

            } else {
                if (btnText && btnText.innerText !== "SWIM") {
                    btnText.innerText = "SWIM";
                    btn.classList.remove('shoot-mode');
                    btn.classList.remove('limit-ready');
                    lbl.innerText = "NORMAL";
                    lbl.classList.remove('shoot-label');
                }
            }
        }

        // Update tackle button visibility
        if (tackleBtn) {
            if (!p.hasBall || p.isEngaged) {
                tackleBtn.style.display = 'flex';
                // Update tackle button text based on context
                const tackleText = tackleBtn.querySelector('.btn-text');
                if (tackleText) {
                    if (p.isEngaged && p.hasBall) {
                        tackleText.innerText = 'BREAK';
                        tackleBtn.classList.add('urgent');
                    } else {
                        tackleText.innerText = 'TACKLE';
                        tackleBtn.classList.remove('urgent');
                    }
                }
            } else {
                tackleBtn.style.display = 'none';
            }
        }

        // Update distance to goal indicator
        const distIndicator = document.getElementById('goal-distance');
        if (distIndicator && p.mesh) {
            const goalZ = (p.team && p.team.side === 1) ? -28 : 28;
            const dist = Math.abs(p.mesh.position.z - goalZ);
            distIndicator.innerText = `${Math.floor(dist)}m`;
        }
    }

function updateCameraLogic(dt) {
        if (!_cameraManager || !_ball) return;

        let targetMesh = _ball.mesh;
        let targetVel = _ball.velocity;
        let targetInput = null;
        let isAiming = false;

        if (_ball.holder && _ball.holder.mesh) {
            targetMesh = _ball.holder.mesh;
            targetVel = _ball.holder.velocity;
            if (_ball.holder.inputVector) {
                targetInput = _ball.holder.inputVector;
            }
// Check aiming state (Charging or Throwing)
            if (_ball.holder.isCharging || _ball.holder.isThrowing) {
                isAiming = true;
            }
        }

        _cameraManager.setTarget(targetMesh, targetVel, targetInput, isAiming);
        _cameraManager.update(dt);
    }

function checkBallGrab(entity) {
        if (!entity.canCatch) return;
        if (_ball && !_ball.isCatchable()) return;
        if (entity.stunTimer > 0 || (entity.status && entity.status.nap > 0)) return;
        if (_ball.state !== 'free') return;
        if (!_ball.mesh || !entity.mesh) return;

        const ballPos = _ball.mesh.position;
        const entPos = entity.mesh.position;

        const dx = ballPos.x - entPos.x;
        const dz = ballPos.z - entPos.z;
        const distXZ = Math.sqrt(dx*dx + dz*dz);
        const distY = Math.abs(ballPos.y - entPos.y);

        // --- RELAXED TOLERANCES FOR EASIER PICKUP ---
        const touchRadius = 1.5; // Increased from 1.0 (Auto-grab radius)
        let magnetRadius = 3.5;  // Increased from 1.8 (Magnetic radius)
        let interactionRadius = 6.0; // Increased from 3.5 (Turn-to radius)
        let catchHeight = 6.0;   // Increased from 3.0 (Vertical reach)

        if (entity.isDashing) {
            magnetRadius = 4.5;
            interactionRadius = 7.0;
            catchHeight = 7.0;
        }

        if (distXZ > interactionRadius || distY > catchHeight) return;

        // Optimization: Use shared vectors to avoid GC
        _tempVec1.copy(ballPos).sub(entPos).normalize(); // toBall
        _tempVec2.set(0, 0, 1).applyQuaternion(entity.mesh.quaternion).normalize(); // playerForward

        const facingDot = _tempVec2.dot(_tempVec1);

        const coneThreshold = -0.4; // More generous cone (was -0.2)
        const isInCone = facingDot > coneThreshold;
        
        // AUTO-TURN: If near but facing wrong way, turn towards ball
        if (distXZ < interactionRadius && !isInCone) {
            const targetAngle = Math.atan2(_tempVec1.x, _tempVec1.z);
            const q = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0), targetAngle);
            entity.mesh.quaternion.slerp(q, 0.2); // Faster turn (was 0.1)
            if (entity.syncRotation) entity.syncRotation();
        }

        // GRAB LOGIC
        // 1. Touch: Very close (ignore facing - prevents running over ball)
        // 2. Magnet: Close and facing
        const isTouch = distXZ < touchRadius;
        const isMagnet = distXZ < magnetRadius && isInCone;

        if (isTouch || isMagnet) {
            // BLAST THROUGH LOGIC
            const ballSpeed = _ball.velocity.length();
            let catchChance = 1.0;

            // If ball is moving fast (e.g. > 20), check CA
            if (ballSpeed > 20.0) {
                const ca = entity.getStat('CA');
                // Difficulty scales with speed. 
                const difficulty = ballSpeed * 1.2; 
                
                if (difficulty > ca) {
                    catchChance = 0.4 + (ca / difficulty) * 0.6;
                    
                    // Point Blank Penalty: Harder to react if ball is right on top of you moving fast
                    if (distXZ < 1.2) {
                        catchChance *= 0.6; // Blast through likely
                    }
                    
                    if (entity.isDashing) catchChance += 0.2;
                }
            } else if (_ball.powerType === 'SH' && _ball.power > 15.0) {
                // Shot power check
                const ca = entity.getStat('CA');
                if (_ball.power > ca * 1.2) {
                    const chance = Math.min(0.7, (_ball.power - ca) * 0.04);
                    catchChance = 1.0 - chance;
                }
            }

            let fumble = false;
            if (Math.random() > catchChance) {
                fumble = true;
            }

            if (fumble) {
                if (window.flux.gameInstance.floatingText) {
                    // Visual feedback for blast through
                    window.flux.gameInstance.floatingText.spawn("BLAST THROUGH!", entPos, "damage");
                }
                
                // Deflect slightly but keep moving fast (Blast Through)
                // Don't stop it completely like a block, just perturb it
                _ball.velocity.multiplyScalar(0.85); 
                _ball.velocity.x += (Math.random()-0.5) * 5.0;
                _ball.velocity.y += (Math.random()) * 5.0; // Pop up
                _ball.velocity.z += (Math.random()-0.5) * 5.0;
                
                _ball.power *= 0.7;

                entity.canCatch = false;
                // Stun briefly
                entity.stunTimer = 0.5;
                if(entity.play) entity.play('react', 0.1);
                
                setTimeout(() => { entity.canCatch = true; }, 1000);

            } else {
                _ball.magnetize(entity);
            }
        }
    }

    // Start
    init();
})();</script>


</body></html>