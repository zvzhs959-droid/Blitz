<html lang="en"><head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Blitzball FFX Remastered</title>
    <style>:root {
    --ffx-blue-deep: #020408;
    --ffx-blue-dark: #0a1525;
    --ffx-blue-mid: #152a45;
    --ffx-blue-light: #2a4d75;
    --ffx-cyan: #60c0d0;
    --ffx-cyan-glow: #00ffff;
    --ffx-gold: #c8b060;
    --ffx-gold-light: #f0e090;
    --ffx-gold-dark: #8a7030;
    --ffx-glass-bg: rgba(10, 20, 40, 0.75);
    --ffx-glass-border: rgba(100, 200, 255, 0.3);
    
    --font-title: 'Garamond', 'Times New Roman', serif;
    --font-data: 'Impact', 'Arial Narrow', sans-serif;
    --font-ui: 'Courier New', monospace;
    --font-spira: 'Spira', 'Impact', sans-serif;
}

@font-face {
    font-family: 'Spira';
    src: url('https://files.catbox.moe/zyn7s3.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
}

html, body {
    margin: 0;
    padding: 0;
    background-color: #000;
    overflow: hidden;
    width: 100vw;
    height: 100%;
    position: fixed; 
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    font-family: var(--font-data);
    color: white;
    user-select: none;
    -webkit-user-select: none;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
}

* {
    box-sizing: border-box;
}

/* --- MAIN GAME CONTAINER --- */
#game-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    max-width: none;
    background: #000510;
    box-shadow: none;
    overflow: hidden;
    transition: filter 0.05s;
    z-index: 1;
    contain: strict;
}

/* --- IMPACT FX --- */
#game-container.impact-fx {
    animation: impactShake 0.1s ease-in-out;
    filter: contrast(1.2) brightness(1.1);
}

#game-container.impact-heavy {
    animation: impactShake 0.2s ease-in-out;
    filter: contrast(1.5) brightness(1.3) sepia(0.4) hue-rotate(-10deg);
}

#game-container.impact-shatter {
    animation: impactShake 0.4s ease-in-out;
    filter: contrast(2.0) invert(0.1) saturate(2.0);
}

@keyframes impactShake {
    0% { transform: translate(0, 0); }
    25% { transform: translate(-5px, 5px); }
    50% { transform: translate(5px, -5px); }
    75% { transform: translate(-5px, -5px); }
    100% { transform: translate(0, 0); }
}

/* --- CANVAS & RENDER --- */
canvas {
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    image-rendering: pixelated; 
    z-index: 0;
}

/* --- GIF OVERLAY --- */
#screen-overlay-gif {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    mix-blend-mode: overlay;
    opacity: 1.0;
    pointer-events: none;
    z-index: 950;
    image-rendering: pixelated;
}

#ui-layer {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    z-index: 1000;
    contain: strict;
}

/* --- CINEMATIC BARS --- */
#cinematic-bars .bar {
    position: absolute;
    left: 0; width: 100%; height: 0;
    background: black;
    transition: height 0.5s ease;
    z-index: 800;
}
#cinematic-bars .bar.top { top: 0; }
#cinematic-bars .bar.bottom { bottom: 0; }

/* --- TECH FLASH OVERLAY --- */
#tech-flash-overlay {
    position: absolute;
    top: 20%; left: 0; width: 100%; height: 120px;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(0, 20, 60, 0.9) 20%, rgba(0, 20, 60, 0.9) 80%, rgba(0,0,0,0) 100%);
    z-index: 2200;
    backdrop-filter: blur(2px);
    border-top: 1px solid rgba(100, 255, 255, 0.3);
    border-bottom: 1px solid rgba(100, 255, 255, 0.3);
    animation: flashEnter 0.15s ease-out;
    will-change: transform, opacity;
}

@keyframes flashEnter {
    from { transform: scaleY(0); opacity: 0; }
    to { transform: scaleY(1); opacity: 1; }
}

.tech-content-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    transform: skewX(-10deg);
}

.tech-text {
    font-family: var(--font-spira);
    font-size: clamp(28px, 10vw, 42px);
    color: #ffffff;
    text-shadow: 0 0 10px #00ffff, 0 0 20px #0000ff;
    letter-spacing: 3px;
    margin-bottom: 2px;
    font-style: italic;
    animation: blinkText 0.08s infinite alternate;
    text-align: center;
}

.tech-sub-text {
    font-family: var(--font-ui);
    font-size: 14px;
    color: #00ffff;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 8px;
    text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
}

.tech-timer-track {
    width: 250px;
    height: 8px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #444;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
}

.tech-timer-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffffff, #00ffff);
    width: 100%;
    transform-origin: left;
    box-shadow: 0 0 10px #00ffff;
}

@keyframes blinkText {
    from { opacity: 0.8; text-shadow: 0 0 5px #00ffff; transform: scale(1); }
    to { opacity: 1.0; text-shadow: 0 0 20px #ffffff, 0 0 10px #00ffff; transform: scale(1.02); }
}

/* --- HUD TOP --- */
/* --- HUD TOP --- */
#hud-top {
    position: absolute;
    top: 0;
    left: 0;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    width: 100%;
    padding: 15px;
    padding-top: max(15px, env(safe-area-inset-top));
    padding-left: max(15px, env(safe-area-inset-left));
    padding-right: max(15px, env(safe-area-inset-right));
    box-sizing: border-box;
    background: linear-gradient(to bottom, rgba(0, 5, 15, 0.9) 0%, rgba(0,0,0,0) 100%);
    pointer-events: none;
    transition: opacity 0.5s;
}

.team-wing {
    position: relative;
    display: flex;
    align-items: center;
    width: 140px;
    height: 55px;
    background: linear-gradient(160deg, rgba(20, 40, 80, 0.9) 0%, rgba(5, 10, 20, 0.95) 100%);
    border: 1px solid rgba(100, 200, 255, 0.3);
    border-top: 2px solid var(--ffx-cyan);
    border-radius: 4px;
    transform: skewX(-15deg);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(0, 100, 255, 0.1);
    padding: 0 15px;
    backdrop-filter: blur(4px);
}

.team-wing::after {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: wingShimmer 4s infinite;
}

@keyframes wingShimmer {
    0% { transform: translateX(-100%); }
    20% { transform: translateX(100%); }
    100% { transform: translateX(100%); }
}

.team-wing.away {
    transform: skewX(15deg);
    flex-direction: row-reverse;
    border-top-color: #ff6666;
    background: linear-gradient(-160deg, rgba(60, 20, 20, 0.9) 0%, rgba(20, 5, 5, 0.95) 100%);
}

.team-data {
    display: flex;
    flex-direction: column;
    justify-content: center;
    transform: skewX(15deg);
    flex-grow: 1;
}
.team-wing.away .team-data { transform: skewX(-15deg); text-align: right; }

.team-name {
    font-family: var(--font-title);
    font-size: 16px;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 0 5px rgba(0, 150, 255, 0.8);
}
.team-sub {
    font-family: var(--font-data);
    font-size: 10px;
    color: var(--ffx-cyan);
    opacity: 0.8;
    letter-spacing: 2px;
}
.team-wing.away .team-sub { color: #ffaaaa; }

.score-box {
    font-family: var(--font-data);
    font-size: 42px;
    color: white;
    text-shadow: 0 0 15px var(--ffx-cyan-glow);
    transform: skewX(15deg);
    margin: 0 5px;
    min-width: 30px;
    text-align: center;
}
.team-wing.away .score-box { transform: skewX(-15deg); text-shadow: 0 0 15px #ff4444; }

.timer-complex {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: -5px;
}

.timer-crystal-ring {
    position: absolute;
    top: -30px;
    width: 140px;
    height: 70px;
    border-radius: 50%;
    border-top: 3px solid var(--ffx-gold);
    border-bottom: 1px solid transparent;
    box-shadow: 0 -5px 20px rgba(200, 180, 100, 0.4), inset 0 10px 20px rgba(0,0,0,0.5);
    z-index: -1;
    background: radial-gradient(ellipse at top, rgba(20, 40, 80, 0.9), transparent 70%);
    backdrop-filter: blur(4px);
}

#half-indicator {
    font-family: var(--font-spira);
    font-size: 12px;
    color: var(--ffx-gold);
    letter-spacing: 4px;
    margin-bottom: -4px;
    text-shadow: 0 0 5px var(--ffx-gold-dark);
    text-transform: uppercase;
}

#timer-display {
    font-family: var(--font-data);
    font-size: 48px;
    background: linear-gradient(to bottom, #fff 0%, #ffd700 50%, #b8860b 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 2px 0px rgba(0,0,0,0.8));
    letter-spacing: 2px;
}
/* --- PLAYER STATUS PANEL --- */
#player-status-panel {
    position: absolute;
    bottom: max(160px, env(safe-area-inset-bottom) + 40px);
    left: max(20px, env(safe-area-inset-left));
    width: 160px;
    padding: 10px;
    background: linear-gradient(90deg, rgba(0, 10, 30, 0.8) 0%, rgba(0,0,0,0) 100%);
    border-left: 3px solid var(--ffx-cyan);
    border-radius: 0 10px 10px 0;
    backdrop-filter: blur(4px);
    transform: skewX(-10deg);
    pointer-events: none;
    display: none;
}

.char-name {
    font-family: var(--font-title);
    font-size: 18px;
    color: white;
    text-transform: uppercase;
    margin-bottom: 5px;
    transform: skewX(10deg);
    text-shadow: 0 0 5px var(--ffx-blue-light);
}

.hp-gauge-container {
    display: flex;
    align-items: center;
    margin-bottom: 4px;
    transform: skewX(10deg);
}
.hp-label { font-size: 10px; color: var(--ffx-cyan); width: 20px; }
.hp-bar-track {
    flex-grow: 1;
    height: 6px;
    background: rgba(0,0,0,0.5);
    border: 1px solid #444;
    margin: 0 5px;
}
.hp-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #00ff00, #ccffcc);
    box-shadow: 0 0 5px #00ff00;
}
.hp-value { font-size: 10px; color: #fff; width: 45px; text-align: right; }

.tech-gauge-container {
    display: flex;
    align-items: center;
    transform: skewX(10deg);
}
.tech-label { font-size: 10px; color: var(--ffx-gold); width: 20px; }
.tech-bar-track {
    flex-grow: 1;
    height: 4px;
    background: rgba(0,0,0,0.5);
    border: 1px solid #444;
    margin: 0 5px;
}
.tech-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffaa00, #ffffaa);
}

/* --- MINIMAP --- */
#minimap-container {
    position: absolute;
    top: max(80px, env(safe-area-inset-top) + 60px);
    right: max(20px, env(safe-area-inset-right));
    width: 110px;
    height: 110px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.radar-rim {
    position: absolute;
    width: 100%; height: 100%;
    border-radius: 50%;
    border: 2px solid var(--ffx-blue-light);
    box-shadow: 0 0 15px var(--ffx-blue-mid), inset 0 0 20px rgba(0,0,0,0.8);
    background: radial-gradient(circle, rgba(0, 20, 60, 0.4) 0%, rgba(0, 5, 10, 0.8) 100%);
    z-index: 5;
}

#minimap {
    position: relative;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    z-index: 6;
    overflow: hidden;
}

.radar-label {
    position: absolute;
    bottom: -15px;
    width: 140%;
    left: -20%;
    text-align: center;
    font-family: var(--font-spira);
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 0 5px var(--ffx-cyan);
}

.map-dot {
    position: absolute;
    width: 6px; height: 6px;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 4px currentColor;
}
.map-dot.home { background: var(--ffx-cyan); color: var(--ffx-cyan); }
.map-dot.away { background: #ff4444; color: #ff4444; }
.map-dot.ball { 
    background: #ff00cc;
    color: #ff00cc; 
    width: 12px; height: 12px;
    border: 2px solid #ffffff;
    z-index: 20;
    animation: blinkBall 0.3s infinite alternate;
    box-shadow: 0 0 6px #ff00cc;
}
.map-dot.nap { background: #333; color: #000; border: 1px solid #555; }
.map-dot.active-player { 
    background: #00ff00 !important; 
    color: #00ff00 !important; 
    box-shadow: 0 0 8px #00ff00;
    z-index: 15;
    transform: translate(-50%, -50%) scale(1.2);
}
.map-dot.ball-carrier {
    box-shadow: 0 0 15px #fff, 0 0 30px #ffaa00;
    border: 2px solid #ffffff;
    background-color: #ffaa00 !important;
    z-index: 100;
    width: 10px; height: 10px;
    animation: carrierPulse 0.8s infinite alternate;
}
@keyframes carrierPulse {
    from { transform: translate(-50%, -50%) scale(1.2); box-shadow: 0 0 10px #fff; opacity: 0.8; }
    to { transform: translate(-50%, -50%) scale(1.8); box-shadow: 0 0 25px #ffcc00; opacity: 1.0; }
}
@keyframes blinkBall { from { opacity: 1; transform: translate(-50%, -50%) scale(1); } to { opacity: 0.5; transform: translate(-50%, -50%) scale(1.3); } }

/* --- ANNOUNCEMENTS --- */
#announcement {
    position: absolute;
    top: 40%; 
    left: 5%; 
    width: 90%;
    text-align: center;
    font-family: var(--font-data);
    font-size: clamp(40px, 12vw, 72px);
    font-weight: 900;
    font-style: italic;
    text-transform: uppercase;
    letter-spacing: 2px;
    line-height: 1.0;
    white-space: normal;
    background: linear-gradient(to bottom, #fff 0%, #ffd700 40%, #b8860b 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 10px rgba(255, 100, 0, 0.5)) drop-shadow(3px 3px 0 #000);
    display: none;
    z-index: 2000;
    animation: announceSlide 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    pointer-events: none;
    will-change: transform, opacity;
}

@keyframes announceSlide {
    from { transform: scale(0) rotate(-5deg); opacity: 0; }
    to { transform: scale(1) rotate(0deg); opacity: 1; }
}

/* --- JOYSTICK --- */
#joystick-hit-zone {
    position: absolute;
    bottom: 0; left: 0;
    width: 50%; height: 50%;
    z-index: 1000;
    background: rgba(0,0,0,0); 
    touch-action: none;
    pointer-events: auto;
}

#joystick-visual-container {
    position: absolute;
    top: 0; left: 0;
    width: 0; height: 0;
    overflow: visible;
    pointer-events: none;
    display: none;
    z-index: 1100;
}

#joystick-base {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 120px; height: 120px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(0, 40, 80, 0.4) 0%, rgba(0, 10, 20, 0.1) 60%, transparent 100%);
    border: 1px solid rgba(100, 220, 255, 0.3);
    box-shadow: 0 0 20px rgba(0, 100, 255, 0.2), inset 0 0 30px rgba(0, 50, 100, 0.3);
    animation: basePulse 2s infinite alternate;
}

@keyframes basePulse {
    from { box-shadow: 0 0 10px rgba(0, 100, 255, 0.2); border-color: rgba(100, 220, 255, 0.2); }
    to { box-shadow: 0 0 25px rgba(0, 100, 255, 0.5); border-color: rgba(100, 255, 255, 0.6); }
}

#joystick-knob {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 50px; height: 50px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, #e0ffff 0%, #00aaff 40%, #004488 80%, #001122 100%);
    border: 2px solid #88ccff;
    box-shadow: 0 0 15px #00ffff, inset 0 0 10px rgba(255,255,255,0.8);
    transition: transform 0.05s linear;
    will-change: transform;
}

#joystick-knob::after {
    content: "";
    position: absolute;
    top: 20%; left: 20%; width: 20%; height: 20%;
    background: radial-gradient(circle, #ffffff 0%, transparent 70%);
    filter: blur(2px);
    opacity: 0.8;
}

.touch-ripple {
    position: absolute;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(200, 255, 255, 0.8) 0%, rgba(0, 255, 255, 0.4) 40%, transparent 70%);
    transform: translate(-50%, -50%) scale(0);
    animation: rippleAnim 0.6s ease-out forwards;
    pointer-events: none;
    z-index: 9000;
    mix-blend-mode: screen;
    will-change: transform, opacity;
}

@keyframes rippleAnim {
    0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(3.0); opacity: 0; }
}

#camera-zone {
    position: absolute;
    top: 0; right: 0; width: 50%; height: 100%;
    pointer-events: auto;
    touch-action: none;
    z-index: 50;
}

/* --- ACTION BUTTON --- */
#action-container {
    position: absolute;
    bottom: max(40px, env(safe-area-inset-bottom)); 
    right: max(40px, env(safe-area-inset-right));
    display: flex;
    flex-direction: column;
    align-items: center;
    pointer-events: auto;
    z-index: 100;
}

.command-menu-bg {
    position: absolute;
    width: 180px; height: 80px;
    bottom: 15px;
    background: linear-gradient(90deg, transparent 0%, rgba(0, 10, 30, 0.8) 50%, transparent 100%);
    border-bottom: 1px solid rgba(0, 200, 255, 0.3);
    z-index: -1;
}

.command-ring {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 130px; height: 130px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-top: 2px solid rgba(0, 255, 255, 0.6);
    border-bottom: 2px solid rgba(0, 255, 255, 0.6);
    border-radius: 50%;
    animation: spinReverse 15s linear infinite;
    pointer-events: none;
    box-shadow: 0 0 15px rgba(0, 100, 255, 0.2);
}
@keyframes spinReverse { from { transform: translate(-50%, -50%) rotate(360deg); } to { transform: translate(-50%, -50%) rotate(0deg); } }

#action-label {
    font-family: var(--font-spira);
    font-size: 12px;
    color: var(--ffx-cyan);
    background: rgba(0, 5, 10, 0.8);
    padding: 4px 12px;
    border: 1px solid var(--ffx-blue-light);
    border-radius: 10px;
    margin-bottom: 15px;
    text-transform: uppercase;
    letter-spacing: 2px;
    box-shadow: 0 0 10px rgba(0,0,0,0.8);
    text-shadow: 0 0 5px var(--ffx-cyan);
    transition: all 0.3s;
}

#action-button {
    position: absolute;
    top: 0; left: 0;
    width: 100px; height: 100px;
    border-radius: 50%;
    cursor: pointer;
    transition: transform 0.1s, filter 0.3s;
    background: radial-gradient(circle at 35% 35%, #ffffff 0%, #0088ff 40%, #002266 80%, #000 100%);
    border: 3px solid #44aaff;
    box-shadow: 0 0 20px rgba(0, 100, 255, 0.8), inset 0 0 20px rgba(255, 255, 255, 0.4);
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: visible;
    z-index: 10;
}

#pass-button {
    display: none !important;
    position: absolute;
    bottom: -20px; left: -30px;
    width: 60px; height: 60px;
    border-radius: 50%;
    cursor: pointer;
    z-index: 9;
}

#action-button::before {
    content: '';
    position: absolute;
    top: -40px; left: -40px; right: -40px; bottom: -40px;
    border-radius: 50%;
    z-index: 10;
}

#action-button:active { transform: scale(0.92); }

#action-button .btn-text {
    font-family: var(--font-title);
    font-size: 22px;
    font-weight: bold;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8), 0 0 10px rgba(255,255,255,0.5);
    z-index: 5;
    pointer-events: none;
    letter-spacing: 1px;
}

#action-button .btn-glare {
    position: absolute;
    top: -50%; left: -50%; width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.4) 50%, transparent 60%);
    animation: glarePass 5s infinite;
    pointer-events: none;
    z-index: 6;
    border-radius: 50%;
}

.limit-ring {
    position: absolute;
    top: -5px; left: -5px; right: -5px; bottom: -5px;
    border-radius: 50%;
    border: 2px solid transparent;
    box-shadow: 0 0 0 transparent;
    transition: all 0.5s;
    z-index: 1;
    pointer-events: none;
}

#action-button.shoot-mode {
    background: radial-gradient(circle at 35% 35%, #ffffaa 0%, #ffaa00 40%, #882200 80%, #220000 100%);
    border-color: #ffcc00;
    box-shadow: 0 0 30px rgba(255, 100, 0, 0.8), inset 0 0 20px rgba(255, 255, 0, 0.5);
}

#action-button.limit-ready .limit-ring {
    border-color: #ffdd44;
    animation: limitPulse 0.8s ease-in-out infinite alternate;
}

.shoot-label {
    color: #ffdd44 !important;
    border-color: #ffaa00 !important;
    text-shadow: 0 0 10px #ff4400 !important;
}

@keyframes limitPulse {
    0% { transform: scale(1.0); box-shadow: 0 0 10px #ffaa00, inset 0 0 5px #ffaa00; opacity: 0.5; }
    100% { transform: scale(1.15); box-shadow: 0 0 30px #ff4400, inset 0 0 15px #ff0000; opacity: 1.0; }
}

/* --- AUTO TOGGLE --- */
#auto-toggle {
    position: absolute;
    top: max(200px, env(safe-area-inset-top) + 60px); 
    right: max(20px, env(safe-area-inset-right));
    width: 110px;
    padding: 10px 0;
    text-align: center;
    font-size: 12px;
    font-weight: bold;
    color: var(--ffx-cyan);
    background: linear-gradient(135deg, rgba(0, 20, 40, 0.8) 0%, rgba(0, 5, 10, 0.9) 100%);
    border: 1px solid var(--ffx-blue-light);
    border-top: 1px solid var(--ffx-cyan);
    border-radius: 4px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    backdrop-filter: blur(4px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    pointer-events: auto;
    transition: all 0.2s;
    z-index: 100;
}

#auto-toggle:hover {
    background: rgba(0, 40, 80, 0.9);
    box-shadow: 0 0 15px var(--ffx-cyan);
    color: white;
}

#auto-toggle.active {
    background: linear-gradient(135deg, rgba(100, 20, 0, 0.8) 0%, rgba(40, 0, 0, 0.9) 100%);
    border-color: #ff4400;
    color: #ffaa00;
    animation: pulseRed 2s infinite;
}
@keyframes pulseRed { 0% { box-shadow: 0 0 5px #ff0000; } 50% { box-shadow: 0 0 20px #ff4400; } 100% { box-shadow: 0 0 5px #ff0000; } }

/* --- FLOATING TEXT --- */
.floating-text-wrapper {
    position: absolute;
    top: 0; left: 0;
    pointer-events: none;
    z-index: 2000;
    will-change: transform;
    contain: layout style;
}

.floating-text-inner {
    display: block;
    font-family: var(--font-data);
    font-weight: 900;
    text-transform: uppercase;
    white-space: nowrap;
    text-align: center;
    font-size: 24px; 
    text-shadow: 1px 1px 0 #000;
    opacity: 0.9;
}

.floating-text-inner.damage {
    font-size: 42px;
    font-style: italic;
    background: linear-gradient(to bottom, #ffffff 0%, #ffcc00 40%, #ff4400 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 4px 4px rgba(0,0,0,0.8));
    animation: popDamage 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

.floating-text-inner.heal {
    font-size: 36px;
    color: #44ff44;
    text-shadow: 0 0 10px #00ff00;
    animation: floatUp 1s ease-out forwards;
}

.floating-text-inner.venom {
    font-family: var(--font-data);
    font-size: 42px;
    font-style: italic;
    color: #aaff00;
    text-shadow: 0 0 10px #448800, 2px 2px 0 #002200;
    background: linear-gradient(to bottom, #ccff66 0%, #66cc00 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 5px rgba(100, 255, 0, 0.5));
    animation: dripStatus 2s infinite;
}

.floating-text-inner.sleep {
    font-family: var(--font-title);
    font-size: 42px;
    color: #ffffff;
    text-shadow: 0 0 15px #0044ff, 0 0 30px #0000ff;
    opacity: 0.9;
    animation: driftStatus 3s ease-in-out infinite;
}

.floating-text-inner.wither {
    font-family: var(--font-data);
    font-size: 38px;
    color: #cccccc;
    text-shadow: 2px 2px 0 #444444;
    background: linear-gradient(to bottom, #eeeeee 0%, #888888 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: witherStatus 1.5s forwards;
}

.floating-text-inner.tech {
    font-family: var(--font-title);
    font-size: 32px;
    color: #00ffff;
    background: rgba(0, 10, 30, 0.7);
    padding: 2px 10px;
    border: 1px solid #00ffff;
    border-radius: 4px;
    box-shadow: 0 0 10px #0088ff;
    text-shadow: 0 0 5px #fff;
    animation: shakeTech 0.6s ease-in-out, flashTech 0.3s;
    transform-origin: center;
}

.floating-text-inner.save, .floating-text-inner.block {
    font-size: 48px;
    font-weight: 900;
    color: #ffffff;
    -webkit-text-stroke: 1px #004488;
    text-shadow: 0 0 20px #0088ff;
    animation: popDamage 0.5s ease-out forwards;
}

@keyframes popDamage {
    0% { transform: scale(0.5); opacity: 0; }
    20% { transform: scale(1.5); opacity: 1; }
    40% { transform: scale(1.0); opacity: 1; }
    100% { transform: scale(1.0); opacity: 0; }
}

@keyframes floatUp {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(-50px); opacity: 0; }
}

@keyframes dripStatus {
    0% { transform: scaleY(1); filter: blur(0px); }
    50% { transform: scaleY(1.1) translateY(5px); filter: blur(1px); }
    100% { transform: scaleY(1); filter: blur(0px); }
}

@keyframes driftStatus {
    0% { transform: translateX(0) rotate(0deg); opacity: 0; }
    20% { opacity: 1; }
    50% { transform: translateX(15px) translateY(-20px) rotate(10deg); }
    100% { transform: translateX(-15px) translateY(-50px) rotate(-10deg); opacity: 0; }
}

@keyframes witherStatus {
    0% { transform: scale(1); filter: grayscale(0%); opacity: 1; }
    100% { transform: scale(0.6); filter: grayscale(100%); opacity: 0; }
}

@keyframes shakeTech {
    0% { transform: scale(0.8); }
    10%, 30%, 50%, 70%, 90% { transform: scale(1.1) translate(-2px, 2px); }
    20%, 40%, 60%, 80% { transform: scale(1.1) translate(2px, -2px); }
    100% { transform: scale(1.0); }
}

@keyframes flashTech {
    0% { background-color: #fff; color: #000; border-color: #fff; }
    100% { background-color: rgba(0, 10, 30, 0.85); color: #00ffff; border-color: #00ffff; }
}

#loading {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    color: var(--ffx-cyan);
    text-transform: uppercase;
    letter-spacing: 5px;
    animation: blink 1s infinite;
}
@keyframes blink { 50% { opacity: 0.5; } }

#controls-hint {
    position: absolute;
    top: 130px; width: 100%;
    text-align: center;
    font-size: 10px;
    color: rgba(255,255,255,0.4);
    text-transform: uppercase;
    pointer-events: none;
}

.floating-text-inner.comic-impact {
    font-family: 'Impact', sans-serif;
    font-size: 42px;
    color: #ffff00; 
    -webkit-text-stroke: 1px #000;
    text-shadow: 3px 3px 0 #ff0000;
    font-style: italic;
    transform-origin: center;
    white-space: nowrap;
    animation: comicPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    z-index: 2500;
}

.floating-text-inner.comic-action {
    font-family: 'Arial Black', sans-serif;
    font-size: 28px;
    color: #00ffff; 
    -webkit-text-stroke: 1px #000;
    text-shadow: 2px 2px 0 #0044aa;
    font-style: italic;
    white-space: nowrap;
    animation: comicSlide 0.4s ease-out forwards;
    z-index: 2500;
}

@keyframes comicPop {
    0% { transform: scale(0) rotate(-20deg); opacity: 0; }
    40% { transform: scale(1.2) rotate(5deg); opacity: 1; }
    60% { transform: scale(1.0) rotate(-5deg); opacity: 1; }
    100% { transform: scale(1.1) rotate(0deg); opacity: 0; }
}

@keyframes comicSlide {
    0% { transform: translate(-20px, 20px) scale(0.5); opacity: 0; }
    100% { transform: translate(20px, -20px) scale(1.2); opacity: 0; }
}

/* --- MAIN MENU --- */
/* --- MAIN MENU & END GAME (FFX STYLE) --- */
#main-menu, #end-game-menu {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.8s cubic-bezier(0.2, 0.8, 0.2, 1.0);
    background: radial-gradient(circle at center, rgba(0, 20, 60, 0.4) 0%, rgba(0, 5, 10, 0.8) 100%);
    backdrop-filter: blur(5px);
}

#main-menu.active, #end-game-menu.active {
    opacity: 1;
    pointer-events: auto;
}

.menu-bg-overlay, .end-bg-layer {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: 
        linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,0.1) 50%), 
        repeating-linear-gradient(90deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 1px, transparent 1px, transparent 20px);
    background-size: 100% 4px, 100% 100%;
    pointer-events: none;
    z-index: -1;
}

/* LOGO STYLING */
.ffx-logo-container {
    margin-bottom: 50px;
    text-align: center;
    transform: skewX(-10deg);
    position: relative;
}

.ffx-logo-main {
    font-family: var(--font-title);
    font-size: clamp(48px, 10vw, 84px);
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 8px;
    background: linear-gradient(to bottom, #ffffff 0%, #aaccff 40%, #0088ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 15px rgba(0, 100, 255, 0.8));
    animation: logoShimmer 3s infinite alternate;
}

.ffx-logo-sub {
    font-family: var(--font-spira);
    font-size: clamp(14px, 3vw, 24px);
    color: var(--ffx-gold);
    letter-spacing: 15px;
    margin-top: -10px;
    text-shadow: 0 0 10px #ffaa00;
    opacity: 0.9;
}

@keyframes logoShimmer {
    0% { filter: drop-shadow(0 0 10px rgba(0, 100, 255, 0.5)); }
    100% { filter: drop-shadow(0 0 25px rgba(0, 200, 255, 0.9)); }
}

/* MENU OPTIONS */
.menu-options, .end-options {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 320px;
}

.menu-item {
    position: relative;
    padding: 12px 30px;
    background: linear-gradient(90deg, rgba(0, 30, 60, 0.8) 0%, rgba(0, 10, 20, 0.2) 100%);
    border-left: 3px solid rgba(100, 200, 255, 0.3);
    border-bottom: 1px solid rgba(100, 200, 255, 0.1);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1.0);
    transform: skewX(-15deg);
    display: flex;
    align-items: center;
    overflow: hidden;
}

.menu-item::before {
    content: '';
    position: absolute;
    top: 0; left: -100%; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.4s;
}

.menu-item:hover::before {
    left: 100%;
}

.menu-item:hover {
    background: linear-gradient(90deg, rgba(0, 80, 160, 0.9) 0%, rgba(0, 20, 40, 0.4) 100%);
    border-left-color: #00ffff;
    padding-left: 45px;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
}

.menu-item .label {
    font-family: var(--font-title);
    font-size: 20px;
    color: #cccccc;
    letter-spacing: 3px;
    text-transform: uppercase;
    transform: skewX(15deg);
    transition: color 0.2s;
}

.menu-item:hover .label {
    color: #ffffff;
    text-shadow: 0 0 10px #00ffff;
}

.menu-item .cursor {
    width: 10px; height: 10px;
    background: var(--ffx-gold);
    border-radius: 50%;
    margin-right: 15px;
    opacity: 0;
    transform: translateX(-20px) skewX(15deg);
    transition: all 0.3s;
    box-shadow: 0 0 10px var(--ffx-gold);
}

.menu-item:hover .cursor {
    opacity: 1;
    transform: translateX(0) skewX(15deg);
}

.menu-footer {
    position: absolute;
    bottom: 30px;
    font-family: var(--font-ui);
    font-size: 10px;
    color: rgba(255,255,255,0.3);
    letter-spacing: 4px;
    text-transform: uppercase;
}

/* END GAME SPECIFIC */
.result-header {
    text-align: center;
    margin-bottom: 40px;
    transform: skewX(-10deg);
}

.result-title {
    font-family: var(--font-title);
    font-size: 72px;
    color: #fff;
    text-shadow: 0 0 20px #00aaff, 0 0 40px #0044aa;
    letter-spacing: 5px;
    line-height: 1.0;
}

.result-subtitle {
    font-family: var(--font-spira);
    font-size: 18px;
    color: var(--ffx-gold);
    letter-spacing: 8px;
    margin-top: 5px;
}

.final-score-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 40px;
    margin-bottom: 50px;
    background: linear-gradient(90deg, transparent, rgba(0, 20, 50, 0.8), transparent);
    padding: 20px 0;
    width: 100%;
}

.final-team {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 120px;
}

.final-score-digit {
    font-family: var(--font-data);
    font-size: 80px;
    color: #ffffff;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    line-height: 1.0;
}

.final-team.home .final-score-digit { color: #00ffff; text-shadow: 0 0 20px #00ffff; }
.final-team.away .final-score-digit { color: #ff4444; text-shadow: 0 0 20px #ff4444; }

.final-team-name {
    font-family: var(--font-title);
    font-size: 14px;
    color: #aaa;
    letter-spacing: 2px;
    margin-top: 5px;
}

.final-vs {
    display: flex;
    flex-direction: column;
    align-items: center;
    opacity: 0.6;
}

.final-vs span {
    font-family: var(--font-spira);
    font-size: 24px;
    color: var(--ffx-gold);
    margin: 5px 0;
}

.vs-line {
    width: 2px; height: 30px;
    background: linear-gradient(to bottom, transparent, var(--ffx-gold), transparent);
}
/* --- PRACTICE OVERLAY --- */
#practice-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 5, 10, 0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2500;
    pointer-events: none;
}

#practice-overlay.active {
    display: flex;
}

.practice-panel {
    position: absolute;
    top: max(60px, env(safe-area-inset-top) + 40px); 
    right: max(20px, env(safe-area-inset-right));
    width: 280px;
    background: linear-gradient(160deg, rgba(0, 20, 50, 0.95) 0%, rgba(0, 10, 20, 0.98) 100%);
    border: 1px solid #4488ff;
    border-radius: 0 0 15px 0;
    box-shadow: 0 0 20px rgba(0, 100, 255, 0.2), inset 0 0 50px rgba(0, 20, 60, 0.5);
    padding: 15px;
    pointer-events: auto;
    transform: skewX(-2deg);
    backdrop-filter: blur(5px);
}

.panel-header {
    margin-bottom: 15px;
    text-align: center;
}

.panel-title-group {
    display: flex;
    flex-direction: column;
}

.panel-title {
    font-family: var(--font-title);
    font-size: clamp(18px, 6vw, 24px);
    color: #ffffff;
    text-shadow: 0 0 10px #00ffff;
    letter-spacing: 2px;
}

.panel-subtitle {
    font-family: var(--font-spira);
    font-size: 8px;
    color: #4488ff;
    letter-spacing: 4px;
    margin-top: -2px;
}

.panel-deco-line {
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, transparent, #00ffff, transparent);
    margin-top: 5px;
    box-shadow: 0 0 5px #00ffff;
}

.panel-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.section-label {
    font-family: var(--font-ui);
    font-size: 10px;
    color: var(--ffx-gold);
    border-bottom: 1px solid rgba(200, 176, 96, 0.3);
    margin-bottom: 5px;
    padding-bottom: 2px;
    letter-spacing: 1px;
}

.drill-list {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.drill-btn {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    background: linear-gradient(90deg, rgba(255, 255, 255, 0.05), transparent);
    border-left: 2px solid transparent;
    cursor: pointer;
    font-family: var(--font-data);
    font-size: 14px;
    color: #aaa;
    transition: all 0.2s;
}

.drill-btn:hover {
    background: linear-gradient(90deg, rgba(0, 255, 255, 0.1), transparent);
    color: #fff;
    padding-left: 15px;
}

.drill-btn.active {
    background: linear-gradient(90deg, rgba(0, 100, 255, 0.4), transparent);
    border-left: 3px solid #00ffff;
    color: #fff;
    text-shadow: 0 0 5px #00ffff;
}

.drill-btn .icon {
    width: 20px;
    text-align: center;
    margin-right: 10px;
    color: var(--ffx-cyan);
}

.option-list {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.option-toggle {
    display: flex;
    align-items: center;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 12px;
    color: #ccc;
    transition: color 0.2s;
}

.option-toggle:hover { color: #fff; }

.option-toggle .checkbox {
    margin-right: 10px;
    color: #444;
    font-family: monospace;
    font-size: 14px;
}

.option-toggle.active .checkbox {
    color: #00ff00;
    text-shadow: 0 0 5px #00ff00;
}

.option-toggle.active {
    color: #fff;
}

.action-btn {
    text-align: center;
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid #444;
    padding: 6px;
    font-size: 11px;
    color: #aaa;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.action-btn:hover {
    border-color: #fff;
    color: #fff;
    background: rgba(255, 255, 255, 0.1);
}

#p-exit:hover {
    border-color: #ff4444;
    color: #ff4444;
    background: rgba(50, 0, 0, 0.3);
}

.panel-footer {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    text-align: center;
}

#drill-instruction {
    font-size: 10px;
    color: var(--ffx-cyan);
    margin-bottom: 5px;
    font-style: italic;
}

#drill-score {
    font-family: var(--font-data);
    font-size: 24px;
    color: var(--ffx-gold);
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

.panel-minimize-btn {
    position: absolute;
    top: 10px; right: 10px;
    width: 20px; height: 20px;
    border: 1px solid var(--ffx-cyan);
    color: var(--ffx-cyan);
    text-align: center;
    line-height: 18px;
    cursor: pointer;
    font-size: 14px;
    background: rgba(0,0,0,0.5);
    transition: all 0.2s;
}
.panel-minimize-btn:hover { 
    background: var(--ffx-cyan); 
    color: #000; 
    box-shadow: 0 0 5px var(--ffx-cyan);
}

#practice-restore-btn {
    position: absolute;
    top: max(60px, env(safe-area-inset-top) + 40px); 
    right: max(20px, env(safe-area-inset-right));
    padding: 8px 15px;
    background: linear-gradient(90deg, rgba(0, 20, 50, 0.9) 0%, rgba(0, 10, 20, 0.9) 100%);
    border: 1px solid var(--ffx-cyan);
    border-left: 3px solid var(--ffx-cyan);
    color: var(--ffx-cyan);
    font-family: var(--font-data);
    font-size: 12px;
    letter-spacing: 1px;
    cursor: pointer;
    z-index: 2400;
    display: none;
    pointer-events: auto;
    transform: skewX(-10deg);
    box-shadow: 0 0 10px rgba(0, 100, 255, 0.2);
    text-transform: uppercase;
}
#practice-restore-btn:hover {
    background: rgba(0, 40, 80, 0.9);
    color: #fff;
    text-shadow: 0 0 5px #00ffff;
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
}

/* --- AIM JOYSTICK --- */
#aim-joystick-zone {
    position: absolute;
    bottom: max(150px, env(safe-area-inset-bottom));
    right: 0;
    width: 40%;
    height: 35%;
    z-index: 1000;
    background: rgba(0,0,0,0);
    touch-action: none;
    pointer-events: auto;
}

#aim-joystick-visual {
    position: absolute;
    top: 0; left: 0;
    width: 0; height: 0;
    overflow: visible;
    pointer-events: none;
    display: none;
    z-index: 1100;
}

#aim-joystick-base {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 90px; height: 90px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(255, 100, 0, 0.3) 0%, rgba(80, 20, 0, 0.1) 60%, transparent 100%);
    border: 1px solid rgba(255, 150, 50, 0.4);
    box-shadow: 0 0 15px rgba(255, 100, 0, 0.2), inset 0 0 20px rgba(255, 50, 0, 0.2);
}

#aim-joystick-knob {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 40px; height: 40px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, #ffcc88 0%, #ff6600 40%, #882200 80%, #220000 100%);
    border: 2px solid #ffaa44;
    box-shadow: 0 0 10px #ff4400, inset 0 0 8px rgba(255,255,255,0.6);
    transition: transform 0.05s linear;
    will-change: transform;
}

#aim-joystick-knob::after {
    content: "AIM";
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 8px;
    color: white;
    font-family: var(--font-data);
    text-shadow: 0 0 3px #000;
}

/* --- TACKLE BUTTON --- */
#tackle-button {
    position: absolute;
    bottom: max(160px, env(safe-area-inset-bottom) + 100px);
    right: max(40px, env(safe-area-inset-right));
    width: 70px;
    height: 70px;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    justify-content: center;
    align-items: center;
    pointer-events: auto;
    z-index: 100;
    background: radial-gradient(circle at 35% 35%, #ff8888 0%, #cc0000 40%, #660000 80%, #220000 100%);
    border: 3px solid #ff4444;
    box-shadow: 0 0 15px rgba(255, 50, 50, 0.6), inset 0 0 15px rgba(255, 200, 200, 0.3);
    transition: transform 0.1s, filter 0.2s;
}

#tackle-button:active {
    transform: scale(0.9);
    filter: brightness(1.2);
}

#tackle-button.active {
    background: radial-gradient(circle at 35% 35%, #ffffff 0%, #ff4444 40%, #aa0000 80%, #440000 100%);
    box-shadow: 0 0 25px rgba(255, 100, 100, 0.9);
}

#tackle-button .btn-text {
    font-family: var(--font-data);
    font-size: 12px;
    font-weight: bold;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    pointer-events: none;
    text-transform: uppercase;
    letter-spacing: 1px;
}

#tackle-button .btn-glare {
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.3) 50%, transparent 60%);
    pointer-events: none;
    border-radius: 50%;
    animation: glarePass 4s infinite;
}

#tackle-button.urgent {
    animation: urgentPulse 0.5s infinite alternate;
    background: radial-gradient(circle at 35% 35%, #ff5555 0%, #ff0000 40%, #880000 100%);
    border-color: #ffaaaa;
    box-shadow: 0 0 20px #ff0000;
}

@keyframes urgentPulse {
    from { transform: scale(1.0); }
    to { transform: scale(1.15); }
}

/* --- CHARGE POWER METER --- */
#charge-meter-container {
    position: absolute;
    bottom: max(250px, env(safe-area-inset-bottom) + 100px);
    left: 50%;
    transform: translateX(-50%);
    width: 200px;
    display: none;
    flex-direction: column;
    align-items: center;
    pointer-events: none;
    z-index: 2000;
    background: rgba(0, 10, 30, 0.8);
    padding: 10px 15px;
    border: 1px solid var(--ffx-cyan);
    border-radius: 5px;
    box-shadow: 0 0 15px rgba(0, 100, 255, 0.3);
}

.charge-label {
    font-family: var(--font-spira);
    font-size: 12px;
    color: var(--ffx-cyan);
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 5px;
}

.charge-meter-track {
    width: 100%;
    height: 12px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #444;
    border-radius: 6px;
    overflow: hidden;
}

#charge-meter-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #0af, #0f0);
    box-shadow: 0 0 10px #0f0;
    transition: width 0.05s linear, background 0.1s;
    border-radius: 5px;
}

.charge-hint {
    font-family: var(--font-ui);
    font-size: 10px;
    color: var(--ffx-gold);
    margin-top: 5px;
    opacity: 0.8;
    animation: blink 0.5s infinite;
}

/* --- GOAL DISTANCE INDICATOR --- */
#goal-distance-container {
    position: absolute;
    top: max(75px, env(safe-area-inset-top) + 55px);
    left: max(20px, env(safe-area-inset-left));
    display: flex;
    flex-direction: column;
    align-items: center;
    pointer-events: none;
    z-index: 100;
    background: linear-gradient(90deg, rgba(0, 10, 30, 0.7) 0%, transparent 100%);
    padding: 5px 15px 5px 10px;
    border-left: 2px solid var(--ffx-gold);
}

.distance-label {
    font-family: var(--font-spira);
    font-size: 8px;
    color: var(--ffx-gold);
    letter-spacing: 2px;
    text-transform: uppercase;
}

#goal-distance {
    font-family: var(--font-data);
    font-size: 24px;
    color: white;
    text-shadow: 0 0 5px var(--ffx-gold);
}

/* --- SETTINGS BUTTON --- */
#settings-button {
    position: absolute;
    top: max(240px, env(safe-area-inset-top) + 100px);
    right: max(20px, env(safe-area-inset-right));
    width: 110px;
    padding: 8px 0;
    text-align: center;
    font-size: 10px;
    font-weight: bold;
    color: #888;
    background: linear-gradient(135deg, rgba(20, 20, 20, 0.8) 0%, rgba(10, 10, 10, 0.9) 100%);
    border: 1px solid #444;
    border-radius: 4px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    pointer-events: auto;
    transition: all 0.2s;
    z-index: 100;
}

#settings-button:hover {
    background: rgba(40, 40, 40, 0.9);
    border-color: #888;
    color: #fff;
}

/* --- SETTINGS PANEL --- */
#settings-panel {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 280px;
    background: linear-gradient(160deg, rgba(0, 20, 50, 0.98) 0%, rgba(0, 10, 20, 0.99) 100%);
    border: 2px solid var(--ffx-cyan);
    border-radius: 10px;
    box-shadow: 0 0 30px rgba(0, 100, 255, 0.4);
    z-index: 3500;
    pointer-events: auto;
    backdrop-filter: blur(10px);
}

.settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid rgba(100, 200, 255, 0.3);
    background: rgba(0, 30, 60, 0.5);
}

.settings-header span {
    font-family: var(--font-title);
    font-size: 20px;
    color: white;
    text-shadow: 0 0 5px var(--ffx-cyan);
    letter-spacing: 3px;
}

#settings-close {
    width: 30px;
    height: 30px;
    border: 1px solid #ff4444;
    background: rgba(50, 0, 0, 0.5);
    color: #ff4444;
    font-size: 14px;
    cursor: pointer;
    border-radius: 5px;
    transition: all 0.2s;
}

#settings-close:hover {
    background: #ff4444;
    color: white;
}

.settings-content {
    padding: 20px;
}

.setting-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 5px;
}

.setting-row label {
    font-family: var(--font-data);
    font-size: 14px;
    color: #ccc;
}

.setting-row input[type="range"] {
    width: 100px;
    accent-color: var(--ffx-cyan);
}

.setting-row input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--ffx-cyan);
    cursor: pointer;
}

/* --- GLARE ANIMATION --- */
@keyframes glarePass {
    0% { transform: translateX(-100%) rotate(45deg); }
    30% { transform: translateX(100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}

/* --- STATUS TYPE FLOATING TEXT --- */
.floating-text-inner.status {
    font-family: var(--font-data);
    font-size: 28px;
    font-style: italic;
    color: #ff00ff;
    text-shadow: 0 0 10px #ff00ff, 2px 2px 0 #000;
    animation: statusPop 1.2s ease-out forwards;
}

@keyframes statusPop {
    0% { transform: scale(0.5) translateY(0); opacity: 0; }
    20% { transform: scale(1.3) translateY(-10px); opacity: 1; }
    100% { transform: scale(1.0) translateY(-40px); opacity: 0; }
}

/* --- GOAL TYPE FLOATING TEXT --- */
.floating-text-inner.goal {
    font-family: var(--font-data);
    font-size: 48px;
    font-weight: 900;
    background: linear-gradient(to bottom, #fff 0%, #ffd700 50%, #ff8800 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 4px 4px rgba(0,0,0,0.9));
    animation: goalPop 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

@keyframes goalPop {
    0% { transform: scale(0) rotate(-10deg); opacity: 0; }
    50% { transform: scale(1.5) rotate(5deg); opacity: 1; }
    100% { transform: scale(1.2) rotate(0deg); opacity: 0; }
}

/* --- DEFAULT TYPE FLOATING TEXT --- */
.floating-text-inner.default {
    font-family: var(--font-data);
    font-size: 24px;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    animation: floatUp 0.8s ease-out forwards;
}

/* --- MOBILE PORTRAIT OPTIMIZATIONS --- */
@media screen and (orientation: portrait) {
    .team-wing { width: 80px; padding: 0 5px; }
    .score-box { font-size: 24px; margin: 0 2px; min-width: 20px; }
    .team-name { font-size: 10px; letter-spacing: 0px; }
    .team-sub { display: none; }
    
    .timer-crystal-ring { width: 70px; height: 35px; top: -10px; }
    #timer-display { font-size: 24px; }
    #half-indicator { font-size: 10px; letter-spacing: 1px; }
    
    #minimap-container { width: 80px; height: 80px; top: max(60px, env(safe-area-inset-top) + 50px); }
    #minimap { width: 70px; height: 70px; }
    .radar-label { font-size: 8px; bottom: -10px; }
    
    .tech-text { font-size: 24px; }
    
    #action-button { width: 70px; height: 70px; }
    #action-button .btn-text { font-size: 16px; }
    .command-ring { width: 90px; height: 90px; }
    #action-label { font-size: 10px; padding: 2px 8px; margin-bottom: 10px; }
    
    #player-status-panel { width: 120px; bottom: max(120px, env(safe-area-inset-bottom) + 10px); left: 10px; }
    .char-name { font-size: 12px; }
    .hp-value { font-size: 8px; }
    
    #auto-toggle, #settings-button, #practice-restore-btn {
        width: 80px;
        font-size: 8px;
        right: max(10px, env(safe-area-inset-right));
        padding: 6px 0;
    }
    
    #goal-distance-container { left: max(10px, env(safe-area-inset-left)); top: max(60px, env(safe-area-inset-top) + 45px); }
    #goal-distance { font-size: 16px; }
    
    /* Fix Announcement Text Cutoff */
    #announcement {
        font-size: clamp(32px, 10vw, 60px);
        width: 95%;
        left: 2.5%;
        white-space: normal;
        word-wrap: break-word;
        line-height: 1.1;
    }
    .announcement-slam {
        font-size: clamp(48px, 15vw, 80px) !important;
        white-space: normal !important;
    }

    /* Menu Adjustments */
    .ffx-logo-main { font-size: clamp(36px, 12vw, 60px); letter-spacing: 4px; }
    .ffx-logo-sub { font-size: clamp(12px, 4vw, 18px); letter-spacing: 8px; }
    .menu-options { width: 260px; }
    .menu-item { padding: 10px 20px; }
    .menu-item .label { font-size: 16px; }
}
/* --- GESTURE HINT --- */
#gesture-hint {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 200px; height: 300px;
    pointer-events: none;
    display: none;
    z-index: 2500;
    opacity: 0.9;
}

#gesture-hint.active {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.curve-arrow {
    filter: drop-shadow(0 0 5px #00ffff);
    animation: dashDraw 1.5s linear infinite;
}

@keyframes dashDraw {
    to { stroke-dashoffset: -30; }
}

.gesture-text {
    font-family: var(--font-data);
    font-size: 24px;
    color: #ffffff;
    text-shadow: 0 0 10px #00ffff;
    margin-top: -50px;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-align: center;
}

.gesture-hand {
    font-size: 48px;
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    animation: handSwipe 1.5s ease-in-out infinite;
    filter: drop-shadow(0 0 10px black);
}

@keyframes handSwipe {
    0% { transform: translate(-50%, 50px) rotate(0deg); opacity: 0; }
    20% { opacity: 1; }
    80% { transform: translate(20px, -100px) rotate(20deg); opacity: 1; }
    100% { transform: translate(0px, -120px) rotate(10deg); opacity: 0; }
}

/* --- SWIPE TRAIL (INTUITIVE FEEDBACK) --- */
.swipe-trail-dot {
    position: absolute;
    width: 12px;
    height: 12px;
    background: radial-gradient(circle, #00ffff 0%, rgba(0, 255, 255, 0) 70%);
    border-radius: 50%;
    pointer-events: none;
    z-index: 9000;
    animation: fadeTrail 0.5s linear forwards;
    mix-blend-mode: screen;
    will-change: transform, opacity;
}

@keyframes fadeTrail {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(0.2); opacity: 0; }
}
@keyframes fadeTrail {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(0.2); opacity: 0; }
}

/* --- OFFSCREEN INDICATOR --- */
#offscreen-indicator {
    position: absolute;
    top: 0; left: 0;
    width: 40px; height: 40px;
    margin-left: -20px; margin-top: -20px;
    z-index: 1500;
    pointer-events: none;
    display: none;
    filter: drop-shadow(0 0 5px #000);
}

#offscreen-indicator .arrow {
    width: 0; height: 0;
    border-left: 15px solid transparent;
    border-right: 15px solid transparent;
    border-bottom: 25px solid #00ff00; /* Green for player */
    animation: pulseArrow 0.5s infinite alternate;
    transform-origin: center bottom;
}

@keyframes pulseArrow {
    from { transform: scale(1); filter: brightness(1); }
    to { transform: scale(1.2); filter: brightness(1.5); }
}</style>

    <!-- Three.js Core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- GLTFLoader -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/utils/SkeletonUtils.js"></script>
    <!-- Lil-GUI -->
    <script src="https://cdn.jsdelivr.net/npm/lil-gui@0.19.1/dist/lil-gui.umd.min.js"></script>
<script type="importmap">{"imports":{"style.css":"data:text/css;base64,OnJvb3QgewogICAgLS1mZngtYmx1ZS1kZWVwOiAjMDIwNDA4OwogICAgLS1mZngtYmx1ZS1kYXJrOiAjMGExNTI1OwogICAgLS1mZngtYmx1ZS1taWQ6ICMxNTJhNDU7CiAgICAtLWZmeC1ibHVlLWxpZ2h0OiAjMmE0ZDc1OwogICAgLS1mZngtY3lhbjogIzYwYzBkMDsKICAgIC0tZmZ4LWN5YW4tZ2xvdzogIzAwZmZmZjsKICAgIC0tZmZ4LWdvbGQ6ICNjOGIwNjA7CiAgICAtLWZmeC1nb2xkLWxpZ2h0OiAjZjBlMDkwOwogICAgLS1mZngtZ29sZC1kYXJrOiAjOGE3MDMwOwogICAgLS1mZngtZ2xhc3MtYmc6IHJnYmEoMTAsIDIwLCA0MCwgMC43NSk7CiAgICAtLWZmeC1nbGFzcy1ib3JkZXI6IHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIAogICAgLS1mb250LXRpdGxlOiAnR2FyYW1vbmQnLCAnVGltZXMgTmV3IFJvbWFuJywgc2VyaWY7CiAgICAtLWZvbnQtZGF0YTogJ0ltcGFjdCcsICdBcmlhbCBOYXJyb3cnLCBzYW5zLXNlcmlmOwogICAgLS1mb250LXVpOiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAtLWZvbnQtc3BpcmE6ICdTcGlyYScsICdJbXBhY3QnLCBzYW5zLXNlcmlmOwp9CgpAZm9udC1mYWNlIHsKICAgIGZvbnQtZmFtaWx5OiAnU3BpcmEnOwogICAgc3JjOiB1cmwoJ2h0dHBzOi8vZmlsZXMuY2F0Ym94Lm1vZS96eW43czMudHRmJykgZm9ybWF0KCd0cnVldHlwZScpOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgIGZvbnQtc3R5bGU6IG5vcm1hbDsKfQoKaHRtbCwgYm9keSB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB3aWR0aDogMTAwdnc7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBwb3NpdGlvbjogZml4ZWQ7IAogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHJpZ2h0OiAwOwogICAgYm90dG9tOiAwOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBjb2xvcjogd2hpdGU7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICBwYWRkaW5nLXRvcDogZW52KHNhZmUtYXJlYS1pbnNldC10b3ApOwogICAgcGFkZGluZy1ib3R0b206IGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKTsKICAgIHBhZGRpbmctbGVmdDogZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KTsKICAgIHBhZGRpbmctcmlnaHQ6IGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpOwp9CgoqIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7Cn0KCi8qIC0tLSBNQUlOIEdBTUUgQ09OVEFJTkVSIC0tLSAqLwojZ2FtZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgbWF4LXdpZHRoOiBub25lOwogICAgYmFja2dyb3VuZDogIzAwMDUxMDsKICAgIGJveC1zaGFkb3c6IG5vbmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgdHJhbnNpdGlvbjogZmlsdGVyIDAuMDVzOwogICAgei1pbmRleDogMTsKICAgIGNvbnRhaW46IHN0cmljdDsKfQoKLyogLS0tIElNUEFDVCBGWCAtLS0gKi8KI2dhbWUtY29udGFpbmVyLmltcGFjdC1meCB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuMXMgZWFzZS1pbi1vdXQ7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDEuMikgYnJpZ2h0bmVzcygxLjEpOwp9CgojZ2FtZS1jb250YWluZXIuaW1wYWN0LWhlYXZ5IHsKICAgIGFuaW1hdGlvbjogaW1wYWN0U2hha2UgMC4ycyBlYXNlLWluLW91dDsKICAgIGZpbHRlcjogY29udHJhc3QoMS41KSBicmlnaHRuZXNzKDEuMykgc2VwaWEoMC40KSBodWUtcm90YXRlKC0xMGRlZyk7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3Qtc2hhdHRlciB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuNHMgZWFzZS1pbi1vdXQ7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDIuMCkgaW52ZXJ0KDAuMSkgc2F0dXJhdGUoMi4wKTsKfQoKQGtleWZyYW1lcyBpbXBhY3RTaGFrZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDAsIDApOyB9CiAgICAyNSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNXB4LCA1cHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSg1cHgsIC01cHgpOyB9CiAgICA3NSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNXB4LCAtNXB4KTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDAsIDApOyB9Cn0KCi8qIC0tLSBDQU5WQVMgJiBSRU5ERVIgLS0tICovCmNhbnZhcyB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsKICAgIGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGltYWdlLXJlbmRlcmluZzogcGl4ZWxhdGVkOyAKICAgIHotaW5kZXg6IDA7Cn0KCi8qIC0tLSBHSUYgT1ZFUkxBWSAtLS0gKi8KI3NjcmVlbi1vdmVybGF5LWdpZiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgb2JqZWN0LWZpdDogY292ZXI7CiAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKICAgIG9wYWNpdHk6IDEuMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogOTUwOwogICAgaW1hZ2UtcmVuZGVyaW5nOiBwaXhlbGF0ZWQ7Cn0KCiN1aS1sYXllciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgei1pbmRleDogMTAwMDsKICAgIGNvbnRhaW46IHN0cmljdDsKfQoKLyogLS0tIENJTkVNQVRJQyBCQVJTIC0tLSAqLwojY2luZW1hdGljLWJhcnMgLmJhciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAwOwogICAgYmFja2dyb3VuZDogYmxhY2s7CiAgICB0cmFuc2l0aW9uOiBoZWlnaHQgMC41cyBlYXNlOwogICAgei1pbmRleDogODAwOwp9CiNjaW5lbWF0aWMtYmFycyAuYmFyLnRvcCB7IHRvcDogMDsgfQojY2luZW1hdGljLWJhcnMgLmJhci5ib3R0b20geyBib3R0b206IDA7IH0KCi8qIC0tLSBURUNIIEZMQVNIIE9WRVJMQVkgLS0tICovCiN0ZWNoLWZsYXNoLW92ZXJsYXkgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAyMCU7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEyMHB4OwogICAgZGlzcGxheTogbm9uZTsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwwLDAsMCkgMCUsIHJnYmEoMCwgMjAsIDYwLCAwLjkpIDIwJSwgcmdiYSgwLCAyMCwgNjAsIDAuOSkgODAlLCByZ2JhKDAsMCwwLDApIDEwMCUpOwogICAgei1pbmRleDogMjIwMDsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigycHgpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMTAwLCAyNTUsIDI1NSwgMC4zKTsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDEwMCwgMjU1LCAyNTUsIDAuMyk7CiAgICBhbmltYXRpb246IGZsYXNoRW50ZXIgMC4xNXMgZWFzZS1vdXQ7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBvcGFjaXR5Owp9CgpAa2V5ZnJhbWVzIGZsYXNoRW50ZXIgewogICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGVZKDApOyBvcGFjaXR5OiAwOyB9CiAgICB0byB7IHRyYW5zZm9ybTogc2NhbGVZKDEpOyBvcGFjaXR5OiAxOyB9Cn0KCi50ZWNoLWNvbnRlbnQtd3JhcHBlciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7Cn0KCi50ZWNoLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiBjbGFtcCgyOHB4LCAxMHZ3LCA0MnB4KTsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICMwMGZmZmYsIDAgMCAyMHB4ICMwMDAwZmY7CiAgICBsZXR0ZXItc3BhY2luZzogM3B4OwogICAgbWFyZ2luLWJvdHRvbTogMnB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgYW5pbWF0aW9uOiBibGlua1RleHQgMC4wOHMgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgoudGVjaC1zdWItdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjb2xvcjogIzAwZmZmZjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgbWFyZ2luLWJvdHRvbTogOHB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggcmdiYSgwLCAyNTUsIDI1NSwgMC41KTsKfQoKLnRlY2gtdGltZXItdHJhY2sgewogICAgd2lkdGg6IDI1MHB4OwogICAgaGVpZ2h0OiA4cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuNik7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ0OwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMCwwLDAsMC41KTsKfQoKLnRlY2gtdGltZXItZmlsbCB7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZmZmZmYsICMwMGZmZmYpOwogICAgd2lkdGg6IDEwMCU7CiAgICB0cmFuc2Zvcm0tb3JpZ2luOiBsZWZ0OwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKfQoKQGtleWZyYW1lcyBibGlua1RleHQgewogICAgZnJvbSB7IG9wYWNpdHk6IDAuODsgdGV4dC1zaGFkb3c6IDAgMCA1cHggIzAwZmZmZjsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgfQogICAgdG8geyBvcGFjaXR5OiAxLjA7IHRleHQtc2hhZG93OiAwIDAgMjBweCAjZmZmZmZmLCAwIDAgMTBweCAjMDBmZmZmOyB0cmFuc2Zvcm06IHNjYWxlKDEuMDIpOyB9Cn0KCi8qIC0tLSBIVUQgVE9QIC0tLSAqLwovKiAtLS0gSFVEIFRPUCAtLS0gKi8KI2h1ZC10b3AgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogZmxleC1zdGFydDsKICAgIHdpZHRoOiAxMDAlOwogICAgcGFkZGluZzogMTVweDsKICAgIHBhZGRpbmctdG9wOiBtYXgoMTVweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApKTsKICAgIHBhZGRpbmctbGVmdDogbWF4KDE1cHgsIGVudihzYWZlLWFyZWEtaW5zZXQtbGVmdCkpOwogICAgcGFkZGluZy1yaWdodDogbWF4KDE1cHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCByZ2JhKDAsIDUsIDE1LCAwLjkpIDAlLCByZ2JhKDAsMCwwLDApIDEwMCUpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuNXM7Cn0KCi50ZWFtLXdpbmcgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB3aWR0aDogMTQwcHg7CiAgICBoZWlnaHQ6IDU1cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTYwZGVnLCByZ2JhKDIwLCA0MCwgODAsIDAuOSkgMCUsIHJnYmEoNSwgMTAsIDIwLCAwLjk1KSAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIGJvcmRlci10b3A6IDJweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xNWRlZyk7CiAgICBib3gtc2hhZG93OiAwIDVweCAxNXB4IHJnYmEoMCwgMCwgMCwgMC41KSwgaW5zZXQgMCAwIDIwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC4xKTsKICAgIHBhZGRpbmc6IDAgMTVweDsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig0cHgpOwp9CgoudGVhbS13aW5nOjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHJnYmEoMjU1LDI1NSwyNTUsMC4xKSwgdHJhbnNwYXJlbnQpOwogICAgYW5pbWF0aW9uOiB3aW5nU2hpbW1lciA0cyBpbmZpbml0ZTsKfQoKQGtleWZyYW1lcyB3aW5nU2hpbW1lciB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtMTAwJSk7IH0KICAgIDIwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxMDAlKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxMDAlKTsgfQp9CgoudGVhbS13aW5nLmF3YXkgewogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZyk7CiAgICBmbGV4LWRpcmVjdGlvbjogcm93LXJldmVyc2U7CiAgICBib3JkZXItdG9wLWNvbG9yOiAjZmY2NjY2OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KC0xNjBkZWcsIHJnYmEoNjAsIDIwLCAyMCwgMC45KSAwJSwgcmdiYSgyMCwgNSwgNSwgMC45NSkgMTAwJSk7Cn0KCi50ZWFtLWRhdGEgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpOwogICAgZmxleC1ncm93OiAxOwp9Ci50ZWFtLXdpbmcuYXdheSAudGVhbS1kYXRhIHsgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpOyB0ZXh0LWFsaWduOiByaWdodDsgfQoKLnRlYW0tbmFtZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDE2cHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggcmdiYSgwLCAxNTAsIDI1NSwgMC44KTsKfQoudGVhbS1zdWIgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgb3BhY2l0eTogMC44OwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKfQoudGVhbS13aW5nLmF3YXkgLnRlYW0tc3ViIHsgY29sb3I6ICNmZmFhYWE7IH0KCi5zY29yZS1ib3ggewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDE1cHggdmFyKC0tZmZ4LWN5YW4tZ2xvdyk7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDE1ZGVnKTsKICAgIG1hcmdpbjogMCA1cHg7CiAgICBtaW4td2lkdGg6IDMwcHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KLnRlYW0td2luZy5hd2F5IC5zY29yZS1ib3ggeyB0cmFuc2Zvcm06IHNrZXdYKC0xNWRlZyk7IHRleHQtc2hhZG93OiAwIDAgMTVweCAjZmY0NDQ0OyB9CgoudGltZXItY29tcGxleCB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBtYXJnaW4tdG9wOiAtNXB4Owp9CgoudGltZXItY3J5c3RhbC1yaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTMwcHg7CiAgICB3aWR0aDogMTQwcHg7CiAgICBoZWlnaHQ6IDcwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXItdG9wOiAzcHggc29saWQgdmFyKC0tZmZ4LWdvbGQpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHRyYW5zcGFyZW50OwogICAgYm94LXNoYWRvdzogMCAtNXB4IDIwcHggcmdiYSgyMDAsIDE4MCwgMTAwLCAwLjQpLCBpbnNldCAwIDEwcHggMjBweCByZ2JhKDAsMCwwLDAuNSk7CiAgICB6LWluZGV4OiAtMTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChlbGxpcHNlIGF0IHRvcCwgcmdiYSgyMCwgNDAsIDgwLCAwLjkpLCB0cmFuc3BhcmVudCA3MCUpOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7Cn0KCiNoYWxmLWluZGljYXRvciB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIG1hcmdpbi1ib3R0b206IC00cHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtZ29sZC1kYXJrKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KCiN0aW1lci1kaXNwbGF5IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiA0OHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZiAwJSwgI2ZmZDcwMCA1MCUsICNiODg2MGIgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAycHggMHB4IHJnYmEoMCwwLDAsMC44KSk7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4Owp9Ci8qIC0tLSBQTEFZRVIgU1RBVFVTIFBBTkVMIC0tLSAqLwojcGxheWVyLXN0YXR1cy1wYW5lbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCgxNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pICsgNDBweCk7CiAgICBsZWZ0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KSk7CiAgICB3aWR0aDogMTYwcHg7CiAgICBwYWRkaW5nOiAxMHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDEwLCAzMCwgMC44KSAwJSwgcmdiYSgwLDAsMCwwKSAxMDAlKTsKICAgIGJvcmRlci1sZWZ0OiAzcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogMCAxMHB4IDEwcHggMDsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig0cHgpOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwp9CgouY2hhci1uYW1lIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMThweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBtYXJnaW4tYm90dG9tOiA1cHg7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDEwZGVnKTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1ibHVlLWxpZ2h0KTsKfQoKLmhwLWdhdWdlLWNvbnRhaW5lciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG1hcmdpbi1ib3R0b206IDRweDsKICAgIHRyYW5zZm9ybTogc2tld1goMTBkZWcpOwp9Ci5ocC1sYWJlbCB7IGZvbnQtc2l6ZTogMTBweDsgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsgd2lkdGg6IDIwcHg7IH0KLmhwLWJhci10cmFjayB7CiAgICBmbGV4LWdyb3c6IDE7CiAgICBoZWlnaHQ6IDZweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC41KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBtYXJnaW46IDAgNXB4Owp9Ci5ocC1iYXItZmlsbCB7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwMGZmMDAsICNjY2ZmY2MpOwogICAgYm94LXNoYWRvdzogMCAwIDVweCAjMDBmZjAwOwp9Ci5ocC12YWx1ZSB7IGZvbnQtc2l6ZTogMTBweDsgY29sb3I6ICNmZmY7IHdpZHRoOiA0NXB4OyB0ZXh0LWFsaWduOiByaWdodDsgfQoKLnRlY2gtZ2F1Z2UtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7Cn0KLnRlY2gtbGFiZWwgeyBmb250LXNpemU6IDEwcHg7IGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7IHdpZHRoOiAyMHB4OyB9Ci50ZWNoLWJhci10cmFjayB7CiAgICBmbGV4LWdyb3c6IDE7CiAgICBoZWlnaHQ6IDRweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC41KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBtYXJnaW46IDAgNXB4Owp9Ci50ZWNoLWJhci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmYWEwMCwgI2ZmZmZhYSk7Cn0KCi8qIC0tLSBNSU5JTUFQIC0tLSAqLwojbWluaW1hcC1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoODBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNjBweCk7CiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiAxMTBweDsKICAgIGhlaWdodDogMTEwcHg7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgoucmFkYXItcmltIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDJweCBzb2xpZCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCB2YXIoLS1mZngtYmx1ZS1taWQpLCBpbnNldCAwIDAgMjBweCByZ2JhKDAsMCwwLDAuOCk7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCByZ2JhKDAsIDIwLCA2MCwgMC40KSAwJSwgcmdiYSgwLCA1LCAxMCwgMC44KSAxMDAlKTsKICAgIHotaW5kZXg6IDU7Cn0KCiNtaW5pbWFwIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIHdpZHRoOiAxMDBweDsKICAgIGhlaWdodDogMTAwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB6LWluZGV4OiA2OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKLnJhZGFyLWxhYmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogLTE1cHg7CiAgICB3aWR0aDogMTQwJTsKICAgIGxlZnQ6IC0yMCU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKfQoKLm1hcC1kb3QgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDZweDsgaGVpZ2h0OiA2cHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGJveC1zaGFkb3c6IDAgMCA0cHggY3VycmVudENvbG9yOwp9Ci5tYXAtZG90LmhvbWUgeyBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtY3lhbik7IGNvbG9yOiB2YXIoLS1mZngtY3lhbik7IH0KLm1hcC1kb3QuYXdheSB7IGJhY2tncm91bmQ6ICNmZjQ0NDQ7IGNvbG9yOiAjZmY0NDQ0OyB9Ci5tYXAtZG90LmJhbGwgeyAKICAgIGJhY2tncm91bmQ6ICNmZjAwY2M7CiAgICBjb2xvcjogI2ZmMDBjYzsgCiAgICB3aWR0aDogMTJweDsgaGVpZ2h0OiAxMnB4OwogICAgYm9yZGVyOiAycHggc29saWQgI2ZmZmZmZjsKICAgIHotaW5kZXg6IDIwOwogICAgYW5pbWF0aW9uOiBibGlua0JhbGwgMC4zcyBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICBib3gtc2hhZG93OiAwIDAgNnB4ICNmZjAwY2M7Cn0KLm1hcC1kb3QubmFwIHsgYmFja2dyb3VuZDogIzMzMzsgY29sb3I6ICMwMDA7IGJvcmRlcjogMXB4IHNvbGlkICM1NTU7IH0KLm1hcC1kb3QuYWN0aXZlLXBsYXllciB7IAogICAgYmFja2dyb3VuZDogIzAwZmYwMCAhaW1wb3J0YW50OyAKICAgIGNvbG9yOiAjMDBmZjAwICFpbXBvcnRhbnQ7IAogICAgYm94LXNoYWRvdzogMCAwIDhweCAjMDBmZjAwOwogICAgei1pbmRleDogMTU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjIpOwp9Ci5tYXAtZG90LmJhbGwtY2FycmllciB7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCAjZmZmLCAwIDAgMzBweCAjZmZhYTAwOwogICAgYm9yZGVyOiAycHggc29saWQgI2ZmZmZmZjsKICAgIGJhY2tncm91bmQtY29sb3I6ICNmZmFhMDAgIWltcG9ydGFudDsKICAgIHotaW5kZXg6IDEwMDsKICAgIHdpZHRoOiAxMHB4OyBoZWlnaHQ6IDEwcHg7CiAgICBhbmltYXRpb246IGNhcnJpZXJQdWxzZSAwLjhzIGluZmluaXRlIGFsdGVybmF0ZTsKfQpAa2V5ZnJhbWVzIGNhcnJpZXJQdWxzZSB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4yKTsgYm94LXNoYWRvdzogMCAwIDEwcHggI2ZmZjsgb3BhY2l0eTogMC44OyB9CiAgICB0byB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuOCk7IGJveC1zaGFkb3c6IDAgMCAyNXB4ICNmZmNjMDA7IG9wYWNpdHk6IDEuMDsgfQp9CkBrZXlmcmFtZXMgYmxpbmtCYWxsIHsgZnJvbSB7IG9wYWNpdHk6IDE7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyB9IHRvIHsgb3BhY2l0eTogMC41OyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjMpOyB9IH0KCi8qIC0tLSBBTk5PVU5DRU1FTlRTIC0tLSAqLwojYW5ub3VuY2VtZW50IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNDAlOyAKICAgIGxlZnQ6IDUlOyAKICAgIHdpZHRoOiA5MCU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoNDBweCwgMTJ2dywgNzJweCk7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBsaW5lLWhlaWdodDogMS4wOwogICAgd2hpdGUtc3BhY2U6IG5vcm1hbDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmYgMCUsICNmZmQ3MDAgNDAlLCAjYjg4NjBiIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuNSkpIGRyb3Atc2hhZG93KDNweCAzcHggMCAjMDAwKTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAyMDAwOwogICAgYW5pbWF0aW9uOiBhbm5vdW5jZVNsaWRlIDAuNXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBvcGFjaXR5Owp9CgpAa2V5ZnJhbWVzIGFubm91bmNlU2xpZGUgewogICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGUoMCkgcm90YXRlKC01ZGVnKTsgb3BhY2l0eTogMDsgfQogICAgdG8geyB0cmFuc2Zvcm06IHNjYWxlKDEpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMTsgfQp9CgovKiAtLS0gSk9ZU1RJQ0sgLS0tICovCiNqb3lzdGljay1oaXQtem9uZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogNTAlOyBoZWlnaHQ6IDUwJTsKICAgIHotaW5kZXg6IDEwMDA7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDApOyAKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9Cgojam95c3RpY2stdmlzdWFsLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMDsgaGVpZ2h0OiAwOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAxMTAwOwp9Cgojam95c3RpY2stYmFzZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMTIwcHg7IGhlaWdodDogMTIwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCByZ2JhKDAsIDQwLCA4MCwgMC40KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuMSkgNjAlLCB0cmFuc3BhcmVudCAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMTAwLCAyMjAsIDI1NSwgMC4zKTsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMiksIGluc2V0IDAgMCAzMHB4IHJnYmEoMCwgNTAsIDEwMCwgMC4zKTsKICAgIGFuaW1hdGlvbjogYmFzZVB1bHNlIDJzIGluZmluaXRlIGFsdGVybmF0ZTsKfQoKQGtleWZyYW1lcyBiYXNlUHVsc2UgewogICAgZnJvbSB7IGJveC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMik7IGJvcmRlci1jb2xvcjogcmdiYSgxMDAsIDIyMCwgMjU1LCAwLjIpOyB9CiAgICB0byB7IGJveC1zaGFkb3c6IDAgMCAyNXB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuNSk7IGJvcmRlci1jb2xvcjogcmdiYSgxMDAsIDI1NSwgMjU1LCAwLjYpOyB9Cn0KCiNqb3lzdGljay1rbm9iIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiA1MHB4OyBoZWlnaHQ6IDUwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsICNlMGZmZmYgMCUsICMwMGFhZmYgNDAlLCAjMDA0NDg4IDgwJSwgIzAwMTEyMiAxMDAlKTsKICAgIGJvcmRlcjogMnB4IHNvbGlkICM4OGNjZmY7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCAjMDBmZmZmLCBpbnNldCAwIDAgMTBweCByZ2JhKDI1NSwyNTUsMjU1LDAuOCk7CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4wNXMgbGluZWFyOwogICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybTsKfQoKI2pveXN0aWNrLWtub2I6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICIiOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAyMCU7IGxlZnQ6IDIwJTsgd2lkdGg6IDIwJTsgaGVpZ2h0OiAyMCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAjZmZmZmZmIDAlLCB0cmFuc3BhcmVudCA3MCUpOwogICAgZmlsdGVyOiBibHVyKDJweCk7CiAgICBvcGFjaXR5OiAwLjg7Cn0KCi50b3VjaC1yaXBwbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgyMDAsIDI1NSwgMjU1LCAwLjgpIDAlLCByZ2JhKDAsIDI1NSwgMjU1LCAwLjQpIDQwJSwgdHJhbnNwYXJlbnQgNzAlKTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDApOwogICAgYW5pbWF0aW9uOiByaXBwbGVBbmltIDAuNnMgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDkwMDA7CiAgICBtaXgtYmxlbmQtbW9kZTogc2NyZWVuOwogICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybSwgb3BhY2l0eTsKfQoKQGtleWZyYW1lcyByaXBwbGVBbmltIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMCk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgzLjApOyBvcGFjaXR5OiAwOyB9Cn0KCiNjYW1lcmEtem9uZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IHJpZ2h0OiAwOyB3aWR0aDogNTAlOyBoZWlnaHQ6IDEwMCU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHotaW5kZXg6IDUwOwp9CgovKiAtLS0gQUNUSU9OIEJVVFRPTiAtLS0gKi8KI2FjdGlvbi1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiBtYXgoNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pKTsgCiAgICByaWdodDogbWF4KDQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgei1pbmRleDogMTAwOwp9CgouY29tbWFuZC1tZW51LWJnIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxODBweDsgaGVpZ2h0OiA4MHB4OwogICAgYm90dG9tOiAxNXB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCAwJSwgcmdiYSgwLCAxMCwgMzAsIDAuOCkgNTAlLCB0cmFuc3BhcmVudCAxMDAlKTsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDAsIDIwMCwgMjU1LCAwLjMpOwogICAgei1pbmRleDogLTE7Cn0KCi5jb21tYW5kLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDEzMHB4OyBoZWlnaHQ6IDEzMHB4OwogICAgYm9yZGVyOiAycHggc29saWQgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjEpOwogICAgYm9yZGVyLXRvcDogMnB4IHNvbGlkIHJnYmEoMCwgMjU1LCAyNTUsIDAuNik7CiAgICBib3JkZXItYm90dG9tOiAycHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC42KTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGFuaW1hdGlvbjogc3BpblJldmVyc2UgMTVzIGxpbmVhciBpbmZpbml0ZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLCAxMDAsIDI1NSwgMC4yKTsKfQpAa2V5ZnJhbWVzIHNwaW5SZXZlcnNlIHsgZnJvbSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHJvdGF0ZSgzNjBkZWcpOyB9IHRvIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgcm90YXRlKDBkZWcpOyB9IH0KCiNhY3Rpb24tbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNSwgMTAsIDAuOCk7CiAgICBwYWRkaW5nOiA0cHggMTJweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZmeC1ibHVlLWxpZ2h0KTsKICAgIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCByZ2JhKDAsMCwwLDAuOCk7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4zczsKfQoKI2FjdGlvbi1idXR0b24gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDEwMHB4OyBoZWlnaHQ6IDEwMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMXMsIGZpbHRlciAwLjNzOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmZmZmZmIDAlLCAjMDA4OGZmIDQwJSwgIzAwMjI2NiA4MCUsICMwMDAgMTAwJSk7CiAgICBib3JkZXI6IDNweCBzb2xpZCAjNDRhYWZmOwogICAgYm94LXNoYWRvdzogMCAwIDIwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC44KSwgaW5zZXQgMCAwIDIwcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjQpOwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG92ZXJmbG93OiB2aXNpYmxlOwogICAgei1pbmRleDogMTA7Cn0KCiNwYXNzLWJ1dHRvbiB7CiAgICBkaXNwbGF5OiBub25lICFpbXBvcnRhbnQ7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IC0yMHB4OyBsZWZ0OiAtMzBweDsKICAgIHdpZHRoOiA2MHB4OyBoZWlnaHQ6IDYwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB6LWluZGV4OiA5Owp9CgojYWN0aW9uLWJ1dHRvbjo6YmVmb3JlIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtNDBweDsgbGVmdDogLTQwcHg7IHJpZ2h0OiAtNDBweDsgYm90dG9tOiAtNDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHotaW5kZXg6IDEwOwp9CgojYWN0aW9uLWJ1dHRvbjphY3RpdmUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuOTIpOyB9CgojYWN0aW9uLWJ1dHRvbiAuYnRuLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAyMnB4OwogICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAycHggNHB4IHJnYmEoMCwwLDAsMC44KSwgMCAwIDEwcHggcmdiYSgyNTUsMjU1LDI1NSwwLjUpOwogICAgei1pbmRleDogNTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKI2FjdGlvbi1idXR0b24gLmJ0bi1nbGFyZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01MCU7IGxlZnQ6IC01MCU7IHdpZHRoOiAyMDAlOyBoZWlnaHQ6IDIwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoNDVkZWcsIHRyYW5zcGFyZW50IDQwJSwgcmdiYSgyNTUsMjU1LDI1NSwwLjQpIDUwJSwgdHJhbnNwYXJlbnQgNjAlKTsKICAgIGFuaW1hdGlvbjogZ2xhcmVQYXNzIDVzIGluZmluaXRlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiA2OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwp9CgoubGltaXQtcmluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01cHg7IGxlZnQ6IC01cHg7IHJpZ2h0OiAtNXB4OyBib3R0b206IC01cHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDJweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGJveC1zaGFkb3c6IDAgMCAwIHRyYW5zcGFyZW50OwogICAgdHJhbnNpdGlvbjogYWxsIDAuNXM7CiAgICB6LWluZGV4OiAxOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCiNhY3Rpb24tYnV0dG9uLnNob290LW1vZGUgewogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmZmZmFhIDAlLCAjZmZhYTAwIDQwJSwgIzg4MjIwMCA4MCUsICMyMjAwMDAgMTAwJSk7CiAgICBib3JkZXItY29sb3I6ICNmZmNjMDA7CiAgICBib3gtc2hhZG93OiAwIDAgMzBweCByZ2JhKDI1NSwgMTAwLCAwLCAwLjgpLCBpbnNldCAwIDAgMjBweCByZ2JhKDI1NSwgMjU1LCAwLCAwLjUpOwp9CgojYWN0aW9uLWJ1dHRvbi5saW1pdC1yZWFkeSAubGltaXQtcmluZyB7CiAgICBib3JkZXItY29sb3I6ICNmZmRkNDQ7CiAgICBhbmltYXRpb246IGxpbWl0UHVsc2UgMC44cyBlYXNlLWluLW91dCBpbmZpbml0ZSBhbHRlcm5hdGU7Cn0KCi5zaG9vdC1sYWJlbCB7CiAgICBjb2xvcjogI2ZmZGQ0NCAhaW1wb3J0YW50OwogICAgYm9yZGVyLWNvbG9yOiAjZmZhYTAwICFpbXBvcnRhbnQ7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggI2ZmNDQwMCAhaW1wb3J0YW50Owp9CgpAa2V5ZnJhbWVzIGxpbWl0UHVsc2UgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IGJveC1zaGFkb3c6IDAgMCAxMHB4ICNmZmFhMDAsIGluc2V0IDAgMCA1cHggI2ZmYWEwMDsgb3BhY2l0eTogMC41OyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjE1KTsgYm94LXNoYWRvdzogMCAwIDMwcHggI2ZmNDQwMCwgaW5zZXQgMCAwIDE1cHggI2ZmMDAwMDsgb3BhY2l0eTogMS4wOyB9Cn0KCi8qIC0tLSBBVVRPIFRPR0dMRSAtLS0gKi8KI2F1dG8tdG9nZ2xlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDIwMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA2MHB4KTsgCiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiAxMTBweDsKICAgIHBhZGRpbmc6IDEwcHggMDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMCwgMjAsIDQwLCAwLjgpIDAlLCByZ2JhKDAsIDUsIDEwLCAwLjkpIDEwMCUpOwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7CiAgICBib3gtc2hhZG93OiAwIDVweCAxNXB4IHJnYmEoMCwwLDAsMC4zKTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICB6LWluZGV4OiAxMDA7Cn0KCiNhdXRvLXRvZ2dsZTpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDQwLCA4MCwgMC45KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHZhcigtLWZmeC1jeWFuKTsKICAgIGNvbG9yOiB3aGl0ZTsKfQoKI2F1dG8tdG9nZ2xlLmFjdGl2ZSB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDEwMCwgMjAsIDAsIDAuOCkgMCUsIHJnYmEoNDAsIDAsIDAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXItY29sb3I6ICNmZjQ0MDA7CiAgICBjb2xvcjogI2ZmYWEwMDsKICAgIGFuaW1hdGlvbjogcHVsc2VSZWQgMnMgaW5maW5pdGU7Cn0KQGtleWZyYW1lcyBwdWxzZVJlZCB7IDAlIHsgYm94LXNoYWRvdzogMCAwIDVweCAjZmYwMDAwOyB9IDUwJSB7IGJveC1zaGFkb3c6IDAgMCAyMHB4ICNmZjQ0MDA7IH0gMTAwJSB7IGJveC1zaGFkb3c6IDAgMCA1cHggI2ZmMDAwMDsgfSB9CgovKiAtLS0gRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtd3JhcHBlciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDIwMDA7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtOwogICAgY29udGFpbjogbGF5b3V0IHN0eWxlOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lciB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAyNHB4OyAKICAgIHRleHQtc2hhZG93OiAxcHggMXB4IDAgIzAwMDsKICAgIG9wYWNpdHk6IDAuOTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuZGFtYWdlIHsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmZmYgMCUsICNmZmNjMDAgNDAlLCAjZmY0NDAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgNHB4IDRweCByZ2JhKDAsMCwwLDAuOCkpOwogICAgYW5pbWF0aW9uOiBwb3BEYW1hZ2UgMC44cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSkgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmhlYWwgewogICAgZm9udC1zaXplOiAzNnB4OwogICAgY29sb3I6ICM0NGZmNDQ7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmYwMDsKICAgIGFuaW1hdGlvbjogZmxvYXRVcCAxcyBlYXNlLW91dCBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIudmVub20gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBjb2xvcjogI2FhZmYwMDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjNDQ4ODAwLCAycHggMnB4IDAgIzAwMjIwMDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNjY2ZmNjYgMCUsICM2NmNjMDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDVweCByZ2JhKDEwMCwgMjU1LCAwLCAwLjUpKTsKICAgIGFuaW1hdGlvbjogZHJpcFN0YXR1cyAycyBpbmZpbml0ZTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2xlZXAgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDE1cHggIzAwNDRmZiwgMCAwIDMwcHggIzAwMDBmZjsKICAgIG9wYWNpdHk6IDAuOTsKICAgIGFuaW1hdGlvbjogZHJpZnRTdGF0dXMgM3MgZWFzZS1pbi1vdXQgaW5maW5pdGU7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLndpdGhlciB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzhweDsKICAgIGNvbG9yOiAjY2NjY2NjOwogICAgdGV4dC1zaGFkb3c6IDJweCAycHggMCAjNDQ0NDQ0OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2VlZWVlZSAwJSwgIzg4ODg4OCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYW5pbWF0aW9uOiB3aXRoZXJTdGF0dXMgMS41cyBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIudGVjaCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDMycHg7CiAgICBjb2xvcjogIzAwZmZmZjsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMTAsIDMwLCAwLjcpOwogICAgcGFkZGluZzogMnB4IDEwcHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjMDBmZmZmOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggIzAwODhmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICNmZmY7CiAgICBhbmltYXRpb246IHNoYWtlVGVjaCAwLjZzIGVhc2UtaW4tb3V0LCBmbGFzaFRlY2ggMC4zczsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGNlbnRlcjsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2F2ZSwgLmZsb2F0aW5nLXRleHQtaW5uZXIuYmxvY2sgewogICAgZm9udC1zaXplOiA0OHB4OwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgLXdlYmtpdC10ZXh0LXN0cm9rZTogMXB4ICMwMDQ0ODg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwODhmZjsKICAgIGFuaW1hdGlvbjogcG9wRGFtYWdlIDAuNXMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCkBrZXlmcmFtZXMgcG9wRGFtYWdlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjUpOyBvcGFjaXR5OiAwOyB9CiAgICAyMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuNSk7IG9wYWNpdHk6IDE7IH0KICAgIDQwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIGZsb2F0VXAgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMCk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTUwcHgpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgZHJpcFN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGVZKDEpOyBmaWx0ZXI6IGJsdXIoMHB4KTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiBzY2FsZVkoMS4xKSB0cmFuc2xhdGVZKDVweCk7IGZpbHRlcjogYmx1cigxcHgpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZVkoMSk7IGZpbHRlcjogYmx1cigwcHgpOyB9Cn0KCkBrZXlmcmFtZXMgZHJpZnRTdGF0dXMgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMCkgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9CiAgICAyMCUgeyBvcGFjaXR5OiAxOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMTVweCkgdHJhbnNsYXRlWSgtMjBweCkgcm90YXRlKDEwZGVnKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtMTVweCkgdHJhbnNsYXRlWSgtNTBweCkgcm90YXRlKC0xMGRlZyk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyB3aXRoZXJTdGF0dXMgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEpOyBmaWx0ZXI6IGdyYXlzY2FsZSgwJSk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuNik7IGZpbHRlcjogZ3JheXNjYWxlKDEwMCUpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgc2hha2VUZWNoIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjgpOyB9CiAgICAxMCUsIDMwJSwgNTAlLCA3MCUsIDkwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4xKSB0cmFuc2xhdGUoLTJweCwgMnB4KTsgfQogICAgMjAlLCA0MCUsIDYwJSwgODAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjEpIHRyYW5zbGF0ZSgycHgsIC0ycHgpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyB9Cn0KCkBrZXlmcmFtZXMgZmxhc2hUZWNoIHsKICAgIDAlIHsgYmFja2dyb3VuZC1jb2xvcjogI2ZmZjsgY29sb3I6ICMwMDA7IGJvcmRlci1jb2xvcjogI2ZmZjsgfQogICAgMTAwJSB7IGJhY2tncm91bmQtY29sb3I6IHJnYmEoMCwgMTAsIDMwLCAwLjg1KTsgY29sb3I6ICMwMGZmZmY7IGJvcmRlci1jb2xvcjogIzAwZmZmZjsgfQp9CgojbG9hZGluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICBhbmltYXRpb246IGJsaW5rIDFzIGluZmluaXRlOwp9CkBrZXlmcmFtZXMgYmxpbmsgeyA1MCUgeyBvcGFjaXR5OiAwLjU7IH0gfQoKI2NvbnRyb2xzLWhpbnQgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMzBweDsgd2lkdGg6IDEwMCU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogcmdiYSgyNTUsMjU1LDI1NSwwLjQpOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5jb21pYy1pbXBhY3QgewogICAgZm9udC1mYW1pbHk6ICdJbXBhY3QnLCBzYW5zLXNlcmlmOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgY29sb3I6ICNmZmZmMDA7IAogICAgLXdlYmtpdC10ZXh0LXN0cm9rZTogMXB4ICMwMDA7CiAgICB0ZXh0LXNoYWRvdzogM3B4IDNweCAwICNmZjAwMDA7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB0cmFuc2Zvcm0tb3JpZ2luOiBjZW50ZXI7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgYW5pbWF0aW9uOiBjb21pY1BvcCAwLjRzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KSBmb3J3YXJkczsKICAgIHotaW5kZXg6IDI1MDA7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmNvbWljLWFjdGlvbiB7CiAgICBmb250LWZhbWlseTogJ0FyaWFsIEJsYWNrJywgc2Fucy1zZXJpZjsKICAgIGZvbnQtc2l6ZTogMjhweDsKICAgIGNvbG9yOiAjMDBmZmZmOyAKICAgIC13ZWJraXQtdGV4dC1zdHJva2U6IDFweCAjMDAwOwogICAgdGV4dC1zaGFkb3c6IDJweCAycHggMCAjMDA0NGFhOwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgIGFuaW1hdGlvbjogY29taWNTbGlkZSAwLjRzIGVhc2Utb3V0IGZvcndhcmRzOwogICAgei1pbmRleDogMjUwMDsKfQoKQGtleWZyYW1lcyBjb21pY1BvcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMCkgcm90YXRlKC0yMGRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIDQwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4yKSByb3RhdGUoNWRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDYwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKSByb3RhdGUoLTVkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjEpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIGNvbWljU2xpZGUgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtMjBweCwgMjBweCkgc2NhbGUoMC41KTsgb3BhY2l0eTogMDsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDIwcHgsIC0yMHB4KSBzY2FsZSgxLjIpOyBvcGFjaXR5OiAwOyB9Cn0KCi8qIC0tLSBNQUlOIE1FTlUgLS0tICovCi8qIC0tLSBNQUlOIE1FTlUgJiBFTkQgR0FNRSAoRkZYIFNUWUxFKSAtLS0gKi8KI21haW4tbWVudSwgI2VuZC1nYW1lLW1lbnUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB6LWluZGV4OiAzMDAwOwogICAgb3BhY2l0eTogMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjhzIGN1YmljLWJlemllcigwLjIsIDAuOCwgMC4yLCAxLjApOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCBjZW50ZXIsIHJnYmEoMCwgMjAsIDYwLCAwLjQpIDAlLCByZ2JhKDAsIDUsIDEwLCAwLjgpIDEwMCUpOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDVweCk7Cn0KCiNtYWluLW1lbnUuYWN0aXZlLCAjZW5kLWdhbWUtbWVudS5hY3RpdmUgewogICAgb3BhY2l0eTogMTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgoubWVudS1iZy1vdmVybGF5LCAuZW5kLWJnLWxheWVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IAogICAgICAgIGxpbmVhci1ncmFkaWVudChyZ2JhKDAsMCwwLDApIDUwJSwgcmdiYSgwLDAsMCwwLjEpIDUwJSksIAogICAgICAgIHJlcGVhdGluZy1saW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMjU1LDI1NSwyNTUsMC4wMikgMHB4LCByZ2JhKDI1NSwyNTUsMjU1LDAuMDIpIDFweCwgdHJhbnNwYXJlbnQgMXB4LCB0cmFuc3BhcmVudCAyMHB4KTsKICAgIGJhY2tncm91bmQtc2l6ZTogMTAwJSA0cHgsIDEwMCUgMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogLTE7Cn0KCi8qIExPR08gU1RZTElORyAqLwouZmZ4LWxvZ28tY29udGFpbmVyIHsKICAgIG1hcmdpbi1ib3R0b206IDUwcHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7Cn0KCi5mZngtbG9nby1tYWluIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoNDhweCwgMTB2dywgODRweCk7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogOHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZmZmZiAwJSwgI2FhY2NmZiA0MCUsICMwMDg4ZmYgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDE1cHggcmdiYSgwLCAxMDAsIDI1NSwgMC44KSk7CiAgICBhbmltYXRpb246IGxvZ29TaGltbWVyIDNzIGluZmluaXRlIGFsdGVybmF0ZTsKfQoKLmZmeC1sb2dvLXN1YiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IGNsYW1wKDE0cHgsIDN2dywgMjRweCk7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDE1cHg7CiAgICBtYXJnaW4tdG9wOiAtMTBweDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmZhYTAwOwogICAgb3BhY2l0eTogMC45Owp9CgpAa2V5ZnJhbWVzIGxvZ29TaGltbWVyIHsKICAgIDAlIHsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjUpKTsgfQogICAgMTAwJSB7IGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDI1cHggcmdiYSgwLCAyMDAsIDI1NSwgMC45KSk7IH0KfQoKLyogTUVOVSBPUFRJT05TICovCi5tZW51LW9wdGlvbnMsIC5lbmQtb3B0aW9ucyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogMTVweDsKICAgIHdpZHRoOiAzMjBweDsKfQoKLm1lbnUtaXRlbSB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBwYWRkaW5nOiAxMnB4IDMwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMzAsIDYwLCAwLjgpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC4yKSAxMDAlKTsKICAgIGJvcmRlci1sZWZ0OiAzcHggc29saWQgcmdiYSgxMDAsIDIwMCwgMjU1LCAwLjMpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4xKTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRyYW5zaXRpb246IGFsbCAwLjNzIGN1YmljLWJlemllcigwLjIsIDAuOCwgMC4yLCAxLjApOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpOwogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgoubWVudS1pdGVtOjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IC0xMDAlOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjIpLCB0cmFuc3BhcmVudCk7CiAgICB0cmFuc2l0aW9uOiBsZWZ0IDAuNHM7Cn0KCi5tZW51LWl0ZW06aG92ZXI6OmJlZm9yZSB7CiAgICBsZWZ0OiAxMDAlOwp9CgoubWVudS1pdGVtOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgwLCA4MCwgMTYwLCAwLjkpIDAlLCByZ2JhKDAsIDIwLCA0MCwgMC40KSAxMDAlKTsKICAgIGJvcmRlci1sZWZ0LWNvbG9yOiAjMDBmZmZmOwogICAgcGFkZGluZy1sZWZ0OiA0NXB4OwogICAgYm94LXNoYWRvdzogMCAwIDIwcHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLm1lbnUtaXRlbSAubGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAyMHB4OwogICAgY29sb3I6ICNjY2NjY2M7CiAgICBsZXR0ZXItc3BhY2luZzogM3B4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpOwogICAgdHJhbnNpdGlvbjogY29sb3IgMC4yczsKfQoKLm1lbnUtaXRlbTpob3ZlciAubGFiZWwgewogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKfQoKLm1lbnUtaXRlbSAuY3Vyc29yIHsKICAgIHdpZHRoOiAxMHB4OyBoZWlnaHQ6IDEwcHg7CiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtZ29sZCk7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBtYXJnaW4tcmlnaHQ6IDE1cHg7CiAgICBvcGFjaXR5OiAwOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0yMHB4KSBza2V3WCgxNWRlZyk7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4zczsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHZhcigtLWZmeC1nb2xkKTsKfQoKLm1lbnUtaXRlbTpob3ZlciAuY3Vyc29yIHsKICAgIG9wYWNpdHk6IDE7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMCkgc2tld1goMTVkZWcpOwp9CgoubWVudS1mb290ZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAzMHB4OwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHJnYmEoMjU1LDI1NSwyNTUsMC4zKTsKICAgIGxldHRlci1zcGFjaW5nOiA0cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwp9CgovKiBFTkQgR0FNRSBTUEVDSUZJQyAqLwoucmVzdWx0LWhlYWRlciB7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBtYXJnaW4tYm90dG9tOiA0MHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwp9CgoucmVzdWx0LXRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogNzJweDsKICAgIGNvbG9yOiAjZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICMwMGFhZmYsIDAgMCA0MHB4ICMwMDQ0YWE7CiAgICBsZXR0ZXItc3BhY2luZzogNXB4OwogICAgbGluZS1oZWlnaHQ6IDEuMDsKfQoKLnJlc3VsdC1zdWJ0aXRsZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDE4cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDhweDsKICAgIG1hcmdpbi10b3A6IDVweDsKfQoKLmZpbmFsLXNjb3JlLWNvbnRhaW5lciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgZ2FwOiA0MHB4OwogICAgbWFyZ2luLWJvdHRvbTogNTBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHJnYmEoMCwgMjAsIDUwLCAwLjgpLCB0cmFuc3BhcmVudCk7CiAgICBwYWRkaW5nOiAyMHB4IDA7CiAgICB3aWR0aDogMTAwJTsKfQoKLmZpbmFsLXRlYW0gewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgd2lkdGg6IDEyMHB4Owp9CgouZmluYWwtc2NvcmUtZGlnaXQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDgwcHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNSk7CiAgICBsaW5lLWhlaWdodDogMS4wOwp9CgouZmluYWwtdGVhbS5ob21lIC5maW5hbC1zY29yZS1kaWdpdCB7IGNvbG9yOiAjMDBmZmZmOyB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwZmZmZjsgfQouZmluYWwtdGVhbS5hd2F5IC5maW5hbC1zY29yZS1kaWdpdCB7IGNvbG9yOiAjZmY0NDQ0OyB0ZXh0LXNoYWRvdzogMCAwIDIwcHggI2ZmNDQ0NDsgfQoKLmZpbmFsLXRlYW0tbmFtZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjb2xvcjogI2FhYTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBtYXJnaW4tdG9wOiA1cHg7Cn0KCi5maW5hbC12cyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBvcGFjaXR5OiAwLjY7Cn0KCi5maW5hbC12cyBzcGFuIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBtYXJnaW46IDVweCAwOwp9CgoudnMtbGluZSB7CiAgICB3aWR0aDogMnB4OyBoZWlnaHQ6IDMwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCB0cmFuc3BhcmVudCwgdmFyKC0tZmZ4LWdvbGQpLCB0cmFuc3BhcmVudCk7Cn0KLyogLS0tIFBSQUNUSUNFIE9WRVJMQVkgLS0tICovCiNwcmFjdGljZS1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNSwgMTAsIDAuNik7CiAgICBkaXNwbGF5OiBub25lOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgei1pbmRleDogMjUwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgojcHJhY3RpY2Utb3ZlcmxheS5hY3RpdmUgewogICAgZGlzcGxheTogZmxleDsKfQoKLnByYWN0aWNlLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDYwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDQwcHgpOyAKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDI4MHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE2MGRlZywgcmdiYSgwLCAyMCwgNTAsIDAuOTUpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC45OCkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ4OGZmOwogICAgYm9yZGVyLXJhZGl1czogMCAwIDE1cHggMDsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMiksIGluc2V0IDAgMCA1MHB4IHJnYmEoMCwgMjAsIDYwLCAwLjUpOwogICAgcGFkZGluZzogMTVweDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMmRlZyk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNXB4KTsKfQoKLnBhbmVsLWhlYWRlciB7CiAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgoucGFuZWwtdGl0bGUtZ3JvdXAgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47Cn0KCi5wYW5lbC10aXRsZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IGNsYW1wKDE4cHgsIDZ2dywgMjRweCk7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKfQoKLnBhbmVsLXN1YnRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogOHB4OwogICAgY29sb3I6ICM0NDg4ZmY7CiAgICBsZXR0ZXItc3BhY2luZzogNHB4OwogICAgbWFyZ2luLXRvcDogLTJweDsKfQoKLnBhbmVsLWRlY28tbGluZSB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMnB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgIzAwZmZmZiwgdHJhbnNwYXJlbnQpOwogICAgbWFyZ2luLXRvcDogNXB4OwogICAgYm94LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOwp9CgoucGFuZWwtY29udGVudCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogMTVweDsKfQoKLnNlY3Rpb24tbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDIwMCwgMTc2LCA5NiwgMC4zKTsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKICAgIHBhZGRpbmctYm90dG9tOiAycHg7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgouZHJpbGwtbGlzdCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogNXB4Owp9CgouZHJpbGwtYnRuIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcGFkZGluZzogOHB4IDEycHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4wNSksIHRyYW5zcGFyZW50KTsKICAgIGJvcmRlci1sZWZ0OiAycHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjYWFhOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7Cn0KCi5kcmlsbC1idG46aG92ZXIgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDI1NSwgMjU1LCAwLjEpLCB0cmFuc3BhcmVudCk7CiAgICBjb2xvcjogI2ZmZjsKICAgIHBhZGRpbmctbGVmdDogMTVweDsKfQoKLmRyaWxsLWJ0bi5hY3RpdmUgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDEwMCwgMjU1LCAwLjQpLCB0cmFuc3BhcmVudCk7CiAgICBib3JkZXItbGVmdDogM3B4IHNvbGlkICMwMGZmZmY7CiAgICBjb2xvcjogI2ZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMGZmZmY7Cn0KCi5kcmlsbC1idG4gLmljb24gewogICAgd2lkdGg6IDIwcHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBtYXJnaW4tcmlnaHQ6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwp9Cgoub3B0aW9uLWxpc3QgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBnYXA6IDVweDsKfQoKLm9wdGlvbi10b2dnbGUgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwYWRkaW5nOiA1cHggMTBweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiAjY2NjOwogICAgdHJhbnNpdGlvbjogY29sb3IgMC4yczsKfQoKLm9wdGlvbi10b2dnbGU6aG92ZXIgeyBjb2xvcjogI2ZmZjsgfQoKLm9wdGlvbi10b2dnbGUgLmNoZWNrYm94IHsKICAgIG1hcmdpbi1yaWdodDogMTBweDsKICAgIGNvbG9yOiAjNDQ0OwogICAgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsKICAgIGZvbnQtc2l6ZTogMTRweDsKfQoKLm9wdGlvbi10b2dnbGUuYWN0aXZlIC5jaGVja2JveCB7CiAgICBjb2xvcjogIzAwZmYwMDsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMGZmMDA7Cn0KCi5vcHRpb24tdG9nZ2xlLmFjdGl2ZSB7CiAgICBjb2xvcjogI2ZmZjsKfQoKLmFjdGlvbi1idG4gewogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIHBhZGRpbmc6IDZweDsKICAgIGZvbnQtc2l6ZTogMTFweDsKICAgIGNvbG9yOiAjYWFhOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICBtYXJnaW4tYm90dG9tOiA1cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKLmFjdGlvbi1idG46aG92ZXIgewogICAgYm9yZGVyLWNvbG9yOiAjZmZmOwogICAgY29sb3I6ICNmZmY7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7Cn0KCiNwLWV4aXQ6aG92ZXIgewogICAgYm9yZGVyLWNvbG9yOiAjZmY0NDQ0OwogICAgY29sb3I6ICNmZjQ0NDQ7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDUwLCAwLCAwLCAwLjMpOwp9CgoucGFuZWwtZm9vdGVyIHsKICAgIG1hcmdpbi10b3A6IDE1cHg7CiAgICBwYWRkaW5nLXRvcDogMTBweDsKICAgIGJvcmRlci10b3A6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCiNkcmlsbC1pbnN0cnVjdGlvbiB7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgbWFyZ2luLWJvdHRvbTogNXB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwp9CgojZHJpbGwtc2NvcmUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMjU1LCAyMTUsIDAsIDAuNSk7Cn0KCi5wYW5lbC1taW5pbWl6ZS1idG4gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMHB4OyByaWdodDogMTBweDsKICAgIHdpZHRoOiAyMHB4OyBoZWlnaHQ6IDIwcHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbGluZS1oZWlnaHQ6IDE4cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDAuNSk7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoucGFuZWwtbWluaW1pemUtYnRuOmhvdmVyIHsgCiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtY3lhbik7IAogICAgY29sb3I6ICMwMDA7IAogICAgYm94LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7Cn0KCiNwcmFjdGljZS1yZXN0b3JlLWJ0biB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA0MHB4KTsgCiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHBhZGRpbmc6IDhweCAxNXB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDIwLCA1MCwgMC45KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItbGVmdDogM3B4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB6LWluZGV4OiAyNDAwOwogICAgZGlzcGxheTogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC4yKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KI3ByYWN0aWNlLXJlc3RvcmUtYnRuOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjkpOwogICAgY29sb3I6ICNmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLyogLS0tIEFJTSBKT1lTVElDSyAtLS0gKi8KI2FpbS1qb3lzdGljay16b25lIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE1MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOwogICAgcmlnaHQ6IDA7CiAgICB3aWR0aDogNDAlOwogICAgaGVpZ2h0OiAzNSU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwKTsKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgojYWltLWpveXN0aWNrLXZpc3VhbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMDsgaGVpZ2h0OiAwOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAxMTAwOwp9CgojYWltLWpveXN0aWNrLWJhc2UgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDkwcHg7IGhlaWdodDogOTBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMjU1LCAxMDAsIDAsIDAuMykgMCUsIHJnYmEoODAsIDIwLCAwLCAwLjEpIDYwJSwgdHJhbnNwYXJlbnQgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMTUwLCA1MCwgMC40KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuMiksIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCA1MCwgMCwgMC4yKTsKfQoKI2FpbS1qb3lzdGljay1rbm9iIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiA0MHB4OyBoZWlnaHQ6IDQwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsICNmZmNjODggMCUsICNmZjY2MDAgNDAlLCAjODgyMjAwIDgwJSwgIzIyMDAwMCAxMDAlKTsKICAgIGJvcmRlcjogMnB4IHNvbGlkICNmZmFhNDQ7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjZmY0NDAwLCBpbnNldCAwIDAgOHB4IHJnYmEoMjU1LDI1NSwyNTUsMC42KTsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjA1cyBsaW5lYXI7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtOwp9CgojYWltLWpveXN0aWNrLWtub2I6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICJBSU0iOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgZm9udC1zaXplOiA4cHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIHRleHQtc2hhZG93OiAwIDAgM3B4ICMwMDA7Cn0KCi8qIC0tLSBUQUNLTEUgQlVUVE9OIC0tLSAqLwojdGFja2xlLWJ1dHRvbiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCgxNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pICsgMTAwcHgpOwogICAgcmlnaHQ6IG1heCg0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogNzBweDsKICAgIGhlaWdodDogNzBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHotaW5kZXg6IDEwMDsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzUlIDM1JSwgI2ZmODg4OCAwJSwgI2NjMDAwMCA0MCUsICM2NjAwMDAgODAlLCAjMjIwMDAwIDEwMCUpOwogICAgYm9yZGVyOiAzcHggc29saWQgI2ZmNDQ0NDsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjU1LCA1MCwgNTAsIDAuNiksIGluc2V0IDAgMCAxNXB4IHJnYmEoMjU1LCAyMDAsIDIwMCwgMC4zKTsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjFzLCBmaWx0ZXIgMC4yczsKfQoKI3RhY2tsZS1idXR0b246YWN0aXZlIHsKICAgIHRyYW5zZm9ybTogc2NhbGUoMC45KTsKICAgIGZpbHRlcjogYnJpZ2h0bmVzcygxLjIpOwp9CgojdGFja2xlLWJ1dHRvbi5hY3RpdmUgewogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmZmZmZmIDAlLCAjZmY0NDQ0IDQwJSwgI2FhMDAwMCA4MCUsICM0NDAwMDAgMTAwJSk7CiAgICBib3gtc2hhZG93OiAwIDAgMjVweCByZ2JhKDI1NSwgMTAwLCAxMDAsIDAuOSk7Cn0KCiN0YWNrbGUtYnV0dG9uIC5idG4tdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMXB4IDJweCByZ2JhKDAsMCwwLDAuOCk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgojdGFja2xlLWJ1dHRvbiAuYnRuLWdsYXJlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwJTsgbGVmdDogLTUwJTsKICAgIHdpZHRoOiAyMDAlOyBoZWlnaHQ6IDIwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoNDVkZWcsIHRyYW5zcGFyZW50IDQwJSwgcmdiYSgyNTUsMjU1LDI1NSwwLjMpIDUwJSwgdHJhbnNwYXJlbnQgNjAlKTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYW5pbWF0aW9uOiBnbGFyZVBhc3MgNHMgaW5maW5pdGU7Cn0KCiN0YWNrbGUtYnV0dG9uLnVyZ2VudCB7CiAgICBhbmltYXRpb246IHVyZ2VudFB1bHNlIDAuNXMgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmY1NTU1IDAlLCAjZmYwMDAwIDQwJSwgIzg4MDAwMCAxMDAlKTsKICAgIGJvcmRlci1jb2xvcjogI2ZmYWFhYTsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4ICNmZjAwMDA7Cn0KCkBrZXlmcmFtZXMgdXJnZW50UHVsc2UgewogICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgfQogICAgdG8geyB0cmFuc2Zvcm06IHNjYWxlKDEuMTUpOyB9Cn0KCi8qIC0tLSBDSEFSR0UgUE9XRVIgTUVURVIgLS0tICovCiNjaGFyZ2UtbWV0ZXItY29udGFpbmVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDI1MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyAxMDBweCk7CiAgICBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICB3aWR0aDogMjAwcHg7CiAgICBkaXNwbGF5OiBub25lOwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDIwMDA7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDEwLCAzMCwgMC44KTsKICAgIHBhZGRpbmc6IDEwcHggMTVweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMyk7Cn0KCi5jaGFyZ2UtbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgbWFyZ2luLWJvdHRvbTogNXB4Owp9CgouY2hhcmdlLW1ldGVyLXRyYWNrIHsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjYpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCiNjaGFyZ2UtbWV0ZXItZmlsbCB7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICB3aWR0aDogMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwYWYsICMwZjApOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggIzBmMDsKICAgIHRyYW5zaXRpb246IHdpZHRoIDAuMDVzIGxpbmVhciwgYmFja2dyb3VuZCAwLjFzOwogICAgYm9yZGVyLXJhZGl1czogNXB4Owp9CgouY2hhcmdlLWhpbnQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIG1hcmdpbi10b3A6IDVweDsKICAgIG9wYWNpdHk6IDAuODsKICAgIGFuaW1hdGlvbjogYmxpbmsgMC41cyBpbmZpbml0ZTsKfQoKLyogLS0tIEdPQUwgRElTVEFOQ0UgSU5ESUNBVE9SIC0tLSAqLwojZ29hbC1kaXN0YW5jZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoNzVweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNTVweCk7CiAgICBsZWZ0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KSk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDEwMDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgwLCAxMCwgMzAsIDAuNykgMCUsIHRyYW5zcGFyZW50IDEwMCUpOwogICAgcGFkZGluZzogNXB4IDE1cHggNXB4IDEwcHg7CiAgICBib3JkZXItbGVmdDogMnB4IHNvbGlkIHZhcigtLWZmeC1nb2xkKTsKfQoKLmRpc3RhbmNlLWxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogOHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwp9CgojZ29hbC1kaXN0YW5jZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1nb2xkKTsKfQoKLyogLS0tIFNFVFRJTkdTIEJVVFRPTiAtLS0gKi8KI3NldHRpbmdzLWJ1dHRvbiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCgyNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMTAwcHgpOwogICAgcmlnaHQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogMTEwcHg7CiAgICBwYWRkaW5nOiA4cHggMDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6ICM4ODg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDIwLCAyMCwgMjAsIDAuOCkgMCUsIHJnYmEoMTAsIDEwLCAxMCwgMC45KSAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICB6LWluZGV4OiAxMDA7Cn0KCiNzZXR0aW5ncy1idXR0b246aG92ZXIgewogICAgYmFja2dyb3VuZDogcmdiYSg0MCwgNDAsIDQwLCAwLjkpOwogICAgYm9yZGVyLWNvbG9yOiAjODg4OwogICAgY29sb3I6ICNmZmY7Cn0KCi8qIC0tLSBTRVRUSU5HUyBQQU5FTCAtLS0gKi8KI3NldHRpbmdzLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOwogICAgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMjgwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTYwZGVnLCByZ2JhKDAsIDIwLCA1MCwgMC45OCkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjk5KSAxMDAlKTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgICBib3gtc2hhZG93OiAwIDAgMzBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjQpOwogICAgei1pbmRleDogMzUwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEwcHgpOwp9Cgouc2V0dGluZ3MtaGVhZGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcGFkZGluZzogMTVweDsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyk7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDMwLCA2MCwgMC41KTsKfQoKLnNldHRpbmdzLWhlYWRlciBzcGFuIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMjBweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7Cn0KCiNzZXR0aW5ncy1jbG9zZSB7CiAgICB3aWR0aDogMzBweDsKICAgIGhlaWdodDogMzBweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkICNmZjQ0NDQ7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDUwLCAwLCAwLCAwLjUpOwogICAgY29sb3I6ICNmZjQ0NDQ7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoKI3NldHRpbmdzLWNsb3NlOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6ICNmZjQ0NDQ7CiAgICBjb2xvcjogd2hpdGU7Cn0KCi5zZXR0aW5ncy1jb250ZW50IHsKICAgIHBhZGRpbmc6IDIwcHg7Cn0KCi5zZXR0aW5nLXJvdyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICBwYWRkaW5nOiAxMHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjMpOwogICAgYm9yZGVyLXJhZGl1czogNXB4Owp9Cgouc2V0dGluZy1yb3cgbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjb2xvcjogI2NjYzsKfQoKLnNldHRpbmctcm93IGlucHV0W3R5cGU9InJhbmdlIl0gewogICAgd2lkdGg6IDEwMHB4OwogICAgYWNjZW50LWNvbG9yOiB2YXIoLS1mZngtY3lhbik7Cn0KCi5zZXR0aW5nLXJvdyBpbnB1dFt0eXBlPSJjaGVja2JveCJdIHsKICAgIHdpZHRoOiAyMHB4OwogICAgaGVpZ2h0OiAyMHB4OwogICAgYWNjZW50LWNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBjdXJzb3I6IHBvaW50ZXI7Cn0KCi8qIC0tLSBHTEFSRSBBTklNQVRJT04gLS0tICovCkBrZXlmcmFtZXMgZ2xhcmVQYXNzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0xMDAlKSByb3RhdGUoNDVkZWcpOyB9CiAgICAzMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMTAwJSkgcm90YXRlKDQ1ZGVnKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxMDAlKSByb3RhdGUoNDVkZWcpOyB9Cn0KCi8qIC0tLSBTVEFUVVMgVFlQRSBGTE9BVElORyBURVhUIC0tLSAqLwouZmxvYXRpbmctdGV4dC1pbm5lci5zdGF0dXMgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI4cHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBjb2xvcjogI2ZmMDBmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmYwMGZmLCAycHggMnB4IDAgIzAwMDsKICAgIGFuaW1hdGlvbjogc3RhdHVzUG9wIDEuMnMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCkBrZXlmcmFtZXMgc3RhdHVzUG9wIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjUpIHRyYW5zbGF0ZVkoMCk7IG9wYWNpdHk6IDA7IH0KICAgIDIwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4zKSB0cmFuc2xhdGVZKC0xMHB4KTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKSB0cmFuc2xhdGVZKC00MHB4KTsgb3BhY2l0eTogMDsgfQp9CgovKiAtLS0gR09BTCBUWVBFIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LWlubmVyLmdvYWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQ4cHg7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZiAwJSwgI2ZmZDcwMCA1MCUsICNmZjg4MDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCA0cHggNHB4IHJnYmEoMCwwLDAsMC45KSk7CiAgICBhbmltYXRpb246IGdvYWxQb3AgMXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpIGZvcndhcmRzOwp9CgpAa2V5ZnJhbWVzIGdvYWxQb3AgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDApIHJvdGF0ZSgtMTBkZWcpOyBvcGFjaXR5OiAwOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuNSkgcm90YXRlKDVkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjIpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgovKiAtLS0gREVGQVVMVCBUWVBFIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LWlubmVyLmRlZmF1bHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAycHggNHB4IHJnYmEoMCwwLDAsMC44KTsKICAgIGFuaW1hdGlvbjogZmxvYXRVcCAwLjhzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgovKiAtLS0gTU9CSUxFIFBPUlRSQUlUIE9QVElNSVpBVElPTlMgLS0tICovCkBtZWRpYSBzY3JlZW4gYW5kIChvcmllbnRhdGlvbjogcG9ydHJhaXQpIHsKICAgIC50ZWFtLXdpbmcgeyB3aWR0aDogODBweDsgcGFkZGluZzogMCA1cHg7IH0KICAgIC5zY29yZS1ib3ggeyBmb250LXNpemU6IDI0cHg7IG1hcmdpbjogMCAycHg7IG1pbi13aWR0aDogMjBweDsgfQogICAgLnRlYW0tbmFtZSB7IGZvbnQtc2l6ZTogMTBweDsgbGV0dGVyLXNwYWNpbmc6IDBweDsgfQogICAgLnRlYW0tc3ViIHsgZGlzcGxheTogbm9uZTsgfQogICAgCiAgICAudGltZXItY3J5c3RhbC1yaW5nIHsgd2lkdGg6IDcwcHg7IGhlaWdodDogMzVweDsgdG9wOiAtMTBweDsgfQogICAgI3RpbWVyLWRpc3BsYXkgeyBmb250LXNpemU6IDI0cHg7IH0KICAgICNoYWxmLWluZGljYXRvciB7IGZvbnQtc2l6ZTogMTBweDsgbGV0dGVyLXNwYWNpbmc6IDFweDsgfQogICAgCiAgICAjbWluaW1hcC1jb250YWluZXIgeyB3aWR0aDogODBweDsgaGVpZ2h0OiA4MHB4OyB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA1MHB4KTsgfQogICAgI21pbmltYXAgeyB3aWR0aDogNzBweDsgaGVpZ2h0OiA3MHB4OyB9CiAgICAucmFkYXItbGFiZWwgeyBmb250LXNpemU6IDhweDsgYm90dG9tOiAtMTBweDsgfQogICAgCiAgICAudGVjaC10ZXh0IHsgZm9udC1zaXplOiAyNHB4OyB9CiAgICAKICAgICNhY3Rpb24tYnV0dG9uIHsgd2lkdGg6IDcwcHg7IGhlaWdodDogNzBweDsgfQogICAgI2FjdGlvbi1idXR0b24gLmJ0bi10ZXh0IHsgZm9udC1zaXplOiAxNnB4OyB9CiAgICAuY29tbWFuZC1yaW5nIHsgd2lkdGg6IDkwcHg7IGhlaWdodDogOTBweDsgfQogICAgI2FjdGlvbi1sYWJlbCB7IGZvbnQtc2l6ZTogMTBweDsgcGFkZGluZzogMnB4IDhweDsgbWFyZ2luLWJvdHRvbTogMTBweDsgfQogICAgCiAgICAjcGxheWVyLXN0YXR1cy1wYW5lbCB7IHdpZHRoOiAxMjBweDsgYm90dG9tOiBtYXgoMTIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSArIDEwcHgpOyBsZWZ0OiAxMHB4OyB9CiAgICAuY2hhci1uYW1lIHsgZm9udC1zaXplOiAxMnB4OyB9CiAgICAuaHAtdmFsdWUgeyBmb250LXNpemU6IDhweDsgfQogICAgCiAgICAjYXV0by10b2dnbGUsICNzZXR0aW5ncy1idXR0b24sICNwcmFjdGljZS1yZXN0b3JlLWJ0biB7CiAgICAgICAgd2lkdGg6IDgwcHg7CiAgICAgICAgZm9udC1zaXplOiA4cHg7CiAgICAgICAgcmlnaHQ6IG1heCgxMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICAgICAgcGFkZGluZzogNnB4IDA7CiAgICB9CiAgICAKICAgICNnb2FsLWRpc3RhbmNlLWNvbnRhaW5lciB7IGxlZnQ6IG1heCgxMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQpKTsgdG9wOiBtYXgoNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNDVweCk7IH0KICAgICNnb2FsLWRpc3RhbmNlIHsgZm9udC1zaXplOiAxNnB4OyB9CiAgICAKICAgIC8qIEZpeCBBbm5vdW5jZW1lbnQgVGV4dCBDdXRvZmYgKi8KICAgICNhbm5vdW5jZW1lbnQgewogICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMzJweCwgMTB2dywgNjBweCk7CiAgICAgICAgd2lkdGg6IDk1JTsKICAgICAgICBsZWZ0OiAyLjUlOwogICAgICAgIHdoaXRlLXNwYWNlOiBub3JtYWw7CiAgICAgICAgd29yZC13cmFwOiBicmVhay13b3JkOwogICAgICAgIGxpbmUtaGVpZ2h0OiAxLjE7CiAgICB9CiAgICAuYW5ub3VuY2VtZW50LXNsYW0gewogICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoNDhweCwgMTV2dywgODBweCkgIWltcG9ydGFudDsKICAgICAgICB3aGl0ZS1zcGFjZTogbm9ybWFsICFpbXBvcnRhbnQ7CiAgICB9CgogICAgLyogTWVudSBBZGp1c3RtZW50cyAqLwogICAgLmZmeC1sb2dvLW1haW4geyBmb250LXNpemU6IGNsYW1wKDM2cHgsIDEydncsIDYwcHgpOyBsZXR0ZXItc3BhY2luZzogNHB4OyB9CiAgICAuZmZ4LWxvZ28tc3ViIHsgZm9udC1zaXplOiBjbGFtcCgxMnB4LCA0dncsIDE4cHgpOyBsZXR0ZXItc3BhY2luZzogOHB4OyB9CiAgICAubWVudS1vcHRpb25zIHsgd2lkdGg6IDI2MHB4OyB9CiAgICAubWVudS1pdGVtIHsgcGFkZGluZzogMTBweCAyMHB4OyB9CiAgICAubWVudS1pdGVtIC5sYWJlbCB7IGZvbnQtc2l6ZTogMTZweDsgfQp9Ci8qIC0tLSBHRVNUVVJFIEhJTlQgLS0tICovCiNnZXN0dXJlLWhpbnQgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDIwMHB4OyBoZWlnaHQ6IDMwMHB4OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMjUwMDsKICAgIG9wYWNpdHk6IDAuOTsKfQoKI2dlc3R1cmUtaGludC5hY3RpdmUgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7Cn0KCi5jdXJ2ZS1hcnJvdyB7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA1cHggIzAwZmZmZik7CiAgICBhbmltYXRpb246IGRhc2hEcmF3IDEuNXMgbGluZWFyIGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIGRhc2hEcmF3IHsKICAgIHRvIHsgc3Ryb2tlLWRhc2hvZmZzZXQ6IC0zMDsgfQp9CgouZ2VzdHVyZS10ZXh0IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKICAgIG1hcmdpbi10b3A6IC01MHB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCi5nZXN0dXJlLWhhbmQgewogICAgZm9udC1zaXplOiA0OHB4OwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAyMHB4OwogICAgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgYW5pbWF0aW9uOiBoYW5kU3dpcGUgMS41cyBlYXNlLWluLW91dCBpbmZpbml0ZTsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggYmxhY2spOwp9CgpAa2V5ZnJhbWVzIGhhbmRTd2lwZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIDUwcHgpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgb3BhY2l0eTogMTsgfQogICAgODAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMjBweCwgLTEwMHB4KSByb3RhdGUoMjBkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMHB4LCAtMTIwcHgpIHJvdGF0ZSgxMGRlZyk7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIFNXSVBFIFRSQUlMIChJTlRVSVRJVkUgRkVFREJBQ0spIC0tLSAqLwouc3dpcGUtdHJhaWwtZG90IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxMnB4OwogICAgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgIzAwZmZmZiAwJSwgcmdiYSgwLCAyNTUsIDI1NSwgMCkgNzAlKTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogOTAwMDsKICAgIGFuaW1hdGlvbjogZmFkZVRyYWlsIDAuNXMgbGluZWFyIGZvcndhcmRzOwogICAgbWl4LWJsZW5kLW1vZGU6IHNjcmVlbjsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm0sIG9wYWNpdHk7Cn0KCkBrZXlmcmFtZXMgZmFkZVRyYWlsIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC4yKTsgb3BhY2l0eTogMDsgfQp9CkBrZXlmcmFtZXMgZmFkZVRyYWlsIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC4yKTsgb3BhY2l0eTogMDsgfQp9CgovKiAtLS0gT0ZGU0NSRUVOIElORElDQVRPUiAtLS0gKi8KI29mZnNjcmVlbi1pbmRpY2F0b3IgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDQwcHg7IGhlaWdodDogNDBweDsKICAgIG1hcmdpbi1sZWZ0OiAtMjBweDsgbWFyZ2luLXRvcDogLTIwcHg7CiAgICB6LWluZGV4OiAxNTAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgNXB4ICMwMDApOwp9Cgojb2Zmc2NyZWVuLWluZGljYXRvciAuYXJyb3cgewogICAgd2lkdGg6IDA7IGhlaWdodDogMDsKICAgIGJvcmRlci1sZWZ0OiAxNXB4IHNvbGlkIHRyYW5zcGFyZW50OwogICAgYm9yZGVyLXJpZ2h0OiAxNXB4IHNvbGlkIHRyYW5zcGFyZW50OwogICAgYm9yZGVyLWJvdHRvbTogMjVweCBzb2xpZCAjMDBmZjAwOyAvKiBHcmVlbiBmb3IgcGxheWVyICovCiAgICBhbmltYXRpb246IHB1bHNlQXJyb3cgMC41cyBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICB0cmFuc2Zvcm0tb3JpZ2luOiBjZW50ZXIgYm90dG9tOwp9CgpAa2V5ZnJhbWVzIHB1bHNlQXJyb3cgewogICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IGZpbHRlcjogYnJpZ2h0bmVzcygxKTsgfQogICAgdG8geyB0cmFuc2Zvcm06IHNjYWxlKDEuMik7IGZpbHRlcjogYnJpZ2h0bmVzcygxLjUpOyB9Cn0=","./style.css":"data:text/css;base64,OnJvb3QgewogICAgLS1mZngtYmx1ZS1kZWVwOiAjMDIwNDA4OwogICAgLS1mZngtYmx1ZS1kYXJrOiAjMGExNTI1OwogICAgLS1mZngtYmx1ZS1taWQ6ICMxNTJhNDU7CiAgICAtLWZmeC1ibHVlLWxpZ2h0OiAjMmE0ZDc1OwogICAgLS1mZngtY3lhbjogIzYwYzBkMDsKICAgIC0tZmZ4LWN5YW4tZ2xvdzogIzAwZmZmZjsKICAgIC0tZmZ4LWdvbGQ6ICNjOGIwNjA7CiAgICAtLWZmeC1nb2xkLWxpZ2h0OiAjZjBlMDkwOwogICAgLS1mZngtZ29sZC1kYXJrOiAjOGE3MDMwOwogICAgLS1mZngtZ2xhc3MtYmc6IHJnYmEoMTAsIDIwLCA0MCwgMC43NSk7CiAgICAtLWZmeC1nbGFzcy1ib3JkZXI6IHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIAogICAgLS1mb250LXRpdGxlOiAnR2FyYW1vbmQnLCAnVGltZXMgTmV3IFJvbWFuJywgc2VyaWY7CiAgICAtLWZvbnQtZGF0YTogJ0ltcGFjdCcsICdBcmlhbCBOYXJyb3cnLCBzYW5zLXNlcmlmOwogICAgLS1mb250LXVpOiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAtLWZvbnQtc3BpcmE6ICdTcGlyYScsICdJbXBhY3QnLCBzYW5zLXNlcmlmOwp9CgpAZm9udC1mYWNlIHsKICAgIGZvbnQtZmFtaWx5OiAnU3BpcmEnOwogICAgc3JjOiB1cmwoJ2h0dHBzOi8vZmlsZXMuY2F0Ym94Lm1vZS96eW43czMudHRmJykgZm9ybWF0KCd0cnVldHlwZScpOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgIGZvbnQtc3R5bGU6IG5vcm1hbDsKfQoKaHRtbCwgYm9keSB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB3aWR0aDogMTAwdnc7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBwb3NpdGlvbjogZml4ZWQ7IAogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHJpZ2h0OiAwOwogICAgYm90dG9tOiAwOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBjb2xvcjogd2hpdGU7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICBwYWRkaW5nLXRvcDogZW52KHNhZmUtYXJlYS1pbnNldC10b3ApOwogICAgcGFkZGluZy1ib3R0b206IGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKTsKICAgIHBhZGRpbmctbGVmdDogZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KTsKICAgIHBhZGRpbmctcmlnaHQ6IGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpOwp9CgoqIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7Cn0KCi8qIC0tLSBNQUlOIEdBTUUgQ09OVEFJTkVSIC0tLSAqLwojZ2FtZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgbWF4LXdpZHRoOiBub25lOwogICAgYmFja2dyb3VuZDogIzAwMDUxMDsKICAgIGJveC1zaGFkb3c6IG5vbmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgdHJhbnNpdGlvbjogZmlsdGVyIDAuMDVzOwogICAgei1pbmRleDogMTsKICAgIGNvbnRhaW46IHN0cmljdDsKfQoKLyogLS0tIElNUEFDVCBGWCAtLS0gKi8KI2dhbWUtY29udGFpbmVyLmltcGFjdC1meCB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuMXMgZWFzZS1pbi1vdXQ7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDEuMikgYnJpZ2h0bmVzcygxLjEpOwp9CgojZ2FtZS1jb250YWluZXIuaW1wYWN0LWhlYXZ5IHsKICAgIGFuaW1hdGlvbjogaW1wYWN0U2hha2UgMC4ycyBlYXNlLWluLW91dDsKICAgIGZpbHRlcjogY29udHJhc3QoMS41KSBicmlnaHRuZXNzKDEuMykgc2VwaWEoMC40KSBodWUtcm90YXRlKC0xMGRlZyk7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3Qtc2hhdHRlciB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuNHMgZWFzZS1pbi1vdXQ7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDIuMCkgaW52ZXJ0KDAuMSkgc2F0dXJhdGUoMi4wKTsKfQoKQGtleWZyYW1lcyBpbXBhY3RTaGFrZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDAsIDApOyB9CiAgICAyNSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNXB4LCA1cHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSg1cHgsIC01cHgpOyB9CiAgICA3NSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNXB4LCAtNXB4KTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDAsIDApOyB9Cn0KCi8qIC0tLSBDQU5WQVMgJiBSRU5ERVIgLS0tICovCmNhbnZhcyB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsKICAgIGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGltYWdlLXJlbmRlcmluZzogcGl4ZWxhdGVkOyAKICAgIHotaW5kZXg6IDA7Cn0KCi8qIC0tLSBHSUYgT1ZFUkxBWSAtLS0gKi8KI3NjcmVlbi1vdmVybGF5LWdpZiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgb2JqZWN0LWZpdDogY292ZXI7CiAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKICAgIG9wYWNpdHk6IDEuMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogOTUwOwogICAgaW1hZ2UtcmVuZGVyaW5nOiBwaXhlbGF0ZWQ7Cn0KCiN1aS1sYXllciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgei1pbmRleDogMTAwMDsKICAgIGNvbnRhaW46IHN0cmljdDsKfQoKLyogLS0tIENJTkVNQVRJQyBCQVJTIC0tLSAqLwojY2luZW1hdGljLWJhcnMgLmJhciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAwOwogICAgYmFja2dyb3VuZDogYmxhY2s7CiAgICB0cmFuc2l0aW9uOiBoZWlnaHQgMC41cyBlYXNlOwogICAgei1pbmRleDogODAwOwp9CiNjaW5lbWF0aWMtYmFycyAuYmFyLnRvcCB7IHRvcDogMDsgfQojY2luZW1hdGljLWJhcnMgLmJhci5ib3R0b20geyBib3R0b206IDA7IH0KCi8qIC0tLSBURUNIIEZMQVNIIE9WRVJMQVkgLS0tICovCiN0ZWNoLWZsYXNoLW92ZXJsYXkgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAyMCU7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEyMHB4OwogICAgZGlzcGxheTogbm9uZTsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwwLDAsMCkgMCUsIHJnYmEoMCwgMjAsIDYwLCAwLjkpIDIwJSwgcmdiYSgwLCAyMCwgNjAsIDAuOSkgODAlLCByZ2JhKDAsMCwwLDApIDEwMCUpOwogICAgei1pbmRleDogMjIwMDsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigycHgpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMTAwLCAyNTUsIDI1NSwgMC4zKTsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDEwMCwgMjU1LCAyNTUsIDAuMyk7CiAgICBhbmltYXRpb246IGZsYXNoRW50ZXIgMC4xNXMgZWFzZS1vdXQ7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBvcGFjaXR5Owp9CgpAa2V5ZnJhbWVzIGZsYXNoRW50ZXIgewogICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGVZKDApOyBvcGFjaXR5OiAwOyB9CiAgICB0byB7IHRyYW5zZm9ybTogc2NhbGVZKDEpOyBvcGFjaXR5OiAxOyB9Cn0KCi50ZWNoLWNvbnRlbnQtd3JhcHBlciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7Cn0KCi50ZWNoLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiBjbGFtcCgyOHB4LCAxMHZ3LCA0MnB4KTsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICMwMGZmZmYsIDAgMCAyMHB4ICMwMDAwZmY7CiAgICBsZXR0ZXItc3BhY2luZzogM3B4OwogICAgbWFyZ2luLWJvdHRvbTogMnB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgYW5pbWF0aW9uOiBibGlua1RleHQgMC4wOHMgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgoudGVjaC1zdWItdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjb2xvcjogIzAwZmZmZjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgbWFyZ2luLWJvdHRvbTogOHB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggcmdiYSgwLCAyNTUsIDI1NSwgMC41KTsKfQoKLnRlY2gtdGltZXItdHJhY2sgewogICAgd2lkdGg6IDI1MHB4OwogICAgaGVpZ2h0OiA4cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuNik7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ0OwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMCwwLDAsMC41KTsKfQoKLnRlY2gtdGltZXItZmlsbCB7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZmZmZmYsICMwMGZmZmYpOwogICAgd2lkdGg6IDEwMCU7CiAgICB0cmFuc2Zvcm0tb3JpZ2luOiBsZWZ0OwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKfQoKQGtleWZyYW1lcyBibGlua1RleHQgewogICAgZnJvbSB7IG9wYWNpdHk6IDAuODsgdGV4dC1zaGFkb3c6IDAgMCA1cHggIzAwZmZmZjsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgfQogICAgdG8geyBvcGFjaXR5OiAxLjA7IHRleHQtc2hhZG93OiAwIDAgMjBweCAjZmZmZmZmLCAwIDAgMTBweCAjMDBmZmZmOyB0cmFuc2Zvcm06IHNjYWxlKDEuMDIpOyB9Cn0KCi8qIC0tLSBIVUQgVE9QIC0tLSAqLwovKiAtLS0gSFVEIFRPUCAtLS0gKi8KI2h1ZC10b3AgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogZmxleC1zdGFydDsKICAgIHdpZHRoOiAxMDAlOwogICAgcGFkZGluZzogMTVweDsKICAgIHBhZGRpbmctdG9wOiBtYXgoMTVweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApKTsKICAgIHBhZGRpbmctbGVmdDogbWF4KDE1cHgsIGVudihzYWZlLWFyZWEtaW5zZXQtbGVmdCkpOwogICAgcGFkZGluZy1yaWdodDogbWF4KDE1cHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCByZ2JhKDAsIDUsIDE1LCAwLjkpIDAlLCByZ2JhKDAsMCwwLDApIDEwMCUpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuNXM7Cn0KCi50ZWFtLXdpbmcgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB3aWR0aDogMTQwcHg7CiAgICBoZWlnaHQ6IDU1cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTYwZGVnLCByZ2JhKDIwLCA0MCwgODAsIDAuOSkgMCUsIHJnYmEoNSwgMTAsIDIwLCAwLjk1KSAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIGJvcmRlci10b3A6IDJweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xNWRlZyk7CiAgICBib3gtc2hhZG93OiAwIDVweCAxNXB4IHJnYmEoMCwgMCwgMCwgMC41KSwgaW5zZXQgMCAwIDIwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC4xKTsKICAgIHBhZGRpbmc6IDAgMTVweDsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig0cHgpOwp9CgoudGVhbS13aW5nOjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHJnYmEoMjU1LDI1NSwyNTUsMC4xKSwgdHJhbnNwYXJlbnQpOwogICAgYW5pbWF0aW9uOiB3aW5nU2hpbW1lciA0cyBpbmZpbml0ZTsKfQoKQGtleWZyYW1lcyB3aW5nU2hpbW1lciB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtMTAwJSk7IH0KICAgIDIwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxMDAlKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxMDAlKTsgfQp9CgoudGVhbS13aW5nLmF3YXkgewogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZyk7CiAgICBmbGV4LWRpcmVjdGlvbjogcm93LXJldmVyc2U7CiAgICBib3JkZXItdG9wLWNvbG9yOiAjZmY2NjY2OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KC0xNjBkZWcsIHJnYmEoNjAsIDIwLCAyMCwgMC45KSAwJSwgcmdiYSgyMCwgNSwgNSwgMC45NSkgMTAwJSk7Cn0KCi50ZWFtLWRhdGEgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpOwogICAgZmxleC1ncm93OiAxOwp9Ci50ZWFtLXdpbmcuYXdheSAudGVhbS1kYXRhIHsgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpOyB0ZXh0LWFsaWduOiByaWdodDsgfQoKLnRlYW0tbmFtZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDE2cHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggcmdiYSgwLCAxNTAsIDI1NSwgMC44KTsKfQoudGVhbS1zdWIgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgb3BhY2l0eTogMC44OwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKfQoudGVhbS13aW5nLmF3YXkgLnRlYW0tc3ViIHsgY29sb3I6ICNmZmFhYWE7IH0KCi5zY29yZS1ib3ggewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDE1cHggdmFyKC0tZmZ4LWN5YW4tZ2xvdyk7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDE1ZGVnKTsKICAgIG1hcmdpbjogMCA1cHg7CiAgICBtaW4td2lkdGg6IDMwcHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KLnRlYW0td2luZy5hd2F5IC5zY29yZS1ib3ggeyB0cmFuc2Zvcm06IHNrZXdYKC0xNWRlZyk7IHRleHQtc2hhZG93OiAwIDAgMTVweCAjZmY0NDQ0OyB9CgoudGltZXItY29tcGxleCB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBtYXJnaW4tdG9wOiAtNXB4Owp9CgoudGltZXItY3J5c3RhbC1yaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTMwcHg7CiAgICB3aWR0aDogMTQwcHg7CiAgICBoZWlnaHQ6IDcwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXItdG9wOiAzcHggc29saWQgdmFyKC0tZmZ4LWdvbGQpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHRyYW5zcGFyZW50OwogICAgYm94LXNoYWRvdzogMCAtNXB4IDIwcHggcmdiYSgyMDAsIDE4MCwgMTAwLCAwLjQpLCBpbnNldCAwIDEwcHggMjBweCByZ2JhKDAsMCwwLDAuNSk7CiAgICB6LWluZGV4OiAtMTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChlbGxpcHNlIGF0IHRvcCwgcmdiYSgyMCwgNDAsIDgwLCAwLjkpLCB0cmFuc3BhcmVudCA3MCUpOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7Cn0KCiNoYWxmLWluZGljYXRvciB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIG1hcmdpbi1ib3R0b206IC00cHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtZ29sZC1kYXJrKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KCiN0aW1lci1kaXNwbGF5IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiA0OHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZiAwJSwgI2ZmZDcwMCA1MCUsICNiODg2MGIgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAycHggMHB4IHJnYmEoMCwwLDAsMC44KSk7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4Owp9Ci8qIC0tLSBQTEFZRVIgU1RBVFVTIFBBTkVMIC0tLSAqLwojcGxheWVyLXN0YXR1cy1wYW5lbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCgxNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pICsgNDBweCk7CiAgICBsZWZ0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KSk7CiAgICB3aWR0aDogMTYwcHg7CiAgICBwYWRkaW5nOiAxMHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDEwLCAzMCwgMC44KSAwJSwgcmdiYSgwLDAsMCwwKSAxMDAlKTsKICAgIGJvcmRlci1sZWZ0OiAzcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogMCAxMHB4IDEwcHggMDsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig0cHgpOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwp9CgouY2hhci1uYW1lIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMThweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBtYXJnaW4tYm90dG9tOiA1cHg7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDEwZGVnKTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1ibHVlLWxpZ2h0KTsKfQoKLmhwLWdhdWdlLWNvbnRhaW5lciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG1hcmdpbi1ib3R0b206IDRweDsKICAgIHRyYW5zZm9ybTogc2tld1goMTBkZWcpOwp9Ci5ocC1sYWJlbCB7IGZvbnQtc2l6ZTogMTBweDsgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsgd2lkdGg6IDIwcHg7IH0KLmhwLWJhci10cmFjayB7CiAgICBmbGV4LWdyb3c6IDE7CiAgICBoZWlnaHQ6IDZweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC41KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBtYXJnaW46IDAgNXB4Owp9Ci5ocC1iYXItZmlsbCB7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwMGZmMDAsICNjY2ZmY2MpOwogICAgYm94LXNoYWRvdzogMCAwIDVweCAjMDBmZjAwOwp9Ci5ocC12YWx1ZSB7IGZvbnQtc2l6ZTogMTBweDsgY29sb3I6ICNmZmY7IHdpZHRoOiA0NXB4OyB0ZXh0LWFsaWduOiByaWdodDsgfQoKLnRlY2gtZ2F1Z2UtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7Cn0KLnRlY2gtbGFiZWwgeyBmb250LXNpemU6IDEwcHg7IGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7IHdpZHRoOiAyMHB4OyB9Ci50ZWNoLWJhci10cmFjayB7CiAgICBmbGV4LWdyb3c6IDE7CiAgICBoZWlnaHQ6IDRweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC41KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBtYXJnaW46IDAgNXB4Owp9Ci50ZWNoLWJhci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmYWEwMCwgI2ZmZmZhYSk7Cn0KCi8qIC0tLSBNSU5JTUFQIC0tLSAqLwojbWluaW1hcC1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoODBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNjBweCk7CiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiAxMTBweDsKICAgIGhlaWdodDogMTEwcHg7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgoucmFkYXItcmltIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDJweCBzb2xpZCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCB2YXIoLS1mZngtYmx1ZS1taWQpLCBpbnNldCAwIDAgMjBweCByZ2JhKDAsMCwwLDAuOCk7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCByZ2JhKDAsIDIwLCA2MCwgMC40KSAwJSwgcmdiYSgwLCA1LCAxMCwgMC44KSAxMDAlKTsKICAgIHotaW5kZXg6IDU7Cn0KCiNtaW5pbWFwIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIHdpZHRoOiAxMDBweDsKICAgIGhlaWdodDogMTAwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB6LWluZGV4OiA2OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKLnJhZGFyLWxhYmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogLTE1cHg7CiAgICB3aWR0aDogMTQwJTsKICAgIGxlZnQ6IC0yMCU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKfQoKLm1hcC1kb3QgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDZweDsgaGVpZ2h0OiA2cHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGJveC1zaGFkb3c6IDAgMCA0cHggY3VycmVudENvbG9yOwp9Ci5tYXAtZG90LmhvbWUgeyBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtY3lhbik7IGNvbG9yOiB2YXIoLS1mZngtY3lhbik7IH0KLm1hcC1kb3QuYXdheSB7IGJhY2tncm91bmQ6ICNmZjQ0NDQ7IGNvbG9yOiAjZmY0NDQ0OyB9Ci5tYXAtZG90LmJhbGwgeyAKICAgIGJhY2tncm91bmQ6ICNmZjAwY2M7CiAgICBjb2xvcjogI2ZmMDBjYzsgCiAgICB3aWR0aDogMTJweDsgaGVpZ2h0OiAxMnB4OwogICAgYm9yZGVyOiAycHggc29saWQgI2ZmZmZmZjsKICAgIHotaW5kZXg6IDIwOwogICAgYW5pbWF0aW9uOiBibGlua0JhbGwgMC4zcyBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICBib3gtc2hhZG93OiAwIDAgNnB4ICNmZjAwY2M7Cn0KLm1hcC1kb3QubmFwIHsgYmFja2dyb3VuZDogIzMzMzsgY29sb3I6ICMwMDA7IGJvcmRlcjogMXB4IHNvbGlkICM1NTU7IH0KLm1hcC1kb3QuYWN0aXZlLXBsYXllciB7IAogICAgYmFja2dyb3VuZDogIzAwZmYwMCAhaW1wb3J0YW50OyAKICAgIGNvbG9yOiAjMDBmZjAwICFpbXBvcnRhbnQ7IAogICAgYm94LXNoYWRvdzogMCAwIDhweCAjMDBmZjAwOwogICAgei1pbmRleDogMTU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjIpOwp9Ci5tYXAtZG90LmJhbGwtY2FycmllciB7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCAjZmZmLCAwIDAgMzBweCAjZmZhYTAwOwogICAgYm9yZGVyOiAycHggc29saWQgI2ZmZmZmZjsKICAgIGJhY2tncm91bmQtY29sb3I6ICNmZmFhMDAgIWltcG9ydGFudDsKICAgIHotaW5kZXg6IDEwMDsKICAgIHdpZHRoOiAxMHB4OyBoZWlnaHQ6IDEwcHg7CiAgICBhbmltYXRpb246IGNhcnJpZXJQdWxzZSAwLjhzIGluZmluaXRlIGFsdGVybmF0ZTsKfQpAa2V5ZnJhbWVzIGNhcnJpZXJQdWxzZSB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4yKTsgYm94LXNoYWRvdzogMCAwIDEwcHggI2ZmZjsgb3BhY2l0eTogMC44OyB9CiAgICB0byB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuOCk7IGJveC1zaGFkb3c6IDAgMCAyNXB4ICNmZmNjMDA7IG9wYWNpdHk6IDEuMDsgfQp9CkBrZXlmcmFtZXMgYmxpbmtCYWxsIHsgZnJvbSB7IG9wYWNpdHk6IDE7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyB9IHRvIHsgb3BhY2l0eTogMC41OyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjMpOyB9IH0KCi8qIC0tLSBBTk5PVU5DRU1FTlRTIC0tLSAqLwojYW5ub3VuY2VtZW50IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNDAlOyAKICAgIGxlZnQ6IDUlOyAKICAgIHdpZHRoOiA5MCU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoNDBweCwgMTJ2dywgNzJweCk7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBsaW5lLWhlaWdodDogMS4wOwogICAgd2hpdGUtc3BhY2U6IG5vcm1hbDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmYgMCUsICNmZmQ3MDAgNDAlLCAjYjg4NjBiIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuNSkpIGRyb3Atc2hhZG93KDNweCAzcHggMCAjMDAwKTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAyMDAwOwogICAgYW5pbWF0aW9uOiBhbm5vdW5jZVNsaWRlIDAuNXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBvcGFjaXR5Owp9CgpAa2V5ZnJhbWVzIGFubm91bmNlU2xpZGUgewogICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGUoMCkgcm90YXRlKC01ZGVnKTsgb3BhY2l0eTogMDsgfQogICAgdG8geyB0cmFuc2Zvcm06IHNjYWxlKDEpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMTsgfQp9CgovKiAtLS0gSk9ZU1RJQ0sgLS0tICovCiNqb3lzdGljay1oaXQtem9uZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogNTAlOyBoZWlnaHQ6IDUwJTsKICAgIHotaW5kZXg6IDEwMDA7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDApOyAKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9Cgojam95c3RpY2stdmlzdWFsLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMDsgaGVpZ2h0OiAwOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAxMTAwOwp9Cgojam95c3RpY2stYmFzZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMTIwcHg7IGhlaWdodDogMTIwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCByZ2JhKDAsIDQwLCA4MCwgMC40KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuMSkgNjAlLCB0cmFuc3BhcmVudCAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMTAwLCAyMjAsIDI1NSwgMC4zKTsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMiksIGluc2V0IDAgMCAzMHB4IHJnYmEoMCwgNTAsIDEwMCwgMC4zKTsKICAgIGFuaW1hdGlvbjogYmFzZVB1bHNlIDJzIGluZmluaXRlIGFsdGVybmF0ZTsKfQoKQGtleWZyYW1lcyBiYXNlUHVsc2UgewogICAgZnJvbSB7IGJveC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMik7IGJvcmRlci1jb2xvcjogcmdiYSgxMDAsIDIyMCwgMjU1LCAwLjIpOyB9CiAgICB0byB7IGJveC1zaGFkb3c6IDAgMCAyNXB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuNSk7IGJvcmRlci1jb2xvcjogcmdiYSgxMDAsIDI1NSwgMjU1LCAwLjYpOyB9Cn0KCiNqb3lzdGljay1rbm9iIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiA1MHB4OyBoZWlnaHQ6IDUwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsICNlMGZmZmYgMCUsICMwMGFhZmYgNDAlLCAjMDA0NDg4IDgwJSwgIzAwMTEyMiAxMDAlKTsKICAgIGJvcmRlcjogMnB4IHNvbGlkICM4OGNjZmY7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCAjMDBmZmZmLCBpbnNldCAwIDAgMTBweCByZ2JhKDI1NSwyNTUsMjU1LDAuOCk7CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4wNXMgbGluZWFyOwogICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybTsKfQoKI2pveXN0aWNrLWtub2I6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICIiOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAyMCU7IGxlZnQ6IDIwJTsgd2lkdGg6IDIwJTsgaGVpZ2h0OiAyMCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAjZmZmZmZmIDAlLCB0cmFuc3BhcmVudCA3MCUpOwogICAgZmlsdGVyOiBibHVyKDJweCk7CiAgICBvcGFjaXR5OiAwLjg7Cn0KCi50b3VjaC1yaXBwbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgyMDAsIDI1NSwgMjU1LCAwLjgpIDAlLCByZ2JhKDAsIDI1NSwgMjU1LCAwLjQpIDQwJSwgdHJhbnNwYXJlbnQgNzAlKTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDApOwogICAgYW5pbWF0aW9uOiByaXBwbGVBbmltIDAuNnMgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDkwMDA7CiAgICBtaXgtYmxlbmQtbW9kZTogc2NyZWVuOwogICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybSwgb3BhY2l0eTsKfQoKQGtleWZyYW1lcyByaXBwbGVBbmltIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMCk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgzLjApOyBvcGFjaXR5OiAwOyB9Cn0KCiNjYW1lcmEtem9uZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IHJpZ2h0OiAwOyB3aWR0aDogNTAlOyBoZWlnaHQ6IDEwMCU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHotaW5kZXg6IDUwOwp9CgovKiAtLS0gQUNUSU9OIEJVVFRPTiAtLS0gKi8KI2FjdGlvbi1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiBtYXgoNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pKTsgCiAgICByaWdodDogbWF4KDQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgei1pbmRleDogMTAwOwp9CgouY29tbWFuZC1tZW51LWJnIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxODBweDsgaGVpZ2h0OiA4MHB4OwogICAgYm90dG9tOiAxNXB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCAwJSwgcmdiYSgwLCAxMCwgMzAsIDAuOCkgNTAlLCB0cmFuc3BhcmVudCAxMDAlKTsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDAsIDIwMCwgMjU1LCAwLjMpOwogICAgei1pbmRleDogLTE7Cn0KCi5jb21tYW5kLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDEzMHB4OyBoZWlnaHQ6IDEzMHB4OwogICAgYm9yZGVyOiAycHggc29saWQgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjEpOwogICAgYm9yZGVyLXRvcDogMnB4IHNvbGlkIHJnYmEoMCwgMjU1LCAyNTUsIDAuNik7CiAgICBib3JkZXItYm90dG9tOiAycHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC42KTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGFuaW1hdGlvbjogc3BpblJldmVyc2UgMTVzIGxpbmVhciBpbmZpbml0ZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLCAxMDAsIDI1NSwgMC4yKTsKfQpAa2V5ZnJhbWVzIHNwaW5SZXZlcnNlIHsgZnJvbSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHJvdGF0ZSgzNjBkZWcpOyB9IHRvIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgcm90YXRlKDBkZWcpOyB9IH0KCiNhY3Rpb24tbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNSwgMTAsIDAuOCk7CiAgICBwYWRkaW5nOiA0cHggMTJweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZmeC1ibHVlLWxpZ2h0KTsKICAgIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCByZ2JhKDAsMCwwLDAuOCk7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4zczsKfQoKI2FjdGlvbi1idXR0b24gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDEwMHB4OyBoZWlnaHQ6IDEwMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMXMsIGZpbHRlciAwLjNzOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmZmZmZmIDAlLCAjMDA4OGZmIDQwJSwgIzAwMjI2NiA4MCUsICMwMDAgMTAwJSk7CiAgICBib3JkZXI6IDNweCBzb2xpZCAjNDRhYWZmOwogICAgYm94LXNoYWRvdzogMCAwIDIwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC44KSwgaW5zZXQgMCAwIDIwcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjQpOwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG92ZXJmbG93OiB2aXNpYmxlOwogICAgei1pbmRleDogMTA7Cn0KCiNwYXNzLWJ1dHRvbiB7CiAgICBkaXNwbGF5OiBub25lICFpbXBvcnRhbnQ7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IC0yMHB4OyBsZWZ0OiAtMzBweDsKICAgIHdpZHRoOiA2MHB4OyBoZWlnaHQ6IDYwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB6LWluZGV4OiA5Owp9CgojYWN0aW9uLWJ1dHRvbjo6YmVmb3JlIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtNDBweDsgbGVmdDogLTQwcHg7IHJpZ2h0OiAtNDBweDsgYm90dG9tOiAtNDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHotaW5kZXg6IDEwOwp9CgojYWN0aW9uLWJ1dHRvbjphY3RpdmUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuOTIpOyB9CgojYWN0aW9uLWJ1dHRvbiAuYnRuLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAyMnB4OwogICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAycHggNHB4IHJnYmEoMCwwLDAsMC44KSwgMCAwIDEwcHggcmdiYSgyNTUsMjU1LDI1NSwwLjUpOwogICAgei1pbmRleDogNTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKI2FjdGlvbi1idXR0b24gLmJ0bi1nbGFyZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01MCU7IGxlZnQ6IC01MCU7IHdpZHRoOiAyMDAlOyBoZWlnaHQ6IDIwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoNDVkZWcsIHRyYW5zcGFyZW50IDQwJSwgcmdiYSgyNTUsMjU1LDI1NSwwLjQpIDUwJSwgdHJhbnNwYXJlbnQgNjAlKTsKICAgIGFuaW1hdGlvbjogZ2xhcmVQYXNzIDVzIGluZmluaXRlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiA2OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwp9CgoubGltaXQtcmluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01cHg7IGxlZnQ6IC01cHg7IHJpZ2h0OiAtNXB4OyBib3R0b206IC01cHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDJweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGJveC1zaGFkb3c6IDAgMCAwIHRyYW5zcGFyZW50OwogICAgdHJhbnNpdGlvbjogYWxsIDAuNXM7CiAgICB6LWluZGV4OiAxOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCiNhY3Rpb24tYnV0dG9uLnNob290LW1vZGUgewogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmZmZmFhIDAlLCAjZmZhYTAwIDQwJSwgIzg4MjIwMCA4MCUsICMyMjAwMDAgMTAwJSk7CiAgICBib3JkZXItY29sb3I6ICNmZmNjMDA7CiAgICBib3gtc2hhZG93OiAwIDAgMzBweCByZ2JhKDI1NSwgMTAwLCAwLCAwLjgpLCBpbnNldCAwIDAgMjBweCByZ2JhKDI1NSwgMjU1LCAwLCAwLjUpOwp9CgojYWN0aW9uLWJ1dHRvbi5saW1pdC1yZWFkeSAubGltaXQtcmluZyB7CiAgICBib3JkZXItY29sb3I6ICNmZmRkNDQ7CiAgICBhbmltYXRpb246IGxpbWl0UHVsc2UgMC44cyBlYXNlLWluLW91dCBpbmZpbml0ZSBhbHRlcm5hdGU7Cn0KCi5zaG9vdC1sYWJlbCB7CiAgICBjb2xvcjogI2ZmZGQ0NCAhaW1wb3J0YW50OwogICAgYm9yZGVyLWNvbG9yOiAjZmZhYTAwICFpbXBvcnRhbnQ7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggI2ZmNDQwMCAhaW1wb3J0YW50Owp9CgpAa2V5ZnJhbWVzIGxpbWl0UHVsc2UgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IGJveC1zaGFkb3c6IDAgMCAxMHB4ICNmZmFhMDAsIGluc2V0IDAgMCA1cHggI2ZmYWEwMDsgb3BhY2l0eTogMC41OyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjE1KTsgYm94LXNoYWRvdzogMCAwIDMwcHggI2ZmNDQwMCwgaW5zZXQgMCAwIDE1cHggI2ZmMDAwMDsgb3BhY2l0eTogMS4wOyB9Cn0KCi8qIC0tLSBBVVRPIFRPR0dMRSAtLS0gKi8KI2F1dG8tdG9nZ2xlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDIwMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA2MHB4KTsgCiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiAxMTBweDsKICAgIHBhZGRpbmc6IDEwcHggMDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMCwgMjAsIDQwLCAwLjgpIDAlLCByZ2JhKDAsIDUsIDEwLCAwLjkpIDEwMCUpOwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7CiAgICBib3gtc2hhZG93OiAwIDVweCAxNXB4IHJnYmEoMCwwLDAsMC4zKTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICB6LWluZGV4OiAxMDA7Cn0KCiNhdXRvLXRvZ2dsZTpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDQwLCA4MCwgMC45KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHZhcigtLWZmeC1jeWFuKTsKICAgIGNvbG9yOiB3aGl0ZTsKfQoKI2F1dG8tdG9nZ2xlLmFjdGl2ZSB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDEwMCwgMjAsIDAsIDAuOCkgMCUsIHJnYmEoNDAsIDAsIDAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXItY29sb3I6ICNmZjQ0MDA7CiAgICBjb2xvcjogI2ZmYWEwMDsKICAgIGFuaW1hdGlvbjogcHVsc2VSZWQgMnMgaW5maW5pdGU7Cn0KQGtleWZyYW1lcyBwdWxzZVJlZCB7IDAlIHsgYm94LXNoYWRvdzogMCAwIDVweCAjZmYwMDAwOyB9IDUwJSB7IGJveC1zaGFkb3c6IDAgMCAyMHB4ICNmZjQ0MDA7IH0gMTAwJSB7IGJveC1zaGFkb3c6IDAgMCA1cHggI2ZmMDAwMDsgfSB9CgovKiAtLS0gRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtd3JhcHBlciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDIwMDA7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtOwogICAgY29udGFpbjogbGF5b3V0IHN0eWxlOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lciB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAyNHB4OyAKICAgIHRleHQtc2hhZG93OiAxcHggMXB4IDAgIzAwMDsKICAgIG9wYWNpdHk6IDAuOTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuZGFtYWdlIHsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmZmYgMCUsICNmZmNjMDAgNDAlLCAjZmY0NDAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgNHB4IDRweCByZ2JhKDAsMCwwLDAuOCkpOwogICAgYW5pbWF0aW9uOiBwb3BEYW1hZ2UgMC44cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSkgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmhlYWwgewogICAgZm9udC1zaXplOiAzNnB4OwogICAgY29sb3I6ICM0NGZmNDQ7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmYwMDsKICAgIGFuaW1hdGlvbjogZmxvYXRVcCAxcyBlYXNlLW91dCBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIudmVub20gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBjb2xvcjogI2FhZmYwMDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjNDQ4ODAwLCAycHggMnB4IDAgIzAwMjIwMDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNjY2ZmNjYgMCUsICM2NmNjMDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDVweCByZ2JhKDEwMCwgMjU1LCAwLCAwLjUpKTsKICAgIGFuaW1hdGlvbjogZHJpcFN0YXR1cyAycyBpbmZpbml0ZTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2xlZXAgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDE1cHggIzAwNDRmZiwgMCAwIDMwcHggIzAwMDBmZjsKICAgIG9wYWNpdHk6IDAuOTsKICAgIGFuaW1hdGlvbjogZHJpZnRTdGF0dXMgM3MgZWFzZS1pbi1vdXQgaW5maW5pdGU7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLndpdGhlciB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzhweDsKICAgIGNvbG9yOiAjY2NjY2NjOwogICAgdGV4dC1zaGFkb3c6IDJweCAycHggMCAjNDQ0NDQ0OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2VlZWVlZSAwJSwgIzg4ODg4OCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYW5pbWF0aW9uOiB3aXRoZXJTdGF0dXMgMS41cyBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIudGVjaCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDMycHg7CiAgICBjb2xvcjogIzAwZmZmZjsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMTAsIDMwLCAwLjcpOwogICAgcGFkZGluZzogMnB4IDEwcHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjMDBmZmZmOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggIzAwODhmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICNmZmY7CiAgICBhbmltYXRpb246IHNoYWtlVGVjaCAwLjZzIGVhc2UtaW4tb3V0LCBmbGFzaFRlY2ggMC4zczsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGNlbnRlcjsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2F2ZSwgLmZsb2F0aW5nLXRleHQtaW5uZXIuYmxvY2sgewogICAgZm9udC1zaXplOiA0OHB4OwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgLXdlYmtpdC10ZXh0LXN0cm9rZTogMXB4ICMwMDQ0ODg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwODhmZjsKICAgIGFuaW1hdGlvbjogcG9wRGFtYWdlIDAuNXMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCkBrZXlmcmFtZXMgcG9wRGFtYWdlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjUpOyBvcGFjaXR5OiAwOyB9CiAgICAyMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuNSk7IG9wYWNpdHk6IDE7IH0KICAgIDQwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIGZsb2F0VXAgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMCk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTUwcHgpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgZHJpcFN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGVZKDEpOyBmaWx0ZXI6IGJsdXIoMHB4KTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiBzY2FsZVkoMS4xKSB0cmFuc2xhdGVZKDVweCk7IGZpbHRlcjogYmx1cigxcHgpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZVkoMSk7IGZpbHRlcjogYmx1cigwcHgpOyB9Cn0KCkBrZXlmcmFtZXMgZHJpZnRTdGF0dXMgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMCkgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9CiAgICAyMCUgeyBvcGFjaXR5OiAxOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMTVweCkgdHJhbnNsYXRlWSgtMjBweCkgcm90YXRlKDEwZGVnKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtMTVweCkgdHJhbnNsYXRlWSgtNTBweCkgcm90YXRlKC0xMGRlZyk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyB3aXRoZXJTdGF0dXMgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEpOyBmaWx0ZXI6IGdyYXlzY2FsZSgwJSk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuNik7IGZpbHRlcjogZ3JheXNjYWxlKDEwMCUpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgc2hha2VUZWNoIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjgpOyB9CiAgICAxMCUsIDMwJSwgNTAlLCA3MCUsIDkwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4xKSB0cmFuc2xhdGUoLTJweCwgMnB4KTsgfQogICAgMjAlLCA0MCUsIDYwJSwgODAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjEpIHRyYW5zbGF0ZSgycHgsIC0ycHgpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyB9Cn0KCkBrZXlmcmFtZXMgZmxhc2hUZWNoIHsKICAgIDAlIHsgYmFja2dyb3VuZC1jb2xvcjogI2ZmZjsgY29sb3I6ICMwMDA7IGJvcmRlci1jb2xvcjogI2ZmZjsgfQogICAgMTAwJSB7IGJhY2tncm91bmQtY29sb3I6IHJnYmEoMCwgMTAsIDMwLCAwLjg1KTsgY29sb3I6ICMwMGZmZmY7IGJvcmRlci1jb2xvcjogIzAwZmZmZjsgfQp9CgojbG9hZGluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICBhbmltYXRpb246IGJsaW5rIDFzIGluZmluaXRlOwp9CkBrZXlmcmFtZXMgYmxpbmsgeyA1MCUgeyBvcGFjaXR5OiAwLjU7IH0gfQoKI2NvbnRyb2xzLWhpbnQgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMzBweDsgd2lkdGg6IDEwMCU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogcmdiYSgyNTUsMjU1LDI1NSwwLjQpOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5jb21pYy1pbXBhY3QgewogICAgZm9udC1mYW1pbHk6ICdJbXBhY3QnLCBzYW5zLXNlcmlmOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgY29sb3I6ICNmZmZmMDA7IAogICAgLXdlYmtpdC10ZXh0LXN0cm9rZTogMXB4ICMwMDA7CiAgICB0ZXh0LXNoYWRvdzogM3B4IDNweCAwICNmZjAwMDA7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB0cmFuc2Zvcm0tb3JpZ2luOiBjZW50ZXI7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgYW5pbWF0aW9uOiBjb21pY1BvcCAwLjRzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KSBmb3J3YXJkczsKICAgIHotaW5kZXg6IDI1MDA7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmNvbWljLWFjdGlvbiB7CiAgICBmb250LWZhbWlseTogJ0FyaWFsIEJsYWNrJywgc2Fucy1zZXJpZjsKICAgIGZvbnQtc2l6ZTogMjhweDsKICAgIGNvbG9yOiAjMDBmZmZmOyAKICAgIC13ZWJraXQtdGV4dC1zdHJva2U6IDFweCAjMDAwOwogICAgdGV4dC1zaGFkb3c6IDJweCAycHggMCAjMDA0NGFhOwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgIGFuaW1hdGlvbjogY29taWNTbGlkZSAwLjRzIGVhc2Utb3V0IGZvcndhcmRzOwogICAgei1pbmRleDogMjUwMDsKfQoKQGtleWZyYW1lcyBjb21pY1BvcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMCkgcm90YXRlKC0yMGRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIDQwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4yKSByb3RhdGUoNWRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDYwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKSByb3RhdGUoLTVkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjEpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIGNvbWljU2xpZGUgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtMjBweCwgMjBweCkgc2NhbGUoMC41KTsgb3BhY2l0eTogMDsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDIwcHgsIC0yMHB4KSBzY2FsZSgxLjIpOyBvcGFjaXR5OiAwOyB9Cn0KCi8qIC0tLSBNQUlOIE1FTlUgLS0tICovCi8qIC0tLSBNQUlOIE1FTlUgJiBFTkQgR0FNRSAoRkZYIFNUWUxFKSAtLS0gKi8KI21haW4tbWVudSwgI2VuZC1nYW1lLW1lbnUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB6LWluZGV4OiAzMDAwOwogICAgb3BhY2l0eTogMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjhzIGN1YmljLWJlemllcigwLjIsIDAuOCwgMC4yLCAxLjApOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCBjZW50ZXIsIHJnYmEoMCwgMjAsIDYwLCAwLjQpIDAlLCByZ2JhKDAsIDUsIDEwLCAwLjgpIDEwMCUpOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDVweCk7Cn0KCiNtYWluLW1lbnUuYWN0aXZlLCAjZW5kLWdhbWUtbWVudS5hY3RpdmUgewogICAgb3BhY2l0eTogMTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgoubWVudS1iZy1vdmVybGF5LCAuZW5kLWJnLWxheWVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IAogICAgICAgIGxpbmVhci1ncmFkaWVudChyZ2JhKDAsMCwwLDApIDUwJSwgcmdiYSgwLDAsMCwwLjEpIDUwJSksIAogICAgICAgIHJlcGVhdGluZy1saW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMjU1LDI1NSwyNTUsMC4wMikgMHB4LCByZ2JhKDI1NSwyNTUsMjU1LDAuMDIpIDFweCwgdHJhbnNwYXJlbnQgMXB4LCB0cmFuc3BhcmVudCAyMHB4KTsKICAgIGJhY2tncm91bmQtc2l6ZTogMTAwJSA0cHgsIDEwMCUgMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogLTE7Cn0KCi8qIExPR08gU1RZTElORyAqLwouZmZ4LWxvZ28tY29udGFpbmVyIHsKICAgIG1hcmdpbi1ib3R0b206IDUwcHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7Cn0KCi5mZngtbG9nby1tYWluIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoNDhweCwgMTB2dywgODRweCk7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogOHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZmZmZiAwJSwgI2FhY2NmZiA0MCUsICMwMDg4ZmYgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDE1cHggcmdiYSgwLCAxMDAsIDI1NSwgMC44KSk7CiAgICBhbmltYXRpb246IGxvZ29TaGltbWVyIDNzIGluZmluaXRlIGFsdGVybmF0ZTsKfQoKLmZmeC1sb2dvLXN1YiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IGNsYW1wKDE0cHgsIDN2dywgMjRweCk7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDE1cHg7CiAgICBtYXJnaW4tdG9wOiAtMTBweDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmZhYTAwOwogICAgb3BhY2l0eTogMC45Owp9CgpAa2V5ZnJhbWVzIGxvZ29TaGltbWVyIHsKICAgIDAlIHsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjUpKTsgfQogICAgMTAwJSB7IGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDI1cHggcmdiYSgwLCAyMDAsIDI1NSwgMC45KSk7IH0KfQoKLyogTUVOVSBPUFRJT05TICovCi5tZW51LW9wdGlvbnMsIC5lbmQtb3B0aW9ucyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogMTVweDsKICAgIHdpZHRoOiAzMjBweDsKfQoKLm1lbnUtaXRlbSB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBwYWRkaW5nOiAxMnB4IDMwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMzAsIDYwLCAwLjgpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC4yKSAxMDAlKTsKICAgIGJvcmRlci1sZWZ0OiAzcHggc29saWQgcmdiYSgxMDAsIDIwMCwgMjU1LCAwLjMpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4xKTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRyYW5zaXRpb246IGFsbCAwLjNzIGN1YmljLWJlemllcigwLjIsIDAuOCwgMC4yLCAxLjApOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpOwogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgoubWVudS1pdGVtOjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IC0xMDAlOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjIpLCB0cmFuc3BhcmVudCk7CiAgICB0cmFuc2l0aW9uOiBsZWZ0IDAuNHM7Cn0KCi5tZW51LWl0ZW06aG92ZXI6OmJlZm9yZSB7CiAgICBsZWZ0OiAxMDAlOwp9CgoubWVudS1pdGVtOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgwLCA4MCwgMTYwLCAwLjkpIDAlLCByZ2JhKDAsIDIwLCA0MCwgMC40KSAxMDAlKTsKICAgIGJvcmRlci1sZWZ0LWNvbG9yOiAjMDBmZmZmOwogICAgcGFkZGluZy1sZWZ0OiA0NXB4OwogICAgYm94LXNoYWRvdzogMCAwIDIwcHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLm1lbnUtaXRlbSAubGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAyMHB4OwogICAgY29sb3I6ICNjY2NjY2M7CiAgICBsZXR0ZXItc3BhY2luZzogM3B4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpOwogICAgdHJhbnNpdGlvbjogY29sb3IgMC4yczsKfQoKLm1lbnUtaXRlbTpob3ZlciAubGFiZWwgewogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKfQoKLm1lbnUtaXRlbSAuY3Vyc29yIHsKICAgIHdpZHRoOiAxMHB4OyBoZWlnaHQ6IDEwcHg7CiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtZ29sZCk7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBtYXJnaW4tcmlnaHQ6IDE1cHg7CiAgICBvcGFjaXR5OiAwOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0yMHB4KSBza2V3WCgxNWRlZyk7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4zczsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHZhcigtLWZmeC1nb2xkKTsKfQoKLm1lbnUtaXRlbTpob3ZlciAuY3Vyc29yIHsKICAgIG9wYWNpdHk6IDE7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMCkgc2tld1goMTVkZWcpOwp9CgoubWVudS1mb290ZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAzMHB4OwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHJnYmEoMjU1LDI1NSwyNTUsMC4zKTsKICAgIGxldHRlci1zcGFjaW5nOiA0cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwp9CgovKiBFTkQgR0FNRSBTUEVDSUZJQyAqLwoucmVzdWx0LWhlYWRlciB7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBtYXJnaW4tYm90dG9tOiA0MHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwp9CgoucmVzdWx0LXRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogNzJweDsKICAgIGNvbG9yOiAjZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICMwMGFhZmYsIDAgMCA0MHB4ICMwMDQ0YWE7CiAgICBsZXR0ZXItc3BhY2luZzogNXB4OwogICAgbGluZS1oZWlnaHQ6IDEuMDsKfQoKLnJlc3VsdC1zdWJ0aXRsZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDE4cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDhweDsKICAgIG1hcmdpbi10b3A6IDVweDsKfQoKLmZpbmFsLXNjb3JlLWNvbnRhaW5lciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgZ2FwOiA0MHB4OwogICAgbWFyZ2luLWJvdHRvbTogNTBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHJnYmEoMCwgMjAsIDUwLCAwLjgpLCB0cmFuc3BhcmVudCk7CiAgICBwYWRkaW5nOiAyMHB4IDA7CiAgICB3aWR0aDogMTAwJTsKfQoKLmZpbmFsLXRlYW0gewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgd2lkdGg6IDEyMHB4Owp9CgouZmluYWwtc2NvcmUtZGlnaXQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDgwcHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNSk7CiAgICBsaW5lLWhlaWdodDogMS4wOwp9CgouZmluYWwtdGVhbS5ob21lIC5maW5hbC1zY29yZS1kaWdpdCB7IGNvbG9yOiAjMDBmZmZmOyB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwZmZmZjsgfQouZmluYWwtdGVhbS5hd2F5IC5maW5hbC1zY29yZS1kaWdpdCB7IGNvbG9yOiAjZmY0NDQ0OyB0ZXh0LXNoYWRvdzogMCAwIDIwcHggI2ZmNDQ0NDsgfQoKLmZpbmFsLXRlYW0tbmFtZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjb2xvcjogI2FhYTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBtYXJnaW4tdG9wOiA1cHg7Cn0KCi5maW5hbC12cyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBvcGFjaXR5OiAwLjY7Cn0KCi5maW5hbC12cyBzcGFuIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBtYXJnaW46IDVweCAwOwp9CgoudnMtbGluZSB7CiAgICB3aWR0aDogMnB4OyBoZWlnaHQ6IDMwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCB0cmFuc3BhcmVudCwgdmFyKC0tZmZ4LWdvbGQpLCB0cmFuc3BhcmVudCk7Cn0KLyogLS0tIFBSQUNUSUNFIE9WRVJMQVkgLS0tICovCiNwcmFjdGljZS1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNSwgMTAsIDAuNik7CiAgICBkaXNwbGF5OiBub25lOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgei1pbmRleDogMjUwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgojcHJhY3RpY2Utb3ZlcmxheS5hY3RpdmUgewogICAgZGlzcGxheTogZmxleDsKfQoKLnByYWN0aWNlLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDYwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDQwcHgpOyAKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDI4MHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE2MGRlZywgcmdiYSgwLCAyMCwgNTAsIDAuOTUpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC45OCkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ4OGZmOwogICAgYm9yZGVyLXJhZGl1czogMCAwIDE1cHggMDsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMiksIGluc2V0IDAgMCA1MHB4IHJnYmEoMCwgMjAsIDYwLCAwLjUpOwogICAgcGFkZGluZzogMTVweDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMmRlZyk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNXB4KTsKfQoKLnBhbmVsLWhlYWRlciB7CiAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgoucGFuZWwtdGl0bGUtZ3JvdXAgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47Cn0KCi5wYW5lbC10aXRsZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IGNsYW1wKDE4cHgsIDZ2dywgMjRweCk7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKfQoKLnBhbmVsLXN1YnRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogOHB4OwogICAgY29sb3I6ICM0NDg4ZmY7CiAgICBsZXR0ZXItc3BhY2luZzogNHB4OwogICAgbWFyZ2luLXRvcDogLTJweDsKfQoKLnBhbmVsLWRlY28tbGluZSB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMnB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgIzAwZmZmZiwgdHJhbnNwYXJlbnQpOwogICAgbWFyZ2luLXRvcDogNXB4OwogICAgYm94LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOwp9CgoucGFuZWwtY29udGVudCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogMTVweDsKfQoKLnNlY3Rpb24tbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDIwMCwgMTc2LCA5NiwgMC4zKTsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKICAgIHBhZGRpbmctYm90dG9tOiAycHg7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgouZHJpbGwtbGlzdCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogNXB4Owp9CgouZHJpbGwtYnRuIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcGFkZGluZzogOHB4IDEycHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4wNSksIHRyYW5zcGFyZW50KTsKICAgIGJvcmRlci1sZWZ0OiAycHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjYWFhOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7Cn0KCi5kcmlsbC1idG46aG92ZXIgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDI1NSwgMjU1LCAwLjEpLCB0cmFuc3BhcmVudCk7CiAgICBjb2xvcjogI2ZmZjsKICAgIHBhZGRpbmctbGVmdDogMTVweDsKfQoKLmRyaWxsLWJ0bi5hY3RpdmUgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDEwMCwgMjU1LCAwLjQpLCB0cmFuc3BhcmVudCk7CiAgICBib3JkZXItbGVmdDogM3B4IHNvbGlkICMwMGZmZmY7CiAgICBjb2xvcjogI2ZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMGZmZmY7Cn0KCi5kcmlsbC1idG4gLmljb24gewogICAgd2lkdGg6IDIwcHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBtYXJnaW4tcmlnaHQ6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwp9Cgoub3B0aW9uLWxpc3QgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBnYXA6IDVweDsKfQoKLm9wdGlvbi10b2dnbGUgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwYWRkaW5nOiA1cHggMTBweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiAjY2NjOwogICAgdHJhbnNpdGlvbjogY29sb3IgMC4yczsKfQoKLm9wdGlvbi10b2dnbGU6aG92ZXIgeyBjb2xvcjogI2ZmZjsgfQoKLm9wdGlvbi10b2dnbGUgLmNoZWNrYm94IHsKICAgIG1hcmdpbi1yaWdodDogMTBweDsKICAgIGNvbG9yOiAjNDQ0OwogICAgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsKICAgIGZvbnQtc2l6ZTogMTRweDsKfQoKLm9wdGlvbi10b2dnbGUuYWN0aXZlIC5jaGVja2JveCB7CiAgICBjb2xvcjogIzAwZmYwMDsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMGZmMDA7Cn0KCi5vcHRpb24tdG9nZ2xlLmFjdGl2ZSB7CiAgICBjb2xvcjogI2ZmZjsKfQoKLmFjdGlvbi1idG4gewogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIHBhZGRpbmc6IDZweDsKICAgIGZvbnQtc2l6ZTogMTFweDsKICAgIGNvbG9yOiAjYWFhOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICBtYXJnaW4tYm90dG9tOiA1cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKLmFjdGlvbi1idG46aG92ZXIgewogICAgYm9yZGVyLWNvbG9yOiAjZmZmOwogICAgY29sb3I6ICNmZmY7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7Cn0KCiNwLWV4aXQ6aG92ZXIgewogICAgYm9yZGVyLWNvbG9yOiAjZmY0NDQ0OwogICAgY29sb3I6ICNmZjQ0NDQ7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDUwLCAwLCAwLCAwLjMpOwp9CgoucGFuZWwtZm9vdGVyIHsKICAgIG1hcmdpbi10b3A6IDE1cHg7CiAgICBwYWRkaW5nLXRvcDogMTBweDsKICAgIGJvcmRlci10b3A6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCiNkcmlsbC1pbnN0cnVjdGlvbiB7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgbWFyZ2luLWJvdHRvbTogNXB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwp9CgojZHJpbGwtc2NvcmUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMjU1LCAyMTUsIDAsIDAuNSk7Cn0KCi5wYW5lbC1taW5pbWl6ZS1idG4gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMHB4OyByaWdodDogMTBweDsKICAgIHdpZHRoOiAyMHB4OyBoZWlnaHQ6IDIwcHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbGluZS1oZWlnaHQ6IDE4cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDAuNSk7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoucGFuZWwtbWluaW1pemUtYnRuOmhvdmVyIHsgCiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtY3lhbik7IAogICAgY29sb3I6ICMwMDA7IAogICAgYm94LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7Cn0KCiNwcmFjdGljZS1yZXN0b3JlLWJ0biB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA0MHB4KTsgCiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHBhZGRpbmc6IDhweCAxNXB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDIwLCA1MCwgMC45KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItbGVmdDogM3B4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB6LWluZGV4OiAyNDAwOwogICAgZGlzcGxheTogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC4yKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KI3ByYWN0aWNlLXJlc3RvcmUtYnRuOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjkpOwogICAgY29sb3I6ICNmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLyogLS0tIEFJTSBKT1lTVElDSyAtLS0gKi8KI2FpbS1qb3lzdGljay16b25lIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE1MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOwogICAgcmlnaHQ6IDA7CiAgICB3aWR0aDogNDAlOwogICAgaGVpZ2h0OiAzNSU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwKTsKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgojYWltLWpveXN0aWNrLXZpc3VhbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMDsgaGVpZ2h0OiAwOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAxMTAwOwp9CgojYWltLWpveXN0aWNrLWJhc2UgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDkwcHg7IGhlaWdodDogOTBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMjU1LCAxMDAsIDAsIDAuMykgMCUsIHJnYmEoODAsIDIwLCAwLCAwLjEpIDYwJSwgdHJhbnNwYXJlbnQgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMTUwLCA1MCwgMC40KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuMiksIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCA1MCwgMCwgMC4yKTsKfQoKI2FpbS1qb3lzdGljay1rbm9iIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiA0MHB4OyBoZWlnaHQ6IDQwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsICNmZmNjODggMCUsICNmZjY2MDAgNDAlLCAjODgyMjAwIDgwJSwgIzIyMDAwMCAxMDAlKTsKICAgIGJvcmRlcjogMnB4IHNvbGlkICNmZmFhNDQ7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjZmY0NDAwLCBpbnNldCAwIDAgOHB4IHJnYmEoMjU1LDI1NSwyNTUsMC42KTsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjA1cyBsaW5lYXI7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtOwp9CgojYWltLWpveXN0aWNrLWtub2I6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICJBSU0iOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgZm9udC1zaXplOiA4cHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIHRleHQtc2hhZG93OiAwIDAgM3B4ICMwMDA7Cn0KCi8qIC0tLSBUQUNLTEUgQlVUVE9OIC0tLSAqLwojdGFja2xlLWJ1dHRvbiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCgxNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pICsgMTAwcHgpOwogICAgcmlnaHQ6IG1heCg0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogNzBweDsKICAgIGhlaWdodDogNzBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHotaW5kZXg6IDEwMDsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzUlIDM1JSwgI2ZmODg4OCAwJSwgI2NjMDAwMCA0MCUsICM2NjAwMDAgODAlLCAjMjIwMDAwIDEwMCUpOwogICAgYm9yZGVyOiAzcHggc29saWQgI2ZmNDQ0NDsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjU1LCA1MCwgNTAsIDAuNiksIGluc2V0IDAgMCAxNXB4IHJnYmEoMjU1LCAyMDAsIDIwMCwgMC4zKTsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjFzLCBmaWx0ZXIgMC4yczsKfQoKI3RhY2tsZS1idXR0b246YWN0aXZlIHsKICAgIHRyYW5zZm9ybTogc2NhbGUoMC45KTsKICAgIGZpbHRlcjogYnJpZ2h0bmVzcygxLjIpOwp9CgojdGFja2xlLWJ1dHRvbi5hY3RpdmUgewogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmZmZmZmIDAlLCAjZmY0NDQ0IDQwJSwgI2FhMDAwMCA4MCUsICM0NDAwMDAgMTAwJSk7CiAgICBib3gtc2hhZG93OiAwIDAgMjVweCByZ2JhKDI1NSwgMTAwLCAxMDAsIDAuOSk7Cn0KCiN0YWNrbGUtYnV0dG9uIC5idG4tdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMXB4IDJweCByZ2JhKDAsMCwwLDAuOCk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgojdGFja2xlLWJ1dHRvbiAuYnRuLWdsYXJlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwJTsgbGVmdDogLTUwJTsKICAgIHdpZHRoOiAyMDAlOyBoZWlnaHQ6IDIwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoNDVkZWcsIHRyYW5zcGFyZW50IDQwJSwgcmdiYSgyNTUsMjU1LDI1NSwwLjMpIDUwJSwgdHJhbnNwYXJlbnQgNjAlKTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYW5pbWF0aW9uOiBnbGFyZVBhc3MgNHMgaW5maW5pdGU7Cn0KCiN0YWNrbGUtYnV0dG9uLnVyZ2VudCB7CiAgICBhbmltYXRpb246IHVyZ2VudFB1bHNlIDAuNXMgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmY1NTU1IDAlLCAjZmYwMDAwIDQwJSwgIzg4MDAwMCAxMDAlKTsKICAgIGJvcmRlci1jb2xvcjogI2ZmYWFhYTsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4ICNmZjAwMDA7Cn0KCkBrZXlmcmFtZXMgdXJnZW50UHVsc2UgewogICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgfQogICAgdG8geyB0cmFuc2Zvcm06IHNjYWxlKDEuMTUpOyB9Cn0KCi8qIC0tLSBDSEFSR0UgUE9XRVIgTUVURVIgLS0tICovCiNjaGFyZ2UtbWV0ZXItY29udGFpbmVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDI1MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyAxMDBweCk7CiAgICBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICB3aWR0aDogMjAwcHg7CiAgICBkaXNwbGF5OiBub25lOwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDIwMDA7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDEwLCAzMCwgMC44KTsKICAgIHBhZGRpbmc6IDEwcHggMTVweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMyk7Cn0KCi5jaGFyZ2UtbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgbWFyZ2luLWJvdHRvbTogNXB4Owp9CgouY2hhcmdlLW1ldGVyLXRyYWNrIHsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjYpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCiNjaGFyZ2UtbWV0ZXItZmlsbCB7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICB3aWR0aDogMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwYWYsICMwZjApOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggIzBmMDsKICAgIHRyYW5zaXRpb246IHdpZHRoIDAuMDVzIGxpbmVhciwgYmFja2dyb3VuZCAwLjFzOwogICAgYm9yZGVyLXJhZGl1czogNXB4Owp9CgouY2hhcmdlLWhpbnQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIG1hcmdpbi10b3A6IDVweDsKICAgIG9wYWNpdHk6IDAuODsKICAgIGFuaW1hdGlvbjogYmxpbmsgMC41cyBpbmZpbml0ZTsKfQoKLyogLS0tIEdPQUwgRElTVEFOQ0UgSU5ESUNBVE9SIC0tLSAqLwojZ29hbC1kaXN0YW5jZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoNzVweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNTVweCk7CiAgICBsZWZ0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KSk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDEwMDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgwLCAxMCwgMzAsIDAuNykgMCUsIHRyYW5zcGFyZW50IDEwMCUpOwogICAgcGFkZGluZzogNXB4IDE1cHggNXB4IDEwcHg7CiAgICBib3JkZXItbGVmdDogMnB4IHNvbGlkIHZhcigtLWZmeC1nb2xkKTsKfQoKLmRpc3RhbmNlLWxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogOHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwp9CgojZ29hbC1kaXN0YW5jZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1nb2xkKTsKfQoKLyogLS0tIFNFVFRJTkdTIEJVVFRPTiAtLS0gKi8KI3NldHRpbmdzLWJ1dHRvbiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCgyNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMTAwcHgpOwogICAgcmlnaHQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogMTEwcHg7CiAgICBwYWRkaW5nOiA4cHggMDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6ICM4ODg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDIwLCAyMCwgMjAsIDAuOCkgMCUsIHJnYmEoMTAsIDEwLCAxMCwgMC45KSAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICB6LWluZGV4OiAxMDA7Cn0KCiNzZXR0aW5ncy1idXR0b246aG92ZXIgewogICAgYmFja2dyb3VuZDogcmdiYSg0MCwgNDAsIDQwLCAwLjkpOwogICAgYm9yZGVyLWNvbG9yOiAjODg4OwogICAgY29sb3I6ICNmZmY7Cn0KCi8qIC0tLSBTRVRUSU5HUyBQQU5FTCAtLS0gKi8KI3NldHRpbmdzLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOwogICAgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMjgwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTYwZGVnLCByZ2JhKDAsIDIwLCA1MCwgMC45OCkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjk5KSAxMDAlKTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgICBib3gtc2hhZG93OiAwIDAgMzBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjQpOwogICAgei1pbmRleDogMzUwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEwcHgpOwp9Cgouc2V0dGluZ3MtaGVhZGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcGFkZGluZzogMTVweDsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyk7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDMwLCA2MCwgMC41KTsKfQoKLnNldHRpbmdzLWhlYWRlciBzcGFuIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMjBweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7Cn0KCiNzZXR0aW5ncy1jbG9zZSB7CiAgICB3aWR0aDogMzBweDsKICAgIGhlaWdodDogMzBweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkICNmZjQ0NDQ7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDUwLCAwLCAwLCAwLjUpOwogICAgY29sb3I6ICNmZjQ0NDQ7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoKI3NldHRpbmdzLWNsb3NlOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6ICNmZjQ0NDQ7CiAgICBjb2xvcjogd2hpdGU7Cn0KCi5zZXR0aW5ncy1jb250ZW50IHsKICAgIHBhZGRpbmc6IDIwcHg7Cn0KCi5zZXR0aW5nLXJvdyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICBwYWRkaW5nOiAxMHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjMpOwogICAgYm9yZGVyLXJhZGl1czogNXB4Owp9Cgouc2V0dGluZy1yb3cgbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjb2xvcjogI2NjYzsKfQoKLnNldHRpbmctcm93IGlucHV0W3R5cGU9InJhbmdlIl0gewogICAgd2lkdGg6IDEwMHB4OwogICAgYWNjZW50LWNvbG9yOiB2YXIoLS1mZngtY3lhbik7Cn0KCi5zZXR0aW5nLXJvdyBpbnB1dFt0eXBlPSJjaGVja2JveCJdIHsKICAgIHdpZHRoOiAyMHB4OwogICAgaGVpZ2h0OiAyMHB4OwogICAgYWNjZW50LWNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBjdXJzb3I6IHBvaW50ZXI7Cn0KCi8qIC0tLSBHTEFSRSBBTklNQVRJT04gLS0tICovCkBrZXlmcmFtZXMgZ2xhcmVQYXNzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0xMDAlKSByb3RhdGUoNDVkZWcpOyB9CiAgICAzMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMTAwJSkgcm90YXRlKDQ1ZGVnKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxMDAlKSByb3RhdGUoNDVkZWcpOyB9Cn0KCi8qIC0tLSBTVEFUVVMgVFlQRSBGTE9BVElORyBURVhUIC0tLSAqLwouZmxvYXRpbmctdGV4dC1pbm5lci5zdGF0dXMgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI4cHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBjb2xvcjogI2ZmMDBmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmYwMGZmLCAycHggMnB4IDAgIzAwMDsKICAgIGFuaW1hdGlvbjogc3RhdHVzUG9wIDEuMnMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCkBrZXlmcmFtZXMgc3RhdHVzUG9wIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjUpIHRyYW5zbGF0ZVkoMCk7IG9wYWNpdHk6IDA7IH0KICAgIDIwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4zKSB0cmFuc2xhdGVZKC0xMHB4KTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKSB0cmFuc2xhdGVZKC00MHB4KTsgb3BhY2l0eTogMDsgfQp9CgovKiAtLS0gR09BTCBUWVBFIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LWlubmVyLmdvYWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQ4cHg7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZiAwJSwgI2ZmZDcwMCA1MCUsICNmZjg4MDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCA0cHggNHB4IHJnYmEoMCwwLDAsMC45KSk7CiAgICBhbmltYXRpb246IGdvYWxQb3AgMXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpIGZvcndhcmRzOwp9CgpAa2V5ZnJhbWVzIGdvYWxQb3AgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDApIHJvdGF0ZSgtMTBkZWcpOyBvcGFjaXR5OiAwOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuNSkgcm90YXRlKDVkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjIpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgovKiAtLS0gREVGQVVMVCBUWVBFIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LWlubmVyLmRlZmF1bHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAycHggNHB4IHJnYmEoMCwwLDAsMC44KTsKICAgIGFuaW1hdGlvbjogZmxvYXRVcCAwLjhzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgovKiAtLS0gTU9CSUxFIFBPUlRSQUlUIE9QVElNSVpBVElPTlMgLS0tICovCkBtZWRpYSBzY3JlZW4gYW5kIChvcmllbnRhdGlvbjogcG9ydHJhaXQpIHsKICAgIC50ZWFtLXdpbmcgeyB3aWR0aDogODBweDsgcGFkZGluZzogMCA1cHg7IH0KICAgIC5zY29yZS1ib3ggeyBmb250LXNpemU6IDI0cHg7IG1hcmdpbjogMCAycHg7IG1pbi13aWR0aDogMjBweDsgfQogICAgLnRlYW0tbmFtZSB7IGZvbnQtc2l6ZTogMTBweDsgbGV0dGVyLXNwYWNpbmc6IDBweDsgfQogICAgLnRlYW0tc3ViIHsgZGlzcGxheTogbm9uZTsgfQogICAgCiAgICAudGltZXItY3J5c3RhbC1yaW5nIHsgd2lkdGg6IDcwcHg7IGhlaWdodDogMzVweDsgdG9wOiAtMTBweDsgfQogICAgI3RpbWVyLWRpc3BsYXkgeyBmb250LXNpemU6IDI0cHg7IH0KICAgICNoYWxmLWluZGljYXRvciB7IGZvbnQtc2l6ZTogMTBweDsgbGV0dGVyLXNwYWNpbmc6IDFweDsgfQogICAgCiAgICAjbWluaW1hcC1jb250YWluZXIgeyB3aWR0aDogODBweDsgaGVpZ2h0OiA4MHB4OyB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA1MHB4KTsgfQogICAgI21pbmltYXAgeyB3aWR0aDogNzBweDsgaGVpZ2h0OiA3MHB4OyB9CiAgICAucmFkYXItbGFiZWwgeyBmb250LXNpemU6IDhweDsgYm90dG9tOiAtMTBweDsgfQogICAgCiAgICAudGVjaC10ZXh0IHsgZm9udC1zaXplOiAyNHB4OyB9CiAgICAKICAgICNhY3Rpb24tYnV0dG9uIHsgd2lkdGg6IDcwcHg7IGhlaWdodDogNzBweDsgfQogICAgI2FjdGlvbi1idXR0b24gLmJ0bi10ZXh0IHsgZm9udC1zaXplOiAxNnB4OyB9CiAgICAuY29tbWFuZC1yaW5nIHsgd2lkdGg6IDkwcHg7IGhlaWdodDogOTBweDsgfQogICAgI2FjdGlvbi1sYWJlbCB7IGZvbnQtc2l6ZTogMTBweDsgcGFkZGluZzogMnB4IDhweDsgbWFyZ2luLWJvdHRvbTogMTBweDsgfQogICAgCiAgICAjcGxheWVyLXN0YXR1cy1wYW5lbCB7IHdpZHRoOiAxMjBweDsgYm90dG9tOiBtYXgoMTIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSArIDEwcHgpOyBsZWZ0OiAxMHB4OyB9CiAgICAuY2hhci1uYW1lIHsgZm9udC1zaXplOiAxMnB4OyB9CiAgICAuaHAtdmFsdWUgeyBmb250LXNpemU6IDhweDsgfQogICAgCiAgICAjYXV0by10b2dnbGUsICNzZXR0aW5ncy1idXR0b24sICNwcmFjdGljZS1yZXN0b3JlLWJ0biB7CiAgICAgICAgd2lkdGg6IDgwcHg7CiAgICAgICAgZm9udC1zaXplOiA4cHg7CiAgICAgICAgcmlnaHQ6IG1heCgxMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICAgICAgcGFkZGluZzogNnB4IDA7CiAgICB9CiAgICAKICAgICNnb2FsLWRpc3RhbmNlLWNvbnRhaW5lciB7IGxlZnQ6IG1heCgxMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQpKTsgdG9wOiBtYXgoNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNDVweCk7IH0KICAgICNnb2FsLWRpc3RhbmNlIHsgZm9udC1zaXplOiAxNnB4OyB9CiAgICAKICAgIC8qIEZpeCBBbm5vdW5jZW1lbnQgVGV4dCBDdXRvZmYgKi8KICAgICNhbm5vdW5jZW1lbnQgewogICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMzJweCwgMTB2dywgNjBweCk7CiAgICAgICAgd2lkdGg6IDk1JTsKICAgICAgICBsZWZ0OiAyLjUlOwogICAgICAgIHdoaXRlLXNwYWNlOiBub3JtYWw7CiAgICAgICAgd29yZC13cmFwOiBicmVhay13b3JkOwogICAgICAgIGxpbmUtaGVpZ2h0OiAxLjE7CiAgICB9CiAgICAuYW5ub3VuY2VtZW50LXNsYW0gewogICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoNDhweCwgMTV2dywgODBweCkgIWltcG9ydGFudDsKICAgICAgICB3aGl0ZS1zcGFjZTogbm9ybWFsICFpbXBvcnRhbnQ7CiAgICB9CgogICAgLyogTWVudSBBZGp1c3RtZW50cyAqLwogICAgLmZmeC1sb2dvLW1haW4geyBmb250LXNpemU6IGNsYW1wKDM2cHgsIDEydncsIDYwcHgpOyBsZXR0ZXItc3BhY2luZzogNHB4OyB9CiAgICAuZmZ4LWxvZ28tc3ViIHsgZm9udC1zaXplOiBjbGFtcCgxMnB4LCA0dncsIDE4cHgpOyBsZXR0ZXItc3BhY2luZzogOHB4OyB9CiAgICAubWVudS1vcHRpb25zIHsgd2lkdGg6IDI2MHB4OyB9CiAgICAubWVudS1pdGVtIHsgcGFkZGluZzogMTBweCAyMHB4OyB9CiAgICAubWVudS1pdGVtIC5sYWJlbCB7IGZvbnQtc2l6ZTogMTZweDsgfQp9Ci8qIC0tLSBHRVNUVVJFIEhJTlQgLS0tICovCiNnZXN0dXJlLWhpbnQgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDIwMHB4OyBoZWlnaHQ6IDMwMHB4OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMjUwMDsKICAgIG9wYWNpdHk6IDAuOTsKfQoKI2dlc3R1cmUtaGludC5hY3RpdmUgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7Cn0KCi5jdXJ2ZS1hcnJvdyB7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA1cHggIzAwZmZmZik7CiAgICBhbmltYXRpb246IGRhc2hEcmF3IDEuNXMgbGluZWFyIGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIGRhc2hEcmF3IHsKICAgIHRvIHsgc3Ryb2tlLWRhc2hvZmZzZXQ6IC0zMDsgfQp9CgouZ2VzdHVyZS10ZXh0IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKICAgIG1hcmdpbi10b3A6IC01MHB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCi5nZXN0dXJlLWhhbmQgewogICAgZm9udC1zaXplOiA0OHB4OwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAyMHB4OwogICAgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgYW5pbWF0aW9uOiBoYW5kU3dpcGUgMS41cyBlYXNlLWluLW91dCBpbmZpbml0ZTsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggYmxhY2spOwp9CgpAa2V5ZnJhbWVzIGhhbmRTd2lwZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIDUwcHgpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgb3BhY2l0eTogMTsgfQogICAgODAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMjBweCwgLTEwMHB4KSByb3RhdGUoMjBkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMHB4LCAtMTIwcHgpIHJvdGF0ZSgxMGRlZyk7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIFNXSVBFIFRSQUlMIChJTlRVSVRJVkUgRkVFREJBQ0spIC0tLSAqLwouc3dpcGUtdHJhaWwtZG90IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxMnB4OwogICAgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgIzAwZmZmZiAwJSwgcmdiYSgwLCAyNTUsIDI1NSwgMCkgNzAlKTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogOTAwMDsKICAgIGFuaW1hdGlvbjogZmFkZVRyYWlsIDAuNXMgbGluZWFyIGZvcndhcmRzOwogICAgbWl4LWJsZW5kLW1vZGU6IHNjcmVlbjsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm0sIG9wYWNpdHk7Cn0KCkBrZXlmcmFtZXMgZmFkZVRyYWlsIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC4yKTsgb3BhY2l0eTogMDsgfQp9CkBrZXlmcmFtZXMgZmFkZVRyYWlsIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC4yKTsgb3BhY2l0eTogMDsgfQp9CgovKiAtLS0gT0ZGU0NSRUVOIElORElDQVRPUiAtLS0gKi8KI29mZnNjcmVlbi1pbmRpY2F0b3IgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDQwcHg7IGhlaWdodDogNDBweDsKICAgIG1hcmdpbi1sZWZ0OiAtMjBweDsgbWFyZ2luLXRvcDogLTIwcHg7CiAgICB6LWluZGV4OiAxNTAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgNXB4ICMwMDApOwp9Cgojb2Zmc2NyZWVuLWluZGljYXRvciAuYXJyb3cgewogICAgd2lkdGg6IDA7IGhlaWdodDogMDsKICAgIGJvcmRlci1sZWZ0OiAxNXB4IHNvbGlkIHRyYW5zcGFyZW50OwogICAgYm9yZGVyLXJpZ2h0OiAxNXB4IHNvbGlkIHRyYW5zcGFyZW50OwogICAgYm9yZGVyLWJvdHRvbTogMjVweCBzb2xpZCAjMDBmZjAwOyAvKiBHcmVlbiBmb3IgcGxheWVyICovCiAgICBhbmltYXRpb246IHB1bHNlQXJyb3cgMC41cyBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICB0cmFuc2Zvcm0tb3JpZ2luOiBjZW50ZXIgYm90dG9tOwp9CgpAa2V5ZnJhbWVzIHB1bHNlQXJyb3cgewogICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IGZpbHRlcjogYnJpZ2h0bmVzcygxKTsgfQogICAgdG8geyB0cmFuc2Zvcm06IHNjYWxlKDEuMik7IGZpbHRlcjogYnJpZ2h0bmVzcygxLjUpOyB9Cn0=","/style.css":"data:text/css;base64,OnJvb3QgewogICAgLS1mZngtYmx1ZS1kZWVwOiAjMDIwNDA4OwogICAgLS1mZngtYmx1ZS1kYXJrOiAjMGExNTI1OwogICAgLS1mZngtYmx1ZS1taWQ6ICMxNTJhNDU7CiAgICAtLWZmeC1ibHVlLWxpZ2h0OiAjMmE0ZDc1OwogICAgLS1mZngtY3lhbjogIzYwYzBkMDsKICAgIC0tZmZ4LWN5YW4tZ2xvdzogIzAwZmZmZjsKICAgIC0tZmZ4LWdvbGQ6ICNjOGIwNjA7CiAgICAtLWZmeC1nb2xkLWxpZ2h0OiAjZjBlMDkwOwogICAgLS1mZngtZ29sZC1kYXJrOiAjOGE3MDMwOwogICAgLS1mZngtZ2xhc3MtYmc6IHJnYmEoMTAsIDIwLCA0MCwgMC43NSk7CiAgICAtLWZmeC1nbGFzcy1ib3JkZXI6IHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIAogICAgLS1mb250LXRpdGxlOiAnR2FyYW1vbmQnLCAnVGltZXMgTmV3IFJvbWFuJywgc2VyaWY7CiAgICAtLWZvbnQtZGF0YTogJ0ltcGFjdCcsICdBcmlhbCBOYXJyb3cnLCBzYW5zLXNlcmlmOwogICAgLS1mb250LXVpOiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAtLWZvbnQtc3BpcmE6ICdTcGlyYScsICdJbXBhY3QnLCBzYW5zLXNlcmlmOwp9CgpAZm9udC1mYWNlIHsKICAgIGZvbnQtZmFtaWx5OiAnU3BpcmEnOwogICAgc3JjOiB1cmwoJ2h0dHBzOi8vZmlsZXMuY2F0Ym94Lm1vZS96eW43czMudHRmJykgZm9ybWF0KCd0cnVldHlwZScpOwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgIGZvbnQtc3R5bGU6IG5vcm1hbDsKfQoKaHRtbCwgYm9keSB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB3aWR0aDogMTAwdnc7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBwb3NpdGlvbjogZml4ZWQ7IAogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHJpZ2h0OiAwOwogICAgYm90dG9tOiAwOwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBjb2xvcjogd2hpdGU7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICBwYWRkaW5nLXRvcDogZW52KHNhZmUtYXJlYS1pbnNldC10b3ApOwogICAgcGFkZGluZy1ib3R0b206IGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKTsKICAgIHBhZGRpbmctbGVmdDogZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KTsKICAgIHBhZGRpbmctcmlnaHQ6IGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpOwp9CgoqIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7Cn0KCi8qIC0tLSBNQUlOIEdBTUUgQ09OVEFJTkVSIC0tLSAqLwojZ2FtZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgbWF4LXdpZHRoOiBub25lOwogICAgYmFja2dyb3VuZDogIzAwMDUxMDsKICAgIGJveC1zaGFkb3c6IG5vbmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgdHJhbnNpdGlvbjogZmlsdGVyIDAuMDVzOwogICAgei1pbmRleDogMTsKICAgIGNvbnRhaW46IHN0cmljdDsKfQoKLyogLS0tIElNUEFDVCBGWCAtLS0gKi8KI2dhbWUtY29udGFpbmVyLmltcGFjdC1meCB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuMXMgZWFzZS1pbi1vdXQ7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDEuMikgYnJpZ2h0bmVzcygxLjEpOwp9CgojZ2FtZS1jb250YWluZXIuaW1wYWN0LWhlYXZ5IHsKICAgIGFuaW1hdGlvbjogaW1wYWN0U2hha2UgMC4ycyBlYXNlLWluLW91dDsKICAgIGZpbHRlcjogY29udHJhc3QoMS41KSBicmlnaHRuZXNzKDEuMykgc2VwaWEoMC40KSBodWUtcm90YXRlKC0xMGRlZyk7Cn0KCiNnYW1lLWNvbnRhaW5lci5pbXBhY3Qtc2hhdHRlciB7CiAgICBhbmltYXRpb246IGltcGFjdFNoYWtlIDAuNHMgZWFzZS1pbi1vdXQ7CiAgICBmaWx0ZXI6IGNvbnRyYXN0KDIuMCkgaW52ZXJ0KDAuMSkgc2F0dXJhdGUoMi4wKTsKfQoKQGtleWZyYW1lcyBpbXBhY3RTaGFrZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDAsIDApOyB9CiAgICAyNSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNXB4LCA1cHgpOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSg1cHgsIC01cHgpOyB9CiAgICA3NSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNXB4LCAtNXB4KTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDAsIDApOyB9Cn0KCi8qIC0tLSBDQU5WQVMgJiBSRU5ERVIgLS0tICovCmNhbnZhcyB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsKICAgIGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGltYWdlLXJlbmRlcmluZzogcGl4ZWxhdGVkOyAKICAgIHotaW5kZXg6IDA7Cn0KCi8qIC0tLSBHSUYgT1ZFUkxBWSAtLS0gKi8KI3NjcmVlbi1vdmVybGF5LWdpZiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgb2JqZWN0LWZpdDogY292ZXI7CiAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKICAgIG9wYWNpdHk6IDEuMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogOTUwOwogICAgaW1hZ2UtcmVuZGVyaW5nOiBwaXhlbGF0ZWQ7Cn0KCiN1aS1sYXllciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgei1pbmRleDogMTAwMDsKICAgIGNvbnRhaW46IHN0cmljdDsKfQoKLyogLS0tIENJTkVNQVRJQyBCQVJTIC0tLSAqLwojY2luZW1hdGljLWJhcnMgLmJhciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAwOwogICAgYmFja2dyb3VuZDogYmxhY2s7CiAgICB0cmFuc2l0aW9uOiBoZWlnaHQgMC41cyBlYXNlOwogICAgei1pbmRleDogODAwOwp9CiNjaW5lbWF0aWMtYmFycyAuYmFyLnRvcCB7IHRvcDogMDsgfQojY2luZW1hdGljLWJhcnMgLmJhci5ib3R0b20geyBib3R0b206IDA7IH0KCi8qIC0tLSBURUNIIEZMQVNIIE9WRVJMQVkgLS0tICovCiN0ZWNoLWZsYXNoLW92ZXJsYXkgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAyMCU7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEyMHB4OwogICAgZGlzcGxheTogbm9uZTsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwwLDAsMCkgMCUsIHJnYmEoMCwgMjAsIDYwLCAwLjkpIDIwJSwgcmdiYSgwLCAyMCwgNjAsIDAuOSkgODAlLCByZ2JhKDAsMCwwLDApIDEwMCUpOwogICAgei1pbmRleDogMjIwMDsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigycHgpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMTAwLCAyNTUsIDI1NSwgMC4zKTsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDEwMCwgMjU1LCAyNTUsIDAuMyk7CiAgICBhbmltYXRpb246IGZsYXNoRW50ZXIgMC4xNXMgZWFzZS1vdXQ7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBvcGFjaXR5Owp9CgpAa2V5ZnJhbWVzIGZsYXNoRW50ZXIgewogICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGVZKDApOyBvcGFjaXR5OiAwOyB9CiAgICB0byB7IHRyYW5zZm9ybTogc2NhbGVZKDEpOyBvcGFjaXR5OiAxOyB9Cn0KCi50ZWNoLWNvbnRlbnQtd3JhcHBlciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7Cn0KCi50ZWNoLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiBjbGFtcCgyOHB4LCAxMHZ3LCA0MnB4KTsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4ICMwMGZmZmYsIDAgMCAyMHB4ICMwMDAwZmY7CiAgICBsZXR0ZXItc3BhY2luZzogM3B4OwogICAgbWFyZ2luLWJvdHRvbTogMnB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgYW5pbWF0aW9uOiBibGlua1RleHQgMC4wOHMgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgoudGVjaC1zdWItdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC11aSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjb2xvcjogIzAwZmZmZjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgbWFyZ2luLWJvdHRvbTogOHB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggcmdiYSgwLCAyNTUsIDI1NSwgMC41KTsKfQoKLnRlY2gtdGltZXItdHJhY2sgewogICAgd2lkdGg6IDI1MHB4OwogICAgaGVpZ2h0OiA4cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuNik7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ0OwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMCwwLDAsMC41KTsKfQoKLnRlY2gtdGltZXItZmlsbCB7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZmZmZmYsICMwMGZmZmYpOwogICAgd2lkdGg6IDEwMCU7CiAgICB0cmFuc2Zvcm0tb3JpZ2luOiBsZWZ0OwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKfQoKQGtleWZyYW1lcyBibGlua1RleHQgewogICAgZnJvbSB7IG9wYWNpdHk6IDAuODsgdGV4dC1zaGFkb3c6IDAgMCA1cHggIzAwZmZmZjsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgfQogICAgdG8geyBvcGFjaXR5OiAxLjA7IHRleHQtc2hhZG93OiAwIDAgMjBweCAjZmZmZmZmLCAwIDAgMTBweCAjMDBmZmZmOyB0cmFuc2Zvcm06IHNjYWxlKDEuMDIpOyB9Cn0KCi8qIC0tLSBIVUQgVE9QIC0tLSAqLwovKiAtLS0gSFVEIFRPUCAtLS0gKi8KI2h1ZC10b3AgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogZmxleC1zdGFydDsKICAgIHdpZHRoOiAxMDAlOwogICAgcGFkZGluZzogMTVweDsKICAgIHBhZGRpbmctdG9wOiBtYXgoMTVweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApKTsKICAgIHBhZGRpbmctbGVmdDogbWF4KDE1cHgsIGVudihzYWZlLWFyZWEtaW5zZXQtbGVmdCkpOwogICAgcGFkZGluZy1yaWdodDogbWF4KDE1cHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCByZ2JhKDAsIDUsIDE1LCAwLjkpIDAlLCByZ2JhKDAsMCwwLDApIDEwMCUpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuNXM7Cn0KCi50ZWFtLXdpbmcgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB3aWR0aDogMTQwcHg7CiAgICBoZWlnaHQ6IDU1cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTYwZGVnLCByZ2JhKDIwLCA0MCwgODAsIDAuOSkgMCUsIHJnYmEoNSwgMTAsIDIwLCAwLjk1KSAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKTsKICAgIGJvcmRlci10b3A6IDJweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xNWRlZyk7CiAgICBib3gtc2hhZG93OiAwIDVweCAxNXB4IHJnYmEoMCwgMCwgMCwgMC41KSwgaW5zZXQgMCAwIDIwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC4xKTsKICAgIHBhZGRpbmc6IDAgMTVweDsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig0cHgpOwp9CgoudGVhbS13aW5nOjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHJnYmEoMjU1LDI1NSwyNTUsMC4xKSwgdHJhbnNwYXJlbnQpOwogICAgYW5pbWF0aW9uOiB3aW5nU2hpbW1lciA0cyBpbmZpbml0ZTsKfQoKQGtleWZyYW1lcyB3aW5nU2hpbW1lciB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtMTAwJSk7IH0KICAgIDIwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxMDAlKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxMDAlKTsgfQp9CgoudGVhbS13aW5nLmF3YXkgewogICAgdHJhbnNmb3JtOiBza2V3WCgxNWRlZyk7CiAgICBmbGV4LWRpcmVjdGlvbjogcm93LXJldmVyc2U7CiAgICBib3JkZXItdG9wLWNvbG9yOiAjZmY2NjY2OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KC0xNjBkZWcsIHJnYmEoNjAsIDIwLCAyMCwgMC45KSAwJSwgcmdiYSgyMCwgNSwgNSwgMC45NSkgMTAwJSk7Cn0KCi50ZWFtLWRhdGEgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpOwogICAgZmxleC1ncm93OiAxOwp9Ci50ZWFtLXdpbmcuYXdheSAudGVhbS1kYXRhIHsgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpOyB0ZXh0LWFsaWduOiByaWdodDsgfQoKLnRlYW0tbmFtZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDE2cHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgdGV4dC1zaGFkb3c6IDAgMCA1cHggcmdiYSgwLCAxNTAsIDI1NSwgMC44KTsKfQoudGVhbS1zdWIgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgb3BhY2l0eTogMC44OwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKfQoudGVhbS13aW5nLmF3YXkgLnRlYW0tc3ViIHsgY29sb3I6ICNmZmFhYWE7IH0KCi5zY29yZS1ib3ggewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDE1cHggdmFyKC0tZmZ4LWN5YW4tZ2xvdyk7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDE1ZGVnKTsKICAgIG1hcmdpbjogMCA1cHg7CiAgICBtaW4td2lkdGg6IDMwcHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KLnRlYW0td2luZy5hd2F5IC5zY29yZS1ib3ggeyB0cmFuc2Zvcm06IHNrZXdYKC0xNWRlZyk7IHRleHQtc2hhZG93OiAwIDAgMTVweCAjZmY0NDQ0OyB9CgoudGltZXItY29tcGxleCB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBtYXJnaW4tdG9wOiAtNXB4Owp9CgoudGltZXItY3J5c3RhbC1yaW5nIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTMwcHg7CiAgICB3aWR0aDogMTQwcHg7CiAgICBoZWlnaHQ6IDcwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXItdG9wOiAzcHggc29saWQgdmFyKC0tZmZ4LWdvbGQpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHRyYW5zcGFyZW50OwogICAgYm94LXNoYWRvdzogMCAtNXB4IDIwcHggcmdiYSgyMDAsIDE4MCwgMTAwLCAwLjQpLCBpbnNldCAwIDEwcHggMjBweCByZ2JhKDAsMCwwLDAuNSk7CiAgICB6LWluZGV4OiAtMTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChlbGxpcHNlIGF0IHRvcCwgcmdiYSgyMCwgNDAsIDgwLCAwLjkpLCB0cmFuc3BhcmVudCA3MCUpOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7Cn0KCiNoYWxmLWluZGljYXRvciB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDEycHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDRweDsKICAgIG1hcmdpbi1ib3R0b206IC00cHg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtZ29sZC1kYXJrKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KCiN0aW1lci1kaXNwbGF5IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiA0OHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZiAwJSwgI2ZmZDcwMCA1MCUsICNiODg2MGIgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAycHggMHB4IHJnYmEoMCwwLDAsMC44KSk7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4Owp9Ci8qIC0tLSBQTEFZRVIgU1RBVFVTIFBBTkVMIC0tLSAqLwojcGxheWVyLXN0YXR1cy1wYW5lbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCgxNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pICsgNDBweCk7CiAgICBsZWZ0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KSk7CiAgICB3aWR0aDogMTYwcHg7CiAgICBwYWRkaW5nOiAxMHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDEwLCAzMCwgMC44KSAwJSwgcmdiYSgwLDAsMCwwKSAxMDAlKTsKICAgIGJvcmRlci1sZWZ0OiAzcHggc29saWQgdmFyKC0tZmZ4LWN5YW4pOwogICAgYm9yZGVyLXJhZGl1czogMCAxMHB4IDEwcHggMDsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig0cHgpOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwp9CgouY2hhci1uYW1lIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMThweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBtYXJnaW4tYm90dG9tOiA1cHg7CiAgICB0cmFuc2Zvcm06IHNrZXdYKDEwZGVnKTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1ibHVlLWxpZ2h0KTsKfQoKLmhwLWdhdWdlLWNvbnRhaW5lciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG1hcmdpbi1ib3R0b206IDRweDsKICAgIHRyYW5zZm9ybTogc2tld1goMTBkZWcpOwp9Ci5ocC1sYWJlbCB7IGZvbnQtc2l6ZTogMTBweDsgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsgd2lkdGg6IDIwcHg7IH0KLmhwLWJhci10cmFjayB7CiAgICBmbGV4LWdyb3c6IDE7CiAgICBoZWlnaHQ6IDZweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC41KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBtYXJnaW46IDAgNXB4Owp9Ci5ocC1iYXItZmlsbCB7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwMGZmMDAsICNjY2ZmY2MpOwogICAgYm94LXNoYWRvdzogMCAwIDVweCAjMDBmZjAwOwp9Ci5ocC12YWx1ZSB7IGZvbnQtc2l6ZTogMTBweDsgY29sb3I6ICNmZmY7IHdpZHRoOiA0NXB4OyB0ZXh0LWFsaWduOiByaWdodDsgfQoKLnRlY2gtZ2F1Z2UtY29udGFpbmVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgdHJhbnNmb3JtOiBza2V3WCgxMGRlZyk7Cn0KLnRlY2gtbGFiZWwgeyBmb250LXNpemU6IDEwcHg7IGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7IHdpZHRoOiAyMHB4OyB9Ci50ZWNoLWJhci10cmFjayB7CiAgICBmbGV4LWdyb3c6IDE7CiAgICBoZWlnaHQ6IDRweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC41KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBtYXJnaW46IDAgNXB4Owp9Ci50ZWNoLWJhci1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmYWEwMCwgI2ZmZmZhYSk7Cn0KCi8qIC0tLSBNSU5JTUFQIC0tLSAqLwojbWluaW1hcC1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoODBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNjBweCk7CiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiAxMTBweDsKICAgIGhlaWdodDogMTEwcHg7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgoucmFkYXItcmltIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDJweCBzb2xpZCB2YXIoLS1mZngtYmx1ZS1saWdodCk7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCB2YXIoLS1mZngtYmx1ZS1taWQpLCBpbnNldCAwIDAgMjBweCByZ2JhKDAsMCwwLDAuOCk7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCByZ2JhKDAsIDIwLCA2MCwgMC40KSAwJSwgcmdiYSgwLCA1LCAxMCwgMC44KSAxMDAlKTsKICAgIHotaW5kZXg6IDU7Cn0KCiNtaW5pbWFwIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIHdpZHRoOiAxMDBweDsKICAgIGhlaWdodDogMTAwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB6LWluZGV4OiA2OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKLnJhZGFyLWxhYmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogLTE1cHg7CiAgICB3aWR0aDogMTQwJTsKICAgIGxlZnQ6IC0yMCU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKfQoKLm1hcC1kb3QgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgd2lkdGg6IDZweDsgaGVpZ2h0OiA2cHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGJveC1zaGFkb3c6IDAgMCA0cHggY3VycmVudENvbG9yOwp9Ci5tYXAtZG90LmhvbWUgeyBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtY3lhbik7IGNvbG9yOiB2YXIoLS1mZngtY3lhbik7IH0KLm1hcC1kb3QuYXdheSB7IGJhY2tncm91bmQ6ICNmZjQ0NDQ7IGNvbG9yOiAjZmY0NDQ0OyB9Ci5tYXAtZG90LmJhbGwgeyAKICAgIGJhY2tncm91bmQ6ICNmZjAwY2M7CiAgICBjb2xvcjogI2ZmMDBjYzsgCiAgICB3aWR0aDogMTJweDsgaGVpZ2h0OiAxMnB4OwogICAgYm9yZGVyOiAycHggc29saWQgI2ZmZmZmZjsKICAgIHotaW5kZXg6IDIwOwogICAgYW5pbWF0aW9uOiBibGlua0JhbGwgMC4zcyBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICBib3gtc2hhZG93OiAwIDAgNnB4ICNmZjAwY2M7Cn0KLm1hcC1kb3QubmFwIHsgYmFja2dyb3VuZDogIzMzMzsgY29sb3I6ICMwMDA7IGJvcmRlcjogMXB4IHNvbGlkICM1NTU7IH0KLm1hcC1kb3QuYWN0aXZlLXBsYXllciB7IAogICAgYmFja2dyb3VuZDogIzAwZmYwMCAhaW1wb3J0YW50OyAKICAgIGNvbG9yOiAjMDBmZjAwICFpbXBvcnRhbnQ7IAogICAgYm94LXNoYWRvdzogMCAwIDhweCAjMDBmZjAwOwogICAgei1pbmRleDogMTU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjIpOwp9Ci5tYXAtZG90LmJhbGwtY2FycmllciB7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCAjZmZmLCAwIDAgMzBweCAjZmZhYTAwOwogICAgYm9yZGVyOiAycHggc29saWQgI2ZmZmZmZjsKICAgIGJhY2tncm91bmQtY29sb3I6ICNmZmFhMDAgIWltcG9ydGFudDsKICAgIHotaW5kZXg6IDEwMDsKICAgIHdpZHRoOiAxMHB4OyBoZWlnaHQ6IDEwcHg7CiAgICBhbmltYXRpb246IGNhcnJpZXJQdWxzZSAwLjhzIGluZmluaXRlIGFsdGVybmF0ZTsKfQpAa2V5ZnJhbWVzIGNhcnJpZXJQdWxzZSB7CiAgICBmcm9tIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4yKTsgYm94LXNoYWRvdzogMCAwIDEwcHggI2ZmZjsgb3BhY2l0eTogMC44OyB9CiAgICB0byB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuOCk7IGJveC1zaGFkb3c6IDAgMCAyNXB4ICNmZmNjMDA7IG9wYWNpdHk6IDEuMDsgfQp9CkBrZXlmcmFtZXMgYmxpbmtCYWxsIHsgZnJvbSB7IG9wYWNpdHk6IDE7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyB9IHRvIHsgb3BhY2l0eTogMC41OyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjMpOyB9IH0KCi8qIC0tLSBBTk5PVU5DRU1FTlRTIC0tLSAqLwojYW5ub3VuY2VtZW50IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNDAlOyAKICAgIGxlZnQ6IDUlOyAKICAgIHdpZHRoOiA5MCU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoNDBweCwgMTJ2dywgNzJweCk7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBsaW5lLWhlaWdodDogMS4wOwogICAgd2hpdGUtc3BhY2U6IG5vcm1hbDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmYgMCUsICNmZmQ3MDAgNDAlLCAjYjg4NjBiIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuNSkpIGRyb3Atc2hhZG93KDNweCAzcHggMCAjMDAwKTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAyMDAwOwogICAgYW5pbWF0aW9uOiBhbm5vdW5jZVNsaWRlIDAuNXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtLCBvcGFjaXR5Owp9CgpAa2V5ZnJhbWVzIGFubm91bmNlU2xpZGUgewogICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGUoMCkgcm90YXRlKC01ZGVnKTsgb3BhY2l0eTogMDsgfQogICAgdG8geyB0cmFuc2Zvcm06IHNjYWxlKDEpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMTsgfQp9CgovKiAtLS0gSk9ZU1RJQ0sgLS0tICovCiNqb3lzdGljay1oaXQtem9uZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogNTAlOyBoZWlnaHQ6IDUwJTsKICAgIHotaW5kZXg6IDEwMDA7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDApOyAKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9Cgojam95c3RpY2stdmlzdWFsLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMDsgaGVpZ2h0OiAwOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAxMTAwOwp9Cgojam95c3RpY2stYmFzZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMTIwcHg7IGhlaWdodDogMTIwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCByZ2JhKDAsIDQwLCA4MCwgMC40KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuMSkgNjAlLCB0cmFuc3BhcmVudCAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMTAwLCAyMjAsIDI1NSwgMC4zKTsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMiksIGluc2V0IDAgMCAzMHB4IHJnYmEoMCwgNTAsIDEwMCwgMC4zKTsKICAgIGFuaW1hdGlvbjogYmFzZVB1bHNlIDJzIGluZmluaXRlIGFsdGVybmF0ZTsKfQoKQGtleWZyYW1lcyBiYXNlUHVsc2UgewogICAgZnJvbSB7IGJveC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMik7IGJvcmRlci1jb2xvcjogcmdiYSgxMDAsIDIyMCwgMjU1LCAwLjIpOyB9CiAgICB0byB7IGJveC1zaGFkb3c6IDAgMCAyNXB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuNSk7IGJvcmRlci1jb2xvcjogcmdiYSgxMDAsIDI1NSwgMjU1LCAwLjYpOyB9Cn0KCiNqb3lzdGljay1rbm9iIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiA1MHB4OyBoZWlnaHQ6IDUwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsICNlMGZmZmYgMCUsICMwMGFhZmYgNDAlLCAjMDA0NDg4IDgwJSwgIzAwMTEyMiAxMDAlKTsKICAgIGJvcmRlcjogMnB4IHNvbGlkICM4OGNjZmY7CiAgICBib3gtc2hhZG93OiAwIDAgMTVweCAjMDBmZmZmLCBpbnNldCAwIDAgMTBweCByZ2JhKDI1NSwyNTUsMjU1LDAuOCk7CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4wNXMgbGluZWFyOwogICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybTsKfQoKI2pveXN0aWNrLWtub2I6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICIiOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAyMCU7IGxlZnQ6IDIwJTsgd2lkdGg6IDIwJTsgaGVpZ2h0OiAyMCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAjZmZmZmZmIDAlLCB0cmFuc3BhcmVudCA3MCUpOwogICAgZmlsdGVyOiBibHVyKDJweCk7CiAgICBvcGFjaXR5OiAwLjg7Cn0KCi50b3VjaC1yaXBwbGUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgyMDAsIDI1NSwgMjU1LCAwLjgpIDAlLCByZ2JhKDAsIDI1NSwgMjU1LCAwLjQpIDQwJSwgdHJhbnNwYXJlbnQgNzAlKTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDApOwogICAgYW5pbWF0aW9uOiByaXBwbGVBbmltIDAuNnMgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDkwMDA7CiAgICBtaXgtYmxlbmQtbW9kZTogc2NyZWVuOwogICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybSwgb3BhY2l0eTsKfQoKQGtleWZyYW1lcyByaXBwbGVBbmltIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMCk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgzLjApOyBvcGFjaXR5OiAwOyB9Cn0KCiNjYW1lcmEtem9uZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IHJpZ2h0OiAwOyB3aWR0aDogNTAlOyBoZWlnaHQ6IDEwMCU7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHotaW5kZXg6IDUwOwp9CgovKiAtLS0gQUNUSU9OIEJVVFRPTiAtLS0gKi8KI2FjdGlvbi1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiBtYXgoNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pKTsgCiAgICByaWdodDogbWF4KDQwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgei1pbmRleDogMTAwOwp9CgouY29tbWFuZC1tZW51LWJnIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxODBweDsgaGVpZ2h0OiA4MHB4OwogICAgYm90dG9tOiAxNXB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCAwJSwgcmdiYSgwLCAxMCwgMzAsIDAuOCkgNTAlLCB0cmFuc3BhcmVudCAxMDAlKTsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDAsIDIwMCwgMjU1LCAwLjMpOwogICAgei1pbmRleDogLTE7Cn0KCi5jb21tYW5kLXJpbmcgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDEzMHB4OyBoZWlnaHQ6IDEzMHB4OwogICAgYm9yZGVyOiAycHggc29saWQgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjEpOwogICAgYm9yZGVyLXRvcDogMnB4IHNvbGlkIHJnYmEoMCwgMjU1LCAyNTUsIDAuNik7CiAgICBib3JkZXItYm90dG9tOiAycHggc29saWQgcmdiYSgwLCAyNTUsIDI1NSwgMC42KTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGFuaW1hdGlvbjogc3BpblJldmVyc2UgMTVzIGxpbmVhciBpbmZpbml0ZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLCAxMDAsIDI1NSwgMC4yKTsKfQpAa2V5ZnJhbWVzIHNwaW5SZXZlcnNlIHsgZnJvbSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHJvdGF0ZSgzNjBkZWcpOyB9IHRvIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgcm90YXRlKDBkZWcpOyB9IH0KCiNhY3Rpb24tbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNSwgMTAsIDAuOCk7CiAgICBwYWRkaW5nOiA0cHggMTJweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZmeC1ibHVlLWxpZ2h0KTsKICAgIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCByZ2JhKDAsMCwwLDAuOCk7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4zczsKfQoKI2FjdGlvbi1idXR0b24gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDEwMHB4OyBoZWlnaHQ6IDEwMHB4OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMXMsIGZpbHRlciAwLjNzOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmZmZmZmIDAlLCAjMDA4OGZmIDQwJSwgIzAwMjI2NiA4MCUsICMwMDAgMTAwJSk7CiAgICBib3JkZXI6IDNweCBzb2xpZCAjNDRhYWZmOwogICAgYm94LXNoYWRvdzogMCAwIDIwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC44KSwgaW5zZXQgMCAwIDIwcHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjQpOwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG92ZXJmbG93OiB2aXNpYmxlOwogICAgei1pbmRleDogMTA7Cn0KCiNwYXNzLWJ1dHRvbiB7CiAgICBkaXNwbGF5OiBub25lICFpbXBvcnRhbnQ7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IC0yMHB4OyBsZWZ0OiAtMzBweDsKICAgIHdpZHRoOiA2MHB4OyBoZWlnaHQ6IDYwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB6LWluZGV4OiA5Owp9CgojYWN0aW9uLWJ1dHRvbjo6YmVmb3JlIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAtNDBweDsgbGVmdDogLTQwcHg7IHJpZ2h0OiAtNDBweDsgYm90dG9tOiAtNDBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHotaW5kZXg6IDEwOwp9CgojYWN0aW9uLWJ1dHRvbjphY3RpdmUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuOTIpOyB9CgojYWN0aW9uLWJ1dHRvbiAuYnRuLXRleHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAyMnB4OwogICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAycHggNHB4IHJnYmEoMCwwLDAsMC44KSwgMCAwIDEwcHggcmdiYSgyNTUsMjU1LDI1NSwwLjUpOwogICAgei1pbmRleDogNTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKI2FjdGlvbi1idXR0b24gLmJ0bi1nbGFyZSB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01MCU7IGxlZnQ6IC01MCU7IHdpZHRoOiAyMDAlOyBoZWlnaHQ6IDIwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoNDVkZWcsIHRyYW5zcGFyZW50IDQwJSwgcmdiYSgyNTUsMjU1LDI1NSwwLjQpIDUwJSwgdHJhbnNwYXJlbnQgNjAlKTsKICAgIGFuaW1hdGlvbjogZ2xhcmVQYXNzIDVzIGluZmluaXRlOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiA2OwogICAgYm9yZGVyLXJhZGl1czogNTAlOwp9CgoubGltaXQtcmluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IC01cHg7IGxlZnQ6IC01cHg7IHJpZ2h0OiAtNXB4OyBib3R0b206IC01cHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXI6IDJweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgIGJveC1zaGFkb3c6IDAgMCAwIHRyYW5zcGFyZW50OwogICAgdHJhbnNpdGlvbjogYWxsIDAuNXM7CiAgICB6LWluZGV4OiAxOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7Cn0KCiNhY3Rpb24tYnV0dG9uLnNob290LW1vZGUgewogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmZmZmFhIDAlLCAjZmZhYTAwIDQwJSwgIzg4MjIwMCA4MCUsICMyMjAwMDAgMTAwJSk7CiAgICBib3JkZXItY29sb3I6ICNmZmNjMDA7CiAgICBib3gtc2hhZG93OiAwIDAgMzBweCByZ2JhKDI1NSwgMTAwLCAwLCAwLjgpLCBpbnNldCAwIDAgMjBweCByZ2JhKDI1NSwgMjU1LCAwLCAwLjUpOwp9CgojYWN0aW9uLWJ1dHRvbi5saW1pdC1yZWFkeSAubGltaXQtcmluZyB7CiAgICBib3JkZXItY29sb3I6ICNmZmRkNDQ7CiAgICBhbmltYXRpb246IGxpbWl0UHVsc2UgMC44cyBlYXNlLWluLW91dCBpbmZpbml0ZSBhbHRlcm5hdGU7Cn0KCi5zaG9vdC1sYWJlbCB7CiAgICBjb2xvcjogI2ZmZGQ0NCAhaW1wb3J0YW50OwogICAgYm9yZGVyLWNvbG9yOiAjZmZhYTAwICFpbXBvcnRhbnQ7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggI2ZmNDQwMCAhaW1wb3J0YW50Owp9CgpAa2V5ZnJhbWVzIGxpbWl0UHVsc2UgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7IGJveC1zaGFkb3c6IDAgMCAxMHB4ICNmZmFhMDAsIGluc2V0IDAgMCA1cHggI2ZmYWEwMDsgb3BhY2l0eTogMC41OyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjE1KTsgYm94LXNoYWRvdzogMCAwIDMwcHggI2ZmNDQwMCwgaW5zZXQgMCAwIDE1cHggI2ZmMDAwMDsgb3BhY2l0eTogMS4wOyB9Cn0KCi8qIC0tLSBBVVRPIFRPR0dMRSAtLS0gKi8KI2F1dG8tdG9nZ2xlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDIwMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA2MHB4KTsgCiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHdpZHRoOiAxMTBweDsKICAgIHBhZGRpbmc6IDEwcHggMDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMCwgMjAsIDQwLCAwLjgpIDAlLCByZ2JhKDAsIDUsIDEwLCAwLjkpIDEwMCUpOwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZmZ4LWJsdWUtbGlnaHQpOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4OwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7CiAgICBib3gtc2hhZG93OiAwIDVweCAxNXB4IHJnYmEoMCwwLDAsMC4zKTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICB6LWluZGV4OiAxMDA7Cn0KCiNhdXRvLXRvZ2dsZTpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDQwLCA4MCwgMC45KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHZhcigtLWZmeC1jeWFuKTsKICAgIGNvbG9yOiB3aGl0ZTsKfQoKI2F1dG8tdG9nZ2xlLmFjdGl2ZSB7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDEwMCwgMjAsIDAsIDAuOCkgMCUsIHJnYmEoNDAsIDAsIDAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXItY29sb3I6ICNmZjQ0MDA7CiAgICBjb2xvcjogI2ZmYWEwMDsKICAgIGFuaW1hdGlvbjogcHVsc2VSZWQgMnMgaW5maW5pdGU7Cn0KQGtleWZyYW1lcyBwdWxzZVJlZCB7IDAlIHsgYm94LXNoYWRvdzogMCAwIDVweCAjZmYwMDAwOyB9IDUwJSB7IGJveC1zaGFkb3c6IDAgMCAyMHB4ICNmZjQ0MDA7IH0gMTAwJSB7IGJveC1zaGFkb3c6IDAgMCA1cHggI2ZmMDAwMDsgfSB9CgovKiAtLS0gRkxPQVRJTkcgVEVYVCAtLS0gKi8KLmZsb2F0aW5nLXRleHQtd3JhcHBlciB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDIwMDA7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtOwogICAgY29udGFpbjogbGF5b3V0IHN0eWxlOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lciB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgZm9udC1zaXplOiAyNHB4OyAKICAgIHRleHQtc2hhZG93OiAxcHggMXB4IDAgIzAwMDsKICAgIG9wYWNpdHk6IDAuOTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuZGFtYWdlIHsKICAgIGZvbnQtc2l6ZTogNDJweDsKICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmZmYgMCUsICNmZmNjMDAgNDAlLCAjZmY0NDAwIDEwMCUpOwogICAgLXdlYmtpdC1iYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAtd2Via2l0LXRleHQtZmlsbC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgNHB4IDRweCByZ2JhKDAsMCwwLDAuOCkpOwogICAgYW5pbWF0aW9uOiBwb3BEYW1hZ2UgMC44cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSkgZm9yd2FyZHM7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmhlYWwgewogICAgZm9udC1zaXplOiAzNnB4OwogICAgY29sb3I6ICM0NGZmNDQ7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmYwMDsKICAgIGFuaW1hdGlvbjogZmxvYXRVcCAxcyBlYXNlLW91dCBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIudmVub20gewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQycHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBjb2xvcjogI2FhZmYwMDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjNDQ4ODAwLCAycHggMnB4IDAgIzAwMjIwMDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNjY2ZmNjYgMCUsICM2NmNjMDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDVweCByZ2JhKDEwMCwgMjU1LCAwLCAwLjUpKTsKICAgIGFuaW1hdGlvbjogZHJpcFN0YXR1cyAycyBpbmZpbml0ZTsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2xlZXAgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDE1cHggIzAwNDRmZiwgMCAwIDMwcHggIzAwMDBmZjsKICAgIG9wYWNpdHk6IDAuOTsKICAgIGFuaW1hdGlvbjogZHJpZnRTdGF0dXMgM3MgZWFzZS1pbi1vdXQgaW5maW5pdGU7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLndpdGhlciB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMzhweDsKICAgIGNvbG9yOiAjY2NjY2NjOwogICAgdGV4dC1zaGFkb3c6IDJweCAycHggMCAjNDQ0NDQ0OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2VlZWVlZSAwJSwgIzg4ODg4OCAxMDAlKTsKICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYW5pbWF0aW9uOiB3aXRoZXJTdGF0dXMgMS41cyBmb3J3YXJkczsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIudGVjaCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDMycHg7CiAgICBjb2xvcjogIzAwZmZmZjsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMTAsIDMwLCAwLjcpOwogICAgcGFkZGluZzogMnB4IDEwcHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjMDBmZmZmOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggIzAwODhmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICNmZmY7CiAgICBhbmltYXRpb246IHNoYWtlVGVjaCAwLjZzIGVhc2UtaW4tb3V0LCBmbGFzaFRlY2ggMC4zczsKICAgIHRyYW5zZm9ybS1vcmlnaW46IGNlbnRlcjsKfQoKLmZsb2F0aW5nLXRleHQtaW5uZXIuc2F2ZSwgLmZsb2F0aW5nLXRleHQtaW5uZXIuYmxvY2sgewogICAgZm9udC1zaXplOiA0OHB4OwogICAgZm9udC13ZWlnaHQ6IDkwMDsKICAgIGNvbG9yOiAjZmZmZmZmOwogICAgLXdlYmtpdC10ZXh0LXN0cm9rZTogMXB4ICMwMDQ0ODg7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwODhmZjsKICAgIGFuaW1hdGlvbjogcG9wRGFtYWdlIDAuNXMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCkBrZXlmcmFtZXMgcG9wRGFtYWdlIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjUpOyBvcGFjaXR5OiAwOyB9CiAgICAyMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuNSk7IG9wYWNpdHk6IDE7IH0KICAgIDQwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIGZsb2F0VXAgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMCk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTUwcHgpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgZHJpcFN0YXR1cyB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGVZKDEpOyBmaWx0ZXI6IGJsdXIoMHB4KTsgfQogICAgNTAlIHsgdHJhbnNmb3JtOiBzY2FsZVkoMS4xKSB0cmFuc2xhdGVZKDVweCk7IGZpbHRlcjogYmx1cigxcHgpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZVkoMSk7IGZpbHRlcjogYmx1cigwcHgpOyB9Cn0KCkBrZXlmcmFtZXMgZHJpZnRTdGF0dXMgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMCkgcm90YXRlKDBkZWcpOyBvcGFjaXR5OiAwOyB9CiAgICAyMCUgeyBvcGFjaXR5OiAxOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMTVweCkgdHJhbnNsYXRlWSgtMjBweCkgcm90YXRlKDEwZGVnKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtMTVweCkgdHJhbnNsYXRlWSgtNTBweCkgcm90YXRlKC0xMGRlZyk7IG9wYWNpdHk6IDA7IH0KfQoKQGtleWZyYW1lcyB3aXRoZXJTdGF0dXMgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEpOyBmaWx0ZXI6IGdyYXlzY2FsZSgwJSk7IG9wYWNpdHk6IDE7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuNik7IGZpbHRlcjogZ3JheXNjYWxlKDEwMCUpOyBvcGFjaXR5OiAwOyB9Cn0KCkBrZXlmcmFtZXMgc2hha2VUZWNoIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjgpOyB9CiAgICAxMCUsIDMwJSwgNTAlLCA3MCUsIDkwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4xKSB0cmFuc2xhdGUoLTJweCwgMnB4KTsgfQogICAgMjAlLCA0MCUsIDYwJSwgODAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjEpIHRyYW5zbGF0ZSgycHgsIC0ycHgpOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjApOyB9Cn0KCkBrZXlmcmFtZXMgZmxhc2hUZWNoIHsKICAgIDAlIHsgYmFja2dyb3VuZC1jb2xvcjogI2ZmZjsgY29sb3I6ICMwMDA7IGJvcmRlci1jb2xvcjogI2ZmZjsgfQogICAgMTAwJSB7IGJhY2tncm91bmQtY29sb3I6IHJnYmEoMCwgMTAsIDMwLCAwLjg1KTsgY29sb3I6ICMwMGZmZmY7IGJvcmRlci1jb2xvcjogIzAwZmZmZjsgfQp9CgojbG9hZGluZyB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICBhbmltYXRpb246IGJsaW5rIDFzIGluZmluaXRlOwp9CkBrZXlmcmFtZXMgYmxpbmsgeyA1MCUgeyBvcGFjaXR5OiAwLjU7IH0gfQoKI2NvbnRyb2xzLWhpbnQgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMzBweDsgd2lkdGg6IDEwMCU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogcmdiYSgyNTUsMjU1LDI1NSwwLjQpOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgouZmxvYXRpbmctdGV4dC1pbm5lci5jb21pYy1pbXBhY3QgewogICAgZm9udC1mYW1pbHk6ICdJbXBhY3QnLCBzYW5zLXNlcmlmOwogICAgZm9udC1zaXplOiA0MnB4OwogICAgY29sb3I6ICNmZmZmMDA7IAogICAgLXdlYmtpdC10ZXh0LXN0cm9rZTogMXB4ICMwMDA7CiAgICB0ZXh0LXNoYWRvdzogM3B4IDNweCAwICNmZjAwMDA7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICB0cmFuc2Zvcm0tb3JpZ2luOiBjZW50ZXI7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgYW5pbWF0aW9uOiBjb21pY1BvcCAwLjRzIGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIsIDEuMjc1KSBmb3J3YXJkczsKICAgIHotaW5kZXg6IDI1MDA7Cn0KCi5mbG9hdGluZy10ZXh0LWlubmVyLmNvbWljLWFjdGlvbiB7CiAgICBmb250LWZhbWlseTogJ0FyaWFsIEJsYWNrJywgc2Fucy1zZXJpZjsKICAgIGZvbnQtc2l6ZTogMjhweDsKICAgIGNvbG9yOiAjMDBmZmZmOyAKICAgIC13ZWJraXQtdGV4dC1zdHJva2U6IDFweCAjMDAwOwogICAgdGV4dC1zaGFkb3c6IDJweCAycHggMCAjMDA0NGFhOwogICAgZm9udC1zdHlsZTogaXRhbGljOwogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgIGFuaW1hdGlvbjogY29taWNTbGlkZSAwLjRzIGVhc2Utb3V0IGZvcndhcmRzOwogICAgei1pbmRleDogMjUwMDsKfQoKQGtleWZyYW1lcyBjb21pY1BvcCB7CiAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMCkgcm90YXRlKC0yMGRlZyk7IG9wYWNpdHk6IDA7IH0KICAgIDQwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4yKSByb3RhdGUoNWRlZyk7IG9wYWNpdHk6IDE7IH0KICAgIDYwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKSByb3RhdGUoLTVkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjEpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgpAa2V5ZnJhbWVzIGNvbWljU2xpZGUgewogICAgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtMjBweCwgMjBweCkgc2NhbGUoMC41KTsgb3BhY2l0eTogMDsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKDIwcHgsIC0yMHB4KSBzY2FsZSgxLjIpOyBvcGFjaXR5OiAwOyB9Cn0KCi8qIC0tLSBNQUlOIE1FTlUgLS0tICovCi8qIC0tLSBNQUlOIE1FTlUgJiBFTkQgR0FNRSAoRkZYIFNUWUxFKSAtLS0gKi8KI21haW4tbWVudSwgI2VuZC1nYW1lLW1lbnUgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICB6LWluZGV4OiAzMDAwOwogICAgb3BhY2l0eTogMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjhzIGN1YmljLWJlemllcigwLjIsIDAuOCwgMC4yLCAxLjApOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCBjZW50ZXIsIHJnYmEoMCwgMjAsIDYwLCAwLjQpIDAlLCByZ2JhKDAsIDUsIDEwLCAwLjgpIDEwMCUpOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDVweCk7Cn0KCiNtYWluLW1lbnUuYWN0aXZlLCAjZW5kLWdhbWUtbWVudS5hY3RpdmUgewogICAgb3BhY2l0eTogMTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgoubWVudS1iZy1vdmVybGF5LCAuZW5kLWJnLWxheWVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IAogICAgICAgIGxpbmVhci1ncmFkaWVudChyZ2JhKDAsMCwwLDApIDUwJSwgcmdiYSgwLDAsMCwwLjEpIDUwJSksIAogICAgICAgIHJlcGVhdGluZy1saW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMjU1LDI1NSwyNTUsMC4wMikgMHB4LCByZ2JhKDI1NSwyNTUsMjU1LDAuMDIpIDFweCwgdHJhbnNwYXJlbnQgMXB4LCB0cmFuc3BhcmVudCAyMHB4KTsKICAgIGJhY2tncm91bmQtc2l6ZTogMTAwJSA0cHgsIDEwMCUgMTAwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogLTE7Cn0KCi8qIExPR08gU1RZTElORyAqLwouZmZ4LWxvZ28tY29udGFpbmVyIHsKICAgIG1hcmdpbi1ib3R0b206IDUwcHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICB0cmFuc2Zvcm06IHNrZXdYKC0xMGRlZyk7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7Cn0KCi5mZngtbG9nby1tYWluIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogY2xhbXAoNDhweCwgMTB2dywgODRweCk7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogOHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZmZmZiAwJSwgI2FhY2NmZiA0MCUsICMwMDg4ZmYgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDE1cHggcmdiYSgwLCAxMDAsIDI1NSwgMC44KSk7CiAgICBhbmltYXRpb246IGxvZ29TaGltbWVyIDNzIGluZmluaXRlIGFsdGVybmF0ZTsKfQoKLmZmeC1sb2dvLXN1YiB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IGNsYW1wKDE0cHgsIDN2dywgMjRweCk7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDE1cHg7CiAgICBtYXJnaW4tdG9wOiAtMTBweDsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmZhYTAwOwogICAgb3BhY2l0eTogMC45Owp9CgpAa2V5ZnJhbWVzIGxvZ29TaGltbWVyIHsKICAgIDAlIHsgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMTBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjUpKTsgfQogICAgMTAwJSB7IGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDI1cHggcmdiYSgwLCAyMDAsIDI1NSwgMC45KSk7IH0KfQoKLyogTUVOVSBPUFRJT05TICovCi5tZW51LW9wdGlvbnMsIC5lbmQtb3B0aW9ucyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogMTVweDsKICAgIHdpZHRoOiAzMjBweDsKfQoKLm1lbnUtaXRlbSB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBwYWRkaW5nOiAxMnB4IDMwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwgMzAsIDYwLCAwLjgpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC4yKSAxMDAlKTsKICAgIGJvcmRlci1sZWZ0OiAzcHggc29saWQgcmdiYSgxMDAsIDIwMCwgMjU1LCAwLjMpOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMTAwLCAyMDAsIDI1NSwgMC4xKTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRyYW5zaXRpb246IGFsbCAwLjNzIGN1YmljLWJlemllcigwLjIsIDAuOCwgMC4yLCAxLjApOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTVkZWcpOwogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgoubWVudS1pdGVtOjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IC0xMDAlOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjIpLCB0cmFuc3BhcmVudCk7CiAgICB0cmFuc2l0aW9uOiBsZWZ0IDAuNHM7Cn0KCi5tZW51LWl0ZW06aG92ZXI6OmJlZm9yZSB7CiAgICBsZWZ0OiAxMDAlOwp9CgoubWVudS1pdGVtOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgwLCA4MCwgMTYwLCAwLjkpIDAlLCByZ2JhKDAsIDIwLCA0MCwgMC40KSAxMDAlKTsKICAgIGJvcmRlci1sZWZ0LWNvbG9yOiAjMDBmZmZmOwogICAgcGFkZGluZy1sZWZ0OiA0NXB4OwogICAgYm94LXNoYWRvdzogMCAwIDIwcHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLm1lbnUtaXRlbSAubGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdGl0bGUpOwogICAgZm9udC1zaXplOiAyMHB4OwogICAgY29sb3I6ICNjY2NjY2M7CiAgICBsZXR0ZXItc3BhY2luZzogM3B4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIHRyYW5zZm9ybTogc2tld1goMTVkZWcpOwogICAgdHJhbnNpdGlvbjogY29sb3IgMC4yczsKfQoKLm1lbnUtaXRlbTpob3ZlciAubGFiZWwgewogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKfQoKLm1lbnUtaXRlbSAuY3Vyc29yIHsKICAgIHdpZHRoOiAxMHB4OyBoZWlnaHQ6IDEwcHg7CiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtZ29sZCk7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBtYXJnaW4tcmlnaHQ6IDE1cHg7CiAgICBvcGFjaXR5OiAwOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0yMHB4KSBza2V3WCgxNWRlZyk7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4zczsKICAgIGJveC1zaGFkb3c6IDAgMCAxMHB4IHZhcigtLWZmeC1nb2xkKTsKfQoKLm1lbnUtaXRlbTpob3ZlciAuY3Vyc29yIHsKICAgIG9wYWNpdHk6IDE7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMCkgc2tld1goMTVkZWcpOwp9CgoubWVudS1mb290ZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAzMHB4OwogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHJnYmEoMjU1LDI1NSwyNTUsMC4zKTsKICAgIGxldHRlci1zcGFjaW5nOiA0cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwp9CgovKiBFTkQgR0FNRSBTUEVDSUZJQyAqLwoucmVzdWx0LWhlYWRlciB7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBtYXJnaW4tYm90dG9tOiA0MHB4OwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwp9CgoucmVzdWx0LXRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogNzJweDsKICAgIGNvbG9yOiAjZmZmOwogICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICMwMGFhZmYsIDAgMCA0MHB4ICMwMDQ0YWE7CiAgICBsZXR0ZXItc3BhY2luZzogNXB4OwogICAgbGluZS1oZWlnaHQ6IDEuMDsKfQoKLnJlc3VsdC1zdWJ0aXRsZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1zcGlyYSk7CiAgICBmb250LXNpemU6IDE4cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgbGV0dGVyLXNwYWNpbmc6IDhweDsKICAgIG1hcmdpbi10b3A6IDVweDsKfQoKLmZpbmFsLXNjb3JlLWNvbnRhaW5lciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgZ2FwOiA0MHB4OwogICAgbWFyZ2luLWJvdHRvbTogNTBweDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQsIHJnYmEoMCwgMjAsIDUwLCAwLjgpLCB0cmFuc3BhcmVudCk7CiAgICBwYWRkaW5nOiAyMHB4IDA7CiAgICB3aWR0aDogMTAwJTsKfQoKLmZpbmFsLXRlYW0gewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgd2lkdGg6IDEyMHB4Owp9CgouZmluYWwtc2NvcmUtZGlnaXQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDgwcHg7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMjBweCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNSk7CiAgICBsaW5lLWhlaWdodDogMS4wOwp9CgouZmluYWwtdGVhbS5ob21lIC5maW5hbC1zY29yZS1kaWdpdCB7IGNvbG9yOiAjMDBmZmZmOyB0ZXh0LXNoYWRvdzogMCAwIDIwcHggIzAwZmZmZjsgfQouZmluYWwtdGVhbS5hd2F5IC5maW5hbC1zY29yZS1kaWdpdCB7IGNvbG9yOiAjZmY0NDQ0OyB0ZXh0LXNoYWRvdzogMCAwIDIwcHggI2ZmNDQ0NDsgfQoKLmZpbmFsLXRlYW0tbmFtZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjb2xvcjogI2FhYTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICBtYXJnaW4tdG9wOiA1cHg7Cn0KCi5maW5hbC12cyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBvcGFjaXR5OiAwLjY7Cn0KCi5maW5hbC12cyBzcGFuIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB2YXIoLS1mZngtZ29sZCk7CiAgICBtYXJnaW46IDVweCAwOwp9CgoudnMtbGluZSB7CiAgICB3aWR0aDogMnB4OyBoZWlnaHQ6IDMwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCB0cmFuc3BhcmVudCwgdmFyKC0tZmZ4LWdvbGQpLCB0cmFuc3BhcmVudCk7Cn0KLyogLS0tIFBSQUNUSUNFIE9WRVJMQVkgLS0tICovCiNwcmFjdGljZS1vdmVybGF5IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNSwgMTAsIDAuNik7CiAgICBkaXNwbGF5OiBub25lOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgei1pbmRleDogMjUwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwp9CgojcHJhY3RpY2Utb3ZlcmxheS5hY3RpdmUgewogICAgZGlzcGxheTogZmxleDsKfQoKLnByYWN0aWNlLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogbWF4KDYwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtdG9wKSArIDQwcHgpOyAKICAgIHJpZ2h0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCkpOwogICAgd2lkdGg6IDI4MHB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE2MGRlZywgcmdiYSgwLCAyMCwgNTAsIDAuOTUpIDAlLCByZ2JhKDAsIDEwLCAyMCwgMC45OCkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjNDQ4OGZmOwogICAgYm9yZGVyLXJhZGl1czogMCAwIDE1cHggMDsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMiksIGluc2V0IDAgMCA1MHB4IHJnYmEoMCwgMjAsIDYwLCAwLjUpOwogICAgcGFkZGluZzogMTVweDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMmRlZyk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNXB4KTsKfQoKLnBhbmVsLWhlYWRlciB7CiAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgoucGFuZWwtdGl0bGUtZ3JvdXAgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47Cn0KCi5wYW5lbC10aXRsZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC10aXRsZSk7CiAgICBmb250LXNpemU6IGNsYW1wKDE4cHgsIDZ2dywgMjRweCk7CiAgICBjb2xvcjogI2ZmZmZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjMDBmZmZmOwogICAgbGV0dGVyLXNwYWNpbmc6IDJweDsKfQoKLnBhbmVsLXN1YnRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogOHB4OwogICAgY29sb3I6ICM0NDg4ZmY7CiAgICBsZXR0ZXItc3BhY2luZzogNHB4OwogICAgbWFyZ2luLXRvcDogLTJweDsKfQoKLnBhbmVsLWRlY28tbGluZSB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMnB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB0cmFuc3BhcmVudCwgIzAwZmZmZiwgdHJhbnNwYXJlbnQpOwogICAgbWFyZ2luLXRvcDogNXB4OwogICAgYm94LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOwp9CgoucGFuZWwtY29udGVudCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogMTVweDsKfQoKLnNlY3Rpb24tbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDIwMCwgMTc2LCA5NiwgMC4zKTsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKICAgIHBhZGRpbmctYm90dG9tOiAycHg7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgouZHJpbGwtbGlzdCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGdhcDogNXB4Owp9CgouZHJpbGwtYnRuIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcGFkZGluZzogOHB4IDEycHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4wNSksIHRyYW5zcGFyZW50KTsKICAgIGJvcmRlci1sZWZ0OiAycHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTRweDsKICAgIGNvbG9yOiAjYWFhOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7Cn0KCi5kcmlsbC1idG46aG92ZXIgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDI1NSwgMjU1LCAwLjEpLCB0cmFuc3BhcmVudCk7CiAgICBjb2xvcjogI2ZmZjsKICAgIHBhZGRpbmctbGVmdDogMTVweDsKfQoKLmRyaWxsLWJ0bi5hY3RpdmUgewogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDEwMCwgMjU1LCAwLjQpLCB0cmFuc3BhcmVudCk7CiAgICBib3JkZXItbGVmdDogM3B4IHNvbGlkICMwMGZmZmY7CiAgICBjb2xvcjogI2ZmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMGZmZmY7Cn0KCi5kcmlsbC1idG4gLmljb24gewogICAgd2lkdGg6IDIwcHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBtYXJnaW4tcmlnaHQ6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwp9Cgoub3B0aW9uLWxpc3QgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBnYXA6IDVweDsKfQoKLm9wdGlvbi10b2dnbGUgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwYWRkaW5nOiA1cHggMTBweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGNvbG9yOiAjY2NjOwogICAgdHJhbnNpdGlvbjogY29sb3IgMC4yczsKfQoKLm9wdGlvbi10b2dnbGU6aG92ZXIgeyBjb2xvcjogI2ZmZjsgfQoKLm9wdGlvbi10b2dnbGUgLmNoZWNrYm94IHsKICAgIG1hcmdpbi1yaWdodDogMTBweDsKICAgIGNvbG9yOiAjNDQ0OwogICAgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsKICAgIGZvbnQtc2l6ZTogMTRweDsKfQoKLm9wdGlvbi10b2dnbGUuYWN0aXZlIC5jaGVja2JveCB7CiAgICBjb2xvcjogIzAwZmYwMDsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMGZmMDA7Cn0KCi5vcHRpb24tdG9nZ2xlLmFjdGl2ZSB7CiAgICBjb2xvcjogI2ZmZjsKfQoKLmFjdGlvbi1idG4gewogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjUpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIHBhZGRpbmc6IDZweDsKICAgIGZvbnQtc2l6ZTogMTFweDsKICAgIGNvbG9yOiAjYWFhOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICBtYXJnaW4tYm90dG9tOiA1cHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKfQoKLmFjdGlvbi1idG46aG92ZXIgewogICAgYm9yZGVyLWNvbG9yOiAjZmZmOwogICAgY29sb3I6ICNmZmY7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7Cn0KCiNwLWV4aXQ6aG92ZXIgewogICAgYm9yZGVyLWNvbG9yOiAjZmY0NDQ0OwogICAgY29sb3I6ICNmZjQ0NDQ7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDUwLCAwLCAwLCAwLjMpOwp9CgoucGFuZWwtZm9vdGVyIHsKICAgIG1hcmdpbi10b3A6IDE1cHg7CiAgICBwYWRkaW5nLXRvcDogMTBweDsKICAgIGJvcmRlci10b3A6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCiNkcmlsbC1pbnN0cnVjdGlvbiB7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgbWFyZ2luLWJvdHRvbTogNXB4OwogICAgZm9udC1zdHlsZTogaXRhbGljOwp9CgojZHJpbGwtc2NvcmUgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWdvbGQpOwogICAgdGV4dC1zaGFkb3c6IDAgMCAxMHB4IHJnYmEoMjU1LCAyMTUsIDAsIDAuNSk7Cn0KCi5wYW5lbC1taW5pbWl6ZS1idG4gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAxMHB4OyByaWdodDogMTBweDsKICAgIHdpZHRoOiAyMHB4OyBoZWlnaHQ6IDIwcHg7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBjb2xvcjogdmFyKC0tZmZ4LWN5YW4pOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgbGluZS1oZWlnaHQ6IDE4cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDAuNSk7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoucGFuZWwtbWluaW1pemUtYnRuOmhvdmVyIHsgCiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mZngtY3lhbik7IAogICAgY29sb3I6ICMwMDA7IAogICAgYm94LXNoYWRvdzogMCAwIDVweCB2YXIoLS1mZngtY3lhbik7Cn0KCiNwcmFjdGljZS1yZXN0b3JlLWJ0biB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA0MHB4KTsgCiAgICByaWdodDogbWF4KDIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQpKTsKICAgIHBhZGRpbmc6IDhweCAxNXB4OwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCByZ2JhKDAsIDIwLCA1MCwgMC45KSAwJSwgcmdiYSgwLCAxMCwgMjAsIDAuOSkgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mZngtY3lhbik7CiAgICBib3JkZXItbGVmdDogM3B4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB6LWluZGV4OiAyNDAwOwogICAgZGlzcGxheTogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNmb3JtOiBza2V3WCgtMTBkZWcpOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggcmdiYSgwLCAxMDAsIDI1NSwgMC4yKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KI3ByYWN0aWNlLXJlc3RvcmUtYnRuOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgNDAsIDgwLCAwLjkpOwogICAgY29sb3I6ICNmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDVweCAjMDBmZmZmOwogICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLCAyNTUsIDI1NSwgMC4zKTsKfQoKLyogLS0tIEFJTSBKT1lTVElDSyAtLS0gKi8KI2FpbS1qb3lzdGljay16b25lIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDE1MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkpOwogICAgcmlnaHQ6IDA7CiAgICB3aWR0aDogNDAlOwogICAgaGVpZ2h0OiAzNSU7CiAgICB6LWluZGV4OiAxMDAwOwogICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwKTsKICAgIHRvdWNoLWFjdGlvbjogbm9uZTsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwp9CgojYWltLWpveXN0aWNrLXZpc3VhbCB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7CiAgICB3aWR0aDogMDsgaGVpZ2h0OiAwOwogICAgb3ZlcmZsb3c6IHZpc2libGU7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICB6LWluZGV4OiAxMTAwOwp9CgojYWltLWpveXN0aWNrLWJhc2UgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDkwcHg7IGhlaWdodDogOTBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMjU1LCAxMDAsIDAsIDAuMykgMCUsIHJnYmEoODAsIDIwLCAwLCAwLjEpIDYwJSwgdHJhbnNwYXJlbnQgMTAwJSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMTUwLCA1MCwgMC40KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuMiksIGluc2V0IDAgMCAyMHB4IHJnYmEoMjU1LCA1MCwgMCwgMC4yKTsKfQoKI2FpbS1qb3lzdGljay1rbm9iIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIHdpZHRoOiA0MHB4OyBoZWlnaHQ6IDQwcHg7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsICNmZmNjODggMCUsICNmZjY2MDAgNDAlLCAjODgyMjAwIDgwJSwgIzIyMDAwMCAxMDAlKTsKICAgIGJvcmRlcjogMnB4IHNvbGlkICNmZmFhNDQ7CiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjZmY0NDAwLCBpbnNldCAwIDAgOHB4IHJnYmEoMjU1LDI1NSwyNTUsMC42KTsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjA1cyBsaW5lYXI7CiAgICB3aWxsLWNoYW5nZTogdHJhbnNmb3JtOwp9CgojYWltLWpveXN0aWNrLWtub2I6OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICJBSU0iOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgZm9udC1zaXplOiA4cHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIHRleHQtc2hhZG93OiAwIDAgM3B4ICMwMDA7Cn0KCi8qIC0tLSBUQUNLTEUgQlVUVE9OIC0tLSAqLwojdGFja2xlLWJ1dHRvbiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IG1heCgxNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20pICsgMTAwcHgpOwogICAgcmlnaHQ6IG1heCg0MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogNzBweDsKICAgIGhlaWdodDogNzBweDsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgIHotaW5kZXg6IDEwMDsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgMzUlIDM1JSwgI2ZmODg4OCAwJSwgI2NjMDAwMCA0MCUsICM2NjAwMDAgODAlLCAjMjIwMDAwIDEwMCUpOwogICAgYm9yZGVyOiAzcHggc29saWQgI2ZmNDQ0NDsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjU1LCA1MCwgNTAsIDAuNiksIGluc2V0IDAgMCAxNXB4IHJnYmEoMjU1LCAyMDAsIDIwMCwgMC4zKTsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjFzLCBmaWx0ZXIgMC4yczsKfQoKI3RhY2tsZS1idXR0b246YWN0aXZlIHsKICAgIHRyYW5zZm9ybTogc2NhbGUoMC45KTsKICAgIGZpbHRlcjogYnJpZ2h0bmVzcygxLjIpOwp9CgojdGFja2xlLWJ1dHRvbi5hY3RpdmUgewogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmZmZmZmIDAlLCAjZmY0NDQ0IDQwJSwgI2FhMDAwMCA4MCUsICM0NDAwMDAgMTAwJSk7CiAgICBib3gtc2hhZG93OiAwIDAgMjVweCByZ2JhKDI1NSwgMTAwLCAxMDAsIDAuOSk7Cn0KCiN0YWNrbGUtYnV0dG9uIC5idG4tdGV4dCB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6IHdoaXRlOwogICAgdGV4dC1zaGFkb3c6IDAgMXB4IDJweCByZ2JhKDAsMCwwLDAuOCk7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMXB4Owp9CgojdGFja2xlLWJ1dHRvbiAuYnRuLWdsYXJlIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogLTUwJTsgbGVmdDogLTUwJTsKICAgIHdpZHRoOiAyMDAlOyBoZWlnaHQ6IDIwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoNDVkZWcsIHRyYW5zcGFyZW50IDQwJSwgcmdiYSgyNTUsMjU1LDI1NSwwLjMpIDUwJSwgdHJhbnNwYXJlbnQgNjAlKTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgYW5pbWF0aW9uOiBnbGFyZVBhc3MgNHMgaW5maW5pdGU7Cn0KCiN0YWNrbGUtYnV0dG9uLnVyZ2VudCB7CiAgICBhbmltYXRpb246IHVyZ2VudFB1bHNlIDAuNXMgaW5maW5pdGUgYWx0ZXJuYXRlOwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAzNSUgMzUlLCAjZmY1NTU1IDAlLCAjZmYwMDAwIDQwJSwgIzg4MDAwMCAxMDAlKTsKICAgIGJvcmRlci1jb2xvcjogI2ZmYWFhYTsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4ICNmZjAwMDA7Cn0KCkBrZXlmcmFtZXMgdXJnZW50UHVsc2UgewogICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKTsgfQogICAgdG8geyB0cmFuc2Zvcm06IHNjYWxlKDEuMTUpOyB9Cn0KCi8qIC0tLSBDSEFSR0UgUE9XRVIgTUVURVIgLS0tICovCiNjaGFyZ2UtbWV0ZXItY29udGFpbmVyIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJvdHRvbTogbWF4KDI1MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWJvdHRvbSkgKyAxMDBweCk7CiAgICBsZWZ0OiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICB3aWR0aDogMjAwcHg7CiAgICBkaXNwbGF5OiBub25lOwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDIwMDA7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDEwLCAzMCwgMC44KTsKICAgIHBhZGRpbmc6IDEwcHggMTVweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDVweDsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMCwgMTAwLCAyNTUsIDAuMyk7Cn0KCi5jaGFyZ2UtbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtc3BpcmEpOwogICAgZm9udC1zaXplOiAxMnB4OwogICAgY29sb3I6IHZhcigtLWZmeC1jeWFuKTsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgbWFyZ2luLWJvdHRvbTogNXB4Owp9CgouY2hhcmdlLW1ldGVyLXRyYWNrIHsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjYpOwogICAgYm9yZGVyOiAxcHggc29saWQgIzQ0NDsKICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCiNjaGFyZ2UtbWV0ZXItZmlsbCB7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICB3aWR0aDogMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwYWYsICMwZjApOwogICAgYm94LXNoYWRvdzogMCAwIDEwcHggIzBmMDsKICAgIHRyYW5zaXRpb246IHdpZHRoIDAuMDVzIGxpbmVhciwgYmFja2dyb3VuZCAwLjFzOwogICAgYm9yZGVyLXJhZGl1czogNXB4Owp9CgouY2hhcmdlLWhpbnQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtdWkpOwogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIG1hcmdpbi10b3A6IDVweDsKICAgIG9wYWNpdHk6IDAuODsKICAgIGFuaW1hdGlvbjogYmxpbmsgMC41cyBpbmZpbml0ZTsKfQoKLyogLS0tIEdPQUwgRElTVEFOQ0UgSU5ESUNBVE9SIC0tLSAqLwojZ29hbC1kaXN0YW5jZS1jb250YWluZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiBtYXgoNzVweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNTVweCk7CiAgICBsZWZ0OiBtYXgoMjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0KSk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgIHotaW5kZXg6IDEwMDsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgcmdiYSgwLCAxMCwgMzAsIDAuNykgMCUsIHRyYW5zcGFyZW50IDEwMCUpOwogICAgcGFkZGluZzogNXB4IDE1cHggNXB4IDEwcHg7CiAgICBib3JkZXItbGVmdDogMnB4IHNvbGlkIHZhcigtLWZmeC1nb2xkKTsKfQoKLmRpc3RhbmNlLWxhYmVsIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXNwaXJhKTsKICAgIGZvbnQtc2l6ZTogOHB4OwogICAgY29sb3I6IHZhcigtLWZmeC1nb2xkKTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwp9CgojZ29hbC1kaXN0YW5jZSB7CiAgICBmb250LWZhbWlseTogdmFyKC0tZm9udC1kYXRhKTsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1nb2xkKTsKfQoKLyogLS0tIFNFVFRJTkdTIEJVVFRPTiAtLS0gKi8KI3NldHRpbmdzLWJ1dHRvbiB7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IG1heCgyNDBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgMTAwcHgpOwogICAgcmlnaHQ6IG1heCgyMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICB3aWR0aDogMTEwcHg7CiAgICBwYWRkaW5nOiA4cHggMDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6ICM4ODg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDIwLCAyMCwgMjAsIDAuOCkgMCUsIHJnYmEoMTAsIDEwLCAxMCwgMC45KSAxMDAlKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICB6LWluZGV4OiAxMDA7Cn0KCiNzZXR0aW5ncy1idXR0b246aG92ZXIgewogICAgYmFja2dyb3VuZDogcmdiYSg0MCwgNDAsIDQwLCAwLjkpOwogICAgYm9yZGVyLWNvbG9yOiAjODg4OwogICAgY29sb3I6ICNmZmY7Cn0KCi8qIC0tLSBTRVRUSU5HUyBQQU5FTCAtLS0gKi8KI3NldHRpbmdzLXBhbmVsIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOwogICAgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICB3aWR0aDogMjgwcHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTYwZGVnLCByZ2JhKDAsIDIwLCA1MCwgMC45OCkgMCUsIHJnYmEoMCwgMTAsIDIwLCAwLjk5KSAxMDAlKTsKICAgIGJvcmRlcjogMnB4IHNvbGlkIHZhcigtLWZmeC1jeWFuKTsKICAgIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgICBib3gtc2hhZG93OiAwIDAgMzBweCByZ2JhKDAsIDEwMCwgMjU1LCAwLjQpOwogICAgei1pbmRleDogMzUwMDsKICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEwcHgpOwp9Cgouc2V0dGluZ3MtaGVhZGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgcGFkZGluZzogMTVweDsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMyk7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDMwLCA2MCwgMC41KTsKfQoKLnNldHRpbmdzLWhlYWRlciBzcGFuIHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LXRpdGxlKTsKICAgIGZvbnQtc2l6ZTogMjBweDsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIHRleHQtc2hhZG93OiAwIDAgNXB4IHZhcigtLWZmeC1jeWFuKTsKICAgIGxldHRlci1zcGFjaW5nOiAzcHg7Cn0KCiNzZXR0aW5ncy1jbG9zZSB7CiAgICB3aWR0aDogMzBweDsKICAgIGhlaWdodDogMzBweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkICNmZjQ0NDQ7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDUwLCAwLCAwLCAwLjUpOwogICAgY29sb3I6ICNmZjQ0NDQ7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKfQoKI3NldHRpbmdzLWNsb3NlOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6ICNmZjQ0NDQ7CiAgICBjb2xvcjogd2hpdGU7Cn0KCi5zZXR0aW5ncy1jb250ZW50IHsKICAgIHBhZGRpbmc6IDIwcHg7Cn0KCi5zZXR0aW5nLXJvdyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICBwYWRkaW5nOiAxMHB4OwogICAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjMpOwogICAgYm9yZGVyLXJhZGl1czogNXB4Owp9Cgouc2V0dGluZy1yb3cgbGFiZWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjb2xvcjogI2NjYzsKfQoKLnNldHRpbmctcm93IGlucHV0W3R5cGU9InJhbmdlIl0gewogICAgd2lkdGg6IDEwMHB4OwogICAgYWNjZW50LWNvbG9yOiB2YXIoLS1mZngtY3lhbik7Cn0KCi5zZXR0aW5nLXJvdyBpbnB1dFt0eXBlPSJjaGVja2JveCJdIHsKICAgIHdpZHRoOiAyMHB4OwogICAgaGVpZ2h0OiAyMHB4OwogICAgYWNjZW50LWNvbG9yOiB2YXIoLS1mZngtY3lhbik7CiAgICBjdXJzb3I6IHBvaW50ZXI7Cn0KCi8qIC0tLSBHTEFSRSBBTklNQVRJT04gLS0tICovCkBrZXlmcmFtZXMgZ2xhcmVQYXNzIHsKICAgIDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC0xMDAlKSByb3RhdGUoNDVkZWcpOyB9CiAgICAzMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMTAwJSkgcm90YXRlKDQ1ZGVnKTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxMDAlKSByb3RhdGUoNDVkZWcpOyB9Cn0KCi8qIC0tLSBTVEFUVVMgVFlQRSBGTE9BVElORyBURVhUIC0tLSAqLwouZmxvYXRpbmctdGV4dC1pbm5lci5zdGF0dXMgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI4cHg7CiAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICBjb2xvcjogI2ZmMDBmZjsKICAgIHRleHQtc2hhZG93OiAwIDAgMTBweCAjZmYwMGZmLCAycHggMnB4IDAgIzAwMDsKICAgIGFuaW1hdGlvbjogc3RhdHVzUG9wIDEuMnMgZWFzZS1vdXQgZm9yd2FyZHM7Cn0KCkBrZXlmcmFtZXMgc3RhdHVzUG9wIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjUpIHRyYW5zbGF0ZVkoMCk7IG9wYWNpdHk6IDA7IH0KICAgIDIwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4zKSB0cmFuc2xhdGVZKC0xMHB4KTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wKSB0cmFuc2xhdGVZKC00MHB4KTsgb3BhY2l0eTogMDsgfQp9CgovKiAtLS0gR09BTCBUWVBFIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LWlubmVyLmdvYWwgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDQ4cHg7CiAgICBmb250LXdlaWdodDogOTAwOwogICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgI2ZmZiAwJSwgI2ZmZDcwMCA1MCUsICNmZjg4MDAgMTAwJSk7CiAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCA0cHggNHB4IHJnYmEoMCwwLDAsMC45KSk7CiAgICBhbmltYXRpb246IGdvYWxQb3AgMXMgY3ViaWMtYmV6aWVyKDAuMTc1LCAwLjg4NSwgMC4zMiwgMS4yNzUpIGZvcndhcmRzOwp9CgpAa2V5ZnJhbWVzIGdvYWxQb3AgewogICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDApIHJvdGF0ZSgtMTBkZWcpOyBvcGFjaXR5OiAwOyB9CiAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuNSkgcm90YXRlKDVkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjIpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQp9CgovKiAtLS0gREVGQVVMVCBUWVBFIEZMT0FUSU5HIFRFWFQgLS0tICovCi5mbG9hdGluZy10ZXh0LWlubmVyLmRlZmF1bHQgewogICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtZGF0YSk7CiAgICBmb250LXNpemU6IDI0cHg7CiAgICBjb2xvcjogd2hpdGU7CiAgICB0ZXh0LXNoYWRvdzogMCAycHggNHB4IHJnYmEoMCwwLDAsMC44KTsKICAgIGFuaW1hdGlvbjogZmxvYXRVcCAwLjhzIGVhc2Utb3V0IGZvcndhcmRzOwp9CgovKiAtLS0gTU9CSUxFIFBPUlRSQUlUIE9QVElNSVpBVElPTlMgLS0tICovCkBtZWRpYSBzY3JlZW4gYW5kIChvcmllbnRhdGlvbjogcG9ydHJhaXQpIHsKICAgIC50ZWFtLXdpbmcgeyB3aWR0aDogODBweDsgcGFkZGluZzogMCA1cHg7IH0KICAgIC5zY29yZS1ib3ggeyBmb250LXNpemU6IDI0cHg7IG1hcmdpbjogMCAycHg7IG1pbi13aWR0aDogMjBweDsgfQogICAgLnRlYW0tbmFtZSB7IGZvbnQtc2l6ZTogMTBweDsgbGV0dGVyLXNwYWNpbmc6IDBweDsgfQogICAgLnRlYW0tc3ViIHsgZGlzcGxheTogbm9uZTsgfQogICAgCiAgICAudGltZXItY3J5c3RhbC1yaW5nIHsgd2lkdGg6IDcwcHg7IGhlaWdodDogMzVweDsgdG9wOiAtMTBweDsgfQogICAgI3RpbWVyLWRpc3BsYXkgeyBmb250LXNpemU6IDI0cHg7IH0KICAgICNoYWxmLWluZGljYXRvciB7IGZvbnQtc2l6ZTogMTBweDsgbGV0dGVyLXNwYWNpbmc6IDFweDsgfQogICAgCiAgICAjbWluaW1hcC1jb250YWluZXIgeyB3aWR0aDogODBweDsgaGVpZ2h0OiA4MHB4OyB0b3A6IG1heCg2MHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXRvcCkgKyA1MHB4KTsgfQogICAgI21pbmltYXAgeyB3aWR0aDogNzBweDsgaGVpZ2h0OiA3MHB4OyB9CiAgICAucmFkYXItbGFiZWwgeyBmb250LXNpemU6IDhweDsgYm90dG9tOiAtMTBweDsgfQogICAgCiAgICAudGVjaC10ZXh0IHsgZm9udC1zaXplOiAyNHB4OyB9CiAgICAKICAgICNhY3Rpb24tYnV0dG9uIHsgd2lkdGg6IDcwcHg7IGhlaWdodDogNzBweDsgfQogICAgI2FjdGlvbi1idXR0b24gLmJ0bi10ZXh0IHsgZm9udC1zaXplOiAxNnB4OyB9CiAgICAuY29tbWFuZC1yaW5nIHsgd2lkdGg6IDkwcHg7IGhlaWdodDogOTBweDsgfQogICAgI2FjdGlvbi1sYWJlbCB7IGZvbnQtc2l6ZTogMTBweDsgcGFkZGluZzogMnB4IDhweDsgbWFyZ2luLWJvdHRvbTogMTBweDsgfQogICAgCiAgICAjcGxheWVyLXN0YXR1cy1wYW5lbCB7IHdpZHRoOiAxMjBweDsgYm90dG9tOiBtYXgoMTIwcHgsIGVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tKSArIDEwcHgpOyBsZWZ0OiAxMHB4OyB9CiAgICAuY2hhci1uYW1lIHsgZm9udC1zaXplOiAxMnB4OyB9CiAgICAuaHAtdmFsdWUgeyBmb250LXNpemU6IDhweDsgfQogICAgCiAgICAjYXV0by10b2dnbGUsICNzZXR0aW5ncy1idXR0b24sICNwcmFjdGljZS1yZXN0b3JlLWJ0biB7CiAgICAgICAgd2lkdGg6IDgwcHg7CiAgICAgICAgZm9udC1zaXplOiA4cHg7CiAgICAgICAgcmlnaHQ6IG1heCgxMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LXJpZ2h0KSk7CiAgICAgICAgcGFkZGluZzogNnB4IDA7CiAgICB9CiAgICAKICAgICNnb2FsLWRpc3RhbmNlLWNvbnRhaW5lciB7IGxlZnQ6IG1heCgxMHB4LCBlbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQpKTsgdG9wOiBtYXgoNjBweCwgZW52KHNhZmUtYXJlYS1pbnNldC10b3ApICsgNDVweCk7IH0KICAgICNnb2FsLWRpc3RhbmNlIHsgZm9udC1zaXplOiAxNnB4OyB9CiAgICAKICAgIC8qIEZpeCBBbm5vdW5jZW1lbnQgVGV4dCBDdXRvZmYgKi8KICAgICNhbm5vdW5jZW1lbnQgewogICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMzJweCwgMTB2dywgNjBweCk7CiAgICAgICAgd2lkdGg6IDk1JTsKICAgICAgICBsZWZ0OiAyLjUlOwogICAgICAgIHdoaXRlLXNwYWNlOiBub3JtYWw7CiAgICAgICAgd29yZC13cmFwOiBicmVhay13b3JkOwogICAgICAgIGxpbmUtaGVpZ2h0OiAxLjE7CiAgICB9CiAgICAuYW5ub3VuY2VtZW50LXNsYW0gewogICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoNDhweCwgMTV2dywgODBweCkgIWltcG9ydGFudDsKICAgICAgICB3aGl0ZS1zcGFjZTogbm9ybWFsICFpbXBvcnRhbnQ7CiAgICB9CgogICAgLyogTWVudSBBZGp1c3RtZW50cyAqLwogICAgLmZmeC1sb2dvLW1haW4geyBmb250LXNpemU6IGNsYW1wKDM2cHgsIDEydncsIDYwcHgpOyBsZXR0ZXItc3BhY2luZzogNHB4OyB9CiAgICAuZmZ4LWxvZ28tc3ViIHsgZm9udC1zaXplOiBjbGFtcCgxMnB4LCA0dncsIDE4cHgpOyBsZXR0ZXItc3BhY2luZzogOHB4OyB9CiAgICAubWVudS1vcHRpb25zIHsgd2lkdGg6IDI2MHB4OyB9CiAgICAubWVudS1pdGVtIHsgcGFkZGluZzogMTBweCAyMHB4OyB9CiAgICAubWVudS1pdGVtIC5sYWJlbCB7IGZvbnQtc2l6ZTogMTZweDsgfQp9Ci8qIC0tLSBHRVNUVVJFIEhJTlQgLS0tICovCiNnZXN0dXJlLWhpbnQgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiA1MCU7IGxlZnQ6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgd2lkdGg6IDIwMHB4OyBoZWlnaHQ6IDMwMHB4OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgei1pbmRleDogMjUwMDsKICAgIG9wYWNpdHk6IDAuOTsKfQoKI2dlc3R1cmUtaGludC5hY3RpdmUgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7Cn0KCi5jdXJ2ZS1hcnJvdyB7CiAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCA1cHggIzAwZmZmZik7CiAgICBhbmltYXRpb246IGRhc2hEcmF3IDEuNXMgbGluZWFyIGluZmluaXRlOwp9CgpAa2V5ZnJhbWVzIGRhc2hEcmF3IHsKICAgIHRvIHsgc3Ryb2tlLWRhc2hvZmZzZXQ6IC0zMDsgfQp9CgouZ2VzdHVyZS10ZXh0IHsKICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1mb250LWRhdGEpOwogICAgZm9udC1zaXplOiAyNHB4OwogICAgY29sb3I6ICNmZmZmZmY7CiAgICB0ZXh0LXNoYWRvdzogMCAwIDEwcHggIzAwZmZmZjsKICAgIG1hcmdpbi10b3A6IC01MHB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCi5nZXN0dXJlLWhhbmQgewogICAgZm9udC1zaXplOiA0OHB4OwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgYm90dG9tOiAyMHB4OwogICAgbGVmdDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgYW5pbWF0aW9uOiBoYW5kU3dpcGUgMS41cyBlYXNlLWluLW91dCBpbmZpbml0ZTsKICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDEwcHggYmxhY2spOwp9CgpAa2V5ZnJhbWVzIGhhbmRTd2lwZSB7CiAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIDUwcHgpIHJvdGF0ZSgwZGVnKTsgb3BhY2l0eTogMDsgfQogICAgMjAlIHsgb3BhY2l0eTogMTsgfQogICAgODAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMjBweCwgLTEwMHB4KSByb3RhdGUoMjBkZWcpOyBvcGFjaXR5OiAxOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMHB4LCAtMTIwcHgpIHJvdGF0ZSgxMGRlZyk7IG9wYWNpdHk6IDA7IH0KfQoKLyogLS0tIFNXSVBFIFRSQUlMIChJTlRVSVRJVkUgRkVFREJBQ0spIC0tLSAqLwouc3dpcGUtdHJhaWwtZG90IHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiAxMnB4OwogICAgaGVpZ2h0OiAxMnB4OwogICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgIzAwZmZmZiAwJSwgcmdiYSgwLCAyNTUsIDI1NSwgMCkgNzAlKTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogOTAwMDsKICAgIGFuaW1hdGlvbjogZmFkZVRyYWlsIDAuNXMgbGluZWFyIGZvcndhcmRzOwogICAgbWl4LWJsZW5kLW1vZGU6IHNjcmVlbjsKICAgIHdpbGwtY2hhbmdlOiB0cmFuc2Zvcm0sIG9wYWNpdHk7Cn0KCkBrZXlmcmFtZXMgZmFkZVRyYWlsIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC4yKTsgb3BhY2l0eTogMDsgfQp9CkBrZXlmcmFtZXMgZmFkZVRyYWlsIHsKICAgIDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgb3BhY2l0eTogMTsgfQogICAgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMC4yKTsgb3BhY2l0eTogMDsgfQp9CgovKiAtLS0gT0ZGU0NSRUVOIElORElDQVRPUiAtLS0gKi8KI29mZnNjcmVlbi1pbmRpY2F0b3IgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOyBsZWZ0OiAwOwogICAgd2lkdGg6IDQwcHg7IGhlaWdodDogNDBweDsKICAgIG1hcmdpbi1sZWZ0OiAtMjBweDsgbWFyZ2luLXRvcDogLTIwcHg7CiAgICB6LWluZGV4OiAxNTAwOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICBkaXNwbGF5OiBub25lOwogICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgNXB4ICMwMDApOwp9Cgojb2Zmc2NyZWVuLWluZGljYXRvciAuYXJyb3cgewogICAgd2lkdGg6IDA7IGhlaWdodDogMDsKICAgIGJvcmRlci1sZWZ0OiAxNXB4IHNvbGlkIHRyYW5zcGFyZW50OwogICAgYm9yZGVyLXJpZ2h0OiAxNXB4IHNvbGlkIHRyYW5zcGFyZW50OwogICAgYm9yZGVyLWJvdHRvbTogMjVweCBzb2xpZCAjMDBmZjAwOyAvKiBHcmVlbiBmb3IgcGxheWVyICovCiAgICBhbmltYXRpb246IHB1bHNlQXJyb3cgMC41cyBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICB0cmFuc2Zvcm0tb3JpZ2luOiBjZW50ZXIgYm90dG9tOwp9CgpAa2V5ZnJhbWVzIHB1bHNlQXJyb3cgewogICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IGZpbHRlcjogYnJpZ2h0bmVzcygxKTsgfQogICAgdG8geyB0cmFuc2Zvcm06IHNjYWxlKDEuMik7IGZpbHRlcjogYnJpZ2h0bmVzcygxLjUpOyB9Cn0=","AssetLoader.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfbG9hZGVyID0gbmV3IFRIUkVFLkdMVEZMb2FkZXIoKTsKCiAgICAvLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQovLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQogICAgZnVuY3Rpb24gY29udmVydE1hdGVyaWFsKG9sZE1hdCwgaXNTa2lubmVkKSB7CiAgICAgICAgCiAgICAgICAgLy8gUHJlc2VydmUgdGV4dHVyZTogQ2hlY2sgbWFwLCB0aGVuIGVtaXNzaXZlTWFwCiAgICAgICAgY29uc3QgdGV4dHVyZSA9IG9sZE1hdC5tYXAgfHwgb2xkTWF0LmVtaXNzaXZlTWFwIHx8IG51bGw7CgogICAgICAgIC8vIEZPUkNFIE9QQVFVRSBWSVNJQklMSVRZCiAgICAgICAgLy8gV2Ugb3ZlcnJpZGUgdHJhbnNwYXJlbmN5IHRvIGVuc3VyZSBtb2RlbHMgYXJlIGFsd2F5cyB2aXNpYmxlIChmaXhpbmcgdGhlICJpbnZpc2libGUgbW9kZWwiIGlzc3VlKS4KICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIG1hcDogdGV4dHVyZSwKICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAgICAgICAgLy8gRk9SQ0UgV0hJVEU6IFJlbW92ZSBhbnkgdGludCBmcm9tIEdMVEYKICAgICAgICAgICAgc2tpbm5pbmc6IGlzU2tpbm5lZCwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgLy8gUmVuZGVyIGJvdGggc2lkZXMgdG8gcHJldmVudCBiYWNrZmFjZSBjdWxsaW5nIGludmlzaWJpbGl0eQogICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsICAgICAvLyBEaXNhYmxlIHRyYW5zcGFyZW5jeSB0byBwcmV2ZW50IHNvcnRpbmcgaXNzdWVzCiAgICAgICAgICAgIG9wYWNpdHk6IDEuMCwgICAgICAgICAgIC8vIEZvcmNlIGZ1bGwgb3BhY2l0eQogICAgICAgICAgICBhbHBoYVRlc3Q6IDAuNSwgICAgICAgICAvLyBTdHJvbmcgYWxwaGEgdGVzdCBmb3IgY3V0b3V0cyAobmV0cy9ncmF0ZXMpCiAgICAgICAgICAgIHZlcnRleENvbG9yczogb2xkTWF0LnZlcnRleENvbG9ycywgLy8gUHJlc2VydmUgdmVydGV4IGNvbG9ycwogICAgICAgICAgICBkZXB0aFRlc3Q6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IHRydWUsICAgICAgIC8vIEZvcmNlIGRlcHRoIHdyaXRlIHNvIGl0IG9jY2x1ZGVzIHByb3Blcmx5CiAgICAgICAgICAgIGZvZzogdHJ1ZQogICAgICAgIH07CgogICAgICAgIC8vIEVuc3VyZSB0ZXh0dXJlIGVuY29kaW5nIGlzIGNvcnJlY3QgZm9yIFRocmVlLmpzCiAgICAgICAgaWYgKHBhcmFtcy5tYXApIHBhcmFtcy5tYXAuZW5jb2RpbmcgPSBUSFJFRS5zUkdCRW5jb2Rpbmc7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwocGFyYW1zKTsKICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlciA9IHsKICAgICAgICBsb2FkTW9kZWw6IGZ1bmN0aW9uKHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yKSB7CiAgICAgICAgICAgIF9sb2FkZXIubG9hZCh1cmwsIGZ1bmN0aW9uKGdsdGYpIHsKICAgICAgICAgICAgICAgIGdsdGYuc2NlbmUudHJhdmVyc2UoZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCkgewpub2RlLmNhc3RTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBQcmV2ZW50IGludmlzaWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZS5tYXRlcmlhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gbm9kZS5tYXRlcmlhbC5tYXAobSA9PiBjb252ZXJ0TWF0ZXJpYWwobSwgbm9kZS5pc1NraW5uZWRNZXNoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBjb252ZXJ0TWF0ZXJpYWwobm9kZS5tYXRlcmlhbCwgbm9kZS5pc1NraW5uZWRNZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKG9uTG9hZCkgb25Mb2FkKGdsdGYpOwogICAgICAgICAgICB9LCBvblByb2dyZXNzLCBvbkVycm9yKTsKICAgICAgICB9CiAgICB9Owp9KSgpOw==","./AssetLoader.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfbG9hZGVyID0gbmV3IFRIUkVFLkdMVEZMb2FkZXIoKTsKCiAgICAvLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQovLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQogICAgZnVuY3Rpb24gY29udmVydE1hdGVyaWFsKG9sZE1hdCwgaXNTa2lubmVkKSB7CiAgICAgICAgCiAgICAgICAgLy8gUHJlc2VydmUgdGV4dHVyZTogQ2hlY2sgbWFwLCB0aGVuIGVtaXNzaXZlTWFwCiAgICAgICAgY29uc3QgdGV4dHVyZSA9IG9sZE1hdC5tYXAgfHwgb2xkTWF0LmVtaXNzaXZlTWFwIHx8IG51bGw7CgogICAgICAgIC8vIEZPUkNFIE9QQVFVRSBWSVNJQklMSVRZCiAgICAgICAgLy8gV2Ugb3ZlcnJpZGUgdHJhbnNwYXJlbmN5IHRvIGVuc3VyZSBtb2RlbHMgYXJlIGFsd2F5cyB2aXNpYmxlIChmaXhpbmcgdGhlICJpbnZpc2libGUgbW9kZWwiIGlzc3VlKS4KICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIG1hcDogdGV4dHVyZSwKICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAgICAgICAgLy8gRk9SQ0UgV0hJVEU6IFJlbW92ZSBhbnkgdGludCBmcm9tIEdMVEYKICAgICAgICAgICAgc2tpbm5pbmc6IGlzU2tpbm5lZCwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgLy8gUmVuZGVyIGJvdGggc2lkZXMgdG8gcHJldmVudCBiYWNrZmFjZSBjdWxsaW5nIGludmlzaWJpbGl0eQogICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsICAgICAvLyBEaXNhYmxlIHRyYW5zcGFyZW5jeSB0byBwcmV2ZW50IHNvcnRpbmcgaXNzdWVzCiAgICAgICAgICAgIG9wYWNpdHk6IDEuMCwgICAgICAgICAgIC8vIEZvcmNlIGZ1bGwgb3BhY2l0eQogICAgICAgICAgICBhbHBoYVRlc3Q6IDAuNSwgICAgICAgICAvLyBTdHJvbmcgYWxwaGEgdGVzdCBmb3IgY3V0b3V0cyAobmV0cy9ncmF0ZXMpCiAgICAgICAgICAgIHZlcnRleENvbG9yczogb2xkTWF0LnZlcnRleENvbG9ycywgLy8gUHJlc2VydmUgdmVydGV4IGNvbG9ycwogICAgICAgICAgICBkZXB0aFRlc3Q6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IHRydWUsICAgICAgIC8vIEZvcmNlIGRlcHRoIHdyaXRlIHNvIGl0IG9jY2x1ZGVzIHByb3Blcmx5CiAgICAgICAgICAgIGZvZzogdHJ1ZQogICAgICAgIH07CgogICAgICAgIC8vIEVuc3VyZSB0ZXh0dXJlIGVuY29kaW5nIGlzIGNvcnJlY3QgZm9yIFRocmVlLmpzCiAgICAgICAgaWYgKHBhcmFtcy5tYXApIHBhcmFtcy5tYXAuZW5jb2RpbmcgPSBUSFJFRS5zUkdCRW5jb2Rpbmc7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwocGFyYW1zKTsKICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlciA9IHsKICAgICAgICBsb2FkTW9kZWw6IGZ1bmN0aW9uKHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yKSB7CiAgICAgICAgICAgIF9sb2FkZXIubG9hZCh1cmwsIGZ1bmN0aW9uKGdsdGYpIHsKICAgICAgICAgICAgICAgIGdsdGYuc2NlbmUudHJhdmVyc2UoZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCkgewpub2RlLmNhc3RTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBQcmV2ZW50IGludmlzaWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZS5tYXRlcmlhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gbm9kZS5tYXRlcmlhbC5tYXAobSA9PiBjb252ZXJ0TWF0ZXJpYWwobSwgbm9kZS5pc1NraW5uZWRNZXNoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBjb252ZXJ0TWF0ZXJpYWwobm9kZS5tYXRlcmlhbCwgbm9kZS5pc1NraW5uZWRNZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKG9uTG9hZCkgb25Mb2FkKGdsdGYpOwogICAgICAgICAgICB9LCBvblByb2dyZXNzLCBvbkVycm9yKTsKICAgICAgICB9CiAgICB9Owp9KSgpOw==","/AssetLoader.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjb25zdCBfbG9hZGVyID0gbmV3IFRIUkVFLkdMVEZMb2FkZXIoKTsKCiAgICAvLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQovLyBIZWxwZXIgdG8gY29udmVydCBhIHNpbmdsZSBtYXRlcmlhbCB0byBCYXNpYyAoVW5saXQvUFNYKQogICAgZnVuY3Rpb24gY29udmVydE1hdGVyaWFsKG9sZE1hdCwgaXNTa2lubmVkKSB7CiAgICAgICAgCiAgICAgICAgLy8gUHJlc2VydmUgdGV4dHVyZTogQ2hlY2sgbWFwLCB0aGVuIGVtaXNzaXZlTWFwCiAgICAgICAgY29uc3QgdGV4dHVyZSA9IG9sZE1hdC5tYXAgfHwgb2xkTWF0LmVtaXNzaXZlTWFwIHx8IG51bGw7CgogICAgICAgIC8vIEZPUkNFIE9QQVFVRSBWSVNJQklMSVRZCiAgICAgICAgLy8gV2Ugb3ZlcnJpZGUgdHJhbnNwYXJlbmN5IHRvIGVuc3VyZSBtb2RlbHMgYXJlIGFsd2F5cyB2aXNpYmxlIChmaXhpbmcgdGhlICJpbnZpc2libGUgbW9kZWwiIGlzc3VlKS4KICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIG1hcDogdGV4dHVyZSwKICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAgICAgICAgLy8gRk9SQ0UgV0hJVEU6IFJlbW92ZSBhbnkgdGludCBmcm9tIEdMVEYKICAgICAgICAgICAgc2tpbm5pbmc6IGlzU2tpbm5lZCwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgLy8gUmVuZGVyIGJvdGggc2lkZXMgdG8gcHJldmVudCBiYWNrZmFjZSBjdWxsaW5nIGludmlzaWJpbGl0eQogICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsICAgICAvLyBEaXNhYmxlIHRyYW5zcGFyZW5jeSB0byBwcmV2ZW50IHNvcnRpbmcgaXNzdWVzCiAgICAgICAgICAgIG9wYWNpdHk6IDEuMCwgICAgICAgICAgIC8vIEZvcmNlIGZ1bGwgb3BhY2l0eQogICAgICAgICAgICBhbHBoYVRlc3Q6IDAuNSwgICAgICAgICAvLyBTdHJvbmcgYWxwaGEgdGVzdCBmb3IgY3V0b3V0cyAobmV0cy9ncmF0ZXMpCiAgICAgICAgICAgIHZlcnRleENvbG9yczogb2xkTWF0LnZlcnRleENvbG9ycywgLy8gUHJlc2VydmUgdmVydGV4IGNvbG9ycwogICAgICAgICAgICBkZXB0aFRlc3Q6IHRydWUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IHRydWUsICAgICAgIC8vIEZvcmNlIGRlcHRoIHdyaXRlIHNvIGl0IG9jY2x1ZGVzIHByb3Blcmx5CiAgICAgICAgICAgIGZvZzogdHJ1ZQogICAgICAgIH07CgogICAgICAgIC8vIEVuc3VyZSB0ZXh0dXJlIGVuY29kaW5nIGlzIGNvcnJlY3QgZm9yIFRocmVlLmpzCiAgICAgICAgaWYgKHBhcmFtcy5tYXApIHBhcmFtcy5tYXAuZW5jb2RpbmcgPSBUSFJFRS5zUkdCRW5jb2Rpbmc7CgogICAgICAgIHJldHVybiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwocGFyYW1zKTsKICAgIH0KCiAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlciA9IHsKICAgICAgICBsb2FkTW9kZWw6IGZ1bmN0aW9uKHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yKSB7CiAgICAgICAgICAgIF9sb2FkZXIubG9hZCh1cmwsIGZ1bmN0aW9uKGdsdGYpIHsKICAgICAgICAgICAgICAgIGdsdGYuc2NlbmUudHJhdmVyc2UoZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCkgewpub2RlLmNhc3RTaGFkb3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOyAvLyBQcmV2ZW50IGludmlzaWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZS5tYXRlcmlhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1hdGVyaWFsID0gbm9kZS5tYXRlcmlhbC5tYXAobSA9PiBjb252ZXJ0TWF0ZXJpYWwobSwgbm9kZS5pc1NraW5uZWRNZXNoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBjb252ZXJ0TWF0ZXJpYWwobm9kZS5tYXRlcmlhbCwgbm9kZS5pc1NraW5uZWRNZXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKG9uTG9hZCkgb25Mb2FkKGdsdGYpOwogICAgICAgICAgICB9LCBvblByb2dyZXNzLCBvbkVycm9yKTsKICAgICAgICB9CiAgICB9Owp9KSgpOw==","Player.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBCYWxsIExhYiAvIERldlRvb2xzOiB0aHJvdyAmIGN1cnZlIG1hcHBpbmcga25vYnMKICAgIC8vIChEZWZhdWx0cyBtYXRjaCBjdXJyZW50IGZlZWw7IERldlRvb2xzIGNhbiB0d2VhayBhdCBydW50aW1lLikKICAgIHdpbmRvdy5mbHV4LlRocm93Q29uZmlnID0gd2luZG93LmZsdXguVGhyb3dDb25maWcgfHwgewogICAgICAgIFNXSVBFX01JTl9QWDogMjAsCiAgICAgICAgQUlNX0RYX1NDQUxFOiAxLjAsCiAgICAgICAgQUlNX0RZX1NDQUxFOiAxLjAsCgogICAgICAgIFBPV0VSX0JBU0U6IDEuMCwKICAgICAgICBQT1dFUl9SQU5HRTogMC44LCAgICAgICAgICAvLyBCYXNlIG11bHRpcGxpZXIgPSBQT1dFUl9CQVNFICsgcmF0aW8qUE9XRVJfUkFOR0UKICAgICAgICBQT1dFUl9NQVhfQk9OVVNfUkFUSU86IDAuOTUsCiAgICAgICAgUE9XRVJfTUFYX01VTFRJUExJRVI6IDIuNSwKCiAgICAgICAgQ1VSVkVfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBDVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEOiAwLjI1LAogICAgICAgIENVUlZFX1NQSU5fU0NBTEU6IDEwMDAuMCwKICAgICAgICBDVVJWRV9TUEVFRF9NVUxUOiAxLjUsCiAgICAgICAgQ1VSVkVfU1BJTl9DQVA6IDE1MDAuMCwKICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDUwMC4wCiAgICB9OwoKLy8gUmV1c2FibGUgbWF0aCBvYmplY3RzCmNvbnN0IF9wVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9wVmVjMiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfcFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BRdWF0MiA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRhcmdldFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BFdWxlciA9IG5ldyBUSFJFRS5FdWxlcigpOwogICAgY29uc3QgX3BBeGlzWSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApOwogICAgY29uc3QgX3BBeGlzWiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpOwogICAgY29uc3QgX3BJbnZRdWF0ID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgIGNvbnN0IF9wVG1wUXVhdCA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRtcEV1bGVyID0gbmV3IFRIUkVFLkV1bGVyKCk7CgoKY2xhc3MgUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSA9ICdNRicpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLnJvbGUgPSByb2xlOwogICAgICAgICAgICB0aGlzLnRlYW0gPSBudWxsOyAvLyBBc3NpZ25lZCBieSBUZWFtLmFkZFBsYXllcgogICAgICAgICAgICB0aGlzLmhvbWVQb3NpdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLm1peGVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hY3Rpb25zID0ge307CiAgICAgICAgICAgIHRoaXMuYWN0aXZlQWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdpZGxlJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2xhc3RMb2NvbW90aW9uID0gJ2lkbGUnOwp0aGlzLmlucHV0VmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAvLyBQaHlzaWNzIChEcmlmdC9JbmVydGlhIE1vZGVsKQogICAgICAgICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYWNjZWxlcmF0aW9uID0gMTIuMDsKICAgICAgICAgICAgdGhpcy5kcmFnID0gMy4wOwogICAgICAgICAgICB0aGlzLm1heFNwZWVkID0gOC4wOwogICAgICAgICAgICAvLyBCb25lIHJlZmVyZW5jZSBmb3IgaG9sZGluZyBiYWxsCiAgICAgICAgICAgIHRoaXMuaGFuZEJvbmUgPSBudWxsOwovLyBQcm9jZWR1cmFsIGFuaW1hdGlvbiBib25lIHJlZnMgKGZpbGxlZCBpbiBzZXRNZXNoKQp0aGlzLmJvbmVzID0gewogICAgaGlwczogbnVsbCwKICAgIHNwaW5lOiBudWxsLAogICAgY2hlc3Q6IG51bGwsCiAgICBuZWNrOiBudWxsLAogICAgaGVhZDogbnVsbCwKICAgIHJVcHBlckFybTogbnVsbCwKICAgIHJGb3JlQXJtOiBudWxsLAogICAgckhhbmQ6IG51bGwsCiAgICBsVXBwZXJBcm06IG51bGwsCiAgICBsRm9yZUFybTogbnVsbCwKICAgIGxIYW5kOiBudWxsCn07CnRoaXMuX2JvbmVCYXNlUXVhdHMgPSBudWxsOyAvLyBPcHRpb25hbCBmdXR1cmUgdXNlCnRoaXMuX3Byb2NBbmltVGltZSA9IDA7CnRoaXMuX3Ntb290aGVkU3BlZWQgPSAwOwp0aGlzLl9tb3ZpbmdMYXRjaCA9IGZhbHNlOwoKdGhpcy5jYW5DYXRjaCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2F0Y2hDb29sZG93biA9IDA7IC8vIFJlcGxhY2VzIHNldFRpbWVvdXQgZm9yIHNhZmV0eQoKICAgICAgICAgICAgLy8gQmxpdHpiYWxsIFN0YXRzCiAgICAgICAgICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLAogICAgICAgICAgICAgICAgbWF4SFA6IDEwMCwKICAgICAgICAgICAgICAgIEVOOiAzMCwKICAgICAgICAgICAgICAgIEFUOiAxMCwKICAgICAgICAgICAgICAgIFBBOiAxNSwKICAgICAgICAgICAgICAgIEJMOiAxMCwKICAgICAgICAgICAgICAgIFNIOiAxNSwKICAgICAgICAgICAgICAgIENBOiAxMCwKICAgICAgICAgICAgICAgIFNQOiA2MAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gTGV2ZWxpbmcgU3lzdGVtCiAgICAgICAgICAgIHRoaXMubGV2ZWwgPSAxOwogICAgICAgICAgICB0aGlzLmV4cCA9IDA7CiAgICAgICAgICAgIHRoaXMubmV4dExldmVsRXhwID0gMTAwOwoKICAgICAgICAgICAgLy8gU3RhdHVzIEVmZmVjdHMgJiBUZWNobmlxdWVzCiAgICAgICAgICAgIHRoaXMuc3RhdHVzID0gewogICAgICAgICAgICAgICAgdmVub206IDAsCiAgICAgICAgICAgICAgICBuYXA6IDAsCiAgICAgICAgICAgICAgICB3aXRoZXI6IHsgUEE6IDAsIFNIOiAwLCBBVDogMCwgQkw6IDAsIENBOiAwLCBTUDogMCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLm1hcmtpbmcgPSBudWxsOwogICAgICAgICAgICB0aGlzLmxlYXJuZWRUZWNocyA9IFtdOwoKICAgICAgICAgICAgdGhpcy50ZWNocyA9IHsKICAgICAgICAgICAgICAgIHRhY2tsZTogbnVsbCwKICAgICAgICAgICAgICAgIHNob290OiBudWxsLAogICAgICAgICAgICAgICAgcGFzczogbnVsbCwKICAgICAgICAgICAgICAgIHBhc3NpdmU6IG51bGwKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFZpc3VhbHMKICAgICAgICAgICAgdGhpcy5iYXNlQ29sb3JIZXggPSAweGZmZmZmZjsKICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscyA9IFtdOwogICAgICAgICAgICB0aGlzLmF1cmFNZXNoID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5yb3RhdGlvbk9mZnNldCA9IDA7CnRoaXMuYmFzZVNjYWxlID0gMS4xNzsgLy8gSW5jcmVhc2VkIH44JQoKICAgICAgICAgICAgLy8gUmVhbC10aW1lIFN0YXRzCiAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gdGhpcy5zdGF0cy5FTjsKdGhpcy50YWNrbGVSYWRpdXMgPSAyLjA7IC8vIFJlZHVjZWQgZnJvbSAyLjUgdG8gcmVkdWNlIHN3YXJtIGxvY2sKCiAgICAgICAgICAgIHRoaXMuc3BlZWQgPSA0LjA7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gRGFzaCBTdGF0ZQogICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5kYXNoVG90YWxUaW1lID0gMC41Owp0aGlzLmRhc2hDb29sZG93biA9IDA7CiAgICAgICAgICAgIHRoaXMuZGFzaFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBGZWVkYmFjayBBY2N1bXVsYXRvcnMKICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UgPSAwOwogICAgICAgICAgICB0aGlzLl9kYW1hZ2VUaW1lciA9IDA7CgogICAgICAgICAgICAvLyBIUCBCYXIKICAgICAgICAgICAgdGhpcy5ocEJhciA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsID0gbnVsbDsKCiAgICAgICAgICAgIC8vIEdhbWVwbGF5IEZsb3cgVGltZXJzCiAgICAgICAgICAgIHRoaXMuc3R1blRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMDsKCiAgICAgICAgICAgIC8vIEJhbmtpbmcgJiBWZXJ0aWNhbGl0eQogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLnRhcmdldFkgPSAwOwoKICAgICAgICAgICAgLy8gRW5jb3VudGVyIFN5c3RlbQogICAgICAgICAgICB0aGlzLmlzRW5nYWdlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNsYXNoVGltZXIgPSAwOwoKICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7IC8vIFRyYWNrIGR1cmF0aW9uIG9mIGN1cnJlbnQgZW5nYWdlbWVudAogICAgICAgICAgICAvLyBDaGFyZ2UgTWVjaGFuaWMKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4Q2hhcmdlVGltZSA9IDEuNTsKCiAgICAgICAgICAgIC8vIEZJWEVEOiBJbXByb3ZlZCBSb3RhdGlvbiBTdGF0ZSB3aXRoIGh5c3RlcmVzaXMKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gMDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLmxhc3RWYWxpZFlhdyA9IDA7IC8vIFN0b3JlIGxhc3Qga25vd24gZ29vZCB5YXcgZm9yIGRlYWR6b25lIGhhbmRsaW5nCiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmZhY2luZ0RlYWR6b25lID0gMC4zOyAvLyBNaW5pbXVtIGlucHV0L3ZlbG9jaXR5IG1hZ25pdHVkZSB0byB1cGRhdGUgZmFjaW5nCgogICAgICAgICAgICAvLyBQYXJ0aWNsZSBFbWlzc2lvbiBUaW1lcnMKICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMgPSB7CiAgICAgICAgICAgICAgICB2ZW5vbTogMCwKICAgICAgICAgICAgICAgIG5hcDogMCwKICAgICAgICAgICAgICAgIHdpdGhlcjogMAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gRGV2VG9vbHMgRmxhZ3MKICAgICAgICAgICAgdGhpcy5pc0dvZE1vZGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBhc3MgVGFyZ2V0IEluZGljYXRvcgovLyBQYXNzIFRhcmdldCBJbmRpY2F0b3IKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yID0gbnVsbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJ1YmJsZSBUcmFpbCBUaW1lcgogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDA7Cgp0aGlzLl9kYXNoUGFydGljbGVUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSAwOyAvLyBDb250aW51b3VzIHByZXNzdXJlIGZhY3RvciAoMC4wIHRvIDEuMCkKICAgICAgICB9CgogICAgICAgIHN5bmNSb3RhdGlvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgZXVsZXIgPSBuZXcgVEhSRUUuRXVsZXIoKS5zZXRGcm9tUXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbiwgJ1lYWicpOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgPSBldWxlci55IC0gdGhpcy5yb3RhdGlvbk9mZnNldDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgIHRoaXMubGFzdFZhbGlkWWF3ID0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ID0gMDsKICAgICAgICB9CgogICAgICAgIGdldFN0YXQobmFtZSkgewogICAgICAgICAgICBsZXQgdmFsID0gdGhpcy5zdGF0c1tuYW1lXTsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltuYW1lXSA+IDApIHsKICAgICAgICAgICAgICAgIHZhbCAqPSAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICB9CgogICAgICAgIGFwcGx5U3RhdHVzKHR5cGUsIGR1cmF0aW9uLCBzdWJUeXBlID0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMudmVub20gPiAxLjA7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy52ZW5vbSA9IE1hdGgubWF4KHRoaXMuc3RhdHVzLnZlbm9tLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnJvbGV9IHBvaXNvbmVkIWApOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQT0lTT04iLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMubmFwID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gTWF0aC5tYXgodGhpcy5zdGF0dXMubmFwLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gZmVsbCBhc2xlZXAhYCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNMRUVQIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3dpdGhlcicgJiYgc3ViVHlwZSkgewogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFZhbCA9IHRoaXMuc3RhdHVzLndpdGhlcltzdWJUeXBlXSB8fCAwOwogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gY3VycmVudFZhbCA+IDEuMDsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLndpdGhlcltzdWJUeXBlXSA9IE1hdGgubWF4KGN1cnJlbnRWYWwsIGR1cmF0aW9uKTsKCiAgICAgICAgICAgICAgICBpZiAoIXdhc0FjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gd2l0aGVyZWQgJHtzdWJUeXBlfSFgKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgV0lUSEVSICR7c3ViVHlwZX1gLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZURlcml2ZWRTdGF0cygpIHsKICAgICAgICAgICAgY29uc3Qgc3AgPSB0aGlzLmdldFN0YXQoJ1NQJyk7CiAgICAgICAgICAgIHRoaXMubWF4U3BlZWQgPSA1LjAgKyAoc3AgLyAxNS4wKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSB0aGlzLmdldFN0YXQoJ0VOJyk7CiAgICAgICAgfQoKc2V0TWVzaChzb3VyY2VNZXNoLCBhbmltYXRpb25zKSB7CiAgICAgICAgICAgIHRoaXMubWVzaCA9IHNvdXJjZU1lc2g7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUhQQmFyKCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUF1cmEoKTsKICAgICAgICAgICAgdGhpcy5fY3JlYXRlUGFzc1RhcmdldEluZGljYXRvcigpOwoKICAgICAgICAgICAgLy8gQ3VzdG9tIENoYXJhY3RlciBTY2FsaW5nCiAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUuaW5jbHVkZXMoJ1RpZHVzJykpIHRoaXMuYmFzZVNjYWxlID0gMS42OwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB0aGlzLmJhc2VTY2FsZSA9IDEuNDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXNoLnNjYWxlLnNldFNjYWxhcih0aGlzLmJhc2VTY2FsZSk7CgogICAgICAgICAgICB0aGlzLm1lc2gudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCAmJiBub2RlLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udmVydE9uZSA9IChtYXQpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXA6IG1hdC5tYXAgfHwgbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBuZXcgVEhSRUUuQ29sb3IoMHhmZmZmZmYpLCAvLyBGT1JDRSBXSElURTogSWdub3JlIHNvdXJjZSBjb2xvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6ICEhbWF0LnRyYW5zcGFyZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogKG1hdC5vcGFjaXR5ICE9PSB1bmRlZmluZWQgPyBtYXQub3BhY2l0eSA6IDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxwaGFUZXN0OiAobWF0LmFscGhhVGVzdCAhPT0gdW5kZWZpbmVkID8gbWF0LmFscGhhVGVzdCA6IDApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2lkZTogbWF0LnNpZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IG1hdC5kZXB0aFRlc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBtYXQuZGVwdGhXcml0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNraW5uaW5nOiAhIW5vZGUuaXNTa2lubmVkTWVzaAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5wdXNoKHsgbWF0ZXJpYWw6IG0sIGJhc2VDb2xvcjogbS5jb2xvci5jbG9uZSgpIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBBcnJheS5pc0FycmF5KG5vZGUubWF0ZXJpYWwpCiAgICAgICAgICAgICAgICAgICAgICAgID8gbm9kZS5tYXRlcmlhbC5tYXAoY29udmVydE9uZSkKICAgICAgICAgICAgICAgICAgICAgICAgOiBjb252ZXJ0T25lKG5vZGUubWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzQm9uZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSAobm9kZS5uYW1lIHx8ICcnKS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBDb3JlIHNwaW5lL2hlYWQgY2hhaW4gKE1peGFtby1mcmllbmRseSkKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuaGlwcyAmJiBuYW1lLmluY2x1ZGVzKCdoaXBzJykpIHRoaXMuYm9uZXMuaGlwcyA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLnNwaW5lICYmIG5hbWUuaW5jbHVkZXMoJ3NwaW5lJykgJiYgIW5hbWUuaW5jbHVkZXMoJ3NwaW5lMicpICYmICFuYW1lLmluY2x1ZGVzKCdzcGluZV8yJykpIHRoaXMuYm9uZXMuc3BpbmUgPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5jaGVzdCAmJiAobmFtZS5pbmNsdWRlcygnY2hlc3QnKSB8fCBuYW1lLmluY2x1ZGVzKCdzcGluZTInKSB8fCBuYW1lLmluY2x1ZGVzKCdzcGluZV8yJykpKSB0aGlzLmJvbmVzLmNoZXN0ID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubmVjayAmJiBuYW1lLmluY2x1ZGVzKCduZWNrJykpIHRoaXMuYm9uZXMubmVjayA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmhlYWQgJiYgbmFtZS5pbmNsdWRlcygnaGVhZCcpKSB0aGlzLmJvbmVzLmhlYWQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1JpZ2h0ID0gbmFtZS5pbmNsdWRlcygncmlnaHQnKSB8fCBuYW1lLmVuZHNXaXRoKCdyJykgfHwgbmFtZS5pbmNsdWRlcygnX3InKSB8fCBuYW1lLmluY2x1ZGVzKCcucicpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzTGVmdCAgPSBuYW1lLmluY2x1ZGVzKCdsZWZ0JykgIHx8IG5hbWUuZW5kc1dpdGgoJ2wnKSB8fCBuYW1lLmluY2x1ZGVzKCdfbCcpIHx8IG5hbWUuaW5jbHVkZXMoJy5sJyk7CgogICAgICAgICAgICAgICAgICAgIC8vIEFybXMvaGFuZHMgKE1peGFtbzogbWl4YW1vcmlnUmlnaHRBcm0vUmlnaHRGb3JlQXJtL1JpZ2h0SGFuZCkKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuclVwcGVyQXJtICYmIChuYW1lLmluY2x1ZGVzKCdyaWdodGFybScpIHx8IChpc1JpZ2h0ICYmIG5hbWUuaW5jbHVkZXMoJ3VwcGVyYXJtJykpKSkgdGhpcy5ib25lcy5yVXBwZXJBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5yRm9yZUFybSAmJiAobmFtZS5pbmNsdWRlcygncmlnaHRmb3JlYXJtJykgfHwgKGlzUmlnaHQgJiYgbmFtZS5pbmNsdWRlcygnZm9yZWFybScpKSkpIHRoaXMuYm9uZXMuckZvcmVBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5ySGFuZCAmJiAoKG5hbWUuaW5jbHVkZXMoJ2hhbmQnKSAmJiBpc1JpZ2h0KSB8fCBuYW1lLmluY2x1ZGVzKCdyaWdodGhhbmQnKSkpIHRoaXMuYm9uZXMuckhhbmQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubFVwcGVyQXJtICYmIChuYW1lLmluY2x1ZGVzKCdsZWZ0YXJtJykgfHwgKGlzTGVmdCAmJiBuYW1lLmluY2x1ZGVzKCd1cHBlcmFybScpKSkpIHRoaXMuYm9uZXMubFVwcGVyQXJtID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubEZvcmVBcm0gJiYgKG5hbWUuaW5jbHVkZXMoJ2xlZnRmb3JlYXJtJykgfHwgKGlzTGVmdCAmJiBuYW1lLmluY2x1ZGVzKCdmb3JlYXJtJykpKSkgdGhpcy5ib25lcy5sRm9yZUFybSA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmxIYW5kICYmICgobmFtZS5pbmNsdWRlcygnaGFuZCcpICYmIGlzTGVmdCkgfHwgbmFtZS5pbmNsdWRlcygnbGVmdGhhbmQnKSkpIHRoaXMuYm9uZXMubEhhbmQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICAvLyBCYWNrLWNvbXBhdDogYmFsbCBhdHRhY2htZW50IHVzZXMgaGFuZEJvbmUKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaGFuZEJvbmUgJiYgdGhpcy5ib25lcy5ySGFuZCkgdGhpcy5oYW5kQm9uZSA9IHRoaXMuYm9uZXMuckhhbmQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5taXhlciA9IG5ldyBUSFJFRS5BbmltYXRpb25NaXhlcih0aGlzLm1lc2gpOwoKICAgICAgICAgICAgaWYgKGFuaW1hdGlvbnMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IF9ub3JtQ2xpcE5hbWUgPSAocykgPT4gKHMgfHwgJycpCiAgICAgICAgICAgICAgICAgICAgLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvW19cLV0rL2csICcgJykKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXHMrL2csICcgJykKICAgICAgICAgICAgICAgICAgICAudHJpbSgpOwoKICAgICAgICAgICAgICAgIC8vIEhlbHBlciB0byBzdHJpcCBsZWcgdHJhY2tzIGZyb20gYWN0aW9uIGNsaXBzCiAgICAgICAgICAgICAgICBjb25zdCBfc3RyaXBMZWdzID0gKGNsaXApID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFja3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICBjbGlwLnRyYWNrcy5mb3JFYWNoKHQgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZWdleCB0byBtYXRjaCBsZWcgYm9uZXMgKE1peGFtbyBzdHlsZTogUmlnaHRVcExlZywgUmlnaHRMZWcsIFJpZ2h0Rm9vdCwgUmlnaHRUb2VCYXNlKQogICAgICAgICAgICAgICAgICAgICAgICAvLyBBbHNvIGdlbmVyaWMgIkxlZyIsICJGb290IgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXQubmFtZS5tYXRjaCgvKFVwTGVnfExlZ3xGb290fFRvZSkvaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYWNrcy5wdXNoKHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgY2xpcC50cmFja3MgPSB0cmFja3M7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNsaXA7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGFuaW1hdGlvbnMuZm9yRWFjaCgoY2xpcCkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBfbm9ybUNsaXBOYW1lKGNsaXAubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzID0gKHJlKSA9PiByZS50ZXN0KG5hbWUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxldCBpc0xvY29tb3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBsZXQgYWN0aW9uS2V5ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIENvcmUgbG9jb21vdGlvbiAtLS0KICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC90cmVhZHx0cmVhZGluZ3xpZGxlfGZsb2F0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2lkbGUnOwogICAgICAgICAgICAgICAgICAgICAgICBpc0xvY29tb3Rpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9kYXNofHNwcmludHxidXJzdHxmYXN0XHMqc3dpbXxzd2ltXHMqZmFzdC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdkYXNoJzsKICAgICAgICAgICAgICAgICAgICAgICAgaXNMb2NvbW90aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvc3dpbXxmcmVlc3R5bGV8Y3Jhd2wvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAnc3dpbSc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzTG9jb21vdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIFRocm93aW5nIChwYXNzL3Nob3QgdmFyaWFudHMgaWYgcHJlc2VudCkgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3Rocm93fHRvc3N8cGl0Y2gvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC9zaG9vdHxzaG90fGdvYWwvKSkgYWN0aW9uS2V5ID0gJ3Rocm93X3Nob3QnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChoYXMoL3Bhc3MvKSkgYWN0aW9uS2V5ID0gJ3Rocm93X3Bhc3MnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFjdGlvbktleSA9ICd0aHJvdyc7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBDYXRjaGluZyAoanVtcC9haXIgdmFyaWFudHMgaWYgcHJlc2VudCkgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2NhdGNofHJlY2VpdmV8Z3JhYnxpbnRlcmNlcHQvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC9qdW1wfGxlYXB8YWlyfGRpdmUvKSkgYWN0aW9uS2V5ID0gJ2NhdGNoX2p1bXAnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFjdGlvbktleSA9ICdjYXRjaCc7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBIaXQgLyBSZWFjdCAtLS0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvcmVhY3R8aGl0fGh1cnR8ZGFtYWdlfHN0YWdnZXJ8a25vY2svKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAncmVhY3QnOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gT3B0aW9uYWwgc3RhdGVzIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jaGFyZ2V8YWltfHJlYWR5fHdpbmR1cHxob2xkLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2NoYXJnZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3RhY2tsZXxjaGVja3xyYW0vKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAndGFja2xlJzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvYmxvY2t8c2F2ZS8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2NlbGVicmF0ZXx2aWN0b3J5fGNoZWVyLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2NlbGVicmF0ZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gY2xpcC5uYW1lOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gU3RyaXAgbGVncyBmcm9tIG5vbi1sb2NvbW90aW9uIGNsaXBzIHRvIGFsbG93IHRyZWFkaW5nIHdhdGVyIG92ZXJsYXkKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTG9jb21vdGlvbiAmJiBhY3Rpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3N0cmlwTGVncyhjbGlwKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChhY3Rpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3Rpb25zW2FjdGlvbktleV0gPSB0aGlzLm1peGVyLmNsaXBBY3Rpb24oY2xpcCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFN0YXJ0IGRlZmF1bHQgbG9jb21vdGlvbgogICAgICAgICAgICBpZiAodGhpcy5hY3Rpb25zWydpZGxlJ10pIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24oJ2lkbGUnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrCiAgICAgICAgICAgICAgICBjb25zdCBmaXJzdCA9IE9iamVjdC52YWx1ZXModGhpcy5hY3Rpb25zKVswXTsKICAgICAgICAgICAgICAgIGlmKGZpcnN0KSBmaXJzdC5wbGF5KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9uZS1zaG90IGFuaW1hdGlvbiBsaXN0ZW5lcgogICAgICAgICAgICBpZiAodGhpcy5taXhlcikgewogICAgICAgICAgICAgICAgdGhpcy5taXhlci5hZGRFdmVudExpc3RlbmVyKCdmaW5pc2hlZCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9hbmltTG9ja2VkKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLmFjdGlvbikgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBmaW5pc2hlZCBhY3Rpb24gaXMgb3VyIGN1cnJlbnQgb25lLXNob3QKICAgICAgICAgICAgICAgICAgICBpZiAoZS5hY3Rpb24gPT09IHRoaXMuYWN0aXZlT25lU2hvdCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hbmltTG9ja2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvY2tlZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVPbmVTaG90ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJldHVybiB0byBsb2NvbW90aW9uIHVwZGF0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMTUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE5ldyBtZXRob2QgZm9yIGJhc2UgbGF5ZXIgKGxlZ3MvYm9keSBtb3ZlbWVudCkKICAgICAgICBwbGF5TG9jb21vdGlvbihhY3Rpb25OYW1lLCBkdXJhdGlvbiA9IDAuNSkgewogICAgICAgICAgICBjb25zdCBuZXdBY3Rpb24gPSB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgIGlmICghbmV3QWN0aW9uIHx8IG5ld0FjdGlvbiA9PT0gdGhpcy5hY3RpdmVMb2NvbW90aW9uKSByZXR1cm47CgogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVMb2NvbW90aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUxvY29tb3Rpb24uZmFkZU91dChkdXJhdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5ld0FjdGlvbi5yZXNldCgpOwogICAgICAgICAgICBuZXdBY3Rpb24uZmFkZUluKGR1cmF0aW9uKTsKICAgICAgICAgICAgbmV3QWN0aW9uLnBsYXkoKTsKICAgICAgICAgICAgdGhpcy5hY3RpdmVMb2NvbW90aW9uID0gbmV3QWN0aW9uOwogICAgICAgICAgICB0aGlzLl9sYXN0TG9jb21vdGlvbiA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICAvLyBPdmVyaGF1bGVkIHBsYXkgbWV0aG9kIHRvIGhhbmRsZSBsYXllcmluZwogICAgICAgIHBsYXkoYWN0aW9uTmFtZSwgZHVyYXRpb24gPSAwLjUpIHsKICAgICAgICAgICAgLy8gSWYgaXQncyBhIGxvY29tb3Rpb24gc3RhdGUsIHJvdXRlIHRvIHBsYXlMb2NvbW90aW9uCiAgICAgICAgICAgIGlmIChbJ2lkbGUnLCAnc3dpbScsICdkYXNoJ10uaW5jbHVkZXMoYWN0aW9uTmFtZSkpIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24oYWN0aW9uTmFtZSwgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPdGhlcndpc2UgdHJlYXQgYXMgYW4gYWN0aW9uIGxheWVyCiAgICAgICAgICAgIGNvbnN0IG5ld0FjdGlvbiA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFuZXdBY3Rpb24pIHJldHVybjsKCiAgICAgICAgICAgIC8vIElmIHdlIGhhdmUgYW4gYWN0aXZlIG9uZS1zaG90LCBmYWRlIGl0IG91dAogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVPbmVTaG90ICYmIHRoaXMuYWN0aXZlT25lU2hvdCAhPT0gbmV3QWN0aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZU9uZVNob3QuZmFkZU91dCgwLjEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXdBY3Rpb24ucmVzZXQoKTsKICAgICAgICAgICAgbmV3QWN0aW9uLmZhZGVJbigwLjEpOyAvLyBGYXN0IHRyYW5zaXRpb24gZm9yIGFjdGlvbnMKICAgICAgICAgICAgbmV3QWN0aW9uLnBsYXkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYWN0aXZlT25lU2hvdCA9IG5ld0FjdGlvbjsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlTG9jb21vdGlvbkFuaW0oZHVyYXRpb24gPSAwLjIpIHsKICAgICAgICAgICAgLy8gTm90ZTogV2UgTk8gTE9OR0VSIGNoZWNrIF9hbmltTG9ja2VkIGhlcmUuCiAgICAgICAgICAgIC8vIExvY29tb3Rpb24gc2hvdWxkIHVwZGF0ZSBjb250aW51b3VzbHkgYmFzZWQgb24gc3BlZWQsIAogICAgICAgICAgICAvLyBydW5uaW5nIHVuZGVybmVhdGggdGhlIHVwcGVyIGJvZHkgYWN0aW9uLgogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgdnggPSB0aGlzLnZlbG9jaXR5ID8gdGhpcy52ZWxvY2l0eS54IDogMDsKICAgICAgICAgICAgY29uc3QgdnogPSB0aGlzLnZlbG9jaXR5ID8gdGhpcy52ZWxvY2l0eS56IDogMDsKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSBNYXRoLnNxcnQodnggKiB2eCArIHZ6ICogdnopOwoKICAgICAgICAgICAgLy8gU21vb3RoIHNwZWVkCiAgICAgICAgICAgIGNvbnN0IHNtb290aEsgPSAxLjAgLSBNYXRoLnBvdygwLjAwMSwgZHVyYXRpb24pOwogICAgICAgICAgICB0aGlzLl9zbW9vdGhlZFNwZWVkICs9IChzcGVlZCAtIHRoaXMuX3Ntb290aGVkU3BlZWQpICogc21vb3RoSzsKCiAgICAgICAgICAgIGNvbnN0IHNwZWVkTm9ybSA9ICh0aGlzLm1heFNwZWVkID4gMC4wMDAxKSA/IFRIUkVFLk1hdGhVdGlscy5jbGFtcCh0aGlzLl9zbW9vdGhlZFNwZWVkIC8gdGhpcy5tYXhTcGVlZCwgMCwgMSkgOiAwOwoKICAgICAgICAgICAgLy8gSHlzdGVyZXNpcwogICAgICAgICAgICBjb25zdCBlbnRlck1vdmUgPSAwLjE4OwogICAgICAgICAgICBjb25zdCBleGl0TW92ZSA9IDAuMTA7CgogICAgICAgICAgICBjb25zdCBpbnB1dE1vdmluZyA9IHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wNjsKICAgICAgICAgICAgY29uc3QgdmVsTW92aW5nID0gdGhpcy5fc21vb3RoZWRTcGVlZCA+ICh0aGlzLl9tb3ZpbmdMYXRjaCA/IGV4aXRNb3ZlIDogZW50ZXJNb3ZlKTsKCiAgICAgICAgICAgIHRoaXMuX21vdmluZ0xhdGNoID0gaW5wdXRNb3ZpbmcgfHwgdmVsTW92aW5nOwoKICAgICAgICAgICAgbGV0IHRhcmdldCA9IHRoaXMuX21vdmluZ0xhdGNoID8gJ3N3aW0nIDogJ2lkbGUnOwogICAgICAgICAgICBpZiAodGhpcy5fbW92aW5nTGF0Y2ggJiYgdGhpcy5pc0Rhc2hpbmcgJiYgdGhpcy5hY3Rpb25zWydkYXNoJ10pIHRhcmdldCA9ICdkYXNoJzsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBwbGF5YmFjayByYXRlCiAgICAgICAgICAgIGNvbnN0IGFwcGx5UmF0ZSA9IChrZXkpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGlvbnNba2V5XTsKICAgICAgICAgICAgICAgIGlmICghYSkgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gJ3N3aW0nKSBhLnRpbWVTY2FsZSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDAuODUsIDEuNzAsIHNwZWVkTm9ybSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChrZXkgPT09ICdkYXNoJykgYS50aW1lU2NhbGUgPSBUSFJFRS5NYXRoVXRpbHMubGVycCgxLjEwLCAyLjIwLCBzcGVlZE5vcm0pOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoa2V5ID09PSAnaWRsZScpIGEudGltZVNjYWxlID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoMC45NSwgMS4wNSwgc3BlZWROb3JtKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGFwcGx5UmF0ZSh0YXJnZXQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuX2xhc3RMb2NvbW90aW9uICE9PSB0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGlvbnNbdGFyZ2V0XTsKICAgICAgICAgICAgICAgIGlmIChhKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsgYS5zZXRMb29wKFRIUkVFLkxvb3BSZXBlYXQpOyB9IGNhdGNoIChfKSB7fQogICAgICAgICAgICAgICAgICAgIGEuY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24odGFyZ2V0LCBkdXJhdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBsYXlPbmVTaG90KGFjdGlvbk5hbWUsIGR1cmF0aW9uID0gMC4xLCBvcHRzID0ge30pIHsKICAgICAgICAgICAgY29uc3QgYSA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFhKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICB0aGlzLl9hbmltTG9ja2VkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5fbG9ja2VkU3RhdGUgPSBhY3Rpb25OYW1lOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGEucmVzZXQoKTsKICAgICAgICAgICAgICAgIGEuc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICBhLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGEudGltZVNjYWxlID0gKG9wdHMudGltZVNjYWxlICE9PSB1bmRlZmluZWQgPyBvcHRzLnRpbWVTY2FsZSA6IDEuMCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKF8pIHt9CgogICAgICAgICAgICAvLyBVc2UgdGhlIG5ldyBwbGF5IG1ldGhvZCB3aGljaCBoYW5kbGVzIGxheWVyaW5nCiAgICAgICAgICAgIHRoaXMucGxheShhY3Rpb25OYW1lLCBkdXJhdGlvbik7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBzZXRJbnB1dCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCh4LCAwLCB6KTsKICAgICAgICB9CgpyZWNlaXZlQmFsbCgpIHsKICAgICAgICAgICAgdGhpcy5jYW5DYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ1JJVElDQUwgRklYOiBSZXNldCBzdGF0ZXMgdGhhdCBtaWdodCBwcmV2ZW50IHNob290aW5nCiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMi4wOwoKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLmxhc3RIb2xkZXIgJiYgYmFsbC5sYXN0SG9sZGVyLnRlYW0gPT09IHRoaXMudGVhbSAmJiBiYWxsLmxhc3RIb2xkZXIgIT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGJhbGwubGFzdEhvbGRlci5nYWluRXhwKDIpOwogICAgICAgICAgICAgICAgdGhpcy5nYWluRXhwKDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBiYWxsWSA9ICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLm1lc2gpID8gdGhpcy5iYWxsUmVmLm1lc2gucG9zaXRpb24ueSA6IDA7CiAgICAgICAgICAgIGNvbnN0IGNhdGNoS2V5ID0gKGJhbGxZID4gMC4yNSAmJiB0aGlzLmFjdGlvbnNbJ2NhdGNoX2p1bXAnXSkgPyAnY2F0Y2hfanVtcCcgOiAnY2F0Y2gnOwoKICAgICAgICAgICAgdGhpcy5wbGF5T25lU2hvdChjYXRjaEtleSwgMC4xKTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2NhdGNoJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTTkFQISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWFjdGlvbiIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdGhyb3dCYWxsKGJhbGwsIGZvcmNlZFR5cGUgPSBudWxsLCBwb3dlck11bHRpcGxpZXIgPSAxLjAsIGZvcmNlZFNwaW4gPSBudWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZykgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gdHJ1ZTsKCiAgICAgICAgICAgIC8vIExvY2sgYWltIGRpcmVjdGlvbiBhdCBzdGFydCBvZiB0aHJvdwogICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3RvciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICBpZiAodGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4xKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3Rvci5jb3B5KHRoaXMuaW5wdXRWZWN0b3IpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5sb2NrZWRBaW1WZWN0b3Iuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtZ29hbERpc3QgOiBnb2FsRGlzdDsKICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwoKICAgICAgICAgICAgbGV0IHR5cGUgPSBmb3JjZWRUeXBlOwogICAgICAgICAgICBpZiAoIXR5cGUpIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAoZGlzdFRvR29hbCA8IDI1KSA/ICdTSCcgOiAnUEEnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBpc0ZpbmlzaGVyID0gKHR5cGUgPT09ICdTSCcgJiYgZGlzdFRvR29hbCA8IDEyLjApOwoKICAgICAgICAgICAgbGV0IHRlY2hOYW1lID0gKHR5cGUgPT09ICdTSCcpID8gdGhpcy50ZWNocy5zaG9vdCA6IHRoaXMudGVjaHMucGFzczsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy52ZW5vbSA+IDAgJiYgdGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNJTEVOQ0VEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgICAgICB0ZWNoTmFtZSA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCB3aW5kdXBUaW1lID0gMTAwOwogICAgICAgICAgICBsZXQgYW5pbVNwZWVkID0gMS41OwoKICAgICAgICAgICAgaWYgKHBvd2VyTXVsdGlwbGllciA+IDEuMSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSArPSAyMDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc0ZpbmlzaGVyICYmICF0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSA9IDUwOwogICAgICAgICAgICAgICAgYW5pbVNwZWVkID0gMy4wOwogICAgICAgICAgICB9CgppZiAodGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIHdpbmR1cFRpbWUgPSA0MDA7CiAgICAgICAgICAgICAgICBhbmltU3BlZWQgPSAwLjg7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIucGxheUNpbmVtYXRpYyh0ZWNoTmFtZSwgdGhpcy5tZXNoLCAxLjIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuaW1tdW5pdHlUaW1lciA9IDEuNTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJykudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGxhYmVsLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTkVXOiBTcGF3biBUZWNoIEdseXBoIChWZXJ0aWNhbCBDYXN0aW5nIENpcmNsZSkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmdseXBoTWFuYWdlci5zcGF3bigndGVjaCcsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDEuMiwKICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogNC4wLAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAxLjUsCiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFk6IDEuMiwKICAgICAgICAgICAgICAgICAgICAgICAgZmFjZUNhbWVyYTogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQaWNrIGJlc3QgdGhyb3cgY2xpcCAocGFzcy9zaG90IHZhcmlhbnRzIGlmIHByZXNlbnQpCiAgICAgICAgICAgIGNvbnN0IHRocm93S2V5ID0KICAgICAgICAgICAgICAgICh0eXBlID09PSAnU0gnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfc2hvdCddKSA/ICd0aHJvd19zaG90JyA6CiAgICAgICAgICAgICAgICAodHlwZSA9PT0gJ1BBJyAmJiB0aGlzLmFjdGlvbnNbJ3Rocm93X3Bhc3MnXSkgPyAndGhyb3dfcGFzcycgOgogICAgICAgICAgICAgICAgJ3Rocm93JzsKCnRoaXMucGxheU9uZVNob3QodGhyb3dLZXksIDAuMSwgeyB0aW1lU2NhbGU6IGFuaW1TcGVlZCB9KTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3Rocm93Jyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0ICYmICF0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiV0hPT1NIIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtYWN0aW9uIik7CiAgICAgICAgICAgIH0KCnNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgLy8gU2FmZXR5OiBJZiBiYWxsIGhvbGRlciBpcyBzdGlsbCB1cywgcHJvY2VlZC4gSWYgaGFzQmFsbCBpcyBmYWxzZSBidXQgaG9sZGVyIGlzIHVzLCBhc3N1bWUgc3luYyBsYWcgYW5kIHByb2NlZWQuCiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IChiYWxsICYmIGJhbGwuaG9sZGVyID09PSB0aGlzKSkgewpjb25zdCB0aHJvd0FjdGlvbiA9IHRoaXMuYWN0aW9uc1t0aHJvd0tleV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHRocm93QWN0aW9uKSB0aHJvd0FjdGlvbi50aW1lU2NhbGUgPSAxLjA7CgogICAgICAgICAgICAgICAgICAgIGxldCBmaW5hbERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICAgICAgbGV0IHJlZmVyZW5jZURpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgppZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5jb3B5KHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2VEaXIuY29weShmaW5hbERpcik7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBSRU1PVkVEOiBJbnN0YW50IHJvdGF0aW9uIHNuYXAuIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGUgdXBkYXRlIGxvb3AgaGFuZGxlcyBzbW9vdGggcm90YXRpb24gdmlhIHRhcmdldFlhdy4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyB0aGUgImZsaXBwaW5nIGFyb3VuZCIgdmlzdWFsIGdsaXRjaC4KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5jb3B5KHRoaXMubG9ja2VkQWltVmVjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlRGlyLmNvcHkodGhpcy5sb2NrZWRBaW1WZWN0b3IpOwogICAgICAgICAgICAgICAgICAgIH0KCmNvbnN0IHNwaW4gPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGZvcmNlZFNwaW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3Bpbi5jb3B5KGZvcmNlZFNwaW4pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlucHV0RGlyID0gdGhpcy5pbnB1dFZlY3Rvci5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjcm9zc1kgPSBuZXcgVEhSRUUuVmVjdG9yMygpLmNyb3NzVmVjdG9ycyhyZWZlcmVuY2VEaXIsIGlucHV0RGlyKS55OwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGNyb3NzWSkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwaW4uc2V0KDAsIGNyb3NzWSAqIDEyLjAsIDApOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsZXQgYmFzZUNvc3QgPSAodHlwZSA9PT0gJ1NIJykgPyAyMCA6IDEwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoQ29zdCA9IDA7CiAgICAgICAgICAgICAgICAgICAgbGV0IHRlY2hCb251cyA9IDA7CiAgICAgICAgICAgICAgICAgICAgbGV0IHRlY2hQYXlsb2FkID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAodGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3Zlbm9tJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9ICh0eXBlID09PSAnU0gnID8gMjAgOiAxMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IHsgdHlwZTogJ3Zlbm9tJywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3dpdGhlcic6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDIwIDogMTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICd3aXRoZXInLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnbmFwJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9ICh0eXBlID09PSAnU0gnID8gMzUgOiAzMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IHsgdHlwZTogJ25hcCcsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdzcGhlcmUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gMjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJuZyA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDExKSArIDU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IHJuZzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdzcGhlcmUnLCBsZXZlbDogMSwgYm9udXM6IHJuZyB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oYFNQSEVSRSArJHtybmd9YCwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZ29hbCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2plY2h0JzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9IDQwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSA1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IHsgdHlwZTogJ2plY2h0JywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGVyZm9ybUplY2h0S25vY2tiYWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnaW52aXNpYmxlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9IDI1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IHsgdHlwZTogJ2ludmlzaWJsZScsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b3RhbENvc3QgPSBiYXNlQ29zdCArIHRlY2hDb3N0OwoKICAgICAgICAgICAgICAgICAgICBsZXQgcG93ZXJGYWN0b3IgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPCB0b3RhbENvc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcG93ZXJGYWN0b3IgPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiVElSRUQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IHRvdGFsQ29zdDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGxldCBzdGF0VmFsID0gdGhpcy5nZXRTdGF0KHR5cGUpOwogICAgICAgICAgICAgICAgICAgIHN0YXRWYWwgKz0gdGVjaEJvbnVzOwogICAgICAgICAgICAgICAgICAgIHN0YXRWYWwgKj0gcG93ZXJGYWN0b3I7CiAgICAgICAgICAgICAgICAgICAgc3RhdFZhbCAqPSBwb3dlck11bHRpcGxpZXI7Cgpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtZ29hbERpc3QgOiBnb2FsRGlzdDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnb2FsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbFogLSB0aGlzLm1lc2gucG9zaXRpb24ueikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbERvdCA9IGZpbmFsRGlyLmRvdChnb2FsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDIsIGdvYWxaKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdG9Hb2FsID0gZ29hbFBvcy5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2ggPSB0aGlzLmdldFN0YXQoJ1NIJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBNYXRoLm1pbigwLjksIE1hdGgubWF4KDAuMSwgc2ggLyAxMDAuMCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lzdEZhY3RvciAqPSAwLjE7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnb2FsRG90ID4gMC4yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5sZXJwKHRvR29hbCwgYXNzaXN0RmFjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRmluaXNoZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4wNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xBTSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4yNTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKLy8gR29hbGllIExvZnQgQm9udXMgKFByZXZlbnQgaW50ZXJjZXB0aW9uIGJ5IGltbWVkaWF0ZSBkZWZlbmRlcikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgZmluYWxEaXIueSArPSAwLjg7IC8vIEhpZ2ggbG9mdCBmb3IgY2xlYXJhbmNlCgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGZpbmFsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvTWF0ZSA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0LnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b01hdGUuYWRkU2NhbGVkVmVjdG9yKHRhcmdldC52ZWxvY2l0eSwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvTWF0ZS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYSA9IHRoaXMuZ2V0U3RhdCgnUEEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBNYXRoLm1pbigxLjAsIDAuMyArIChwYSAvIDgwLjApKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lzdEZhY3RvciAqPSAwLjE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIubGVycCh0b01hdGUsIGFzc2lzdEZhY3Rvcik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gTWF0aC5taW4oMC42LCBkaXN0ICogMC4wMyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CmZpbmFsRGlyLnkgKz0gMC4yOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBHb2FsaWUgTG9mdCBCb251cyBmb3IgUGFzc2luZwovLyBHb2FsaWUgTG9mdCBCb251cyBmb3IgUGFzc2luZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yb2xlID09PSAnR0wnKSBmaW5hbERpci55ICs9IDAuODsgLy8gSGlnaCBsb2Z0IGZvciBjbGVhcmFuY2UKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodGVjaFBheWxvYWQgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KHRoaXMsIHRlY2hOYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CgpiYWxsLnNob290KGZpbmFsRGlyLCBzdGF0VmFsLCB0eXBlLCB0ZWNoUGF5bG9hZCwgc3Bpbik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRXh0cmEgZ3JhY2UgcGVyaW9kIGZvciBHb2FsaWUgdG8gcHJldmVudCBwb2ludC1ibGFuayBpbnRlcmNlcHRpb25zCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgewogICAgICAgICAgICAgICAgICAgICAgICBiYWxsLmNhdGNoR3JhY2VQZXJpb2QgPSAwLjY7IC8vIDAuNnMgaW1tdW5pdHkgKGFwcHJveCAxMC0xMm0gdHJhdmVsKQogICAgICAgICAgICAgICAgICAgIH0KCnRoaXMubG9zZUJhbGwoKTsKCnRoaXMuY2F0Y2hDb29sZG93biA9IDEuMDsgLy8gMXMgY29vbGRvd24KICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHdpbmR1cFRpbWUpOwoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBudWxsOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlTG9jb21vdGlvbkFuaW0oMC4yKTsKICAgICAgICAgICAgfSwgd2luZHVwVGltZSArIDUwMCk7CiAgICAgICAgfQoKICAgICAgICBfZmluZFBhc3NUYXJnZXRJbkNvbmUoYWltRGlyKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtKSByZXR1cm4gbnVsbDsKCiAgICAgICAgICAgIGxldCBiZXN0VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IG1heFNjb3JlID0gLUluZmluaXR5OwoKICAgICAgICAgICAgZm9yIChjb25zdCBtYXRlIG9mIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcyB8fCAhbWF0ZS5tZXNoKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICBjb25zdCB0b01hdGUgPSBtYXRlLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGRvdCA9IGFpbURpci5kb3QodG9NYXRlKTsKCiAgICAgICAgICAgICAgICBpZiAoZG90ID4gMC43KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2NvcmUgPSAoZG90ICogMTApIC0gKGRpc3QgKiAwLjEpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoc2NvcmUgPiBtYXhTY29yZSkgewogICAgICAgICAgICAgICAgICAgICAgICBtYXhTY29yZSA9IHNjb3JlOwogICAgICAgICAgICAgICAgICAgICAgICBiZXN0VGFyZ2V0ID0gbWF0ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJlc3RUYXJnZXQ7CiAgICAgICAgfQoKc3RhcnRDaGFyZ2UoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CgovLyBWaXN1YWxzIGhhbmRsZWQgaW4gdXBkYXRlCgogICAgICAgICAgICAvLyBTaG93IGNoYXJnZSBVSQogICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSSgwKTsKCiAgICAgICAgICAgIC8vIE5FVzogU3Bhd24gQ2hhcmdlIEdseXBoIChHcm91bmQgUmluZykKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyLnNwYXduKCdjaGFyZ2UnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgbGlmZTogdGhpcy5tYXhDaGFyZ2VUaW1lLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IDMuMCwKICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAwLjIsCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WTogMC4xCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnJlbGVhc2VDaGFyZ2UoZHgsIGR5LCBjdXJ2ZUlucHV0ID0gbnVsbCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaXNDaGFyZ2luZykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBvd2VyIENhbGN1bGF0aW9uCiAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4odGhpcy5jaGFyZ2VUaW1lIC8gdGhpcy5tYXhDaGFyZ2VUaW1lLCAxLjApOwogICAgICAgICAgICBjb25zdCBUQyA9IHdpbmRvdy5mbHV4LlRocm93Q29uZmlnIHx8IHt9OwoKICAgICAgICAgICAgLy8gQmFzZSBtdWx0aXBsaWVyIChkZWZhdWx0czogMS4wIHRvIDEuOCkKICAgICAgICAgICAgbGV0IG11bHRpcGxpZXIgPSAoVEMuUE9XRVJfQkFTRSAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfQkFTRSA6IDEuMCkgKyAocmF0aW8gKiAoVEMuUE9XRVJfUkFOR0UgIT09IHVuZGVmaW5lZCA/IFRDLlBPV0VSX1JBTkdFIDogMC44KSk7Ly8gTUFYIFBPV0VSIEJPTlVTOiBJZiBoZWxkIG5lYXIgbWF4LCBzaWduaWZpY2FudCBib29zdAogICAgICAgICAgICBpZiAocmF0aW8gPiAoVEMuUE9XRVJfTUFYX0JPTlVTX1JBVElPICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9NQVhfQk9OVVNfUkFUSU8gOiAwLjk1KSkgewogICAgICAgICAgICAgICAgbXVsdGlwbGllciA9IChUQy5QT1dFUl9NQVhfTVVMVElQTElFUiAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfTUFYX01VTFRJUExJRVIgOiAyLjUpOyAvLyBDcml0aWNhbCBQb3dlcgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNQVggUE9XRVIhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKC0xMCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CgogICAgICAgICAgICAvLyBBaW0gVmVjdG9yIENhbGN1bGF0aW9uCiAgICAgICAgICAgIGxldCBhaW1WZWMgPSBudWxsOwogICAgICAgICAgICBjb25zdCBzd2lwZUxlbiA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCiAgICAgICAgICAgIGlmIChzd2lwZUxlbiA+IChUQy5TV0lQRV9NSU5fUFggIT09IHVuZGVmaW5lZCA/IFRDLlNXSVBFX01JTl9QWCA6IDIwKSkgewogICAgICAgICAgICAgICAgY29uc3QgY2FtZXJhID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYTsKICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICBjb25zdCByaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAgICAgaWYgKGNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihmd2QpOwogICAgICAgICAgICAgICAgICAgIGZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAoZndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgZndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBmd2Qubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIHJpZ2h0LmNyb3NzVmVjdG9ycyhmd2QsIG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgICAgIHdvcmxkVmVjLmFkZFNjYWxlZFZlY3RvcihyaWdodCwgZHggKiAoVEMuQUlNX0RYX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5BSU1fRFhfU0NBTEUgOiAxLjApKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5hZGRTY2FsZWRWZWN0b3IoZndkLCAtZHkgKiAoVEMuQUlNX0RZX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5BSU1fRFlfU0NBTEUgOiAxLjApKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgYWltVmVjID0gd29ybGRWZWM7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdmVycmlkZUFpbVZlY3RvciA9IGFpbVZlYzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYWltVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFpbVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgfQoKLy8gLS0tIEFOQUxPRyBDVVJWRSBMT0dJQyAtLS0KICAgICAgICAgICAgLy8gRm9ybXVsYTogQ3VydmUgPSBJbnRlbnNpdHkgKiBTcGVlZAogICAgICAgICAgICBsZXQgc3BpblZlYyA9IG51bGw7CiAgICAgICAgICAgIAppZiAoKFRDLkNVUlZFX0VOQUJMRUQgIT09IGZhbHNlKSAmJiBjdXJ2ZUlucHV0ICYmIE1hdGguYWJzKGN1cnZlSW5wdXQuaW50ZW5zaXR5KSA+IChUQy5DVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEIDogMC4yNSkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJhd0ludGVuc2l0eSA9IE1hdGguYWJzKGN1cnZlSW5wdXQuaW50ZW5zaXR5KTsKICAgICAgICAgICAgICAgIGNvbnN0IHNpZ24gPSBNYXRoLnNpZ24oY3VydmVJbnB1dC5pbnRlbnNpdHkpOyAvLyBQb3NpdGl2ZSA9IFJpZ2h0IEh1bXAgPSBMZWZ0IEN1cnZlCiAgICAgICAgICAgICAgICBjb25zdCBzd2lwZVNwZWVkID0gY3VydmVJbnB1dC5zcGVlZCB8fCAxLjA7CgogICAgICAgICAgICAgICAgLy8gMS4gQmFzZSBTcGluIGZyb20gQXJjIChUdW5lZCBmb3IgcmVhbGlzbSwgbm8gY3ljbG9uZXMpCi8vIDEuIEJhc2UgU3BpbiBmcm9tIEFyYyAoSGVyY3VsZWFuIEJvb3N0KQogICAgICAgICAgICAgICAgbGV0IHNwaW5NYWcgPSByYXdJbnRlbnNpdHkgKiAoVEMuQ1VSVkVfU1BJTl9TQ0FMRSAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BJTl9TQ0FMRSA6IDEwMDAuMCk7CgogICAgICAgICAgICAgICAgLy8gMi4gU3BlZWQgQm9udXMgKFF1aWNrbmVzcyBhZGRzIFJQTSkKICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkQm9udXMgPSBNYXRoLm1heCgxLjAsIHN3aXBlU3BlZWQgKiAoVEMuQ1VSVkVfU1BFRURfTVVMVCAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BFRURfTVVMVCA6IDEuNSkpOwogICAgICAgICAgICAgICAgc3Bpbk1hZyAqPSBzcGVlZEJvbnVzOwoKICAgICAgICAgICAgICAgIC8vIENhcCAoSW5jcmVhc2VkIHRvIDE1MDAgZm9yIG1hc3NpdmUgYXJjcykKICAgICAgICAgICAgICAgIHNwaW5NYWcgPSBNYXRoLm1pbigoVEMuQ1VSVkVfU1BJTl9DQVAgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX1NQSU5fQ0FQIDogMTUwMC4wKSwgc3Bpbk1hZyk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgU3BpbgogICAgICAgICAgICAgICAgLy8gUmlnaHQgSHVtcCAoUG9zaXRpdmUgSW50ZW5zaXR5KSAtPiBMZWZ0IEN1cnZlIChQb3NpdGl2ZSBTcGluIFkpCiAgICAgICAgICAgICAgICBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3Bpbk1hZyAqIHNpZ24sIDApOwogICAgICAgICAgICAgICAgCmlmIChzcGluTWFnID4gKFRDLkNVUlZFX1BFUkZFQ1RfU1BJTiAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfUEVSRkVDVF9TUElOIDogNTAwLjApICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQRVJGRUNUIENVUlZFIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSb2xsSW1wdWxzZShzaWduICogLTAuMyk7IC8vIFRpbHQgY2FtZXJhIGludG8gdGhlIGN1cnZlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEZXRlcm1pbmUgVHlwZSAoUGFzcyB2cyBTaG9vdCkKLy8gRGV0ZXJtaW5lIFR5cGUgKFBhc3MgdnMgU2hvb3QpCmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtZ29hbERpc3QgOiBnb2FsRGlzdDsKICAgICAgICAgICAgY29uc3QgZ29hbERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIGdvYWxaIC0gdGhpcy5tZXNoLnBvc2l0aW9uLnopLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBjb25zdCBkb3RHb2FsID0gYWltVmVjLmRvdChnb2FsRGlyKTsKCiAgICAgICAgICAgIGxldCB0eXBlID0gJ1BBJzsKICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwoKICAgICAgICAgICAgaWYgKGRvdEdvYWwgPiAwLjggJiYgZGlzdFRvR29hbCA8IDM1LjApIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAnU0gnOwogICAgICAgICAgICB9IGVsc2UgaWYgKGRvdEdvYWwgPiAwLjUgJiYgZGlzdFRvR29hbCA8IDIwLjApIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAnU0gnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbWFydCBQYXNzIE92ZXJyaWRlCiAgICAgICAgICAgIGNvbnN0IHRhcmdldE1hdGUgPSB0aGlzLl9maW5kUGFzc1RhcmdldEluQ29uZShhaW1WZWMpOwogICAgICAgICAgICBpZiAodGFyZ2V0TWF0ZSAmJiB0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0TWF0ZSA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldE1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdE1hdGUgPCAxMi4wKSB0eXBlID0gJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgdHlwZSwgbXVsdGlwbGllciwgc3BpblZlYyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE5FVzogQ2hhcmdlIFVJIG1ldGhvZHMKICAgICAgICBfdXBkYXRlQ2hhcmdlVUkocmF0aW8pIHsKICAgICAgICAgICAgY29uc3QgbWV0ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhcmdlLW1ldGVyLWZpbGwnKTsKICAgICAgICAgICAgaWYgKG1ldGVyKSB7CiAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS53aWR0aCA9IGAke3JhdGlvICogMTAwfSVgOwogICAgICAgICAgICAgICAgaWYgKHJhdGlvID4gMC45KSB7CiAgICAgICAgICAgICAgICAgICAgbWV0ZXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAsICNmODApJzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmF0aW8gPiAwLjUpIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzBmMCwgI2ZmMCknOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzBhZiwgIzBmMCknOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIpIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlQ2hhcmdlVUkoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIpIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KCiAgICAgICAgc2V0T3ZlcnJpZGVBaW0oeCwgeikgewogICAgICAgICAgICBpZiAoIXRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yLnNldCh4LCAwLCB6KS5ub3JtYWxpemUoKTsKICAgICAgICB9Cgpsb3NlQmFsbCgpIHsKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwogICAgICAgICAgICAvLyBGaXg6IEVuc3VyZSBwbGF5ZXIgY2FuIGNhdGNoIGFnYWluIGlmIHRoZXkgbG9zZSBwb3NzZXNzaW9uIHVuZXhwZWN0ZWRseQogICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBzdGF0ZXMgdG8gcHJldmVudCBsb2NraW5nCiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQaHlzaWNzKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyBTWU5DIEZJWDogSWYgYmFsbCB0aGlua3MgSSBob2xkIGl0LCBidXQgSSBkb24ndCwgZm9yY2UgcmVjZWl2ZQogICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmICYmIHRoaXMuYmFsbFJlZi5ob2xkZXIgPT09IHRoaXMgJiYgIXRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJTeW5jaW5nIGJhbGwgcG9zc2Vzc2lvbiB0byBwbGF5ZXIiKTsKICAgICAgICAgICAgICAgIHRoaXMucmVjZWl2ZUJhbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaXNHb2RNb2RlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gdGhpcy5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gdGhpcy5nZXRTdGF0KCdFTicpOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMudmVub20gPSAwOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzTG9naWMoZHQpOwoKICAgICAgICAgICAgLy8gQ2hhcmdlIExvZ2ljIChQaHlzaWNzIHBhcnQgLSBUaW1lcikKICAgICAgICAgICAgaWYgKHRoaXMuaXNDaGFyZ2luZykgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgfHwgdGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBwaHlzaWNzIHByb3BzIHRoYXQgbWlnaHQgaGF2ZSBiZWVuIGFsdGVyZWQKICAgICAgICAgICAgICAgICAgICAvLyBWaXN1YWwgcmVzZXQgaGFwcGVucyBpbiB1cGRhdGVWaXN1YWxzCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSArPSBkdDsKICAgICAgICAgICAgICAgICAgICAvLyBBVVRPLVJFTEVBU0U6IElmIGhlbGQgdG9vIGxvbmcgKDNzKSwgZm9yY2UgcmVsZWFzZQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJnZVRpbWUgPiAzLjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWxlYXNlQ2hhcmdlKDAsIDApOyAKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuZGFzaENvb2xkb3duID4gMCkgdGhpcy5kYXNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmNsYXNoQ29vbGRvd24gPiAwKSB0aGlzLmNsYXNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLnN0dW5UaW1lciA+IDApIHRoaXMuc3R1blRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5pbW11bml0eVRpbWVyID4gMCkgdGhpcy5pbW11bml0eVRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5jYXRjaENvb2xkb3duID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2F0Y2hDb29sZG93biA8PSAwKSB0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGFzaCBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNtb290aCBSb3RhdGlvbiBkdXJpbmcgRGFzaCAoTG9naWMgYWZmZWN0aW5nIHRyYW5zZm9ybSkKICAgICAgICAgICAgICAgIGxldCBkaWZmID0gdGhpcy50YXJnZXRZYXcgLSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlmZiA+IE1hdGguUEkpIGRpZmYgLT0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlmZiA8IC1NYXRoLlBJKSBkaWZmICs9IE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB0dXJuU3BlZWQgPSAxNS4wOyAKICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5nZSA9IE1hdGgubWF4KC10dXJuU3BlZWQgKiBkdCwgTWF0aC5taW4odHVyblNwZWVkICogZHQsIGRpZmYpKTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyArPSBjaGFuZ2U7CgogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVDb2xsaXNpb24oKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGFzaFRpbWUgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXNoVHlwZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUeXBlID09PSAndmVydGljYWwnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5kYXNoVmVjKS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBZIHBvc2l0aW9uIGNhbGN1bGF0aW9uIGlzIHZpc3VhbC9waHlzaWNzIGh5YnJpZCwga2VlcGluZyBoZXJlIGZvciBjb2xsaXNpb24gY29uc2lzdGVuY3kKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IDEgLSAodGhpcy5kYXNoVGltZSAvIHRoaXMuZGFzaFRvdGFsVGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gTWF0aC5zaW4odCAqIE1hdGguUEkpICogMy4wOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhvcml6b250YWwgRGFzaCBNb3ZlbWVudAogICAgICAgICAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJvdGF0aW9uIHVwZGF0ZQogICAgICAgICAgICAgICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCB0aGlzLmN1cnJlbnRZYXcgKyB0aGlzLnJvdGF0aW9uT2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIGxlYW4gaXMgY2FsY3VsYXRlZCBpbiB1cGRhdGVWaXN1YWxzLCBidXQgd2Ugc2V0IGJhc2Ugb3JpZW50YXRpb24gaGVyZQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5jb3B5KF9wUXVhdCk7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOTYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3R1bi9OYXAgQ2hlY2sKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkcmFnRmFjdG9yID0gTWF0aC5tYXgoMCwgMSAtICgyLjAgKiBkdCkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihkcmFnRmFjdG9yKTsKCiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9jaGVja1RhY2tsZVByZXNzdXJlKGR0KTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgoMCwgMS4wIC0gKDIuMCAqIGR0KSkpOwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlTb2Z0Q29sbGlzaW9uKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5R29hbENyZWFzZShkdCk7CiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmVydGljYWxpdHkoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQmFua2luZyhkdCk7IAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVWZXJ0aWNhbGl0eShkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCYW5raW5nKGR0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlTG9jb21vdGlvbkFuaW0oZHQpOyAvLyBBbmltYXRpb24gc3RhdGUgbG9naWMgZHJpdmVuIGJ5IHBoeXNpY3Mgc3RhdGUKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzVmlzdWFscyhkdCk7CgogICAgICAgICAgICAvLyBDaGFyZ2UgVmlzdWFscwogICAgICAgICAgICBpZiAodGhpcy5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmIHRoaXMuc3RhdHVzLm5hcCA8PSAwICYmIHRoaXMuc3R1blRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHRoaXMuY2hhcmdlVGltZSAvIHRoaXMubWF4Q2hhcmdlVGltZSwgMS4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMZXZpdGF0aW9uCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaG92ZXIgPSAoTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDIpICogMC4xKSArIChyYXRpbyAqIDAuOCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hha2UgPSAwLjA1ICsgKDAuMSAqIHJhdGlvKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IGhvdmVyICsgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2U7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIEppdHRlcgogICAgICAgICAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlOwoKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0U2NhbGFyKHRoaXMuYmFzZVNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSShyYXRpbyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IHZpc3VhbHMgaWYgY2hhcmdlIGNhbmNlbGxlZAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0U2NhbGFyKHRoaXMuYmFzZVNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGFzaCBWaXN1YWxzIChQYXJ0aWNsZXMgJiBMZWFuKQogICAgICAgICAgICBpZiAodGhpcy5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9kYXNoUGFydGljbGVUaW1lciA9IDAuMDE7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhY2sgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCkubmVnYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYWNrLmxlbmd0aFNxKCkgPCAwLjEpIGJhY2suc2V0KDAsIDAsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwyOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChiYWNrLm11bHRpcGx5U2NhbGFyKDAuNSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gMS4wICsgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwb3MsIHsgc2NhbGU6IDIuMCArIE1hdGgucmFuZG9tKCkgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVmlzdWFsIExlYW4gZm9yIERhc2gKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUeXBlID09PSAnaG9yaXpvbnRhbCcgfHwgdGhpcy5kYXNoVHlwZSA9PT0gJ2JyZWFrJyB8fCB0aGlzLmRhc2hUeXBlID09PSAnc3ByaW50JykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAxIC0gKHRoaXMuZGFzaFRpbWUgLyB0aGlzLmRhc2hUb3RhbFRpbWUpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlYW4gPSBNYXRoLnNpbih0ICogTWF0aC5QSSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgX3BRdWF0LnNldEZyb21BeGlzQW5nbGUoX3BBeGlzWSwgdGhpcy5jdXJyZW50WWF3ICsgdGhpcy5yb3RhdGlvbk9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgbGV0IHBpdGNoID0gMCwgeWF3ID0gMCwgcm9sbCA9IDAsIGx1bmdlQW10ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXNoVHlwZSAhPT0gJ3NwcmludCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHBpdGNoID0gMS4yICogbGVhbjsgeWF3ID0gMC44ICogbGVhbjsgcm9sbCA9IC0wLjYgKiBsZWFuOyBsdW5nZUFtdCA9IDAuOCAqIGxlYW47CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHBpdGNoID0gMC41ICogbGVhbjsgbHVuZ2VBbXQgPSAwLjIgKiBsZWFuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGx1bmdlQW10ID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIGx1bmdlQW10KS5hcHBseVF1YXRlcm5pb24oX3BRdWF0KTsKICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBvZmZzZXQgb25seSwgZG9uJ3QgYWNjdW11bGF0ZSB0byBwaHlzaWNzIHBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAvLyBOb3RlOiBXZSBhcmUgbW9kaWZ5aW5nIG1lc2gucG9zaXRpb24gaGVyZSB3aGljaCBpcyB0aGUgcGh5c2ljcyB0cmFuc2Zvcm0uCiAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZGVhbGx5IHdlIHNob3VsZCBoYXZlIGEgdmlzdWFsIGNoaWxkIG5vZGUsIGJ1dCBmb3Igbm93IHdlIGFkZCB0aGUgb2Zmc2V0LgogICAgICAgICAgICAgICAgICAgICAgICAgLy8gVG8gcHJldmVudCBkcmlmdCwgd2UgcmVseSBvbiBwaHlzaWNzIHVwZGF0ZSByZXNldHRpbmcgWSBhbmQgWC9aIGJlaW5nIGludGVncmF0ZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAvLyBBY3R1YWxseSwgYWRkaW5nIHRvIG1lc2gucG9zaXRpb24gaGVyZSBXSUxMIGFmZmVjdCBwaHlzaWNzIG5leHQgZnJhbWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3Igbm93LCB3ZSBhY2NlcHQgdGhpcyB2aXN1YWwtaW1wYWN0aW5nLXBoeXNpY3MgYmVoYXZpb3IgYXMgaXQgd2FzIGluIG9yaWdpbmFsIGNvZGUuCiAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIF9wRXVsZXIuc2V0KHBpdGNoLCB5YXcsIHJvbGwpOwogICAgICAgICAgICAgICAgICAgIF9wUXVhdDIuc2V0RnJvbUV1bGVyKF9wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5UXVhdGVybmlvbnMoX3BRdWF0LCBfcFF1YXQyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3R1bi9OYXAgVmlzdWFsIFJlc2V0CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9hbmltTG9ja2VkICYmIHRoaXMuc3RhdGUgIT09ICdpZGxlJyAmJiB0aGlzLnN0YXRlICE9PSAnY2F0Y2gnKSB0aGlzLnBsYXkoJ2lkbGUnLCAwLjUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl91cGRhdGVIUEJhcigpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwoKICAgICAgICAgICAgLy8gQnViYmxlIFRyYWlsCiAgICAgICAgICAgIGNvbnN0IHNwZWVkU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGlmIChzcGVlZFNxID4gMS4wICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9idWJibGVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG0gPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhY2tEaXIgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCkubmVnYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gYmFja0Rpci5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKDAuOCk7CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LnkgPSAwLjUgKyBNYXRoLnJhbmRvbSgpICogMC41OyAKICAgICAgICAgICAgICAgICAgICBvZmZzZXQueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgIG9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZScsIHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLCB7IHNjYWxlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMjUgfSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChzcGVlZFNxID4gNDAuMCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1PZmZzZXQgPSBiYWNrRGlyLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC41ICsgTWF0aC5yYW5kb20oKSowLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC55ID0gMC41ICsgKE1hdGgucmFuZG9tKCktMC41KSowLjg7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChtT2Zmc2V0KSwgeyBzY2FsZTogMC4wNiArIE1hdGgucmFuZG9tKCkqMC4wOCB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDAuMDM7IAogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4xOyAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2FwcGx5UHJvY2VkdXJhbFBvc2UoZHQpOwogICAgICAgIH0KCiAgICAgICAgX2FwcGx5UHJvY2VkdXJhbFBvc2UoZHQpIHsKICAgICAgICAgICAgLy8gQWR2YW5jZSBsb2NhbCB0aW1lICh1c2VkIGZvciBzdWJ0bGUgc3dheXMpCiAgICAgICAgICAgIHRoaXMuX3Byb2NBbmltVGltZSArPSBkdDsKCiAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmJvbmVzOwogICAgICAgICAgICBpZiAoIWIpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSAoZ2FtZSAmJiBnYW1lLmVudGl0aWVzKSA/IGdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CgogICAgICAgICAgICBsZXQgc2hvdWxkQXBwbHkgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIEJ1aWxkIGEgZGVzaXJlZCB3b3JsZC1zcGFjZSBkaXJlY3Rpb24gd2Ugd2FudCB0aGUgdG9yc28vaGVhZCB0byBiaWFzIHRvd2FyZC4KICAgICAgICAgICAgLy8gTk9URTogV2UgYXBwbHkgdGhpcyBBRlRFUiB0aGUgYW5pbWF0aW9uIG1peGVyIGhhcyBwb3NlZCBib25lcywgYXMgYSBzbWFsbCBhZGRpdGl2ZSBvZmZzZXQuCiAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgLy8gQWltIGRpcmVjdGlvbiAocHJlZmVyIGV4cGxpY2l0IGFpbSB2ZWN0b3IpCiAgICAgICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5vdmVycmlkZUFpbVZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubG9ja2VkQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLmxvY2tlZEFpbVZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wOCkgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5pbnB1dFZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2hvdWxkQXBwbHkgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICAvLyBMb29rIGF0IHRoZSBiYWxsIGlmIGl0J3MgaW4gdGhlICJhd2FyZW5lc3MiIHJhZGl1cwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDIwLjApIHsKICAgICAgICAgICAgICAgICAgICBfcFZlYy5zdWJWZWN0b3JzKGJhbGwubWVzaC5wb3NpdGlvbiwgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICBzaG91bGRBcHBseSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghc2hvdWxkQXBwbHkpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENvbnZlcnQgdGhlIGRpcmVjdGlvbiBpbnRvIHRoZSBwbGF5ZXIncyBsb2NhbCBzcGFjZSBzbyB5YXcvcGl0Y2ggYXJlIHN0YWJsZS4KICAgICAgICAgICAgX3BJbnZRdWF0LmNvcHkodGhpcy5tZXNoLnF1YXRlcm5pb24pLmludmVydCgpOwogICAgICAgICAgICBfcFZlYy5hcHBseVF1YXRlcm5pb24oX3BJbnZRdWF0KS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIGNvbnN0IGx4ID0gX3BWZWMueCwgbHkgPSBfcFZlYy55LCBseiA9IF9wVmVjLno7CiAgICAgICAgICAgIGNvbnN0IHlhdyA9IE1hdGguYXRhbjIobHgsIGx6KTsKICAgICAgICAgICAgY29uc3QgcGl0Y2ggPSBNYXRoLmF0YW4yKGx5LCBNYXRoLnNxcnQobHggKiBseCArIGx6ICogbHopICsgMWUtNik7CgogICAgICAgICAgICBjb25zdCB5YXdDID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHlhdywgLTAuOSwgMC45KTsKICAgICAgICAgICAgY29uc3QgcGl0Y2hDID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHBpdGNoLCAtMC42LCAwLjYpOwoKICAgICAgICAgICAgY29uc3Qgc3BlZWROb3JtID0gKHRoaXMubWF4U3BlZWQgPiAwLjAwMDEpID8gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHRoaXMuX3Ntb290aGVkU3BlZWQgLyB0aGlzLm1heFNwZWVkLCAwLCAxKSA6IDA7CiAgICAgICAgICAgIGNvbnN0IGFpbVcgPSAodGhpcy5oYXNCYWxsID8gKHRoaXMuaXNDaGFyZ2luZyA/IDEuMCA6IDAuNjUpIDogMC4zNSkgKiAoMS4wIC0gMC4zNSAqIHNwZWVkTm9ybSk7CiAgICAgICAgICAgIGNvbnN0IGhlYWRXID0gKHRoaXMuaGFzQmFsbCA/IDAuNTUgOiAwLjc1KSAqICgxLjAgLSAwLjI1ICogc3BlZWROb3JtKTsKCiAgICAgICAgICAgIC8vIFRvcnNvIGJpYXMgKHNwaW5lL2NoZXN0KQogICAgICAgICAgICBpZiAoYi5jaGVzdCkgewogICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMjAgKiBhaW1XLCB5YXdDICogMC4zNSAqIGFpbVcsIDApOwogICAgICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgICAgIGIuY2hlc3QucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGIuc3BpbmUpIHsKICAgICAgICAgICAgICAgIF9wVG1wRXVsZXIuc2V0KC1waXRjaEMgKiAwLjE1ICogYWltVywgeWF3QyAqIDAuMjUgKiBhaW1XLCAwKTsKICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICBiLnNwaW5lLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSGVhZC9uZWNrIGxvb2sKICAgICAgICAgICAgaWYgKGIubmVjaykgewogICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMjUgKiBoZWFkVywgeWF3QyAqIDAuNDUgKiBoZWFkVywgMCk7CiAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgYi5uZWNrLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYi5oZWFkKSB7CiAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldCgtcGl0Y2hDICogMC4zMCAqIGhlYWRXLCB5YXdDICogMC41NSAqIGhlYWRXLCAwKTsKICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICBiLmhlYWQucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCYWxsLWhvbGQgLyBhaW0gYXJtIHBvc2UgKGtlZXBzICJzd2ltIiBhbmltYXRpb24gYnV0IHJlYWRzIGFzIGhvbGRpbmcvYWltaW5nKQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmICF0aGlzLmlzVGhyb3dpbmcgJiYgIXRoaXMuX2FuaW1Mb2NrZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLl9wcm9jQW5pbVRpbWU7CiAgICAgICAgICAgICAgICBjb25zdCBsaWZ0ID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKDAuMzUgKyAodGhpcy5pc0NoYXJnaW5nID8gMC41NSA6IDAuMjUpIC0gc3BlZWROb3JtICogMC4yLCAwLjE1LCAwLjk1KTsKICAgICAgICAgICAgICAgIGNvbnN0IHN3YXkgPSBNYXRoLnNpbih0ICogNS4wKSAqIDAuMDUgKiAoMC41ICsgbGlmdCk7CgogICAgICAgICAgICAgICAgY29uc3QgcmFpc2VYID0gLTAuNTUgKiBsaWZ0ICsgc3dheTsKICAgICAgICAgICAgICAgIGNvbnN0IHJhaXNlWiA9IC0wLjI1ICogbGlmdDsKCiAgICAgICAgICAgICAgICBpZiAoYi5yVXBwZXJBcm0pIHsKICAgICAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldChyYWlzZVgsIHlhd0MgKiAwLjEwICogbGlmdCwgcmFpc2VaKTsKICAgICAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIGIuclVwcGVyQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChiLnJGb3JlQXJtKSB7CiAgICAgICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLTAuMzUgKiBsaWZ0ICsgc3dheSAqIDAuNSwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgICAgICAgICBiLnJGb3JlQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDb3VudGVyYmFsYW5jZSBsZWZ0IGFybSBzbGlnaHRseSBmb3IgYSBtb3JlIGR5bmFtaWMgc2lsaG91ZXR0ZQogICAgICAgICAgICAgICAgaWYgKGIubFVwcGVyQXJtKSB7CiAgICAgICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoMC4xNSAqIGxpZnQsIC15YXdDICogMC4wNSAqIGxpZnQsIDAuMTUgKiBsaWZ0KTsKICAgICAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIGIubFVwcGVyQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KX3VwZGF0ZVN0YXR1cyhkdCkgewogICAgICAgIC8vIExlZ2FjeSB3cmFwcGVyCiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzTG9naWMoZHQpOwogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXR1c1Zpc3VhbHMoZHQpOwogICAgfQoKICAgIF91cGRhdGVTdGF0dXNMb2dpYyhkdCkgewogICAgICAgIGlmICh0aGlzLnN0YXR1cy52ZW5vbSA+IDApIHsKICAgICAgICAgICAgdGhpcy5zdGF0dXMudmVub20gLT0gZHQ7CiAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gNSAqIGR0OwogICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA8IDApIHRoaXMuc3RhdHMuSFAgPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsICYmIHRoaXMuc3RhdHMuSFAgPCB0aGlzLnN0YXRzLm1heEhQKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQICs9IDUgKiBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQID4gdGhpcy5zdGF0cy5tYXhIUCkgdGhpcy5zdGF0cy5IUCA9IHRoaXMuc3RhdHMubWF4SFA7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSAyLjAgKiBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPCAwKSB0aGlzLnN0YXRzLkhQID0gMDsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdHVzLm5hcCAtPSBkdDsKICAgICAgICB9CgogICAgICAgIGZvciAobGV0IGtleSBpbiB0aGlzLnN0YXR1cy53aXRoZXIpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltrZXldID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMud2l0aGVyW2tleV0gLT0gZHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgX3VwZGF0ZVN0YXR1c1Zpc3VhbHMoZHQpIHsKICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIgOiBudWxsOwoKICAgICAgICBpZiAodGhpcy5zdGF0dXMudmVub20gPiAwKSB7CiAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnZlbm9tIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgcG0uc3Bhd24oJ3Zlbm9tJywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnZlbm9tID0gMC4xNTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMubmFwIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMubmFwIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgIHBtLnNwYXduKCduYXAnLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMubmFwID0gMC44OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsZXQgaXNXaXRoZXJpbmcgPSBmYWxzZTsKICAgICAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5zdGF0dXMud2l0aGVyKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy53aXRoZXJba2V5XSA+IDApIGlzV2l0aGVyaW5nID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmIChpc1dpdGhlcmluZykgewogICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgcG0uc3Bhd24oJ3dpdGhlcicsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgPSAwLjI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbHMoKTsKICAgIH0KCl91cGRhdGVWaXN1YWxzKCkgewogICAgICAgICAgICAvLyBSRU1PVkVEOiBZZWxsb3cgc3BoZXJlL3RpbnQgbG9naWMgYXMgcGVyIHJlcXVlc3QuCiAgICAgICAgICAgIC8vIEFsd2F5cyByZXZlcnQgdG8gYmFzZSBjb2xvci4KICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5mb3JFYWNoKGVudHJ5ID0+IHsKICAgICAgICAgICAgICAgIGVudHJ5Lm1hdGVyaWFsLmNvbG9yLmNvcHkoZW50cnkuYmFzZUNvbG9yKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfY3JlYXRlQXVyYSgpIHsKICAgICAgICAgICAgLy8gQXVyYSByZW1vdmVkIHBlciB1c2VyIHJlcXVlc3QKICAgICAgICAgICAgdGhpcy5hdXJhTWVzaCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IFBhc3MgdGFyZ2V0IGluZGljYXRvcgogICAgICAgIF9jcmVhdGVQYXNzVGFyZ2V0SW5kaWNhdG9yKCkgewogICAgICAgICAgICAvLyBDcmVhdGUgYSByaW5nIHRoYXQgaGlnaGxpZ2h0cyBwb3RlbnRpYWwgcGFzcyB0YXJnZXRzCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMC44LCAxLjAsIDE2KTsKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgICAgIGNvbG9yOiAweDAwZmYwMCwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yID0gbmV3IFRIUkVFLk1lc2goZ2VvLCBtYXQpOwogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3Iucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnBvc2l0aW9uLnkgPSAwLjE7CiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMucGFzc1RhcmdldEluZGljYXRvcik7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlUGFzc1RhcmdldEluZGljYXRvcnMoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8ICF0aGlzLnRlYW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGaW5kIGJlc3QgcGFzcyB0YXJnZXQKICAgICAgICAgICAgY29uc3QgYWltRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5fZmluZFBhc3NUYXJnZXRJbkNvbmUoYWltRGlyKTsKCiAgICAgICAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0Lm1lc2ggJiYgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueCA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLng7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueiA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLno7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci5yb3RhdGlvbi56ICs9IDAuMDU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpIHsKICAgICAgICAgICAgaWYgKHRoaXMucGFzc1RhcmdldEluZGljYXRvcikgewogICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9hcHBseVNvZnRDb2xsaXNpb24oZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2ggfHwgIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgdGVhbXMgPSBbZ2FtZS50ZWFtcy5ob21lLCBnYW1lLnRlYW1zLmF3YXldOwoKICAgICAgICAgICAgY29uc3QgcmVwdWxzaW9uUmFkaXVzID0gMC41OyAvLyBSZWR1Y2VkIHRvIDAuNSB0byBmaXggaW52aXNpYmxlIHdhbGwgaXNzdWVzCiAgICAgICAgICAgIGNvbnN0IHN0aWZmbmVzcyA9IDE1LjA7CgogICAgICAgICAgICB0ZWFtcy5mb3JFYWNoKHRlYW0gPT4gewogICAgICAgICAgICAgICAgaWYgKCF0ZWFtKSByZXR1cm47CiAgICAgICAgICAgICAgICB0ZWFtLnBsYXllcnMuZm9yRWFjaChvdGhlciA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG90aGVyID09PSB0aGlzIHx8ICFvdGhlci5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGR4ID0gdGhpcy5tZXNoLnBvc2l0aW9uLnggLSBvdGhlci5tZXNoLnBvc2l0aW9uLng7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHkgPSB0aGlzLm1lc2gucG9zaXRpb24ueSAtIG90aGVyLm1lc2gucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkeiA9IHRoaXMubWVzaC5wb3NpdGlvbi56IC0gb3RoZXIubWVzaC5wb3NpdGlvbi56OwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR5KmR5ICsgZHoqZHo7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWluRGlzdCA9IHJlcHVsc2lvblJhZGl1cyAqIDIuMDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IG1pbkRpc3QgKiBtaW5EaXN0ICYmIGRpc3RTcSA+IDAuMDAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG92ZXJsYXAgPSBtaW5EaXN0IC0gZGlzdDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gb3ZlcmxhcCAqIHN0aWZmbmVzczsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG54ID0gZHggLyBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBueSA9IGR5IC8gZGlzdDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbnogPSBkeiAvIGRpc3Q7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gbnggKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKz0gbnkgKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gbnogKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICB0aGlzLl9hcHBseVNvZnRDb2xsaXNpb24oZHQpOwogICAgICAgICAgICB0aGlzLl9hcHBseUdvYWxDcmVhc2UoZHQpOwoKICAgICAgICAgICAgY29uc3QgaW5wdXRMZW5TcSA9IHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKTsKICAgICAgICAgICAgY29uc3QgaXNJbnB1dEFjdGl2ZSA9IGlucHV0TGVuU3EgPiAwLjAxOwoKICAgICAgICAgICAgbGV0IGN1cnJlbnRNYXhTcGVlZCA9IHRoaXMubWF4U3BlZWQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTVFJVR0dMRSBTVEFURTogSGluZGVyIG1vdmVtZW50IGJhc2VkIG9uIHByZXNzdXJlCiAgICAgICAgICAgIC8vIEluc3RlYWQgb2YgYSBiaW5hcnkgMC44IG11bHRpcGxpZXIsIHdlIHNjYWxlIGJhc2VkIG9uIGludGVuc2l0eS4KICAgICAgICAgICAgLy8gTWF4IHN0cnVnZ2xlICgxLjApIHJlZHVjZXMgc3BlZWQgdG8gNDAlLgogICAgICAgICAgICBpZiAodGhpcy5zdHJ1Z2dsZUludGVuc2l0eSA+IDApIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRNYXhTcGVlZCAqPSAoMS4wIC0gKHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgKiAwLjYpKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgc2xpZ2h0IHJlZHVjdGlvbiBpZiBlbmdhZ2VkIGJ1dCBsb3cgcHJlc3N1cmUKICAgICAgICAgICAgICAgIGN1cnJlbnRNYXhTcGVlZCAqPSAwLjk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmlzQ2hhcmdpbmcpIGN1cnJlbnRNYXhTcGVlZCAqPSAwLjk7CgogICAgICAgICAgICBpZiAoaXNJbnB1dEFjdGl2ZSkgewogICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLmlucHV0VmVjdG9yKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSBTdHJ1Z2dsZSBKaXR0ZXIgdG8gZGlyZWN0aW9uCiAgICAgICAgICAgICAgICAvLyBTaW11bGF0ZXMgd3Jlc3RsaW5nIGZvciBjb250cm9sCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdHJ1Z2dsZUludGVuc2l0eSA+IDAuMykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGppdHRlciA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgKiAwLjg7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMueCArPSBqaXR0ZXI7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMueiArPSBqaXR0ZXI7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0VmVsWCA9IF9wVmVjLnggKiBjdXJyZW50TWF4U3BlZWQ7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRWZWxaID0gX3BWZWMueiAqIGN1cnJlbnRNYXhTcGVlZDsKCiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50U3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWRSYXRpbyA9IE1hdGgubWluKDEuMCwgY3VycmVudFNwZWVkIC8gdGhpcy5tYXhTcGVlZCk7CgogICAgICAgICAgICAgICAgLy8gQWdpbGl0eSBpcyByZWR1Y2VkIHdoZW4gc3RydWdnbGluZwogICAgICAgICAgICAgICAgbGV0IGFnaWxpdHkgPSBUSFJFRS5NYXRoVXRpbHMubGVycCgxMC4wLCAyLjAsIHNwZWVkUmF0aW8pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPiAwKSBhZ2lsaXR5ICo9IDAuNTsKCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gMS4wIC0gTWF0aC5wb3coMC4wMSwgZHQgKiBhZ2lsaXR5KTsKCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gKHRhcmdldFZlbFggLSB0aGlzLnZlbG9jaXR5LngpICogdDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiArPSAodGFyZ2V0VmVsWiAtIHRoaXMudmVsb2NpdHkueikgKiB0OwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJyYWtlRmFjdG9yID0gMi4wOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IDEuMCAtIE1hdGgucG93KDAuMSwgZHQgKiBicmFrZUZhY3Rvcik7CgogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9ICgwIC0gdGhpcy52ZWxvY2l0eS54KSAqIHQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gKDAgLSB0aGlzLnZlbG9jaXR5LnopICogdDsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMC4wMSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIHRoaXMudmVsb2NpdHkueSwgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSBNYXRoLm1heCgwLCAxLjAgLSAoMi4wICogZHQpKTsKCiAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoZHQpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVWZXJ0aWNhbGl0eShkdCkgewogICAgICAgICAgICBsZXQgdGFyZ2V0WSA9IDA7CgogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CgogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2ggJiYgIXRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvQmFsbCA8IDE1LjApIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRZID0gYmFsbC5tZXNoLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRhcmdldFkgPSAwLjU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHlEaWZmID0gdGFyZ2V0WSAtIHRoaXMubWVzaC5wb3NpdGlvbi55OwoKICAgICAgICAgICAgY29uc3QgbGlmdCA9IHlEaWZmICogMTAuMCAqIGR0OwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKz0gbGlmdDsKCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gucG9zaXRpb24ueSA+IDguMCkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSA4LjA7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLTAuNTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLm1lc2gucG9zaXRpb24ueSA8IC04LjApIHsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gLTguMDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSAtMC41OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBGSVhFRDogSW1wcm92ZWQgYmFua2luZyB3aXRoIGh5c3RlcmVzaXMgdG8gcHJldmVudCBmYWNpbmcgZmxpcHMKLy8gRklYRUQ6IEltcHJvdmVkIGJhbmtpbmcgd2l0aCBoeXN0ZXJlc2lzIHRvIHByZXZlbnQgZmFjaW5nIGZsaXBzCiAgICAgICAgX3VwZGF0ZUJhbmtpbmcoZHQpIHsKICAgICAgICAgICAgY29uc3QgaW5wdXRMZW5TcSA9IHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKTsKICAgICAgICAgICAgY29uc3QgdmVsTGVuU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CgogICAgICAgICAgICBsZXQgdGFyZ2V0WWF3ID0gdGhpcy50YXJnZXRZYXc7CiAgICAgICAgICAgIGxldCBzaG91bGRVcGRhdGVZYXcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDE6IEV4cGxpY2l0IEFpbSAoQWltIFN0aWNrIC8gU3dpcGUpCiAgICAgICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IueCwgdGhpcy5vdmVycmlkZUFpbVZlY3Rvci56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUFJJT1JJVFkgMjogTW92ZW1lbnQgSW5wdXQKICAgICAgICAgICAgZWxzZSBpZiAoaW5wdXRMZW5TcSA+IHRoaXMuZmFjaW5nRGVhZHpvbmUgKiB0aGlzLmZhY2luZ0RlYWR6b25lKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMuaW5wdXRWZWN0b3IueCwgdGhpcy5pbnB1dFZlY3Rvci56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDM6IFZlbG9jaXR5IChEcmlmdGluZykKICAgICAgICAgICAgZWxzZSBpZiAodmVsTGVuU3EgPiB0aGlzLmZhY2luZ0RlYWR6b25lICogdGhpcy5mYWNpbmdEZWFkem9uZSkgewogICAgICAgICAgICAgICAgdGFyZ2V0WWF3ID0gTWF0aC5hdGFuMih0aGlzLnZlbG9jaXR5LngsIHRoaXMudmVsb2NpdHkueik7CiAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGVZYXcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB3ZSBzaG91bGQgdXBkYXRlLCBkbyBzby4gT3RoZXJ3aXNlIGtlZXAgbGFzdCB2YWxpZCB5YXcKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZVlhdykgewogICAgICAgICAgICAgICAgdGhpcy5sYXN0VmFsaWRZYXcgPSB0YXJnZXRZYXc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSB0aGlzLmxhc3RWYWxpZFlhdzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU21vb3RoIFlhdyB3aXRoIHdyYXAtYXJvdW5kIGhhbmRsaW5nCiAgICAgICAgICAgIGxldCBkaWZmID0gdGFyZ2V0WWF3IC0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICB3aGlsZSAoZGlmZiA+IE1hdGguUEkpIGRpZmYgLT0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgIHdoaWxlIChkaWZmIDwgLU1hdGguUEkpIGRpZmYgKz0gTWF0aC5QSSAqIDI7CgogICAgICAgICAgICBjb25zdCBzcGVlZFJhdGlvID0gTWF0aC5taW4oMS4wLCB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpIC8gdGhpcy5tYXhTcGVlZCk7CmNvbnN0IHR1cm5TcGVlZCA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDguMCwgNC4wLCBzcGVlZFJhdGlvKTsgLy8gUmVkdWNlZCBmcm9tIDEyLjAvNi4wIHRvIHJlZHVjZSBmbGlwcGluZwoKICAgICAgICAgICAgLy8gUHJldmVudCBzdWRkZW4gc25hcHMgd2hlbiBkaWZmIGlzIHZlcnkgbGFyZ2UgKHRlbGVwb3J0L3Jlc2V0IHNjZW5hcmlvcykKICAgICAgICAgICAgY29uc3QgbWF4WWF3Q2hhbmdlID0gTWF0aC5QSSAqIGR0ICogdHVyblNwZWVkOwogICAgICAgICAgICBjb25zdCB5YXdDaGFuZ2UgPSBNYXRoLm1heCgtbWF4WWF3Q2hhbmdlLCBNYXRoLm1pbihtYXhZYXdDaGFuZ2UsIGRpZmYgKiBkdCAqIHR1cm5TcGVlZCkpOwoKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ICs9IHlhd0NoYW5nZTsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSB0YXJnZXRZYXc7CgogICAgICAgICAgICAvLyBCYW5raW5nCiAgICAgICAgICAgIGNvbnN0IGJhbmtTZW5zaXRpdml0eSA9IDAuODsKICAgICAgICAgICAgY29uc3QgbWF4QmFuayA9IDAuNzU7CgogICAgICAgICAgICBsZXQgdGFyZ2V0QmFuayA9IC1kaWZmICogYmFua1NlbnNpdGl2aXR5OwogICAgICAgICAgICB0YXJnZXRCYW5rID0gTWF0aC5tYXgoLW1heEJhbmssIE1hdGgubWluKG1heEJhbmssIHRhcmdldEJhbmspKTsKCiAgICAgICAgICAgIGNvbnN0IGJhbmtMZXJwID0gMS4wIC0gTWF0aC5wb3coMC4wMiwgZHQpOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgKz0gKHRhcmdldEJhbmsgLSB0aGlzLmJhbmtpbmdBbW91bnQpICogYmFua0xlcnA7CgogICAgICAgICAgICAvLyBQaXRjaAogICAgICAgICAgICBjb25zdCBwaXRjaFNlbnNpdGl2aXR5ID0gMC4xOwogICAgICAgICAgICBjb25zdCBtYXhQaXRjaCA9IDEuMDsKCiAgICAgICAgICAgIGxldCB0YXJnZXRQaXRjaCA9IC10aGlzLnZlbG9jaXR5LnkgKiBwaXRjaFNlbnNpdGl2aXR5OwogICAgICAgICAgICB0YXJnZXRQaXRjaCA9IE1hdGgubWF4KC1tYXhQaXRjaCwgTWF0aC5taW4obWF4UGl0Y2gsIHRhcmdldFBpdGNoKSk7CgogICAgICAgICAgICBjb25zdCBwaXRjaExlcnAgPSAxLjAgLSBNYXRoLnBvdygwLjA1LCBkdCk7CiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgKz0gKHRhcmdldFBpdGNoIC0gdGhpcy5waXRjaEFtb3VudCkgKiBwaXRjaExlcnA7CgogICAgICAgICAgICAvLyBBcHBseSBSb3RhdGlvbgogICAgICAgICAgICBjb25zdCBmaW5hbFlhdyA9IHRoaXMuY3VycmVudFlhdyArIHRoaXMucm90YXRpb25PZmZzZXQ7CgogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5zZXRGcm9tQXhpc0FuZ2xlKF9wQXhpc1ksIGZpbmFsWWF3KTsKCiAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDEsIDAsIDApLCB0aGlzLnBpdGNoQW1vdW50KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BRdWF0KTsKCiAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLCB0aGlzLmJhbmtpbmdBbW91bnQpOwogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseShfcFF1YXQpOwoKICAgICAgICAgICAgLy8gSWRsZSBCb2IKICAgICAgICAgICAgaWYgKHZlbExlblNxIDwgMC4xICYmICF0aGlzLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IERhdGUubm93KCkgKiAwLjAwMTU7CiAgICAgICAgICAgICAgICBjb25zdCBib2JQaXRjaCA9IE1hdGguc2luKHRpbWUpICogMC4wMzsKICAgICAgICAgICAgICAgIGNvbnN0IGJvYlJvbGwgPSBNYXRoLmNvcyh0aW1lICogMC43KSAqIDAuMDI7CgpfcEV1bGVyLnNldChib2JQaXRjaCwgMCwgYm9iUm9sbCk7CiAgICAgICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUV1bGVyKF9wRXVsZXIpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BRdWF0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9jaGVja1RhY2tsZVByZXNzdXJlKGR0KSB7CiAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNFbmdhZ2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIXRoaXMudGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CiAgICAgICAgICAgIGlmICghb3Bwb25lbnRUZWFtKSByZXR1cm47CgogICAgICAgICAgICBsZXQgdG90YWxQcmVzc3VyZSA9IDA7CiAgICAgICAgICAgIGxldCBlbmdhZ2VkQ291bnQgPSAwOwogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVSYWRpdXMgPSB0aGlzLnRhY2tsZVJhZGl1czsgCgogICAgICAgICAgICAvLyBGb3J3YXJkIHZlY3RvciBmb3Igc2hpZWxkaW5nIGNoZWNrCiAgICAgICAgICAgIF9wVmVjLmNvcHkoX3BBeGlzWikuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsgCgogICAgICAgICAgICBmb3IgKGNvbnN0IGVudGl0eSBvZiBvcHBvbmVudFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCB8fCBlbnRpdHkuc3RhdHVzLm5hcCA+IDAgfHwgZW50aXR5LnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oZW50aXR5Lm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCBlZmZlY3RpdmVSYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICBlbmdhZ2VkQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgUHJlc3N1cmUgSW50ZW5zaXR5ICgwIHRvIDEgYmFzZWQgb24gZGlzdGFuY2UpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJveGltaXR5ID0gMS4wIC0gKGRpc3QgLyBlZmZlY3RpdmVSYWRpdXMpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEJhc2UgUHJlc3N1cmUgZnJvbSBBVCBzdGF0CiAgICAgICAgICAgICAgICAgICAgbGV0IHByZXNzdXJlID0gZW50aXR5LmdldFN0YXQoJ0FUJykgKiBwcm94aW1pdHk7CgogICAgICAgICAgICAgICAgICAgIC8vIERpcmVjdGlvbmFsIFNoaWVsZGluZyAoQ29udGludW91cykKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b09wcCA9IGVudGl0eS5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZG90ID0gX3BWZWMuZG90KHRvT3BwKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJZiBvcHBvbmVudCBpcyBCRUhJTkQgKGRvdCA8IC0wLjIpLCBwcmVzc3VyZSBpcyByZWR1Y2VkIChTaGllbGRpbmcpCiAgICAgICAgICAgICAgICAgICAgbGV0IGlzU2hpZWxkZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoZG90IDwgLTAuMikgewogICAgICAgICAgICAgICAgICAgICAgICBwcmVzc3VyZSAqPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzU2hpZWxkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gVGVjaCBNb2RpZmllcnMgKENvbnRpbnVvdXMgYXBwbGljYXRpb24gY2hhbmNlKQogICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkudGVjaHMudGFja2xlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgZHQgKiAwLjUpIHRoaXMuYXBwbHlTdGF0dXMoJ3Zlbm9tJywgNS4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMS4yOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCBkdCAqIDAuNSkgdGhpcy5hcHBseVN0YXR1cygnd2l0aGVyJywgNS4wLCAnRU4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMS4yOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ2RyYWluJykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkcmFpbkFtdCA9IHByZXNzdXJlICogZHQgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gZHJhaW5BbXQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eS5zdGF0cy5IUCArPSBkcmFpbkFtdDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRvdGFsUHJlc3N1cmUgKz0gcHJlc3N1cmU7CgogICAgICAgICAgICAgICAgICAgIC8vIFZpc3VhbHM6IFNwYXJrcyBvY2Nhc2lvbmFsbHkgYmFzZWQgb24gcHJlc3N1cmUKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IGR0ICogNC4wICogcHJveGltaXR5KSB7IAogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuc3Bhd25DbGFzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWlkID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkubGVycChlbnRpdHkubWVzaC5wb3NpdGlvbiwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pZC55ICs9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuc3Bhd25DbGFzaChtaWQsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gT2NjYXNpb25hbCBTaGllbGQgVGV4dAogICAgICAgICAgICAgICAgICAgIGlmIChpc1NoaWVsZGVkICYmIE1hdGgucmFuZG9tKCkgPCBkdCAqIDEuMCAmJiBnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU0hJRUxEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiYmxvY2siKTsgLy8gVG9vIHNwYW1teSwgbWF5YmUganVzdCBzb3VuZCBsYXRlcgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5pc0VuZ2FnZWQgPSAoZW5nYWdlZENvdW50ID4gMCk7CgogICAgICAgICAgICBpZiAodGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5jb3VudGVyVGltZXIgKz0gZHQ7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgRU4gRHJhaW4gKENvbnRpbnVvdXMpCiAgICAgICAgICAgICAgICAvLyBTY2FsaW5nOiAyMCBBVCBwcmVzc3VyZSAtPiBhcHByb3ggMTAgRU4gbG9zdCBwZXIgc2Vjb25kCiAgICAgICAgICAgICAgICBjb25zdCBkcmFpblJhdGUgPSB0b3RhbFByZXNzdXJlICogMC41OyAKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOIC09IGRyYWluUmF0ZSAqIGR0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgU3RydWdnbGUgSW50ZW5zaXR5IGZvciBQaHlzaWNzICgwLjAgdG8gMS4wKQogICAgICAgICAgICAgICAgLy8gTWF4IHN0cnVnZ2xlIGF0IHJvdWdobHkgMzAgcHJlc3N1cmUKICAgICAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSBNYXRoLm1pbigxLjAsIHRvdGFsUHJlc3N1cmUgLyAzMC4wKTsKCiAgICAgICAgICAgICAgICAvLyBWaXN1YWwgRmVlZGJhY2sgZm9yIERyYWluIChBY2N1bXVsYXRlIHRvIGF2b2lkIHNwYW0pCiAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSArPSBkcmFpblJhdGUgKiBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSA+IDUuMCkgewogICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bihgLSR7TWF0aC5mbG9vcih0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSl9YCwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkRGFtYWdlID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSGludCBmb3IgcGxheWVyIGlmIGVuZ2FnZWQgdG9vIGxvbmcKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVuY291bnRlclRpbWVyID4gMS4wICYmIHRoaXMuZW5jb3VudGVyVGltZXIgPCAxLjEgJiYgdGhpcy50ZWFtLmlzSHVtYW4gJiYgdGhpcy50ZWFtLmFjdGl2ZVBsYXllciA9PT0gdGhpcykgewogICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJCUkVBSyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDw9IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuZnVtYmxlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9wZXJmb3JtSmVjaHRLbm9ja2JhY2soKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwoKICAgICAgICAgICAgaWYgKCFvcHBvbmVudFRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHJhbmdlID0gNi4wOwogICAgICAgICAgICBjb25zdCBmb3JjZSA9IDI1LjA7CgogICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJKRUNIVCBTSE9UISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImdvYWwiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgb3Bwb25lbnRUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ocC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBkaXIueSA9IDAuNTsKICAgICAgICAgICAgICAgICAgICBkaXIubm9ybWFsaXplKCk7CgpwLnZlbG9jaXR5LmFkZChkaXIubXVsdGlwbHlTY2FsYXIoZm9yY2UpKTsKCiAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAyLjA7IC8vIEVuc3VyZSB0aGV5IHN0YXkgZG93bgogICAgICAgICAgICAgICAgICAgIHAuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVhY3RBY3Rpb24gPSBwLmFjdGlvbnMgJiYgcC5hY3Rpb25zWydyZWFjdCddOwogICAgICAgICAgICAgICAgICAgIGlmIChyZWFjdEFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZWFjdEFjdGlvbi5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVhY3RBY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXlPbmVTaG90KCdyZWFjdCcsIDAuMSk7Cn0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2gnLCAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTTUFDSyEiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUudHJpZ2dlckltcGFjdCkgZ2FtZS50cmlnZ2VySW1wYWN0KDAuMTUsICdzaGF0dGVyJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVtYmxlKCkgewogICAgICAgICAgICBjb25zb2xlLmxvZygiRlVNQkxFISBFTiBEZXBsZXRlZC4iKTsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgdGhpcy5tZXNoKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDUkFTSCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zdHVuVGltZXIgPSAxLjU7CgogICAgICAgICAgICBjb25zdCBiYWNrRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgYmFja0Rpci54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgYmFja0Rpci56ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgYmFja0Rpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKGJhY2tEaXIubXVsdGlwbHlTY2FsYXIoMTIuMCkpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgaWYgKGJhbGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlamVjdERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKE1hdGgucmFuZG9tKCktMC41LCAwLjgsIE1hdGgucmFuZG9tKCktMC41KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBiYWxsLnNob290KGVqZWN0RGlyLCA2LjAsICdub25lJyk7CnRoaXMubG9zZUJhbGwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZGFzaCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzRGFzaGluZyB8fCB0aGlzLmRhc2hDb29sZG93biA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKCiAgICAgICAgICAgIC8vIE9GRkVOU0U6IEJSRUFLIFRBQ0tMRQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmIHRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjb3N0ID0gMTU7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkZBSUxFRCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mdW1ibGUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDIuMDsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnYnJlYWsnOwoKX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CnRoaXMudmVsb2NpdHkuYWRkKF9wVmVjLm11bHRpcGx5U2NhbGFyKDEwLjApKTsgLy8gTmVyZmVkIGZyb20gMTUuMCBmb3IgcmVhbGlzbQoKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW1JZCA9IHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CgogICAgICAgICAgICAgICAgb3Bwb25lbnRUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgdGhpcy50YWNrbGVSYWRpdXMgKiAxLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVzaERpciA9IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBwdXNoRGlyLnkgPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuYWRkKHB1c2hEaXIubXVsdGlwbHlTY2FsYXIoMTUuMCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2gnLCAwLjIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU1RVTiEiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJSRUFLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAovLyBORVc6IFNwYXduIEJyZWFrIEdseXBoIChFeHBsb3NpdmUgQnVyc3QpCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLmdseXBoTWFuYWdlci5zcGF3bignc3RhdHVzJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC41LAogICAgICAgICAgICAgICAgICAgICAgICByb3RhdGlvblNwZWVkOiA4LjAsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IDMuMCwKICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WTogMC41CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKLy8gUGFydGljbGUgQnVyc3QgKEJyZWFrIFRhY2tsZSkKLy8gUGFydGljbGUgQnVyc3QgKEJyZWFrIFRhY2tsZSkKICAgICAgICAgICAgICAgIGlmIChnYW1lLnBhcnRpY2xlTWFuYWdlcikgewpmb3IobGV0IGk9MDsgaTwzMDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAyLjUgfSk7CiAgICAgICAgICAgICAgICAgICAgLy8gQnViYmxlIEJ1cnN0CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBidWJibGVQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSoyLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMikpOwogICAgICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgYnViYmxlUG9zLCB7IHNjYWxlOiAwLjIgKyBNYXRoLnJhbmRvbSgpICogMC40IH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS50cmlnZ2VySW1wYWN0KSBnYW1lLnRyaWdnZXJJbXBhY3QoMC4xNSwgJ2hlYXZ5Jyk7CgogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE9GRkVOU0U6IFNQUklOVAogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjb3N0ID0gNTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRFTiA8IGNvc3QpIHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJOTyBFTiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOIC09IGNvc3Q7CiAgICAgICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gMC40OwogICAgICAgICAgICAgICAgdGhpcy5kYXNoQ29vbGRvd24gPSAxLjU7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ3NwcmludCc7Cgpjb25zdCBidXJzdERpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGlmIChidXJzdERpci5sZW5ndGhTcSgpIDwgMC4xKSBidXJzdERpci5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKCnRoaXMudmVsb2NpdHkuYWRkKGJ1cnN0RGlyLm11bHRpcGx5U2NhbGFyKDEyLjApKTsgLy8gTmVyZmVkIGZyb20gMTUuMAogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcpOwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZEZvdkltcHVsc2UoMjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJEQVNIISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gREVGRU5TRTogQkxPQ0sgLyBUQUNLTEUKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBsZXQgaXNCbG9ja0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgOC4wICYmIGJhbGwubWVzaC5wb3NpdGlvbi55ID4gMi41KSB7CiAgICAgICAgICAgICAgICAgICAgaXNCbG9ja0NvbnRleHQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSB0aGlzLmRhc2hUb3RhbFRpbWU7CiAgICAgICAgICAgIHRoaXMuZGFzaENvb2xkb3duID0gMS41OwoKICAgICAgICAgICAgY29uc3QgbGVuID0gTWF0aC5zcXJ0KHgqeCArIHoqeik7CiAgICAgICAgICAgIGNvbnN0IG54ID0gKGxlbiA+IDApID8geC9sZW4gOiAwOwogICAgICAgICAgICBjb25zdCBueiA9IChsZW4gPiAwKSA/IHovbGVuIDogMDsKCmlmIChsZW4gPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBTbW9vdGggdHVybiBmb3IgZGFzaCBpbnN0ZWFkIG9mIHNuYXAKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0WWF3ID0gTWF0aC5hdGFuMihueCwgbnopOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc0Jsb2NrQ29udGV4dCkgewogICAgICAgICAgICAgICAgdGhpcy5kYXNoVHlwZSA9ICd2ZXJ0aWNhbCc7CgogICAgICAgICAgICAgICAgY29uc3QgZGlyVG9CYWxsID0gYmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBkaXJUb0JhbGwueSA9IDA7CgogICAgICAgICAgICAgICAgaWYgKGRpclRvQmFsbC5sZW5ndGhTcSgpID4gMC4wMSkgewogICAgICAgICAgICAgICAgICAgIGRpclRvQmFsbC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2hWZWMuY29weShkaXJUb0JhbGwpLm11bHRpcGx5U2NhbGFyKDguMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZGFzaFZlYy5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgY2F0Y2hBY3Rpb24gPSB0aGlzLmFjdGlvbnNbJ2NhdGNoJ107CiAgICAgICAgICAgICAgICBpZiAoY2F0Y2hBY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICBjYXRjaEFjdGlvbi5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgICAgICBjYXRjaEFjdGlvbi5jbGFtcFdoZW5GaW5pc2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hBY3Rpb24udGltZVNjYWxlID0gMS41OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wbGF5KCdjYXRjaCcsIDAuMSk7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTE9DSyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkZWZhdWx0Iik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5kYXNoVHlwZSA9ICdob3Jpem9udGFsJzsKICAgICAgICAgICAgICAgIHRoaXMuX2hhc0hpdFRhY2tsZSA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IHZlbG9jaXR5IGltcHVsc2UgaW4gZGFzaCBkaXJlY3Rpb24KLy8gQXBwbHkgdmVsb2NpdHkgaW1wdWxzZSBpbiBkYXNoIGRpcmVjdGlvbgogICAgICAgICAgICAgICAgX3BWZWMuc2V0KG54LCAwLCBueik7CiAgICAgICAgICAgICAgICBpZiAoX3BWZWMubGVuZ3RoU3EoKSA8IDAuMSkgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgfQp0aGlzLnZlbG9jaXR5LmFkZChfcFZlYy5tdWx0aXBseVNjYWxhcigxNC4wKSk7IC8vIE5lcmZlZCBmcm9tIDIwLjAKCiAgICAgICAgICAgICAgICBjb25zdCBsdW5nZUFjdGlvbiA9IHRoaXMuYWN0aW9uc1sndGhyb3cnXTsKICAgICAgICAgICAgICAgIGlmIChsdW5nZUFjdGlvbikgewogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBsdW5nZUFjdGlvbi50aW1lU2NhbGUgPSAyLjA7CiAgICAgICAgICAgICAgICB9CnRoaXMucGxheSgndGhyb3cnLCAwLjEpOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcpOwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCkgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QoMC4wNSwgJ2RlZmF1bHQnKTsKICAgICAgICAgICAgfQoKaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKDEwKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuMyk7IAogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIERhc2ggRWZmZWN0CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXNoUG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICBkYXNoUG9zLnkgKz0gMS4wOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgZGFzaFBvcywgeyBzY2FsZTogMS41LCBsaWZlOiAwLjMgfSk7CiAgICAgICAgICAgICAgICAvLyBTcGVlZCBsaW5lcwogICAgICAgICAgICAgICAgY29uc3QgYmFjayA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDM7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBkYXNoUG9zLmNsb25lKCkuYWRkKGJhY2subXVsdGlwbHlTY2FsYXIoTWF0aC5yYW5kb20oKSkpOwogICAgICAgICAgICAgICAgICAgIHAueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2Rhc2hfc3RyZWFtJywgcCwgeyBzY2FsZTogMS41IH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY3JlYXRlSFBCYXIoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IG5ldyBUSFJFRS5Hcm91cCgpOwoKICAgICAgICAgICAgY29uc3QgYmdHZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjIsIDAuMTUpOwogICAgICAgICAgICBjb25zdCBiZ01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwMDAwMCwgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgZGVwdGhUZXN0OiBmYWxzZSB9KTsKICAgICAgICAgICAgY29uc3QgYmcgPSBuZXcgVEhSRUUuTWVzaChiZ0dlbywgYmdNYXQpOwogICAgICAgICAgICBjb250YWluZXIuYWRkKGJnKTsKCiAgICAgICAgICAgIGNvbnN0IGZpbGxHZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjE2LCAwLjExKTsKICAgICAgICAgICAgZmlsbEdlby50cmFuc2xhdGUoMC41OCwgMCwgMCk7CiAgICAgICAgICAgIGNvbnN0IGZpbGxNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgwMGZmMDAsIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIGRlcHRoVGVzdDogZmFsc2UgfSk7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsID0gbmV3IFRIUkVFLk1lc2goZmlsbEdlbywgZmlsbE1hdCk7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsLnBvc2l0aW9uLnNldCgtMC41OCwgMCwgMC4wMSk7CiAgICAgICAgICAgIGNvbnRhaW5lci5hZGQodGhpcy5ocEJhckZpbGwpOwoKICAgICAgICAgICAgdGhpcy5ocEJhciA9IGNvbnRhaW5lcjsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5ocEJhcik7CiAgICAgICAgfQoKX3VwZGF0ZUhQQmFyKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaHBCYXIgfHwgIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gVmlzaWJpbGl0eSBDaGVjazogT25seSBzaG93IGlmIG1lc2ggaXMgdmlzaWJsZSBBTkQgaW4gQWN0aXZlL1ByYWN0aWNlIHN0YXRlcwogICAgICAgICAgICBpZiAoIXRoaXMubWVzaC52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgYWxsb3dlZFN0YXRlID0gZ2FtZSAmJiAoZ2FtZS5zdGF0ZSA9PT0gJ2FjdGl2ZScgfHwgZ2FtZS5zdGF0ZSA9PT0gJ2tpY2tvZmYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghYWxsb3dlZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmhwQmFyLnBvc2l0aW9uLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5ocEJhci5wb3NpdGlvbi55ICs9IDIuMjsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgdGhpcy5ocEJhci5sb29rQXQod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYS5wb3NpdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHBjdCA9IE1hdGgubWF4KDAsIHRoaXMuc3RhdHMuSFAgLyB0aGlzLnN0YXRzLm1heEhQKTsKICAgICAgICAgICAgdGhpcy5ocEJhckZpbGwuc2NhbGUuc2V0WChwY3QpOwoKICAgICAgICAgICAgaWYgKHBjdCA+IDAuNSkgdGhpcy5ocEJhckZpbGwubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4MDBmZjAwKTsKICAgICAgICAgICAgZWxzZSBpZiAocGN0ID4gMC4yNSkgdGhpcy5ocEJhckZpbGwubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZmZjAwKTsKICAgICAgICAgICAgZWxzZSB0aGlzLmhwQmFyRmlsbC5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZjAwMDApOwoKICAgICAgICAgICAgLy8gSGlkZSBpZiBmdWxsIEhQIHRvIHJlZHVjZSBjbHV0dGVyLCB1bmxlc3MgaW4gcHJhY3RpY2UgbW9kZQogICAgICAgICAgICBjb25zdCBhbHdheXNTaG93ID0gZ2FtZSAmJiBnYW1lLmdhbWVNb2RlID09PSAncHJhY3RpY2UnOwogICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSAocGN0IDwgMC45OCB8fCBhbHdheXNTaG93KTsKICAgICAgICB9CgogICAgICAgIGdhaW5FeHAoYW1vdW50KSB7CiAgICAgICAgICAgIGlmICghd2luZG93LmZsdXguZ2FtZUluc3RhbmNlIHx8IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSAhPT0gJ2FjdGl2ZScpIHJldHVybjsKCiAgICAgICAgICAgIHRoaXMuZXhwICs9IGFtb3VudDsKCiAgICAgICAgICAgIGlmICh0aGlzLmV4cCA+PSB0aGlzLm5leHRMZXZlbEV4cCkgewogICAgICAgICAgICAgICAgdGhpcy5sZXZlbFVwKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGxldmVsVXAoKSB7CiAgICAgICAgICAgIHRoaXMubGV2ZWwrKzsKICAgICAgICAgICAgdGhpcy5leHAgLT0gdGhpcy5uZXh0TGV2ZWxFeHA7CiAgICAgICAgICAgIHRoaXMubmV4dExldmVsRXhwID0gTWF0aC5mbG9vcih0aGlzLm5leHRMZXZlbEV4cCAqIDEuNSk7CgogICAgICAgICAgICBjb25zdCBrZXlzID0gWydIUCcsICdFTicsICdBVCcsICdQQScsICdCTCcsICdTSCcsICdDQScsICdTUCddOwoKICAgICAgICAgICAgY29uc3QgaHBHYWluID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMjApICsgMTA7CiAgICAgICAgICAgIHRoaXMuc3RhdHMubWF4SFAgKz0gaHBHYWluOwogICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gdGhpcy5zdGF0cy5tYXhIUDsKCiAgICAgICAgICAgIGtleXMuZm9yRWFjaChrID0+IHsKICAgICAgICAgICAgICAgIGlmIChrID09PSAnSFAnKSByZXR1cm47CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdhaW4gPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAyKSArIDE7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0c1trXSArPSBnYWluOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSByZWFjaGVkIExldmVsICR7dGhpcy5sZXZlbH0hYCk7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCAmJiB0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkxFVkVMIFVQISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NoZWNrVGFja2xlQ29sbGlzaW9uKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSB8fCB0aGlzLl9oYXNIaXRUYWNrbGUpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CgogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBvbmVudFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwoKaWYgKGRpc3QgPCAzLjApIHsgLy8gSW5jcmVhc2VkIGZyb20gMi4wIGZvciBlYXNpZXIgaGl0cwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc29sdmVUYWNrbGVIaXQob3BwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oYXNIaXRUYWNrbGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCl9yZXNvbHZlVGFja2xlSGl0KG9wcCkgewogICAgICAgICAgICB0aGlzLnBsYXkoJ2lkbGUnLCAwLjIpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgndGFja2xlJyk7CiAgICAgICAgICAgIH0KCmNvbnN0IGF0ID0gdGhpcy5nZXRTdGF0KCdBVCcpOwogICAgICAgICAgICBsZXQgZGFtYWdlID0gYXQgKiAzLjA7CgogICAgICAgICAgICBpZiAodGhpcy50ZWNocy50YWNrbGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgIG9wcC5hcHBseVN0YXR1cygndmVub20nLCAxMC4wKTsKICAgICAgICAgICAgICAgIGRhbWFnZSArPSA1OwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudGVjaHMudGFja2xlID09PSAnd2l0aGVyJykgewogICAgICAgICAgICAgICAgb3BwLmFwcGx5U3RhdHVzKCd3aXRoZXInLCAxMC4wLCAnRU4nKTsKICAgICAgICAgICAgICAgIGRhbWFnZSArPSA1OwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudGVjaHMudGFja2xlID09PSAnZHJhaW4nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQICs9IDIwOwogICAgICAgICAgICAgICAgb3BwLnN0YXRzLkhQIC09IDIwOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiRFJBSU4iLCB0aGlzLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgb3BwLmN1cnJlbnRFTiAtPSBkYW1hZ2U7CgppZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIC8vIFJlbW92ZWQgIkVOIiBzdWZmaXggZm9yIGNsZWFuZXIgbG9vawogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oYCR7TWF0aC5mbG9vcihkYW1hZ2UpfWAsIG9wcC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkFNISIsIG9wcC5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9wcC5jdXJyZW50RU4gPD0gMCkgewogICAgICAgICAgICAgICAgICAgIG9wcC5mdW1ibGUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgb3BwLnN0dW5UaW1lciA9IDAuNTsKICAgICAgICAgICAgICAgICAgICBvcHAucGxheU9uZVNob3QoJ3JlYWN0JywgMC4xKTsKfQoKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnRhY2tsZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KHRoaXMsIHRoaXMudGVjaHMudGFja2xlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBvcHAuc3R1blRpbWVyID0gMS4wOwogICAgICAgICAgICAgICAgb3BwLnBsYXlPbmVTaG90KCdyZWFjdCcsIDAuMSk7CmlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU01BQ0shIiwgb3BwLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgcHVzaERpciA9IG9wcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIHB1c2hEaXIueSA9IDAuMjsKICAgICAgICAgICAgb3BwLnZlbG9jaXR5LmFkZChwdXNoRGlyLm11bHRpcGx5U2NhbGFyKDEyLjApKTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCkgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QoMC4xLCAnaGVhdnknKTsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjgpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNwYXduQ2xhc2gpIHsKY29uc3QgbWlkID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG9wcC5tZXNoLnBvc2l0aW9uKS5tdWx0aXBseVNjYWxhcigwLjUpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNwYXduQ2xhc2gobWlkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKLy8gQnViYmxlIEJ1cnN0IChUYWNrbGUgSGl0KQovLyBCdWJibGUgQnVyc3QgKFRhY2tsZSBIaXQpCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBtaWQgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5sZXJwKG9wcC5tZXNoLnBvc2l0aW9uLCAwLjUpOwogICAgICAgICAgICAgICAgbWlkLnkgKz0gMS4wOwogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzA7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ1YmJsZVBvcyA9IG1pZC5jbG9uZSgpLmFkZChuZXcgVEhSRUUuVmVjdG9yMygoTWF0aC5yYW5kb20oKS0wLjUpKjEuNSwgKE1hdGgucmFuZG9tKCktMC41KSoxLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMS41KSk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgYnViYmxlUG9zLCB7IHNjYWxlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMzUgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9hcHBseUdvYWxDcmVhc2UoZHQpIHsKCmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gWwogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbERpc3QpLAogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgLWdvYWxEaXN0KQogICAgICAgICAgICBdOwoKCiAgICAgICAgICAgIGNvbnN0IHJhZGl1cyA9IDEwLjA7CgogICAgICAgICAgICBnb2Fscy5mb3JFYWNoKGdvYWwgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZHggPSB0aGlzLm1lc2gucG9zaXRpb24ueCAtIGdvYWwueDsKICAgICAgICAgICAgICAgIGNvbnN0IGR6ID0gdGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsLno7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR6KmR6OwoKICAgICAgICAgICAgICAgIGlmIChkaXN0U3EgPCByYWRpdXMgKiByYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVzaFggPSBkaXN0ID4gMCA/IGR4IC8gZGlzdCA6IDE7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVzaFogPSBkaXN0ID4gMCA/IGR6IC8gZGlzdCA6IDA7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gNTAuMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gcHVzaFggKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiArPSBwdXNoWiAqIGZvcmNlICogZHQ7CgogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFkaXVzIC0gMC41KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNsYW1wUmF0aW8gPSByYWRpdXMgLyAoZGlzdCArIDAuMDAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnggPSBnb2FsLnggKyBkeCAqIGNsYW1wUmF0aW87CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi56ID0gZ29hbC56ICsgZHogKiBjbGFtcFJhdGlvOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LlBsYXllciA9IFBsYXllcjsKfSkoKTsK","./Player.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBCYWxsIExhYiAvIERldlRvb2xzOiB0aHJvdyAmIGN1cnZlIG1hcHBpbmcga25vYnMKICAgIC8vIChEZWZhdWx0cyBtYXRjaCBjdXJyZW50IGZlZWw7IERldlRvb2xzIGNhbiB0d2VhayBhdCBydW50aW1lLikKICAgIHdpbmRvdy5mbHV4LlRocm93Q29uZmlnID0gd2luZG93LmZsdXguVGhyb3dDb25maWcgfHwgewogICAgICAgIFNXSVBFX01JTl9QWDogMjAsCiAgICAgICAgQUlNX0RYX1NDQUxFOiAxLjAsCiAgICAgICAgQUlNX0RZX1NDQUxFOiAxLjAsCgogICAgICAgIFBPV0VSX0JBU0U6IDEuMCwKICAgICAgICBQT1dFUl9SQU5HRTogMC44LCAgICAgICAgICAvLyBCYXNlIG11bHRpcGxpZXIgPSBQT1dFUl9CQVNFICsgcmF0aW8qUE9XRVJfUkFOR0UKICAgICAgICBQT1dFUl9NQVhfQk9OVVNfUkFUSU86IDAuOTUsCiAgICAgICAgUE9XRVJfTUFYX01VTFRJUExJRVI6IDIuNSwKCiAgICAgICAgQ1VSVkVfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBDVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEOiAwLjI1LAogICAgICAgIENVUlZFX1NQSU5fU0NBTEU6IDEwMDAuMCwKICAgICAgICBDVVJWRV9TUEVFRF9NVUxUOiAxLjUsCiAgICAgICAgQ1VSVkVfU1BJTl9DQVA6IDE1MDAuMCwKICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDUwMC4wCiAgICB9OwoKLy8gUmV1c2FibGUgbWF0aCBvYmplY3RzCmNvbnN0IF9wVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9wVmVjMiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfcFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BRdWF0MiA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRhcmdldFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BFdWxlciA9IG5ldyBUSFJFRS5FdWxlcigpOwogICAgY29uc3QgX3BBeGlzWSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApOwogICAgY29uc3QgX3BBeGlzWiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpOwogICAgY29uc3QgX3BJbnZRdWF0ID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgIGNvbnN0IF9wVG1wUXVhdCA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRtcEV1bGVyID0gbmV3IFRIUkVFLkV1bGVyKCk7CgoKY2xhc3MgUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSA9ICdNRicpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLnJvbGUgPSByb2xlOwogICAgICAgICAgICB0aGlzLnRlYW0gPSBudWxsOyAvLyBBc3NpZ25lZCBieSBUZWFtLmFkZFBsYXllcgogICAgICAgICAgICB0aGlzLmhvbWVQb3NpdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLm1peGVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hY3Rpb25zID0ge307CiAgICAgICAgICAgIHRoaXMuYWN0aXZlQWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdpZGxlJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2xhc3RMb2NvbW90aW9uID0gJ2lkbGUnOwp0aGlzLmlucHV0VmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAvLyBQaHlzaWNzIChEcmlmdC9JbmVydGlhIE1vZGVsKQogICAgICAgICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYWNjZWxlcmF0aW9uID0gMTIuMDsKICAgICAgICAgICAgdGhpcy5kcmFnID0gMy4wOwogICAgICAgICAgICB0aGlzLm1heFNwZWVkID0gOC4wOwogICAgICAgICAgICAvLyBCb25lIHJlZmVyZW5jZSBmb3IgaG9sZGluZyBiYWxsCiAgICAgICAgICAgIHRoaXMuaGFuZEJvbmUgPSBudWxsOwovLyBQcm9jZWR1cmFsIGFuaW1hdGlvbiBib25lIHJlZnMgKGZpbGxlZCBpbiBzZXRNZXNoKQp0aGlzLmJvbmVzID0gewogICAgaGlwczogbnVsbCwKICAgIHNwaW5lOiBudWxsLAogICAgY2hlc3Q6IG51bGwsCiAgICBuZWNrOiBudWxsLAogICAgaGVhZDogbnVsbCwKICAgIHJVcHBlckFybTogbnVsbCwKICAgIHJGb3JlQXJtOiBudWxsLAogICAgckhhbmQ6IG51bGwsCiAgICBsVXBwZXJBcm06IG51bGwsCiAgICBsRm9yZUFybTogbnVsbCwKICAgIGxIYW5kOiBudWxsCn07CnRoaXMuX2JvbmVCYXNlUXVhdHMgPSBudWxsOyAvLyBPcHRpb25hbCBmdXR1cmUgdXNlCnRoaXMuX3Byb2NBbmltVGltZSA9IDA7CnRoaXMuX3Ntb290aGVkU3BlZWQgPSAwOwp0aGlzLl9tb3ZpbmdMYXRjaCA9IGZhbHNlOwoKdGhpcy5jYW5DYXRjaCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2F0Y2hDb29sZG93biA9IDA7IC8vIFJlcGxhY2VzIHNldFRpbWVvdXQgZm9yIHNhZmV0eQoKICAgICAgICAgICAgLy8gQmxpdHpiYWxsIFN0YXRzCiAgICAgICAgICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLAogICAgICAgICAgICAgICAgbWF4SFA6IDEwMCwKICAgICAgICAgICAgICAgIEVOOiAzMCwKICAgICAgICAgICAgICAgIEFUOiAxMCwKICAgICAgICAgICAgICAgIFBBOiAxNSwKICAgICAgICAgICAgICAgIEJMOiAxMCwKICAgICAgICAgICAgICAgIFNIOiAxNSwKICAgICAgICAgICAgICAgIENBOiAxMCwKICAgICAgICAgICAgICAgIFNQOiA2MAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gTGV2ZWxpbmcgU3lzdGVtCiAgICAgICAgICAgIHRoaXMubGV2ZWwgPSAxOwogICAgICAgICAgICB0aGlzLmV4cCA9IDA7CiAgICAgICAgICAgIHRoaXMubmV4dExldmVsRXhwID0gMTAwOwoKICAgICAgICAgICAgLy8gU3RhdHVzIEVmZmVjdHMgJiBUZWNobmlxdWVzCiAgICAgICAgICAgIHRoaXMuc3RhdHVzID0gewogICAgICAgICAgICAgICAgdmVub206IDAsCiAgICAgICAgICAgICAgICBuYXA6IDAsCiAgICAgICAgICAgICAgICB3aXRoZXI6IHsgUEE6IDAsIFNIOiAwLCBBVDogMCwgQkw6IDAsIENBOiAwLCBTUDogMCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLm1hcmtpbmcgPSBudWxsOwogICAgICAgICAgICB0aGlzLmxlYXJuZWRUZWNocyA9IFtdOwoKICAgICAgICAgICAgdGhpcy50ZWNocyA9IHsKICAgICAgICAgICAgICAgIHRhY2tsZTogbnVsbCwKICAgICAgICAgICAgICAgIHNob290OiBudWxsLAogICAgICAgICAgICAgICAgcGFzczogbnVsbCwKICAgICAgICAgICAgICAgIHBhc3NpdmU6IG51bGwKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFZpc3VhbHMKICAgICAgICAgICAgdGhpcy5iYXNlQ29sb3JIZXggPSAweGZmZmZmZjsKICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscyA9IFtdOwogICAgICAgICAgICB0aGlzLmF1cmFNZXNoID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5yb3RhdGlvbk9mZnNldCA9IDA7CnRoaXMuYmFzZVNjYWxlID0gMS4xNzsgLy8gSW5jcmVhc2VkIH44JQoKICAgICAgICAgICAgLy8gUmVhbC10aW1lIFN0YXRzCiAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gdGhpcy5zdGF0cy5FTjsKdGhpcy50YWNrbGVSYWRpdXMgPSAyLjA7IC8vIFJlZHVjZWQgZnJvbSAyLjUgdG8gcmVkdWNlIHN3YXJtIGxvY2sKCiAgICAgICAgICAgIHRoaXMuc3BlZWQgPSA0LjA7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gRGFzaCBTdGF0ZQogICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5kYXNoVG90YWxUaW1lID0gMC41Owp0aGlzLmRhc2hDb29sZG93biA9IDA7CiAgICAgICAgICAgIHRoaXMuZGFzaFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBGZWVkYmFjayBBY2N1bXVsYXRvcnMKICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UgPSAwOwogICAgICAgICAgICB0aGlzLl9kYW1hZ2VUaW1lciA9IDA7CgogICAgICAgICAgICAvLyBIUCBCYXIKICAgICAgICAgICAgdGhpcy5ocEJhciA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsID0gbnVsbDsKCiAgICAgICAgICAgIC8vIEdhbWVwbGF5IEZsb3cgVGltZXJzCiAgICAgICAgICAgIHRoaXMuc3R1blRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMDsKCiAgICAgICAgICAgIC8vIEJhbmtpbmcgJiBWZXJ0aWNhbGl0eQogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLnRhcmdldFkgPSAwOwoKICAgICAgICAgICAgLy8gRW5jb3VudGVyIFN5c3RlbQogICAgICAgICAgICB0aGlzLmlzRW5nYWdlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNsYXNoVGltZXIgPSAwOwoKICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7IC8vIFRyYWNrIGR1cmF0aW9uIG9mIGN1cnJlbnQgZW5nYWdlbWVudAogICAgICAgICAgICAvLyBDaGFyZ2UgTWVjaGFuaWMKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4Q2hhcmdlVGltZSA9IDEuNTsKCiAgICAgICAgICAgIC8vIEZJWEVEOiBJbXByb3ZlZCBSb3RhdGlvbiBTdGF0ZSB3aXRoIGh5c3RlcmVzaXMKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gMDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLmxhc3RWYWxpZFlhdyA9IDA7IC8vIFN0b3JlIGxhc3Qga25vd24gZ29vZCB5YXcgZm9yIGRlYWR6b25lIGhhbmRsaW5nCiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmZhY2luZ0RlYWR6b25lID0gMC4zOyAvLyBNaW5pbXVtIGlucHV0L3ZlbG9jaXR5IG1hZ25pdHVkZSB0byB1cGRhdGUgZmFjaW5nCgogICAgICAgICAgICAvLyBQYXJ0aWNsZSBFbWlzc2lvbiBUaW1lcnMKICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMgPSB7CiAgICAgICAgICAgICAgICB2ZW5vbTogMCwKICAgICAgICAgICAgICAgIG5hcDogMCwKICAgICAgICAgICAgICAgIHdpdGhlcjogMAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gRGV2VG9vbHMgRmxhZ3MKICAgICAgICAgICAgdGhpcy5pc0dvZE1vZGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBhc3MgVGFyZ2V0IEluZGljYXRvcgovLyBQYXNzIFRhcmdldCBJbmRpY2F0b3IKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yID0gbnVsbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJ1YmJsZSBUcmFpbCBUaW1lcgogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDA7Cgp0aGlzLl9kYXNoUGFydGljbGVUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSAwOyAvLyBDb250aW51b3VzIHByZXNzdXJlIGZhY3RvciAoMC4wIHRvIDEuMCkKICAgICAgICB9CgogICAgICAgIHN5bmNSb3RhdGlvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgZXVsZXIgPSBuZXcgVEhSRUUuRXVsZXIoKS5zZXRGcm9tUXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbiwgJ1lYWicpOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgPSBldWxlci55IC0gdGhpcy5yb3RhdGlvbk9mZnNldDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgIHRoaXMubGFzdFZhbGlkWWF3ID0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ID0gMDsKICAgICAgICB9CgogICAgICAgIGdldFN0YXQobmFtZSkgewogICAgICAgICAgICBsZXQgdmFsID0gdGhpcy5zdGF0c1tuYW1lXTsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltuYW1lXSA+IDApIHsKICAgICAgICAgICAgICAgIHZhbCAqPSAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICB9CgogICAgICAgIGFwcGx5U3RhdHVzKHR5cGUsIGR1cmF0aW9uLCBzdWJUeXBlID0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMudmVub20gPiAxLjA7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy52ZW5vbSA9IE1hdGgubWF4KHRoaXMuc3RhdHVzLnZlbm9tLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnJvbGV9IHBvaXNvbmVkIWApOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQT0lTT04iLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMubmFwID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gTWF0aC5tYXgodGhpcy5zdGF0dXMubmFwLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gZmVsbCBhc2xlZXAhYCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNMRUVQIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3dpdGhlcicgJiYgc3ViVHlwZSkgewogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFZhbCA9IHRoaXMuc3RhdHVzLndpdGhlcltzdWJUeXBlXSB8fCAwOwogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gY3VycmVudFZhbCA+IDEuMDsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLndpdGhlcltzdWJUeXBlXSA9IE1hdGgubWF4KGN1cnJlbnRWYWwsIGR1cmF0aW9uKTsKCiAgICAgICAgICAgICAgICBpZiAoIXdhc0FjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gd2l0aGVyZWQgJHtzdWJUeXBlfSFgKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgV0lUSEVSICR7c3ViVHlwZX1gLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZURlcml2ZWRTdGF0cygpIHsKICAgICAgICAgICAgY29uc3Qgc3AgPSB0aGlzLmdldFN0YXQoJ1NQJyk7CiAgICAgICAgICAgIHRoaXMubWF4U3BlZWQgPSA1LjAgKyAoc3AgLyAxNS4wKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSB0aGlzLmdldFN0YXQoJ0VOJyk7CiAgICAgICAgfQoKc2V0TWVzaChzb3VyY2VNZXNoLCBhbmltYXRpb25zKSB7CiAgICAgICAgICAgIHRoaXMubWVzaCA9IHNvdXJjZU1lc2g7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUhQQmFyKCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUF1cmEoKTsKICAgICAgICAgICAgdGhpcy5fY3JlYXRlUGFzc1RhcmdldEluZGljYXRvcigpOwoKICAgICAgICAgICAgLy8gQ3VzdG9tIENoYXJhY3RlciBTY2FsaW5nCiAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUuaW5jbHVkZXMoJ1RpZHVzJykpIHRoaXMuYmFzZVNjYWxlID0gMS42OwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB0aGlzLmJhc2VTY2FsZSA9IDEuNDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXNoLnNjYWxlLnNldFNjYWxhcih0aGlzLmJhc2VTY2FsZSk7CgogICAgICAgICAgICB0aGlzLm1lc2gudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCAmJiBub2RlLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udmVydE9uZSA9IChtYXQpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXA6IG1hdC5tYXAgfHwgbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBuZXcgVEhSRUUuQ29sb3IoMHhmZmZmZmYpLCAvLyBGT1JDRSBXSElURTogSWdub3JlIHNvdXJjZSBjb2xvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6ICEhbWF0LnRyYW5zcGFyZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogKG1hdC5vcGFjaXR5ICE9PSB1bmRlZmluZWQgPyBtYXQub3BhY2l0eSA6IDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxwaGFUZXN0OiAobWF0LmFscGhhVGVzdCAhPT0gdW5kZWZpbmVkID8gbWF0LmFscGhhVGVzdCA6IDApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2lkZTogbWF0LnNpZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IG1hdC5kZXB0aFRlc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBtYXQuZGVwdGhXcml0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNraW5uaW5nOiAhIW5vZGUuaXNTa2lubmVkTWVzaAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5wdXNoKHsgbWF0ZXJpYWw6IG0sIGJhc2VDb2xvcjogbS5jb2xvci5jbG9uZSgpIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBBcnJheS5pc0FycmF5KG5vZGUubWF0ZXJpYWwpCiAgICAgICAgICAgICAgICAgICAgICAgID8gbm9kZS5tYXRlcmlhbC5tYXAoY29udmVydE9uZSkKICAgICAgICAgICAgICAgICAgICAgICAgOiBjb252ZXJ0T25lKG5vZGUubWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzQm9uZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSAobm9kZS5uYW1lIHx8ICcnKS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBDb3JlIHNwaW5lL2hlYWQgY2hhaW4gKE1peGFtby1mcmllbmRseSkKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuaGlwcyAmJiBuYW1lLmluY2x1ZGVzKCdoaXBzJykpIHRoaXMuYm9uZXMuaGlwcyA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLnNwaW5lICYmIG5hbWUuaW5jbHVkZXMoJ3NwaW5lJykgJiYgIW5hbWUuaW5jbHVkZXMoJ3NwaW5lMicpICYmICFuYW1lLmluY2x1ZGVzKCdzcGluZV8yJykpIHRoaXMuYm9uZXMuc3BpbmUgPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5jaGVzdCAmJiAobmFtZS5pbmNsdWRlcygnY2hlc3QnKSB8fCBuYW1lLmluY2x1ZGVzKCdzcGluZTInKSB8fCBuYW1lLmluY2x1ZGVzKCdzcGluZV8yJykpKSB0aGlzLmJvbmVzLmNoZXN0ID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubmVjayAmJiBuYW1lLmluY2x1ZGVzKCduZWNrJykpIHRoaXMuYm9uZXMubmVjayA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmhlYWQgJiYgbmFtZS5pbmNsdWRlcygnaGVhZCcpKSB0aGlzLmJvbmVzLmhlYWQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1JpZ2h0ID0gbmFtZS5pbmNsdWRlcygncmlnaHQnKSB8fCBuYW1lLmVuZHNXaXRoKCdyJykgfHwgbmFtZS5pbmNsdWRlcygnX3InKSB8fCBuYW1lLmluY2x1ZGVzKCcucicpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzTGVmdCAgPSBuYW1lLmluY2x1ZGVzKCdsZWZ0JykgIHx8IG5hbWUuZW5kc1dpdGgoJ2wnKSB8fCBuYW1lLmluY2x1ZGVzKCdfbCcpIHx8IG5hbWUuaW5jbHVkZXMoJy5sJyk7CgogICAgICAgICAgICAgICAgICAgIC8vIEFybXMvaGFuZHMgKE1peGFtbzogbWl4YW1vcmlnUmlnaHRBcm0vUmlnaHRGb3JlQXJtL1JpZ2h0SGFuZCkKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuclVwcGVyQXJtICYmIChuYW1lLmluY2x1ZGVzKCdyaWdodGFybScpIHx8IChpc1JpZ2h0ICYmIG5hbWUuaW5jbHVkZXMoJ3VwcGVyYXJtJykpKSkgdGhpcy5ib25lcy5yVXBwZXJBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5yRm9yZUFybSAmJiAobmFtZS5pbmNsdWRlcygncmlnaHRmb3JlYXJtJykgfHwgKGlzUmlnaHQgJiYgbmFtZS5pbmNsdWRlcygnZm9yZWFybScpKSkpIHRoaXMuYm9uZXMuckZvcmVBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5ySGFuZCAmJiAoKG5hbWUuaW5jbHVkZXMoJ2hhbmQnKSAmJiBpc1JpZ2h0KSB8fCBuYW1lLmluY2x1ZGVzKCdyaWdodGhhbmQnKSkpIHRoaXMuYm9uZXMuckhhbmQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubFVwcGVyQXJtICYmIChuYW1lLmluY2x1ZGVzKCdsZWZ0YXJtJykgfHwgKGlzTGVmdCAmJiBuYW1lLmluY2x1ZGVzKCd1cHBlcmFybScpKSkpIHRoaXMuYm9uZXMubFVwcGVyQXJtID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubEZvcmVBcm0gJiYgKG5hbWUuaW5jbHVkZXMoJ2xlZnRmb3JlYXJtJykgfHwgKGlzTGVmdCAmJiBuYW1lLmluY2x1ZGVzKCdmb3JlYXJtJykpKSkgdGhpcy5ib25lcy5sRm9yZUFybSA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmxIYW5kICYmICgobmFtZS5pbmNsdWRlcygnaGFuZCcpICYmIGlzTGVmdCkgfHwgbmFtZS5pbmNsdWRlcygnbGVmdGhhbmQnKSkpIHRoaXMuYm9uZXMubEhhbmQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICAvLyBCYWNrLWNvbXBhdDogYmFsbCBhdHRhY2htZW50IHVzZXMgaGFuZEJvbmUKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaGFuZEJvbmUgJiYgdGhpcy5ib25lcy5ySGFuZCkgdGhpcy5oYW5kQm9uZSA9IHRoaXMuYm9uZXMuckhhbmQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5taXhlciA9IG5ldyBUSFJFRS5BbmltYXRpb25NaXhlcih0aGlzLm1lc2gpOwoKICAgICAgICAgICAgaWYgKGFuaW1hdGlvbnMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IF9ub3JtQ2xpcE5hbWUgPSAocykgPT4gKHMgfHwgJycpCiAgICAgICAgICAgICAgICAgICAgLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvW19cLV0rL2csICcgJykKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXHMrL2csICcgJykKICAgICAgICAgICAgICAgICAgICAudHJpbSgpOwoKICAgICAgICAgICAgICAgIC8vIEhlbHBlciB0byBzdHJpcCBsZWcgdHJhY2tzIGZyb20gYWN0aW9uIGNsaXBzCiAgICAgICAgICAgICAgICBjb25zdCBfc3RyaXBMZWdzID0gKGNsaXApID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFja3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICBjbGlwLnRyYWNrcy5mb3JFYWNoKHQgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZWdleCB0byBtYXRjaCBsZWcgYm9uZXMgKE1peGFtbyBzdHlsZTogUmlnaHRVcExlZywgUmlnaHRMZWcsIFJpZ2h0Rm9vdCwgUmlnaHRUb2VCYXNlKQogICAgICAgICAgICAgICAgICAgICAgICAvLyBBbHNvIGdlbmVyaWMgIkxlZyIsICJGb290IgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXQubmFtZS5tYXRjaCgvKFVwTGVnfExlZ3xGb290fFRvZSkvaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYWNrcy5wdXNoKHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgY2xpcC50cmFja3MgPSB0cmFja3M7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNsaXA7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGFuaW1hdGlvbnMuZm9yRWFjaCgoY2xpcCkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBfbm9ybUNsaXBOYW1lKGNsaXAubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzID0gKHJlKSA9PiByZS50ZXN0KG5hbWUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxldCBpc0xvY29tb3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBsZXQgYWN0aW9uS2V5ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIENvcmUgbG9jb21vdGlvbiAtLS0KICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC90cmVhZHx0cmVhZGluZ3xpZGxlfGZsb2F0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2lkbGUnOwogICAgICAgICAgICAgICAgICAgICAgICBpc0xvY29tb3Rpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9kYXNofHNwcmludHxidXJzdHxmYXN0XHMqc3dpbXxzd2ltXHMqZmFzdC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdkYXNoJzsKICAgICAgICAgICAgICAgICAgICAgICAgaXNMb2NvbW90aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvc3dpbXxmcmVlc3R5bGV8Y3Jhd2wvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAnc3dpbSc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzTG9jb21vdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIFRocm93aW5nIChwYXNzL3Nob3QgdmFyaWFudHMgaWYgcHJlc2VudCkgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3Rocm93fHRvc3N8cGl0Y2gvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC9zaG9vdHxzaG90fGdvYWwvKSkgYWN0aW9uS2V5ID0gJ3Rocm93X3Nob3QnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChoYXMoL3Bhc3MvKSkgYWN0aW9uS2V5ID0gJ3Rocm93X3Bhc3MnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFjdGlvbktleSA9ICd0aHJvdyc7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBDYXRjaGluZyAoanVtcC9haXIgdmFyaWFudHMgaWYgcHJlc2VudCkgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2NhdGNofHJlY2VpdmV8Z3JhYnxpbnRlcmNlcHQvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC9qdW1wfGxlYXB8YWlyfGRpdmUvKSkgYWN0aW9uS2V5ID0gJ2NhdGNoX2p1bXAnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFjdGlvbktleSA9ICdjYXRjaCc7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBIaXQgLyBSZWFjdCAtLS0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvcmVhY3R8aGl0fGh1cnR8ZGFtYWdlfHN0YWdnZXJ8a25vY2svKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAncmVhY3QnOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gT3B0aW9uYWwgc3RhdGVzIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jaGFyZ2V8YWltfHJlYWR5fHdpbmR1cHxob2xkLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2NoYXJnZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3RhY2tsZXxjaGVja3xyYW0vKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAndGFja2xlJzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvYmxvY2t8c2F2ZS8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2NlbGVicmF0ZXx2aWN0b3J5fGNoZWVyLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2NlbGVicmF0ZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gY2xpcC5uYW1lOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gU3RyaXAgbGVncyBmcm9tIG5vbi1sb2NvbW90aW9uIGNsaXBzIHRvIGFsbG93IHRyZWFkaW5nIHdhdGVyIG92ZXJsYXkKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTG9jb21vdGlvbiAmJiBhY3Rpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3N0cmlwTGVncyhjbGlwKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChhY3Rpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3Rpb25zW2FjdGlvbktleV0gPSB0aGlzLm1peGVyLmNsaXBBY3Rpb24oY2xpcCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFN0YXJ0IGRlZmF1bHQgbG9jb21vdGlvbgogICAgICAgICAgICBpZiAodGhpcy5hY3Rpb25zWydpZGxlJ10pIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24oJ2lkbGUnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrCiAgICAgICAgICAgICAgICBjb25zdCBmaXJzdCA9IE9iamVjdC52YWx1ZXModGhpcy5hY3Rpb25zKVswXTsKICAgICAgICAgICAgICAgIGlmKGZpcnN0KSBmaXJzdC5wbGF5KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9uZS1zaG90IGFuaW1hdGlvbiBsaXN0ZW5lcgogICAgICAgICAgICBpZiAodGhpcy5taXhlcikgewogICAgICAgICAgICAgICAgdGhpcy5taXhlci5hZGRFdmVudExpc3RlbmVyKCdmaW5pc2hlZCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9hbmltTG9ja2VkKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLmFjdGlvbikgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBmaW5pc2hlZCBhY3Rpb24gaXMgb3VyIGN1cnJlbnQgb25lLXNob3QKICAgICAgICAgICAgICAgICAgICBpZiAoZS5hY3Rpb24gPT09IHRoaXMuYWN0aXZlT25lU2hvdCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hbmltTG9ja2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvY2tlZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVPbmVTaG90ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJldHVybiB0byBsb2NvbW90aW9uIHVwZGF0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMTUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE5ldyBtZXRob2QgZm9yIGJhc2UgbGF5ZXIgKGxlZ3MvYm9keSBtb3ZlbWVudCkKICAgICAgICBwbGF5TG9jb21vdGlvbihhY3Rpb25OYW1lLCBkdXJhdGlvbiA9IDAuNSkgewogICAgICAgICAgICBjb25zdCBuZXdBY3Rpb24gPSB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgIGlmICghbmV3QWN0aW9uIHx8IG5ld0FjdGlvbiA9PT0gdGhpcy5hY3RpdmVMb2NvbW90aW9uKSByZXR1cm47CgogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVMb2NvbW90aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUxvY29tb3Rpb24uZmFkZU91dChkdXJhdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5ld0FjdGlvbi5yZXNldCgpOwogICAgICAgICAgICBuZXdBY3Rpb24uZmFkZUluKGR1cmF0aW9uKTsKICAgICAgICAgICAgbmV3QWN0aW9uLnBsYXkoKTsKICAgICAgICAgICAgdGhpcy5hY3RpdmVMb2NvbW90aW9uID0gbmV3QWN0aW9uOwogICAgICAgICAgICB0aGlzLl9sYXN0TG9jb21vdGlvbiA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICAvLyBPdmVyaGF1bGVkIHBsYXkgbWV0aG9kIHRvIGhhbmRsZSBsYXllcmluZwogICAgICAgIHBsYXkoYWN0aW9uTmFtZSwgZHVyYXRpb24gPSAwLjUpIHsKICAgICAgICAgICAgLy8gSWYgaXQncyBhIGxvY29tb3Rpb24gc3RhdGUsIHJvdXRlIHRvIHBsYXlMb2NvbW90aW9uCiAgICAgICAgICAgIGlmIChbJ2lkbGUnLCAnc3dpbScsICdkYXNoJ10uaW5jbHVkZXMoYWN0aW9uTmFtZSkpIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24oYWN0aW9uTmFtZSwgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPdGhlcndpc2UgdHJlYXQgYXMgYW4gYWN0aW9uIGxheWVyCiAgICAgICAgICAgIGNvbnN0IG5ld0FjdGlvbiA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFuZXdBY3Rpb24pIHJldHVybjsKCiAgICAgICAgICAgIC8vIElmIHdlIGhhdmUgYW4gYWN0aXZlIG9uZS1zaG90LCBmYWRlIGl0IG91dAogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVPbmVTaG90ICYmIHRoaXMuYWN0aXZlT25lU2hvdCAhPT0gbmV3QWN0aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZU9uZVNob3QuZmFkZU91dCgwLjEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXdBY3Rpb24ucmVzZXQoKTsKICAgICAgICAgICAgbmV3QWN0aW9uLmZhZGVJbigwLjEpOyAvLyBGYXN0IHRyYW5zaXRpb24gZm9yIGFjdGlvbnMKICAgICAgICAgICAgbmV3QWN0aW9uLnBsYXkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYWN0aXZlT25lU2hvdCA9IG5ld0FjdGlvbjsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlTG9jb21vdGlvbkFuaW0oZHVyYXRpb24gPSAwLjIpIHsKICAgICAgICAgICAgLy8gTm90ZTogV2UgTk8gTE9OR0VSIGNoZWNrIF9hbmltTG9ja2VkIGhlcmUuCiAgICAgICAgICAgIC8vIExvY29tb3Rpb24gc2hvdWxkIHVwZGF0ZSBjb250aW51b3VzbHkgYmFzZWQgb24gc3BlZWQsIAogICAgICAgICAgICAvLyBydW5uaW5nIHVuZGVybmVhdGggdGhlIHVwcGVyIGJvZHkgYWN0aW9uLgogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgdnggPSB0aGlzLnZlbG9jaXR5ID8gdGhpcy52ZWxvY2l0eS54IDogMDsKICAgICAgICAgICAgY29uc3QgdnogPSB0aGlzLnZlbG9jaXR5ID8gdGhpcy52ZWxvY2l0eS56IDogMDsKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSBNYXRoLnNxcnQodnggKiB2eCArIHZ6ICogdnopOwoKICAgICAgICAgICAgLy8gU21vb3RoIHNwZWVkCiAgICAgICAgICAgIGNvbnN0IHNtb290aEsgPSAxLjAgLSBNYXRoLnBvdygwLjAwMSwgZHVyYXRpb24pOwogICAgICAgICAgICB0aGlzLl9zbW9vdGhlZFNwZWVkICs9IChzcGVlZCAtIHRoaXMuX3Ntb290aGVkU3BlZWQpICogc21vb3RoSzsKCiAgICAgICAgICAgIGNvbnN0IHNwZWVkTm9ybSA9ICh0aGlzLm1heFNwZWVkID4gMC4wMDAxKSA/IFRIUkVFLk1hdGhVdGlscy5jbGFtcCh0aGlzLl9zbW9vdGhlZFNwZWVkIC8gdGhpcy5tYXhTcGVlZCwgMCwgMSkgOiAwOwoKICAgICAgICAgICAgLy8gSHlzdGVyZXNpcwogICAgICAgICAgICBjb25zdCBlbnRlck1vdmUgPSAwLjE4OwogICAgICAgICAgICBjb25zdCBleGl0TW92ZSA9IDAuMTA7CgogICAgICAgICAgICBjb25zdCBpbnB1dE1vdmluZyA9IHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wNjsKICAgICAgICAgICAgY29uc3QgdmVsTW92aW5nID0gdGhpcy5fc21vb3RoZWRTcGVlZCA+ICh0aGlzLl9tb3ZpbmdMYXRjaCA/IGV4aXRNb3ZlIDogZW50ZXJNb3ZlKTsKCiAgICAgICAgICAgIHRoaXMuX21vdmluZ0xhdGNoID0gaW5wdXRNb3ZpbmcgfHwgdmVsTW92aW5nOwoKICAgICAgICAgICAgbGV0IHRhcmdldCA9IHRoaXMuX21vdmluZ0xhdGNoID8gJ3N3aW0nIDogJ2lkbGUnOwogICAgICAgICAgICBpZiAodGhpcy5fbW92aW5nTGF0Y2ggJiYgdGhpcy5pc0Rhc2hpbmcgJiYgdGhpcy5hY3Rpb25zWydkYXNoJ10pIHRhcmdldCA9ICdkYXNoJzsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBwbGF5YmFjayByYXRlCiAgICAgICAgICAgIGNvbnN0IGFwcGx5UmF0ZSA9IChrZXkpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGlvbnNba2V5XTsKICAgICAgICAgICAgICAgIGlmICghYSkgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gJ3N3aW0nKSBhLnRpbWVTY2FsZSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDAuODUsIDEuNzAsIHNwZWVkTm9ybSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChrZXkgPT09ICdkYXNoJykgYS50aW1lU2NhbGUgPSBUSFJFRS5NYXRoVXRpbHMubGVycCgxLjEwLCAyLjIwLCBzcGVlZE5vcm0pOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoa2V5ID09PSAnaWRsZScpIGEudGltZVNjYWxlID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoMC45NSwgMS4wNSwgc3BlZWROb3JtKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGFwcGx5UmF0ZSh0YXJnZXQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuX2xhc3RMb2NvbW90aW9uICE9PSB0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGlvbnNbdGFyZ2V0XTsKICAgICAgICAgICAgICAgIGlmIChhKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsgYS5zZXRMb29wKFRIUkVFLkxvb3BSZXBlYXQpOyB9IGNhdGNoIChfKSB7fQogICAgICAgICAgICAgICAgICAgIGEuY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24odGFyZ2V0LCBkdXJhdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBsYXlPbmVTaG90KGFjdGlvbk5hbWUsIGR1cmF0aW9uID0gMC4xLCBvcHRzID0ge30pIHsKICAgICAgICAgICAgY29uc3QgYSA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFhKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICB0aGlzLl9hbmltTG9ja2VkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5fbG9ja2VkU3RhdGUgPSBhY3Rpb25OYW1lOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGEucmVzZXQoKTsKICAgICAgICAgICAgICAgIGEuc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICBhLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGEudGltZVNjYWxlID0gKG9wdHMudGltZVNjYWxlICE9PSB1bmRlZmluZWQgPyBvcHRzLnRpbWVTY2FsZSA6IDEuMCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKF8pIHt9CgogICAgICAgICAgICAvLyBVc2UgdGhlIG5ldyBwbGF5IG1ldGhvZCB3aGljaCBoYW5kbGVzIGxheWVyaW5nCiAgICAgICAgICAgIHRoaXMucGxheShhY3Rpb25OYW1lLCBkdXJhdGlvbik7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBzZXRJbnB1dCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCh4LCAwLCB6KTsKICAgICAgICB9CgpyZWNlaXZlQmFsbCgpIHsKICAgICAgICAgICAgdGhpcy5jYW5DYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ1JJVElDQUwgRklYOiBSZXNldCBzdGF0ZXMgdGhhdCBtaWdodCBwcmV2ZW50IHNob290aW5nCiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMi4wOwoKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLmxhc3RIb2xkZXIgJiYgYmFsbC5sYXN0SG9sZGVyLnRlYW0gPT09IHRoaXMudGVhbSAmJiBiYWxsLmxhc3RIb2xkZXIgIT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGJhbGwubGFzdEhvbGRlci5nYWluRXhwKDIpOwogICAgICAgICAgICAgICAgdGhpcy5nYWluRXhwKDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBiYWxsWSA9ICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLm1lc2gpID8gdGhpcy5iYWxsUmVmLm1lc2gucG9zaXRpb24ueSA6IDA7CiAgICAgICAgICAgIGNvbnN0IGNhdGNoS2V5ID0gKGJhbGxZID4gMC4yNSAmJiB0aGlzLmFjdGlvbnNbJ2NhdGNoX2p1bXAnXSkgPyAnY2F0Y2hfanVtcCcgOiAnY2F0Y2gnOwoKICAgICAgICAgICAgdGhpcy5wbGF5T25lU2hvdChjYXRjaEtleSwgMC4xKTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2NhdGNoJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTTkFQISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWFjdGlvbiIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdGhyb3dCYWxsKGJhbGwsIGZvcmNlZFR5cGUgPSBudWxsLCBwb3dlck11bHRpcGxpZXIgPSAxLjAsIGZvcmNlZFNwaW4gPSBudWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZykgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gdHJ1ZTsKCiAgICAgICAgICAgIC8vIExvY2sgYWltIGRpcmVjdGlvbiBhdCBzdGFydCBvZiB0aHJvdwogICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3RvciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICBpZiAodGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4xKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3Rvci5jb3B5KHRoaXMuaW5wdXRWZWN0b3IpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5sb2NrZWRBaW1WZWN0b3Iuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtZ29hbERpc3QgOiBnb2FsRGlzdDsKICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwoKICAgICAgICAgICAgbGV0IHR5cGUgPSBmb3JjZWRUeXBlOwogICAgICAgICAgICBpZiAoIXR5cGUpIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAoZGlzdFRvR29hbCA8IDI1KSA/ICdTSCcgOiAnUEEnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBpc0ZpbmlzaGVyID0gKHR5cGUgPT09ICdTSCcgJiYgZGlzdFRvR29hbCA8IDEyLjApOwoKICAgICAgICAgICAgbGV0IHRlY2hOYW1lID0gKHR5cGUgPT09ICdTSCcpID8gdGhpcy50ZWNocy5zaG9vdCA6IHRoaXMudGVjaHMucGFzczsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy52ZW5vbSA+IDAgJiYgdGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNJTEVOQ0VEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgICAgICB0ZWNoTmFtZSA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCB3aW5kdXBUaW1lID0gMTAwOwogICAgICAgICAgICBsZXQgYW5pbVNwZWVkID0gMS41OwoKICAgICAgICAgICAgaWYgKHBvd2VyTXVsdGlwbGllciA+IDEuMSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSArPSAyMDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc0ZpbmlzaGVyICYmICF0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSA9IDUwOwogICAgICAgICAgICAgICAgYW5pbVNwZWVkID0gMy4wOwogICAgICAgICAgICB9CgppZiAodGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIHdpbmR1cFRpbWUgPSA0MDA7CiAgICAgICAgICAgICAgICBhbmltU3BlZWQgPSAwLjg7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIucGxheUNpbmVtYXRpYyh0ZWNoTmFtZSwgdGhpcy5tZXNoLCAxLjIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuaW1tdW5pdHlUaW1lciA9IDEuNTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJykudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGxhYmVsLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTkVXOiBTcGF3biBUZWNoIEdseXBoIChWZXJ0aWNhbCBDYXN0aW5nIENpcmNsZSkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmdseXBoTWFuYWdlci5zcGF3bigndGVjaCcsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDEuMiwKICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogNC4wLAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAxLjUsCiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFk6IDEuMiwKICAgICAgICAgICAgICAgICAgICAgICAgZmFjZUNhbWVyYTogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQaWNrIGJlc3QgdGhyb3cgY2xpcCAocGFzcy9zaG90IHZhcmlhbnRzIGlmIHByZXNlbnQpCiAgICAgICAgICAgIGNvbnN0IHRocm93S2V5ID0KICAgICAgICAgICAgICAgICh0eXBlID09PSAnU0gnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfc2hvdCddKSA/ICd0aHJvd19zaG90JyA6CiAgICAgICAgICAgICAgICAodHlwZSA9PT0gJ1BBJyAmJiB0aGlzLmFjdGlvbnNbJ3Rocm93X3Bhc3MnXSkgPyAndGhyb3dfcGFzcycgOgogICAgICAgICAgICAgICAgJ3Rocm93JzsKCnRoaXMucGxheU9uZVNob3QodGhyb3dLZXksIDAuMSwgeyB0aW1lU2NhbGU6IGFuaW1TcGVlZCB9KTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3Rocm93Jyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0ICYmICF0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiV0hPT1NIIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtYWN0aW9uIik7CiAgICAgICAgICAgIH0KCnNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgLy8gU2FmZXR5OiBJZiBiYWxsIGhvbGRlciBpcyBzdGlsbCB1cywgcHJvY2VlZC4gSWYgaGFzQmFsbCBpcyBmYWxzZSBidXQgaG9sZGVyIGlzIHVzLCBhc3N1bWUgc3luYyBsYWcgYW5kIHByb2NlZWQuCiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IChiYWxsICYmIGJhbGwuaG9sZGVyID09PSB0aGlzKSkgewpjb25zdCB0aHJvd0FjdGlvbiA9IHRoaXMuYWN0aW9uc1t0aHJvd0tleV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHRocm93QWN0aW9uKSB0aHJvd0FjdGlvbi50aW1lU2NhbGUgPSAxLjA7CgogICAgICAgICAgICAgICAgICAgIGxldCBmaW5hbERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICAgICAgbGV0IHJlZmVyZW5jZURpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgppZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5jb3B5KHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2VEaXIuY29weShmaW5hbERpcik7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBSRU1PVkVEOiBJbnN0YW50IHJvdGF0aW9uIHNuYXAuIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGUgdXBkYXRlIGxvb3AgaGFuZGxlcyBzbW9vdGggcm90YXRpb24gdmlhIHRhcmdldFlhdy4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyB0aGUgImZsaXBwaW5nIGFyb3VuZCIgdmlzdWFsIGdsaXRjaC4KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5jb3B5KHRoaXMubG9ja2VkQWltVmVjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlRGlyLmNvcHkodGhpcy5sb2NrZWRBaW1WZWN0b3IpOwogICAgICAgICAgICAgICAgICAgIH0KCmNvbnN0IHNwaW4gPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGZvcmNlZFNwaW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3Bpbi5jb3B5KGZvcmNlZFNwaW4pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlucHV0RGlyID0gdGhpcy5pbnB1dFZlY3Rvci5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjcm9zc1kgPSBuZXcgVEhSRUUuVmVjdG9yMygpLmNyb3NzVmVjdG9ycyhyZWZlcmVuY2VEaXIsIGlucHV0RGlyKS55OwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGNyb3NzWSkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwaW4uc2V0KDAsIGNyb3NzWSAqIDEyLjAsIDApOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsZXQgYmFzZUNvc3QgPSAodHlwZSA9PT0gJ1NIJykgPyAyMCA6IDEwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoQ29zdCA9IDA7CiAgICAgICAgICAgICAgICAgICAgbGV0IHRlY2hCb251cyA9IDA7CiAgICAgICAgICAgICAgICAgICAgbGV0IHRlY2hQYXlsb2FkID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAodGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3Zlbm9tJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9ICh0eXBlID09PSAnU0gnID8gMjAgOiAxMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IHsgdHlwZTogJ3Zlbm9tJywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3dpdGhlcic6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDIwIDogMTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICd3aXRoZXInLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnbmFwJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9ICh0eXBlID09PSAnU0gnID8gMzUgOiAzMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IHsgdHlwZTogJ25hcCcsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdzcGhlcmUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gMjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJuZyA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDExKSArIDU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IHJuZzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdzcGhlcmUnLCBsZXZlbDogMSwgYm9udXM6IHJuZyB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oYFNQSEVSRSArJHtybmd9YCwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZ29hbCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2plY2h0JzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9IDQwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSA1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IHsgdHlwZTogJ2plY2h0JywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGVyZm9ybUplY2h0S25vY2tiYWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnaW52aXNpYmxlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9IDI1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IHsgdHlwZTogJ2ludmlzaWJsZScsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b3RhbENvc3QgPSBiYXNlQ29zdCArIHRlY2hDb3N0OwoKICAgICAgICAgICAgICAgICAgICBsZXQgcG93ZXJGYWN0b3IgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPCB0b3RhbENvc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcG93ZXJGYWN0b3IgPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiVElSRUQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IHRvdGFsQ29zdDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGxldCBzdGF0VmFsID0gdGhpcy5nZXRTdGF0KHR5cGUpOwogICAgICAgICAgICAgICAgICAgIHN0YXRWYWwgKz0gdGVjaEJvbnVzOwogICAgICAgICAgICAgICAgICAgIHN0YXRWYWwgKj0gcG93ZXJGYWN0b3I7CiAgICAgICAgICAgICAgICAgICAgc3RhdFZhbCAqPSBwb3dlck11bHRpcGxpZXI7Cgpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtZ29hbERpc3QgOiBnb2FsRGlzdDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnb2FsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbFogLSB0aGlzLm1lc2gucG9zaXRpb24ueikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbERvdCA9IGZpbmFsRGlyLmRvdChnb2FsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDIsIGdvYWxaKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdG9Hb2FsID0gZ29hbFBvcy5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2ggPSB0aGlzLmdldFN0YXQoJ1NIJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBNYXRoLm1pbigwLjksIE1hdGgubWF4KDAuMSwgc2ggLyAxMDAuMCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lzdEZhY3RvciAqPSAwLjE7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnb2FsRG90ID4gMC4yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5sZXJwKHRvR29hbCwgYXNzaXN0RmFjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRmluaXNoZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4wNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xBTSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4yNTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKLy8gR29hbGllIExvZnQgQm9udXMgKFByZXZlbnQgaW50ZXJjZXB0aW9uIGJ5IGltbWVkaWF0ZSBkZWZlbmRlcikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgZmluYWxEaXIueSArPSAwLjg7IC8vIEhpZ2ggbG9mdCBmb3IgY2xlYXJhbmNlCgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGZpbmFsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvTWF0ZSA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0LnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b01hdGUuYWRkU2NhbGVkVmVjdG9yKHRhcmdldC52ZWxvY2l0eSwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvTWF0ZS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYSA9IHRoaXMuZ2V0U3RhdCgnUEEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBNYXRoLm1pbigxLjAsIDAuMyArIChwYSAvIDgwLjApKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lzdEZhY3RvciAqPSAwLjE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIubGVycCh0b01hdGUsIGFzc2lzdEZhY3Rvcik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gTWF0aC5taW4oMC42LCBkaXN0ICogMC4wMyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CmZpbmFsRGlyLnkgKz0gMC4yOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBHb2FsaWUgTG9mdCBCb251cyBmb3IgUGFzc2luZwovLyBHb2FsaWUgTG9mdCBCb251cyBmb3IgUGFzc2luZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yb2xlID09PSAnR0wnKSBmaW5hbERpci55ICs9IDAuODsgLy8gSGlnaCBsb2Z0IGZvciBjbGVhcmFuY2UKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodGVjaFBheWxvYWQgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KHRoaXMsIHRlY2hOYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CgpiYWxsLnNob290KGZpbmFsRGlyLCBzdGF0VmFsLCB0eXBlLCB0ZWNoUGF5bG9hZCwgc3Bpbik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRXh0cmEgZ3JhY2UgcGVyaW9kIGZvciBHb2FsaWUgdG8gcHJldmVudCBwb2ludC1ibGFuayBpbnRlcmNlcHRpb25zCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgewogICAgICAgICAgICAgICAgICAgICAgICBiYWxsLmNhdGNoR3JhY2VQZXJpb2QgPSAwLjY7IC8vIDAuNnMgaW1tdW5pdHkgKGFwcHJveCAxMC0xMm0gdHJhdmVsKQogICAgICAgICAgICAgICAgICAgIH0KCnRoaXMubG9zZUJhbGwoKTsKCnRoaXMuY2F0Y2hDb29sZG93biA9IDEuMDsgLy8gMXMgY29vbGRvd24KICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHdpbmR1cFRpbWUpOwoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBudWxsOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlTG9jb21vdGlvbkFuaW0oMC4yKTsKICAgICAgICAgICAgfSwgd2luZHVwVGltZSArIDUwMCk7CiAgICAgICAgfQoKICAgICAgICBfZmluZFBhc3NUYXJnZXRJbkNvbmUoYWltRGlyKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtKSByZXR1cm4gbnVsbDsKCiAgICAgICAgICAgIGxldCBiZXN0VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IG1heFNjb3JlID0gLUluZmluaXR5OwoKICAgICAgICAgICAgZm9yIChjb25zdCBtYXRlIG9mIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcyB8fCAhbWF0ZS5tZXNoKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICBjb25zdCB0b01hdGUgPSBtYXRlLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGRvdCA9IGFpbURpci5kb3QodG9NYXRlKTsKCiAgICAgICAgICAgICAgICBpZiAoZG90ID4gMC43KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2NvcmUgPSAoZG90ICogMTApIC0gKGRpc3QgKiAwLjEpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoc2NvcmUgPiBtYXhTY29yZSkgewogICAgICAgICAgICAgICAgICAgICAgICBtYXhTY29yZSA9IHNjb3JlOwogICAgICAgICAgICAgICAgICAgICAgICBiZXN0VGFyZ2V0ID0gbWF0ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJlc3RUYXJnZXQ7CiAgICAgICAgfQoKc3RhcnRDaGFyZ2UoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CgovLyBWaXN1YWxzIGhhbmRsZWQgaW4gdXBkYXRlCgogICAgICAgICAgICAvLyBTaG93IGNoYXJnZSBVSQogICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSSgwKTsKCiAgICAgICAgICAgIC8vIE5FVzogU3Bhd24gQ2hhcmdlIEdseXBoIChHcm91bmQgUmluZykKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyLnNwYXduKCdjaGFyZ2UnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgbGlmZTogdGhpcy5tYXhDaGFyZ2VUaW1lLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IDMuMCwKICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAwLjIsCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WTogMC4xCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnJlbGVhc2VDaGFyZ2UoZHgsIGR5LCBjdXJ2ZUlucHV0ID0gbnVsbCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaXNDaGFyZ2luZykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBvd2VyIENhbGN1bGF0aW9uCiAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4odGhpcy5jaGFyZ2VUaW1lIC8gdGhpcy5tYXhDaGFyZ2VUaW1lLCAxLjApOwogICAgICAgICAgICBjb25zdCBUQyA9IHdpbmRvdy5mbHV4LlRocm93Q29uZmlnIHx8IHt9OwoKICAgICAgICAgICAgLy8gQmFzZSBtdWx0aXBsaWVyIChkZWZhdWx0czogMS4wIHRvIDEuOCkKICAgICAgICAgICAgbGV0IG11bHRpcGxpZXIgPSAoVEMuUE9XRVJfQkFTRSAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfQkFTRSA6IDEuMCkgKyAocmF0aW8gKiAoVEMuUE9XRVJfUkFOR0UgIT09IHVuZGVmaW5lZCA/IFRDLlBPV0VSX1JBTkdFIDogMC44KSk7Ly8gTUFYIFBPV0VSIEJPTlVTOiBJZiBoZWxkIG5lYXIgbWF4LCBzaWduaWZpY2FudCBib29zdAogICAgICAgICAgICBpZiAocmF0aW8gPiAoVEMuUE9XRVJfTUFYX0JPTlVTX1JBVElPICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9NQVhfQk9OVVNfUkFUSU8gOiAwLjk1KSkgewogICAgICAgICAgICAgICAgbXVsdGlwbGllciA9IChUQy5QT1dFUl9NQVhfTVVMVElQTElFUiAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfTUFYX01VTFRJUExJRVIgOiAyLjUpOyAvLyBDcml0aWNhbCBQb3dlcgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNQVggUE9XRVIhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKC0xMCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CgogICAgICAgICAgICAvLyBBaW0gVmVjdG9yIENhbGN1bGF0aW9uCiAgICAgICAgICAgIGxldCBhaW1WZWMgPSBudWxsOwogICAgICAgICAgICBjb25zdCBzd2lwZUxlbiA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCiAgICAgICAgICAgIGlmIChzd2lwZUxlbiA+IChUQy5TV0lQRV9NSU5fUFggIT09IHVuZGVmaW5lZCA/IFRDLlNXSVBFX01JTl9QWCA6IDIwKSkgewogICAgICAgICAgICAgICAgY29uc3QgY2FtZXJhID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYTsKICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICBjb25zdCByaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAgICAgaWYgKGNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihmd2QpOwogICAgICAgICAgICAgICAgICAgIGZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAoZndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgZndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBmd2Qubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIHJpZ2h0LmNyb3NzVmVjdG9ycyhmd2QsIG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgICAgIHdvcmxkVmVjLmFkZFNjYWxlZFZlY3RvcihyaWdodCwgZHggKiAoVEMuQUlNX0RYX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5BSU1fRFhfU0NBTEUgOiAxLjApKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5hZGRTY2FsZWRWZWN0b3IoZndkLCAtZHkgKiAoVEMuQUlNX0RZX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5BSU1fRFlfU0NBTEUgOiAxLjApKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgYWltVmVjID0gd29ybGRWZWM7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdmVycmlkZUFpbVZlY3RvciA9IGFpbVZlYzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYWltVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFpbVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgfQoKLy8gLS0tIEFOQUxPRyBDVVJWRSBMT0dJQyAtLS0KICAgICAgICAgICAgLy8gRm9ybXVsYTogQ3VydmUgPSBJbnRlbnNpdHkgKiBTcGVlZAogICAgICAgICAgICBsZXQgc3BpblZlYyA9IG51bGw7CiAgICAgICAgICAgIAppZiAoKFRDLkNVUlZFX0VOQUJMRUQgIT09IGZhbHNlKSAmJiBjdXJ2ZUlucHV0ICYmIE1hdGguYWJzKGN1cnZlSW5wdXQuaW50ZW5zaXR5KSA+IChUQy5DVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEIDogMC4yNSkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJhd0ludGVuc2l0eSA9IE1hdGguYWJzKGN1cnZlSW5wdXQuaW50ZW5zaXR5KTsKICAgICAgICAgICAgICAgIGNvbnN0IHNpZ24gPSBNYXRoLnNpZ24oY3VydmVJbnB1dC5pbnRlbnNpdHkpOyAvLyBQb3NpdGl2ZSA9IFJpZ2h0IEh1bXAgPSBMZWZ0IEN1cnZlCiAgICAgICAgICAgICAgICBjb25zdCBzd2lwZVNwZWVkID0gY3VydmVJbnB1dC5zcGVlZCB8fCAxLjA7CgogICAgICAgICAgICAgICAgLy8gMS4gQmFzZSBTcGluIGZyb20gQXJjIChUdW5lZCBmb3IgcmVhbGlzbSwgbm8gY3ljbG9uZXMpCi8vIDEuIEJhc2UgU3BpbiBmcm9tIEFyYyAoSGVyY3VsZWFuIEJvb3N0KQogICAgICAgICAgICAgICAgbGV0IHNwaW5NYWcgPSByYXdJbnRlbnNpdHkgKiAoVEMuQ1VSVkVfU1BJTl9TQ0FMRSAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BJTl9TQ0FMRSA6IDEwMDAuMCk7CgogICAgICAgICAgICAgICAgLy8gMi4gU3BlZWQgQm9udXMgKFF1aWNrbmVzcyBhZGRzIFJQTSkKICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkQm9udXMgPSBNYXRoLm1heCgxLjAsIHN3aXBlU3BlZWQgKiAoVEMuQ1VSVkVfU1BFRURfTVVMVCAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BFRURfTVVMVCA6IDEuNSkpOwogICAgICAgICAgICAgICAgc3Bpbk1hZyAqPSBzcGVlZEJvbnVzOwoKICAgICAgICAgICAgICAgIC8vIENhcCAoSW5jcmVhc2VkIHRvIDE1MDAgZm9yIG1hc3NpdmUgYXJjcykKICAgICAgICAgICAgICAgIHNwaW5NYWcgPSBNYXRoLm1pbigoVEMuQ1VSVkVfU1BJTl9DQVAgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX1NQSU5fQ0FQIDogMTUwMC4wKSwgc3Bpbk1hZyk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgU3BpbgogICAgICAgICAgICAgICAgLy8gUmlnaHQgSHVtcCAoUG9zaXRpdmUgSW50ZW5zaXR5KSAtPiBMZWZ0IEN1cnZlIChQb3NpdGl2ZSBTcGluIFkpCiAgICAgICAgICAgICAgICBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3Bpbk1hZyAqIHNpZ24sIDApOwogICAgICAgICAgICAgICAgCmlmIChzcGluTWFnID4gKFRDLkNVUlZFX1BFUkZFQ1RfU1BJTiAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfUEVSRkVDVF9TUElOIDogNTAwLjApICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQRVJGRUNUIENVUlZFIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSb2xsSW1wdWxzZShzaWduICogLTAuMyk7IC8vIFRpbHQgY2FtZXJhIGludG8gdGhlIGN1cnZlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEZXRlcm1pbmUgVHlwZSAoUGFzcyB2cyBTaG9vdCkKLy8gRGV0ZXJtaW5lIFR5cGUgKFBhc3MgdnMgU2hvb3QpCmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtZ29hbERpc3QgOiBnb2FsRGlzdDsKICAgICAgICAgICAgY29uc3QgZ29hbERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIGdvYWxaIC0gdGhpcy5tZXNoLnBvc2l0aW9uLnopLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBjb25zdCBkb3RHb2FsID0gYWltVmVjLmRvdChnb2FsRGlyKTsKCiAgICAgICAgICAgIGxldCB0eXBlID0gJ1BBJzsKICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwoKICAgICAgICAgICAgaWYgKGRvdEdvYWwgPiAwLjggJiYgZGlzdFRvR29hbCA8IDM1LjApIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAnU0gnOwogICAgICAgICAgICB9IGVsc2UgaWYgKGRvdEdvYWwgPiAwLjUgJiYgZGlzdFRvR29hbCA8IDIwLjApIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAnU0gnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbWFydCBQYXNzIE92ZXJyaWRlCiAgICAgICAgICAgIGNvbnN0IHRhcmdldE1hdGUgPSB0aGlzLl9maW5kUGFzc1RhcmdldEluQ29uZShhaW1WZWMpOwogICAgICAgICAgICBpZiAodGFyZ2V0TWF0ZSAmJiB0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0TWF0ZSA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldE1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdE1hdGUgPCAxMi4wKSB0eXBlID0gJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgdHlwZSwgbXVsdGlwbGllciwgc3BpblZlYyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE5FVzogQ2hhcmdlIFVJIG1ldGhvZHMKICAgICAgICBfdXBkYXRlQ2hhcmdlVUkocmF0aW8pIHsKICAgICAgICAgICAgY29uc3QgbWV0ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhcmdlLW1ldGVyLWZpbGwnKTsKICAgICAgICAgICAgaWYgKG1ldGVyKSB7CiAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS53aWR0aCA9IGAke3JhdGlvICogMTAwfSVgOwogICAgICAgICAgICAgICAgaWYgKHJhdGlvID4gMC45KSB7CiAgICAgICAgICAgICAgICAgICAgbWV0ZXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAsICNmODApJzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmF0aW8gPiAwLjUpIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzBmMCwgI2ZmMCknOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzBhZiwgIzBmMCknOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIpIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlQ2hhcmdlVUkoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIpIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KCiAgICAgICAgc2V0T3ZlcnJpZGVBaW0oeCwgeikgewogICAgICAgICAgICBpZiAoIXRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yLnNldCh4LCAwLCB6KS5ub3JtYWxpemUoKTsKICAgICAgICB9Cgpsb3NlQmFsbCgpIHsKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwogICAgICAgICAgICAvLyBGaXg6IEVuc3VyZSBwbGF5ZXIgY2FuIGNhdGNoIGFnYWluIGlmIHRoZXkgbG9zZSBwb3NzZXNzaW9uIHVuZXhwZWN0ZWRseQogICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBzdGF0ZXMgdG8gcHJldmVudCBsb2NraW5nCiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQaHlzaWNzKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyBTWU5DIEZJWDogSWYgYmFsbCB0aGlua3MgSSBob2xkIGl0LCBidXQgSSBkb24ndCwgZm9yY2UgcmVjZWl2ZQogICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmICYmIHRoaXMuYmFsbFJlZi5ob2xkZXIgPT09IHRoaXMgJiYgIXRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJTeW5jaW5nIGJhbGwgcG9zc2Vzc2lvbiB0byBwbGF5ZXIiKTsKICAgICAgICAgICAgICAgIHRoaXMucmVjZWl2ZUJhbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaXNHb2RNb2RlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gdGhpcy5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gdGhpcy5nZXRTdGF0KCdFTicpOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMudmVub20gPSAwOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzTG9naWMoZHQpOwoKICAgICAgICAgICAgLy8gQ2hhcmdlIExvZ2ljIChQaHlzaWNzIHBhcnQgLSBUaW1lcikKICAgICAgICAgICAgaWYgKHRoaXMuaXNDaGFyZ2luZykgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgfHwgdGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBwaHlzaWNzIHByb3BzIHRoYXQgbWlnaHQgaGF2ZSBiZWVuIGFsdGVyZWQKICAgICAgICAgICAgICAgICAgICAvLyBWaXN1YWwgcmVzZXQgaGFwcGVucyBpbiB1cGRhdGVWaXN1YWxzCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSArPSBkdDsKICAgICAgICAgICAgICAgICAgICAvLyBBVVRPLVJFTEVBU0U6IElmIGhlbGQgdG9vIGxvbmcgKDNzKSwgZm9yY2UgcmVsZWFzZQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJnZVRpbWUgPiAzLjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWxlYXNlQ2hhcmdlKDAsIDApOyAKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuZGFzaENvb2xkb3duID4gMCkgdGhpcy5kYXNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmNsYXNoQ29vbGRvd24gPiAwKSB0aGlzLmNsYXNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLnN0dW5UaW1lciA+IDApIHRoaXMuc3R1blRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5pbW11bml0eVRpbWVyID4gMCkgdGhpcy5pbW11bml0eVRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5jYXRjaENvb2xkb3duID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2F0Y2hDb29sZG93biA8PSAwKSB0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGFzaCBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNtb290aCBSb3RhdGlvbiBkdXJpbmcgRGFzaCAoTG9naWMgYWZmZWN0aW5nIHRyYW5zZm9ybSkKICAgICAgICAgICAgICAgIGxldCBkaWZmID0gdGhpcy50YXJnZXRZYXcgLSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlmZiA+IE1hdGguUEkpIGRpZmYgLT0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlmZiA8IC1NYXRoLlBJKSBkaWZmICs9IE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB0dXJuU3BlZWQgPSAxNS4wOyAKICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5nZSA9IE1hdGgubWF4KC10dXJuU3BlZWQgKiBkdCwgTWF0aC5taW4odHVyblNwZWVkICogZHQsIGRpZmYpKTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyArPSBjaGFuZ2U7CgogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVDb2xsaXNpb24oKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGFzaFRpbWUgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXNoVHlwZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUeXBlID09PSAndmVydGljYWwnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5kYXNoVmVjKS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBZIHBvc2l0aW9uIGNhbGN1bGF0aW9uIGlzIHZpc3VhbC9waHlzaWNzIGh5YnJpZCwga2VlcGluZyBoZXJlIGZvciBjb2xsaXNpb24gY29uc2lzdGVuY3kKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IDEgLSAodGhpcy5kYXNoVGltZSAvIHRoaXMuZGFzaFRvdGFsVGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gTWF0aC5zaW4odCAqIE1hdGguUEkpICogMy4wOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhvcml6b250YWwgRGFzaCBNb3ZlbWVudAogICAgICAgICAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJvdGF0aW9uIHVwZGF0ZQogICAgICAgICAgICAgICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCB0aGlzLmN1cnJlbnRZYXcgKyB0aGlzLnJvdGF0aW9uT2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIGxlYW4gaXMgY2FsY3VsYXRlZCBpbiB1cGRhdGVWaXN1YWxzLCBidXQgd2Ugc2V0IGJhc2Ugb3JpZW50YXRpb24gaGVyZQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5jb3B5KF9wUXVhdCk7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOTYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3R1bi9OYXAgQ2hlY2sKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkcmFnRmFjdG9yID0gTWF0aC5tYXgoMCwgMSAtICgyLjAgKiBkdCkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihkcmFnRmFjdG9yKTsKCiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9jaGVja1RhY2tsZVByZXNzdXJlKGR0KTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgoMCwgMS4wIC0gKDIuMCAqIGR0KSkpOwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlTb2Z0Q29sbGlzaW9uKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5R29hbENyZWFzZShkdCk7CiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmVydGljYWxpdHkoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQmFua2luZyhkdCk7IAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVWZXJ0aWNhbGl0eShkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCYW5raW5nKGR0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlTG9jb21vdGlvbkFuaW0oZHQpOyAvLyBBbmltYXRpb24gc3RhdGUgbG9naWMgZHJpdmVuIGJ5IHBoeXNpY3Mgc3RhdGUKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzVmlzdWFscyhkdCk7CgogICAgICAgICAgICAvLyBDaGFyZ2UgVmlzdWFscwogICAgICAgICAgICBpZiAodGhpcy5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmIHRoaXMuc3RhdHVzLm5hcCA8PSAwICYmIHRoaXMuc3R1blRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHRoaXMuY2hhcmdlVGltZSAvIHRoaXMubWF4Q2hhcmdlVGltZSwgMS4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMZXZpdGF0aW9uCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaG92ZXIgPSAoTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDIpICogMC4xKSArIChyYXRpbyAqIDAuOCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hha2UgPSAwLjA1ICsgKDAuMSAqIHJhdGlvKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IGhvdmVyICsgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2U7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIEppdHRlcgogICAgICAgICAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlOwoKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0U2NhbGFyKHRoaXMuYmFzZVNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSShyYXRpbyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IHZpc3VhbHMgaWYgY2hhcmdlIGNhbmNlbGxlZAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0U2NhbGFyKHRoaXMuYmFzZVNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGFzaCBWaXN1YWxzIChQYXJ0aWNsZXMgJiBMZWFuKQogICAgICAgICAgICBpZiAodGhpcy5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9kYXNoUGFydGljbGVUaW1lciA9IDAuMDE7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhY2sgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCkubmVnYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYWNrLmxlbmd0aFNxKCkgPCAwLjEpIGJhY2suc2V0KDAsIDAsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwyOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChiYWNrLm11bHRpcGx5U2NhbGFyKDAuNSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gMS4wICsgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwb3MsIHsgc2NhbGU6IDIuMCArIE1hdGgucmFuZG9tKCkgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVmlzdWFsIExlYW4gZm9yIERhc2gKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUeXBlID09PSAnaG9yaXpvbnRhbCcgfHwgdGhpcy5kYXNoVHlwZSA9PT0gJ2JyZWFrJyB8fCB0aGlzLmRhc2hUeXBlID09PSAnc3ByaW50JykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAxIC0gKHRoaXMuZGFzaFRpbWUgLyB0aGlzLmRhc2hUb3RhbFRpbWUpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlYW4gPSBNYXRoLnNpbih0ICogTWF0aC5QSSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgX3BRdWF0LnNldEZyb21BeGlzQW5nbGUoX3BBeGlzWSwgdGhpcy5jdXJyZW50WWF3ICsgdGhpcy5yb3RhdGlvbk9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgbGV0IHBpdGNoID0gMCwgeWF3ID0gMCwgcm9sbCA9IDAsIGx1bmdlQW10ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXNoVHlwZSAhPT0gJ3NwcmludCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHBpdGNoID0gMS4yICogbGVhbjsgeWF3ID0gMC44ICogbGVhbjsgcm9sbCA9IC0wLjYgKiBsZWFuOyBsdW5nZUFtdCA9IDAuOCAqIGxlYW47CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHBpdGNoID0gMC41ICogbGVhbjsgbHVuZ2VBbXQgPSAwLjIgKiBsZWFuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGx1bmdlQW10ID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIGx1bmdlQW10KS5hcHBseVF1YXRlcm5pb24oX3BRdWF0KTsKICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBvZmZzZXQgb25seSwgZG9uJ3QgYWNjdW11bGF0ZSB0byBwaHlzaWNzIHBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAvLyBOb3RlOiBXZSBhcmUgbW9kaWZ5aW5nIG1lc2gucG9zaXRpb24gaGVyZSB3aGljaCBpcyB0aGUgcGh5c2ljcyB0cmFuc2Zvcm0uCiAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZGVhbGx5IHdlIHNob3VsZCBoYXZlIGEgdmlzdWFsIGNoaWxkIG5vZGUsIGJ1dCBmb3Igbm93IHdlIGFkZCB0aGUgb2Zmc2V0LgogICAgICAgICAgICAgICAgICAgICAgICAgLy8gVG8gcHJldmVudCBkcmlmdCwgd2UgcmVseSBvbiBwaHlzaWNzIHVwZGF0ZSByZXNldHRpbmcgWSBhbmQgWC9aIGJlaW5nIGludGVncmF0ZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAvLyBBY3R1YWxseSwgYWRkaW5nIHRvIG1lc2gucG9zaXRpb24gaGVyZSBXSUxMIGFmZmVjdCBwaHlzaWNzIG5leHQgZnJhbWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3Igbm93LCB3ZSBhY2NlcHQgdGhpcyB2aXN1YWwtaW1wYWN0aW5nLXBoeXNpY3MgYmVoYXZpb3IgYXMgaXQgd2FzIGluIG9yaWdpbmFsIGNvZGUuCiAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIF9wRXVsZXIuc2V0KHBpdGNoLCB5YXcsIHJvbGwpOwogICAgICAgICAgICAgICAgICAgIF9wUXVhdDIuc2V0RnJvbUV1bGVyKF9wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5UXVhdGVybmlvbnMoX3BRdWF0LCBfcFF1YXQyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3R1bi9OYXAgVmlzdWFsIFJlc2V0CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9hbmltTG9ja2VkICYmIHRoaXMuc3RhdGUgIT09ICdpZGxlJyAmJiB0aGlzLnN0YXRlICE9PSAnY2F0Y2gnKSB0aGlzLnBsYXkoJ2lkbGUnLCAwLjUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl91cGRhdGVIUEJhcigpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwoKICAgICAgICAgICAgLy8gQnViYmxlIFRyYWlsCiAgICAgICAgICAgIGNvbnN0IHNwZWVkU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGlmIChzcGVlZFNxID4gMS4wICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9idWJibGVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG0gPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhY2tEaXIgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCkubmVnYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gYmFja0Rpci5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKDAuOCk7CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LnkgPSAwLjUgKyBNYXRoLnJhbmRvbSgpICogMC41OyAKICAgICAgICAgICAgICAgICAgICBvZmZzZXQueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgIG9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZScsIHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLCB7IHNjYWxlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMjUgfSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChzcGVlZFNxID4gNDAuMCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1PZmZzZXQgPSBiYWNrRGlyLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC41ICsgTWF0aC5yYW5kb20oKSowLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC55ID0gMC41ICsgKE1hdGgucmFuZG9tKCktMC41KSowLjg7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChtT2Zmc2V0KSwgeyBzY2FsZTogMC4wNiArIE1hdGgucmFuZG9tKCkqMC4wOCB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDAuMDM7IAogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4xOyAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2FwcGx5UHJvY2VkdXJhbFBvc2UoZHQpOwogICAgICAgIH0KCiAgICAgICAgX2FwcGx5UHJvY2VkdXJhbFBvc2UoZHQpIHsKICAgICAgICAgICAgLy8gQWR2YW5jZSBsb2NhbCB0aW1lICh1c2VkIGZvciBzdWJ0bGUgc3dheXMpCiAgICAgICAgICAgIHRoaXMuX3Byb2NBbmltVGltZSArPSBkdDsKCiAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmJvbmVzOwogICAgICAgICAgICBpZiAoIWIpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSAoZ2FtZSAmJiBnYW1lLmVudGl0aWVzKSA/IGdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CgogICAgICAgICAgICBsZXQgc2hvdWxkQXBwbHkgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIEJ1aWxkIGEgZGVzaXJlZCB3b3JsZC1zcGFjZSBkaXJlY3Rpb24gd2Ugd2FudCB0aGUgdG9yc28vaGVhZCB0byBiaWFzIHRvd2FyZC4KICAgICAgICAgICAgLy8gTk9URTogV2UgYXBwbHkgdGhpcyBBRlRFUiB0aGUgYW5pbWF0aW9uIG1peGVyIGhhcyBwb3NlZCBib25lcywgYXMgYSBzbWFsbCBhZGRpdGl2ZSBvZmZzZXQuCiAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgLy8gQWltIGRpcmVjdGlvbiAocHJlZmVyIGV4cGxpY2l0IGFpbSB2ZWN0b3IpCiAgICAgICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5vdmVycmlkZUFpbVZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubG9ja2VkQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLmxvY2tlZEFpbVZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wOCkgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5pbnB1dFZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2hvdWxkQXBwbHkgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICAvLyBMb29rIGF0IHRoZSBiYWxsIGlmIGl0J3MgaW4gdGhlICJhd2FyZW5lc3MiIHJhZGl1cwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDIwLjApIHsKICAgICAgICAgICAgICAgICAgICBfcFZlYy5zdWJWZWN0b3JzKGJhbGwubWVzaC5wb3NpdGlvbiwgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICBzaG91bGRBcHBseSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghc2hvdWxkQXBwbHkpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENvbnZlcnQgdGhlIGRpcmVjdGlvbiBpbnRvIHRoZSBwbGF5ZXIncyBsb2NhbCBzcGFjZSBzbyB5YXcvcGl0Y2ggYXJlIHN0YWJsZS4KICAgICAgICAgICAgX3BJbnZRdWF0LmNvcHkodGhpcy5tZXNoLnF1YXRlcm5pb24pLmludmVydCgpOwogICAgICAgICAgICBfcFZlYy5hcHBseVF1YXRlcm5pb24oX3BJbnZRdWF0KS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIGNvbnN0IGx4ID0gX3BWZWMueCwgbHkgPSBfcFZlYy55LCBseiA9IF9wVmVjLno7CiAgICAgICAgICAgIGNvbnN0IHlhdyA9IE1hdGguYXRhbjIobHgsIGx6KTsKICAgICAgICAgICAgY29uc3QgcGl0Y2ggPSBNYXRoLmF0YW4yKGx5LCBNYXRoLnNxcnQobHggKiBseCArIGx6ICogbHopICsgMWUtNik7CgogICAgICAgICAgICBjb25zdCB5YXdDID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHlhdywgLTAuOSwgMC45KTsKICAgICAgICAgICAgY29uc3QgcGl0Y2hDID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHBpdGNoLCAtMC42LCAwLjYpOwoKICAgICAgICAgICAgY29uc3Qgc3BlZWROb3JtID0gKHRoaXMubWF4U3BlZWQgPiAwLjAwMDEpID8gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHRoaXMuX3Ntb290aGVkU3BlZWQgLyB0aGlzLm1heFNwZWVkLCAwLCAxKSA6IDA7CiAgICAgICAgICAgIGNvbnN0IGFpbVcgPSAodGhpcy5oYXNCYWxsID8gKHRoaXMuaXNDaGFyZ2luZyA/IDEuMCA6IDAuNjUpIDogMC4zNSkgKiAoMS4wIC0gMC4zNSAqIHNwZWVkTm9ybSk7CiAgICAgICAgICAgIGNvbnN0IGhlYWRXID0gKHRoaXMuaGFzQmFsbCA/IDAuNTUgOiAwLjc1KSAqICgxLjAgLSAwLjI1ICogc3BlZWROb3JtKTsKCiAgICAgICAgICAgIC8vIFRvcnNvIGJpYXMgKHNwaW5lL2NoZXN0KQogICAgICAgICAgICBpZiAoYi5jaGVzdCkgewogICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMjAgKiBhaW1XLCB5YXdDICogMC4zNSAqIGFpbVcsIDApOwogICAgICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgICAgIGIuY2hlc3QucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGIuc3BpbmUpIHsKICAgICAgICAgICAgICAgIF9wVG1wRXVsZXIuc2V0KC1waXRjaEMgKiAwLjE1ICogYWltVywgeWF3QyAqIDAuMjUgKiBhaW1XLCAwKTsKICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICBiLnNwaW5lLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSGVhZC9uZWNrIGxvb2sKICAgICAgICAgICAgaWYgKGIubmVjaykgewogICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMjUgKiBoZWFkVywgeWF3QyAqIDAuNDUgKiBoZWFkVywgMCk7CiAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgYi5uZWNrLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYi5oZWFkKSB7CiAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldCgtcGl0Y2hDICogMC4zMCAqIGhlYWRXLCB5YXdDICogMC41NSAqIGhlYWRXLCAwKTsKICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICBiLmhlYWQucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCYWxsLWhvbGQgLyBhaW0gYXJtIHBvc2UgKGtlZXBzICJzd2ltIiBhbmltYXRpb24gYnV0IHJlYWRzIGFzIGhvbGRpbmcvYWltaW5nKQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmICF0aGlzLmlzVGhyb3dpbmcgJiYgIXRoaXMuX2FuaW1Mb2NrZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLl9wcm9jQW5pbVRpbWU7CiAgICAgICAgICAgICAgICBjb25zdCBsaWZ0ID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKDAuMzUgKyAodGhpcy5pc0NoYXJnaW5nID8gMC41NSA6IDAuMjUpIC0gc3BlZWROb3JtICogMC4yLCAwLjE1LCAwLjk1KTsKICAgICAgICAgICAgICAgIGNvbnN0IHN3YXkgPSBNYXRoLnNpbih0ICogNS4wKSAqIDAuMDUgKiAoMC41ICsgbGlmdCk7CgogICAgICAgICAgICAgICAgY29uc3QgcmFpc2VYID0gLTAuNTUgKiBsaWZ0ICsgc3dheTsKICAgICAgICAgICAgICAgIGNvbnN0IHJhaXNlWiA9IC0wLjI1ICogbGlmdDsKCiAgICAgICAgICAgICAgICBpZiAoYi5yVXBwZXJBcm0pIHsKICAgICAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldChyYWlzZVgsIHlhd0MgKiAwLjEwICogbGlmdCwgcmFpc2VaKTsKICAgICAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIGIuclVwcGVyQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChiLnJGb3JlQXJtKSB7CiAgICAgICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLTAuMzUgKiBsaWZ0ICsgc3dheSAqIDAuNSwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgICAgICAgICBiLnJGb3JlQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDb3VudGVyYmFsYW5jZSBsZWZ0IGFybSBzbGlnaHRseSBmb3IgYSBtb3JlIGR5bmFtaWMgc2lsaG91ZXR0ZQogICAgICAgICAgICAgICAgaWYgKGIubFVwcGVyQXJtKSB7CiAgICAgICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoMC4xNSAqIGxpZnQsIC15YXdDICogMC4wNSAqIGxpZnQsIDAuMTUgKiBsaWZ0KTsKICAgICAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIGIubFVwcGVyQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KX3VwZGF0ZVN0YXR1cyhkdCkgewogICAgICAgIC8vIExlZ2FjeSB3cmFwcGVyCiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzTG9naWMoZHQpOwogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXR1c1Zpc3VhbHMoZHQpOwogICAgfQoKICAgIF91cGRhdGVTdGF0dXNMb2dpYyhkdCkgewogICAgICAgIGlmICh0aGlzLnN0YXR1cy52ZW5vbSA+IDApIHsKICAgICAgICAgICAgdGhpcy5zdGF0dXMudmVub20gLT0gZHQ7CiAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gNSAqIGR0OwogICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA8IDApIHRoaXMuc3RhdHMuSFAgPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsICYmIHRoaXMuc3RhdHMuSFAgPCB0aGlzLnN0YXRzLm1heEhQKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQICs9IDUgKiBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQID4gdGhpcy5zdGF0cy5tYXhIUCkgdGhpcy5zdGF0cy5IUCA9IHRoaXMuc3RhdHMubWF4SFA7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSAyLjAgKiBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPCAwKSB0aGlzLnN0YXRzLkhQID0gMDsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdHVzLm5hcCAtPSBkdDsKICAgICAgICB9CgogICAgICAgIGZvciAobGV0IGtleSBpbiB0aGlzLnN0YXR1cy53aXRoZXIpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltrZXldID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMud2l0aGVyW2tleV0gLT0gZHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgX3VwZGF0ZVN0YXR1c1Zpc3VhbHMoZHQpIHsKICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIgOiBudWxsOwoKICAgICAgICBpZiAodGhpcy5zdGF0dXMudmVub20gPiAwKSB7CiAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnZlbm9tIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgcG0uc3Bhd24oJ3Zlbm9tJywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnZlbm9tID0gMC4xNTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMubmFwIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMubmFwIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgIHBtLnNwYXduKCduYXAnLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMubmFwID0gMC44OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsZXQgaXNXaXRoZXJpbmcgPSBmYWxzZTsKICAgICAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5zdGF0dXMud2l0aGVyKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy53aXRoZXJba2V5XSA+IDApIGlzV2l0aGVyaW5nID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmIChpc1dpdGhlcmluZykgewogICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgcG0uc3Bhd24oJ3dpdGhlcicsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgPSAwLjI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbHMoKTsKICAgIH0KCl91cGRhdGVWaXN1YWxzKCkgewogICAgICAgICAgICAvLyBSRU1PVkVEOiBZZWxsb3cgc3BoZXJlL3RpbnQgbG9naWMgYXMgcGVyIHJlcXVlc3QuCiAgICAgICAgICAgIC8vIEFsd2F5cyByZXZlcnQgdG8gYmFzZSBjb2xvci4KICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5mb3JFYWNoKGVudHJ5ID0+IHsKICAgICAgICAgICAgICAgIGVudHJ5Lm1hdGVyaWFsLmNvbG9yLmNvcHkoZW50cnkuYmFzZUNvbG9yKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfY3JlYXRlQXVyYSgpIHsKICAgICAgICAgICAgLy8gQXVyYSByZW1vdmVkIHBlciB1c2VyIHJlcXVlc3QKICAgICAgICAgICAgdGhpcy5hdXJhTWVzaCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IFBhc3MgdGFyZ2V0IGluZGljYXRvcgogICAgICAgIF9jcmVhdGVQYXNzVGFyZ2V0SW5kaWNhdG9yKCkgewogICAgICAgICAgICAvLyBDcmVhdGUgYSByaW5nIHRoYXQgaGlnaGxpZ2h0cyBwb3RlbnRpYWwgcGFzcyB0YXJnZXRzCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMC44LCAxLjAsIDE2KTsKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgICAgIGNvbG9yOiAweDAwZmYwMCwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yID0gbmV3IFRIUkVFLk1lc2goZ2VvLCBtYXQpOwogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3Iucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnBvc2l0aW9uLnkgPSAwLjE7CiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMucGFzc1RhcmdldEluZGljYXRvcik7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlUGFzc1RhcmdldEluZGljYXRvcnMoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8ICF0aGlzLnRlYW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGaW5kIGJlc3QgcGFzcyB0YXJnZXQKICAgICAgICAgICAgY29uc3QgYWltRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5fZmluZFBhc3NUYXJnZXRJbkNvbmUoYWltRGlyKTsKCiAgICAgICAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0Lm1lc2ggJiYgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueCA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLng7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueiA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLno7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci5yb3RhdGlvbi56ICs9IDAuMDU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpIHsKICAgICAgICAgICAgaWYgKHRoaXMucGFzc1RhcmdldEluZGljYXRvcikgewogICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9hcHBseVNvZnRDb2xsaXNpb24oZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2ggfHwgIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgdGVhbXMgPSBbZ2FtZS50ZWFtcy5ob21lLCBnYW1lLnRlYW1zLmF3YXldOwoKICAgICAgICAgICAgY29uc3QgcmVwdWxzaW9uUmFkaXVzID0gMC41OyAvLyBSZWR1Y2VkIHRvIDAuNSB0byBmaXggaW52aXNpYmxlIHdhbGwgaXNzdWVzCiAgICAgICAgICAgIGNvbnN0IHN0aWZmbmVzcyA9IDE1LjA7CgogICAgICAgICAgICB0ZWFtcy5mb3JFYWNoKHRlYW0gPT4gewogICAgICAgICAgICAgICAgaWYgKCF0ZWFtKSByZXR1cm47CiAgICAgICAgICAgICAgICB0ZWFtLnBsYXllcnMuZm9yRWFjaChvdGhlciA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG90aGVyID09PSB0aGlzIHx8ICFvdGhlci5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGR4ID0gdGhpcy5tZXNoLnBvc2l0aW9uLnggLSBvdGhlci5tZXNoLnBvc2l0aW9uLng7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHkgPSB0aGlzLm1lc2gucG9zaXRpb24ueSAtIG90aGVyLm1lc2gucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkeiA9IHRoaXMubWVzaC5wb3NpdGlvbi56IC0gb3RoZXIubWVzaC5wb3NpdGlvbi56OwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR5KmR5ICsgZHoqZHo7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWluRGlzdCA9IHJlcHVsc2lvblJhZGl1cyAqIDIuMDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IG1pbkRpc3QgKiBtaW5EaXN0ICYmIGRpc3RTcSA+IDAuMDAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG92ZXJsYXAgPSBtaW5EaXN0IC0gZGlzdDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gb3ZlcmxhcCAqIHN0aWZmbmVzczsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG54ID0gZHggLyBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBueSA9IGR5IC8gZGlzdDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbnogPSBkeiAvIGRpc3Q7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gbnggKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKz0gbnkgKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gbnogKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICB0aGlzLl9hcHBseVNvZnRDb2xsaXNpb24oZHQpOwogICAgICAgICAgICB0aGlzLl9hcHBseUdvYWxDcmVhc2UoZHQpOwoKICAgICAgICAgICAgY29uc3QgaW5wdXRMZW5TcSA9IHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKTsKICAgICAgICAgICAgY29uc3QgaXNJbnB1dEFjdGl2ZSA9IGlucHV0TGVuU3EgPiAwLjAxOwoKICAgICAgICAgICAgbGV0IGN1cnJlbnRNYXhTcGVlZCA9IHRoaXMubWF4U3BlZWQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTVFJVR0dMRSBTVEFURTogSGluZGVyIG1vdmVtZW50IGJhc2VkIG9uIHByZXNzdXJlCiAgICAgICAgICAgIC8vIEluc3RlYWQgb2YgYSBiaW5hcnkgMC44IG11bHRpcGxpZXIsIHdlIHNjYWxlIGJhc2VkIG9uIGludGVuc2l0eS4KICAgICAgICAgICAgLy8gTWF4IHN0cnVnZ2xlICgxLjApIHJlZHVjZXMgc3BlZWQgdG8gNDAlLgogICAgICAgICAgICBpZiAodGhpcy5zdHJ1Z2dsZUludGVuc2l0eSA+IDApIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRNYXhTcGVlZCAqPSAoMS4wIC0gKHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgKiAwLjYpKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgc2xpZ2h0IHJlZHVjdGlvbiBpZiBlbmdhZ2VkIGJ1dCBsb3cgcHJlc3N1cmUKICAgICAgICAgICAgICAgIGN1cnJlbnRNYXhTcGVlZCAqPSAwLjk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmlzQ2hhcmdpbmcpIGN1cnJlbnRNYXhTcGVlZCAqPSAwLjk7CgogICAgICAgICAgICBpZiAoaXNJbnB1dEFjdGl2ZSkgewogICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLmlucHV0VmVjdG9yKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSBTdHJ1Z2dsZSBKaXR0ZXIgdG8gZGlyZWN0aW9uCiAgICAgICAgICAgICAgICAvLyBTaW11bGF0ZXMgd3Jlc3RsaW5nIGZvciBjb250cm9sCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdHJ1Z2dsZUludGVuc2l0eSA+IDAuMykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGppdHRlciA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgKiAwLjg7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMueCArPSBqaXR0ZXI7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMueiArPSBqaXR0ZXI7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0VmVsWCA9IF9wVmVjLnggKiBjdXJyZW50TWF4U3BlZWQ7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRWZWxaID0gX3BWZWMueiAqIGN1cnJlbnRNYXhTcGVlZDsKCiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50U3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWRSYXRpbyA9IE1hdGgubWluKDEuMCwgY3VycmVudFNwZWVkIC8gdGhpcy5tYXhTcGVlZCk7CgogICAgICAgICAgICAgICAgLy8gQWdpbGl0eSBpcyByZWR1Y2VkIHdoZW4gc3RydWdnbGluZwogICAgICAgICAgICAgICAgbGV0IGFnaWxpdHkgPSBUSFJFRS5NYXRoVXRpbHMubGVycCgxMC4wLCAyLjAsIHNwZWVkUmF0aW8pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPiAwKSBhZ2lsaXR5ICo9IDAuNTsKCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gMS4wIC0gTWF0aC5wb3coMC4wMSwgZHQgKiBhZ2lsaXR5KTsKCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gKHRhcmdldFZlbFggLSB0aGlzLnZlbG9jaXR5LngpICogdDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiArPSAodGFyZ2V0VmVsWiAtIHRoaXMudmVsb2NpdHkueikgKiB0OwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJyYWtlRmFjdG9yID0gMi4wOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IDEuMCAtIE1hdGgucG93KDAuMSwgZHQgKiBicmFrZUZhY3Rvcik7CgogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9ICgwIC0gdGhpcy52ZWxvY2l0eS54KSAqIHQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gKDAgLSB0aGlzLnZlbG9jaXR5LnopICogdDsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMC4wMSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIHRoaXMudmVsb2NpdHkueSwgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSBNYXRoLm1heCgwLCAxLjAgLSAoMi4wICogZHQpKTsKCiAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoZHQpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVWZXJ0aWNhbGl0eShkdCkgewogICAgICAgICAgICBsZXQgdGFyZ2V0WSA9IDA7CgogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CgogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2ggJiYgIXRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvQmFsbCA8IDE1LjApIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRZID0gYmFsbC5tZXNoLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRhcmdldFkgPSAwLjU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHlEaWZmID0gdGFyZ2V0WSAtIHRoaXMubWVzaC5wb3NpdGlvbi55OwoKICAgICAgICAgICAgY29uc3QgbGlmdCA9IHlEaWZmICogMTAuMCAqIGR0OwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKz0gbGlmdDsKCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gucG9zaXRpb24ueSA+IDguMCkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSA4LjA7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLTAuNTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLm1lc2gucG9zaXRpb24ueSA8IC04LjApIHsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gLTguMDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSAtMC41OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBGSVhFRDogSW1wcm92ZWQgYmFua2luZyB3aXRoIGh5c3RlcmVzaXMgdG8gcHJldmVudCBmYWNpbmcgZmxpcHMKLy8gRklYRUQ6IEltcHJvdmVkIGJhbmtpbmcgd2l0aCBoeXN0ZXJlc2lzIHRvIHByZXZlbnQgZmFjaW5nIGZsaXBzCiAgICAgICAgX3VwZGF0ZUJhbmtpbmcoZHQpIHsKICAgICAgICAgICAgY29uc3QgaW5wdXRMZW5TcSA9IHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKTsKICAgICAgICAgICAgY29uc3QgdmVsTGVuU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CgogICAgICAgICAgICBsZXQgdGFyZ2V0WWF3ID0gdGhpcy50YXJnZXRZYXc7CiAgICAgICAgICAgIGxldCBzaG91bGRVcGRhdGVZYXcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDE6IEV4cGxpY2l0IEFpbSAoQWltIFN0aWNrIC8gU3dpcGUpCiAgICAgICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IueCwgdGhpcy5vdmVycmlkZUFpbVZlY3Rvci56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUFJJT1JJVFkgMjogTW92ZW1lbnQgSW5wdXQKICAgICAgICAgICAgZWxzZSBpZiAoaW5wdXRMZW5TcSA+IHRoaXMuZmFjaW5nRGVhZHpvbmUgKiB0aGlzLmZhY2luZ0RlYWR6b25lKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMuaW5wdXRWZWN0b3IueCwgdGhpcy5pbnB1dFZlY3Rvci56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDM6IFZlbG9jaXR5IChEcmlmdGluZykKICAgICAgICAgICAgZWxzZSBpZiAodmVsTGVuU3EgPiB0aGlzLmZhY2luZ0RlYWR6b25lICogdGhpcy5mYWNpbmdEZWFkem9uZSkgewogICAgICAgICAgICAgICAgdGFyZ2V0WWF3ID0gTWF0aC5hdGFuMih0aGlzLnZlbG9jaXR5LngsIHRoaXMudmVsb2NpdHkueik7CiAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGVZYXcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB3ZSBzaG91bGQgdXBkYXRlLCBkbyBzby4gT3RoZXJ3aXNlIGtlZXAgbGFzdCB2YWxpZCB5YXcKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZVlhdykgewogICAgICAgICAgICAgICAgdGhpcy5sYXN0VmFsaWRZYXcgPSB0YXJnZXRZYXc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSB0aGlzLmxhc3RWYWxpZFlhdzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU21vb3RoIFlhdyB3aXRoIHdyYXAtYXJvdW5kIGhhbmRsaW5nCiAgICAgICAgICAgIGxldCBkaWZmID0gdGFyZ2V0WWF3IC0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICB3aGlsZSAoZGlmZiA+IE1hdGguUEkpIGRpZmYgLT0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgIHdoaWxlIChkaWZmIDwgLU1hdGguUEkpIGRpZmYgKz0gTWF0aC5QSSAqIDI7CgogICAgICAgICAgICBjb25zdCBzcGVlZFJhdGlvID0gTWF0aC5taW4oMS4wLCB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpIC8gdGhpcy5tYXhTcGVlZCk7CmNvbnN0IHR1cm5TcGVlZCA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDguMCwgNC4wLCBzcGVlZFJhdGlvKTsgLy8gUmVkdWNlZCBmcm9tIDEyLjAvNi4wIHRvIHJlZHVjZSBmbGlwcGluZwoKICAgICAgICAgICAgLy8gUHJldmVudCBzdWRkZW4gc25hcHMgd2hlbiBkaWZmIGlzIHZlcnkgbGFyZ2UgKHRlbGVwb3J0L3Jlc2V0IHNjZW5hcmlvcykKICAgICAgICAgICAgY29uc3QgbWF4WWF3Q2hhbmdlID0gTWF0aC5QSSAqIGR0ICogdHVyblNwZWVkOwogICAgICAgICAgICBjb25zdCB5YXdDaGFuZ2UgPSBNYXRoLm1heCgtbWF4WWF3Q2hhbmdlLCBNYXRoLm1pbihtYXhZYXdDaGFuZ2UsIGRpZmYgKiBkdCAqIHR1cm5TcGVlZCkpOwoKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ICs9IHlhd0NoYW5nZTsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSB0YXJnZXRZYXc7CgogICAgICAgICAgICAvLyBCYW5raW5nCiAgICAgICAgICAgIGNvbnN0IGJhbmtTZW5zaXRpdml0eSA9IDAuODsKICAgICAgICAgICAgY29uc3QgbWF4QmFuayA9IDAuNzU7CgogICAgICAgICAgICBsZXQgdGFyZ2V0QmFuayA9IC1kaWZmICogYmFua1NlbnNpdGl2aXR5OwogICAgICAgICAgICB0YXJnZXRCYW5rID0gTWF0aC5tYXgoLW1heEJhbmssIE1hdGgubWluKG1heEJhbmssIHRhcmdldEJhbmspKTsKCiAgICAgICAgICAgIGNvbnN0IGJhbmtMZXJwID0gMS4wIC0gTWF0aC5wb3coMC4wMiwgZHQpOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgKz0gKHRhcmdldEJhbmsgLSB0aGlzLmJhbmtpbmdBbW91bnQpICogYmFua0xlcnA7CgogICAgICAgICAgICAvLyBQaXRjaAogICAgICAgICAgICBjb25zdCBwaXRjaFNlbnNpdGl2aXR5ID0gMC4xOwogICAgICAgICAgICBjb25zdCBtYXhQaXRjaCA9IDEuMDsKCiAgICAgICAgICAgIGxldCB0YXJnZXRQaXRjaCA9IC10aGlzLnZlbG9jaXR5LnkgKiBwaXRjaFNlbnNpdGl2aXR5OwogICAgICAgICAgICB0YXJnZXRQaXRjaCA9IE1hdGgubWF4KC1tYXhQaXRjaCwgTWF0aC5taW4obWF4UGl0Y2gsIHRhcmdldFBpdGNoKSk7CgogICAgICAgICAgICBjb25zdCBwaXRjaExlcnAgPSAxLjAgLSBNYXRoLnBvdygwLjA1LCBkdCk7CiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgKz0gKHRhcmdldFBpdGNoIC0gdGhpcy5waXRjaEFtb3VudCkgKiBwaXRjaExlcnA7CgogICAgICAgICAgICAvLyBBcHBseSBSb3RhdGlvbgogICAgICAgICAgICBjb25zdCBmaW5hbFlhdyA9IHRoaXMuY3VycmVudFlhdyArIHRoaXMucm90YXRpb25PZmZzZXQ7CgogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5zZXRGcm9tQXhpc0FuZ2xlKF9wQXhpc1ksIGZpbmFsWWF3KTsKCiAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDEsIDAsIDApLCB0aGlzLnBpdGNoQW1vdW50KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BRdWF0KTsKCiAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLCB0aGlzLmJhbmtpbmdBbW91bnQpOwogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseShfcFF1YXQpOwoKICAgICAgICAgICAgLy8gSWRsZSBCb2IKICAgICAgICAgICAgaWYgKHZlbExlblNxIDwgMC4xICYmICF0aGlzLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IERhdGUubm93KCkgKiAwLjAwMTU7CiAgICAgICAgICAgICAgICBjb25zdCBib2JQaXRjaCA9IE1hdGguc2luKHRpbWUpICogMC4wMzsKICAgICAgICAgICAgICAgIGNvbnN0IGJvYlJvbGwgPSBNYXRoLmNvcyh0aW1lICogMC43KSAqIDAuMDI7CgpfcEV1bGVyLnNldChib2JQaXRjaCwgMCwgYm9iUm9sbCk7CiAgICAgICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUV1bGVyKF9wRXVsZXIpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BRdWF0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9jaGVja1RhY2tsZVByZXNzdXJlKGR0KSB7CiAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNFbmdhZ2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIXRoaXMudGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CiAgICAgICAgICAgIGlmICghb3Bwb25lbnRUZWFtKSByZXR1cm47CgogICAgICAgICAgICBsZXQgdG90YWxQcmVzc3VyZSA9IDA7CiAgICAgICAgICAgIGxldCBlbmdhZ2VkQ291bnQgPSAwOwogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVSYWRpdXMgPSB0aGlzLnRhY2tsZVJhZGl1czsgCgogICAgICAgICAgICAvLyBGb3J3YXJkIHZlY3RvciBmb3Igc2hpZWxkaW5nIGNoZWNrCiAgICAgICAgICAgIF9wVmVjLmNvcHkoX3BBeGlzWikuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsgCgogICAgICAgICAgICBmb3IgKGNvbnN0IGVudGl0eSBvZiBvcHBvbmVudFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCB8fCBlbnRpdHkuc3RhdHVzLm5hcCA+IDAgfHwgZW50aXR5LnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oZW50aXR5Lm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCBlZmZlY3RpdmVSYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICBlbmdhZ2VkQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgUHJlc3N1cmUgSW50ZW5zaXR5ICgwIHRvIDEgYmFzZWQgb24gZGlzdGFuY2UpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJveGltaXR5ID0gMS4wIC0gKGRpc3QgLyBlZmZlY3RpdmVSYWRpdXMpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEJhc2UgUHJlc3N1cmUgZnJvbSBBVCBzdGF0CiAgICAgICAgICAgICAgICAgICAgbGV0IHByZXNzdXJlID0gZW50aXR5LmdldFN0YXQoJ0FUJykgKiBwcm94aW1pdHk7CgogICAgICAgICAgICAgICAgICAgIC8vIERpcmVjdGlvbmFsIFNoaWVsZGluZyAoQ29udGludW91cykKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b09wcCA9IGVudGl0eS5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZG90ID0gX3BWZWMuZG90KHRvT3BwKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJZiBvcHBvbmVudCBpcyBCRUhJTkQgKGRvdCA8IC0wLjIpLCBwcmVzc3VyZSBpcyByZWR1Y2VkIChTaGllbGRpbmcpCiAgICAgICAgICAgICAgICAgICAgbGV0IGlzU2hpZWxkZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoZG90IDwgLTAuMikgewogICAgICAgICAgICAgICAgICAgICAgICBwcmVzc3VyZSAqPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzU2hpZWxkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gVGVjaCBNb2RpZmllcnMgKENvbnRpbnVvdXMgYXBwbGljYXRpb24gY2hhbmNlKQogICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkudGVjaHMudGFja2xlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgZHQgKiAwLjUpIHRoaXMuYXBwbHlTdGF0dXMoJ3Zlbm9tJywgNS4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMS4yOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCBkdCAqIDAuNSkgdGhpcy5hcHBseVN0YXR1cygnd2l0aGVyJywgNS4wLCAnRU4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMS4yOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ2RyYWluJykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkcmFpbkFtdCA9IHByZXNzdXJlICogZHQgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gZHJhaW5BbXQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eS5zdGF0cy5IUCArPSBkcmFpbkFtdDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRvdGFsUHJlc3N1cmUgKz0gcHJlc3N1cmU7CgogICAgICAgICAgICAgICAgICAgIC8vIFZpc3VhbHM6IFNwYXJrcyBvY2Nhc2lvbmFsbHkgYmFzZWQgb24gcHJlc3N1cmUKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IGR0ICogNC4wICogcHJveGltaXR5KSB7IAogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuc3Bhd25DbGFzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWlkID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkubGVycChlbnRpdHkubWVzaC5wb3NpdGlvbiwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pZC55ICs9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuc3Bhd25DbGFzaChtaWQsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gT2NjYXNpb25hbCBTaGllbGQgVGV4dAogICAgICAgICAgICAgICAgICAgIGlmIChpc1NoaWVsZGVkICYmIE1hdGgucmFuZG9tKCkgPCBkdCAqIDEuMCAmJiBnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU0hJRUxEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiYmxvY2siKTsgLy8gVG9vIHNwYW1teSwgbWF5YmUganVzdCBzb3VuZCBsYXRlcgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5pc0VuZ2FnZWQgPSAoZW5nYWdlZENvdW50ID4gMCk7CgogICAgICAgICAgICBpZiAodGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5jb3VudGVyVGltZXIgKz0gZHQ7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgRU4gRHJhaW4gKENvbnRpbnVvdXMpCiAgICAgICAgICAgICAgICAvLyBTY2FsaW5nOiAyMCBBVCBwcmVzc3VyZSAtPiBhcHByb3ggMTAgRU4gbG9zdCBwZXIgc2Vjb25kCiAgICAgICAgICAgICAgICBjb25zdCBkcmFpblJhdGUgPSB0b3RhbFByZXNzdXJlICogMC41OyAKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOIC09IGRyYWluUmF0ZSAqIGR0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgU3RydWdnbGUgSW50ZW5zaXR5IGZvciBQaHlzaWNzICgwLjAgdG8gMS4wKQogICAgICAgICAgICAgICAgLy8gTWF4IHN0cnVnZ2xlIGF0IHJvdWdobHkgMzAgcHJlc3N1cmUKICAgICAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSBNYXRoLm1pbigxLjAsIHRvdGFsUHJlc3N1cmUgLyAzMC4wKTsKCiAgICAgICAgICAgICAgICAvLyBWaXN1YWwgRmVlZGJhY2sgZm9yIERyYWluIChBY2N1bXVsYXRlIHRvIGF2b2lkIHNwYW0pCiAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSArPSBkcmFpblJhdGUgKiBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSA+IDUuMCkgewogICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bihgLSR7TWF0aC5mbG9vcih0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSl9YCwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkRGFtYWdlID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSGludCBmb3IgcGxheWVyIGlmIGVuZ2FnZWQgdG9vIGxvbmcKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVuY291bnRlclRpbWVyID4gMS4wICYmIHRoaXMuZW5jb3VudGVyVGltZXIgPCAxLjEgJiYgdGhpcy50ZWFtLmlzSHVtYW4gJiYgdGhpcy50ZWFtLmFjdGl2ZVBsYXllciA9PT0gdGhpcykgewogICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJCUkVBSyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDw9IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuZnVtYmxlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9wZXJmb3JtSmVjaHRLbm9ja2JhY2soKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwoKICAgICAgICAgICAgaWYgKCFvcHBvbmVudFRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHJhbmdlID0gNi4wOwogICAgICAgICAgICBjb25zdCBmb3JjZSA9IDI1LjA7CgogICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJKRUNIVCBTSE9UISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImdvYWwiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgb3Bwb25lbnRUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ocC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBkaXIueSA9IDAuNTsKICAgICAgICAgICAgICAgICAgICBkaXIubm9ybWFsaXplKCk7CgpwLnZlbG9jaXR5LmFkZChkaXIubXVsdGlwbHlTY2FsYXIoZm9yY2UpKTsKCiAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAyLjA7IC8vIEVuc3VyZSB0aGV5IHN0YXkgZG93bgogICAgICAgICAgICAgICAgICAgIHAuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVhY3RBY3Rpb24gPSBwLmFjdGlvbnMgJiYgcC5hY3Rpb25zWydyZWFjdCddOwogICAgICAgICAgICAgICAgICAgIGlmIChyZWFjdEFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZWFjdEFjdGlvbi5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVhY3RBY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXlPbmVTaG90KCdyZWFjdCcsIDAuMSk7Cn0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2gnLCAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTTUFDSyEiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUudHJpZ2dlckltcGFjdCkgZ2FtZS50cmlnZ2VySW1wYWN0KDAuMTUsICdzaGF0dGVyJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVtYmxlKCkgewogICAgICAgICAgICBjb25zb2xlLmxvZygiRlVNQkxFISBFTiBEZXBsZXRlZC4iKTsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgdGhpcy5tZXNoKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDUkFTSCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zdHVuVGltZXIgPSAxLjU7CgogICAgICAgICAgICBjb25zdCBiYWNrRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgYmFja0Rpci54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgYmFja0Rpci56ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgYmFja0Rpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKGJhY2tEaXIubXVsdGlwbHlTY2FsYXIoMTIuMCkpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgaWYgKGJhbGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlamVjdERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKE1hdGgucmFuZG9tKCktMC41LCAwLjgsIE1hdGgucmFuZG9tKCktMC41KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBiYWxsLnNob290KGVqZWN0RGlyLCA2LjAsICdub25lJyk7CnRoaXMubG9zZUJhbGwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZGFzaCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzRGFzaGluZyB8fCB0aGlzLmRhc2hDb29sZG93biA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKCiAgICAgICAgICAgIC8vIE9GRkVOU0U6IEJSRUFLIFRBQ0tMRQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmIHRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjb3N0ID0gMTU7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkZBSUxFRCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mdW1ibGUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDIuMDsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnYnJlYWsnOwoKX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CnRoaXMudmVsb2NpdHkuYWRkKF9wVmVjLm11bHRpcGx5U2NhbGFyKDEwLjApKTsgLy8gTmVyZmVkIGZyb20gMTUuMCBmb3IgcmVhbGlzbQoKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW1JZCA9IHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CgogICAgICAgICAgICAgICAgb3Bwb25lbnRUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgdGhpcy50YWNrbGVSYWRpdXMgKiAxLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVzaERpciA9IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBwdXNoRGlyLnkgPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuYWRkKHB1c2hEaXIubXVsdGlwbHlTY2FsYXIoMTUuMCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2gnLCAwLjIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU1RVTiEiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJSRUFLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAovLyBORVc6IFNwYXduIEJyZWFrIEdseXBoIChFeHBsb3NpdmUgQnVyc3QpCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLmdseXBoTWFuYWdlci5zcGF3bignc3RhdHVzJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC41LAogICAgICAgICAgICAgICAgICAgICAgICByb3RhdGlvblNwZWVkOiA4LjAsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IDMuMCwKICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WTogMC41CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKLy8gUGFydGljbGUgQnVyc3QgKEJyZWFrIFRhY2tsZSkKLy8gUGFydGljbGUgQnVyc3QgKEJyZWFrIFRhY2tsZSkKICAgICAgICAgICAgICAgIGlmIChnYW1lLnBhcnRpY2xlTWFuYWdlcikgewpmb3IobGV0IGk9MDsgaTwzMDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAyLjUgfSk7CiAgICAgICAgICAgICAgICAgICAgLy8gQnViYmxlIEJ1cnN0CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBidWJibGVQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSoyLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMikpOwogICAgICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgYnViYmxlUG9zLCB7IHNjYWxlOiAwLjIgKyBNYXRoLnJhbmRvbSgpICogMC40IH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS50cmlnZ2VySW1wYWN0KSBnYW1lLnRyaWdnZXJJbXBhY3QoMC4xNSwgJ2hlYXZ5Jyk7CgogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE9GRkVOU0U6IFNQUklOVAogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjb3N0ID0gNTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRFTiA8IGNvc3QpIHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJOTyBFTiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOIC09IGNvc3Q7CiAgICAgICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gMC40OwogICAgICAgICAgICAgICAgdGhpcy5kYXNoQ29vbGRvd24gPSAxLjU7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ3NwcmludCc7Cgpjb25zdCBidXJzdERpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGlmIChidXJzdERpci5sZW5ndGhTcSgpIDwgMC4xKSBidXJzdERpci5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKCnRoaXMudmVsb2NpdHkuYWRkKGJ1cnN0RGlyLm11bHRpcGx5U2NhbGFyKDEyLjApKTsgLy8gTmVyZmVkIGZyb20gMTUuMAogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcpOwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZEZvdkltcHVsc2UoMjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJEQVNIISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gREVGRU5TRTogQkxPQ0sgLyBUQUNLTEUKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBsZXQgaXNCbG9ja0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgOC4wICYmIGJhbGwubWVzaC5wb3NpdGlvbi55ID4gMi41KSB7CiAgICAgICAgICAgICAgICAgICAgaXNCbG9ja0NvbnRleHQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSB0aGlzLmRhc2hUb3RhbFRpbWU7CiAgICAgICAgICAgIHRoaXMuZGFzaENvb2xkb3duID0gMS41OwoKICAgICAgICAgICAgY29uc3QgbGVuID0gTWF0aC5zcXJ0KHgqeCArIHoqeik7CiAgICAgICAgICAgIGNvbnN0IG54ID0gKGxlbiA+IDApID8geC9sZW4gOiAwOwogICAgICAgICAgICBjb25zdCBueiA9IChsZW4gPiAwKSA/IHovbGVuIDogMDsKCmlmIChsZW4gPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBTbW9vdGggdHVybiBmb3IgZGFzaCBpbnN0ZWFkIG9mIHNuYXAKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0WWF3ID0gTWF0aC5hdGFuMihueCwgbnopOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc0Jsb2NrQ29udGV4dCkgewogICAgICAgICAgICAgICAgdGhpcy5kYXNoVHlwZSA9ICd2ZXJ0aWNhbCc7CgogICAgICAgICAgICAgICAgY29uc3QgZGlyVG9CYWxsID0gYmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBkaXJUb0JhbGwueSA9IDA7CgogICAgICAgICAgICAgICAgaWYgKGRpclRvQmFsbC5sZW5ndGhTcSgpID4gMC4wMSkgewogICAgICAgICAgICAgICAgICAgIGRpclRvQmFsbC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2hWZWMuY29weShkaXJUb0JhbGwpLm11bHRpcGx5U2NhbGFyKDguMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZGFzaFZlYy5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgY2F0Y2hBY3Rpb24gPSB0aGlzLmFjdGlvbnNbJ2NhdGNoJ107CiAgICAgICAgICAgICAgICBpZiAoY2F0Y2hBY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICBjYXRjaEFjdGlvbi5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgICAgICBjYXRjaEFjdGlvbi5jbGFtcFdoZW5GaW5pc2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hBY3Rpb24udGltZVNjYWxlID0gMS41OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wbGF5KCdjYXRjaCcsIDAuMSk7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTE9DSyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkZWZhdWx0Iik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5kYXNoVHlwZSA9ICdob3Jpem9udGFsJzsKICAgICAgICAgICAgICAgIHRoaXMuX2hhc0hpdFRhY2tsZSA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IHZlbG9jaXR5IGltcHVsc2UgaW4gZGFzaCBkaXJlY3Rpb24KLy8gQXBwbHkgdmVsb2NpdHkgaW1wdWxzZSBpbiBkYXNoIGRpcmVjdGlvbgogICAgICAgICAgICAgICAgX3BWZWMuc2V0KG54LCAwLCBueik7CiAgICAgICAgICAgICAgICBpZiAoX3BWZWMubGVuZ3RoU3EoKSA8IDAuMSkgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgfQp0aGlzLnZlbG9jaXR5LmFkZChfcFZlYy5tdWx0aXBseVNjYWxhcigxNC4wKSk7IC8vIE5lcmZlZCBmcm9tIDIwLjAKCiAgICAgICAgICAgICAgICBjb25zdCBsdW5nZUFjdGlvbiA9IHRoaXMuYWN0aW9uc1sndGhyb3cnXTsKICAgICAgICAgICAgICAgIGlmIChsdW5nZUFjdGlvbikgewogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBsdW5nZUFjdGlvbi50aW1lU2NhbGUgPSAyLjA7CiAgICAgICAgICAgICAgICB9CnRoaXMucGxheSgndGhyb3cnLCAwLjEpOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcpOwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCkgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QoMC4wNSwgJ2RlZmF1bHQnKTsKICAgICAgICAgICAgfQoKaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKDEwKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuMyk7IAogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIERhc2ggRWZmZWN0CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXNoUG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICBkYXNoUG9zLnkgKz0gMS4wOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgZGFzaFBvcywgeyBzY2FsZTogMS41LCBsaWZlOiAwLjMgfSk7CiAgICAgICAgICAgICAgICAvLyBTcGVlZCBsaW5lcwogICAgICAgICAgICAgICAgY29uc3QgYmFjayA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDM7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBkYXNoUG9zLmNsb25lKCkuYWRkKGJhY2subXVsdGlwbHlTY2FsYXIoTWF0aC5yYW5kb20oKSkpOwogICAgICAgICAgICAgICAgICAgIHAueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2Rhc2hfc3RyZWFtJywgcCwgeyBzY2FsZTogMS41IH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY3JlYXRlSFBCYXIoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IG5ldyBUSFJFRS5Hcm91cCgpOwoKICAgICAgICAgICAgY29uc3QgYmdHZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjIsIDAuMTUpOwogICAgICAgICAgICBjb25zdCBiZ01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwMDAwMCwgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgZGVwdGhUZXN0OiBmYWxzZSB9KTsKICAgICAgICAgICAgY29uc3QgYmcgPSBuZXcgVEhSRUUuTWVzaChiZ0dlbywgYmdNYXQpOwogICAgICAgICAgICBjb250YWluZXIuYWRkKGJnKTsKCiAgICAgICAgICAgIGNvbnN0IGZpbGxHZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjE2LCAwLjExKTsKICAgICAgICAgICAgZmlsbEdlby50cmFuc2xhdGUoMC41OCwgMCwgMCk7CiAgICAgICAgICAgIGNvbnN0IGZpbGxNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgwMGZmMDAsIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIGRlcHRoVGVzdDogZmFsc2UgfSk7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsID0gbmV3IFRIUkVFLk1lc2goZmlsbEdlbywgZmlsbE1hdCk7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsLnBvc2l0aW9uLnNldCgtMC41OCwgMCwgMC4wMSk7CiAgICAgICAgICAgIGNvbnRhaW5lci5hZGQodGhpcy5ocEJhckZpbGwpOwoKICAgICAgICAgICAgdGhpcy5ocEJhciA9IGNvbnRhaW5lcjsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5ocEJhcik7CiAgICAgICAgfQoKX3VwZGF0ZUhQQmFyKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaHBCYXIgfHwgIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gVmlzaWJpbGl0eSBDaGVjazogT25seSBzaG93IGlmIG1lc2ggaXMgdmlzaWJsZSBBTkQgaW4gQWN0aXZlL1ByYWN0aWNlIHN0YXRlcwogICAgICAgICAgICBpZiAoIXRoaXMubWVzaC52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgYWxsb3dlZFN0YXRlID0gZ2FtZSAmJiAoZ2FtZS5zdGF0ZSA9PT0gJ2FjdGl2ZScgfHwgZ2FtZS5zdGF0ZSA9PT0gJ2tpY2tvZmYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghYWxsb3dlZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmhwQmFyLnBvc2l0aW9uLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5ocEJhci5wb3NpdGlvbi55ICs9IDIuMjsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgdGhpcy5ocEJhci5sb29rQXQod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYS5wb3NpdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHBjdCA9IE1hdGgubWF4KDAsIHRoaXMuc3RhdHMuSFAgLyB0aGlzLnN0YXRzLm1heEhQKTsKICAgICAgICAgICAgdGhpcy5ocEJhckZpbGwuc2NhbGUuc2V0WChwY3QpOwoKICAgICAgICAgICAgaWYgKHBjdCA+IDAuNSkgdGhpcy5ocEJhckZpbGwubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4MDBmZjAwKTsKICAgICAgICAgICAgZWxzZSBpZiAocGN0ID4gMC4yNSkgdGhpcy5ocEJhckZpbGwubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZmZjAwKTsKICAgICAgICAgICAgZWxzZSB0aGlzLmhwQmFyRmlsbC5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZjAwMDApOwoKICAgICAgICAgICAgLy8gSGlkZSBpZiBmdWxsIEhQIHRvIHJlZHVjZSBjbHV0dGVyLCB1bmxlc3MgaW4gcHJhY3RpY2UgbW9kZQogICAgICAgICAgICBjb25zdCBhbHdheXNTaG93ID0gZ2FtZSAmJiBnYW1lLmdhbWVNb2RlID09PSAncHJhY3RpY2UnOwogICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSAocGN0IDwgMC45OCB8fCBhbHdheXNTaG93KTsKICAgICAgICB9CgogICAgICAgIGdhaW5FeHAoYW1vdW50KSB7CiAgICAgICAgICAgIGlmICghd2luZG93LmZsdXguZ2FtZUluc3RhbmNlIHx8IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSAhPT0gJ2FjdGl2ZScpIHJldHVybjsKCiAgICAgICAgICAgIHRoaXMuZXhwICs9IGFtb3VudDsKCiAgICAgICAgICAgIGlmICh0aGlzLmV4cCA+PSB0aGlzLm5leHRMZXZlbEV4cCkgewogICAgICAgICAgICAgICAgdGhpcy5sZXZlbFVwKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGxldmVsVXAoKSB7CiAgICAgICAgICAgIHRoaXMubGV2ZWwrKzsKICAgICAgICAgICAgdGhpcy5leHAgLT0gdGhpcy5uZXh0TGV2ZWxFeHA7CiAgICAgICAgICAgIHRoaXMubmV4dExldmVsRXhwID0gTWF0aC5mbG9vcih0aGlzLm5leHRMZXZlbEV4cCAqIDEuNSk7CgogICAgICAgICAgICBjb25zdCBrZXlzID0gWydIUCcsICdFTicsICdBVCcsICdQQScsICdCTCcsICdTSCcsICdDQScsICdTUCddOwoKICAgICAgICAgICAgY29uc3QgaHBHYWluID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMjApICsgMTA7CiAgICAgICAgICAgIHRoaXMuc3RhdHMubWF4SFAgKz0gaHBHYWluOwogICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gdGhpcy5zdGF0cy5tYXhIUDsKCiAgICAgICAgICAgIGtleXMuZm9yRWFjaChrID0+IHsKICAgICAgICAgICAgICAgIGlmIChrID09PSAnSFAnKSByZXR1cm47CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdhaW4gPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAyKSArIDE7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0c1trXSArPSBnYWluOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSByZWFjaGVkIExldmVsICR7dGhpcy5sZXZlbH0hYCk7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCAmJiB0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkxFVkVMIFVQISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NoZWNrVGFja2xlQ29sbGlzaW9uKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSB8fCB0aGlzLl9oYXNIaXRUYWNrbGUpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CgogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBvbmVudFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwoKaWYgKGRpc3QgPCAzLjApIHsgLy8gSW5jcmVhc2VkIGZyb20gMi4wIGZvciBlYXNpZXIgaGl0cwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc29sdmVUYWNrbGVIaXQob3BwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oYXNIaXRUYWNrbGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCl9yZXNvbHZlVGFja2xlSGl0KG9wcCkgewogICAgICAgICAgICB0aGlzLnBsYXkoJ2lkbGUnLCAwLjIpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgndGFja2xlJyk7CiAgICAgICAgICAgIH0KCmNvbnN0IGF0ID0gdGhpcy5nZXRTdGF0KCdBVCcpOwogICAgICAgICAgICBsZXQgZGFtYWdlID0gYXQgKiAzLjA7CgogICAgICAgICAgICBpZiAodGhpcy50ZWNocy50YWNrbGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgIG9wcC5hcHBseVN0YXR1cygndmVub20nLCAxMC4wKTsKICAgICAgICAgICAgICAgIGRhbWFnZSArPSA1OwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudGVjaHMudGFja2xlID09PSAnd2l0aGVyJykgewogICAgICAgICAgICAgICAgb3BwLmFwcGx5U3RhdHVzKCd3aXRoZXInLCAxMC4wLCAnRU4nKTsKICAgICAgICAgICAgICAgIGRhbWFnZSArPSA1OwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudGVjaHMudGFja2xlID09PSAnZHJhaW4nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQICs9IDIwOwogICAgICAgICAgICAgICAgb3BwLnN0YXRzLkhQIC09IDIwOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiRFJBSU4iLCB0aGlzLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgb3BwLmN1cnJlbnRFTiAtPSBkYW1hZ2U7CgppZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIC8vIFJlbW92ZWQgIkVOIiBzdWZmaXggZm9yIGNsZWFuZXIgbG9vawogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oYCR7TWF0aC5mbG9vcihkYW1hZ2UpfWAsIG9wcC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkFNISIsIG9wcC5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9wcC5jdXJyZW50RU4gPD0gMCkgewogICAgICAgICAgICAgICAgICAgIG9wcC5mdW1ibGUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgb3BwLnN0dW5UaW1lciA9IDAuNTsKICAgICAgICAgICAgICAgICAgICBvcHAucGxheU9uZVNob3QoJ3JlYWN0JywgMC4xKTsKfQoKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnRhY2tsZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KHRoaXMsIHRoaXMudGVjaHMudGFja2xlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBvcHAuc3R1blRpbWVyID0gMS4wOwogICAgICAgICAgICAgICAgb3BwLnBsYXlPbmVTaG90KCdyZWFjdCcsIDAuMSk7CmlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU01BQ0shIiwgb3BwLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgcHVzaERpciA9IG9wcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIHB1c2hEaXIueSA9IDAuMjsKICAgICAgICAgICAgb3BwLnZlbG9jaXR5LmFkZChwdXNoRGlyLm11bHRpcGx5U2NhbGFyKDEyLjApKTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCkgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QoMC4xLCAnaGVhdnknKTsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjgpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNwYXduQ2xhc2gpIHsKY29uc3QgbWlkID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG9wcC5tZXNoLnBvc2l0aW9uKS5tdWx0aXBseVNjYWxhcigwLjUpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNwYXduQ2xhc2gobWlkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKLy8gQnViYmxlIEJ1cnN0IChUYWNrbGUgSGl0KQovLyBCdWJibGUgQnVyc3QgKFRhY2tsZSBIaXQpCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBtaWQgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5sZXJwKG9wcC5tZXNoLnBvc2l0aW9uLCAwLjUpOwogICAgICAgICAgICAgICAgbWlkLnkgKz0gMS4wOwogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzA7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ1YmJsZVBvcyA9IG1pZC5jbG9uZSgpLmFkZChuZXcgVEhSRUUuVmVjdG9yMygoTWF0aC5yYW5kb20oKS0wLjUpKjEuNSwgKE1hdGgucmFuZG9tKCktMC41KSoxLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMS41KSk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgYnViYmxlUG9zLCB7IHNjYWxlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMzUgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9hcHBseUdvYWxDcmVhc2UoZHQpIHsKCmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gWwogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbERpc3QpLAogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgLWdvYWxEaXN0KQogICAgICAgICAgICBdOwoKCiAgICAgICAgICAgIGNvbnN0IHJhZGl1cyA9IDEwLjA7CgogICAgICAgICAgICBnb2Fscy5mb3JFYWNoKGdvYWwgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZHggPSB0aGlzLm1lc2gucG9zaXRpb24ueCAtIGdvYWwueDsKICAgICAgICAgICAgICAgIGNvbnN0IGR6ID0gdGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsLno7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR6KmR6OwoKICAgICAgICAgICAgICAgIGlmIChkaXN0U3EgPCByYWRpdXMgKiByYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVzaFggPSBkaXN0ID4gMCA/IGR4IC8gZGlzdCA6IDE7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVzaFogPSBkaXN0ID4gMCA/IGR6IC8gZGlzdCA6IDA7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gNTAuMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gcHVzaFggKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiArPSBwdXNoWiAqIGZvcmNlICogZHQ7CgogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFkaXVzIC0gMC41KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNsYW1wUmF0aW8gPSByYWRpdXMgLyAoZGlzdCArIDAuMDAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnggPSBnb2FsLnggKyBkeCAqIGNsYW1wUmF0aW87CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi56ID0gZ29hbC56ICsgZHogKiBjbGFtcFJhdGlvOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LlBsYXllciA9IFBsYXllcjsKfSkoKTsK","/Player.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBCYWxsIExhYiAvIERldlRvb2xzOiB0aHJvdyAmIGN1cnZlIG1hcHBpbmcga25vYnMKICAgIC8vIChEZWZhdWx0cyBtYXRjaCBjdXJyZW50IGZlZWw7IERldlRvb2xzIGNhbiB0d2VhayBhdCBydW50aW1lLikKICAgIHdpbmRvdy5mbHV4LlRocm93Q29uZmlnID0gd2luZG93LmZsdXguVGhyb3dDb25maWcgfHwgewogICAgICAgIFNXSVBFX01JTl9QWDogMjAsCiAgICAgICAgQUlNX0RYX1NDQUxFOiAxLjAsCiAgICAgICAgQUlNX0RZX1NDQUxFOiAxLjAsCgogICAgICAgIFBPV0VSX0JBU0U6IDEuMCwKICAgICAgICBQT1dFUl9SQU5HRTogMC44LCAgICAgICAgICAvLyBCYXNlIG11bHRpcGxpZXIgPSBQT1dFUl9CQVNFICsgcmF0aW8qUE9XRVJfUkFOR0UKICAgICAgICBQT1dFUl9NQVhfQk9OVVNfUkFUSU86IDAuOTUsCiAgICAgICAgUE9XRVJfTUFYX01VTFRJUExJRVI6IDIuNSwKCiAgICAgICAgQ1VSVkVfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBDVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEOiAwLjI1LAogICAgICAgIENVUlZFX1NQSU5fU0NBTEU6IDEwMDAuMCwKICAgICAgICBDVVJWRV9TUEVFRF9NVUxUOiAxLjUsCiAgICAgICAgQ1VSVkVfU1BJTl9DQVA6IDE1MDAuMCwKICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDUwMC4wCiAgICB9OwoKLy8gUmV1c2FibGUgbWF0aCBvYmplY3RzCmNvbnN0IF9wVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9wVmVjMiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfcFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BRdWF0MiA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRhcmdldFF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpOwogICAgY29uc3QgX3BFdWxlciA9IG5ldyBUSFJFRS5FdWxlcigpOwogICAgY29uc3QgX3BBeGlzWSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApOwogICAgY29uc3QgX3BBeGlzWiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpOwogICAgY29uc3QgX3BJbnZRdWF0ID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgIGNvbnN0IF9wVG1wUXVhdCA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCk7CiAgICBjb25zdCBfcFRtcEV1bGVyID0gbmV3IFRIUkVFLkV1bGVyKCk7CgoKY2xhc3MgUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSA9ICdNRicpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLnJvbGUgPSByb2xlOwogICAgICAgICAgICB0aGlzLnRlYW0gPSBudWxsOyAvLyBBc3NpZ25lZCBieSBUZWFtLmFkZFBsYXllcgogICAgICAgICAgICB0aGlzLmhvbWVQb3NpdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLm1peGVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hY3Rpb25zID0ge307CiAgICAgICAgICAgIHRoaXMuYWN0aXZlQWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdpZGxlJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYW5pbUxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9sb2NrZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2xhc3RMb2NvbW90aW9uID0gJ2lkbGUnOwp0aGlzLmlucHV0VmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CgogICAgICAgICAgICAvLyBQaHlzaWNzIChEcmlmdC9JbmVydGlhIE1vZGVsKQogICAgICAgICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYWNjZWxlcmF0aW9uID0gMTIuMDsKICAgICAgICAgICAgdGhpcy5kcmFnID0gMy4wOwogICAgICAgICAgICB0aGlzLm1heFNwZWVkID0gOC4wOwogICAgICAgICAgICAvLyBCb25lIHJlZmVyZW5jZSBmb3IgaG9sZGluZyBiYWxsCiAgICAgICAgICAgIHRoaXMuaGFuZEJvbmUgPSBudWxsOwovLyBQcm9jZWR1cmFsIGFuaW1hdGlvbiBib25lIHJlZnMgKGZpbGxlZCBpbiBzZXRNZXNoKQp0aGlzLmJvbmVzID0gewogICAgaGlwczogbnVsbCwKICAgIHNwaW5lOiBudWxsLAogICAgY2hlc3Q6IG51bGwsCiAgICBuZWNrOiBudWxsLAogICAgaGVhZDogbnVsbCwKICAgIHJVcHBlckFybTogbnVsbCwKICAgIHJGb3JlQXJtOiBudWxsLAogICAgckhhbmQ6IG51bGwsCiAgICBsVXBwZXJBcm06IG51bGwsCiAgICBsRm9yZUFybTogbnVsbCwKICAgIGxIYW5kOiBudWxsCn07CnRoaXMuX2JvbmVCYXNlUXVhdHMgPSBudWxsOyAvLyBPcHRpb25hbCBmdXR1cmUgdXNlCnRoaXMuX3Byb2NBbmltVGltZSA9IDA7CnRoaXMuX3Ntb290aGVkU3BlZWQgPSAwOwp0aGlzLl9tb3ZpbmdMYXRjaCA9IGZhbHNlOwoKdGhpcy5jYW5DYXRjaCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2F0Y2hDb29sZG93biA9IDA7IC8vIFJlcGxhY2VzIHNldFRpbWVvdXQgZm9yIHNhZmV0eQoKICAgICAgICAgICAgLy8gQmxpdHpiYWxsIFN0YXRzCiAgICAgICAgICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLAogICAgICAgICAgICAgICAgbWF4SFA6IDEwMCwKICAgICAgICAgICAgICAgIEVOOiAzMCwKICAgICAgICAgICAgICAgIEFUOiAxMCwKICAgICAgICAgICAgICAgIFBBOiAxNSwKICAgICAgICAgICAgICAgIEJMOiAxMCwKICAgICAgICAgICAgICAgIFNIOiAxNSwKICAgICAgICAgICAgICAgIENBOiAxMCwKICAgICAgICAgICAgICAgIFNQOiA2MAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gTGV2ZWxpbmcgU3lzdGVtCiAgICAgICAgICAgIHRoaXMubGV2ZWwgPSAxOwogICAgICAgICAgICB0aGlzLmV4cCA9IDA7CiAgICAgICAgICAgIHRoaXMubmV4dExldmVsRXhwID0gMTAwOwoKICAgICAgICAgICAgLy8gU3RhdHVzIEVmZmVjdHMgJiBUZWNobmlxdWVzCiAgICAgICAgICAgIHRoaXMuc3RhdHVzID0gewogICAgICAgICAgICAgICAgdmVub206IDAsCiAgICAgICAgICAgICAgICBuYXA6IDAsCiAgICAgICAgICAgICAgICB3aXRoZXI6IHsgUEE6IDAsIFNIOiAwLCBBVDogMCwgQkw6IDAsIENBOiAwLCBTUDogMCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLm1hcmtpbmcgPSBudWxsOwogICAgICAgICAgICB0aGlzLmxlYXJuZWRUZWNocyA9IFtdOwoKICAgICAgICAgICAgdGhpcy50ZWNocyA9IHsKICAgICAgICAgICAgICAgIHRhY2tsZTogbnVsbCwKICAgICAgICAgICAgICAgIHNob290OiBudWxsLAogICAgICAgICAgICAgICAgcGFzczogbnVsbCwKICAgICAgICAgICAgICAgIHBhc3NpdmU6IG51bGwKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFZpc3VhbHMKICAgICAgICAgICAgdGhpcy5iYXNlQ29sb3JIZXggPSAweGZmZmZmZjsKICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscyA9IFtdOwogICAgICAgICAgICB0aGlzLmF1cmFNZXNoID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5yb3RhdGlvbk9mZnNldCA9IDA7CnRoaXMuYmFzZVNjYWxlID0gMS4xNzsgLy8gSW5jcmVhc2VkIH44JQoKICAgICAgICAgICAgLy8gUmVhbC10aW1lIFN0YXRzCiAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gdGhpcy5zdGF0cy5FTjsKdGhpcy50YWNrbGVSYWRpdXMgPSAyLjA7IC8vIFJlZHVjZWQgZnJvbSAyLjUgdG8gcmVkdWNlIHN3YXJtIGxvY2sKCiAgICAgICAgICAgIHRoaXMuc3BlZWQgPSA0LjA7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gRGFzaCBTdGF0ZQogICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gMDsKICAgICAgICAgICAgdGhpcy5kYXNoVG90YWxUaW1lID0gMC41Owp0aGlzLmRhc2hDb29sZG93biA9IDA7CiAgICAgICAgICAgIHRoaXMuZGFzaFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBGZWVkYmFjayBBY2N1bXVsYXRvcnMKICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWREYW1hZ2UgPSAwOwogICAgICAgICAgICB0aGlzLl9kYW1hZ2VUaW1lciA9IDA7CgogICAgICAgICAgICAvLyBIUCBCYXIKICAgICAgICAgICAgdGhpcy5ocEJhciA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsID0gbnVsbDsKCiAgICAgICAgICAgIC8vIEdhbWVwbGF5IEZsb3cgVGltZXJzCiAgICAgICAgICAgIHRoaXMuc3R1blRpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMDsKCiAgICAgICAgICAgIC8vIEJhbmtpbmcgJiBWZXJ0aWNhbGl0eQogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLnRhcmdldFkgPSAwOwoKICAgICAgICAgICAgLy8gRW5jb3VudGVyIFN5c3RlbQogICAgICAgICAgICB0aGlzLmlzRW5nYWdlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNsYXNoVGltZXIgPSAwOwoKICAgICAgICAgICAgdGhpcy5lbmNvdW50ZXJUaW1lciA9IDA7IC8vIFRyYWNrIGR1cmF0aW9uIG9mIGN1cnJlbnQgZW5nYWdlbWVudAogICAgICAgICAgICAvLyBDaGFyZ2UgTWVjaGFuaWMKICAgICAgICAgICAgdGhpcy5pc0NoYXJnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4Q2hhcmdlVGltZSA9IDEuNTsKCiAgICAgICAgICAgIC8vIEZJWEVEOiBJbXByb3ZlZCBSb3RhdGlvbiBTdGF0ZSB3aXRoIGh5c3RlcmVzaXMKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ID0gMDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLmxhc3RWYWxpZFlhdyA9IDA7IC8vIFN0b3JlIGxhc3Qga25vd24gZ29vZCB5YXcgZm9yIGRlYWR6b25lIGhhbmRsaW5nCiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLmZhY2luZ0RlYWR6b25lID0gMC4zOyAvLyBNaW5pbXVtIGlucHV0L3ZlbG9jaXR5IG1hZ25pdHVkZSB0byB1cGRhdGUgZmFjaW5nCgogICAgICAgICAgICAvLyBQYXJ0aWNsZSBFbWlzc2lvbiBUaW1lcnMKICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMgPSB7CiAgICAgICAgICAgICAgICB2ZW5vbTogMCwKICAgICAgICAgICAgICAgIG5hcDogMCwKICAgICAgICAgICAgICAgIHdpdGhlcjogMAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gRGV2VG9vbHMgRmxhZ3MKICAgICAgICAgICAgdGhpcy5pc0dvZE1vZGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBhc3MgVGFyZ2V0IEluZGljYXRvcgovLyBQYXNzIFRhcmdldCBJbmRpY2F0b3IKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yID0gbnVsbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJ1YmJsZSBUcmFpbCBUaW1lcgogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDA7Cgp0aGlzLl9kYXNoUGFydGljbGVUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSAwOyAvLyBDb250aW51b3VzIHByZXNzdXJlIGZhY3RvciAoMC4wIHRvIDEuMCkKICAgICAgICB9CgogICAgICAgIHN5bmNSb3RhdGlvbigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgZXVsZXIgPSBuZXcgVEhSRUUuRXVsZXIoKS5zZXRGcm9tUXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbiwgJ1lYWicpOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRZYXcgPSBldWxlci55IC0gdGhpcy5yb3RhdGlvbk9mZnNldDsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgIHRoaXMubGFzdFZhbGlkWWF3ID0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgPSAwOwogICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ID0gMDsKICAgICAgICB9CgogICAgICAgIGdldFN0YXQobmFtZSkgewogICAgICAgICAgICBsZXQgdmFsID0gdGhpcy5zdGF0c1tuYW1lXTsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltuYW1lXSA+IDApIHsKICAgICAgICAgICAgICAgIHZhbCAqPSAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICB9CgogICAgICAgIGFwcGx5U3RhdHVzKHR5cGUsIGR1cmF0aW9uLCBzdWJUeXBlID0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3Zlbm9tJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMudmVub20gPiAxLjA7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy52ZW5vbSA9IE1hdGgubWF4KHRoaXMuc3RhdHVzLnZlbm9tLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnJvbGV9IHBvaXNvbmVkIWApOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQT0lTT04iLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gdGhpcy5zdGF0dXMubmFwID4gMS4wOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gTWF0aC5tYXgodGhpcy5zdGF0dXMubmFwLCBkdXJhdGlvbik7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB0aGlzLmZ1bWJsZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gZmVsbCBhc2xlZXAhYCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNMRUVQIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3dpdGhlcicgJiYgc3ViVHlwZSkgewogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFZhbCA9IHRoaXMuc3RhdHVzLndpdGhlcltzdWJUeXBlXSB8fCAwOwogICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gY3VycmVudFZhbCA+IDEuMDsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLndpdGhlcltzdWJUeXBlXSA9IE1hdGgubWF4KGN1cnJlbnRWYWwsIGR1cmF0aW9uKTsKCiAgICAgICAgICAgICAgICBpZiAoIXdhc0FjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gd2l0aGVyZWQgJHtzdWJUeXBlfSFgKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bihgV0lUSEVSICR7c3ViVHlwZX1gLCB0aGlzLm1lc2gucG9zaXRpb24sICJzdGF0dXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZURlcml2ZWRTdGF0cygpIHsKICAgICAgICAgICAgY29uc3Qgc3AgPSB0aGlzLmdldFN0YXQoJ1NQJyk7CiAgICAgICAgICAgIHRoaXMubWF4U3BlZWQgPSA1LjAgKyAoc3AgLyAxNS4wKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gPSB0aGlzLmdldFN0YXQoJ0VOJyk7CiAgICAgICAgfQoKc2V0TWVzaChzb3VyY2VNZXNoLCBhbmltYXRpb25zKSB7CiAgICAgICAgICAgIHRoaXMubWVzaCA9IHNvdXJjZU1lc2g7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUhQQmFyKCk7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUF1cmEoKTsKICAgICAgICAgICAgdGhpcy5fY3JlYXRlUGFzc1RhcmdldEluZGljYXRvcigpOwoKICAgICAgICAgICAgLy8gQ3VzdG9tIENoYXJhY3RlciBTY2FsaW5nCiAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3Rlck5hbWUuaW5jbHVkZXMoJ1RpZHVzJykpIHRoaXMuYmFzZVNjYWxlID0gMS42OwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB0aGlzLmJhc2VTY2FsZSA9IDEuNDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXNoLnNjYWxlLnNldFNjYWxhcih0aGlzLmJhc2VTY2FsZSk7CgogICAgICAgICAgICB0aGlzLm1lc2gudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzTWVzaCAmJiBub2RlLm1hdGVyaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udmVydE9uZSA9IChtYXQpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXA6IG1hdC5tYXAgfHwgbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBuZXcgVEhSRUUuQ29sb3IoMHhmZmZmZmYpLCAvLyBGT1JDRSBXSElURTogSWdub3JlIHNvdXJjZSBjb2xvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6ICEhbWF0LnRyYW5zcGFyZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogKG1hdC5vcGFjaXR5ICE9PSB1bmRlZmluZWQgPyBtYXQub3BhY2l0eSA6IDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxwaGFUZXN0OiAobWF0LmFscGhhVGVzdCAhPT0gdW5kZWZpbmVkID8gbWF0LmFscGhhVGVzdCA6IDApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2lkZTogbWF0LnNpZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aFRlc3Q6IG1hdC5kZXB0aFRlc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBtYXQuZGVwdGhXcml0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNraW5uaW5nOiAhIW5vZGUuaXNTa2lubmVkTWVzaAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5wdXNoKHsgbWF0ZXJpYWw6IG0sIGJhc2VDb2xvcjogbS5jb2xvci5jbG9uZSgpIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIG5vZGUubWF0ZXJpYWwgPSBBcnJheS5pc0FycmF5KG5vZGUubWF0ZXJpYWwpCiAgICAgICAgICAgICAgICAgICAgICAgID8gbm9kZS5tYXRlcmlhbC5tYXAoY29udmVydE9uZSkKICAgICAgICAgICAgICAgICAgICAgICAgOiBjb252ZXJ0T25lKG5vZGUubWF0ZXJpYWwpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChub2RlLmlzQm9uZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSAobm9kZS5uYW1lIHx8ICcnKS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBDb3JlIHNwaW5lL2hlYWQgY2hhaW4gKE1peGFtby1mcmllbmRseSkKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuaGlwcyAmJiBuYW1lLmluY2x1ZGVzKCdoaXBzJykpIHRoaXMuYm9uZXMuaGlwcyA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLnNwaW5lICYmIG5hbWUuaW5jbHVkZXMoJ3NwaW5lJykgJiYgIW5hbWUuaW5jbHVkZXMoJ3NwaW5lMicpICYmICFuYW1lLmluY2x1ZGVzKCdzcGluZV8yJykpIHRoaXMuYm9uZXMuc3BpbmUgPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5jaGVzdCAmJiAobmFtZS5pbmNsdWRlcygnY2hlc3QnKSB8fCBuYW1lLmluY2x1ZGVzKCdzcGluZTInKSB8fCBuYW1lLmluY2x1ZGVzKCdzcGluZV8yJykpKSB0aGlzLmJvbmVzLmNoZXN0ID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubmVjayAmJiBuYW1lLmluY2x1ZGVzKCduZWNrJykpIHRoaXMuYm9uZXMubmVjayA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmhlYWQgJiYgbmFtZS5pbmNsdWRlcygnaGVhZCcpKSB0aGlzLmJvbmVzLmhlYWQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1JpZ2h0ID0gbmFtZS5pbmNsdWRlcygncmlnaHQnKSB8fCBuYW1lLmVuZHNXaXRoKCdyJykgfHwgbmFtZS5pbmNsdWRlcygnX3InKSB8fCBuYW1lLmluY2x1ZGVzKCcucicpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzTGVmdCAgPSBuYW1lLmluY2x1ZGVzKCdsZWZ0JykgIHx8IG5hbWUuZW5kc1dpdGgoJ2wnKSB8fCBuYW1lLmluY2x1ZGVzKCdfbCcpIHx8IG5hbWUuaW5jbHVkZXMoJy5sJyk7CgogICAgICAgICAgICAgICAgICAgIC8vIEFybXMvaGFuZHMgKE1peGFtbzogbWl4YW1vcmlnUmlnaHRBcm0vUmlnaHRGb3JlQXJtL1JpZ2h0SGFuZCkKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMuclVwcGVyQXJtICYmIChuYW1lLmluY2x1ZGVzKCdyaWdodGFybScpIHx8IChpc1JpZ2h0ICYmIG5hbWUuaW5jbHVkZXMoJ3VwcGVyYXJtJykpKSkgdGhpcy5ib25lcy5yVXBwZXJBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5yRm9yZUFybSAmJiAobmFtZS5pbmNsdWRlcygncmlnaHRmb3JlYXJtJykgfHwgKGlzUmlnaHQgJiYgbmFtZS5pbmNsdWRlcygnZm9yZWFybScpKSkpIHRoaXMuYm9uZXMuckZvcmVBcm0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib25lcy5ySGFuZCAmJiAoKG5hbWUuaW5jbHVkZXMoJ2hhbmQnKSAmJiBpc1JpZ2h0KSB8fCBuYW1lLmluY2x1ZGVzKCdyaWdodGhhbmQnKSkpIHRoaXMuYm9uZXMuckhhbmQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubFVwcGVyQXJtICYmIChuYW1lLmluY2x1ZGVzKCdsZWZ0YXJtJykgfHwgKGlzTGVmdCAmJiBuYW1lLmluY2x1ZGVzKCd1cHBlcmFybScpKSkpIHRoaXMuYm9uZXMubFVwcGVyQXJtID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYm9uZXMubEZvcmVBcm0gJiYgKG5hbWUuaW5jbHVkZXMoJ2xlZnRmb3JlYXJtJykgfHwgKGlzTGVmdCAmJiBuYW1lLmluY2x1ZGVzKCdmb3JlYXJtJykpKSkgdGhpcy5ib25lcy5sRm9yZUFybSA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvbmVzLmxIYW5kICYmICgobmFtZS5pbmNsdWRlcygnaGFuZCcpICYmIGlzTGVmdCkgfHwgbmFtZS5pbmNsdWRlcygnbGVmdGhhbmQnKSkpIHRoaXMuYm9uZXMubEhhbmQgPSBub2RlOwoKICAgICAgICAgICAgICAgICAgICAvLyBCYWNrLWNvbXBhdDogYmFsbCBhdHRhY2htZW50IHVzZXMgaGFuZEJvbmUKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaGFuZEJvbmUgJiYgdGhpcy5ib25lcy5ySGFuZCkgdGhpcy5oYW5kQm9uZSA9IHRoaXMuYm9uZXMuckhhbmQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5taXhlciA9IG5ldyBUSFJFRS5BbmltYXRpb25NaXhlcih0aGlzLm1lc2gpOwoKICAgICAgICAgICAgaWYgKGFuaW1hdGlvbnMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IF9ub3JtQ2xpcE5hbWUgPSAocykgPT4gKHMgfHwgJycpCiAgICAgICAgICAgICAgICAgICAgLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvW19cLV0rL2csICcgJykKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXHMrL2csICcgJykKICAgICAgICAgICAgICAgICAgICAudHJpbSgpOwoKICAgICAgICAgICAgICAgIC8vIEhlbHBlciB0byBzdHJpcCBsZWcgdHJhY2tzIGZyb20gYWN0aW9uIGNsaXBzCiAgICAgICAgICAgICAgICBjb25zdCBfc3RyaXBMZWdzID0gKGNsaXApID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFja3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICBjbGlwLnRyYWNrcy5mb3JFYWNoKHQgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZWdleCB0byBtYXRjaCBsZWcgYm9uZXMgKE1peGFtbyBzdHlsZTogUmlnaHRVcExlZywgUmlnaHRMZWcsIFJpZ2h0Rm9vdCwgUmlnaHRUb2VCYXNlKQogICAgICAgICAgICAgICAgICAgICAgICAvLyBBbHNvIGdlbmVyaWMgIkxlZyIsICJGb290IgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXQubmFtZS5tYXRjaCgvKFVwTGVnfExlZ3xGb290fFRvZSkvaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYWNrcy5wdXNoKHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgY2xpcC50cmFja3MgPSB0cmFja3M7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNsaXA7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGFuaW1hdGlvbnMuZm9yRWFjaCgoY2xpcCkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBfbm9ybUNsaXBOYW1lKGNsaXAubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzID0gKHJlKSA9PiByZS50ZXN0KG5hbWUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxldCBpc0xvY29tb3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBsZXQgYWN0aW9uS2V5ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIENvcmUgbG9jb21vdGlvbiAtLS0KICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC90cmVhZHx0cmVhZGluZ3xpZGxlfGZsb2F0LykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2lkbGUnOwogICAgICAgICAgICAgICAgICAgICAgICBpc0xvY29tb3Rpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9kYXNofHNwcmludHxidXJzdHxmYXN0XHMqc3dpbXxzd2ltXHMqZmFzdC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdkYXNoJzsKICAgICAgICAgICAgICAgICAgICAgICAgaXNMb2NvbW90aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvc3dpbXxmcmVlc3R5bGV8Y3Jhd2wvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAnc3dpbSc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzTG9jb21vdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gLS0tIFRocm93aW5nIChwYXNzL3Nob3QgdmFyaWFudHMgaWYgcHJlc2VudCkgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3Rocm93fHRvc3N8cGl0Y2gvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC9zaG9vdHxzaG90fGdvYWwvKSkgYWN0aW9uS2V5ID0gJ3Rocm93X3Nob3QnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChoYXMoL3Bhc3MvKSkgYWN0aW9uS2V5ID0gJ3Rocm93X3Bhc3MnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFjdGlvbktleSA9ICd0aHJvdyc7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBDYXRjaGluZyAoanVtcC9haXIgdmFyaWFudHMgaWYgcHJlc2VudCkgLS0tCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2NhdGNofHJlY2VpdmV8Z3JhYnxpbnRlcmNlcHQvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKC9qdW1wfGxlYXB8YWlyfGRpdmUvKSkgYWN0aW9uS2V5ID0gJ2NhdGNoX2p1bXAnOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFjdGlvbktleSA9ICdjYXRjaCc7CgogICAgICAgICAgICAgICAgICAgIC8vIC0tLSBIaXQgLyBSZWFjdCAtLS0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvcmVhY3R8aGl0fGh1cnR8ZGFtYWdlfHN0YWdnZXJ8a25vY2svKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAncmVhY3QnOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gT3B0aW9uYWwgc3RhdGVzIC0tLQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzKC9jaGFyZ2V8YWltfHJlYWR5fHdpbmR1cHxob2xkLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2NoYXJnZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL3RhY2tsZXxjaGVja3xyYW0vKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25LZXkgPSAndGFja2xlJzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhcygvYmxvY2t8c2F2ZS8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbktleSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXMoL2NlbGVicmF0ZXx2aWN0b3J5fGNoZWVyLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gJ2NlbGVicmF0ZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uS2V5ID0gY2xpcC5uYW1lOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gU3RyaXAgbGVncyBmcm9tIG5vbi1sb2NvbW90aW9uIGNsaXBzIHRvIGFsbG93IHRyZWFkaW5nIHdhdGVyIG92ZXJsYXkKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTG9jb21vdGlvbiAmJiBhY3Rpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3N0cmlwTGVncyhjbGlwKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChhY3Rpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3Rpb25zW2FjdGlvbktleV0gPSB0aGlzLm1peGVyLmNsaXBBY3Rpb24oY2xpcCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFN0YXJ0IGRlZmF1bHQgbG9jb21vdGlvbgogICAgICAgICAgICBpZiAodGhpcy5hY3Rpb25zWydpZGxlJ10pIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24oJ2lkbGUnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrCiAgICAgICAgICAgICAgICBjb25zdCBmaXJzdCA9IE9iamVjdC52YWx1ZXModGhpcy5hY3Rpb25zKVswXTsKICAgICAgICAgICAgICAgIGlmKGZpcnN0KSBmaXJzdC5wbGF5KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9uZS1zaG90IGFuaW1hdGlvbiBsaXN0ZW5lcgogICAgICAgICAgICBpZiAodGhpcy5taXhlcikgewogICAgICAgICAgICAgICAgdGhpcy5taXhlci5hZGRFdmVudExpc3RlbmVyKCdmaW5pc2hlZCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9hbmltTG9ja2VkKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLmFjdGlvbikgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBmaW5pc2hlZCBhY3Rpb24gaXMgb3VyIGN1cnJlbnQgb25lLXNob3QKICAgICAgICAgICAgICAgICAgICBpZiAoZS5hY3Rpb24gPT09IHRoaXMuYWN0aXZlT25lU2hvdCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hbmltTG9ja2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvY2tlZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVPbmVTaG90ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJldHVybiB0byBsb2NvbW90aW9uIHVwZGF0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMTUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE5ldyBtZXRob2QgZm9yIGJhc2UgbGF5ZXIgKGxlZ3MvYm9keSBtb3ZlbWVudCkKICAgICAgICBwbGF5TG9jb21vdGlvbihhY3Rpb25OYW1lLCBkdXJhdGlvbiA9IDAuNSkgewogICAgICAgICAgICBjb25zdCBuZXdBY3Rpb24gPSB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgICAgICAgIGlmICghbmV3QWN0aW9uIHx8IG5ld0FjdGlvbiA9PT0gdGhpcy5hY3RpdmVMb2NvbW90aW9uKSByZXR1cm47CgogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVMb2NvbW90aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUxvY29tb3Rpb24uZmFkZU91dChkdXJhdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5ld0FjdGlvbi5yZXNldCgpOwogICAgICAgICAgICBuZXdBY3Rpb24uZmFkZUluKGR1cmF0aW9uKTsKICAgICAgICAgICAgbmV3QWN0aW9uLnBsYXkoKTsKICAgICAgICAgICAgdGhpcy5hY3RpdmVMb2NvbW90aW9uID0gbmV3QWN0aW9uOwogICAgICAgICAgICB0aGlzLl9sYXN0TG9jb21vdGlvbiA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICAvLyBPdmVyaGF1bGVkIHBsYXkgbWV0aG9kIHRvIGhhbmRsZSBsYXllcmluZwogICAgICAgIHBsYXkoYWN0aW9uTmFtZSwgZHVyYXRpb24gPSAwLjUpIHsKICAgICAgICAgICAgLy8gSWYgaXQncyBhIGxvY29tb3Rpb24gc3RhdGUsIHJvdXRlIHRvIHBsYXlMb2NvbW90aW9uCiAgICAgICAgICAgIGlmIChbJ2lkbGUnLCAnc3dpbScsICdkYXNoJ10uaW5jbHVkZXMoYWN0aW9uTmFtZSkpIHsKICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24oYWN0aW9uTmFtZSwgZHVyYXRpb24pOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPdGhlcndpc2UgdHJlYXQgYXMgYW4gYWN0aW9uIGxheWVyCiAgICAgICAgICAgIGNvbnN0IG5ld0FjdGlvbiA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFuZXdBY3Rpb24pIHJldHVybjsKCiAgICAgICAgICAgIC8vIElmIHdlIGhhdmUgYW4gYWN0aXZlIG9uZS1zaG90LCBmYWRlIGl0IG91dAogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVPbmVTaG90ICYmIHRoaXMuYWN0aXZlT25lU2hvdCAhPT0gbmV3QWN0aW9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZU9uZVNob3QuZmFkZU91dCgwLjEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXdBY3Rpb24ucmVzZXQoKTsKICAgICAgICAgICAgbmV3QWN0aW9uLmZhZGVJbigwLjEpOyAvLyBGYXN0IHRyYW5zaXRpb24gZm9yIGFjdGlvbnMKICAgICAgICAgICAgbmV3QWN0aW9uLnBsYXkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYWN0aXZlT25lU2hvdCA9IG5ld0FjdGlvbjsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGFjdGlvbk5hbWU7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlTG9jb21vdGlvbkFuaW0oZHVyYXRpb24gPSAwLjIpIHsKICAgICAgICAgICAgLy8gTm90ZTogV2UgTk8gTE9OR0VSIGNoZWNrIF9hbmltTG9ja2VkIGhlcmUuCiAgICAgICAgICAgIC8vIExvY29tb3Rpb24gc2hvdWxkIHVwZGF0ZSBjb250aW51b3VzbHkgYmFzZWQgb24gc3BlZWQsIAogICAgICAgICAgICAvLyBydW5uaW5nIHVuZGVybmVhdGggdGhlIHVwcGVyIGJvZHkgYWN0aW9uLgogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgdnggPSB0aGlzLnZlbG9jaXR5ID8gdGhpcy52ZWxvY2l0eS54IDogMDsKICAgICAgICAgICAgY29uc3QgdnogPSB0aGlzLnZlbG9jaXR5ID8gdGhpcy52ZWxvY2l0eS56IDogMDsKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSBNYXRoLnNxcnQodnggKiB2eCArIHZ6ICogdnopOwoKICAgICAgICAgICAgLy8gU21vb3RoIHNwZWVkCiAgICAgICAgICAgIGNvbnN0IHNtb290aEsgPSAxLjAgLSBNYXRoLnBvdygwLjAwMSwgZHVyYXRpb24pOwogICAgICAgICAgICB0aGlzLl9zbW9vdGhlZFNwZWVkICs9IChzcGVlZCAtIHRoaXMuX3Ntb290aGVkU3BlZWQpICogc21vb3RoSzsKCiAgICAgICAgICAgIGNvbnN0IHNwZWVkTm9ybSA9ICh0aGlzLm1heFNwZWVkID4gMC4wMDAxKSA/IFRIUkVFLk1hdGhVdGlscy5jbGFtcCh0aGlzLl9zbW9vdGhlZFNwZWVkIC8gdGhpcy5tYXhTcGVlZCwgMCwgMSkgOiAwOwoKICAgICAgICAgICAgLy8gSHlzdGVyZXNpcwogICAgICAgICAgICBjb25zdCBlbnRlck1vdmUgPSAwLjE4OwogICAgICAgICAgICBjb25zdCBleGl0TW92ZSA9IDAuMTA7CgogICAgICAgICAgICBjb25zdCBpbnB1dE1vdmluZyA9IHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wNjsKICAgICAgICAgICAgY29uc3QgdmVsTW92aW5nID0gdGhpcy5fc21vb3RoZWRTcGVlZCA+ICh0aGlzLl9tb3ZpbmdMYXRjaCA/IGV4aXRNb3ZlIDogZW50ZXJNb3ZlKTsKCiAgICAgICAgICAgIHRoaXMuX21vdmluZ0xhdGNoID0gaW5wdXRNb3ZpbmcgfHwgdmVsTW92aW5nOwoKICAgICAgICAgICAgbGV0IHRhcmdldCA9IHRoaXMuX21vdmluZ0xhdGNoID8gJ3N3aW0nIDogJ2lkbGUnOwogICAgICAgICAgICBpZiAodGhpcy5fbW92aW5nTGF0Y2ggJiYgdGhpcy5pc0Rhc2hpbmcgJiYgdGhpcy5hY3Rpb25zWydkYXNoJ10pIHRhcmdldCA9ICdkYXNoJzsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBwbGF5YmFjayByYXRlCiAgICAgICAgICAgIGNvbnN0IGFwcGx5UmF0ZSA9IChrZXkpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGlvbnNba2V5XTsKICAgICAgICAgICAgICAgIGlmICghYSkgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gJ3N3aW0nKSBhLnRpbWVTY2FsZSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDAuODUsIDEuNzAsIHNwZWVkTm9ybSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChrZXkgPT09ICdkYXNoJykgYS50aW1lU2NhbGUgPSBUSFJFRS5NYXRoVXRpbHMubGVycCgxLjEwLCAyLjIwLCBzcGVlZE5vcm0pOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoa2V5ID09PSAnaWRsZScpIGEudGltZVNjYWxlID0gVEhSRUUuTWF0aFV0aWxzLmxlcnAoMC45NSwgMS4wNSwgc3BlZWROb3JtKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGFwcGx5UmF0ZSh0YXJnZXQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuX2xhc3RMb2NvbW90aW9uICE9PSB0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGlvbnNbdGFyZ2V0XTsKICAgICAgICAgICAgICAgIGlmIChhKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsgYS5zZXRMb29wKFRIUkVFLkxvb3BSZXBlYXQpOyB9IGNhdGNoIChfKSB7fQogICAgICAgICAgICAgICAgICAgIGEuY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucGxheUxvY29tb3Rpb24odGFyZ2V0LCBkdXJhdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBsYXlPbmVTaG90KGFjdGlvbk5hbWUsIGR1cmF0aW9uID0gMC4xLCBvcHRzID0ge30pIHsKICAgICAgICAgICAgY29uc3QgYSA9IHRoaXMuYWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgICAgICAgaWYgKCFhKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICB0aGlzLl9hbmltTG9ja2VkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5fbG9ja2VkU3RhdGUgPSBhY3Rpb25OYW1lOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGEucmVzZXQoKTsKICAgICAgICAgICAgICAgIGEuc2V0TG9vcChUSFJFRS5Mb29wT25jZSk7CiAgICAgICAgICAgICAgICBhLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGEudGltZVNjYWxlID0gKG9wdHMudGltZVNjYWxlICE9PSB1bmRlZmluZWQgPyBvcHRzLnRpbWVTY2FsZSA6IDEuMCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKF8pIHt9CgogICAgICAgICAgICAvLyBVc2UgdGhlIG5ldyBwbGF5IG1ldGhvZCB3aGljaCBoYW5kbGVzIGxheWVyaW5nCiAgICAgICAgICAgIHRoaXMucGxheShhY3Rpb25OYW1lLCBkdXJhdGlvbik7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBzZXRJbnB1dCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlucHV0VmVjdG9yLnNldCh4LCAwLCB6KTsKICAgICAgICB9CgpyZWNlaXZlQmFsbCgpIHsKICAgICAgICAgICAgdGhpcy5jYW5DYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ1JJVElDQUwgRklYOiBSZXNldCBzdGF0ZXMgdGhhdCBtaWdodCBwcmV2ZW50IHNob290aW5nCiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5pbW11bml0eVRpbWVyID0gMi4wOwoKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLmxhc3RIb2xkZXIgJiYgYmFsbC5sYXN0SG9sZGVyLnRlYW0gPT09IHRoaXMudGVhbSAmJiBiYWxsLmxhc3RIb2xkZXIgIT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGJhbGwubGFzdEhvbGRlci5nYWluRXhwKDIpOwogICAgICAgICAgICAgICAgdGhpcy5nYWluRXhwKDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBiYWxsWSA9ICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLm1lc2gpID8gdGhpcy5iYWxsUmVmLm1lc2gucG9zaXRpb24ueSA6IDA7CiAgICAgICAgICAgIGNvbnN0IGNhdGNoS2V5ID0gKGJhbGxZID4gMC4yNSAmJiB0aGlzLmFjdGlvbnNbJ2NhdGNoX2p1bXAnXSkgPyAnY2F0Y2hfanVtcCcgOiAnY2F0Y2gnOwoKICAgICAgICAgICAgdGhpcy5wbGF5T25lU2hvdChjYXRjaEtleSwgMC4xKTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2NhdGNoJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTTkFQISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWFjdGlvbiIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdGhyb3dCYWxsKGJhbGwsIGZvcmNlZFR5cGUgPSBudWxsLCBwb3dlck11bHRpcGxpZXIgPSAxLjAsIGZvcmNlZFNwaW4gPSBudWxsKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZykgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMubmFwID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gdHJ1ZTsKCiAgICAgICAgICAgIC8vIExvY2sgYWltIGRpcmVjdGlvbiBhdCBzdGFydCBvZiB0aHJvdwogICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3RvciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICBpZiAodGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4xKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvY2tlZEFpbVZlY3Rvci5jb3B5KHRoaXMuaW5wdXRWZWN0b3IpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5sb2NrZWRBaW1WZWN0b3Iuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtZ29hbERpc3QgOiBnb2FsRGlzdDsKICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwoKICAgICAgICAgICAgbGV0IHR5cGUgPSBmb3JjZWRUeXBlOwogICAgICAgICAgICBpZiAoIXR5cGUpIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAoZGlzdFRvR29hbCA8IDI1KSA/ICdTSCcgOiAnUEEnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBpc0ZpbmlzaGVyID0gKHR5cGUgPT09ICdTSCcgJiYgZGlzdFRvR29hbCA8IDEyLjApOwoKICAgICAgICAgICAgbGV0IHRlY2hOYW1lID0gKHR5cGUgPT09ICdTSCcpID8gdGhpcy50ZWNocy5zaG9vdCA6IHRoaXMudGVjaHMucGFzczsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy52ZW5vbSA+IDAgJiYgdGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIlNJTEVOQ0VEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAic3RhdHVzIik7CiAgICAgICAgICAgICAgICB0ZWNoTmFtZSA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCB3aW5kdXBUaW1lID0gMTAwOwogICAgICAgICAgICBsZXQgYW5pbVNwZWVkID0gMS41OwoKICAgICAgICAgICAgaWYgKHBvd2VyTXVsdGlwbGllciA+IDEuMSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSArPSAyMDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc0ZpbmlzaGVyICYmICF0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZHVwVGltZSA9IDUwOwogICAgICAgICAgICAgICAgYW5pbVNwZWVkID0gMy4wOwogICAgICAgICAgICB9CgppZiAodGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIHdpbmR1cFRpbWUgPSA0MDA7CiAgICAgICAgICAgICAgICBhbmltU3BlZWQgPSAwLjg7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIucGxheUNpbmVtYXRpYyh0ZWNoTmFtZSwgdGhpcy5tZXNoLCAxLjIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuaW1tdW5pdHlUaW1lciA9IDEuNTsKCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJykudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGxhYmVsLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTkVXOiBTcGF3biBUZWNoIEdseXBoIChWZXJ0aWNhbCBDYXN0aW5nIENpcmNsZSkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmdseXBoTWFuYWdlci5zcGF3bigndGVjaCcsIHRoaXMubWVzaC5wb3NpdGlvbiwgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDEuMiwKICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogNC4wLAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAxLjUsCiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFk6IDEuMiwKICAgICAgICAgICAgICAgICAgICAgICAgZmFjZUNhbWVyYTogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQaWNrIGJlc3QgdGhyb3cgY2xpcCAocGFzcy9zaG90IHZhcmlhbnRzIGlmIHByZXNlbnQpCiAgICAgICAgICAgIGNvbnN0IHRocm93S2V5ID0KICAgICAgICAgICAgICAgICh0eXBlID09PSAnU0gnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfc2hvdCddKSA/ICd0aHJvd19zaG90JyA6CiAgICAgICAgICAgICAgICAodHlwZSA9PT0gJ1BBJyAmJiB0aGlzLmFjdGlvbnNbJ3Rocm93X3Bhc3MnXSkgPyAndGhyb3dfcGFzcycgOgogICAgICAgICAgICAgICAgJ3Rocm93JzsKCnRoaXMucGxheU9uZVNob3QodGhyb3dLZXksIDAuMSwgeyB0aW1lU2NhbGU6IGFuaW1TcGVlZCB9KTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3Rocm93Jyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0ICYmICF0ZWNoTmFtZSkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiV0hPT1NIIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtYWN0aW9uIik7CiAgICAgICAgICAgIH0KCnNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgLy8gU2FmZXR5OiBJZiBiYWxsIGhvbGRlciBpcyBzdGlsbCB1cywgcHJvY2VlZC4gSWYgaGFzQmFsbCBpcyBmYWxzZSBidXQgaG9sZGVyIGlzIHVzLCBhc3N1bWUgc3luYyBsYWcgYW5kIHByb2NlZWQuCiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsIHx8IChiYWxsICYmIGJhbGwuaG9sZGVyID09PSB0aGlzKSkgewpjb25zdCB0aHJvd0FjdGlvbiA9IHRoaXMuYWN0aW9uc1t0aHJvd0tleV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHRocm93QWN0aW9uKSB0aHJvd0FjdGlvbi50aW1lU2NhbGUgPSAxLjA7CgogICAgICAgICAgICAgICAgICAgIGxldCBmaW5hbERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICAgICAgbGV0IHJlZmVyZW5jZURpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgppZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5jb3B5KHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2VEaXIuY29weShmaW5hbERpcik7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBSRU1PVkVEOiBJbnN0YW50IHJvdGF0aW9uIHNuYXAuIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGUgdXBkYXRlIGxvb3AgaGFuZGxlcyBzbW9vdGggcm90YXRpb24gdmlhIHRhcmdldFlhdy4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyB0aGUgImZsaXBwaW5nIGFyb3VuZCIgdmlzdWFsIGdsaXRjaC4KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5jb3B5KHRoaXMubG9ja2VkQWltVmVjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlRGlyLmNvcHkodGhpcy5sb2NrZWRBaW1WZWN0b3IpOwogICAgICAgICAgICAgICAgICAgIH0KCmNvbnN0IHNwaW4gPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGZvcmNlZFNwaW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3Bpbi5jb3B5KGZvcmNlZFNwaW4pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlucHV0RGlyID0gdGhpcy5pbnB1dFZlY3Rvci5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjcm9zc1kgPSBuZXcgVEhSRUUuVmVjdG9yMygpLmNyb3NzVmVjdG9ycyhyZWZlcmVuY2VEaXIsIGlucHV0RGlyKS55OwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGNyb3NzWSkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwaW4uc2V0KDAsIGNyb3NzWSAqIDEyLjAsIDApOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsZXQgYmFzZUNvc3QgPSAodHlwZSA9PT0gJ1NIJykgPyAyMCA6IDEwOwogICAgICAgICAgICAgICAgICAgIGxldCB0ZWNoQ29zdCA9IDA7CiAgICAgICAgICAgICAgICAgICAgbGV0IHRlY2hCb251cyA9IDA7CiAgICAgICAgICAgICAgICAgICAgbGV0IHRlY2hQYXlsb2FkID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRlY2hOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAodGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3Zlbm9tJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9ICh0eXBlID09PSAnU0gnID8gMjAgOiAxMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IHsgdHlwZTogJ3Zlbm9tJywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3dpdGhlcic6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaENvc3QgPSAodHlwZSA9PT0gJ1NIJyA/IDIwIDogMTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICd3aXRoZXInLCBsZXZlbDogMSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnbmFwJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9ICh0eXBlID09PSAnU0gnID8gMzUgOiAzMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaEJvbnVzID0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IHsgdHlwZTogJ25hcCcsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdzcGhlcmUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hDb3N0ID0gMjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJuZyA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDExKSArIDU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IHJuZzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVjaFBheWxvYWQgPSB7IHR5cGU6ICdzcGhlcmUnLCBsZXZlbDogMSwgYm9udXM6IHJuZyB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oYFNQSEVSRSArJHtybmd9YCwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZ29hbCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2plY2h0JzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9IDQwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSA1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IHsgdHlwZTogJ2plY2h0JywgbGV2ZWw6IDEgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGVyZm9ybUplY2h0S25vY2tiYWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnaW52aXNpYmxlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQ29zdCA9IDI1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoQm9udXMgPSAyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IHsgdHlwZTogJ2ludmlzaWJsZScsIGxldmVsOiAxIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b3RhbENvc3QgPSBiYXNlQ29zdCArIHRlY2hDb3N0OwoKICAgICAgICAgICAgICAgICAgICBsZXQgcG93ZXJGYWN0b3IgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPCB0b3RhbENvc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcG93ZXJGYWN0b3IgPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB0ZWNoUGF5bG9hZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIHRlY2hCb251cyA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiVElSRUQiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQIC09IHRvdGFsQ29zdDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGxldCBzdGF0VmFsID0gdGhpcy5nZXRTdGF0KHR5cGUpOwogICAgICAgICAgICAgICAgICAgIHN0YXRWYWwgKz0gdGVjaEJvbnVzOwogICAgICAgICAgICAgICAgICAgIHN0YXRWYWwgKj0gcG93ZXJGYWN0b3I7CiAgICAgICAgICAgICAgICAgICAgc3RhdFZhbCAqPSBwb3dlck11bHRpcGxpZXI7Cgpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtZ29hbERpc3QgOiBnb2FsRGlzdDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnb2FsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbFogLSB0aGlzLm1lc2gucG9zaXRpb24ueikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbERvdCA9IGZpbmFsRGlyLmRvdChnb2FsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTSCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZ29hbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDIsIGdvYWxaKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdG9Hb2FsID0gZ29hbFBvcy5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2ggPSB0aGlzLmdldFN0YXQoJ1NIJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBNYXRoLm1pbigwLjksIE1hdGgubWF4KDAuMSwgc2ggLyAxMDAuMCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lzdEZhY3RvciAqPSAwLjE7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnb2FsRG90ID4gMC4yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbERpci5sZXJwKHRvR29hbCwgYXNzaXN0RmFjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRmluaXNoZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4wNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU0xBTSEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gMC4yNTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKLy8gR29hbGllIExvZnQgQm9udXMgKFByZXZlbnQgaW50ZXJjZXB0aW9uIGJ5IGltbWVkaWF0ZSBkZWZlbmRlcikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgZmluYWxEaXIueSArPSAwLjg7IC8vIEhpZ2ggbG9mdCBmb3IgY2xlYXJhbmNlCgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2ZpbmRQYXNzVGFyZ2V0SW5Db25lKGZpbmFsRGlyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvTWF0ZSA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0LnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b01hdGUuYWRkU2NhbGVkVmVjdG9yKHRhcmdldC52ZWxvY2l0eSwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvTWF0ZS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYSA9IHRoaXMuZ2V0U3RhdCgnUEEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3Npc3RGYWN0b3IgPSBNYXRoLm1pbigxLjAsIDAuMyArIChwYSAvIDgwLjApKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lzdEZhY3RvciAqPSAwLjE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEaXIubGVycCh0b01hdGUsIGFzc2lzdEZhY3Rvcik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLnkgKz0gTWF0aC5taW4oMC42LCBkaXN0ICogMC4wMyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CmZpbmFsRGlyLnkgKz0gMC4yOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBHb2FsaWUgTG9mdCBCb251cyBmb3IgUGFzc2luZwovLyBHb2FsaWUgTG9mdCBCb251cyBmb3IgUGFzc2luZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yb2xlID09PSAnR0wnKSBmaW5hbERpci55ICs9IDAuODsgLy8gSGlnaCBsb2Z0IGZvciBjbGVhcmFuY2UKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodGVjaFBheWxvYWQgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KHRoaXMsIHRlY2hOYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CgpiYWxsLnNob290KGZpbmFsRGlyLCBzdGF0VmFsLCB0eXBlLCB0ZWNoUGF5bG9hZCwgc3Bpbik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRXh0cmEgZ3JhY2UgcGVyaW9kIGZvciBHb2FsaWUgdG8gcHJldmVudCBwb2ludC1ibGFuayBpbnRlcmNlcHRpb25zCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9sZSA9PT0gJ0dMJykgewogICAgICAgICAgICAgICAgICAgICAgICBiYWxsLmNhdGNoR3JhY2VQZXJpb2QgPSAwLjY7IC8vIDAuNnMgaW1tdW5pdHkgKGFwcHJveCAxMC0xMm0gdHJhdmVsKQogICAgICAgICAgICAgICAgICAgIH0KCnRoaXMubG9zZUJhbGwoKTsKCnRoaXMuY2F0Y2hDb29sZG93biA9IDEuMDsgLy8gMXMgY29vbGRvd24KICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHdpbmR1cFRpbWUpOwoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBudWxsOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlTG9jb21vdGlvbkFuaW0oMC4yKTsKICAgICAgICAgICAgfSwgd2luZHVwVGltZSArIDUwMCk7CiAgICAgICAgfQoKICAgICAgICBfZmluZFBhc3NUYXJnZXRJbkNvbmUoYWltRGlyKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtKSByZXR1cm4gbnVsbDsKCiAgICAgICAgICAgIGxldCBiZXN0VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgbGV0IG1heFNjb3JlID0gLUluZmluaXR5OwoKICAgICAgICAgICAgZm9yIChjb25zdCBtYXRlIG9mIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcyB8fCAhbWF0ZS5tZXNoKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICBjb25zdCB0b01hdGUgPSBtYXRlLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGRvdCA9IGFpbURpci5kb3QodG9NYXRlKTsKCiAgICAgICAgICAgICAgICBpZiAoZG90ID4gMC43KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2NvcmUgPSAoZG90ICogMTApIC0gKGRpc3QgKiAwLjEpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoc2NvcmUgPiBtYXhTY29yZSkgewogICAgICAgICAgICAgICAgICAgICAgICBtYXhTY29yZSA9IHNjb3JlOwogICAgICAgICAgICAgICAgICAgICAgICBiZXN0VGFyZ2V0ID0gbWF0ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJlc3RUYXJnZXQ7CiAgICAgICAgfQoKc3RhcnRDaGFyZ2UoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZyB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDaGFyZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSA9IDA7CgovLyBWaXN1YWxzIGhhbmRsZWQgaW4gdXBkYXRlCgogICAgICAgICAgICAvLyBTaG93IGNoYXJnZSBVSQogICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSSgwKTsKCiAgICAgICAgICAgIC8vIE5FVzogU3Bhd24gQ2hhcmdlIEdseXBoIChHcm91bmQgUmluZykKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZ2x5cGhNYW5hZ2VyLnNwYXduKCdjaGFyZ2UnLCB0aGlzLm1lc2gucG9zaXRpb24sIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgbGlmZTogdGhpcy5tYXhDaGFyZ2VUaW1lLAogICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uU3BlZWQ6IDMuMCwKICAgICAgICAgICAgICAgICAgICBzY2FsZVNwZWVkOiAwLjIsCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WTogMC4xCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnJlbGVhc2VDaGFyZ2UoZHgsIGR5LCBjdXJ2ZUlucHV0ID0gbnVsbCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaXNDaGFyZ2luZykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBvd2VyIENhbGN1bGF0aW9uCiAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4odGhpcy5jaGFyZ2VUaW1lIC8gdGhpcy5tYXhDaGFyZ2VUaW1lLCAxLjApOwogICAgICAgICAgICBjb25zdCBUQyA9IHdpbmRvdy5mbHV4LlRocm93Q29uZmlnIHx8IHt9OwoKICAgICAgICAgICAgLy8gQmFzZSBtdWx0aXBsaWVyIChkZWZhdWx0czogMS4wIHRvIDEuOCkKICAgICAgICAgICAgbGV0IG11bHRpcGxpZXIgPSAoVEMuUE9XRVJfQkFTRSAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfQkFTRSA6IDEuMCkgKyAocmF0aW8gKiAoVEMuUE9XRVJfUkFOR0UgIT09IHVuZGVmaW5lZCA/IFRDLlBPV0VSX1JBTkdFIDogMC44KSk7Ly8gTUFYIFBPV0VSIEJPTlVTOiBJZiBoZWxkIG5lYXIgbWF4LCBzaWduaWZpY2FudCBib29zdAogICAgICAgICAgICBpZiAocmF0aW8gPiAoVEMuUE9XRVJfTUFYX0JPTlVTX1JBVElPICE9PSB1bmRlZmluZWQgPyBUQy5QT1dFUl9NQVhfQk9OVVNfUkFUSU8gOiAwLjk1KSkgewogICAgICAgICAgICAgICAgbXVsdGlwbGllciA9IChUQy5QT1dFUl9NQVhfTVVMVElQTElFUiAhPT0gdW5kZWZpbmVkID8gVEMuUE9XRVJfTUFYX01VTFRJUExJRVIgOiAyLjUpOyAvLyBDcml0aWNhbCBQb3dlcgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJNQVggUE9XRVIhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKC0xMCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CgogICAgICAgICAgICAvLyBBaW0gVmVjdG9yIENhbGN1bGF0aW9uCiAgICAgICAgICAgIGxldCBhaW1WZWMgPSBudWxsOwogICAgICAgICAgICBjb25zdCBzd2lwZUxlbiA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKCiAgICAgICAgICAgIGlmIChzd2lwZUxlbiA+IChUQy5TV0lQRV9NSU5fUFggIT09IHVuZGVmaW5lZCA/IFRDLlNXSVBFX01JTl9QWCA6IDIwKSkgewogICAgICAgICAgICAgICAgY29uc3QgY2FtZXJhID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYTsKICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgICAgICBjb25zdCByaWdodCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAgICAgaWYgKGNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihmd2QpOwogICAgICAgICAgICAgICAgICAgIGZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAoZndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgZndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBmd2Qubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIHJpZ2h0LmNyb3NzVmVjdG9ycyhmd2QsIG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ybGRWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgICAgIHdvcmxkVmVjLmFkZFNjYWxlZFZlY3RvcihyaWdodCwgZHggKiAoVEMuQUlNX0RYX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5BSU1fRFhfU0NBTEUgOiAxLjApKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5hZGRTY2FsZWRWZWN0b3IoZndkLCAtZHkgKiAoVEMuQUlNX0RZX1NDQUxFICE9PSB1bmRlZmluZWQgPyBUQy5BSU1fRFlfU0NBTEUgOiAxLjApKTsKICAgICAgICAgICAgICAgICAgICB3b3JsZFZlYy5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgYWltVmVjID0gd29ybGRWZWM7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdmVycmlkZUFpbVZlY3RvciA9IGFpbVZlYzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYWltVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFpbVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgfQoKLy8gLS0tIEFOQUxPRyBDVVJWRSBMT0dJQyAtLS0KICAgICAgICAgICAgLy8gRm9ybXVsYTogQ3VydmUgPSBJbnRlbnNpdHkgKiBTcGVlZAogICAgICAgICAgICBsZXQgc3BpblZlYyA9IG51bGw7CiAgICAgICAgICAgIAppZiAoKFRDLkNVUlZFX0VOQUJMRUQgIT09IGZhbHNlKSAmJiBjdXJ2ZUlucHV0ICYmIE1hdGguYWJzKGN1cnZlSW5wdXQuaW50ZW5zaXR5KSA+IChUQy5DVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEICE9PSB1bmRlZmluZWQgPyBUQy5DVVJWRV9JTlRFTlNJVFlfVEhSRVNIT0xEIDogMC4yNSkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJhd0ludGVuc2l0eSA9IE1hdGguYWJzKGN1cnZlSW5wdXQuaW50ZW5zaXR5KTsKICAgICAgICAgICAgICAgIGNvbnN0IHNpZ24gPSBNYXRoLnNpZ24oY3VydmVJbnB1dC5pbnRlbnNpdHkpOyAvLyBQb3NpdGl2ZSA9IFJpZ2h0IEh1bXAgPSBMZWZ0IEN1cnZlCiAgICAgICAgICAgICAgICBjb25zdCBzd2lwZVNwZWVkID0gY3VydmVJbnB1dC5zcGVlZCB8fCAxLjA7CgogICAgICAgICAgICAgICAgLy8gMS4gQmFzZSBTcGluIGZyb20gQXJjIChUdW5lZCBmb3IgcmVhbGlzbSwgbm8gY3ljbG9uZXMpCi8vIDEuIEJhc2UgU3BpbiBmcm9tIEFyYyAoSGVyY3VsZWFuIEJvb3N0KQogICAgICAgICAgICAgICAgbGV0IHNwaW5NYWcgPSByYXdJbnRlbnNpdHkgKiAoVEMuQ1VSVkVfU1BJTl9TQ0FMRSAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BJTl9TQ0FMRSA6IDEwMDAuMCk7CgogICAgICAgICAgICAgICAgLy8gMi4gU3BlZWQgQm9udXMgKFF1aWNrbmVzcyBhZGRzIFJQTSkKICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkQm9udXMgPSBNYXRoLm1heCgxLjAsIHN3aXBlU3BlZWQgKiAoVEMuQ1VSVkVfU1BFRURfTVVMVCAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfU1BFRURfTVVMVCA6IDEuNSkpOwogICAgICAgICAgICAgICAgc3Bpbk1hZyAqPSBzcGVlZEJvbnVzOwoKICAgICAgICAgICAgICAgIC8vIENhcCAoSW5jcmVhc2VkIHRvIDE1MDAgZm9yIG1hc3NpdmUgYXJjcykKICAgICAgICAgICAgICAgIHNwaW5NYWcgPSBNYXRoLm1pbigoVEMuQ1VSVkVfU1BJTl9DQVAgIT09IHVuZGVmaW5lZCA/IFRDLkNVUlZFX1NQSU5fQ0FQIDogMTUwMC4wKSwgc3Bpbk1hZyk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgU3BpbgogICAgICAgICAgICAgICAgLy8gUmlnaHQgSHVtcCAoUG9zaXRpdmUgSW50ZW5zaXR5KSAtPiBMZWZ0IEN1cnZlIChQb3NpdGl2ZSBTcGluIFkpCiAgICAgICAgICAgICAgICBzcGluVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgc3Bpbk1hZyAqIHNpZ24sIDApOwogICAgICAgICAgICAgICAgCmlmIChzcGluTWFnID4gKFRDLkNVUlZFX1BFUkZFQ1RfU1BJTiAhPT0gdW5kZWZpbmVkID8gVEMuQ1VSVkVfUEVSRkVDVF9TUElOIDogNTAwLjApICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJQRVJGRUNUIENVUlZFIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRSb2xsSW1wdWxzZShzaWduICogLTAuMyk7IC8vIFRpbHQgY2FtZXJhIGludG8gdGhlIGN1cnZlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEZXRlcm1pbmUgVHlwZSAoUGFzcyB2cyBTaG9vdCkKLy8gRGV0ZXJtaW5lIFR5cGUgKFBhc3MgdnMgU2hvb3QpCmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtZ29hbERpc3QgOiBnb2FsRGlzdDsKICAgICAgICAgICAgY29uc3QgZ29hbERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIGdvYWxaIC0gdGhpcy5tZXNoLnBvc2l0aW9uLnopLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBjb25zdCBkb3RHb2FsID0gYWltVmVjLmRvdChnb2FsRGlyKTsKCiAgICAgICAgICAgIGxldCB0eXBlID0gJ1BBJzsKICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwoKICAgICAgICAgICAgaWYgKGRvdEdvYWwgPiAwLjggJiYgZGlzdFRvR29hbCA8IDM1LjApIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAnU0gnOwogICAgICAgICAgICB9IGVsc2UgaWYgKGRvdEdvYWwgPiAwLjUgJiYgZGlzdFRvR29hbCA8IDIwLjApIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAnU0gnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbWFydCBQYXNzIE92ZXJyaWRlCiAgICAgICAgICAgIGNvbnN0IHRhcmdldE1hdGUgPSB0aGlzLl9maW5kUGFzc1RhcmdldEluQ29uZShhaW1WZWMpOwogICAgICAgICAgICBpZiAodGFyZ2V0TWF0ZSAmJiB0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0TWF0ZSA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldE1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdE1hdGUgPCAxMi4wKSB0eXBlID0gJ1BBJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgdHlwZSwgbXVsdGlwbGllciwgc3BpblZlYyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE5FVzogQ2hhcmdlIFVJIG1ldGhvZHMKICAgICAgICBfdXBkYXRlQ2hhcmdlVUkocmF0aW8pIHsKICAgICAgICAgICAgY29uc3QgbWV0ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhcmdlLW1ldGVyLWZpbGwnKTsKICAgICAgICAgICAgaWYgKG1ldGVyKSB7CiAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS53aWR0aCA9IGAke3JhdGlvICogMTAwfSVgOwogICAgICAgICAgICAgICAgaWYgKHJhdGlvID4gMC45KSB7CiAgICAgICAgICAgICAgICAgICAgbWV0ZXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAsICNmODApJzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmF0aW8gPiAwLjUpIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzBmMCwgI2ZmMCknOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtZXRlci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgIzBhZiwgIzBmMCknOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIpIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CgogICAgICAgIF9oaWRlQ2hhcmdlVUkoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyZ2UtbWV0ZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIpIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KCiAgICAgICAgc2V0T3ZlcnJpZGVBaW0oeCwgeikgewogICAgICAgICAgICBpZiAoIXRoaXMub3ZlcnJpZGVBaW1WZWN0b3IpIHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLm92ZXJyaWRlQWltVmVjdG9yLnNldCh4LCAwLCB6KS5ub3JtYWxpemUoKTsKICAgICAgICB9Cgpsb3NlQmFsbCgpIHsKICAgICAgICAgICAgdGhpcy5oYXNCYWxsID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwogICAgICAgICAgICAvLyBGaXg6IEVuc3VyZSBwbGF5ZXIgY2FuIGNhdGNoIGFnYWluIGlmIHRoZXkgbG9zZSBwb3NzZXNzaW9uIHVuZXhwZWN0ZWRseQogICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBzdGF0ZXMgdG8gcHJldmVudCBsb2NraW5nCiAgICAgICAgICAgIHRoaXMuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faGlkZUNoYXJnZVVJKCk7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQaHlzaWNzKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyBTWU5DIEZJWDogSWYgYmFsbCB0aGlua3MgSSBob2xkIGl0LCBidXQgSSBkb24ndCwgZm9yY2UgcmVjZWl2ZQogICAgICAgICAgICBpZiAodGhpcy5iYWxsUmVmICYmIHRoaXMuYmFsbFJlZi5ob2xkZXIgPT09IHRoaXMgJiYgIXRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJTeW5jaW5nIGJhbGwgcG9zc2Vzc2lvbiB0byBwbGF5ZXIiKTsKICAgICAgICAgICAgICAgIHRoaXMucmVjZWl2ZUJhbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaXNHb2RNb2RlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gdGhpcy5zdGF0cy5tYXhIUDsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gdGhpcy5nZXRTdGF0KCdFTicpOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMudmVub20gPSAwOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubmFwID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzTG9naWMoZHQpOwoKICAgICAgICAgICAgLy8gQ2hhcmdlIExvZ2ljIChQaHlzaWNzIHBhcnQgLSBUaW1lcikKICAgICAgICAgICAgaWYgKHRoaXMuaXNDaGFyZ2luZykgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwgfHwgdGhpcy5zdGF0dXMubmFwID4gMCB8fCB0aGlzLnN0dW5UaW1lciA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzQ2hhcmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBwaHlzaWNzIHByb3BzIHRoYXQgbWlnaHQgaGF2ZSBiZWVuIGFsdGVyZWQKICAgICAgICAgICAgICAgICAgICAvLyBWaXN1YWwgcmVzZXQgaGFwcGVucyBpbiB1cGRhdGVWaXN1YWxzCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhcmdlVGltZSArPSBkdDsKICAgICAgICAgICAgICAgICAgICAvLyBBVVRPLVJFTEVBU0U6IElmIGhlbGQgdG9vIGxvbmcgKDNzKSwgZm9yY2UgcmVsZWFzZQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJnZVRpbWUgPiAzLjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWxlYXNlQ2hhcmdlKDAsIDApOyAKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuZGFzaENvb2xkb3duID4gMCkgdGhpcy5kYXNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmNsYXNoQ29vbGRvd24gPiAwKSB0aGlzLmNsYXNoQ29vbGRvd24gLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLnN0dW5UaW1lciA+IDApIHRoaXMuc3R1blRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5pbW11bml0eVRpbWVyID4gMCkgdGhpcy5pbW11bml0eVRpbWVyIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5jYXRjaENvb2xkb3duID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2F0Y2hDb29sZG93biA8PSAwKSB0aGlzLmNhbkNhdGNoID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGFzaCBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNtb290aCBSb3RhdGlvbiBkdXJpbmcgRGFzaCAoTG9naWMgYWZmZWN0aW5nIHRyYW5zZm9ybSkKICAgICAgICAgICAgICAgIGxldCBkaWZmID0gdGhpcy50YXJnZXRZYXcgLSB0aGlzLmN1cnJlbnRZYXc7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlmZiA+IE1hdGguUEkpIGRpZmYgLT0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlmZiA8IC1NYXRoLlBJKSBkaWZmICs9IE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB0dXJuU3BlZWQgPSAxNS4wOyAKICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5nZSA9IE1hdGgubWF4KC10dXJuU3BlZWQgKiBkdCwgTWF0aC5taW4odHVyblNwZWVkICogZHQsIGRpZmYpKTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyArPSBjaGFuZ2U7CgogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVDb2xsaXNpb24oKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGFzaFRpbWUgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXNoVHlwZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUeXBlID09PSAndmVydGljYWwnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5kYXNoVmVjKS5tdWx0aXBseVNjYWxhcihkdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBZIHBvc2l0aW9uIGNhbGN1bGF0aW9uIGlzIHZpc3VhbC9waHlzaWNzIGh5YnJpZCwga2VlcGluZyBoZXJlIGZvciBjb2xsaXNpb24gY29uc2lzdGVuY3kKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IDEgLSAodGhpcy5kYXNoVGltZSAvIHRoaXMuZGFzaFRvdGFsVGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gTWF0aC5zaW4odCAqIE1hdGguUEkpICogMy4wOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhvcml6b250YWwgRGFzaCBNb3ZlbWVudAogICAgICAgICAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChfcFZlYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJvdGF0aW9uIHVwZGF0ZQogICAgICAgICAgICAgICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUF4aXNBbmdsZShfcEF4aXNZLCB0aGlzLmN1cnJlbnRZYXcgKyB0aGlzLnJvdGF0aW9uT2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIGxlYW4gaXMgY2FsY3VsYXRlZCBpbiB1cGRhdGVWaXN1YWxzLCBidXQgd2Ugc2V0IGJhc2Ugb3JpZW50YXRpb24gaGVyZQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5jb3B5KF9wUXVhdCk7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5Lm11bHRpcGx5U2NhbGFyKDAuOTYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3R1bi9OYXAgQ2hlY2sKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDAgfHwgdGhpcy5zdHVuVGltZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkcmFnRmFjdG9yID0gTWF0aC5tYXgoMCwgMSAtICgyLjAgKiBkdCkpOwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihkcmFnRmFjdG9yKTsKCiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9jaGVja1RhY2tsZVByZXNzdXJlKGR0KTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgoMCwgMS4wIC0gKDIuMCAqIGR0KSkpOwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlTb2Z0Q29sbGlzaW9uKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5R29hbENyZWFzZShkdCk7CiAgICAgICAgICAgICAgICBfcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKGR0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQoX3BWZWMpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmVydGljYWxpdHkoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQmFua2luZyhkdCk7IAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVWZXJ0aWNhbGl0eShkdCk7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCYW5raW5nKGR0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlTG9jb21vdGlvbkFuaW0oZHQpOyAvLyBBbmltYXRpb24gc3RhdGUgbG9naWMgZHJpdmVuIGJ5IHBoeXNpY3Mgc3RhdGUKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzVmlzdWFscyhkdCk7CgogICAgICAgICAgICAvLyBDaGFyZ2UgVmlzdWFscwogICAgICAgICAgICBpZiAodGhpcy5pc0NoYXJnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmIHRoaXMuc3RhdHVzLm5hcCA8PSAwICYmIHRoaXMuc3R1blRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHRoaXMuY2hhcmdlVGltZSAvIHRoaXMubWF4Q2hhcmdlVGltZSwgMS4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMZXZpdGF0aW9uCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaG92ZXIgPSAoTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDIpICogMC4xKSArIChyYXRpbyAqIDAuOCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hha2UgPSAwLjA1ICsgKDAuMSAqIHJhdGlvKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9IGhvdmVyICsgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc2hha2U7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVmlzdWFsIEppdHRlcgogICAgICAgICAgICAgICAgICAgIHRoaXMuYmFua2luZ0Ftb3VudCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBpdGNoQW1vdW50ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHNoYWtlOwoKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0U2NhbGFyKHRoaXMuYmFzZVNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVDaGFyZ2VVSShyYXRpbyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IHZpc3VhbHMgaWYgY2hhcmdlIGNhbmNlbGxlZAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2guc2NhbGUuc2V0U2NhbGFyKHRoaXMuYmFzZVNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlQ2hhcmdlVUkoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGFzaCBWaXN1YWxzIChQYXJ0aWNsZXMgJiBMZWFuKQogICAgICAgICAgICBpZiAodGhpcy5pc0Rhc2hpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2Rhc2hQYXJ0aWNsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9kYXNoUGFydGljbGVUaW1lciA9IDAuMDE7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhY2sgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCkubmVnYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYWNrLmxlbmd0aFNxKCkgPCAwLjEpIGJhY2suc2V0KDAsIDAsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwyOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChiYWNrLm11bHRpcGx5U2NhbGFyKDAuNSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gMS4wICsgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnggKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnogKz0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwb3MsIHsgc2NhbGU6IDIuMCArIE1hdGgucmFuZG9tKCkgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVmlzdWFsIExlYW4gZm9yIERhc2gKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhc2hUeXBlID09PSAnaG9yaXpvbnRhbCcgfHwgdGhpcy5kYXNoVHlwZSA9PT0gJ2JyZWFrJyB8fCB0aGlzLmRhc2hUeXBlID09PSAnc3ByaW50JykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSAxIC0gKHRoaXMuZGFzaFRpbWUgLyB0aGlzLmRhc2hUb3RhbFRpbWUpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlYW4gPSBNYXRoLnNpbih0ICogTWF0aC5QSSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgX3BRdWF0LnNldEZyb21BeGlzQW5nbGUoX3BBeGlzWSwgdGhpcy5jdXJyZW50WWF3ICsgdGhpcy5yb3RhdGlvbk9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgbGV0IHBpdGNoID0gMCwgeWF3ID0gMCwgcm9sbCA9IDAsIGx1bmdlQW10ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXNoVHlwZSAhPT0gJ3NwcmludCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHBpdGNoID0gMS4yICogbGVhbjsgeWF3ID0gMC44ICogbGVhbjsgcm9sbCA9IC0wLjYgKiBsZWFuOyBsdW5nZUFtdCA9IDAuOCAqIGxlYW47CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHBpdGNoID0gMC41ICogbGVhbjsgbHVuZ2VBbXQgPSAwLjIgKiBsZWFuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGx1bmdlQW10ID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgX3BWZWMuc2V0KDAsIDAsIGx1bmdlQW10KS5hcHBseVF1YXRlcm5pb24oX3BRdWF0KTsKICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBvZmZzZXQgb25seSwgZG9uJ3QgYWNjdW11bGF0ZSB0byBwaHlzaWNzIHBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAvLyBOb3RlOiBXZSBhcmUgbW9kaWZ5aW5nIG1lc2gucG9zaXRpb24gaGVyZSB3aGljaCBpcyB0aGUgcGh5c2ljcyB0cmFuc2Zvcm0uCiAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZGVhbGx5IHdlIHNob3VsZCBoYXZlIGEgdmlzdWFsIGNoaWxkIG5vZGUsIGJ1dCBmb3Igbm93IHdlIGFkZCB0aGUgb2Zmc2V0LgogICAgICAgICAgICAgICAgICAgICAgICAgLy8gVG8gcHJldmVudCBkcmlmdCwgd2UgcmVseSBvbiBwaHlzaWNzIHVwZGF0ZSByZXNldHRpbmcgWSBhbmQgWC9aIGJlaW5nIGludGVncmF0ZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAvLyBBY3R1YWxseSwgYWRkaW5nIHRvIG1lc2gucG9zaXRpb24gaGVyZSBXSUxMIGFmZmVjdCBwaHlzaWNzIG5leHQgZnJhbWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3Igbm93LCB3ZSBhY2NlcHQgdGhpcyB2aXN1YWwtaW1wYWN0aW5nLXBoeXNpY3MgYmVoYXZpb3IgYXMgaXQgd2FzIGluIG9yaWdpbmFsIGNvZGUuCiAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIF9wRXVsZXIuc2V0KHBpdGNoLCB5YXcsIHJvbGwpOwogICAgICAgICAgICAgICAgICAgIF9wUXVhdDIuc2V0RnJvbUV1bGVyKF9wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5xdWF0ZXJuaW9uLm11bHRpcGx5UXVhdGVybmlvbnMoX3BRdWF0LCBfcFF1YXQyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3R1bi9OYXAgVmlzdWFsIFJlc2V0CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9hbmltTG9ja2VkICYmIHRoaXMuc3RhdGUgIT09ICdpZGxlJyAmJiB0aGlzLnN0YXRlICE9PSAnY2F0Y2gnKSB0aGlzLnBsYXkoJ2lkbGUnLCAwLjUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl91cGRhdGVIUEJhcigpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwoKICAgICAgICAgICAgLy8gQnViYmxlIFRyYWlsCiAgICAgICAgICAgIGNvbnN0IHNwZWVkU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGlmIChzcGVlZFNxID4gMS4wICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciAtPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9idWJibGVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG0gPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhY2tEaXIgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCkubmVnYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gYmFja0Rpci5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKDAuOCk7CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LnkgPSAwLjUgKyBNYXRoLnJhbmRvbSgpICogMC41OyAKICAgICAgICAgICAgICAgICAgICBvZmZzZXQueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgICAgIG9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZScsIHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLCB7IHNjYWxlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMjUgfSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChzcGVlZFNxID4gNDAuMCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTwzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1PZmZzZXQgPSBiYWNrRGlyLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMC41ICsgTWF0aC5yYW5kb20oKSowLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC55ID0gMC41ICsgKE1hdGgucmFuZG9tKCktMC41KSowLjg7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbU9mZnNldC56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkqMC44OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZV9taWNybycsIHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChtT2Zmc2V0KSwgeyBzY2FsZTogMC4wNiArIE1hdGgucmFuZG9tKCkqMC4wOCB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDAuMDM7IAogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4xOyAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2FwcGx5UHJvY2VkdXJhbFBvc2UoZHQpOwogICAgICAgIH0KCiAgICAgICAgX2FwcGx5UHJvY2VkdXJhbFBvc2UoZHQpIHsKICAgICAgICAgICAgLy8gQWR2YW5jZSBsb2NhbCB0aW1lICh1c2VkIGZvciBzdWJ0bGUgc3dheXMpCiAgICAgICAgICAgIHRoaXMuX3Byb2NBbmltVGltZSArPSBkdDsKCiAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmJvbmVzOwogICAgICAgICAgICBpZiAoIWIpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSAoZ2FtZSAmJiBnYW1lLmVudGl0aWVzKSA/IGdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CgogICAgICAgICAgICBsZXQgc2hvdWxkQXBwbHkgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIEJ1aWxkIGEgZGVzaXJlZCB3b3JsZC1zcGFjZSBkaXJlY3Rpb24gd2Ugd2FudCB0aGUgdG9yc28vaGVhZCB0byBiaWFzIHRvd2FyZC4KICAgICAgICAgICAgLy8gTk9URTogV2UgYXBwbHkgdGhpcyBBRlRFUiB0aGUgYW5pbWF0aW9uIG1peGVyIGhhcyBwb3NlZCBib25lcywgYXMgYSBzbWFsbCBhZGRpdGl2ZSBvZmZzZXQuCiAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgLy8gQWltIGRpcmVjdGlvbiAocHJlZmVyIGV4cGxpY2l0IGFpbSB2ZWN0b3IpCiAgICAgICAgICAgICAgICBpZiAodGhpcy5vdmVycmlkZUFpbVZlY3RvcikgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5vdmVycmlkZUFpbVZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubG9ja2VkQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLmxvY2tlZEFpbVZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5wdXRWZWN0b3IgJiYgdGhpcy5pbnB1dFZlY3Rvci5sZW5ndGhTcSgpID4gMC4wOCkgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy5pbnB1dFZlY3Rvcikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2hvdWxkQXBwbHkgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICAvLyBMb29rIGF0IHRoZSBiYWxsIGlmIGl0J3MgaW4gdGhlICJhd2FyZW5lc3MiIHJhZGl1cwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IDIwLjApIHsKICAgICAgICAgICAgICAgICAgICBfcFZlYy5zdWJWZWN0b3JzKGJhbGwubWVzaC5wb3NpdGlvbiwgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICBzaG91bGRBcHBseSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghc2hvdWxkQXBwbHkpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENvbnZlcnQgdGhlIGRpcmVjdGlvbiBpbnRvIHRoZSBwbGF5ZXIncyBsb2NhbCBzcGFjZSBzbyB5YXcvcGl0Y2ggYXJlIHN0YWJsZS4KICAgICAgICAgICAgX3BJbnZRdWF0LmNvcHkodGhpcy5tZXNoLnF1YXRlcm5pb24pLmludmVydCgpOwogICAgICAgICAgICBfcFZlYy5hcHBseVF1YXRlcm5pb24oX3BJbnZRdWF0KS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIGNvbnN0IGx4ID0gX3BWZWMueCwgbHkgPSBfcFZlYy55LCBseiA9IF9wVmVjLno7CiAgICAgICAgICAgIGNvbnN0IHlhdyA9IE1hdGguYXRhbjIobHgsIGx6KTsKICAgICAgICAgICAgY29uc3QgcGl0Y2ggPSBNYXRoLmF0YW4yKGx5LCBNYXRoLnNxcnQobHggKiBseCArIGx6ICogbHopICsgMWUtNik7CgogICAgICAgICAgICBjb25zdCB5YXdDID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHlhdywgLTAuOSwgMC45KTsKICAgICAgICAgICAgY29uc3QgcGl0Y2hDID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHBpdGNoLCAtMC42LCAwLjYpOwoKICAgICAgICAgICAgY29uc3Qgc3BlZWROb3JtID0gKHRoaXMubWF4U3BlZWQgPiAwLjAwMDEpID8gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKHRoaXMuX3Ntb290aGVkU3BlZWQgLyB0aGlzLm1heFNwZWVkLCAwLCAxKSA6IDA7CiAgICAgICAgICAgIGNvbnN0IGFpbVcgPSAodGhpcy5oYXNCYWxsID8gKHRoaXMuaXNDaGFyZ2luZyA/IDEuMCA6IDAuNjUpIDogMC4zNSkgKiAoMS4wIC0gMC4zNSAqIHNwZWVkTm9ybSk7CiAgICAgICAgICAgIGNvbnN0IGhlYWRXID0gKHRoaXMuaGFzQmFsbCA/IDAuNTUgOiAwLjc1KSAqICgxLjAgLSAwLjI1ICogc3BlZWROb3JtKTsKCiAgICAgICAgICAgIC8vIFRvcnNvIGJpYXMgKHNwaW5lL2NoZXN0KQogICAgICAgICAgICBpZiAoYi5jaGVzdCkgewogICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMjAgKiBhaW1XLCB5YXdDICogMC4zNSAqIGFpbVcsIDApOwogICAgICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgICAgIGIuY2hlc3QucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGIuc3BpbmUpIHsKICAgICAgICAgICAgICAgIF9wVG1wRXVsZXIuc2V0KC1waXRjaEMgKiAwLjE1ICogYWltVywgeWF3QyAqIDAuMjUgKiBhaW1XLCAwKTsKICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICBiLnNwaW5lLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSGVhZC9uZWNrIGxvb2sKICAgICAgICAgICAgaWYgKGIubmVjaykgewogICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLXBpdGNoQyAqIDAuMjUgKiBoZWFkVywgeWF3QyAqIDAuNDUgKiBoZWFkVywgMCk7CiAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgYi5uZWNrLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYi5oZWFkKSB7CiAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldCgtcGl0Y2hDICogMC4zMCAqIGhlYWRXLCB5YXdDICogMC41NSAqIGhlYWRXLCAwKTsKICAgICAgICAgICAgICAgIF9wVG1wUXVhdC5zZXRGcm9tRXVsZXIoX3BUbXBFdWxlcik7CiAgICAgICAgICAgICAgICBiLmhlYWQucXVhdGVybmlvbi5tdWx0aXBseShfcFRtcFF1YXQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCYWxsLWhvbGQgLyBhaW0gYXJtIHBvc2UgKGtlZXBzICJzd2ltIiBhbmltYXRpb24gYnV0IHJlYWRzIGFzIGhvbGRpbmcvYWltaW5nKQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmICF0aGlzLmlzVGhyb3dpbmcgJiYgIXRoaXMuX2FuaW1Mb2NrZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB0aGlzLl9wcm9jQW5pbVRpbWU7CiAgICAgICAgICAgICAgICBjb25zdCBsaWZ0ID0gVEhSRUUuTWF0aFV0aWxzLmNsYW1wKDAuMzUgKyAodGhpcy5pc0NoYXJnaW5nID8gMC41NSA6IDAuMjUpIC0gc3BlZWROb3JtICogMC4yLCAwLjE1LCAwLjk1KTsKICAgICAgICAgICAgICAgIGNvbnN0IHN3YXkgPSBNYXRoLnNpbih0ICogNS4wKSAqIDAuMDUgKiAoMC41ICsgbGlmdCk7CgogICAgICAgICAgICAgICAgY29uc3QgcmFpc2VYID0gLTAuNTUgKiBsaWZ0ICsgc3dheTsKICAgICAgICAgICAgICAgIGNvbnN0IHJhaXNlWiA9IC0wLjI1ICogbGlmdDsKCiAgICAgICAgICAgICAgICBpZiAoYi5yVXBwZXJBcm0pIHsKICAgICAgICAgICAgICAgICAgICBfcFRtcEV1bGVyLnNldChyYWlzZVgsIHlhd0MgKiAwLjEwICogbGlmdCwgcmFpc2VaKTsKICAgICAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIGIuclVwcGVyQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChiLnJGb3JlQXJtKSB7CiAgICAgICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoLTAuMzUgKiBsaWZ0ICsgc3dheSAqIDAuNSwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgX3BUbXBRdWF0LnNldEZyb21FdWxlcihfcFRtcEV1bGVyKTsKICAgICAgICAgICAgICAgICAgICBiLnJGb3JlQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDb3VudGVyYmFsYW5jZSBsZWZ0IGFybSBzbGlnaHRseSBmb3IgYSBtb3JlIGR5bmFtaWMgc2lsaG91ZXR0ZQogICAgICAgICAgICAgICAgaWYgKGIubFVwcGVyQXJtKSB7CiAgICAgICAgICAgICAgICAgICAgX3BUbXBFdWxlci5zZXQoMC4xNSAqIGxpZnQsIC15YXdDICogMC4wNSAqIGxpZnQsIDAuMTUgKiBsaWZ0KTsKICAgICAgICAgICAgICAgICAgICBfcFRtcFF1YXQuc2V0RnJvbUV1bGVyKF9wVG1wRXVsZXIpOwogICAgICAgICAgICAgICAgICAgIGIubFVwcGVyQXJtLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BUbXBRdWF0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KX3VwZGF0ZVN0YXR1cyhkdCkgewogICAgICAgIC8vIExlZ2FjeSB3cmFwcGVyCiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdHVzTG9naWMoZHQpOwogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXR1c1Zpc3VhbHMoZHQpOwogICAgfQoKICAgIF91cGRhdGVTdGF0dXNMb2dpYyhkdCkgewogICAgICAgIGlmICh0aGlzLnN0YXR1cy52ZW5vbSA+IDApIHsKICAgICAgICAgICAgdGhpcy5zdGF0dXMudmVub20gLT0gZHQ7CiAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gNSAqIGR0OwogICAgICAgICAgICBpZiAodGhpcy5zdGF0cy5IUCA8IDApIHRoaXMuc3RhdHMuSFAgPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsICYmIHRoaXMuc3RhdHMuSFAgPCB0aGlzLnN0YXRzLm1heEhQKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQICs9IDUgKiBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQID4gdGhpcy5zdGF0cy5tYXhIUCkgdGhpcy5zdGF0cy5IUCA9IHRoaXMuc3RhdHMubWF4SFA7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSAyLjAgKiBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHMuSFAgPCAwKSB0aGlzLnN0YXRzLkhQID0gMDsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdHVzLm5hcCAtPSBkdDsKICAgICAgICB9CgogICAgICAgIGZvciAobGV0IGtleSBpbiB0aGlzLnN0YXR1cy53aXRoZXIpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLndpdGhlcltrZXldID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMud2l0aGVyW2tleV0gLT0gZHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgX3VwZGF0ZVN0YXR1c1Zpc3VhbHMoZHQpIHsKICAgICAgICBjb25zdCBwbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIgOiBudWxsOwoKICAgICAgICBpZiAodGhpcy5zdGF0dXMudmVub20gPiAwKSB7CiAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnZlbm9tIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMudmVub20gPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgcG0uc3Bhd24oJ3Zlbm9tJywgdGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRpY2xlVGltZXJzLnZlbm9tID0gMC4xNTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMubmFwIC09IGR0OwogICAgICAgICAgICBpZiAodGhpcy5fcGFydGljbGVUaW1lcnMubmFwIDw9IDAgJiYgcG0pIHsKICAgICAgICAgICAgICAgIHBtLnNwYXduKCduYXAnLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgdGhpcy5fcGFydGljbGVUaW1lcnMubmFwID0gMC44OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsZXQgaXNXaXRoZXJpbmcgPSBmYWxzZTsKICAgICAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5zdGF0dXMud2l0aGVyKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy53aXRoZXJba2V5XSA+IDApIGlzV2l0aGVyaW5nID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmIChpc1dpdGhlcmluZykgewogICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgPD0gMCAmJiBwbSkgewogICAgICAgICAgICAgICAgcG0uc3Bhd24oJ3dpdGhlcicsIHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0aWNsZVRpbWVycy53aXRoZXIgPSAwLjI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbHMoKTsKICAgIH0KCl91cGRhdGVWaXN1YWxzKCkgewogICAgICAgICAgICAvLyBSRU1PVkVEOiBZZWxsb3cgc3BoZXJlL3RpbnQgbG9naWMgYXMgcGVyIHJlcXVlc3QuCiAgICAgICAgICAgIC8vIEFsd2F5cyByZXZlcnQgdG8gYmFzZSBjb2xvci4KICAgICAgICAgICAgdGhpcy5vcmlnaW5hbE1hdGVyaWFscy5mb3JFYWNoKGVudHJ5ID0+IHsKICAgICAgICAgICAgICAgIGVudHJ5Lm1hdGVyaWFsLmNvbG9yLmNvcHkoZW50cnkuYmFzZUNvbG9yKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfY3JlYXRlQXVyYSgpIHsKICAgICAgICAgICAgLy8gQXVyYSByZW1vdmVkIHBlciB1c2VyIHJlcXVlc3QKICAgICAgICAgICAgdGhpcy5hdXJhTWVzaCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IFBhc3MgdGFyZ2V0IGluZGljYXRvcgogICAgICAgIF9jcmVhdGVQYXNzVGFyZ2V0SW5kaWNhdG9yKCkgewogICAgICAgICAgICAvLyBDcmVhdGUgYSByaW5nIHRoYXQgaGlnaGxpZ2h0cyBwb3RlbnRpYWwgcGFzcyB0YXJnZXRzCiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMC44LCAxLjAsIDE2KTsKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgICAgIGNvbG9yOiAweDAwZmYwMCwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yID0gbmV3IFRIUkVFLk1lc2goZ2VvLCBtYXQpOwogICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3Iucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnBvc2l0aW9uLnkgPSAwLjE7CiAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMucGFzc1RhcmdldEluZGljYXRvcik7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlUGFzc1RhcmdldEluZGljYXRvcnMoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8ICF0aGlzLnRlYW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGaW5kIGJlc3QgcGFzcyB0YXJnZXQKICAgICAgICAgICAgY29uc3QgYWltRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5fZmluZFBhc3NUYXJnZXRJbkNvbmUoYWltRGlyKTsKCiAgICAgICAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0Lm1lc2ggJiYgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueCA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLng7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueiA9IHRhcmdldC5tZXNoLnBvc2l0aW9uLno7CiAgICAgICAgICAgICAgICB0aGlzLnBhc3NUYXJnZXRJbmRpY2F0b3IucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMucGFzc1RhcmdldEluZGljYXRvci5yb3RhdGlvbi56ICs9IDAuMDU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUGFzc1RhcmdldEluZGljYXRvcnMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVQYXNzVGFyZ2V0SW5kaWNhdG9ycygpIHsKICAgICAgICAgICAgaWYgKHRoaXMucGFzc1RhcmdldEluZGljYXRvcikgewogICAgICAgICAgICAgICAgdGhpcy5wYXNzVGFyZ2V0SW5kaWNhdG9yLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9hcHBseVNvZnRDb2xsaXNpb24oZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2ggfHwgIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgdGVhbXMgPSBbZ2FtZS50ZWFtcy5ob21lLCBnYW1lLnRlYW1zLmF3YXldOwoKICAgICAgICAgICAgY29uc3QgcmVwdWxzaW9uUmFkaXVzID0gMC41OyAvLyBSZWR1Y2VkIHRvIDAuNSB0byBmaXggaW52aXNpYmxlIHdhbGwgaXNzdWVzCiAgICAgICAgICAgIGNvbnN0IHN0aWZmbmVzcyA9IDE1LjA7CgogICAgICAgICAgICB0ZWFtcy5mb3JFYWNoKHRlYW0gPT4gewogICAgICAgICAgICAgICAgaWYgKCF0ZWFtKSByZXR1cm47CiAgICAgICAgICAgICAgICB0ZWFtLnBsYXllcnMuZm9yRWFjaChvdGhlciA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG90aGVyID09PSB0aGlzIHx8ICFvdGhlci5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGR4ID0gdGhpcy5tZXNoLnBvc2l0aW9uLnggLSBvdGhlci5tZXNoLnBvc2l0aW9uLng7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHkgPSB0aGlzLm1lc2gucG9zaXRpb24ueSAtIG90aGVyLm1lc2gucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkeiA9IHRoaXMubWVzaC5wb3NpdGlvbi56IC0gb3RoZXIubWVzaC5wb3NpdGlvbi56OwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR5KmR5ICsgZHoqZHo7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWluRGlzdCA9IHJlcHVsc2lvblJhZGl1cyAqIDIuMDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3RTcSA8IG1pbkRpc3QgKiBtaW5EaXN0ICYmIGRpc3RTcSA+IDAuMDAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG92ZXJsYXAgPSBtaW5EaXN0IC0gZGlzdDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gb3ZlcmxhcCAqIHN0aWZmbmVzczsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG54ID0gZHggLyBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBueSA9IGR5IC8gZGlzdDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbnogPSBkeiAvIGRpc3Q7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gbnggKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKz0gbnkgKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gbnogKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICB0aGlzLl9hcHBseVNvZnRDb2xsaXNpb24oZHQpOwogICAgICAgICAgICB0aGlzLl9hcHBseUdvYWxDcmVhc2UoZHQpOwoKICAgICAgICAgICAgY29uc3QgaW5wdXRMZW5TcSA9IHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKTsKICAgICAgICAgICAgY29uc3QgaXNJbnB1dEFjdGl2ZSA9IGlucHV0TGVuU3EgPiAwLjAxOwoKICAgICAgICAgICAgbGV0IGN1cnJlbnRNYXhTcGVlZCA9IHRoaXMubWF4U3BlZWQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTVFJVR0dMRSBTVEFURTogSGluZGVyIG1vdmVtZW50IGJhc2VkIG9uIHByZXNzdXJlCiAgICAgICAgICAgIC8vIEluc3RlYWQgb2YgYSBiaW5hcnkgMC44IG11bHRpcGxpZXIsIHdlIHNjYWxlIGJhc2VkIG9uIGludGVuc2l0eS4KICAgICAgICAgICAgLy8gTWF4IHN0cnVnZ2xlICgxLjApIHJlZHVjZXMgc3BlZWQgdG8gNDAlLgogICAgICAgICAgICBpZiAodGhpcy5zdHJ1Z2dsZUludGVuc2l0eSA+IDApIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRNYXhTcGVlZCAqPSAoMS4wIC0gKHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgKiAwLjYpKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgc2xpZ2h0IHJlZHVjdGlvbiBpZiBlbmdhZ2VkIGJ1dCBsb3cgcHJlc3N1cmUKICAgICAgICAgICAgICAgIGN1cnJlbnRNYXhTcGVlZCAqPSAwLjk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmlzQ2hhcmdpbmcpIGN1cnJlbnRNYXhTcGVlZCAqPSAwLjk7CgogICAgICAgICAgICBpZiAoaXNJbnB1dEFjdGl2ZSkgewogICAgICAgICAgICAgICAgX3BWZWMuY29weSh0aGlzLmlucHV0VmVjdG9yKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSBTdHJ1Z2dsZSBKaXR0ZXIgdG8gZGlyZWN0aW9uCiAgICAgICAgICAgICAgICAvLyBTaW11bGF0ZXMgd3Jlc3RsaW5nIGZvciBjb250cm9sCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdHJ1Z2dsZUludGVuc2l0eSA+IDAuMykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGppdHRlciA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgKiAwLjg7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMueCArPSBqaXR0ZXI7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMueiArPSBqaXR0ZXI7CiAgICAgICAgICAgICAgICAgICAgX3BWZWMubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0VmVsWCA9IF9wVmVjLnggKiBjdXJyZW50TWF4U3BlZWQ7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRWZWxaID0gX3BWZWMueiAqIGN1cnJlbnRNYXhTcGVlZDsKCiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50U3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWRSYXRpbyA9IE1hdGgubWluKDEuMCwgY3VycmVudFNwZWVkIC8gdGhpcy5tYXhTcGVlZCk7CgogICAgICAgICAgICAgICAgLy8gQWdpbGl0eSBpcyByZWR1Y2VkIHdoZW4gc3RydWdnbGluZwogICAgICAgICAgICAgICAgbGV0IGFnaWxpdHkgPSBUSFJFRS5NYXRoVXRpbHMubGVycCgxMC4wLCAyLjAsIHNwZWVkUmF0aW8pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPiAwKSBhZ2lsaXR5ICo9IDAuNTsKCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gMS4wIC0gTWF0aC5wb3coMC4wMSwgZHQgKiBhZ2lsaXR5KTsKCiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gKHRhcmdldFZlbFggLSB0aGlzLnZlbG9jaXR5LngpICogdDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiArPSAodGFyZ2V0VmVsWiAtIHRoaXMudmVsb2NpdHkueikgKiB0OwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJyYWtlRmFjdG9yID0gMi4wOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IDEuMCAtIE1hdGgucG93KDAuMSwgZHQgKiBicmFrZUZhY3Rvcik7CgogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9ICgwIC0gdGhpcy52ZWxvY2l0eS54KSAqIHQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnogKz0gKDAgLSB0aGlzLnZlbG9jaXR5LnopICogdDsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMC4wMSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIHRoaXMudmVsb2NpdHkueSwgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSBNYXRoLm1heCgwLCAxLjAgLSAoMi4wICogZHQpKTsKCiAgICAgICAgICAgIF9wVmVjLmNvcHkodGhpcy52ZWxvY2l0eSkubXVsdGlwbHlTY2FsYXIoZHQpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF9wVmVjKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVWZXJ0aWNhbGl0eShkdCkgewogICAgICAgICAgICBsZXQgdGFyZ2V0WSA9IDA7CgogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CgogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2ggJiYgIXRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvQmFsbCA8IDE1LjApIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRZID0gYmFsbC5tZXNoLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRhcmdldFkgPSAwLjU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHlEaWZmID0gdGFyZ2V0WSAtIHRoaXMubWVzaC5wb3NpdGlvbi55OwoKICAgICAgICAgICAgY29uc3QgbGlmdCA9IHlEaWZmICogMTAuMCAqIGR0OwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKz0gbGlmdDsKCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gucG9zaXRpb24ueSA+IDguMCkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSA4LjA7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKj0gLTAuNTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLm1lc2gucG9zaXRpb24ueSA8IC04LjApIHsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi55ID0gLTguMDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSAtMC41OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBGSVhFRDogSW1wcm92ZWQgYmFua2luZyB3aXRoIGh5c3RlcmVzaXMgdG8gcHJldmVudCBmYWNpbmcgZmxpcHMKLy8gRklYRUQ6IEltcHJvdmVkIGJhbmtpbmcgd2l0aCBoeXN0ZXJlc2lzIHRvIHByZXZlbnQgZmFjaW5nIGZsaXBzCiAgICAgICAgX3VwZGF0ZUJhbmtpbmcoZHQpIHsKICAgICAgICAgICAgY29uc3QgaW5wdXRMZW5TcSA9IHRoaXMuaW5wdXRWZWN0b3IubGVuZ3RoU3EoKTsKICAgICAgICAgICAgY29uc3QgdmVsTGVuU3EgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCk7CgogICAgICAgICAgICBsZXQgdGFyZ2V0WWF3ID0gdGhpcy50YXJnZXRZYXc7CiAgICAgICAgICAgIGxldCBzaG91bGRVcGRhdGVZYXcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDE6IEV4cGxpY2l0IEFpbSAoQWltIFN0aWNrIC8gU3dpcGUpCiAgICAgICAgICAgIGlmICh0aGlzLm92ZXJyaWRlQWltVmVjdG9yKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMub3ZlcnJpZGVBaW1WZWN0b3IueCwgdGhpcy5vdmVycmlkZUFpbVZlY3Rvci56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUFJJT1JJVFkgMjogTW92ZW1lbnQgSW5wdXQKICAgICAgICAgICAgZWxzZSBpZiAoaW5wdXRMZW5TcSA+IHRoaXMuZmFjaW5nRGVhZHpvbmUgKiB0aGlzLmZhY2luZ0RlYWR6b25lKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSBNYXRoLmF0YW4yKHRoaXMuaW5wdXRWZWN0b3IueCwgdGhpcy5pbnB1dFZlY3Rvci56KTsKICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZVlhdyA9IHRydWU7CiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIC8vIFBSSU9SSVRZIDM6IFZlbG9jaXR5IChEcmlmdGluZykKICAgICAgICAgICAgZWxzZSBpZiAodmVsTGVuU3EgPiB0aGlzLmZhY2luZ0RlYWR6b25lICogdGhpcy5mYWNpbmdEZWFkem9uZSkgewogICAgICAgICAgICAgICAgdGFyZ2V0WWF3ID0gTWF0aC5hdGFuMih0aGlzLnZlbG9jaXR5LngsIHRoaXMudmVsb2NpdHkueik7CiAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGVZYXcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB3ZSBzaG91bGQgdXBkYXRlLCBkbyBzby4gT3RoZXJ3aXNlIGtlZXAgbGFzdCB2YWxpZCB5YXcKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZVlhdykgewogICAgICAgICAgICAgICAgdGhpcy5sYXN0VmFsaWRZYXcgPSB0YXJnZXRZYXc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YXJnZXRZYXcgPSB0aGlzLmxhc3RWYWxpZFlhdzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU21vb3RoIFlhdyB3aXRoIHdyYXAtYXJvdW5kIGhhbmRsaW5nCiAgICAgICAgICAgIGxldCBkaWZmID0gdGFyZ2V0WWF3IC0gdGhpcy5jdXJyZW50WWF3OwogICAgICAgICAgICB3aGlsZSAoZGlmZiA+IE1hdGguUEkpIGRpZmYgLT0gTWF0aC5QSSAqIDI7CiAgICAgICAgICAgIHdoaWxlIChkaWZmIDwgLU1hdGguUEkpIGRpZmYgKz0gTWF0aC5QSSAqIDI7CgogICAgICAgICAgICBjb25zdCBzcGVlZFJhdGlvID0gTWF0aC5taW4oMS4wLCB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpIC8gdGhpcy5tYXhTcGVlZCk7CmNvbnN0IHR1cm5TcGVlZCA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKDguMCwgNC4wLCBzcGVlZFJhdGlvKTsgLy8gUmVkdWNlZCBmcm9tIDEyLjAvNi4wIHRvIHJlZHVjZSBmbGlwcGluZwoKICAgICAgICAgICAgLy8gUHJldmVudCBzdWRkZW4gc25hcHMgd2hlbiBkaWZmIGlzIHZlcnkgbGFyZ2UgKHRlbGVwb3J0L3Jlc2V0IHNjZW5hcmlvcykKICAgICAgICAgICAgY29uc3QgbWF4WWF3Q2hhbmdlID0gTWF0aC5QSSAqIGR0ICogdHVyblNwZWVkOwogICAgICAgICAgICBjb25zdCB5YXdDaGFuZ2UgPSBNYXRoLm1heCgtbWF4WWF3Q2hhbmdlLCBNYXRoLm1pbihtYXhZYXdDaGFuZ2UsIGRpZmYgKiBkdCAqIHR1cm5TcGVlZCkpOwoKICAgICAgICAgICAgdGhpcy5jdXJyZW50WWF3ICs9IHlhd0NoYW5nZTsKICAgICAgICAgICAgdGhpcy50YXJnZXRZYXcgPSB0YXJnZXRZYXc7CgogICAgICAgICAgICAvLyBCYW5raW5nCiAgICAgICAgICAgIGNvbnN0IGJhbmtTZW5zaXRpdml0eSA9IDAuODsKICAgICAgICAgICAgY29uc3QgbWF4QmFuayA9IDAuNzU7CgogICAgICAgICAgICBsZXQgdGFyZ2V0QmFuayA9IC1kaWZmICogYmFua1NlbnNpdGl2aXR5OwogICAgICAgICAgICB0YXJnZXRCYW5rID0gTWF0aC5tYXgoLW1heEJhbmssIE1hdGgubWluKG1heEJhbmssIHRhcmdldEJhbmspKTsKCiAgICAgICAgICAgIGNvbnN0IGJhbmtMZXJwID0gMS4wIC0gTWF0aC5wb3coMC4wMiwgZHQpOwogICAgICAgICAgICB0aGlzLmJhbmtpbmdBbW91bnQgKz0gKHRhcmdldEJhbmsgLSB0aGlzLmJhbmtpbmdBbW91bnQpICogYmFua0xlcnA7CgogICAgICAgICAgICAvLyBQaXRjaAogICAgICAgICAgICBjb25zdCBwaXRjaFNlbnNpdGl2aXR5ID0gMC4xOwogICAgICAgICAgICBjb25zdCBtYXhQaXRjaCA9IDEuMDsKCiAgICAgICAgICAgIGxldCB0YXJnZXRQaXRjaCA9IC10aGlzLnZlbG9jaXR5LnkgKiBwaXRjaFNlbnNpdGl2aXR5OwogICAgICAgICAgICB0YXJnZXRQaXRjaCA9IE1hdGgubWF4KC1tYXhQaXRjaCwgTWF0aC5taW4obWF4UGl0Y2gsIHRhcmdldFBpdGNoKSk7CgogICAgICAgICAgICBjb25zdCBwaXRjaExlcnAgPSAxLjAgLSBNYXRoLnBvdygwLjA1LCBkdCk7CiAgICAgICAgICAgIHRoaXMucGl0Y2hBbW91bnQgKz0gKHRhcmdldFBpdGNoIC0gdGhpcy5waXRjaEFtb3VudCkgKiBwaXRjaExlcnA7CgogICAgICAgICAgICAvLyBBcHBseSBSb3RhdGlvbgogICAgICAgICAgICBjb25zdCBmaW5hbFlhdyA9IHRoaXMuY3VycmVudFlhdyArIHRoaXMucm90YXRpb25PZmZzZXQ7CgogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5zZXRGcm9tQXhpc0FuZ2xlKF9wQXhpc1ksIGZpbmFsWWF3KTsKCiAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDEsIDAsIDApLCB0aGlzLnBpdGNoQW1vdW50KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BRdWF0KTsKCiAgICAgICAgICAgIF9wUXVhdC5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLCB0aGlzLmJhbmtpbmdBbW91bnQpOwogICAgICAgICAgICB0aGlzLm1lc2gucXVhdGVybmlvbi5tdWx0aXBseShfcFF1YXQpOwoKICAgICAgICAgICAgLy8gSWRsZSBCb2IKICAgICAgICAgICAgaWYgKHZlbExlblNxIDwgMC4xICYmICF0aGlzLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IERhdGUubm93KCkgKiAwLjAwMTU7CiAgICAgICAgICAgICAgICBjb25zdCBib2JQaXRjaCA9IE1hdGguc2luKHRpbWUpICogMC4wMzsKICAgICAgICAgICAgICAgIGNvbnN0IGJvYlJvbGwgPSBNYXRoLmNvcyh0aW1lICogMC43KSAqIDAuMDI7CgpfcEV1bGVyLnNldChib2JQaXRjaCwgMCwgYm9iUm9sbCk7CiAgICAgICAgICAgICAgICBfcFF1YXQuc2V0RnJvbUV1bGVyKF9wRXVsZXIpOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnF1YXRlcm5pb24ubXVsdGlwbHkoX3BRdWF0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9jaGVja1RhY2tsZVByZXNzdXJlKGR0KSB7CiAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNFbmdhZ2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuaW1tdW5pdHlUaW1lciA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEYXNoaW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIXRoaXMudGVhbSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CiAgICAgICAgICAgIGlmICghb3Bwb25lbnRUZWFtKSByZXR1cm47CgogICAgICAgICAgICBsZXQgdG90YWxQcmVzc3VyZSA9IDA7CiAgICAgICAgICAgIGxldCBlbmdhZ2VkQ291bnQgPSAwOwogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVSYWRpdXMgPSB0aGlzLnRhY2tsZVJhZGl1czsgCgogICAgICAgICAgICAvLyBGb3J3YXJkIHZlY3RvciBmb3Igc2hpZWxkaW5nIGNoZWNrCiAgICAgICAgICAgIF9wVmVjLmNvcHkoX3BBeGlzWikuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsgCgogICAgICAgICAgICBmb3IgKGNvbnN0IGVudGl0eSBvZiBvcHBvbmVudFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFlbnRpdHkubWVzaCB8fCBlbnRpdHkuc3RhdHVzLm5hcCA+IDAgfHwgZW50aXR5LnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oZW50aXR5Lm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCBlZmZlY3RpdmVSYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICBlbmdhZ2VkQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgUHJlc3N1cmUgSW50ZW5zaXR5ICgwIHRvIDEgYmFzZWQgb24gZGlzdGFuY2UpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJveGltaXR5ID0gMS4wIC0gKGRpc3QgLyBlZmZlY3RpdmVSYWRpdXMpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEJhc2UgUHJlc3N1cmUgZnJvbSBBVCBzdGF0CiAgICAgICAgICAgICAgICAgICAgbGV0IHByZXNzdXJlID0gZW50aXR5LmdldFN0YXQoJ0FUJykgKiBwcm94aW1pdHk7CgogICAgICAgICAgICAgICAgICAgIC8vIERpcmVjdGlvbmFsIFNoaWVsZGluZyAoQ29udGludW91cykKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b09wcCA9IGVudGl0eS5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZG90ID0gX3BWZWMuZG90KHRvT3BwKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJZiBvcHBvbmVudCBpcyBCRUhJTkQgKGRvdCA8IC0wLjIpLCBwcmVzc3VyZSBpcyByZWR1Y2VkIChTaGllbGRpbmcpCiAgICAgICAgICAgICAgICAgICAgbGV0IGlzU2hpZWxkZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoZG90IDwgLTAuMikgewogICAgICAgICAgICAgICAgICAgICAgICBwcmVzc3VyZSAqPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzU2hpZWxkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gVGVjaCBNb2RpZmllcnMgKENvbnRpbnVvdXMgYXBwbGljYXRpb24gY2hhbmNlKQogICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkudGVjaHMudGFja2xlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDwgZHQgKiAwLjUpIHRoaXMuYXBwbHlTdGF0dXMoJ3Zlbm9tJywgNS4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMS4yOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ3dpdGhlcicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCBkdCAqIDAuNSkgdGhpcy5hcHBseVN0YXR1cygnd2l0aGVyJywgNS4wLCAnRU4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3N1cmUgKj0gMS4yOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50aXR5LnRlY2hzLnRhY2tsZSA9PT0gJ2RyYWluJykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkcmFpbkFtdCA9IHByZXNzdXJlICogZHQgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHMuSFAgLT0gZHJhaW5BbXQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eS5zdGF0cy5IUCArPSBkcmFpbkFtdDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRvdGFsUHJlc3N1cmUgKz0gcHJlc3N1cmU7CgogICAgICAgICAgICAgICAgICAgIC8vIFZpc3VhbHM6IFNwYXJrcyBvY2Nhc2lvbmFsbHkgYmFzZWQgb24gcHJlc3N1cmUKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IGR0ICogNC4wICogcHJveGltaXR5KSB7IAogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuc3Bhd25DbGFzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWlkID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkubGVycChlbnRpdHkubWVzaC5wb3NpdGlvbiwgMC41KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pZC55ICs9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuc3Bhd25DbGFzaChtaWQsIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gT2NjYXNpb25hbCBTaGllbGQgVGV4dAogICAgICAgICAgICAgICAgICAgIGlmIChpc1NoaWVsZGVkICYmIE1hdGgucmFuZG9tKCkgPCBkdCAqIDEuMCAmJiBnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU0hJRUxEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiYmxvY2siKTsgLy8gVG9vIHNwYW1teSwgbWF5YmUganVzdCBzb3VuZCBsYXRlcgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5pc0VuZ2FnZWQgPSAoZW5nYWdlZENvdW50ID4gMCk7CgogICAgICAgICAgICBpZiAodGhpcy5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5jb3VudGVyVGltZXIgKz0gZHQ7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgRU4gRHJhaW4gKENvbnRpbnVvdXMpCiAgICAgICAgICAgICAgICAvLyBTY2FsaW5nOiAyMCBBVCBwcmVzc3VyZSAtPiBhcHByb3ggMTAgRU4gbG9zdCBwZXIgc2Vjb25kCiAgICAgICAgICAgICAgICBjb25zdCBkcmFpblJhdGUgPSB0b3RhbFByZXNzdXJlICogMC41OyAKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOIC09IGRyYWluUmF0ZSAqIGR0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgU3RydWdnbGUgSW50ZW5zaXR5IGZvciBQaHlzaWNzICgwLjAgdG8gMS4wKQogICAgICAgICAgICAgICAgLy8gTWF4IHN0cnVnZ2xlIGF0IHJvdWdobHkgMzAgcHJlc3N1cmUKICAgICAgICAgICAgICAgIHRoaXMuc3RydWdnbGVJbnRlbnNpdHkgPSBNYXRoLm1pbigxLjAsIHRvdGFsUHJlc3N1cmUgLyAzMC4wKTsKCiAgICAgICAgICAgICAgICAvLyBWaXN1YWwgRmVlZGJhY2sgZm9yIERyYWluIChBY2N1bXVsYXRlIHRvIGF2b2lkIHNwYW0pCiAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSArPSBkcmFpblJhdGUgKiBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSA+IDUuMCkgewogICAgICAgICAgICAgICAgICAgIGlmIChnYW1lLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bihgLSR7TWF0aC5mbG9vcih0aGlzLl9hY2N1bXVsYXRlZERhbWFnZSl9YCwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkRGFtYWdlID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSGludCBmb3IgcGxheWVyIGlmIGVuZ2FnZWQgdG9vIGxvbmcKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVuY291bnRlclRpbWVyID4gMS4wICYmIHRoaXMuZW5jb3VudGVyVGltZXIgPCAxLjEgJiYgdGhpcy50ZWFtLmlzSHVtYW4gJiYgdGhpcy50ZWFtLmFjdGl2ZVBsYXllciA9PT0gdGhpcykgewogICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJCUkVBSyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmVuY291bnRlclRpbWVyID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDw9IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuZnVtYmxlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9wZXJmb3JtSmVjaHRLbm9ja2JhY2soKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbUlkID0gdGhpcy50ZWFtLmlkID09PSAnaG9tZScgPyAnYXdheScgOiAnaG9tZSc7CiAgICAgICAgICAgIGNvbnN0IG9wcG9uZW50VGVhbSA9IGdhbWUudGVhbXNbb3Bwb25lbnRUZWFtSWRdOwoKICAgICAgICAgICAgaWYgKCFvcHBvbmVudFRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHJhbmdlID0gNi4wOwogICAgICAgICAgICBjb25zdCBmb3JjZSA9IDI1LjA7CgogICAgICAgICAgICBpZiAoZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJKRUNIVCBTSE9UISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImdvYWwiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgb3Bwb25lbnRUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ocC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy5tZXNoLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBkaXIueSA9IDAuNTsKICAgICAgICAgICAgICAgICAgICBkaXIubm9ybWFsaXplKCk7CgpwLnZlbG9jaXR5LmFkZChkaXIubXVsdGlwbHlTY2FsYXIoZm9yY2UpKTsKCiAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAyLjA7IC8vIEVuc3VyZSB0aGV5IHN0YXkgZG93bgogICAgICAgICAgICAgICAgICAgIHAuaXNEYXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVhY3RBY3Rpb24gPSBwLmFjdGlvbnMgJiYgcC5hY3Rpb25zWydyZWFjdCddOwogICAgICAgICAgICAgICAgICAgIGlmIChyZWFjdEFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZWFjdEFjdGlvbi5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVhY3RBY3Rpb24uY2xhbXBXaGVuRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBwLnBsYXlPbmVTaG90KCdyZWFjdCcsIDAuMSk7Cn0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2gnLCAwLjUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTTUFDSyEiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUudHJpZ2dlckltcGFjdCkgZ2FtZS50cmlnZ2VySW1wYWN0KDAuMTUsICdzaGF0dGVyJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVtYmxlKCkgewogICAgICAgICAgICBjb25zb2xlLmxvZygiRlVNQkxFISBFTiBEZXBsZXRlZC4iKTsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQgJiYgdGhpcy5tZXNoKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJDUkFTSCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zdHVuVGltZXIgPSAxLjU7CgogICAgICAgICAgICBjb25zdCBiYWNrRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgYmFja0Rpci54ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgYmFja0Rpci56ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgYmFja0Rpci5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKGJhY2tEaXIubXVsdGlwbHlTY2FsYXIoMTIuMCkpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgaWYgKGJhbGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlamVjdERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKE1hdGgucmFuZG9tKCktMC41LCAwLjgsIE1hdGgucmFuZG9tKCktMC41KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICBiYWxsLnNob290KGVqZWN0RGlyLCA2LjAsICdub25lJyk7CnRoaXMubG9zZUJhbGwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbkNhdGNoID0gZmFsc2U7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZGFzaCh4LCB6KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzRGFzaGluZyB8fCB0aGlzLmRhc2hDb29sZG93biA+IDApIHJldHVybjsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKCiAgICAgICAgICAgIC8vIE9GRkVOU0U6IEJSRUFLIFRBQ0tMRQogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsICYmIHRoaXMuaXNFbmdhZ2VkKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjb3N0ID0gMTU7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEVOIDwgY29zdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkZBSUxFRCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mdW1ibGUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RU4gLT0gY29zdDsKICAgICAgICAgICAgICAgIHRoaXMuaXNEYXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hDb29sZG93biA9IDIuMDsKICAgICAgICAgICAgICAgIHRoaXMuZGFzaFR5cGUgPSAnYnJlYWsnOwoKX3BWZWMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbih0aGlzLm1lc2gucXVhdGVybmlvbik7CnRoaXMudmVsb2NpdHkuYWRkKF9wVmVjLm11bHRpcGx5U2NhbGFyKDEwLjApKTsgLy8gTmVyZmVkIGZyb20gMTUuMCBmb3IgcmVhbGlzbQoKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBvcHBvbmVudFRlYW1JZCA9IHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CgogICAgICAgICAgICAgICAgb3Bwb25lbnRUZWFtLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSB0aGlzLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyhwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgdGhpcy50YWNrbGVSYWRpdXMgKiAxLjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVzaERpciA9IHAubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1Yih0aGlzLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBwdXNoRGlyLnkgPSAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuYWRkKHB1c2hEaXIubXVsdGlwbHlTY2FsYXIoMTUuMCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdHVuVGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2gnLCAwLjIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiU1RVTiEiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKaWYgKGdhbWUuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJSRUFLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAovLyBORVc6IFNwYXduIEJyZWFrIEdseXBoIChFeHBsb3NpdmUgQnVyc3QpCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5nbHlwaE1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lLmdseXBoTWFuYWdlci5zcGF3bignc3RhdHVzJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgbGlmZTogMC41LAogICAgICAgICAgICAgICAgICAgICAgICByb3RhdGlvblNwZWVkOiA4LjAsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IDMuMCwKICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WTogMC41CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKLy8gUGFydGljbGUgQnVyc3QgKEJyZWFrIFRhY2tsZSkKLy8gUGFydGljbGUgQnVyc3QgKEJyZWFrIFRhY2tsZSkKICAgICAgICAgICAgICAgIGlmIChnYW1lLnBhcnRpY2xlTWFuYWdlcikgewpmb3IobGV0IGk9MDsgaTwzMDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAyLjUgfSk7CiAgICAgICAgICAgICAgICAgICAgLy8gQnViYmxlIEJ1cnN0CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBidWJibGVQb3MgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSoyLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMikpOwogICAgICAgICAgICAgICAgICAgICAgICBnYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgYnViYmxlUG9zLCB7IHNjYWxlOiAwLjIgKyBNYXRoLnJhbmRvbSgpICogMC40IH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZ2FtZS50cmlnZ2VySW1wYWN0KSBnYW1lLnRyaWdnZXJJbXBhY3QoMC4xNSwgJ2hlYXZ5Jyk7CgogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE9GRkVOU0U6IFNQUklOVAogICAgICAgICAgICBpZiAodGhpcy5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjb3N0ID0gNTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRFTiA8IGNvc3QpIHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJOTyBFTiEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEVOIC09IGNvc3Q7CiAgICAgICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUaW1lID0gMC40OwogICAgICAgICAgICAgICAgdGhpcy5kYXNoQ29vbGRvd24gPSAxLjU7CiAgICAgICAgICAgICAgICB0aGlzLmRhc2hUeXBlID0gJ3NwcmludCc7Cgpjb25zdCBidXJzdERpciA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGlmIChidXJzdERpci5sZW5ndGhTcSgpIDwgMC4xKSBidXJzdERpci5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKTsKCnRoaXMudmVsb2NpdHkuYWRkKGJ1cnN0RGlyLm11bHRpcGx5U2NhbGFyKDEyLjApKTsgLy8gTmVyZmVkIGZyb20gMTUuMAogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcpOwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZEZvdkltcHVsc2UoMjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJEQVNIISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gREVGRU5TRTogQkxPQ0sgLyBUQUNLTEUKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBsZXQgaXNCbG9ja0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGJhbGwgJiYgYmFsbC5tZXNoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgOC4wICYmIGJhbGwubWVzaC5wb3NpdGlvbi55ID4gMi41KSB7CiAgICAgICAgICAgICAgICAgICAgaXNCbG9ja0NvbnRleHQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmlzRGFzaGluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuZGFzaFRpbWUgPSB0aGlzLmRhc2hUb3RhbFRpbWU7CiAgICAgICAgICAgIHRoaXMuZGFzaENvb2xkb3duID0gMS41OwoKICAgICAgICAgICAgY29uc3QgbGVuID0gTWF0aC5zcXJ0KHgqeCArIHoqeik7CiAgICAgICAgICAgIGNvbnN0IG54ID0gKGxlbiA+IDApID8geC9sZW4gOiAwOwogICAgICAgICAgICBjb25zdCBueiA9IChsZW4gPiAwKSA/IHovbGVuIDogMDsKCmlmIChsZW4gPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBTbW9vdGggdHVybiBmb3IgZGFzaCBpbnN0ZWFkIG9mIHNuYXAKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0WWF3ID0gTWF0aC5hdGFuMihueCwgbnopOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc0Jsb2NrQ29udGV4dCkgewogICAgICAgICAgICAgICAgdGhpcy5kYXNoVHlwZSA9ICd2ZXJ0aWNhbCc7CgogICAgICAgICAgICAgICAgY29uc3QgZGlyVG9CYWxsID0gYmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBkaXJUb0JhbGwueSA9IDA7CgogICAgICAgICAgICAgICAgaWYgKGRpclRvQmFsbC5sZW5ndGhTcSgpID4gMC4wMSkgewogICAgICAgICAgICAgICAgICAgIGRpclRvQmFsbC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhc2hWZWMuY29weShkaXJUb0JhbGwpLm11bHRpcGx5U2NhbGFyKDguMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZGFzaFZlYy5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgY2F0Y2hBY3Rpb24gPSB0aGlzLmFjdGlvbnNbJ2NhdGNoJ107CiAgICAgICAgICAgICAgICBpZiAoY2F0Y2hBY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICBjYXRjaEFjdGlvbi5zZXRMb29wKFRIUkVFLkxvb3BPbmNlKTsKICAgICAgICAgICAgICAgICAgICBjYXRjaEFjdGlvbi5jbGFtcFdoZW5GaW5pc2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hBY3Rpb24udGltZVNjYWxlID0gMS41OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wbGF5KCdjYXRjaCcsIDAuMSk7CgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTE9DSyEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJkZWZhdWx0Iik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5kYXNoVHlwZSA9ICdob3Jpem9udGFsJzsKICAgICAgICAgICAgICAgIHRoaXMuX2hhc0hpdFRhY2tsZSA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IHZlbG9jaXR5IGltcHVsc2UgaW4gZGFzaCBkaXJlY3Rpb24KLy8gQXBwbHkgdmVsb2NpdHkgaW1wdWxzZSBpbiBkYXNoIGRpcmVjdGlvbgogICAgICAgICAgICAgICAgX3BWZWMuc2V0KG54LCAwLCBueik7CiAgICAgICAgICAgICAgICBpZiAoX3BWZWMubGVuZ3RoU3EoKSA8IDAuMSkgewogICAgICAgICAgICAgICAgICAgIF9wVmVjLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgfQp0aGlzLnZlbG9jaXR5LmFkZChfcFZlYy5tdWx0aXBseVNjYWxhcigxNC4wKSk7IC8vIE5lcmZlZCBmcm9tIDIwLjAKCiAgICAgICAgICAgICAgICBjb25zdCBsdW5nZUFjdGlvbiA9IHRoaXMuYWN0aW9uc1sndGhyb3cnXTsKICAgICAgICAgICAgICAgIGlmIChsdW5nZUFjdGlvbikgewogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLnNldExvb3AoVEhSRUUuTG9vcE9uY2UpOwogICAgICAgICAgICAgICAgICAgIGx1bmdlQWN0aW9uLmNsYW1wV2hlbkZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBsdW5nZUFjdGlvbi50aW1lU2NhbGUgPSAyLjA7CiAgICAgICAgICAgICAgICB9CnRoaXMucGxheSgndGhyb3cnLCAwLjEpOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcpOwoKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCkgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QoMC4wNSwgJ2RlZmF1bHQnKTsKICAgICAgICAgICAgfQoKaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRGb3ZJbXB1bHNlKDEwKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuMyk7IAogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIERhc2ggRWZmZWN0CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXNoUG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICBkYXNoUG9zLnkgKz0gMS4wOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgZGFzaFBvcywgeyBzY2FsZTogMS41LCBsaWZlOiAwLjMgfSk7CiAgICAgICAgICAgICAgICAvLyBTcGVlZCBsaW5lcwogICAgICAgICAgICAgICAgY29uc3QgYmFjayA9IHRoaXMudmVsb2NpdHkuY2xvbmUoKS5ub3JtYWxpemUoKS5uZWdhdGUoKTsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDM7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBkYXNoUG9zLmNsb25lKCkuYWRkKGJhY2subXVsdGlwbHlTY2FsYXIoTWF0aC5yYW5kb20oKSkpOwogICAgICAgICAgICAgICAgICAgIHAueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2Rhc2hfc3RyZWFtJywgcCwgeyBzY2FsZTogMS41IH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY3JlYXRlSFBCYXIoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IG5ldyBUSFJFRS5Hcm91cCgpOwoKICAgICAgICAgICAgY29uc3QgYmdHZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjIsIDAuMTUpOwogICAgICAgICAgICBjb25zdCBiZ01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwMDAwMCwgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgZGVwdGhUZXN0OiBmYWxzZSB9KTsKICAgICAgICAgICAgY29uc3QgYmcgPSBuZXcgVEhSRUUuTWVzaChiZ0dlbywgYmdNYXQpOwogICAgICAgICAgICBjb250YWluZXIuYWRkKGJnKTsKCiAgICAgICAgICAgIGNvbnN0IGZpbGxHZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjE2LCAwLjExKTsKICAgICAgICAgICAgZmlsbEdlby50cmFuc2xhdGUoMC41OCwgMCwgMCk7CiAgICAgICAgICAgIGNvbnN0IGZpbGxNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgwMGZmMDAsIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIGRlcHRoVGVzdDogZmFsc2UgfSk7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsID0gbmV3IFRIUkVFLk1lc2goZmlsbEdlbywgZmlsbE1hdCk7CiAgICAgICAgICAgIHRoaXMuaHBCYXJGaWxsLnBvc2l0aW9uLnNldCgtMC41OCwgMCwgMC4wMSk7CiAgICAgICAgICAgIGNvbnRhaW5lci5hZGQodGhpcy5ocEJhckZpbGwpOwoKICAgICAgICAgICAgdGhpcy5ocEJhciA9IGNvbnRhaW5lcjsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5ocEJhcik7CiAgICAgICAgfQoKX3VwZGF0ZUhQQmFyKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaHBCYXIgfHwgIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gVmlzaWJpbGl0eSBDaGVjazogT25seSBzaG93IGlmIG1lc2ggaXMgdmlzaWJsZSBBTkQgaW4gQWN0aXZlL1ByYWN0aWNlIHN0YXRlcwogICAgICAgICAgICBpZiAoIXRoaXMubWVzaC52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgYWxsb3dlZFN0YXRlID0gZ2FtZSAmJiAoZ2FtZS5zdGF0ZSA9PT0gJ2FjdGl2ZScgfHwgZ2FtZS5zdGF0ZSA9PT0gJ2tpY2tvZmYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghYWxsb3dlZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmhwQmFyLnBvc2l0aW9uLmNvcHkodGhpcy5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5ocEJhci5wb3NpdGlvbi55ICs9IDIuMjsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgdGhpcy5ocEJhci5sb29rQXQod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYS5wb3NpdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHBjdCA9IE1hdGgubWF4KDAsIHRoaXMuc3RhdHMuSFAgLyB0aGlzLnN0YXRzLm1heEhQKTsKICAgICAgICAgICAgdGhpcy5ocEJhckZpbGwuc2NhbGUuc2V0WChwY3QpOwoKICAgICAgICAgICAgaWYgKHBjdCA+IDAuNSkgdGhpcy5ocEJhckZpbGwubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4MDBmZjAwKTsKICAgICAgICAgICAgZWxzZSBpZiAocGN0ID4gMC4yNSkgdGhpcy5ocEJhckZpbGwubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZmZjAwKTsKICAgICAgICAgICAgZWxzZSB0aGlzLmhwQmFyRmlsbC5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZjAwMDApOwoKICAgICAgICAgICAgLy8gSGlkZSBpZiBmdWxsIEhQIHRvIHJlZHVjZSBjbHV0dGVyLCB1bmxlc3MgaW4gcHJhY3RpY2UgbW9kZQogICAgICAgICAgICBjb25zdCBhbHdheXNTaG93ID0gZ2FtZSAmJiBnYW1lLmdhbWVNb2RlID09PSAncHJhY3RpY2UnOwogICAgICAgICAgICB0aGlzLmhwQmFyLnZpc2libGUgPSAocGN0IDwgMC45OCB8fCBhbHdheXNTaG93KTsKICAgICAgICB9CgogICAgICAgIGdhaW5FeHAoYW1vdW50KSB7CiAgICAgICAgICAgIGlmICghd2luZG93LmZsdXguZ2FtZUluc3RhbmNlIHx8IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zdGF0ZSAhPT0gJ2FjdGl2ZScpIHJldHVybjsKCiAgICAgICAgICAgIHRoaXMuZXhwICs9IGFtb3VudDsKCiAgICAgICAgICAgIGlmICh0aGlzLmV4cCA+PSB0aGlzLm5leHRMZXZlbEV4cCkgewogICAgICAgICAgICAgICAgdGhpcy5sZXZlbFVwKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGxldmVsVXAoKSB7CiAgICAgICAgICAgIHRoaXMubGV2ZWwrKzsKICAgICAgICAgICAgdGhpcy5leHAgLT0gdGhpcy5uZXh0TGV2ZWxFeHA7CiAgICAgICAgICAgIHRoaXMubmV4dExldmVsRXhwID0gTWF0aC5mbG9vcih0aGlzLm5leHRMZXZlbEV4cCAqIDEuNSk7CgogICAgICAgICAgICBjb25zdCBrZXlzID0gWydIUCcsICdFTicsICdBVCcsICdQQScsICdCTCcsICdTSCcsICdDQScsICdTUCddOwoKICAgICAgICAgICAgY29uc3QgaHBHYWluID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMjApICsgMTA7CiAgICAgICAgICAgIHRoaXMuc3RhdHMubWF4SFAgKz0gaHBHYWluOwogICAgICAgICAgICB0aGlzLnN0YXRzLkhQID0gdGhpcy5zdGF0cy5tYXhIUDsKCiAgICAgICAgICAgIGtleXMuZm9yRWFjaChrID0+IHsKICAgICAgICAgICAgICAgIGlmIChrID09PSAnSFAnKSByZXR1cm47CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdhaW4gPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAyKSArIDE7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0c1trXSArPSBnYWluOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwoKICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5yb2xlfSByZWFjaGVkIExldmVsICR7dGhpcy5sZXZlbH0hYCk7CgogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCAmJiB0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkxFVkVMIFVQISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NoZWNrVGFja2xlQ29sbGlzaW9uKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGVhbSB8fCB0aGlzLl9oYXNIaXRUYWNrbGUpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtSWQgPSB0aGlzLnRlYW0uaWQgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgY29uc3Qgb3Bwb25lbnRUZWFtID0gZ2FtZS50ZWFtc1tvcHBvbmVudFRlYW1JZF07CgogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBvbmVudFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCkgY29udGludWU7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwoKaWYgKGRpc3QgPCAzLjApIHsgLy8gSW5jcmVhc2VkIGZyb20gMi4wIGZvciBlYXNpZXIgaGl0cwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc29sdmVUYWNrbGVIaXQob3BwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oYXNIaXRUYWNrbGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCl9yZXNvbHZlVGFja2xlSGl0KG9wcCkgewogICAgICAgICAgICB0aGlzLnBsYXkoJ2lkbGUnLCAwLjIpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgndGFja2xlJyk7CiAgICAgICAgICAgIH0KCmNvbnN0IGF0ID0gdGhpcy5nZXRTdGF0KCdBVCcpOwogICAgICAgICAgICBsZXQgZGFtYWdlID0gYXQgKiAzLjA7CgogICAgICAgICAgICBpZiAodGhpcy50ZWNocy50YWNrbGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgIG9wcC5hcHBseVN0YXR1cygndmVub20nLCAxMC4wKTsKICAgICAgICAgICAgICAgIGRhbWFnZSArPSA1OwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudGVjaHMudGFja2xlID09PSAnd2l0aGVyJykgewogICAgICAgICAgICAgICAgb3BwLmFwcGx5U3RhdHVzKCd3aXRoZXInLCAxMC4wLCAnRU4nKTsKICAgICAgICAgICAgICAgIGRhbWFnZSArPSA1OwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudGVjaHMudGFja2xlID09PSAnZHJhaW4nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLkhQICs9IDIwOwogICAgICAgICAgICAgICAgb3BwLnN0YXRzLkhQIC09IDIwOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiRFJBSU4iLCB0aGlzLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgb3BwLmN1cnJlbnRFTiAtPSBkYW1hZ2U7CgppZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgIC8vIFJlbW92ZWQgIkVOIiBzdWZmaXggZm9yIGNsZWFuZXIgbG9vawogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oYCR7TWF0aC5mbG9vcihkYW1hZ2UpfWAsIG9wcC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQkFNISIsIG9wcC5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9wcC5jdXJyZW50RU4gPD0gMCkgewogICAgICAgICAgICAgICAgICAgIG9wcC5mdW1ibGUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgb3BwLnN0dW5UaW1lciA9IDAuNTsKICAgICAgICAgICAgICAgICAgICBvcHAucGxheU9uZVNob3QoJ3JlYWN0JywgMC4xKTsKfQoKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlY2hzLnRhY2tsZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlclRlY2hFdmVudCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VyVGVjaEV2ZW50KHRoaXMsIHRoaXMudGVjaHMudGFja2xlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBvcHAuc3R1blRpbWVyID0gMS4wOwogICAgICAgICAgICAgICAgb3BwLnBsYXlPbmVTaG90KCdyZWFjdCcsIDAuMSk7CmlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU01BQ0shIiwgb3BwLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgcHVzaERpciA9IG9wcC5tZXNoLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIHB1c2hEaXIueSA9IDAuMjsKICAgICAgICAgICAgb3BwLnZlbG9jaXR5LmFkZChwdXNoRGlyLm11bHRpcGx5U2NhbGFyKDEyLjApKTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UudHJpZ2dlckltcGFjdCkgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QoMC4xLCAnaGVhdnknKTsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmFNYW5hZ2VyKSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjgpOwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNwYXduQ2xhc2gpIHsKY29uc3QgbWlkID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG9wcC5tZXNoLnBvc2l0aW9uKS5tdWx0aXBseVNjYWxhcigwLjUpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnNwYXduQ2xhc2gobWlkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKLy8gQnViYmxlIEJ1cnN0IChUYWNrbGUgSGl0KQovLyBCdWJibGUgQnVyc3QgKFRhY2tsZSBIaXQpCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBtaWQgPSB0aGlzLm1lc2gucG9zaXRpb24uY2xvbmUoKS5sZXJwKG9wcC5tZXNoLnBvc2l0aW9uLCAwLjUpOwogICAgICAgICAgICAgICAgbWlkLnkgKz0gMS4wOwogICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MzA7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ1YmJsZVBvcyA9IG1pZC5jbG9uZSgpLmFkZChuZXcgVEhSRUUuVmVjdG9yMygoTWF0aC5yYW5kb20oKS0wLjUpKjEuNSwgKE1hdGgucmFuZG9tKCktMC41KSoxLjUsIChNYXRoLnJhbmRvbSgpLTAuNSkqMS41KSk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgYnViYmxlUG9zLCB7IHNjYWxlOiAwLjE1ICsgTWF0aC5yYW5kb20oKSAqIDAuMzUgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9hcHBseUdvYWxDcmVhc2UoZHQpIHsKCmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxzID0gWwogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbERpc3QpLAogICAgICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgLWdvYWxEaXN0KQogICAgICAgICAgICBdOwoKCiAgICAgICAgICAgIGNvbnN0IHJhZGl1cyA9IDEwLjA7CgogICAgICAgICAgICBnb2Fscy5mb3JFYWNoKGdvYWwgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZHggPSB0aGlzLm1lc2gucG9zaXRpb24ueCAtIGdvYWwueDsKICAgICAgICAgICAgICAgIGNvbnN0IGR6ID0gdGhpcy5tZXNoLnBvc2l0aW9uLnogLSBnb2FsLno7CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBkeCpkeCArIGR6KmR6OwoKICAgICAgICAgICAgICAgIGlmIChkaXN0U3EgPCByYWRpdXMgKiByYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RTcSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVzaFggPSBkaXN0ID4gMCA/IGR4IC8gZGlzdCA6IDE7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVzaFogPSBkaXN0ID4gMCA/IGR6IC8gZGlzdCA6IDA7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcmNlID0gNTAuMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKz0gcHVzaFggKiBmb3JjZSAqIGR0OwogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueiArPSBwdXNoWiAqIGZvcmNlICogZHQ7CgogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFkaXVzIC0gMC41KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNsYW1wUmF0aW8gPSByYWRpdXMgLyAoZGlzdCArIDAuMDAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnggPSBnb2FsLnggKyBkeCAqIGNsYW1wUmF0aW87CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi56ID0gZ29hbC56ICsgZHogKiBjbGFtcFJhdGlvOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LlBsYXllciA9IFBsYXllcjsKfSkoKTsK","main.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgLy8gTmFtZXNwYWNlCiAgICB3aW5kb3cuZmx1eCA9IHdpbmRvdy5mbHV4IHx8IHt9OwogICAgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyA9IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgfHwgW107CgogICAgLy8gQ29uZmlnCmNvbnN0IF9jb25maWcgPSB7CiAgICAgICAgaW50ZXJuYWxXaWR0aDogMzYwLAogICAgICAgIGludGVybmFsSGVpZ2h0OiA2NDAsCiAgICAgICAgYmdDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgZm9nQ29sb3I6IDB4MDAxZTM2LAogICAgICAgIGZvZ0RlbnNpdHk6IDAuMDAwMSwgLy8gRHJhc3RpY2FsbHkgcmVkdWNlZCB0byBlbnN1cmUgdmlzaWJpbGl0eQogICAgICAgIGFyZW5hUmFkaXVzOiA0OC4wCiAgICB9OwoKICAgIC8vIEdsb2JhbHMKLy8gR2xvYmFscwogICAgY29uc3QgX2lucHV0ID0geyB4OiAwLCB5OiAwIH07IC8vIElucHV0IHN0YXRlCiAgICAKICAgIC8vIFNoYWRlciBVbmlmb3JtcwogICAgY29uc3QgX2FyZW5hVW5pZm9ybXMgPSB7CiAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICB1SW1wYWN0UG9zOiB7IHZhbHVlOiBuZXcgVEhSRUUuVmVjdG9yMygpIH0sCiAgICAgICAgdUltcGFjdFN0cjogeyB2YWx1ZTogMC4wIH0KICAgIH07CiAgICBjb25zdCBfcGFydGljbGVVbmlmb3JtcyA9IHsKICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9CiAgICB9OwoKICAgIC8vIEV4cG9zZSBJbXBhY3QgVHJpZ2dlcgogICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0ID0gZnVuY3Rpb24ocG9zLCBzdHJlbmd0aCkgewogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RQb3MudmFsdWUuY29weShwb3MpOwogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RTdHIudmFsdWUgPSBzdHJlbmd0aCAqIDIuMDsgLy8gU2NhbGUgdXAgZm9yIHZpc2liaWxpdHkKICAgIH07Ci8vIF9pbnB1dCBhbHJlYWR5IGRlY2xhcmVkIGFib3ZlCiAgICBjb25zdCBfdGVtcFZlYzEgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBSZXVzYWJsZSBmb3IgcGh5c2ljcy9sb2dpYwogICAgY29uc3QgX3RlbXBWZWMyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsgLy8gUmV1c2FibGUgZm9yIHBoeXNpY3MvbG9naWMKICAgIGxldCBfc2NlbmUsIF9jYW1lcmEsIF9yZW5kZXJlciwgX2Nsb2NrOwogICAgbGV0IF9ob21lVGVhbSwgX2F3YXlUZWFtOwogICAgbGV0IF9iYWxsOwogICAgbGV0IF9nYW1lTWFuYWdlcjsKICAgIGxldCBfbWVudU1hbmFnZXI7CiAgICBsZXQgX2F1ZGlvTWFuYWdlcjsKCiAgICBsZXQgX2NhbWVyYU1hbmFnZXI7CiAgICBsZXQgX3dhdGVyT3ZlcmxheTsKICAgIGxldCBfbGlnaHRTaGFmdHM7CiAgICBsZXQgX3N0YWRpdW07CiAgICBsZXQgX2dseXBoTWFuYWdlcjsKCiAgICAvLyBJTVBST1ZFRDogU2V0dGluZ3Mgb2JqZWN0CiAgICBjb25zdCBfc2V0dGluZ3MgPSB7CiAgICAgICAgam95c3RpY2tTZW5zaXRpdml0eTogMS4wLAogICAgICAgIGFpbUFzc2lzdDogdHJ1ZSwKICAgICAgICBjYW1lcmFTaGFrZTogdHJ1ZSwKICAgICAgICBoaXRTdG9wOiB0cnVlLAogICAgICAgIGludmVydENhbWVyYTogZmFsc2UsCiAgICAgICAgYXV0b1JlY2VudGVyOiB0cnVlCiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRGVidWcgSU8gQnJpZGdlIChleHBvc2VkIGZvciBEZXZUb29scyBKU09OIHNuYXBzaG90cykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIHx8IHt9OwogICAgX2RlYnVnSU8uc2V0dGluZ3MgPSBfc2V0dGluZ3M7CiAgICBfZGVidWdJTy5pbnB1dCA9IF9kZWJ1Z0lPLmlucHV0IHx8IHt9OwogICAgX2RlYnVnSU8ucGVyZiA9IF9kZWJ1Z0lPLnBlcmYgfHwgeyBmcmFtZTogMCwgcmF3RHQ6IDAsIGR0OiAwLCBmcHM6IDAsIGF2Z0ZwczogMCB9OwoKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIFRvdWNoIGhlbHBlcnMgKG11bHRpLXRvdWNoIHNhZmUpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGZ1bmN0aW9uIF9maW5kVG91Y2hCeUlkKHRvdWNoTGlzdCwgaWQpIHsKICAgICAgICBpZiAoaWQgPT09IG51bGwgfHwgaWQgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgICAgaWYgKCF0b3VjaExpc3QpIHJldHVybiBudWxsOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdG91Y2hMaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IHQgPSB0b3VjaExpc3RbaV07CiAgICAgICAgICAgIGlmICh0ICYmIHQuaWRlbnRpZmllciA9PT0gaWQpIHJldHVybiB0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBfZW5kZWRUb3VjaEJ5SWQoY2hhbmdlZFRvdWNoZXMsIGlkKSB7CiAgICAgICAgaWYgKGlkID09PSBudWxsIHx8IGlkID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgICAgIGlmICghY2hhbmdlZFRvdWNoZXMpIHJldHVybiBudWxsOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hhbmdlZFRvdWNoZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgdCA9IGNoYW5nZWRUb3VjaGVzW2ldOwogICAgICAgICAgICBpZiAodCAmJiB0LmlkZW50aWZpZXIgPT09IGlkKSByZXR1cm4gdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGluaXQoKSB7CiAgICAgICAgX2NvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnYW1lLWNvbnRhaW5lcicpOwoKICAgICAgICAvLyAxLiBTY2VuZQogICAgICAgIF9zY2VuZSA9IG5ldyBUSFJFRS5TY2VuZSgpOwogICAgICAgIF9zY2VuZS5iYWNrZ3JvdW5kID0gbmV3IFRIUkVFLkNvbG9yKF9jb25maWcuYmdDb2xvcik7CiAgICAgICAgX3NjZW5lLmZvZyA9IG5ldyBUSFJFRS5Gb2dFeHAyKF9jb25maWcuZm9nQ29sb3IsIF9jb25maWcuZm9nRGVuc2l0eSk7CgogICAgICAgIC8vIDIuIENhbWVyYQogICAgICAgIGNvbnN0IGFzcGVjdCA9IF9jb25maWcuaW50ZXJuYWxXaWR0aCAvIF9jb25maWcuaW50ZXJuYWxIZWlnaHQ7Cl9jYW1lcmEgPSBuZXcgVEhSRUUuUGVyc3BlY3RpdmVDYW1lcmEoNjAsIGFzcGVjdCwgMC4xLCA1MDApOwpfY2FtZXJhLnBvc2l0aW9uLnNldCgwLCAxNCwgMjIpOwogICAgICAgIF9jYW1lcmEubG9va0F0KDAsIDAsIDApOwogICAgICAgIF9zY2VuZS5hZGQoX2NhbWVyYSk7IC8vIEVuc3VyZSBjYW1lcmEgaXMgaW4gc2NlbmUgZm9yIGNoaWxkcmVuIHRvIHJlbmRlcgoKICAgICAgICAvLyAzLiBSZW5kZXJlcgovLyAzLiBSZW5kZXJlcgogICAgICAgIF9yZW5kZXJlciA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlcmVyKHsgCiAgICAgICAgICAgIGFudGlhbGlhczogZmFsc2UsCiAgICAgICAgICAgIHBvd2VyUHJlZmVyZW5jZTogImhpZ2gtcGVyZm9ybWFuY2UiLAogICAgICAgICAgICBwcmVjaXNpb246ICJtZWRpdW1wIiwgLy8gTW9iaWxlIG9wdGltaXphdGlvbjogZmFzdGVyIHNoYWRlcnMKICAgICAgICAgICAgc3RlbmNpbDogZmFsc2UsICAgICAgIC8vIERpc2FibGUgc3RlbmNpbCBidWZmZXIgaWYgbm90IHVzZWQKICAgICAgICAgICAgZGVwdGg6IHRydWUKICAgICAgICB9KTsKICAgICAgICBfcmVuZGVyZXIuc2V0UGl4ZWxSYXRpbygxKTsgLy8gRm9yY2UgMToxIHBpeGVsIHJhdGlvLCB3ZSBoYW5kbGUgc2NhbGluZyB2aWEgc2V0U2l6ZQogICAgICAgIF9yZW5kZXJlci5hdXRvQ2xlYXIgPSBmYWxzZTsgLy8gV2UgbWFuYWdlIGNsZWFyaW5nIHZpYSBiYWNrZ3JvdW5kIG9yIG1hbnVhbCBjYWxscyBpZiBuZWVkZWQgKHRob3VnaCBzY2VuZS5iYWNrZ3JvdW5kIGhhbmRsZXMgY29sb3IpCiAgICAgICAgLy8gRXhwb3NlIHJlbmRlcmVyIGZvciBEZXZUb29scwogICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIF9nYW1lTWFuYWdlci5yZW5kZXJlciA9IF9yZW5kZXJlcjsgCiAgICAgICAgZWxzZSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPSB7IHJlbmRlcmVyOiBfcmVuZGVyZXIgfTsgLy8gVGVtcCBob29rCl9jb250YWluZXIuYXBwZW5kQ2hpbGQoX3JlbmRlcmVyLmRvbUVsZW1lbnQpOwoKLy8gLS0tIFZpZGVvIE92ZXJsYXkgRW5mb3JjZW1lbnQgLS0tCiAgICAgICAgLy8gLS0tIE92ZXJsYXkgVmlkZW8gTG9naWMgUmVtb3ZlZCAoU3dpdGNoZWQgdG8gR0lGKSAtLS0KICAgICAgICAvLyA1LiBFbnZpcm9ubWVudAogICAgICAgIGNyZWF0ZVBhcnRpY2xlcygpOwogICAgICAgIGNyZWF0ZUFyZW5hKCk7CiAgICAgICAgY3JlYXRlSG9sb2dyYXBoaWNSaW5ncygpOwovLyA1LjUgR2FtZSBNYW5hZ2VyCl9nYW1lTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5HYW1lTWFuYWdlcihfc2NlbmUsICd1aS1sYXllcicsIF9jYW1lcmEsIF9yZW5kZXJlcik7CiAgICAgICAgCiAgICAgICAgLy8gNS41LjEgQXVkaW8gTWFuYWdlcgogICAgICAgIF9hdWRpb01hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguQXVkaW9NYW5hZ2VyKCk7CiAgICAgICAgX2dhbWVNYW5hZ2VyLmF1ZGlvTWFuYWdlciA9IF9hdWRpb01hbmFnZXI7CgogICAgICAgIC8vIDUuNiBDYW1lcmEgTWFuYWdlcgogICAgICAgIF9jYW1lcmFNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkNhbWVyYU1hbmFnZXIoX2NhbWVyYSwgX3NjZW5lKTsKICAgICAgICBfZ2FtZU1hbmFnZXIuY2FtZXJhTWFuYWdlciA9IF9jYW1lcmFNYW5hZ2VyOwoKICAgICAgICAvLyA1LjcgRGV2IFRvb2xzCmlmICh3aW5kb3cuZmx1eC5EZXZUb29scykgewogICAgICAgICAgICBuZXcgd2luZG93LmZsdXguRGV2VG9vbHMoX2dhbWVNYW5hZ2VyKTsKICAgICAgICB9Ci8vIDUuOCBXYXRlciBPdmVybGF5LCBMaWdodCBTaGFmdHMsIFN0YWRpdW0sIEdseXBocwogICAgICAgIF93YXRlck92ZXJsYXkgPSBuZXcgd2luZG93LmZsdXguV2F0ZXJPdmVybGF5KF9jYW1lcmEpOwogICAgICAgIF9saWdodFNoYWZ0cyA9IG5ldyB3aW5kb3cuZmx1eC5MaWdodFNoYWZ0cyhfc2NlbmUpOwogICAgICAgIF9zdGFkaXVtID0gbmV3IHdpbmRvdy5mbHV4LlN0YWRpdW0oX3NjZW5lKTsKICAgICAgICBfZ2x5cGhNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkdseXBoTWFuYWdlcihfc2NlbmUpOwogICAgICAgIAppZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIF9nYW1lTWFuYWdlci5nbHlwaE1hbmFnZXIgPSBfZ2x5cGhNYW5hZ2VyOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIud2F0ZXJPdmVybGF5ID0gX3dhdGVyT3ZlcmxheTsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmxpZ2h0U2hhZnRzID0gX2xpZ2h0U2hhZnRzOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIuc3RhZGl1bSA9IF9zdGFkaXVtOwogICAgICAgIH0KICAgICAgICAvLyA2LiBUZWFtcyBTZXR1cAogICAgICAgIF9ob21lVGVhbSA9IG5ldyB3aW5kb3cuZmx1eC5UZWFtKF9zY2VuZSwgJ2hvbWUnLCAxLCAweDAwYWFmZiwgdHJ1ZSk7CiAgICAgICAgX2F3YXlUZWFtID0gbmV3IHdpbmRvdy5mbHV4LlRlYW0oX3NjZW5lLCAnYXdheScsIC0xLCAweGZmNjY2NiwgZmFsc2UpOwoKICAgICAgICAvLyA3LiBCYWxsCiAgICAgICAgX2JhbGwgPSBuZXcgd2luZG93LmZsdXguQmFsbChfc2NlbmUpOwoKICAgICAgICAvLyBJTVBST1ZFRDogTGluayBiYWxsIHRvIGNhbWVyYSBmb3Igc21hcnQgZnJhbWluZwogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnNldEJhbGwoX2JhbGwpOwoKICAgICAgICAvLyA4LiBUZWFtIFJvc3RlciBNb2RlbHMKICAgICAgICBjb25zdCByb2xlcyA9IFsnTEYnLCAnUkYnLCAnTUYnLCAnTEQnLCAnUkQnLCAnR0wnXTsKICAgICAgICBjb25zdCBob21lUm9zdGVyID0gewogICAgICAgICAgICBMRjogeyBuYW1lOiAnVGlkdXMnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZGE3ODhiZWYyNThjNGYwYjhkOWVmMWFjYzE5YzU1NjcuZ2xiJyB9LAogICAgICAgICAgICBSRjogeyBuYW1lOiAnV2Fra2EnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJyB9LAogICAgICAgICAgICBNRjogeyBuYW1lOiAnTGV0dHknLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNDNhY2UzNGM2ZmQ5NDIxNTk2N2U4NDJiZjkwOWRhNWUuZ2xiJyB9LAogICAgICAgICAgICBMRDogeyBuYW1lOiAnRGF0dG8nLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZTZkNjdlY2IyZTRjNDcxNWJkNzNhNDA3OTVlMWQzZDUuZ2xiJyB9LAogICAgICAgICAgICBSRDogeyBuYW1lOiAnSmFzc3UnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJyB9LAogICAgICAgICAgICBHTDogeyBuYW1lOiAnQm90dGEnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvYWQxNTVlZmVkYzBkNDhmZGFkMDlkYTNlMWNhZTljOTcuZ2xiJyB9CiAgICAgICAgfTsKCmNvbnN0IGFwcGx5U3RhdHMgPSAocCwgcm9sZSwgaXNIb21lKSA9PiB7CmNvbnN0IHRlYW1MZXZlbCA9IGlzSG9tZSA/IDI1IDogODsgLy8gTmVyZmVkIENQVSBsZXZlbCBzaWduaWZpY2FudGx5ICh3YXMgMTUpCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LlRlYW0uZ2VuZXJhdGVTdGF0cyhwLCByb2xlLCB0ZWFtTGV2ZWwsIGlzSG9tZSk7CgogICAgICAgICAgICBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDU7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNQICs9IDM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDM7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkVOICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdCcm90aGVyJykpIHsKICAgICAgICAgICAgICAgIHAuc3RhdHMuU1AgPSA5OTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcC5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CiAgICAgICAgfTsKCiAgICAgICAgbGV0IGhvbWVMb2FkZWQgPSAwOwogICAgICAgIGNvbnN0IHJvbGVHbHRmcyA9IHt9OwoKICAgICAgICBjb25zdCBmaW5hbGl6ZVRlYW1zID0gKCkgPT4gewogICAgICAgICAgICByb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZ2x0ZiA9IHJvbGVHbHRmc1tyb2xlXSB8fCByb2xlR2x0ZnMuTEY7CgogICAgICAgICAgICAgICAgY29uc3QgcCA9IChyb2xlID09PSAnR0wnKQogICAgICAgICAgICAgICAgICAgID8gbmV3IHdpbmRvdy5mbHV4LkdvYWxpZShfc2NlbmUsIHJvbGUpCiAgICAgICAgICAgICAgICAgICAgOiBuZXcgd2luZG93LmZsdXguQUlQbGF5ZXIoX3NjZW5lLCByb2xlKTsKCiAgICAgICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgICAgICBwLmNoYXJhY3Rlck5hbWUgPSBlbnRyeSA/IGBDUFUgJHtlbnRyeS5uYW1lfWAgOiAnQ1BVJzsKICAgICAgICAgICAgICAgIGFwcGx5U3RhdHMocCwgcm9sZSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmICYmIGdsdGYuc2NlbmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjbG9uZSA9IFRIUkVFLlNrZWxldG9uVXRpbHMuY2xvbmUoZ2x0Zi5zY2VuZSk7CiAgICAgICAgICAgICAgICAgICAgcC5zZXRNZXNoKGNsb25lLCBnbHRmLmFuaW1hdGlvbnMgfHwgW10pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ01pc3NpbmcgR0xURiBmb3IgYXdheSByb2xlOicsIHJvbGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS5hZGRQbGF5ZXIocCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYWxsUGxheWVycyA9IFsuLi5faG9tZVRlYW0ucGxheWVycywgLi4uX2F3YXlUZWFtLnBsYXllcnNdOwogICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAocC5iYWxsUmVmID09PSBudWxsKSBwLmJhbGxSZWYgPSBfYmFsbDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyID0gX2hvbWVUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy50YWNrbGUgPSAndmVub20nOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy5zaG9vdCA9ICdzcGhlcmUnOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0VxdWlwcGVkIEhvbWUgTUYgd2l0aCBWZW5vbSBUYWNrbGUgJiBTcGhlcmUgU2hvdCcpOwogICAgICAgICAgICB9Cgpjb25zdCBhd2F5TUYgPSBfYXdheVRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgLy8gUmVtb3ZlZCBndWFyYW50ZWVkIFdpdGhlciB0YWNrbGUgZm9yIEF3YXkgTUYgdG8gcmVkdWNlIGRpZmZpY3VsdHkKICAgICAgICAgICAgX2F3YXlUZWFtLnNldEZvcm1hdGlvbignQ291bnRlcicpOwoKICAgICAgICAgICAgY29uc3QgYXdheUdMID0gX2F3YXlUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ0dMJyk7CiAgICAgICAgICAgIC8vIFJlbW92ZWQgZ3VhcmFudGVlZCBTdXBlciBHb2FsaWUgZm9yIEF3YXkgR0wgdG8gbWFrZSBzY29yaW5nIGVhc2llcgoKICAgICAgICAgICAgX2hvbWVUZWFtLmFzc2lnbk1hcmtzKF9hd2F5VGVhbSk7CiAgICAgICAgICAgIF9hd2F5VGVhbS5hc3NpZ25NYXJrcyhfaG9tZVRlYW0pOwoKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xvYWRpbmcnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIucmVnaXN0ZXJUZWFtcyhfaG9tZVRlYW0sIF9hd2F5VGVhbSwgX2JhbGwpOwoKICAgICAgICAgICAgICAgIF9tZW51TWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5NZW51TWFuYWdlcihfZ2FtZU1hbmFnZXIpOwogICAgICAgICAgICAgICAgX21lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgfQogICAgICAgIH07Cgpyb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgIGlmICghZW50cnkpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9uQ29tcGxldGUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBob21lTG9hZGVkKys7CiAgICAgICAgICAgICAgICBpZiAoaG9tZUxvYWRlZCA+PSByb2xlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBmaW5hbGl6ZVRlYW1zKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlci5sb2FkTW9kZWwoZW50cnkudXJsLCAoZ2x0ZikgPT4gewogICAgICAgICAgICAgICAgcm9sZUdsdGZzW3JvbGVdID0gZ2x0ZjsKCiAgICAgICAgICAgICAgICBjb25zdCBwID0gKHJvbGUgPT09ICdHTCcpCiAgICAgICAgICAgICAgICAgICAgPyBuZXcgd2luZG93LmZsdXguR29hbGllKF9zY2VuZSwgcm9sZSkKICAgICAgICAgICAgICAgICAgICA6IG5ldyB3aW5kb3cuZmx1eC5BSVBsYXllcihfc2NlbmUsIHJvbGUpOwoKICAgICAgICAgICAgICAgIHAuY2hhcmFjdGVyTmFtZSA9IGVudHJ5Lm5hbWU7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIHRydWUpOwoKICAgICAgICAgICAgICAgIGNvbnN0IGNsb25lID0gVEhSRUUuU2tlbGV0b25VdGlscy5jbG9uZShnbHRmLnNjZW5lKTsKICAgICAgICAgICAgICAgIHAuc2V0TWVzaChjbG9uZSwgZ2x0Zi5hbmltYXRpb25zKTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hZGRQbGF5ZXIocCk7CgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpOwogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2FkIG1vZGVsJywgZW50cnkubmFtZSwgZW50cnkudXJsLCBlcnIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayBNZXNoIChSZWQgQm94KQogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoMSwgMiwgMSk7CiAgICAgICAgICAgICAgICBjb25zdCBmYWxsYmFja01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlIH0pOwogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tNZXNoID0gbmV3IFRIUkVFLk1lc2goZmFsbGJhY2tHZW8sIGZhbGxiYWNrTWF0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU3RvcmUgZHVtbXkgaW4gcm9sZUdsdGZzIGZvciBhd2F5IHRlYW0gY2xvbmluZwogICAgICAgICAgICAgICAgcm9sZUdsdGZzW3JvbGVdID0geyBzY2VuZTogZmFsbGJhY2tNZXNoLCBhbmltYXRpb25zOiBbXSB9OwoKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSAocm9sZSA9PT0gJ0dMJykKICAgICAgICAgICAgICAgICAgICA/IG5ldyB3aW5kb3cuZmx1eC5Hb2FsaWUoX3NjZW5lLCByb2xlKQogICAgICAgICAgICAgICAgICAgIDogbmV3IHdpbmRvdy5mbHV4LkFJUGxheWVyKF9zY2VuZSwgcm9sZSk7CgogICAgICAgICAgICAgICAgcC5jaGFyYWN0ZXJOYW1lID0gZW50cnkubmFtZSArICIgKEVycm9yKSI7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIHRydWUpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBwLnNldE1lc2goZmFsbGJhY2tNZXNoLmNsb25lKCksIFtdKTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hZGRQbGF5ZXIocCk7CgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gOC4gSW5wdXQKICAgICAgICBzZXR1cElucHV0cygpOwoKICAgICAgICAvLyA5LiBMb29wCiAgICAgICAgX2Nsb2NrID0gbmV3IFRIUkVFLkNsb2NrKCk7CiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwoKICAgICAgICAvLyBIYW5kbGUgcmVzaXplCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIG9uUmVzaXplKTsKICAgICAgICBvblJlc2l6ZSgpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlUGFydGljbGVzKCkgewogICAgICAgIGNvbnN0IGNvdW50ID0gMTUwMDsgLy8gSW5jcmVhc2VkIGNvdW50CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IFtdOwogICAgICAgIGNvbnN0IG9mZnNldHMgPSBbXTsgLy8gUmFuZG9tIG9mZnNldHMgZm9yIGluZGVwZW5kZW50IGJvYmJpbmcKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgIHZlcnRpY2VzLnB1c2goCiAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA4MCwgLy8gV2lkZXIgc3ByZWFkIFgKICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDUwLCAvLyBXaWRlciBzcHJlYWQgWQogICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogODAgIC8vIFdpZGVyIHNwcmVhZCBaCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIG9mZnNldHMucHVzaChNYXRoLnJhbmRvbSgpICogMTAwKTsKICAgICAgICB9CgogICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSh2ZXJ0aWNlcywgMykpOwogICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgnYU9mZnNldCcsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKG9mZnNldHMsIDEpKTsKCiAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICB1bmlmb3JtczogX3BhcnRpY2xlVW5pZm9ybXMsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCnZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBhT2Zmc2V0OwogICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2QWxwaGE7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAvLyBCb2JiaW5nIG1vdGlvbjogU2luZSB3YXZlIGJhc2VkIG9uIHRpbWUgKyByYW5kb20gb2Zmc2V0CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYm9iID0gc2luKHVUaW1lICogMC41ICsgYU9mZnNldCkgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gYm9iOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZlYzQgbXZQb3NpdGlvbiA9IG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zLCAxLjApOwogICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG12UG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU2l6ZSBhdHRlbnVhdGlvbiAtIFNtYWxsIGFuZCBzaGltbWVyeQogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNpemVCYXNlID0gMi4wICsgc2luKHVUaW1lICogMy4wICsgYU9mZnNldCkgKiAxLjA7IAogICAgICAgICAgICAgICAgICAgIGdsX1BvaW50U2l6ZSA9IHNpemVCYXNlICogKDIwLjAgLyAtbXZQb3NpdGlvbi56KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBGYWRlIGJhc2VkIG9uIGRpc3RhbmNlL2hlaWdodAogICAgICAgICAgICAgICAgICAgIHZBbHBoYSA9IDAuNSArIDAuNSAqIHNpbih1VGltZSAqIDIuMCArIGFPZmZzZXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgLAogICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2QWxwaGE7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU29mdCBnbG93IHBhcnRpY2xlIChEdXN0IG1vdGUpCiAgICAgICAgICAgICAgICAgICAgdmVjMiBjb29yZCA9IGdsX1BvaW50Q29vcmQgLSB2ZWMyKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGlzdCA9IGxlbmd0aChjb29yZCk7CiAgICAgICAgICAgICAgICAgICAgaWYoZGlzdCA+IDAuNSkgZGlzY2FyZDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTb2Z0IGZhbGxvZmYgZm9yIHNoaW1tZXIKICAgICAgICAgICAgICAgICAgICBmbG9hdCBzdHJlbmd0aCA9IDEuMCAtIChkaXN0ICogMi4wKTsKICAgICAgICAgICAgICAgICAgICBzdHJlbmd0aCA9IHBvdyhzdHJlbmd0aCwgMi4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDeWFuL0JsdWUgdGludCwgYWRkaXRpdmUgZmVlbAogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoMC43LCAwLjksIDEuMCwgdkFscGhhICogc3RyZW5ndGggKiAwLjgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHBvaW50cyA9IG5ldyBUSFJFRS5Qb2ludHMoZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICBwb2ludHMuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgIF9zY2VuZS5hZGQocG9pbnRzKTsKICAgIH0KCmZ1bmN0aW9uIGNyZWF0ZUFyZW5hKCkgewogICAgICAgIC8vIEdyb3VwIGZvciByb3RhdGlvbgogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICBfc2NlbmUuYWRkKHdpbmRvdy5mbHV4LmFyZW5hR3JvdXApOwoKICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeShfY29uZmlnLmFyZW5hUmFkaXVzLCAzMiwgMzIpOwogICAgICAgIAogICAgICAgIC8vIC0tLSAxLiBCYXNlIFNwaGVyZSAoRmFpbnQgR3JpZCkgLS0tCiAgICAgICAgY29uc3QgdGV4TG9hZGVyID0gbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKTsKICAgICAgICBjb25zdCBhcmVuYVRleCA9IHRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9XMUxzSDY4US9maWxlLTAwMDAwMDAwMjNlYzcxZjU5NjU5MzgyOWU4MTE4NzYwLSgxKS5wbmcnKTsKICAgICAgICBhcmVuYVRleC5tYWdGaWx0ZXIgPSBUSFJFRS5OZWFyZXN0RmlsdGVyOwogICAgICAgIGFyZW5hVGV4Lm1pbkZpbHRlciA9IFRIUkVFLk5lYXJlc3RGaWx0ZXI7CiAgICAgICAgYXJlbmFUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBhcmVuYVRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGFyZW5hVGV4LnJlcGVhdC5zZXQoNiwgNCk7CgogICAgICAgIGNvbnN0IG1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiBhcmVuYVRleCwKICAgICAgICAgICAgY29sb3I6IDB4NDQ2Njg4LAogICAgICAgICAgICB3aXJlZnJhbWU6IGZhbHNlLAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4xNSwgCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgY29uc3QgYXJlbmEgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAuYWRkKGFyZW5hKTsKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2ggPSBhcmVuYTsKCiAgICAgICAgLy8gLS0tIDIuIElubmVyIEhleCBHcmlkIChXYXJwIEVmZmVjdCkgLS0tCiAgICAgICAgLy8gUmV1c2UgZXhpc3RpbmcgaGV4IGdlbmVyYXRpb24gbG9naWMgYnV0IGF0dGFjaCB0byBncm91cAogICAgICAgIGNvbnN0IGhleFRleCA9ICgoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICAgICAgYy53aWR0aCA9IDUxMjsgYy5oZWlnaHQgPSA1MTI7CiAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLDAsNTEyLDUxMik7CiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDAsIDI1NSwgMjU1LCAwLjUpJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgIGNvbnN0IHIgPSA2NDsKICAgICAgICAgICAgY29uc3QgdyA9IHIgKiAyOwogICAgICAgICAgICBjb25zdCBoID0gTWF0aC5zcXJ0KDMpICogcjsKICAgICAgICAgICAgZm9yKGxldCB5ID0gLTE7IHkgPCA1MTIvaCArIDI7IHkrKykgewogICAgICAgICAgICAgICAgZm9yKGxldCB4ID0gLTE7IHggPCA1MTIvKHcqMC43NSkgKyAyOyB4KyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjeCA9IHggKiB3ICogMC43NTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjeSA9IHkgKiBoICsgKHglMj09PTAgPyAwIDogaC8yKTsKICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8NjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZyA9IE1hdGguUEkvMyAqIGk7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oY3ggKyBNYXRoLmNvcyhhbmcpKnIsIGN5ICsgTWF0aC5zaW4oYW5nKSpyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICAgICAgfSkoKTsKICAgICAgICBoZXhUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBoZXhUZXgud3JhcFQgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBoZXhUZXgucmVwZWF0LnNldCg0LCAyKTsKCiAgICAgICAgY29uc3QgYXJlbmFVbmlmb3JtcyA9IFRIUkVFLlVuaWZvcm1zVXRpbHMubWVyZ2UoWwogICAgICAgICAgICBUSFJFRS5Vbmlmb3Jtc0xpYlsnY29tbW9uJ10sCiAgICAgICAgICAgIF9hcmVuYVVuaWZvcm1zLAogICAgICAgICAgICB7IAogICAgICAgICAgICAgICAgdE1hcDogeyB2YWx1ZTogaGV4VGV4IH0sCiAgICAgICAgICAgICAgICB1T3BhY2l0eTogeyB2YWx1ZTogMC4xIH0gCiAgICAgICAgICAgIH0KICAgICAgICBdKTsKCiAgICAgICAgY29uc3QgbWF0ZXJpYWwyID0gbmV3IFRIUkVFLlNoYWRlck1hdGVyaWFsKHsKICAgICAgICAgICAgdW5pZm9ybXM6IGFyZW5hVW5pZm9ybXMsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IGAKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVRpbWU7CiAgICAgICAgICAgICAgICB1bmlmb3JtIHZlYzMgdUltcGFjdFBvczsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUltcGFjdFN0cjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdlV2ID0gdXY7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkaXN0ID0gZGlzdGFuY2UocG9zLCB1SW1wYWN0UG9zKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYWRpdXMgPSAyMC4wOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSBkaXN0IC8gcmFkaXVzOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBidWxnZSA9ICgxLjAgLSB0KSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBub3JtYWwgPSBub3JtYWxpemUocG9zKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zICs9IG5vcm1hbCAqIChidWxnZSAqIHVJbXBhY3RTdHIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KHBvcywgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYCwKICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGAKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHRNYXA7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVJbXBhY3RTdHI7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVPcGFjaXR5OwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWM0IHRleENvbG9yID0gdGV4dHVyZTJEKHRNYXAsIHZVdik7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYWxwaGEgPSB1T3BhY2l0eSAqIHRleENvbG9yLmE7CiAgICAgICAgICAgICAgICAgICAgYWxwaGEgKz0gdUltcGFjdFN0ciAqIDAuMDI7IAogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB0ZXhDb2xvci5yZ2IgKiB2ZWMzKDAuMiwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGFscGhhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYAogICAgICAgIH0pOwoKICAgICAgICBjb25zdCBhcmVuYTIgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwyKTsKICAgICAgICBhcmVuYTIuc2NhbGUuc2V0U2NhbGFyKDAuOTgpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAuYWRkKGFyZW5hMik7CiAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMiA9IGFyZW5hMjsKCiAgICAgICAgLy8gLS0tIDMuIEVRVUFUT1IgQkFORFMgKEJsdWUgYW5kIEdvbGQgLSBwb3NzZXNzaW9uIGJhc2VkKSAtLS0KICAgICAgICBjb25zdCBiYW5kVGV4TG9hZGVyID0gbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKTsKCiAgICAgICAgLy8gQmx1ZSBCYW5kIChzaG93biB3aGVuIGhvbWUgdGVhbSBoYXMgYmFsbCkgLSB0aGluIGJhbmQsIG5vIHZlcnRpY2FsIHN0cmV0Y2gKICAgICAgICBjb25zdCBibHVlQmFuZFRleCA9IGJhbmRUZXhMb2FkZXIubG9hZCgnaHR0cHM6Ly9pLnBvc3RpbWcuY2MvU1FuRnBESE4vQmx1ZS1iYW5kLnBuZycpOwogICAgICAgIGJsdWVCYW5kVGV4LndyYXBTID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgYmx1ZUJhbmRUZXgud3JhcFQgPSBUSFJFRS5DbGFtcFRvRWRnZVdyYXBwaW5nOwogICAgICAgIGJsdWVCYW5kVGV4LnJlcGVhdC5zZXQoMSwgMSk7IC8vIFNpbmdsZSB3cmFwLCBpbWFnZSB0aWxlcyBuYXR1cmFsbHkKCiAgICAgICAgY29uc3QgYmx1ZUJhbmRNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGJsdWVCYW5kVGV4LAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4zNSwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwovLyBUaGluIGJhbmQgLSBoZWlnaHQgb2YgMyB0byBhdm9pZCBzdHJldGNoaW5nCiAgICAgICAgY29uc3QgYmx1ZUJhbmRHZW8gPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeShfY29uZmlnLmFyZW5hUmFkaXVzICogMC45NiwgX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTYsIDMsIDY0LCAxLCB0cnVlKTsKICAgICAgICBjb25zdCBibHVlQmFuZE1lc2ggPSBuZXcgVEhSRUUuTWVzaChibHVlQmFuZEdlbywgYmx1ZUJhbmRNYXQpOwogICAgICAgIGJsdWVCYW5kTWVzaC5wb3NpdGlvbi55ID0gMDsKICAgICAgICBibHVlQmFuZE1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgX3NjZW5lLmFkZChibHVlQmFuZE1lc2gpOwoKICAgICAgICAvLyBHb2xkIEJhbmQgKHNob3duIHdoZW4gYXdheSB0ZWFtIGhhcyBiYWxsKQogICAgICAgIGNvbnN0IGdvbGRCYW5kVGV4ID0gYmFuZFRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9NWm4yOGRncS9Hb2xkLWJhbmQucG5nJyk7CiAgICAgICAgZ29sZEJhbmRUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBnb2xkQmFuZFRleC53cmFwVCA9IFRIUkVFLkNsYW1wVG9FZGdlV3JhcHBpbmc7CiAgICAgICAgZ29sZEJhbmRUZXgucmVwZWF0LnNldCgxLCAxKTsKCiAgICAgICAgY29uc3QgZ29sZEJhbmRNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGdvbGRCYW5kVGV4LAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4zNSwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwpjb25zdCBnb2xkQmFuZEdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KF9jb25maWcuYXJlbmFSYWRpdXMgKiAwLjk2LCBfY29uZmlnLmFyZW5hUmFkaXVzICogMC45NiwgMywgNjQsIDEsIHRydWUpOwogICAgICAgIGNvbnN0IGdvbGRCYW5kTWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdvbGRCYW5kR2VvLCBnb2xkQmFuZE1hdCk7CiAgICAgICAgZ29sZEJhbmRNZXNoLnBvc2l0aW9uLnkgPSAwOwogICAgICAgIGdvbGRCYW5kTWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgX3NjZW5lLmFkZChnb2xkQmFuZE1lc2gpOwoKICAgICAgICAvLyBTdG9yZSByZWZlcmVuY2VzCiAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNZXNoID0gYmx1ZUJhbmRNZXNoOwogICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWVzaCA9IGdvbGRCYW5kTWVzaDsKICAgICAgICB3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCA9IGJsdWVCYW5kTWF0OwogICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0ID0gZ29sZEJhbmRNYXQ7CgogICAgICAgIHdpbmRvdy5mbHV4LnVwZGF0ZUJhbmRQb3NzZXNzaW9uID0gZnVuY3Rpb24oaG9tZUhhc0JhbGwpIHsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaCAmJiB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2gpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaC52aXNpYmxlID0gaG9tZUhhc0JhbGw7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2gudmlzaWJsZSA9ICFob21lSGFzQmFsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHdpbmRvdy5mbHV4LnRyaWJhbFVuaWZvcm1zID0gewogICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9LAogICAgICAgICAgICB1Q29sb3I6IHsgdmFsdWU6IG5ldyBUSFJFRS5Db2xvcigweDAwZmZmZikgfQogICAgICAgIH07CgogICAgICAgIC8vIC0tLSA0LiBWRVJUSUNBTCBBUlJPVyBTVFJJUFMgKEFyb3VuZCBzcGhlcmUsIGFib3ZlICYgYmVsb3cgYmFuZCkgLS0tCiAgICAgICAgY29uc3QgYXJyb3dUZXhMb2FkZXIgPSBuZXcgVEhSRUUuVGV4dHVyZUxvYWRlcigpOwogICAgICAgIGNvbnN0IGFycm93VGV4ID0gYXJyb3dUZXhMb2FkZXIubG9hZCgnaHR0cHM6Ly9pLnBvc3RpbWcuY2MvZFFoUEs0Z1EvWWVsbG93YXJyb3dzLnBuZycpOwogICAgICAgIGFycm93VGV4LndyYXBTID0gVEhSRUUuQ2xhbXBUb0VkZ2VXcmFwcGluZzsKICAgICAgICBhcnJvd1RleC53cmFwVCA9IFRIUkVFLkNsYW1wVG9FZGdlV3JhcHBpbmc7CgogICAgICAgIGNvbnN0IGFycm93TWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiBhcnJvd1RleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuOCwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7CgogICAgICAgIC8vIENyZWF0ZSB2ZXJ0aWNhbCBhcnJvdyBzdHJpcHMgYXJvdW5kIHRoZSBzcGhlcmUgKGN1cnZlZCB0byBtYXRjaCBzcGhlcmUgc3VyZmFjZSkKICAgICAgICBjb25zdCBhcnJvd0dyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgY29uc3QgbnVtQXJyb3dzID0gMTY7ICAgLy8gTnVtYmVyIG9mIGFycm93IHN0cmlwcyBhcm91bmQgY2lyY3VtZmVyZW5jZQogICAgICAgIGNvbnN0IGFycm93SGVpZ2h0ID0gMzA7IC8vIEhlaWdodCBvZiBlYWNoIGFycm93IHN0cmlwCiAgICAgICAgY29uc3QgYXJyb3dXaWR0aCA9IDY7ICAgLy8gV2lkdGggb2YgZWFjaCBzdHJpcAogICAgICAgIGNvbnN0IGFycm93UmFkaXVzID0gX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTQ7CgogICAgICAgIGNvbnN0IG1ha2VDdXJ2ZWRTdHJpcCA9IChiYXNlQW5nbGUsIHlDZW50ZXIsIGZsaXBWID0gZmFsc2UpID0+IHsKICAgICAgICAgICAgLy8gTW9yZSBzZWdtZW50cyA9IHNtb290aGVyIGN1cnZhdHVyZSAoa2VlcCBtb2Rlc3QgZm9yIG1vYmlsZSkKICAgICAgICAgICAgY29uc3Qgc2VnVyA9IDY7ICAgLy8gY3VydmF0dXJlIHJlc29sdXRpb24gKHdpZHRoKQogICAgICAgICAgICBjb25zdCBzZWdIID0gMTg7ICAvLyB2ZXJ0aWNhbCByZXNvbHV0aW9uIChoZWlnaHQpCgogICAgICAgICAgICAvLyBDb252ZXJ0IGRlc2lyZWQgd29ybGQtc3BhY2Ugd2lkdGggaW50byBhbiBhbmd1bGFyIHNwYW4gb24gdGhlIHNwaGVyZQogICAgICAgICAgICBjb25zdCBwaGlTcGFuID0gYXJyb3dXaWR0aCAvIGFycm93UmFkaXVzOyAvLyByYWRpYW5zIChhcHByb3ggYXQgZXF1YXRvcikKICAgICAgICAgICAgY29uc3QgcGhpMCA9IGJhc2VBbmdsZSAtIHBoaVNwYW4gKiAwLjU7CiAgICAgICAgICAgIGNvbnN0IHBoaTEgPSBiYXNlQW5nbGUgKyBwaGlTcGFuICogMC41OwoKICAgICAgICAgICAgY29uc3QgeTAgPSB5Q2VudGVyIC0gYXJyb3dIZWlnaHQgKiAwLjU7CiAgICAgICAgICAgIGNvbnN0IHkxID0geUNlbnRlciArIGFycm93SGVpZ2h0ICogMC41OwoKICAgICAgICAgICAgY29uc3QgcG9zaXRpb25zID0gW107CiAgICAgICAgICAgIGNvbnN0IG5vcm1hbHMgPSBbXTsKICAgICAgICAgICAgY29uc3QgdXZzID0gW107CiAgICAgICAgICAgIGNvbnN0IGluZGljZXMgPSBbXTsKCiAgICAgICAgICAgIGZvciAobGV0IGl5ID0gMDsgaXkgPD0gc2VnSDsgaXkrKykgewogICAgICAgICAgICAgICAgY29uc3QgdiA9IGl5IC8gc2VnSDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBUSFJFRS5NYXRoVXRpbHMubGVycCh5MCwgeTEsIHYpOwoKICAgICAgICAgICAgICAgIC8vIENpcmNsZSByYWRpdXMgYXQgdGhpcyBoZWlnaHQgb24gdGhlIHNwaGVyZSAoeC96IHNocmluayBhcyB8eXwgZ3Jvd3MpCiAgICAgICAgICAgICAgICBjb25zdCByaW5nUiA9IE1hdGguc3FydChNYXRoLm1heCgwLjAwMDAxLCBhcnJvd1JhZGl1cyAqIGFycm93UmFkaXVzIC0geSAqIHkpKTsKCiAgICAgICAgICAgICAgICBmb3IgKGxldCBpeCA9IDA7IGl4IDw9IHNlZ1c7IGl4KyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB1ID0gaXggLyBzZWdXOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBoaSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKHBoaTAsIHBoaTEsIHUpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5zaW4ocGhpKSAqIHJpbmdSOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHogPSBNYXRoLmNvcyhwaGkpICogcmluZ1I7CgogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9ucy5wdXNoKHgsIHksIHopOwoKICAgICAgICAgICAgICAgICAgICAvLyBPdXR3YXJkIG5vcm1hbCBmb3IgYSBzcGhlcmUgY2VudGVyZWQgYXQgb3JpZ2luCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW52TGVuID0gMS4wIC8gTWF0aC5zcXJ0KHggKiB4ICsgeSAqIHkgKyB6ICogeik7CiAgICAgICAgICAgICAgICAgICAgbm9ybWFscy5wdXNoKHggKiBpbnZMZW4sIHkgKiBpbnZMZW4sIHogKiBpbnZMZW4pOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB2diA9IGZsaXBWID8gKDEgLSB2KSA6IHY7CiAgICAgICAgICAgICAgICAgICAgdXZzLnB1c2godSwgdnYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCByb3cgPSBzZWdXICsgMTsKICAgICAgICAgICAgZm9yIChsZXQgaXkgPSAwOyBpeSA8IHNlZ0g7IGl5KyspIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGl4ID0gMDsgaXggPCBzZWdXOyBpeCsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYSA9IGl5ICogcm93ICsgaXg7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYiA9IGEgKyAxOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGMgPSBhICsgcm93OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGQgPSBjICsgMTsKCiAgICAgICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGEsIGMsIGIpOwogICAgICAgICAgICAgICAgICAgIGluZGljZXMucHVzaChiLCBjLCBkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2VvID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgICAgIGdlby5zZXRJbmRleChpbmRpY2VzKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZShwb3NpdGlvbnMsIDMpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgnbm9ybWFsJywgbmV3IFRIUkVFLkZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUobm9ybWFscywgMykpOwogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCd1dicsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKHV2cywgMikpOwogICAgICAgICAgICBnZW8uY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk7CgogICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLk1lc2goZ2VvLCBhcnJvd01hdCk7CiAgICAgICAgfTsKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1BcnJvd3M7IGkrKykgewogICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gbnVtQXJyb3dzKSAqIE1hdGguUEkgKiAyOwoKICAgICAgICAgICAgLy8gVXBwZXIgYXJyb3cgc3RyaXAgKGFib3ZlIGJhbmQpCiAgICAgICAgICAgIGFycm93R3JvdXAuYWRkKG1ha2VDdXJ2ZWRTdHJpcChhbmdsZSwgYXJyb3dIZWlnaHQgKiAwLjUgKyAyLCBmYWxzZSkpOwoKICAgICAgICAgICAgLy8gTG93ZXIgYXJyb3cgc3RyaXAgKGJlbG93IGJhbmQpIC0gZmxpcCBWIHNvIGFycm93cyBwb2ludCBkb3dud2FyZAogICAgICAgICAgICBhcnJvd0dyb3VwLmFkZChtYWtlQ3VydmVkU3RyaXAoYW5nbGUsIC1hcnJvd0hlaWdodCAqIDAuNSAtIDIsIHRydWUpKTsKICAgICAgICB9CgogICAgICAgIF9zY2VuZS5hZGQoYXJyb3dHcm91cCk7CgogICAgICAgIC8vIFN0b3JlIHJlZmVyZW5jZXMgZm9yIERldlRvb2xzCiAgICAgICAgd2luZG93LmZsdXguYXJyb3dHcm91cCA9IGFycm93R3JvdXA7CiAgICAgICAgd2luZG93LmZsdXguYXJyb3dNYXQgPSBhcnJvd01hdDsKCiAgICAgICAgLy8gLS0tIDUuIFRPUCBHTFlQSFMgKERvbWUpIC0tLSAoRG9tZSkgLS0tCiAgICAgICAgY29uc3QgdG9wR2x5cGhUZXggPSAoKCkgPT4gewogICAgICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgICAgIGMud2lkdGggPSA1MTI7IGMuaGVpZ2h0ID0gNTEyOwogICAgICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgIGN0eC5jbGVhclJlY3QoMCwwLDUxMiw1MTIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMTAwLCAyMDAsIDI1NSwgMC41KSc7CiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoMjU2LCAyNTYsIDIwMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW50cmljYXRlIHBhdHRlcm4KICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ODsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhID0gKGkvOCkqTWF0aC5QSSoyOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IDI1NiArIE1hdGguY29zKGEpKjE1MDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAyNTYgKyBNYXRoLnNpbihhKSoxNTA7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIDQwLCAwLCBNYXRoLlBJKjIpOwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgLy8gQ29ubmVjdG9yCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKDI1NiwgMjU2KTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCwgeSk7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIH0pKCk7CgogICAgICAgIGNvbnN0IHRvcEdseXBoTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiB0b3BHbHlwaFRleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuNCwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHRvcEdseXBoR2VvID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoNjAsIDYwKTsKICAgICAgICBjb25zdCB0b3BHbHlwaCA9IG5ldyBUSFJFRS5NZXNoKHRvcEdseXBoR2VvLCB0b3BHbHlwaE1hdCk7CiAgICAgICAgdG9wR2x5cGgucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICB0b3BHbHlwaC5wb3NpdGlvbi55ID0gMzU7IC8vIE5lYXIgdG9wIG9mIGRvbWUKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYUdyb3VwLmFkZCh0b3BHbHlwaCk7CgogICAgICAgIC8vIC0tLSBORVc6IEZGWCBHT0FMIE1PREVMUyAtLS0KICAgICAgICBjb25zdCBnb2FsVXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hNTE2YmQ5MGZhN2M0ZGVkYjVkY2JmZGY4MDNmMTNkNS5nbGInOwogICAgICAgIApjb25zdCBvbkdvYWxMb2FkZWQgPSAobW9kZWwsIGlzRmFsbGJhY2spID0+IHsKICAgICAgICAgICAgY29uc3QgZ29hbEEgPSBtb2RlbDsKICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UgfHwgNDEuNTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmVkIGRvd24gfjE1ZnQgKDQuNW0pIHRvdGFsIGFzIHJlcXVlc3RlZCwgcHVzaGVkIGJhY2sgdG8gZWRnZQogICAgICAgICAgICBnb2FsQS5wb3NpdGlvbi5zZXQoMCwgLTYuMCwgLWdvYWxEaXN0KTsKICAgICAgICAgICAgaWYgKCFpc0ZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBnb2FsQS5zY2FsZS5zZXRTY2FsYXIoNTQuMCk7IC8vIEluY3JlYXNlZCA1MCUgKHdhcyAzNi4wKQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFNldHVwIEdvYWwgQQogICAgICAgICAgICBnb2FsQS50cmF2ZXJzZShjID0+IHsKICAgICAgICAgICAgICAgIGlmKGMuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgYy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7IC8vIENSSVRJQ0FMOiBQcmV2ZW50IGN1bGxpbmcKICAgICAgICAgICAgICAgICAgICBjLnJlbmRlck9yZGVyID0gMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgbWF0ZXJpYWwgaXMgdmlzaWJsZSBhbmQgdW5pcXVlCiAgICAgICAgICAgICAgICAgICAgaWYgKGMubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbCA9IGMubWF0ZXJpYWwuY2xvbmUoKTsgLy8gQ2xvbmUgZm9yIGluZGVwZW5kZW5jZQogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIFdoaXRlIHRvIHNob3cgb3JpZ2luYWwgdGV4dHVyZS9jb2xvcnMKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC50cmFuc3BhcmVudCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuc2lkZSA9IFRIUkVFLkRvdWJsZVNpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhUZXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyBBZGQgZ29hbHMgdG8gU0NFTkUsIG5vdCBhcmVuYUdyb3VwICh0aGV5IHNob3VsZG4ndCByb3RhdGUgd2l0aCB0aGUgc3BoZXJlKQogICAgICAgICAgICBfc2NlbmUuYWRkKGdvYWxBKTsKICAgICAgICAgICAgd2luZG93LmZsdXguZ29hbEEgPSBnb2FsQTsgLy8gRXhwb3NlIGZvciBEZXZUb29scwoKICAgICAgICAgICAgLy8gU2V0dXAgR29hbCBCCiAgICAgICAgICAgIGNvbnN0IGdvYWxCID0gaXNGYWxsYmFjayA/IGdvYWxBLmNsb25lKCkgOiBUSFJFRS5Ta2VsZXRvblV0aWxzLmNsb25lKGdvYWxBKTsKCiAgICAgICAgICAgIGdvYWxCLnBvc2l0aW9uLnNldCgwLCAtNi4wLCBnb2FsRGlzdCk7IC8vIE1vdmVkIGNsb3NlciAod2FzIDQ1KSBhbmQgZG93bgogICAgICAgICAgICBnb2FsQi5yb3RhdGlvbi55ID0gTWF0aC5QSTsKICAgICAgICAgICAgLy8gRW5zdXJlIEdvYWwgQiBtZXNoZXMgYXJlIGFsc28gcGVyc2lzdGVudCBhbmQgaGF2ZSB1bmlxdWUgbWF0ZXJpYWxzCiAgICAgICAgICAgIGdvYWxCLnRyYXZlcnNlKGMgPT4gewogICAgICAgICAgICAgICAgaWYoYy5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICBjLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoYy5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsID0gYy5tYXRlcmlhbC5jbG9uZSgpOyAvLyBDbG9uZSBhZ2FpbiBmb3IgQgogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLnRyYW5zcGFyZW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5kZXB0aFdyaXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgX3NjZW5lLmFkZChnb2FsQik7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdvYWxCID0gZ29hbEI7IC8vIEV4cG9zZSBmb3IgRGV2VG9vbHMKICAgICAgICB9OwoKICAgICAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlci5sb2FkTW9kZWwoZ29hbFVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgb25Hb2FsTG9hZGVkKGdsdGYuc2NlbmUsIGZhbHNlKTsKICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJHb2FsIG1vZGVsIGZhaWxlZCB0byBsb2FkLiBVc2luZyBmYWxsYmFjay4iLCBlcnIpOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoNzUsIDQ1LCAxMCk7IC8vIEZhbGxiYWNrIG1hc3NpdmUgYm94IChTY2FsZWQgMS41eCkKICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHhmZmZmZmYsIHdpcmVmcmFtZTogdHJ1ZSB9KTsKICAgICAgICAgICAgY29uc3QgZmFsbGJhY2sgPSBuZXcgVEhSRUUuTWVzaChnZW8sIGZhbGxiYWNrTWF0KTsKICAgICAgICAgICAgb25Hb2FsTG9hZGVkKGZhbGxiYWNrLCB0cnVlKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gLS0tIE5FVzogTUFTU0lWRSBGSUVMRCBNQVJLSU5HUyAtLS0KICAgICAgICBjcmVhdGVGaWVsZE1hcmtpbmdzKCk7CiAgICB9CgpmdW5jdGlvbiBjcmVhdGVGaWVsZE1hcmtpbmdzKCkgewogICAgICAgIC8vIExvYWQgZmxvb3IgZ2x5cGggZnJvbSBpbWFnZQogICAgICAgIGNvbnN0IHRleExvYWRlciA9IG5ldyBUSFJFRS5UZXh0dXJlTG9hZGVyKCk7CiAgICAgICAgY29uc3QgdGV4ID0gdGV4TG9hZGVyLmxvYWQoJ2h0dHBzOi8vaS5wb3N0aW1nLmNjL3Y4Q1I4NWRRL0Zsb29yZ2x5cGgucG5nJyk7CiAgICAgICAgdGV4LmFuaXNvdHJvcHkgPSAxNjsKCiAgICAgICAgLy8gRmxvb3IgUGxhbmUgKERlZXApCiAgICAgICAgY29uc3QgZ2VvID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoOTAsIDkwKTsKICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IHRleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuMzUsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZwogICAgICAgIH0pOwoKICAgICAgICBjb25zdCBmaWVsZCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgbWF0KTsKICAgICAgICBmaWVsZC5yb3RhdGlvbi54ID0gLU1hdGguUEkgLyAyOwogICAgICAgIGZpZWxkLnBvc2l0aW9uLnkgPSAtOC4wOyAvLyBTdW5rIGRlZXAKICAgICAgICBfc2NlbmUuYWRkKGZpZWxkKTsKCiAgICAgICAgLy8gU3RvcmUgcmVmZXJlbmNlcyBmb3IgRGV2VG9vbHMKICAgICAgICB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWVzaCA9IGZpZWxkOwogICAgICAgIHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQgPSBtYXQ7CiAgICB9CgpmdW5jdGlvbiBjcmVhdGVIb2xvZ3JhcGhpY1JpbmdzKCkgewogICAgICAgIC8vIEZsb2F0aW5nIEhvbG9ncmFwaGljIFJpbmdzIChNaWQtaGVpZ2h0KQogICAgICAgIGNvbnN0IHJpbmdHZW8gPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgyMCwgMC4xLCAxNiwgMTAwKTsKICAgICAgICBjb25zdCByaW5nTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZmZmLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4zLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KTsKICAgICAgICBjb25zdCByaW5nMSA9IG5ldyBUSFJFRS5NZXNoKHJpbmdHZW8sIHJpbmdNYXQpOwogICAgICAgIHJpbmcxLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICByaW5nMS5wb3NpdGlvbi55ID0gMDsKICAgICAgICBfc2NlbmUuYWRkKHJpbmcxKTsKICAgICAgICAKICAgICAgICBjb25zdCByaW5nMiA9IG5ldyBUSFJFRS5NZXNoKHJpbmdHZW8sIHJpbmdNYXQpOwogICAgICAgIHJpbmcyLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICByaW5nMi5zY2FsZS5zZXRTY2FsYXIoMS4yKTsKICAgICAgICByaW5nMi5wb3NpdGlvbi55ID0gNC4wOwogICAgICAgIF9zY2VuZS5hZGQocmluZzIpOwoKICAgICAgICAvLyBBbmltYXRlIFJpbmdzIChpbnRlZ3JhdGVkIGludG8gbWFpbiBsb29wIHRvIGF2b2lkIGEgc2Vjb25kIFJBRiBvbiBtb2JpbGUpCmxldCBfcmluZ1RpbWUgPSAwOwogICAgICAgIGNvbnN0IF9yaW5nVXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIF9yaW5nVGltZSArPSBkdDsKICAgICAgICAgICAgaWYgKHJpbmcxKSB7CiAgICAgICAgICAgICAgICByaW5nMS5yb3RhdGlvbi56ICs9IGR0ICogMC45OwogICAgICAgICAgICAgICAgcmluZzEuc2NhbGUuc2V0U2NhbGFyKDEuMCArIE1hdGguc2luKF9yaW5nVGltZSAqIDAuNSkgKiAwLjA1KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmluZzIpIHsKICAgICAgICAgICAgICAgIHJpbmcyLnJvdGF0aW9uLnogLT0gZHQgKiAwLjc1OwogICAgICAgICAgICAgICAgcmluZzIucG9zaXRpb24ueSA9IDQuMCArIE1hdGguY29zKF9yaW5nVGltZSAqIDAuNykgKiAxLjA7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGlmICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzKSB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLnB1c2goX3JpbmdVcGRhdGUpOwogICAgfQoKICAgIC8vIC0tLSBJTlBVVCBTWVNURU0gLS0tCi8vIC0tLSBJTlBVVCBTWVNURU0gLS0tCmNvbnN0IF9rZXlzID0ge307Ci8vIEdsb2JhbHMgbW92ZWQgdG8gYmVsb3cgaGVscGVyCgogICAgLy8gSGVscGVyOiBBbmFseXplIGN1cnZlIGdlb21ldHJ5IGZvciBhbmFsb2cgY29udHJvbAogICAgY29uc3QgYW5hbHl6ZVN3aXBlQ3VydmUgPSAocG9pbnRzKSA9PiB7CiAgICAgICAgaWYgKHBvaW50cy5sZW5ndGggPCAzKSByZXR1cm4geyBpbnRlbnNpdHk6IDAsIHNwZWVkOiAwLCBkeDogMCwgZHk6IDAgfTsKICAgICAgICAKICAgICAgICBjb25zdCBwU3RhcnQgPSBwb2ludHNbMF07CiAgICAgICAgY29uc3QgcEVuZCA9IHBvaW50c1twb2ludHMubGVuZ3RoIC0gMV07CiAgICAgICAgY29uc3QgbWlkSWR4ID0gTWF0aC5mbG9vcihwb2ludHMubGVuZ3RoIC8gMik7CiAgICAgICAgY29uc3QgcE1pZCA9IHBvaW50c1ttaWRJZHhdOwoKICAgICAgICBjb25zdCBkeCA9IHBFbmQueCAtIHBTdGFydC54OwogICAgICAgIGNvbnN0IGR5ID0gcEVuZC55IC0gcFN0YXJ0Lnk7CiAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKICAgICAgICBjb25zdCBkdCA9IHBFbmQudCAtIHBTdGFydC50OwogICAgICAgIGNvbnN0IHNwZWVkID0gKGR0ID4gMCkgPyBkaXN0IC8gZHQgOiAwOyAvLyBweC9tcwoKICAgICAgICBpZiAoZGlzdCA8IDUwKSByZXR1cm4geyBpbnRlbnNpdHk6IDAsIHNwZWVkOiBzcGVlZCwgZHgsIGR5IH07CgogICAgICAgIGNvbnN0IHZTTV94ID0gcE1pZC54IC0gcFN0YXJ0Lng7CiAgICAgICAgY29uc3QgdlNNX3kgPSBwTWlkLnkgLSBwU3RhcnQueTsKCiAgICAgICAgLy8gQ3Jvc3MgcHJvZHVjdCBnaXZlcyBzaWduZWQgYXJlYS9jdXJ2YXR1cmUgZGlyZWN0aW9uCiAgICAgICAgY29uc3QgY3Jvc3MgPSAoZHggKiB2U01feSkgLSAoZHkgKiB2U01feCk7CiAgICAgICAgLy8gTm9ybWFsaXplIGJ5IGRpc3RhbmNlIHNxdWFyZWQgdG8gZ2V0IGEgY3VydmF0dXJlIHJhdGlvIGluZGVwZW5kZW50IG9mIHNjYWxlCmNvbnN0IGludGVuc2l0eSA9IGNyb3NzIC8gKGRpc3QgKiBkaXN0KTsKCiAgICAgICAgcmV0dXJuIHsgaW50ZW5zaXR5LCBzcGVlZCwgZHgsIGR5IH07CiAgICB9OwogICAgbGV0IF9zd2lwZVBvaW50cyA9IFtdOyAvLyBUcmFjayBzd2lwZSBoaXN0b3J5IGZvciBjdXJ2ZXMKICAgIGNvbnN0IF9haW1JbnB1dCA9IHsgeDogMCwgeTogMCwgYWN0aXZlOiBmYWxzZSB9OyAvLyBORVc6IEFpbSBqb3lzdGljawoKICAgIGNvbnN0IF9hY3Rpb25CdWZmZXIgPSB7IGFjdGl2ZTogZmFsc2UsIHRpbWVzdGFtcDogMCwgZHVyYXRpb246IDMwMCB9OwoKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF91cEF4aXMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKTsKCmZ1bmN0aW9uIHNldHVwSW5wdXRzKCkgewogICAgICAgIC8vIFNraXAgSW50cm8gTGlzdGVuZXIKICAgICAgICBjb25zdCBza2lwSGFuZGxlciA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPT09ICdpbnRybycpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5za2lwSW50cm8oKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHNraXBIYW5kbGVyKTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHNraXBIYW5kbGVyLCB7cGFzc2l2ZTogdHJ1ZX0pOwoKICAgICAgICAvLyBLZXlib2FyZAogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgX2tleXNbZS5rZXldID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ1NwYWNlJyAmJiBfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllciAmJiBfYmFsbCkgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50aHJvd0JhbGwoX2JhbGwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE5FVzogVGFja2xlIG9uIFNoaWZ0CiAgICAgICAgICAgIGlmIChlLmNvZGUgPT09ICdTaGlmdExlZnQnIHx8IGUuY29kZSA9PT0gJ1NoaWZ0UmlnaHQnKSB7CiAgICAgICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBwLmRhc2gocC5pbnB1dFZlY3Rvci54LCBwLmlucHV0VmVjdG9yLnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH0pOwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIChlKSA9PiB7IF9rZXlzW2Uua2V5XSA9IGZhbHNlOyB1cGRhdGVJbnB1dFZlY3RvcigpOyB9KTsKCiAgICAgICAgLy8gLS0tIEZMT0FUSU5HIEpPWVNUSUNLIChNb3ZlbWVudCkgLS0tCiAgICAgICAgY29uc3QgaGl0Wm9uZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1oaXQtem9uZScpOwogICAgICAgIGNvbnN0IHZpc3VhbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2stdmlzdWFsLWNvbnRhaW5lcicpOwogICAgICAgIGNvbnN0IGJhc2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2stYmFzZScpOwogICAgICAgIGNvbnN0IGtub2IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2sta25vYicpOwoKICAgICAgICBsZXQgc3RhcnRYID0gMCwgc3RhcnRZID0gMDsKICAgICAgICBsZXQgZHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICBjb25zdCBtYXhEaXN0ID0gNDA7CgogICAgICAgIGxldCBtb3ZlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgY29uc3QgbW92ZURlYWR6b25lUHggPSA2OwoKICAgICAgICAvLyBFeHBvc2UgbW92ZSBqb3lzdGljayBzdGF0ZSBmb3Igc25hcHNob3RzCiAgICAgICAgY29uc3QgX2RiZyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPID0gd2luZG93LmZsdXguX2RlYnVnSU8gfHwge307CiAgICAgICAgX2RiZy5zZXR0aW5ncyA9IF9zZXR0aW5nczsKICAgICAgICBfZGJnLmlucHV0ID0gX2RiZy5pbnB1dCB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUgPSBfZGJnLmlucHV0Lm1vdmUgfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnZlY3RvciA9IF9pbnB1dDsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUuZHJhZ2dpbmcgPSBkcmFnZ2luZzsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUudG91Y2hJZCA9IG1vdmVUb3VjaElkOwoKCiAgICAgICAgY29uc3QgaGFuZGxlU3RhcnQgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBkcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHN0YXJ0WCA9IGNsaWVudFg7CgogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQubW92ZSkgewogICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLmRyYWdnaW5nID0gZHJhZ2dpbmc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN0YXJ0WSA9IGNsaWVudFk7CgogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLmxlZnQgPSBgJHtjbGllbnRYfXB4YDsKICAgICAgICAgICAgdmlzdWFscy5zdHlsZS50b3AgPSBgJHtjbGllbnRZfXB4YDsKCiAgICAgICAgICAgIGtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgtNTAlLCAtNTAlKWA7CgogICAgICAgICAgICBjcmVhdGVSaXBwbGUoY2xpZW50WCwgY2xpZW50WSk7CgogICAgICAgICAgICBfaW5wdXQueCA9IDA7CiAgICAgICAgICAgIF9pbnB1dC55ID0gMDsKICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVNb3ZlID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGR4ID0gY2xpZW50WCAtIHN0YXJ0WDsKICAgICAgICAgICAgbGV0IGR5ID0gY2xpZW50WSAtIHN0YXJ0WTsKCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgoKICAgICAgICAgICAgLy8gRGVhZHpvbmUgdG8gcHJldmVudCBkcmlmdCBmcm9tIHRpbnkgdGh1bWIgaml0dGVyCiAgICAgICAgICAgIGlmIChkaXN0IDwgbW92ZURlYWR6b25lUHgpIHsKICAgICAgICAgICAgICAgIGR4ID0gMDsKICAgICAgICAgICAgICAgIGR5ID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRpc3QgPiBtYXhEaXN0KSB7CiAgICAgICAgICAgICAgICBkeCA9IChkeCAvIGRpc3QpICogbWF4RGlzdDsKICAgICAgICAgICAgICAgIGR5ID0gKGR5IC8gZGlzdCkgKiBtYXhEaXN0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBrbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoY2FsYygtNTAlICsgJHtkeH1weCksIGNhbGMoLTUwJSArICR7ZHl9cHgpKWA7CgogICAgICAgICAgICBfaW5wdXQueCA9IChkeCAvIG1heERpc3QpICogX3NldHRpbmdzLmpveXN0aWNrU2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIF9pbnB1dC55ID0gKGR5IC8gbWF4RGlzdCkgKiBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eTsKICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVFbmQgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgZHJhZ2dpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIG1vdmVUb3VjaElkID0gbnVsbDsKCiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5tb3ZlKSB7CiAgICAgICAgICAgICAgICBfZGJnLmlucHV0Lm1vdmUuZHJhZ2dpbmcgPSBkcmFnZ2luZzsKICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS50b3VjaElkID0gbW92ZVRvdWNoSWQ7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBfaW5wdXQueCA9IDA7CiAgICAgICAgICAgIF9pbnB1dC55ID0gMDsKICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9OwoKICAgICAgICBpZiAoaGl0Wm9uZSkgewogICAgICAgICAgICBoaXRab25lLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXNbMF0pID8gZS5jaGFuZ2VkVG91Y2hlc1swXSA6IGUudG91Y2hlc1swXTsKICAgICAgICAgICAgICAgIG1vdmVUb3VjaElkID0gdCA/IHQuaWRlbnRpZmllciA6IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQubW92ZSkgewogICAgICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS50b3VjaElkID0gbW92ZVRvdWNoSWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBoYW5kbGVTdGFydCh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIG1vdmVUb3VjaElkKTsKICAgICAgICAgICAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICAgICAgICAgICAgaGFuZGxlTW92ZSh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBtb3ZlVG91Y2hJZCk7CiAgICAgICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsgLy8gSWdub3JlIG90aGVyIGZpbmdlcnMgbGlmdGluZwogICAgICAgICAgICAgICAgaGFuZGxlRW5kKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBtb3ZlVG91Y2hJZCk7CiAgICAgICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsKICAgICAgICAgICAgICAgIGhhbmRsZUVuZCgpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGhpdFpvbmUuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGhhbmRsZVN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGRyYWdnaW5nKSBoYW5kbGVNb3ZlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBORVc6IEFJTSBKT1lTVElDSyAoUmlnaHQgc2lkZSkgLS0tCiAgICAgICAgc2V0dXBBaW1Kb3lzdGljaygpOwoKICAgICAgICAvLyAtLS0gTkVXOiBUQUNLTEUgQlVUVE9OIC0tLQogICAgICAgIHNldHVwVGFja2xlQnV0dG9uKCk7CgogICAgICAgIC8vIFN3aXBlIERldGVjdGlvbgovLyBTd2lwZSBEZXRlY3Rpb24KICAgICAgICBsZXQgc3dpcGVTdGFydCA9IHsgeDogMCwgeTogMCwgdDogMCB9OwogICAgICAgIGxldCBzd2lwZVRvdWNoSWQgPSBudWxsOwogICAgICAgIAogICAgICAgIC8vIEV4cG9zZSBzd2lwZS90aHJvdyBnZXN0dXJlIHN0YXRlIGZvciBzbmFwc2hvdHMKICAgICAgICBfZGJnLmlucHV0LnN3aXBlID0gX2RiZy5pbnB1dC5zd2lwZSB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0LnN3aXBlLnN0YXJ0ID0gc3dpcGVTdGFydDsKICAgICAgICBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7CiAgICAgICAgX2RiZy5pbnB1dC5zd2lwZS5wb2ludHMgPSBfc3dpcGVQb2ludHM7CmNvbnN0IG9uU3dpcGVTdGFydCA9ICh4LCB5KSA9PiB7CiAgICAgICAgICAgIHN3aXBlU3RhcnQueCA9IHg7CiAgICAgICAgICAgIHN3aXBlU3RhcnQueSA9IHk7CiAgICAgICAgICAgIHN3aXBlU3RhcnQudCA9IERhdGUubm93KCk7CiAgICAgICAgICAgIF9zd2lwZVBvaW50cyA9IFt7eCwgeSwgdDogRGF0ZS5ub3coKX1dOwogICAgICAgIH07Cgpjb25zdCBvblN3aXBlTW92ZSA9ICh4LCB5KSA9PiB7CiAgICAgICAgICAgIGlmIChfc3dpcGVQb2ludHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgX3N3aXBlUG9pbnRzLnB1c2goe3gsIHksIHQ6IERhdGUubm93KCl9KTsKICAgICAgICAgICAgICAgIGNyZWF0ZVN3aXBlVHJhaWxEb3QoeCwgeSk7IC8vIFZpc3VhbCBGZWVkYmFjawogICAgICAgICAgICB9CiAgICAgICAgfTsKCmNvbnN0IG9uU3dpcGVFbmQgPSAoeCwgeSkgPT4gewogICAgICAgICAgICBpZiAoX3N3aXBlUG9pbnRzLmxlbmd0aCA8IDIpIHJldHVybjsKICAgICAgICAgICAgX3N3aXBlUG9pbnRzLnB1c2goe3gsIHksIHQ6IERhdGUubm93KCl9KTsKCiAgICAgICAgICAgIGNvbnN0IHsgaW50ZW5zaXR5LCBzcGVlZCwgZHgsIGR5IH0gPSBhbmFseXplU3dpcGVDdXJ2ZShfc3dpcGVQb2ludHMpOwogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwoKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyICYmIF9jYW1lcmEpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgICAgIC8vIC0tLSBDVVJWRSBCQUxMIERFVEVDVElPTiAoSW1tZWRpYXRlIFRocm93KSAtLS0KLy8gLS0tIENVUlZFIEJBTEwgREVURUNUSU9OIChJbW1lZGlhdGUgVGhyb3cpIC0tLQogICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCAmJiAhcC5pc1Rocm93aW5nICYmICFwLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBBbmFsb2cgQ3VydmUgQ2hlY2s6IFRocmVzaG9sZCAwLjI1IHJlcXVpcmVzIGEgZGVsaWJlcmF0ZSBhcmMgKFRoZSAiRmVhdCIpCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGludGVuc2l0eSkgPiAwLjI1ICYmIGRpc3QgPiAxMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhfY2FtRndkLCBfdXBBeGlzKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWCA9IChfY2FtUmlnaHQueCAqIGR4KSArIChfY2FtRndkLnggKiAtZHkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoX2NhbVJpZ2h0LnogKiBkeCkgKyAoX2NhbUZ3ZC56ICogLWR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGhyb3dEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMyh3b3JsZFgsIDAsIHdvcmxkWikubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBNYXAgaW50ZW5zaXR5IHRvIHNwaW4gLSBEcmFzdGljYWxseSByZWR1Y2VkIHNlbnNpdGl2aXR5CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhd1NwaW4gPSBNYXRoLmFicyhpbnRlbnNpdHkpICogMzAwLjA7IAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGVlZEZhY3RvciA9IE1hdGgubWluKDEuNSwgc3BlZWQgLyAxLjApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluUG93ZXIgPSBNYXRoLm1pbig0MDAuMCwgcmF3U3BpbiAqIHNwZWVkRmFjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblNpZ24gPSBNYXRoLnNpZ24oaW50ZW5zaXR5KTsgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5WZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCBzcGluUG93ZXIgKiBzcGluU2lnbiwgMCk7CgoKICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRPdmVycmlkZUFpbSh0aHJvd0Rpci54LCB0aHJvd0Rpci56KTsKICAgICAgICAgICAgICAgICAgICAgICAgcC50aHJvd0JhbGwod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGwsICdTSCcsIDEuMCwgc3BpblZlYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQ1VSVkUiLCBwLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlUmlwcGxlKHgsIHkpOwogICAgICAgICAgICAgICAgICAgICAgICBfc3dpcGVQb2ludHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOyAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gLS0tIFNUQU5EQVJEIERBU0ggLyBBSU0gLS0tCiAgICAgICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICAgICAgZWxzZSBfY2FtRndkLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7Cgpjb25zdCB3b3JsZFgyID0gKF9jYW1SaWdodC54ICogZHgpICsgKF9jYW1Gd2QueCAqIC1keSk7CiAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFoyID0gKF9jYW1SaWdodC56ICogZHgpICsgKF9jYW1Gd2QueiAqIC1keSk7CgogICAgICAgICAgICAgICAgaWYgKHAuaXNUaHJvd2luZykgewpwLnNldE92ZXJyaWRlQWltKHdvcmxkWDIsIHdvcmxkWjIpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkFJTSEiLCBwLm1lc2gucG9zaXRpb24sICJkZWZhdWx0Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKaWYgKGRpc3QgPiA1MCkgcC5kYXNoKHdvcmxkWDIsIHdvcmxkWjIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNyZWF0ZVJpcHBsZSh4LCB5KTsKICAgICAgICAgICAgfQpfc3dpcGVQb2ludHMgPSBbXTsKICAgICAgICB9OwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHQgPSAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzWzBdKSA/IGUuY2hhbmdlZFRvdWNoZXNbMF0gOiBlLnRvdWNoZXNbMF07CiAgICAgICAgICAgIHN3aXBlVG91Y2hJZCA9IHQgPyB0LmlkZW50aWZpZXIgOiBudWxsOwovLyBvblN3aXBlU3RhcnQodC5jbGllbnRYLCB0LmNsaWVudFkpOyAvLyBGaXhlZCBzeW50YXggZXJyb3IKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LnN3aXBlKSB7IF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsgfQogICAgICAgICAgICBvblN3aXBlU3RhcnQodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgICAgICBjcmVhdGVSaXBwbGUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7Cgp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBzd2lwZVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgb25Td2lwZU1vdmUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBzd2lwZVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsgLy8gSWdub3JlIG90aGVyIGZpbmdlcnMgbGlmdGluZwogICAgICAgICAgICBvblN3aXBlRW5kKHRFbmQuY2xpZW50WCwgdEVuZC5jbGllbnRZKTsKICAgICAgICAgICAgc3dpcGVUb3VjaElkID0gbnVsbDsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LnN3aXBlKSB7IF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsgfQogICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIChlKSA9PiB7CmlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBzd2lwZVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsgLy8gSWdub3JlIG90aGVyIGZpbmdlcnMgbGlmdGluZwogICAgICAgICAgICBvblN3aXBlRW5kKHRFbmQuY2xpZW50WCwgdEVuZC5jbGllbnRZKTsKICAgICAgICAgICAgc3dpcGVUb3VjaElkID0gbnVsbDsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LnN3aXBlKSB7IF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsgfQogICAgICAgIAogICAgICAgIH0pOwovLyBNb3VzZSBTd2lwZQogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CgogICAgICAgICAgICBvblN3aXBlU3RhcnQoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICBjcmVhdGVSaXBwbGUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykpIHJldHVybjsKICAgICAgICAgICAgLy8gT25seSB0cmFjayBpZiBtb3VzZSBpcyBkb3duIChzaW11bGF0aW5nIGRyYWcpCiAgICAgICAgICAgIGlmIChlLmJ1dHRvbnMgPT09IDEpIHsKICAgICAgICAgICAgICAgIG9uU3dpcGVNb3ZlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CiAgICAgICAgICAgIG9uU3dpcGVFbmQoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBBY3Rpb24gQnV0dG9uIChTaG9vdC9QYXNzKQogICAgICAgIGNvbnN0IGFjdGlvbkJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY3Rpb24tYnV0dG9uJyk7Cgpjb25zdCBzZXR1cEJ1dHRvbiA9IChidG4pID0+IHsKICAgICAgICAgICAgaWYgKCFidG4pIHJldHVybjsKCiAgICAgICAgICAgIGxldCBidG5TdGFydFggPSAwOwogICAgICAgICAgICBsZXQgYnRuU3RhcnRZID0gMDsKICAgICAgICAgICAgbGV0IGlzRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgbGV0IHN3aXBlUG9pbnRzID0gW107CiAgICAgICAgICAgIGxldCBhY3Rpb25Ub3VjaElkID0gbnVsbDsKCiAgICAgICAgICAgIGNvbnN0IGF0dGVtcHRBY3Rpb24gPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIV9ob21lVGVhbSB8fCAhX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCAmJiAhcC5pc0NoYXJnaW5nICYmICFwLmlzVGhyb3dpbmcgJiYgcC5zdGF0dXMubmFwIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBwLnN0YXJ0Q2hhcmdlKCk7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgaGFuZGxlU3RhcnQgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLnRlY2hDb3B5U3RhdGUuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmF0dGVtcHRUZWNoQ29weSgpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSwgMTAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaXNEZW1vTW9kZSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGxldCBjbGllbnRYID0gZS5jbGllbnRYOwogICAgICAgICAgICAgICAgbGV0IGNsaWVudFkgPSBlLmNsaWVudFk7CiAgICAgICAgICAgICAgICBpZiAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBlLmNoYW5nZWRUb3VjaGVzWzBdOwogICAgICAgICAgICAgICAgICAgIGFjdGlvblRvdWNoSWQgPSB0LmlkZW50aWZpZXI7CiAgICAgICAgICAgICAgICAgICAgY2xpZW50WCA9IHQuY2xpZW50WDsKICAgICAgICAgICAgICAgICAgICBjbGllbnRZID0gdC5jbGllbnRZOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBhY3Rpb25Ub3VjaElkID0gbnVsbDsgLy8gbW91c2UKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJ0blN0YXJ0WCA9IGNsaWVudFg7CiAgICAgICAgICAgICAgICBidG5TdGFydFkgPSBjbGllbnRZOwogICAgICAgICAgICAgICAgaXNEcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICBzd2lwZVBvaW50cyA9IFt7eDogY2xpZW50WCwgeTogY2xpZW50WSwgdDogRGF0ZS5ub3coKX1dOwoKICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIudGltZXN0YW1wID0gRGF0ZS5ub3coKTsKCiAgICAgICAgICAgICAgICBpZiAoYXR0ZW1wdEFjdGlvbigpKSB7CiAgICAgICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBdHRhY2ggZ2xvYmFsIGxpc3RlbmVycyB0byB0cmFjayBzd2lwZSBvdXRzaWRlIGJ1dHRvbgogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGhhbmRsZU1vdmUsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBoYW5kbGVNb3ZlKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGNvbnN0IGhhbmRsZU1vdmUgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFpc0RyYWdnaW5nKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gVG91Y2ggcGF0aCAobXVsdGktdG91Y2ggc2FmZSkKICAgICAgICAgICAgICAgIGlmIChlLnRvdWNoZXMgJiYgYWN0aW9uVG91Y2hJZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIGFjdGlvblRvdWNoSWQpOwogICAgICAgICAgICAgICAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIHN3aXBlUG9pbnRzLnB1c2goe3g6IHQuY2xpZW50WCwgeTogdC5jbGllbnRZLCB0OiBEYXRlLm5vdygpfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE1vdXNlIHBhdGgKICAgICAgICAgICAgICAgIGNvbnN0IGNsaWVudFggPSBlLmNsaWVudFg7CiAgICAgICAgICAgICAgICBjb25zdCBjbGllbnRZID0gZS5jbGllbnRZOwogICAgICAgICAgICAgICAgc3dpcGVQb2ludHMucHVzaCh7eDogY2xpZW50WCwgeTogY2xpZW50WSwgdDogRGF0ZS5ub3coKX0pOwogICAgICAgICAgICB9OwoKY29uc3QgaGFuZGxlRW5kID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIGxldCBkeCA9IDA7CiAgICAgICAgICAgICAgICBsZXQgZHkgPSAwOwogICAgICAgICAgICAgICAgbGV0IHZhbGlkRW5kID0gZmFsc2U7CgogICAgICAgICAgICAgICAgLy8gMS4gQ2hlY2sgVG91Y2gKICAgICAgICAgICAgICAgIGlmIChlLmNoYW5nZWRUb3VjaGVzICYmIGFjdGlvblRvdWNoSWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIGFjdGlvblRvdWNoSWQpOwogICAgICAgICAgICAgICAgICAgIGlmICh0RW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGR4ID0gdEVuZC5jbGllbnRYIC0gYnRuU3RhcnRYOwogICAgICAgICAgICAgICAgICAgICAgICBkeSA9IHRFbmQuY2xpZW50WSAtIGJ0blN0YXJ0WTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRFbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25Ub3VjaElkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgLy8gMi4gQ2hlY2sgTW91c2UKICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFlLmNoYW5nZWRUb3VjaGVzICYmIGlzRHJhZ2dpbmcpIHsKICAgICAgICAgICAgICAgICAgICBkeCA9IGUuY2xpZW50WCAtIGJ0blN0YXJ0WDsKICAgICAgICAgICAgICAgICAgICBkeSA9IGUuY2xpZW50WSAtIGJ0blN0YXJ0WTsKICAgICAgICAgICAgICAgICAgICB2YWxpZEVuZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCF2YWxpZEVuZCkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIC8vIENsZWFudXAgbGlzdGVuZXJzCiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgaGFuZGxlTW92ZSk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBoYW5kbGVNb3ZlKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKCiAgICAgICAgICAgICAgICBpZiAoIWlzRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgd2FzQnVmZmVyZWQgPSBfYWN0aW9uQnVmZmVyLmFjdGl2ZTsKICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gZmFsc2U7CgogICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ3VydmUgQW5hbHlzaXMKICAgICAgICAgICAgICAgICAgICBsZXQgY3VydmVEYXRhID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBsZXQgc3BpblZlYyA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBjdXJ2ZSBpZiB3ZSBoYXZlIGVub3VnaCBkYXRhCi8vIENhbGN1bGF0ZSBjdXJ2ZSBpZiB3ZSBoYXZlIGVub3VnaCBkYXRhCiAgICAgICAgICAgICAgICAgICAgaWYgKHN3aXBlUG9pbnRzLmxlbmd0aCA+IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5hbHlzaXMgPSBhbmFseXplU3dpcGVDdXJ2ZShzd2lwZVBvaW50cyk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhpZ2ggdGhyZXNob2xkIGZvciBidXR0b24gcmVsZWFzZSB0b28KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGFuYWx5c2lzLmludGVuc2l0eSkgPiAwLjI1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJ2ZURhdGEgPSBhbmFseXNpczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIHNwaW4gdmVjdG9yIGZvciBtb3VzZS90b3VjaCB1bmlmaWVkIChDb25zZXJ2YXRpdmUgdmFsdWVzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblBvd2VyID0gTWF0aC5taW4oNDAwLjAsIE1hdGguYWJzKGFuYWx5c2lzLmludGVuc2l0eSkgKiAxNTAwLjApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblNpZ24gPSBNYXRoLnNpZ24oYW5hbHlzaXMuaW50ZW5zaXR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwaW5WZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCBzcGluUG93ZXIgKiBzcGluU2lnbiwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KfQoKICAgICAgICAgICAgICAgICAgICAvLyBFWEVDVVRFCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaXNDaGFyZ2luZykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWwgUmVsZWFzZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3BpblZlYykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVW5pZmllZCBzcGluIHBhc3NpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAucmVsZWFzZUNoYXJnZShkeCwgZHksIHsgaW50ZW5zaXR5OiBjdXJ2ZURhdGEuaW50ZW5zaXR5LCBzcGVlZDogY3VydmVEYXRhLnNwZWVkIH0pOyAKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAucmVsZWFzZUNoYXJnZShkeCwgZHksIGN1cnZlRGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAod2FzQnVmZmVyZWQgJiYgcC5oYXNCYWxsICYmICFwLmlzVGhyb3dpbmcgJiYgcC5zdGF0dXMubmFwIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQnVmZmVyZWQgVGFwIChJbnN0YW50IFNob3QpCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvcmNlIHN0YXJ0IGFuZCByZWxlYXNlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlQ2hhcmdlKGR4LCBkeSwgY3VydmVEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlU3RhcnQsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBoYW5kbGVTdGFydCk7CiAgICAgICAgfTsKICAgICAgICBzZXR1cEJ1dHRvbihhY3Rpb25CdG4pOwoKLy8gQXV0byBUb2dnbGUKICAgICAgICBjb25zdCBhdXRvQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F1dG8tdG9nZ2xlJyk7CiAgICAgICAgaWYgKGF1dG9CdG4pIHsKICAgICAgICAgICAgY29uc3QgaGFuZGxlVG9nZ2xlID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci50b2dnbGVEZW1vTW9kZSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGF1dG9CdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBoYW5kbGVUb2dnbGUpOwphdXRvQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgaGFuZGxlVG9nZ2xlKCk7CiAgICAgICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IFNldHRpbmdzIEJ1dHRvbgogICAgICAgIHNldHVwU2V0dGluZ3NCdXR0b24oKTsKICAgIH0KCiAgICAvLyBORVc6IEFpbSBKb3lzdGljayBTZXR1cAovLyBORVc6IEFpbSBKb3lzdGljayBTZXR1cApmdW5jdGlvbiBzZXR1cEFpbUpveXN0aWNrKCkgewogICAgICAgIGNvbnN0IGFpbUtub2IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWltLWpveXN0aWNrLWtub2InKTsKICAgICAgICBjb25zdCBhaW1WaXN1YWxzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1qb3lzdGljay12aXN1YWwnKTsKICAgICAgICBjb25zdCBhaW1ab25lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1qb3lzdGljay16b25lJyk7CiAgICAgICAgaWYgKCFhaW1ab25lKSByZXR1cm47CiAgICAgICAgbGV0IGFpbVN0YXJ0WCA9IDAsIGFpbVN0YXJ0WSA9IDA7CiAgICAgICAgbGV0IGFpbURyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgY29uc3QgYWltTWF4RGlzdCA9IDM1OwogICAgICAgIGxldCBhaW1Ub3VjaElkID0gbnVsbDsKCiAgICAgICAgCgogICAgICAgIC8vIEV4cG9zZSBhaW0gam95c3RpY2sgc3RhdGUgZm9yIHNuYXBzaG90cwogICAgICAgIGNvbnN0IF9kYmcgPSB3aW5kb3cuZmx1eC5fZGVidWdJTyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIHx8IHt9OwogICAgICAgIF9kYmcuc2V0dGluZ3MgPSBfc2V0dGluZ3M7CiAgICAgICAgX2RiZy5pbnB1dCA9IF9kYmcuaW5wdXQgfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5haW0gPSBfZGJnLmlucHV0LmFpbSB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0LmFpbS52ZWN0b3IgPSBfYWltSW5wdXQ7CiAgICAgICAgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsKICAgICAgICBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsKY29uc3QgaGFuZGxlQWltU3RhcnQgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBhaW1EcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgIGFpbVN0YXJ0WCA9IGNsaWVudFg7CgogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7IH0KCiAgICAgICAgICAgIGFpbVN0YXJ0WSA9IGNsaWVudFk7CiAgICAgICAgICAgIF9haW1JbnB1dC5hY3RpdmUgPSB0cnVlOwoKICAgICAgICAgICAgaWYgKGFpbVZpc3VhbHMpIHsKICAgICAgICAgICAgICAgIGFpbVZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLmxlZnQgPSBgJHtjbGllbnRYfXB4YDsKICAgICAgICAgICAgICAgIGFpbVZpc3VhbHMuc3R5bGUudG9wID0gYCR7Y2xpZW50WX1weGA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGFpbUtub2IpIHsKICAgICAgICAgICAgICAgIGFpbUtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgtNTAlLCAtNTAlKWA7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVBaW1Nb3ZlID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGR4ID0gY2xpZW50WCAtIGFpbVN0YXJ0WDsKICAgICAgICAgICAgbGV0IGR5ID0gY2xpZW50WSAtIGFpbVN0YXJ0WTsKCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgogICAgICAgICAgICBpZiAoZGlzdCA+IGFpbU1heERpc3QpIHsKICAgICAgICAgICAgICAgIGR4ID0gKGR4IC8gZGlzdCkgKiBhaW1NYXhEaXN0OwogICAgICAgICAgICAgICAgZHkgPSAoZHkgLyBkaXN0KSAqIGFpbU1heERpc3Q7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhaW1Lbm9iKSB7CiAgICAgICAgICAgICAgICBhaW1Lbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoY2FsYygtNTAlICsgJHtkeH1weCksIGNhbGMoLTUwJSArICR7ZHl9cHgpKWA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSBhbmQgdHJhbnNmb3JtIHRvIHdvcmxkIHNwYWNlCiAgICAgICAgICAgIF9haW1JbnB1dC54ID0gZHggLyBhaW1NYXhEaXN0OwogICAgICAgICAgICBfYWltSW5wdXQueSA9IGR5IC8gYWltTWF4RGlzdDsKCiAgICAgICAgICAgIC8vIEFwcGx5IGFpbSB0byBwbGF5ZXIgaWYgY2hhcmdpbmcKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIGlmIChwLmlzQ2hhcmdpbmcgfHwgcC5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVHJhbnNmb3JtIHNjcmVlbiBhaW0gdG8gd29ybGQgc3BhY2UKICAgICAgICAgICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9jYW1Gd2QubGVuZ3RoU3EoKSA8IDAuMDAxKSBfY2FtRndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBfY2FtRndkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWCA9IChfY2FtUmlnaHQueCAqIF9haW1JbnB1dC54KSArIChfY2FtRndkLnggKiAtX2FpbUlucHV0LnkpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWiA9IChfY2FtUmlnaHQueiAqIF9haW1JbnB1dC54KSArIChfY2FtRndkLnogKiAtX2FpbUlucHV0LnkpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMod29ybGRYKSA+IDAuMSB8fCBNYXRoLmFicyh3b3JsZFopID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0T3ZlcnJpZGVBaW0od29ybGRYLCB3b3JsZFopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07Cgpjb25zdCBoYW5kbGVBaW1FbmQgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgYWltRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgX2FpbUlucHV0LmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICBfYWltSW5wdXQueCA9IDA7CiAgICAgICAgICAgIF9haW1JbnB1dC55ID0gMDsKCiAgICAgICAgICAgIGlmIChhaW1WaXN1YWxzKSB7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENsZWFyIHBsYXllciBhaW0gb3ZlcnJpZGUKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGFpbVpvbmUuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgY29uc3QgdCA9IChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXNbMF0pID8gZS5jaGFuZ2VkVG91Y2hlc1swXSA6IGUudG91Y2hlc1swXTsKICAgICAgICAgICAgYWltVG91Y2hJZCA9IHQgPyB0LmlkZW50aWZpZXIgOiBudWxsOwogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLnRvdWNoSWQgPSBhaW1Ub3VjaElkOyB9CiAgICAgICAgICAgIGhhbmRsZUFpbVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIGFpbVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgaGFuZGxlQWltTW92ZSh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIGFpbVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsKICAgICAgICAgICAgYWltVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgIGhhbmRsZUFpbUVuZCgpOwogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLnRvdWNoSWQgPSBhaW1Ub3VjaElkOyBfZGJnLmlucHV0LmFpbS5kcmFnZ2luZyA9IGFpbURyYWdnaW5nOyB9CiAgICAgICAgICAgIGhhbmRsZUFpbUVuZCgpOwogICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBhaW1Ub3VjaElkKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGFpbVRvdWNoSWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVBaW1FbmQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsgfQogICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVBaW1FbmQoKTsKICAgICAgICB9KTsKLy8gTW91c2Ugc3VwcG9ydCBmb3IgZGVza3RvcCB0ZXN0aW5nCiAgICAgICAgYWltWm9uZS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICBoYW5kbGVBaW1TdGFydChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChhaW1EcmFnZ2luZykgaGFuZGxlQWltTW92ZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoYWltRHJhZ2dpbmcpIGhhbmRsZUFpbUVuZCgpOwogICAgICAgIH0pOwogICAgfQoKICAgIC8vIE5FVzogVGFja2xlIEJ1dHRvbiBTZXR1cAogICAgZnVuY3Rpb24gc2V0dXBUYWNrbGVCdXR0b24oKSB7CiAgICAgICAgY29uc3QgdGFja2xlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RhY2tsZS1idXR0b24nKTsKICAgICAgICBpZiAoIXRhY2tsZUJ0bikgcmV0dXJuOwoKY29uc3QgaGFuZGxlVGFja2xlID0gKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyAvLyBQcmV2ZW50IGJ1YmJsaW5nIHRvIGpveXN0aWNrCgogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pc0RlbW9Nb2RlKSByZXR1cm47CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjayBpbW1lZGlhdGVseQogICAgICAgICAgICAgICAgdGFja2xlQnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0YWNrbGVCdG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyksIDE1MCk7CgogICAgICAgICAgICAgICAgLy8gSWYgd2UgZG9uJ3QgaGF2ZSB0aGUgYmFsbCwgZGFzaC90YWNrbGUKICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gR2V0IGN1cnJlbnQgbW92ZW1lbnQgZGlyZWN0aW9uIG9yIGZvcndhcmQKICAgICAgICAgICAgICAgICAgICBsZXQgZGFzaFggPSBwLmlucHV0VmVjdG9yLng7CiAgICAgICAgICAgICAgICAgICAgbGV0IGRhc2haID0gcC5pbnB1dFZlY3Rvci56OwoKICAgICAgICAgICAgICAgICAgICAvLyBJZiBub3QgbW92aW5nLCBkYXNoIGZvcndhcmQgcmVsYXRpdmUgdG8gcGxheWVyIGZhY2luZwogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhkYXNoWCkgPCAwLjEgJiYgTWF0aC5hYnMoZGFzaFopIDwgMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihwLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhc2hYID0gZndkLng7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhc2haID0gZndkLno7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBwLmRhc2goZGFzaFgsIGRhc2haKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT25seSBzaG93IHRleHQgaWYgZGFzaCBhY3R1YWxseSBoYXBwZW5lZCAoY29vbGRvd24gY2hlY2sgaW5zaWRlIGRhc2gpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLmlzRGFzaGluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiVEFDS0xFISIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocC5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBCcmVhayB0YWNrbGUgaWYgZW5nYWdlZAogICAgICAgICAgICAgICAgICAgIHAuZGFzaChwLmlucHV0VmVjdG9yLngsIHAuaW5wdXRWZWN0b3Iueik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB0YWNrbGVCdG4uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGhhbmRsZVRhY2tsZSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICB0YWNrbGVCdG4uYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgaGFuZGxlVGFja2xlKTsKICAgIH0KCiAgICAvLyBORVc6IFNldHRpbmdzIEJ1dHRvbiBTZXR1cAovLyBORVc6IFNldHRpbmdzIEJ1dHRvbiBTZXR1cApmdW5jdGlvbiBzZXR1cFNldHRpbmdzQnV0dG9uKCkgewogICAgICAgIGNvbnN0IHNldHRpbmdzQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NldHRpbmdzLWJ1dHRvbicpOwogICAgICAgIGNvbnN0IHNldHRpbmdzUGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2V0dGluZ3MtcGFuZWwnKTsKICAgICAgICBjb25zdCBzZXR0aW5nc0Nsb3NlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NldHRpbmdzLWNsb3NlJyk7CgogICAgICAgIGlmICghc2V0dGluZ3NCdG4gfHwgIXNldHRpbmdzUGFuZWwpIHJldHVybjsKCiAgICAgICAgc2V0dGluZ3NCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgIHNldHRpbmdzUGFuZWwuc3R5bGUuZGlzcGxheSA9IHNldHRpbmdzUGFuZWwuc3R5bGUuZGlzcGxheSA9PT0gJ25vbmUnID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICB9KTsKCiAgICAgICAgaWYgKHNldHRpbmdzQ2xvc2UpIHsKICAgICAgICAgICAgc2V0dGluZ3NDbG9zZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgICAgIHNldHRpbmdzUGFuZWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBTZW5zaXRpdml0eSBzbGlkZXIKICAgICAgICBjb25zdCBzZW5zaXRpdml0eVNsaWRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZW5zaXRpdml0eS1zbGlkZXInKTsKICAgICAgICBpZiAoc2Vuc2l0aXZpdHlTbGlkZXIpIHsKICAgICAgICAgICAgc2Vuc2l0aXZpdHlTbGlkZXIudmFsdWUgPSBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eSAqIDEwMDsKICAgICAgICAgICAgc2Vuc2l0aXZpdHlTbGlkZXIuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgX3NldHRpbmdzLmpveXN0aWNrU2Vuc2l0aXZpdHkgPSBlLnRhcmdldC52YWx1ZSAvIDEwMDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBBaW0gYXNzaXN0IHRvZ2dsZQogICAgICAgIGNvbnN0IGFpbUFzc2lzdFRvZ2dsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaW0tYXNzaXN0LXRvZ2dsZScpOwogICAgICAgIGlmIChhaW1Bc3Npc3RUb2dnbGUpIHsKICAgICAgICAgICAgYWltQXNzaXN0VG9nZ2xlLmNoZWNrZWQgPSBfc2V0dGluZ3MuYWltQXNzaXN0OwogICAgICAgICAgICBhaW1Bc3Npc3RUb2dnbGUuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIF9zZXR0aW5ncy5haW1Bc3Npc3QgPSBlLnRhcmdldC5jaGVja2VkOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIENhbWVyYSBzaGFrZSB0b2dnbGUKICAgICAgICBjb25zdCBzaGFrZVRvZ2dsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzaGFrZS10b2dnbGUnKTsKICAgICAgICBpZiAoc2hha2VUb2dnbGUpIHsKICAgICAgICAgICAgc2hha2VUb2dnbGUuY2hlY2tlZCA9IF9zZXR0aW5ncy5jYW1lcmFTaGFrZTsKICAgICAgICAgICAgc2hha2VUb2dnbGUuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIF9zZXR0aW5ncy5jYW1lcmFTaGFrZSA9IGUudGFyZ2V0LmNoZWNrZWQ7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gVm9sdW1lIHNsaWRlcgogICAgICAgIGNvbnN0IHZvbHVtZVNsaWRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd2b2x1bWUtc2xpZGVyJyk7CiAgICAgICAgaWYgKHZvbHVtZVNsaWRlciAmJiBfYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgIHZvbHVtZVNsaWRlci5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB2b2wgPSBlLnRhcmdldC52YWx1ZSAvIDEwMDsKX2F1ZGlvTWFuYWdlci5zZXRNYXN0ZXJWb2x1bWUodm9sKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBFeGl0IHRvIE1lbnUKICAgICAgICBjb25zdCBleGl0QnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2V4aXQtdG8tbWVudS1idG4nKTsKICAgICAgICBpZiAoZXhpdEJ0bikgewogICAgICAgICAgICBleGl0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKF9tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIF9tZW51TWFuYWdlci5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIuc3RhdGUgPSAnbWVudSc7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgcHJhY3RpY2UgaWYgcnVubmluZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlSW5wdXRWZWN0b3IoKSB7CiAgICAgICAgbGV0IHggPSBfaW5wdXQueCB8fCAwOwogICAgICAgIGxldCB6ID0gX2lucHV0LnkgfHwgMDsKCiAgICAgICAgaWYgKF9rZXlzWyd3J10gfHwgX2tleXNbJ0Fycm93VXAnXSkgeiAtPSAxOwogICAgICAgIGlmIChfa2V5c1sncyddIHx8IF9rZXlzWydBcnJvd0Rvd24nXSkgeiArPSAxOwogICAgICAgIGlmIChfa2V5c1snYSddIHx8IF9rZXlzWydBcnJvd0xlZnQnXSkgeCAtPSAxOwogICAgICAgIGlmIChfa2V5c1snZCddIHx8IF9rZXlzWydBcnJvd1JpZ2h0J10pIHggKz0gMTsKCiAgICAgICAgY29uc3QgbGVuU3EgPSB4KnggKyB6Kno7CiAgICAgICAgaWYgKGxlblNxID4gMSkgewogICAgICAgICAgICBjb25zdCBsZW4gPSBNYXRoLnNxcnQobGVuU3EpOwogICAgICAgICAgICB4IC89IGxlbjsKICAgICAgICAgICAgeiAvPSBsZW47CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNOYU4oeCkpIHggPSAwOwogICAgICAgIGlmIChpc05hTih6KSkgeiA9IDA7CgogICAgICAgIGlmIChfY2FtZXJhKSB7CiAgICAgICAgICAgIF9jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CgogICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICBfY2FtUmlnaHQuc2V0KDEsIDAsIDApOwogICAgICAgIH0KCiAgICAgICAgbGV0IHdvcmxkWCA9IChfY2FtRndkLnggKiAteikgKyAoX2NhbVJpZ2h0LnggKiB4KTsKICAgICAgICBsZXQgd29ybGRaID0gKF9jYW1Gd2QueiAqIC16KSArIChfY2FtUmlnaHQueiAqIHgpOwoKICAgICAgICBpZiAoaXNOYU4od29ybGRYKSB8fCBpc05hTih3b3JsZFopKSB7CiAgICAgICAgICAgIHdvcmxkWCA9IDA7CiAgICAgICAgICAgIHdvcmxkWiA9IDA7CiAgICAgICAgfQoKaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgIC8vIEZJWDogT25seSBhbGxvdyBtb3ZlbWVudCBpZiBnYW1lIGlzIGFjdGl2ZSBvciBpbiBwcmFjdGljZQogICAgICAgICAgICBjb25zdCBnbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgY2FuTW92ZSA9IGdtICYmICFnbS5pc0RlbW9Nb2RlICYmIChnbS5zdGF0ZSA9PT0gJ2FjdGl2ZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGNhbk1vdmUpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQod29ybGRYLCB3b3JsZFopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZVJpcHBsZSh4LCB5KSB7CiAgICAgICAgY29uc3QgcmlwcGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgcmlwcGxlLmNsYXNzTmFtZSA9ICd0b3VjaC1yaXBwbGUnOwogICAgICAgIHJpcHBsZS5zdHlsZS5sZWZ0ID0gYCR7eH1weGA7CiAgICAgICAgcmlwcGxlLnN0eWxlLnRvcCA9IGAke3l9cHhgOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpLmFwcGVuZENoaWxkKHJpcHBsZSk7CgogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAocmlwcGxlLnBhcmVudE5vZGUpIHJpcHBsZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHJpcHBsZSk7CiAgICAgICAgfSwgNjAwKTsKCiAgICB9CgogICAgLy8gTkVXOiBWaXN1YWwgU3dpcGUgVHJhaWwKICAgIGZ1bmN0aW9uIGNyZWF0ZVN3aXBlVHJhaWxEb3QoeCwgeSkgewogICAgICAgIGNvbnN0IGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIGRvdC5jbGFzc05hbWUgPSAnc3dpcGUtdHJhaWwtZG90JzsKICAgICAgICBkb3Quc3R5bGUubGVmdCA9IGAke3ggLSA2fXB4YDsgLy8gQ2VudGVyICgxMnB4IHdpZHRoKQogICAgICAgIGRvdC5zdHlsZS50b3AgPSBgJHt5IC0gNn1weGA7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJykuYXBwZW5kQ2hpbGQoZG90KTsKICAgICAgICAKICAgICAgICAvLyBDU1MgYW5pbWF0aW9uIGhhbmRsZXMgcmVtb3ZhbCwgYnV0IHdlIGNsZWFuIHVwIERPTSB0byBiZSBzYWZlCiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGlmIChkb3QucGFyZW50Tm9kZSkgZG90LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZG90KTsKICAgICAgICB9LCA1MDApOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uUmVzaXplKCkgewogICAgICAgIGNvbnN0IHdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgIAogICAgICAgIGlmIChfY2FtZXJhKSB7CiAgICAgICAgICAgIF9jYW1lcmEuYXNwZWN0ID0gd2lkdGggLyBoZWlnaHQ7CiAgICAgICAgICAgIF9jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBTdHJpY3RseSAwLjUwIGFzIHJlcXVlc3RlZAogICAgICAgIGNvbnN0IHJlc1NjYWxlID0gMC41MDsKICAgICAgICAKICAgICAgICBfY29uZmlnLmludGVybmFsV2lkdGggPSBNYXRoLmZsb29yKHdpZHRoICogcmVzU2NhbGUpOwogICAgICAgIF9jb25maWcuaW50ZXJuYWxIZWlnaHQgPSBNYXRoLmZsb29yKGhlaWdodCAqIHJlc1NjYWxlKTsKCiAgICAgICAgaWYgKF9yZW5kZXJlcikgewogICAgICAgICAgICBfcmVuZGVyZXIuc2V0U2l6ZShfY29uZmlnLmludGVybmFsV2lkdGgsIF9jb25maWcuaW50ZXJuYWxIZWlnaHQsIGZhbHNlKTsKICAgICAgICB9CiAgICB9CgovLyAtLS0gRklYRUQgVElNRVNURVAgVkFSSUFCTEVTIC0tLQogICAgbGV0IF9hY2N1bXVsYXRvciA9IDA7CiAgICBjb25zdCBfZml4ZWRTdGVwID0gMSAvIDYwOwoKICAgIGZ1bmN0aW9uIGFuaW1hdGUoKSB7CiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwoKICAgICAgICBjb25zdCByYXdEdCA9IF9jbG9jay5nZXREZWx0YSgpOwogICAgICAgIC8vIENsYW1wIGR0IHRvIHByZXZlbnQgc3BpcmFscyAobWF4IDAuMXMpCiAgICAgICAgY29uc3QgZHQgPSBNYXRoLm1pbihyYXdEdCwgMC4xKSAqICh3aW5kb3cuZmx1eC50aW1lU2NhbGUgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA6IDAuOCk7CgogICAgICAgIC8vIFBlcmYgc3RhdHMgZm9yIERldlRvb2xzCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPLnBlcmYpIHsKICAgICAgICAgICAgY29uc3QgcGVyZiA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPLnBlcmY7CiAgICAgICAgICAgIHBlcmYuZnJhbWUgPSAocGVyZi5mcmFtZSB8fCAwKSArIDE7CiAgICAgICAgICAgIHBlcmYucmF3RHQgPSByYXdEdDsKICAgICAgICAgICAgcGVyZi5kdCA9IGR0OwogICAgICAgICAgICBjb25zdCBmcHMgPSBkdCA+IDAgPyAoMSAvIGR0KSA6IDA7CiAgICAgICAgICAgIHBlcmYuZnBzID0gZnBzOwogICAgICAgICAgICBwZXJmLmF2Z0ZwcyA9IChwZXJmLmF2Z0ZwcyAmJiBwZXJmLmF2Z0ZwcyA+IDApID8gKHBlcmYuYXZnRnBzICogMC45ICsgZnBzICogMC4xKSA6IGZwczsKICAgICAgICB9CgogICAgICAgIC8vIEltcGFjdCBGcmFtZXMgKEZyZWV6ZSBGcmFtZSBFZmZlY3QpCiAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaW1wYWN0UGF1c2UgPiAwKSB7CiAgICAgICAgICAgIF9nYW1lTWFuYWdlci5pbXBhY3RQYXVzZSAtPSBkdDsKICAgICAgICAgICAgaWYgKF9yZW5kZXJlciAmJiBfc2NlbmUgJiYgX2NhbWVyYSkgewogICAgICAgICAgICAgICAgX3JlbmRlcmVyLnJlbmRlcihfc2NlbmUsIF9jYW1lcmEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CgogICAgICAgIC8vIEFjdGlvbiBCdWZmZXIgUHJvY2Vzc2luZwogICAgICAgIGlmIChfYWN0aW9uQnVmZmVyLmFjdGl2ZSkgewogICAgICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIF9hY3Rpb25CdWZmZXIudGltZXN0YW1wID4gX2FjdGlvbkJ1ZmZlci5kdXJhdGlvbikgewogICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgJiYgIXAuaXNDaGFyZ2luZyAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ0bikgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIEZJWEVEIFVQREFURSBMT09QIChQaHlzaWNzICYgR2FtZSBMb2dpYykgLS0tCiAgICAgICAgX2FjY3VtdWxhdG9yICs9IGR0OwogICAgICAgIC8vIFNhZmV0eSBDYXA6IFByZXZlbnQgc3BpcmFsIG9mIGRlYXRoIGlmIGZyYW1lIHRha2VzIHRvbyBsb25nCiAgICAgICAgaWYgKF9hY2N1bXVsYXRvciA+IDAuMikgX2FjY3VtdWxhdG9yID0gMC4yOwoKICAgICAgICB3aGlsZSAoX2FjY3VtdWxhdG9yID49IF9maXhlZFN0ZXApIHsKICAgICAgICAgICAgY29uc3QgX3NkdCA9IF9maXhlZFN0ZXA7CgogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSBfZ2FtZU1hbmFnZXIudXBkYXRlKF9zZHQpOwoKICAgICAgICAgICAgLy8gSWYgaW4gQXNzZXQgRm9yZ2UgbW9kZSwgc2tpcCBnYW1lIGxvZ2ljCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmlzRm9yZ2VNb2RlKSB7CiAgICAgICAgICAgICAgICBfYWNjdW11bGF0b3IgPSAwOyAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ21TdGF0ZSA9IF9nYW1lTWFuYWdlciA/IF9nYW1lTWFuYWdlci5zdGF0ZSA6ICcnOwogICAgICAgICAgICBjb25zdCBpc0ludHJvID0gZ21TdGF0ZSA9PT0gJ2ludHJvJzsKICAgICAgICAgICAgY29uc3QgaXNNZW51ID0gZ21TdGF0ZSA9PT0gJ21lbnUnOwoKICAgICAgICAgICAgLy8gVXBkYXRlIEVudGl0aWVzIChQaHlzaWNzL0FJKQogICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmICFpc0ludHJvICYmICFpc01lbnUpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS51cGRhdGUoX3NkdCk7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gY2hlY2tCYWxsR3JhYihwKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChfYXdheVRlYW0gJiYgIWlzSW50cm8gJiYgIWlzTWVudSkgewogICAgICAgICAgICAgICAgX2F3YXlUZWFtLnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiBjaGVja0JhbGxHcmFiKHApKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKF9iYWxsICYmICFpc0ludHJvICYmICFpc01lbnUpIHsKICAgICAgICAgICAgICAgIF9iYWxsLnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmFsbCBMYWIKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWIgJiYgdHlwZW9mIHdpbmRvdy5mbHV4LmJhbGxMYWIudXBkYXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5iYWxsTGFiLnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUnVudGltZSBVcGRhdGVycyAoZS5nLiBSaW5ncyBsb2dpYykKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgJiYgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IHVpID0gMDsgdWkgPCB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLmxlbmd0aDsgdWkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZuID0gd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVyc1t1aV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJykgZm4oX3NkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9hY2N1bXVsYXRvciAtPSBfZml4ZWRTdGVwOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIFZJU1VBTCBVUERBVEUgTE9PUCAoT25jZSBQZXIgRnJhbWUpIC0tLQogICAgICAgIC8vIFRoZXNlIHN5c3RlbXMgZG9uJ3QgYWZmZWN0IGdhbWVwbGF5IG91dGNvbWUsIHNvIHdlIHVwZGF0ZSB0aGVtIHdpdGggdGhlIHZpc3VhbCBkZWx0YSBgZHRgCiAgICAgICAgLy8gdG8gZW5zdXJlIHNtb290aCBhbmltYXRpb24gYXQgaGlnaCByZWZyZXNoIHJhdGVzICg5MC8xMjBIeikgd2l0aG91dCB3YXN0aW5nIENQVSBvbiBwaHlzaWNzLgoKICAgICAgICBjb25zdCBnbVN0YXRlID0gX2dhbWVNYW5hZ2VyID8gX2dhbWVNYW5hZ2VyLnN0YXRlIDogJyc7CiAgICAgICAgY29uc3QgaXNJbnRybyA9IGdtU3RhdGUgPT09ICdpbnRybyc7CiAgICAgICAgY29uc3QgaXNNZW51ID0gZ21TdGF0ZSA9PT0gJ21lbnUnOwoKICAgICAgICAvLyBDYW1lcmEKICAgICAgICBpZiAoIWlzSW50cm8gJiYgIWlzTWVudSkgewogICAgICAgICAgICB1cGRhdGVDYW1lcmFMb2dpYyhkdCk7CiAgICAgICAgfQoKICAgICAgICAvLyBWaXN1YWwgRlggU3lzdGVtcwogICAgICAgIGlmIChfd2F0ZXJPdmVybGF5KSBfd2F0ZXJPdmVybGF5LnVwZGF0ZShkdCk7CiAgICAgICAgaWYgKF9saWdodFNoYWZ0cykgX2xpZ2h0U2hhZnRzLnVwZGF0ZShkdCk7CiAgICAgICAgaWYgKF9zdGFkaXVtKSBfc3RhZGl1bS51cGRhdGUoZHQpOwogICAgICAgIGlmIChfZ2x5cGhNYW5hZ2VyKSBfZ2x5cGhNYW5hZ2VyLnVwZGF0ZShkdCk7CgppZiAoX2dseXBoTWFuYWdlcikgX2dseXBoTWFuYWdlci51cGRhdGUoZHQpOwogICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIF9nYW1lTWFuYWdlci51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICBpZiAoX2FyZW5hVW5pZm9ybXMpIHsKICAgICAgICAgICAgX2FyZW5hVW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RTdHIudmFsdWUgKj0gTWF0aC5tYXgoMCwgMS4wIC0gZHQgKiA0LjApOwogICAgICAgIH0KCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hR3JvdXApIHsKICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5yb3RhdGlvbi55ICs9IGR0ICogMC4wNTsKICAgICAgICB9CgogICAgICAgIGlmICh3aW5kb3cuZmx1eC50cmliYWxVbmlmb3JtcykgewogICAgICAgICAgICB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgbGV0IHRhcmdldENvbG9yID0gbmV3IFRIUkVFLkNvbG9yKDB4MDBmZmZmKTsKICAgICAgICAgICAgaWYgKF9iYWxsICYmIF9iYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKF9iYWxsLmhvbGRlci50ZWFtICYmIF9iYWxsLmhvbGRlci50ZWFtLnNpZGUgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Q29sb3Iuc2V0SGV4KDB4ZmY4ODAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3Jtcy51Q29sb3IudmFsdWUubGVycCh0YXJnZXRDb2xvciwgZHQgKiAyLjApOwogICAgICAgIH0KCiAgICAgICAgaWYgKF9wYXJ0aWNsZVVuaWZvcm1zKSB7CiAgICAgICAgICAgIF9wYXJ0aWNsZVVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgIH0KCiAgICAgICAgLy8gUmVuZGVyCiAgICAgICAgaWYgKF9yZW5kZXJlciAmJiBfc2NlbmUgJiYgX2NhbWVyYSkgewogICAgICAgICAgICBfcmVuZGVyZXIucmVuZGVyKF9zY2VuZSwgX2NhbWVyYSk7CiAgICAgICAgfQoKICAgICAgICAvLyBVSSBVcGRhdGVzCiAgICAgICAgdXBkYXRlVUkoKTsKICAgIH0KCmZ1bmN0aW9uIHVwZGF0ZVVJKCkgewogICAgICAgIC8vIFByZXZlbnQgVUkgdXBkYXRlcyBkdXJpbmcgaW50cm8gdG8ga2VlcCB0aGluZ3MgaGlkZGVuCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPT09ICdpbnRybycpIHJldHVybjsKCiAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybjsKICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWJ1dHRvbicpOwogICAgICAgIGNvbnN0IGxibCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY3Rpb24tbGFiZWwnKTsKICAgICAgICBjb25zdCB0YWNrbGVCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGFja2xlLWJ1dHRvbicpOwogICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICBpZiAoYnRuICYmIGxibCkgewogICAgICAgICAgICBjb25zdCBidG5UZXh0ID0gYnRuLnF1ZXJ5U2VsZWN0b3IoJy5idG4tdGV4dCcpOwoKICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgaWYgKGJ0blRleHQgJiYgYnRuVGV4dC5pbm5lclRleHQgIT09ICJBQ1RJT04iKSB7CiAgICAgICAgICAgICAgICAgICAgYnRuVGV4dC5pbm5lclRleHQgPSAiQUNUSU9OIjsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnc2hvb3QtbW9kZScpOwogICAgICAgICAgICAgICAgICAgIGxibC5pbm5lclRleHQgPSAiT0ZGRU5TRSI7CiAgICAgICAgICAgICAgICAgICAgbGJsLmNsYXNzTGlzdC5hZGQoJ3Nob290LWxhYmVsJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgaXNIaWdoRW5lcmd5ID0gKHAuc3RhdHMuSFAgLyBwLnN0YXRzLm1heEhQKSA+IDAuNDsKICAgICAgICAgICAgICAgIGlmIChpc0hpZ2hFbmVyZ3kpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWJ0bi5jbGFzc0xpc3QuY29udGFpbnMoJ2xpbWl0LXJlYWR5JykpIGJ0bi5jbGFzc0xpc3QuYWRkKCdsaW1pdC1yZWFkeScpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYnRuLmNsYXNzTGlzdC5jb250YWlucygnbGltaXQtcmVhZHknKSkgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2xpbWl0LXJlYWR5Jyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGJ0blRleHQgJiYgYnRuVGV4dC5pbm5lclRleHQgIT09ICJTV0lNIikgewogICAgICAgICAgICAgICAgICAgIGJ0blRleHQuaW5uZXJUZXh0ID0gIlNXSU0iOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdzaG9vdC1tb2RlJyk7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2xpbWl0LXJlYWR5Jyk7CiAgICAgICAgICAgICAgICAgICAgbGJsLmlubmVyVGV4dCA9ICJOT1JNQUwiOwogICAgICAgICAgICAgICAgICAgIGxibC5jbGFzc0xpc3QucmVtb3ZlKCdzaG9vdC1sYWJlbCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBVcGRhdGUgdGFja2xlIGJ1dHRvbiB2aXNpYmlsaXR5CiAgICAgICAgaWYgKHRhY2tsZUJ0bikgewogICAgICAgICAgICBpZiAoIXAuaGFzQmFsbCB8fCBwLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgdGFja2xlQnRuLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgdGFja2xlIGJ1dHRvbiB0ZXh0IGJhc2VkIG9uIGNvbnRleHQKICAgICAgICAgICAgICAgIGNvbnN0IHRhY2tsZVRleHQgPSB0YWNrbGVCdG4ucXVlcnlTZWxlY3RvcignLmJ0bi10ZXh0Jyk7CiAgICAgICAgICAgICAgICBpZiAodGFja2xlVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGlmIChwLmlzRW5nYWdlZCAmJiBwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFja2xlVGV4dC5pbm5lclRleHQgPSAnQlJFQUsnOwogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVCdG4uY2xhc3NMaXN0LmFkZCgndXJnZW50Jyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFja2xlVGV4dC5pbm5lclRleHQgPSAnVEFDS0xFJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGFja2xlQnRuLmNsYXNzTGlzdC5yZW1vdmUoJ3VyZ2VudCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBVcGRhdGUgZGlzdGFuY2UgdG8gZ29hbCBpbmRpY2F0b3IKICAgICAgICBjb25zdCBkaXN0SW5kaWNhdG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvYWwtZGlzdGFuY2UnKTsKICAgICAgICBpZiAoZGlzdEluZGljYXRvciAmJiBwLm1lc2gpIHsKICAgICAgICAgICAgY29uc3QgZ29hbFogPSAocC50ZWFtICYmIHAudGVhbS5zaWRlID09PSAxKSA/IC0yOCA6IDI4OwogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5hYnMocC5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgIGRpc3RJbmRpY2F0b3IuaW5uZXJUZXh0ID0gYCR7TWF0aC5mbG9vcihkaXN0KX1tYDsKICAgICAgICB9CiAgICB9CgpmdW5jdGlvbiB1cGRhdGVDYW1lcmFMb2dpYyhkdCkgewogICAgICAgIGlmICghX2NhbWVyYU1hbmFnZXIgfHwgIV9iYWxsKSByZXR1cm47CgogICAgICAgIGxldCB0YXJnZXRNZXNoID0gX2JhbGwubWVzaDsKICAgICAgICBsZXQgdGFyZ2V0VmVsID0gX2JhbGwudmVsb2NpdHk7CiAgICAgICAgbGV0IHRhcmdldElucHV0ID0gbnVsbDsKICAgICAgICBsZXQgaXNBaW1pbmcgPSBmYWxzZTsKCiAgICAgICAgaWYgKF9iYWxsLmhvbGRlciAmJiBfYmFsbC5ob2xkZXIubWVzaCkgewogICAgICAgICAgICB0YXJnZXRNZXNoID0gX2JhbGwuaG9sZGVyLm1lc2g7CiAgICAgICAgICAgIHRhcmdldFZlbCA9IF9iYWxsLmhvbGRlci52ZWxvY2l0eTsKICAgICAgICAgICAgaWYgKF9iYWxsLmhvbGRlci5pbnB1dFZlY3RvcikgewogICAgICAgICAgICAgICAgdGFyZ2V0SW5wdXQgPSBfYmFsbC5ob2xkZXIuaW5wdXRWZWN0b3I7CiAgICAgICAgICAgIH0KLy8gQ2hlY2sgYWltaW5nIHN0YXRlIChDaGFyZ2luZyBvciBUaHJvd2luZykKICAgICAgICAgICAgaWYgKF9iYWxsLmhvbGRlci5pc0NoYXJnaW5nIHx8IF9iYWxsLmhvbGRlci5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICBpc0FpbWluZyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnNldFRhcmdldCh0YXJnZXRNZXNoLCB0YXJnZXRWZWwsIHRhcmdldElucHV0LCBpc0FpbWluZyk7CiAgICAgICAgX2NhbWVyYU1hbmFnZXIudXBkYXRlKGR0KTsKICAgIH0KCmZ1bmN0aW9uIGNoZWNrQmFsbEdyYWIoZW50aXR5KSB7CiAgICAgICAgaWYgKCFlbnRpdHkuY2FuQ2F0Y2gpIHJldHVybjsKICAgICAgICBpZiAoX2JhbGwgJiYgIV9iYWxsLmlzQ2F0Y2hhYmxlKCkpIHJldHVybjsKICAgICAgICBpZiAoZW50aXR5LnN0dW5UaW1lciA+IDAgfHwgKGVudGl0eS5zdGF0dXMgJiYgZW50aXR5LnN0YXR1cy5uYXAgPiAwKSkgcmV0dXJuOwogICAgICAgIGlmIChfYmFsbC5zdGF0ZSAhPT0gJ2ZyZWUnKSByZXR1cm47CiAgICAgICAgaWYgKCFfYmFsbC5tZXNoIHx8ICFlbnRpdHkubWVzaCkgcmV0dXJuOwoKICAgICAgICBjb25zdCBiYWxsUG9zID0gX2JhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICBjb25zdCBlbnRQb3MgPSBlbnRpdHkubWVzaC5wb3NpdGlvbjsKCiAgICAgICAgY29uc3QgZHggPSBiYWxsUG9zLnggLSBlbnRQb3MueDsKICAgICAgICBjb25zdCBkeiA9IGJhbGxQb3MueiAtIGVudFBvcy56OwogICAgICAgIGNvbnN0IGRpc3RYWiA9IE1hdGguc3FydChkeCpkeCArIGR6KmR6KTsKICAgICAgICBjb25zdCBkaXN0WSA9IE1hdGguYWJzKGJhbGxQb3MueSAtIGVudFBvcy55KTsKCiAgICAgICAgLy8gLS0tIFJFTEFYRUQgVE9MRVJBTkNFUyBGT1IgRUFTSUVSIFBJQ0tVUCAtLS0KICAgICAgICBjb25zdCB0b3VjaFJhZGl1cyA9IDEuNTsgLy8gSW5jcmVhc2VkIGZyb20gMS4wIChBdXRvLWdyYWIgcmFkaXVzKQogICAgICAgIGxldCBtYWduZXRSYWRpdXMgPSAzLjU7ICAvLyBJbmNyZWFzZWQgZnJvbSAxLjggKE1hZ25ldGljIHJhZGl1cykKICAgICAgICBsZXQgaW50ZXJhY3Rpb25SYWRpdXMgPSA2LjA7IC8vIEluY3JlYXNlZCBmcm9tIDMuNSAoVHVybi10byByYWRpdXMpCiAgICAgICAgbGV0IGNhdGNoSGVpZ2h0ID0gNi4wOyAgIC8vIEluY3JlYXNlZCBmcm9tIDMuMCAoVmVydGljYWwgcmVhY2gpCgogICAgICAgIGlmIChlbnRpdHkuaXNEYXNoaW5nKSB7CiAgICAgICAgICAgIG1hZ25ldFJhZGl1cyA9IDQuNTsKICAgICAgICAgICAgaW50ZXJhY3Rpb25SYWRpdXMgPSA3LjA7CiAgICAgICAgICAgIGNhdGNoSGVpZ2h0ID0gNy4wOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRpc3RYWiA+IGludGVyYWN0aW9uUmFkaXVzIHx8IGRpc3RZID4gY2F0Y2hIZWlnaHQpIHJldHVybjsKCiAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBVc2Ugc2hhcmVkIHZlY3RvcnMgdG8gYXZvaWQgR0MKICAgICAgICBfdGVtcFZlYzEuY29weShiYWxsUG9zKS5zdWIoZW50UG9zKS5ub3JtYWxpemUoKTsgLy8gdG9CYWxsCiAgICAgICAgX3RlbXBWZWMyLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24oZW50aXR5Lm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7IC8vIHBsYXllckZvcndhcmQKCiAgICAgICAgY29uc3QgZmFjaW5nRG90ID0gX3RlbXBWZWMyLmRvdChfdGVtcFZlYzEpOwoKICAgICAgICBjb25zdCBjb25lVGhyZXNob2xkID0gLTAuNDsgLy8gTW9yZSBnZW5lcm91cyBjb25lICh3YXMgLTAuMikKICAgICAgICBjb25zdCBpc0luQ29uZSA9IGZhY2luZ0RvdCA+IGNvbmVUaHJlc2hvbGQ7CiAgICAgICAgCiAgICAgICAgLy8gQVVUTy1UVVJOOiBJZiBuZWFyIGJ1dCBmYWNpbmcgd3Jvbmcgd2F5LCB0dXJuIHRvd2FyZHMgYmFsbAogICAgICAgIGlmIChkaXN0WFogPCBpbnRlcmFjdGlvblJhZGl1cyAmJiAhaXNJbkNvbmUpIHsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0QW5nbGUgPSBNYXRoLmF0YW4yKF90ZW1wVmVjMS54LCBfdGVtcFZlYzEueik7CiAgICAgICAgICAgIGNvbnN0IHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUobmV3IFRIUkVFLlZlY3RvcjMoMCwxLDApLCB0YXJnZXRBbmdsZSk7CiAgICAgICAgICAgIGVudGl0eS5tZXNoLnF1YXRlcm5pb24uc2xlcnAocSwgMC4yKTsgLy8gRmFzdGVyIHR1cm4gKHdhcyAwLjEpCiAgICAgICAgICAgIGlmIChlbnRpdHkuc3luY1JvdGF0aW9uKSBlbnRpdHkuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBHUkFCIExPR0lDCiAgICAgICAgLy8gMS4gVG91Y2g6IFZlcnkgY2xvc2UgKGlnbm9yZSBmYWNpbmcgLSBwcmV2ZW50cyBydW5uaW5nIG92ZXIgYmFsbCkKICAgICAgICAvLyAyLiBNYWduZXQ6IENsb3NlIGFuZCBmYWNpbmcKICAgICAgICBjb25zdCBpc1RvdWNoID0gZGlzdFhaIDwgdG91Y2hSYWRpdXM7CiAgICAgICAgY29uc3QgaXNNYWduZXQgPSBkaXN0WFogPCBtYWduZXRSYWRpdXMgJiYgaXNJbkNvbmU7CgogICAgICAgIGlmIChpc1RvdWNoIHx8IGlzTWFnbmV0KSB7CiAgICAgICAgICAgIC8vIEJMQVNUIFRIUk9VR0ggTE9HSUMKICAgICAgICAgICAgY29uc3QgYmFsbFNwZWVkID0gX2JhbGwudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgIGxldCBjYXRjaENoYW5jZSA9IDEuMDsKCiAgICAgICAgICAgIC8vIElmIGJhbGwgaXMgbW92aW5nIGZhc3QgKGUuZy4gPiAyMCksIGNoZWNrIENBCiAgICAgICAgICAgIGlmIChiYWxsU3BlZWQgPiAyMC4wKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjYSA9IGVudGl0eS5nZXRTdGF0KCdDQScpOwogICAgICAgICAgICAgICAgLy8gRGlmZmljdWx0eSBzY2FsZXMgd2l0aCBzcGVlZC4gCiAgICAgICAgICAgICAgICBjb25zdCBkaWZmaWN1bHR5ID0gYmFsbFNwZWVkICogMS4yOyAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGRpZmZpY3VsdHkgPiBjYSkgewogICAgICAgICAgICAgICAgICAgIGNhdGNoQ2hhbmNlID0gMC40ICsgKGNhIC8gZGlmZmljdWx0eSkgKiAwLjY7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUG9pbnQgQmxhbmsgUGVuYWx0eTogSGFyZGVyIHRvIHJlYWN0IGlmIGJhbGwgaXMgcmlnaHQgb24gdG9wIG9mIHlvdSBtb3ZpbmcgZmFzdAogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0WFogPCAxLjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2F0Y2hDaGFuY2UgKj0gMC42OyAvLyBCbGFzdCB0aHJvdWdoIGxpa2VseQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoZW50aXR5LmlzRGFzaGluZykgY2F0Y2hDaGFuY2UgKz0gMC4yOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKF9iYWxsLnBvd2VyVHlwZSA9PT0gJ1NIJyAmJiBfYmFsbC5wb3dlciA+IDE1LjApIHsKICAgICAgICAgICAgICAgIC8vIFNob3QgcG93ZXIgY2hlY2sKICAgICAgICAgICAgICAgIGNvbnN0IGNhID0gZW50aXR5LmdldFN0YXQoJ0NBJyk7CiAgICAgICAgICAgICAgICBpZiAoX2JhbGwucG93ZXIgPiBjYSAqIDEuMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5jZSA9IE1hdGgubWluKDAuNywgKF9iYWxsLnBvd2VyIC0gY2EpICogMC4wNCk7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hDaGFuY2UgPSAxLjAgLSBjaGFuY2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBmdW1ibGUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPiBjYXRjaENoYW5jZSkgewogICAgICAgICAgICAgICAgZnVtYmxlID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGZ1bWJsZSkgewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWaXN1YWwgZmVlZGJhY2sgZm9yIGJsYXN0IHRocm91Z2gKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTEFTVCBUSFJPVUdIISIsIGVudFBvcywgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEZWZsZWN0IHNsaWdodGx5IGJ1dCBrZWVwIG1vdmluZyBmYXN0IChCbGFzdCBUaHJvdWdoKQogICAgICAgICAgICAgICAgLy8gRG9uJ3Qgc3RvcCBpdCBjb21wbGV0ZWx5IGxpa2UgYSBibG9jaywganVzdCBwZXJ0dXJiIGl0CiAgICAgICAgICAgICAgICBfYmFsbC52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjg1KTsgCiAgICAgICAgICAgICAgICBfYmFsbC52ZWxvY2l0eS54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiA1LjA7CiAgICAgICAgICAgICAgICBfYmFsbC52ZWxvY2l0eS55ICs9IChNYXRoLnJhbmRvbSgpKSAqIDUuMDsgLy8gUG9wIHVwCiAgICAgICAgICAgICAgICBfYmFsbC52ZWxvY2l0eS56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiA1LjA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9iYWxsLnBvd2VyICo9IDAuNzsKCiAgICAgICAgICAgICAgICBlbnRpdHkuY2FuQ2F0Y2ggPSBmYWxzZTsKICAgICAgICAgICAgICAgIC8vIFN0dW4gYnJpZWZseQogICAgICAgICAgICAgICAgZW50aXR5LnN0dW5UaW1lciA9IDAuNTsKICAgICAgICAgICAgICAgIGlmKGVudGl0eS5wbGF5KSBlbnRpdHkucGxheSgncmVhY3QnLCAwLjEpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgZW50aXR5LmNhbkNhdGNoID0gdHJ1ZTsgfSwgMTAwMCk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2JhbGwubWFnbmV0aXplKGVudGl0eSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8gU3RhcnQKICAgIGluaXQoKTsKfSkoKTs=","./main.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgLy8gTmFtZXNwYWNlCiAgICB3aW5kb3cuZmx1eCA9IHdpbmRvdy5mbHV4IHx8IHt9OwogICAgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyA9IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgfHwgW107CgogICAgLy8gQ29uZmlnCmNvbnN0IF9jb25maWcgPSB7CiAgICAgICAgaW50ZXJuYWxXaWR0aDogMzYwLAogICAgICAgIGludGVybmFsSGVpZ2h0OiA2NDAsCiAgICAgICAgYmdDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgZm9nQ29sb3I6IDB4MDAxZTM2LAogICAgICAgIGZvZ0RlbnNpdHk6IDAuMDAwMSwgLy8gRHJhc3RpY2FsbHkgcmVkdWNlZCB0byBlbnN1cmUgdmlzaWJpbGl0eQogICAgICAgIGFyZW5hUmFkaXVzOiA0OC4wCiAgICB9OwoKICAgIC8vIEdsb2JhbHMKLy8gR2xvYmFscwogICAgY29uc3QgX2lucHV0ID0geyB4OiAwLCB5OiAwIH07IC8vIElucHV0IHN0YXRlCiAgICAKICAgIC8vIFNoYWRlciBVbmlmb3JtcwogICAgY29uc3QgX2FyZW5hVW5pZm9ybXMgPSB7CiAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICB1SW1wYWN0UG9zOiB7IHZhbHVlOiBuZXcgVEhSRUUuVmVjdG9yMygpIH0sCiAgICAgICAgdUltcGFjdFN0cjogeyB2YWx1ZTogMC4wIH0KICAgIH07CiAgICBjb25zdCBfcGFydGljbGVVbmlmb3JtcyA9IHsKICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9CiAgICB9OwoKICAgIC8vIEV4cG9zZSBJbXBhY3QgVHJpZ2dlcgogICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0ID0gZnVuY3Rpb24ocG9zLCBzdHJlbmd0aCkgewogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RQb3MudmFsdWUuY29weShwb3MpOwogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RTdHIudmFsdWUgPSBzdHJlbmd0aCAqIDIuMDsgLy8gU2NhbGUgdXAgZm9yIHZpc2liaWxpdHkKICAgIH07Ci8vIF9pbnB1dCBhbHJlYWR5IGRlY2xhcmVkIGFib3ZlCiAgICBjb25zdCBfdGVtcFZlYzEgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBSZXVzYWJsZSBmb3IgcGh5c2ljcy9sb2dpYwogICAgY29uc3QgX3RlbXBWZWMyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsgLy8gUmV1c2FibGUgZm9yIHBoeXNpY3MvbG9naWMKICAgIGxldCBfc2NlbmUsIF9jYW1lcmEsIF9yZW5kZXJlciwgX2Nsb2NrOwogICAgbGV0IF9ob21lVGVhbSwgX2F3YXlUZWFtOwogICAgbGV0IF9iYWxsOwogICAgbGV0IF9nYW1lTWFuYWdlcjsKICAgIGxldCBfbWVudU1hbmFnZXI7CiAgICBsZXQgX2F1ZGlvTWFuYWdlcjsKCiAgICBsZXQgX2NhbWVyYU1hbmFnZXI7CiAgICBsZXQgX3dhdGVyT3ZlcmxheTsKICAgIGxldCBfbGlnaHRTaGFmdHM7CiAgICBsZXQgX3N0YWRpdW07CiAgICBsZXQgX2dseXBoTWFuYWdlcjsKCiAgICAvLyBJTVBST1ZFRDogU2V0dGluZ3Mgb2JqZWN0CiAgICBjb25zdCBfc2V0dGluZ3MgPSB7CiAgICAgICAgam95c3RpY2tTZW5zaXRpdml0eTogMS4wLAogICAgICAgIGFpbUFzc2lzdDogdHJ1ZSwKICAgICAgICBjYW1lcmFTaGFrZTogdHJ1ZSwKICAgICAgICBoaXRTdG9wOiB0cnVlLAogICAgICAgIGludmVydENhbWVyYTogZmFsc2UsCiAgICAgICAgYXV0b1JlY2VudGVyOiB0cnVlCiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRGVidWcgSU8gQnJpZGdlIChleHBvc2VkIGZvciBEZXZUb29scyBKU09OIHNuYXBzaG90cykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIHx8IHt9OwogICAgX2RlYnVnSU8uc2V0dGluZ3MgPSBfc2V0dGluZ3M7CiAgICBfZGVidWdJTy5pbnB1dCA9IF9kZWJ1Z0lPLmlucHV0IHx8IHt9OwogICAgX2RlYnVnSU8ucGVyZiA9IF9kZWJ1Z0lPLnBlcmYgfHwgeyBmcmFtZTogMCwgcmF3RHQ6IDAsIGR0OiAwLCBmcHM6IDAsIGF2Z0ZwczogMCB9OwoKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIFRvdWNoIGhlbHBlcnMgKG11bHRpLXRvdWNoIHNhZmUpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGZ1bmN0aW9uIF9maW5kVG91Y2hCeUlkKHRvdWNoTGlzdCwgaWQpIHsKICAgICAgICBpZiAoaWQgPT09IG51bGwgfHwgaWQgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgICAgaWYgKCF0b3VjaExpc3QpIHJldHVybiBudWxsOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdG91Y2hMaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IHQgPSB0b3VjaExpc3RbaV07CiAgICAgICAgICAgIGlmICh0ICYmIHQuaWRlbnRpZmllciA9PT0gaWQpIHJldHVybiB0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBfZW5kZWRUb3VjaEJ5SWQoY2hhbmdlZFRvdWNoZXMsIGlkKSB7CiAgICAgICAgaWYgKGlkID09PSBudWxsIHx8IGlkID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgICAgIGlmICghY2hhbmdlZFRvdWNoZXMpIHJldHVybiBudWxsOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hhbmdlZFRvdWNoZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgdCA9IGNoYW5nZWRUb3VjaGVzW2ldOwogICAgICAgICAgICBpZiAodCAmJiB0LmlkZW50aWZpZXIgPT09IGlkKSByZXR1cm4gdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGluaXQoKSB7CiAgICAgICAgX2NvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnYW1lLWNvbnRhaW5lcicpOwoKICAgICAgICAvLyAxLiBTY2VuZQogICAgICAgIF9zY2VuZSA9IG5ldyBUSFJFRS5TY2VuZSgpOwogICAgICAgIF9zY2VuZS5iYWNrZ3JvdW5kID0gbmV3IFRIUkVFLkNvbG9yKF9jb25maWcuYmdDb2xvcik7CiAgICAgICAgX3NjZW5lLmZvZyA9IG5ldyBUSFJFRS5Gb2dFeHAyKF9jb25maWcuZm9nQ29sb3IsIF9jb25maWcuZm9nRGVuc2l0eSk7CgogICAgICAgIC8vIDIuIENhbWVyYQogICAgICAgIGNvbnN0IGFzcGVjdCA9IF9jb25maWcuaW50ZXJuYWxXaWR0aCAvIF9jb25maWcuaW50ZXJuYWxIZWlnaHQ7Cl9jYW1lcmEgPSBuZXcgVEhSRUUuUGVyc3BlY3RpdmVDYW1lcmEoNjAsIGFzcGVjdCwgMC4xLCA1MDApOwpfY2FtZXJhLnBvc2l0aW9uLnNldCgwLCAxNCwgMjIpOwogICAgICAgIF9jYW1lcmEubG9va0F0KDAsIDAsIDApOwogICAgICAgIF9zY2VuZS5hZGQoX2NhbWVyYSk7IC8vIEVuc3VyZSBjYW1lcmEgaXMgaW4gc2NlbmUgZm9yIGNoaWxkcmVuIHRvIHJlbmRlcgoKICAgICAgICAvLyAzLiBSZW5kZXJlcgovLyAzLiBSZW5kZXJlcgogICAgICAgIF9yZW5kZXJlciA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlcmVyKHsgCiAgICAgICAgICAgIGFudGlhbGlhczogZmFsc2UsCiAgICAgICAgICAgIHBvd2VyUHJlZmVyZW5jZTogImhpZ2gtcGVyZm9ybWFuY2UiLAogICAgICAgICAgICBwcmVjaXNpb246ICJtZWRpdW1wIiwgLy8gTW9iaWxlIG9wdGltaXphdGlvbjogZmFzdGVyIHNoYWRlcnMKICAgICAgICAgICAgc3RlbmNpbDogZmFsc2UsICAgICAgIC8vIERpc2FibGUgc3RlbmNpbCBidWZmZXIgaWYgbm90IHVzZWQKICAgICAgICAgICAgZGVwdGg6IHRydWUKICAgICAgICB9KTsKICAgICAgICBfcmVuZGVyZXIuc2V0UGl4ZWxSYXRpbygxKTsgLy8gRm9yY2UgMToxIHBpeGVsIHJhdGlvLCB3ZSBoYW5kbGUgc2NhbGluZyB2aWEgc2V0U2l6ZQogICAgICAgIF9yZW5kZXJlci5hdXRvQ2xlYXIgPSBmYWxzZTsgLy8gV2UgbWFuYWdlIGNsZWFyaW5nIHZpYSBiYWNrZ3JvdW5kIG9yIG1hbnVhbCBjYWxscyBpZiBuZWVkZWQgKHRob3VnaCBzY2VuZS5iYWNrZ3JvdW5kIGhhbmRsZXMgY29sb3IpCiAgICAgICAgLy8gRXhwb3NlIHJlbmRlcmVyIGZvciBEZXZUb29scwogICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIF9nYW1lTWFuYWdlci5yZW5kZXJlciA9IF9yZW5kZXJlcjsgCiAgICAgICAgZWxzZSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPSB7IHJlbmRlcmVyOiBfcmVuZGVyZXIgfTsgLy8gVGVtcCBob29rCl9jb250YWluZXIuYXBwZW5kQ2hpbGQoX3JlbmRlcmVyLmRvbUVsZW1lbnQpOwoKLy8gLS0tIFZpZGVvIE92ZXJsYXkgRW5mb3JjZW1lbnQgLS0tCiAgICAgICAgLy8gLS0tIE92ZXJsYXkgVmlkZW8gTG9naWMgUmVtb3ZlZCAoU3dpdGNoZWQgdG8gR0lGKSAtLS0KICAgICAgICAvLyA1LiBFbnZpcm9ubWVudAogICAgICAgIGNyZWF0ZVBhcnRpY2xlcygpOwogICAgICAgIGNyZWF0ZUFyZW5hKCk7CiAgICAgICAgY3JlYXRlSG9sb2dyYXBoaWNSaW5ncygpOwovLyA1LjUgR2FtZSBNYW5hZ2VyCl9nYW1lTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5HYW1lTWFuYWdlcihfc2NlbmUsICd1aS1sYXllcicsIF9jYW1lcmEsIF9yZW5kZXJlcik7CiAgICAgICAgCiAgICAgICAgLy8gNS41LjEgQXVkaW8gTWFuYWdlcgogICAgICAgIF9hdWRpb01hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguQXVkaW9NYW5hZ2VyKCk7CiAgICAgICAgX2dhbWVNYW5hZ2VyLmF1ZGlvTWFuYWdlciA9IF9hdWRpb01hbmFnZXI7CgogICAgICAgIC8vIDUuNiBDYW1lcmEgTWFuYWdlcgogICAgICAgIF9jYW1lcmFNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkNhbWVyYU1hbmFnZXIoX2NhbWVyYSwgX3NjZW5lKTsKICAgICAgICBfZ2FtZU1hbmFnZXIuY2FtZXJhTWFuYWdlciA9IF9jYW1lcmFNYW5hZ2VyOwoKICAgICAgICAvLyA1LjcgRGV2IFRvb2xzCmlmICh3aW5kb3cuZmx1eC5EZXZUb29scykgewogICAgICAgICAgICBuZXcgd2luZG93LmZsdXguRGV2VG9vbHMoX2dhbWVNYW5hZ2VyKTsKICAgICAgICB9Ci8vIDUuOCBXYXRlciBPdmVybGF5LCBMaWdodCBTaGFmdHMsIFN0YWRpdW0sIEdseXBocwogICAgICAgIF93YXRlck92ZXJsYXkgPSBuZXcgd2luZG93LmZsdXguV2F0ZXJPdmVybGF5KF9jYW1lcmEpOwogICAgICAgIF9saWdodFNoYWZ0cyA9IG5ldyB3aW5kb3cuZmx1eC5MaWdodFNoYWZ0cyhfc2NlbmUpOwogICAgICAgIF9zdGFkaXVtID0gbmV3IHdpbmRvdy5mbHV4LlN0YWRpdW0oX3NjZW5lKTsKICAgICAgICBfZ2x5cGhNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkdseXBoTWFuYWdlcihfc2NlbmUpOwogICAgICAgIAppZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIF9nYW1lTWFuYWdlci5nbHlwaE1hbmFnZXIgPSBfZ2x5cGhNYW5hZ2VyOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIud2F0ZXJPdmVybGF5ID0gX3dhdGVyT3ZlcmxheTsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmxpZ2h0U2hhZnRzID0gX2xpZ2h0U2hhZnRzOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIuc3RhZGl1bSA9IF9zdGFkaXVtOwogICAgICAgIH0KICAgICAgICAvLyA2LiBUZWFtcyBTZXR1cAogICAgICAgIF9ob21lVGVhbSA9IG5ldyB3aW5kb3cuZmx1eC5UZWFtKF9zY2VuZSwgJ2hvbWUnLCAxLCAweDAwYWFmZiwgdHJ1ZSk7CiAgICAgICAgX2F3YXlUZWFtID0gbmV3IHdpbmRvdy5mbHV4LlRlYW0oX3NjZW5lLCAnYXdheScsIC0xLCAweGZmNjY2NiwgZmFsc2UpOwoKICAgICAgICAvLyA3LiBCYWxsCiAgICAgICAgX2JhbGwgPSBuZXcgd2luZG93LmZsdXguQmFsbChfc2NlbmUpOwoKICAgICAgICAvLyBJTVBST1ZFRDogTGluayBiYWxsIHRvIGNhbWVyYSBmb3Igc21hcnQgZnJhbWluZwogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnNldEJhbGwoX2JhbGwpOwoKICAgICAgICAvLyA4LiBUZWFtIFJvc3RlciBNb2RlbHMKICAgICAgICBjb25zdCByb2xlcyA9IFsnTEYnLCAnUkYnLCAnTUYnLCAnTEQnLCAnUkQnLCAnR0wnXTsKICAgICAgICBjb25zdCBob21lUm9zdGVyID0gewogICAgICAgICAgICBMRjogeyBuYW1lOiAnVGlkdXMnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZGE3ODhiZWYyNThjNGYwYjhkOWVmMWFjYzE5YzU1NjcuZ2xiJyB9LAogICAgICAgICAgICBSRjogeyBuYW1lOiAnV2Fra2EnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJyB9LAogICAgICAgICAgICBNRjogeyBuYW1lOiAnTGV0dHknLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNDNhY2UzNGM2ZmQ5NDIxNTk2N2U4NDJiZjkwOWRhNWUuZ2xiJyB9LAogICAgICAgICAgICBMRDogeyBuYW1lOiAnRGF0dG8nLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZTZkNjdlY2IyZTRjNDcxNWJkNzNhNDA3OTVlMWQzZDUuZ2xiJyB9LAogICAgICAgICAgICBSRDogeyBuYW1lOiAnSmFzc3UnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJyB9LAogICAgICAgICAgICBHTDogeyBuYW1lOiAnQm90dGEnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvYWQxNTVlZmVkYzBkNDhmZGFkMDlkYTNlMWNhZTljOTcuZ2xiJyB9CiAgICAgICAgfTsKCmNvbnN0IGFwcGx5U3RhdHMgPSAocCwgcm9sZSwgaXNIb21lKSA9PiB7CmNvbnN0IHRlYW1MZXZlbCA9IGlzSG9tZSA/IDI1IDogODsgLy8gTmVyZmVkIENQVSBsZXZlbCBzaWduaWZpY2FudGx5ICh3YXMgMTUpCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LlRlYW0uZ2VuZXJhdGVTdGF0cyhwLCByb2xlLCB0ZWFtTGV2ZWwsIGlzSG9tZSk7CgogICAgICAgICAgICBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDU7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNQICs9IDM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDM7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkVOICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdCcm90aGVyJykpIHsKICAgICAgICAgICAgICAgIHAuc3RhdHMuU1AgPSA5OTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcC5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CiAgICAgICAgfTsKCiAgICAgICAgbGV0IGhvbWVMb2FkZWQgPSAwOwogICAgICAgIGNvbnN0IHJvbGVHbHRmcyA9IHt9OwoKICAgICAgICBjb25zdCBmaW5hbGl6ZVRlYW1zID0gKCkgPT4gewogICAgICAgICAgICByb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZ2x0ZiA9IHJvbGVHbHRmc1tyb2xlXSB8fCByb2xlR2x0ZnMuTEY7CgogICAgICAgICAgICAgICAgY29uc3QgcCA9IChyb2xlID09PSAnR0wnKQogICAgICAgICAgICAgICAgICAgID8gbmV3IHdpbmRvdy5mbHV4LkdvYWxpZShfc2NlbmUsIHJvbGUpCiAgICAgICAgICAgICAgICAgICAgOiBuZXcgd2luZG93LmZsdXguQUlQbGF5ZXIoX3NjZW5lLCByb2xlKTsKCiAgICAgICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgICAgICBwLmNoYXJhY3Rlck5hbWUgPSBlbnRyeSA/IGBDUFUgJHtlbnRyeS5uYW1lfWAgOiAnQ1BVJzsKICAgICAgICAgICAgICAgIGFwcGx5U3RhdHMocCwgcm9sZSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmICYmIGdsdGYuc2NlbmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjbG9uZSA9IFRIUkVFLlNrZWxldG9uVXRpbHMuY2xvbmUoZ2x0Zi5zY2VuZSk7CiAgICAgICAgICAgICAgICAgICAgcC5zZXRNZXNoKGNsb25lLCBnbHRmLmFuaW1hdGlvbnMgfHwgW10pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ01pc3NpbmcgR0xURiBmb3IgYXdheSByb2xlOicsIHJvbGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS5hZGRQbGF5ZXIocCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYWxsUGxheWVycyA9IFsuLi5faG9tZVRlYW0ucGxheWVycywgLi4uX2F3YXlUZWFtLnBsYXllcnNdOwogICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAocC5iYWxsUmVmID09PSBudWxsKSBwLmJhbGxSZWYgPSBfYmFsbDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyID0gX2hvbWVUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy50YWNrbGUgPSAndmVub20nOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy5zaG9vdCA9ICdzcGhlcmUnOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0VxdWlwcGVkIEhvbWUgTUYgd2l0aCBWZW5vbSBUYWNrbGUgJiBTcGhlcmUgU2hvdCcpOwogICAgICAgICAgICB9Cgpjb25zdCBhd2F5TUYgPSBfYXdheVRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgLy8gUmVtb3ZlZCBndWFyYW50ZWVkIFdpdGhlciB0YWNrbGUgZm9yIEF3YXkgTUYgdG8gcmVkdWNlIGRpZmZpY3VsdHkKICAgICAgICAgICAgX2F3YXlUZWFtLnNldEZvcm1hdGlvbignQ291bnRlcicpOwoKICAgICAgICAgICAgY29uc3QgYXdheUdMID0gX2F3YXlUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ0dMJyk7CiAgICAgICAgICAgIC8vIFJlbW92ZWQgZ3VhcmFudGVlZCBTdXBlciBHb2FsaWUgZm9yIEF3YXkgR0wgdG8gbWFrZSBzY29yaW5nIGVhc2llcgoKICAgICAgICAgICAgX2hvbWVUZWFtLmFzc2lnbk1hcmtzKF9hd2F5VGVhbSk7CiAgICAgICAgICAgIF9hd2F5VGVhbS5hc3NpZ25NYXJrcyhfaG9tZVRlYW0pOwoKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xvYWRpbmcnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIucmVnaXN0ZXJUZWFtcyhfaG9tZVRlYW0sIF9hd2F5VGVhbSwgX2JhbGwpOwoKICAgICAgICAgICAgICAgIF9tZW51TWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5NZW51TWFuYWdlcihfZ2FtZU1hbmFnZXIpOwogICAgICAgICAgICAgICAgX21lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgfQogICAgICAgIH07Cgpyb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgIGlmICghZW50cnkpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9uQ29tcGxldGUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBob21lTG9hZGVkKys7CiAgICAgICAgICAgICAgICBpZiAoaG9tZUxvYWRlZCA+PSByb2xlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBmaW5hbGl6ZVRlYW1zKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlci5sb2FkTW9kZWwoZW50cnkudXJsLCAoZ2x0ZikgPT4gewogICAgICAgICAgICAgICAgcm9sZUdsdGZzW3JvbGVdID0gZ2x0ZjsKCiAgICAgICAgICAgICAgICBjb25zdCBwID0gKHJvbGUgPT09ICdHTCcpCiAgICAgICAgICAgICAgICAgICAgPyBuZXcgd2luZG93LmZsdXguR29hbGllKF9zY2VuZSwgcm9sZSkKICAgICAgICAgICAgICAgICAgICA6IG5ldyB3aW5kb3cuZmx1eC5BSVBsYXllcihfc2NlbmUsIHJvbGUpOwoKICAgICAgICAgICAgICAgIHAuY2hhcmFjdGVyTmFtZSA9IGVudHJ5Lm5hbWU7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIHRydWUpOwoKICAgICAgICAgICAgICAgIGNvbnN0IGNsb25lID0gVEhSRUUuU2tlbGV0b25VdGlscy5jbG9uZShnbHRmLnNjZW5lKTsKICAgICAgICAgICAgICAgIHAuc2V0TWVzaChjbG9uZSwgZ2x0Zi5hbmltYXRpb25zKTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hZGRQbGF5ZXIocCk7CgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpOwogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2FkIG1vZGVsJywgZW50cnkubmFtZSwgZW50cnkudXJsLCBlcnIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayBNZXNoIChSZWQgQm94KQogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoMSwgMiwgMSk7CiAgICAgICAgICAgICAgICBjb25zdCBmYWxsYmFja01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlIH0pOwogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tNZXNoID0gbmV3IFRIUkVFLk1lc2goZmFsbGJhY2tHZW8sIGZhbGxiYWNrTWF0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU3RvcmUgZHVtbXkgaW4gcm9sZUdsdGZzIGZvciBhd2F5IHRlYW0gY2xvbmluZwogICAgICAgICAgICAgICAgcm9sZUdsdGZzW3JvbGVdID0geyBzY2VuZTogZmFsbGJhY2tNZXNoLCBhbmltYXRpb25zOiBbXSB9OwoKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSAocm9sZSA9PT0gJ0dMJykKICAgICAgICAgICAgICAgICAgICA/IG5ldyB3aW5kb3cuZmx1eC5Hb2FsaWUoX3NjZW5lLCByb2xlKQogICAgICAgICAgICAgICAgICAgIDogbmV3IHdpbmRvdy5mbHV4LkFJUGxheWVyKF9zY2VuZSwgcm9sZSk7CgogICAgICAgICAgICAgICAgcC5jaGFyYWN0ZXJOYW1lID0gZW50cnkubmFtZSArICIgKEVycm9yKSI7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIHRydWUpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBwLnNldE1lc2goZmFsbGJhY2tNZXNoLmNsb25lKCksIFtdKTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hZGRQbGF5ZXIocCk7CgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gOC4gSW5wdXQKICAgICAgICBzZXR1cElucHV0cygpOwoKICAgICAgICAvLyA5LiBMb29wCiAgICAgICAgX2Nsb2NrID0gbmV3IFRIUkVFLkNsb2NrKCk7CiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwoKICAgICAgICAvLyBIYW5kbGUgcmVzaXplCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIG9uUmVzaXplKTsKICAgICAgICBvblJlc2l6ZSgpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlUGFydGljbGVzKCkgewogICAgICAgIGNvbnN0IGNvdW50ID0gMTUwMDsgLy8gSW5jcmVhc2VkIGNvdW50CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IFtdOwogICAgICAgIGNvbnN0IG9mZnNldHMgPSBbXTsgLy8gUmFuZG9tIG9mZnNldHMgZm9yIGluZGVwZW5kZW50IGJvYmJpbmcKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgIHZlcnRpY2VzLnB1c2goCiAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA4MCwgLy8gV2lkZXIgc3ByZWFkIFgKICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDUwLCAvLyBXaWRlciBzcHJlYWQgWQogICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogODAgIC8vIFdpZGVyIHNwcmVhZCBaCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIG9mZnNldHMucHVzaChNYXRoLnJhbmRvbSgpICogMTAwKTsKICAgICAgICB9CgogICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSh2ZXJ0aWNlcywgMykpOwogICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgnYU9mZnNldCcsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKG9mZnNldHMsIDEpKTsKCiAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICB1bmlmb3JtczogX3BhcnRpY2xlVW5pZm9ybXMsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCnZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBhT2Zmc2V0OwogICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2QWxwaGE7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAvLyBCb2JiaW5nIG1vdGlvbjogU2luZSB3YXZlIGJhc2VkIG9uIHRpbWUgKyByYW5kb20gb2Zmc2V0CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYm9iID0gc2luKHVUaW1lICogMC41ICsgYU9mZnNldCkgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gYm9iOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZlYzQgbXZQb3NpdGlvbiA9IG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zLCAxLjApOwogICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG12UG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU2l6ZSBhdHRlbnVhdGlvbiAtIFNtYWxsIGFuZCBzaGltbWVyeQogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNpemVCYXNlID0gMi4wICsgc2luKHVUaW1lICogMy4wICsgYU9mZnNldCkgKiAxLjA7IAogICAgICAgICAgICAgICAgICAgIGdsX1BvaW50U2l6ZSA9IHNpemVCYXNlICogKDIwLjAgLyAtbXZQb3NpdGlvbi56KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBGYWRlIGJhc2VkIG9uIGRpc3RhbmNlL2hlaWdodAogICAgICAgICAgICAgICAgICAgIHZBbHBoYSA9IDAuNSArIDAuNSAqIHNpbih1VGltZSAqIDIuMCArIGFPZmZzZXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgLAogICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2QWxwaGE7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU29mdCBnbG93IHBhcnRpY2xlIChEdXN0IG1vdGUpCiAgICAgICAgICAgICAgICAgICAgdmVjMiBjb29yZCA9IGdsX1BvaW50Q29vcmQgLSB2ZWMyKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGlzdCA9IGxlbmd0aChjb29yZCk7CiAgICAgICAgICAgICAgICAgICAgaWYoZGlzdCA+IDAuNSkgZGlzY2FyZDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTb2Z0IGZhbGxvZmYgZm9yIHNoaW1tZXIKICAgICAgICAgICAgICAgICAgICBmbG9hdCBzdHJlbmd0aCA9IDEuMCAtIChkaXN0ICogMi4wKTsKICAgICAgICAgICAgICAgICAgICBzdHJlbmd0aCA9IHBvdyhzdHJlbmd0aCwgMi4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDeWFuL0JsdWUgdGludCwgYWRkaXRpdmUgZmVlbAogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoMC43LCAwLjksIDEuMCwgdkFscGhhICogc3RyZW5ndGggKiAwLjgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHBvaW50cyA9IG5ldyBUSFJFRS5Qb2ludHMoZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICBwb2ludHMuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgIF9zY2VuZS5hZGQocG9pbnRzKTsKICAgIH0KCmZ1bmN0aW9uIGNyZWF0ZUFyZW5hKCkgewogICAgICAgIC8vIEdyb3VwIGZvciByb3RhdGlvbgogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICBfc2NlbmUuYWRkKHdpbmRvdy5mbHV4LmFyZW5hR3JvdXApOwoKICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeShfY29uZmlnLmFyZW5hUmFkaXVzLCAzMiwgMzIpOwogICAgICAgIAogICAgICAgIC8vIC0tLSAxLiBCYXNlIFNwaGVyZSAoRmFpbnQgR3JpZCkgLS0tCiAgICAgICAgY29uc3QgdGV4TG9hZGVyID0gbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKTsKICAgICAgICBjb25zdCBhcmVuYVRleCA9IHRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9XMUxzSDY4US9maWxlLTAwMDAwMDAwMjNlYzcxZjU5NjU5MzgyOWU4MTE4NzYwLSgxKS5wbmcnKTsKICAgICAgICBhcmVuYVRleC5tYWdGaWx0ZXIgPSBUSFJFRS5OZWFyZXN0RmlsdGVyOwogICAgICAgIGFyZW5hVGV4Lm1pbkZpbHRlciA9IFRIUkVFLk5lYXJlc3RGaWx0ZXI7CiAgICAgICAgYXJlbmFUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBhcmVuYVRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGFyZW5hVGV4LnJlcGVhdC5zZXQoNiwgNCk7CgogICAgICAgIGNvbnN0IG1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiBhcmVuYVRleCwKICAgICAgICAgICAgY29sb3I6IDB4NDQ2Njg4LAogICAgICAgICAgICB3aXJlZnJhbWU6IGZhbHNlLAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4xNSwgCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgY29uc3QgYXJlbmEgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAuYWRkKGFyZW5hKTsKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2ggPSBhcmVuYTsKCiAgICAgICAgLy8gLS0tIDIuIElubmVyIEhleCBHcmlkIChXYXJwIEVmZmVjdCkgLS0tCiAgICAgICAgLy8gUmV1c2UgZXhpc3RpbmcgaGV4IGdlbmVyYXRpb24gbG9naWMgYnV0IGF0dGFjaCB0byBncm91cAogICAgICAgIGNvbnN0IGhleFRleCA9ICgoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICAgICAgYy53aWR0aCA9IDUxMjsgYy5oZWlnaHQgPSA1MTI7CiAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLDAsNTEyLDUxMik7CiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDAsIDI1NSwgMjU1LCAwLjUpJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgIGNvbnN0IHIgPSA2NDsKICAgICAgICAgICAgY29uc3QgdyA9IHIgKiAyOwogICAgICAgICAgICBjb25zdCBoID0gTWF0aC5zcXJ0KDMpICogcjsKICAgICAgICAgICAgZm9yKGxldCB5ID0gLTE7IHkgPCA1MTIvaCArIDI7IHkrKykgewogICAgICAgICAgICAgICAgZm9yKGxldCB4ID0gLTE7IHggPCA1MTIvKHcqMC43NSkgKyAyOyB4KyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjeCA9IHggKiB3ICogMC43NTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjeSA9IHkgKiBoICsgKHglMj09PTAgPyAwIDogaC8yKTsKICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8NjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZyA9IE1hdGguUEkvMyAqIGk7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oY3ggKyBNYXRoLmNvcyhhbmcpKnIsIGN5ICsgTWF0aC5zaW4oYW5nKSpyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICAgICAgfSkoKTsKICAgICAgICBoZXhUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBoZXhUZXgud3JhcFQgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBoZXhUZXgucmVwZWF0LnNldCg0LCAyKTsKCiAgICAgICAgY29uc3QgYXJlbmFVbmlmb3JtcyA9IFRIUkVFLlVuaWZvcm1zVXRpbHMubWVyZ2UoWwogICAgICAgICAgICBUSFJFRS5Vbmlmb3Jtc0xpYlsnY29tbW9uJ10sCiAgICAgICAgICAgIF9hcmVuYVVuaWZvcm1zLAogICAgICAgICAgICB7IAogICAgICAgICAgICAgICAgdE1hcDogeyB2YWx1ZTogaGV4VGV4IH0sCiAgICAgICAgICAgICAgICB1T3BhY2l0eTogeyB2YWx1ZTogMC4xIH0gCiAgICAgICAgICAgIH0KICAgICAgICBdKTsKCiAgICAgICAgY29uc3QgbWF0ZXJpYWwyID0gbmV3IFRIUkVFLlNoYWRlck1hdGVyaWFsKHsKICAgICAgICAgICAgdW5pZm9ybXM6IGFyZW5hVW5pZm9ybXMsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IGAKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVRpbWU7CiAgICAgICAgICAgICAgICB1bmlmb3JtIHZlYzMgdUltcGFjdFBvczsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUltcGFjdFN0cjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdlV2ID0gdXY7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkaXN0ID0gZGlzdGFuY2UocG9zLCB1SW1wYWN0UG9zKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYWRpdXMgPSAyMC4wOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSBkaXN0IC8gcmFkaXVzOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBidWxnZSA9ICgxLjAgLSB0KSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBub3JtYWwgPSBub3JtYWxpemUocG9zKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zICs9IG5vcm1hbCAqIChidWxnZSAqIHVJbXBhY3RTdHIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KHBvcywgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYCwKICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGAKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHRNYXA7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVJbXBhY3RTdHI7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVPcGFjaXR5OwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWM0IHRleENvbG9yID0gdGV4dHVyZTJEKHRNYXAsIHZVdik7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYWxwaGEgPSB1T3BhY2l0eSAqIHRleENvbG9yLmE7CiAgICAgICAgICAgICAgICAgICAgYWxwaGEgKz0gdUltcGFjdFN0ciAqIDAuMDI7IAogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB0ZXhDb2xvci5yZ2IgKiB2ZWMzKDAuMiwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGFscGhhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYAogICAgICAgIH0pOwoKICAgICAgICBjb25zdCBhcmVuYTIgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwyKTsKICAgICAgICBhcmVuYTIuc2NhbGUuc2V0U2NhbGFyKDAuOTgpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAuYWRkKGFyZW5hMik7CiAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMiA9IGFyZW5hMjsKCiAgICAgICAgLy8gLS0tIDMuIEVRVUFUT1IgQkFORFMgKEJsdWUgYW5kIEdvbGQgLSBwb3NzZXNzaW9uIGJhc2VkKSAtLS0KICAgICAgICBjb25zdCBiYW5kVGV4TG9hZGVyID0gbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKTsKCiAgICAgICAgLy8gQmx1ZSBCYW5kIChzaG93biB3aGVuIGhvbWUgdGVhbSBoYXMgYmFsbCkgLSB0aGluIGJhbmQsIG5vIHZlcnRpY2FsIHN0cmV0Y2gKICAgICAgICBjb25zdCBibHVlQmFuZFRleCA9IGJhbmRUZXhMb2FkZXIubG9hZCgnaHR0cHM6Ly9pLnBvc3RpbWcuY2MvU1FuRnBESE4vQmx1ZS1iYW5kLnBuZycpOwogICAgICAgIGJsdWVCYW5kVGV4LndyYXBTID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgYmx1ZUJhbmRUZXgud3JhcFQgPSBUSFJFRS5DbGFtcFRvRWRnZVdyYXBwaW5nOwogICAgICAgIGJsdWVCYW5kVGV4LnJlcGVhdC5zZXQoMSwgMSk7IC8vIFNpbmdsZSB3cmFwLCBpbWFnZSB0aWxlcyBuYXR1cmFsbHkKCiAgICAgICAgY29uc3QgYmx1ZUJhbmRNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGJsdWVCYW5kVGV4LAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4zNSwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwovLyBUaGluIGJhbmQgLSBoZWlnaHQgb2YgMyB0byBhdm9pZCBzdHJldGNoaW5nCiAgICAgICAgY29uc3QgYmx1ZUJhbmRHZW8gPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeShfY29uZmlnLmFyZW5hUmFkaXVzICogMC45NiwgX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTYsIDMsIDY0LCAxLCB0cnVlKTsKICAgICAgICBjb25zdCBibHVlQmFuZE1lc2ggPSBuZXcgVEhSRUUuTWVzaChibHVlQmFuZEdlbywgYmx1ZUJhbmRNYXQpOwogICAgICAgIGJsdWVCYW5kTWVzaC5wb3NpdGlvbi55ID0gMDsKICAgICAgICBibHVlQmFuZE1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgX3NjZW5lLmFkZChibHVlQmFuZE1lc2gpOwoKICAgICAgICAvLyBHb2xkIEJhbmQgKHNob3duIHdoZW4gYXdheSB0ZWFtIGhhcyBiYWxsKQogICAgICAgIGNvbnN0IGdvbGRCYW5kVGV4ID0gYmFuZFRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9NWm4yOGRncS9Hb2xkLWJhbmQucG5nJyk7CiAgICAgICAgZ29sZEJhbmRUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBnb2xkQmFuZFRleC53cmFwVCA9IFRIUkVFLkNsYW1wVG9FZGdlV3JhcHBpbmc7CiAgICAgICAgZ29sZEJhbmRUZXgucmVwZWF0LnNldCgxLCAxKTsKCiAgICAgICAgY29uc3QgZ29sZEJhbmRNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGdvbGRCYW5kVGV4LAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4zNSwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwpjb25zdCBnb2xkQmFuZEdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KF9jb25maWcuYXJlbmFSYWRpdXMgKiAwLjk2LCBfY29uZmlnLmFyZW5hUmFkaXVzICogMC45NiwgMywgNjQsIDEsIHRydWUpOwogICAgICAgIGNvbnN0IGdvbGRCYW5kTWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdvbGRCYW5kR2VvLCBnb2xkQmFuZE1hdCk7CiAgICAgICAgZ29sZEJhbmRNZXNoLnBvc2l0aW9uLnkgPSAwOwogICAgICAgIGdvbGRCYW5kTWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgX3NjZW5lLmFkZChnb2xkQmFuZE1lc2gpOwoKICAgICAgICAvLyBTdG9yZSByZWZlcmVuY2VzCiAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNZXNoID0gYmx1ZUJhbmRNZXNoOwogICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWVzaCA9IGdvbGRCYW5kTWVzaDsKICAgICAgICB3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCA9IGJsdWVCYW5kTWF0OwogICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0ID0gZ29sZEJhbmRNYXQ7CgogICAgICAgIHdpbmRvdy5mbHV4LnVwZGF0ZUJhbmRQb3NzZXNzaW9uID0gZnVuY3Rpb24oaG9tZUhhc0JhbGwpIHsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaCAmJiB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2gpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaC52aXNpYmxlID0gaG9tZUhhc0JhbGw7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2gudmlzaWJsZSA9ICFob21lSGFzQmFsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHdpbmRvdy5mbHV4LnRyaWJhbFVuaWZvcm1zID0gewogICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9LAogICAgICAgICAgICB1Q29sb3I6IHsgdmFsdWU6IG5ldyBUSFJFRS5Db2xvcigweDAwZmZmZikgfQogICAgICAgIH07CgogICAgICAgIC8vIC0tLSA0LiBWRVJUSUNBTCBBUlJPVyBTVFJJUFMgKEFyb3VuZCBzcGhlcmUsIGFib3ZlICYgYmVsb3cgYmFuZCkgLS0tCiAgICAgICAgY29uc3QgYXJyb3dUZXhMb2FkZXIgPSBuZXcgVEhSRUUuVGV4dHVyZUxvYWRlcigpOwogICAgICAgIGNvbnN0IGFycm93VGV4ID0gYXJyb3dUZXhMb2FkZXIubG9hZCgnaHR0cHM6Ly9pLnBvc3RpbWcuY2MvZFFoUEs0Z1EvWWVsbG93YXJyb3dzLnBuZycpOwogICAgICAgIGFycm93VGV4LndyYXBTID0gVEhSRUUuQ2xhbXBUb0VkZ2VXcmFwcGluZzsKICAgICAgICBhcnJvd1RleC53cmFwVCA9IFRIUkVFLkNsYW1wVG9FZGdlV3JhcHBpbmc7CgogICAgICAgIGNvbnN0IGFycm93TWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiBhcnJvd1RleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuOCwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7CgogICAgICAgIC8vIENyZWF0ZSB2ZXJ0aWNhbCBhcnJvdyBzdHJpcHMgYXJvdW5kIHRoZSBzcGhlcmUgKGN1cnZlZCB0byBtYXRjaCBzcGhlcmUgc3VyZmFjZSkKICAgICAgICBjb25zdCBhcnJvd0dyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgY29uc3QgbnVtQXJyb3dzID0gMTY7ICAgLy8gTnVtYmVyIG9mIGFycm93IHN0cmlwcyBhcm91bmQgY2lyY3VtZmVyZW5jZQogICAgICAgIGNvbnN0IGFycm93SGVpZ2h0ID0gMzA7IC8vIEhlaWdodCBvZiBlYWNoIGFycm93IHN0cmlwCiAgICAgICAgY29uc3QgYXJyb3dXaWR0aCA9IDY7ICAgLy8gV2lkdGggb2YgZWFjaCBzdHJpcAogICAgICAgIGNvbnN0IGFycm93UmFkaXVzID0gX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTQ7CgogICAgICAgIGNvbnN0IG1ha2VDdXJ2ZWRTdHJpcCA9IChiYXNlQW5nbGUsIHlDZW50ZXIsIGZsaXBWID0gZmFsc2UpID0+IHsKICAgICAgICAgICAgLy8gTW9yZSBzZWdtZW50cyA9IHNtb290aGVyIGN1cnZhdHVyZSAoa2VlcCBtb2Rlc3QgZm9yIG1vYmlsZSkKICAgICAgICAgICAgY29uc3Qgc2VnVyA9IDY7ICAgLy8gY3VydmF0dXJlIHJlc29sdXRpb24gKHdpZHRoKQogICAgICAgICAgICBjb25zdCBzZWdIID0gMTg7ICAvLyB2ZXJ0aWNhbCByZXNvbHV0aW9uIChoZWlnaHQpCgogICAgICAgICAgICAvLyBDb252ZXJ0IGRlc2lyZWQgd29ybGQtc3BhY2Ugd2lkdGggaW50byBhbiBhbmd1bGFyIHNwYW4gb24gdGhlIHNwaGVyZQogICAgICAgICAgICBjb25zdCBwaGlTcGFuID0gYXJyb3dXaWR0aCAvIGFycm93UmFkaXVzOyAvLyByYWRpYW5zIChhcHByb3ggYXQgZXF1YXRvcikKICAgICAgICAgICAgY29uc3QgcGhpMCA9IGJhc2VBbmdsZSAtIHBoaVNwYW4gKiAwLjU7CiAgICAgICAgICAgIGNvbnN0IHBoaTEgPSBiYXNlQW5nbGUgKyBwaGlTcGFuICogMC41OwoKICAgICAgICAgICAgY29uc3QgeTAgPSB5Q2VudGVyIC0gYXJyb3dIZWlnaHQgKiAwLjU7CiAgICAgICAgICAgIGNvbnN0IHkxID0geUNlbnRlciArIGFycm93SGVpZ2h0ICogMC41OwoKICAgICAgICAgICAgY29uc3QgcG9zaXRpb25zID0gW107CiAgICAgICAgICAgIGNvbnN0IG5vcm1hbHMgPSBbXTsKICAgICAgICAgICAgY29uc3QgdXZzID0gW107CiAgICAgICAgICAgIGNvbnN0IGluZGljZXMgPSBbXTsKCiAgICAgICAgICAgIGZvciAobGV0IGl5ID0gMDsgaXkgPD0gc2VnSDsgaXkrKykgewogICAgICAgICAgICAgICAgY29uc3QgdiA9IGl5IC8gc2VnSDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBUSFJFRS5NYXRoVXRpbHMubGVycCh5MCwgeTEsIHYpOwoKICAgICAgICAgICAgICAgIC8vIENpcmNsZSByYWRpdXMgYXQgdGhpcyBoZWlnaHQgb24gdGhlIHNwaGVyZSAoeC96IHNocmluayBhcyB8eXwgZ3Jvd3MpCiAgICAgICAgICAgICAgICBjb25zdCByaW5nUiA9IE1hdGguc3FydChNYXRoLm1heCgwLjAwMDAxLCBhcnJvd1JhZGl1cyAqIGFycm93UmFkaXVzIC0geSAqIHkpKTsKCiAgICAgICAgICAgICAgICBmb3IgKGxldCBpeCA9IDA7IGl4IDw9IHNlZ1c7IGl4KyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB1ID0gaXggLyBzZWdXOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBoaSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKHBoaTAsIHBoaTEsIHUpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5zaW4ocGhpKSAqIHJpbmdSOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHogPSBNYXRoLmNvcyhwaGkpICogcmluZ1I7CgogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9ucy5wdXNoKHgsIHksIHopOwoKICAgICAgICAgICAgICAgICAgICAvLyBPdXR3YXJkIG5vcm1hbCBmb3IgYSBzcGhlcmUgY2VudGVyZWQgYXQgb3JpZ2luCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW52TGVuID0gMS4wIC8gTWF0aC5zcXJ0KHggKiB4ICsgeSAqIHkgKyB6ICogeik7CiAgICAgICAgICAgICAgICAgICAgbm9ybWFscy5wdXNoKHggKiBpbnZMZW4sIHkgKiBpbnZMZW4sIHogKiBpbnZMZW4pOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB2diA9IGZsaXBWID8gKDEgLSB2KSA6IHY7CiAgICAgICAgICAgICAgICAgICAgdXZzLnB1c2godSwgdnYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCByb3cgPSBzZWdXICsgMTsKICAgICAgICAgICAgZm9yIChsZXQgaXkgPSAwOyBpeSA8IHNlZ0g7IGl5KyspIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGl4ID0gMDsgaXggPCBzZWdXOyBpeCsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYSA9IGl5ICogcm93ICsgaXg7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYiA9IGEgKyAxOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGMgPSBhICsgcm93OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGQgPSBjICsgMTsKCiAgICAgICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGEsIGMsIGIpOwogICAgICAgICAgICAgICAgICAgIGluZGljZXMucHVzaChiLCBjLCBkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2VvID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgICAgIGdlby5zZXRJbmRleChpbmRpY2VzKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZShwb3NpdGlvbnMsIDMpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgnbm9ybWFsJywgbmV3IFRIUkVFLkZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUobm9ybWFscywgMykpOwogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCd1dicsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKHV2cywgMikpOwogICAgICAgICAgICBnZW8uY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk7CgogICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLk1lc2goZ2VvLCBhcnJvd01hdCk7CiAgICAgICAgfTsKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1BcnJvd3M7IGkrKykgewogICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gbnVtQXJyb3dzKSAqIE1hdGguUEkgKiAyOwoKICAgICAgICAgICAgLy8gVXBwZXIgYXJyb3cgc3RyaXAgKGFib3ZlIGJhbmQpCiAgICAgICAgICAgIGFycm93R3JvdXAuYWRkKG1ha2VDdXJ2ZWRTdHJpcChhbmdsZSwgYXJyb3dIZWlnaHQgKiAwLjUgKyAyLCBmYWxzZSkpOwoKICAgICAgICAgICAgLy8gTG93ZXIgYXJyb3cgc3RyaXAgKGJlbG93IGJhbmQpIC0gZmxpcCBWIHNvIGFycm93cyBwb2ludCBkb3dud2FyZAogICAgICAgICAgICBhcnJvd0dyb3VwLmFkZChtYWtlQ3VydmVkU3RyaXAoYW5nbGUsIC1hcnJvd0hlaWdodCAqIDAuNSAtIDIsIHRydWUpKTsKICAgICAgICB9CgogICAgICAgIF9zY2VuZS5hZGQoYXJyb3dHcm91cCk7CgogICAgICAgIC8vIFN0b3JlIHJlZmVyZW5jZXMgZm9yIERldlRvb2xzCiAgICAgICAgd2luZG93LmZsdXguYXJyb3dHcm91cCA9IGFycm93R3JvdXA7CiAgICAgICAgd2luZG93LmZsdXguYXJyb3dNYXQgPSBhcnJvd01hdDsKCiAgICAgICAgLy8gLS0tIDUuIFRPUCBHTFlQSFMgKERvbWUpIC0tLSAoRG9tZSkgLS0tCiAgICAgICAgY29uc3QgdG9wR2x5cGhUZXggPSAoKCkgPT4gewogICAgICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgICAgIGMud2lkdGggPSA1MTI7IGMuaGVpZ2h0ID0gNTEyOwogICAgICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgIGN0eC5jbGVhclJlY3QoMCwwLDUxMiw1MTIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMTAwLCAyMDAsIDI1NSwgMC41KSc7CiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoMjU2LCAyNTYsIDIwMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW50cmljYXRlIHBhdHRlcm4KICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ODsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhID0gKGkvOCkqTWF0aC5QSSoyOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IDI1NiArIE1hdGguY29zKGEpKjE1MDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAyNTYgKyBNYXRoLnNpbihhKSoxNTA7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIDQwLCAwLCBNYXRoLlBJKjIpOwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgLy8gQ29ubmVjdG9yCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKDI1NiwgMjU2KTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCwgeSk7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIH0pKCk7CgogICAgICAgIGNvbnN0IHRvcEdseXBoTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiB0b3BHbHlwaFRleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuNCwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHRvcEdseXBoR2VvID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoNjAsIDYwKTsKICAgICAgICBjb25zdCB0b3BHbHlwaCA9IG5ldyBUSFJFRS5NZXNoKHRvcEdseXBoR2VvLCB0b3BHbHlwaE1hdCk7CiAgICAgICAgdG9wR2x5cGgucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICB0b3BHbHlwaC5wb3NpdGlvbi55ID0gMzU7IC8vIE5lYXIgdG9wIG9mIGRvbWUKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYUdyb3VwLmFkZCh0b3BHbHlwaCk7CgogICAgICAgIC8vIC0tLSBORVc6IEZGWCBHT0FMIE1PREVMUyAtLS0KICAgICAgICBjb25zdCBnb2FsVXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hNTE2YmQ5MGZhN2M0ZGVkYjVkY2JmZGY4MDNmMTNkNS5nbGInOwogICAgICAgIApjb25zdCBvbkdvYWxMb2FkZWQgPSAobW9kZWwsIGlzRmFsbGJhY2spID0+IHsKICAgICAgICAgICAgY29uc3QgZ29hbEEgPSBtb2RlbDsKICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UgfHwgNDEuNTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmVkIGRvd24gfjE1ZnQgKDQuNW0pIHRvdGFsIGFzIHJlcXVlc3RlZCwgcHVzaGVkIGJhY2sgdG8gZWRnZQogICAgICAgICAgICBnb2FsQS5wb3NpdGlvbi5zZXQoMCwgLTYuMCwgLWdvYWxEaXN0KTsKICAgICAgICAgICAgaWYgKCFpc0ZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBnb2FsQS5zY2FsZS5zZXRTY2FsYXIoNTQuMCk7IC8vIEluY3JlYXNlZCA1MCUgKHdhcyAzNi4wKQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFNldHVwIEdvYWwgQQogICAgICAgICAgICBnb2FsQS50cmF2ZXJzZShjID0+IHsKICAgICAgICAgICAgICAgIGlmKGMuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgYy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7IC8vIENSSVRJQ0FMOiBQcmV2ZW50IGN1bGxpbmcKICAgICAgICAgICAgICAgICAgICBjLnJlbmRlck9yZGVyID0gMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgbWF0ZXJpYWwgaXMgdmlzaWJsZSBhbmQgdW5pcXVlCiAgICAgICAgICAgICAgICAgICAgaWYgKGMubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbCA9IGMubWF0ZXJpYWwuY2xvbmUoKTsgLy8gQ2xvbmUgZm9yIGluZGVwZW5kZW5jZQogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIFdoaXRlIHRvIHNob3cgb3JpZ2luYWwgdGV4dHVyZS9jb2xvcnMKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC50cmFuc3BhcmVudCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuc2lkZSA9IFRIUkVFLkRvdWJsZVNpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhUZXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyBBZGQgZ29hbHMgdG8gU0NFTkUsIG5vdCBhcmVuYUdyb3VwICh0aGV5IHNob3VsZG4ndCByb3RhdGUgd2l0aCB0aGUgc3BoZXJlKQogICAgICAgICAgICBfc2NlbmUuYWRkKGdvYWxBKTsKICAgICAgICAgICAgd2luZG93LmZsdXguZ29hbEEgPSBnb2FsQTsgLy8gRXhwb3NlIGZvciBEZXZUb29scwoKICAgICAgICAgICAgLy8gU2V0dXAgR29hbCBCCiAgICAgICAgICAgIGNvbnN0IGdvYWxCID0gaXNGYWxsYmFjayA/IGdvYWxBLmNsb25lKCkgOiBUSFJFRS5Ta2VsZXRvblV0aWxzLmNsb25lKGdvYWxBKTsKCiAgICAgICAgICAgIGdvYWxCLnBvc2l0aW9uLnNldCgwLCAtNi4wLCBnb2FsRGlzdCk7IC8vIE1vdmVkIGNsb3NlciAod2FzIDQ1KSBhbmQgZG93bgogICAgICAgICAgICBnb2FsQi5yb3RhdGlvbi55ID0gTWF0aC5QSTsKICAgICAgICAgICAgLy8gRW5zdXJlIEdvYWwgQiBtZXNoZXMgYXJlIGFsc28gcGVyc2lzdGVudCBhbmQgaGF2ZSB1bmlxdWUgbWF0ZXJpYWxzCiAgICAgICAgICAgIGdvYWxCLnRyYXZlcnNlKGMgPT4gewogICAgICAgICAgICAgICAgaWYoYy5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICBjLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoYy5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsID0gYy5tYXRlcmlhbC5jbG9uZSgpOyAvLyBDbG9uZSBhZ2FpbiBmb3IgQgogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLnRyYW5zcGFyZW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5kZXB0aFdyaXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgX3NjZW5lLmFkZChnb2FsQik7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdvYWxCID0gZ29hbEI7IC8vIEV4cG9zZSBmb3IgRGV2VG9vbHMKICAgICAgICB9OwoKICAgICAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlci5sb2FkTW9kZWwoZ29hbFVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgb25Hb2FsTG9hZGVkKGdsdGYuc2NlbmUsIGZhbHNlKTsKICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJHb2FsIG1vZGVsIGZhaWxlZCB0byBsb2FkLiBVc2luZyBmYWxsYmFjay4iLCBlcnIpOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoNzUsIDQ1LCAxMCk7IC8vIEZhbGxiYWNrIG1hc3NpdmUgYm94IChTY2FsZWQgMS41eCkKICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHhmZmZmZmYsIHdpcmVmcmFtZTogdHJ1ZSB9KTsKICAgICAgICAgICAgY29uc3QgZmFsbGJhY2sgPSBuZXcgVEhSRUUuTWVzaChnZW8sIGZhbGxiYWNrTWF0KTsKICAgICAgICAgICAgb25Hb2FsTG9hZGVkKGZhbGxiYWNrLCB0cnVlKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gLS0tIE5FVzogTUFTU0lWRSBGSUVMRCBNQVJLSU5HUyAtLS0KICAgICAgICBjcmVhdGVGaWVsZE1hcmtpbmdzKCk7CiAgICB9CgpmdW5jdGlvbiBjcmVhdGVGaWVsZE1hcmtpbmdzKCkgewogICAgICAgIC8vIExvYWQgZmxvb3IgZ2x5cGggZnJvbSBpbWFnZQogICAgICAgIGNvbnN0IHRleExvYWRlciA9IG5ldyBUSFJFRS5UZXh0dXJlTG9hZGVyKCk7CiAgICAgICAgY29uc3QgdGV4ID0gdGV4TG9hZGVyLmxvYWQoJ2h0dHBzOi8vaS5wb3N0aW1nLmNjL3Y4Q1I4NWRRL0Zsb29yZ2x5cGgucG5nJyk7CiAgICAgICAgdGV4LmFuaXNvdHJvcHkgPSAxNjsKCiAgICAgICAgLy8gRmxvb3IgUGxhbmUgKERlZXApCiAgICAgICAgY29uc3QgZ2VvID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoOTAsIDkwKTsKICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IHRleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuMzUsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZwogICAgICAgIH0pOwoKICAgICAgICBjb25zdCBmaWVsZCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgbWF0KTsKICAgICAgICBmaWVsZC5yb3RhdGlvbi54ID0gLU1hdGguUEkgLyAyOwogICAgICAgIGZpZWxkLnBvc2l0aW9uLnkgPSAtOC4wOyAvLyBTdW5rIGRlZXAKICAgICAgICBfc2NlbmUuYWRkKGZpZWxkKTsKCiAgICAgICAgLy8gU3RvcmUgcmVmZXJlbmNlcyBmb3IgRGV2VG9vbHMKICAgICAgICB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWVzaCA9IGZpZWxkOwogICAgICAgIHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQgPSBtYXQ7CiAgICB9CgpmdW5jdGlvbiBjcmVhdGVIb2xvZ3JhcGhpY1JpbmdzKCkgewogICAgICAgIC8vIEZsb2F0aW5nIEhvbG9ncmFwaGljIFJpbmdzIChNaWQtaGVpZ2h0KQogICAgICAgIGNvbnN0IHJpbmdHZW8gPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgyMCwgMC4xLCAxNiwgMTAwKTsKICAgICAgICBjb25zdCByaW5nTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZmZmLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4zLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KTsKICAgICAgICBjb25zdCByaW5nMSA9IG5ldyBUSFJFRS5NZXNoKHJpbmdHZW8sIHJpbmdNYXQpOwogICAgICAgIHJpbmcxLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICByaW5nMS5wb3NpdGlvbi55ID0gMDsKICAgICAgICBfc2NlbmUuYWRkKHJpbmcxKTsKICAgICAgICAKICAgICAgICBjb25zdCByaW5nMiA9IG5ldyBUSFJFRS5NZXNoKHJpbmdHZW8sIHJpbmdNYXQpOwogICAgICAgIHJpbmcyLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICByaW5nMi5zY2FsZS5zZXRTY2FsYXIoMS4yKTsKICAgICAgICByaW5nMi5wb3NpdGlvbi55ID0gNC4wOwogICAgICAgIF9zY2VuZS5hZGQocmluZzIpOwoKICAgICAgICAvLyBBbmltYXRlIFJpbmdzIChpbnRlZ3JhdGVkIGludG8gbWFpbiBsb29wIHRvIGF2b2lkIGEgc2Vjb25kIFJBRiBvbiBtb2JpbGUpCmxldCBfcmluZ1RpbWUgPSAwOwogICAgICAgIGNvbnN0IF9yaW5nVXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIF9yaW5nVGltZSArPSBkdDsKICAgICAgICAgICAgaWYgKHJpbmcxKSB7CiAgICAgICAgICAgICAgICByaW5nMS5yb3RhdGlvbi56ICs9IGR0ICogMC45OwogICAgICAgICAgICAgICAgcmluZzEuc2NhbGUuc2V0U2NhbGFyKDEuMCArIE1hdGguc2luKF9yaW5nVGltZSAqIDAuNSkgKiAwLjA1KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmluZzIpIHsKICAgICAgICAgICAgICAgIHJpbmcyLnJvdGF0aW9uLnogLT0gZHQgKiAwLjc1OwogICAgICAgICAgICAgICAgcmluZzIucG9zaXRpb24ueSA9IDQuMCArIE1hdGguY29zKF9yaW5nVGltZSAqIDAuNykgKiAxLjA7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGlmICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzKSB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLnB1c2goX3JpbmdVcGRhdGUpOwogICAgfQoKICAgIC8vIC0tLSBJTlBVVCBTWVNURU0gLS0tCi8vIC0tLSBJTlBVVCBTWVNURU0gLS0tCmNvbnN0IF9rZXlzID0ge307Ci8vIEdsb2JhbHMgbW92ZWQgdG8gYmVsb3cgaGVscGVyCgogICAgLy8gSGVscGVyOiBBbmFseXplIGN1cnZlIGdlb21ldHJ5IGZvciBhbmFsb2cgY29udHJvbAogICAgY29uc3QgYW5hbHl6ZVN3aXBlQ3VydmUgPSAocG9pbnRzKSA9PiB7CiAgICAgICAgaWYgKHBvaW50cy5sZW5ndGggPCAzKSByZXR1cm4geyBpbnRlbnNpdHk6IDAsIHNwZWVkOiAwLCBkeDogMCwgZHk6IDAgfTsKICAgICAgICAKICAgICAgICBjb25zdCBwU3RhcnQgPSBwb2ludHNbMF07CiAgICAgICAgY29uc3QgcEVuZCA9IHBvaW50c1twb2ludHMubGVuZ3RoIC0gMV07CiAgICAgICAgY29uc3QgbWlkSWR4ID0gTWF0aC5mbG9vcihwb2ludHMubGVuZ3RoIC8gMik7CiAgICAgICAgY29uc3QgcE1pZCA9IHBvaW50c1ttaWRJZHhdOwoKICAgICAgICBjb25zdCBkeCA9IHBFbmQueCAtIHBTdGFydC54OwogICAgICAgIGNvbnN0IGR5ID0gcEVuZC55IC0gcFN0YXJ0Lnk7CiAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKICAgICAgICBjb25zdCBkdCA9IHBFbmQudCAtIHBTdGFydC50OwogICAgICAgIGNvbnN0IHNwZWVkID0gKGR0ID4gMCkgPyBkaXN0IC8gZHQgOiAwOyAvLyBweC9tcwoKICAgICAgICBpZiAoZGlzdCA8IDUwKSByZXR1cm4geyBpbnRlbnNpdHk6IDAsIHNwZWVkOiBzcGVlZCwgZHgsIGR5IH07CgogICAgICAgIGNvbnN0IHZTTV94ID0gcE1pZC54IC0gcFN0YXJ0Lng7CiAgICAgICAgY29uc3QgdlNNX3kgPSBwTWlkLnkgLSBwU3RhcnQueTsKCiAgICAgICAgLy8gQ3Jvc3MgcHJvZHVjdCBnaXZlcyBzaWduZWQgYXJlYS9jdXJ2YXR1cmUgZGlyZWN0aW9uCiAgICAgICAgY29uc3QgY3Jvc3MgPSAoZHggKiB2U01feSkgLSAoZHkgKiB2U01feCk7CiAgICAgICAgLy8gTm9ybWFsaXplIGJ5IGRpc3RhbmNlIHNxdWFyZWQgdG8gZ2V0IGEgY3VydmF0dXJlIHJhdGlvIGluZGVwZW5kZW50IG9mIHNjYWxlCmNvbnN0IGludGVuc2l0eSA9IGNyb3NzIC8gKGRpc3QgKiBkaXN0KTsKCiAgICAgICAgcmV0dXJuIHsgaW50ZW5zaXR5LCBzcGVlZCwgZHgsIGR5IH07CiAgICB9OwogICAgbGV0IF9zd2lwZVBvaW50cyA9IFtdOyAvLyBUcmFjayBzd2lwZSBoaXN0b3J5IGZvciBjdXJ2ZXMKICAgIGNvbnN0IF9haW1JbnB1dCA9IHsgeDogMCwgeTogMCwgYWN0aXZlOiBmYWxzZSB9OyAvLyBORVc6IEFpbSBqb3lzdGljawoKICAgIGNvbnN0IF9hY3Rpb25CdWZmZXIgPSB7IGFjdGl2ZTogZmFsc2UsIHRpbWVzdGFtcDogMCwgZHVyYXRpb246IDMwMCB9OwoKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF91cEF4aXMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKTsKCmZ1bmN0aW9uIHNldHVwSW5wdXRzKCkgewogICAgICAgIC8vIFNraXAgSW50cm8gTGlzdGVuZXIKICAgICAgICBjb25zdCBza2lwSGFuZGxlciA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPT09ICdpbnRybycpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5za2lwSW50cm8oKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHNraXBIYW5kbGVyKTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHNraXBIYW5kbGVyLCB7cGFzc2l2ZTogdHJ1ZX0pOwoKICAgICAgICAvLyBLZXlib2FyZAogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgX2tleXNbZS5rZXldID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ1NwYWNlJyAmJiBfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllciAmJiBfYmFsbCkgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50aHJvd0JhbGwoX2JhbGwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE5FVzogVGFja2xlIG9uIFNoaWZ0CiAgICAgICAgICAgIGlmIChlLmNvZGUgPT09ICdTaGlmdExlZnQnIHx8IGUuY29kZSA9PT0gJ1NoaWZ0UmlnaHQnKSB7CiAgICAgICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBwLmRhc2gocC5pbnB1dFZlY3Rvci54LCBwLmlucHV0VmVjdG9yLnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH0pOwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIChlKSA9PiB7IF9rZXlzW2Uua2V5XSA9IGZhbHNlOyB1cGRhdGVJbnB1dFZlY3RvcigpOyB9KTsKCiAgICAgICAgLy8gLS0tIEZMT0FUSU5HIEpPWVNUSUNLIChNb3ZlbWVudCkgLS0tCiAgICAgICAgY29uc3QgaGl0Wm9uZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1oaXQtem9uZScpOwogICAgICAgIGNvbnN0IHZpc3VhbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2stdmlzdWFsLWNvbnRhaW5lcicpOwogICAgICAgIGNvbnN0IGJhc2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2stYmFzZScpOwogICAgICAgIGNvbnN0IGtub2IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2sta25vYicpOwoKICAgICAgICBsZXQgc3RhcnRYID0gMCwgc3RhcnRZID0gMDsKICAgICAgICBsZXQgZHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICBjb25zdCBtYXhEaXN0ID0gNDA7CgogICAgICAgIGxldCBtb3ZlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgY29uc3QgbW92ZURlYWR6b25lUHggPSA2OwoKICAgICAgICAvLyBFeHBvc2UgbW92ZSBqb3lzdGljayBzdGF0ZSBmb3Igc25hcHNob3RzCiAgICAgICAgY29uc3QgX2RiZyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPID0gd2luZG93LmZsdXguX2RlYnVnSU8gfHwge307CiAgICAgICAgX2RiZy5zZXR0aW5ncyA9IF9zZXR0aW5nczsKICAgICAgICBfZGJnLmlucHV0ID0gX2RiZy5pbnB1dCB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUgPSBfZGJnLmlucHV0Lm1vdmUgfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnZlY3RvciA9IF9pbnB1dDsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUuZHJhZ2dpbmcgPSBkcmFnZ2luZzsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUudG91Y2hJZCA9IG1vdmVUb3VjaElkOwoKCiAgICAgICAgY29uc3QgaGFuZGxlU3RhcnQgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBkcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHN0YXJ0WCA9IGNsaWVudFg7CgogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQubW92ZSkgewogICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLmRyYWdnaW5nID0gZHJhZ2dpbmc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN0YXJ0WSA9IGNsaWVudFk7CgogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLmxlZnQgPSBgJHtjbGllbnRYfXB4YDsKICAgICAgICAgICAgdmlzdWFscy5zdHlsZS50b3AgPSBgJHtjbGllbnRZfXB4YDsKCiAgICAgICAgICAgIGtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgtNTAlLCAtNTAlKWA7CgogICAgICAgICAgICBjcmVhdGVSaXBwbGUoY2xpZW50WCwgY2xpZW50WSk7CgogICAgICAgICAgICBfaW5wdXQueCA9IDA7CiAgICAgICAgICAgIF9pbnB1dC55ID0gMDsKICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVNb3ZlID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGR4ID0gY2xpZW50WCAtIHN0YXJ0WDsKICAgICAgICAgICAgbGV0IGR5ID0gY2xpZW50WSAtIHN0YXJ0WTsKCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgoKICAgICAgICAgICAgLy8gRGVhZHpvbmUgdG8gcHJldmVudCBkcmlmdCBmcm9tIHRpbnkgdGh1bWIgaml0dGVyCiAgICAgICAgICAgIGlmIChkaXN0IDwgbW92ZURlYWR6b25lUHgpIHsKICAgICAgICAgICAgICAgIGR4ID0gMDsKICAgICAgICAgICAgICAgIGR5ID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRpc3QgPiBtYXhEaXN0KSB7CiAgICAgICAgICAgICAgICBkeCA9IChkeCAvIGRpc3QpICogbWF4RGlzdDsKICAgICAgICAgICAgICAgIGR5ID0gKGR5IC8gZGlzdCkgKiBtYXhEaXN0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBrbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoY2FsYygtNTAlICsgJHtkeH1weCksIGNhbGMoLTUwJSArICR7ZHl9cHgpKWA7CgogICAgICAgICAgICBfaW5wdXQueCA9IChkeCAvIG1heERpc3QpICogX3NldHRpbmdzLmpveXN0aWNrU2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIF9pbnB1dC55ID0gKGR5IC8gbWF4RGlzdCkgKiBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eTsKICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVFbmQgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgZHJhZ2dpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIG1vdmVUb3VjaElkID0gbnVsbDsKCiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5tb3ZlKSB7CiAgICAgICAgICAgICAgICBfZGJnLmlucHV0Lm1vdmUuZHJhZ2dpbmcgPSBkcmFnZ2luZzsKICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS50b3VjaElkID0gbW92ZVRvdWNoSWQ7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBfaW5wdXQueCA9IDA7CiAgICAgICAgICAgIF9pbnB1dC55ID0gMDsKICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9OwoKICAgICAgICBpZiAoaGl0Wm9uZSkgewogICAgICAgICAgICBoaXRab25lLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXNbMF0pID8gZS5jaGFuZ2VkVG91Y2hlc1swXSA6IGUudG91Y2hlc1swXTsKICAgICAgICAgICAgICAgIG1vdmVUb3VjaElkID0gdCA/IHQuaWRlbnRpZmllciA6IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQubW92ZSkgewogICAgICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS50b3VjaElkID0gbW92ZVRvdWNoSWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBoYW5kbGVTdGFydCh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIG1vdmVUb3VjaElkKTsKICAgICAgICAgICAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICAgICAgICAgICAgaGFuZGxlTW92ZSh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBtb3ZlVG91Y2hJZCk7CiAgICAgICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsgLy8gSWdub3JlIG90aGVyIGZpbmdlcnMgbGlmdGluZwogICAgICAgICAgICAgICAgaGFuZGxlRW5kKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBtb3ZlVG91Y2hJZCk7CiAgICAgICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsKICAgICAgICAgICAgICAgIGhhbmRsZUVuZCgpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGhpdFpvbmUuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGhhbmRsZVN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGRyYWdnaW5nKSBoYW5kbGVNb3ZlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBORVc6IEFJTSBKT1lTVElDSyAoUmlnaHQgc2lkZSkgLS0tCiAgICAgICAgc2V0dXBBaW1Kb3lzdGljaygpOwoKICAgICAgICAvLyAtLS0gTkVXOiBUQUNLTEUgQlVUVE9OIC0tLQogICAgICAgIHNldHVwVGFja2xlQnV0dG9uKCk7CgogICAgICAgIC8vIFN3aXBlIERldGVjdGlvbgovLyBTd2lwZSBEZXRlY3Rpb24KICAgICAgICBsZXQgc3dpcGVTdGFydCA9IHsgeDogMCwgeTogMCwgdDogMCB9OwogICAgICAgIGxldCBzd2lwZVRvdWNoSWQgPSBudWxsOwogICAgICAgIAogICAgICAgIC8vIEV4cG9zZSBzd2lwZS90aHJvdyBnZXN0dXJlIHN0YXRlIGZvciBzbmFwc2hvdHMKICAgICAgICBfZGJnLmlucHV0LnN3aXBlID0gX2RiZy5pbnB1dC5zd2lwZSB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0LnN3aXBlLnN0YXJ0ID0gc3dpcGVTdGFydDsKICAgICAgICBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7CiAgICAgICAgX2RiZy5pbnB1dC5zd2lwZS5wb2ludHMgPSBfc3dpcGVQb2ludHM7CmNvbnN0IG9uU3dpcGVTdGFydCA9ICh4LCB5KSA9PiB7CiAgICAgICAgICAgIHN3aXBlU3RhcnQueCA9IHg7CiAgICAgICAgICAgIHN3aXBlU3RhcnQueSA9IHk7CiAgICAgICAgICAgIHN3aXBlU3RhcnQudCA9IERhdGUubm93KCk7CiAgICAgICAgICAgIF9zd2lwZVBvaW50cyA9IFt7eCwgeSwgdDogRGF0ZS5ub3coKX1dOwogICAgICAgIH07Cgpjb25zdCBvblN3aXBlTW92ZSA9ICh4LCB5KSA9PiB7CiAgICAgICAgICAgIGlmIChfc3dpcGVQb2ludHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgX3N3aXBlUG9pbnRzLnB1c2goe3gsIHksIHQ6IERhdGUubm93KCl9KTsKICAgICAgICAgICAgICAgIGNyZWF0ZVN3aXBlVHJhaWxEb3QoeCwgeSk7IC8vIFZpc3VhbCBGZWVkYmFjawogICAgICAgICAgICB9CiAgICAgICAgfTsKCmNvbnN0IG9uU3dpcGVFbmQgPSAoeCwgeSkgPT4gewogICAgICAgICAgICBpZiAoX3N3aXBlUG9pbnRzLmxlbmd0aCA8IDIpIHJldHVybjsKICAgICAgICAgICAgX3N3aXBlUG9pbnRzLnB1c2goe3gsIHksIHQ6IERhdGUubm93KCl9KTsKCiAgICAgICAgICAgIGNvbnN0IHsgaW50ZW5zaXR5LCBzcGVlZCwgZHgsIGR5IH0gPSBhbmFseXplU3dpcGVDdXJ2ZShfc3dpcGVQb2ludHMpOwogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwoKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyICYmIF9jYW1lcmEpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgICAgIC8vIC0tLSBDVVJWRSBCQUxMIERFVEVDVElPTiAoSW1tZWRpYXRlIFRocm93KSAtLS0KLy8gLS0tIENVUlZFIEJBTEwgREVURUNUSU9OIChJbW1lZGlhdGUgVGhyb3cpIC0tLQogICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCAmJiAhcC5pc1Rocm93aW5nICYmICFwLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBBbmFsb2cgQ3VydmUgQ2hlY2s6IFRocmVzaG9sZCAwLjI1IHJlcXVpcmVzIGEgZGVsaWJlcmF0ZSBhcmMgKFRoZSAiRmVhdCIpCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGludGVuc2l0eSkgPiAwLjI1ICYmIGRpc3QgPiAxMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhfY2FtRndkLCBfdXBBeGlzKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWCA9IChfY2FtUmlnaHQueCAqIGR4KSArIChfY2FtRndkLnggKiAtZHkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoX2NhbVJpZ2h0LnogKiBkeCkgKyAoX2NhbUZ3ZC56ICogLWR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGhyb3dEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMyh3b3JsZFgsIDAsIHdvcmxkWikubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBNYXAgaW50ZW5zaXR5IHRvIHNwaW4gLSBEcmFzdGljYWxseSByZWR1Y2VkIHNlbnNpdGl2aXR5CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhd1NwaW4gPSBNYXRoLmFicyhpbnRlbnNpdHkpICogMzAwLjA7IAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGVlZEZhY3RvciA9IE1hdGgubWluKDEuNSwgc3BlZWQgLyAxLjApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluUG93ZXIgPSBNYXRoLm1pbig0MDAuMCwgcmF3U3BpbiAqIHNwZWVkRmFjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblNpZ24gPSBNYXRoLnNpZ24oaW50ZW5zaXR5KTsgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5WZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCBzcGluUG93ZXIgKiBzcGluU2lnbiwgMCk7CgoKICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRPdmVycmlkZUFpbSh0aHJvd0Rpci54LCB0aHJvd0Rpci56KTsKICAgICAgICAgICAgICAgICAgICAgICAgcC50aHJvd0JhbGwod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGwsICdTSCcsIDEuMCwgc3BpblZlYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQ1VSVkUiLCBwLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlUmlwcGxlKHgsIHkpOwogICAgICAgICAgICAgICAgICAgICAgICBfc3dpcGVQb2ludHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOyAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gLS0tIFNUQU5EQVJEIERBU0ggLyBBSU0gLS0tCiAgICAgICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICAgICAgZWxzZSBfY2FtRndkLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7Cgpjb25zdCB3b3JsZFgyID0gKF9jYW1SaWdodC54ICogZHgpICsgKF9jYW1Gd2QueCAqIC1keSk7CiAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFoyID0gKF9jYW1SaWdodC56ICogZHgpICsgKF9jYW1Gd2QueiAqIC1keSk7CgogICAgICAgICAgICAgICAgaWYgKHAuaXNUaHJvd2luZykgewpwLnNldE92ZXJyaWRlQWltKHdvcmxkWDIsIHdvcmxkWjIpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkFJTSEiLCBwLm1lc2gucG9zaXRpb24sICJkZWZhdWx0Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKaWYgKGRpc3QgPiA1MCkgcC5kYXNoKHdvcmxkWDIsIHdvcmxkWjIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNyZWF0ZVJpcHBsZSh4LCB5KTsKICAgICAgICAgICAgfQpfc3dpcGVQb2ludHMgPSBbXTsKICAgICAgICB9OwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHQgPSAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzWzBdKSA/IGUuY2hhbmdlZFRvdWNoZXNbMF0gOiBlLnRvdWNoZXNbMF07CiAgICAgICAgICAgIHN3aXBlVG91Y2hJZCA9IHQgPyB0LmlkZW50aWZpZXIgOiBudWxsOwovLyBvblN3aXBlU3RhcnQodC5jbGllbnRYLCB0LmNsaWVudFkpOyAvLyBGaXhlZCBzeW50YXggZXJyb3IKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LnN3aXBlKSB7IF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsgfQogICAgICAgICAgICBvblN3aXBlU3RhcnQodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgICAgICBjcmVhdGVSaXBwbGUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7Cgp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBzd2lwZVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgb25Td2lwZU1vdmUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBzd2lwZVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsgLy8gSWdub3JlIG90aGVyIGZpbmdlcnMgbGlmdGluZwogICAgICAgICAgICBvblN3aXBlRW5kKHRFbmQuY2xpZW50WCwgdEVuZC5jbGllbnRZKTsKICAgICAgICAgICAgc3dpcGVUb3VjaElkID0gbnVsbDsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LnN3aXBlKSB7IF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsgfQogICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIChlKSA9PiB7CmlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBzd2lwZVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsgLy8gSWdub3JlIG90aGVyIGZpbmdlcnMgbGlmdGluZwogICAgICAgICAgICBvblN3aXBlRW5kKHRFbmQuY2xpZW50WCwgdEVuZC5jbGllbnRZKTsKICAgICAgICAgICAgc3dpcGVUb3VjaElkID0gbnVsbDsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LnN3aXBlKSB7IF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsgfQogICAgICAgIAogICAgICAgIH0pOwovLyBNb3VzZSBTd2lwZQogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CgogICAgICAgICAgICBvblN3aXBlU3RhcnQoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICBjcmVhdGVSaXBwbGUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykpIHJldHVybjsKICAgICAgICAgICAgLy8gT25seSB0cmFjayBpZiBtb3VzZSBpcyBkb3duIChzaW11bGF0aW5nIGRyYWcpCiAgICAgICAgICAgIGlmIChlLmJ1dHRvbnMgPT09IDEpIHsKICAgICAgICAgICAgICAgIG9uU3dpcGVNb3ZlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CiAgICAgICAgICAgIG9uU3dpcGVFbmQoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBBY3Rpb24gQnV0dG9uIChTaG9vdC9QYXNzKQogICAgICAgIGNvbnN0IGFjdGlvbkJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY3Rpb24tYnV0dG9uJyk7Cgpjb25zdCBzZXR1cEJ1dHRvbiA9IChidG4pID0+IHsKICAgICAgICAgICAgaWYgKCFidG4pIHJldHVybjsKCiAgICAgICAgICAgIGxldCBidG5TdGFydFggPSAwOwogICAgICAgICAgICBsZXQgYnRuU3RhcnRZID0gMDsKICAgICAgICAgICAgbGV0IGlzRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgbGV0IHN3aXBlUG9pbnRzID0gW107CiAgICAgICAgICAgIGxldCBhY3Rpb25Ub3VjaElkID0gbnVsbDsKCiAgICAgICAgICAgIGNvbnN0IGF0dGVtcHRBY3Rpb24gPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIV9ob21lVGVhbSB8fCAhX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCAmJiAhcC5pc0NoYXJnaW5nICYmICFwLmlzVGhyb3dpbmcgJiYgcC5zdGF0dXMubmFwIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBwLnN0YXJ0Q2hhcmdlKCk7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgaGFuZGxlU3RhcnQgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLnRlY2hDb3B5U3RhdGUuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmF0dGVtcHRUZWNoQ29weSgpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSwgMTAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaXNEZW1vTW9kZSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGxldCBjbGllbnRYID0gZS5jbGllbnRYOwogICAgICAgICAgICAgICAgbGV0IGNsaWVudFkgPSBlLmNsaWVudFk7CiAgICAgICAgICAgICAgICBpZiAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBlLmNoYW5nZWRUb3VjaGVzWzBdOwogICAgICAgICAgICAgICAgICAgIGFjdGlvblRvdWNoSWQgPSB0LmlkZW50aWZpZXI7CiAgICAgICAgICAgICAgICAgICAgY2xpZW50WCA9IHQuY2xpZW50WDsKICAgICAgICAgICAgICAgICAgICBjbGllbnRZID0gdC5jbGllbnRZOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBhY3Rpb25Ub3VjaElkID0gbnVsbDsgLy8gbW91c2UKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJ0blN0YXJ0WCA9IGNsaWVudFg7CiAgICAgICAgICAgICAgICBidG5TdGFydFkgPSBjbGllbnRZOwogICAgICAgICAgICAgICAgaXNEcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICBzd2lwZVBvaW50cyA9IFt7eDogY2xpZW50WCwgeTogY2xpZW50WSwgdDogRGF0ZS5ub3coKX1dOwoKICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIudGltZXN0YW1wID0gRGF0ZS5ub3coKTsKCiAgICAgICAgICAgICAgICBpZiAoYXR0ZW1wdEFjdGlvbigpKSB7CiAgICAgICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBdHRhY2ggZ2xvYmFsIGxpc3RlbmVycyB0byB0cmFjayBzd2lwZSBvdXRzaWRlIGJ1dHRvbgogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGhhbmRsZU1vdmUsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBoYW5kbGVNb3ZlKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGNvbnN0IGhhbmRsZU1vdmUgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFpc0RyYWdnaW5nKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gVG91Y2ggcGF0aCAobXVsdGktdG91Y2ggc2FmZSkKICAgICAgICAgICAgICAgIGlmIChlLnRvdWNoZXMgJiYgYWN0aW9uVG91Y2hJZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIGFjdGlvblRvdWNoSWQpOwogICAgICAgICAgICAgICAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIHN3aXBlUG9pbnRzLnB1c2goe3g6IHQuY2xpZW50WCwgeTogdC5jbGllbnRZLCB0OiBEYXRlLm5vdygpfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE1vdXNlIHBhdGgKICAgICAgICAgICAgICAgIGNvbnN0IGNsaWVudFggPSBlLmNsaWVudFg7CiAgICAgICAgICAgICAgICBjb25zdCBjbGllbnRZID0gZS5jbGllbnRZOwogICAgICAgICAgICAgICAgc3dpcGVQb2ludHMucHVzaCh7eDogY2xpZW50WCwgeTogY2xpZW50WSwgdDogRGF0ZS5ub3coKX0pOwogICAgICAgICAgICB9OwoKY29uc3QgaGFuZGxlRW5kID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIGxldCBkeCA9IDA7CiAgICAgICAgICAgICAgICBsZXQgZHkgPSAwOwogICAgICAgICAgICAgICAgbGV0IHZhbGlkRW5kID0gZmFsc2U7CgogICAgICAgICAgICAgICAgLy8gMS4gQ2hlY2sgVG91Y2gKICAgICAgICAgICAgICAgIGlmIChlLmNoYW5nZWRUb3VjaGVzICYmIGFjdGlvblRvdWNoSWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIGFjdGlvblRvdWNoSWQpOwogICAgICAgICAgICAgICAgICAgIGlmICh0RW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGR4ID0gdEVuZC5jbGllbnRYIC0gYnRuU3RhcnRYOwogICAgICAgICAgICAgICAgICAgICAgICBkeSA9IHRFbmQuY2xpZW50WSAtIGJ0blN0YXJ0WTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRFbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25Ub3VjaElkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgLy8gMi4gQ2hlY2sgTW91c2UKICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFlLmNoYW5nZWRUb3VjaGVzICYmIGlzRHJhZ2dpbmcpIHsKICAgICAgICAgICAgICAgICAgICBkeCA9IGUuY2xpZW50WCAtIGJ0blN0YXJ0WDsKICAgICAgICAgICAgICAgICAgICBkeSA9IGUuY2xpZW50WSAtIGJ0blN0YXJ0WTsKICAgICAgICAgICAgICAgICAgICB2YWxpZEVuZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCF2YWxpZEVuZCkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIC8vIENsZWFudXAgbGlzdGVuZXJzCiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgaGFuZGxlTW92ZSk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBoYW5kbGVNb3ZlKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKCiAgICAgICAgICAgICAgICBpZiAoIWlzRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgd2FzQnVmZmVyZWQgPSBfYWN0aW9uQnVmZmVyLmFjdGl2ZTsKICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gZmFsc2U7CgogICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ3VydmUgQW5hbHlzaXMKICAgICAgICAgICAgICAgICAgICBsZXQgY3VydmVEYXRhID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBsZXQgc3BpblZlYyA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBjdXJ2ZSBpZiB3ZSBoYXZlIGVub3VnaCBkYXRhCi8vIENhbGN1bGF0ZSBjdXJ2ZSBpZiB3ZSBoYXZlIGVub3VnaCBkYXRhCiAgICAgICAgICAgICAgICAgICAgaWYgKHN3aXBlUG9pbnRzLmxlbmd0aCA+IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5hbHlzaXMgPSBhbmFseXplU3dpcGVDdXJ2ZShzd2lwZVBvaW50cyk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhpZ2ggdGhyZXNob2xkIGZvciBidXR0b24gcmVsZWFzZSB0b28KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGFuYWx5c2lzLmludGVuc2l0eSkgPiAwLjI1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJ2ZURhdGEgPSBhbmFseXNpczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIHNwaW4gdmVjdG9yIGZvciBtb3VzZS90b3VjaCB1bmlmaWVkIChDb25zZXJ2YXRpdmUgdmFsdWVzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblBvd2VyID0gTWF0aC5taW4oNDAwLjAsIE1hdGguYWJzKGFuYWx5c2lzLmludGVuc2l0eSkgKiAxNTAwLjApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblNpZ24gPSBNYXRoLnNpZ24oYW5hbHlzaXMuaW50ZW5zaXR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwaW5WZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCBzcGluUG93ZXIgKiBzcGluU2lnbiwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KfQoKICAgICAgICAgICAgICAgICAgICAvLyBFWEVDVVRFCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaXNDaGFyZ2luZykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWwgUmVsZWFzZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3BpblZlYykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVW5pZmllZCBzcGluIHBhc3NpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAucmVsZWFzZUNoYXJnZShkeCwgZHksIHsgaW50ZW5zaXR5OiBjdXJ2ZURhdGEuaW50ZW5zaXR5LCBzcGVlZDogY3VydmVEYXRhLnNwZWVkIH0pOyAKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAucmVsZWFzZUNoYXJnZShkeCwgZHksIGN1cnZlRGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAod2FzQnVmZmVyZWQgJiYgcC5oYXNCYWxsICYmICFwLmlzVGhyb3dpbmcgJiYgcC5zdGF0dXMubmFwIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQnVmZmVyZWQgVGFwIChJbnN0YW50IFNob3QpCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvcmNlIHN0YXJ0IGFuZCByZWxlYXNlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlQ2hhcmdlKGR4LCBkeSwgY3VydmVEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlU3RhcnQsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBoYW5kbGVTdGFydCk7CiAgICAgICAgfTsKICAgICAgICBzZXR1cEJ1dHRvbihhY3Rpb25CdG4pOwoKLy8gQXV0byBUb2dnbGUKICAgICAgICBjb25zdCBhdXRvQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F1dG8tdG9nZ2xlJyk7CiAgICAgICAgaWYgKGF1dG9CdG4pIHsKICAgICAgICAgICAgY29uc3QgaGFuZGxlVG9nZ2xlID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci50b2dnbGVEZW1vTW9kZSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGF1dG9CdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBoYW5kbGVUb2dnbGUpOwphdXRvQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgaGFuZGxlVG9nZ2xlKCk7CiAgICAgICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IFNldHRpbmdzIEJ1dHRvbgogICAgICAgIHNldHVwU2V0dGluZ3NCdXR0b24oKTsKICAgIH0KCiAgICAvLyBORVc6IEFpbSBKb3lzdGljayBTZXR1cAovLyBORVc6IEFpbSBKb3lzdGljayBTZXR1cApmdW5jdGlvbiBzZXR1cEFpbUpveXN0aWNrKCkgewogICAgICAgIGNvbnN0IGFpbUtub2IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWltLWpveXN0aWNrLWtub2InKTsKICAgICAgICBjb25zdCBhaW1WaXN1YWxzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1qb3lzdGljay12aXN1YWwnKTsKICAgICAgICBjb25zdCBhaW1ab25lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1qb3lzdGljay16b25lJyk7CiAgICAgICAgaWYgKCFhaW1ab25lKSByZXR1cm47CiAgICAgICAgbGV0IGFpbVN0YXJ0WCA9IDAsIGFpbVN0YXJ0WSA9IDA7CiAgICAgICAgbGV0IGFpbURyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgY29uc3QgYWltTWF4RGlzdCA9IDM1OwogICAgICAgIGxldCBhaW1Ub3VjaElkID0gbnVsbDsKCiAgICAgICAgCgogICAgICAgIC8vIEV4cG9zZSBhaW0gam95c3RpY2sgc3RhdGUgZm9yIHNuYXBzaG90cwogICAgICAgIGNvbnN0IF9kYmcgPSB3aW5kb3cuZmx1eC5fZGVidWdJTyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIHx8IHt9OwogICAgICAgIF9kYmcuc2V0dGluZ3MgPSBfc2V0dGluZ3M7CiAgICAgICAgX2RiZy5pbnB1dCA9IF9kYmcuaW5wdXQgfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5haW0gPSBfZGJnLmlucHV0LmFpbSB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0LmFpbS52ZWN0b3IgPSBfYWltSW5wdXQ7CiAgICAgICAgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsKICAgICAgICBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsKY29uc3QgaGFuZGxlQWltU3RhcnQgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBhaW1EcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgIGFpbVN0YXJ0WCA9IGNsaWVudFg7CgogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7IH0KCiAgICAgICAgICAgIGFpbVN0YXJ0WSA9IGNsaWVudFk7CiAgICAgICAgICAgIF9haW1JbnB1dC5hY3RpdmUgPSB0cnVlOwoKICAgICAgICAgICAgaWYgKGFpbVZpc3VhbHMpIHsKICAgICAgICAgICAgICAgIGFpbVZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLmxlZnQgPSBgJHtjbGllbnRYfXB4YDsKICAgICAgICAgICAgICAgIGFpbVZpc3VhbHMuc3R5bGUudG9wID0gYCR7Y2xpZW50WX1weGA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGFpbUtub2IpIHsKICAgICAgICAgICAgICAgIGFpbUtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgtNTAlLCAtNTAlKWA7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVBaW1Nb3ZlID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGR4ID0gY2xpZW50WCAtIGFpbVN0YXJ0WDsKICAgICAgICAgICAgbGV0IGR5ID0gY2xpZW50WSAtIGFpbVN0YXJ0WTsKCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgogICAgICAgICAgICBpZiAoZGlzdCA+IGFpbU1heERpc3QpIHsKICAgICAgICAgICAgICAgIGR4ID0gKGR4IC8gZGlzdCkgKiBhaW1NYXhEaXN0OwogICAgICAgICAgICAgICAgZHkgPSAoZHkgLyBkaXN0KSAqIGFpbU1heERpc3Q7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhaW1Lbm9iKSB7CiAgICAgICAgICAgICAgICBhaW1Lbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoY2FsYygtNTAlICsgJHtkeH1weCksIGNhbGMoLTUwJSArICR7ZHl9cHgpKWA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSBhbmQgdHJhbnNmb3JtIHRvIHdvcmxkIHNwYWNlCiAgICAgICAgICAgIF9haW1JbnB1dC54ID0gZHggLyBhaW1NYXhEaXN0OwogICAgICAgICAgICBfYWltSW5wdXQueSA9IGR5IC8gYWltTWF4RGlzdDsKCiAgICAgICAgICAgIC8vIEFwcGx5IGFpbSB0byBwbGF5ZXIgaWYgY2hhcmdpbmcKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIGlmIChwLmlzQ2hhcmdpbmcgfHwgcC5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVHJhbnNmb3JtIHNjcmVlbiBhaW0gdG8gd29ybGQgc3BhY2UKICAgICAgICAgICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9jYW1Gd2QubGVuZ3RoU3EoKSA8IDAuMDAxKSBfY2FtRndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBfY2FtRndkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWCA9IChfY2FtUmlnaHQueCAqIF9haW1JbnB1dC54KSArIChfY2FtRndkLnggKiAtX2FpbUlucHV0LnkpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWiA9IChfY2FtUmlnaHQueiAqIF9haW1JbnB1dC54KSArIChfY2FtRndkLnogKiAtX2FpbUlucHV0LnkpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMod29ybGRYKSA+IDAuMSB8fCBNYXRoLmFicyh3b3JsZFopID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0T3ZlcnJpZGVBaW0od29ybGRYLCB3b3JsZFopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07Cgpjb25zdCBoYW5kbGVBaW1FbmQgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgYWltRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgX2FpbUlucHV0LmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICBfYWltSW5wdXQueCA9IDA7CiAgICAgICAgICAgIF9haW1JbnB1dC55ID0gMDsKCiAgICAgICAgICAgIGlmIChhaW1WaXN1YWxzKSB7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENsZWFyIHBsYXllciBhaW0gb3ZlcnJpZGUKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGFpbVpvbmUuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgY29uc3QgdCA9IChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXNbMF0pID8gZS5jaGFuZ2VkVG91Y2hlc1swXSA6IGUudG91Y2hlc1swXTsKICAgICAgICAgICAgYWltVG91Y2hJZCA9IHQgPyB0LmlkZW50aWZpZXIgOiBudWxsOwogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLnRvdWNoSWQgPSBhaW1Ub3VjaElkOyB9CiAgICAgICAgICAgIGhhbmRsZUFpbVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIGFpbVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgaGFuZGxlQWltTW92ZSh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIGFpbVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsKICAgICAgICAgICAgYWltVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgIGhhbmRsZUFpbUVuZCgpOwogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLnRvdWNoSWQgPSBhaW1Ub3VjaElkOyBfZGJnLmlucHV0LmFpbS5kcmFnZ2luZyA9IGFpbURyYWdnaW5nOyB9CiAgICAgICAgICAgIGhhbmRsZUFpbUVuZCgpOwogICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBhaW1Ub3VjaElkKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGFpbVRvdWNoSWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVBaW1FbmQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsgfQogICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVBaW1FbmQoKTsKICAgICAgICB9KTsKLy8gTW91c2Ugc3VwcG9ydCBmb3IgZGVza3RvcCB0ZXN0aW5nCiAgICAgICAgYWltWm9uZS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICBoYW5kbGVBaW1TdGFydChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChhaW1EcmFnZ2luZykgaGFuZGxlQWltTW92ZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoYWltRHJhZ2dpbmcpIGhhbmRsZUFpbUVuZCgpOwogICAgICAgIH0pOwogICAgfQoKICAgIC8vIE5FVzogVGFja2xlIEJ1dHRvbiBTZXR1cAogICAgZnVuY3Rpb24gc2V0dXBUYWNrbGVCdXR0b24oKSB7CiAgICAgICAgY29uc3QgdGFja2xlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RhY2tsZS1idXR0b24nKTsKICAgICAgICBpZiAoIXRhY2tsZUJ0bikgcmV0dXJuOwoKY29uc3QgaGFuZGxlVGFja2xlID0gKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyAvLyBQcmV2ZW50IGJ1YmJsaW5nIHRvIGpveXN0aWNrCgogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pc0RlbW9Nb2RlKSByZXR1cm47CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjayBpbW1lZGlhdGVseQogICAgICAgICAgICAgICAgdGFja2xlQnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0YWNrbGVCdG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyksIDE1MCk7CgogICAgICAgICAgICAgICAgLy8gSWYgd2UgZG9uJ3QgaGF2ZSB0aGUgYmFsbCwgZGFzaC90YWNrbGUKICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gR2V0IGN1cnJlbnQgbW92ZW1lbnQgZGlyZWN0aW9uIG9yIGZvcndhcmQKICAgICAgICAgICAgICAgICAgICBsZXQgZGFzaFggPSBwLmlucHV0VmVjdG9yLng7CiAgICAgICAgICAgICAgICAgICAgbGV0IGRhc2haID0gcC5pbnB1dFZlY3Rvci56OwoKICAgICAgICAgICAgICAgICAgICAvLyBJZiBub3QgbW92aW5nLCBkYXNoIGZvcndhcmQgcmVsYXRpdmUgdG8gcGxheWVyIGZhY2luZwogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhkYXNoWCkgPCAwLjEgJiYgTWF0aC5hYnMoZGFzaFopIDwgMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihwLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhc2hYID0gZndkLng7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhc2haID0gZndkLno7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBwLmRhc2goZGFzaFgsIGRhc2haKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT25seSBzaG93IHRleHQgaWYgZGFzaCBhY3R1YWxseSBoYXBwZW5lZCAoY29vbGRvd24gY2hlY2sgaW5zaWRlIGRhc2gpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLmlzRGFzaGluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiVEFDS0xFISIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocC5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBCcmVhayB0YWNrbGUgaWYgZW5nYWdlZAogICAgICAgICAgICAgICAgICAgIHAuZGFzaChwLmlucHV0VmVjdG9yLngsIHAuaW5wdXRWZWN0b3Iueik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB0YWNrbGVCdG4uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGhhbmRsZVRhY2tsZSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICB0YWNrbGVCdG4uYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgaGFuZGxlVGFja2xlKTsKICAgIH0KCiAgICAvLyBORVc6IFNldHRpbmdzIEJ1dHRvbiBTZXR1cAovLyBORVc6IFNldHRpbmdzIEJ1dHRvbiBTZXR1cApmdW5jdGlvbiBzZXR1cFNldHRpbmdzQnV0dG9uKCkgewogICAgICAgIGNvbnN0IHNldHRpbmdzQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NldHRpbmdzLWJ1dHRvbicpOwogICAgICAgIGNvbnN0IHNldHRpbmdzUGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2V0dGluZ3MtcGFuZWwnKTsKICAgICAgICBjb25zdCBzZXR0aW5nc0Nsb3NlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NldHRpbmdzLWNsb3NlJyk7CgogICAgICAgIGlmICghc2V0dGluZ3NCdG4gfHwgIXNldHRpbmdzUGFuZWwpIHJldHVybjsKCiAgICAgICAgc2V0dGluZ3NCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgIHNldHRpbmdzUGFuZWwuc3R5bGUuZGlzcGxheSA9IHNldHRpbmdzUGFuZWwuc3R5bGUuZGlzcGxheSA9PT0gJ25vbmUnID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICB9KTsKCiAgICAgICAgaWYgKHNldHRpbmdzQ2xvc2UpIHsKICAgICAgICAgICAgc2V0dGluZ3NDbG9zZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgICAgIHNldHRpbmdzUGFuZWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBTZW5zaXRpdml0eSBzbGlkZXIKICAgICAgICBjb25zdCBzZW5zaXRpdml0eVNsaWRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZW5zaXRpdml0eS1zbGlkZXInKTsKICAgICAgICBpZiAoc2Vuc2l0aXZpdHlTbGlkZXIpIHsKICAgICAgICAgICAgc2Vuc2l0aXZpdHlTbGlkZXIudmFsdWUgPSBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eSAqIDEwMDsKICAgICAgICAgICAgc2Vuc2l0aXZpdHlTbGlkZXIuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgX3NldHRpbmdzLmpveXN0aWNrU2Vuc2l0aXZpdHkgPSBlLnRhcmdldC52YWx1ZSAvIDEwMDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBBaW0gYXNzaXN0IHRvZ2dsZQogICAgICAgIGNvbnN0IGFpbUFzc2lzdFRvZ2dsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaW0tYXNzaXN0LXRvZ2dsZScpOwogICAgICAgIGlmIChhaW1Bc3Npc3RUb2dnbGUpIHsKICAgICAgICAgICAgYWltQXNzaXN0VG9nZ2xlLmNoZWNrZWQgPSBfc2V0dGluZ3MuYWltQXNzaXN0OwogICAgICAgICAgICBhaW1Bc3Npc3RUb2dnbGUuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIF9zZXR0aW5ncy5haW1Bc3Npc3QgPSBlLnRhcmdldC5jaGVja2VkOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIENhbWVyYSBzaGFrZSB0b2dnbGUKICAgICAgICBjb25zdCBzaGFrZVRvZ2dsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzaGFrZS10b2dnbGUnKTsKICAgICAgICBpZiAoc2hha2VUb2dnbGUpIHsKICAgICAgICAgICAgc2hha2VUb2dnbGUuY2hlY2tlZCA9IF9zZXR0aW5ncy5jYW1lcmFTaGFrZTsKICAgICAgICAgICAgc2hha2VUb2dnbGUuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIF9zZXR0aW5ncy5jYW1lcmFTaGFrZSA9IGUudGFyZ2V0LmNoZWNrZWQ7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gVm9sdW1lIHNsaWRlcgogICAgICAgIGNvbnN0IHZvbHVtZVNsaWRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd2b2x1bWUtc2xpZGVyJyk7CiAgICAgICAgaWYgKHZvbHVtZVNsaWRlciAmJiBfYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgIHZvbHVtZVNsaWRlci5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB2b2wgPSBlLnRhcmdldC52YWx1ZSAvIDEwMDsKX2F1ZGlvTWFuYWdlci5zZXRNYXN0ZXJWb2x1bWUodm9sKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBFeGl0IHRvIE1lbnUKICAgICAgICBjb25zdCBleGl0QnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2V4aXQtdG8tbWVudS1idG4nKTsKICAgICAgICBpZiAoZXhpdEJ0bikgewogICAgICAgICAgICBleGl0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKF9tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIF9tZW51TWFuYWdlci5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIuc3RhdGUgPSAnbWVudSc7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgcHJhY3RpY2UgaWYgcnVubmluZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlSW5wdXRWZWN0b3IoKSB7CiAgICAgICAgbGV0IHggPSBfaW5wdXQueCB8fCAwOwogICAgICAgIGxldCB6ID0gX2lucHV0LnkgfHwgMDsKCiAgICAgICAgaWYgKF9rZXlzWyd3J10gfHwgX2tleXNbJ0Fycm93VXAnXSkgeiAtPSAxOwogICAgICAgIGlmIChfa2V5c1sncyddIHx8IF9rZXlzWydBcnJvd0Rvd24nXSkgeiArPSAxOwogICAgICAgIGlmIChfa2V5c1snYSddIHx8IF9rZXlzWydBcnJvd0xlZnQnXSkgeCAtPSAxOwogICAgICAgIGlmIChfa2V5c1snZCddIHx8IF9rZXlzWydBcnJvd1JpZ2h0J10pIHggKz0gMTsKCiAgICAgICAgY29uc3QgbGVuU3EgPSB4KnggKyB6Kno7CiAgICAgICAgaWYgKGxlblNxID4gMSkgewogICAgICAgICAgICBjb25zdCBsZW4gPSBNYXRoLnNxcnQobGVuU3EpOwogICAgICAgICAgICB4IC89IGxlbjsKICAgICAgICAgICAgeiAvPSBsZW47CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNOYU4oeCkpIHggPSAwOwogICAgICAgIGlmIChpc05hTih6KSkgeiA9IDA7CgogICAgICAgIGlmIChfY2FtZXJhKSB7CiAgICAgICAgICAgIF9jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CgogICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICBfY2FtUmlnaHQuc2V0KDEsIDAsIDApOwogICAgICAgIH0KCiAgICAgICAgbGV0IHdvcmxkWCA9IChfY2FtRndkLnggKiAteikgKyAoX2NhbVJpZ2h0LnggKiB4KTsKICAgICAgICBsZXQgd29ybGRaID0gKF9jYW1Gd2QueiAqIC16KSArIChfY2FtUmlnaHQueiAqIHgpOwoKICAgICAgICBpZiAoaXNOYU4od29ybGRYKSB8fCBpc05hTih3b3JsZFopKSB7CiAgICAgICAgICAgIHdvcmxkWCA9IDA7CiAgICAgICAgICAgIHdvcmxkWiA9IDA7CiAgICAgICAgfQoKaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgIC8vIEZJWDogT25seSBhbGxvdyBtb3ZlbWVudCBpZiBnYW1lIGlzIGFjdGl2ZSBvciBpbiBwcmFjdGljZQogICAgICAgICAgICBjb25zdCBnbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgY2FuTW92ZSA9IGdtICYmICFnbS5pc0RlbW9Nb2RlICYmIChnbS5zdGF0ZSA9PT0gJ2FjdGl2ZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGNhbk1vdmUpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQod29ybGRYLCB3b3JsZFopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZVJpcHBsZSh4LCB5KSB7CiAgICAgICAgY29uc3QgcmlwcGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgcmlwcGxlLmNsYXNzTmFtZSA9ICd0b3VjaC1yaXBwbGUnOwogICAgICAgIHJpcHBsZS5zdHlsZS5sZWZ0ID0gYCR7eH1weGA7CiAgICAgICAgcmlwcGxlLnN0eWxlLnRvcCA9IGAke3l9cHhgOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpLmFwcGVuZENoaWxkKHJpcHBsZSk7CgogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAocmlwcGxlLnBhcmVudE5vZGUpIHJpcHBsZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHJpcHBsZSk7CiAgICAgICAgfSwgNjAwKTsKCiAgICB9CgogICAgLy8gTkVXOiBWaXN1YWwgU3dpcGUgVHJhaWwKICAgIGZ1bmN0aW9uIGNyZWF0ZVN3aXBlVHJhaWxEb3QoeCwgeSkgewogICAgICAgIGNvbnN0IGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIGRvdC5jbGFzc05hbWUgPSAnc3dpcGUtdHJhaWwtZG90JzsKICAgICAgICBkb3Quc3R5bGUubGVmdCA9IGAke3ggLSA2fXB4YDsgLy8gQ2VudGVyICgxMnB4IHdpZHRoKQogICAgICAgIGRvdC5zdHlsZS50b3AgPSBgJHt5IC0gNn1weGA7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJykuYXBwZW5kQ2hpbGQoZG90KTsKICAgICAgICAKICAgICAgICAvLyBDU1MgYW5pbWF0aW9uIGhhbmRsZXMgcmVtb3ZhbCwgYnV0IHdlIGNsZWFuIHVwIERPTSB0byBiZSBzYWZlCiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGlmIChkb3QucGFyZW50Tm9kZSkgZG90LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZG90KTsKICAgICAgICB9LCA1MDApOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uUmVzaXplKCkgewogICAgICAgIGNvbnN0IHdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgIAogICAgICAgIGlmIChfY2FtZXJhKSB7CiAgICAgICAgICAgIF9jYW1lcmEuYXNwZWN0ID0gd2lkdGggLyBoZWlnaHQ7CiAgICAgICAgICAgIF9jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBTdHJpY3RseSAwLjUwIGFzIHJlcXVlc3RlZAogICAgICAgIGNvbnN0IHJlc1NjYWxlID0gMC41MDsKICAgICAgICAKICAgICAgICBfY29uZmlnLmludGVybmFsV2lkdGggPSBNYXRoLmZsb29yKHdpZHRoICogcmVzU2NhbGUpOwogICAgICAgIF9jb25maWcuaW50ZXJuYWxIZWlnaHQgPSBNYXRoLmZsb29yKGhlaWdodCAqIHJlc1NjYWxlKTsKCiAgICAgICAgaWYgKF9yZW5kZXJlcikgewogICAgICAgICAgICBfcmVuZGVyZXIuc2V0U2l6ZShfY29uZmlnLmludGVybmFsV2lkdGgsIF9jb25maWcuaW50ZXJuYWxIZWlnaHQsIGZhbHNlKTsKICAgICAgICB9CiAgICB9CgovLyAtLS0gRklYRUQgVElNRVNURVAgVkFSSUFCTEVTIC0tLQogICAgbGV0IF9hY2N1bXVsYXRvciA9IDA7CiAgICBjb25zdCBfZml4ZWRTdGVwID0gMSAvIDYwOwoKICAgIGZ1bmN0aW9uIGFuaW1hdGUoKSB7CiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwoKICAgICAgICBjb25zdCByYXdEdCA9IF9jbG9jay5nZXREZWx0YSgpOwogICAgICAgIC8vIENsYW1wIGR0IHRvIHByZXZlbnQgc3BpcmFscyAobWF4IDAuMXMpCiAgICAgICAgY29uc3QgZHQgPSBNYXRoLm1pbihyYXdEdCwgMC4xKSAqICh3aW5kb3cuZmx1eC50aW1lU2NhbGUgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA6IDAuOCk7CgogICAgICAgIC8vIFBlcmYgc3RhdHMgZm9yIERldlRvb2xzCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPLnBlcmYpIHsKICAgICAgICAgICAgY29uc3QgcGVyZiA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPLnBlcmY7CiAgICAgICAgICAgIHBlcmYuZnJhbWUgPSAocGVyZi5mcmFtZSB8fCAwKSArIDE7CiAgICAgICAgICAgIHBlcmYucmF3RHQgPSByYXdEdDsKICAgICAgICAgICAgcGVyZi5kdCA9IGR0OwogICAgICAgICAgICBjb25zdCBmcHMgPSBkdCA+IDAgPyAoMSAvIGR0KSA6IDA7CiAgICAgICAgICAgIHBlcmYuZnBzID0gZnBzOwogICAgICAgICAgICBwZXJmLmF2Z0ZwcyA9IChwZXJmLmF2Z0ZwcyAmJiBwZXJmLmF2Z0ZwcyA+IDApID8gKHBlcmYuYXZnRnBzICogMC45ICsgZnBzICogMC4xKSA6IGZwczsKICAgICAgICB9CgogICAgICAgIC8vIEltcGFjdCBGcmFtZXMgKEZyZWV6ZSBGcmFtZSBFZmZlY3QpCiAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaW1wYWN0UGF1c2UgPiAwKSB7CiAgICAgICAgICAgIF9nYW1lTWFuYWdlci5pbXBhY3RQYXVzZSAtPSBkdDsKICAgICAgICAgICAgaWYgKF9yZW5kZXJlciAmJiBfc2NlbmUgJiYgX2NhbWVyYSkgewogICAgICAgICAgICAgICAgX3JlbmRlcmVyLnJlbmRlcihfc2NlbmUsIF9jYW1lcmEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CgogICAgICAgIC8vIEFjdGlvbiBCdWZmZXIgUHJvY2Vzc2luZwogICAgICAgIGlmIChfYWN0aW9uQnVmZmVyLmFjdGl2ZSkgewogICAgICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIF9hY3Rpb25CdWZmZXIudGltZXN0YW1wID4gX2FjdGlvbkJ1ZmZlci5kdXJhdGlvbikgewogICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgJiYgIXAuaXNDaGFyZ2luZyAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ0bikgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIEZJWEVEIFVQREFURSBMT09QIChQaHlzaWNzICYgR2FtZSBMb2dpYykgLS0tCiAgICAgICAgX2FjY3VtdWxhdG9yICs9IGR0OwogICAgICAgIC8vIFNhZmV0eSBDYXA6IFByZXZlbnQgc3BpcmFsIG9mIGRlYXRoIGlmIGZyYW1lIHRha2VzIHRvbyBsb25nCiAgICAgICAgaWYgKF9hY2N1bXVsYXRvciA+IDAuMikgX2FjY3VtdWxhdG9yID0gMC4yOwoKICAgICAgICB3aGlsZSAoX2FjY3VtdWxhdG9yID49IF9maXhlZFN0ZXApIHsKICAgICAgICAgICAgY29uc3QgX3NkdCA9IF9maXhlZFN0ZXA7CgogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSBfZ2FtZU1hbmFnZXIudXBkYXRlKF9zZHQpOwoKICAgICAgICAgICAgLy8gSWYgaW4gQXNzZXQgRm9yZ2UgbW9kZSwgc2tpcCBnYW1lIGxvZ2ljCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmlzRm9yZ2VNb2RlKSB7CiAgICAgICAgICAgICAgICBfYWNjdW11bGF0b3IgPSAwOyAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ21TdGF0ZSA9IF9nYW1lTWFuYWdlciA/IF9nYW1lTWFuYWdlci5zdGF0ZSA6ICcnOwogICAgICAgICAgICBjb25zdCBpc0ludHJvID0gZ21TdGF0ZSA9PT0gJ2ludHJvJzsKICAgICAgICAgICAgY29uc3QgaXNNZW51ID0gZ21TdGF0ZSA9PT0gJ21lbnUnOwoKICAgICAgICAgICAgLy8gVXBkYXRlIEVudGl0aWVzIChQaHlzaWNzL0FJKQogICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmICFpc0ludHJvICYmICFpc01lbnUpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS51cGRhdGUoX3NkdCk7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gY2hlY2tCYWxsR3JhYihwKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChfYXdheVRlYW0gJiYgIWlzSW50cm8gJiYgIWlzTWVudSkgewogICAgICAgICAgICAgICAgX2F3YXlUZWFtLnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiBjaGVja0JhbGxHcmFiKHApKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKF9iYWxsICYmICFpc0ludHJvICYmICFpc01lbnUpIHsKICAgICAgICAgICAgICAgIF9iYWxsLnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmFsbCBMYWIKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWIgJiYgdHlwZW9mIHdpbmRvdy5mbHV4LmJhbGxMYWIudXBkYXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5iYWxsTGFiLnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUnVudGltZSBVcGRhdGVycyAoZS5nLiBSaW5ncyBsb2dpYykKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgJiYgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IHVpID0gMDsgdWkgPCB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLmxlbmd0aDsgdWkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZuID0gd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVyc1t1aV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJykgZm4oX3NkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9hY2N1bXVsYXRvciAtPSBfZml4ZWRTdGVwOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIFZJU1VBTCBVUERBVEUgTE9PUCAoT25jZSBQZXIgRnJhbWUpIC0tLQogICAgICAgIC8vIFRoZXNlIHN5c3RlbXMgZG9uJ3QgYWZmZWN0IGdhbWVwbGF5IG91dGNvbWUsIHNvIHdlIHVwZGF0ZSB0aGVtIHdpdGggdGhlIHZpc3VhbCBkZWx0YSBgZHRgCiAgICAgICAgLy8gdG8gZW5zdXJlIHNtb290aCBhbmltYXRpb24gYXQgaGlnaCByZWZyZXNoIHJhdGVzICg5MC8xMjBIeikgd2l0aG91dCB3YXN0aW5nIENQVSBvbiBwaHlzaWNzLgoKICAgICAgICBjb25zdCBnbVN0YXRlID0gX2dhbWVNYW5hZ2VyID8gX2dhbWVNYW5hZ2VyLnN0YXRlIDogJyc7CiAgICAgICAgY29uc3QgaXNJbnRybyA9IGdtU3RhdGUgPT09ICdpbnRybyc7CiAgICAgICAgY29uc3QgaXNNZW51ID0gZ21TdGF0ZSA9PT0gJ21lbnUnOwoKICAgICAgICAvLyBDYW1lcmEKICAgICAgICBpZiAoIWlzSW50cm8gJiYgIWlzTWVudSkgewogICAgICAgICAgICB1cGRhdGVDYW1lcmFMb2dpYyhkdCk7CiAgICAgICAgfQoKICAgICAgICAvLyBWaXN1YWwgRlggU3lzdGVtcwogICAgICAgIGlmIChfd2F0ZXJPdmVybGF5KSBfd2F0ZXJPdmVybGF5LnVwZGF0ZShkdCk7CiAgICAgICAgaWYgKF9saWdodFNoYWZ0cykgX2xpZ2h0U2hhZnRzLnVwZGF0ZShkdCk7CiAgICAgICAgaWYgKF9zdGFkaXVtKSBfc3RhZGl1bS51cGRhdGUoZHQpOwogICAgICAgIGlmIChfZ2x5cGhNYW5hZ2VyKSBfZ2x5cGhNYW5hZ2VyLnVwZGF0ZShkdCk7CgppZiAoX2dseXBoTWFuYWdlcikgX2dseXBoTWFuYWdlci51cGRhdGUoZHQpOwogICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIF9nYW1lTWFuYWdlci51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICBpZiAoX2FyZW5hVW5pZm9ybXMpIHsKICAgICAgICAgICAgX2FyZW5hVW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RTdHIudmFsdWUgKj0gTWF0aC5tYXgoMCwgMS4wIC0gZHQgKiA0LjApOwogICAgICAgIH0KCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hR3JvdXApIHsKICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5yb3RhdGlvbi55ICs9IGR0ICogMC4wNTsKICAgICAgICB9CgogICAgICAgIGlmICh3aW5kb3cuZmx1eC50cmliYWxVbmlmb3JtcykgewogICAgICAgICAgICB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgbGV0IHRhcmdldENvbG9yID0gbmV3IFRIUkVFLkNvbG9yKDB4MDBmZmZmKTsKICAgICAgICAgICAgaWYgKF9iYWxsICYmIF9iYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKF9iYWxsLmhvbGRlci50ZWFtICYmIF9iYWxsLmhvbGRlci50ZWFtLnNpZGUgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Q29sb3Iuc2V0SGV4KDB4ZmY4ODAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3Jtcy51Q29sb3IudmFsdWUubGVycCh0YXJnZXRDb2xvciwgZHQgKiAyLjApOwogICAgICAgIH0KCiAgICAgICAgaWYgKF9wYXJ0aWNsZVVuaWZvcm1zKSB7CiAgICAgICAgICAgIF9wYXJ0aWNsZVVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgIH0KCiAgICAgICAgLy8gUmVuZGVyCiAgICAgICAgaWYgKF9yZW5kZXJlciAmJiBfc2NlbmUgJiYgX2NhbWVyYSkgewogICAgICAgICAgICBfcmVuZGVyZXIucmVuZGVyKF9zY2VuZSwgX2NhbWVyYSk7CiAgICAgICAgfQoKICAgICAgICAvLyBVSSBVcGRhdGVzCiAgICAgICAgdXBkYXRlVUkoKTsKICAgIH0KCmZ1bmN0aW9uIHVwZGF0ZVVJKCkgewogICAgICAgIC8vIFByZXZlbnQgVUkgdXBkYXRlcyBkdXJpbmcgaW50cm8gdG8ga2VlcCB0aGluZ3MgaGlkZGVuCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPT09ICdpbnRybycpIHJldHVybjsKCiAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybjsKICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWJ1dHRvbicpOwogICAgICAgIGNvbnN0IGxibCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY3Rpb24tbGFiZWwnKTsKICAgICAgICBjb25zdCB0YWNrbGVCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGFja2xlLWJ1dHRvbicpOwogICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICBpZiAoYnRuICYmIGxibCkgewogICAgICAgICAgICBjb25zdCBidG5UZXh0ID0gYnRuLnF1ZXJ5U2VsZWN0b3IoJy5idG4tdGV4dCcpOwoKICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgaWYgKGJ0blRleHQgJiYgYnRuVGV4dC5pbm5lclRleHQgIT09ICJBQ1RJT04iKSB7CiAgICAgICAgICAgICAgICAgICAgYnRuVGV4dC5pbm5lclRleHQgPSAiQUNUSU9OIjsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnc2hvb3QtbW9kZScpOwogICAgICAgICAgICAgICAgICAgIGxibC5pbm5lclRleHQgPSAiT0ZGRU5TRSI7CiAgICAgICAgICAgICAgICAgICAgbGJsLmNsYXNzTGlzdC5hZGQoJ3Nob290LWxhYmVsJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgaXNIaWdoRW5lcmd5ID0gKHAuc3RhdHMuSFAgLyBwLnN0YXRzLm1heEhQKSA+IDAuNDsKICAgICAgICAgICAgICAgIGlmIChpc0hpZ2hFbmVyZ3kpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWJ0bi5jbGFzc0xpc3QuY29udGFpbnMoJ2xpbWl0LXJlYWR5JykpIGJ0bi5jbGFzc0xpc3QuYWRkKCdsaW1pdC1yZWFkeScpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYnRuLmNsYXNzTGlzdC5jb250YWlucygnbGltaXQtcmVhZHknKSkgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2xpbWl0LXJlYWR5Jyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGJ0blRleHQgJiYgYnRuVGV4dC5pbm5lclRleHQgIT09ICJTV0lNIikgewogICAgICAgICAgICAgICAgICAgIGJ0blRleHQuaW5uZXJUZXh0ID0gIlNXSU0iOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdzaG9vdC1tb2RlJyk7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2xpbWl0LXJlYWR5Jyk7CiAgICAgICAgICAgICAgICAgICAgbGJsLmlubmVyVGV4dCA9ICJOT1JNQUwiOwogICAgICAgICAgICAgICAgICAgIGxibC5jbGFzc0xpc3QucmVtb3ZlKCdzaG9vdC1sYWJlbCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBVcGRhdGUgdGFja2xlIGJ1dHRvbiB2aXNpYmlsaXR5CiAgICAgICAgaWYgKHRhY2tsZUJ0bikgewogICAgICAgICAgICBpZiAoIXAuaGFzQmFsbCB8fCBwLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgdGFja2xlQnRuLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgdGFja2xlIGJ1dHRvbiB0ZXh0IGJhc2VkIG9uIGNvbnRleHQKICAgICAgICAgICAgICAgIGNvbnN0IHRhY2tsZVRleHQgPSB0YWNrbGVCdG4ucXVlcnlTZWxlY3RvcignLmJ0bi10ZXh0Jyk7CiAgICAgICAgICAgICAgICBpZiAodGFja2xlVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGlmIChwLmlzRW5nYWdlZCAmJiBwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFja2xlVGV4dC5pbm5lclRleHQgPSAnQlJFQUsnOwogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVCdG4uY2xhc3NMaXN0LmFkZCgndXJnZW50Jyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFja2xlVGV4dC5pbm5lclRleHQgPSAnVEFDS0xFJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGFja2xlQnRuLmNsYXNzTGlzdC5yZW1vdmUoJ3VyZ2VudCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBVcGRhdGUgZGlzdGFuY2UgdG8gZ29hbCBpbmRpY2F0b3IKICAgICAgICBjb25zdCBkaXN0SW5kaWNhdG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvYWwtZGlzdGFuY2UnKTsKICAgICAgICBpZiAoZGlzdEluZGljYXRvciAmJiBwLm1lc2gpIHsKICAgICAgICAgICAgY29uc3QgZ29hbFogPSAocC50ZWFtICYmIHAudGVhbS5zaWRlID09PSAxKSA/IC0yOCA6IDI4OwogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5hYnMocC5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgIGRpc3RJbmRpY2F0b3IuaW5uZXJUZXh0ID0gYCR7TWF0aC5mbG9vcihkaXN0KX1tYDsKICAgICAgICB9CiAgICB9CgpmdW5jdGlvbiB1cGRhdGVDYW1lcmFMb2dpYyhkdCkgewogICAgICAgIGlmICghX2NhbWVyYU1hbmFnZXIgfHwgIV9iYWxsKSByZXR1cm47CgogICAgICAgIGxldCB0YXJnZXRNZXNoID0gX2JhbGwubWVzaDsKICAgICAgICBsZXQgdGFyZ2V0VmVsID0gX2JhbGwudmVsb2NpdHk7CiAgICAgICAgbGV0IHRhcmdldElucHV0ID0gbnVsbDsKICAgICAgICBsZXQgaXNBaW1pbmcgPSBmYWxzZTsKCiAgICAgICAgaWYgKF9iYWxsLmhvbGRlciAmJiBfYmFsbC5ob2xkZXIubWVzaCkgewogICAgICAgICAgICB0YXJnZXRNZXNoID0gX2JhbGwuaG9sZGVyLm1lc2g7CiAgICAgICAgICAgIHRhcmdldFZlbCA9IF9iYWxsLmhvbGRlci52ZWxvY2l0eTsKICAgICAgICAgICAgaWYgKF9iYWxsLmhvbGRlci5pbnB1dFZlY3RvcikgewogICAgICAgICAgICAgICAgdGFyZ2V0SW5wdXQgPSBfYmFsbC5ob2xkZXIuaW5wdXRWZWN0b3I7CiAgICAgICAgICAgIH0KLy8gQ2hlY2sgYWltaW5nIHN0YXRlIChDaGFyZ2luZyBvciBUaHJvd2luZykKICAgICAgICAgICAgaWYgKF9iYWxsLmhvbGRlci5pc0NoYXJnaW5nIHx8IF9iYWxsLmhvbGRlci5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICBpc0FpbWluZyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnNldFRhcmdldCh0YXJnZXRNZXNoLCB0YXJnZXRWZWwsIHRhcmdldElucHV0LCBpc0FpbWluZyk7CiAgICAgICAgX2NhbWVyYU1hbmFnZXIudXBkYXRlKGR0KTsKICAgIH0KCmZ1bmN0aW9uIGNoZWNrQmFsbEdyYWIoZW50aXR5KSB7CiAgICAgICAgaWYgKCFlbnRpdHkuY2FuQ2F0Y2gpIHJldHVybjsKICAgICAgICBpZiAoX2JhbGwgJiYgIV9iYWxsLmlzQ2F0Y2hhYmxlKCkpIHJldHVybjsKICAgICAgICBpZiAoZW50aXR5LnN0dW5UaW1lciA+IDAgfHwgKGVudGl0eS5zdGF0dXMgJiYgZW50aXR5LnN0YXR1cy5uYXAgPiAwKSkgcmV0dXJuOwogICAgICAgIGlmIChfYmFsbC5zdGF0ZSAhPT0gJ2ZyZWUnKSByZXR1cm47CiAgICAgICAgaWYgKCFfYmFsbC5tZXNoIHx8ICFlbnRpdHkubWVzaCkgcmV0dXJuOwoKICAgICAgICBjb25zdCBiYWxsUG9zID0gX2JhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICBjb25zdCBlbnRQb3MgPSBlbnRpdHkubWVzaC5wb3NpdGlvbjsKCiAgICAgICAgY29uc3QgZHggPSBiYWxsUG9zLnggLSBlbnRQb3MueDsKICAgICAgICBjb25zdCBkeiA9IGJhbGxQb3MueiAtIGVudFBvcy56OwogICAgICAgIGNvbnN0IGRpc3RYWiA9IE1hdGguc3FydChkeCpkeCArIGR6KmR6KTsKICAgICAgICBjb25zdCBkaXN0WSA9IE1hdGguYWJzKGJhbGxQb3MueSAtIGVudFBvcy55KTsKCiAgICAgICAgLy8gLS0tIFJFTEFYRUQgVE9MRVJBTkNFUyBGT1IgRUFTSUVSIFBJQ0tVUCAtLS0KICAgICAgICBjb25zdCB0b3VjaFJhZGl1cyA9IDEuNTsgLy8gSW5jcmVhc2VkIGZyb20gMS4wIChBdXRvLWdyYWIgcmFkaXVzKQogICAgICAgIGxldCBtYWduZXRSYWRpdXMgPSAzLjU7ICAvLyBJbmNyZWFzZWQgZnJvbSAxLjggKE1hZ25ldGljIHJhZGl1cykKICAgICAgICBsZXQgaW50ZXJhY3Rpb25SYWRpdXMgPSA2LjA7IC8vIEluY3JlYXNlZCBmcm9tIDMuNSAoVHVybi10byByYWRpdXMpCiAgICAgICAgbGV0IGNhdGNoSGVpZ2h0ID0gNi4wOyAgIC8vIEluY3JlYXNlZCBmcm9tIDMuMCAoVmVydGljYWwgcmVhY2gpCgogICAgICAgIGlmIChlbnRpdHkuaXNEYXNoaW5nKSB7CiAgICAgICAgICAgIG1hZ25ldFJhZGl1cyA9IDQuNTsKICAgICAgICAgICAgaW50ZXJhY3Rpb25SYWRpdXMgPSA3LjA7CiAgICAgICAgICAgIGNhdGNoSGVpZ2h0ID0gNy4wOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRpc3RYWiA+IGludGVyYWN0aW9uUmFkaXVzIHx8IGRpc3RZID4gY2F0Y2hIZWlnaHQpIHJldHVybjsKCiAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBVc2Ugc2hhcmVkIHZlY3RvcnMgdG8gYXZvaWQgR0MKICAgICAgICBfdGVtcFZlYzEuY29weShiYWxsUG9zKS5zdWIoZW50UG9zKS5ub3JtYWxpemUoKTsgLy8gdG9CYWxsCiAgICAgICAgX3RlbXBWZWMyLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24oZW50aXR5Lm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7IC8vIHBsYXllckZvcndhcmQKCiAgICAgICAgY29uc3QgZmFjaW5nRG90ID0gX3RlbXBWZWMyLmRvdChfdGVtcFZlYzEpOwoKICAgICAgICBjb25zdCBjb25lVGhyZXNob2xkID0gLTAuNDsgLy8gTW9yZSBnZW5lcm91cyBjb25lICh3YXMgLTAuMikKICAgICAgICBjb25zdCBpc0luQ29uZSA9IGZhY2luZ0RvdCA+IGNvbmVUaHJlc2hvbGQ7CiAgICAgICAgCiAgICAgICAgLy8gQVVUTy1UVVJOOiBJZiBuZWFyIGJ1dCBmYWNpbmcgd3Jvbmcgd2F5LCB0dXJuIHRvd2FyZHMgYmFsbAogICAgICAgIGlmIChkaXN0WFogPCBpbnRlcmFjdGlvblJhZGl1cyAmJiAhaXNJbkNvbmUpIHsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0QW5nbGUgPSBNYXRoLmF0YW4yKF90ZW1wVmVjMS54LCBfdGVtcFZlYzEueik7CiAgICAgICAgICAgIGNvbnN0IHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUobmV3IFRIUkVFLlZlY3RvcjMoMCwxLDApLCB0YXJnZXRBbmdsZSk7CiAgICAgICAgICAgIGVudGl0eS5tZXNoLnF1YXRlcm5pb24uc2xlcnAocSwgMC4yKTsgLy8gRmFzdGVyIHR1cm4gKHdhcyAwLjEpCiAgICAgICAgICAgIGlmIChlbnRpdHkuc3luY1JvdGF0aW9uKSBlbnRpdHkuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBHUkFCIExPR0lDCiAgICAgICAgLy8gMS4gVG91Y2g6IFZlcnkgY2xvc2UgKGlnbm9yZSBmYWNpbmcgLSBwcmV2ZW50cyBydW5uaW5nIG92ZXIgYmFsbCkKICAgICAgICAvLyAyLiBNYWduZXQ6IENsb3NlIGFuZCBmYWNpbmcKICAgICAgICBjb25zdCBpc1RvdWNoID0gZGlzdFhaIDwgdG91Y2hSYWRpdXM7CiAgICAgICAgY29uc3QgaXNNYWduZXQgPSBkaXN0WFogPCBtYWduZXRSYWRpdXMgJiYgaXNJbkNvbmU7CgogICAgICAgIGlmIChpc1RvdWNoIHx8IGlzTWFnbmV0KSB7CiAgICAgICAgICAgIC8vIEJMQVNUIFRIUk9VR0ggTE9HSUMKICAgICAgICAgICAgY29uc3QgYmFsbFNwZWVkID0gX2JhbGwudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgIGxldCBjYXRjaENoYW5jZSA9IDEuMDsKCiAgICAgICAgICAgIC8vIElmIGJhbGwgaXMgbW92aW5nIGZhc3QgKGUuZy4gPiAyMCksIGNoZWNrIENBCiAgICAgICAgICAgIGlmIChiYWxsU3BlZWQgPiAyMC4wKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjYSA9IGVudGl0eS5nZXRTdGF0KCdDQScpOwogICAgICAgICAgICAgICAgLy8gRGlmZmljdWx0eSBzY2FsZXMgd2l0aCBzcGVlZC4gCiAgICAgICAgICAgICAgICBjb25zdCBkaWZmaWN1bHR5ID0gYmFsbFNwZWVkICogMS4yOyAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGRpZmZpY3VsdHkgPiBjYSkgewogICAgICAgICAgICAgICAgICAgIGNhdGNoQ2hhbmNlID0gMC40ICsgKGNhIC8gZGlmZmljdWx0eSkgKiAwLjY7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUG9pbnQgQmxhbmsgUGVuYWx0eTogSGFyZGVyIHRvIHJlYWN0IGlmIGJhbGwgaXMgcmlnaHQgb24gdG9wIG9mIHlvdSBtb3ZpbmcgZmFzdAogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0WFogPCAxLjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2F0Y2hDaGFuY2UgKj0gMC42OyAvLyBCbGFzdCB0aHJvdWdoIGxpa2VseQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoZW50aXR5LmlzRGFzaGluZykgY2F0Y2hDaGFuY2UgKz0gMC4yOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKF9iYWxsLnBvd2VyVHlwZSA9PT0gJ1NIJyAmJiBfYmFsbC5wb3dlciA+IDE1LjApIHsKICAgICAgICAgICAgICAgIC8vIFNob3QgcG93ZXIgY2hlY2sKICAgICAgICAgICAgICAgIGNvbnN0IGNhID0gZW50aXR5LmdldFN0YXQoJ0NBJyk7CiAgICAgICAgICAgICAgICBpZiAoX2JhbGwucG93ZXIgPiBjYSAqIDEuMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5jZSA9IE1hdGgubWluKDAuNywgKF9iYWxsLnBvd2VyIC0gY2EpICogMC4wNCk7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hDaGFuY2UgPSAxLjAgLSBjaGFuY2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBmdW1ibGUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPiBjYXRjaENoYW5jZSkgewogICAgICAgICAgICAgICAgZnVtYmxlID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGZ1bWJsZSkgewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWaXN1YWwgZmVlZGJhY2sgZm9yIGJsYXN0IHRocm91Z2gKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTEFTVCBUSFJPVUdIISIsIGVudFBvcywgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEZWZsZWN0IHNsaWdodGx5IGJ1dCBrZWVwIG1vdmluZyBmYXN0IChCbGFzdCBUaHJvdWdoKQogICAgICAgICAgICAgICAgLy8gRG9uJ3Qgc3RvcCBpdCBjb21wbGV0ZWx5IGxpa2UgYSBibG9jaywganVzdCBwZXJ0dXJiIGl0CiAgICAgICAgICAgICAgICBfYmFsbC52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjg1KTsgCiAgICAgICAgICAgICAgICBfYmFsbC52ZWxvY2l0eS54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiA1LjA7CiAgICAgICAgICAgICAgICBfYmFsbC52ZWxvY2l0eS55ICs9IChNYXRoLnJhbmRvbSgpKSAqIDUuMDsgLy8gUG9wIHVwCiAgICAgICAgICAgICAgICBfYmFsbC52ZWxvY2l0eS56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiA1LjA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9iYWxsLnBvd2VyICo9IDAuNzsKCiAgICAgICAgICAgICAgICBlbnRpdHkuY2FuQ2F0Y2ggPSBmYWxzZTsKICAgICAgICAgICAgICAgIC8vIFN0dW4gYnJpZWZseQogICAgICAgICAgICAgICAgZW50aXR5LnN0dW5UaW1lciA9IDAuNTsKICAgICAgICAgICAgICAgIGlmKGVudGl0eS5wbGF5KSBlbnRpdHkucGxheSgncmVhY3QnLCAwLjEpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgZW50aXR5LmNhbkNhdGNoID0gdHJ1ZTsgfSwgMTAwMCk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2JhbGwubWFnbmV0aXplKGVudGl0eSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8gU3RhcnQKICAgIGluaXQoKTsKfSkoKTs=","/main.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgLy8gTmFtZXNwYWNlCiAgICB3aW5kb3cuZmx1eCA9IHdpbmRvdy5mbHV4IHx8IHt9OwogICAgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycyA9IHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgfHwgW107CgogICAgLy8gQ29uZmlnCmNvbnN0IF9jb25maWcgPSB7CiAgICAgICAgaW50ZXJuYWxXaWR0aDogMzYwLAogICAgICAgIGludGVybmFsSGVpZ2h0OiA2NDAsCiAgICAgICAgYmdDb2xvcjogMHgwMDFlMzYsCiAgICAgICAgZm9nQ29sb3I6IDB4MDAxZTM2LAogICAgICAgIGZvZ0RlbnNpdHk6IDAuMDAwMSwgLy8gRHJhc3RpY2FsbHkgcmVkdWNlZCB0byBlbnN1cmUgdmlzaWJpbGl0eQogICAgICAgIGFyZW5hUmFkaXVzOiA0OC4wCiAgICB9OwoKICAgIC8vIEdsb2JhbHMKLy8gR2xvYmFscwogICAgY29uc3QgX2lucHV0ID0geyB4OiAwLCB5OiAwIH07IC8vIElucHV0IHN0YXRlCiAgICAKICAgIC8vIFNoYWRlciBVbmlmb3JtcwogICAgY29uc3QgX2FyZW5hVW5pZm9ybXMgPSB7CiAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICB1SW1wYWN0UG9zOiB7IHZhbHVlOiBuZXcgVEhSRUUuVmVjdG9yMygpIH0sCiAgICAgICAgdUltcGFjdFN0cjogeyB2YWx1ZTogMC4wIH0KICAgIH07CiAgICBjb25zdCBfcGFydGljbGVVbmlmb3JtcyA9IHsKICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9CiAgICB9OwoKICAgIC8vIEV4cG9zZSBJbXBhY3QgVHJpZ2dlcgogICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0ID0gZnVuY3Rpb24ocG9zLCBzdHJlbmd0aCkgewogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RQb3MudmFsdWUuY29weShwb3MpOwogICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RTdHIudmFsdWUgPSBzdHJlbmd0aCAqIDIuMDsgLy8gU2NhbGUgdXAgZm9yIHZpc2liaWxpdHkKICAgIH07Ci8vIF9pbnB1dCBhbHJlYWR5IGRlY2xhcmVkIGFib3ZlCiAgICBjb25zdCBfdGVtcFZlYzEgPSBuZXcgVEhSRUUuVmVjdG9yMygpOyAvLyBSZXVzYWJsZSBmb3IgcGh5c2ljcy9sb2dpYwogICAgY29uc3QgX3RlbXBWZWMyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsgLy8gUmV1c2FibGUgZm9yIHBoeXNpY3MvbG9naWMKICAgIGxldCBfc2NlbmUsIF9jYW1lcmEsIF9yZW5kZXJlciwgX2Nsb2NrOwogICAgbGV0IF9ob21lVGVhbSwgX2F3YXlUZWFtOwogICAgbGV0IF9iYWxsOwogICAgbGV0IF9nYW1lTWFuYWdlcjsKICAgIGxldCBfbWVudU1hbmFnZXI7CiAgICBsZXQgX2F1ZGlvTWFuYWdlcjsKCiAgICBsZXQgX2NhbWVyYU1hbmFnZXI7CiAgICBsZXQgX3dhdGVyT3ZlcmxheTsKICAgIGxldCBfbGlnaHRTaGFmdHM7CiAgICBsZXQgX3N0YWRpdW07CiAgICBsZXQgX2dseXBoTWFuYWdlcjsKCiAgICAvLyBJTVBST1ZFRDogU2V0dGluZ3Mgb2JqZWN0CiAgICBjb25zdCBfc2V0dGluZ3MgPSB7CiAgICAgICAgam95c3RpY2tTZW5zaXRpdml0eTogMS4wLAogICAgICAgIGFpbUFzc2lzdDogdHJ1ZSwKICAgICAgICBjYW1lcmFTaGFrZTogdHJ1ZSwKICAgICAgICBoaXRTdG9wOiB0cnVlLAogICAgICAgIGludmVydENhbWVyYTogZmFsc2UsCiAgICAgICAgYXV0b1JlY2VudGVyOiB0cnVlCiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRGVidWcgSU8gQnJpZGdlIChleHBvc2VkIGZvciBEZXZUb29scyBKU09OIHNuYXBzaG90cykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgX2RlYnVnSU8gPSB3aW5kb3cuZmx1eC5fZGVidWdJTyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIHx8IHt9OwogICAgX2RlYnVnSU8uc2V0dGluZ3MgPSBfc2V0dGluZ3M7CiAgICBfZGVidWdJTy5pbnB1dCA9IF9kZWJ1Z0lPLmlucHV0IHx8IHt9OwogICAgX2RlYnVnSU8ucGVyZiA9IF9kZWJ1Z0lPLnBlcmYgfHwgeyBmcmFtZTogMCwgcmF3RHQ6IDAsIGR0OiAwLCBmcHM6IDAsIGF2Z0ZwczogMCB9OwoKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIFRvdWNoIGhlbHBlcnMgKG11bHRpLXRvdWNoIHNhZmUpCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGZ1bmN0aW9uIF9maW5kVG91Y2hCeUlkKHRvdWNoTGlzdCwgaWQpIHsKICAgICAgICBpZiAoaWQgPT09IG51bGwgfHwgaWQgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgICAgaWYgKCF0b3VjaExpc3QpIHJldHVybiBudWxsOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdG91Y2hMaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IHQgPSB0b3VjaExpc3RbaV07CiAgICAgICAgICAgIGlmICh0ICYmIHQuaWRlbnRpZmllciA9PT0gaWQpIHJldHVybiB0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBfZW5kZWRUb3VjaEJ5SWQoY2hhbmdlZFRvdWNoZXMsIGlkKSB7CiAgICAgICAgaWYgKGlkID09PSBudWxsIHx8IGlkID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgICAgIGlmICghY2hhbmdlZFRvdWNoZXMpIHJldHVybiBudWxsOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hhbmdlZFRvdWNoZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgdCA9IGNoYW5nZWRUb3VjaGVzW2ldOwogICAgICAgICAgICBpZiAodCAmJiB0LmlkZW50aWZpZXIgPT09IGlkKSByZXR1cm4gdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGluaXQoKSB7CiAgICAgICAgX2NvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnYW1lLWNvbnRhaW5lcicpOwoKICAgICAgICAvLyAxLiBTY2VuZQogICAgICAgIF9zY2VuZSA9IG5ldyBUSFJFRS5TY2VuZSgpOwogICAgICAgIF9zY2VuZS5iYWNrZ3JvdW5kID0gbmV3IFRIUkVFLkNvbG9yKF9jb25maWcuYmdDb2xvcik7CiAgICAgICAgX3NjZW5lLmZvZyA9IG5ldyBUSFJFRS5Gb2dFeHAyKF9jb25maWcuZm9nQ29sb3IsIF9jb25maWcuZm9nRGVuc2l0eSk7CgogICAgICAgIC8vIDIuIENhbWVyYQogICAgICAgIGNvbnN0IGFzcGVjdCA9IF9jb25maWcuaW50ZXJuYWxXaWR0aCAvIF9jb25maWcuaW50ZXJuYWxIZWlnaHQ7Cl9jYW1lcmEgPSBuZXcgVEhSRUUuUGVyc3BlY3RpdmVDYW1lcmEoNjAsIGFzcGVjdCwgMC4xLCA1MDApOwpfY2FtZXJhLnBvc2l0aW9uLnNldCgwLCAxNCwgMjIpOwogICAgICAgIF9jYW1lcmEubG9va0F0KDAsIDAsIDApOwogICAgICAgIF9zY2VuZS5hZGQoX2NhbWVyYSk7IC8vIEVuc3VyZSBjYW1lcmEgaXMgaW4gc2NlbmUgZm9yIGNoaWxkcmVuIHRvIHJlbmRlcgoKICAgICAgICAvLyAzLiBSZW5kZXJlcgovLyAzLiBSZW5kZXJlcgogICAgICAgIF9yZW5kZXJlciA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlcmVyKHsgCiAgICAgICAgICAgIGFudGlhbGlhczogZmFsc2UsCiAgICAgICAgICAgIHBvd2VyUHJlZmVyZW5jZTogImhpZ2gtcGVyZm9ybWFuY2UiLAogICAgICAgICAgICBwcmVjaXNpb246ICJtZWRpdW1wIiwgLy8gTW9iaWxlIG9wdGltaXphdGlvbjogZmFzdGVyIHNoYWRlcnMKICAgICAgICAgICAgc3RlbmNpbDogZmFsc2UsICAgICAgIC8vIERpc2FibGUgc3RlbmNpbCBidWZmZXIgaWYgbm90IHVzZWQKICAgICAgICAgICAgZGVwdGg6IHRydWUKICAgICAgICB9KTsKICAgICAgICBfcmVuZGVyZXIuc2V0UGl4ZWxSYXRpbygxKTsgLy8gRm9yY2UgMToxIHBpeGVsIHJhdGlvLCB3ZSBoYW5kbGUgc2NhbGluZyB2aWEgc2V0U2l6ZQogICAgICAgIF9yZW5kZXJlci5hdXRvQ2xlYXIgPSBmYWxzZTsgLy8gV2UgbWFuYWdlIGNsZWFyaW5nIHZpYSBiYWNrZ3JvdW5kIG9yIG1hbnVhbCBjYWxscyBpZiBuZWVkZWQgKHRob3VnaCBzY2VuZS5iYWNrZ3JvdW5kIGhhbmRsZXMgY29sb3IpCiAgICAgICAgLy8gRXhwb3NlIHJlbmRlcmVyIGZvciBEZXZUb29scwogICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIF9nYW1lTWFuYWdlci5yZW5kZXJlciA9IF9yZW5kZXJlcjsgCiAgICAgICAgZWxzZSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPSB7IHJlbmRlcmVyOiBfcmVuZGVyZXIgfTsgLy8gVGVtcCBob29rCl9jb250YWluZXIuYXBwZW5kQ2hpbGQoX3JlbmRlcmVyLmRvbUVsZW1lbnQpOwoKLy8gLS0tIFZpZGVvIE92ZXJsYXkgRW5mb3JjZW1lbnQgLS0tCiAgICAgICAgLy8gLS0tIE92ZXJsYXkgVmlkZW8gTG9naWMgUmVtb3ZlZCAoU3dpdGNoZWQgdG8gR0lGKSAtLS0KICAgICAgICAvLyA1LiBFbnZpcm9ubWVudAogICAgICAgIGNyZWF0ZVBhcnRpY2xlcygpOwogICAgICAgIGNyZWF0ZUFyZW5hKCk7CiAgICAgICAgY3JlYXRlSG9sb2dyYXBoaWNSaW5ncygpOwovLyA1LjUgR2FtZSBNYW5hZ2VyCl9nYW1lTWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5HYW1lTWFuYWdlcihfc2NlbmUsICd1aS1sYXllcicsIF9jYW1lcmEsIF9yZW5kZXJlcik7CiAgICAgICAgCiAgICAgICAgLy8gNS41LjEgQXVkaW8gTWFuYWdlcgogICAgICAgIF9hdWRpb01hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguQXVkaW9NYW5hZ2VyKCk7CiAgICAgICAgX2dhbWVNYW5hZ2VyLmF1ZGlvTWFuYWdlciA9IF9hdWRpb01hbmFnZXI7CgogICAgICAgIC8vIDUuNiBDYW1lcmEgTWFuYWdlcgogICAgICAgIF9jYW1lcmFNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkNhbWVyYU1hbmFnZXIoX2NhbWVyYSwgX3NjZW5lKTsKICAgICAgICBfZ2FtZU1hbmFnZXIuY2FtZXJhTWFuYWdlciA9IF9jYW1lcmFNYW5hZ2VyOwoKICAgICAgICAvLyA1LjcgRGV2IFRvb2xzCmlmICh3aW5kb3cuZmx1eC5EZXZUb29scykgewogICAgICAgICAgICBuZXcgd2luZG93LmZsdXguRGV2VG9vbHMoX2dhbWVNYW5hZ2VyKTsKICAgICAgICB9Ci8vIDUuOCBXYXRlciBPdmVybGF5LCBMaWdodCBTaGFmdHMsIFN0YWRpdW0sIEdseXBocwogICAgICAgIF93YXRlck92ZXJsYXkgPSBuZXcgd2luZG93LmZsdXguV2F0ZXJPdmVybGF5KF9jYW1lcmEpOwogICAgICAgIF9saWdodFNoYWZ0cyA9IG5ldyB3aW5kb3cuZmx1eC5MaWdodFNoYWZ0cyhfc2NlbmUpOwogICAgICAgIF9zdGFkaXVtID0gbmV3IHdpbmRvdy5mbHV4LlN0YWRpdW0oX3NjZW5lKTsKICAgICAgICBfZ2x5cGhNYW5hZ2VyID0gbmV3IHdpbmRvdy5mbHV4LkdseXBoTWFuYWdlcihfc2NlbmUpOwogICAgICAgIAppZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIF9nYW1lTWFuYWdlci5nbHlwaE1hbmFnZXIgPSBfZ2x5cGhNYW5hZ2VyOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIud2F0ZXJPdmVybGF5ID0gX3dhdGVyT3ZlcmxheTsKICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmxpZ2h0U2hhZnRzID0gX2xpZ2h0U2hhZnRzOwogICAgICAgICAgICBfZ2FtZU1hbmFnZXIuc3RhZGl1bSA9IF9zdGFkaXVtOwogICAgICAgIH0KICAgICAgICAvLyA2LiBUZWFtcyBTZXR1cAogICAgICAgIF9ob21lVGVhbSA9IG5ldyB3aW5kb3cuZmx1eC5UZWFtKF9zY2VuZSwgJ2hvbWUnLCAxLCAweDAwYWFmZiwgdHJ1ZSk7CiAgICAgICAgX2F3YXlUZWFtID0gbmV3IHdpbmRvdy5mbHV4LlRlYW0oX3NjZW5lLCAnYXdheScsIC0xLCAweGZmNjY2NiwgZmFsc2UpOwoKICAgICAgICAvLyA3LiBCYWxsCiAgICAgICAgX2JhbGwgPSBuZXcgd2luZG93LmZsdXguQmFsbChfc2NlbmUpOwoKICAgICAgICAvLyBJTVBST1ZFRDogTGluayBiYWxsIHRvIGNhbWVyYSBmb3Igc21hcnQgZnJhbWluZwogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnNldEJhbGwoX2JhbGwpOwoKICAgICAgICAvLyA4LiBUZWFtIFJvc3RlciBNb2RlbHMKICAgICAgICBjb25zdCByb2xlcyA9IFsnTEYnLCAnUkYnLCAnTUYnLCAnTEQnLCAnUkQnLCAnR0wnXTsKICAgICAgICBjb25zdCBob21lUm9zdGVyID0gewogICAgICAgICAgICBMRjogeyBuYW1lOiAnVGlkdXMnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZGE3ODhiZWYyNThjNGYwYjhkOWVmMWFjYzE5YzU1NjcuZ2xiJyB9LAogICAgICAgICAgICBSRjogeyBuYW1lOiAnV2Fra2EnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJyB9LAogICAgICAgICAgICBNRjogeyBuYW1lOiAnTGV0dHknLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNDNhY2UzNGM2ZmQ5NDIxNTk2N2U4NDJiZjkwOWRhNWUuZ2xiJyB9LAogICAgICAgICAgICBMRDogeyBuYW1lOiAnRGF0dG8nLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvZTZkNjdlY2IyZTRjNDcxNWJkNzNhNDA3OTVlMWQzZDUuZ2xiJyB9LAogICAgICAgICAgICBSRDogeyBuYW1lOiAnSmFzc3UnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJyB9LAogICAgICAgICAgICBHTDogeyBuYW1lOiAnQm90dGEnLCB1cmw6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvYWQxNTVlZmVkYzBkNDhmZGFkMDlkYTNlMWNhZTljOTcuZ2xiJyB9CiAgICAgICAgfTsKCmNvbnN0IGFwcGx5U3RhdHMgPSAocCwgcm9sZSwgaXNIb21lKSA9PiB7CmNvbnN0IHRlYW1MZXZlbCA9IGlzSG9tZSA/IDI1IDogODsgLy8gTmVyZmVkIENQVSBsZXZlbCBzaWduaWZpY2FudGx5ICh3YXMgMTUpCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LlRlYW0uZ2VuZXJhdGVTdGF0cyhwLCByb2xlLCB0ZWFtTGV2ZWwsIGlzSG9tZSk7CgogICAgICAgICAgICBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDU7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNQICs9IDM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdXYWtrYScpKSB7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIICs9IDM7CiAgICAgICAgICAgICAgICBwLnN0YXRzLkVOICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdCcm90aGVyJykpIHsKICAgICAgICAgICAgICAgIHAuc3RhdHMuU1AgPSA5OTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcC5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CiAgICAgICAgfTsKCiAgICAgICAgbGV0IGhvbWVMb2FkZWQgPSAwOwogICAgICAgIGNvbnN0IHJvbGVHbHRmcyA9IHt9OwoKICAgICAgICBjb25zdCBmaW5hbGl6ZVRlYW1zID0gKCkgPT4gewogICAgICAgICAgICByb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZ2x0ZiA9IHJvbGVHbHRmc1tyb2xlXSB8fCByb2xlR2x0ZnMuTEY7CgogICAgICAgICAgICAgICAgY29uc3QgcCA9IChyb2xlID09PSAnR0wnKQogICAgICAgICAgICAgICAgICAgID8gbmV3IHdpbmRvdy5mbHV4LkdvYWxpZShfc2NlbmUsIHJvbGUpCiAgICAgICAgICAgICAgICAgICAgOiBuZXcgd2luZG93LmZsdXguQUlQbGF5ZXIoX3NjZW5lLCByb2xlKTsKCiAgICAgICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgICAgICBwLmNoYXJhY3Rlck5hbWUgPSBlbnRyeSA/IGBDUFUgJHtlbnRyeS5uYW1lfWAgOiAnQ1BVJzsKICAgICAgICAgICAgICAgIGFwcGx5U3RhdHMocCwgcm9sZSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmICYmIGdsdGYuc2NlbmUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjbG9uZSA9IFRIUkVFLlNrZWxldG9uVXRpbHMuY2xvbmUoZ2x0Zi5zY2VuZSk7CiAgICAgICAgICAgICAgICAgICAgcC5zZXRNZXNoKGNsb25lLCBnbHRmLmFuaW1hdGlvbnMgfHwgW10pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ01pc3NpbmcgR0xURiBmb3IgYXdheSByb2xlOicsIHJvbGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS5hZGRQbGF5ZXIocCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgYWxsUGxheWVycyA9IFsuLi5faG9tZVRlYW0ucGxheWVycywgLi4uX2F3YXlUZWFtLnBsYXllcnNdOwogICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAocC5iYWxsUmVmID09PSBudWxsKSBwLmJhbGxSZWYgPSBfYmFsbDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyID0gX2hvbWVUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy50YWNrbGUgPSAndmVub20nOwogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50ZWNocy5zaG9vdCA9ICdzcGhlcmUnOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0VxdWlwcGVkIEhvbWUgTUYgd2l0aCBWZW5vbSBUYWNrbGUgJiBTcGhlcmUgU2hvdCcpOwogICAgICAgICAgICB9Cgpjb25zdCBhd2F5TUYgPSBfYXdheVRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgLy8gUmVtb3ZlZCBndWFyYW50ZWVkIFdpdGhlciB0YWNrbGUgZm9yIEF3YXkgTUYgdG8gcmVkdWNlIGRpZmZpY3VsdHkKICAgICAgICAgICAgX2F3YXlUZWFtLnNldEZvcm1hdGlvbignQ291bnRlcicpOwoKICAgICAgICAgICAgY29uc3QgYXdheUdMID0gX2F3YXlUZWFtLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ0dMJyk7CiAgICAgICAgICAgIC8vIFJlbW92ZWQgZ3VhcmFudGVlZCBTdXBlciBHb2FsaWUgZm9yIEF3YXkgR0wgdG8gbWFrZSBzY29yaW5nIGVhc2llcgoKICAgICAgICAgICAgX2hvbWVUZWFtLmFzc2lnbk1hcmtzKF9hd2F5VGVhbSk7CiAgICAgICAgICAgIF9hd2F5VGVhbS5hc3NpZ25NYXJrcyhfaG9tZVRlYW0pOwoKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xvYWRpbmcnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIucmVnaXN0ZXJUZWFtcyhfaG9tZVRlYW0sIF9hd2F5VGVhbSwgX2JhbGwpOwoKICAgICAgICAgICAgICAgIF9tZW51TWFuYWdlciA9IG5ldyB3aW5kb3cuZmx1eC5NZW51TWFuYWdlcihfZ2FtZU1hbmFnZXIpOwogICAgICAgICAgICAgICAgX21lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgfQogICAgICAgIH07Cgpyb2xlcy5mb3JFYWNoKHJvbGUgPT4gewogICAgICAgICAgICBjb25zdCBlbnRyeSA9IGhvbWVSb3N0ZXJbcm9sZV07CiAgICAgICAgICAgIGlmICghZW50cnkpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9uQ29tcGxldGUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBob21lTG9hZGVkKys7CiAgICAgICAgICAgICAgICBpZiAoaG9tZUxvYWRlZCA+PSByb2xlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBmaW5hbGl6ZVRlYW1zKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlci5sb2FkTW9kZWwoZW50cnkudXJsLCAoZ2x0ZikgPT4gewogICAgICAgICAgICAgICAgcm9sZUdsdGZzW3JvbGVdID0gZ2x0ZjsKCiAgICAgICAgICAgICAgICBjb25zdCBwID0gKHJvbGUgPT09ICdHTCcpCiAgICAgICAgICAgICAgICAgICAgPyBuZXcgd2luZG93LmZsdXguR29hbGllKF9zY2VuZSwgcm9sZSkKICAgICAgICAgICAgICAgICAgICA6IG5ldyB3aW5kb3cuZmx1eC5BSVBsYXllcihfc2NlbmUsIHJvbGUpOwoKICAgICAgICAgICAgICAgIHAuY2hhcmFjdGVyTmFtZSA9IGVudHJ5Lm5hbWU7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIHRydWUpOwoKICAgICAgICAgICAgICAgIGNvbnN0IGNsb25lID0gVEhSRUUuU2tlbGV0b25VdGlscy5jbG9uZShnbHRmLnNjZW5lKTsKICAgICAgICAgICAgICAgIHAuc2V0TWVzaChjbG9uZSwgZ2x0Zi5hbmltYXRpb25zKTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hZGRQbGF5ZXIocCk7CgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpOwogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2FkIG1vZGVsJywgZW50cnkubmFtZSwgZW50cnkudXJsLCBlcnIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayBNZXNoIChSZWQgQm94KQogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoMSwgMiwgMSk7CiAgICAgICAgICAgICAgICBjb25zdCBmYWxsYmFja01hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlIH0pOwogICAgICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tNZXNoID0gbmV3IFRIUkVFLk1lc2goZmFsbGJhY2tHZW8sIGZhbGxiYWNrTWF0KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU3RvcmUgZHVtbXkgaW4gcm9sZUdsdGZzIGZvciBhd2F5IHRlYW0gY2xvbmluZwogICAgICAgICAgICAgICAgcm9sZUdsdGZzW3JvbGVdID0geyBzY2VuZTogZmFsbGJhY2tNZXNoLCBhbmltYXRpb25zOiBbXSB9OwoKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSAocm9sZSA9PT0gJ0dMJykKICAgICAgICAgICAgICAgICAgICA/IG5ldyB3aW5kb3cuZmx1eC5Hb2FsaWUoX3NjZW5lLCByb2xlKQogICAgICAgICAgICAgICAgICAgIDogbmV3IHdpbmRvdy5mbHV4LkFJUGxheWVyKF9zY2VuZSwgcm9sZSk7CgogICAgICAgICAgICAgICAgcC5jaGFyYWN0ZXJOYW1lID0gZW50cnkubmFtZSArICIgKEVycm9yKSI7CiAgICAgICAgICAgICAgICBhcHBseVN0YXRzKHAsIHJvbGUsIHRydWUpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBwLnNldE1lc2goZmFsbGJhY2tNZXNoLmNsb25lKCksIFtdKTsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hZGRQbGF5ZXIocCk7CgogICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gOC4gSW5wdXQKICAgICAgICBzZXR1cElucHV0cygpOwoKICAgICAgICAvLyA5LiBMb29wCiAgICAgICAgX2Nsb2NrID0gbmV3IFRIUkVFLkNsb2NrKCk7CiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwoKICAgICAgICAvLyBIYW5kbGUgcmVzaXplCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIG9uUmVzaXplKTsKICAgICAgICBvblJlc2l6ZSgpOwogICAgfQoKZnVuY3Rpb24gY3JlYXRlUGFydGljbGVzKCkgewogICAgICAgIGNvbnN0IGNvdW50ID0gMTUwMDsgLy8gSW5jcmVhc2VkIGNvdW50CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICBjb25zdCB2ZXJ0aWNlcyA9IFtdOwogICAgICAgIGNvbnN0IG9mZnNldHMgPSBbXTsgLy8gUmFuZG9tIG9mZnNldHMgZm9yIGluZGVwZW5kZW50IGJvYmJpbmcKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgIHZlcnRpY2VzLnB1c2goCiAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA4MCwgLy8gV2lkZXIgc3ByZWFkIFgKICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDUwLCAvLyBXaWRlciBzcHJlYWQgWQogICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogODAgIC8vIFdpZGVyIHNwcmVhZCBaCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIG9mZnNldHMucHVzaChNYXRoLnJhbmRvbSgpICogMTAwKTsKICAgICAgICB9CgogICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSh2ZXJ0aWNlcywgMykpOwogICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgnYU9mZnNldCcsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKG9mZnNldHMsIDEpKTsKCiAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICB1bmlmb3JtczogX3BhcnRpY2xlVW5pZm9ybXMsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCnZlcnRleFNoYWRlcjogYAogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1VGltZTsKICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBhT2Zmc2V0OwogICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2QWxwaGE7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAvLyBCb2JiaW5nIG1vdGlvbjogU2luZSB3YXZlIGJhc2VkIG9uIHRpbWUgKyByYW5kb20gb2Zmc2V0CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYm9iID0gc2luKHVUaW1lICogMC41ICsgYU9mZnNldCkgKiAyLjA7CiAgICAgICAgICAgICAgICAgICAgcG9zLnkgKz0gYm9iOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZlYzQgbXZQb3NpdGlvbiA9IG1vZGVsVmlld01hdHJpeCAqIHZlYzQocG9zLCAxLjApOwogICAgICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG12UG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU2l6ZSBhdHRlbnVhdGlvbiAtIFNtYWxsIGFuZCBzaGltbWVyeQogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNpemVCYXNlID0gMi4wICsgc2luKHVUaW1lICogMy4wICsgYU9mZnNldCkgKiAxLjA7IAogICAgICAgICAgICAgICAgICAgIGdsX1BvaW50U2l6ZSA9IHNpemVCYXNlICogKDIwLjAgLyAtbXZQb3NpdGlvbi56KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBGYWRlIGJhc2VkIG9uIGRpc3RhbmNlL2hlaWdodAogICAgICAgICAgICAgICAgICAgIHZBbHBoYSA9IDAuNSArIDAuNSAqIHNpbih1VGltZSAqIDIuMCArIGFPZmZzZXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgLAogICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogYAogICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2QWxwaGE7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU29mdCBnbG93IHBhcnRpY2xlIChEdXN0IG1vdGUpCiAgICAgICAgICAgICAgICAgICAgdmVjMiBjb29yZCA9IGdsX1BvaW50Q29vcmQgLSB2ZWMyKDAuNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGlzdCA9IGxlbmd0aChjb29yZCk7CiAgICAgICAgICAgICAgICAgICAgaWYoZGlzdCA+IDAuNSkgZGlzY2FyZDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTb2Z0IGZhbGxvZmYgZm9yIHNoaW1tZXIKICAgICAgICAgICAgICAgICAgICBmbG9hdCBzdHJlbmd0aCA9IDEuMCAtIChkaXN0ICogMi4wKTsKICAgICAgICAgICAgICAgICAgICBzdHJlbmd0aCA9IHBvdyhzdHJlbmd0aCwgMi4wKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDeWFuL0JsdWUgdGludCwgYWRkaXRpdmUgZmVlbAogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoMC43LCAwLjksIDEuMCwgdkFscGhhICogc3RyZW5ndGggKiAwLjgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHBvaW50cyA9IG5ldyBUSFJFRS5Qb2ludHMoZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICBwb2ludHMuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgIF9zY2VuZS5hZGQocG9pbnRzKTsKICAgIH0KCmZ1bmN0aW9uIGNyZWF0ZUFyZW5hKCkgewogICAgICAgIC8vIEdyb3VwIGZvciByb3RhdGlvbgogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICBfc2NlbmUuYWRkKHdpbmRvdy5mbHV4LmFyZW5hR3JvdXApOwoKICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeShfY29uZmlnLmFyZW5hUmFkaXVzLCAzMiwgMzIpOwogICAgICAgIAogICAgICAgIC8vIC0tLSAxLiBCYXNlIFNwaGVyZSAoRmFpbnQgR3JpZCkgLS0tCiAgICAgICAgY29uc3QgdGV4TG9hZGVyID0gbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKTsKICAgICAgICBjb25zdCBhcmVuYVRleCA9IHRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9XMUxzSDY4US9maWxlLTAwMDAwMDAwMjNlYzcxZjU5NjU5MzgyOWU4MTE4NzYwLSgxKS5wbmcnKTsKICAgICAgICBhcmVuYVRleC5tYWdGaWx0ZXIgPSBUSFJFRS5OZWFyZXN0RmlsdGVyOwogICAgICAgIGFyZW5hVGV4Lm1pbkZpbHRlciA9IFRIUkVFLk5lYXJlc3RGaWx0ZXI7CiAgICAgICAgYXJlbmFUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBhcmVuYVRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIGFyZW5hVGV4LnJlcGVhdC5zZXQoNiwgNCk7CgogICAgICAgIGNvbnN0IG1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiBhcmVuYVRleCwKICAgICAgICAgICAgY29sb3I6IDB4NDQ2Njg4LAogICAgICAgICAgICB3aXJlZnJhbWU6IGZhbHNlLAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4xNSwgCiAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgY29uc3QgYXJlbmEgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAuYWRkKGFyZW5hKTsKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2ggPSBhcmVuYTsKCiAgICAgICAgLy8gLS0tIDIuIElubmVyIEhleCBHcmlkIChXYXJwIEVmZmVjdCkgLS0tCiAgICAgICAgLy8gUmV1c2UgZXhpc3RpbmcgaGV4IGdlbmVyYXRpb24gbG9naWMgYnV0IGF0dGFjaCB0byBncm91cAogICAgICAgIGNvbnN0IGhleFRleCA9ICgoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICAgICAgYy53aWR0aCA9IDUxMjsgYy5oZWlnaHQgPSA1MTI7CiAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLDAsNTEyLDUxMik7CiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDAsIDI1NSwgMjU1LCAwLjUpJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgIGNvbnN0IHIgPSA2NDsKICAgICAgICAgICAgY29uc3QgdyA9IHIgKiAyOwogICAgICAgICAgICBjb25zdCBoID0gTWF0aC5zcXJ0KDMpICogcjsKICAgICAgICAgICAgZm9yKGxldCB5ID0gLTE7IHkgPCA1MTIvaCArIDI7IHkrKykgewogICAgICAgICAgICAgICAgZm9yKGxldCB4ID0gLTE7IHggPCA1MTIvKHcqMC43NSkgKyAyOyB4KyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjeCA9IHggKiB3ICogMC43NTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjeSA9IHkgKiBoICsgKHglMj09PTAgPyAwIDogaC8yKTsKICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8NjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZyA9IE1hdGguUEkvMyAqIGk7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oY3ggKyBNYXRoLmNvcyhhbmcpKnIsIGN5ICsgTWF0aC5zaW4oYW5nKSpyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICAgICAgfSkoKTsKICAgICAgICBoZXhUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBoZXhUZXgud3JhcFQgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBoZXhUZXgucmVwZWF0LnNldCg0LCAyKTsKCiAgICAgICAgY29uc3QgYXJlbmFVbmlmb3JtcyA9IFRIUkVFLlVuaWZvcm1zVXRpbHMubWVyZ2UoWwogICAgICAgICAgICBUSFJFRS5Vbmlmb3Jtc0xpYlsnY29tbW9uJ10sCiAgICAgICAgICAgIF9hcmVuYVVuaWZvcm1zLAogICAgICAgICAgICB7IAogICAgICAgICAgICAgICAgdE1hcDogeyB2YWx1ZTogaGV4VGV4IH0sCiAgICAgICAgICAgICAgICB1T3BhY2l0eTogeyB2YWx1ZTogMC4xIH0gCiAgICAgICAgICAgIH0KICAgICAgICBdKTsKCiAgICAgICAgY29uc3QgbWF0ZXJpYWwyID0gbmV3IFRIUkVFLlNoYWRlck1hdGVyaWFsKHsKICAgICAgICAgICAgdW5pZm9ybXM6IGFyZW5hVW5pZm9ybXMsCiAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IGAKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdVRpbWU7CiAgICAgICAgICAgICAgICB1bmlmb3JtIHZlYzMgdUltcGFjdFBvczsKICAgICAgICAgICAgICAgIHVuaWZvcm0gZmxvYXQgdUltcGFjdFN0cjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdlV2ID0gdXY7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBwb3MgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkaXN0ID0gZGlzdGFuY2UocG9zLCB1SW1wYWN0UG9zKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYWRpdXMgPSAyMC4wOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgcmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSBkaXN0IC8gcmFkaXVzOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBidWxnZSA9ICgxLjAgLSB0KSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMyBub3JtYWwgPSBub3JtYWxpemUocG9zKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zICs9IG5vcm1hbCAqIChidWxnZSAqIHVJbXBhY3RTdHIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KHBvcywgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYCwKICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGAKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHRNYXA7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVJbXBhY3RTdHI7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVPcGFjaXR5OwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2ZWM0IHRleENvbG9yID0gdGV4dHVyZTJEKHRNYXAsIHZVdik7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYWxwaGEgPSB1T3BhY2l0eSAqIHRleENvbG9yLmE7CiAgICAgICAgICAgICAgICAgICAgYWxwaGEgKz0gdUltcGFjdFN0ciAqIDAuMDI7IAogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB0ZXhDb2xvci5yZ2IgKiB2ZWMzKDAuMiwgMC44LCAxLjApOwogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGFscGhhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYAogICAgICAgIH0pOwoKICAgICAgICBjb25zdCBhcmVuYTIgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwyKTsKICAgICAgICBhcmVuYTIuc2NhbGUuc2V0U2NhbGFyKDAuOTgpOwogICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hR3JvdXAuYWRkKGFyZW5hMik7CiAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoMiA9IGFyZW5hMjsKCiAgICAgICAgLy8gLS0tIDMuIEVRVUFUT1IgQkFORFMgKEJsdWUgYW5kIEdvbGQgLSBwb3NzZXNzaW9uIGJhc2VkKSAtLS0KICAgICAgICBjb25zdCBiYW5kVGV4TG9hZGVyID0gbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKTsKCiAgICAgICAgLy8gQmx1ZSBCYW5kIChzaG93biB3aGVuIGhvbWUgdGVhbSBoYXMgYmFsbCkgLSB0aGluIGJhbmQsIG5vIHZlcnRpY2FsIHN0cmV0Y2gKICAgICAgICBjb25zdCBibHVlQmFuZFRleCA9IGJhbmRUZXhMb2FkZXIubG9hZCgnaHR0cHM6Ly9pLnBvc3RpbWcuY2MvU1FuRnBESE4vQmx1ZS1iYW5kLnBuZycpOwogICAgICAgIGJsdWVCYW5kVGV4LndyYXBTID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgYmx1ZUJhbmRUZXgud3JhcFQgPSBUSFJFRS5DbGFtcFRvRWRnZVdyYXBwaW5nOwogICAgICAgIGJsdWVCYW5kVGV4LnJlcGVhdC5zZXQoMSwgMSk7IC8vIFNpbmdsZSB3cmFwLCBpbWFnZSB0aWxlcyBuYXR1cmFsbHkKCiAgICAgICAgY29uc3QgYmx1ZUJhbmRNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGJsdWVCYW5kVGV4LAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4zNSwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwovLyBUaGluIGJhbmQgLSBoZWlnaHQgb2YgMyB0byBhdm9pZCBzdHJldGNoaW5nCiAgICAgICAgY29uc3QgYmx1ZUJhbmRHZW8gPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeShfY29uZmlnLmFyZW5hUmFkaXVzICogMC45NiwgX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTYsIDMsIDY0LCAxLCB0cnVlKTsKICAgICAgICBjb25zdCBibHVlQmFuZE1lc2ggPSBuZXcgVEhSRUUuTWVzaChibHVlQmFuZEdlbywgYmx1ZUJhbmRNYXQpOwogICAgICAgIGJsdWVCYW5kTWVzaC5wb3NpdGlvbi55ID0gMDsKICAgICAgICBibHVlQmFuZE1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgX3NjZW5lLmFkZChibHVlQmFuZE1lc2gpOwoKICAgICAgICAvLyBHb2xkIEJhbmQgKHNob3duIHdoZW4gYXdheSB0ZWFtIGhhcyBiYWxsKQogICAgICAgIGNvbnN0IGdvbGRCYW5kVGV4ID0gYmFuZFRleExvYWRlci5sb2FkKCdodHRwczovL2kucG9zdGltZy5jYy9NWm4yOGRncS9Hb2xkLWJhbmQucG5nJyk7CiAgICAgICAgZ29sZEJhbmRUZXgud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICBnb2xkQmFuZFRleC53cmFwVCA9IFRIUkVFLkNsYW1wVG9FZGdlV3JhcHBpbmc7CiAgICAgICAgZ29sZEJhbmRUZXgucmVwZWF0LnNldCgxLCAxKTsKCiAgICAgICAgY29uc3QgZ29sZEJhbmRNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IGdvbGRCYW5kVGV4LAogICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgb3BhY2l0eTogMC4zNSwKICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgIH0pOwpjb25zdCBnb2xkQmFuZEdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KF9jb25maWcuYXJlbmFSYWRpdXMgKiAwLjk2LCBfY29uZmlnLmFyZW5hUmFkaXVzICogMC45NiwgMywgNjQsIDEsIHRydWUpOwogICAgICAgIGNvbnN0IGdvbGRCYW5kTWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdvbGRCYW5kR2VvLCBnb2xkQmFuZE1hdCk7CiAgICAgICAgZ29sZEJhbmRNZXNoLnBvc2l0aW9uLnkgPSAwOwogICAgICAgIGdvbGRCYW5kTWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgX3NjZW5lLmFkZChnb2xkQmFuZE1lc2gpOwoKICAgICAgICAvLyBTdG9yZSByZWZlcmVuY2VzCiAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNZXNoID0gYmx1ZUJhbmRNZXNoOwogICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWVzaCA9IGdvbGRCYW5kTWVzaDsKICAgICAgICB3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCA9IGJsdWVCYW5kTWF0OwogICAgICAgIHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0ID0gZ29sZEJhbmRNYXQ7CgogICAgICAgIHdpbmRvdy5mbHV4LnVwZGF0ZUJhbmRQb3NzZXNzaW9uID0gZnVuY3Rpb24oaG9tZUhhc0JhbGwpIHsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaCAmJiB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2gpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaC52aXNpYmxlID0gaG9tZUhhc0JhbGw7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2xkQmFuZE1lc2gudmlzaWJsZSA9ICFob21lSGFzQmFsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHdpbmRvdy5mbHV4LnRyaWJhbFVuaWZvcm1zID0gewogICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9LAogICAgICAgICAgICB1Q29sb3I6IHsgdmFsdWU6IG5ldyBUSFJFRS5Db2xvcigweDAwZmZmZikgfQogICAgICAgIH07CgogICAgICAgIC8vIC0tLSA0LiBWRVJUSUNBTCBBUlJPVyBTVFJJUFMgKEFyb3VuZCBzcGhlcmUsIGFib3ZlICYgYmVsb3cgYmFuZCkgLS0tCiAgICAgICAgY29uc3QgYXJyb3dUZXhMb2FkZXIgPSBuZXcgVEhSRUUuVGV4dHVyZUxvYWRlcigpOwogICAgICAgIGNvbnN0IGFycm93VGV4ID0gYXJyb3dUZXhMb2FkZXIubG9hZCgnaHR0cHM6Ly9pLnBvc3RpbWcuY2MvZFFoUEs0Z1EvWWVsbG93YXJyb3dzLnBuZycpOwogICAgICAgIGFycm93VGV4LndyYXBTID0gVEhSRUUuQ2xhbXBUb0VkZ2VXcmFwcGluZzsKICAgICAgICBhcnJvd1RleC53cmFwVCA9IFRIUkVFLkNsYW1wVG9FZGdlV3JhcHBpbmc7CgogICAgICAgIGNvbnN0IGFycm93TWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiBhcnJvd1RleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuOCwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7CgogICAgICAgIC8vIENyZWF0ZSB2ZXJ0aWNhbCBhcnJvdyBzdHJpcHMgYXJvdW5kIHRoZSBzcGhlcmUgKGN1cnZlZCB0byBtYXRjaCBzcGhlcmUgc3VyZmFjZSkKICAgICAgICBjb25zdCBhcnJvd0dyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgY29uc3QgbnVtQXJyb3dzID0gMTY7ICAgLy8gTnVtYmVyIG9mIGFycm93IHN0cmlwcyBhcm91bmQgY2lyY3VtZmVyZW5jZQogICAgICAgIGNvbnN0IGFycm93SGVpZ2h0ID0gMzA7IC8vIEhlaWdodCBvZiBlYWNoIGFycm93IHN0cmlwCiAgICAgICAgY29uc3QgYXJyb3dXaWR0aCA9IDY7ICAgLy8gV2lkdGggb2YgZWFjaCBzdHJpcAogICAgICAgIGNvbnN0IGFycm93UmFkaXVzID0gX2NvbmZpZy5hcmVuYVJhZGl1cyAqIDAuOTQ7CgogICAgICAgIGNvbnN0IG1ha2VDdXJ2ZWRTdHJpcCA9IChiYXNlQW5nbGUsIHlDZW50ZXIsIGZsaXBWID0gZmFsc2UpID0+IHsKICAgICAgICAgICAgLy8gTW9yZSBzZWdtZW50cyA9IHNtb290aGVyIGN1cnZhdHVyZSAoa2VlcCBtb2Rlc3QgZm9yIG1vYmlsZSkKICAgICAgICAgICAgY29uc3Qgc2VnVyA9IDY7ICAgLy8gY3VydmF0dXJlIHJlc29sdXRpb24gKHdpZHRoKQogICAgICAgICAgICBjb25zdCBzZWdIID0gMTg7ICAvLyB2ZXJ0aWNhbCByZXNvbHV0aW9uIChoZWlnaHQpCgogICAgICAgICAgICAvLyBDb252ZXJ0IGRlc2lyZWQgd29ybGQtc3BhY2Ugd2lkdGggaW50byBhbiBhbmd1bGFyIHNwYW4gb24gdGhlIHNwaGVyZQogICAgICAgICAgICBjb25zdCBwaGlTcGFuID0gYXJyb3dXaWR0aCAvIGFycm93UmFkaXVzOyAvLyByYWRpYW5zIChhcHByb3ggYXQgZXF1YXRvcikKICAgICAgICAgICAgY29uc3QgcGhpMCA9IGJhc2VBbmdsZSAtIHBoaVNwYW4gKiAwLjU7CiAgICAgICAgICAgIGNvbnN0IHBoaTEgPSBiYXNlQW5nbGUgKyBwaGlTcGFuICogMC41OwoKICAgICAgICAgICAgY29uc3QgeTAgPSB5Q2VudGVyIC0gYXJyb3dIZWlnaHQgKiAwLjU7CiAgICAgICAgICAgIGNvbnN0IHkxID0geUNlbnRlciArIGFycm93SGVpZ2h0ICogMC41OwoKICAgICAgICAgICAgY29uc3QgcG9zaXRpb25zID0gW107CiAgICAgICAgICAgIGNvbnN0IG5vcm1hbHMgPSBbXTsKICAgICAgICAgICAgY29uc3QgdXZzID0gW107CiAgICAgICAgICAgIGNvbnN0IGluZGljZXMgPSBbXTsKCiAgICAgICAgICAgIGZvciAobGV0IGl5ID0gMDsgaXkgPD0gc2VnSDsgaXkrKykgewogICAgICAgICAgICAgICAgY29uc3QgdiA9IGl5IC8gc2VnSDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBUSFJFRS5NYXRoVXRpbHMubGVycCh5MCwgeTEsIHYpOwoKICAgICAgICAgICAgICAgIC8vIENpcmNsZSByYWRpdXMgYXQgdGhpcyBoZWlnaHQgb24gdGhlIHNwaGVyZSAoeC96IHNocmluayBhcyB8eXwgZ3Jvd3MpCiAgICAgICAgICAgICAgICBjb25zdCByaW5nUiA9IE1hdGguc3FydChNYXRoLm1heCgwLjAwMDAxLCBhcnJvd1JhZGl1cyAqIGFycm93UmFkaXVzIC0geSAqIHkpKTsKCiAgICAgICAgICAgICAgICBmb3IgKGxldCBpeCA9IDA7IGl4IDw9IHNlZ1c7IGl4KyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB1ID0gaXggLyBzZWdXOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBoaSA9IFRIUkVFLk1hdGhVdGlscy5sZXJwKHBoaTAsIHBoaTEsIHUpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5zaW4ocGhpKSAqIHJpbmdSOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHogPSBNYXRoLmNvcyhwaGkpICogcmluZ1I7CgogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9ucy5wdXNoKHgsIHksIHopOwoKICAgICAgICAgICAgICAgICAgICAvLyBPdXR3YXJkIG5vcm1hbCBmb3IgYSBzcGhlcmUgY2VudGVyZWQgYXQgb3JpZ2luCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW52TGVuID0gMS4wIC8gTWF0aC5zcXJ0KHggKiB4ICsgeSAqIHkgKyB6ICogeik7CiAgICAgICAgICAgICAgICAgICAgbm9ybWFscy5wdXNoKHggKiBpbnZMZW4sIHkgKiBpbnZMZW4sIHogKiBpbnZMZW4pOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCB2diA9IGZsaXBWID8gKDEgLSB2KSA6IHY7CiAgICAgICAgICAgICAgICAgICAgdXZzLnB1c2godSwgdnYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCByb3cgPSBzZWdXICsgMTsKICAgICAgICAgICAgZm9yIChsZXQgaXkgPSAwOyBpeSA8IHNlZ0g7IGl5KyspIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGl4ID0gMDsgaXggPCBzZWdXOyBpeCsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYSA9IGl5ICogcm93ICsgaXg7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYiA9IGEgKyAxOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGMgPSBhICsgcm93OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGQgPSBjICsgMTsKCiAgICAgICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGEsIGMsIGIpOwogICAgICAgICAgICAgICAgICAgIGluZGljZXMucHVzaChiLCBjLCBkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2VvID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgICAgIGdlby5zZXRJbmRleChpbmRpY2VzKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZShwb3NpdGlvbnMsIDMpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgnbm9ybWFsJywgbmV3IFRIUkVFLkZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUobm9ybWFscywgMykpOwogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCd1dicsIG5ldyBUSFJFRS5GbG9hdDMyQnVmZmVyQXR0cmlidXRlKHV2cywgMikpOwogICAgICAgICAgICBnZW8uY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk7CgogICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLk1lc2goZ2VvLCBhcnJvd01hdCk7CiAgICAgICAgfTsKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1BcnJvd3M7IGkrKykgewogICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gbnVtQXJyb3dzKSAqIE1hdGguUEkgKiAyOwoKICAgICAgICAgICAgLy8gVXBwZXIgYXJyb3cgc3RyaXAgKGFib3ZlIGJhbmQpCiAgICAgICAgICAgIGFycm93R3JvdXAuYWRkKG1ha2VDdXJ2ZWRTdHJpcChhbmdsZSwgYXJyb3dIZWlnaHQgKiAwLjUgKyAyLCBmYWxzZSkpOwoKICAgICAgICAgICAgLy8gTG93ZXIgYXJyb3cgc3RyaXAgKGJlbG93IGJhbmQpIC0gZmxpcCBWIHNvIGFycm93cyBwb2ludCBkb3dud2FyZAogICAgICAgICAgICBhcnJvd0dyb3VwLmFkZChtYWtlQ3VydmVkU3RyaXAoYW5nbGUsIC1hcnJvd0hlaWdodCAqIDAuNSAtIDIsIHRydWUpKTsKICAgICAgICB9CgogICAgICAgIF9zY2VuZS5hZGQoYXJyb3dHcm91cCk7CgogICAgICAgIC8vIFN0b3JlIHJlZmVyZW5jZXMgZm9yIERldlRvb2xzCiAgICAgICAgd2luZG93LmZsdXguYXJyb3dHcm91cCA9IGFycm93R3JvdXA7CiAgICAgICAgd2luZG93LmZsdXguYXJyb3dNYXQgPSBhcnJvd01hdDsKCiAgICAgICAgLy8gLS0tIDUuIFRPUCBHTFlQSFMgKERvbWUpIC0tLSAoRG9tZSkgLS0tCiAgICAgICAgY29uc3QgdG9wR2x5cGhUZXggPSAoKCkgPT4gewogICAgICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgICAgIGMud2lkdGggPSA1MTI7IGMuaGVpZ2h0ID0gNTEyOwogICAgICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgIGN0eC5jbGVhclJlY3QoMCwwLDUxMiw1MTIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMTAwLCAyMDAsIDI1NSwgMC41KSc7CiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoMjU2LCAyNTYsIDIwMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW50cmljYXRlIHBhdHRlcm4KICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ODsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhID0gKGkvOCkqTWF0aC5QSSoyOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IDI1NiArIE1hdGguY29zKGEpKjE1MDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAyNTYgKyBNYXRoLnNpbihhKSoxNTA7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIDQwLCAwLCBNYXRoLlBJKjIpOwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgLy8gQ29ubmVjdG9yCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKDI1NiwgMjU2KTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCwgeSk7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIH0pKCk7CgogICAgICAgIGNvbnN0IHRvcEdseXBoTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgbWFwOiB0b3BHbHlwaFRleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuNCwKICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgfSk7CgogICAgICAgIGNvbnN0IHRvcEdseXBoR2VvID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoNjAsIDYwKTsKICAgICAgICBjb25zdCB0b3BHbHlwaCA9IG5ldyBUSFJFRS5NZXNoKHRvcEdseXBoR2VvLCB0b3BHbHlwaE1hdCk7CiAgICAgICAgdG9wR2x5cGgucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgICAgICB0b3BHbHlwaC5wb3NpdGlvbi55ID0gMzU7IC8vIE5lYXIgdG9wIG9mIGRvbWUKICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYUdyb3VwLmFkZCh0b3BHbHlwaCk7CgogICAgICAgIC8vIC0tLSBORVc6IEZGWCBHT0FMIE1PREVMUyAtLS0KICAgICAgICBjb25zdCBnb2FsVXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hNTE2YmQ5MGZhN2M0ZGVkYjVkY2JmZGY4MDNmMTNkNS5nbGInOwogICAgICAgIApjb25zdCBvbkdvYWxMb2FkZWQgPSAobW9kZWwsIGlzRmFsbGJhY2spID0+IHsKICAgICAgICAgICAgY29uc3QgZ29hbEEgPSBtb2RlbDsKICAgICAgICAgICAgY29uc3QgZ29hbERpc3QgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UgfHwgNDEuNTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmVkIGRvd24gfjE1ZnQgKDQuNW0pIHRvdGFsIGFzIHJlcXVlc3RlZCwgcHVzaGVkIGJhY2sgdG8gZWRnZQogICAgICAgICAgICBnb2FsQS5wb3NpdGlvbi5zZXQoMCwgLTYuMCwgLWdvYWxEaXN0KTsKICAgICAgICAgICAgaWYgKCFpc0ZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBnb2FsQS5zY2FsZS5zZXRTY2FsYXIoNTQuMCk7IC8vIEluY3JlYXNlZCA1MCUgKHdhcyAzNi4wKQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFNldHVwIEdvYWwgQQogICAgICAgICAgICBnb2FsQS50cmF2ZXJzZShjID0+IHsKICAgICAgICAgICAgICAgIGlmKGMuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgYy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7IC8vIENSSVRJQ0FMOiBQcmV2ZW50IGN1bGxpbmcKICAgICAgICAgICAgICAgICAgICBjLnJlbmRlck9yZGVyID0gMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgbWF0ZXJpYWwgaXMgdmlzaWJsZSBhbmQgdW5pcXVlCiAgICAgICAgICAgICAgICAgICAgaWYgKGMubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbCA9IGMubWF0ZXJpYWwuY2xvbmUoKTsgLy8gQ2xvbmUgZm9yIGluZGVwZW5kZW5jZQogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIFdoaXRlIHRvIHNob3cgb3JpZ2luYWwgdGV4dHVyZS9jb2xvcnMKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC50cmFuc3BhcmVudCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuc2lkZSA9IFRIUkVFLkRvdWJsZVNpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhUZXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyBBZGQgZ29hbHMgdG8gU0NFTkUsIG5vdCBhcmVuYUdyb3VwICh0aGV5IHNob3VsZG4ndCByb3RhdGUgd2l0aCB0aGUgc3BoZXJlKQogICAgICAgICAgICBfc2NlbmUuYWRkKGdvYWxBKTsKICAgICAgICAgICAgd2luZG93LmZsdXguZ29hbEEgPSBnb2FsQTsgLy8gRXhwb3NlIGZvciBEZXZUb29scwoKICAgICAgICAgICAgLy8gU2V0dXAgR29hbCBCCiAgICAgICAgICAgIGNvbnN0IGdvYWxCID0gaXNGYWxsYmFjayA/IGdvYWxBLmNsb25lKCkgOiBUSFJFRS5Ta2VsZXRvblV0aWxzLmNsb25lKGdvYWxBKTsKCiAgICAgICAgICAgIGdvYWxCLnBvc2l0aW9uLnNldCgwLCAtNi4wLCBnb2FsRGlzdCk7IC8vIE1vdmVkIGNsb3NlciAod2FzIDQ1KSBhbmQgZG93bgogICAgICAgICAgICBnb2FsQi5yb3RhdGlvbi55ID0gTWF0aC5QSTsKICAgICAgICAgICAgLy8gRW5zdXJlIEdvYWwgQiBtZXNoZXMgYXJlIGFsc28gcGVyc2lzdGVudCBhbmQgaGF2ZSB1bmlxdWUgbWF0ZXJpYWxzCiAgICAgICAgICAgIGdvYWxCLnRyYXZlcnNlKGMgPT4gewogICAgICAgICAgICAgICAgaWYoYy5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICBjLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoYy5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsID0gYy5tYXRlcmlhbC5jbG9uZSgpOyAvLyBDbG9uZSBhZ2FpbiBmb3IgQgogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLnRyYW5zcGFyZW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5kZXB0aFdyaXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgX3NjZW5lLmFkZChnb2FsQik7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdvYWxCID0gZ29hbEI7IC8vIEV4cG9zZSBmb3IgRGV2VG9vbHMKICAgICAgICB9OwoKICAgICAgICB3aW5kb3cuZmx1eC5Bc3NldExvYWRlci5sb2FkTW9kZWwoZ29hbFVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgb25Hb2FsTG9hZGVkKGdsdGYuc2NlbmUsIGZhbHNlKTsKICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJHb2FsIG1vZGVsIGZhaWxlZCB0byBsb2FkLiBVc2luZyBmYWxsYmFjay4iLCBlcnIpOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoNzUsIDQ1LCAxMCk7IC8vIEZhbGxiYWNrIG1hc3NpdmUgYm94IChTY2FsZWQgMS41eCkKICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHhmZmZmZmYsIHdpcmVmcmFtZTogdHJ1ZSB9KTsKICAgICAgICAgICAgY29uc3QgZmFsbGJhY2sgPSBuZXcgVEhSRUUuTWVzaChnZW8sIGZhbGxiYWNrTWF0KTsKICAgICAgICAgICAgb25Hb2FsTG9hZGVkKGZhbGxiYWNrLCB0cnVlKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gLS0tIE5FVzogTUFTU0lWRSBGSUVMRCBNQVJLSU5HUyAtLS0KICAgICAgICBjcmVhdGVGaWVsZE1hcmtpbmdzKCk7CiAgICB9CgpmdW5jdGlvbiBjcmVhdGVGaWVsZE1hcmtpbmdzKCkgewogICAgICAgIC8vIExvYWQgZmxvb3IgZ2x5cGggZnJvbSBpbWFnZQogICAgICAgIGNvbnN0IHRleExvYWRlciA9IG5ldyBUSFJFRS5UZXh0dXJlTG9hZGVyKCk7CiAgICAgICAgY29uc3QgdGV4ID0gdGV4TG9hZGVyLmxvYWQoJ2h0dHBzOi8vaS5wb3N0aW1nLmNjL3Y4Q1I4NWRRL0Zsb29yZ2x5cGgucG5nJyk7CiAgICAgICAgdGV4LmFuaXNvdHJvcHkgPSAxNjsKCiAgICAgICAgLy8gRmxvb3IgUGxhbmUgKERlZXApCiAgICAgICAgY29uc3QgZ2VvID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoOTAsIDkwKTsKICAgICAgICBjb25zdCBtYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoewogICAgICAgICAgICBtYXA6IHRleCwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgIG9wYWNpdHk6IDAuMzUsCiAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZwogICAgICAgIH0pOwoKICAgICAgICBjb25zdCBmaWVsZCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgbWF0KTsKICAgICAgICBmaWVsZC5yb3RhdGlvbi54ID0gLU1hdGguUEkgLyAyOwogICAgICAgIGZpZWxkLnBvc2l0aW9uLnkgPSAtOC4wOyAvLyBTdW5rIGRlZXAKICAgICAgICBfc2NlbmUuYWRkKGZpZWxkKTsKCiAgICAgICAgLy8gU3RvcmUgcmVmZXJlbmNlcyBmb3IgRGV2VG9vbHMKICAgICAgICB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWVzaCA9IGZpZWxkOwogICAgICAgIHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQgPSBtYXQ7CiAgICB9CgpmdW5jdGlvbiBjcmVhdGVIb2xvZ3JhcGhpY1JpbmdzKCkgewogICAgICAgIC8vIEZsb2F0aW5nIEhvbG9ncmFwaGljIFJpbmdzIChNaWQtaGVpZ2h0KQogICAgICAgIGNvbnN0IHJpbmdHZW8gPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgyMCwgMC4xLCAxNiwgMTAwKTsKICAgICAgICBjb25zdCByaW5nTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZmZmLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4zLCBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZyB9KTsKICAgICAgICBjb25zdCByaW5nMSA9IG5ldyBUSFJFRS5NZXNoKHJpbmdHZW8sIHJpbmdNYXQpOwogICAgICAgIHJpbmcxLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICByaW5nMS5wb3NpdGlvbi55ID0gMDsKICAgICAgICBfc2NlbmUuYWRkKHJpbmcxKTsKICAgICAgICAKICAgICAgICBjb25zdCByaW5nMiA9IG5ldyBUSFJFRS5NZXNoKHJpbmdHZW8sIHJpbmdNYXQpOwogICAgICAgIHJpbmcyLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICByaW5nMi5zY2FsZS5zZXRTY2FsYXIoMS4yKTsKICAgICAgICByaW5nMi5wb3NpdGlvbi55ID0gNC4wOwogICAgICAgIF9zY2VuZS5hZGQocmluZzIpOwoKICAgICAgICAvLyBBbmltYXRlIFJpbmdzIChpbnRlZ3JhdGVkIGludG8gbWFpbiBsb29wIHRvIGF2b2lkIGEgc2Vjb25kIFJBRiBvbiBtb2JpbGUpCmxldCBfcmluZ1RpbWUgPSAwOwogICAgICAgIGNvbnN0IF9yaW5nVXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIF9yaW5nVGltZSArPSBkdDsKICAgICAgICAgICAgaWYgKHJpbmcxKSB7CiAgICAgICAgICAgICAgICByaW5nMS5yb3RhdGlvbi56ICs9IGR0ICogMC45OwogICAgICAgICAgICAgICAgcmluZzEuc2NhbGUuc2V0U2NhbGFyKDEuMCArIE1hdGguc2luKF9yaW5nVGltZSAqIDAuNSkgKiAwLjA1KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmluZzIpIHsKICAgICAgICAgICAgICAgIHJpbmcyLnJvdGF0aW9uLnogLT0gZHQgKiAwLjc1OwogICAgICAgICAgICAgICAgcmluZzIucG9zaXRpb24ueSA9IDQuMCArIE1hdGguY29zKF9yaW5nVGltZSAqIDAuNykgKiAxLjA7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGlmICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzKSB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLnB1c2goX3JpbmdVcGRhdGUpOwogICAgfQoKICAgIC8vIC0tLSBJTlBVVCBTWVNURU0gLS0tCi8vIC0tLSBJTlBVVCBTWVNURU0gLS0tCmNvbnN0IF9rZXlzID0ge307Ci8vIEdsb2JhbHMgbW92ZWQgdG8gYmVsb3cgaGVscGVyCgogICAgLy8gSGVscGVyOiBBbmFseXplIGN1cnZlIGdlb21ldHJ5IGZvciBhbmFsb2cgY29udHJvbAogICAgY29uc3QgYW5hbHl6ZVN3aXBlQ3VydmUgPSAocG9pbnRzKSA9PiB7CiAgICAgICAgaWYgKHBvaW50cy5sZW5ndGggPCAzKSByZXR1cm4geyBpbnRlbnNpdHk6IDAsIHNwZWVkOiAwLCBkeDogMCwgZHk6IDAgfTsKICAgICAgICAKICAgICAgICBjb25zdCBwU3RhcnQgPSBwb2ludHNbMF07CiAgICAgICAgY29uc3QgcEVuZCA9IHBvaW50c1twb2ludHMubGVuZ3RoIC0gMV07CiAgICAgICAgY29uc3QgbWlkSWR4ID0gTWF0aC5mbG9vcihwb2ludHMubGVuZ3RoIC8gMik7CiAgICAgICAgY29uc3QgcE1pZCA9IHBvaW50c1ttaWRJZHhdOwoKICAgICAgICBjb25zdCBkeCA9IHBFbmQueCAtIHBTdGFydC54OwogICAgICAgIGNvbnN0IGR5ID0gcEVuZC55IC0gcFN0YXJ0Lnk7CiAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKICAgICAgICBjb25zdCBkdCA9IHBFbmQudCAtIHBTdGFydC50OwogICAgICAgIGNvbnN0IHNwZWVkID0gKGR0ID4gMCkgPyBkaXN0IC8gZHQgOiAwOyAvLyBweC9tcwoKICAgICAgICBpZiAoZGlzdCA8IDUwKSByZXR1cm4geyBpbnRlbnNpdHk6IDAsIHNwZWVkOiBzcGVlZCwgZHgsIGR5IH07CgogICAgICAgIGNvbnN0IHZTTV94ID0gcE1pZC54IC0gcFN0YXJ0Lng7CiAgICAgICAgY29uc3QgdlNNX3kgPSBwTWlkLnkgLSBwU3RhcnQueTsKCiAgICAgICAgLy8gQ3Jvc3MgcHJvZHVjdCBnaXZlcyBzaWduZWQgYXJlYS9jdXJ2YXR1cmUgZGlyZWN0aW9uCiAgICAgICAgY29uc3QgY3Jvc3MgPSAoZHggKiB2U01feSkgLSAoZHkgKiB2U01feCk7CiAgICAgICAgLy8gTm9ybWFsaXplIGJ5IGRpc3RhbmNlIHNxdWFyZWQgdG8gZ2V0IGEgY3VydmF0dXJlIHJhdGlvIGluZGVwZW5kZW50IG9mIHNjYWxlCmNvbnN0IGludGVuc2l0eSA9IGNyb3NzIC8gKGRpc3QgKiBkaXN0KTsKCiAgICAgICAgcmV0dXJuIHsgaW50ZW5zaXR5LCBzcGVlZCwgZHgsIGR5IH07CiAgICB9OwogICAgbGV0IF9zd2lwZVBvaW50cyA9IFtdOyAvLyBUcmFjayBzd2lwZSBoaXN0b3J5IGZvciBjdXJ2ZXMKICAgIGNvbnN0IF9haW1JbnB1dCA9IHsgeDogMCwgeTogMCwgYWN0aXZlOiBmYWxzZSB9OyAvLyBORVc6IEFpbSBqb3lzdGljawoKICAgIGNvbnN0IF9hY3Rpb25CdWZmZXIgPSB7IGFjdGl2ZTogZmFsc2UsIHRpbWVzdGFtcDogMCwgZHVyYXRpb246IDMwMCB9OwoKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF91cEF4aXMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKTsKCmZ1bmN0aW9uIHNldHVwSW5wdXRzKCkgewogICAgICAgIC8vIFNraXAgSW50cm8gTGlzdGVuZXIKICAgICAgICBjb25zdCBza2lwSGFuZGxlciA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPT09ICdpbnRybycpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5za2lwSW50cm8oKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHNraXBIYW5kbGVyKTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHNraXBIYW5kbGVyLCB7cGFzc2l2ZTogdHJ1ZX0pOwoKICAgICAgICAvLyBLZXlib2FyZAogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgX2tleXNbZS5rZXldID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ1NwYWNlJyAmJiBfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllciAmJiBfYmFsbCkgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci50aHJvd0JhbGwoX2JhbGwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE5FVzogVGFja2xlIG9uIFNoaWZ0CiAgICAgICAgICAgIGlmIChlLmNvZGUgPT09ICdTaGlmdExlZnQnIHx8IGUuY29kZSA9PT0gJ1NoaWZ0UmlnaHQnKSB7CiAgICAgICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBwLmRhc2gocC5pbnB1dFZlY3Rvci54LCBwLmlucHV0VmVjdG9yLnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVJbnB1dFZlY3RvcigpOwogICAgICAgIH0pOwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIChlKSA9PiB7IF9rZXlzW2Uua2V5XSA9IGZhbHNlOyB1cGRhdGVJbnB1dFZlY3RvcigpOyB9KTsKCiAgICAgICAgLy8gLS0tIEZMT0FUSU5HIEpPWVNUSUNLIChNb3ZlbWVudCkgLS0tCiAgICAgICAgY29uc3QgaGl0Wm9uZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3lzdGljay1oaXQtem9uZScpOwogICAgICAgIGNvbnN0IHZpc3VhbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2stdmlzdWFsLWNvbnRhaW5lcicpOwogICAgICAgIGNvbnN0IGJhc2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2stYmFzZScpOwogICAgICAgIGNvbnN0IGtub2IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2sta25vYicpOwoKICAgICAgICBsZXQgc3RhcnRYID0gMCwgc3RhcnRZID0gMDsKICAgICAgICBsZXQgZHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICBjb25zdCBtYXhEaXN0ID0gNDA7CgogICAgICAgIGxldCBtb3ZlVG91Y2hJZCA9IG51bGw7CiAgICAgICAgY29uc3QgbW92ZURlYWR6b25lUHggPSA2OwoKICAgICAgICAvLyBFeHBvc2UgbW92ZSBqb3lzdGljayBzdGF0ZSBmb3Igc25hcHNob3RzCiAgICAgICAgY29uc3QgX2RiZyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPID0gd2luZG93LmZsdXguX2RlYnVnSU8gfHwge307CiAgICAgICAgX2RiZy5zZXR0aW5ncyA9IF9zZXR0aW5nczsKICAgICAgICBfZGJnLmlucHV0ID0gX2RiZy5pbnB1dCB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUgPSBfZGJnLmlucHV0Lm1vdmUgfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLnZlY3RvciA9IF9pbnB1dDsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUuZHJhZ2dpbmcgPSBkcmFnZ2luZzsKICAgICAgICBfZGJnLmlucHV0Lm1vdmUudG91Y2hJZCA9IG1vdmVUb3VjaElkOwoKCiAgICAgICAgY29uc3QgaGFuZGxlU3RhcnQgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBkcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHN0YXJ0WCA9IGNsaWVudFg7CgogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQubW92ZSkgewogICAgICAgICAgICAgICAgX2RiZy5pbnB1dC5tb3ZlLmRyYWdnaW5nID0gZHJhZ2dpbmc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN0YXJ0WSA9IGNsaWVudFk7CgogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICB2aXN1YWxzLnN0eWxlLmxlZnQgPSBgJHtjbGllbnRYfXB4YDsKICAgICAgICAgICAgdmlzdWFscy5zdHlsZS50b3AgPSBgJHtjbGllbnRZfXB4YDsKCiAgICAgICAgICAgIGtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgtNTAlLCAtNTAlKWA7CgogICAgICAgICAgICBjcmVhdGVSaXBwbGUoY2xpZW50WCwgY2xpZW50WSk7CgogICAgICAgICAgICBfaW5wdXQueCA9IDA7CiAgICAgICAgICAgIF9pbnB1dC55ID0gMDsKICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVNb3ZlID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGR4ID0gY2xpZW50WCAtIHN0YXJ0WDsKICAgICAgICAgICAgbGV0IGR5ID0gY2xpZW50WSAtIHN0YXJ0WTsKCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgoKICAgICAgICAgICAgLy8gRGVhZHpvbmUgdG8gcHJldmVudCBkcmlmdCBmcm9tIHRpbnkgdGh1bWIgaml0dGVyCiAgICAgICAgICAgIGlmIChkaXN0IDwgbW92ZURlYWR6b25lUHgpIHsKICAgICAgICAgICAgICAgIGR4ID0gMDsKICAgICAgICAgICAgICAgIGR5ID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRpc3QgPiBtYXhEaXN0KSB7CiAgICAgICAgICAgICAgICBkeCA9IChkeCAvIGRpc3QpICogbWF4RGlzdDsKICAgICAgICAgICAgICAgIGR5ID0gKGR5IC8gZGlzdCkgKiBtYXhEaXN0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBrbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoY2FsYygtNTAlICsgJHtkeH1weCksIGNhbGMoLTUwJSArICR7ZHl9cHgpKWA7CgogICAgICAgICAgICBfaW5wdXQueCA9IChkeCAvIG1heERpc3QpICogX3NldHRpbmdzLmpveXN0aWNrU2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIF9pbnB1dC55ID0gKGR5IC8gbWF4RGlzdCkgKiBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eTsKICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVFbmQgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgZHJhZ2dpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIG1vdmVUb3VjaElkID0gbnVsbDsKCiAgICAgICAgICAgIHZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKCiAgICAgICAgICAgIGlmIChfZGJnICYmIF9kYmcuaW5wdXQgJiYgX2RiZy5pbnB1dC5tb3ZlKSB7CiAgICAgICAgICAgICAgICBfZGJnLmlucHV0Lm1vdmUuZHJhZ2dpbmcgPSBkcmFnZ2luZzsKICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS50b3VjaElkID0gbW92ZVRvdWNoSWQ7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBfaW5wdXQueCA9IDA7CiAgICAgICAgICAgIF9pbnB1dC55ID0gMDsKICAgICAgICAgICAgdXBkYXRlSW5wdXRWZWN0b3IoKTsKICAgICAgICB9OwoKICAgICAgICBpZiAoaGl0Wm9uZSkgewogICAgICAgICAgICBoaXRab25lLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXNbMF0pID8gZS5jaGFuZ2VkVG91Y2hlc1swXSA6IGUudG91Y2hlc1swXTsKICAgICAgICAgICAgICAgIG1vdmVUb3VjaElkID0gdCA/IHQuaWRlbnRpZmllciA6IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQubW92ZSkgewogICAgICAgICAgICAgICAgICAgIF9kYmcuaW5wdXQubW92ZS50b3VjaElkID0gbW92ZVRvdWNoSWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBoYW5kbGVTdGFydCh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmICghZHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIG1vdmVUb3VjaElkKTsKICAgICAgICAgICAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICAgICAgICAgICAgaGFuZGxlTW92ZSh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBtb3ZlVG91Y2hJZCk7CiAgICAgICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsgLy8gSWdub3JlIG90aGVyIGZpbmdlcnMgbGlmdGluZwogICAgICAgICAgICAgICAgaGFuZGxlRW5kKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBtb3ZlVG91Y2hJZCk7CiAgICAgICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsKICAgICAgICAgICAgICAgIGhhbmRsZUVuZCgpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGhpdFpvbmUuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGhhbmRsZVN0YXJ0KGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGRyYWdnaW5nKSBoYW5kbGVNb3ZlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBORVc6IEFJTSBKT1lTVElDSyAoUmlnaHQgc2lkZSkgLS0tCiAgICAgICAgc2V0dXBBaW1Kb3lzdGljaygpOwoKICAgICAgICAvLyAtLS0gTkVXOiBUQUNLTEUgQlVUVE9OIC0tLQogICAgICAgIHNldHVwVGFja2xlQnV0dG9uKCk7CgogICAgICAgIC8vIFN3aXBlIERldGVjdGlvbgovLyBTd2lwZSBEZXRlY3Rpb24KICAgICAgICBsZXQgc3dpcGVTdGFydCA9IHsgeDogMCwgeTogMCwgdDogMCB9OwogICAgICAgIGxldCBzd2lwZVRvdWNoSWQgPSBudWxsOwogICAgICAgIAogICAgICAgIC8vIEV4cG9zZSBzd2lwZS90aHJvdyBnZXN0dXJlIHN0YXRlIGZvciBzbmFwc2hvdHMKICAgICAgICBfZGJnLmlucHV0LnN3aXBlID0gX2RiZy5pbnB1dC5zd2lwZSB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0LnN3aXBlLnN0YXJ0ID0gc3dpcGVTdGFydDsKICAgICAgICBfZGJnLmlucHV0LnN3aXBlLnRvdWNoSWQgPSBzd2lwZVRvdWNoSWQ7CiAgICAgICAgX2RiZy5pbnB1dC5zd2lwZS5wb2ludHMgPSBfc3dpcGVQb2ludHM7CmNvbnN0IG9uU3dpcGVTdGFydCA9ICh4LCB5KSA9PiB7CiAgICAgICAgICAgIHN3aXBlU3RhcnQueCA9IHg7CiAgICAgICAgICAgIHN3aXBlU3RhcnQueSA9IHk7CiAgICAgICAgICAgIHN3aXBlU3RhcnQudCA9IERhdGUubm93KCk7CiAgICAgICAgICAgIF9zd2lwZVBvaW50cyA9IFt7eCwgeSwgdDogRGF0ZS5ub3coKX1dOwogICAgICAgIH07Cgpjb25zdCBvblN3aXBlTW92ZSA9ICh4LCB5KSA9PiB7CiAgICAgICAgICAgIGlmIChfc3dpcGVQb2ludHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgX3N3aXBlUG9pbnRzLnB1c2goe3gsIHksIHQ6IERhdGUubm93KCl9KTsKICAgICAgICAgICAgICAgIGNyZWF0ZVN3aXBlVHJhaWxEb3QoeCwgeSk7IC8vIFZpc3VhbCBGZWVkYmFjawogICAgICAgICAgICB9CiAgICAgICAgfTsKCmNvbnN0IG9uU3dpcGVFbmQgPSAoeCwgeSkgPT4gewogICAgICAgICAgICBpZiAoX3N3aXBlUG9pbnRzLmxlbmd0aCA8IDIpIHJldHVybjsKICAgICAgICAgICAgX3N3aXBlUG9pbnRzLnB1c2goe3gsIHksIHQ6IERhdGUubm93KCl9KTsKCiAgICAgICAgICAgIGNvbnN0IHsgaW50ZW5zaXR5LCBzcGVlZCwgZHgsIGR5IH0gPSBhbmFseXplU3dpcGVDdXJ2ZShfc3dpcGVQb2ludHMpOwogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwoKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyICYmIF9jYW1lcmEpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgICAgIC8vIC0tLSBDVVJWRSBCQUxMIERFVEVDVElPTiAoSW1tZWRpYXRlIFRocm93KSAtLS0KLy8gLS0tIENVUlZFIEJBTEwgREVURUNUSU9OIChJbW1lZGlhdGUgVGhyb3cpIC0tLQogICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCAmJiAhcC5pc1Rocm93aW5nICYmICFwLmlzQ2hhcmdpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBBbmFsb2cgQ3VydmUgQ2hlY2s6IFRocmVzaG9sZCAwLjI1IHJlcXVpcmVzIGEgZGVsaWJlcmF0ZSBhcmMgKFRoZSAiRmVhdCIpCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGludGVuc2l0eSkgPiAwLjI1ICYmIGRpc3QgPiAxMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2NhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhfY2FtRndkLCBfdXBBeGlzKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWCA9IChfY2FtUmlnaHQueCAqIGR4KSArIChfY2FtRndkLnggKiAtZHkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoX2NhbVJpZ2h0LnogKiBkeCkgKyAoX2NhbUZ3ZC56ICogLWR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGhyb3dEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMyh3b3JsZFgsIDAsIHdvcmxkWikubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBNYXAgaW50ZW5zaXR5IHRvIHNwaW4gLSBEcmFzdGljYWxseSByZWR1Y2VkIHNlbnNpdGl2aXR5CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhd1NwaW4gPSBNYXRoLmFicyhpbnRlbnNpdHkpICogMzAwLjA7IAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGVlZEZhY3RvciA9IE1hdGgubWluKDEuNSwgc3BlZWQgLyAxLjApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluUG93ZXIgPSBNYXRoLm1pbig0MDAuMCwgcmF3U3BpbiAqIHNwZWVkRmFjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblNpZ24gPSBNYXRoLnNpZ24oaW50ZW5zaXR5KTsgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5WZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCBzcGluUG93ZXIgKiBzcGluU2lnbiwgMCk7CgoKICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRPdmVycmlkZUFpbSh0aHJvd0Rpci54LCB0aHJvd0Rpci56KTsKICAgICAgICAgICAgICAgICAgICAgICAgcC50aHJvd0JhbGwod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGwsICdTSCcsIDEuMCwgc3BpblZlYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQ1VSVkUiLCBwLm1lc2gucG9zaXRpb24sICJ0ZWNoIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlUmlwcGxlKHgsIHkpOwogICAgICAgICAgICAgICAgICAgICAgICBfc3dpcGVQb2ludHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOyAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gLS0tIFNUQU5EQVJEIERBU0ggLyBBSU0gLS0tCiAgICAgICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICAgICAgZWxzZSBfY2FtRndkLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7Cgpjb25zdCB3b3JsZFgyID0gKF9jYW1SaWdodC54ICogZHgpICsgKF9jYW1Gd2QueCAqIC1keSk7CiAgICAgICAgICAgICAgICBjb25zdCB3b3JsZFoyID0gKF9jYW1SaWdodC56ICogZHgpICsgKF9jYW1Gd2QueiAqIC1keSk7CgogICAgICAgICAgICAgICAgaWYgKHAuaXNUaHJvd2luZykgewpwLnNldE92ZXJyaWRlQWltKHdvcmxkWDIsIHdvcmxkWjIpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkFJTSEiLCBwLm1lc2gucG9zaXRpb24sICJkZWZhdWx0Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKaWYgKGRpc3QgPiA1MCkgcC5kYXNoKHdvcmxkWDIsIHdvcmxkWjIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNyZWF0ZVJpcHBsZSh4LCB5KTsKICAgICAgICAgICAgfQpfc3dpcGVQb2ludHMgPSBbXTsKICAgICAgICB9OwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHQgPSAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzWzBdKSA/IGUuY2hhbmdlZFRvdWNoZXNbMF0gOiBlLnRvdWNoZXNbMF07CiAgICAgICAgICAgIHN3aXBlVG91Y2hJZCA9IHQgPyB0LmlkZW50aWZpZXIgOiBudWxsOwovLyBvblN3aXBlU3RhcnQodC5jbGllbnRYLCB0LmNsaWVudFkpOyAvLyBGaXhlZCBzeW50YXggZXJyb3IKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LnN3aXBlKSB7IF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsgfQogICAgICAgICAgICBvblN3aXBlU3RhcnQodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgICAgICBjcmVhdGVSaXBwbGUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7Cgp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJyNqb3lzdGljay1oaXQtem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWN0aW9uLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjdGFja2xlLWJ1dHRvbicpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYWltLWpveXN0aWNrLXpvbmUnKSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB0ID0gX2ZpbmRUb3VjaEJ5SWQoZS50b3VjaGVzLCBzd2lwZVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgb25Td2lwZU1vdmUodC5jbGllbnRYLCB0LmNsaWVudFkpOwogICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBzd2lwZVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsgLy8gSWdub3JlIG90aGVyIGZpbmdlcnMgbGlmdGluZwogICAgICAgICAgICBvblN3aXBlRW5kKHRFbmQuY2xpZW50WCwgdEVuZC5jbGllbnRZKTsKICAgICAgICAgICAgc3dpcGVUb3VjaElkID0gbnVsbDsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LnN3aXBlKSB7IF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsgfQogICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIChlKSA9PiB7CmlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhdXRvLXRvZ2dsZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjc2V0dGluZ3MtYnV0dG9uJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBzd2lwZVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsgLy8gSWdub3JlIG90aGVyIGZpbmdlcnMgbGlmdGluZwogICAgICAgICAgICBvblN3aXBlRW5kKHRFbmQuY2xpZW50WCwgdEVuZC5jbGllbnRZKTsKICAgICAgICAgICAgc3dpcGVUb3VjaElkID0gbnVsbDsKICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LnN3aXBlKSB7IF9kYmcuaW5wdXQuc3dpcGUudG91Y2hJZCA9IHN3aXBlVG91Y2hJZDsgfQogICAgICAgIAogICAgICAgIH0pOwovLyBNb3VzZSBTd2lwZQogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CgogICAgICAgICAgICBvblN3aXBlU3RhcnQoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICBjcmVhdGVSaXBwbGUoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcjam95c3RpY2staGl0LXpvbmUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FjdGlvbi1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3RhY2tsZS1idXR0b24nKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI2FpbS1qb3lzdGljay16b25lJykpIHJldHVybjsKICAgICAgICAgICAgLy8gT25seSB0cmFjayBpZiBtb3VzZSBpcyBkb3duIChzaW11bGF0aW5nIGRyYWcpCiAgICAgICAgICAgIGlmIChlLmJ1dHRvbnMgPT09IDEpIHsKICAgICAgICAgICAgICAgIG9uU3dpcGVNb3ZlKGUuY2xpZW50WCwgZS5jbGllbnRZKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnI2pveXN0aWNrLWhpdC16b25lJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhY3Rpb24tYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyN0YWNrbGUtYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGUudGFyZ2V0LmNsb3Nlc3QoJyNhaW0tam95c3RpY2stem9uZScpIHx8CiAgICAgICAgICAgICAgICBlLnRhcmdldC5jbG9zZXN0KCcjYXV0by10b2dnbGUnKSB8fAogICAgICAgICAgICAgICAgZS50YXJnZXQuY2xvc2VzdCgnI3NldHRpbmdzLWJ1dHRvbicpKSByZXR1cm47CiAgICAgICAgICAgIG9uU3dpcGVFbmQoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBBY3Rpb24gQnV0dG9uIChTaG9vdC9QYXNzKQogICAgICAgIGNvbnN0IGFjdGlvbkJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY3Rpb24tYnV0dG9uJyk7Cgpjb25zdCBzZXR1cEJ1dHRvbiA9IChidG4pID0+IHsKICAgICAgICAgICAgaWYgKCFidG4pIHJldHVybjsKCiAgICAgICAgICAgIGxldCBidG5TdGFydFggPSAwOwogICAgICAgICAgICBsZXQgYnRuU3RhcnRZID0gMDsKICAgICAgICAgICAgbGV0IGlzRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgbGV0IHN3aXBlUG9pbnRzID0gW107CiAgICAgICAgICAgIGxldCBhY3Rpb25Ub3VjaElkID0gbnVsbDsKCiAgICAgICAgICAgIGNvbnN0IGF0dGVtcHRBY3Rpb24gPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIV9ob21lVGVhbSB8fCAhX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CgogICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCAmJiAhcC5pc0NoYXJnaW5nICYmICFwLmlzVGhyb3dpbmcgJiYgcC5zdGF0dXMubmFwIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBwLnN0YXJ0Q2hhcmdlKCk7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgaGFuZGxlU3RhcnQgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLnRlY2hDb3B5U3RhdGUuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLmF0dGVtcHRUZWNoQ29weSgpOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSwgMTAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaXNEZW1vTW9kZSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGxldCBjbGllbnRYID0gZS5jbGllbnRYOwogICAgICAgICAgICAgICAgbGV0IGNsaWVudFkgPSBlLmNsaWVudFk7CiAgICAgICAgICAgICAgICBpZiAoZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBlLmNoYW5nZWRUb3VjaGVzWzBdOwogICAgICAgICAgICAgICAgICAgIGFjdGlvblRvdWNoSWQgPSB0LmlkZW50aWZpZXI7CiAgICAgICAgICAgICAgICAgICAgY2xpZW50WCA9IHQuY2xpZW50WDsKICAgICAgICAgICAgICAgICAgICBjbGllbnRZID0gdC5jbGllbnRZOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBhY3Rpb25Ub3VjaElkID0gbnVsbDsgLy8gbW91c2UKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJ0blN0YXJ0WCA9IGNsaWVudFg7CiAgICAgICAgICAgICAgICBidG5TdGFydFkgPSBjbGllbnRZOwogICAgICAgICAgICAgICAgaXNEcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICBzd2lwZVBvaW50cyA9IFt7eDogY2xpZW50WCwgeTogY2xpZW50WSwgdDogRGF0ZS5ub3coKX1dOwoKICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIudGltZXN0YW1wID0gRGF0ZS5ub3coKTsKCiAgICAgICAgICAgICAgICBpZiAoYXR0ZW1wdEFjdGlvbigpKSB7CiAgICAgICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBdHRhY2ggZ2xvYmFsIGxpc3RlbmVycyB0byB0cmFjayBzd2lwZSBvdXRzaWRlIGJ1dHRvbgogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGhhbmRsZU1vdmUsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBoYW5kbGVNb3ZlKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGNvbnN0IGhhbmRsZU1vdmUgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFpc0RyYWdnaW5nKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gVG91Y2ggcGF0aCAobXVsdGktdG91Y2ggc2FmZSkKICAgICAgICAgICAgICAgIGlmIChlLnRvdWNoZXMgJiYgYWN0aW9uVG91Y2hJZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIGFjdGlvblRvdWNoSWQpOwogICAgICAgICAgICAgICAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIHN3aXBlUG9pbnRzLnB1c2goe3g6IHQuY2xpZW50WCwgeTogdC5jbGllbnRZLCB0OiBEYXRlLm5vdygpfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE1vdXNlIHBhdGgKICAgICAgICAgICAgICAgIGNvbnN0IGNsaWVudFggPSBlLmNsaWVudFg7CiAgICAgICAgICAgICAgICBjb25zdCBjbGllbnRZID0gZS5jbGllbnRZOwogICAgICAgICAgICAgICAgc3dpcGVQb2ludHMucHVzaCh7eDogY2xpZW50WCwgeTogY2xpZW50WSwgdDogRGF0ZS5ub3coKX0pOwogICAgICAgICAgICB9OwoKY29uc3QgaGFuZGxlRW5kID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIGxldCBkeCA9IDA7CiAgICAgICAgICAgICAgICBsZXQgZHkgPSAwOwogICAgICAgICAgICAgICAgbGV0IHZhbGlkRW5kID0gZmFsc2U7CgogICAgICAgICAgICAgICAgLy8gMS4gQ2hlY2sgVG91Y2gKICAgICAgICAgICAgICAgIGlmIChlLmNoYW5nZWRUb3VjaGVzICYmIGFjdGlvblRvdWNoSWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIGFjdGlvblRvdWNoSWQpOwogICAgICAgICAgICAgICAgICAgIGlmICh0RW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGR4ID0gdEVuZC5jbGllbnRYIC0gYnRuU3RhcnRYOwogICAgICAgICAgICAgICAgICAgICAgICBkeSA9IHRFbmQuY2xpZW50WSAtIGJ0blN0YXJ0WTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRFbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25Ub3VjaElkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgLy8gMi4gQ2hlY2sgTW91c2UKICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFlLmNoYW5nZWRUb3VjaGVzICYmIGlzRHJhZ2dpbmcpIHsKICAgICAgICAgICAgICAgICAgICBkeCA9IGUuY2xpZW50WCAtIGJ0blN0YXJ0WDsKICAgICAgICAgICAgICAgICAgICBkeSA9IGUuY2xpZW50WSAtIGJ0blN0YXJ0WTsKICAgICAgICAgICAgICAgICAgICB2YWxpZEVuZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCF2YWxpZEVuZCkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIC8vIENsZWFudXAgbGlzdGVuZXJzCiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgaGFuZGxlTW92ZSk7CiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBoYW5kbGVFbmQpOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgaGFuZGxlRW5kKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBoYW5kbGVNb3ZlKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRW5kKTsKCiAgICAgICAgICAgICAgICBpZiAoIWlzRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgd2FzQnVmZmVyZWQgPSBfYWN0aW9uQnVmZmVyLmFjdGl2ZTsKICAgICAgICAgICAgICAgIF9hY3Rpb25CdWZmZXIuYWN0aXZlID0gZmFsc2U7CgogICAgICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IF9ob21lVGVhbS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ3VydmUgQW5hbHlzaXMKICAgICAgICAgICAgICAgICAgICBsZXQgY3VydmVEYXRhID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBsZXQgc3BpblZlYyA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBjdXJ2ZSBpZiB3ZSBoYXZlIGVub3VnaCBkYXRhCi8vIENhbGN1bGF0ZSBjdXJ2ZSBpZiB3ZSBoYXZlIGVub3VnaCBkYXRhCiAgICAgICAgICAgICAgICAgICAgaWYgKHN3aXBlUG9pbnRzLmxlbmd0aCA+IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5hbHlzaXMgPSBhbmFseXplU3dpcGVDdXJ2ZShzd2lwZVBvaW50cyk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhpZ2ggdGhyZXNob2xkIGZvciBidXR0b24gcmVsZWFzZSB0b28KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGFuYWx5c2lzLmludGVuc2l0eSkgPiAwLjI1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJ2ZURhdGEgPSBhbmFseXNpczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIHNwaW4gdmVjdG9yIGZvciBtb3VzZS90b3VjaCB1bmlmaWVkIChDb25zZXJ2YXRpdmUgdmFsdWVzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblBvd2VyID0gTWF0aC5taW4oNDAwLjAsIE1hdGguYWJzKGFuYWx5c2lzLmludGVuc2l0eSkgKiAxNTAwLjApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BpblNpZ24gPSBNYXRoLnNpZ24oYW5hbHlzaXMuaW50ZW5zaXR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwaW5WZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCBzcGluUG93ZXIgKiBzcGluU2lnbiwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KfQoKICAgICAgICAgICAgICAgICAgICAvLyBFWEVDVVRFCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaXNDaGFyZ2luZykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWwgUmVsZWFzZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3BpblZlYykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVW5pZmllZCBzcGluIHBhc3NpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAucmVsZWFzZUNoYXJnZShkeCwgZHksIHsgaW50ZW5zaXR5OiBjdXJ2ZURhdGEuaW50ZW5zaXR5LCBzcGVlZDogY3VydmVEYXRhLnNwZWVkIH0pOyAKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAucmVsZWFzZUNoYXJnZShkeCwgZHksIGN1cnZlRGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAod2FzQnVmZmVyZWQgJiYgcC5oYXNCYWxsICYmICFwLmlzVGhyb3dpbmcgJiYgcC5zdGF0dXMubmFwIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQnVmZmVyZWQgVGFwIChJbnN0YW50IFNob3QpCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvcmNlIHN0YXJ0IGFuZCByZWxlYXNlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcC5yZWxlYXNlQ2hhcmdlKGR4LCBkeSwgY3VydmVEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlU3RhcnQsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBoYW5kbGVTdGFydCk7CiAgICAgICAgfTsKICAgICAgICBzZXR1cEJ1dHRvbihhY3Rpb25CdG4pOwoKLy8gQXV0byBUb2dnbGUKICAgICAgICBjb25zdCBhdXRvQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F1dG8tdG9nZ2xlJyk7CiAgICAgICAgaWYgKGF1dG9CdG4pIHsKICAgICAgICAgICAgY29uc3QgaGFuZGxlVG9nZ2xlID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIF9nYW1lTWFuYWdlci50b2dnbGVEZW1vTW9kZSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGF1dG9CdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBoYW5kbGVUb2dnbGUpOwphdXRvQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgaGFuZGxlVG9nZ2xlKCk7CiAgICAgICAgICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IFNldHRpbmdzIEJ1dHRvbgogICAgICAgIHNldHVwU2V0dGluZ3NCdXR0b24oKTsKICAgIH0KCiAgICAvLyBORVc6IEFpbSBKb3lzdGljayBTZXR1cAovLyBORVc6IEFpbSBKb3lzdGljayBTZXR1cApmdW5jdGlvbiBzZXR1cEFpbUpveXN0aWNrKCkgewogICAgICAgIGNvbnN0IGFpbUtub2IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWltLWpveXN0aWNrLWtub2InKTsKICAgICAgICBjb25zdCBhaW1WaXN1YWxzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1qb3lzdGljay12aXN1YWwnKTsKICAgICAgICBjb25zdCBhaW1ab25lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpbS1qb3lzdGljay16b25lJyk7CiAgICAgICAgaWYgKCFhaW1ab25lKSByZXR1cm47CiAgICAgICAgbGV0IGFpbVN0YXJ0WCA9IDAsIGFpbVN0YXJ0WSA9IDA7CiAgICAgICAgbGV0IGFpbURyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgY29uc3QgYWltTWF4RGlzdCA9IDM1OwogICAgICAgIGxldCBhaW1Ub3VjaElkID0gbnVsbDsKCiAgICAgICAgCgogICAgICAgIC8vIEV4cG9zZSBhaW0gam95c3RpY2sgc3RhdGUgZm9yIHNuYXBzaG90cwogICAgICAgIGNvbnN0IF9kYmcgPSB3aW5kb3cuZmx1eC5fZGVidWdJTyA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPIHx8IHt9OwogICAgICAgIF9kYmcuc2V0dGluZ3MgPSBfc2V0dGluZ3M7CiAgICAgICAgX2RiZy5pbnB1dCA9IF9kYmcuaW5wdXQgfHwge307CiAgICAgICAgX2RiZy5pbnB1dC5haW0gPSBfZGJnLmlucHV0LmFpbSB8fCB7fTsKICAgICAgICBfZGJnLmlucHV0LmFpbS52ZWN0b3IgPSBfYWltSW5wdXQ7CiAgICAgICAgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsKICAgICAgICBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsKY29uc3QgaGFuZGxlQWltU3RhcnQgPSAoY2xpZW50WCwgY2xpZW50WSkgPT4gewogICAgICAgICAgICBhaW1EcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgIGFpbVN0YXJ0WCA9IGNsaWVudFg7CgogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLmRyYWdnaW5nID0gYWltRHJhZ2dpbmc7IH0KCiAgICAgICAgICAgIGFpbVN0YXJ0WSA9IGNsaWVudFk7CiAgICAgICAgICAgIF9haW1JbnB1dC5hY3RpdmUgPSB0cnVlOwoKICAgICAgICAgICAgaWYgKGFpbVZpc3VhbHMpIHsKICAgICAgICAgICAgICAgIGFpbVZpc3VhbHMuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLmxlZnQgPSBgJHtjbGllbnRYfXB4YDsKICAgICAgICAgICAgICAgIGFpbVZpc3VhbHMuc3R5bGUudG9wID0gYCR7Y2xpZW50WX1weGA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGFpbUtub2IpIHsKICAgICAgICAgICAgICAgIGFpbUtub2Iuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgtNTAlLCAtNTAlKWA7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjb25zdCBoYW5kbGVBaW1Nb3ZlID0gKGNsaWVudFgsIGNsaWVudFkpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IGR4ID0gY2xpZW50WCAtIGFpbVN0YXJ0WDsKICAgICAgICAgICAgbGV0IGR5ID0gY2xpZW50WSAtIGFpbVN0YXJ0WTsKCiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeSpkeSk7CgogICAgICAgICAgICBpZiAoZGlzdCA+IGFpbU1heERpc3QpIHsKICAgICAgICAgICAgICAgIGR4ID0gKGR4IC8gZGlzdCkgKiBhaW1NYXhEaXN0OwogICAgICAgICAgICAgICAgZHkgPSAoZHkgLyBkaXN0KSAqIGFpbU1heERpc3Q7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhaW1Lbm9iKSB7CiAgICAgICAgICAgICAgICBhaW1Lbm9iLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoY2FsYygtNTAlICsgJHtkeH1weCksIGNhbGMoLTUwJSArICR7ZHl9cHgpKWA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSBhbmQgdHJhbnNmb3JtIHRvIHdvcmxkIHNwYWNlCiAgICAgICAgICAgIF9haW1JbnB1dC54ID0gZHggLyBhaW1NYXhEaXN0OwogICAgICAgICAgICBfYWltSW5wdXQueSA9IGR5IC8gYWltTWF4RGlzdDsKCiAgICAgICAgICAgIC8vIEFwcGx5IGFpbSB0byBwbGF5ZXIgaWYgY2hhcmdpbmcKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gX2hvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIGlmIChwLmlzQ2hhcmdpbmcgfHwgcC5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVHJhbnNmb3JtIHNjcmVlbiBhaW0gdG8gd29ybGQgc3BhY2UKICAgICAgICAgICAgICAgICAgICBfY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKF9jYW1Gd2QpOwogICAgICAgICAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9jYW1Gd2QubGVuZ3RoU3EoKSA8IDAuMDAxKSBfY2FtRndkLnNldCgwLCAwLCAtMSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBfY2FtRndkLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWCA9IChfY2FtUmlnaHQueCAqIF9haW1JbnB1dC54KSArIChfY2FtRndkLnggKiAtX2FpbUlucHV0LnkpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmxkWiA9IChfY2FtUmlnaHQueiAqIF9haW1JbnB1dC54KSArIChfY2FtRndkLnogKiAtX2FpbUlucHV0LnkpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMod29ybGRYKSA+IDAuMSB8fCBNYXRoLmFicyh3b3JsZFopID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0T3ZlcnJpZGVBaW0od29ybGRYLCB3b3JsZFopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07Cgpjb25zdCBoYW5kbGVBaW1FbmQgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgYWltRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgX2FpbUlucHV0LmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICBfYWltSW5wdXQueCA9IDA7CiAgICAgICAgICAgIF9haW1JbnB1dC55ID0gMDsKCiAgICAgICAgICAgIGlmIChhaW1WaXN1YWxzKSB7CiAgICAgICAgICAgICAgICBhaW1WaXN1YWxzLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENsZWFyIHBsYXllciBhaW0gb3ZlcnJpZGUKICAgICAgICAgICAgaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0uYWN0aXZlUGxheWVyLm92ZXJyaWRlQWltVmVjdG9yID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGFpbVpvbmUuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChlLmNhbmNlbGFibGUpIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgY29uc3QgdCA9IChlLmNoYW5nZWRUb3VjaGVzICYmIGUuY2hhbmdlZFRvdWNoZXNbMF0pID8gZS5jaGFuZ2VkVG91Y2hlc1swXSA6IGUudG91Y2hlc1swXTsKICAgICAgICAgICAgYWltVG91Y2hJZCA9IHQgPyB0LmlkZW50aWZpZXIgOiBudWxsOwogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLnRvdWNoSWQgPSBhaW1Ub3VjaElkOyB9CiAgICAgICAgICAgIGhhbmRsZUFpbVN0YXJ0KHQuY2xpZW50WCwgdC5jbGllbnRZKTsKICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBpZiAoZS5jYW5jZWxhYmxlKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGNvbnN0IHQgPSBfZmluZFRvdWNoQnlJZChlLnRvdWNoZXMsIGFpbVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXQpIHJldHVybjsKICAgICAgICAgICAgaGFuZGxlQWltTW92ZSh0LmNsaWVudFgsIHQuY2xpZW50WSk7CiAgICAgICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgKGUpID0+IHsKICAgICAgICAgICAgaWYgKCFhaW1EcmFnZ2luZykgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB0RW5kID0gX2VuZGVkVG91Y2hCeUlkKGUuY2hhbmdlZFRvdWNoZXMsIGFpbVRvdWNoSWQpOwogICAgICAgICAgICBpZiAoIXRFbmQpIHJldHVybjsKICAgICAgICAgICAgYWltVG91Y2hJZCA9IG51bGw7CiAgICAgICAgICAgIGhhbmRsZUFpbUVuZCgpOwogICAgICAgICAgICBpZiAoX2RiZyAmJiBfZGJnLmlucHV0ICYmIF9kYmcuaW5wdXQuYWltKSB7IF9kYmcuaW5wdXQuYWltLnRvdWNoSWQgPSBhaW1Ub3VjaElkOyBfZGJnLmlucHV0LmFpbS5kcmFnZ2luZyA9IGFpbURyYWdnaW5nOyB9CiAgICAgICAgICAgIGhhbmRsZUFpbUVuZCgpOwogICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIChlKSA9PiB7CiAgICAgICAgICAgIGlmICghYWltRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdEVuZCA9IF9lbmRlZFRvdWNoQnlJZChlLmNoYW5nZWRUb3VjaGVzLCBhaW1Ub3VjaElkKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0RW5kKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGFpbVRvdWNoSWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVBaW1FbmQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9kYmcgJiYgX2RiZy5pbnB1dCAmJiBfZGJnLmlucHV0LmFpbSkgeyBfZGJnLmlucHV0LmFpbS50b3VjaElkID0gYWltVG91Y2hJZDsgX2RiZy5pbnB1dC5haW0uZHJhZ2dpbmcgPSBhaW1EcmFnZ2luZzsgfQogICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVBaW1FbmQoKTsKICAgICAgICB9KTsKLy8gTW91c2Ugc3VwcG9ydCBmb3IgZGVza3RvcCB0ZXN0aW5nCiAgICAgICAgYWltWm9uZS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoZSkgPT4gewogICAgICAgICAgICBoYW5kbGVBaW1TdGFydChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIChlKSA9PiB7CiAgICAgICAgICAgIGlmIChhaW1EcmFnZ2luZykgaGFuZGxlQWltTW92ZShlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgfSk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCAoZSkgPT4gewogICAgICAgICAgICBpZiAoYWltRHJhZ2dpbmcpIGhhbmRsZUFpbUVuZCgpOwogICAgICAgIH0pOwogICAgfQoKICAgIC8vIE5FVzogVGFja2xlIEJ1dHRvbiBTZXR1cAogICAgZnVuY3Rpb24gc2V0dXBUYWNrbGVCdXR0b24oKSB7CiAgICAgICAgY29uc3QgdGFja2xlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RhY2tsZS1idXR0b24nKTsKICAgICAgICBpZiAoIXRhY2tsZUJ0bikgcmV0dXJuOwoKY29uc3QgaGFuZGxlVGFja2xlID0gKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUuY2FuY2VsYWJsZSkgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyAvLyBQcmV2ZW50IGJ1YmJsaW5nIHRvIGpveXN0aWNrCgogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyICYmIF9nYW1lTWFuYWdlci5pc0RlbW9Nb2RlKSByZXR1cm47CgogICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjayBpbW1lZGlhdGVseQogICAgICAgICAgICAgICAgdGFja2xlQnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0YWNrbGVCdG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyksIDE1MCk7CgogICAgICAgICAgICAgICAgLy8gSWYgd2UgZG9uJ3QgaGF2ZSB0aGUgYmFsbCwgZGFzaC90YWNrbGUKICAgICAgICAgICAgICAgIGlmICghcC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gR2V0IGN1cnJlbnQgbW92ZW1lbnQgZGlyZWN0aW9uIG9yIGZvcndhcmQKICAgICAgICAgICAgICAgICAgICBsZXQgZGFzaFggPSBwLmlucHV0VmVjdG9yLng7CiAgICAgICAgICAgICAgICAgICAgbGV0IGRhc2haID0gcC5pbnB1dFZlY3Rvci56OwoKICAgICAgICAgICAgICAgICAgICAvLyBJZiBub3QgbW92aW5nLCBkYXNoIGZvcndhcmQgcmVsYXRpdmUgdG8gcGxheWVyIGZhY2luZwogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhkYXNoWCkgPCAwLjEgJiYgTWF0aC5hYnMoZGFzaFopIDwgMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihwLm1lc2gucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhc2hYID0gZndkLng7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhc2haID0gZndkLno7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBwLmRhc2goZGFzaFgsIGRhc2haKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT25seSBzaG93IHRleHQgaWYgZGFzaCBhY3R1YWxseSBoYXBwZW5lZCAoY29vbGRvd24gY2hlY2sgaW5zaWRlIGRhc2gpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLmlzRGFzaGluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiVEFDS0xFISIsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocC5pc0VuZ2FnZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBCcmVhayB0YWNrbGUgaWYgZW5nYWdlZAogICAgICAgICAgICAgICAgICAgIHAuZGFzaChwLmlucHV0VmVjdG9yLngsIHAuaW5wdXRWZWN0b3Iueik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB0YWNrbGVCdG4uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGhhbmRsZVRhY2tsZSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICB0YWNrbGVCdG4uYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgaGFuZGxlVGFja2xlKTsKICAgIH0KCiAgICAvLyBORVc6IFNldHRpbmdzIEJ1dHRvbiBTZXR1cAovLyBORVc6IFNldHRpbmdzIEJ1dHRvbiBTZXR1cApmdW5jdGlvbiBzZXR1cFNldHRpbmdzQnV0dG9uKCkgewogICAgICAgIGNvbnN0IHNldHRpbmdzQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NldHRpbmdzLWJ1dHRvbicpOwogICAgICAgIGNvbnN0IHNldHRpbmdzUGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2V0dGluZ3MtcGFuZWwnKTsKICAgICAgICBjb25zdCBzZXR0aW5nc0Nsb3NlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NldHRpbmdzLWNsb3NlJyk7CgogICAgICAgIGlmICghc2V0dGluZ3NCdG4gfHwgIXNldHRpbmdzUGFuZWwpIHJldHVybjsKCiAgICAgICAgc2V0dGluZ3NCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgIHNldHRpbmdzUGFuZWwuc3R5bGUuZGlzcGxheSA9IHNldHRpbmdzUGFuZWwuc3R5bGUuZGlzcGxheSA9PT0gJ25vbmUnID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICB9KTsKCiAgICAgICAgaWYgKHNldHRpbmdzQ2xvc2UpIHsKICAgICAgICAgICAgc2V0dGluZ3NDbG9zZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgICAgIHNldHRpbmdzUGFuZWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBTZW5zaXRpdml0eSBzbGlkZXIKICAgICAgICBjb25zdCBzZW5zaXRpdml0eVNsaWRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZW5zaXRpdml0eS1zbGlkZXInKTsKICAgICAgICBpZiAoc2Vuc2l0aXZpdHlTbGlkZXIpIHsKICAgICAgICAgICAgc2Vuc2l0aXZpdHlTbGlkZXIudmFsdWUgPSBfc2V0dGluZ3Muam95c3RpY2tTZW5zaXRpdml0eSAqIDEwMDsKICAgICAgICAgICAgc2Vuc2l0aXZpdHlTbGlkZXIuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoZSkgPT4gewogICAgICAgICAgICAgICAgX3NldHRpbmdzLmpveXN0aWNrU2Vuc2l0aXZpdHkgPSBlLnRhcmdldC52YWx1ZSAvIDEwMDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBBaW0gYXNzaXN0IHRvZ2dsZQogICAgICAgIGNvbnN0IGFpbUFzc2lzdFRvZ2dsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaW0tYXNzaXN0LXRvZ2dsZScpOwogICAgICAgIGlmIChhaW1Bc3Npc3RUb2dnbGUpIHsKICAgICAgICAgICAgYWltQXNzaXN0VG9nZ2xlLmNoZWNrZWQgPSBfc2V0dGluZ3MuYWltQXNzaXN0OwogICAgICAgICAgICBhaW1Bc3Npc3RUb2dnbGUuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIF9zZXR0aW5ncy5haW1Bc3Npc3QgPSBlLnRhcmdldC5jaGVja2VkOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIENhbWVyYSBzaGFrZSB0b2dnbGUKICAgICAgICBjb25zdCBzaGFrZVRvZ2dsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzaGFrZS10b2dnbGUnKTsKICAgICAgICBpZiAoc2hha2VUb2dnbGUpIHsKICAgICAgICAgICAgc2hha2VUb2dnbGUuY2hlY2tlZCA9IF9zZXR0aW5ncy5jYW1lcmFTaGFrZTsKICAgICAgICAgICAgc2hha2VUb2dnbGUuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIF9zZXR0aW5ncy5jYW1lcmFTaGFrZSA9IGUudGFyZ2V0LmNoZWNrZWQ7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gVm9sdW1lIHNsaWRlcgogICAgICAgIGNvbnN0IHZvbHVtZVNsaWRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd2b2x1bWUtc2xpZGVyJyk7CiAgICAgICAgaWYgKHZvbHVtZVNsaWRlciAmJiBfYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgIHZvbHVtZVNsaWRlci5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB2b2wgPSBlLnRhcmdldC52YWx1ZSAvIDEwMDsKX2F1ZGlvTWFuYWdlci5zZXRNYXN0ZXJWb2x1bWUodm9sKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBFeGl0IHRvIE1lbnUKICAgICAgICBjb25zdCBleGl0QnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2V4aXQtdG8tbWVudS1idG4nKTsKICAgICAgICBpZiAoZXhpdEJ0bikgewogICAgICAgICAgICBleGl0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKF9tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIF9tZW51TWFuYWdlci5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9nYW1lTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICBfZ2FtZU1hbmFnZXIuc3RhdGUgPSAnbWVudSc7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgcHJhY3RpY2UgaWYgcnVubmluZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2dhbWVNYW5hZ2VyLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3NQYW5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlSW5wdXRWZWN0b3IoKSB7CiAgICAgICAgbGV0IHggPSBfaW5wdXQueCB8fCAwOwogICAgICAgIGxldCB6ID0gX2lucHV0LnkgfHwgMDsKCiAgICAgICAgaWYgKF9rZXlzWyd3J10gfHwgX2tleXNbJ0Fycm93VXAnXSkgeiAtPSAxOwogICAgICAgIGlmIChfa2V5c1sncyddIHx8IF9rZXlzWydBcnJvd0Rvd24nXSkgeiArPSAxOwogICAgICAgIGlmIChfa2V5c1snYSddIHx8IF9rZXlzWydBcnJvd0xlZnQnXSkgeCAtPSAxOwogICAgICAgIGlmIChfa2V5c1snZCddIHx8IF9rZXlzWydBcnJvd1JpZ2h0J10pIHggKz0gMTsKCiAgICAgICAgY29uc3QgbGVuU3EgPSB4KnggKyB6Kno7CiAgICAgICAgaWYgKGxlblNxID4gMSkgewogICAgICAgICAgICBjb25zdCBsZW4gPSBNYXRoLnNxcnQobGVuU3EpOwogICAgICAgICAgICB4IC89IGxlbjsKICAgICAgICAgICAgeiAvPSBsZW47CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNOYU4oeCkpIHggPSAwOwogICAgICAgIGlmIChpc05hTih6KSkgeiA9IDA7CgogICAgICAgIGlmIChfY2FtZXJhKSB7CiAgICAgICAgICAgIF9jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CgogICAgICAgICAgICBpZiAoX2NhbUZ3ZC5sZW5ndGhTcSgpIDwgMC4wMDEpIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Quc2V0KDAsIDAsIC0xKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jYW1Gd2Qubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jYW1SaWdodC5jcm9zc1ZlY3RvcnMoX2NhbUZ3ZCwgX3VwQXhpcykubm9ybWFsaXplKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICBfY2FtUmlnaHQuc2V0KDEsIDAsIDApOwogICAgICAgIH0KCiAgICAgICAgbGV0IHdvcmxkWCA9IChfY2FtRndkLnggKiAteikgKyAoX2NhbVJpZ2h0LnggKiB4KTsKICAgICAgICBsZXQgd29ybGRaID0gKF9jYW1Gd2QueiAqIC16KSArIChfY2FtUmlnaHQueiAqIHgpOwoKICAgICAgICBpZiAoaXNOYU4od29ybGRYKSB8fCBpc05hTih3b3JsZFopKSB7CiAgICAgICAgICAgIHdvcmxkWCA9IDA7CiAgICAgICAgICAgIHdvcmxkWiA9IDA7CiAgICAgICAgfQoKaWYgKF9ob21lVGVhbSAmJiBfaG9tZVRlYW0uYWN0aXZlUGxheWVyKSB7CiAgICAgICAgICAgIC8vIEZJWDogT25seSBhbGxvdyBtb3ZlbWVudCBpZiBnYW1lIGlzIGFjdGl2ZSBvciBpbiBwcmFjdGljZQogICAgICAgICAgICBjb25zdCBnbSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgY2FuTW92ZSA9IGdtICYmICFnbS5pc0RlbW9Nb2RlICYmIChnbS5zdGF0ZSA9PT0gJ2FjdGl2ZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGNhbk1vdmUpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS5hY3RpdmVQbGF5ZXIuc2V0SW5wdXQod29ybGRYLCB3b3JsZFopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2hvbWVUZWFtLmFjdGl2ZVBsYXllci5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZVJpcHBsZSh4LCB5KSB7CiAgICAgICAgY29uc3QgcmlwcGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgcmlwcGxlLmNsYXNzTmFtZSA9ICd0b3VjaC1yaXBwbGUnOwogICAgICAgIHJpcHBsZS5zdHlsZS5sZWZ0ID0gYCR7eH1weGA7CiAgICAgICAgcmlwcGxlLnN0eWxlLnRvcCA9IGAke3l9cHhgOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpLmFwcGVuZENoaWxkKHJpcHBsZSk7CgogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAocmlwcGxlLnBhcmVudE5vZGUpIHJpcHBsZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHJpcHBsZSk7CiAgICAgICAgfSwgNjAwKTsKCiAgICB9CgogICAgLy8gTkVXOiBWaXN1YWwgU3dpcGUgVHJhaWwKICAgIGZ1bmN0aW9uIGNyZWF0ZVN3aXBlVHJhaWxEb3QoeCwgeSkgewogICAgICAgIGNvbnN0IGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIGRvdC5jbGFzc05hbWUgPSAnc3dpcGUtdHJhaWwtZG90JzsKICAgICAgICBkb3Quc3R5bGUubGVmdCA9IGAke3ggLSA2fXB4YDsgLy8gQ2VudGVyICgxMnB4IHdpZHRoKQogICAgICAgIGRvdC5zdHlsZS50b3AgPSBgJHt5IC0gNn1weGA7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJykuYXBwZW5kQ2hpbGQoZG90KTsKICAgICAgICAKICAgICAgICAvLyBDU1MgYW5pbWF0aW9uIGhhbmRsZXMgcmVtb3ZhbCwgYnV0IHdlIGNsZWFuIHVwIERPTSB0byBiZSBzYWZlCiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGlmIChkb3QucGFyZW50Tm9kZSkgZG90LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZG90KTsKICAgICAgICB9LCA1MDApOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uUmVzaXplKCkgewogICAgICAgIGNvbnN0IHdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgIAogICAgICAgIGlmIChfY2FtZXJhKSB7CiAgICAgICAgICAgIF9jYW1lcmEuYXNwZWN0ID0gd2lkdGggLyBoZWlnaHQ7CiAgICAgICAgICAgIF9jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBTdHJpY3RseSAwLjUwIGFzIHJlcXVlc3RlZAogICAgICAgIGNvbnN0IHJlc1NjYWxlID0gMC41MDsKICAgICAgICAKICAgICAgICBfY29uZmlnLmludGVybmFsV2lkdGggPSBNYXRoLmZsb29yKHdpZHRoICogcmVzU2NhbGUpOwogICAgICAgIF9jb25maWcuaW50ZXJuYWxIZWlnaHQgPSBNYXRoLmZsb29yKGhlaWdodCAqIHJlc1NjYWxlKTsKCiAgICAgICAgaWYgKF9yZW5kZXJlcikgewogICAgICAgICAgICBfcmVuZGVyZXIuc2V0U2l6ZShfY29uZmlnLmludGVybmFsV2lkdGgsIF9jb25maWcuaW50ZXJuYWxIZWlnaHQsIGZhbHNlKTsKICAgICAgICB9CiAgICB9CgovLyAtLS0gRklYRUQgVElNRVNURVAgVkFSSUFCTEVTIC0tLQogICAgbGV0IF9hY2N1bXVsYXRvciA9IDA7CiAgICBjb25zdCBfZml4ZWRTdGVwID0gMSAvIDYwOwoKICAgIGZ1bmN0aW9uIGFuaW1hdGUoKSB7CiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwoKICAgICAgICBjb25zdCByYXdEdCA9IF9jbG9jay5nZXREZWx0YSgpOwogICAgICAgIC8vIENsYW1wIGR0IHRvIHByZXZlbnQgc3BpcmFscyAobWF4IDAuMXMpCiAgICAgICAgY29uc3QgZHQgPSBNYXRoLm1pbihyYXdEdCwgMC4xKSAqICh3aW5kb3cuZmx1eC50aW1lU2NhbGUgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA6IDAuOCk7CgogICAgICAgIC8vIFBlcmYgc3RhdHMgZm9yIERldlRvb2xzCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPICYmIHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPLnBlcmYpIHsKICAgICAgICAgICAgY29uc3QgcGVyZiA9IHdpbmRvdy5mbHV4Ll9kZWJ1Z0lPLnBlcmY7CiAgICAgICAgICAgIHBlcmYuZnJhbWUgPSAocGVyZi5mcmFtZSB8fCAwKSArIDE7CiAgICAgICAgICAgIHBlcmYucmF3RHQgPSByYXdEdDsKICAgICAgICAgICAgcGVyZi5kdCA9IGR0OwogICAgICAgICAgICBjb25zdCBmcHMgPSBkdCA+IDAgPyAoMSAvIGR0KSA6IDA7CiAgICAgICAgICAgIHBlcmYuZnBzID0gZnBzOwogICAgICAgICAgICBwZXJmLmF2Z0ZwcyA9IChwZXJmLmF2Z0ZwcyAmJiBwZXJmLmF2Z0ZwcyA+IDApID8gKHBlcmYuYXZnRnBzICogMC45ICsgZnBzICogMC4xKSA6IGZwczsKICAgICAgICB9CgogICAgICAgIC8vIEltcGFjdCBGcmFtZXMgKEZyZWV6ZSBGcmFtZSBFZmZlY3QpCiAgICAgICAgaWYgKF9nYW1lTWFuYWdlciAmJiBfZ2FtZU1hbmFnZXIuaW1wYWN0UGF1c2UgPiAwKSB7CiAgICAgICAgICAgIF9nYW1lTWFuYWdlci5pbXBhY3RQYXVzZSAtPSBkdDsKICAgICAgICAgICAgaWYgKF9yZW5kZXJlciAmJiBfc2NlbmUgJiYgX2NhbWVyYSkgewogICAgICAgICAgICAgICAgX3JlbmRlcmVyLnJlbmRlcihfc2NlbmUsIF9jYW1lcmEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUlucHV0VmVjdG9yKCk7CgogICAgICAgIC8vIEFjdGlvbiBCdWZmZXIgUHJvY2Vzc2luZwogICAgICAgIGlmIChfYWN0aW9uQnVmZmVyLmFjdGl2ZSkgewogICAgICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIF9hY3Rpb25CdWZmZXIudGltZXN0YW1wID4gX2FjdGlvbkJ1ZmZlci5kdXJhdGlvbikgewogICAgICAgICAgICAgICAgX2FjdGlvbkJ1ZmZlci5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChfaG9tZVRlYW0gJiYgX2hvbWVUZWFtLmFjdGl2ZVBsYXllcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwogICAgICAgICAgICAgICAgICAgIGlmIChwLmhhc0JhbGwgJiYgIXAuaXNDaGFyZ2luZyAmJiAhcC5pc1Rocm93aW5nICYmIHAuc3RhdHVzLm5hcCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhcnRDaGFyZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1idXR0b24nKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ0bikgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBfYWN0aW9uQnVmZmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIEZJWEVEIFVQREFURSBMT09QIChQaHlzaWNzICYgR2FtZSBMb2dpYykgLS0tCiAgICAgICAgX2FjY3VtdWxhdG9yICs9IGR0OwogICAgICAgIC8vIFNhZmV0eSBDYXA6IFByZXZlbnQgc3BpcmFsIG9mIGRlYXRoIGlmIGZyYW1lIHRha2VzIHRvbyBsb25nCiAgICAgICAgaWYgKF9hY2N1bXVsYXRvciA+IDAuMikgX2FjY3VtdWxhdG9yID0gMC4yOwoKICAgICAgICB3aGlsZSAoX2FjY3VtdWxhdG9yID49IF9maXhlZFN0ZXApIHsKICAgICAgICAgICAgY29uc3QgX3NkdCA9IF9maXhlZFN0ZXA7CgogICAgICAgICAgICBpZiAoX2dhbWVNYW5hZ2VyKSBfZ2FtZU1hbmFnZXIudXBkYXRlKF9zZHQpOwoKICAgICAgICAgICAgLy8gSWYgaW4gQXNzZXQgRm9yZ2UgbW9kZSwgc2tpcCBnYW1lIGxvZ2ljCiAgICAgICAgICAgIGlmIChfZ2FtZU1hbmFnZXIgJiYgX2dhbWVNYW5hZ2VyLmlzRm9yZ2VNb2RlKSB7CiAgICAgICAgICAgICAgICBfYWNjdW11bGF0b3IgPSAwOyAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ21TdGF0ZSA9IF9nYW1lTWFuYWdlciA/IF9nYW1lTWFuYWdlci5zdGF0ZSA6ICcnOwogICAgICAgICAgICBjb25zdCBpc0ludHJvID0gZ21TdGF0ZSA9PT0gJ2ludHJvJzsKICAgICAgICAgICAgY29uc3QgaXNNZW51ID0gZ21TdGF0ZSA9PT0gJ21lbnUnOwoKICAgICAgICAgICAgLy8gVXBkYXRlIEVudGl0aWVzIChQaHlzaWNzL0FJKQogICAgICAgICAgICBpZiAoX2hvbWVUZWFtICYmICFpc0ludHJvICYmICFpc01lbnUpIHsKICAgICAgICAgICAgICAgIF9ob21lVGVhbS51cGRhdGUoX3NkdCk7CiAgICAgICAgICAgICAgICBfaG9tZVRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gY2hlY2tCYWxsR3JhYihwKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChfYXdheVRlYW0gJiYgIWlzSW50cm8gJiYgIWlzTWVudSkgewogICAgICAgICAgICAgICAgX2F3YXlUZWFtLnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgICAgIF9hd2F5VGVhbS5wbGF5ZXJzLmZvckVhY2gocCA9PiBjaGVja0JhbGxHcmFiKHApKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKF9iYWxsICYmICFpc0ludHJvICYmICFpc01lbnUpIHsKICAgICAgICAgICAgICAgIF9iYWxsLnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmFsbCBMYWIKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWIgJiYgdHlwZW9mIHdpbmRvdy5mbHV4LmJhbGxMYWIudXBkYXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5iYWxsTGFiLnVwZGF0ZShfc2R0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUnVudGltZSBVcGRhdGVycyAoZS5nLiBSaW5ncyBsb2dpYykKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4Ll9ydW50aW1lVXBkYXRlcnMgJiYgd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVycy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IHVpID0gMDsgdWkgPCB3aW5kb3cuZmx1eC5fcnVudGltZVVwZGF0ZXJzLmxlbmd0aDsgdWkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZuID0gd2luZG93LmZsdXguX3J1bnRpbWVVcGRhdGVyc1t1aV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJykgZm4oX3NkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9hY2N1bXVsYXRvciAtPSBfZml4ZWRTdGVwOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIFZJU1VBTCBVUERBVEUgTE9PUCAoT25jZSBQZXIgRnJhbWUpIC0tLQogICAgICAgIC8vIFRoZXNlIHN5c3RlbXMgZG9uJ3QgYWZmZWN0IGdhbWVwbGF5IG91dGNvbWUsIHNvIHdlIHVwZGF0ZSB0aGVtIHdpdGggdGhlIHZpc3VhbCBkZWx0YSBgZHRgCiAgICAgICAgLy8gdG8gZW5zdXJlIHNtb290aCBhbmltYXRpb24gYXQgaGlnaCByZWZyZXNoIHJhdGVzICg5MC8xMjBIeikgd2l0aG91dCB3YXN0aW5nIENQVSBvbiBwaHlzaWNzLgoKICAgICAgICBjb25zdCBnbVN0YXRlID0gX2dhbWVNYW5hZ2VyID8gX2dhbWVNYW5hZ2VyLnN0YXRlIDogJyc7CiAgICAgICAgY29uc3QgaXNJbnRybyA9IGdtU3RhdGUgPT09ICdpbnRybyc7CiAgICAgICAgY29uc3QgaXNNZW51ID0gZ21TdGF0ZSA9PT0gJ21lbnUnOwoKICAgICAgICAvLyBDYW1lcmEKICAgICAgICBpZiAoIWlzSW50cm8gJiYgIWlzTWVudSkgewogICAgICAgICAgICB1cGRhdGVDYW1lcmFMb2dpYyhkdCk7CiAgICAgICAgfQoKICAgICAgICAvLyBWaXN1YWwgRlggU3lzdGVtcwogICAgICAgIGlmIChfd2F0ZXJPdmVybGF5KSBfd2F0ZXJPdmVybGF5LnVwZGF0ZShkdCk7CiAgICAgICAgaWYgKF9saWdodFNoYWZ0cykgX2xpZ2h0U2hhZnRzLnVwZGF0ZShkdCk7CiAgICAgICAgaWYgKF9zdGFkaXVtKSBfc3RhZGl1bS51cGRhdGUoZHQpOwogICAgICAgIGlmIChfZ2x5cGhNYW5hZ2VyKSBfZ2x5cGhNYW5hZ2VyLnVwZGF0ZShkdCk7CgppZiAoX2dseXBoTWFuYWdlcikgX2dseXBoTWFuYWdlci51cGRhdGUoZHQpOwogICAgICAgIGlmIChfZ2FtZU1hbmFnZXIpIF9nYW1lTWFuYWdlci51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICBpZiAoX2FyZW5hVW5pZm9ybXMpIHsKICAgICAgICAgICAgX2FyZW5hVW5pZm9ybXMudVRpbWUudmFsdWUgKz0gZHQ7CiAgICAgICAgICAgIF9hcmVuYVVuaWZvcm1zLnVJbXBhY3RTdHIudmFsdWUgKj0gTWF0aC5tYXgoMCwgMS4wIC0gZHQgKiA0LjApOwogICAgICAgIH0KCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hR3JvdXApIHsKICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFHcm91cC5yb3RhdGlvbi55ICs9IGR0ICogMC4wNTsKICAgICAgICB9CgogICAgICAgIGlmICh3aW5kb3cuZmx1eC50cmliYWxVbmlmb3JtcykgewogICAgICAgICAgICB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgbGV0IHRhcmdldENvbG9yID0gbmV3IFRIUkVFLkNvbG9yKDB4MDBmZmZmKTsKICAgICAgICAgICAgaWYgKF9iYWxsICYmIF9iYWxsLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKF9iYWxsLmhvbGRlci50ZWFtICYmIF9iYWxsLmhvbGRlci50ZWFtLnNpZGUgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Q29sb3Iuc2V0SGV4KDB4ZmY4ODAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3aW5kb3cuZmx1eC50cmliYWxVbmlmb3Jtcy51Q29sb3IudmFsdWUubGVycCh0YXJnZXRDb2xvciwgZHQgKiAyLjApOwogICAgICAgIH0KCiAgICAgICAgaWYgKF9wYXJ0aWNsZVVuaWZvcm1zKSB7CiAgICAgICAgICAgIF9wYXJ0aWNsZVVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgIH0KCiAgICAgICAgLy8gUmVuZGVyCiAgICAgICAgaWYgKF9yZW5kZXJlciAmJiBfc2NlbmUgJiYgX2NhbWVyYSkgewogICAgICAgICAgICBfcmVuZGVyZXIucmVuZGVyKF9zY2VuZSwgX2NhbWVyYSk7CiAgICAgICAgfQoKICAgICAgICAvLyBVSSBVcGRhdGVzCiAgICAgICAgdXBkYXRlVUkoKTsKICAgIH0KCmZ1bmN0aW9uIHVwZGF0ZVVJKCkgewogICAgICAgIC8vIFByZXZlbnQgVUkgdXBkYXRlcyBkdXJpbmcgaW50cm8gdG8ga2VlcCB0aGluZ3MgaGlkZGVuCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPT09ICdpbnRybycpIHJldHVybjsKCiAgICAgICAgaWYgKCFfaG9tZVRlYW0gfHwgIV9ob21lVGVhbS5hY3RpdmVQbGF5ZXIpIHJldHVybjsKICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWJ1dHRvbicpOwogICAgICAgIGNvbnN0IGxibCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY3Rpb24tbGFiZWwnKTsKICAgICAgICBjb25zdCB0YWNrbGVCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGFja2xlLWJ1dHRvbicpOwogICAgICAgIGNvbnN0IHAgPSBfaG9tZVRlYW0uYWN0aXZlUGxheWVyOwoKICAgICAgICBpZiAoYnRuICYmIGxibCkgewogICAgICAgICAgICBjb25zdCBidG5UZXh0ID0gYnRuLnF1ZXJ5U2VsZWN0b3IoJy5idG4tdGV4dCcpOwoKICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgaWYgKGJ0blRleHQgJiYgYnRuVGV4dC5pbm5lclRleHQgIT09ICJBQ1RJT04iKSB7CiAgICAgICAgICAgICAgICAgICAgYnRuVGV4dC5pbm5lclRleHQgPSAiQUNUSU9OIjsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnc2hvb3QtbW9kZScpOwogICAgICAgICAgICAgICAgICAgIGxibC5pbm5lclRleHQgPSAiT0ZGRU5TRSI7CiAgICAgICAgICAgICAgICAgICAgbGJsLmNsYXNzTGlzdC5hZGQoJ3Nob290LWxhYmVsJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgaXNIaWdoRW5lcmd5ID0gKHAuc3RhdHMuSFAgLyBwLnN0YXRzLm1heEhQKSA+IDAuNDsKICAgICAgICAgICAgICAgIGlmIChpc0hpZ2hFbmVyZ3kpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWJ0bi5jbGFzc0xpc3QuY29udGFpbnMoJ2xpbWl0LXJlYWR5JykpIGJ0bi5jbGFzc0xpc3QuYWRkKCdsaW1pdC1yZWFkeScpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYnRuLmNsYXNzTGlzdC5jb250YWlucygnbGltaXQtcmVhZHknKSkgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2xpbWl0LXJlYWR5Jyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGJ0blRleHQgJiYgYnRuVGV4dC5pbm5lclRleHQgIT09ICJTV0lNIikgewogICAgICAgICAgICAgICAgICAgIGJ0blRleHQuaW5uZXJUZXh0ID0gIlNXSU0iOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdzaG9vdC1tb2RlJyk7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ2xpbWl0LXJlYWR5Jyk7CiAgICAgICAgICAgICAgICAgICAgbGJsLmlubmVyVGV4dCA9ICJOT1JNQUwiOwogICAgICAgICAgICAgICAgICAgIGxibC5jbGFzc0xpc3QucmVtb3ZlKCdzaG9vdC1sYWJlbCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBVcGRhdGUgdGFja2xlIGJ1dHRvbiB2aXNpYmlsaXR5CiAgICAgICAgaWYgKHRhY2tsZUJ0bikgewogICAgICAgICAgICBpZiAoIXAuaGFzQmFsbCB8fCBwLmlzRW5nYWdlZCkgewogICAgICAgICAgICAgICAgdGFja2xlQnRuLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgdGFja2xlIGJ1dHRvbiB0ZXh0IGJhc2VkIG9uIGNvbnRleHQKICAgICAgICAgICAgICAgIGNvbnN0IHRhY2tsZVRleHQgPSB0YWNrbGVCdG4ucXVlcnlTZWxlY3RvcignLmJ0bi10ZXh0Jyk7CiAgICAgICAgICAgICAgICBpZiAodGFja2xlVGV4dCkgewogICAgICAgICAgICAgICAgICAgIGlmIChwLmlzRW5nYWdlZCAmJiBwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFja2xlVGV4dC5pbm5lclRleHQgPSAnQlJFQUsnOwogICAgICAgICAgICAgICAgICAgICAgICB0YWNrbGVCdG4uY2xhc3NMaXN0LmFkZCgndXJnZW50Jyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFja2xlVGV4dC5pbm5lclRleHQgPSAnVEFDS0xFJzsKICAgICAgICAgICAgICAgICAgICAgICAgdGFja2xlQnRuLmNsYXNzTGlzdC5yZW1vdmUoJ3VyZ2VudCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRhY2tsZUJ0bi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBVcGRhdGUgZGlzdGFuY2UgdG8gZ29hbCBpbmRpY2F0b3IKICAgICAgICBjb25zdCBkaXN0SW5kaWNhdG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvYWwtZGlzdGFuY2UnKTsKICAgICAgICBpZiAoZGlzdEluZGljYXRvciAmJiBwLm1lc2gpIHsKICAgICAgICAgICAgY29uc3QgZ29hbFogPSAocC50ZWFtICYmIHAudGVhbS5zaWRlID09PSAxKSA/IC0yOCA6IDI4OwogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5hYnMocC5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgIGRpc3RJbmRpY2F0b3IuaW5uZXJUZXh0ID0gYCR7TWF0aC5mbG9vcihkaXN0KX1tYDsKICAgICAgICB9CiAgICB9CgpmdW5jdGlvbiB1cGRhdGVDYW1lcmFMb2dpYyhkdCkgewogICAgICAgIGlmICghX2NhbWVyYU1hbmFnZXIgfHwgIV9iYWxsKSByZXR1cm47CgogICAgICAgIGxldCB0YXJnZXRNZXNoID0gX2JhbGwubWVzaDsKICAgICAgICBsZXQgdGFyZ2V0VmVsID0gX2JhbGwudmVsb2NpdHk7CiAgICAgICAgbGV0IHRhcmdldElucHV0ID0gbnVsbDsKICAgICAgICBsZXQgaXNBaW1pbmcgPSBmYWxzZTsKCiAgICAgICAgaWYgKF9iYWxsLmhvbGRlciAmJiBfYmFsbC5ob2xkZXIubWVzaCkgewogICAgICAgICAgICB0YXJnZXRNZXNoID0gX2JhbGwuaG9sZGVyLm1lc2g7CiAgICAgICAgICAgIHRhcmdldFZlbCA9IF9iYWxsLmhvbGRlci52ZWxvY2l0eTsKICAgICAgICAgICAgaWYgKF9iYWxsLmhvbGRlci5pbnB1dFZlY3RvcikgewogICAgICAgICAgICAgICAgdGFyZ2V0SW5wdXQgPSBfYmFsbC5ob2xkZXIuaW5wdXRWZWN0b3I7CiAgICAgICAgICAgIH0KLy8gQ2hlY2sgYWltaW5nIHN0YXRlIChDaGFyZ2luZyBvciBUaHJvd2luZykKICAgICAgICAgICAgaWYgKF9iYWxsLmhvbGRlci5pc0NoYXJnaW5nIHx8IF9iYWxsLmhvbGRlci5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICBpc0FpbWluZyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9jYW1lcmFNYW5hZ2VyLnNldFRhcmdldCh0YXJnZXRNZXNoLCB0YXJnZXRWZWwsIHRhcmdldElucHV0LCBpc0FpbWluZyk7CiAgICAgICAgX2NhbWVyYU1hbmFnZXIudXBkYXRlKGR0KTsKICAgIH0KCmZ1bmN0aW9uIGNoZWNrQmFsbEdyYWIoZW50aXR5KSB7CiAgICAgICAgaWYgKCFlbnRpdHkuY2FuQ2F0Y2gpIHJldHVybjsKICAgICAgICBpZiAoX2JhbGwgJiYgIV9iYWxsLmlzQ2F0Y2hhYmxlKCkpIHJldHVybjsKICAgICAgICBpZiAoZW50aXR5LnN0dW5UaW1lciA+IDAgfHwgKGVudGl0eS5zdGF0dXMgJiYgZW50aXR5LnN0YXR1cy5uYXAgPiAwKSkgcmV0dXJuOwogICAgICAgIGlmIChfYmFsbC5zdGF0ZSAhPT0gJ2ZyZWUnKSByZXR1cm47CiAgICAgICAgaWYgKCFfYmFsbC5tZXNoIHx8ICFlbnRpdHkubWVzaCkgcmV0dXJuOwoKICAgICAgICBjb25zdCBiYWxsUG9zID0gX2JhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICBjb25zdCBlbnRQb3MgPSBlbnRpdHkubWVzaC5wb3NpdGlvbjsKCiAgICAgICAgY29uc3QgZHggPSBiYWxsUG9zLnggLSBlbnRQb3MueDsKICAgICAgICBjb25zdCBkeiA9IGJhbGxQb3MueiAtIGVudFBvcy56OwogICAgICAgIGNvbnN0IGRpc3RYWiA9IE1hdGguc3FydChkeCpkeCArIGR6KmR6KTsKICAgICAgICBjb25zdCBkaXN0WSA9IE1hdGguYWJzKGJhbGxQb3MueSAtIGVudFBvcy55KTsKCiAgICAgICAgLy8gLS0tIFJFTEFYRUQgVE9MRVJBTkNFUyBGT1IgRUFTSUVSIFBJQ0tVUCAtLS0KICAgICAgICBjb25zdCB0b3VjaFJhZGl1cyA9IDEuNTsgLy8gSW5jcmVhc2VkIGZyb20gMS4wIChBdXRvLWdyYWIgcmFkaXVzKQogICAgICAgIGxldCBtYWduZXRSYWRpdXMgPSAzLjU7ICAvLyBJbmNyZWFzZWQgZnJvbSAxLjggKE1hZ25ldGljIHJhZGl1cykKICAgICAgICBsZXQgaW50ZXJhY3Rpb25SYWRpdXMgPSA2LjA7IC8vIEluY3JlYXNlZCBmcm9tIDMuNSAoVHVybi10byByYWRpdXMpCiAgICAgICAgbGV0IGNhdGNoSGVpZ2h0ID0gNi4wOyAgIC8vIEluY3JlYXNlZCBmcm9tIDMuMCAoVmVydGljYWwgcmVhY2gpCgogICAgICAgIGlmIChlbnRpdHkuaXNEYXNoaW5nKSB7CiAgICAgICAgICAgIG1hZ25ldFJhZGl1cyA9IDQuNTsKICAgICAgICAgICAgaW50ZXJhY3Rpb25SYWRpdXMgPSA3LjA7CiAgICAgICAgICAgIGNhdGNoSGVpZ2h0ID0gNy4wOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRpc3RYWiA+IGludGVyYWN0aW9uUmFkaXVzIHx8IGRpc3RZID4gY2F0Y2hIZWlnaHQpIHJldHVybjsKCiAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBVc2Ugc2hhcmVkIHZlY3RvcnMgdG8gYXZvaWQgR0MKICAgICAgICBfdGVtcFZlYzEuY29weShiYWxsUG9zKS5zdWIoZW50UG9zKS5ub3JtYWxpemUoKTsgLy8gdG9CYWxsCiAgICAgICAgX3RlbXBWZWMyLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24oZW50aXR5Lm1lc2gucXVhdGVybmlvbikubm9ybWFsaXplKCk7IC8vIHBsYXllckZvcndhcmQKCiAgICAgICAgY29uc3QgZmFjaW5nRG90ID0gX3RlbXBWZWMyLmRvdChfdGVtcFZlYzEpOwoKICAgICAgICBjb25zdCBjb25lVGhyZXNob2xkID0gLTAuNDsgLy8gTW9yZSBnZW5lcm91cyBjb25lICh3YXMgLTAuMikKICAgICAgICBjb25zdCBpc0luQ29uZSA9IGZhY2luZ0RvdCA+IGNvbmVUaHJlc2hvbGQ7CiAgICAgICAgCiAgICAgICAgLy8gQVVUTy1UVVJOOiBJZiBuZWFyIGJ1dCBmYWNpbmcgd3Jvbmcgd2F5LCB0dXJuIHRvd2FyZHMgYmFsbAogICAgICAgIGlmIChkaXN0WFogPCBpbnRlcmFjdGlvblJhZGl1cyAmJiAhaXNJbkNvbmUpIHsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0QW5nbGUgPSBNYXRoLmF0YW4yKF90ZW1wVmVjMS54LCBfdGVtcFZlYzEueik7CiAgICAgICAgICAgIGNvbnN0IHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUobmV3IFRIUkVFLlZlY3RvcjMoMCwxLDApLCB0YXJnZXRBbmdsZSk7CiAgICAgICAgICAgIGVudGl0eS5tZXNoLnF1YXRlcm5pb24uc2xlcnAocSwgMC4yKTsgLy8gRmFzdGVyIHR1cm4gKHdhcyAwLjEpCiAgICAgICAgICAgIGlmIChlbnRpdHkuc3luY1JvdGF0aW9uKSBlbnRpdHkuc3luY1JvdGF0aW9uKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBHUkFCIExPR0lDCiAgICAgICAgLy8gMS4gVG91Y2g6IFZlcnkgY2xvc2UgKGlnbm9yZSBmYWNpbmcgLSBwcmV2ZW50cyBydW5uaW5nIG92ZXIgYmFsbCkKICAgICAgICAvLyAyLiBNYWduZXQ6IENsb3NlIGFuZCBmYWNpbmcKICAgICAgICBjb25zdCBpc1RvdWNoID0gZGlzdFhaIDwgdG91Y2hSYWRpdXM7CiAgICAgICAgY29uc3QgaXNNYWduZXQgPSBkaXN0WFogPCBtYWduZXRSYWRpdXMgJiYgaXNJbkNvbmU7CgogICAgICAgIGlmIChpc1RvdWNoIHx8IGlzTWFnbmV0KSB7CiAgICAgICAgICAgIC8vIEJMQVNUIFRIUk9VR0ggTE9HSUMKICAgICAgICAgICAgY29uc3QgYmFsbFNwZWVkID0gX2JhbGwudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgIGxldCBjYXRjaENoYW5jZSA9IDEuMDsKCiAgICAgICAgICAgIC8vIElmIGJhbGwgaXMgbW92aW5nIGZhc3QgKGUuZy4gPiAyMCksIGNoZWNrIENBCiAgICAgICAgICAgIGlmIChiYWxsU3BlZWQgPiAyMC4wKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjYSA9IGVudGl0eS5nZXRTdGF0KCdDQScpOwogICAgICAgICAgICAgICAgLy8gRGlmZmljdWx0eSBzY2FsZXMgd2l0aCBzcGVlZC4gCiAgICAgICAgICAgICAgICBjb25zdCBkaWZmaWN1bHR5ID0gYmFsbFNwZWVkICogMS4yOyAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGRpZmZpY3VsdHkgPiBjYSkgewogICAgICAgICAgICAgICAgICAgIGNhdGNoQ2hhbmNlID0gMC40ICsgKGNhIC8gZGlmZmljdWx0eSkgKiAwLjY7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUG9pbnQgQmxhbmsgUGVuYWx0eTogSGFyZGVyIHRvIHJlYWN0IGlmIGJhbGwgaXMgcmlnaHQgb24gdG9wIG9mIHlvdSBtb3ZpbmcgZmFzdAogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0WFogPCAxLjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2F0Y2hDaGFuY2UgKj0gMC42OyAvLyBCbGFzdCB0aHJvdWdoIGxpa2VseQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoZW50aXR5LmlzRGFzaGluZykgY2F0Y2hDaGFuY2UgKz0gMC4yOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKF9iYWxsLnBvd2VyVHlwZSA9PT0gJ1NIJyAmJiBfYmFsbC5wb3dlciA+IDE1LjApIHsKICAgICAgICAgICAgICAgIC8vIFNob3QgcG93ZXIgY2hlY2sKICAgICAgICAgICAgICAgIGNvbnN0IGNhID0gZW50aXR5LmdldFN0YXQoJ0NBJyk7CiAgICAgICAgICAgICAgICBpZiAoX2JhbGwucG93ZXIgPiBjYSAqIDEuMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5jZSA9IE1hdGgubWluKDAuNywgKF9iYWxsLnBvd2VyIC0gY2EpICogMC4wNCk7CiAgICAgICAgICAgICAgICAgICAgY2F0Y2hDaGFuY2UgPSAxLjAgLSBjaGFuY2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBmdW1ibGUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPiBjYXRjaENoYW5jZSkgewogICAgICAgICAgICAgICAgZnVtYmxlID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGZ1bWJsZSkgewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWaXN1YWwgZmVlZGJhY2sgZm9yIGJsYXN0IHRocm91Z2gKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTEFTVCBUSFJPVUdIISIsIGVudFBvcywgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBEZWZsZWN0IHNsaWdodGx5IGJ1dCBrZWVwIG1vdmluZyBmYXN0IChCbGFzdCBUaHJvdWdoKQogICAgICAgICAgICAgICAgLy8gRG9uJ3Qgc3RvcCBpdCBjb21wbGV0ZWx5IGxpa2UgYSBibG9jaywganVzdCBwZXJ0dXJiIGl0CiAgICAgICAgICAgICAgICBfYmFsbC52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcigwLjg1KTsgCiAgICAgICAgICAgICAgICBfYmFsbC52ZWxvY2l0eS54ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiA1LjA7CiAgICAgICAgICAgICAgICBfYmFsbC52ZWxvY2l0eS55ICs9IChNYXRoLnJhbmRvbSgpKSAqIDUuMDsgLy8gUG9wIHVwCiAgICAgICAgICAgICAgICBfYmFsbC52ZWxvY2l0eS56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiA1LjA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9iYWxsLnBvd2VyICo9IDAuNzsKCiAgICAgICAgICAgICAgICBlbnRpdHkuY2FuQ2F0Y2ggPSBmYWxzZTsKICAgICAgICAgICAgICAgIC8vIFN0dW4gYnJpZWZseQogICAgICAgICAgICAgICAgZW50aXR5LnN0dW5UaW1lciA9IDAuNTsKICAgICAgICAgICAgICAgIGlmKGVudGl0eS5wbGF5KSBlbnRpdHkucGxheSgncmVhY3QnLCAwLjEpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgZW50aXR5LmNhbkNhdGNoID0gdHJ1ZTsgfSwgMTAwMCk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2JhbGwubWFnbmV0aXplKGVudGl0eSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8gU3RhcnQKICAgIGluaXQoKTsKfSkoKTs=","Ball.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIHZlY3RvcnMgdG8gYXZvaWQgR0MKY29uc3QgX2JWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2JEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2F4aXNZID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CiAgICBjb25zdCBfdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbWFnbnVzVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCi8vIFBoeXNpY3MgQ29uZmlndXJhdGlvbiAoRXhwb3NlZCBmb3IgRGV2VG9vbHMpCndpbmRvdy5mbHV4LkJhbGxDb25maWcgPSB7CiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBDb3JlIGludGVncmF0aW9uCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBTVUJTVEVQUzogMiwgICAgICAgICAgICAgICAgLy8gUGh5c2ljcyBzdWJzdGVwcyBwZXIgZnJhbWUgKHN0YWJpbGl0eSBhdCBoaWdoIHNwZWVkcykKICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLCAgICAgICAgICAgLy8gQmVsb3cgdGhpcyBzcGVlZCwgc25hcCB0byByZXN0IChwcmV2ZW50cyBlbmRsZXNzIGRyaWZ0KQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFdhdGVyIHJlc2lzdGFuY2UgKHBoeXNpY2FsIHZlbG9jaXR5IGRyYWcsIE5PVCBzdGF0IGRlY2F5KQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMTUsICAgIC8vIExpbmVhciBkcmFnIHRlcm0gKHJvdWdobHkgeW91ciBwcmV2aW91cyBXQVRFUl9EUkFHKQogICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDIsICAgICAvLyBRdWFkcmF0aWMgZHJhZyAoc3Ryb25nZXIgYXQgaGlnaCBzcGVlZCwgaGVscHMgdGFtZSByb2NrZXRzKQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFNwaW4gJiBjdXJ2ZQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgU1BJTl9EUkFHOiAwLjQwLCAgICAgICAgICAgIC8vIFNwaW4gZGVjYXkgcGVyIHNlY29uZAogICAgICAgIE1BR05VU19FTkFCTEVEOiB0cnVlLAogICAgICAgIE1BR05VU19DT0VGRjogMC4wOCwgICAgICAgICAvLyBMaWZ0IHN0cmVuZ3RoCiAgICAgICAgTUFHTlVTX0NBUDogNjAuMCwgICAgICAgICAgIC8vIE1heCBtYWdudXMgZGVsdGEtViBwZXIgc3Vic3RlcCAocHJldmVudHMgZXhwbG9zaW9ucykKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBEZXB0aCBjb25zdHJhaW50IChrZWVwcyBiYWxsIG5lYXIgcGxheSBwbGFuZSB3aXRob3V0IGZlZWxpbmcgbGlrZSBhIGhhcmQgZmxvb3IpCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBERVBUSF9UQVJHRVRfWTogMC4wLAogICAgICAgIERFUFRIX1NQUklORzogMS4wLCAgICAgICAgICAvLyBZb3VyIHByZXZpb3VzIEdSQVZJVFlfU1BSSU5HCiAgICAgICAgREVQVEhfREFNUDogMS41LCAgICAgICAgICAgIC8vIFlvdXIgcHJldmlvdXMgR1JBVklUWV9EQU1QCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gQXJlbmEgYm91bmRhcnkgKHNvZnQgd2FsbCArIGNsYW1wKQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCkJPVU5EQVJZX1JBRElVUzogNDYuMCwKICAgICAgICBHT0FMX0RJU1RBTkNFOiA0MS41LCAgICAgICAgLy8gRGlzdGFuY2Ugb2YgZ29hbCBmcm9tIGNlbnRlciAoWi1heGlzKQogICAgICAgIEJPVU5EQVJZX0hFSUdIVDogMjAuMCwKICAgICAgICBCT1VOREFSWV9IRUlHSFQ6IDIwLjAsCiAgICAgICAgR09BTF9QT0NLRVRfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBHT0FMX1BPQ0tFVF9YOiAxMi4wLCAgICAgICAgLy8gSGFsZi13aWR0aCBvZiBnb2FsIHBvY2tldCBjb3JyaWRvcgogICAgICAgIEdPQUxfUE9DS0VUX1o6IDQwLjAsICAgICAgICAvLyBTdGFydCBvZiBnb2FsIHBvY2tldCBjb3JyaWRvciAoYWJzIHopIC0gUHVzaGVkIGJhY2sKICAgICAgICBHT0FMX1BPQ0tFVF9SQURJVVM6IDU1LjAsICAgLy8gRWZmZWN0aXZlIHJhZGl1cyB3aGVuIGluIGdvYWwgcG9ja2V0CiAgICAgICAgV0FMTF9TT0ZUX0JVRkZFUjogMy4wLCAgICAgIC8vIERpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMKICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDIwLjAsICAgICAgLy8gU29mdCByZXB1bHNpb24gc3RyZW5ndGgKICAgICAgICBXQUxMX0VMQVNUSUNJVFk6IDAuMzAsICAgICAgLy8gQm91bmNlIGRhbXBlbmluZyBvbiBjbGFtcAogICAgICAgIFdBTExfRlJJQ1RJT046IDAuOTUsICAgICAgICAvLyBUYW5nZW50aWFsIGRhbXBpbmcgb24gd2FsbCBjb250YWN0CgogICAgICAgIEZMT09SX0VMQVNUSUNJVFk6IDAuNDAsICAgICAvLyBCb3VuY2UgZGFtcGVuaW5nIG9uIGNlaWxpbmcvZmxvb3IgY2xhbXAKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBUaHJvdyBtYXBwaW5nIChzdGF0IGZvcmNlIC0+IHBoeXNpY2FsIGxhdW5jaCBzcGVlZCkKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIExBVU5DSF9TUEVFRF9TQ0FMRTogMS4wLCAgICAvLyBNdWx0aXBsaWVzIGZvcmNlIHdoZW4gY29udmVydGluZyB0byB2ZWxvY2l0eQogICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDg1LjAgICAgICAvLyBQaHlzaWNhbCBzcGVlZCBjYXAgKHdhcyBoYXJkY29kZWQgaW4gQmFsbC5zaG9vdCkKICAgIH07CgoKICAgIAogICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWc7IC8vIExvY2FsIGFsaWFzIGZvciBicmV2aXR5CiAgICAvLyAtLS0gVFJBSUwgUkVOREVSRVIgLS0tCi8vIC0tLSBUUkFJTCBSRU5ERVJFUiAtLS0KICAgIGNsYXNzIFRyYWlsUmVuZGVyZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5zZWdtZW50cyA9IDMwOyAvLyBNb3JlIHNlZ21lbnRzIGZvciBzbW9vdGhlciBjdXJ2ZXMKICAgICAgICAgICAgdGhpcy5wb2ludHMgPSBbXTsKdGhpcy5iYXNlV2lkdGggPSAwLjg7IC8vIEluY3JlYXNlZCB3aWR0aCBmb3IgdmlzaWJpbGl0eQogICAgICAgICAgICB0aGlzLmN1cnJlbnRXaWR0aCA9IDAuODsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJ5CiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgICAgIGNvbnN0IHBvc0RhdGEgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuc2VnbWVudHMgKiAyICogMyk7CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHBvc0RhdGEsIDMpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluZGljZXMKICAgICAgICAgICAgY29uc3QgaW5kaWNlcyA9IFtdOwogICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50cy0xOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhc2UgPSBpKjI7CiAgICAgICAgICAgICAgICBpbmRpY2VzLnB1c2goYmFzZSwgYmFzZSsxLCBiYXNlKzIpOwogICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGJhc2UrMSwgYmFzZSszLCBiYXNlKzIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEluZGV4KGluZGljZXMpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBjb2xvcjogMHgwMGFhZmYsCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLjksIC8vIEluY3JlYXNlZCBvcGFjaXR5CiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLm1lc2gpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW5pdCBwb2ludHMKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB0aGlzLnBvaW50cy5wdXNoKG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUmV1c2FibGUgdGVtcHMgKGF2b2lkIHBlci1mcmFtZSBhbGxvY2F0aW9ucyBvbiBtb2JpbGUpCiAgICAgICAgICAgIHRoaXMuX3RtcERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuX3RtcFRvQ2FtID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5fdG1wUmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXNldChwb3MpIHsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB0aGlzLnBvaW50c1tpXS5jb3B5KHBvcyk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlR2VvbWV0cnkoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgc2V0Q29sb3IoaGV4KSB7CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KGhleCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZShjdXJyZW50UG9zLCBzcGVlZFJhdGlvID0gMC4wKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXQoY3VycmVudFBvcyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCi8vIER5bmFtaWMgV2lkdGggYmFzZWQgb24gc3BlZWQgQU5EIFNQSU4gKFBvd2VyIFZpc3VhbCkKICAgICAgICAgICAgLy8gRmFzdCBiYWxsID0gVGhpY2tlci4gU3Bpbm5pbmcgYmFsbCA9IEV2ZW4gVGhpY2tlci4KICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgY29uc3Qgc3BpblJhdGlvID0gYmFsbCA/IE1hdGgubWluKDEuMCwgYmFsbC5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkgLyAzMC4wKSA6IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB0YXJnZXRXaWR0aCA9IHRoaXMuYmFzZVdpZHRoICogKDAuOCArIHNwZWVkUmF0aW8gKiAxLjIgKyBzcGluUmF0aW8gKiAyLjApOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRXaWR0aCArPSAodGFyZ2V0V2lkdGggLSB0aGlzLmN1cnJlbnRXaWR0aCkgKiAwLjI7IC8vIFNtb290aCB0cmFuc2l0aW9uCgogICAgICAgICAgICAvLyBTaGlmdCBwb2ludHMKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuc2VnbWVudHMgLSAxOyBpID4gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBvaW50c1tpXS5jb3B5KHRoaXMucG9pbnRzW2ktMV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucG9pbnRzWzBdLmNvcHkoY3VycmVudFBvcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVwZGF0ZUdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZUdlb21ldHJ5KCkgewogICAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5hcnJheTsKICAgICAgICAgICAgY29uc3QgY2FtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSA6IG51bGw7CiAgICAgICAgICAgIGlmICghY2FtKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IGNhbS5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgdGVtcERpciA9IHRoaXMuX3RtcERpcjsKICAgICAgICAgICAgY29uc3QgdGVtcFRvQ2FtID0gdGhpcy5fdG1wVG9DYW07CiAgICAgICAgICAgIGNvbnN0IHRlbXBSaWdodCA9IHRoaXMuX3RtcFJpZ2h0OwogICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5wb2ludHNbaV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRhcGVyIHdpZHRoIGFsb25nIHRyYWlsIGxlbmd0aAogICAgICAgICAgICAgICAgY29uc3QgdGFwZXIgPSAxLjAgLSBNYXRoLnBvdyhpIC8gdGhpcy5zZWdtZW50cywgMik7IC8vIFF1YWRyYXRpYyB0YXBlcgogICAgICAgICAgICAgICAgY29uc3QgdyA9IHRoaXMuY3VycmVudFdpZHRoICogdGFwZXI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIGlmIChpIDwgdGhpcy5zZWdtZW50cyAtIDEpIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wRGlyLnN1YlZlY3RvcnModGhpcy5wb2ludHNbaV0sIHRoaXMucG9pbnRzW2krMV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wRGlyLnN1YlZlY3RvcnModGhpcy5wb2ludHNbaS0xXSwgdGhpcy5wb2ludHNbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGVtcERpci5sZW5ndGhTcSgpIDwgMC4wMDAxKSB0ZW1wRGlyLnNldCgwLCAxLCAwKTsKICAgICAgICAgICAgICAgIHRlbXBEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRlbXBUb0NhbS5zdWJWZWN0b3JzKGNhbVBvcywgcCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0ZW1wUmlnaHQuY3Jvc3NWZWN0b3JzKHRlbXBEaXIsIHRlbXBUb0NhbSkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIodyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZlcnQgMQogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDBdID0gcC54IC0gdGVtcFJpZ2h0Lng7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgMV0gPSBwLnkgLSB0ZW1wUmlnaHQueTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAyXSA9IHAueiAtIHRlbXBSaWdodC56OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZXJ0IDIKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAzXSA9IHAueCArIHRlbXBSaWdodC54OwogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDRdID0gcC55ICsgdGVtcFJpZ2h0Lnk7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgNV0gPSBwLnogKyB0ZW1wUmlnaHQuejsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgfQogICAgfQpjbGFzcyBCYWxsIHsKCiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7IAogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSBudWxsOyAvLyBUcmFjayB3aG8gdGhyZXcgaXQgbGFzdCAoZm9yIEVYUC9Bc3Npc3RzKQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOyAvLyAnZnJlZScsICdoZWxkJywgJ21hZ25ldGl6ZWQnCiAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIENvbnRpbnVvdXMgU3RhdHMKICAgICAgICAgICAgdGhpcy5wb3dlciA9IDA7ICAgICAgLy8gQ3VycmVudCBQQSBvciBTSCB2YWx1ZQogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9ICdub25lJzsgLy8gJ1BBJyBvciAnU0gnCiAgICAgICAgICAgIHRoaXMuZGVjYXlSYXRlID0gMy4wOyAvLyBTdGF0IHBvaW50cyBsb3N0IHBlciBzZWNvbmQgKFdhdGVyIHJlc2lzdGFuY2UpCiAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7IC8vIFRpbWUgYmVmb3JlIGJhbGwgY2FuIGJlIGNhdWdodCBhZ2FpbgoKICAgICAgICAgICAgLy8gTWFnbmV0IFN5c3RlbQogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1hZ25ldER1cmF0aW9uID0gMC4yOyAKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gVmlzdWFscyAoU3F1YXNoICYgU3RyZXRjaCkKICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zcGluTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubW9kZWwgPSBudWxsOwoKdGhpcy5pbml0TWVzaCgpOwogICAgICAgICAgICB0aGlzLnRyYWlsID0gbmV3IFRyYWlsUmVuZGVyZXIoc2NlbmUpOwogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDA7Cn0KaW5pdE1lc2goKSB7CiAgICAgICAgICAgIC8vIEhpZXJhcmNoeTogTWVzaCAoUG9zKSAtPiBEZWZvcm0gKFNxdWFzaC9TdHJldGNoKSAtPiBTcGluIChSb3RhdGlvbikgLT4gTW9kZWwKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7Cgp0aGlzLmRlZm9ybU5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnkgPSAwLjA7IC8vIFJlc2V0IG9mZnNldCBzbyBiYWxsIGlzIGNlbnRlcmVkIG9uIG1lc2ggcG9zaXRpb24KICAgICAgICAgICAgdGhpcy5tZXNoLmFkZCh0aGlzLmRlZm9ybU5vZGUpOyAvLyBGaXg6IEFkZCBkZWZvcm1Ob2RlIHRvIG1lc2gKCiAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLmFkZCh0aGlzLnNwaW5Ob2RlKTsKCiAgICAgICAgICAgIC8vIFByb2NlZHVyYWwgUGxhY2Vob2xkZXIgVGV4dHVyZSAoQmxpdHpiYWxsLWlzaCkKICAgICAgICAgICAgY29uc3QgcGxhY2Vob2xkZXJUZXggPSAoKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAgICAgYy53aWR0aCA9IDEyODsgYy5oZWlnaHQgPSA2NDsKICAgICAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2VlZWVlZSc7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwwLDEyOCw2NCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEJsdWUgYnVtcHMvZGV0YWlscwogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDA4OGZmJzsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDY7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBjdHguYXJjKGkqMjUsIDMyLCAxMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDA0NDg4JzsKICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAyOCwgMTI4LCA4KTsgLy8gU3RyaXBlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICAgICAgfSkoKTsKCiAgICAgICAgICAgIC8vIFBsYWNlaG9sZGVyIFZpc3VhbCAoSW1tZWRpYXRlIGZlZWRiYWNrLCBwZXJzaXN0cyB1bnRpbCB2YWxpZCBtb2RlbCBsb2FkcykKLy8gUGxhY2Vob2xkZXIgVmlzdWFsIChJbW1lZGlhdGUgZmVlZGJhY2ssIHBlcnNpc3RzIHVudGlsIHZhbGlkIG1vZGVsIGxvYWRzKQovLyBQbGFjZWhvbGRlciBWaXN1YWwgKEltbWVkaWF0ZSBmZWVkYmFjaywgcGVyc2lzdHMgdW50aWwgdmFsaWQgbW9kZWwgbG9hZHMpCmNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDAuMywgMTYsIDE2KTsgLy8gU2NhbGVkIGRvd24gfjE1JQogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBtYXA6IHBsYWNlaG9sZGVyVGV4LAogICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAKICAgICAgICAgICAgICAgIHdpcmVmcmFtZTogZmFsc2UsIC8vIFNvbGlkCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAxLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwoKICAgICAgICAgICAgLy8gTG9hZCBHTEIgTW9kZWwKICAgICAgICAgICAgY29uc3QgdXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy81MjFhZTg3ODhlNTg0ZTM3OGE3OWQ5NzMyYTA3NTM1Ni5nbGInOwogICAgICAgICAgICAKICAgICAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKHVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJERUJVRzogQmFsbCBHTEIgbG9hZGVkLiIsIGdsdGYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBtb2RlbCA9IGdsdGYuc2NlbmU7CgogICAgICAgICAgICAgICAgLy8gMS4gUmVzZXQgcm9vdCB0cmFuc2Zvcm1zCiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBtb2RlbC5yb3RhdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBtb2RlbC5zY2FsZS5zZXQoMSwgMSwgMSk7CiAgICAgICAgICAgICAgICBtb2RlbC51cGRhdGVNYXRyaXhXb3JsZCh0cnVlKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBIYXJkZW4gTWF0ZXJpYWxzICYgVmlzaWJpbGl0eQogICAgICAgICAgICAgICAgbW9kZWwudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5jYXN0U2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVjZWl2ZVNoYWRvdyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsgLy8gQ1JJVElDQUw6IFByZXZlbnQgY3VsbGluZyBpZiBib3VuZHMgYXJlIG9mZgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hdHMgPSBBcnJheS5pc0FycmF5KG5vZGUubWF0ZXJpYWwpID8gbm9kZS5tYXRlcmlhbCA6IFtub2RlLm1hdGVyaWFsXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdHMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLmNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIEZvcmNlIHdoaXRlIGJhc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnNpZGUgPSBUSFJFRS5Eb3VibGVTaWRlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5hbHBoYVRlc3QgPSAwOyAvLyBDUklUSUNBTDogRGlzYWJsZSBhbHBoYSB0ZXN0IHRvIHByZXZlbnQgY3VsbGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5kZXB0aFRlc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyAzLiBDb21wdXRlIEJvdW5kaW5nIEJveAogICAgICAgICAgICAgICAgY29uc3QgYm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KG1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNpemUgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgYm94LmdldFNpemUoc2l6ZSk7CiAgICAgICAgICAgICAgICBjb25zdCBjZW50ZXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgYm94LmdldENlbnRlcihjZW50ZXIpOwoKICAgICAgICAgICAgICAgIC8vIDQuIFZhbGlkYXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IG1heERpbSA9IE1hdGgubWF4KHNpemUueCwgc2l6ZS55LCBzaXplLnopOwogICAgICAgICAgICAgICAgaWYgKG1heERpbSA8PSAwLjAwMSB8fCAhaXNGaW5pdGUobWF4RGltKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBtb2RlbCBoYXMgaW52YWxpZCBkaW1lbnNpb25zLiBLZWVwaW5nIHBsYWNlaG9sZGVyLiIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gNS4gQ2FsY3VsYXRlIFNjYWxlCi8vIDUuIENhbGN1bGF0ZSBTY2FsZQpjb25zdCB0YXJnZXREaWFtZXRlciA9IDAuNzI7IC8vIFJlZHVjZWQgc2NhbGUgYnkgfjE1JSAod2FzIDAuODUpCiAgICAgICAgICAgICAgICBjb25zdCBzY2FsZUZhY3RvciA9IHRhcmdldERpYW1ldGVyIC8gbWF4RGltOwoKICAgICAgICAgICAgICAgIC8vIDYuIEFwcGx5IFRyYW5zZm9ybXMKICAgICAgICAgICAgICAgIG1vZGVsLnNjYWxlLnNldFNjYWxhcihzY2FsZUZhY3Rvcik7CiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5jb3B5KGNlbnRlcikubXVsdGlwbHlTY2FsYXIoLXNjYWxlRmFjdG9yKTsKCiAgICAgICAgICAgICAgICAvLyA3LiBTd2FwIFBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucmVtb3ZlKHRoaXMucGxhY2Vob2xkZXIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5KSB0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsID0gbW9kZWw7CiAgICAgICAgICAgICAgICB0aGlzLnNwaW5Ob2RlLmFkZCh0aGlzLm1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCbGl0emJhbGwgbW9kZWwgYXR0YWNoZWQuIFNjYWxlOiAke3NjYWxlRmFjdG9yLnRvRml4ZWQoNCl9YCk7CgogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBsb2FkIEJsaXR6YmFsbCBtb2RlbDoiLCBlcnIpOwogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2s6IEtlZXAgcGxhY2Vob2xkZXIgYnV0IHRpbnQgaXQgcmVkIHRvIGluZGljYXRlIGVycm9yCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZhYWFhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIFdyYXBwZXIgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkKICAgICAgICAgICAgdGhpcy51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIEJhbGwgTGFiIHJlcGxheSBvdmVycmlkZSAoUGh5c2ljcyBjb250cm9sKQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzICYmIHR5cGVvZiBfX2xhYi5hcHBseVJlcGxheUZyYW1lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBfX2xhYi5hcHBseVJlcGxheUZyYW1lKHRoaXMsIGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBpZiBwb3NpdGlvbiBjb3JydXB0ZWQKICAgICAgICAgICAgaWYgKGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi54KSB8fCBpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueSkgfHwgaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLnopKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNhZmV0eTogRml4ICJVbnBpY2thYmxlIEJhbGwiIEJ1ZwogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2hlbGQnICYmICghdGhpcy5ob2xkZXIgfHwgIXRoaXMuaG9sZGVyLm1lc2gpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ21hZ25ldGl6ZWQnKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMubWFnbmV0VGFyZ2V0IHx8ICF0aGlzLm1hZ25ldFRhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tYWduZXRUaW1lciA+IDIuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBzdHVjayBpbiBtYWduZXRpemVkIHN0YXRlLiBEcm9wcGluZy4iKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHRoaXMuaG9sZGVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdmcmVlJyAmJiB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAwLjUpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaGVsZCcgJiYgdGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVIZWxkKGR0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTWFnbmV0aXplZChkdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVGcmVlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYXRjaEdyYWNlUGVyaW9kIDwgMCkgdGhpcy5jYXRjaEdyYWNlUGVyaW9kID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQmFsbCBMYWIgcmVwbGF5IG92ZXJyaWRlIChWaXN1YWxzKQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgdGhpcy50cmFpbC5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgewogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgdGhpcy50cmFpbC5hY3RpdmUgPSAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHNwZWVkID4gMi4wKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2JWZWMuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgX2JWZWMueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKCiAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHNwZWVkIC8gNjAuMCwgMS4wKTsKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwudXBkYXRlKF9iVmVjLCByYXRpbyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVQYXJ0aWNsZXMoZHQpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMubWVzaCAmJiAhdGhpcy5pc0ludmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubW9kZWwpIHRoaXMubW9kZWwudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgptYWduZXRpemUodGFyZ2V0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcgfHwgdGhpcy5zdGF0ZSA9PT0gJ2hlbGQnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ21hZ25ldGl6ZWQnOwogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSB0YXJnZXQ7IC8vIExvZ2ljYWwgcG9zc2Vzc2lvbiBzbyBBSSByZWFjdHMKICAgICAgICAgICAgdGhpcy5tYWduZXRUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRQb3MuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLm1hZ25ldFN0YXJ0VmVsLmNvcHkodGhpcy52ZWxvY2l0eSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEeW5hbWljIER1cmF0aW9uIGJhc2VkIG9uIGRpc3RhbmNlIChTbW9vdGhlciBmb3IgbG9uZyByYW5nZSwgc25hcHB5IGZvciBjbG9zZSkKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5tYWduZXREdXJhdGlvbiA9IE1hdGgubWF4KDAuMTUsIE1hdGgubWluKDAuNCwgZGlzdCAvIDE1LjApKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEtpbGwgcGh5c2ljcwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gTm90aWZ5IHBsYXllciBpbW1lZGlhdGVseSBzbyB0aGV5IHN0b3AgY2hhc2luZyBhbmQgcGxheSBhbmltYXRpb24KICAgICAgICAgICAgaWYgKHRhcmdldC5yZWNlaXZlQmFsbCkgewogICAgICAgICAgICAgICAgdGFyZ2V0LnJlY2VpdmVCYWxsKCk7CiAgICAgICAgICAgIH0KCnRoaXMucmV2ZWFsKCk7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdjYXRjaCcsIHsgdm9sdW1lOiAwLjYgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGVNYWduZXRpemVkKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tYWduZXRUYXJnZXQgfHwgIXRoaXMubWFnbmV0VGFyZ2V0Lm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm1hZ25ldFRpbWVyICs9IGR0OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm9ybWFsaXplZCBUaW1lCiAgICAgICAgICAgIGxldCB0ID0gdGhpcy5tYWduZXRUaW1lciAvIHRoaXMubWFnbmV0RHVyYXRpb247CiAgICAgICAgICAgIGlmICh0ID4gMS4wKSB0ID0gMS4wOwoKICAgICAgICAgICAgLy8gVGFyZ2V0ICJWaXJ0dWFsIEhhbmQiIFBvc2l0aW9uIChGcm9udCBvZiBDaGVzdCkKICAgICAgICAgICAgY29uc3QgaG9sZGVyUG9zID0gdGhpcy5tYWduZXRUYXJnZXQubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgaG9sZGVyUXVhdCA9IHRoaXMubWFnbmV0VGFyZ2V0Lm1lc2gucXVhdGVybmlvbjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9mZnNldDogRm9yd2FyZCAwLjYsIFVwIDEuMCAoQ2hlc3QgaGVpZ2h0KQogICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBfYlZlYy5zZXQoMCwgMS4wLCAwLjYpLmFwcGx5UXVhdGVybmlvbihob2xkZXJRdWF0KTsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9zID0gb2Zmc2V0LmFkZChob2xkZXJQb3MpOwoKICAgICAgICAgICAgLy8gLS0tIFFVQURSQVRJQyBCRVpJRVIgQ1VSVkUgLS0tCiAgICAgICAgICAgIC8vIFAwID0gU3RhcnQsIFAyID0gVGFyZ2V0CiAgICAgICAgICAgIC8vIFAxID0gQ29udHJvbCBQb2ludCAoUHJvamVjdGVkIGFsb25nIGluaXRpYWwgdmVsb2NpdHkgdG8gcHJlc2VydmUgbW9tZW50dW0gZmVlbCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHAwID0gdGhpcy5tYWduZXRTdGFydFBvczsKICAgICAgICAgICAgY29uc3QgcDIgPSB0YXJnZXRQb3M7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDYWxjdWxhdGUgUDEgKENvbnRyb2wgUG9pbnQpCiAgICAgICAgICAgIC8vIFByb2plY3QgZm9yd2FyZCBmcm9tIFAwIGFsb25nIHN0YXJ0IHZlbG9jaXR5IHZlY3RvcgogICAgICAgICAgICAvLyBEaXN0YW5jZSBvZiBwcm9qZWN0aW9uID0gNDAlIG9mIHRvdGFsIGRpc3RhbmNlIHRvIHRhcmdldAogICAgICAgICAgICBjb25zdCBkaXN0ID0gcDAuZGlzdGFuY2VUbyhwMik7CiAgICAgICAgICAgIGNvbnN0IHAxID0gX3RlbXBWZWMuY29weShwMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2ZWxMZW4gPSB0aGlzLm1hZ25ldFN0YXJ0VmVsLmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGlmICh2ZWxMZW4gPiAxLjApIHsKICAgICAgICAgICAgICAgIC8vIFVzZSB2ZWxvY2l0eSB0YW5nZW50Ci8vIFVzZSB2ZWxvY2l0eSB0YW5nZW50CiAgICAgICAgICAgICAgICBfYkRpci5jb3B5KHRoaXMubWFnbmV0U3RhcnRWZWwpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgcDEuYWRkKF9iRGlyLm11bHRpcGx5U2NhbGFyKGRpc3QgKiAwLjQpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE5vIHZlbG9jaXR5IChzdGF0aW9uYXJ5IGJhbGwpLCBhcmMgdXB3YXJkcyBzbGlnaHRseQogICAgICAgICAgICAgICAgcDEubGVycChwMiwgMC41KTsKICAgICAgICAgICAgICAgIHAxLnkgKz0gMS41OyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmV6aWVyOiBCKHQpID0gKDEtdCleMiAqIFAwICsgMigxLXQpdCAqIFAxICsgdF4yICogUDIKICAgICAgICAgICAgY29uc3Qgb25lTWludXNUID0gMS4wIC0gdDsKICAgICAgICAgICAgY29uc3QgdzAgPSBvbmVNaW51c1QgKiBvbmVNaW51c1Q7CiAgICAgICAgICAgIGNvbnN0IHcxID0gMi4wICogb25lTWludXNUICogdDsKICAgICAgICAgICAgY29uc3QgdzIgPSB0ICogdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi54ID0gKHcwICogcDAueCkgKyAodzEgKiBwMS54KSArICh3MiAqIHAyLngpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9ICh3MCAqIHAwLnkpICsgKHcxICogcDEueSkgKyAodzIgKiBwMi55KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSAodzAgKiBwMC56KSArICh3MSAqIHAxLnopICsgKHcyICogcDIueik7CgogICAgICAgICAgICAvLyBGaW5pc2gKICAgICAgICAgICAgaWYgKHQgPj0gMS4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdyYWIodGhpcy5tYWduZXRUYXJnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlSGVsZChkdCkgewogICAgICAgICAgICAvLyBBVFRBQ0hFRCBTVEFURSAoVmlydHVhbCBBdHRhY2htZW50KQogICAgICAgICAgICBpZiAoIXRoaXMuaG9sZGVyIHx8ICF0aGlzLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIDEuIFRyeSB0byB1c2UgSGFuZCBCb25lIGlmIGF2YWlsYWJsZSAoUmVhbGlzbSkKICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmhhbmRCb25lKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgd29ybGQgcG9zaXRpb24gb2YgdGhlIGhhbmQgYm9uZQogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIuaGFuZEJvbmUuZ2V0V29ybGRQb3NpdGlvbih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBZGp1c3Qgc2xpZ2h0bHkgdG8gc2l0IElOIHRoZSBoYW5kIHJhdGhlciB0aGFuIE9OIHRoZSB3cmlzdAogICAgICAgICAgICAgICAgLy8gV2UgY2FuJ3QgZWFzaWx5IGtub3cgImZvcndhcmQiIGZvciB0aGUgYm9uZSB3aXRob3V0IG1vcmUgaW5mbywgCiAgICAgICAgICAgICAgICAvLyBidXQgdXN1YWxseSBHTFRGIGJvbmVzIGFyZSBvcmllbnRlZC4gRm9yIG5vdywgZXhhY3QgYm9uZSBwb3MgaXMgYmV0dGVyIHRoYW4gY2hlc3QuCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAyLiBGYWxsYmFjazogQ2FsY3VsYXRlICJDYXJyeWluZyIgUG9zaXRpb24gKFJpZ2h0IEhhbmQgU2lkZSkKICAgICAgICAgICAgICAgIC8vIFJlbGF0aXZlIHRvIHBsYXllcjogVXAgMC44IChXYWlzdC9DaGVzdCksIFJpZ2h0IDAuNCwgRm9yd2FyZCAwLjUKICAgICAgICAgICAgICAgIGNvbnN0IGhvbGRlclBvcyA9IHRoaXMuaG9sZGVyLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICBjb25zdCBob2xkZXJRdWF0ID0gdGhpcy5ob2xkZXIubWVzaC5xdWF0ZXJuaW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSZXVzZSBfYlZlYwovLyBSZXVzZSBfYlZlYwogICAgICAgICAgICAgICAgLy8gT2Zmc2V0OiB4PTAuMzUgKFJpZ2h0KSwgeT0xLjMgKENoZXN0L0hhbmRzKSwgej0wLjUgKEZvcndhcmQpCiAgICAgICAgICAgICAgICBfYlZlYy5zZXQoMC4zNSwgMS4zLCAwLjUpLmFwcGx5UXVhdGVybmlvbihob2xkZXJRdWF0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5jb3B5KGhvbGRlclBvcykuYWRkKF9iVmVjKTsKICAgICAgICAgICAgfQoKLy8gVmlzdWFsIEZsYWlyOiBTcGluIHRoZSBiYWxsIHNsb3dseQogICAgICAgICAgICBjb25zdCByb3RYID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDEsMCwwKSwgMiAqIGR0KTsKICAgICAgICAgICAgY29uc3Qgcm90WSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIDUgKiBkdCk7CiAgICAgICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5tdWx0aXBseShyb3RYKS5tdWx0aXBseShyb3RZKTsKICAgICAgICB9CgoKdXBkYXRlRnJlZShkdCkgewogICAgICAgICAgICAvLyBMZWdhY3kgd3JhcHBlcgogICAgICAgICAgICB0aGlzLl91cGRhdGVGcmVlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBhcnRpY2xlcyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZUZyZWVQaHlzaWNzKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnIHx8IHt9OwogICAgICAgICAgICBjb25zdCBzdWJzdGVwcyA9IE1hdGgubWF4KDEsIE1hdGguZmxvb3IoQy5TVUJTVEVQUyB8fCAxKSk7CiAgICAgICAgICAgIGNvbnN0IHN0ZXBEdCA9IGR0IC8gc3Vic3RlcHM7CgogICAgICAgICAgICBmb3IgKGxldCBzID0gMDsgcyA8IHN1YnN0ZXBzOyBzKyspIHsKICAgICAgICAgICAgICAgIC8vIEEpIE1hZ251cyBlZmZlY3QKICAgICAgICAgICAgICAgIGlmIChDLk1BR05VU19FTkFCTEVEICYmIHRoaXMuYW5ndWxhclZlbG9jaXR5ICYmIHRoaXMudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluU3EgPSB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZlbFNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChzcGluU3EgPiAwLjI1ICYmIHZlbFNxID4gMC4yNSkgewogICAgICAgICAgICAgICAgICAgICAgICBfbWFnbnVzVmVjLmNvcHkodGhpcy5hbmd1bGFyVmVsb2NpdHkpLmNyb3NzKHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKChDLk1BR05VU19DT0VGRiB8fCAwKSAqIHN0ZXBEdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhcCA9IChDLk1BR05VU19DQVAgIT09IHVuZGVmaW5lZCA/IEMuTUFHTlVTX0NBUCA6IDYwLjApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYWdMZW4gPSBfbWFnbnVzVmVjLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWFnTGVuID4gY2FwKSBfbWFnbnVzVmVjLm11bHRpcGx5U2NhbGFyKGNhcCAvIG1hZ0xlbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKF9tYWdudXNWZWMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBCKSBTcGluIGRlY2F5CiAgICAgICAgICAgICAgICBpZiAodGhpcy5hbmd1bGFyVmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluRHJhZyA9IE1hdGgubWF4KDAsIDEuMCAtIChDLlNQSU5fRFJBRyB8fCAwKSAqIHN0ZXBEdCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoc3BpbkRyYWcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEMpIERlcHRoIHNwcmluZwogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0WSA9IChDLkRFUFRIX1RBUkdFVF9ZICE9PSB1bmRlZmluZWQgPyBDLkRFUFRIX1RBUkdFVF9ZIDogMC4wKTsKICAgICAgICAgICAgICAgIGNvbnN0IHlFcnIgPSAodGhpcy5tZXNoLnBvc2l0aW9uLnkgLSB0YXJnZXRZKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAtPSB5RXJyICogKEMuREVQVEhfU1BSSU5HIHx8IDApICogc3RlcER0OwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IE1hdGgubWF4KDAsIDEuMCAtIChDLkRFUFRIX0RBTVAgfHwgMCkgKiBzdGVwRHQpOwoKICAgICAgICAgICAgICAgIC8vIEQpIERyYWcKICAgICAgICAgICAgICAgIGNvbnN0IHZMZW4gPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgaWYgKHZMZW4gPiAwLjAwMDAxKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGluID0gKEMuV0FURVJfRFJBR19MSU5FQVIgIT09IHVuZGVmaW5lZCA/IEMuV0FURVJfRFJBR19MSU5FQVIgOiAoQy5XQVRFUl9EUkFHIHx8IDApKSAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBxdWFkID0gKEMuV0FURVJfRFJBR19RVUFEIHx8IDApICogdkxlbiAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gbGluIC0gcXVhZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihkcmFnKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RvcCA9IChDLlNUT1BfU1BFRUQgfHwgMCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0b3AgPiAwICYmIHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKSA8IHN0b3AgKiBzdG9wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBFKSBNb3ZlCiAgICAgICAgICAgICAgICBfdGVtcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKHN0ZXBEdCk7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF90ZW1wVmVjKTsKCiAgICAgICAgICAgICAgICAvLyBGKSBTdGF0IHBvd2VyIGRlY2F5CiAgICAgICAgICAgICAgICBpZiAodGhpcy5wb3dlciA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBvd2VyIC09IHRoaXMuZGVjYXlSYXRlICogc3RlcER0OwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBvd2VyIDwgMCkgdGhpcy5wb3dlciA9IDA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRykgQm91bmRhcnkgbG9naWMKICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RYWiA9IE1hdGguc3FydChwb3MueCAqIHBvcy54ICsgcG9zLnogKiBwb3Mueik7CiAgICAgICAgICAgICAgICBjb25zdCBib3VuZGFyeVJhZGl1cyA9IChDLkJPVU5EQVJZX1JBRElVUyAhPT0gdW5kZWZpbmVkID8gQy5CT1VOREFSWV9SQURJVVMgOiAzMy4wKTsKICAgICAgICAgICAgICAgIGxldCBlZmZlY3RpdmVCb3VuZGFyeSA9IGJvdW5kYXJ5UmFkaXVzOwoKICAgICAgICAgICAgICAgIGlmIChDLkdPQUxfUE9DS0VUX0VOQUJMRUQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpbkdvYWxQb2NrZXQgPSAoTWF0aC5hYnMocG9zLngpIDwgKEMuR09BTF9QT0NLRVRfWCB8fCAxMi4wKSAmJiBNYXRoLmFicyhwb3MueikgPiAoQy5HT0FMX1BPQ0tFVF9aIHx8IDI1LjApKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5Hb2FsUG9ja2V0KSBlZmZlY3RpdmVCb3VuZGFyeSA9IChDLkdPQUxfUE9DS0VUX1JBRElVUyB8fCA0NS4wKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBzb2Z0QnVmZmVyID0gTWF0aC5tYXgoMC4wMSwgKEMuV0FMTF9TT0ZUX0JVRkZFUiAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX1NPRlRfQlVGRkVSIDogMy4wKSk7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RYWiA+IGVmZmVjdGl2ZUJvdW5kYXJ5IC0gc29mdEJ1ZmZlcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBlbmV0cmF0aW9uID0gZGlzdFhaIC0gKGVmZmVjdGl2ZUJvdW5kYXJ5IC0gc29mdEJ1ZmZlcik7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBwZW5ldHJhdGlvbiAvIHNvZnRCdWZmZXIpKTsKICAgICAgICAgICAgICAgICAgICBfdGVtcFZlYy5zZXQoLXBvcy54LCAwLCAtcG9zLnopOwogICAgICAgICAgICAgICAgICAgIGlmIChfdGVtcFZlYy5sZW5ndGhTcSgpID4gMC4wMDAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmb3JjZSA9IHJhdGlvICogcmF0aW8gKiAoQy5XQUxMX1NPRlRfRk9SQ0UgfHwgMCkgKiBzdGVwRHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjLCBmb3JjZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChkaXN0WFogPiBlZmZlY3RpdmVCb3VuZGFyeSkgewogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjLnNldCgtcG9zLngsIDAsIC1wb3Mueik7CiAgICAgICAgICAgICAgICAgICAgaWYgKF90ZW1wVmVjLmxlbmd0aFNxKCkgPiAwLjAwMDEpIF90ZW1wVmVjLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG92ZXJsYXAgPSBkaXN0WFogLSBlZmZlY3RpdmVCb3VuZGFyeTsKICAgICAgICAgICAgICAgICAgICBwb3MuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjLCBvdmVybGFwKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB2RG90TiA9IHRoaXMudmVsb2NpdHkuZG90KF90ZW1wVmVjKTsKICAgICAgICAgICAgICAgICAgICBpZiAodkRvdE4gPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGltcGFjdFNwZWVkID0gTWF0aC5hYnModkRvdE4pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW1wYWN0U3BlZWQgPiAxMC4wICYmIHdpbmRvdy5mbHV4LnRyaWdnZXJBcmVuYUltcGFjdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KHBvcywgTWF0aC5taW4oaW1wYWN0U3BlZWQgKiAwLjUsIDE1LjApKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgnaW1wYWN0JywgeyB2b2x1bWU6IE1hdGgubWluKDEuMCwgaW1wYWN0U3BlZWQgKiAwLjA1KSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlID0gKEMuV0FMTF9FTEFTVElDSVRZICE9PSB1bmRlZmluZWQgPyBDLldBTExfRUxBU1RJQ0lUWSA6IDAuMyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGltcHVsc2UgPSBfdGVtcFZlYy5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKC12RG90TiAqICgxLjAgKyBlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKGltcHVsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmcmljdGlvbiA9IChDLldBTExfRlJJQ1RJT04gIT09IHVuZGVmaW5lZCA/IEMuV0FMTF9GUklDVElPTiA6IDAuOTUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0YW5nZW50ID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLnByb2plY3RPblBsYW5lKF90ZW1wVmVjKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zdWIodGFuZ2VudC5tdWx0aXBseVNjYWxhcigxLjAgLSBmcmljdGlvbikpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBiaCA9IChDLkJPVU5EQVJZX0hFSUdIVCAhPT0gdW5kZWZpbmVkID8gQy5CT1VOREFSWV9IRUlHSFQgOiAxNS4wKTsKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueSkgPiBiaCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNpZ24gPSBNYXRoLnNpZ24ocG9zLnkpIHx8IDE7CiAgICAgICAgICAgICAgICAgICAgcG9zLnkgPSBiaCAqIHNpZ247CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmUgPSAoQy5GTE9PUl9FTEFTVElDSVRZICE9PSB1bmRlZmluZWQgPyBDLkZMT09SX0VMQVNUSUNJVFkgOiAwLjQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSAtZmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVQYXJ0aWNsZXMoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2dob3N0KSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBzcGVlZFNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuX2J1YmJsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlciA6IG51bGw7CiAgICAgICAgICAgICAgICBpZiAocG0pIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoLTAuOCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RkUG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG9mZnNldCkuYWRkKF9iRGlyLnNldCgoTWF0aC5yYW5kb20oKS0wLjUpKjAuMywgKE1hdGgucmFuZG9tKCktMC41KSowLjMsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4zKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3RkUG9zLnkgKz0gdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZScsIHN0ZFBvcywgeyBzY2FsZTogMC40ICsgTWF0aC5yYW5kb20oKSAqIDAuNCB9KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHNwZWVkU3EgPiA1MC4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gTWF0aC5taW4oNCwgTWF0aC5mbG9vcihzcGVlZFNxIC8gNjApKTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBqaXR0ZXIgPSBfYkRpci5zZXQoKE1hdGgucmFuZG9tKCktMC41KSowLjQsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC40LCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuNCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGF3blBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLmFkZChqaXR0ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3Bhd25Qb3MueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdidWJibGVfbWljcm8nLCBzcGF3blBvcywgeyBzY2FsZTogMC4wNSArIE1hdGgucmFuZG9tKCkgKiAwLjEgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwLjAyOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gMC41KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBqaXR0ZXIgPSBfYkRpci5zZXQoKE1hdGgucmFuZG9tKCktMC41KSowLjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yLCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuMik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGF3blBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLmFkZChqaXR0ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3Bhd25Qb3MueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdidWJibGVfbWljcm8nLCBzcGF3blBvcywgeyBzY2FsZTogMC4wNCArIE1hdGgucmFuZG9tKCkgKiAwLjA2IH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4wNTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgovLyBTdHJheSBjb2RlIGJsb2NrIHJlbW92ZWQKCmdyYWIocGxheWVyKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50OiBQb3NzZXNzaW9uIChpZiB0YWtpbmcgZnJvbSBmcmVlIHN0YXRlKQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCgiUE9TU0VTU0lPTiIsICJub3JtYWwiKTsKICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIFR1cm5vdmVyIChQb3NzZXNzaW9uIENoYW5nZSkKICAgICAgICAgICAgY29uc3QgcHJldmlvdXNUZWFtID0gdGhpcy5ob2xkZXIgPyB0aGlzLmhvbGRlci50ZWFtIDogKHRoaXMubGFzdEhvbGRlciA/IHRoaXMubGFzdEhvbGRlci50ZWFtIDogbnVsbCk7CiAgICAgICAgICAgIGlmIChwcmV2aW91c1RlYW0gJiYgcHJldmlvdXNUZWFtICE9PSBwbGF5ZXIudGVhbSkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJUVVJOT1ZFUiIsIHBsYXllci5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgc29tZW9uZSBlbHNlIGhlbGQgaXQsIHRoZXkgbG9zZSBpdAogICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIgIT09IHBsYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIubG9zZUJhbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBwbGF5ZXI7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaGVsZCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOT1RFOiBXZSBkbyBOT1QgcGFyZW50IHRoZSBtZXNoIHRvIHRoZSBwbGF5ZXIgYW55bW9yZS4KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyB0aGUgYmFsbCBmcm9tIGZseWluZyBhcm91bmQgZHVlIHRvIHN3aW0gYW5pbWF0aW9ucy4KICAgICAgICAgICAgLy8gSW5zdGVhZCwgd2UgdXBkYXRlIGl0cyBwb3NpdGlvbiBtYW51YWxseSBpbiB1cGRhdGVIZWxkKCkuCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3RpZnkgcGxheWVyCiAgICAgICAgICAgIGlmIChwbGF5ZXIucmVjZWl2ZUJhbGwpIHsKICAgICAgICAgICAgICAgIHBsYXllci5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zb2xlLmxvZygiQmFsbCBncmFiYmVkIGJ5ICIgKyBwbGF5ZXIucm9sZSk7CiAgICAgICAgfQoKICAgICAgICBkcm9wKCkgewogICAgICAgICAgICB0aGlzLnJldmVhbCgpOyAvLyBFbnN1cmUgdmlzaWJsZQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm8gbmVlZCB0byBkZXRhY2ggZnJvbSBzY2VuZSBncmFwaCBzaW5jZSB3ZSBhcmVuJ3QgcGFyZW50aW5nIHRvIHBsYXllciBhbnltb3JlLgogICAgICAgICAgICAvLyBKdXN0IGNsZWFyIGhvbGRlci4KCiAgICAgICAgICAgIGlmICh0aGlzLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmxvc2VCYWxsKSB0aGlzLmhvbGRlci5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIH0KLy8gU2hvb3QvUGFzcwovLyBTaG9vdC9QYXNzCiAgICAgICAgc2hvb3QoZGlyZWN0aW9uVmVjdG9yLCBmb3JjZSwgdHlwZSA9ICdTSCcsIHRlY2huaXF1ZSA9IG51bGwsIHNwaW5WZWN0b3IgPSBudWxsKSB7CgogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSB0aGlzLmhvbGRlcjsgLy8gUmVjb3JkIGZvciBFWFAgYXR0cmlidXRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZ1bWJsZSBEZXRlY3Rpb24gKFR5cGUgJ25vbmUnIGlzIHVzZWQgYnkgUGxheWVyLmZ1bWJsZSkKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdub25lJykgewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KCJGVU1CTEUhIiwgInNsYW0iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5kcm9wKCk7IC8vIERldGFjaCBmaXJzdAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0IEdyYWNlIFBlcmlvZCB0byBwcmV2ZW50IGluc3RhbnQgaW50ZXJjZXB0aW9ucy9jYXRjaGVzCiAgICAgICAgICAgIC8vIDAuMnMgYWxsb3dzIGJhbGwgdG8gY2xlYXIgdGhlIHRocm93ZXIncyBpbW1lZGlhdGUgdmljaW5pdHkKICAgICAgICAgICAgdGhpcy5jYXRjaEdyYWNlUGVyaW9kID0gMC4yOwoKICAgICAgICAgICAgLy8gUGh5c2ljYWwgVmVsb2NpdHkgKFZpc3VhbCBzcGVlZCkKICAgICAgICAgICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcgfHwge307CiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKEMuTEFVTkNIX1NQRUVEX1NDQUxFICE9PSB1bmRlZmluZWQgPyBDLkxBVU5DSF9TUEVFRF9TQ0FMRSA6IDEuMCk7CiAgICAgICAgICAgIGNvbnN0IGNhcCA9IChDLkxBVU5DSF9TUEVFRF9DQVAgIT09IHVuZGVmaW5lZCA/IEMuTEFVTkNIX1NQRUVEX0NBUCA6IDg1LjApOwogICAgICAgICAgICBjb25zdCBzcGVlZCA9IE1hdGgubWluKGZvcmNlICogc2NhbGUsIGNhcCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuY29weShkaXJlY3Rpb25WZWN0b3IpLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKHNwZWVkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IFNwaW4gaWYgcHJvdmlkZWQKICAgICAgICAgICAgaWYgKHNwaW5WZWN0b3IpIHsKICAgICAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LmNvcHkoc3BpblZlY3Rvcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN0YXQgUG93ZXIgKEdhbWUgTG9naWMpCiAgICAgICAgICAgIHRoaXMucG93ZXIgPSBmb3JjZTsKICAgICAgICAgICAgdGhpcy5wb3dlclR5cGUgPSB0eXBlOwogICAgICAgICAgICB0aGlzLnRlY2huaXF1ZSA9IHRlY2huaXF1ZTsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVHJhaWwgQ29sb3IKICAgICAgICAgICAgaWYgKHRoaXMudHJhaWwpIHsKICAgICAgICAgICAgICAgIGxldCBjb2xvciA9IDB4MDBhYWZmOyAvLyBEZWZhdWx0IEJsdWUgKFBhc3MpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZWNobmlxdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICd2ZW5vbScpIGNvbG9yID0gMHgwMGZmMDA7IC8vIEdyZWVuIChWZW5vbSkKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ3dpdGhlcicpIGNvbG9yID0gMHg4ODg4ODg7IC8vIEdyZXkKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ25hcCcpIGNvbG9yID0gMHgwMDAwODg7IC8vIERhcmsgQmx1ZQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnc3BoZXJlJykgY29sb3IgPSAweDAwZmZmZjsgLy8gQ3lhbgogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnamVjaHQnKSBjb2xvciA9IDB4ZmYwMDAwOyAvLyBSZWQKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIGNvbG9yID0gMHg0NDQ0NDQ7IC8vIERhcmsgR3JleQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgPSAweGZmNDQwMDsgLy8gT3JhbmdlL1JlZAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLnRyYWlsLnNldENvbG9yKGNvbG9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGFuZGxlIEludmlzaWJsZSBTaG90CiAgICAgICAgICAgIGlmICh0ZWNobmlxdWUgJiYgdGVjaG5pcXVlLnR5cGUgPT09ICdpbnZpc2libGUnKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzSW52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBGWDogUG9vZgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignd2l0aGVyJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAyLjAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiSW52aXNpYmxlIFNob3QhIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCYWxsICR7dHlwZX0gd2l0aCBQb3dlcjogJHt0aGlzLnBvd2VyLnRvRml4ZWQoMSl9IFNwaW46ICR7dGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkudG9GaXhlZCgxKX1gKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjayBmb3IgQ3VydmUKICAgICAgICAgICAgaWYgKHRoaXMuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aCgpID4gMTUuMCAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQ1VSVkUhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXZlYWwoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzSW52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICAvLyBGWDogUmV2ZWFsIFBvb2YKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlciAmJiB0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCd3aXRoZXInLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlzSW52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICB9CgovLyBEdXBsaWNhdGUgcmV2ZWFsIHJlbW92ZWQKICAgICAgICAKcmVzZXQoKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7CiAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwOwogICAgICAgICAgICB0aGlzLnBvd2VyID0gMDsKICAgICAgICB9CmlzQ2F0Y2hhYmxlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jYXRjaEdyYWNlUGVyaW9kIDw9IDA7CiAgICAgICAgfQoKX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmRlZm9ybU5vZGUgfHwgIXRoaXMuc3Bpbk5vZGUpIHJldHVybjsKCiAgICAgICAgICAgIC8vIDEuIFNxdWFzaCAmIFN0cmV0Y2ggYmFzZWQgb24gdmVsb2NpdHkKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHNwZWVkID4gMS4wICYmIHRoaXMuc3RhdGUgPT09ICdmcmVlJykgewogICAgICAgICAgICAgICAgY29uc3QgZGlyID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnF1YXRlcm5pb24uc2V0RnJvbVVuaXRWZWN0b3JzKG5ldyBUSFJFRS5WZWN0b3IzKDAsMCwxKSwgZGlyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZmFjdG9yID0gTWF0aC5taW4oc3BlZWQgLyA0MC4wLCAxLjApOyAKICAgICAgICAgICAgICAgIGNvbnN0IHN0cmV0Y2ggPSAxLjAgKyAoZmFjdG9yICogMC44KTsKICAgICAgICAgICAgICAgIGNvbnN0IHNxdWFzaCA9IDEuMCAvIE1hdGguc3FydChzdHJldGNoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnNjYWxlLnNldChzcXVhc2gsIHNxdWFzaCwgc3RyZXRjaCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUucXVhdGVybmlvbi5pZGVudGl0eSgpOwogICAgICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnNjYWxlLnNldCgxLCAxLCAxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gQXBwbHkgQWNjdW11bGF0ZWQgU3BpbgogICAgICAgICAgICBjb25zdCBpbnZEZWZvcm0gPSB0aGlzLmRlZm9ybU5vZGUucXVhdGVybmlvbi5jbG9uZSgpLmludmVydCgpOwogICAgICAgICAgICB0aGlzLnNwaW5Ob2RlLnF1YXRlcm5pb24uY29weShpbnZEZWZvcm0ubXVsdGlwbHkodGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uKSk7CgogICAgICAgICAgICAvLyAzLiBWaXN1YWwgcm90YXRpb24gaW50ZWdyYXRpb24KICAgICAgICAgICAgY29uc3Qgc3BpblNxID0gdGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHNwaW5TcSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5TcGVlZCA9IE1hdGguc3FydChzcGluU3EpOwogICAgICAgICAgICAgICAgY29uc3QgYXhpcyA9IF90ZW1wVmVjLmNvcHkodGhpcy5hbmd1bGFyVmVsb2NpdHkpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgY29uc3QgcSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShheGlzLCBzcGluU3BlZWQgKiBkdCk7CiAgICAgICAgICAgICAgICB0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24ucHJlbXVsdGlwbHkocSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoc3BlZWQgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICBfdGVtcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLmNyb3NzKF9heGlzWSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF90ZW1wVmVjLmxlbmd0aFNxKCkgPiAwLjAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUoX3RlbXBWZWMsIHNwZWVkICogZHQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24ucHJlbXVsdGlwbHkocSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKd2luZG93LmZsdXguQmFsbCA9IEJhbGw7CiAgICB3aW5kb3cuZmx1eC5UcmFpbFJlbmRlcmVyID0gVHJhaWxSZW5kZXJlcjsKfSkoKTs=","./Ball.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIHZlY3RvcnMgdG8gYXZvaWQgR0MKY29uc3QgX2JWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2JEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2F4aXNZID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CiAgICBjb25zdCBfdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbWFnbnVzVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCi8vIFBoeXNpY3MgQ29uZmlndXJhdGlvbiAoRXhwb3NlZCBmb3IgRGV2VG9vbHMpCndpbmRvdy5mbHV4LkJhbGxDb25maWcgPSB7CiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBDb3JlIGludGVncmF0aW9uCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBTVUJTVEVQUzogMiwgICAgICAgICAgICAgICAgLy8gUGh5c2ljcyBzdWJzdGVwcyBwZXIgZnJhbWUgKHN0YWJpbGl0eSBhdCBoaWdoIHNwZWVkcykKICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLCAgICAgICAgICAgLy8gQmVsb3cgdGhpcyBzcGVlZCwgc25hcCB0byByZXN0IChwcmV2ZW50cyBlbmRsZXNzIGRyaWZ0KQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFdhdGVyIHJlc2lzdGFuY2UgKHBoeXNpY2FsIHZlbG9jaXR5IGRyYWcsIE5PVCBzdGF0IGRlY2F5KQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMTUsICAgIC8vIExpbmVhciBkcmFnIHRlcm0gKHJvdWdobHkgeW91ciBwcmV2aW91cyBXQVRFUl9EUkFHKQogICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDIsICAgICAvLyBRdWFkcmF0aWMgZHJhZyAoc3Ryb25nZXIgYXQgaGlnaCBzcGVlZCwgaGVscHMgdGFtZSByb2NrZXRzKQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFNwaW4gJiBjdXJ2ZQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgU1BJTl9EUkFHOiAwLjQwLCAgICAgICAgICAgIC8vIFNwaW4gZGVjYXkgcGVyIHNlY29uZAogICAgICAgIE1BR05VU19FTkFCTEVEOiB0cnVlLAogICAgICAgIE1BR05VU19DT0VGRjogMC4wOCwgICAgICAgICAvLyBMaWZ0IHN0cmVuZ3RoCiAgICAgICAgTUFHTlVTX0NBUDogNjAuMCwgICAgICAgICAgIC8vIE1heCBtYWdudXMgZGVsdGEtViBwZXIgc3Vic3RlcCAocHJldmVudHMgZXhwbG9zaW9ucykKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBEZXB0aCBjb25zdHJhaW50IChrZWVwcyBiYWxsIG5lYXIgcGxheSBwbGFuZSB3aXRob3V0IGZlZWxpbmcgbGlrZSBhIGhhcmQgZmxvb3IpCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBERVBUSF9UQVJHRVRfWTogMC4wLAogICAgICAgIERFUFRIX1NQUklORzogMS4wLCAgICAgICAgICAvLyBZb3VyIHByZXZpb3VzIEdSQVZJVFlfU1BSSU5HCiAgICAgICAgREVQVEhfREFNUDogMS41LCAgICAgICAgICAgIC8vIFlvdXIgcHJldmlvdXMgR1JBVklUWV9EQU1QCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gQXJlbmEgYm91bmRhcnkgKHNvZnQgd2FsbCArIGNsYW1wKQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCkJPVU5EQVJZX1JBRElVUzogNDYuMCwKICAgICAgICBHT0FMX0RJU1RBTkNFOiA0MS41LCAgICAgICAgLy8gRGlzdGFuY2Ugb2YgZ29hbCBmcm9tIGNlbnRlciAoWi1heGlzKQogICAgICAgIEJPVU5EQVJZX0hFSUdIVDogMjAuMCwKICAgICAgICBCT1VOREFSWV9IRUlHSFQ6IDIwLjAsCiAgICAgICAgR09BTF9QT0NLRVRfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBHT0FMX1BPQ0tFVF9YOiAxMi4wLCAgICAgICAgLy8gSGFsZi13aWR0aCBvZiBnb2FsIHBvY2tldCBjb3JyaWRvcgogICAgICAgIEdPQUxfUE9DS0VUX1o6IDQwLjAsICAgICAgICAvLyBTdGFydCBvZiBnb2FsIHBvY2tldCBjb3JyaWRvciAoYWJzIHopIC0gUHVzaGVkIGJhY2sKICAgICAgICBHT0FMX1BPQ0tFVF9SQURJVVM6IDU1LjAsICAgLy8gRWZmZWN0aXZlIHJhZGl1cyB3aGVuIGluIGdvYWwgcG9ja2V0CiAgICAgICAgV0FMTF9TT0ZUX0JVRkZFUjogMy4wLCAgICAgIC8vIERpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMKICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDIwLjAsICAgICAgLy8gU29mdCByZXB1bHNpb24gc3RyZW5ndGgKICAgICAgICBXQUxMX0VMQVNUSUNJVFk6IDAuMzAsICAgICAgLy8gQm91bmNlIGRhbXBlbmluZyBvbiBjbGFtcAogICAgICAgIFdBTExfRlJJQ1RJT046IDAuOTUsICAgICAgICAvLyBUYW5nZW50aWFsIGRhbXBpbmcgb24gd2FsbCBjb250YWN0CgogICAgICAgIEZMT09SX0VMQVNUSUNJVFk6IDAuNDAsICAgICAvLyBCb3VuY2UgZGFtcGVuaW5nIG9uIGNlaWxpbmcvZmxvb3IgY2xhbXAKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBUaHJvdyBtYXBwaW5nIChzdGF0IGZvcmNlIC0+IHBoeXNpY2FsIGxhdW5jaCBzcGVlZCkKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIExBVU5DSF9TUEVFRF9TQ0FMRTogMS4wLCAgICAvLyBNdWx0aXBsaWVzIGZvcmNlIHdoZW4gY29udmVydGluZyB0byB2ZWxvY2l0eQogICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDg1LjAgICAgICAvLyBQaHlzaWNhbCBzcGVlZCBjYXAgKHdhcyBoYXJkY29kZWQgaW4gQmFsbC5zaG9vdCkKICAgIH07CgoKICAgIAogICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWc7IC8vIExvY2FsIGFsaWFzIGZvciBicmV2aXR5CiAgICAvLyAtLS0gVFJBSUwgUkVOREVSRVIgLS0tCi8vIC0tLSBUUkFJTCBSRU5ERVJFUiAtLS0KICAgIGNsYXNzIFRyYWlsUmVuZGVyZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5zZWdtZW50cyA9IDMwOyAvLyBNb3JlIHNlZ21lbnRzIGZvciBzbW9vdGhlciBjdXJ2ZXMKICAgICAgICAgICAgdGhpcy5wb2ludHMgPSBbXTsKdGhpcy5iYXNlV2lkdGggPSAwLjg7IC8vIEluY3JlYXNlZCB3aWR0aCBmb3IgdmlzaWJpbGl0eQogICAgICAgICAgICB0aGlzLmN1cnJlbnRXaWR0aCA9IDAuODsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJ5CiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgICAgIGNvbnN0IHBvc0RhdGEgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuc2VnbWVudHMgKiAyICogMyk7CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHBvc0RhdGEsIDMpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluZGljZXMKICAgICAgICAgICAgY29uc3QgaW5kaWNlcyA9IFtdOwogICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50cy0xOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhc2UgPSBpKjI7CiAgICAgICAgICAgICAgICBpbmRpY2VzLnB1c2goYmFzZSwgYmFzZSsxLCBiYXNlKzIpOwogICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGJhc2UrMSwgYmFzZSszLCBiYXNlKzIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEluZGV4KGluZGljZXMpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBjb2xvcjogMHgwMGFhZmYsCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLjksIC8vIEluY3JlYXNlZCBvcGFjaXR5CiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLm1lc2gpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW5pdCBwb2ludHMKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB0aGlzLnBvaW50cy5wdXNoKG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUmV1c2FibGUgdGVtcHMgKGF2b2lkIHBlci1mcmFtZSBhbGxvY2F0aW9ucyBvbiBtb2JpbGUpCiAgICAgICAgICAgIHRoaXMuX3RtcERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuX3RtcFRvQ2FtID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5fdG1wUmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXNldChwb3MpIHsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB0aGlzLnBvaW50c1tpXS5jb3B5KHBvcyk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlR2VvbWV0cnkoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgc2V0Q29sb3IoaGV4KSB7CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KGhleCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZShjdXJyZW50UG9zLCBzcGVlZFJhdGlvID0gMC4wKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXQoY3VycmVudFBvcyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCi8vIER5bmFtaWMgV2lkdGggYmFzZWQgb24gc3BlZWQgQU5EIFNQSU4gKFBvd2VyIFZpc3VhbCkKICAgICAgICAgICAgLy8gRmFzdCBiYWxsID0gVGhpY2tlci4gU3Bpbm5pbmcgYmFsbCA9IEV2ZW4gVGhpY2tlci4KICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgY29uc3Qgc3BpblJhdGlvID0gYmFsbCA/IE1hdGgubWluKDEuMCwgYmFsbC5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkgLyAzMC4wKSA6IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB0YXJnZXRXaWR0aCA9IHRoaXMuYmFzZVdpZHRoICogKDAuOCArIHNwZWVkUmF0aW8gKiAxLjIgKyBzcGluUmF0aW8gKiAyLjApOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRXaWR0aCArPSAodGFyZ2V0V2lkdGggLSB0aGlzLmN1cnJlbnRXaWR0aCkgKiAwLjI7IC8vIFNtb290aCB0cmFuc2l0aW9uCgogICAgICAgICAgICAvLyBTaGlmdCBwb2ludHMKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuc2VnbWVudHMgLSAxOyBpID4gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBvaW50c1tpXS5jb3B5KHRoaXMucG9pbnRzW2ktMV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucG9pbnRzWzBdLmNvcHkoY3VycmVudFBvcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVwZGF0ZUdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZUdlb21ldHJ5KCkgewogICAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5hcnJheTsKICAgICAgICAgICAgY29uc3QgY2FtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSA6IG51bGw7CiAgICAgICAgICAgIGlmICghY2FtKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IGNhbS5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgdGVtcERpciA9IHRoaXMuX3RtcERpcjsKICAgICAgICAgICAgY29uc3QgdGVtcFRvQ2FtID0gdGhpcy5fdG1wVG9DYW07CiAgICAgICAgICAgIGNvbnN0IHRlbXBSaWdodCA9IHRoaXMuX3RtcFJpZ2h0OwogICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5wb2ludHNbaV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRhcGVyIHdpZHRoIGFsb25nIHRyYWlsIGxlbmd0aAogICAgICAgICAgICAgICAgY29uc3QgdGFwZXIgPSAxLjAgLSBNYXRoLnBvdyhpIC8gdGhpcy5zZWdtZW50cywgMik7IC8vIFF1YWRyYXRpYyB0YXBlcgogICAgICAgICAgICAgICAgY29uc3QgdyA9IHRoaXMuY3VycmVudFdpZHRoICogdGFwZXI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIGlmIChpIDwgdGhpcy5zZWdtZW50cyAtIDEpIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wRGlyLnN1YlZlY3RvcnModGhpcy5wb2ludHNbaV0sIHRoaXMucG9pbnRzW2krMV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wRGlyLnN1YlZlY3RvcnModGhpcy5wb2ludHNbaS0xXSwgdGhpcy5wb2ludHNbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGVtcERpci5sZW5ndGhTcSgpIDwgMC4wMDAxKSB0ZW1wRGlyLnNldCgwLCAxLCAwKTsKICAgICAgICAgICAgICAgIHRlbXBEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRlbXBUb0NhbS5zdWJWZWN0b3JzKGNhbVBvcywgcCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0ZW1wUmlnaHQuY3Jvc3NWZWN0b3JzKHRlbXBEaXIsIHRlbXBUb0NhbSkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIodyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZlcnQgMQogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDBdID0gcC54IC0gdGVtcFJpZ2h0Lng7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgMV0gPSBwLnkgLSB0ZW1wUmlnaHQueTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAyXSA9IHAueiAtIHRlbXBSaWdodC56OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZXJ0IDIKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAzXSA9IHAueCArIHRlbXBSaWdodC54OwogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDRdID0gcC55ICsgdGVtcFJpZ2h0Lnk7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgNV0gPSBwLnogKyB0ZW1wUmlnaHQuejsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgfQogICAgfQpjbGFzcyBCYWxsIHsKCiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7IAogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSBudWxsOyAvLyBUcmFjayB3aG8gdGhyZXcgaXQgbGFzdCAoZm9yIEVYUC9Bc3Npc3RzKQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOyAvLyAnZnJlZScsICdoZWxkJywgJ21hZ25ldGl6ZWQnCiAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIENvbnRpbnVvdXMgU3RhdHMKICAgICAgICAgICAgdGhpcy5wb3dlciA9IDA7ICAgICAgLy8gQ3VycmVudCBQQSBvciBTSCB2YWx1ZQogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9ICdub25lJzsgLy8gJ1BBJyBvciAnU0gnCiAgICAgICAgICAgIHRoaXMuZGVjYXlSYXRlID0gMy4wOyAvLyBTdGF0IHBvaW50cyBsb3N0IHBlciBzZWNvbmQgKFdhdGVyIHJlc2lzdGFuY2UpCiAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7IC8vIFRpbWUgYmVmb3JlIGJhbGwgY2FuIGJlIGNhdWdodCBhZ2FpbgoKICAgICAgICAgICAgLy8gTWFnbmV0IFN5c3RlbQogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1hZ25ldER1cmF0aW9uID0gMC4yOyAKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gVmlzdWFscyAoU3F1YXNoICYgU3RyZXRjaCkKICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zcGluTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubW9kZWwgPSBudWxsOwoKdGhpcy5pbml0TWVzaCgpOwogICAgICAgICAgICB0aGlzLnRyYWlsID0gbmV3IFRyYWlsUmVuZGVyZXIoc2NlbmUpOwogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDA7Cn0KaW5pdE1lc2goKSB7CiAgICAgICAgICAgIC8vIEhpZXJhcmNoeTogTWVzaCAoUG9zKSAtPiBEZWZvcm0gKFNxdWFzaC9TdHJldGNoKSAtPiBTcGluIChSb3RhdGlvbikgLT4gTW9kZWwKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7Cgp0aGlzLmRlZm9ybU5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnkgPSAwLjA7IC8vIFJlc2V0IG9mZnNldCBzbyBiYWxsIGlzIGNlbnRlcmVkIG9uIG1lc2ggcG9zaXRpb24KICAgICAgICAgICAgdGhpcy5tZXNoLmFkZCh0aGlzLmRlZm9ybU5vZGUpOyAvLyBGaXg6IEFkZCBkZWZvcm1Ob2RlIHRvIG1lc2gKCiAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLmFkZCh0aGlzLnNwaW5Ob2RlKTsKCiAgICAgICAgICAgIC8vIFByb2NlZHVyYWwgUGxhY2Vob2xkZXIgVGV4dHVyZSAoQmxpdHpiYWxsLWlzaCkKICAgICAgICAgICAgY29uc3QgcGxhY2Vob2xkZXJUZXggPSAoKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAgICAgYy53aWR0aCA9IDEyODsgYy5oZWlnaHQgPSA2NDsKICAgICAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2VlZWVlZSc7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwwLDEyOCw2NCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEJsdWUgYnVtcHMvZGV0YWlscwogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDA4OGZmJzsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDY7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBjdHguYXJjKGkqMjUsIDMyLCAxMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDA0NDg4JzsKICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAyOCwgMTI4LCA4KTsgLy8gU3RyaXBlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICAgICAgfSkoKTsKCiAgICAgICAgICAgIC8vIFBsYWNlaG9sZGVyIFZpc3VhbCAoSW1tZWRpYXRlIGZlZWRiYWNrLCBwZXJzaXN0cyB1bnRpbCB2YWxpZCBtb2RlbCBsb2FkcykKLy8gUGxhY2Vob2xkZXIgVmlzdWFsIChJbW1lZGlhdGUgZmVlZGJhY2ssIHBlcnNpc3RzIHVudGlsIHZhbGlkIG1vZGVsIGxvYWRzKQovLyBQbGFjZWhvbGRlciBWaXN1YWwgKEltbWVkaWF0ZSBmZWVkYmFjaywgcGVyc2lzdHMgdW50aWwgdmFsaWQgbW9kZWwgbG9hZHMpCmNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDAuMywgMTYsIDE2KTsgLy8gU2NhbGVkIGRvd24gfjE1JQogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBtYXA6IHBsYWNlaG9sZGVyVGV4LAogICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAKICAgICAgICAgICAgICAgIHdpcmVmcmFtZTogZmFsc2UsIC8vIFNvbGlkCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAxLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwoKICAgICAgICAgICAgLy8gTG9hZCBHTEIgTW9kZWwKICAgICAgICAgICAgY29uc3QgdXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy81MjFhZTg3ODhlNTg0ZTM3OGE3OWQ5NzMyYTA3NTM1Ni5nbGInOwogICAgICAgICAgICAKICAgICAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKHVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJERUJVRzogQmFsbCBHTEIgbG9hZGVkLiIsIGdsdGYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBtb2RlbCA9IGdsdGYuc2NlbmU7CgogICAgICAgICAgICAgICAgLy8gMS4gUmVzZXQgcm9vdCB0cmFuc2Zvcm1zCiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBtb2RlbC5yb3RhdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBtb2RlbC5zY2FsZS5zZXQoMSwgMSwgMSk7CiAgICAgICAgICAgICAgICBtb2RlbC51cGRhdGVNYXRyaXhXb3JsZCh0cnVlKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBIYXJkZW4gTWF0ZXJpYWxzICYgVmlzaWJpbGl0eQogICAgICAgICAgICAgICAgbW9kZWwudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5jYXN0U2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVjZWl2ZVNoYWRvdyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsgLy8gQ1JJVElDQUw6IFByZXZlbnQgY3VsbGluZyBpZiBib3VuZHMgYXJlIG9mZgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hdHMgPSBBcnJheS5pc0FycmF5KG5vZGUubWF0ZXJpYWwpID8gbm9kZS5tYXRlcmlhbCA6IFtub2RlLm1hdGVyaWFsXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdHMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLmNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIEZvcmNlIHdoaXRlIGJhc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnNpZGUgPSBUSFJFRS5Eb3VibGVTaWRlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5hbHBoYVRlc3QgPSAwOyAvLyBDUklUSUNBTDogRGlzYWJsZSBhbHBoYSB0ZXN0IHRvIHByZXZlbnQgY3VsbGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5kZXB0aFRlc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyAzLiBDb21wdXRlIEJvdW5kaW5nIEJveAogICAgICAgICAgICAgICAgY29uc3QgYm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KG1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNpemUgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgYm94LmdldFNpemUoc2l6ZSk7CiAgICAgICAgICAgICAgICBjb25zdCBjZW50ZXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgYm94LmdldENlbnRlcihjZW50ZXIpOwoKICAgICAgICAgICAgICAgIC8vIDQuIFZhbGlkYXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IG1heERpbSA9IE1hdGgubWF4KHNpemUueCwgc2l6ZS55LCBzaXplLnopOwogICAgICAgICAgICAgICAgaWYgKG1heERpbSA8PSAwLjAwMSB8fCAhaXNGaW5pdGUobWF4RGltKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBtb2RlbCBoYXMgaW52YWxpZCBkaW1lbnNpb25zLiBLZWVwaW5nIHBsYWNlaG9sZGVyLiIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gNS4gQ2FsY3VsYXRlIFNjYWxlCi8vIDUuIENhbGN1bGF0ZSBTY2FsZQpjb25zdCB0YXJnZXREaWFtZXRlciA9IDAuNzI7IC8vIFJlZHVjZWQgc2NhbGUgYnkgfjE1JSAod2FzIDAuODUpCiAgICAgICAgICAgICAgICBjb25zdCBzY2FsZUZhY3RvciA9IHRhcmdldERpYW1ldGVyIC8gbWF4RGltOwoKICAgICAgICAgICAgICAgIC8vIDYuIEFwcGx5IFRyYW5zZm9ybXMKICAgICAgICAgICAgICAgIG1vZGVsLnNjYWxlLnNldFNjYWxhcihzY2FsZUZhY3Rvcik7CiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5jb3B5KGNlbnRlcikubXVsdGlwbHlTY2FsYXIoLXNjYWxlRmFjdG9yKTsKCiAgICAgICAgICAgICAgICAvLyA3LiBTd2FwIFBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucmVtb3ZlKHRoaXMucGxhY2Vob2xkZXIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5KSB0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsID0gbW9kZWw7CiAgICAgICAgICAgICAgICB0aGlzLnNwaW5Ob2RlLmFkZCh0aGlzLm1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCbGl0emJhbGwgbW9kZWwgYXR0YWNoZWQuIFNjYWxlOiAke3NjYWxlRmFjdG9yLnRvRml4ZWQoNCl9YCk7CgogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBsb2FkIEJsaXR6YmFsbCBtb2RlbDoiLCBlcnIpOwogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2s6IEtlZXAgcGxhY2Vob2xkZXIgYnV0IHRpbnQgaXQgcmVkIHRvIGluZGljYXRlIGVycm9yCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZhYWFhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIFdyYXBwZXIgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkKICAgICAgICAgICAgdGhpcy51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIEJhbGwgTGFiIHJlcGxheSBvdmVycmlkZSAoUGh5c2ljcyBjb250cm9sKQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzICYmIHR5cGVvZiBfX2xhYi5hcHBseVJlcGxheUZyYW1lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBfX2xhYi5hcHBseVJlcGxheUZyYW1lKHRoaXMsIGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBpZiBwb3NpdGlvbiBjb3JydXB0ZWQKICAgICAgICAgICAgaWYgKGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi54KSB8fCBpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueSkgfHwgaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLnopKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNhZmV0eTogRml4ICJVbnBpY2thYmxlIEJhbGwiIEJ1ZwogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2hlbGQnICYmICghdGhpcy5ob2xkZXIgfHwgIXRoaXMuaG9sZGVyLm1lc2gpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ21hZ25ldGl6ZWQnKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMubWFnbmV0VGFyZ2V0IHx8ICF0aGlzLm1hZ25ldFRhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tYWduZXRUaW1lciA+IDIuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBzdHVjayBpbiBtYWduZXRpemVkIHN0YXRlLiBEcm9wcGluZy4iKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHRoaXMuaG9sZGVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdmcmVlJyAmJiB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAwLjUpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaGVsZCcgJiYgdGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVIZWxkKGR0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTWFnbmV0aXplZChkdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVGcmVlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYXRjaEdyYWNlUGVyaW9kIDwgMCkgdGhpcy5jYXRjaEdyYWNlUGVyaW9kID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQmFsbCBMYWIgcmVwbGF5IG92ZXJyaWRlIChWaXN1YWxzKQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgdGhpcy50cmFpbC5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgewogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgdGhpcy50cmFpbC5hY3RpdmUgPSAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHNwZWVkID4gMi4wKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2JWZWMuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgX2JWZWMueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKCiAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHNwZWVkIC8gNjAuMCwgMS4wKTsKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwudXBkYXRlKF9iVmVjLCByYXRpbyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVQYXJ0aWNsZXMoZHQpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMubWVzaCAmJiAhdGhpcy5pc0ludmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubW9kZWwpIHRoaXMubW9kZWwudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgptYWduZXRpemUodGFyZ2V0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcgfHwgdGhpcy5zdGF0ZSA9PT0gJ2hlbGQnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ21hZ25ldGl6ZWQnOwogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSB0YXJnZXQ7IC8vIExvZ2ljYWwgcG9zc2Vzc2lvbiBzbyBBSSByZWFjdHMKICAgICAgICAgICAgdGhpcy5tYWduZXRUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRQb3MuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLm1hZ25ldFN0YXJ0VmVsLmNvcHkodGhpcy52ZWxvY2l0eSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEeW5hbWljIER1cmF0aW9uIGJhc2VkIG9uIGRpc3RhbmNlIChTbW9vdGhlciBmb3IgbG9uZyByYW5nZSwgc25hcHB5IGZvciBjbG9zZSkKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5tYWduZXREdXJhdGlvbiA9IE1hdGgubWF4KDAuMTUsIE1hdGgubWluKDAuNCwgZGlzdCAvIDE1LjApKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEtpbGwgcGh5c2ljcwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gTm90aWZ5IHBsYXllciBpbW1lZGlhdGVseSBzbyB0aGV5IHN0b3AgY2hhc2luZyBhbmQgcGxheSBhbmltYXRpb24KICAgICAgICAgICAgaWYgKHRhcmdldC5yZWNlaXZlQmFsbCkgewogICAgICAgICAgICAgICAgdGFyZ2V0LnJlY2VpdmVCYWxsKCk7CiAgICAgICAgICAgIH0KCnRoaXMucmV2ZWFsKCk7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdjYXRjaCcsIHsgdm9sdW1lOiAwLjYgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGVNYWduZXRpemVkKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tYWduZXRUYXJnZXQgfHwgIXRoaXMubWFnbmV0VGFyZ2V0Lm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm1hZ25ldFRpbWVyICs9IGR0OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm9ybWFsaXplZCBUaW1lCiAgICAgICAgICAgIGxldCB0ID0gdGhpcy5tYWduZXRUaW1lciAvIHRoaXMubWFnbmV0RHVyYXRpb247CiAgICAgICAgICAgIGlmICh0ID4gMS4wKSB0ID0gMS4wOwoKICAgICAgICAgICAgLy8gVGFyZ2V0ICJWaXJ0dWFsIEhhbmQiIFBvc2l0aW9uIChGcm9udCBvZiBDaGVzdCkKICAgICAgICAgICAgY29uc3QgaG9sZGVyUG9zID0gdGhpcy5tYWduZXRUYXJnZXQubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgaG9sZGVyUXVhdCA9IHRoaXMubWFnbmV0VGFyZ2V0Lm1lc2gucXVhdGVybmlvbjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9mZnNldDogRm9yd2FyZCAwLjYsIFVwIDEuMCAoQ2hlc3QgaGVpZ2h0KQogICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBfYlZlYy5zZXQoMCwgMS4wLCAwLjYpLmFwcGx5UXVhdGVybmlvbihob2xkZXJRdWF0KTsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9zID0gb2Zmc2V0LmFkZChob2xkZXJQb3MpOwoKICAgICAgICAgICAgLy8gLS0tIFFVQURSQVRJQyBCRVpJRVIgQ1VSVkUgLS0tCiAgICAgICAgICAgIC8vIFAwID0gU3RhcnQsIFAyID0gVGFyZ2V0CiAgICAgICAgICAgIC8vIFAxID0gQ29udHJvbCBQb2ludCAoUHJvamVjdGVkIGFsb25nIGluaXRpYWwgdmVsb2NpdHkgdG8gcHJlc2VydmUgbW9tZW50dW0gZmVlbCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHAwID0gdGhpcy5tYWduZXRTdGFydFBvczsKICAgICAgICAgICAgY29uc3QgcDIgPSB0YXJnZXRQb3M7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDYWxjdWxhdGUgUDEgKENvbnRyb2wgUG9pbnQpCiAgICAgICAgICAgIC8vIFByb2plY3QgZm9yd2FyZCBmcm9tIFAwIGFsb25nIHN0YXJ0IHZlbG9jaXR5IHZlY3RvcgogICAgICAgICAgICAvLyBEaXN0YW5jZSBvZiBwcm9qZWN0aW9uID0gNDAlIG9mIHRvdGFsIGRpc3RhbmNlIHRvIHRhcmdldAogICAgICAgICAgICBjb25zdCBkaXN0ID0gcDAuZGlzdGFuY2VUbyhwMik7CiAgICAgICAgICAgIGNvbnN0IHAxID0gX3RlbXBWZWMuY29weShwMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2ZWxMZW4gPSB0aGlzLm1hZ25ldFN0YXJ0VmVsLmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGlmICh2ZWxMZW4gPiAxLjApIHsKICAgICAgICAgICAgICAgIC8vIFVzZSB2ZWxvY2l0eSB0YW5nZW50Ci8vIFVzZSB2ZWxvY2l0eSB0YW5nZW50CiAgICAgICAgICAgICAgICBfYkRpci5jb3B5KHRoaXMubWFnbmV0U3RhcnRWZWwpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgcDEuYWRkKF9iRGlyLm11bHRpcGx5U2NhbGFyKGRpc3QgKiAwLjQpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE5vIHZlbG9jaXR5IChzdGF0aW9uYXJ5IGJhbGwpLCBhcmMgdXB3YXJkcyBzbGlnaHRseQogICAgICAgICAgICAgICAgcDEubGVycChwMiwgMC41KTsKICAgICAgICAgICAgICAgIHAxLnkgKz0gMS41OyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmV6aWVyOiBCKHQpID0gKDEtdCleMiAqIFAwICsgMigxLXQpdCAqIFAxICsgdF4yICogUDIKICAgICAgICAgICAgY29uc3Qgb25lTWludXNUID0gMS4wIC0gdDsKICAgICAgICAgICAgY29uc3QgdzAgPSBvbmVNaW51c1QgKiBvbmVNaW51c1Q7CiAgICAgICAgICAgIGNvbnN0IHcxID0gMi4wICogb25lTWludXNUICogdDsKICAgICAgICAgICAgY29uc3QgdzIgPSB0ICogdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi54ID0gKHcwICogcDAueCkgKyAodzEgKiBwMS54KSArICh3MiAqIHAyLngpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9ICh3MCAqIHAwLnkpICsgKHcxICogcDEueSkgKyAodzIgKiBwMi55KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSAodzAgKiBwMC56KSArICh3MSAqIHAxLnopICsgKHcyICogcDIueik7CgogICAgICAgICAgICAvLyBGaW5pc2gKICAgICAgICAgICAgaWYgKHQgPj0gMS4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdyYWIodGhpcy5tYWduZXRUYXJnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlSGVsZChkdCkgewogICAgICAgICAgICAvLyBBVFRBQ0hFRCBTVEFURSAoVmlydHVhbCBBdHRhY2htZW50KQogICAgICAgICAgICBpZiAoIXRoaXMuaG9sZGVyIHx8ICF0aGlzLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIDEuIFRyeSB0byB1c2UgSGFuZCBCb25lIGlmIGF2YWlsYWJsZSAoUmVhbGlzbSkKICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmhhbmRCb25lKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgd29ybGQgcG9zaXRpb24gb2YgdGhlIGhhbmQgYm9uZQogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIuaGFuZEJvbmUuZ2V0V29ybGRQb3NpdGlvbih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBZGp1c3Qgc2xpZ2h0bHkgdG8gc2l0IElOIHRoZSBoYW5kIHJhdGhlciB0aGFuIE9OIHRoZSB3cmlzdAogICAgICAgICAgICAgICAgLy8gV2UgY2FuJ3QgZWFzaWx5IGtub3cgImZvcndhcmQiIGZvciB0aGUgYm9uZSB3aXRob3V0IG1vcmUgaW5mbywgCiAgICAgICAgICAgICAgICAvLyBidXQgdXN1YWxseSBHTFRGIGJvbmVzIGFyZSBvcmllbnRlZC4gRm9yIG5vdywgZXhhY3QgYm9uZSBwb3MgaXMgYmV0dGVyIHRoYW4gY2hlc3QuCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAyLiBGYWxsYmFjazogQ2FsY3VsYXRlICJDYXJyeWluZyIgUG9zaXRpb24gKFJpZ2h0IEhhbmQgU2lkZSkKICAgICAgICAgICAgICAgIC8vIFJlbGF0aXZlIHRvIHBsYXllcjogVXAgMC44IChXYWlzdC9DaGVzdCksIFJpZ2h0IDAuNCwgRm9yd2FyZCAwLjUKICAgICAgICAgICAgICAgIGNvbnN0IGhvbGRlclBvcyA9IHRoaXMuaG9sZGVyLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICBjb25zdCBob2xkZXJRdWF0ID0gdGhpcy5ob2xkZXIubWVzaC5xdWF0ZXJuaW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSZXVzZSBfYlZlYwovLyBSZXVzZSBfYlZlYwogICAgICAgICAgICAgICAgLy8gT2Zmc2V0OiB4PTAuMzUgKFJpZ2h0KSwgeT0xLjMgKENoZXN0L0hhbmRzKSwgej0wLjUgKEZvcndhcmQpCiAgICAgICAgICAgICAgICBfYlZlYy5zZXQoMC4zNSwgMS4zLCAwLjUpLmFwcGx5UXVhdGVybmlvbihob2xkZXJRdWF0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5jb3B5KGhvbGRlclBvcykuYWRkKF9iVmVjKTsKICAgICAgICAgICAgfQoKLy8gVmlzdWFsIEZsYWlyOiBTcGluIHRoZSBiYWxsIHNsb3dseQogICAgICAgICAgICBjb25zdCByb3RYID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDEsMCwwKSwgMiAqIGR0KTsKICAgICAgICAgICAgY29uc3Qgcm90WSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIDUgKiBkdCk7CiAgICAgICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5tdWx0aXBseShyb3RYKS5tdWx0aXBseShyb3RZKTsKICAgICAgICB9CgoKdXBkYXRlRnJlZShkdCkgewogICAgICAgICAgICAvLyBMZWdhY3kgd3JhcHBlcgogICAgICAgICAgICB0aGlzLl91cGRhdGVGcmVlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBhcnRpY2xlcyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZUZyZWVQaHlzaWNzKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnIHx8IHt9OwogICAgICAgICAgICBjb25zdCBzdWJzdGVwcyA9IE1hdGgubWF4KDEsIE1hdGguZmxvb3IoQy5TVUJTVEVQUyB8fCAxKSk7CiAgICAgICAgICAgIGNvbnN0IHN0ZXBEdCA9IGR0IC8gc3Vic3RlcHM7CgogICAgICAgICAgICBmb3IgKGxldCBzID0gMDsgcyA8IHN1YnN0ZXBzOyBzKyspIHsKICAgICAgICAgICAgICAgIC8vIEEpIE1hZ251cyBlZmZlY3QKICAgICAgICAgICAgICAgIGlmIChDLk1BR05VU19FTkFCTEVEICYmIHRoaXMuYW5ndWxhclZlbG9jaXR5ICYmIHRoaXMudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluU3EgPSB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZlbFNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChzcGluU3EgPiAwLjI1ICYmIHZlbFNxID4gMC4yNSkgewogICAgICAgICAgICAgICAgICAgICAgICBfbWFnbnVzVmVjLmNvcHkodGhpcy5hbmd1bGFyVmVsb2NpdHkpLmNyb3NzKHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKChDLk1BR05VU19DT0VGRiB8fCAwKSAqIHN0ZXBEdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhcCA9IChDLk1BR05VU19DQVAgIT09IHVuZGVmaW5lZCA/IEMuTUFHTlVTX0NBUCA6IDYwLjApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYWdMZW4gPSBfbWFnbnVzVmVjLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWFnTGVuID4gY2FwKSBfbWFnbnVzVmVjLm11bHRpcGx5U2NhbGFyKGNhcCAvIG1hZ0xlbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKF9tYWdudXNWZWMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBCKSBTcGluIGRlY2F5CiAgICAgICAgICAgICAgICBpZiAodGhpcy5hbmd1bGFyVmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluRHJhZyA9IE1hdGgubWF4KDAsIDEuMCAtIChDLlNQSU5fRFJBRyB8fCAwKSAqIHN0ZXBEdCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoc3BpbkRyYWcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEMpIERlcHRoIHNwcmluZwogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0WSA9IChDLkRFUFRIX1RBUkdFVF9ZICE9PSB1bmRlZmluZWQgPyBDLkRFUFRIX1RBUkdFVF9ZIDogMC4wKTsKICAgICAgICAgICAgICAgIGNvbnN0IHlFcnIgPSAodGhpcy5tZXNoLnBvc2l0aW9uLnkgLSB0YXJnZXRZKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAtPSB5RXJyICogKEMuREVQVEhfU1BSSU5HIHx8IDApICogc3RlcER0OwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IE1hdGgubWF4KDAsIDEuMCAtIChDLkRFUFRIX0RBTVAgfHwgMCkgKiBzdGVwRHQpOwoKICAgICAgICAgICAgICAgIC8vIEQpIERyYWcKICAgICAgICAgICAgICAgIGNvbnN0IHZMZW4gPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgaWYgKHZMZW4gPiAwLjAwMDAxKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGluID0gKEMuV0FURVJfRFJBR19MSU5FQVIgIT09IHVuZGVmaW5lZCA/IEMuV0FURVJfRFJBR19MSU5FQVIgOiAoQy5XQVRFUl9EUkFHIHx8IDApKSAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBxdWFkID0gKEMuV0FURVJfRFJBR19RVUFEIHx8IDApICogdkxlbiAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gbGluIC0gcXVhZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihkcmFnKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RvcCA9IChDLlNUT1BfU1BFRUQgfHwgMCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0b3AgPiAwICYmIHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKSA8IHN0b3AgKiBzdG9wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBFKSBNb3ZlCiAgICAgICAgICAgICAgICBfdGVtcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKHN0ZXBEdCk7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF90ZW1wVmVjKTsKCiAgICAgICAgICAgICAgICAvLyBGKSBTdGF0IHBvd2VyIGRlY2F5CiAgICAgICAgICAgICAgICBpZiAodGhpcy5wb3dlciA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBvd2VyIC09IHRoaXMuZGVjYXlSYXRlICogc3RlcER0OwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBvd2VyIDwgMCkgdGhpcy5wb3dlciA9IDA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRykgQm91bmRhcnkgbG9naWMKICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RYWiA9IE1hdGguc3FydChwb3MueCAqIHBvcy54ICsgcG9zLnogKiBwb3Mueik7CiAgICAgICAgICAgICAgICBjb25zdCBib3VuZGFyeVJhZGl1cyA9IChDLkJPVU5EQVJZX1JBRElVUyAhPT0gdW5kZWZpbmVkID8gQy5CT1VOREFSWV9SQURJVVMgOiAzMy4wKTsKICAgICAgICAgICAgICAgIGxldCBlZmZlY3RpdmVCb3VuZGFyeSA9IGJvdW5kYXJ5UmFkaXVzOwoKICAgICAgICAgICAgICAgIGlmIChDLkdPQUxfUE9DS0VUX0VOQUJMRUQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpbkdvYWxQb2NrZXQgPSAoTWF0aC5hYnMocG9zLngpIDwgKEMuR09BTF9QT0NLRVRfWCB8fCAxMi4wKSAmJiBNYXRoLmFicyhwb3MueikgPiAoQy5HT0FMX1BPQ0tFVF9aIHx8IDI1LjApKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5Hb2FsUG9ja2V0KSBlZmZlY3RpdmVCb3VuZGFyeSA9IChDLkdPQUxfUE9DS0VUX1JBRElVUyB8fCA0NS4wKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBzb2Z0QnVmZmVyID0gTWF0aC5tYXgoMC4wMSwgKEMuV0FMTF9TT0ZUX0JVRkZFUiAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX1NPRlRfQlVGRkVSIDogMy4wKSk7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RYWiA+IGVmZmVjdGl2ZUJvdW5kYXJ5IC0gc29mdEJ1ZmZlcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBlbmV0cmF0aW9uID0gZGlzdFhaIC0gKGVmZmVjdGl2ZUJvdW5kYXJ5IC0gc29mdEJ1ZmZlcik7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBwZW5ldHJhdGlvbiAvIHNvZnRCdWZmZXIpKTsKICAgICAgICAgICAgICAgICAgICBfdGVtcFZlYy5zZXQoLXBvcy54LCAwLCAtcG9zLnopOwogICAgICAgICAgICAgICAgICAgIGlmIChfdGVtcFZlYy5sZW5ndGhTcSgpID4gMC4wMDAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmb3JjZSA9IHJhdGlvICogcmF0aW8gKiAoQy5XQUxMX1NPRlRfRk9SQ0UgfHwgMCkgKiBzdGVwRHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjLCBmb3JjZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChkaXN0WFogPiBlZmZlY3RpdmVCb3VuZGFyeSkgewogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjLnNldCgtcG9zLngsIDAsIC1wb3Mueik7CiAgICAgICAgICAgICAgICAgICAgaWYgKF90ZW1wVmVjLmxlbmd0aFNxKCkgPiAwLjAwMDEpIF90ZW1wVmVjLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG92ZXJsYXAgPSBkaXN0WFogLSBlZmZlY3RpdmVCb3VuZGFyeTsKICAgICAgICAgICAgICAgICAgICBwb3MuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjLCBvdmVybGFwKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB2RG90TiA9IHRoaXMudmVsb2NpdHkuZG90KF90ZW1wVmVjKTsKICAgICAgICAgICAgICAgICAgICBpZiAodkRvdE4gPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGltcGFjdFNwZWVkID0gTWF0aC5hYnModkRvdE4pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW1wYWN0U3BlZWQgPiAxMC4wICYmIHdpbmRvdy5mbHV4LnRyaWdnZXJBcmVuYUltcGFjdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KHBvcywgTWF0aC5taW4oaW1wYWN0U3BlZWQgKiAwLjUsIDE1LjApKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgnaW1wYWN0JywgeyB2b2x1bWU6IE1hdGgubWluKDEuMCwgaW1wYWN0U3BlZWQgKiAwLjA1KSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlID0gKEMuV0FMTF9FTEFTVElDSVRZICE9PSB1bmRlZmluZWQgPyBDLldBTExfRUxBU1RJQ0lUWSA6IDAuMyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGltcHVsc2UgPSBfdGVtcFZlYy5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKC12RG90TiAqICgxLjAgKyBlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKGltcHVsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmcmljdGlvbiA9IChDLldBTExfRlJJQ1RJT04gIT09IHVuZGVmaW5lZCA/IEMuV0FMTF9GUklDVElPTiA6IDAuOTUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0YW5nZW50ID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLnByb2plY3RPblBsYW5lKF90ZW1wVmVjKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zdWIodGFuZ2VudC5tdWx0aXBseVNjYWxhcigxLjAgLSBmcmljdGlvbikpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBiaCA9IChDLkJPVU5EQVJZX0hFSUdIVCAhPT0gdW5kZWZpbmVkID8gQy5CT1VOREFSWV9IRUlHSFQgOiAxNS4wKTsKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueSkgPiBiaCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNpZ24gPSBNYXRoLnNpZ24ocG9zLnkpIHx8IDE7CiAgICAgICAgICAgICAgICAgICAgcG9zLnkgPSBiaCAqIHNpZ247CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmUgPSAoQy5GTE9PUl9FTEFTVElDSVRZICE9PSB1bmRlZmluZWQgPyBDLkZMT09SX0VMQVNUSUNJVFkgOiAwLjQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSAtZmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVQYXJ0aWNsZXMoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2dob3N0KSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBzcGVlZFNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuX2J1YmJsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlciA6IG51bGw7CiAgICAgICAgICAgICAgICBpZiAocG0pIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoLTAuOCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RkUG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG9mZnNldCkuYWRkKF9iRGlyLnNldCgoTWF0aC5yYW5kb20oKS0wLjUpKjAuMywgKE1hdGgucmFuZG9tKCktMC41KSowLjMsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4zKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3RkUG9zLnkgKz0gdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZScsIHN0ZFBvcywgeyBzY2FsZTogMC40ICsgTWF0aC5yYW5kb20oKSAqIDAuNCB9KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHNwZWVkU3EgPiA1MC4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gTWF0aC5taW4oNCwgTWF0aC5mbG9vcihzcGVlZFNxIC8gNjApKTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBqaXR0ZXIgPSBfYkRpci5zZXQoKE1hdGgucmFuZG9tKCktMC41KSowLjQsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC40LCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuNCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGF3blBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLmFkZChqaXR0ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3Bhd25Qb3MueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdidWJibGVfbWljcm8nLCBzcGF3blBvcywgeyBzY2FsZTogMC4wNSArIE1hdGgucmFuZG9tKCkgKiAwLjEgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwLjAyOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gMC41KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBqaXR0ZXIgPSBfYkRpci5zZXQoKE1hdGgucmFuZG9tKCktMC41KSowLjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yLCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuMik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGF3blBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLmFkZChqaXR0ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3Bhd25Qb3MueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdidWJibGVfbWljcm8nLCBzcGF3blBvcywgeyBzY2FsZTogMC4wNCArIE1hdGgucmFuZG9tKCkgKiAwLjA2IH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4wNTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgovLyBTdHJheSBjb2RlIGJsb2NrIHJlbW92ZWQKCmdyYWIocGxheWVyKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50OiBQb3NzZXNzaW9uIChpZiB0YWtpbmcgZnJvbSBmcmVlIHN0YXRlKQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCgiUE9TU0VTU0lPTiIsICJub3JtYWwiKTsKICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIFR1cm5vdmVyIChQb3NzZXNzaW9uIENoYW5nZSkKICAgICAgICAgICAgY29uc3QgcHJldmlvdXNUZWFtID0gdGhpcy5ob2xkZXIgPyB0aGlzLmhvbGRlci50ZWFtIDogKHRoaXMubGFzdEhvbGRlciA/IHRoaXMubGFzdEhvbGRlci50ZWFtIDogbnVsbCk7CiAgICAgICAgICAgIGlmIChwcmV2aW91c1RlYW0gJiYgcHJldmlvdXNUZWFtICE9PSBwbGF5ZXIudGVhbSkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJUVVJOT1ZFUiIsIHBsYXllci5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgc29tZW9uZSBlbHNlIGhlbGQgaXQsIHRoZXkgbG9zZSBpdAogICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIgIT09IHBsYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIubG9zZUJhbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBwbGF5ZXI7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaGVsZCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOT1RFOiBXZSBkbyBOT1QgcGFyZW50IHRoZSBtZXNoIHRvIHRoZSBwbGF5ZXIgYW55bW9yZS4KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyB0aGUgYmFsbCBmcm9tIGZseWluZyBhcm91bmQgZHVlIHRvIHN3aW0gYW5pbWF0aW9ucy4KICAgICAgICAgICAgLy8gSW5zdGVhZCwgd2UgdXBkYXRlIGl0cyBwb3NpdGlvbiBtYW51YWxseSBpbiB1cGRhdGVIZWxkKCkuCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3RpZnkgcGxheWVyCiAgICAgICAgICAgIGlmIChwbGF5ZXIucmVjZWl2ZUJhbGwpIHsKICAgICAgICAgICAgICAgIHBsYXllci5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zb2xlLmxvZygiQmFsbCBncmFiYmVkIGJ5ICIgKyBwbGF5ZXIucm9sZSk7CiAgICAgICAgfQoKICAgICAgICBkcm9wKCkgewogICAgICAgICAgICB0aGlzLnJldmVhbCgpOyAvLyBFbnN1cmUgdmlzaWJsZQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm8gbmVlZCB0byBkZXRhY2ggZnJvbSBzY2VuZSBncmFwaCBzaW5jZSB3ZSBhcmVuJ3QgcGFyZW50aW5nIHRvIHBsYXllciBhbnltb3JlLgogICAgICAgICAgICAvLyBKdXN0IGNsZWFyIGhvbGRlci4KCiAgICAgICAgICAgIGlmICh0aGlzLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmxvc2VCYWxsKSB0aGlzLmhvbGRlci5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIH0KLy8gU2hvb3QvUGFzcwovLyBTaG9vdC9QYXNzCiAgICAgICAgc2hvb3QoZGlyZWN0aW9uVmVjdG9yLCBmb3JjZSwgdHlwZSA9ICdTSCcsIHRlY2huaXF1ZSA9IG51bGwsIHNwaW5WZWN0b3IgPSBudWxsKSB7CgogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSB0aGlzLmhvbGRlcjsgLy8gUmVjb3JkIGZvciBFWFAgYXR0cmlidXRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZ1bWJsZSBEZXRlY3Rpb24gKFR5cGUgJ25vbmUnIGlzIHVzZWQgYnkgUGxheWVyLmZ1bWJsZSkKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdub25lJykgewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KCJGVU1CTEUhIiwgInNsYW0iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5kcm9wKCk7IC8vIERldGFjaCBmaXJzdAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0IEdyYWNlIFBlcmlvZCB0byBwcmV2ZW50IGluc3RhbnQgaW50ZXJjZXB0aW9ucy9jYXRjaGVzCiAgICAgICAgICAgIC8vIDAuMnMgYWxsb3dzIGJhbGwgdG8gY2xlYXIgdGhlIHRocm93ZXIncyBpbW1lZGlhdGUgdmljaW5pdHkKICAgICAgICAgICAgdGhpcy5jYXRjaEdyYWNlUGVyaW9kID0gMC4yOwoKICAgICAgICAgICAgLy8gUGh5c2ljYWwgVmVsb2NpdHkgKFZpc3VhbCBzcGVlZCkKICAgICAgICAgICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcgfHwge307CiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKEMuTEFVTkNIX1NQRUVEX1NDQUxFICE9PSB1bmRlZmluZWQgPyBDLkxBVU5DSF9TUEVFRF9TQ0FMRSA6IDEuMCk7CiAgICAgICAgICAgIGNvbnN0IGNhcCA9IChDLkxBVU5DSF9TUEVFRF9DQVAgIT09IHVuZGVmaW5lZCA/IEMuTEFVTkNIX1NQRUVEX0NBUCA6IDg1LjApOwogICAgICAgICAgICBjb25zdCBzcGVlZCA9IE1hdGgubWluKGZvcmNlICogc2NhbGUsIGNhcCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuY29weShkaXJlY3Rpb25WZWN0b3IpLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKHNwZWVkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IFNwaW4gaWYgcHJvdmlkZWQKICAgICAgICAgICAgaWYgKHNwaW5WZWN0b3IpIHsKICAgICAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LmNvcHkoc3BpblZlY3Rvcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN0YXQgUG93ZXIgKEdhbWUgTG9naWMpCiAgICAgICAgICAgIHRoaXMucG93ZXIgPSBmb3JjZTsKICAgICAgICAgICAgdGhpcy5wb3dlclR5cGUgPSB0eXBlOwogICAgICAgICAgICB0aGlzLnRlY2huaXF1ZSA9IHRlY2huaXF1ZTsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVHJhaWwgQ29sb3IKICAgICAgICAgICAgaWYgKHRoaXMudHJhaWwpIHsKICAgICAgICAgICAgICAgIGxldCBjb2xvciA9IDB4MDBhYWZmOyAvLyBEZWZhdWx0IEJsdWUgKFBhc3MpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZWNobmlxdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICd2ZW5vbScpIGNvbG9yID0gMHgwMGZmMDA7IC8vIEdyZWVuIChWZW5vbSkKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ3dpdGhlcicpIGNvbG9yID0gMHg4ODg4ODg7IC8vIEdyZXkKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ25hcCcpIGNvbG9yID0gMHgwMDAwODg7IC8vIERhcmsgQmx1ZQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnc3BoZXJlJykgY29sb3IgPSAweDAwZmZmZjsgLy8gQ3lhbgogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnamVjaHQnKSBjb2xvciA9IDB4ZmYwMDAwOyAvLyBSZWQKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIGNvbG9yID0gMHg0NDQ0NDQ7IC8vIERhcmsgR3JleQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgPSAweGZmNDQwMDsgLy8gT3JhbmdlL1JlZAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLnRyYWlsLnNldENvbG9yKGNvbG9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGFuZGxlIEludmlzaWJsZSBTaG90CiAgICAgICAgICAgIGlmICh0ZWNobmlxdWUgJiYgdGVjaG5pcXVlLnR5cGUgPT09ICdpbnZpc2libGUnKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzSW52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBGWDogUG9vZgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignd2l0aGVyJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAyLjAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiSW52aXNpYmxlIFNob3QhIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCYWxsICR7dHlwZX0gd2l0aCBQb3dlcjogJHt0aGlzLnBvd2VyLnRvRml4ZWQoMSl9IFNwaW46ICR7dGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkudG9GaXhlZCgxKX1gKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjayBmb3IgQ3VydmUKICAgICAgICAgICAgaWYgKHRoaXMuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aCgpID4gMTUuMCAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQ1VSVkUhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXZlYWwoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzSW52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICAvLyBGWDogUmV2ZWFsIFBvb2YKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlciAmJiB0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCd3aXRoZXInLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlzSW52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICB9CgovLyBEdXBsaWNhdGUgcmV2ZWFsIHJlbW92ZWQKICAgICAgICAKcmVzZXQoKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7CiAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwOwogICAgICAgICAgICB0aGlzLnBvd2VyID0gMDsKICAgICAgICB9CmlzQ2F0Y2hhYmxlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jYXRjaEdyYWNlUGVyaW9kIDw9IDA7CiAgICAgICAgfQoKX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmRlZm9ybU5vZGUgfHwgIXRoaXMuc3Bpbk5vZGUpIHJldHVybjsKCiAgICAgICAgICAgIC8vIDEuIFNxdWFzaCAmIFN0cmV0Y2ggYmFzZWQgb24gdmVsb2NpdHkKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHNwZWVkID4gMS4wICYmIHRoaXMuc3RhdGUgPT09ICdmcmVlJykgewogICAgICAgICAgICAgICAgY29uc3QgZGlyID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnF1YXRlcm5pb24uc2V0RnJvbVVuaXRWZWN0b3JzKG5ldyBUSFJFRS5WZWN0b3IzKDAsMCwxKSwgZGlyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZmFjdG9yID0gTWF0aC5taW4oc3BlZWQgLyA0MC4wLCAxLjApOyAKICAgICAgICAgICAgICAgIGNvbnN0IHN0cmV0Y2ggPSAxLjAgKyAoZmFjdG9yICogMC44KTsKICAgICAgICAgICAgICAgIGNvbnN0IHNxdWFzaCA9IDEuMCAvIE1hdGguc3FydChzdHJldGNoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnNjYWxlLnNldChzcXVhc2gsIHNxdWFzaCwgc3RyZXRjaCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUucXVhdGVybmlvbi5pZGVudGl0eSgpOwogICAgICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnNjYWxlLnNldCgxLCAxLCAxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gQXBwbHkgQWNjdW11bGF0ZWQgU3BpbgogICAgICAgICAgICBjb25zdCBpbnZEZWZvcm0gPSB0aGlzLmRlZm9ybU5vZGUucXVhdGVybmlvbi5jbG9uZSgpLmludmVydCgpOwogICAgICAgICAgICB0aGlzLnNwaW5Ob2RlLnF1YXRlcm5pb24uY29weShpbnZEZWZvcm0ubXVsdGlwbHkodGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uKSk7CgogICAgICAgICAgICAvLyAzLiBWaXN1YWwgcm90YXRpb24gaW50ZWdyYXRpb24KICAgICAgICAgICAgY29uc3Qgc3BpblNxID0gdGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHNwaW5TcSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5TcGVlZCA9IE1hdGguc3FydChzcGluU3EpOwogICAgICAgICAgICAgICAgY29uc3QgYXhpcyA9IF90ZW1wVmVjLmNvcHkodGhpcy5hbmd1bGFyVmVsb2NpdHkpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgY29uc3QgcSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShheGlzLCBzcGluU3BlZWQgKiBkdCk7CiAgICAgICAgICAgICAgICB0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24ucHJlbXVsdGlwbHkocSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoc3BlZWQgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICBfdGVtcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLmNyb3NzKF9heGlzWSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF90ZW1wVmVjLmxlbmd0aFNxKCkgPiAwLjAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUoX3RlbXBWZWMsIHNwZWVkICogZHQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24ucHJlbXVsdGlwbHkocSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKd2luZG93LmZsdXguQmFsbCA9IEJhbGw7CiAgICB3aW5kb3cuZmx1eC5UcmFpbFJlbmRlcmVyID0gVHJhaWxSZW5kZXJlcjsKfSkoKTs=","/Ball.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSBtYXRoIHZlY3RvcnMgdG8gYXZvaWQgR0MKY29uc3QgX2JWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2JEaXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2F4aXNZID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCk7CiAgICBjb25zdCBfdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbWFnbnVzVmVjID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCi8vIFBoeXNpY3MgQ29uZmlndXJhdGlvbiAoRXhwb3NlZCBmb3IgRGV2VG9vbHMpCndpbmRvdy5mbHV4LkJhbGxDb25maWcgPSB7CiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBDb3JlIGludGVncmF0aW9uCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBTVUJTVEVQUzogMiwgICAgICAgICAgICAgICAgLy8gUGh5c2ljcyBzdWJzdGVwcyBwZXIgZnJhbWUgKHN0YWJpbGl0eSBhdCBoaWdoIHNwZWVkcykKICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLCAgICAgICAgICAgLy8gQmVsb3cgdGhpcyBzcGVlZCwgc25hcCB0byByZXN0IChwcmV2ZW50cyBlbmRsZXNzIGRyaWZ0KQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFdhdGVyIHJlc2lzdGFuY2UgKHBoeXNpY2FsIHZlbG9jaXR5IGRyYWcsIE5PVCBzdGF0IGRlY2F5KQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMTUsICAgIC8vIExpbmVhciBkcmFnIHRlcm0gKHJvdWdobHkgeW91ciBwcmV2aW91cyBXQVRFUl9EUkFHKQogICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDIsICAgICAvLyBRdWFkcmF0aWMgZHJhZyAoc3Ryb25nZXIgYXQgaGlnaCBzcGVlZCwgaGVscHMgdGFtZSByb2NrZXRzKQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFNwaW4gJiBjdXJ2ZQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgU1BJTl9EUkFHOiAwLjQwLCAgICAgICAgICAgIC8vIFNwaW4gZGVjYXkgcGVyIHNlY29uZAogICAgICAgIE1BR05VU19FTkFCTEVEOiB0cnVlLAogICAgICAgIE1BR05VU19DT0VGRjogMC4wOCwgICAgICAgICAvLyBMaWZ0IHN0cmVuZ3RoCiAgICAgICAgTUFHTlVTX0NBUDogNjAuMCwgICAgICAgICAgIC8vIE1heCBtYWdudXMgZGVsdGEtViBwZXIgc3Vic3RlcCAocHJldmVudHMgZXhwbG9zaW9ucykKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBEZXB0aCBjb25zdHJhaW50IChrZWVwcyBiYWxsIG5lYXIgcGxheSBwbGFuZSB3aXRob3V0IGZlZWxpbmcgbGlrZSBhIGhhcmQgZmxvb3IpCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBERVBUSF9UQVJHRVRfWTogMC4wLAogICAgICAgIERFUFRIX1NQUklORzogMS4wLCAgICAgICAgICAvLyBZb3VyIHByZXZpb3VzIEdSQVZJVFlfU1BSSU5HCiAgICAgICAgREVQVEhfREFNUDogMS41LCAgICAgICAgICAgIC8vIFlvdXIgcHJldmlvdXMgR1JBVklUWV9EQU1QCgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gQXJlbmEgYm91bmRhcnkgKHNvZnQgd2FsbCArIGNsYW1wKQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCkJPVU5EQVJZX1JBRElVUzogNDYuMCwKICAgICAgICBHT0FMX0RJU1RBTkNFOiA0MS41LCAgICAgICAgLy8gRGlzdGFuY2Ugb2YgZ29hbCBmcm9tIGNlbnRlciAoWi1heGlzKQogICAgICAgIEJPVU5EQVJZX0hFSUdIVDogMjAuMCwKICAgICAgICBCT1VOREFSWV9IRUlHSFQ6IDIwLjAsCiAgICAgICAgR09BTF9QT0NLRVRfRU5BQkxFRDogdHJ1ZSwKICAgICAgICBHT0FMX1BPQ0tFVF9YOiAxMi4wLCAgICAgICAgLy8gSGFsZi13aWR0aCBvZiBnb2FsIHBvY2tldCBjb3JyaWRvcgogICAgICAgIEdPQUxfUE9DS0VUX1o6IDQwLjAsICAgICAgICAvLyBTdGFydCBvZiBnb2FsIHBvY2tldCBjb3JyaWRvciAoYWJzIHopIC0gUHVzaGVkIGJhY2sKICAgICAgICBHT0FMX1BPQ0tFVF9SQURJVVM6IDU1LjAsICAgLy8gRWZmZWN0aXZlIHJhZGl1cyB3aGVuIGluIGdvYWwgcG9ja2V0CiAgICAgICAgV0FMTF9TT0ZUX0JVRkZFUjogMy4wLCAgICAgIC8vIERpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMKICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDIwLjAsICAgICAgLy8gU29mdCByZXB1bHNpb24gc3RyZW5ndGgKICAgICAgICBXQUxMX0VMQVNUSUNJVFk6IDAuMzAsICAgICAgLy8gQm91bmNlIGRhbXBlbmluZyBvbiBjbGFtcAogICAgICAgIFdBTExfRlJJQ1RJT046IDAuOTUsICAgICAgICAvLyBUYW5nZW50aWFsIGRhbXBpbmcgb24gd2FsbCBjb250YWN0CgogICAgICAgIEZMT09SX0VMQVNUSUNJVFk6IDAuNDAsICAgICAvLyBCb3VuY2UgZGFtcGVuaW5nIG9uIGNlaWxpbmcvZmxvb3IgY2xhbXAKCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBUaHJvdyBtYXBwaW5nIChzdGF0IGZvcmNlIC0+IHBoeXNpY2FsIGxhdW5jaCBzcGVlZCkKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIExBVU5DSF9TUEVFRF9TQ0FMRTogMS4wLCAgICAvLyBNdWx0aXBsaWVzIGZvcmNlIHdoZW4gY29udmVydGluZyB0byB2ZWxvY2l0eQogICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDg1LjAgICAgICAvLyBQaHlzaWNhbCBzcGVlZCBjYXAgKHdhcyBoYXJkY29kZWQgaW4gQmFsbC5zaG9vdCkKICAgIH07CgoKICAgIAogICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWc7IC8vIExvY2FsIGFsaWFzIGZvciBicmV2aXR5CiAgICAvLyAtLS0gVFJBSUwgUkVOREVSRVIgLS0tCi8vIC0tLSBUUkFJTCBSRU5ERVJFUiAtLS0KICAgIGNsYXNzIFRyYWlsUmVuZGVyZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5zZWdtZW50cyA9IDMwOyAvLyBNb3JlIHNlZ21lbnRzIGZvciBzbW9vdGhlciBjdXJ2ZXMKICAgICAgICAgICAgdGhpcy5wb2ludHMgPSBbXTsKdGhpcy5iYXNlV2lkdGggPSAwLjg7IC8vIEluY3JlYXNlZCB3aWR0aCBmb3IgdmlzaWJpbGl0eQogICAgICAgICAgICB0aGlzLmN1cnJlbnRXaWR0aCA9IDAuODsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJ5CiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgICAgIGNvbnN0IHBvc0RhdGEgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuc2VnbWVudHMgKiAyICogMyk7CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHBvc0RhdGEsIDMpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluZGljZXMKICAgICAgICAgICAgY29uc3QgaW5kaWNlcyA9IFtdOwogICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50cy0xOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhc2UgPSBpKjI7CiAgICAgICAgICAgICAgICBpbmRpY2VzLnB1c2goYmFzZSwgYmFzZSsxLCBiYXNlKzIpOwogICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKGJhc2UrMSwgYmFzZSszLCBiYXNlKzIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlb21ldHJ5LnNldEluZGV4KGluZGljZXMpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBjb2xvcjogMHgwMGFhZmYsCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLjksIC8vIEluY3JlYXNlZCBvcGFjaXR5CiAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLm1lc2gpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW5pdCBwb2ludHMKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB0aGlzLnBvaW50cy5wdXNoKG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gUmV1c2FibGUgdGVtcHMgKGF2b2lkIHBlci1mcmFtZSBhbGxvY2F0aW9ucyBvbiBtb2JpbGUpCiAgICAgICAgICAgIHRoaXMuX3RtcERpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuX3RtcFRvQ2FtID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5fdG1wUmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXNldChwb3MpIHsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB0aGlzLnBvaW50c1tpXS5jb3B5KHBvcyk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlR2VvbWV0cnkoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgc2V0Q29sb3IoaGV4KSB7CiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KGhleCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZShjdXJyZW50UG9zLCBzcGVlZFJhdGlvID0gMC4wKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXQoY3VycmVudFBvcyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCi8vIER5bmFtaWMgV2lkdGggYmFzZWQgb24gc3BlZWQgQU5EIFNQSU4gKFBvd2VyIFZpc3VhbCkKICAgICAgICAgICAgLy8gRmFzdCBiYWxsID0gVGhpY2tlci4gU3Bpbm5pbmcgYmFsbCA9IEV2ZW4gVGhpY2tlci4KICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA/IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsIDogbnVsbDsKICAgICAgICAgICAgY29uc3Qgc3BpblJhdGlvID0gYmFsbCA/IE1hdGgubWluKDEuMCwgYmFsbC5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkgLyAzMC4wKSA6IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB0YXJnZXRXaWR0aCA9IHRoaXMuYmFzZVdpZHRoICogKDAuOCArIHNwZWVkUmF0aW8gKiAxLjIgKyBzcGluUmF0aW8gKiAyLjApOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRXaWR0aCArPSAodGFyZ2V0V2lkdGggLSB0aGlzLmN1cnJlbnRXaWR0aCkgKiAwLjI7IC8vIFNtb290aCB0cmFuc2l0aW9uCgogICAgICAgICAgICAvLyBTaGlmdCBwb2ludHMKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuc2VnbWVudHMgLSAxOyBpID4gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBvaW50c1tpXS5jb3B5KHRoaXMucG9pbnRzW2ktMV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucG9pbnRzWzBdLmNvcHkoY3VycmVudFBvcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVwZGF0ZUdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZUdlb21ldHJ5KCkgewogICAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5hcnJheTsKICAgICAgICAgICAgY29uc3QgY2FtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSA6IG51bGw7CiAgICAgICAgICAgIGlmICghY2FtKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IGNhbS5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgdGVtcERpciA9IHRoaXMuX3RtcERpcjsKICAgICAgICAgICAgY29uc3QgdGVtcFRvQ2FtID0gdGhpcy5fdG1wVG9DYW07CiAgICAgICAgICAgIGNvbnN0IHRlbXBSaWdodCA9IHRoaXMuX3RtcFJpZ2h0OwogICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8dGhpcy5zZWdtZW50czsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5wb2ludHNbaV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFRhcGVyIHdpZHRoIGFsb25nIHRyYWlsIGxlbmd0aAogICAgICAgICAgICAgICAgY29uc3QgdGFwZXIgPSAxLjAgLSBNYXRoLnBvdyhpIC8gdGhpcy5zZWdtZW50cywgMik7IC8vIFF1YWRyYXRpYyB0YXBlcgogICAgICAgICAgICAgICAgY29uc3QgdyA9IHRoaXMuY3VycmVudFdpZHRoICogdGFwZXI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIGlmIChpIDwgdGhpcy5zZWdtZW50cyAtIDEpIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wRGlyLnN1YlZlY3RvcnModGhpcy5wb2ludHNbaV0sIHRoaXMucG9pbnRzW2krMV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wRGlyLnN1YlZlY3RvcnModGhpcy5wb2ludHNbaS0xXSwgdGhpcy5wb2ludHNbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGVtcERpci5sZW5ndGhTcSgpIDwgMC4wMDAxKSB0ZW1wRGlyLnNldCgwLCAxLCAwKTsKICAgICAgICAgICAgICAgIHRlbXBEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRlbXBUb0NhbS5zdWJWZWN0b3JzKGNhbVBvcywgcCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB0ZW1wUmlnaHQuY3Jvc3NWZWN0b3JzKHRlbXBEaXIsIHRlbXBUb0NhbSkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIodyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZlcnQgMQogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDBdID0gcC54IC0gdGVtcFJpZ2h0Lng7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgMV0gPSBwLnkgLSB0ZW1wUmlnaHQueTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAyXSA9IHAueiAtIHRlbXBSaWdodC56OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBWZXJ0IDIKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpKjYgKyAzXSA9IHAueCArIHRlbXBSaWdodC54OwogICAgICAgICAgICAgICAgcG9zaXRpb25zW2kqNiArIDRdID0gcC55ICsgdGVtcFJpZ2h0Lnk7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSo2ICsgNV0gPSBwLnogKyB0ZW1wUmlnaHQuejsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgfQogICAgfQpjbGFzcyBCYWxsIHsKCiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7IAogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSBudWxsOyAvLyBUcmFjayB3aG8gdGhyZXcgaXQgbGFzdCAoZm9yIEVYUC9Bc3Npc3RzKQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOyAvLyAnZnJlZScsICdoZWxkJywgJ21hZ25ldGl6ZWQnCiAgICAgICAgICAgIHRoaXMuaXNJbnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIENvbnRpbnVvdXMgU3RhdHMKICAgICAgICAgICAgdGhpcy5wb3dlciA9IDA7ICAgICAgLy8gQ3VycmVudCBQQSBvciBTSCB2YWx1ZQogICAgICAgICAgICB0aGlzLnBvd2VyVHlwZSA9ICdub25lJzsgLy8gJ1BBJyBvciAnU0gnCiAgICAgICAgICAgIHRoaXMuZGVjYXlSYXRlID0gMy4wOyAvLyBTdGF0IHBvaW50cyBsb3N0IHBlciBzZWNvbmQgKFdhdGVyIHJlc2lzdGFuY2UpCiAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7IC8vIFRpbWUgYmVmb3JlIGJhbGwgY2FuIGJlIGNhdWdodCBhZ2FpbgoKICAgICAgICAgICAgLy8gTWFnbmV0IFN5c3RlbQogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubWFnbmV0VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLm1hZ25ldER1cmF0aW9uID0gMC4yOyAKICAgICAgICAgICAgdGhpcy5tYWduZXRTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gVmlzdWFscyAoU3F1YXNoICYgU3RyZXRjaCkKICAgICAgICAgICAgdGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zcGluTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubW9kZWwgPSBudWxsOwoKdGhpcy5pbml0TWVzaCgpOwogICAgICAgICAgICB0aGlzLnRyYWlsID0gbmV3IFRyYWlsUmVuZGVyZXIoc2NlbmUpOwogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciA9IDA7Cn0KaW5pdE1lc2goKSB7CiAgICAgICAgICAgIC8vIEhpZXJhcmNoeTogTWVzaCAoUG9zKSAtPiBEZWZvcm0gKFNxdWFzaC9TdHJldGNoKSAtPiBTcGluIChSb3RhdGlvbikgLT4gTW9kZWwKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubWVzaCk7Cgp0aGlzLmRlZm9ybU5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnkgPSAwLjA7IC8vIFJlc2V0IG9mZnNldCBzbyBiYWxsIGlzIGNlbnRlcmVkIG9uIG1lc2ggcG9zaXRpb24KICAgICAgICAgICAgdGhpcy5tZXNoLmFkZCh0aGlzLmRlZm9ybU5vZGUpOyAvLyBGaXg6IEFkZCBkZWZvcm1Ob2RlIHRvIG1lc2gKCiAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLmFkZCh0aGlzLnNwaW5Ob2RlKTsKCiAgICAgICAgICAgIC8vIFByb2NlZHVyYWwgUGxhY2Vob2xkZXIgVGV4dHVyZSAoQmxpdHpiYWxsLWlzaCkKICAgICAgICAgICAgY29uc3QgcGxhY2Vob2xkZXJUZXggPSAoKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAgICAgYy53aWR0aCA9IDEyODsgYy5oZWlnaHQgPSA2NDsKICAgICAgICAgICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2VlZWVlZSc7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwwLDEyOCw2NCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEJsdWUgYnVtcHMvZGV0YWlscwogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDA4OGZmJzsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDY7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBjdHguYXJjKGkqMjUsIDMyLCAxMCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDA0NDg4JzsKICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAyOCwgMTI4LCA4KTsgLy8gU3RyaXBlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgICAgICAgICAgfSkoKTsKCiAgICAgICAgICAgIC8vIFBsYWNlaG9sZGVyIFZpc3VhbCAoSW1tZWRpYXRlIGZlZWRiYWNrLCBwZXJzaXN0cyB1bnRpbCB2YWxpZCBtb2RlbCBsb2FkcykKLy8gUGxhY2Vob2xkZXIgVmlzdWFsIChJbW1lZGlhdGUgZmVlZGJhY2ssIHBlcnNpc3RzIHVudGlsIHZhbGlkIG1vZGVsIGxvYWRzKQovLyBQbGFjZWhvbGRlciBWaXN1YWwgKEltbWVkaWF0ZSBmZWVkYmFjaywgcGVyc2lzdHMgdW50aWwgdmFsaWQgbW9kZWwgbG9hZHMpCmNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDAuMywgMTYsIDE2KTsgLy8gU2NhbGVkIGRvd24gfjE1JQogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICBtYXA6IHBsYWNlaG9sZGVyVGV4LAogICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLCAKICAgICAgICAgICAgICAgIHdpcmVmcmFtZTogZmFsc2UsIC8vIFNvbGlkCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogZmFsc2UsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAxLjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwoKICAgICAgICAgICAgLy8gTG9hZCBHTEIgTW9kZWwKICAgICAgICAgICAgY29uc3QgdXJsID0gJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy81MjFhZTg3ODhlNTg0ZTM3OGE3OWQ5NzMyYTA3NTM1Ni5nbGInOwogICAgICAgICAgICAKICAgICAgICAgICAgd2luZG93LmZsdXguQXNzZXRMb2FkZXIubG9hZE1vZGVsKHVybCwgKGdsdGYpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJERUJVRzogQmFsbCBHTEIgbG9hZGVkLiIsIGdsdGYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBtb2RlbCA9IGdsdGYuc2NlbmU7CgogICAgICAgICAgICAgICAgLy8gMS4gUmVzZXQgcm9vdCB0cmFuc2Zvcm1zCiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBtb2RlbC5yb3RhdGlvbi5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBtb2RlbC5zY2FsZS5zZXQoMSwgMSwgMSk7CiAgICAgICAgICAgICAgICBtb2RlbC51cGRhdGVNYXRyaXhXb3JsZCh0cnVlKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBIYXJkZW4gTWF0ZXJpYWxzICYgVmlzaWJpbGl0eQogICAgICAgICAgICAgICAgbW9kZWwudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5jYXN0U2hhZG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVjZWl2ZVNoYWRvdyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsgLy8gQ1JJVElDQUw6IFByZXZlbnQgY3VsbGluZyBpZiBib3VuZHMgYXJlIG9mZgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hdHMgPSBBcnJheS5pc0FycmF5KG5vZGUubWF0ZXJpYWwpID8gbm9kZS5tYXRlcmlhbCA6IFtub2RlLm1hdGVyaWFsXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdHMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLmNvbG9yLnNldEhleCgweGZmZmZmZik7IC8vIEZvcmNlIHdoaXRlIGJhc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnNpZGUgPSBUSFJFRS5Eb3VibGVTaWRlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0udHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLm9wYWNpdHkgPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5hbHBoYVRlc3QgPSAwOyAvLyBDUklUSUNBTDogRGlzYWJsZSBhbHBoYSB0ZXN0IHRvIHByZXZlbnQgY3VsbGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5kZXB0aFRlc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyAzLiBDb21wdXRlIEJvdW5kaW5nIEJveAogICAgICAgICAgICAgICAgY29uc3QgYm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KG1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNpemUgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgYm94LmdldFNpemUoc2l6ZSk7CiAgICAgICAgICAgICAgICBjb25zdCBjZW50ZXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICAgICAgYm94LmdldENlbnRlcihjZW50ZXIpOwoKICAgICAgICAgICAgICAgIC8vIDQuIFZhbGlkYXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IG1heERpbSA9IE1hdGgubWF4KHNpemUueCwgc2l6ZS55LCBzaXplLnopOwogICAgICAgICAgICAgICAgaWYgKG1heERpbSA8PSAwLjAwMSB8fCAhaXNGaW5pdGUobWF4RGltKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBtb2RlbCBoYXMgaW52YWxpZCBkaW1lbnNpb25zLiBLZWVwaW5nIHBsYWNlaG9sZGVyLiIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gNS4gQ2FsY3VsYXRlIFNjYWxlCi8vIDUuIENhbGN1bGF0ZSBTY2FsZQpjb25zdCB0YXJnZXREaWFtZXRlciA9IDAuNzI7IC8vIFJlZHVjZWQgc2NhbGUgYnkgfjE1JSAod2FzIDAuODUpCiAgICAgICAgICAgICAgICBjb25zdCBzY2FsZUZhY3RvciA9IHRhcmdldERpYW1ldGVyIC8gbWF4RGltOwoKICAgICAgICAgICAgICAgIC8vIDYuIEFwcGx5IFRyYW5zZm9ybXMKICAgICAgICAgICAgICAgIG1vZGVsLnNjYWxlLnNldFNjYWxhcihzY2FsZUZhY3Rvcik7CiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5jb3B5KGNlbnRlcikubXVsdGlwbHlTY2FsYXIoLXNjYWxlRmFjdG9yKTsKCiAgICAgICAgICAgICAgICAvLyA3LiBTd2FwIFBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bpbk5vZGUucmVtb3ZlKHRoaXMucGxhY2Vob2xkZXIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5KSB0aGlzLnBsYWNlaG9sZGVyLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsID0gbW9kZWw7CiAgICAgICAgICAgICAgICB0aGlzLnNwaW5Ob2RlLmFkZCh0aGlzLm1vZGVsKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCbGl0emJhbGwgbW9kZWwgYXR0YWNoZWQuIFNjYWxlOiAke3NjYWxlRmFjdG9yLnRvRml4ZWQoNCl9YCk7CgogICAgICAgICAgICB9LCB1bmRlZmluZWQsIChlcnIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBsb2FkIEJsaXR6YmFsbCBtb2RlbDoiLCBlcnIpOwogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2s6IEtlZXAgcGxhY2Vob2xkZXIgYnV0IHRpbnQgaXQgcmVkIHRvIGluZGljYXRlIGVycm9yCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXIubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmZhYWFhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIFdyYXBwZXIgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkKICAgICAgICAgICAgdGhpcy51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVWaXN1YWxzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVBoeXNpY3MoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIC8vIEJhbGwgTGFiIHJlcGxheSBvdmVycmlkZSAoUGh5c2ljcyBjb250cm9sKQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzICYmIHR5cGVvZiBfX2xhYi5hcHBseVJlcGxheUZyYW1lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBfX2xhYi5hcHBseVJlcGxheUZyYW1lKHRoaXMsIGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2FmZXR5OiBSZXNldCBpZiBwb3NpdGlvbiBjb3JydXB0ZWQKICAgICAgICAgICAgaWYgKGlzTmFOKHRoaXMubWVzaC5wb3NpdGlvbi54KSB8fCBpc05hTih0aGlzLm1lc2gucG9zaXRpb24ueSkgfHwgaXNOYU4odGhpcy5tZXNoLnBvc2l0aW9uLnopKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNhZmV0eTogRml4ICJVbnBpY2thYmxlIEJhbGwiIEJ1ZwogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2hlbGQnICYmICghdGhpcy5ob2xkZXIgfHwgIXRoaXMuaG9sZGVyLm1lc2gpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ21hZ25ldGl6ZWQnKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMubWFnbmV0VGFyZ2V0IHx8ICF0aGlzLm1hZ25ldFRhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcm9wKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tYWduZXRUaW1lciA+IDIuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQmFsbCBzdHVjayBpbiBtYWduZXRpemVkIHN0YXRlLiBEcm9wcGluZy4iKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHRoaXMuaG9sZGVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhvbGRlciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdmcmVlJyAmJiB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAwLjUpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hHcmFjZVBlcmlvZCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaGVsZCcgJiYgdGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVIZWxkKGR0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTWFnbmV0aXplZChkdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVGcmVlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgLT0gZHQ7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYXRjaEdyYWNlUGVyaW9kIDwgMCkgdGhpcy5jYXRjaEdyYWNlUGVyaW9kID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQmFsbCBMYWIgcmVwbGF5IG92ZXJyaWRlIChWaXN1YWxzKQogICAgICAgICAgICBjb25zdCBfX2xhYiA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LmJhbGxMYWI7CiAgICAgICAgICAgIGlmIChfX2xhYiAmJiBfX2xhYi5pc1JlcGxheWluZyAmJiBfX2xhYi50YXJnZXRCYWxsID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgdGhpcy50cmFpbC5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy50cmFpbCkgewogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgdGhpcy50cmFpbC5hY3RpdmUgPSAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnICYmIHNwZWVkID4gMi4wKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2JWZWMuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgX2JWZWMueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKCiAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHNwZWVkIC8gNjAuMCwgMS4wKTsKICAgICAgICAgICAgICAgIHRoaXMudHJhaWwudXBkYXRlKF9iVmVjLCByYXRpbyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVQYXJ0aWNsZXMoZHQpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMubWVzaCAmJiAhdGhpcy5pc0ludmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubW9kZWwpIHRoaXMubW9kZWwudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgptYWduZXRpemUodGFyZ2V0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnbWFnbmV0aXplZCcgfHwgdGhpcy5zdGF0ZSA9PT0gJ2hlbGQnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ21hZ25ldGl6ZWQnOwogICAgICAgICAgICB0aGlzLm1hZ25ldFRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSB0YXJnZXQ7IC8vIExvZ2ljYWwgcG9zc2Vzc2lvbiBzbyBBSSByZWFjdHMKICAgICAgICAgICAgdGhpcy5tYWduZXRUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubWFnbmV0U3RhcnRQb3MuY29weSh0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLm1hZ25ldFN0YXJ0VmVsLmNvcHkodGhpcy52ZWxvY2l0eSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEeW5hbWljIER1cmF0aW9uIGJhc2VkIG9uIGRpc3RhbmNlIChTbW9vdGhlciBmb3IgbG9uZyByYW5nZSwgc25hcHB5IGZvciBjbG9zZSkKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5tYWduZXREdXJhdGlvbiA9IE1hdGgubWF4KDAuMTUsIE1hdGgubWluKDAuNCwgZGlzdCAvIDE1LjApKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEtpbGwgcGh5c2ljcwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwoKICAgICAgICAgICAgLy8gTm90aWZ5IHBsYXllciBpbW1lZGlhdGVseSBzbyB0aGV5IHN0b3AgY2hhc2luZyBhbmQgcGxheSBhbmltYXRpb24KICAgICAgICAgICAgaWYgKHRhcmdldC5yZWNlaXZlQmFsbCkgewogICAgICAgICAgICAgICAgdGFyZ2V0LnJlY2VpdmVCYWxsKCk7CiAgICAgICAgICAgIH0KCnRoaXMucmV2ZWFsKCk7CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdjYXRjaCcsIHsgdm9sdW1lOiAwLjYgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgp1cGRhdGVNYWduZXRpemVkKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5tYWduZXRUYXJnZXQgfHwgIXRoaXMubWFnbmV0VGFyZ2V0Lm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm1hZ25ldFRpbWVyICs9IGR0OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm9ybWFsaXplZCBUaW1lCiAgICAgICAgICAgIGxldCB0ID0gdGhpcy5tYWduZXRUaW1lciAvIHRoaXMubWFnbmV0RHVyYXRpb247CiAgICAgICAgICAgIGlmICh0ID4gMS4wKSB0ID0gMS4wOwoKICAgICAgICAgICAgLy8gVGFyZ2V0ICJWaXJ0dWFsIEhhbmQiIFBvc2l0aW9uIChGcm9udCBvZiBDaGVzdCkKICAgICAgICAgICAgY29uc3QgaG9sZGVyUG9zID0gdGhpcy5tYWduZXRUYXJnZXQubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgaG9sZGVyUXVhdCA9IHRoaXMubWFnbmV0VGFyZ2V0Lm1lc2gucXVhdGVybmlvbjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9mZnNldDogRm9yd2FyZCAwLjYsIFVwIDEuMCAoQ2hlc3QgaGVpZ2h0KQogICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBfYlZlYy5zZXQoMCwgMS4wLCAwLjYpLmFwcGx5UXVhdGVybmlvbihob2xkZXJRdWF0KTsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9zID0gb2Zmc2V0LmFkZChob2xkZXJQb3MpOwoKICAgICAgICAgICAgLy8gLS0tIFFVQURSQVRJQyBCRVpJRVIgQ1VSVkUgLS0tCiAgICAgICAgICAgIC8vIFAwID0gU3RhcnQsIFAyID0gVGFyZ2V0CiAgICAgICAgICAgIC8vIFAxID0gQ29udHJvbCBQb2ludCAoUHJvamVjdGVkIGFsb25nIGluaXRpYWwgdmVsb2NpdHkgdG8gcHJlc2VydmUgbW9tZW50dW0gZmVlbCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHAwID0gdGhpcy5tYWduZXRTdGFydFBvczsKICAgICAgICAgICAgY29uc3QgcDIgPSB0YXJnZXRQb3M7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDYWxjdWxhdGUgUDEgKENvbnRyb2wgUG9pbnQpCiAgICAgICAgICAgIC8vIFByb2plY3QgZm9yd2FyZCBmcm9tIFAwIGFsb25nIHN0YXJ0IHZlbG9jaXR5IHZlY3RvcgogICAgICAgICAgICAvLyBEaXN0YW5jZSBvZiBwcm9qZWN0aW9uID0gNDAlIG9mIHRvdGFsIGRpc3RhbmNlIHRvIHRhcmdldAogICAgICAgICAgICBjb25zdCBkaXN0ID0gcDAuZGlzdGFuY2VUbyhwMik7CiAgICAgICAgICAgIGNvbnN0IHAxID0gX3RlbXBWZWMuY29weShwMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2ZWxMZW4gPSB0aGlzLm1hZ25ldFN0YXJ0VmVsLmxlbmd0aFNxKCk7CiAgICAgICAgICAgIGlmICh2ZWxMZW4gPiAxLjApIHsKICAgICAgICAgICAgICAgIC8vIFVzZSB2ZWxvY2l0eSB0YW5nZW50Ci8vIFVzZSB2ZWxvY2l0eSB0YW5nZW50CiAgICAgICAgICAgICAgICBfYkRpci5jb3B5KHRoaXMubWFnbmV0U3RhcnRWZWwpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgcDEuYWRkKF9iRGlyLm11bHRpcGx5U2NhbGFyKGRpc3QgKiAwLjQpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE5vIHZlbG9jaXR5IChzdGF0aW9uYXJ5IGJhbGwpLCBhcmMgdXB3YXJkcyBzbGlnaHRseQogICAgICAgICAgICAgICAgcDEubGVycChwMiwgMC41KTsKICAgICAgICAgICAgICAgIHAxLnkgKz0gMS41OyAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmV6aWVyOiBCKHQpID0gKDEtdCleMiAqIFAwICsgMigxLXQpdCAqIFAxICsgdF4yICogUDIKICAgICAgICAgICAgY29uc3Qgb25lTWludXNUID0gMS4wIC0gdDsKICAgICAgICAgICAgY29uc3QgdzAgPSBvbmVNaW51c1QgKiBvbmVNaW51c1Q7CiAgICAgICAgICAgIGNvbnN0IHcxID0gMi4wICogb25lTWludXNUICogdDsKICAgICAgICAgICAgY29uc3QgdzIgPSB0ICogdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi54ID0gKHcwICogcDAueCkgKyAodzEgKiBwMS54KSArICh3MiAqIHAyLngpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24ueSA9ICh3MCAqIHAwLnkpICsgKHcxICogcDEueSkgKyAodzIgKiBwMi55KTsKICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLnogPSAodzAgKiBwMC56KSArICh3MSAqIHAxLnopICsgKHcyICogcDIueik7CgogICAgICAgICAgICAvLyBGaW5pc2gKICAgICAgICAgICAgaWYgKHQgPj0gMS4wKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdyYWIodGhpcy5tYWduZXRUYXJnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlSGVsZChkdCkgewogICAgICAgICAgICAvLyBBVFRBQ0hFRCBTVEFURSAoVmlydHVhbCBBdHRhY2htZW50KQogICAgICAgICAgICBpZiAoIXRoaXMuaG9sZGVyIHx8ICF0aGlzLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3AoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIDEuIFRyeSB0byB1c2UgSGFuZCBCb25lIGlmIGF2YWlsYWJsZSAoUmVhbGlzbSkKICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmhhbmRCb25lKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgd29ybGQgcG9zaXRpb24gb2YgdGhlIGhhbmQgYm9uZQogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIuaGFuZEJvbmUuZ2V0V29ybGRQb3NpdGlvbih0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBZGp1c3Qgc2xpZ2h0bHkgdG8gc2l0IElOIHRoZSBoYW5kIHJhdGhlciB0aGFuIE9OIHRoZSB3cmlzdAogICAgICAgICAgICAgICAgLy8gV2UgY2FuJ3QgZWFzaWx5IGtub3cgImZvcndhcmQiIGZvciB0aGUgYm9uZSB3aXRob3V0IG1vcmUgaW5mbywgCiAgICAgICAgICAgICAgICAvLyBidXQgdXN1YWxseSBHTFRGIGJvbmVzIGFyZSBvcmllbnRlZC4gRm9yIG5vdywgZXhhY3QgYm9uZSBwb3MgaXMgYmV0dGVyIHRoYW4gY2hlc3QuCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAyLiBGYWxsYmFjazogQ2FsY3VsYXRlICJDYXJyeWluZyIgUG9zaXRpb24gKFJpZ2h0IEhhbmQgU2lkZSkKICAgICAgICAgICAgICAgIC8vIFJlbGF0aXZlIHRvIHBsYXllcjogVXAgMC44IChXYWlzdC9DaGVzdCksIFJpZ2h0IDAuNCwgRm9yd2FyZCAwLjUKICAgICAgICAgICAgICAgIGNvbnN0IGhvbGRlclBvcyA9IHRoaXMuaG9sZGVyLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgICAgICBjb25zdCBob2xkZXJRdWF0ID0gdGhpcy5ob2xkZXIubWVzaC5xdWF0ZXJuaW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSZXVzZSBfYlZlYwovLyBSZXVzZSBfYlZlYwogICAgICAgICAgICAgICAgLy8gT2Zmc2V0OiB4PTAuMzUgKFJpZ2h0KSwgeT0xLjMgKENoZXN0L0hhbmRzKSwgej0wLjUgKEZvcndhcmQpCiAgICAgICAgICAgICAgICBfYlZlYy5zZXQoMC4zNSwgMS4zLCAwLjUpLmFwcGx5UXVhdGVybmlvbihob2xkZXJRdWF0KTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5jb3B5KGhvbGRlclBvcykuYWRkKF9iVmVjKTsKICAgICAgICAgICAgfQoKLy8gVmlzdWFsIEZsYWlyOiBTcGluIHRoZSBiYWxsIHNsb3dseQogICAgICAgICAgICBjb25zdCByb3RYID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKS5zZXRGcm9tQXhpc0FuZ2xlKG5ldyBUSFJFRS5WZWN0b3IzKDEsMCwwKSwgMiAqIGR0KTsKICAgICAgICAgICAgY29uc3Qgcm90WSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIDUgKiBkdCk7CiAgICAgICAgICAgIHRoaXMuYWNjdW11bGF0ZWRSb3RhdGlvbi5tdWx0aXBseShyb3RYKS5tdWx0aXBseShyb3RZKTsKICAgICAgICB9CgoKdXBkYXRlRnJlZShkdCkgewogICAgICAgICAgICAvLyBMZWdhY3kgd3JhcHBlcgogICAgICAgICAgICB0aGlzLl91cGRhdGVGcmVlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBhcnRpY2xlcyhkdCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpOwogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZUZyZWVQaHlzaWNzKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnIHx8IHt9OwogICAgICAgICAgICBjb25zdCBzdWJzdGVwcyA9IE1hdGgubWF4KDEsIE1hdGguZmxvb3IoQy5TVUJTVEVQUyB8fCAxKSk7CiAgICAgICAgICAgIGNvbnN0IHN0ZXBEdCA9IGR0IC8gc3Vic3RlcHM7CgogICAgICAgICAgICBmb3IgKGxldCBzID0gMDsgcyA8IHN1YnN0ZXBzOyBzKyspIHsKICAgICAgICAgICAgICAgIC8vIEEpIE1hZ251cyBlZmZlY3QKICAgICAgICAgICAgICAgIGlmIChDLk1BR05VU19FTkFCTEVEICYmIHRoaXMuYW5ndWxhclZlbG9jaXR5ICYmIHRoaXMudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluU3EgPSB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZlbFNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChzcGluU3EgPiAwLjI1ICYmIHZlbFNxID4gMC4yNSkgewogICAgICAgICAgICAgICAgICAgICAgICBfbWFnbnVzVmVjLmNvcHkodGhpcy5hbmd1bGFyVmVsb2NpdHkpLmNyb3NzKHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKChDLk1BR05VU19DT0VGRiB8fCAwKSAqIHN0ZXBEdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhcCA9IChDLk1BR05VU19DQVAgIT09IHVuZGVmaW5lZCA/IEMuTUFHTlVTX0NBUCA6IDYwLjApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYWdMZW4gPSBfbWFnbnVzVmVjLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWFnTGVuID4gY2FwKSBfbWFnbnVzVmVjLm11bHRpcGx5U2NhbGFyKGNhcCAvIG1hZ0xlbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKF9tYWdudXNWZWMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBCKSBTcGluIGRlY2F5CiAgICAgICAgICAgICAgICBpZiAodGhpcy5hbmd1bGFyVmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGluRHJhZyA9IE1hdGgubWF4KDAsIDEuMCAtIChDLlNQSU5fRFJBRyB8fCAwKSAqIHN0ZXBEdCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoc3BpbkRyYWcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEMpIERlcHRoIHNwcmluZwogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0WSA9IChDLkRFUFRIX1RBUkdFVF9ZICE9PSB1bmRlZmluZWQgPyBDLkRFUFRIX1RBUkdFVF9ZIDogMC4wKTsKICAgICAgICAgICAgICAgIGNvbnN0IHlFcnIgPSAodGhpcy5tZXNoLnBvc2l0aW9uLnkgLSB0YXJnZXRZKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAtPSB5RXJyICogKEMuREVQVEhfU1BSSU5HIHx8IDApICogc3RlcER0OwogICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IE1hdGgubWF4KDAsIDEuMCAtIChDLkRFUFRIX0RBTVAgfHwgMCkgKiBzdGVwRHQpOwoKICAgICAgICAgICAgICAgIC8vIEQpIERyYWcKICAgICAgICAgICAgICAgIGNvbnN0IHZMZW4gPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAgICAgaWYgKHZMZW4gPiAwLjAwMDAxKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGluID0gKEMuV0FURVJfRFJBR19MSU5FQVIgIT09IHVuZGVmaW5lZCA/IEMuV0FURVJfRFJBR19MSU5FQVIgOiAoQy5XQVRFUl9EUkFHIHx8IDApKSAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBxdWFkID0gKEMuV0FURVJfRFJBR19RVUFEIHx8IDApICogdkxlbiAqIHN0ZXBEdDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkcmFnID0gTWF0aC5tYXgoMCwgMS4wIC0gbGluIC0gcXVhZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5tdWx0aXBseVNjYWxhcihkcmFnKTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RvcCA9IChDLlNUT1BfU1BFRUQgfHwgMCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0b3AgPiAwICYmIHRoaXMudmVsb2NpdHkubGVuZ3RoU3EoKSA8IHN0b3AgKiBzdG9wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBFKSBNb3ZlCiAgICAgICAgICAgICAgICBfdGVtcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLm11bHRpcGx5U2NhbGFyKHN0ZXBEdCk7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uYWRkKF90ZW1wVmVjKTsKCiAgICAgICAgICAgICAgICAvLyBGKSBTdGF0IHBvd2VyIGRlY2F5CiAgICAgICAgICAgICAgICBpZiAodGhpcy5wb3dlciA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBvd2VyIC09IHRoaXMuZGVjYXlSYXRlICogc3RlcER0OwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBvd2VyIDwgMCkgdGhpcy5wb3dlciA9IDA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRykgQm91bmRhcnkgbG9naWMKICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RYWiA9IE1hdGguc3FydChwb3MueCAqIHBvcy54ICsgcG9zLnogKiBwb3Mueik7CiAgICAgICAgICAgICAgICBjb25zdCBib3VuZGFyeVJhZGl1cyA9IChDLkJPVU5EQVJZX1JBRElVUyAhPT0gdW5kZWZpbmVkID8gQy5CT1VOREFSWV9SQURJVVMgOiAzMy4wKTsKICAgICAgICAgICAgICAgIGxldCBlZmZlY3RpdmVCb3VuZGFyeSA9IGJvdW5kYXJ5UmFkaXVzOwoKICAgICAgICAgICAgICAgIGlmIChDLkdPQUxfUE9DS0VUX0VOQUJMRUQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpbkdvYWxQb2NrZXQgPSAoTWF0aC5hYnMocG9zLngpIDwgKEMuR09BTF9QT0NLRVRfWCB8fCAxMi4wKSAmJiBNYXRoLmFicyhwb3MueikgPiAoQy5HT0FMX1BPQ0tFVF9aIHx8IDI1LjApKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5Hb2FsUG9ja2V0KSBlZmZlY3RpdmVCb3VuZGFyeSA9IChDLkdPQUxfUE9DS0VUX1JBRElVUyB8fCA0NS4wKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBzb2Z0QnVmZmVyID0gTWF0aC5tYXgoMC4wMSwgKEMuV0FMTF9TT0ZUX0JVRkZFUiAhPT0gdW5kZWZpbmVkID8gQy5XQUxMX1NPRlRfQlVGRkVSIDogMy4wKSk7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RYWiA+IGVmZmVjdGl2ZUJvdW5kYXJ5IC0gc29mdEJ1ZmZlcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBlbmV0cmF0aW9uID0gZGlzdFhaIC0gKGVmZmVjdGl2ZUJvdW5kYXJ5IC0gc29mdEJ1ZmZlcik7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBwZW5ldHJhdGlvbiAvIHNvZnRCdWZmZXIpKTsKICAgICAgICAgICAgICAgICAgICBfdGVtcFZlYy5zZXQoLXBvcy54LCAwLCAtcG9zLnopOwogICAgICAgICAgICAgICAgICAgIGlmIChfdGVtcFZlYy5sZW5ndGhTcSgpID4gMC4wMDAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmb3JjZSA9IHJhdGlvICogcmF0aW8gKiAoQy5XQUxMX1NPRlRfRk9SQ0UgfHwgMCkgKiBzdGVwRHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjLCBmb3JjZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChkaXN0WFogPiBlZmZlY3RpdmVCb3VuZGFyeSkgewogICAgICAgICAgICAgICAgICAgIF90ZW1wVmVjLnNldCgtcG9zLngsIDAsIC1wb3Mueik7CiAgICAgICAgICAgICAgICAgICAgaWYgKF90ZW1wVmVjLmxlbmd0aFNxKCkgPiAwLjAwMDEpIF90ZW1wVmVjLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG92ZXJsYXAgPSBkaXN0WFogLSBlZmZlY3RpdmVCb3VuZGFyeTsKICAgICAgICAgICAgICAgICAgICBwb3MuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjLCBvdmVybGFwKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB2RG90TiA9IHRoaXMudmVsb2NpdHkuZG90KF90ZW1wVmVjKTsKICAgICAgICAgICAgICAgICAgICBpZiAodkRvdE4gPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGltcGFjdFNwZWVkID0gTWF0aC5hYnModkRvdE4pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW1wYWN0U3BlZWQgPiAxMC4wICYmIHdpbmRvdy5mbHV4LnRyaWdnZXJBcmVuYUltcGFjdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXgudHJpZ2dlckFyZW5hSW1wYWN0KHBvcywgTWF0aC5taW4oaW1wYWN0U3BlZWQgKiAwLjUsIDE1LjApKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5hdWRpb01hbmFnZXIucGxheVNGWCgnaW1wYWN0JywgeyB2b2x1bWU6IE1hdGgubWluKDEuMCwgaW1wYWN0U3BlZWQgKiAwLjA1KSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlID0gKEMuV0FMTF9FTEFTVElDSVRZICE9PSB1bmRlZmluZWQgPyBDLldBTExfRUxBU1RJQ0lUWSA6IDAuMyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGltcHVsc2UgPSBfdGVtcFZlYy5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKC12RG90TiAqICgxLjAgKyBlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuYWRkKGltcHVsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmcmljdGlvbiA9IChDLldBTExfRlJJQ1RJT04gIT09IHVuZGVmaW5lZCA/IEMuV0FMTF9GUklDVElPTiA6IDAuOTUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0YW5nZW50ID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLnByb2plY3RPblBsYW5lKF90ZW1wVmVjKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS5zdWIodGFuZ2VudC5tdWx0aXBseVNjYWxhcigxLjAgLSBmcmljdGlvbikpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBiaCA9IChDLkJPVU5EQVJZX0hFSUdIVCAhPT0gdW5kZWZpbmVkID8gQy5CT1VOREFSWV9IRUlHSFQgOiAxNS4wKTsKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueSkgPiBiaCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNpZ24gPSBNYXRoLnNpZ24ocG9zLnkpIHx8IDE7CiAgICAgICAgICAgICAgICAgICAgcG9zLnkgPSBiaCAqIHNpZ247CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmUgPSAoQy5GTE9PUl9FTEFTVElDSVRZICE9PSB1bmRlZmluZWQgPyBDLkZMT09SX0VMQVNUSUNJVFkgOiAwLjQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSAtZmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVQYXJ0aWNsZXMoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2dob3N0KSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBzcGVlZFNxID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcSgpOwogICAgICAgICAgICB0aGlzLl9idWJibGVUaW1lciAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuX2J1YmJsZVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBtID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlID8gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlciA6IG51bGw7CiAgICAgICAgICAgICAgICBpZiAocG0pIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSB0aGlzLnZlbG9jaXR5LmNsb25lKCkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIoLTAuOCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RkUG9zID0gdGhpcy5tZXNoLnBvc2l0aW9uLmNsb25lKCkuYWRkKG9mZnNldCkuYWRkKF9iRGlyLnNldCgoTWF0aC5yYW5kb20oKS0wLjUpKjAuMywgKE1hdGgucmFuZG9tKCktMC41KSowLjMsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4zKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3RkUG9zLnkgKz0gdGhpcy5kZWZvcm1Ob2RlLnBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICAgICAgcG0uc3Bhd24oJ2J1YmJsZScsIHN0ZFBvcywgeyBzY2FsZTogMC40ICsgTWF0aC5yYW5kb20oKSAqIDAuNCB9KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHNwZWVkU3EgPiA1MC4wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gTWF0aC5taW4oNCwgTWF0aC5mbG9vcihzcGVlZFNxIC8gNjApKTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBqaXR0ZXIgPSBfYkRpci5zZXQoKE1hdGgucmFuZG9tKCktMC41KSowLjQsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC40LCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuNCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGF3blBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLmFkZChqaXR0ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3Bhd25Qb3MueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdidWJibGVfbWljcm8nLCBzcGF3blBvcywgeyBzY2FsZTogMC4wNSArIE1hdGgucmFuZG9tKCkgKiAwLjEgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnViYmxlVGltZXIgPSAwLjAyOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gMC41KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBqaXR0ZXIgPSBfYkRpci5zZXQoKE1hdGgucmFuZG9tKCktMC41KSowLjIsIChNYXRoLnJhbmRvbSgpLTAuNSkqMC4yLCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuMik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGF3blBvcyA9IHRoaXMubWVzaC5wb3NpdGlvbi5jbG9uZSgpLmFkZChvZmZzZXQpLmFkZChqaXR0ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVmb3JtTm9kZSkgc3Bhd25Qb3MueSArPSB0aGlzLmRlZm9ybU5vZGUucG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBtLnNwYXduKCdidWJibGVfbWljcm8nLCBzcGF3blBvcywgeyBzY2FsZTogMC4wNCArIE1hdGgucmFuZG9tKCkgKiAwLjA2IH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2J1YmJsZVRpbWVyID0gMC4wNTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgovLyBTdHJheSBjb2RlIGJsb2NrIHJlbW92ZWQKCmdyYWIocGxheWVyKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50OiBQb3NzZXNzaW9uIChpZiB0YWtpbmcgZnJvbSBmcmVlIHN0YXRlKQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCgiUE9TU0VTU0lPTiIsICJub3JtYWwiKTsKICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIFR1cm5vdmVyIChQb3NzZXNzaW9uIENoYW5nZSkKICAgICAgICAgICAgY29uc3QgcHJldmlvdXNUZWFtID0gdGhpcy5ob2xkZXIgPyB0aGlzLmhvbGRlci50ZWFtIDogKHRoaXMubGFzdEhvbGRlciA/IHRoaXMubGFzdEhvbGRlci50ZWFtIDogbnVsbCk7CiAgICAgICAgICAgIGlmIChwcmV2aW91c1RlYW0gJiYgcHJldmlvdXNUZWFtICE9PSBwbGF5ZXIudGVhbSkgewogICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJUVVJOT1ZFUiIsIHBsYXllci5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgc29tZW9uZSBlbHNlIGhlbGQgaXQsIHRoZXkgbG9zZSBpdAogICAgICAgICAgICBpZiAodGhpcy5ob2xkZXIgJiYgdGhpcy5ob2xkZXIgIT09IHBsYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIubG9zZUJhbGwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBwbGF5ZXI7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaGVsZCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOT1RFOiBXZSBkbyBOT1QgcGFyZW50IHRoZSBtZXNoIHRvIHRoZSBwbGF5ZXIgYW55bW9yZS4KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyB0aGUgYmFsbCBmcm9tIGZseWluZyBhcm91bmQgZHVlIHRvIHN3aW0gYW5pbWF0aW9ucy4KICAgICAgICAgICAgLy8gSW5zdGVhZCwgd2UgdXBkYXRlIGl0cyBwb3NpdGlvbiBtYW51YWxseSBpbiB1cGRhdGVIZWxkKCkuCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3RpZnkgcGxheWVyCiAgICAgICAgICAgIGlmIChwbGF5ZXIucmVjZWl2ZUJhbGwpIHsKICAgICAgICAgICAgICAgIHBsYXllci5yZWNlaXZlQmFsbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zb2xlLmxvZygiQmFsbCBncmFiYmVkIGJ5ICIgKyBwbGF5ZXIucm9sZSk7CiAgICAgICAgfQoKICAgICAgICBkcm9wKCkgewogICAgICAgICAgICB0aGlzLnJldmVhbCgpOyAvLyBFbnN1cmUgdmlzaWJsZQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm8gbmVlZCB0byBkZXRhY2ggZnJvbSBzY2VuZSBncmFwaCBzaW5jZSB3ZSBhcmVuJ3QgcGFyZW50aW5nIHRvIHBsYXllciBhbnltb3JlLgogICAgICAgICAgICAvLyBKdXN0IGNsZWFyIGhvbGRlci4KCiAgICAgICAgICAgIGlmICh0aGlzLmhvbGRlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaG9sZGVyLmxvc2VCYWxsKSB0aGlzLmhvbGRlci5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIH0KLy8gU2hvb3QvUGFzcwovLyBTaG9vdC9QYXNzCiAgICAgICAgc2hvb3QoZGlyZWN0aW9uVmVjdG9yLCBmb3JjZSwgdHlwZSA9ICdTSCcsIHRlY2huaXF1ZSA9IG51bGwsIHNwaW5WZWN0b3IgPSBudWxsKSB7CgogICAgICAgICAgICB0aGlzLmxhc3RIb2xkZXIgPSB0aGlzLmhvbGRlcjsgLy8gUmVjb3JkIGZvciBFWFAgYXR0cmlidXRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZ1bWJsZSBEZXRlY3Rpb24gKFR5cGUgJ25vbmUnIGlzIHVzZWQgYnkgUGxheWVyLmZ1bWJsZSkKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdub25lJykgewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc2hvd0Fubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zaG93QW5ub3VuY2VtZW50KCJGVU1CTEUhIiwgInNsYW0iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5kcm9wKCk7IC8vIERldGFjaCBmaXJzdAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0IEdyYWNlIFBlcmlvZCB0byBwcmV2ZW50IGluc3RhbnQgaW50ZXJjZXB0aW9ucy9jYXRjaGVzCiAgICAgICAgICAgIC8vIDAuMnMgYWxsb3dzIGJhbGwgdG8gY2xlYXIgdGhlIHRocm93ZXIncyBpbW1lZGlhdGUgdmljaW5pdHkKICAgICAgICAgICAgdGhpcy5jYXRjaEdyYWNlUGVyaW9kID0gMC4yOwoKICAgICAgICAgICAgLy8gUGh5c2ljYWwgVmVsb2NpdHkgKFZpc3VhbCBzcGVlZCkKICAgICAgICAgICAgY29uc3QgQyA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcgfHwge307CiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKEMuTEFVTkNIX1NQRUVEX1NDQUxFICE9PSB1bmRlZmluZWQgPyBDLkxBVU5DSF9TUEVFRF9TQ0FMRSA6IDEuMCk7CiAgICAgICAgICAgIGNvbnN0IGNhcCA9IChDLkxBVU5DSF9TUEVFRF9DQVAgIT09IHVuZGVmaW5lZCA/IEMuTEFVTkNIX1NQRUVEX0NBUCA6IDg1LjApOwogICAgICAgICAgICBjb25zdCBzcGVlZCA9IE1hdGgubWluKGZvcmNlICogc2NhbGUsIGNhcCk7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuY29weShkaXJlY3Rpb25WZWN0b3IpLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKHNwZWVkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGx5IFNwaW4gaWYgcHJvdmlkZWQKICAgICAgICAgICAgaWYgKHNwaW5WZWN0b3IpIHsKICAgICAgICAgICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LmNvcHkoc3BpblZlY3Rvcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN0YXQgUG93ZXIgKEdhbWUgTG9naWMpCiAgICAgICAgICAgIHRoaXMucG93ZXIgPSBmb3JjZTsKICAgICAgICAgICAgdGhpcy5wb3dlclR5cGUgPSB0eXBlOwogICAgICAgICAgICB0aGlzLnRlY2huaXF1ZSA9IHRlY2huaXF1ZTsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVHJhaWwgQ29sb3IKICAgICAgICAgICAgaWYgKHRoaXMudHJhaWwpIHsKICAgICAgICAgICAgICAgIGxldCBjb2xvciA9IDB4MDBhYWZmOyAvLyBEZWZhdWx0IEJsdWUgKFBhc3MpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZWNobmlxdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGVjaG5pcXVlLnR5cGUgPT09ICd2ZW5vbScpIGNvbG9yID0gMHgwMGZmMDA7IC8vIEdyZWVuIChWZW5vbSkKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ3dpdGhlcicpIGNvbG9yID0gMHg4ODg4ODg7IC8vIEdyZXkKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ25hcCcpIGNvbG9yID0gMHgwMDAwODg7IC8vIERhcmsgQmx1ZQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnc3BoZXJlJykgY29sb3IgPSAweDAwZmZmZjsgLy8gQ3lhbgogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2huaXF1ZS50eXBlID09PSAnamVjaHQnKSBjb2xvciA9IDB4ZmYwMDAwOyAvLyBSZWQKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNobmlxdWUudHlwZSA9PT0gJ2ludmlzaWJsZScpIGNvbG9yID0gMHg0NDQ0NDQ7IC8vIERhcmsgR3JleQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnU0gnKSB7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgPSAweGZmNDQwMDsgLy8gT3JhbmdlL1JlZAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLnRyYWlsLnNldENvbG9yKGNvbG9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGFuZGxlIEludmlzaWJsZSBTaG90CiAgICAgICAgICAgIGlmICh0ZWNobmlxdWUgJiYgdGVjaG5pcXVlLnR5cGUgPT09ICdpbnZpc2libGUnKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzSW52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBGWDogUG9vZgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlci5zcGF3bignd2l0aGVyJywgdGhpcy5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiAyLjAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiSW52aXNpYmxlIFNob3QhIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCYWxsICR7dHlwZX0gd2l0aCBQb3dlcjogJHt0aGlzLnBvd2VyLnRvRml4ZWQoMSl9IFNwaW46ICR7dGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoKCkudG9GaXhlZCgxKX1gKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjayBmb3IgQ3VydmUKICAgICAgICAgICAgaWYgKHRoaXMuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aCgpID4gMTUuMCAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiQ1VSVkUhIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXZlYWwoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzSW52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICAvLyBGWDogUmV2ZWFsIFBvb2YKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnBhcnRpY2xlTWFuYWdlciAmJiB0aGlzLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UucGFydGljbGVNYW5hZ2VyLnNwYXduKCd3aXRoZXInLCB0aGlzLm1lc2gucG9zaXRpb24sIHsgc2NhbGU6IDIuMCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlzSW52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICB9CgovLyBEdXBsaWNhdGUgcmV2ZWFsIHJlbW92ZWQKICAgICAgICAKcmVzZXQoKSB7CiAgICAgICAgICAgIHRoaXMucmV2ZWFsKCk7CiAgICAgICAgICAgIHRoaXMuZHJvcCgpOwogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNhdGNoR3JhY2VQZXJpb2QgPSAwOwogICAgICAgICAgICB0aGlzLnBvd2VyID0gMDsKICAgICAgICB9CmlzQ2F0Y2hhYmxlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jYXRjaEdyYWNlUGVyaW9kIDw9IDA7CiAgICAgICAgfQoKX3VwZGF0ZVZpc3VhbFRyYW5zZm9ybXMoZHQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmRlZm9ybU5vZGUgfHwgIXRoaXMuc3Bpbk5vZGUpIHJldHVybjsKCiAgICAgICAgICAgIC8vIDEuIFNxdWFzaCAmIFN0cmV0Y2ggYmFzZWQgb24gdmVsb2NpdHkKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHNwZWVkID4gMS4wICYmIHRoaXMuc3RhdGUgPT09ICdmcmVlJykgewogICAgICAgICAgICAgICAgY29uc3QgZGlyID0gdGhpcy52ZWxvY2l0eS5jbG9uZSgpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnF1YXRlcm5pb24uc2V0RnJvbVVuaXRWZWN0b3JzKG5ldyBUSFJFRS5WZWN0b3IzKDAsMCwxKSwgZGlyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgZmFjdG9yID0gTWF0aC5taW4oc3BlZWQgLyA0MC4wLCAxLjApOyAKICAgICAgICAgICAgICAgIGNvbnN0IHN0cmV0Y2ggPSAxLjAgKyAoZmFjdG9yICogMC44KTsKICAgICAgICAgICAgICAgIGNvbnN0IHNxdWFzaCA9IDEuMCAvIE1hdGguc3FydChzdHJldGNoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnNjYWxlLnNldChzcXVhc2gsIHNxdWFzaCwgc3RyZXRjaCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmRlZm9ybU5vZGUucXVhdGVybmlvbi5pZGVudGl0eSgpOwogICAgICAgICAgICAgICAgdGhpcy5kZWZvcm1Ob2RlLnNjYWxlLnNldCgxLCAxLCAxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gQXBwbHkgQWNjdW11bGF0ZWQgU3BpbgogICAgICAgICAgICBjb25zdCBpbnZEZWZvcm0gPSB0aGlzLmRlZm9ybU5vZGUucXVhdGVybmlvbi5jbG9uZSgpLmludmVydCgpOwogICAgICAgICAgICB0aGlzLnNwaW5Ob2RlLnF1YXRlcm5pb24uY29weShpbnZEZWZvcm0ubXVsdGlwbHkodGhpcy5hY2N1bXVsYXRlZFJvdGF0aW9uKSk7CgogICAgICAgICAgICAvLyAzLiBWaXN1YWwgcm90YXRpb24gaW50ZWdyYXRpb24KICAgICAgICAgICAgY29uc3Qgc3BpblNxID0gdGhpcy5hbmd1bGFyVmVsb2NpdHkubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKHNwaW5TcSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5TcGVlZCA9IE1hdGguc3FydChzcGluU3EpOwogICAgICAgICAgICAgICAgY29uc3QgYXhpcyA9IF90ZW1wVmVjLmNvcHkodGhpcy5hbmd1bGFyVmVsb2NpdHkpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgY29uc3QgcSA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbUF4aXNBbmdsZShheGlzLCBzcGluU3BlZWQgKiBkdCk7CiAgICAgICAgICAgICAgICB0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24ucHJlbXVsdGlwbHkocSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoc3BlZWQgPiAwLjEpIHsKICAgICAgICAgICAgICAgICAgICBfdGVtcFZlYy5jb3B5KHRoaXMudmVsb2NpdHkpLmNyb3NzKF9heGlzWSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKF90ZW1wVmVjLmxlbmd0aFNxKCkgPiAwLjAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21BeGlzQW5nbGUoX3RlbXBWZWMsIHNwZWVkICogZHQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFjY3VtdWxhdGVkUm90YXRpb24ucHJlbXVsdGlwbHkocSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKd2luZG93LmZsdXguQmFsbCA9IEJhbGw7CiAgICB3aW5kb3cuZmx1eC5UcmFpbFJlbmRlcmVyID0gVHJhaWxSZW5kZXJlcjsKfSkoKTs=","GameManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFNwYXJrIFRleHR1cmUgKFByb2NlZHVyYWwgQnVyc3QpCiAgICBjb25zdCBfc3BhcmtUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw2NCw2NCk7CiAgICAgICAgCiAgICAgICAgLy8gQnVyc3Qgc2hhcGUKICAgICAgICBjb25zdCBjeCA9IDMyLCBjeSA9IDMyOwogICAgICAgIGNvbnN0IHNwaWtlcyA9IDg7CiAgICAgICAgY29uc3Qgb3V0ZXIgPSAzMDsKICAgICAgICBjb25zdCBpbm5lciA9IDEwOwogICAgICAgIAogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBmb3IobGV0IGk9MDsgaTxzcGlrZXMqMjsgaSsrKXsKICAgICAgICAgICAgY29uc3QgciA9IChpJTI9PT0wKT8gb3V0ZXIgOiBpbm5lcjsKICAgICAgICAgICAgY29uc3QgYSA9IChNYXRoLlBJKmkpL3NwaWtlczsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKnIsIGN5ICsgTWF0aC5zaW4oYSkqcik7CiAgICAgICAgfQogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmNjMDAnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgLy8gV2hpdGUgQ29yZQogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHguYXJjKGN4LCBjeSwgOCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjb25zdCBfc3BhcmtNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IAogICAgICAgIG1hcDogX3NwYXJrVGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBHYW1lTWFuYWdlciB7CgogICAgICAgIApjb25zdHJ1Y3RvcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEsIHJlbmRlcmVyKSB7CndpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIgPSByZW5kZXJlcjsgLy8gU3RvcmUgcmVuZGVyZXIKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmNhbWVyYSA9IGNhbWVyYTsKICAgICAgICAgICAgdGhpcy51aUxheWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodWlMYXllcklkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc2NvcmUgPSB7IGhvbWU6IDAsIGF3YXk6IDAgfTsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5oYWxmID0gMTsKICAgICAgICAgICAgdGhpcy5oYWxmRHVyYXRpb24gPSAzMDA7IC8vIDUgbWludXRlcyAoc2Vjb25kcykKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNEZW1vTW9kZSA9IGZhbHNlOwp0aGlzLmdhbWVNb2RlID0gJ25vcm1hbCc7IC8vICdub3JtYWwnIG9yICdwcmFjdGljZScKICAgICAgICAgICAgdGhpcy5pc0ZvcmdlTW9kZSA9IGZhbHNlOyAvLyBBc3NldCBGb3JnZSBTdGF0ZQogICAgICAgICAgICAvLyBJbXBhY3QgRnJhbWVzCiAgICAgICAgICAgIHRoaXMuaW1wYWN0UGF1c2UgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsgLy8gU3RhcnQgaW4gbWVudQp0aGlzLnRlYW1zID0gewogICAgICAgICAgICAgICAgaG9tZTogbnVsbCwKICAgICAgICAgICAgICAgIGF3YXk6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZW50aXRpZXMgPSB7CiAgICAgICAgICAgICAgICBiYWxsOiBudWxsCiAgICAgICAgICAgIH07Cgp0aGlzLnVpID0gewogICAgICAgICAgICAgICAgc2NvcmVQbGF5ZXI6IG51bGwsCiAgICAgICAgICAgICAgICBzY29yZUNwdTogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWVyOiBudWxsLAogICAgICAgICAgICAgICAgaGFsZjogbnVsbCwKICAgICAgICAgICAgICAgIGFubm91bmNlbWVudDogbnVsbCwKICAgICAgICAgICAgICAgIC8vIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgICAgIHN0YXR1c1BhbmVsOiB7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyOiBudWxsLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBCYXI6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBUZXh0OiBudWxsLAogICAgICAgICAgICAgICAgICAgIGV4cEJhcjogbnVsbAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVGVjaGNvcHkgU3RhdGUKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHRpbWVyOiAwLAogICAgICAgICAgICAgICAgdGVjaDogbnVsbCwKICAgICAgICAgICAgICAgIGxlYXJuZXJzOiBbXQogICAgICAgICAgICB9OwoKdGhpcy5taW5pTWFwID0gbmV3IHdpbmRvdy5mbHV4Lk1pbmlNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgRmxvYXRpbmcgVGV4dAovLyBJbml0aWFsaXplIEZsb2F0aW5nIFRleHQKdGhpcy5mbG9hdGluZ1RleHQgPSBuZXcgd2luZG93LmZsdXguRmxvYXRpbmdUZXh0TWFuYWdlcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBVSSBjYWxjdWxhdGlvbnMKICAgICAgICAgICAgdGhpcy5fdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIFBhcnRpY2xlIE1hbmFnZXIgKFN0YXR1cyBFZmZlY3RzKQogICAgICAgICAgICAKLy8gSW5pdGlhbGl6ZSBQYXJ0aWNsZSBNYW5hZ2VyIChTdGF0dXMgRWZmZWN0cykKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyKHNjZW5lKTsKdGhpcy5nbHlwaE1hbmFnZXIgPSBudWxsOyAvLyBJbmplY3RlZCBieSBtYWluLmpzCnRoaXMuX2luaXRDaW5lbWF0aWNzKCk7CiAgICAgICAgICAgIHRoaXMuX2luaXRQYXJ0aWNsZXMoKTsgLy8gM0QgU3BhcmsgU3lzdGVtIChMZWdhY3kvSW1wYWN0KQoKdGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIgPSBuZXcgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyKHNjZW5lKTsKICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyKHRoaXMpOyAvLyBJbml0aWFsaXplIFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgdGhpcy5faW5qZWN0U3R5bGVzKCk7CnRoaXMuX2luaXRVSSgpOwogICAgICAgIH0KCl9pbml0Q2luZW1hdGljcygpIHsKICAgICAgICAgICAgLy8gTWVudSBCYWNrZ3JvdW5kIFNob3RzIChCLVJvbGwpCiAgICAgICAgICAgIHRoaXMubWVudVNob3RJbmRleCA9IDA7CiAgICAgICAgICAgIHRoaXMubWVudVNob3RUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubWVudVNob3RzID0gWwogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogMTAuMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNhbS5wb3NpdGlvbi5zZXQoNjAsIDM1LCA2MCkubGVycChuZXcgVEhSRUUuVmVjdG9yMyg0MCwgMjUsIDQwKSwgdCk7IGNhbS5sb29rQXQoMCwgMCwgMCk7IH0gfSwKICAgICAgICAgICAgICAgIHsgZHVyYXRpb246IDguMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNhbS5wb3NpdGlvbi5zZXQoLTI1LCA2LCAtMjUgKyA1MCp0KTsgY2FtLmxvb2tBdCgwLCAyLCAoLTI1ICsgNTAqdCkqMC44KTsgfSB9LAogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogOC4wLCB1cGRhdGU6ICh0LCBjYW0pID0+IHsgY29uc3QgYSA9IHQrMy41OyBjYW0ucG9zaXRpb24uc2V0KC0xMCtNYXRoLmNvcyhhKSoxMCwgNCwgLTEwK01hdGguc2luKGEpKjEwKTsgY2FtLmxvb2tBdCgtMTAsIDEuNSwgLTEwKTsgfSB9LAogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogNy4wLCB1cGRhdGU6ICh0LCBjYW0pID0+IHsgY2FtLnBvc2l0aW9uLnNldCgwLCAtNSwgMzIpLmxlcnAobmV3IFRIUkVFLlZlY3RvcjMoMCwgOCwgMjApLCB0KTsgY2FtLmxvb2tBdCgwLCAxNSwgNDUpOyBjYW0ucm90YXRpb24ueiA9ICh0LTAuNSkqMC4xNTsgfSB9LAogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogOC4wLCB1cGRhdGU6ICh0LCBjYW0pID0+IHsgY2FtLnBvc2l0aW9uLnNldCgwLCA1MCwgMCkubGVycChuZXcgVEhSRUUuVmVjdG9yMygwLCAxMCwgMCksIHQqdCooMy0yKnQpKTsgY2FtLmxvb2tBdCgwLCAwLCAwKTsgY2FtLnJvdGF0aW9uLnogPSB0KjAuODsgfSB9CiAgICAgICAgICAgIF07CgogICAgICAgICAgICAvLyBFcGljIEludHJvIFNlcXVlbmNlICgiSGVyY3VsZWFuIikKICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RzID0gWwogICAgICAgICAgICAgICAgLy8gMS4gIlRoZSBBd2FrZW5pbmciIC0gQ2xvc2Ugb24gU3BoZXJlIC0+IFpvb20gT3V0IFVwc2lkZSBEb3duIC0+IExpZ2h0cyAmIFJvYXIKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogOC4wLAogICAgICAgICAgICAgICAgICAgIG9uU3RhcnQ6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiVEhFIFNQSEVSRSBQT09MIiwgInNsYW0iKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc3RhZGl1bSkgdGhpcy5zdGFkaXVtLnJlc2V0TGlnaHRzKCk7IC8vIEVuc3VyZSBkYXJrIHN0YXJ0CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhc1JvYXJlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQW1iaWVudCBzdGFydCBzb3VuZCAoRGVlcCBodW0gLyBVbmRlcndhdGVyIGZlZWwpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdzd2ltJywgeyB2b2x1bWU6IDEuMCwgcmF0ZTogMC4zIH0pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVhc2luZwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlYXNlID0gdCA8IDAuNSA/IDIgKiB0ICogdCA6IC0xICsgKDQgLSAyICogdCkgKiB0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBleHBUID0gTWF0aC5wb3codCwgMy4wKTsgLy8gU3Ryb25nIGV4cG9uZW50aWFsIHpvb20gb3V0CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYW1lcmEgTW90aW9uOiBTdGFydCBJTlNJREUvQ0xPU0UgKDAsMCwyKSAtPiBFbmQgRkFSIEJBQ0svVVAgKDAsIDgwLCAxNjApCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMik7IAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlbmRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCA4MCwgMTYwKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMoc3RhcnRQb3MsIGVuZFBvcywgZXhwVCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBEeW5hbWljIFJvbGw6IFR1cm4gdXBzaWRlIGRvd24gKDAgLT4gUEkpCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5yb3RhdGlvbi56ID0gZWFzZSAqIE1hdGguUEk7IAoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTGlnaHQgU2VxdWVuY2luZyAmIFNvdW5kCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsID0gdGhpcy5zdGFkaXVtLmxpZ2h0Q291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsaWdodFByb2dyZXNzID0gTWF0aC5tYXgoMCwgKHQgLSAwLjIpIC8gMC42KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2ZUNvdW50ID0gTWF0aC5mbG9vcihsaWdodFByb2dyZXNzICogdG90YWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyICJSb2FyIHRvIExpZmUiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGlnaHRQcm9ncmVzcyA+IDAuNSAmJiAhdGhpcy5faGFzUm9hcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faGFzUm9hcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdnb2FsJywgeyB2b2x1bWU6IDEuMCwgcmF0ZTogMC43IH0pOyAvLyBEZWVwIHJvYXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAwLjgsIHJhdGU6IDAuNSB9KTsgLy8gV2hvb3NoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgxLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpIDwgdG90YWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpIDw9IGFjdGl2ZUNvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IHRoaXMuc3RhZGl1bS5saWdodFNwcml0ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcHJpdGUgJiYgIXNwcml0ZS52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YWRpdW0udHVybk9uTGlnaHQoaSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluZHVzdHJpYWwgTGlnaHQgU0ZYCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpdGNoID0gMC41ICsgKGkgLyB0b3RhbCkgKiAwLjU7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2ltcGFjdCcsIHsgdm9sdW1lOiAwLjQsIHJhdGU6IHBpdGNoLCB2YXJpYW5jZTogMC4wIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuMik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gMi4gIlRoZSBSb2FyIiAtIFN3ZWVwaW5nIGNyb3dkIHNob3QKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogNC4wLAogICAgICAgICAgICAgICAgICAgIG9uU3RhcnQ6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJMRUdFTkRBUlkgQVJFTkEiLCAibm9ybWFsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuY2FtZXJhTWFuYWdlcikgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDEuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdnb2FsJywgeyB2b2x1bWU6IDAuNyB9KTsgLy8gQ3Jvd2QgY2hlZXIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhc3BlY3QgPSB3aW5kb3cuaW5uZXJXaWR0aCAvIHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNQb3J0cmFpdCA9IGFzcGVjdCA8IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gLU1hdGguUEkvMiArICh0ICogTWF0aC5QSSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBpc1BvcnRyYWl0ID8gODUgOiA2NTsgLy8gUHVsbCBiYWNrIGluIHBvcnRyYWl0CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24uc2V0KE1hdGguY29zKGFuZ2xlKSpyLCAxNSwgTWF0aC5zaW4oYW5nbGUpKnIpOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KDAsIDUsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyAzLiAiSG9tZSBHbG9yeSIgLSBPcmJpdCBIb21lIFRlYW0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogMy41LAogICAgICAgICAgICAgICAgICAgIG9uU3RhcnQ6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJCRVNBSUQgQVVST0NIUyIsICJzbGFtIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnY2VsZWJyYXRlJywgMC4yKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJywgeyB2b2x1bWU6IDAuNSB9KTsgLy8gV2hvb3NoCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB1cGRhdGU6ICh0LCBjYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYXNwZWN0ID0gd2luZG93LmlubmVyV2lkdGggLyB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzUG9ydHJhaXQgPSBhc3BlY3QgPCAxLjA7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBPcmJpdCBIb21lIFRlYW0gKFNpZGUgMSwgLVopCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIC0yMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5QSSArICh0ICogMS41KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IGlzUG9ydHJhaXQgPyAyMCA6IDEyOyAvLyBQdWxsIGJhY2sgaWYgcG9ydHJhaXQKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnBvc2l0aW9uLnNldChjZW50ZXIueCArIE1hdGguY29zKGFuZ2xlKSpyLCA0LCBjZW50ZXIueiArIE1hdGguc2luKGFuZ2xlKSpyKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdChjZW50ZXIueCwgMiwgY2VudGVyLnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyA0LiAiRW5lbXkgR2F0ZXMiIC0gVHJhY2tpbmcgQXdheSBUZWFtCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDMuNSwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiTFVDQSBHT0VSUyIsICJzbGFtIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnaWRsZScsIDAuMikpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAwLjUgfSk7IC8vIFdob29zaAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1BvcnRyYWl0ID0gYXNwZWN0IDwgMS4wOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJhY2tpbmcgQXdheSBUZWFtIChTaWRlIC0xLCArWikKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSBuZXcgVEhSRUUuVmVjdG9yMygtMTUsIDIsIDI1KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gbmV3IFRIUkVFLlZlY3RvcjMoMTUsIDIsIDI1KTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1BvcnRyYWl0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydC54ICo9IDEuNTsgZW5kLnggKj0gMS41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQueiArPSAxMDsgZW5kLnogKz0gMTA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5wb3NpdGlvbi5sZXJwVmVjdG9ycyhzdGFydCwgZW5kLCB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdCgwLCAzLCAyNSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIDUuICJUaGUgU3BoZXJlIiAtIFpvb20gdG8gY2VudGVyCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDIuMCwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQkxJVFogT0ZGISIsICJzbGFtIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc3RhZGl1bSkgdGhpcy5zdGFkaXVtLnNldEFsbExpZ2h0cyh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3doaXN0bGUnLCB7IHZvbHVtZTogMC44IH0pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1BvcnRyYWl0ID0gYXNwZWN0IDwgMS4wOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcDEgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAzMCwgaXNQb3J0cmFpdCA/IDcwIDogNTApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwMiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDE0LCAyMik7IC8vIEdhbWVwbGF5IGNhbQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdCA9IHQgKiB0OwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCBzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBdOwogICAgICAgIH0KCiAgICAgICAgX2luamVjdFN0eWxlcygpIHsKICAgICAgICAgICAgaWYgKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmbHV4LWR5bmFtaWMtc3R5bGVzJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpOwogICAgICAgICAgICBzdHlsZS5pZCA9ICdmbHV4LWR5bmFtaWMtc3R5bGVzJzsKc3R5bGUudGV4dENvbnRlbnQgPSBgCiAgICAgICAgICAgICAgICBAa2V5ZnJhbWVzIHRleHRTbGFtIHsKICAgICAgICAgICAgICAgICAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDQpOyBvcGFjaXR5OiAwOyBsZXR0ZXItc3BhY2luZzogNTBweDsgfQogICAgICAgICAgICAgICAgICAgIDEwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyBvcGFjaXR5OiAxOyBsZXR0ZXItc3BhY2luZzogNXB4OyB9CiAgICAgICAgICAgICAgICAgICAgMTUlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4xKTsgfQogICAgICAgICAgICAgICAgICAgIDIwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyB9CiAgICAgICAgICAgICAgICAgICAgODAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IG9wYWNpdHk6IDE7IGZpbHRlcjogYmx1cigwcHgpOyB9CiAgICAgICAgICAgICAgICAgICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuNSk7IG9wYWNpdHk6IDA7IGZpbHRlcjogYmx1cigxMHB4KTsgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAuYW5ub3VuY2VtZW50LXNsYW0gewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgICAgICAgICB0b3A6IDQ1JTsgbGVmdDogNTAlOwogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiAxMDAlOwogICAgICAgICAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgICAgICAgICBmb250LWZhbWlseTogJ0ltcGFjdCcsIHNhbnMtc2VyaWY7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiA5NnB4OwogICAgICAgICAgICAgICAgICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmZmYgMCUsICNmZmRkMDAgNDUlLCAjZmY4ODAwIDEwMCUpOwogICAgICAgICAgICAgICAgICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgICAgICAgICAgICAgICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4IHJnYmEoMCwwLDAsMSkpIGRyb3Atc2hhZG93KDAgMCAzMHB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuNikpOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDIwMDA7CiAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uOiB0ZXh0U2xhbSAxLjhzIGN1YmljLWJlemllcigwLjEsIDAuOCwgMC4xLCAxKSBmb3J3YXJkczsKICAgICAgICAgICAgICAgICAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgICAgICAgICAgICAgICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC5tb2RhbC1vdmVybGF5IHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7IHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IGNlbnRlciwgcmdiYSgxMCwgMjUsIDYwLCAwLjk1KSAwJSwgcmdiYSgwLCAwLCAwLCAwLjk4KSAxMDAlKTsKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiBmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsgYWxpZ24taXRlbXM6IGNlbnRlcjsgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgICAgICAgICAgICAgICB6LWluZGV4OiAxOTAwOwogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IDA7IHBvaW50ZXItZXZlbnRzOiBub25lOyB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuOHM7CiAgICAgICAgICAgICAgICAgICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDhweCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAubW9kYWwtb3ZlcmxheS5hY3RpdmUgeyBvcGFjaXR5OiAxOyBwb2ludGVyLWV2ZW50czogYXV0bzsgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAubW9kYWwtdGl0bGUgewogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnR2FyYW1vbmQnLCBzZXJpZjsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDUycHg7IGNvbG9yOiAjZmZmOwogICAgICAgICAgICAgICAgICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICMwMGFhZmYsIDAgMCA0MHB4ICMwMDQ0YWE7CiAgICAgICAgICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMzBweDsKICAgICAgICAgICAgICAgICAgICBib3JkZXItYm90dG9tOiAycHggc29saWQgIzAwYWFmZjsKICAgICAgICAgICAgICAgICAgICBwYWRkaW5nLWJvdHRvbTogMTBweDsKICAgICAgICAgICAgICAgICAgICB3aWR0aDogODAlOyB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLm1vZGFsLXNjb3JlLWNvbnRhaW5lciB7CiAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgZ2FwOiA0MHB4OwogICAgICAgICAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDQwcHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAubW9kYWwtc2NvcmUgewogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnSW1wYWN0Jywgc2Fucy1zZXJpZjsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDgwcHg7IGNvbG9yOiAjZmZkNzAwOwogICAgICAgICAgICAgICAgICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICNiODg2MGI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAubW9kYWwtdnMgewogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiAyNHB4OyBjb2xvcjogIzAwYWFmZjsgb3BhY2l0eTogMC43OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC5mbGFzaC1vdmVybGF5IHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7IHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgICAgICAgICAgICAgICAgICB6LWluZGV4OiAyMTAwOwogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IDA7IHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC4xcyBlYXNlLW91dDsKICAgICAgICAgICAgICAgICAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBAa2V5ZnJhbWVzIGNsYXNoUG9wIHsKICAgICAgICAgICAgICAgICAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDAuNSk7IG9wYWNpdHk6IDE7IH0KICAgICAgICAgICAgICAgICAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjUpOyBvcGFjaXR5OiAwLjg7IH0KICAgICAgICAgICAgICAgICAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMi4wKTsgb3BhY2l0eTogMDsgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC5jbGFzaC1zcGFyayB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiA2MHB4OyBoZWlnaHQ6IDYwcHg7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgI2ZmZmZmZiAwJSwgI2ZmZmYwMCA0MCUsIHRyYW5zcGFyZW50IDcwJSk7CiAgICAgICAgICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICAgICAgICAgICAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDE1MDA7CiAgICAgICAgICAgICAgICAgICAgbWl4LWJsZW5kLW1vZGU6IHNjcmVlbjsKICAgICAgICAgICAgICAgICAgICBhbmltYXRpb246IGNsYXNoUG9wIDAuM3MgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICAgICAgICAgICAgICAgICAgYm94LXNoYWRvdzogMCAwIDIwcHggI2ZmYWEwMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKICAgICAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZSk7CiAgICAgICAgfQoKICAgICAgICByZWdpc3RlclRlYW1zKGhvbWVUZWFtLCBhd2F5VGVhbSwgYmFsbCkgewogICAgICAgICAgICB0aGlzLnRlYW1zLmhvbWUgPSBob21lVGVhbTsKICAgICAgICAgICAgdGhpcy50ZWFtcy5hd2F5ID0gYXdheVRlYW07CnRoaXMuZW50aXRpZXMuYmFsbCA9IGJhbGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsaXplIE1pbmlNYXAKICAgICAgICAgICAgaWYgKHRoaXMubWluaU1hcCkgewogICAgICAgICAgICAgICAgdGhpcy5taW5pTWFwLmluaXQoaG9tZVRlYW0sIGF3YXlUZWFtLCBiYWxsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9pbml0VUkoKSB7CiAgICAgICAgICAgIC8vIEJpbmQgdG8gZXhpc3RpbmcgSFRNTCBlbGVtZW50cwogICAgICAgICAgICB0aGlzLnVpLnNjb3JlUGxheWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Njb3JlLXBsYXllcicpOwogICAgICAgICAgICB0aGlzLnVpLnNjb3JlQ3B1ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Njb3JlLWNwdScpOwogICAgICAgICAgICB0aGlzLnVpLnRpbWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RpbWVyLWRpc3BsYXknKTsKICAgICAgICAgICAgdGhpcy51aS5oYWxmID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hhbGYtaW5kaWNhdG9yJyk7CiAgICAgICAgICAgIHRoaXMudWkuYW5ub3VuY2VtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Fubm91bmNlbWVudCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy51aS50ZWNoRmxhc2ggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGVjaC1mbGFzaC1vdmVybGF5Jyk7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoU3ViID0gdGhpcy51aS50ZWNoRmxhc2gucXVlcnlTZWxlY3RvcignLnRlY2gtc3ViLXRleHQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnVpLnRlY2hUaW1lckZpbGwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudGVjaC10aW1lci1maWxsJyk7CgogICAgICAgICAgICAvLyBCaW5kIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpOwogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLm5hbWUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAuY2hhci1uYW1lJyk7CiAgICAgICAgICAgIHRoaXMudWkuc3RhdHVzUGFuZWwuaHBCYXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAuaHAtYmFyLWZpbGwnKTsKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5ocFRleHQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAuaHAtdmFsdWUnKTsKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5leHBCYXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAudGVjaC1iYXItZmlsbCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5kIEdhbWUgTWVudSBCaW5kaW5ncwogICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLWdhbWUtbWVudScpOwogICAgICAgICAgICBjb25zdCBidG5SZW1hdGNoID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1idG4tcmVtYXRjaCcpOwogICAgICAgICAgICBjb25zdCBidG5FeGl0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1idG4tZXhpdCcpOwoKICAgICAgICAgICAgaWYgKGJ0blJlbWF0Y2gpIHsKICAgICAgICAgICAgICAgIGJ0blJlbWF0Y2guYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZUVuZE1lbnUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0TWF0Y2godGhpcy5nYW1lTW9kZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYnRuRXhpdCkgewogICAgICAgICAgICAgICAgYnRuRXhpdC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlRW5kTWVudSgpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ3JlYXRlIE1vZGFsIE92ZXJsYXkgKEZvciBIYWxmdGltZSBvbmx5IG5vdykKICAgICAgICAgICAgdGhpcy51aS5tb2RhbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTmFtZSA9ICdtb2RhbC1vdmVybGF5JzsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5pbm5lckhUTUwgPSBgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC10aXRsZSI+SEFMRiBUSU1FPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC1zY29yZS1jb250YWluZXIiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXNjb3JlIiBpZD0ibW9kYWwtc2NvcmUtaG9tZSI+MDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXZzIj4tPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtc2NvcmUiIGlkPSJtb2RhbC1zY29yZS1hd2F5Ij4wPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgaWQ9Im1vZGFsLW1zZyIgc3R5bGU9ImNvbG9yOiAjMDBhYWZmOyBmb250LXNpemU6IDE0cHg7IGxldHRlci1zcGFjaW5nOiAycHg7Ij5QUkVQQVJJTkcgMk5EIEhBTEYuLi48L2Rpdj4KICAgICAgICAgICAgYDsKICAgICAgICAgICAgdGhpcy51aUxheWVyLmFwcGVuZENoaWxkKHRoaXMudWkubW9kYWwpOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIEZsYXNoIE92ZXJsYXkKICAgICAgICAgICAgdGhpcy51aS5mbGFzaCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0aGlzLnVpLmZsYXNoLmNsYXNzTmFtZSA9ICdmbGFzaC1vdmVybGF5JzsKICAgICAgICAgICAgdGhpcy51aUxheWVyLmFwcGVuZENoaWxkKHRoaXMudWkuZmxhc2gpOwoKICAgICAgICAgICAgLy8gSW5pdGlhbCBTdGF0ZQogICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRpbWVyKSB0aGlzLnVpLnRpbWVyLmlubmVyVGV4dCA9ICIwMDowMCI7CiAgICAgICAgfQogICAgICAgIF91cGRhdGVTY29yZVVJKCkgewogICAgICAgICAgICBpZiAodGhpcy51aS5zY29yZVBsYXllcikgdGhpcy51aS5zY29yZVBsYXllci5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnNjb3JlQ3B1KSB0aGlzLnVpLnNjb3JlQ3B1LmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuYXdheTsKICAgICAgICB9Cgp1cGRhdGVQcmFjdGljZShkdCkgewogICAgICAgICAgICAvLyBEZWxlZ2F0ZSBsb2dpYyB0byBQcmFjdGljZU1hbmFnZXIKICAgICAgICAgICAgaWYgKHRoaXMucHJhY3RpY2VNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLnByYWN0aWNlTWFuYWdlci51cGRhdGUoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIC0tLSBQSFlTSUNTICYgTE9HSUMgVVBEQVRFIChGaXhlZCBUaW1lc3RlcCkgLS0tCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbnRybyAmIE1lbnUgYXJlIHB1cmVseSB2aXN1YWwgc3RhdGVzLCBoYW5kbGVkIGluIHVwZGF0ZVZpc3VhbHMKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdpbnRybycgfHwgdGhpcy5zdGF0ZSA9PT0gJ21lbnUnKSByZXR1cm47CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2JsaXR6X2NoYXJnZScpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUJsaXR6Q2hhcmdlKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2JsaXR6X2xhdW5jaCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUJsaXR6TGF1bmNoKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdhY3RpdmUnKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVUaW1lcigpOwogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tIYWxmVGltZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9jaGVja0dvYWxzKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVGVjaGNvcHkgTG9naWMgKFRpbWVyKQogICAgICAgICAgICBpZiAodGhpcy50ZWNoQ29weVN0YXRlLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLnRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmRUZWNoQ29weVdpbmRvdyhmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgLy8gLS0tIFZJU1VBTCBVUERBVEUgKE9uY2UgUGVyIEZyYW1lKSAtLS0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaW50cm8nKSB7CiAgICAgICAgICAgICAgICAvLyBQbGF5ZXIgV2FybXVwIEFuaW1hdGlvbnMKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUludHJvV2FybXVwKGR0KTsKCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaW50cm9TaG90cyB8fCB0aGlzLmludHJvU2hvdHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5za2lwSW50cm8oKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3Qgc2hvdCA9IHRoaXMuaW50cm9TaG90c1t0aGlzLmludHJvU2hvdEluZGV4XTsKICAgICAgICAgICAgICAgIHRoaXMuaW50cm9TaG90VGltZXIgKz0gZHQ7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuaW50cm9TaG90VGltZXIgPj0gc2hvdC5kdXJhdGlvbikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaW50cm9TaG90SW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmludHJvU2hvdFRpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnRyb1Nob3RJbmRleCA+PSB0aGlzLmludHJvU2hvdHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2tpcEludHJvKCk7IC8vIERvbmUKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5leHQgc2hvdCBzdGFydAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXh0U2hvdCA9IHRoaXMuaW50cm9TaG90c1t0aGlzLmludHJvU2hvdEluZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5leHRTaG90Lm9uU3RhcnQpIG5leHRTaG90Lm9uU3RhcnQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBjdXJyZW50IHNob3QKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gdGhpcy5pbnRyb1Nob3RUaW1lciAvIHNob3QuZHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhICYmIHNob3QudXBkYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3QudXBkYXRlKHQsIHRoaXMuY2FtZXJhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnbWVudScpIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBQT1BVTEFURSBBUkVOQSBGT1IgQi1ST0xMIC0tLQogICAgICAgICAgICAgICAgY29uc3QgYW5pbWF0ZVRlYW0gPSAodGVhbSkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICghdGVhbSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIHRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBHZW50bGUgYm9iYmluZyB0byBzaW11bGF0ZSB0cmVhZGluZyB3YXRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSBwLmhvbWVQb3NpdGlvbi55ICsgTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDAyICsgcC5tZXNoLmlkKSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBpZGxlIGFuaW1hdGlvbiBpcyBwbGF5aW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0ZSAhPT0gJ2lkbGUnKSBwLnBsYXkoJ2lkbGUnLCAwLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAubWl4ZXIpIHAubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGFuaW1hdGVUZWFtKHRoaXMudGVhbXMuaG9tZSk7CiAgICAgICAgICAgICAgICBhbmltYXRlVGVhbSh0aGlzLnRlYW1zLmF3YXkpOwoKICAgICAgICAgICAgICAgIC8vIC0tLSBDSU5FTUFUSUMgQi1ST0xMIC0tLQogICAgICAgICAgICAgICAgaWYgKHRoaXMubWVudVNob3RzICYmIHRoaXMubWVudVNob3RzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzaG90ID0gdGhpcy5tZW51U2hvdHNbdGhpcy5tZW51U2hvdEluZGV4XTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lbnVTaG90VGltZXIgKz0gZHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubWVudVNob3RUaW1lciA+PSBzaG90LmR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVudVNob3RUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVudVNob3RJbmRleCA9ICh0aGlzLm1lbnVTaG90SW5kZXggKyAxKSAlIHRoaXMubWVudVNob3RzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gTm9ybWFsaXplIHRpbWUgKDAgdG8gMSkKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gdGhpcy5tZW51U2hvdFRpbWVyIC8gc2hvdC5kdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvdC51cGRhdGUodCwgdGhpcy5jYW1lcmEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBbWJpZW50IEZYIGluIE1lbnUKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlciAmJiBNYXRoLnJhbmRvbSgpIDwgMC4yKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFuZ2UgPSA2MDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSpyYW5nZSwgCiAgICAgICAgICAgICAgICAgICAgICAgIC0xMCArIE1hdGgucmFuZG9tKCkqMjAsIAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKnJhbmdlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgcG9zLCB7IGxpZmU6IDMuMCArIE1hdGgucmFuZG9tKCkqMi4wLCBzY2FsZTogMC4zICsgTWF0aC5yYW5kb20oKSowLjQgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVXBkYXRlIEJhY2tncm91bmQgU3lzdGVtcwogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB0aGlzLnBhcnRpY2xlTWFuYWdlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgVGVjaGNvcHkgVUkKICAgICAgICAgICAgaWYgKHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUgJiYgdGhpcy51aS50ZWNoVGltZXJGaWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwY3QgPSBNYXRoLm1heCgwLCAodGhpcy50ZWNoQ29weVN0YXRlLnRpbWVyIC8gdGhpcy50ZWNoQ29weVN0YXRlLm1heFRpbWUpICogMTAwKTsKICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9IGAke3BjdH0lYDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ29sb3Igc2hpZnQgYmFzZWQgb24gdXJnZW5jeQogICAgICAgICAgICAgICAgaWYgKHBjdCA8IDMwKSB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICcjZmYwMDAwJzsKICAgICAgICAgICAgICAgIGVsc2UgdGhpcy51aS50ZWNoVGltZXJGaWxsLnN0eWxlLmJhY2tncm91bmQgPSAnbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjZmZmZmZmLCAjMDBmZmZmKSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEdlbmVyYWwgVmlzdWFscyAoQWx3YXlzIFJ1biBleGNlcHQgSW50cm8vTWVudSkKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdtZW51JyAmJiB0aGlzLnN0YXRlICE9PSAnaW50cm8nKSB7CiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgYmFuZCBwb3NzZXNzaW9uIGRpc3BsYXkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC51cGRhdGVCYW5kUG9zc2Vzc2lvbiAmJiB0aGlzLmVudGl0aWVzICYmIHRoaXMuZW50aXRpZXMuYmFsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaG9tZUhhc0JhbGwgPSBiYWxsLmhvbGRlciAmJiBiYWxsLmhvbGRlci50ZWFtICYmIGJhbGwuaG9sZGVyLnRlYW0uaXNIdW1hbjsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC51cGRhdGVCYW5kUG9zc2Vzc2lvbihob21lSGFzQmFsbCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMubWluaU1hcCkgdGhpcy5taW5pTWFwLnVwZGF0ZSgpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZmxvYXRpbmdUZXh0KSB0aGlzLmZsb2F0aW5nVGV4dC51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB0aGlzLnBhcnRpY2xlTWFuYWdlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFydGljbGVzKGR0KTsgLy8gTGVnYWN5IHNwYXJrcwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlR29hbFRyYW5zcGFyZW5jeSgpOyAvLyBEeW5hbWljIEdvYWwgRmFkaW5nCiAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIpIHRoaXMuZGVidWdWaXN1YWxpemVyLnVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlR29hbFRyYW5zcGFyZW5jeSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmNhbWVyYSkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZ29hbHMgPSBbd2luZG93LmZsdXguZ29hbEEsIHdpbmRvdy5mbHV4LmdvYWxCXTsKICAgICAgICAgICAgY29uc3QgZmFkZURpc3QgPSAzNS4wOyAvLyBEaXN0YW5jZSB0byBzdGFydCBmYWRpbmcKICAgICAgICAgICAgY29uc3QgbWluRmFkZURpc3QgPSAxNS4wOyAvLyBEaXN0YW5jZSB3aGVyZSBpdCdzIG1vc3QgdHJhbnNwYXJlbnQKICAgICAgICAgICAgY29uc3QgbWluT3BhY2l0eSA9IDAuMjsKCiAgICAgICAgICAgIGdvYWxzLmZvckVhY2goZ29hbCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWdvYWwpIHJldHVybjsKCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlzdGFuY2UgZnJvbSBjYW1lcmEgdG8gZ29hbCBwb3NpdGlvbgogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMuY2FtZXJhLnBvc2l0aW9uLmRpc3RhbmNlVG8oZ29hbC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBvcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCBmYWRlRGlzdCkgewogICAgICAgICAgICAgICAgICAgIC8vIExpbmVhciBmYWRlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IChkaXN0IC0gbWluRmFkZURpc3QpIC8gKGZhZGVEaXN0IC0gbWluRmFkZURpc3QpOwogICAgICAgICAgICAgICAgICAgIG9wYWNpdHkgPSBUSFJFRS5NYXRoVXRpbHMuY2xhbXAodCwgMC4wLCAxLjApICogKDEuMCAtIG1pbk9wYWNpdHkpICsgbWluT3BhY2l0eTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBpc1RyYW5zcGFyZW50ID0gb3BhY2l0eSA8IDAuOTk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdG8gYWxsIG1lc2hlcyBpbiBnb2FsIGhpZXJhcmNoeQogICAgICAgICAgICAgICAgZ29hbC50cmF2ZXJzZShjaGlsZCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLmlzTWVzaCAmJiBjaGlsZC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXQgPSBjaGlsZC5tYXRlcmlhbDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgdXBkYXRlIGlmIGNoYW5nZWQgdG8gbWluaW1pemUgb3ZlcmhlYWQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKG1hdC5vcGFjaXR5IC0gb3BhY2l0eSkgPiAwLjAxIHx8IG1hdC50cmFuc3BhcmVudCAhPT0gaXNUcmFuc3BhcmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Lm9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0LnRyYW5zcGFyZW50ID0gaXNUcmFuc3BhcmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIERpc2FibGUgZGVwdGhXcml0ZSB3aGVuIHRyYW5zcGFyZW50IHNvIHdlIGNhbiBzZWUgdGhlIGJhbGwgaW5zaWRlIHRoZSBuZXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdC5kZXB0aFdyaXRlID0gIWlzVHJhbnNwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXQubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwp9CiAgICAgICAgX3VwZGF0ZU9mZnNjcmVlbkluZGljYXRvcigpIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMudGVhbXMuaG9tZSA/IHRoaXMudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIgOiBudWxsOwogICAgICAgICAgICBjb25zdCBpbmRpY2F0b3IgPSB0aGlzLnVpLm9mZnNjcmVlbkluZGljYXRvcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghcCB8fCAhcC5tZXNoIHx8ICF0aGlzLmNhbWVyYSB8fCAhaW5kaWNhdG9yKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBHZXQgUGxheWVyIFBvc2l0aW9uIChDZW50ZXIgTWFzcykKICAgICAgICAgICAgY29uc3QgcG9zID0gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgIHBvcy55ICs9IDEuMDsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAyLiBQcm9qZWN0IHRvIE5vcm1hbGl6ZWQgRGV2aWNlIENvb3JkaW5hdGVzIChOREMpIFstMSwgMV0KICAgICAgICAgICAgdGhpcy5fdGVtcFZlYy5jb3B5KHBvcykucHJvamVjdCh0aGlzLmNhbWVyYSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBDaGVjayBpZiBCZWhpbmQgQ2FtZXJhCiAgICAgICAgICAgIGNvbnN0IGNhbUZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKGNhbUZ3ZCk7CiAgICAgICAgICAgIGNvbnN0IHRvUGxheWVyID0gcG9zLmNsb25lKCkuc3ViKHRoaXMuY2FtZXJhLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgY29uc3QgZG90ID0gY2FtRndkLmRvdCh0b1BsYXllcik7CiAgICAgICAgICAgIGNvbnN0IGlzQmVoaW5kID0gZG90IDwgMC4yOyAvLyBCdWZmZXIgdG8gcHJldmVudCBmbGlwcGluZyBhdCBlZGdlCgogICAgICAgICAgICAvLyA0LiBDaGVjayBCb3VuZHMKICAgICAgICAgICAgY29uc3QgaXNPZmZTY3JlZW4gPSAoCiAgICAgICAgICAgICAgICB0aGlzLl90ZW1wVmVjLnggPCAtMC45IHx8IHRoaXMuX3RlbXBWZWMueCA+IDAuOSB8fAogICAgICAgICAgICAgICAgdGhpcy5fdGVtcFZlYy55IDwgLTAuOSB8fCB0aGlzLl90ZW1wVmVjLnkgPiAwLjkgfHwKICAgICAgICAgICAgICAgIGlzQmVoaW5kCiAgICAgICAgICAgICk7CgogICAgICAgICAgICBpZiAoaXNPZmZTY3JlZW4pIHsKICAgICAgICAgICAgICAgIGluZGljYXRvci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHggPSB0aGlzLl90ZW1wVmVjLng7CiAgICAgICAgICAgICAgICBsZXQgeSA9IHRoaXMuX3RlbXBWZWMueTsKCiAgICAgICAgICAgICAgICAvLyBJZiBiZWhpbmQsIGludmVydCBjb29yZGluYXRlcyB0byBwb2ludCBjb3JyZWN0bHkKICAgICAgICAgICAgICAgIGlmIChpc0JlaGluZCkgewogICAgICAgICAgICAgICAgICAgIHggPSAteDsKICAgICAgICAgICAgICAgICAgICB5ID0gLXk7CiAgICAgICAgICAgICAgICAgICAgLy8gRml4IHNpbmd1bGFyaXR5IGlmIGV4YWN0bHkgYmVoaW5kIGNlbnRlcgogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyh4KSA8IDAuMDEgJiYgTWF0aC5hYnMoeSkgPCAwLjAxKSB5ID0gLTE7IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENsYW1wIHRvIHNjcmVlbiBlZGdlcwogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCB0byBmaW5kIHRoZSBpbnRlcnNlY3Rpb24gb2YgdGhlIHZlY3RvciAoeCx5KSB3aXRoIHRoZSBib3ggWy0wLjksIDAuOV0KICAgICAgICAgICAgICAgIGNvbnN0IHBhZGRpbmcgPSAwLjk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSB0byBnZXQgZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBjb25zdCBtYWcgPSBNYXRoLnNxcnQoeCp4ICsgeSp5KTsKICAgICAgICAgICAgICAgIGNvbnN0IG54ID0geCAvIG1hZzsKICAgICAgICAgICAgICAgIGNvbnN0IG55ID0geSAvIG1hZzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmF5Y2FzdCB0byBib3ggZWRnZXMKICAgICAgICAgICAgICAgIC8vIFZlcnRpY2FsIGVkZ2VzOiB4ID0gKy8tIHBhZGRpbmcKICAgICAgICAgICAgICAgIC8vIEhvcml6b250YWwgZWRnZXM6IHkgPSArLy0gcGFkZGluZwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBdm9pZCBkaXZpZGUgYnkgemVybwogICAgICAgICAgICAgICAgY29uc3QgdHggPSAoTWF0aC5hYnMobngpID4gMC4wMDEpID8gKG54ID4gMCA/IHBhZGRpbmcgOiAtcGFkZGluZykgLyBueCA6IDk5OTsKICAgICAgICAgICAgICAgIGNvbnN0IHR5ID0gKE1hdGguYWJzKG55KSA+IDAuMDAxKSA/IChueSA+IDAgPyBwYWRkaW5nIDogLXBhZGRpbmcpIC8gbnkgOiA5OTk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFVzZSB0aGUgbmVhcmVzdCBpbnRlcnNlY3Rpb24gKHNtYWxsZXN0IHBvc2l0aXZlIHQpCiAgICAgICAgICAgICAgICAvLyBTaW5jZSB3ZSBhcmUgcHJvamVjdGluZyBmcm9tIGNlbnRlciAoMCwwKSB0byAobngsbnkpLCB0IG11c3QgYmUgcG9zaXRpdmUuCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gTWF0aC5taW4oTWF0aC5hYnModHgpLCBNYXRoLmFicyh0eSkpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBzY3JlZW5YID0gbnggKiB0OwogICAgICAgICAgICAgICAgY29uc3Qgc2NyZWVuWSA9IG55ICogdDsKCiAgICAgICAgICAgICAgICAvLyBDb252ZXJ0IE5EQyB0byBQaXhlbHMKICAgICAgICAgICAgICAgIGNvbnN0IHdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBoZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHB4ID0gKHNjcmVlblggKiAwLjUgKyAwLjUpICogd2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBweSA9ICgtKHNjcmVlblkpICogMC41ICsgMC41KSAqIGhlaWdodDsKCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgUm90YXRpb24KICAgICAgICAgICAgICAgIC8vIEFycm93IHBvaW50cyBVUCBieSBkZWZhdWx0LgogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCBpdCB0byBwb2ludCBpbiBkaXJlY3Rpb24gKG54LCBueSkgb24gc2NyZWVuLgogICAgICAgICAgICAgICAgLy8gU2NyZWVuIFkgaXMgZG93biAoaW52ZXJ0ZWQgZnJvbSBXZWJHTCBZKS4KICAgICAgICAgICAgICAgIC8vIFNvICgwLCAxKSBpbiBOREMgaXMgVVAuICgwLCAtMSkgaW4gTkRDIGlzIERPV04uCiAgICAgICAgICAgICAgICAvLyBhdGFuMih5LCB4KSBnaXZlcyBhbmdsZSBmcm9tICtYLgogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCBhbmdsZSBmcm9tICtZIChVcCkuCiAgICAgICAgICAgICAgICAvLyBSb3RhdGlvbiA9IFBJLzIgLSBhbmdsZS4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKG55LCBueCk7CiAgICAgICAgICAgICAgICBjb25zdCByb3QgPSAoTWF0aC5QSSAvIDIpIC0gYW5nbGU7CgogICAgICAgICAgICAgICAgaW5kaWNhdG9yLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHtweH1weCwgJHtweX1weCkgcm90YXRlKCR7cm90fXJhZClgOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgaW5kaWNhdG9yLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVUaW1lcigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnVpLnRpbWVyKSByZXR1cm47CiAgICAgICAgICAgIC8vIENsYW1wIHRvIGhhbGYgZHVyYXRpb24gZm9yIGRpc3BsYXkgaWYgd2UgZ28gc2xpZ2h0bHkgb3ZlciBiZWZvcmUgdGljawogICAgICAgICAgICBjb25zdCB0ID0gTWF0aC5taW4odGhpcy50aW1lLCB0aGlzLmhhbGZEdXJhdGlvbik7CiAgICAgICAgICAgIGNvbnN0IG1pbnV0ZXMgPSBNYXRoLmZsb29yKHQgLyA2MCk7CiAgICAgICAgICAgIGNvbnN0IHNlY29uZHMgPSBNYXRoLmZsb29yKHQgJSA2MCk7CiAgICAgICAgICAgIHRoaXMudWkudGltZXIuaW5uZXJUZXh0ID0gYCR7bWludXRlcy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9OiR7c2Vjb25kcy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9YDsKICAgICAgICB9CiAgICAgICAgX2NoZWNrSGFsZlRpbWUoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnRpbWUgPj0gdGhpcy5oYWxmRHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5kSGFsZigpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKZW5kSGFsZigpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdoYWxmdGltZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdG9wIGFsbCBwbGF5ZXJzCiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFsZiA9PT0gMSkgewogICAgICAgICAgICAgICAgdGhpcy5fc2hvd01vZGFsKCJIQUxGIFRJTUUiLCAiUFJFUEFSSU5HIDJORCBIQUxGLi4uIik7CiAgICAgICAgICAgICAgICAKLy8gT3B0aW9uYWw6IFBsYXkgd2hpc3RsZSBzb3VuZCBoZXJlIGlmIGF2YWlsYWJsZQogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCd3aGlzdGxlJyk7CgogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZU1vZGFsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydFNlY29uZEhhbGYoKTsKICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRW5kIG9mIDJuZCBIYWxmIG9yIE92ZXJ0aW1lIFBlcmlvZAogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuaG9tZSA9PT0gdGhpcy5zY29yZS5hd2F5KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVElFRCAtIEdvIHRvIE92ZXJ0aW1lIChHb2xkZW4gR29hbCkKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93TW9kYWwoIk9WRVJUSU1FIiwgIkdPTERFTiBHT0FMIFJVTEUgQUNUSVZFIik7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVNb2RhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0T3ZlcnRpbWUoKTsKICAgICAgICAgICAgICAgICAgICB9LCA0MDAwKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV2lubmVyIGRlY2lkZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3RhcnRTZWNvbmRIYWxmKCkgewogICAgICAgICAgICB0aGlzLmhhbGYgPSAyOwogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYuaW5uZXJUZXh0ID0gIjJuZCBIQUxGIjsKICAgICAgICAgICAgdGhpcy5yZXNldFJvdW5kKG51bGwpOyAvLyBOZXV0cmFsIEJsaXR6LW9mZiBmb3IgMm5kIGhhbGYgc3RhcnQKICAgICAgICB9CgogICAgICAgIHN0YXJ0T3ZlcnRpbWUoKSB7CiAgICAgICAgICAgIHRoaXMuaGFsZisrOwogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmlzT3ZlcnRpbWUgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYuaW5uZXJUZXh0ID0gIk9WRVJUSU1FIjsKICAgICAgICAgICAgdGhpcy5yZXNldFJvdW5kKG51bGwpOyAvLyBOZXV0cmFsIEJsaXR6LW9mZgogICAgICAgIH0KCmVuZEdhbWUoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZ2FtZW92ZXInOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcCBwbGF5ZXJzCiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwoKICAgICAgICAgICAgbGV0IG1zZyA9ICJEUkFXIjsKICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuaG9tZSA+IHRoaXMuc2NvcmUuYXdheSkgbXNnID0gIlZJQ1RPUlkiOwogICAgICAgICAgICBpZiAodGhpcy5zY29yZS5hd2F5ID4gdGhpcy5zY29yZS5ob21lKSBtc2cgPSAiREVGRUFUIjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBvcHVsYXRlIEVuZCBHYW1lIE1lbnUKICAgICAgICAgICAgaWYgKHRoaXMudWkuZW5kTWVudSkgewogICAgICAgICAgICAgICAgY29uc3QgdGl0bGVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtcmVzdWx0LXRpdGxlJyk7CiAgICAgICAgICAgICAgICBjb25zdCBob21lU2NvcmVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtc2NvcmUtaG9tZScpOwogICAgICAgICAgICAgICAgY29uc3QgYXdheVNjb3JlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLXNjb3JlLWF3YXknKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRpdGxlRWwpIHsKICAgICAgICAgICAgICAgICAgICB0aXRsZUVsLmlubmVyVGV4dCA9IG1zZzsKICAgICAgICAgICAgICAgICAgICB0aXRsZUVsLnN0eWxlLmNvbG9yID0gKG1zZyA9PT0gIlZJQ1RPUlkiKSA/ICIjMDBmZmZmIiA6ICgobXNnID09PSAiREVGRUFUIikgPyAiI2ZmNDQ0NCIgOiAiI2ZmZmZmZiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGhvbWVTY29yZUVsKSBob21lU2NvcmVFbC5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgICAgICBpZiAoYXdheVNjb3JlRWwpIGF3YXlTY29yZUVsLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuYXdheTsKCiAgICAgICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1lbnVNb2RlKHRydWUpOyAvLyBIaWRlIEhVRAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdG9wIE11c2ljIG9uIEdhbWUgT3ZlcgogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnN0b3BCR00oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVFbmRNZW51KCkgewogICAgICAgICAgICBpZiAodGhpcy51aS5lbmRNZW51KSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1lbnVNb2RlKGZhbHNlKTsgLy8gU2hvdyBIVUQKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3Nob3dNb2RhbCh0aXRsZSwgc3VidGV4dCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkubW9kYWwpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignLm1vZGFsLXRpdGxlJykuaW5uZXJUZXh0ID0gdGl0bGU7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLXNjb3JlLWhvbWUnKS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLXNjb3JlLWF3YXknKS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmF3YXk7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLW1zZycpLmlubmVyVGV4dCA9IHN1YnRleHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBIVUQgZWxlbWVudHMKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKS5zdHlsZS5vcGFjaXR5ID0gJzAnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpLnN0eWxlLm9wYWNpdHkgPSAnMCc7CiAgICAgICAgfQoKICAgICAgICBfaGlkZU1vZGFsKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkubW9kYWwpIHJldHVybjsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNob3cgSFVEIGVsZW1lbnRzCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJykuc3R5bGUub3BhY2l0eSA9ICcxJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKS5zdHlsZS5vcGFjaXR5ID0gJzEnOwogICAgICAgIH0KCl9jaGVja0dvYWxzKCkgewogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoIWJhbGwgfHwgIWJhbGwubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgcG9zID0gYmFsbC5tZXNoLnBvc2l0aW9uOwoKICAgICAgICAgICAgLy8gUHJlY2lzZSBHb2FsIERldGVjdGlvbgogICAgICAgICAgICAvLyBWaXN1YWwgR29hbCBpcyBhdCBaID0gKy8tIDI4LgogICAgICAgICAgICAvLyBXZSBkZWZpbmUgYSAiR29hbCBNb3V0aCIgYm94IG1hdGNoaW5nIEdvYWxpZS5qcyAoV2lkdGggMTQsIEhlaWdodCA4KS4KLy8gV2UgZGVmaW5lIGEgIkdvYWwgTW91dGgiIGJveCBtYXRjaGluZyB0aGUgdmlzdWFsIG5ldC4KICAgICAgICAgICAgLy8gQXJlbmEgUmFkaXVzIGlzIDMyLiBHb2FsIGlzIHJvdWdobHkgMjJtIHdpZGUsIDE4bSBoaWdoLgovLyBBcmVuYSBSYWRpdXMgaXMgMzIuIEdvYWwgaXMgcm91Z2hseSAyMm0gd2lkZSwgMThtIGhpZ2guCiAgICAgICAgICAgIGNvbnN0IGhhbGZXaWR0aCA9IDExLjA7IC8vIEluY3JlYXNlZCB0byAxMSAoV2lkdGggMjIpIHRvIGNhdGNoIGNvcm5lcnMKICAgICAgICAgICAgY29uc3QgaGFsZkhlaWdodCA9IDkuMDsgLy8gSW5jcmVhc2VkIHRvIDkgKEhlaWdodCAxOCkgdG8gY2F0Y2ggaGlnaCBzaG90cwpjb25zdCBnb2FsWU9mZnNldCA9IC02LjA7IC8vIE1vdmVkIGRvd24gdG8gbWF0Y2ggdmlzdWFsIG1vZGVsICgtNi4wbSkKCmNvbnN0IHRyaWdnZXJaID0gNDAuNTsgLy8gVHJpZ2dlciBlYXJsaWVyICh3YXMgNDMuNSkgdG8gZW5zdXJlIHJlZ2lzdHJhdGlvbiBiZWZvcmUgYm91bmNlCgogICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnopID4gdHJpZ2dlclopIHsKICAgICAgICAgICAgICAgIC8vIFBSRVZFTlQgT1dOIEdPQUwgQlkgQ0FSUklFUiAoVXNlciBSZXF1ZXN0KQogICAgICAgICAgICAgICAgLy8gSWYgdGhlIGJhbGwgaXMgaGVsZCBieSB0aGUgdGVhbSBkZWZlbmRpbmcgdGhpcyBnb2FsLCBkbyBub3QgY291bnQgaXQuCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIb21lIChTaWRlIDEpIGRlZmVuZHMgK1ouIElmIHBvcy56ID4gMCAoSG9tZSBHb2FsKSBhbmQgaG9sZGVyIGlzIEhvbWUsIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPiAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gMSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIC8vIEF3YXkgKFNpZGUgLTEpIGRlZmVuZHMgLVouIElmIHBvcy56IDwgMCAoQXdheSBHb2FsKSBhbmQgaG9sZGVyIGlzIEF3YXksIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gLTEpIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyLiBDaGVjayBGcmFtZSAoTXVzdCBiZSB3aXRoaW4gd2lkdGgvaGVpZ2h0KQovLyAyLiBDaGVjayBGcmFtZSAoTXVzdCBiZSB3aXRoaW4gd2lkdGgvaGVpZ2h0LCBhY2NvdW50aW5nIGZvciBZIG9mZnNldCkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueCkgPD0gaGFsZldpZHRoICYmIE1hdGguYWJzKHBvcy55IC0gZ29hbFlPZmZzZXQpIDw9IGhhbGZIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ29hbFNjb3JlZCgnaG9tZScpOyAvLyBIb21lIGF0dGFja3MgLVoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdvYWxTY29yZWQoJ2F3YXknKTsgLy8gQXdheSBhdHRhY2tzICtaCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKZ29hbFNjb3JlZChzY29yZXIpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJTVBBQ1QgRlJBTUU6IEdPQUwKICAgICAgICAgICAgdGhpcy50cmlnZ2VySW1wYWN0KDAuNCwgJ3NoYXR0ZXInKTsgLy8gTWFzc2l2ZSBmcmVlemUgZm9yIGdvYWwKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVYUCBSRVdBUkQ6IEdvYWwKICAgICAgICAgICAgLy8gRmluZCB3aG8gc2NvcmVkIChMYXN0IGhvbGRlciBvZiBiYWxsKQogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLmxhc3RIb2xkZXIgJiYgYmFsbC5sYXN0SG9sZGVyLnRlYW0uaWQgPT09IHNjb3JlcikgewogICAgICAgICAgICAgICAgYmFsbC5sYXN0SG9sZGVyLmdhaW5FeHAoMTApOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2dvYWwnOwogICAgICAgICAgICB0aGlzLnNjb3JlW3Njb3Jlcl0rKzsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMS4gVklTQ0VSQUwgU0hBS0UgJiBQQVJUSUNMRVMKICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDIuMCk7IC8vIEhlYXZ5IHNoYWtlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIHRoaXMuZW50aXRpZXMuYmFsbCAmJiB0aGlzLmVudGl0aWVzLmJhbGwubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgZ29hbFBvcyA9IHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAvLyBNYXNzaXZlIEdvYWwgRXhwbG9zaW9uCiAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgZ29hbFBvcywgeyBzY2FsZTogMTUuMCwgbGlmZTogMC44IH0pOwogICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgZ29hbFBvcywgeyBzY2FsZTogMTAuMCB9KTsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDMwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGVicmlzJywgZ29hbFBvcywgeyBzY2FsZTogMC44IH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIDIuIFNDUkVFTiBGTEFTSAogICAgICAgICAgICBpZiAodGhpcy51aS5mbGFzaCkgewogICAgICAgICAgICAgICAgdGhpcy51aS5mbGFzaC5zdHlsZS5vcGFjaXR5ID0gJzAuOCc7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy51aS5mbGFzaC5zdHlsZS5vcGFjaXR5ID0gJzAnOyB9LCAxMDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBHT0xERU4gR09BTCBDSEVDSwogICAgICAgICAgICBpZiAodGhpcy5pc092ZXJ0aW1lKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkdPTERFTiBHT0FMISIsICdzbGFtJyk7CiAgICAgICAgICAgICAgICAvLyBFbmQgZ2FtZSBhZnRlciBzaG9ydCBkZWxheQogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmRHYW1lKCk7CiAgICAgICAgICAgICAgICB9LCAzMDAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNC4gU0xBTSBBTk5PVU5DRU1FTlQgKE5vcm1hbCkKLy8gNC4gU0xBTSBBTk5PVU5DRU1FTlQgKE5vcm1hbCkKICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJHT0FMISIsICdzbGFtJyk7CiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZ29hbCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgc2VxdWVuY2UKICAgICAgICAgICAgLy8gU2NvcmVkLXVwb24gdGVhbSBnZXRzIGJhbGwKICAgICAgICAgICAgY29uc3QgbG9zZXIgPSBzY29yZXIgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZBU1RFUiBGTE9XOiBSZWR1Y2VkIGRlbGF5IGZyb20gMzAwMG1zIHRvIDEyMDBtcwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChsb3Nlcik7CiAgICAgICAgICAgIH0sIDIwMDApOyAvLyBTbGlnaHRseSBsb25nZXIgdG8gYXBwcmVjaWF0ZSB0aGUgIkdPQUwiIHNsYW0KICAgICAgICB9CgpzaG93QW5ub3VuY2VtZW50KHRleHQsIHR5cGUgPSAnbm9ybWFsJywgZHVyYXRpb24gPSAyMDAwKSB7CiAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5hbm5vdW5jZW1lbnQ7CiAgICAgICAgICAgIGlmICghZWwpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENsZWFyIHByZXZpb3VzIHRpbWVvdXQKICAgICAgICAgICAgaWYgKHRoaXMuX2Fubm91bmNlVGltZW91dCkgewogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX2Fubm91bmNlVGltZW91dCk7CiAgICAgICAgICAgICAgICB0aGlzLl9hbm5vdW5jZVRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBBbmltYXRpb24gYnkgY2xvbmluZwogICAgICAgICAgICBjb25zdCBuZXdFbCA9IGVsLmNsb25lTm9kZSh0cnVlKTsKICAgICAgICAgICAgZWwucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQobmV3RWwsIGVsKTsKICAgICAgICAgICAgdGhpcy51aS5hbm5vdW5jZW1lbnQgPSBuZXdFbDsKCiAgICAgICAgICAgIG5ld0VsLmlubmVyVGV4dCA9IHRleHQ7CiAgICAgICAgICAgIG5ld0VsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgQ2xhc3MgYmFzZWQgb24gdHlwZQogICAgICAgICAgICBuZXdFbC5jbGFzc05hbWUgPSAnJzsgLy8gUmVzZXQgY2xhc3NlcwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3NsYW0nKSB7CiAgICAgICAgICAgICAgICBuZXdFbC5jbGFzc0xpc3QuYWRkKCdhbm5vdW5jZW1lbnQtc2xhbScpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRGVmYXVsdCBzdHlsZQogICAgICAgICAgICAgICAgbmV3RWwuc3R5bGUuYW5pbWF0aW9uID0gJ25vbmUnOwogICAgICAgICAgICAgICAgbmV3RWwub2Zmc2V0SGVpZ2h0OyAvKiB0cmlnZ2VyIHJlZmxvdyAqLwogICAgICAgICAgICAgICAgbmV3RWwuc3R5bGUuYW5pbWF0aW9uID0gJ2Fubm91bmNlU2xpZGUgMC41cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSknOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBdXRvLWhpZGUKICAgICAgICAgICAgaWYgKGR1cmF0aW9uID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fYW5ub3VuY2VUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlQW5ub3VuY2VtZW50KCk7CiAgICAgICAgICAgICAgICB9LCBkdXJhdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGhpZGVBbm5vdW5jZW1lbnQoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLmFubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgdGhpcy51aS5hbm5vdW5jZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCnJlc2V0Um91bmQocG9zc2Vzc2lvblRlYW1JZCkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ3Jlc2V0JzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENsZWFyIHBlcnNpc3RlbnQgdmlzdWFscwogICAgICAgICAgICBpZiAodGhpcy5nbHlwaE1hbmFnZXIpIHRoaXMuZ2x5cGhNYW5hZ2VyLmNsZWFyKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gT3B0aW9uYWw6IENsZWFyIHBhcnRpY2xlcyBpZiBuZWVkZWQsIHRob3VnaCB0aGV5IHNlbGYtZXhwaXJlIHF1aWNrbHkKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgQmFsbAogICAgICAgICAgICBpZiAodGhpcy5lbnRpdGllcy5iYWxsKSB0aGlzLmVudGl0aWVzLmJhbGwucmVzZXQoKTsKICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCkgdGhpcy5lbnRpdGllcy5iYWxsLnJlc2V0KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCBUZWFtcwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBiYWxsIGhvbGRlcgogICAgICAgICAgICBpZiAodGhpcy5lbnRpdGllcy5iYWxsKSB0aGlzLmVudGl0aWVzLmJhbGwuZHJvcCgpOwoKICAgICAgICAgICAgLy8gQ1JJVElDQUw6IFNuYXAgY2FtZXJhIHRvIHByZXZlbnQgZGlzb3JpZW50YXRpb24KICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gRm9yY2UgdXBkYXRlIHRhcmdldCBmaXJzdCAodXN1YWxseSBiYWxsKQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCAmJiB0aGlzLmVudGl0aWVzLmJhbGwubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQodGhpcy5lbnRpdGllcy5iYWxsLm1lc2gsIHRoaXMuZW50aXRpZXMuYmFsbC52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGQVNURVIgRkxPVzogUmVkdWNlZCBkZWxheSBmcm9tIDIwMDBtcyB0byAxMDBtcwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRLaWNrb2ZmKHBvc3Nlc3Npb25UZWFtSWQpOwp9LCAxMDApOwogICAgICAgIH0KCnN0YXJ0S2lja29mZihwb3NzZXNzaW9uVGVhbUlkKSB7CiAgICAgICAgICAgIC8vIFN0b3AgYWxsIHBsYXllcnMgaW1tZWRpYXRlbHkKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5hd2F5KSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gcC5zZXRJbnB1dCgwLCAwKSk7CgogICAgICAgICAgICAvLyBJZiBhIHRlYW0gaGFzIHBvc3Nlc3Npb24gKGFmdGVyIGdvYWwpLCBzdGFuZGFyZCBraWNrb2ZmCiAgICAgICAgICAgIGlmIChwb3NzZXNzaW9uVGVhbUlkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2tpY2tvZmYnOwogICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJCTElUWiBPRkYhIiwgJ3NsYW0nKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnd2hpc3RsZScpOwoKICAgICAgICAgICAgICAgIGNvbnN0IHRlYW0gPSB0aGlzLnRlYW1zW3Bvc3Nlc3Npb25UZWFtSWRdOwogICAgICAgICAgICAgICAgaWYgKHRlYW0pIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtZiA9IHRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgICAgICAgICBpZiAobWYgJiYgdGhpcy5lbnRpdGllcy5iYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW50aXRpZXMuYmFsbC5ncmFiKG1mKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNuYXAgY2FtZXJhIHRvIG5ldyBob2xkZXIKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldChtZi5tZXNoLCBtZi52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnYWN0aXZlJzsKICAgICAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBORVVUUkFMIEtJQ0tPRkY6ICJUaGUgQmxpdHogT2ZmIiBDaW5lbWF0aWMgU2VxdWVuY2UKICAgICAgICAgICAgICAgIHRoaXMuX3N0YXJ0TmV1dHJhbEJsaXR6T2ZmKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpfc3RhcnROZXV0cmFsQmxpdHpPZmYoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnYmxpdHpfY2hhcmdlJzsKICAgICAgICAgICAgdGhpcy5ibGl0elRpbWVyID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDEuIFJlc2V0IEJhbGwgdG8gQ2VudGVyIChEZWVwKQogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGJhbGwuZHJvcCgpOwogICAgICAgICAgICAgICAgYmFsbC5tZXNoLnBvc2l0aW9uLnNldCgwLCAtNSwgMCk7IC8vIFN0YXJ0IERFRVAgKC01bSkgZm9yICJncm91bmQgdXAiIHJpc2UKICAgICAgICAgICAgICAgIGJhbGwudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgYmFsbC5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgLy8gUmVzZXQgdmlzdWFscwogICAgICAgICAgICAgICAgaWYgKGJhbGwuZGVmb3JtTm9kZSkgYmFsbC5kZWZvcm1Ob2RlLnNjYWxlLnNldCgxLCAxLCAxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gUG9zaXRpb24gQ2FwdGFpbnMgKE1GcykKICAgICAgICAgICAgY29uc3QgaG9tZU1GID0gdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIGNvbnN0IGF3YXlNRiA9IHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwoKICAgICAgICAgICAgaWYgKGhvbWVNRiAmJiBob21lTUYubWVzaCkgewogICAgICAgICAgICAgICAgaG9tZU1GLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDgpOyAvLyA4bSBiYWNrCiAgICAgICAgICAgICAgICBob21lTUYubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBob21lTUYucGxheSgnaWRsZScsIDAuMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGF3YXlNRiAmJiBhd2F5TUYubWVzaCkgewogICAgICAgICAgICAgICAgYXdheU1GLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC04KTsgLy8gOG0gYmFjawogICAgICAgICAgICAgICAgYXdheU1GLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgYXdheU1GLnBsYXkoJ2lkbGUnLCAwLjEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBDYW1lcmEgRm9jdXMKICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlciAmJiBiYWxsICYmIGJhbGwubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldChiYWxsLm1lc2gsIG51bGwpOwogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICAgICAgLy8gWm9vbSBpbiB0aWdodAogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLmN1cnJlbnRQdWxsQmFjayA9IC0xMjsgCiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIubWFudWFsT3JiaXRQaXRjaCA9IDAuNDsgLy8gTG9vayBkb3duIHN0ZWVwCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJ1aWxkIFRlbnNpb24KICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJSRUFEWS4uLiIsICdub3JtYWwnKTsKICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdzd2ltJywgeyB2b2x1bWU6IDAuNSB9KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVCbGl0ekNoYXJnZShkdCkgewogICAgICAgICAgICB0aGlzLmJsaXR6VGltZXIgKz0gZHQ7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBjaGFyZ2VEdXJhdGlvbiA9IDIuMDsgLy8gTG9uZ2VyIGJ1aWxkIHVwIGZvciBjaW5lbWF0aWMgZmVlbAoKICAgICAgICAgICAgLy8gUEhBU0UgMTogQ0hBUkdFIChSaXNpbmcgZnJvbSBkZXB0aHMpCiAgICAgICAgICAgIGlmICh0aGlzLmJsaXR6VGltZXIgPCBjaGFyZ2VEdXJhdGlvbikgewogICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMuYmxpdHpUaW1lciAvIGNoYXJnZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgZWFzZVQgPSB0ICogdDsgLy8gUXVhZHJhdGljIGVhc2UgaW4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmlzZSBmcm9tIC01IHRvIDAgKEdyb3VuZCB1cCBlZmZlY3QpCiAgICAgICAgICAgICAgICBiYWxsLm1lc2gucG9zaXRpb24ueSA9IC01LjAgKyAoNS4wICogZWFzZVQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTcGluIHVwIChFeHBvbmVudGlhbCkKICAgICAgICAgICAgICAgIGJhbGwubWVzaC5yb3RhdGlvbi55ICs9ICgxMC4wICsgNTAuMCAqIHQpICogZHQ7CiAgICAgICAgICAgICAgICBiYWxsLm1lc2gucm90YXRpb24ueCArPSAoNS4wICsgMjAuMCAqIHQpICogZHQ7CgogICAgICAgICAgICAgICAgLy8gU3F1YXNoIChGbGF0dGVuIGxpa2UgYSBkaXNjIGJ1aWxkaW5nIGVuZXJneSkKICAgICAgICAgICAgICAgIGlmIChiYWxsLmRlZm9ybU5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBFeHRyZW1lIHNxdWFzaCBhdCB0aGUgZW5kCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3F1YXNoID0gMS4wIC0gKDAuNyAqIGVhc2VUKTsgLy8gRmxhdHRlbiBZIHRvIDAuMwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0cmV0Y2ggPSAxLjAgKyAoMC41ICogZWFzZVQpOyAvLyBFeHBhbmQgWFoKICAgICAgICAgICAgICAgICAgICBiYWxsLmRlZm9ybU5vZGUuc2NhbGUuc2V0KHN0cmV0Y2gsIHNxdWFzaCwgc3RyZXRjaCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2FtZXJhIFNoYWtlIGluY3JlYXNpbmcKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjIgKiB0KTsKCiAgICAgICAgICAgICAgICAvLyBQYXJ0aWNsZXM6IFJpc2luZyBFbmVyZ3kgZnJvbSBncm91bmQKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIC8vIEJ1YmJsZXMgcmlzaW5nIGZhc3QKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb3VudCA9IE1hdGguZmxvb3IodCAqIDgpICsgMTsKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByID0gMi4wICogKDEuMCAtIHQpOyAvLyBSYWRpdXMgc2hyaW5rcyBhcyBpdCBnZXRzIGNsb3NlciB0byBsYXVuY2gKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeCA9IE1hdGguY29zKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHogPSBNYXRoLnNpbihhbmdsZSkgKiByOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB5ID0gYmFsbC5tZXNoLnBvc2l0aW9uLnkgLSAxLjA7IC8vIEJlbG93IGJhbGwKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBuZXcgVEhSRUUuVmVjdG9yMyh4LCB5LCB6KSwgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDAuNCwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTogMC4yICsgdCAqIDAuNSAKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IAogICAgICAgICAgICAvLyBQSEFTRSAyOiBMQVVOQ0gKICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5zdGF0ZSA9PT0gJ2JsaXR6X2NoYXJnZScpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnYmxpdHpfbGF1bmNoJzsKICAgICAgICAgICAgICAgIHRoaXMuYmxpdHpUaW1lciA9IDA7IC8vIFJlc2V0IGZvciBsYXVuY2ggcGhhc2UKCiAgICAgICAgICAgICAgICAvLyBUSU1FRCBBTk5PVU5DRU1FTlQKICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQkxJVFogT0ZGISIsICdzbGFtJyk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdpbXBhY3QnLCB7IHZvbHVtZTogMS4wIH0pOyAvLyBCb29tCiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAxLjAgfSk7ICAgLy8gV2hvb3NoCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTGF1bmNoIEJhbGwKICAgICAgICAgICAgICAgIGJhbGwudmVsb2NpdHkuc2V0KDAsIDM1LCAwKTsgLy8gU2hvb3QgVVAgRkFTVAogICAgICAgICAgICAgICAgaWYgKGJhbGwuZGVmb3JtTm9kZSkgYmFsbC5kZWZvcm1Ob2RlLnNjYWxlLnNldCgwLjQsIDMuMCwgMC40KTsgLy8gRXh0cmVtZSBzdHJldGNoIHZlcnRpY2FsCgogICAgICAgICAgICAgICAgLy8gRlg6IE1hc3NpdmUgR3JvdW5kIEVydXB0aW9uCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgYmFsbC5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiA4LjAgfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgYmFsbC5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiA2LjAgfSk7CiAgICAgICAgICAgICAgICAgICAgLy8gVmVydGljYWwgc3RyZWFtCiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MTA7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gYmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHAueSArPSBpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwLCB7IHNjYWxlOiAzLjAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDMuMCk7IC8vIEhlYXZ5IHNoYWtlCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLmN1cnJlbnRQdWxsQmFjayA9IDEwOyAvLyBab29tIG91dCBmYXN0CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLm1hbnVhbE9yYml0UGl0Y2ggPSAwLjA7IC8vIExldmVsIG91dAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENhcHRhaW5zIEp1bXAKICAgICAgICAgICAgICAgIGNvbnN0IGhvbWVNRiA9IHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAgICAgY29uc3QgYXdheU1GID0gdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CgogICAgICAgICAgICAgICAgY29uc3QganVtcFRvID0gKHApID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAgfHwgIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IGJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1YihwLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGRpci55ID0gMS4yOyAvLyBTdGVlcCBqdW1wCiAgICAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5jb3B5KGRpcikubXVsdGlwbHlTY2FsYXIoMTguMCk7IC8vIEZhc3QganVtcAogICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2hfanVtcCcsIDAuMSk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGp1bXBUbyhob21lTUYpOwogICAgICAgICAgICAgICAganVtcFRvKGF3YXlNRik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVCbGl0ekxhdW5jaChkdCkgewogICAgICAgICAgICB0aGlzLmJsaXR6VGltZXIgKz0gZHQ7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBncmF2aXR5IG1hbnVhbGx5IGZvciBjaW5lbWF0aWMgZmVlbCAoSW5jcmVhc2VkIGdyYXZpdHkgZm9yIHNuYXBwaWVyIGFyYykKICAgICAgICAgICAgYmFsbC52ZWxvY2l0eS55IC09IDQwLjAgKiBkdDsgCiAgICAgICAgICAgIGJhbGwubWVzaC5wb3NpdGlvbi5hZGRTY2FsZWRWZWN0b3IoYmFsbC52ZWxvY2l0eSwgZHQpOwoKICAgICAgICAgICAgLy8gTW92ZSBQbGF5ZXJzIG1hbnVhbGx5CiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZUp1bXBlciA9IChwKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXAgfHwgIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS55IC09IDI1LjAgKiBkdDsgLy8gR3Jhdml0eQogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmFkZFNjYWxlZFZlY3RvcihwLnZlbG9jaXR5LCBkdCk7CiAgICAgICAgICAgICAgICBwLm1lc2gubG9va0F0KGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBob21lTUYgPSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgY29uc3QgYXdheU1GID0gdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB1cGRhdGVKdW1wZXIoaG9tZU1GKTsKICAgICAgICAgICAgdXBkYXRlSnVtcGVyKGF3YXlNRik7CgogICAgICAgICAgICAvLyBQSEFTRSAzOiBHUkFCIChBcGV4IH4wLjdzKQogICAgICAgICAgICBpZiAodGhpcy5ibGl0elRpbWVyID4gMC43ICYmIHRoaXMuc3RhdGUgPT09ICdibGl0el9sYXVuY2gnKSB7CiAgICAgICAgICAgICAgICAvLyBEZXRlcm1pbmUgV2lubmVyICg1MC81MCArIFN0YXQgYmlhcykKICAgICAgICAgICAgICAgIGNvbnN0IGhvbWVTcCA9IGhvbWVNRi5nZXRTdGF0KCdTUCcpOwogICAgICAgICAgICAgICAgY29uc3QgYXdheVNwID0gYXdheU1GLmdldFN0YXQoJ1NQJyk7CiAgICAgICAgICAgICAgICBjb25zdCB0b3RhbCA9IGhvbWVTcCArIGF3YXlTcDsKICAgICAgICAgICAgICAgIGNvbnN0IHJvbGwgPSBNYXRoLnJhbmRvbSgpICogdG90YWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHdpbm5lciA9IChyb2xsIDwgaG9tZVNwKSA/IGhvbWVNRiA6IGF3YXlNRjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgYmFsbC5ncmFiKHdpbm5lcik7CiAgICAgICAgICAgICAgICB0aGlzLmhpZGVBbm5vdW5jZW1lbnQoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mbG9hdGluZ1RleHQuc3Bhd24oIldPTiEiLCB3aW5uZXIubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBUcmFuc2l0aW9uIHRvIEFjdGl2ZQogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdhY3RpdmUnOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYSB0byB3aW5uZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KHdpbm5lci5tZXNoLCB3aW5uZXIudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuY2FtZXJhTWFuYWdlci5zbmFwVG9UYXJnZXQoKTsgLy8gT3B0aW9uYWw6IEtlZXAgc21vb3RoIG9yIHNuYXAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKLy8gSW5pdGlhbCBzdGFydAovLyBJbml0aWFsIHN0YXJ0CnN0YXJ0TWF0Y2gobW9kZSA9ICdub3JtYWwnKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZU1vZGUgPSBtb2RlOwogICAgICAgICAgICBjb25zb2xlLmxvZygiU3RhcnRpbmcgTWF0Y2ggaW4gbW9kZToiLCBtb2RlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IFNjb3JlCiAgICAgICAgICAgIHRoaXMuc2NvcmUuaG9tZSA9IDA7CiAgICAgICAgICAgIHRoaXMuc2NvcmUuYXdheSA9IDA7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IFRpbWUKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5oYWxmID0gMTsKICAgICAgICAgICAgaWYgKHRoaXMudWkuaGFsZikgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICIxc3QiOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKG1vZGUgPT09ICdwcmFjdGljZScpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiUFJBQyI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyLnN0YXJ0KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSW4gcHJhY3RpY2UsIGVuc3VyZSBBSSBpcyBlbmFibGVkIGZvciBzcGFycmluZwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5haUVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTdGFydCBCR00gaW1tZWRpYXRlbHkgZm9yIHByYWN0aWNlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gU2tpcCBpbnRybyBmb3IgcHJhY3RpY2UKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIFByYWN0aWNlIE1hbmFnZXIgaXMgc3RvcHBlZCBpZiBub3JtYWwgZ2FtZQogICAgICAgICAgICAgICAgaWYgKHRoaXMucHJhY3RpY2VNYW5hZ2VyKSB0aGlzLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNhZmV0eTogRW5zdXJlIGFsbCBwbGF5ZXJzIGFyZSB2aXNpYmxlIChpbiBjYXNlIFByYWN0aWNlIGhpZCB0aGVtKQogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7IGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSB0cnVlOyB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gdHJ1ZTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7IH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IENpbmVtYXRpYyBJbnRybwogICAgICAgICAgICAgICAgdGhpcy5zdGFydEludHJvU2VxdWVuY2UoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnNraXBJbnRybygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpbnRybycpIHJldHVybjsKICAgICAgICAgICAgY29uc29sZS5sb2coIkludHJvIENvbXBsZXRlL1NraXBwZWQiKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUkVTVE9SRSBVSSBFTEVNRU5UUwovLyBSRVNUT1JFIFVJIEVMRU1FTlRTCiAgICAgICAgICAgIGNvbnN0IHVpRWxlbWVudHMgPSBbCiAgICAgICAgICAgICAgICAnaHVkLXRvcCcsIAogICAgICAgICAgICAgICAgJ3BsYXllci1zdGF0dXMtcGFuZWwnLCAKICAgICAgICAgICAgICAgICdtaW5pbWFwLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2dvYWwtZGlzdGFuY2UtY29udGFpbmVyJywgCiAgICAgICAgICAgICAgICAnYWN0aW9uLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2pveXN0aWNrLWhpdC16b25lJywgCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXpvbmUnLAogICAgICAgICAgICAgICAgJ2F1dG8tdG9nZ2xlJywgCiAgICAgICAgICAgICAgICAnc2V0dGluZ3MtYnV0dG9uJywKICAgICAgICAgICAgICAgICdjb250cm9scy1oaW50JwogICAgICAgICAgICBdOwogICAgICAgICAgICAKICAgICAgICAgICAgdWlFbGVtZW50cy5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJyc7IC8vIFJldmVydCB0byBDU1MgZGVmYXVsdAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEhpZGUgQ2luZW1hdGljIEJhcnMKICAgICAgICAgICAgY29uc3QgYmFycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaW5lbWF0aWMtYmFycycpOwogICAgICAgICAgICBpZiAoYmFycykgewogICAgICAgICAgICAgICAgYmFycy5xdWVyeVNlbGVjdG9yQWxsKCcuYmFyJykuZm9yRWFjaChiID0+IGIuc3R5bGUuaGVpZ2h0ID0gJzAnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKLy8gTGlnaHRzIG9uCiAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS5zZXRBbGxMaWdodHModHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCBwbGF5ZXJzIHRvIGlkbGUKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnaWRsZScsIDAuMSkpOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5hd2F5KSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gcC5wbGF5KCdpZGxlJywgMC4xKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFydCBCR00gYWZ0ZXIgaW50cm8KICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0SW50cm9TZXF1ZW5jZSgpIHsKCiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaW50cm8nOwogICAgICAgICAgICB0aGlzLmludHJvU2hvdEluZGV4ID0gMDsKICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuX2hhc1JvYXJlZCA9IGZhbHNlOyAvLyBSZXNldCByb2FyIGZsYWcKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWwgc2V0dXAKICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bSkgdGhpcy5zdGFkaXVtLnNldEFsbExpZ2h0cyhmYWxzZSk7CgogICAgICAgICAgICAvLyBISURFIEFMTCBVSSBFTEVNRU5UUwogICAgICAgICAgICBjb25zdCB1aUVsZW1lbnRzID0gWwogICAgICAgICAgICAgICAgJ2h1ZC10b3AnLCAKICAgICAgICAgICAgICAgICdwbGF5ZXItc3RhdHVzLXBhbmVsJywgCiAgICAgICAgICAgICAgICAnbWluaW1hcC1jb250YWluZXInLCAKICAgICAgICAgICAgICAgICdnb2FsLWRpc3RhbmNlLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2FjdGlvbi1jb250YWluZXInLCAKICAgICAgICAgICAgICAgICd0YWNrbGUtYnV0dG9uJywgCiAgICAgICAgICAgICAgICAnam95c3RpY2staGl0LXpvbmUnLCAKICAgICAgICAgICAgICAgICdhaW0tam95c3RpY2stem9uZScsCiAgICAgICAgICAgICAgICAnam95c3RpY2stdmlzdWFsLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXZpc3VhbCcsCiAgICAgICAgICAgICAgICAnYXV0by10b2dnbGUnLCAKICAgICAgICAgICAgICAgICdzZXR0aW5ncy1idXR0b24nLAogICAgICAgICAgICAgICAgJ2NvbnRyb2xzLWhpbnQnLAogICAgICAgICAgICAgICAgJ2NoYXJnZS1tZXRlci1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJwogICAgICAgICAgICBdOwogICAgICAgICAgICAKICAgICAgICAgICAgdWlFbGVtZW50cy5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFNob3cgQ2luZW1hdGljIEJhcnMKICAgICAgICAgICAgY29uc3QgYmFycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaW5lbWF0aWMtYmFycycpOwogICAgICAgICAgICBpZiAoYmFycykgewogICAgICAgICAgICAgICAgYmFycy5xdWVyeVNlbGVjdG9yQWxsKCcuYmFyJykuZm9yRWFjaChiID0+IGIuc3R5bGUuaGVpZ2h0ID0gJzEwJScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIGlmICh0aGlzLmVudGl0aWVzLmJhbGwpIHRoaXMuZW50aXRpZXMuYmFsbC5yZXNldCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVHJpZ2dlciBmaXJzdCBzaG90IHN0YXJ0CiAgICAgICAgICAgIGlmICh0aGlzLmludHJvU2hvdHMgJiYgdGhpcy5pbnRyb1Nob3RzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmludHJvU2hvdHNbMF0ub25TdGFydCkgdGhpcy5pbnRyb1Nob3RzWzBdLm9uU3RhcnQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2tpcEludHJvKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cl91cGRhdGVJbnRyb1dhcm11cChkdCkgewogICAgICAgICAgICBjb25zdCBhbGxQbGF5ZXJzID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIGFsbFBsYXllcnMucHVzaCguLi50aGlzLnRlYW1zLmhvbWUucGxheWVycyk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIGFsbFBsYXllcnMucHVzaCguLi50aGlzLnRlYW1zLmF3YXkucGxheWVycyk7CgogICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBtaXhlciB1cGRhdGVzIChzaW5jZSBnYW1lIGxvb3AgbWlnaHQgc2tpcCBwbGF5ZXIudXBkYXRlIGluIGludHJvIHN0YXRlKQogICAgICAgICAgICAgICAgaWYgKHAubWl4ZXIpIHAubWl4ZXIudXBkYXRlKGR0KTsKCiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIHdhcm11cCB0aW1lciBpZiBuZWVkZWQKICAgICAgICAgICAgICAgIGlmIChwLl93YXJtdXBUaW1lciA9PT0gdW5kZWZpbmVkKSBwLl93YXJtdXBUaW1lciA9IE1hdGgucmFuZG9tKCkgKiAyLjA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHAuX3dhcm11cFRpbWVyIC09IGR0OwoKICAgICAgICAgICAgICAgIGlmIChwLl93YXJtdXBUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUGljayBuZXh0IGFjdGlvbiB0aW1lICgycyB0byA1cykKICAgICAgICAgICAgICAgICAgICBwLl93YXJtdXBUaW1lciA9IDIuMCArIE1hdGgucmFuZG9tKCkgKiAzLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFuZCA9IE1hdGgucmFuZG9tKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJhbmQgPCAwLjQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdpZGxlJywgMC41KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhbmQgPCAwLjYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdzd2ltJywgMC41KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhbmQgPCAwLjgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gIlN0cmV0Y2giIC8gQ2VsZWJyYXRlCiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2VsZWJyYXRlJywgMC41KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhbmQgPCAwLjkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjYXRjaCcsIDAuNSk7IC8vIENoZWNraW5nIGdsb3ZlcwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgncmVhY3QnLCAwLjUpOyAvLyBTaGFrZSBvZmYKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gR2VudGxlIGJvYmJpbmcgKHRyZWFkaW5nIHdhdGVyKQogICAgICAgICAgICAgICAgaWYgKHAuaG9tZVBvc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSBwLmhvbWVQb3NpdGlvbi55ICsgTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDAzICsgcC5tZXNoLmlkKSAqIDAuMzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKc2V0TWVudU1vZGUoaXNBY3RpdmUpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGlzQWN0aXZlID8gJ21lbnUnIDogJ2FjdGl2ZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaXNBY3RpdmUgJiYgdGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnN0b3BCR00oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTGlzdCBvZiBzdGF0aWMgSFVEIGVsZW1lbnRzIHRvIHRvZ2dsZQogICAgICAgICAgICBjb25zdCBzdGF0aWNVSSA9IFsKICAgICAgICAgICAgICAgICdodWQtdG9wJywKICAgICAgICAgICAgICAgICdwbGF5ZXItc3RhdHVzLXBhbmVsJywKICAgICAgICAgICAgICAgICdhY3Rpb24tY29udGFpbmVyJywKICAgICAgICAgICAgICAgICdqb3lzdGljay1oaXQtem9uZScsCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXpvbmUnLAogICAgICAgICAgICAgICAgJ21pbmltYXAtY29udGFpbmVyJywKICAgICAgICAgICAgICAgICdnb2FsLWRpc3RhbmNlLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAnc2V0dGluZ3MtYnV0dG9uJywKICAgICAgICAgICAgICAgICdhdXRvLXRvZ2dsZScsCiAgICAgICAgICAgICAgICAndGFja2xlLWJ1dHRvbicsCiAgICAgICAgICAgICAgICAnY29udHJvbHMtaGludCcKICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIC8vIExpc3Qgb2YgZHluYW1pYyBlbGVtZW50cyB0byBGT1JDRSBISURFIGluIG1lbnUKICAgICAgICAgICAgY29uc3QgZHluYW1pY1VJID0gWwogICAgICAgICAgICAgICAgJ2pveXN0aWNrLXZpc3VhbC1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ2FpbS1qb3lzdGljay12aXN1YWwnLAogICAgICAgICAgICAgICAgJ2NoYXJnZS1tZXRlci1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ3RlY2gtZmxhc2gtb3ZlcmxheScsCiAgICAgICAgICAgICAgICAncHJhY3RpY2UtcmVzdG9yZS1idG4nCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBpZiAoaXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgIC8vIEhJREUgQUxMCiAgICAgICAgICAgICAgICBbLi4uc3RhdGljVUksIC4uLmR5bmFtaWNVSV0uZm9yRWFjaChpZCA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBTSE9XIFNUQVRJQyBPTkxZCiAgICAgICAgICAgICAgICBzdGF0aWNVSS5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlkID09PSAnaHVkLXRvcCcgfHwgaWQgPT09ICdhY3Rpb24tY29udGFpbmVyJykgZWwuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBlbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIC8vIER5bmFtaWMgb25lcyByZW1haW4gaGlkZGVuL2NvbnRyb2xsZWQgYnkgdGhlaXIgbG9naWMKICAgICAgICAgICAgfQogICAgICAgIH0KdG9nZ2xlRGVtb01vZGUoKSB7CiAgICAgICAgICAgIHRoaXMuaXNEZW1vTW9kZSA9ICF0aGlzLmlzRGVtb01vZGU7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJEZW1vIE1vZGU6IiwgdGhpcy5pc0RlbW9Nb2RlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBVSSBCdXR0b24KICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F1dG8tdG9nZ2xlJyk7CiAgICAgICAgICAgIGlmIChidG4pIHsKICAgICAgICAgICAgICAgIGJ0bi5pbm5lclRleHQgPSB0aGlzLmlzRGVtb01vZGUgPyAiQVVUTyBQSUxPVCIgOiAiTUFOVUFMIjsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzRGVtb01vZGUpIHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSB0aGlzLmlzRGVtb01vZGUgPyAiQVVUTyBQSUxPVCIgOiAiTUFOVUFMIjsKICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KHRleHQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIEZsYWlyOiBTcGF3biB0ZXh0IGFib3ZlIGFjdGl2ZSBwbGF5ZXIKICAgICAgICAgICAgaWYgKHRoaXMuaXNEZW1vTW9kZSAmJiB0aGlzLmZsb2F0aW5nVGV4dCAmJiB0aGlzLnRlYW1zLmhvbWUgJiYgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciAmJiB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKCJBSSBFTkdBR0VEIiwgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllci5tZXNoLnBvc2l0aW9uLCAiZ29hbCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBdXRvLWhpZGUgYW5ub3VuY2VtZW50CnNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkuYW5ub3VuY2VtZW50ICYmIHRoaXMudWkuYW5ub3VuY2VtZW50LmlubmVyVGV4dCA9PT0gdGV4dCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBURUNIQ09QWSBTWVNURU0gLS0tCgogICAgICAgIHRyaWdnZXJUZWNoRXZlbnQoc291cmNlUGxheWVyLCB0ZWNoTmFtZSkgewogICAgICAgICAgICBpZiAoIXNvdXJjZVBsYXllciB8fCAhc291cmNlUGxheWVyLnRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIC8vIEZpbmQgb3Bwb3NpbmcgdGVhbQogICAgICAgICAgICBjb25zdCBvcHBUZWFtSWQgPSBzb3VyY2VQbGF5ZXIudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gdGhpcy50ZWFtc1tvcHBUZWFtSWRdOwogICAgICAgICAgICBpZiAoIW9wcFRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIC8vIEZpbmQgd2hvIGlzIG1hcmtpbmcgdGhpcyBzb3VyY2UKICAgICAgICAgICAgY29uc3QgbGVhcm5lcnMgPSBvcHBUZWFtLnBsYXllcnMuZmlsdGVyKHAgPT4gcC5tYXJraW5nID09PSBzb3VyY2VQbGF5ZXIpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGxlYXJuZXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gT25seSBzaG93IFVJIGlmIHRoZSBsZWFybmluZyB0ZWFtIGlzIEh1bWFuIChIb21lKQogICAgICAgICAgICAvLyAoT3IgaWYgd2UgYXJlIGluIERlbW8gbW9kZSBhbmQgd2FudCB0byBzZWUgaXQgaGFwcGVuIGZvciBIb21lIHRlYW0pCiAgICAgICAgICAgIGlmIChvcHBUZWFtLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIC8vIEZpbHRlciBvdXQgdGhvc2Ugd2hvIGFscmVhZHkga25vdyBpdAogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRMZWFybmVycyA9IGxlYXJuZXJzLmZpbHRlcihwID0+ICFwLmxlYXJuZWRUZWNocy5pbmNsdWRlcyh0ZWNoTmFtZSkpOwogICAgICAgICAgICAgICAgaWYgKHZhbGlkTGVhcm5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRUZWNoQ29weVdpbmRvdyh0ZWNoTmFtZSwgdmFsaWRMZWFybmVycyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzdGFydFRlY2hDb3B5V2luZG93KHRlY2hOYW1lLCBsZWFybmVycykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLm1heFRpbWUgPSAwLjY7IC8vIDAuNnMgd2luZG93CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciA9IHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUudGVjaCA9IHRlY2hOYW1lOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUubGVhcm5lcnMgPSBsZWFybmVyczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNob3cgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaEZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoRmxhc2guc3R5bGUuYmFja2dyb3VuZCA9ICIiOyAvLyBSZXNldCBiYWNrZ3JvdW5kCiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlRFQ0hDT1BZISI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hTdWIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hTdWIuaW5uZXJUZXh0ID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IGJhcgogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaFRpbWVyRmlsbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9ICcxMDAlJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmF0dGVtcHRUZWNoQ29weSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdWNjZXNzIQogICAgICAgICAgICBjb25zdCB0ZWNoID0gdGhpcy50ZWNoQ29weVN0YXRlLnRlY2g7CiAgICAgICAgICAgIGNvbnN0IGxlYXJuZXJzID0gdGhpcy50ZWNoQ29weVN0YXRlLmxlYXJuZXJzOwogICAgICAgICAgICAKICAgICAgICAgICAgbGVhcm5lcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIC8vIERvdWJsZSBjaGVjayB0byBwcmV2ZW50IGR1cGxpY2F0ZXMKICAgICAgICAgICAgICAgIGlmICghcC5sZWFybmVkVGVjaHMuaW5jbHVkZXModGVjaCkpIHsKICAgICAgICAgICAgICAgICAgICBwLmxlYXJuZWRUZWNocy5wdXNoKHRlY2gpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3Aucm9sZX0gbGVhcm5lZCAke3RlY2h9IWApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDEuIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5mbG9hdGluZ1RleHQgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKGBMRUFSTkVEIWAsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gUGFydGljbGUgRWZmZWN0IChTcGlyYWwpCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biBtdWx0aXBsZSBwYXJ0aWNsZXMgZm9yIGEgc3dpcmwgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDEwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGkgKiA1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5lbmRUZWNoQ29weVdpbmRvdyh0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKZW5kVGVjaENvcHlXaW5kb3coc3VjY2VzcykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlNVQ0NFU1MhIjsKICAgICAgICAgICAgICAgICAgICAvLyBGbGFzaCBzdWNjZXNzIGNvbG9yIChXaGl0ZSBmbGFzaCkKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5iYWNrZ3JvdW5kID0gInJnYmEoMjU1LCAyNTUsIDI1NSwgMC44KSI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSGlkZSBhZnRlciBzaG9ydCBkZWxheSB0byBzaG93IHRoZSBzdWNjZXNzIGZsYXNoCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOyAKICAgICAgICAgICAgICAgICAgICB9LCAzMDApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBGYWlsZWQgLyBNaXNzZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQpfdXBkYXRlUGxheWVyU3RhdHVzVUkoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtcy5ob21lIHx8ICF0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBwID0gdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgdWkgPSB0aGlzLnVpLnN0YXR1c1BhbmVsOwogICAgICAgICAgICAKLy8gVUkgVXBkYXRlcyAoQWN0aW9uIEJ1dHRvbiBDb250ZXh0KQogICAgICAgICAgICAgICAgdWkuY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOYW1lICYgTGV2ZWwKICAgICAgICAgICAgICAgIGlmICh1aS5uYW1lKSB1aS5uYW1lLmlubmVyVGV4dCA9IGAke3AuY2hhcmFjdGVyTmFtZSB8fCBwLnJvbGV9IExWJHtwLmxldmVsfWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEhQCiAgICAgICAgICAgICAgICBpZiAodWkuaHBCYXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBocFBjdCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEwMCwgKHAuc3RhdHMuSFAgLyBwLnN0YXRzLm1heEhQKSAqIDEwMCkpOwogICAgICAgICAgICAgICAgICAgIHVpLmhwQmFyLnN0eWxlLndpZHRoID0gYCR7aHBQY3R9JWA7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29sb3Igc2hpZnQKICAgICAgICAgICAgICAgICAgICBpZiAoaHBQY3QgPCAyNSkgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAwMDAsICNmZjQ0NDQpJzsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChocFBjdCA8IDUwKSB1aS5ocEJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmYwMCwgI2ZmZmY4OCknOwogICAgICAgICAgICAgICAgICAgIGVsc2UgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwMGZmMDAsICNjY2ZmY2MpJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1aS5ocFRleHQpIHVpLmhwVGV4dC5pbm5lclRleHQgPSBgJHtNYXRoLmZsb29yKHAuc3RhdHMuSFApfS8ke3Auc3RhdHMubWF4SFB9YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRVhQCiAgICAgICAgICAgICAgICBpZiAodWkuZXhwQmFyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwUGN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMTAwLCAocC5leHAgLyBwLm5leHRMZXZlbEV4cCkgKiAxMDApKTsKICAgICAgICAgICAgICAgICAgICB1aS5leHBCYXIuc3R5bGUud2lkdGggPSBgJHtleHBQY3R9JWA7CnVpLmV4cEJhci5zdHlsZS53aWR0aCA9IGAke2V4cFBjdH0lYDsKICAgICAgICAgICAgICAgIH0KICAgICAgICB9CgpfaW5pdFBhcnRpY2xlcygpIHsKICAgICAgICAgICAgdGhpcy5hY3RpdmVTcGFya3MgPSBbXTsKICAgICAgICAgICAgdGhpcy5zcGFya1Bvb2wgPSBbXTsKICAgICAgICAgICAgY29uc3QgcG9vbFNpemUgPSA0MDsgLy8gU3VmZmljaWVudCBmb3IgY29udGludW91cyBncmluZGluZwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb29sU2l6ZTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSBuZXcgVEhSRUUuU3ByaXRlKF9zcGFya01hdGVyaWFsLmNsb25lKCkpOwogICAgICAgICAgICAgICAgc3ByaXRlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHNwcml0ZSk7CiAgICAgICAgICAgICAgICB0aGlzLnNwYXJrUG9vbC5wdXNoKHNwcml0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNwYXduQ2xhc2gocG9zLCBpbnRlbnNpdHkgPSAxLjApIHsKICAgICAgICAgICAgLy8gRmluZCBmcmVlIHNwYXJrCiAgICAgICAgICAgIGNvbnN0IHNwYXJrID0gdGhpcy5zcGFya1Bvb2wuZmluZChzID0+ICFzLnZpc2libGUpOwogICAgICAgICAgICBpZiAoIXNwYXJrKSByZXR1cm47IC8vIFBvb2wgZXhoYXVzdGVkCiAgICAgICAgICAgIAogICAgICAgICAgICBzcGFyay5wb3NpdGlvbi5jb3B5KHBvcyk7CiAgICAgICAgICAgIHNwYXJrLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmFuZG9taXplIHJvdGF0aW9uCiAgICAgICAgICAgIHNwYXJrLm1hdGVyaWFsLnJvdGF0aW9uID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsaXplIEFjdGl2ZSBTdGF0ZQogICAgICAgICAgICB0aGlzLmFjdGl2ZVNwYXJrcy5wdXNoKHsKICAgICAgICAgICAgICAgIG1lc2g6IHNwYXJrLAogICAgICAgICAgICAgICAgYWdlOiAwLAogICAgICAgICAgICAgICAgbGlmZTogMC4xNSArIE1hdGgucmFuZG9tKCkgKiAwLjE1LCAvLyBGYXN0LCBwdW5jaHkgc3BhcmtzCiAgICAgICAgICAgICAgICBtYXhTY2FsZTogMi41ICogaW50ZW5zaXR5LAogICAgICAgICAgICAgICAgdmVsb2NpdHk6IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqOCwgCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSo4LCAKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKjgKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlUGFydGljbGVzKGR0KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmFjdGl2ZVNwYXJrcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuYWN0aXZlU3BhcmtzW2ldOwogICAgICAgICAgICAgICAgcC5hZ2UgKz0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChwLmFnZSA+PSBwLmxpZmUpIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlU3BhcmtzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgdCA9IHAuYWdlIC8gcC5saWZlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBFeHBhbmQKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRTY2FsZSA9IDAuNSArIChwLm1heFNjYWxlIC0gMC41KSAqIHQ7CiAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKGN1cnJlbnRTY2FsZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZhZGUgb3V0CiAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IDEuMCAtICh0ICogdCk7IC8vIFF1YWRyYXRpYyBmYWRlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE1vdmUKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5hZGRTY2FsZWRWZWN0b3IocC52ZWxvY2l0eSwgZHQpOwogICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLnJvdGF0aW9uICs9IDEwLjAgKiBkdDsKICAgICAgICAgICAgfQogICAgICAgIH0KCi8vIEhlbHBlciBmb3IgaW1wYWN0IGZyYW1lcwoKdHJpZ2dlckltcGFjdChkdXJhdGlvbiwgdHlwZSA9ICdkZWZhdWx0JykgewogICAgICAgICAgICB0aGlzLmltcGFjdFBhdXNlID0gZHVyYXRpb247CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKICAgICAgICAgICAgaWYgKCFjb250YWluZXIpIHJldHVybjsKCiAgICAgICAgICAgIC8vIFJlc2V0IGNsYXNzZXMgdG8gZW5zdXJlIGFuaW1hdGlvbiByZXN0YXJ0cwogICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZSgnaW1wYWN0LWZ4JywgJ2ltcGFjdC1oZWF2eScsICdpbXBhY3Qtc2hhdHRlcicpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRm9yY2UgcmVmbG93CiAgICAgICAgICAgIHZvaWQgY29udGFpbmVyLm9mZnNldFdpZHRoOwoKICAgICAgICAgICAgbGV0IGNsYXNzTmFtZSA9ICdpbXBhY3QtZngnOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2hlYXZ5JykgY2xhc3NOYW1lID0gJ2ltcGFjdC1oZWF2eSc7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnc2hhdHRlcicpIGNsYXNzTmFtZSA9ICdpbXBhY3Qtc2hhdHRlcic7CgogICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LmFkZChjbGFzc05hbWUpOwoKICAgICAgICAgICAgLy8gQXV0by1yZW1vdmUgY2xhc3MgYWZ0ZXIgZHVyYXRpb24KICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpOwogICAgICAgICAgICB9LCBkdXJhdGlvbiAqIDEwMDAgKyAxMDApOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5HYW1lTWFuYWdlciA9IEdhbWVNYW5hZ2VyOwp9KSgpOw==","./GameManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFNwYXJrIFRleHR1cmUgKFByb2NlZHVyYWwgQnVyc3QpCiAgICBjb25zdCBfc3BhcmtUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw2NCw2NCk7CiAgICAgICAgCiAgICAgICAgLy8gQnVyc3Qgc2hhcGUKICAgICAgICBjb25zdCBjeCA9IDMyLCBjeSA9IDMyOwogICAgICAgIGNvbnN0IHNwaWtlcyA9IDg7CiAgICAgICAgY29uc3Qgb3V0ZXIgPSAzMDsKICAgICAgICBjb25zdCBpbm5lciA9IDEwOwogICAgICAgIAogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBmb3IobGV0IGk9MDsgaTxzcGlrZXMqMjsgaSsrKXsKICAgICAgICAgICAgY29uc3QgciA9IChpJTI9PT0wKT8gb3V0ZXIgOiBpbm5lcjsKICAgICAgICAgICAgY29uc3QgYSA9IChNYXRoLlBJKmkpL3NwaWtlczsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKnIsIGN5ICsgTWF0aC5zaW4oYSkqcik7CiAgICAgICAgfQogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmNjMDAnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgLy8gV2hpdGUgQ29yZQogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHguYXJjKGN4LCBjeSwgOCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjb25zdCBfc3BhcmtNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IAogICAgICAgIG1hcDogX3NwYXJrVGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBHYW1lTWFuYWdlciB7CgogICAgICAgIApjb25zdHJ1Y3RvcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEsIHJlbmRlcmVyKSB7CndpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIgPSByZW5kZXJlcjsgLy8gU3RvcmUgcmVuZGVyZXIKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmNhbWVyYSA9IGNhbWVyYTsKICAgICAgICAgICAgdGhpcy51aUxheWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodWlMYXllcklkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc2NvcmUgPSB7IGhvbWU6IDAsIGF3YXk6IDAgfTsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5oYWxmID0gMTsKICAgICAgICAgICAgdGhpcy5oYWxmRHVyYXRpb24gPSAzMDA7IC8vIDUgbWludXRlcyAoc2Vjb25kcykKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNEZW1vTW9kZSA9IGZhbHNlOwp0aGlzLmdhbWVNb2RlID0gJ25vcm1hbCc7IC8vICdub3JtYWwnIG9yICdwcmFjdGljZScKICAgICAgICAgICAgdGhpcy5pc0ZvcmdlTW9kZSA9IGZhbHNlOyAvLyBBc3NldCBGb3JnZSBTdGF0ZQogICAgICAgICAgICAvLyBJbXBhY3QgRnJhbWVzCiAgICAgICAgICAgIHRoaXMuaW1wYWN0UGF1c2UgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsgLy8gU3RhcnQgaW4gbWVudQp0aGlzLnRlYW1zID0gewogICAgICAgICAgICAgICAgaG9tZTogbnVsbCwKICAgICAgICAgICAgICAgIGF3YXk6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZW50aXRpZXMgPSB7CiAgICAgICAgICAgICAgICBiYWxsOiBudWxsCiAgICAgICAgICAgIH07Cgp0aGlzLnVpID0gewogICAgICAgICAgICAgICAgc2NvcmVQbGF5ZXI6IG51bGwsCiAgICAgICAgICAgICAgICBzY29yZUNwdTogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWVyOiBudWxsLAogICAgICAgICAgICAgICAgaGFsZjogbnVsbCwKICAgICAgICAgICAgICAgIGFubm91bmNlbWVudDogbnVsbCwKICAgICAgICAgICAgICAgIC8vIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgICAgIHN0YXR1c1BhbmVsOiB7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyOiBudWxsLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBCYXI6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBUZXh0OiBudWxsLAogICAgICAgICAgICAgICAgICAgIGV4cEJhcjogbnVsbAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVGVjaGNvcHkgU3RhdGUKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHRpbWVyOiAwLAogICAgICAgICAgICAgICAgdGVjaDogbnVsbCwKICAgICAgICAgICAgICAgIGxlYXJuZXJzOiBbXQogICAgICAgICAgICB9OwoKdGhpcy5taW5pTWFwID0gbmV3IHdpbmRvdy5mbHV4Lk1pbmlNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgRmxvYXRpbmcgVGV4dAovLyBJbml0aWFsaXplIEZsb2F0aW5nIFRleHQKdGhpcy5mbG9hdGluZ1RleHQgPSBuZXcgd2luZG93LmZsdXguRmxvYXRpbmdUZXh0TWFuYWdlcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBVSSBjYWxjdWxhdGlvbnMKICAgICAgICAgICAgdGhpcy5fdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIFBhcnRpY2xlIE1hbmFnZXIgKFN0YXR1cyBFZmZlY3RzKQogICAgICAgICAgICAKLy8gSW5pdGlhbGl6ZSBQYXJ0aWNsZSBNYW5hZ2VyIChTdGF0dXMgRWZmZWN0cykKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyKHNjZW5lKTsKdGhpcy5nbHlwaE1hbmFnZXIgPSBudWxsOyAvLyBJbmplY3RlZCBieSBtYWluLmpzCnRoaXMuX2luaXRDaW5lbWF0aWNzKCk7CiAgICAgICAgICAgIHRoaXMuX2luaXRQYXJ0aWNsZXMoKTsgLy8gM0QgU3BhcmsgU3lzdGVtIChMZWdhY3kvSW1wYWN0KQoKdGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIgPSBuZXcgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyKHNjZW5lKTsKICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyKHRoaXMpOyAvLyBJbml0aWFsaXplIFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgdGhpcy5faW5qZWN0U3R5bGVzKCk7CnRoaXMuX2luaXRVSSgpOwogICAgICAgIH0KCl9pbml0Q2luZW1hdGljcygpIHsKICAgICAgICAgICAgLy8gTWVudSBCYWNrZ3JvdW5kIFNob3RzIChCLVJvbGwpCiAgICAgICAgICAgIHRoaXMubWVudVNob3RJbmRleCA9IDA7CiAgICAgICAgICAgIHRoaXMubWVudVNob3RUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubWVudVNob3RzID0gWwogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogMTAuMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNhbS5wb3NpdGlvbi5zZXQoNjAsIDM1LCA2MCkubGVycChuZXcgVEhSRUUuVmVjdG9yMyg0MCwgMjUsIDQwKSwgdCk7IGNhbS5sb29rQXQoMCwgMCwgMCk7IH0gfSwKICAgICAgICAgICAgICAgIHsgZHVyYXRpb246IDguMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNhbS5wb3NpdGlvbi5zZXQoLTI1LCA2LCAtMjUgKyA1MCp0KTsgY2FtLmxvb2tBdCgwLCAyLCAoLTI1ICsgNTAqdCkqMC44KTsgfSB9LAogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogOC4wLCB1cGRhdGU6ICh0LCBjYW0pID0+IHsgY29uc3QgYSA9IHQrMy41OyBjYW0ucG9zaXRpb24uc2V0KC0xMCtNYXRoLmNvcyhhKSoxMCwgNCwgLTEwK01hdGguc2luKGEpKjEwKTsgY2FtLmxvb2tBdCgtMTAsIDEuNSwgLTEwKTsgfSB9LAogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogNy4wLCB1cGRhdGU6ICh0LCBjYW0pID0+IHsgY2FtLnBvc2l0aW9uLnNldCgwLCAtNSwgMzIpLmxlcnAobmV3IFRIUkVFLlZlY3RvcjMoMCwgOCwgMjApLCB0KTsgY2FtLmxvb2tBdCgwLCAxNSwgNDUpOyBjYW0ucm90YXRpb24ueiA9ICh0LTAuNSkqMC4xNTsgfSB9LAogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogOC4wLCB1cGRhdGU6ICh0LCBjYW0pID0+IHsgY2FtLnBvc2l0aW9uLnNldCgwLCA1MCwgMCkubGVycChuZXcgVEhSRUUuVmVjdG9yMygwLCAxMCwgMCksIHQqdCooMy0yKnQpKTsgY2FtLmxvb2tBdCgwLCAwLCAwKTsgY2FtLnJvdGF0aW9uLnogPSB0KjAuODsgfSB9CiAgICAgICAgICAgIF07CgogICAgICAgICAgICAvLyBFcGljIEludHJvIFNlcXVlbmNlICgiSGVyY3VsZWFuIikKICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RzID0gWwogICAgICAgICAgICAgICAgLy8gMS4gIlRoZSBBd2FrZW5pbmciIC0gQ2xvc2Ugb24gU3BoZXJlIC0+IFpvb20gT3V0IFVwc2lkZSBEb3duIC0+IExpZ2h0cyAmIFJvYXIKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogOC4wLAogICAgICAgICAgICAgICAgICAgIG9uU3RhcnQ6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiVEhFIFNQSEVSRSBQT09MIiwgInNsYW0iKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc3RhZGl1bSkgdGhpcy5zdGFkaXVtLnJlc2V0TGlnaHRzKCk7IC8vIEVuc3VyZSBkYXJrIHN0YXJ0CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhc1JvYXJlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQW1iaWVudCBzdGFydCBzb3VuZCAoRGVlcCBodW0gLyBVbmRlcndhdGVyIGZlZWwpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdzd2ltJywgeyB2b2x1bWU6IDEuMCwgcmF0ZTogMC4zIH0pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVhc2luZwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlYXNlID0gdCA8IDAuNSA/IDIgKiB0ICogdCA6IC0xICsgKDQgLSAyICogdCkgKiB0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBleHBUID0gTWF0aC5wb3codCwgMy4wKTsgLy8gU3Ryb25nIGV4cG9uZW50aWFsIHpvb20gb3V0CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYW1lcmEgTW90aW9uOiBTdGFydCBJTlNJREUvQ0xPU0UgKDAsMCwyKSAtPiBFbmQgRkFSIEJBQ0svVVAgKDAsIDgwLCAxNjApCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMik7IAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlbmRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCA4MCwgMTYwKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMoc3RhcnRQb3MsIGVuZFBvcywgZXhwVCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBEeW5hbWljIFJvbGw6IFR1cm4gdXBzaWRlIGRvd24gKDAgLT4gUEkpCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5yb3RhdGlvbi56ID0gZWFzZSAqIE1hdGguUEk7IAoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTGlnaHQgU2VxdWVuY2luZyAmIFNvdW5kCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsID0gdGhpcy5zdGFkaXVtLmxpZ2h0Q291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsaWdodFByb2dyZXNzID0gTWF0aC5tYXgoMCwgKHQgLSAwLjIpIC8gMC42KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2ZUNvdW50ID0gTWF0aC5mbG9vcihsaWdodFByb2dyZXNzICogdG90YWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyICJSb2FyIHRvIExpZmUiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGlnaHRQcm9ncmVzcyA+IDAuNSAmJiAhdGhpcy5faGFzUm9hcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faGFzUm9hcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdnb2FsJywgeyB2b2x1bWU6IDEuMCwgcmF0ZTogMC43IH0pOyAvLyBEZWVwIHJvYXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAwLjgsIHJhdGU6IDAuNSB9KTsgLy8gV2hvb3NoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgxLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpIDwgdG90YWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpIDw9IGFjdGl2ZUNvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IHRoaXMuc3RhZGl1bS5saWdodFNwcml0ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcHJpdGUgJiYgIXNwcml0ZS52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YWRpdW0udHVybk9uTGlnaHQoaSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluZHVzdHJpYWwgTGlnaHQgU0ZYCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpdGNoID0gMC41ICsgKGkgLyB0b3RhbCkgKiAwLjU7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2ltcGFjdCcsIHsgdm9sdW1lOiAwLjQsIHJhdGU6IHBpdGNoLCB2YXJpYW5jZTogMC4wIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuMik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gMi4gIlRoZSBSb2FyIiAtIFN3ZWVwaW5nIGNyb3dkIHNob3QKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogNC4wLAogICAgICAgICAgICAgICAgICAgIG9uU3RhcnQ6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJMRUdFTkRBUlkgQVJFTkEiLCAibm9ybWFsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuY2FtZXJhTWFuYWdlcikgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDEuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdnb2FsJywgeyB2b2x1bWU6IDAuNyB9KTsgLy8gQ3Jvd2QgY2hlZXIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhc3BlY3QgPSB3aW5kb3cuaW5uZXJXaWR0aCAvIHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNQb3J0cmFpdCA9IGFzcGVjdCA8IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gLU1hdGguUEkvMiArICh0ICogTWF0aC5QSSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBpc1BvcnRyYWl0ID8gODUgOiA2NTsgLy8gUHVsbCBiYWNrIGluIHBvcnRyYWl0CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24uc2V0KE1hdGguY29zKGFuZ2xlKSpyLCAxNSwgTWF0aC5zaW4oYW5nbGUpKnIpOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KDAsIDUsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyAzLiAiSG9tZSBHbG9yeSIgLSBPcmJpdCBIb21lIFRlYW0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogMy41LAogICAgICAgICAgICAgICAgICAgIG9uU3RhcnQ6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJCRVNBSUQgQVVST0NIUyIsICJzbGFtIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnY2VsZWJyYXRlJywgMC4yKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJywgeyB2b2x1bWU6IDAuNSB9KTsgLy8gV2hvb3NoCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB1cGRhdGU6ICh0LCBjYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYXNwZWN0ID0gd2luZG93LmlubmVyV2lkdGggLyB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzUG9ydHJhaXQgPSBhc3BlY3QgPCAxLjA7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBPcmJpdCBIb21lIFRlYW0gKFNpZGUgMSwgLVopCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIC0yMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5QSSArICh0ICogMS41KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IGlzUG9ydHJhaXQgPyAyMCA6IDEyOyAvLyBQdWxsIGJhY2sgaWYgcG9ydHJhaXQKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnBvc2l0aW9uLnNldChjZW50ZXIueCArIE1hdGguY29zKGFuZ2xlKSpyLCA0LCBjZW50ZXIueiArIE1hdGguc2luKGFuZ2xlKSpyKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdChjZW50ZXIueCwgMiwgY2VudGVyLnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyA0LiAiRW5lbXkgR2F0ZXMiIC0gVHJhY2tpbmcgQXdheSBUZWFtCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDMuNSwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiTFVDQSBHT0VSUyIsICJzbGFtIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnaWRsZScsIDAuMikpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAwLjUgfSk7IC8vIFdob29zaAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1BvcnRyYWl0ID0gYXNwZWN0IDwgMS4wOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJhY2tpbmcgQXdheSBUZWFtIChTaWRlIC0xLCArWikKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSBuZXcgVEhSRUUuVmVjdG9yMygtMTUsIDIsIDI1KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gbmV3IFRIUkVFLlZlY3RvcjMoMTUsIDIsIDI1KTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1BvcnRyYWl0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydC54ICo9IDEuNTsgZW5kLnggKj0gMS41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQueiArPSAxMDsgZW5kLnogKz0gMTA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5wb3NpdGlvbi5sZXJwVmVjdG9ycyhzdGFydCwgZW5kLCB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdCgwLCAzLCAyNSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIDUuICJUaGUgU3BoZXJlIiAtIFpvb20gdG8gY2VudGVyCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDIuMCwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQkxJVFogT0ZGISIsICJzbGFtIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc3RhZGl1bSkgdGhpcy5zdGFkaXVtLnNldEFsbExpZ2h0cyh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3doaXN0bGUnLCB7IHZvbHVtZTogMC44IH0pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1BvcnRyYWl0ID0gYXNwZWN0IDwgMS4wOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcDEgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAzMCwgaXNQb3J0cmFpdCA/IDcwIDogNTApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwMiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDE0LCAyMik7IC8vIEdhbWVwbGF5IGNhbQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdCA9IHQgKiB0OwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCBzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBdOwogICAgICAgIH0KCiAgICAgICAgX2luamVjdFN0eWxlcygpIHsKICAgICAgICAgICAgaWYgKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmbHV4LWR5bmFtaWMtc3R5bGVzJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpOwogICAgICAgICAgICBzdHlsZS5pZCA9ICdmbHV4LWR5bmFtaWMtc3R5bGVzJzsKc3R5bGUudGV4dENvbnRlbnQgPSBgCiAgICAgICAgICAgICAgICBAa2V5ZnJhbWVzIHRleHRTbGFtIHsKICAgICAgICAgICAgICAgICAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDQpOyBvcGFjaXR5OiAwOyBsZXR0ZXItc3BhY2luZzogNTBweDsgfQogICAgICAgICAgICAgICAgICAgIDEwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyBvcGFjaXR5OiAxOyBsZXR0ZXItc3BhY2luZzogNXB4OyB9CiAgICAgICAgICAgICAgICAgICAgMTUlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4xKTsgfQogICAgICAgICAgICAgICAgICAgIDIwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyB9CiAgICAgICAgICAgICAgICAgICAgODAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IG9wYWNpdHk6IDE7IGZpbHRlcjogYmx1cigwcHgpOyB9CiAgICAgICAgICAgICAgICAgICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuNSk7IG9wYWNpdHk6IDA7IGZpbHRlcjogYmx1cigxMHB4KTsgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAuYW5ub3VuY2VtZW50LXNsYW0gewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgICAgICAgICB0b3A6IDQ1JTsgbGVmdDogNTAlOwogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiAxMDAlOwogICAgICAgICAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgICAgICAgICBmb250LWZhbWlseTogJ0ltcGFjdCcsIHNhbnMtc2VyaWY7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiA5NnB4OwogICAgICAgICAgICAgICAgICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmZmYgMCUsICNmZmRkMDAgNDUlLCAjZmY4ODAwIDEwMCUpOwogICAgICAgICAgICAgICAgICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgICAgICAgICAgICAgICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4IHJnYmEoMCwwLDAsMSkpIGRyb3Atc2hhZG93KDAgMCAzMHB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuNikpOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDIwMDA7CiAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uOiB0ZXh0U2xhbSAxLjhzIGN1YmljLWJlemllcigwLjEsIDAuOCwgMC4xLCAxKSBmb3J3YXJkczsKICAgICAgICAgICAgICAgICAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgICAgICAgICAgICAgICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC5tb2RhbC1vdmVybGF5IHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7IHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IGNlbnRlciwgcmdiYSgxMCwgMjUsIDYwLCAwLjk1KSAwJSwgcmdiYSgwLCAwLCAwLCAwLjk4KSAxMDAlKTsKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiBmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsgYWxpZ24taXRlbXM6IGNlbnRlcjsgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgICAgICAgICAgICAgICB6LWluZGV4OiAxOTAwOwogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IDA7IHBvaW50ZXItZXZlbnRzOiBub25lOyB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuOHM7CiAgICAgICAgICAgICAgICAgICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDhweCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAubW9kYWwtb3ZlcmxheS5hY3RpdmUgeyBvcGFjaXR5OiAxOyBwb2ludGVyLWV2ZW50czogYXV0bzsgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAubW9kYWwtdGl0bGUgewogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnR2FyYW1vbmQnLCBzZXJpZjsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDUycHg7IGNvbG9yOiAjZmZmOwogICAgICAgICAgICAgICAgICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICMwMGFhZmYsIDAgMCA0MHB4ICMwMDQ0YWE7CiAgICAgICAgICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMzBweDsKICAgICAgICAgICAgICAgICAgICBib3JkZXItYm90dG9tOiAycHggc29saWQgIzAwYWFmZjsKICAgICAgICAgICAgICAgICAgICBwYWRkaW5nLWJvdHRvbTogMTBweDsKICAgICAgICAgICAgICAgICAgICB3aWR0aDogODAlOyB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLm1vZGFsLXNjb3JlLWNvbnRhaW5lciB7CiAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgZ2FwOiA0MHB4OwogICAgICAgICAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDQwcHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAubW9kYWwtc2NvcmUgewogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnSW1wYWN0Jywgc2Fucy1zZXJpZjsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDgwcHg7IGNvbG9yOiAjZmZkNzAwOwogICAgICAgICAgICAgICAgICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICNiODg2MGI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAubW9kYWwtdnMgewogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiAyNHB4OyBjb2xvcjogIzAwYWFmZjsgb3BhY2l0eTogMC43OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC5mbGFzaC1vdmVybGF5IHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7IHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgICAgICAgICAgICAgICAgICB6LWluZGV4OiAyMTAwOwogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IDA7IHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC4xcyBlYXNlLW91dDsKICAgICAgICAgICAgICAgICAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBAa2V5ZnJhbWVzIGNsYXNoUG9wIHsKICAgICAgICAgICAgICAgICAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDAuNSk7IG9wYWNpdHk6IDE7IH0KICAgICAgICAgICAgICAgICAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjUpOyBvcGFjaXR5OiAwLjg7IH0KICAgICAgICAgICAgICAgICAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMi4wKTsgb3BhY2l0eTogMDsgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC5jbGFzaC1zcGFyayB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiA2MHB4OyBoZWlnaHQ6IDYwcHg7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgI2ZmZmZmZiAwJSwgI2ZmZmYwMCA0MCUsIHRyYW5zcGFyZW50IDcwJSk7CiAgICAgICAgICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICAgICAgICAgICAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDE1MDA7CiAgICAgICAgICAgICAgICAgICAgbWl4LWJsZW5kLW1vZGU6IHNjcmVlbjsKICAgICAgICAgICAgICAgICAgICBhbmltYXRpb246IGNsYXNoUG9wIDAuM3MgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICAgICAgICAgICAgICAgICAgYm94LXNoYWRvdzogMCAwIDIwcHggI2ZmYWEwMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKICAgICAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZSk7CiAgICAgICAgfQoKICAgICAgICByZWdpc3RlclRlYW1zKGhvbWVUZWFtLCBhd2F5VGVhbSwgYmFsbCkgewogICAgICAgICAgICB0aGlzLnRlYW1zLmhvbWUgPSBob21lVGVhbTsKICAgICAgICAgICAgdGhpcy50ZWFtcy5hd2F5ID0gYXdheVRlYW07CnRoaXMuZW50aXRpZXMuYmFsbCA9IGJhbGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsaXplIE1pbmlNYXAKICAgICAgICAgICAgaWYgKHRoaXMubWluaU1hcCkgewogICAgICAgICAgICAgICAgdGhpcy5taW5pTWFwLmluaXQoaG9tZVRlYW0sIGF3YXlUZWFtLCBiYWxsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9pbml0VUkoKSB7CiAgICAgICAgICAgIC8vIEJpbmQgdG8gZXhpc3RpbmcgSFRNTCBlbGVtZW50cwogICAgICAgICAgICB0aGlzLnVpLnNjb3JlUGxheWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Njb3JlLXBsYXllcicpOwogICAgICAgICAgICB0aGlzLnVpLnNjb3JlQ3B1ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Njb3JlLWNwdScpOwogICAgICAgICAgICB0aGlzLnVpLnRpbWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RpbWVyLWRpc3BsYXknKTsKICAgICAgICAgICAgdGhpcy51aS5oYWxmID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hhbGYtaW5kaWNhdG9yJyk7CiAgICAgICAgICAgIHRoaXMudWkuYW5ub3VuY2VtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Fubm91bmNlbWVudCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy51aS50ZWNoRmxhc2ggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGVjaC1mbGFzaC1vdmVybGF5Jyk7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoU3ViID0gdGhpcy51aS50ZWNoRmxhc2gucXVlcnlTZWxlY3RvcignLnRlY2gtc3ViLXRleHQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnVpLnRlY2hUaW1lckZpbGwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudGVjaC10aW1lci1maWxsJyk7CgogICAgICAgICAgICAvLyBCaW5kIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpOwogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLm5hbWUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAuY2hhci1uYW1lJyk7CiAgICAgICAgICAgIHRoaXMudWkuc3RhdHVzUGFuZWwuaHBCYXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAuaHAtYmFyLWZpbGwnKTsKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5ocFRleHQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAuaHAtdmFsdWUnKTsKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5leHBCYXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAudGVjaC1iYXItZmlsbCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5kIEdhbWUgTWVudSBCaW5kaW5ncwogICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLWdhbWUtbWVudScpOwogICAgICAgICAgICBjb25zdCBidG5SZW1hdGNoID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1idG4tcmVtYXRjaCcpOwogICAgICAgICAgICBjb25zdCBidG5FeGl0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1idG4tZXhpdCcpOwoKICAgICAgICAgICAgaWYgKGJ0blJlbWF0Y2gpIHsKICAgICAgICAgICAgICAgIGJ0blJlbWF0Y2guYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZUVuZE1lbnUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0TWF0Y2godGhpcy5nYW1lTW9kZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYnRuRXhpdCkgewogICAgICAgICAgICAgICAgYnRuRXhpdC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlRW5kTWVudSgpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ3JlYXRlIE1vZGFsIE92ZXJsYXkgKEZvciBIYWxmdGltZSBvbmx5IG5vdykKICAgICAgICAgICAgdGhpcy51aS5tb2RhbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTmFtZSA9ICdtb2RhbC1vdmVybGF5JzsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5pbm5lckhUTUwgPSBgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC10aXRsZSI+SEFMRiBUSU1FPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC1zY29yZS1jb250YWluZXIiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXNjb3JlIiBpZD0ibW9kYWwtc2NvcmUtaG9tZSI+MDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXZzIj4tPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtc2NvcmUiIGlkPSJtb2RhbC1zY29yZS1hd2F5Ij4wPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgaWQ9Im1vZGFsLW1zZyIgc3R5bGU9ImNvbG9yOiAjMDBhYWZmOyBmb250LXNpemU6IDE0cHg7IGxldHRlci1zcGFjaW5nOiAycHg7Ij5QUkVQQVJJTkcgMk5EIEhBTEYuLi48L2Rpdj4KICAgICAgICAgICAgYDsKICAgICAgICAgICAgdGhpcy51aUxheWVyLmFwcGVuZENoaWxkKHRoaXMudWkubW9kYWwpOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIEZsYXNoIE92ZXJsYXkKICAgICAgICAgICAgdGhpcy51aS5mbGFzaCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0aGlzLnVpLmZsYXNoLmNsYXNzTmFtZSA9ICdmbGFzaC1vdmVybGF5JzsKICAgICAgICAgICAgdGhpcy51aUxheWVyLmFwcGVuZENoaWxkKHRoaXMudWkuZmxhc2gpOwoKICAgICAgICAgICAgLy8gSW5pdGlhbCBTdGF0ZQogICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRpbWVyKSB0aGlzLnVpLnRpbWVyLmlubmVyVGV4dCA9ICIwMDowMCI7CiAgICAgICAgfQogICAgICAgIF91cGRhdGVTY29yZVVJKCkgewogICAgICAgICAgICBpZiAodGhpcy51aS5zY29yZVBsYXllcikgdGhpcy51aS5zY29yZVBsYXllci5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnNjb3JlQ3B1KSB0aGlzLnVpLnNjb3JlQ3B1LmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuYXdheTsKICAgICAgICB9Cgp1cGRhdGVQcmFjdGljZShkdCkgewogICAgICAgICAgICAvLyBEZWxlZ2F0ZSBsb2dpYyB0byBQcmFjdGljZU1hbmFnZXIKICAgICAgICAgICAgaWYgKHRoaXMucHJhY3RpY2VNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLnByYWN0aWNlTWFuYWdlci51cGRhdGUoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIC0tLSBQSFlTSUNTICYgTE9HSUMgVVBEQVRFIChGaXhlZCBUaW1lc3RlcCkgLS0tCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbnRybyAmIE1lbnUgYXJlIHB1cmVseSB2aXN1YWwgc3RhdGVzLCBoYW5kbGVkIGluIHVwZGF0ZVZpc3VhbHMKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdpbnRybycgfHwgdGhpcy5zdGF0ZSA9PT0gJ21lbnUnKSByZXR1cm47CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2JsaXR6X2NoYXJnZScpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUJsaXR6Q2hhcmdlKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2JsaXR6X2xhdW5jaCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUJsaXR6TGF1bmNoKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdhY3RpdmUnKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVUaW1lcigpOwogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tIYWxmVGltZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9jaGVja0dvYWxzKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVGVjaGNvcHkgTG9naWMgKFRpbWVyKQogICAgICAgICAgICBpZiAodGhpcy50ZWNoQ29weVN0YXRlLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLnRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmRUZWNoQ29weVdpbmRvdyhmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgLy8gLS0tIFZJU1VBTCBVUERBVEUgKE9uY2UgUGVyIEZyYW1lKSAtLS0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaW50cm8nKSB7CiAgICAgICAgICAgICAgICAvLyBQbGF5ZXIgV2FybXVwIEFuaW1hdGlvbnMKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUludHJvV2FybXVwKGR0KTsKCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaW50cm9TaG90cyB8fCB0aGlzLmludHJvU2hvdHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5za2lwSW50cm8oKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3Qgc2hvdCA9IHRoaXMuaW50cm9TaG90c1t0aGlzLmludHJvU2hvdEluZGV4XTsKICAgICAgICAgICAgICAgIHRoaXMuaW50cm9TaG90VGltZXIgKz0gZHQ7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuaW50cm9TaG90VGltZXIgPj0gc2hvdC5kdXJhdGlvbikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaW50cm9TaG90SW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmludHJvU2hvdFRpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnRyb1Nob3RJbmRleCA+PSB0aGlzLmludHJvU2hvdHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2tpcEludHJvKCk7IC8vIERvbmUKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5leHQgc2hvdCBzdGFydAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXh0U2hvdCA9IHRoaXMuaW50cm9TaG90c1t0aGlzLmludHJvU2hvdEluZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5leHRTaG90Lm9uU3RhcnQpIG5leHRTaG90Lm9uU3RhcnQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBjdXJyZW50IHNob3QKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gdGhpcy5pbnRyb1Nob3RUaW1lciAvIHNob3QuZHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhICYmIHNob3QudXBkYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3QudXBkYXRlKHQsIHRoaXMuY2FtZXJhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnbWVudScpIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBQT1BVTEFURSBBUkVOQSBGT1IgQi1ST0xMIC0tLQogICAgICAgICAgICAgICAgY29uc3QgYW5pbWF0ZVRlYW0gPSAodGVhbSkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICghdGVhbSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIHRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBHZW50bGUgYm9iYmluZyB0byBzaW11bGF0ZSB0cmVhZGluZyB3YXRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSBwLmhvbWVQb3NpdGlvbi55ICsgTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDAyICsgcC5tZXNoLmlkKSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBpZGxlIGFuaW1hdGlvbiBpcyBwbGF5aW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0ZSAhPT0gJ2lkbGUnKSBwLnBsYXkoJ2lkbGUnLCAwLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAubWl4ZXIpIHAubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGFuaW1hdGVUZWFtKHRoaXMudGVhbXMuaG9tZSk7CiAgICAgICAgICAgICAgICBhbmltYXRlVGVhbSh0aGlzLnRlYW1zLmF3YXkpOwoKICAgICAgICAgICAgICAgIC8vIC0tLSBDSU5FTUFUSUMgQi1ST0xMIC0tLQogICAgICAgICAgICAgICAgaWYgKHRoaXMubWVudVNob3RzICYmIHRoaXMubWVudVNob3RzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzaG90ID0gdGhpcy5tZW51U2hvdHNbdGhpcy5tZW51U2hvdEluZGV4XTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lbnVTaG90VGltZXIgKz0gZHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubWVudVNob3RUaW1lciA+PSBzaG90LmR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVudVNob3RUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVudVNob3RJbmRleCA9ICh0aGlzLm1lbnVTaG90SW5kZXggKyAxKSAlIHRoaXMubWVudVNob3RzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gTm9ybWFsaXplIHRpbWUgKDAgdG8gMSkKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gdGhpcy5tZW51U2hvdFRpbWVyIC8gc2hvdC5kdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvdC51cGRhdGUodCwgdGhpcy5jYW1lcmEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBbWJpZW50IEZYIGluIE1lbnUKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlciAmJiBNYXRoLnJhbmRvbSgpIDwgMC4yKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFuZ2UgPSA2MDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSpyYW5nZSwgCiAgICAgICAgICAgICAgICAgICAgICAgIC0xMCArIE1hdGgucmFuZG9tKCkqMjAsIAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKnJhbmdlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgcG9zLCB7IGxpZmU6IDMuMCArIE1hdGgucmFuZG9tKCkqMi4wLCBzY2FsZTogMC4zICsgTWF0aC5yYW5kb20oKSowLjQgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVXBkYXRlIEJhY2tncm91bmQgU3lzdGVtcwogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB0aGlzLnBhcnRpY2xlTWFuYWdlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgVGVjaGNvcHkgVUkKICAgICAgICAgICAgaWYgKHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUgJiYgdGhpcy51aS50ZWNoVGltZXJGaWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwY3QgPSBNYXRoLm1heCgwLCAodGhpcy50ZWNoQ29weVN0YXRlLnRpbWVyIC8gdGhpcy50ZWNoQ29weVN0YXRlLm1heFRpbWUpICogMTAwKTsKICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9IGAke3BjdH0lYDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ29sb3Igc2hpZnQgYmFzZWQgb24gdXJnZW5jeQogICAgICAgICAgICAgICAgaWYgKHBjdCA8IDMwKSB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICcjZmYwMDAwJzsKICAgICAgICAgICAgICAgIGVsc2UgdGhpcy51aS50ZWNoVGltZXJGaWxsLnN0eWxlLmJhY2tncm91bmQgPSAnbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjZmZmZmZmLCAjMDBmZmZmKSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEdlbmVyYWwgVmlzdWFscyAoQWx3YXlzIFJ1biBleGNlcHQgSW50cm8vTWVudSkKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdtZW51JyAmJiB0aGlzLnN0YXRlICE9PSAnaW50cm8nKSB7CiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgYmFuZCBwb3NzZXNzaW9uIGRpc3BsYXkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC51cGRhdGVCYW5kUG9zc2Vzc2lvbiAmJiB0aGlzLmVudGl0aWVzICYmIHRoaXMuZW50aXRpZXMuYmFsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaG9tZUhhc0JhbGwgPSBiYWxsLmhvbGRlciAmJiBiYWxsLmhvbGRlci50ZWFtICYmIGJhbGwuaG9sZGVyLnRlYW0uaXNIdW1hbjsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC51cGRhdGVCYW5kUG9zc2Vzc2lvbihob21lSGFzQmFsbCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMubWluaU1hcCkgdGhpcy5taW5pTWFwLnVwZGF0ZSgpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZmxvYXRpbmdUZXh0KSB0aGlzLmZsb2F0aW5nVGV4dC51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB0aGlzLnBhcnRpY2xlTWFuYWdlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFydGljbGVzKGR0KTsgLy8gTGVnYWN5IHNwYXJrcwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlR29hbFRyYW5zcGFyZW5jeSgpOyAvLyBEeW5hbWljIEdvYWwgRmFkaW5nCiAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIpIHRoaXMuZGVidWdWaXN1YWxpemVyLnVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlR29hbFRyYW5zcGFyZW5jeSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmNhbWVyYSkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZ29hbHMgPSBbd2luZG93LmZsdXguZ29hbEEsIHdpbmRvdy5mbHV4LmdvYWxCXTsKICAgICAgICAgICAgY29uc3QgZmFkZURpc3QgPSAzNS4wOyAvLyBEaXN0YW5jZSB0byBzdGFydCBmYWRpbmcKICAgICAgICAgICAgY29uc3QgbWluRmFkZURpc3QgPSAxNS4wOyAvLyBEaXN0YW5jZSB3aGVyZSBpdCdzIG1vc3QgdHJhbnNwYXJlbnQKICAgICAgICAgICAgY29uc3QgbWluT3BhY2l0eSA9IDAuMjsKCiAgICAgICAgICAgIGdvYWxzLmZvckVhY2goZ29hbCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWdvYWwpIHJldHVybjsKCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlzdGFuY2UgZnJvbSBjYW1lcmEgdG8gZ29hbCBwb3NpdGlvbgogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMuY2FtZXJhLnBvc2l0aW9uLmRpc3RhbmNlVG8oZ29hbC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBvcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCBmYWRlRGlzdCkgewogICAgICAgICAgICAgICAgICAgIC8vIExpbmVhciBmYWRlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IChkaXN0IC0gbWluRmFkZURpc3QpIC8gKGZhZGVEaXN0IC0gbWluRmFkZURpc3QpOwogICAgICAgICAgICAgICAgICAgIG9wYWNpdHkgPSBUSFJFRS5NYXRoVXRpbHMuY2xhbXAodCwgMC4wLCAxLjApICogKDEuMCAtIG1pbk9wYWNpdHkpICsgbWluT3BhY2l0eTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBpc1RyYW5zcGFyZW50ID0gb3BhY2l0eSA8IDAuOTk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdG8gYWxsIG1lc2hlcyBpbiBnb2FsIGhpZXJhcmNoeQogICAgICAgICAgICAgICAgZ29hbC50cmF2ZXJzZShjaGlsZCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLmlzTWVzaCAmJiBjaGlsZC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXQgPSBjaGlsZC5tYXRlcmlhbDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgdXBkYXRlIGlmIGNoYW5nZWQgdG8gbWluaW1pemUgb3ZlcmhlYWQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKG1hdC5vcGFjaXR5IC0gb3BhY2l0eSkgPiAwLjAxIHx8IG1hdC50cmFuc3BhcmVudCAhPT0gaXNUcmFuc3BhcmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Lm9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0LnRyYW5zcGFyZW50ID0gaXNUcmFuc3BhcmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIERpc2FibGUgZGVwdGhXcml0ZSB3aGVuIHRyYW5zcGFyZW50IHNvIHdlIGNhbiBzZWUgdGhlIGJhbGwgaW5zaWRlIHRoZSBuZXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdC5kZXB0aFdyaXRlID0gIWlzVHJhbnNwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXQubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwp9CiAgICAgICAgX3VwZGF0ZU9mZnNjcmVlbkluZGljYXRvcigpIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMudGVhbXMuaG9tZSA/IHRoaXMudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIgOiBudWxsOwogICAgICAgICAgICBjb25zdCBpbmRpY2F0b3IgPSB0aGlzLnVpLm9mZnNjcmVlbkluZGljYXRvcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghcCB8fCAhcC5tZXNoIHx8ICF0aGlzLmNhbWVyYSB8fCAhaW5kaWNhdG9yKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBHZXQgUGxheWVyIFBvc2l0aW9uIChDZW50ZXIgTWFzcykKICAgICAgICAgICAgY29uc3QgcG9zID0gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgIHBvcy55ICs9IDEuMDsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAyLiBQcm9qZWN0IHRvIE5vcm1hbGl6ZWQgRGV2aWNlIENvb3JkaW5hdGVzIChOREMpIFstMSwgMV0KICAgICAgICAgICAgdGhpcy5fdGVtcFZlYy5jb3B5KHBvcykucHJvamVjdCh0aGlzLmNhbWVyYSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBDaGVjayBpZiBCZWhpbmQgQ2FtZXJhCiAgICAgICAgICAgIGNvbnN0IGNhbUZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKGNhbUZ3ZCk7CiAgICAgICAgICAgIGNvbnN0IHRvUGxheWVyID0gcG9zLmNsb25lKCkuc3ViKHRoaXMuY2FtZXJhLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgY29uc3QgZG90ID0gY2FtRndkLmRvdCh0b1BsYXllcik7CiAgICAgICAgICAgIGNvbnN0IGlzQmVoaW5kID0gZG90IDwgMC4yOyAvLyBCdWZmZXIgdG8gcHJldmVudCBmbGlwcGluZyBhdCBlZGdlCgogICAgICAgICAgICAvLyA0LiBDaGVjayBCb3VuZHMKICAgICAgICAgICAgY29uc3QgaXNPZmZTY3JlZW4gPSAoCiAgICAgICAgICAgICAgICB0aGlzLl90ZW1wVmVjLnggPCAtMC45IHx8IHRoaXMuX3RlbXBWZWMueCA+IDAuOSB8fAogICAgICAgICAgICAgICAgdGhpcy5fdGVtcFZlYy55IDwgLTAuOSB8fCB0aGlzLl90ZW1wVmVjLnkgPiAwLjkgfHwKICAgICAgICAgICAgICAgIGlzQmVoaW5kCiAgICAgICAgICAgICk7CgogICAgICAgICAgICBpZiAoaXNPZmZTY3JlZW4pIHsKICAgICAgICAgICAgICAgIGluZGljYXRvci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHggPSB0aGlzLl90ZW1wVmVjLng7CiAgICAgICAgICAgICAgICBsZXQgeSA9IHRoaXMuX3RlbXBWZWMueTsKCiAgICAgICAgICAgICAgICAvLyBJZiBiZWhpbmQsIGludmVydCBjb29yZGluYXRlcyB0byBwb2ludCBjb3JyZWN0bHkKICAgICAgICAgICAgICAgIGlmIChpc0JlaGluZCkgewogICAgICAgICAgICAgICAgICAgIHggPSAteDsKICAgICAgICAgICAgICAgICAgICB5ID0gLXk7CiAgICAgICAgICAgICAgICAgICAgLy8gRml4IHNpbmd1bGFyaXR5IGlmIGV4YWN0bHkgYmVoaW5kIGNlbnRlcgogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyh4KSA8IDAuMDEgJiYgTWF0aC5hYnMoeSkgPCAwLjAxKSB5ID0gLTE7IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENsYW1wIHRvIHNjcmVlbiBlZGdlcwogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCB0byBmaW5kIHRoZSBpbnRlcnNlY3Rpb24gb2YgdGhlIHZlY3RvciAoeCx5KSB3aXRoIHRoZSBib3ggWy0wLjksIDAuOV0KICAgICAgICAgICAgICAgIGNvbnN0IHBhZGRpbmcgPSAwLjk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSB0byBnZXQgZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBjb25zdCBtYWcgPSBNYXRoLnNxcnQoeCp4ICsgeSp5KTsKICAgICAgICAgICAgICAgIGNvbnN0IG54ID0geCAvIG1hZzsKICAgICAgICAgICAgICAgIGNvbnN0IG55ID0geSAvIG1hZzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmF5Y2FzdCB0byBib3ggZWRnZXMKICAgICAgICAgICAgICAgIC8vIFZlcnRpY2FsIGVkZ2VzOiB4ID0gKy8tIHBhZGRpbmcKICAgICAgICAgICAgICAgIC8vIEhvcml6b250YWwgZWRnZXM6IHkgPSArLy0gcGFkZGluZwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBdm9pZCBkaXZpZGUgYnkgemVybwogICAgICAgICAgICAgICAgY29uc3QgdHggPSAoTWF0aC5hYnMobngpID4gMC4wMDEpID8gKG54ID4gMCA/IHBhZGRpbmcgOiAtcGFkZGluZykgLyBueCA6IDk5OTsKICAgICAgICAgICAgICAgIGNvbnN0IHR5ID0gKE1hdGguYWJzKG55KSA+IDAuMDAxKSA/IChueSA+IDAgPyBwYWRkaW5nIDogLXBhZGRpbmcpIC8gbnkgOiA5OTk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFVzZSB0aGUgbmVhcmVzdCBpbnRlcnNlY3Rpb24gKHNtYWxsZXN0IHBvc2l0aXZlIHQpCiAgICAgICAgICAgICAgICAvLyBTaW5jZSB3ZSBhcmUgcHJvamVjdGluZyBmcm9tIGNlbnRlciAoMCwwKSB0byAobngsbnkpLCB0IG11c3QgYmUgcG9zaXRpdmUuCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gTWF0aC5taW4oTWF0aC5hYnModHgpLCBNYXRoLmFicyh0eSkpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBzY3JlZW5YID0gbnggKiB0OwogICAgICAgICAgICAgICAgY29uc3Qgc2NyZWVuWSA9IG55ICogdDsKCiAgICAgICAgICAgICAgICAvLyBDb252ZXJ0IE5EQyB0byBQaXhlbHMKICAgICAgICAgICAgICAgIGNvbnN0IHdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBoZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHB4ID0gKHNjcmVlblggKiAwLjUgKyAwLjUpICogd2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBweSA9ICgtKHNjcmVlblkpICogMC41ICsgMC41KSAqIGhlaWdodDsKCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgUm90YXRpb24KICAgICAgICAgICAgICAgIC8vIEFycm93IHBvaW50cyBVUCBieSBkZWZhdWx0LgogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCBpdCB0byBwb2ludCBpbiBkaXJlY3Rpb24gKG54LCBueSkgb24gc2NyZWVuLgogICAgICAgICAgICAgICAgLy8gU2NyZWVuIFkgaXMgZG93biAoaW52ZXJ0ZWQgZnJvbSBXZWJHTCBZKS4KICAgICAgICAgICAgICAgIC8vIFNvICgwLCAxKSBpbiBOREMgaXMgVVAuICgwLCAtMSkgaW4gTkRDIGlzIERPV04uCiAgICAgICAgICAgICAgICAvLyBhdGFuMih5LCB4KSBnaXZlcyBhbmdsZSBmcm9tICtYLgogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCBhbmdsZSBmcm9tICtZIChVcCkuCiAgICAgICAgICAgICAgICAvLyBSb3RhdGlvbiA9IFBJLzIgLSBhbmdsZS4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKG55LCBueCk7CiAgICAgICAgICAgICAgICBjb25zdCByb3QgPSAoTWF0aC5QSSAvIDIpIC0gYW5nbGU7CgogICAgICAgICAgICAgICAgaW5kaWNhdG9yLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHtweH1weCwgJHtweX1weCkgcm90YXRlKCR7cm90fXJhZClgOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgaW5kaWNhdG9yLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVUaW1lcigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnVpLnRpbWVyKSByZXR1cm47CiAgICAgICAgICAgIC8vIENsYW1wIHRvIGhhbGYgZHVyYXRpb24gZm9yIGRpc3BsYXkgaWYgd2UgZ28gc2xpZ2h0bHkgb3ZlciBiZWZvcmUgdGljawogICAgICAgICAgICBjb25zdCB0ID0gTWF0aC5taW4odGhpcy50aW1lLCB0aGlzLmhhbGZEdXJhdGlvbik7CiAgICAgICAgICAgIGNvbnN0IG1pbnV0ZXMgPSBNYXRoLmZsb29yKHQgLyA2MCk7CiAgICAgICAgICAgIGNvbnN0IHNlY29uZHMgPSBNYXRoLmZsb29yKHQgJSA2MCk7CiAgICAgICAgICAgIHRoaXMudWkudGltZXIuaW5uZXJUZXh0ID0gYCR7bWludXRlcy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9OiR7c2Vjb25kcy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9YDsKICAgICAgICB9CiAgICAgICAgX2NoZWNrSGFsZlRpbWUoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnRpbWUgPj0gdGhpcy5oYWxmRHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5kSGFsZigpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKZW5kSGFsZigpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdoYWxmdGltZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdG9wIGFsbCBwbGF5ZXJzCiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFsZiA9PT0gMSkgewogICAgICAgICAgICAgICAgdGhpcy5fc2hvd01vZGFsKCJIQUxGIFRJTUUiLCAiUFJFUEFSSU5HIDJORCBIQUxGLi4uIik7CiAgICAgICAgICAgICAgICAKLy8gT3B0aW9uYWw6IFBsYXkgd2hpc3RsZSBzb3VuZCBoZXJlIGlmIGF2YWlsYWJsZQogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCd3aGlzdGxlJyk7CgogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZU1vZGFsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydFNlY29uZEhhbGYoKTsKICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRW5kIG9mIDJuZCBIYWxmIG9yIE92ZXJ0aW1lIFBlcmlvZAogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuaG9tZSA9PT0gdGhpcy5zY29yZS5hd2F5KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVElFRCAtIEdvIHRvIE92ZXJ0aW1lIChHb2xkZW4gR29hbCkKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93TW9kYWwoIk9WRVJUSU1FIiwgIkdPTERFTiBHT0FMIFJVTEUgQUNUSVZFIik7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVNb2RhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0T3ZlcnRpbWUoKTsKICAgICAgICAgICAgICAgICAgICB9LCA0MDAwKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV2lubmVyIGRlY2lkZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3RhcnRTZWNvbmRIYWxmKCkgewogICAgICAgICAgICB0aGlzLmhhbGYgPSAyOwogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYuaW5uZXJUZXh0ID0gIjJuZCBIQUxGIjsKICAgICAgICAgICAgdGhpcy5yZXNldFJvdW5kKG51bGwpOyAvLyBOZXV0cmFsIEJsaXR6LW9mZiBmb3IgMm5kIGhhbGYgc3RhcnQKICAgICAgICB9CgogICAgICAgIHN0YXJ0T3ZlcnRpbWUoKSB7CiAgICAgICAgICAgIHRoaXMuaGFsZisrOwogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmlzT3ZlcnRpbWUgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYuaW5uZXJUZXh0ID0gIk9WRVJUSU1FIjsKICAgICAgICAgICAgdGhpcy5yZXNldFJvdW5kKG51bGwpOyAvLyBOZXV0cmFsIEJsaXR6LW9mZgogICAgICAgIH0KCmVuZEdhbWUoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZ2FtZW92ZXInOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcCBwbGF5ZXJzCiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwoKICAgICAgICAgICAgbGV0IG1zZyA9ICJEUkFXIjsKICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuaG9tZSA+IHRoaXMuc2NvcmUuYXdheSkgbXNnID0gIlZJQ1RPUlkiOwogICAgICAgICAgICBpZiAodGhpcy5zY29yZS5hd2F5ID4gdGhpcy5zY29yZS5ob21lKSBtc2cgPSAiREVGRUFUIjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBvcHVsYXRlIEVuZCBHYW1lIE1lbnUKICAgICAgICAgICAgaWYgKHRoaXMudWkuZW5kTWVudSkgewogICAgICAgICAgICAgICAgY29uc3QgdGl0bGVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtcmVzdWx0LXRpdGxlJyk7CiAgICAgICAgICAgICAgICBjb25zdCBob21lU2NvcmVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtc2NvcmUtaG9tZScpOwogICAgICAgICAgICAgICAgY29uc3QgYXdheVNjb3JlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLXNjb3JlLWF3YXknKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRpdGxlRWwpIHsKICAgICAgICAgICAgICAgICAgICB0aXRsZUVsLmlubmVyVGV4dCA9IG1zZzsKICAgICAgICAgICAgICAgICAgICB0aXRsZUVsLnN0eWxlLmNvbG9yID0gKG1zZyA9PT0gIlZJQ1RPUlkiKSA/ICIjMDBmZmZmIiA6ICgobXNnID09PSAiREVGRUFUIikgPyAiI2ZmNDQ0NCIgOiAiI2ZmZmZmZiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGhvbWVTY29yZUVsKSBob21lU2NvcmVFbC5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgICAgICBpZiAoYXdheVNjb3JlRWwpIGF3YXlTY29yZUVsLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuYXdheTsKCiAgICAgICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1lbnVNb2RlKHRydWUpOyAvLyBIaWRlIEhVRAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdG9wIE11c2ljIG9uIEdhbWUgT3ZlcgogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnN0b3BCR00oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVFbmRNZW51KCkgewogICAgICAgICAgICBpZiAodGhpcy51aS5lbmRNZW51KSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1lbnVNb2RlKGZhbHNlKTsgLy8gU2hvdyBIVUQKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3Nob3dNb2RhbCh0aXRsZSwgc3VidGV4dCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkubW9kYWwpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignLm1vZGFsLXRpdGxlJykuaW5uZXJUZXh0ID0gdGl0bGU7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLXNjb3JlLWhvbWUnKS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLXNjb3JlLWF3YXknKS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmF3YXk7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLW1zZycpLmlubmVyVGV4dCA9IHN1YnRleHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBIVUQgZWxlbWVudHMKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKS5zdHlsZS5vcGFjaXR5ID0gJzAnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpLnN0eWxlLm9wYWNpdHkgPSAnMCc7CiAgICAgICAgfQoKICAgICAgICBfaGlkZU1vZGFsKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkubW9kYWwpIHJldHVybjsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNob3cgSFVEIGVsZW1lbnRzCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJykuc3R5bGUub3BhY2l0eSA9ICcxJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKS5zdHlsZS5vcGFjaXR5ID0gJzEnOwogICAgICAgIH0KCl9jaGVja0dvYWxzKCkgewogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoIWJhbGwgfHwgIWJhbGwubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgcG9zID0gYmFsbC5tZXNoLnBvc2l0aW9uOwoKICAgICAgICAgICAgLy8gUHJlY2lzZSBHb2FsIERldGVjdGlvbgogICAgICAgICAgICAvLyBWaXN1YWwgR29hbCBpcyBhdCBaID0gKy8tIDI4LgogICAgICAgICAgICAvLyBXZSBkZWZpbmUgYSAiR29hbCBNb3V0aCIgYm94IG1hdGNoaW5nIEdvYWxpZS5qcyAoV2lkdGggMTQsIEhlaWdodCA4KS4KLy8gV2UgZGVmaW5lIGEgIkdvYWwgTW91dGgiIGJveCBtYXRjaGluZyB0aGUgdmlzdWFsIG5ldC4KICAgICAgICAgICAgLy8gQXJlbmEgUmFkaXVzIGlzIDMyLiBHb2FsIGlzIHJvdWdobHkgMjJtIHdpZGUsIDE4bSBoaWdoLgovLyBBcmVuYSBSYWRpdXMgaXMgMzIuIEdvYWwgaXMgcm91Z2hseSAyMm0gd2lkZSwgMThtIGhpZ2guCiAgICAgICAgICAgIGNvbnN0IGhhbGZXaWR0aCA9IDExLjA7IC8vIEluY3JlYXNlZCB0byAxMSAoV2lkdGggMjIpIHRvIGNhdGNoIGNvcm5lcnMKICAgICAgICAgICAgY29uc3QgaGFsZkhlaWdodCA9IDkuMDsgLy8gSW5jcmVhc2VkIHRvIDkgKEhlaWdodCAxOCkgdG8gY2F0Y2ggaGlnaCBzaG90cwpjb25zdCBnb2FsWU9mZnNldCA9IC02LjA7IC8vIE1vdmVkIGRvd24gdG8gbWF0Y2ggdmlzdWFsIG1vZGVsICgtNi4wbSkKCmNvbnN0IHRyaWdnZXJaID0gNDAuNTsgLy8gVHJpZ2dlciBlYXJsaWVyICh3YXMgNDMuNSkgdG8gZW5zdXJlIHJlZ2lzdHJhdGlvbiBiZWZvcmUgYm91bmNlCgogICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnopID4gdHJpZ2dlclopIHsKICAgICAgICAgICAgICAgIC8vIFBSRVZFTlQgT1dOIEdPQUwgQlkgQ0FSUklFUiAoVXNlciBSZXF1ZXN0KQogICAgICAgICAgICAgICAgLy8gSWYgdGhlIGJhbGwgaXMgaGVsZCBieSB0aGUgdGVhbSBkZWZlbmRpbmcgdGhpcyBnb2FsLCBkbyBub3QgY291bnQgaXQuCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIb21lIChTaWRlIDEpIGRlZmVuZHMgK1ouIElmIHBvcy56ID4gMCAoSG9tZSBHb2FsKSBhbmQgaG9sZGVyIGlzIEhvbWUsIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPiAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gMSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIC8vIEF3YXkgKFNpZGUgLTEpIGRlZmVuZHMgLVouIElmIHBvcy56IDwgMCAoQXdheSBHb2FsKSBhbmQgaG9sZGVyIGlzIEF3YXksIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gLTEpIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyLiBDaGVjayBGcmFtZSAoTXVzdCBiZSB3aXRoaW4gd2lkdGgvaGVpZ2h0KQovLyAyLiBDaGVjayBGcmFtZSAoTXVzdCBiZSB3aXRoaW4gd2lkdGgvaGVpZ2h0LCBhY2NvdW50aW5nIGZvciBZIG9mZnNldCkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueCkgPD0gaGFsZldpZHRoICYmIE1hdGguYWJzKHBvcy55IC0gZ29hbFlPZmZzZXQpIDw9IGhhbGZIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ29hbFNjb3JlZCgnaG9tZScpOyAvLyBIb21lIGF0dGFja3MgLVoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdvYWxTY29yZWQoJ2F3YXknKTsgLy8gQXdheSBhdHRhY2tzICtaCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKZ29hbFNjb3JlZChzY29yZXIpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJTVBBQ1QgRlJBTUU6IEdPQUwKICAgICAgICAgICAgdGhpcy50cmlnZ2VySW1wYWN0KDAuNCwgJ3NoYXR0ZXInKTsgLy8gTWFzc2l2ZSBmcmVlemUgZm9yIGdvYWwKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVYUCBSRVdBUkQ6IEdvYWwKICAgICAgICAgICAgLy8gRmluZCB3aG8gc2NvcmVkIChMYXN0IGhvbGRlciBvZiBiYWxsKQogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLmxhc3RIb2xkZXIgJiYgYmFsbC5sYXN0SG9sZGVyLnRlYW0uaWQgPT09IHNjb3JlcikgewogICAgICAgICAgICAgICAgYmFsbC5sYXN0SG9sZGVyLmdhaW5FeHAoMTApOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2dvYWwnOwogICAgICAgICAgICB0aGlzLnNjb3JlW3Njb3Jlcl0rKzsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMS4gVklTQ0VSQUwgU0hBS0UgJiBQQVJUSUNMRVMKICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDIuMCk7IC8vIEhlYXZ5IHNoYWtlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIHRoaXMuZW50aXRpZXMuYmFsbCAmJiB0aGlzLmVudGl0aWVzLmJhbGwubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgZ29hbFBvcyA9IHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAvLyBNYXNzaXZlIEdvYWwgRXhwbG9zaW9uCiAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgZ29hbFBvcywgeyBzY2FsZTogMTUuMCwgbGlmZTogMC44IH0pOwogICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgZ29hbFBvcywgeyBzY2FsZTogMTAuMCB9KTsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDMwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGVicmlzJywgZ29hbFBvcywgeyBzY2FsZTogMC44IH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIDIuIFNDUkVFTiBGTEFTSAogICAgICAgICAgICBpZiAodGhpcy51aS5mbGFzaCkgewogICAgICAgICAgICAgICAgdGhpcy51aS5mbGFzaC5zdHlsZS5vcGFjaXR5ID0gJzAuOCc7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy51aS5mbGFzaC5zdHlsZS5vcGFjaXR5ID0gJzAnOyB9LCAxMDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBHT0xERU4gR09BTCBDSEVDSwogICAgICAgICAgICBpZiAodGhpcy5pc092ZXJ0aW1lKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkdPTERFTiBHT0FMISIsICdzbGFtJyk7CiAgICAgICAgICAgICAgICAvLyBFbmQgZ2FtZSBhZnRlciBzaG9ydCBkZWxheQogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmRHYW1lKCk7CiAgICAgICAgICAgICAgICB9LCAzMDAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNC4gU0xBTSBBTk5PVU5DRU1FTlQgKE5vcm1hbCkKLy8gNC4gU0xBTSBBTk5PVU5DRU1FTlQgKE5vcm1hbCkKICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJHT0FMISIsICdzbGFtJyk7CiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZ29hbCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgc2VxdWVuY2UKICAgICAgICAgICAgLy8gU2NvcmVkLXVwb24gdGVhbSBnZXRzIGJhbGwKICAgICAgICAgICAgY29uc3QgbG9zZXIgPSBzY29yZXIgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZBU1RFUiBGTE9XOiBSZWR1Y2VkIGRlbGF5IGZyb20gMzAwMG1zIHRvIDEyMDBtcwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChsb3Nlcik7CiAgICAgICAgICAgIH0sIDIwMDApOyAvLyBTbGlnaHRseSBsb25nZXIgdG8gYXBwcmVjaWF0ZSB0aGUgIkdPQUwiIHNsYW0KICAgICAgICB9CgpzaG93QW5ub3VuY2VtZW50KHRleHQsIHR5cGUgPSAnbm9ybWFsJywgZHVyYXRpb24gPSAyMDAwKSB7CiAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5hbm5vdW5jZW1lbnQ7CiAgICAgICAgICAgIGlmICghZWwpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENsZWFyIHByZXZpb3VzIHRpbWVvdXQKICAgICAgICAgICAgaWYgKHRoaXMuX2Fubm91bmNlVGltZW91dCkgewogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX2Fubm91bmNlVGltZW91dCk7CiAgICAgICAgICAgICAgICB0aGlzLl9hbm5vdW5jZVRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBBbmltYXRpb24gYnkgY2xvbmluZwogICAgICAgICAgICBjb25zdCBuZXdFbCA9IGVsLmNsb25lTm9kZSh0cnVlKTsKICAgICAgICAgICAgZWwucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQobmV3RWwsIGVsKTsKICAgICAgICAgICAgdGhpcy51aS5hbm5vdW5jZW1lbnQgPSBuZXdFbDsKCiAgICAgICAgICAgIG5ld0VsLmlubmVyVGV4dCA9IHRleHQ7CiAgICAgICAgICAgIG5ld0VsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgQ2xhc3MgYmFzZWQgb24gdHlwZQogICAgICAgICAgICBuZXdFbC5jbGFzc05hbWUgPSAnJzsgLy8gUmVzZXQgY2xhc3NlcwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3NsYW0nKSB7CiAgICAgICAgICAgICAgICBuZXdFbC5jbGFzc0xpc3QuYWRkKCdhbm5vdW5jZW1lbnQtc2xhbScpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRGVmYXVsdCBzdHlsZQogICAgICAgICAgICAgICAgbmV3RWwuc3R5bGUuYW5pbWF0aW9uID0gJ25vbmUnOwogICAgICAgICAgICAgICAgbmV3RWwub2Zmc2V0SGVpZ2h0OyAvKiB0cmlnZ2VyIHJlZmxvdyAqLwogICAgICAgICAgICAgICAgbmV3RWwuc3R5bGUuYW5pbWF0aW9uID0gJ2Fubm91bmNlU2xpZGUgMC41cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSknOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBdXRvLWhpZGUKICAgICAgICAgICAgaWYgKGR1cmF0aW9uID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fYW5ub3VuY2VUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlQW5ub3VuY2VtZW50KCk7CiAgICAgICAgICAgICAgICB9LCBkdXJhdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGhpZGVBbm5vdW5jZW1lbnQoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLmFubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgdGhpcy51aS5hbm5vdW5jZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCnJlc2V0Um91bmQocG9zc2Vzc2lvblRlYW1JZCkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ3Jlc2V0JzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENsZWFyIHBlcnNpc3RlbnQgdmlzdWFscwogICAgICAgICAgICBpZiAodGhpcy5nbHlwaE1hbmFnZXIpIHRoaXMuZ2x5cGhNYW5hZ2VyLmNsZWFyKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gT3B0aW9uYWw6IENsZWFyIHBhcnRpY2xlcyBpZiBuZWVkZWQsIHRob3VnaCB0aGV5IHNlbGYtZXhwaXJlIHF1aWNrbHkKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgQmFsbAogICAgICAgICAgICBpZiAodGhpcy5lbnRpdGllcy5iYWxsKSB0aGlzLmVudGl0aWVzLmJhbGwucmVzZXQoKTsKICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCkgdGhpcy5lbnRpdGllcy5iYWxsLnJlc2V0KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCBUZWFtcwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBiYWxsIGhvbGRlcgogICAgICAgICAgICBpZiAodGhpcy5lbnRpdGllcy5iYWxsKSB0aGlzLmVudGl0aWVzLmJhbGwuZHJvcCgpOwoKICAgICAgICAgICAgLy8gQ1JJVElDQUw6IFNuYXAgY2FtZXJhIHRvIHByZXZlbnQgZGlzb3JpZW50YXRpb24KICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gRm9yY2UgdXBkYXRlIHRhcmdldCBmaXJzdCAodXN1YWxseSBiYWxsKQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCAmJiB0aGlzLmVudGl0aWVzLmJhbGwubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQodGhpcy5lbnRpdGllcy5iYWxsLm1lc2gsIHRoaXMuZW50aXRpZXMuYmFsbC52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGQVNURVIgRkxPVzogUmVkdWNlZCBkZWxheSBmcm9tIDIwMDBtcyB0byAxMDBtcwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRLaWNrb2ZmKHBvc3Nlc3Npb25UZWFtSWQpOwp9LCAxMDApOwogICAgICAgIH0KCnN0YXJ0S2lja29mZihwb3NzZXNzaW9uVGVhbUlkKSB7CiAgICAgICAgICAgIC8vIFN0b3AgYWxsIHBsYXllcnMgaW1tZWRpYXRlbHkKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5hd2F5KSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gcC5zZXRJbnB1dCgwLCAwKSk7CgogICAgICAgICAgICAvLyBJZiBhIHRlYW0gaGFzIHBvc3Nlc3Npb24gKGFmdGVyIGdvYWwpLCBzdGFuZGFyZCBraWNrb2ZmCiAgICAgICAgICAgIGlmIChwb3NzZXNzaW9uVGVhbUlkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2tpY2tvZmYnOwogICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJCTElUWiBPRkYhIiwgJ3NsYW0nKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnd2hpc3RsZScpOwoKICAgICAgICAgICAgICAgIGNvbnN0IHRlYW0gPSB0aGlzLnRlYW1zW3Bvc3Nlc3Npb25UZWFtSWRdOwogICAgICAgICAgICAgICAgaWYgKHRlYW0pIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtZiA9IHRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgICAgICAgICBpZiAobWYgJiYgdGhpcy5lbnRpdGllcy5iYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW50aXRpZXMuYmFsbC5ncmFiKG1mKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNuYXAgY2FtZXJhIHRvIG5ldyBob2xkZXIKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldChtZi5tZXNoLCBtZi52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnYWN0aXZlJzsKICAgICAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBORVVUUkFMIEtJQ0tPRkY6ICJUaGUgQmxpdHogT2ZmIiBDaW5lbWF0aWMgU2VxdWVuY2UKICAgICAgICAgICAgICAgIHRoaXMuX3N0YXJ0TmV1dHJhbEJsaXR6T2ZmKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpfc3RhcnROZXV0cmFsQmxpdHpPZmYoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnYmxpdHpfY2hhcmdlJzsKICAgICAgICAgICAgdGhpcy5ibGl0elRpbWVyID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDEuIFJlc2V0IEJhbGwgdG8gQ2VudGVyIChEZWVwKQogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGJhbGwuZHJvcCgpOwogICAgICAgICAgICAgICAgYmFsbC5tZXNoLnBvc2l0aW9uLnNldCgwLCAtNSwgMCk7IC8vIFN0YXJ0IERFRVAgKC01bSkgZm9yICJncm91bmQgdXAiIHJpc2UKICAgICAgICAgICAgICAgIGJhbGwudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgYmFsbC5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgLy8gUmVzZXQgdmlzdWFscwogICAgICAgICAgICAgICAgaWYgKGJhbGwuZGVmb3JtTm9kZSkgYmFsbC5kZWZvcm1Ob2RlLnNjYWxlLnNldCgxLCAxLCAxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gUG9zaXRpb24gQ2FwdGFpbnMgKE1GcykKICAgICAgICAgICAgY29uc3QgaG9tZU1GID0gdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIGNvbnN0IGF3YXlNRiA9IHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwoKICAgICAgICAgICAgaWYgKGhvbWVNRiAmJiBob21lTUYubWVzaCkgewogICAgICAgICAgICAgICAgaG9tZU1GLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDgpOyAvLyA4bSBiYWNrCiAgICAgICAgICAgICAgICBob21lTUYubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBob21lTUYucGxheSgnaWRsZScsIDAuMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGF3YXlNRiAmJiBhd2F5TUYubWVzaCkgewogICAgICAgICAgICAgICAgYXdheU1GLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC04KTsgLy8gOG0gYmFjawogICAgICAgICAgICAgICAgYXdheU1GLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgYXdheU1GLnBsYXkoJ2lkbGUnLCAwLjEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBDYW1lcmEgRm9jdXMKICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlciAmJiBiYWxsICYmIGJhbGwubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldChiYWxsLm1lc2gsIG51bGwpOwogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICAgICAgLy8gWm9vbSBpbiB0aWdodAogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLmN1cnJlbnRQdWxsQmFjayA9IC0xMjsgCiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIubWFudWFsT3JiaXRQaXRjaCA9IDAuNDsgLy8gTG9vayBkb3duIHN0ZWVwCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJ1aWxkIFRlbnNpb24KICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJSRUFEWS4uLiIsICdub3JtYWwnKTsKICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdzd2ltJywgeyB2b2x1bWU6IDAuNSB9KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVCbGl0ekNoYXJnZShkdCkgewogICAgICAgICAgICB0aGlzLmJsaXR6VGltZXIgKz0gZHQ7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBjaGFyZ2VEdXJhdGlvbiA9IDIuMDsgLy8gTG9uZ2VyIGJ1aWxkIHVwIGZvciBjaW5lbWF0aWMgZmVlbAoKICAgICAgICAgICAgLy8gUEhBU0UgMTogQ0hBUkdFIChSaXNpbmcgZnJvbSBkZXB0aHMpCiAgICAgICAgICAgIGlmICh0aGlzLmJsaXR6VGltZXIgPCBjaGFyZ2VEdXJhdGlvbikgewogICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMuYmxpdHpUaW1lciAvIGNoYXJnZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgZWFzZVQgPSB0ICogdDsgLy8gUXVhZHJhdGljIGVhc2UgaW4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmlzZSBmcm9tIC01IHRvIDAgKEdyb3VuZCB1cCBlZmZlY3QpCiAgICAgICAgICAgICAgICBiYWxsLm1lc2gucG9zaXRpb24ueSA9IC01LjAgKyAoNS4wICogZWFzZVQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTcGluIHVwIChFeHBvbmVudGlhbCkKICAgICAgICAgICAgICAgIGJhbGwubWVzaC5yb3RhdGlvbi55ICs9ICgxMC4wICsgNTAuMCAqIHQpICogZHQ7CiAgICAgICAgICAgICAgICBiYWxsLm1lc2gucm90YXRpb24ueCArPSAoNS4wICsgMjAuMCAqIHQpICogZHQ7CgogICAgICAgICAgICAgICAgLy8gU3F1YXNoIChGbGF0dGVuIGxpa2UgYSBkaXNjIGJ1aWxkaW5nIGVuZXJneSkKICAgICAgICAgICAgICAgIGlmIChiYWxsLmRlZm9ybU5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBFeHRyZW1lIHNxdWFzaCBhdCB0aGUgZW5kCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3F1YXNoID0gMS4wIC0gKDAuNyAqIGVhc2VUKTsgLy8gRmxhdHRlbiBZIHRvIDAuMwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0cmV0Y2ggPSAxLjAgKyAoMC41ICogZWFzZVQpOyAvLyBFeHBhbmQgWFoKICAgICAgICAgICAgICAgICAgICBiYWxsLmRlZm9ybU5vZGUuc2NhbGUuc2V0KHN0cmV0Y2gsIHNxdWFzaCwgc3RyZXRjaCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2FtZXJhIFNoYWtlIGluY3JlYXNpbmcKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjIgKiB0KTsKCiAgICAgICAgICAgICAgICAvLyBQYXJ0aWNsZXM6IFJpc2luZyBFbmVyZ3kgZnJvbSBncm91bmQKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIC8vIEJ1YmJsZXMgcmlzaW5nIGZhc3QKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb3VudCA9IE1hdGguZmxvb3IodCAqIDgpICsgMTsKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByID0gMi4wICogKDEuMCAtIHQpOyAvLyBSYWRpdXMgc2hyaW5rcyBhcyBpdCBnZXRzIGNsb3NlciB0byBsYXVuY2gKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeCA9IE1hdGguY29zKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHogPSBNYXRoLnNpbihhbmdsZSkgKiByOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB5ID0gYmFsbC5tZXNoLnBvc2l0aW9uLnkgLSAxLjA7IC8vIEJlbG93IGJhbGwKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBuZXcgVEhSRUUuVmVjdG9yMyh4LCB5LCB6KSwgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDAuNCwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTogMC4yICsgdCAqIDAuNSAKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IAogICAgICAgICAgICAvLyBQSEFTRSAyOiBMQVVOQ0gKICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5zdGF0ZSA9PT0gJ2JsaXR6X2NoYXJnZScpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnYmxpdHpfbGF1bmNoJzsKICAgICAgICAgICAgICAgIHRoaXMuYmxpdHpUaW1lciA9IDA7IC8vIFJlc2V0IGZvciBsYXVuY2ggcGhhc2UKCiAgICAgICAgICAgICAgICAvLyBUSU1FRCBBTk5PVU5DRU1FTlQKICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQkxJVFogT0ZGISIsICdzbGFtJyk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdpbXBhY3QnLCB7IHZvbHVtZTogMS4wIH0pOyAvLyBCb29tCiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAxLjAgfSk7ICAgLy8gV2hvb3NoCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTGF1bmNoIEJhbGwKICAgICAgICAgICAgICAgIGJhbGwudmVsb2NpdHkuc2V0KDAsIDM1LCAwKTsgLy8gU2hvb3QgVVAgRkFTVAogICAgICAgICAgICAgICAgaWYgKGJhbGwuZGVmb3JtTm9kZSkgYmFsbC5kZWZvcm1Ob2RlLnNjYWxlLnNldCgwLjQsIDMuMCwgMC40KTsgLy8gRXh0cmVtZSBzdHJldGNoIHZlcnRpY2FsCgogICAgICAgICAgICAgICAgLy8gRlg6IE1hc3NpdmUgR3JvdW5kIEVydXB0aW9uCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgYmFsbC5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiA4LjAgfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgYmFsbC5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiA2LjAgfSk7CiAgICAgICAgICAgICAgICAgICAgLy8gVmVydGljYWwgc3RyZWFtCiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MTA7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gYmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHAueSArPSBpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwLCB7IHNjYWxlOiAzLjAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDMuMCk7IC8vIEhlYXZ5IHNoYWtlCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLmN1cnJlbnRQdWxsQmFjayA9IDEwOyAvLyBab29tIG91dCBmYXN0CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLm1hbnVhbE9yYml0UGl0Y2ggPSAwLjA7IC8vIExldmVsIG91dAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENhcHRhaW5zIEp1bXAKICAgICAgICAgICAgICAgIGNvbnN0IGhvbWVNRiA9IHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAgICAgY29uc3QgYXdheU1GID0gdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CgogICAgICAgICAgICAgICAgY29uc3QganVtcFRvID0gKHApID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAgfHwgIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IGJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1YihwLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGRpci55ID0gMS4yOyAvLyBTdGVlcCBqdW1wCiAgICAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5jb3B5KGRpcikubXVsdGlwbHlTY2FsYXIoMTguMCk7IC8vIEZhc3QganVtcAogICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2hfanVtcCcsIDAuMSk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGp1bXBUbyhob21lTUYpOwogICAgICAgICAgICAgICAganVtcFRvKGF3YXlNRik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVCbGl0ekxhdW5jaChkdCkgewogICAgICAgICAgICB0aGlzLmJsaXR6VGltZXIgKz0gZHQ7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBncmF2aXR5IG1hbnVhbGx5IGZvciBjaW5lbWF0aWMgZmVlbCAoSW5jcmVhc2VkIGdyYXZpdHkgZm9yIHNuYXBwaWVyIGFyYykKICAgICAgICAgICAgYmFsbC52ZWxvY2l0eS55IC09IDQwLjAgKiBkdDsgCiAgICAgICAgICAgIGJhbGwubWVzaC5wb3NpdGlvbi5hZGRTY2FsZWRWZWN0b3IoYmFsbC52ZWxvY2l0eSwgZHQpOwoKICAgICAgICAgICAgLy8gTW92ZSBQbGF5ZXJzIG1hbnVhbGx5CiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZUp1bXBlciA9IChwKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXAgfHwgIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS55IC09IDI1LjAgKiBkdDsgLy8gR3Jhdml0eQogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmFkZFNjYWxlZFZlY3RvcihwLnZlbG9jaXR5LCBkdCk7CiAgICAgICAgICAgICAgICBwLm1lc2gubG9va0F0KGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBob21lTUYgPSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgY29uc3QgYXdheU1GID0gdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB1cGRhdGVKdW1wZXIoaG9tZU1GKTsKICAgICAgICAgICAgdXBkYXRlSnVtcGVyKGF3YXlNRik7CgogICAgICAgICAgICAvLyBQSEFTRSAzOiBHUkFCIChBcGV4IH4wLjdzKQogICAgICAgICAgICBpZiAodGhpcy5ibGl0elRpbWVyID4gMC43ICYmIHRoaXMuc3RhdGUgPT09ICdibGl0el9sYXVuY2gnKSB7CiAgICAgICAgICAgICAgICAvLyBEZXRlcm1pbmUgV2lubmVyICg1MC81MCArIFN0YXQgYmlhcykKICAgICAgICAgICAgICAgIGNvbnN0IGhvbWVTcCA9IGhvbWVNRi5nZXRTdGF0KCdTUCcpOwogICAgICAgICAgICAgICAgY29uc3QgYXdheVNwID0gYXdheU1GLmdldFN0YXQoJ1NQJyk7CiAgICAgICAgICAgICAgICBjb25zdCB0b3RhbCA9IGhvbWVTcCArIGF3YXlTcDsKICAgICAgICAgICAgICAgIGNvbnN0IHJvbGwgPSBNYXRoLnJhbmRvbSgpICogdG90YWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHdpbm5lciA9IChyb2xsIDwgaG9tZVNwKSA/IGhvbWVNRiA6IGF3YXlNRjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgYmFsbC5ncmFiKHdpbm5lcik7CiAgICAgICAgICAgICAgICB0aGlzLmhpZGVBbm5vdW5jZW1lbnQoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mbG9hdGluZ1RleHQuc3Bhd24oIldPTiEiLCB3aW5uZXIubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBUcmFuc2l0aW9uIHRvIEFjdGl2ZQogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdhY3RpdmUnOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYSB0byB3aW5uZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KHdpbm5lci5tZXNoLCB3aW5uZXIudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuY2FtZXJhTWFuYWdlci5zbmFwVG9UYXJnZXQoKTsgLy8gT3B0aW9uYWw6IEtlZXAgc21vb3RoIG9yIHNuYXAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKLy8gSW5pdGlhbCBzdGFydAovLyBJbml0aWFsIHN0YXJ0CnN0YXJ0TWF0Y2gobW9kZSA9ICdub3JtYWwnKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZU1vZGUgPSBtb2RlOwogICAgICAgICAgICBjb25zb2xlLmxvZygiU3RhcnRpbmcgTWF0Y2ggaW4gbW9kZToiLCBtb2RlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IFNjb3JlCiAgICAgICAgICAgIHRoaXMuc2NvcmUuaG9tZSA9IDA7CiAgICAgICAgICAgIHRoaXMuc2NvcmUuYXdheSA9IDA7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IFRpbWUKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5oYWxmID0gMTsKICAgICAgICAgICAgaWYgKHRoaXMudWkuaGFsZikgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICIxc3QiOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKG1vZGUgPT09ICdwcmFjdGljZScpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiUFJBQyI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyLnN0YXJ0KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSW4gcHJhY3RpY2UsIGVuc3VyZSBBSSBpcyBlbmFibGVkIGZvciBzcGFycmluZwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5haUVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTdGFydCBCR00gaW1tZWRpYXRlbHkgZm9yIHByYWN0aWNlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gU2tpcCBpbnRybyBmb3IgcHJhY3RpY2UKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIFByYWN0aWNlIE1hbmFnZXIgaXMgc3RvcHBlZCBpZiBub3JtYWwgZ2FtZQogICAgICAgICAgICAgICAgaWYgKHRoaXMucHJhY3RpY2VNYW5hZ2VyKSB0aGlzLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNhZmV0eTogRW5zdXJlIGFsbCBwbGF5ZXJzIGFyZSB2aXNpYmxlIChpbiBjYXNlIFByYWN0aWNlIGhpZCB0aGVtKQogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7IGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSB0cnVlOyB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gdHJ1ZTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7IH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IENpbmVtYXRpYyBJbnRybwogICAgICAgICAgICAgICAgdGhpcy5zdGFydEludHJvU2VxdWVuY2UoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnNraXBJbnRybygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpbnRybycpIHJldHVybjsKICAgICAgICAgICAgY29uc29sZS5sb2coIkludHJvIENvbXBsZXRlL1NraXBwZWQiKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUkVTVE9SRSBVSSBFTEVNRU5UUwovLyBSRVNUT1JFIFVJIEVMRU1FTlRTCiAgICAgICAgICAgIGNvbnN0IHVpRWxlbWVudHMgPSBbCiAgICAgICAgICAgICAgICAnaHVkLXRvcCcsIAogICAgICAgICAgICAgICAgJ3BsYXllci1zdGF0dXMtcGFuZWwnLCAKICAgICAgICAgICAgICAgICdtaW5pbWFwLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2dvYWwtZGlzdGFuY2UtY29udGFpbmVyJywgCiAgICAgICAgICAgICAgICAnYWN0aW9uLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2pveXN0aWNrLWhpdC16b25lJywgCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXpvbmUnLAogICAgICAgICAgICAgICAgJ2F1dG8tdG9nZ2xlJywgCiAgICAgICAgICAgICAgICAnc2V0dGluZ3MtYnV0dG9uJywKICAgICAgICAgICAgICAgICdjb250cm9scy1oaW50JwogICAgICAgICAgICBdOwogICAgICAgICAgICAKICAgICAgICAgICAgdWlFbGVtZW50cy5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJyc7IC8vIFJldmVydCB0byBDU1MgZGVmYXVsdAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEhpZGUgQ2luZW1hdGljIEJhcnMKICAgICAgICAgICAgY29uc3QgYmFycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaW5lbWF0aWMtYmFycycpOwogICAgICAgICAgICBpZiAoYmFycykgewogICAgICAgICAgICAgICAgYmFycy5xdWVyeVNlbGVjdG9yQWxsKCcuYmFyJykuZm9yRWFjaChiID0+IGIuc3R5bGUuaGVpZ2h0ID0gJzAnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKLy8gTGlnaHRzIG9uCiAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS5zZXRBbGxMaWdodHModHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCBwbGF5ZXJzIHRvIGlkbGUKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnaWRsZScsIDAuMSkpOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5hd2F5KSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gcC5wbGF5KCdpZGxlJywgMC4xKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFydCBCR00gYWZ0ZXIgaW50cm8KICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0SW50cm9TZXF1ZW5jZSgpIHsKCiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaW50cm8nOwogICAgICAgICAgICB0aGlzLmludHJvU2hvdEluZGV4ID0gMDsKICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuX2hhc1JvYXJlZCA9IGZhbHNlOyAvLyBSZXNldCByb2FyIGZsYWcKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWwgc2V0dXAKICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bSkgdGhpcy5zdGFkaXVtLnNldEFsbExpZ2h0cyhmYWxzZSk7CgogICAgICAgICAgICAvLyBISURFIEFMTCBVSSBFTEVNRU5UUwogICAgICAgICAgICBjb25zdCB1aUVsZW1lbnRzID0gWwogICAgICAgICAgICAgICAgJ2h1ZC10b3AnLCAKICAgICAgICAgICAgICAgICdwbGF5ZXItc3RhdHVzLXBhbmVsJywgCiAgICAgICAgICAgICAgICAnbWluaW1hcC1jb250YWluZXInLCAKICAgICAgICAgICAgICAgICdnb2FsLWRpc3RhbmNlLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2FjdGlvbi1jb250YWluZXInLCAKICAgICAgICAgICAgICAgICd0YWNrbGUtYnV0dG9uJywgCiAgICAgICAgICAgICAgICAnam95c3RpY2staGl0LXpvbmUnLCAKICAgICAgICAgICAgICAgICdhaW0tam95c3RpY2stem9uZScsCiAgICAgICAgICAgICAgICAnam95c3RpY2stdmlzdWFsLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXZpc3VhbCcsCiAgICAgICAgICAgICAgICAnYXV0by10b2dnbGUnLCAKICAgICAgICAgICAgICAgICdzZXR0aW5ncy1idXR0b24nLAogICAgICAgICAgICAgICAgJ2NvbnRyb2xzLWhpbnQnLAogICAgICAgICAgICAgICAgJ2NoYXJnZS1tZXRlci1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJwogICAgICAgICAgICBdOwogICAgICAgICAgICAKICAgICAgICAgICAgdWlFbGVtZW50cy5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFNob3cgQ2luZW1hdGljIEJhcnMKICAgICAgICAgICAgY29uc3QgYmFycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaW5lbWF0aWMtYmFycycpOwogICAgICAgICAgICBpZiAoYmFycykgewogICAgICAgICAgICAgICAgYmFycy5xdWVyeVNlbGVjdG9yQWxsKCcuYmFyJykuZm9yRWFjaChiID0+IGIuc3R5bGUuaGVpZ2h0ID0gJzEwJScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIGlmICh0aGlzLmVudGl0aWVzLmJhbGwpIHRoaXMuZW50aXRpZXMuYmFsbC5yZXNldCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVHJpZ2dlciBmaXJzdCBzaG90IHN0YXJ0CiAgICAgICAgICAgIGlmICh0aGlzLmludHJvU2hvdHMgJiYgdGhpcy5pbnRyb1Nob3RzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmludHJvU2hvdHNbMF0ub25TdGFydCkgdGhpcy5pbnRyb1Nob3RzWzBdLm9uU3RhcnQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2tpcEludHJvKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cl91cGRhdGVJbnRyb1dhcm11cChkdCkgewogICAgICAgICAgICBjb25zdCBhbGxQbGF5ZXJzID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIGFsbFBsYXllcnMucHVzaCguLi50aGlzLnRlYW1zLmhvbWUucGxheWVycyk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIGFsbFBsYXllcnMucHVzaCguLi50aGlzLnRlYW1zLmF3YXkucGxheWVycyk7CgogICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBtaXhlciB1cGRhdGVzIChzaW5jZSBnYW1lIGxvb3AgbWlnaHQgc2tpcCBwbGF5ZXIudXBkYXRlIGluIGludHJvIHN0YXRlKQogICAgICAgICAgICAgICAgaWYgKHAubWl4ZXIpIHAubWl4ZXIudXBkYXRlKGR0KTsKCiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIHdhcm11cCB0aW1lciBpZiBuZWVkZWQKICAgICAgICAgICAgICAgIGlmIChwLl93YXJtdXBUaW1lciA9PT0gdW5kZWZpbmVkKSBwLl93YXJtdXBUaW1lciA9IE1hdGgucmFuZG9tKCkgKiAyLjA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHAuX3dhcm11cFRpbWVyIC09IGR0OwoKICAgICAgICAgICAgICAgIGlmIChwLl93YXJtdXBUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUGljayBuZXh0IGFjdGlvbiB0aW1lICgycyB0byA1cykKICAgICAgICAgICAgICAgICAgICBwLl93YXJtdXBUaW1lciA9IDIuMCArIE1hdGgucmFuZG9tKCkgKiAzLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFuZCA9IE1hdGgucmFuZG9tKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJhbmQgPCAwLjQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdpZGxlJywgMC41KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhbmQgPCAwLjYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdzd2ltJywgMC41KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhbmQgPCAwLjgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gIlN0cmV0Y2giIC8gQ2VsZWJyYXRlCiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2VsZWJyYXRlJywgMC41KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhbmQgPCAwLjkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjYXRjaCcsIDAuNSk7IC8vIENoZWNraW5nIGdsb3ZlcwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgncmVhY3QnLCAwLjUpOyAvLyBTaGFrZSBvZmYKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gR2VudGxlIGJvYmJpbmcgKHRyZWFkaW5nIHdhdGVyKQogICAgICAgICAgICAgICAgaWYgKHAuaG9tZVBvc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSBwLmhvbWVQb3NpdGlvbi55ICsgTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDAzICsgcC5tZXNoLmlkKSAqIDAuMzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKc2V0TWVudU1vZGUoaXNBY3RpdmUpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGlzQWN0aXZlID8gJ21lbnUnIDogJ2FjdGl2ZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaXNBY3RpdmUgJiYgdGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnN0b3BCR00oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTGlzdCBvZiBzdGF0aWMgSFVEIGVsZW1lbnRzIHRvIHRvZ2dsZQogICAgICAgICAgICBjb25zdCBzdGF0aWNVSSA9IFsKICAgICAgICAgICAgICAgICdodWQtdG9wJywKICAgICAgICAgICAgICAgICdwbGF5ZXItc3RhdHVzLXBhbmVsJywKICAgICAgICAgICAgICAgICdhY3Rpb24tY29udGFpbmVyJywKICAgICAgICAgICAgICAgICdqb3lzdGljay1oaXQtem9uZScsCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXpvbmUnLAogICAgICAgICAgICAgICAgJ21pbmltYXAtY29udGFpbmVyJywKICAgICAgICAgICAgICAgICdnb2FsLWRpc3RhbmNlLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAnc2V0dGluZ3MtYnV0dG9uJywKICAgICAgICAgICAgICAgICdhdXRvLXRvZ2dsZScsCiAgICAgICAgICAgICAgICAndGFja2xlLWJ1dHRvbicsCiAgICAgICAgICAgICAgICAnY29udHJvbHMtaGludCcKICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIC8vIExpc3Qgb2YgZHluYW1pYyBlbGVtZW50cyB0byBGT1JDRSBISURFIGluIG1lbnUKICAgICAgICAgICAgY29uc3QgZHluYW1pY1VJID0gWwogICAgICAgICAgICAgICAgJ2pveXN0aWNrLXZpc3VhbC1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ2FpbS1qb3lzdGljay12aXN1YWwnLAogICAgICAgICAgICAgICAgJ2NoYXJnZS1tZXRlci1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ3RlY2gtZmxhc2gtb3ZlcmxheScsCiAgICAgICAgICAgICAgICAncHJhY3RpY2UtcmVzdG9yZS1idG4nCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBpZiAoaXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgIC8vIEhJREUgQUxMCiAgICAgICAgICAgICAgICBbLi4uc3RhdGljVUksIC4uLmR5bmFtaWNVSV0uZm9yRWFjaChpZCA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBTSE9XIFNUQVRJQyBPTkxZCiAgICAgICAgICAgICAgICBzdGF0aWNVSS5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlkID09PSAnaHVkLXRvcCcgfHwgaWQgPT09ICdhY3Rpb24tY29udGFpbmVyJykgZWwuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBlbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIC8vIER5bmFtaWMgb25lcyByZW1haW4gaGlkZGVuL2NvbnRyb2xsZWQgYnkgdGhlaXIgbG9naWMKICAgICAgICAgICAgfQogICAgICAgIH0KdG9nZ2xlRGVtb01vZGUoKSB7CiAgICAgICAgICAgIHRoaXMuaXNEZW1vTW9kZSA9ICF0aGlzLmlzRGVtb01vZGU7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJEZW1vIE1vZGU6IiwgdGhpcy5pc0RlbW9Nb2RlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBVSSBCdXR0b24KICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F1dG8tdG9nZ2xlJyk7CiAgICAgICAgICAgIGlmIChidG4pIHsKICAgICAgICAgICAgICAgIGJ0bi5pbm5lclRleHQgPSB0aGlzLmlzRGVtb01vZGUgPyAiQVVUTyBQSUxPVCIgOiAiTUFOVUFMIjsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzRGVtb01vZGUpIHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSB0aGlzLmlzRGVtb01vZGUgPyAiQVVUTyBQSUxPVCIgOiAiTUFOVUFMIjsKICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KHRleHQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIEZsYWlyOiBTcGF3biB0ZXh0IGFib3ZlIGFjdGl2ZSBwbGF5ZXIKICAgICAgICAgICAgaWYgKHRoaXMuaXNEZW1vTW9kZSAmJiB0aGlzLmZsb2F0aW5nVGV4dCAmJiB0aGlzLnRlYW1zLmhvbWUgJiYgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciAmJiB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKCJBSSBFTkdBR0VEIiwgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllci5tZXNoLnBvc2l0aW9uLCAiZ29hbCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBdXRvLWhpZGUgYW5ub3VuY2VtZW50CnNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkuYW5ub3VuY2VtZW50ICYmIHRoaXMudWkuYW5ub3VuY2VtZW50LmlubmVyVGV4dCA9PT0gdGV4dCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBURUNIQ09QWSBTWVNURU0gLS0tCgogICAgICAgIHRyaWdnZXJUZWNoRXZlbnQoc291cmNlUGxheWVyLCB0ZWNoTmFtZSkgewogICAgICAgICAgICBpZiAoIXNvdXJjZVBsYXllciB8fCAhc291cmNlUGxheWVyLnRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIC8vIEZpbmQgb3Bwb3NpbmcgdGVhbQogICAgICAgICAgICBjb25zdCBvcHBUZWFtSWQgPSBzb3VyY2VQbGF5ZXIudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gdGhpcy50ZWFtc1tvcHBUZWFtSWRdOwogICAgICAgICAgICBpZiAoIW9wcFRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIC8vIEZpbmQgd2hvIGlzIG1hcmtpbmcgdGhpcyBzb3VyY2UKICAgICAgICAgICAgY29uc3QgbGVhcm5lcnMgPSBvcHBUZWFtLnBsYXllcnMuZmlsdGVyKHAgPT4gcC5tYXJraW5nID09PSBzb3VyY2VQbGF5ZXIpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGxlYXJuZXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gT25seSBzaG93IFVJIGlmIHRoZSBsZWFybmluZyB0ZWFtIGlzIEh1bWFuIChIb21lKQogICAgICAgICAgICAvLyAoT3IgaWYgd2UgYXJlIGluIERlbW8gbW9kZSBhbmQgd2FudCB0byBzZWUgaXQgaGFwcGVuIGZvciBIb21lIHRlYW0pCiAgICAgICAgICAgIGlmIChvcHBUZWFtLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIC8vIEZpbHRlciBvdXQgdGhvc2Ugd2hvIGFscmVhZHkga25vdyBpdAogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRMZWFybmVycyA9IGxlYXJuZXJzLmZpbHRlcihwID0+ICFwLmxlYXJuZWRUZWNocy5pbmNsdWRlcyh0ZWNoTmFtZSkpOwogICAgICAgICAgICAgICAgaWYgKHZhbGlkTGVhcm5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRUZWNoQ29weVdpbmRvdyh0ZWNoTmFtZSwgdmFsaWRMZWFybmVycyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzdGFydFRlY2hDb3B5V2luZG93KHRlY2hOYW1lLCBsZWFybmVycykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLm1heFRpbWUgPSAwLjY7IC8vIDAuNnMgd2luZG93CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciA9IHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUudGVjaCA9IHRlY2hOYW1lOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUubGVhcm5lcnMgPSBsZWFybmVyczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNob3cgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaEZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoRmxhc2guc3R5bGUuYmFja2dyb3VuZCA9ICIiOyAvLyBSZXNldCBiYWNrZ3JvdW5kCiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlRFQ0hDT1BZISI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hTdWIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hTdWIuaW5uZXJUZXh0ID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IGJhcgogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaFRpbWVyRmlsbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9ICcxMDAlJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmF0dGVtcHRUZWNoQ29weSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdWNjZXNzIQogICAgICAgICAgICBjb25zdCB0ZWNoID0gdGhpcy50ZWNoQ29weVN0YXRlLnRlY2g7CiAgICAgICAgICAgIGNvbnN0IGxlYXJuZXJzID0gdGhpcy50ZWNoQ29weVN0YXRlLmxlYXJuZXJzOwogICAgICAgICAgICAKICAgICAgICAgICAgbGVhcm5lcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIC8vIERvdWJsZSBjaGVjayB0byBwcmV2ZW50IGR1cGxpY2F0ZXMKICAgICAgICAgICAgICAgIGlmICghcC5sZWFybmVkVGVjaHMuaW5jbHVkZXModGVjaCkpIHsKICAgICAgICAgICAgICAgICAgICBwLmxlYXJuZWRUZWNocy5wdXNoKHRlY2gpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3Aucm9sZX0gbGVhcm5lZCAke3RlY2h9IWApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDEuIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5mbG9hdGluZ1RleHQgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKGBMRUFSTkVEIWAsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gUGFydGljbGUgRWZmZWN0IChTcGlyYWwpCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biBtdWx0aXBsZSBwYXJ0aWNsZXMgZm9yIGEgc3dpcmwgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDEwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGkgKiA1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5lbmRUZWNoQ29weVdpbmRvdyh0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKZW5kVGVjaENvcHlXaW5kb3coc3VjY2VzcykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlNVQ0NFU1MhIjsKICAgICAgICAgICAgICAgICAgICAvLyBGbGFzaCBzdWNjZXNzIGNvbG9yIChXaGl0ZSBmbGFzaCkKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5iYWNrZ3JvdW5kID0gInJnYmEoMjU1LCAyNTUsIDI1NSwgMC44KSI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSGlkZSBhZnRlciBzaG9ydCBkZWxheSB0byBzaG93IHRoZSBzdWNjZXNzIGZsYXNoCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOyAKICAgICAgICAgICAgICAgICAgICB9LCAzMDApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBGYWlsZWQgLyBNaXNzZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQpfdXBkYXRlUGxheWVyU3RhdHVzVUkoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtcy5ob21lIHx8ICF0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBwID0gdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgdWkgPSB0aGlzLnVpLnN0YXR1c1BhbmVsOwogICAgICAgICAgICAKLy8gVUkgVXBkYXRlcyAoQWN0aW9uIEJ1dHRvbiBDb250ZXh0KQogICAgICAgICAgICAgICAgdWkuY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOYW1lICYgTGV2ZWwKICAgICAgICAgICAgICAgIGlmICh1aS5uYW1lKSB1aS5uYW1lLmlubmVyVGV4dCA9IGAke3AuY2hhcmFjdGVyTmFtZSB8fCBwLnJvbGV9IExWJHtwLmxldmVsfWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEhQCiAgICAgICAgICAgICAgICBpZiAodWkuaHBCYXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBocFBjdCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEwMCwgKHAuc3RhdHMuSFAgLyBwLnN0YXRzLm1heEhQKSAqIDEwMCkpOwogICAgICAgICAgICAgICAgICAgIHVpLmhwQmFyLnN0eWxlLndpZHRoID0gYCR7aHBQY3R9JWA7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29sb3Igc2hpZnQKICAgICAgICAgICAgICAgICAgICBpZiAoaHBQY3QgPCAyNSkgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAwMDAsICNmZjQ0NDQpJzsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChocFBjdCA8IDUwKSB1aS5ocEJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmYwMCwgI2ZmZmY4OCknOwogICAgICAgICAgICAgICAgICAgIGVsc2UgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwMGZmMDAsICNjY2ZmY2MpJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1aS5ocFRleHQpIHVpLmhwVGV4dC5pbm5lclRleHQgPSBgJHtNYXRoLmZsb29yKHAuc3RhdHMuSFApfS8ke3Auc3RhdHMubWF4SFB9YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRVhQCiAgICAgICAgICAgICAgICBpZiAodWkuZXhwQmFyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwUGN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMTAwLCAocC5leHAgLyBwLm5leHRMZXZlbEV4cCkgKiAxMDApKTsKICAgICAgICAgICAgICAgICAgICB1aS5leHBCYXIuc3R5bGUud2lkdGggPSBgJHtleHBQY3R9JWA7CnVpLmV4cEJhci5zdHlsZS53aWR0aCA9IGAke2V4cFBjdH0lYDsKICAgICAgICAgICAgICAgIH0KICAgICAgICB9CgpfaW5pdFBhcnRpY2xlcygpIHsKICAgICAgICAgICAgdGhpcy5hY3RpdmVTcGFya3MgPSBbXTsKICAgICAgICAgICAgdGhpcy5zcGFya1Bvb2wgPSBbXTsKICAgICAgICAgICAgY29uc3QgcG9vbFNpemUgPSA0MDsgLy8gU3VmZmljaWVudCBmb3IgY29udGludW91cyBncmluZGluZwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb29sU2l6ZTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSBuZXcgVEhSRUUuU3ByaXRlKF9zcGFya01hdGVyaWFsLmNsb25lKCkpOwogICAgICAgICAgICAgICAgc3ByaXRlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHNwcml0ZSk7CiAgICAgICAgICAgICAgICB0aGlzLnNwYXJrUG9vbC5wdXNoKHNwcml0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNwYXduQ2xhc2gocG9zLCBpbnRlbnNpdHkgPSAxLjApIHsKICAgICAgICAgICAgLy8gRmluZCBmcmVlIHNwYXJrCiAgICAgICAgICAgIGNvbnN0IHNwYXJrID0gdGhpcy5zcGFya1Bvb2wuZmluZChzID0+ICFzLnZpc2libGUpOwogICAgICAgICAgICBpZiAoIXNwYXJrKSByZXR1cm47IC8vIFBvb2wgZXhoYXVzdGVkCiAgICAgICAgICAgIAogICAgICAgICAgICBzcGFyay5wb3NpdGlvbi5jb3B5KHBvcyk7CiAgICAgICAgICAgIHNwYXJrLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmFuZG9taXplIHJvdGF0aW9uCiAgICAgICAgICAgIHNwYXJrLm1hdGVyaWFsLnJvdGF0aW9uID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsaXplIEFjdGl2ZSBTdGF0ZQogICAgICAgICAgICB0aGlzLmFjdGl2ZVNwYXJrcy5wdXNoKHsKICAgICAgICAgICAgICAgIG1lc2g6IHNwYXJrLAogICAgICAgICAgICAgICAgYWdlOiAwLAogICAgICAgICAgICAgICAgbGlmZTogMC4xNSArIE1hdGgucmFuZG9tKCkgKiAwLjE1LCAvLyBGYXN0LCBwdW5jaHkgc3BhcmtzCiAgICAgICAgICAgICAgICBtYXhTY2FsZTogMi41ICogaW50ZW5zaXR5LAogICAgICAgICAgICAgICAgdmVsb2NpdHk6IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqOCwgCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSo4LCAKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKjgKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlUGFydGljbGVzKGR0KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmFjdGl2ZVNwYXJrcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuYWN0aXZlU3BhcmtzW2ldOwogICAgICAgICAgICAgICAgcC5hZ2UgKz0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChwLmFnZSA+PSBwLmxpZmUpIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlU3BhcmtzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgdCA9IHAuYWdlIC8gcC5saWZlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBFeHBhbmQKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRTY2FsZSA9IDAuNSArIChwLm1heFNjYWxlIC0gMC41KSAqIHQ7CiAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKGN1cnJlbnRTY2FsZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZhZGUgb3V0CiAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IDEuMCAtICh0ICogdCk7IC8vIFF1YWRyYXRpYyBmYWRlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE1vdmUKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5hZGRTY2FsZWRWZWN0b3IocC52ZWxvY2l0eSwgZHQpOwogICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLnJvdGF0aW9uICs9IDEwLjAgKiBkdDsKICAgICAgICAgICAgfQogICAgICAgIH0KCi8vIEhlbHBlciBmb3IgaW1wYWN0IGZyYW1lcwoKdHJpZ2dlckltcGFjdChkdXJhdGlvbiwgdHlwZSA9ICdkZWZhdWx0JykgewogICAgICAgICAgICB0aGlzLmltcGFjdFBhdXNlID0gZHVyYXRpb247CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKICAgICAgICAgICAgaWYgKCFjb250YWluZXIpIHJldHVybjsKCiAgICAgICAgICAgIC8vIFJlc2V0IGNsYXNzZXMgdG8gZW5zdXJlIGFuaW1hdGlvbiByZXN0YXJ0cwogICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZSgnaW1wYWN0LWZ4JywgJ2ltcGFjdC1oZWF2eScsICdpbXBhY3Qtc2hhdHRlcicpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRm9yY2UgcmVmbG93CiAgICAgICAgICAgIHZvaWQgY29udGFpbmVyLm9mZnNldFdpZHRoOwoKICAgICAgICAgICAgbGV0IGNsYXNzTmFtZSA9ICdpbXBhY3QtZngnOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2hlYXZ5JykgY2xhc3NOYW1lID0gJ2ltcGFjdC1oZWF2eSc7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnc2hhdHRlcicpIGNsYXNzTmFtZSA9ICdpbXBhY3Qtc2hhdHRlcic7CgogICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LmFkZChjbGFzc05hbWUpOwoKICAgICAgICAgICAgLy8gQXV0by1yZW1vdmUgY2xhc3MgYWZ0ZXIgZHVyYXRpb24KICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpOwogICAgICAgICAgICB9LCBkdXJhdGlvbiAqIDEwMDAgKyAxMDApOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5HYW1lTWFuYWdlciA9IEdhbWVNYW5hZ2VyOwp9KSgpOw==","/GameManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFNwYXJrIFRleHR1cmUgKFByb2NlZHVyYWwgQnVyc3QpCiAgICBjb25zdCBfc3BhcmtUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsMCw2NCw2NCk7CiAgICAgICAgCiAgICAgICAgLy8gQnVyc3Qgc2hhcGUKICAgICAgICBjb25zdCBjeCA9IDMyLCBjeSA9IDMyOwogICAgICAgIGNvbnN0IHNwaWtlcyA9IDg7CiAgICAgICAgY29uc3Qgb3V0ZXIgPSAzMDsKICAgICAgICBjb25zdCBpbm5lciA9IDEwOwogICAgICAgIAogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBmb3IobGV0IGk9MDsgaTxzcGlrZXMqMjsgaSsrKXsKICAgICAgICAgICAgY29uc3QgciA9IChpJTI9PT0wKT8gb3V0ZXIgOiBpbm5lcjsKICAgICAgICAgICAgY29uc3QgYSA9IChNYXRoLlBJKmkpL3NwaWtlczsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCArIE1hdGguY29zKGEpKnIsIGN5ICsgTWF0aC5zaW4oYSkqcik7CiAgICAgICAgfQogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmNjMDAnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgLy8gV2hpdGUgQ29yZQogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHguYXJjKGN4LCBjeSwgOCwgMCwgTWF0aC5QSSoyKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICBjb25zdCBfc3BhcmtNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IAogICAgICAgIG1hcDogX3NwYXJrVGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBHYW1lTWFuYWdlciB7CgogICAgICAgIApjb25zdHJ1Y3RvcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEsIHJlbmRlcmVyKSB7CndpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIgPSByZW5kZXJlcjsgLy8gU3RvcmUgcmVuZGVyZXIKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmNhbWVyYSA9IGNhbWVyYTsKICAgICAgICAgICAgdGhpcy51aUxheWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodWlMYXllcklkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc2NvcmUgPSB7IGhvbWU6IDAsIGF3YXk6IDAgfTsKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5oYWxmID0gMTsKICAgICAgICAgICAgdGhpcy5oYWxmRHVyYXRpb24gPSAzMDA7IC8vIDUgbWludXRlcyAoc2Vjb25kcykKICAgICAgICAgICAgdGhpcy5pc092ZXJ0aW1lID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNEZW1vTW9kZSA9IGZhbHNlOwp0aGlzLmdhbWVNb2RlID0gJ25vcm1hbCc7IC8vICdub3JtYWwnIG9yICdwcmFjdGljZScKICAgICAgICAgICAgdGhpcy5pc0ZvcmdlTW9kZSA9IGZhbHNlOyAvLyBBc3NldCBGb3JnZSBTdGF0ZQogICAgICAgICAgICAvLyBJbXBhY3QgRnJhbWVzCiAgICAgICAgICAgIHRoaXMuaW1wYWN0UGF1c2UgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsgLy8gU3RhcnQgaW4gbWVudQp0aGlzLnRlYW1zID0gewogICAgICAgICAgICAgICAgaG9tZTogbnVsbCwKICAgICAgICAgICAgICAgIGF3YXk6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZW50aXRpZXMgPSB7CiAgICAgICAgICAgICAgICBiYWxsOiBudWxsCiAgICAgICAgICAgIH07Cgp0aGlzLnVpID0gewogICAgICAgICAgICAgICAgc2NvcmVQbGF5ZXI6IG51bGwsCiAgICAgICAgICAgICAgICBzY29yZUNwdTogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWVyOiBudWxsLAogICAgICAgICAgICAgICAgaGFsZjogbnVsbCwKICAgICAgICAgICAgICAgIGFubm91bmNlbWVudDogbnVsbCwKICAgICAgICAgICAgICAgIC8vIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgICAgIHN0YXR1c1BhbmVsOiB7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyOiBudWxsLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBCYXI6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaHBUZXh0OiBudWxsLAogICAgICAgICAgICAgICAgICAgIGV4cEJhcjogbnVsbAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVGVjaGNvcHkgU3RhdGUKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlID0gewogICAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHRpbWVyOiAwLAogICAgICAgICAgICAgICAgdGVjaDogbnVsbCwKICAgICAgICAgICAgICAgIGxlYXJuZXJzOiBbXQogICAgICAgICAgICB9OwoKdGhpcy5taW5pTWFwID0gbmV3IHdpbmRvdy5mbHV4Lk1pbmlNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgRmxvYXRpbmcgVGV4dAovLyBJbml0aWFsaXplIEZsb2F0aW5nIFRleHQKdGhpcy5mbG9hdGluZ1RleHQgPSBuZXcgd2luZG93LmZsdXguRmxvYXRpbmdUZXh0TWFuYWdlcihzY2VuZSwgdWlMYXllcklkLCBjYW1lcmEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmV1c2FibGUgdmVjdG9yIGZvciBVSSBjYWxjdWxhdGlvbnMKICAgICAgICAgICAgdGhpcy5fdGVtcFZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIFBhcnRpY2xlIE1hbmFnZXIgKFN0YXR1cyBFZmZlY3RzKQogICAgICAgICAgICAKLy8gSW5pdGlhbGl6ZSBQYXJ0aWNsZSBNYW5hZ2VyIChTdGF0dXMgRWZmZWN0cykKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyKHNjZW5lKTsKdGhpcy5nbHlwaE1hbmFnZXIgPSBudWxsOyAvLyBJbmplY3RlZCBieSBtYWluLmpzCnRoaXMuX2luaXRDaW5lbWF0aWNzKCk7CiAgICAgICAgICAgIHRoaXMuX2luaXRQYXJ0aWNsZXMoKTsgLy8gM0QgU3BhcmsgU3lzdGVtIChMZWdhY3kvSW1wYWN0KQoKdGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIgPSBuZXcgd2luZG93LmZsdXguRGVidWdWaXN1YWxpemVyKHNjZW5lKTsKICAgICAgICAgICAgdGhpcy5wcmFjdGljZU1hbmFnZXIgPSBuZXcgd2luZG93LmZsdXguUHJhY3RpY2VNYW5hZ2VyKHRoaXMpOyAvLyBJbml0aWFsaXplIFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgdGhpcy5faW5qZWN0U3R5bGVzKCk7CnRoaXMuX2luaXRVSSgpOwogICAgICAgIH0KCl9pbml0Q2luZW1hdGljcygpIHsKICAgICAgICAgICAgLy8gTWVudSBCYWNrZ3JvdW5kIFNob3RzIChCLVJvbGwpCiAgICAgICAgICAgIHRoaXMubWVudVNob3RJbmRleCA9IDA7CiAgICAgICAgICAgIHRoaXMubWVudVNob3RUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMubWVudVNob3RzID0gWwogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogMTAuMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNhbS5wb3NpdGlvbi5zZXQoNjAsIDM1LCA2MCkubGVycChuZXcgVEhSRUUuVmVjdG9yMyg0MCwgMjUsIDQwKSwgdCk7IGNhbS5sb29rQXQoMCwgMCwgMCk7IH0gfSwKICAgICAgICAgICAgICAgIHsgZHVyYXRpb246IDguMCwgdXBkYXRlOiAodCwgY2FtKSA9PiB7IGNhbS5wb3NpdGlvbi5zZXQoLTI1LCA2LCAtMjUgKyA1MCp0KTsgY2FtLmxvb2tBdCgwLCAyLCAoLTI1ICsgNTAqdCkqMC44KTsgfSB9LAogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogOC4wLCB1cGRhdGU6ICh0LCBjYW0pID0+IHsgY29uc3QgYSA9IHQrMy41OyBjYW0ucG9zaXRpb24uc2V0KC0xMCtNYXRoLmNvcyhhKSoxMCwgNCwgLTEwK01hdGguc2luKGEpKjEwKTsgY2FtLmxvb2tBdCgtMTAsIDEuNSwgLTEwKTsgfSB9LAogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogNy4wLCB1cGRhdGU6ICh0LCBjYW0pID0+IHsgY2FtLnBvc2l0aW9uLnNldCgwLCAtNSwgMzIpLmxlcnAobmV3IFRIUkVFLlZlY3RvcjMoMCwgOCwgMjApLCB0KTsgY2FtLmxvb2tBdCgwLCAxNSwgNDUpOyBjYW0ucm90YXRpb24ueiA9ICh0LTAuNSkqMC4xNTsgfSB9LAogICAgICAgICAgICAgICAgeyBkdXJhdGlvbjogOC4wLCB1cGRhdGU6ICh0LCBjYW0pID0+IHsgY2FtLnBvc2l0aW9uLnNldCgwLCA1MCwgMCkubGVycChuZXcgVEhSRUUuVmVjdG9yMygwLCAxMCwgMCksIHQqdCooMy0yKnQpKTsgY2FtLmxvb2tBdCgwLCAwLCAwKTsgY2FtLnJvdGF0aW9uLnogPSB0KjAuODsgfSB9CiAgICAgICAgICAgIF07CgogICAgICAgICAgICAvLyBFcGljIEludHJvIFNlcXVlbmNlICgiSGVyY3VsZWFuIikKICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RzID0gWwogICAgICAgICAgICAgICAgLy8gMS4gIlRoZSBBd2FrZW5pbmciIC0gQ2xvc2Ugb24gU3BoZXJlIC0+IFpvb20gT3V0IFVwc2lkZSBEb3duIC0+IExpZ2h0cyAmIFJvYXIKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogOC4wLAogICAgICAgICAgICAgICAgICAgIG9uU3RhcnQ6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiVEhFIFNQSEVSRSBQT09MIiwgInNsYW0iKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc3RhZGl1bSkgdGhpcy5zdGFkaXVtLnJlc2V0TGlnaHRzKCk7IC8vIEVuc3VyZSBkYXJrIHN0YXJ0CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhc1JvYXJlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQW1iaWVudCBzdGFydCBzb3VuZCAoRGVlcCBodW0gLyBVbmRlcndhdGVyIGZlZWwpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdzd2ltJywgeyB2b2x1bWU6IDEuMCwgcmF0ZTogMC4zIH0pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVhc2luZwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlYXNlID0gdCA8IDAuNSA/IDIgKiB0ICogdCA6IC0xICsgKDQgLSAyICogdCkgKiB0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBleHBUID0gTWF0aC5wb3codCwgMy4wKTsgLy8gU3Ryb25nIGV4cG9uZW50aWFsIHpvb20gb3V0CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYW1lcmEgTW90aW9uOiBTdGFydCBJTlNJREUvQ0xPU0UgKDAsMCwyKSAtPiBFbmQgRkFSIEJBQ0svVVAgKDAsIDgwLCAxNjApCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMik7IAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlbmRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCA4MCwgMTYwKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMoc3RhcnRQb3MsIGVuZFBvcywgZXhwVCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBEeW5hbWljIFJvbGw6IFR1cm4gdXBzaWRlIGRvd24gKDAgLT4gUEkpCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5yb3RhdGlvbi56ID0gZWFzZSAqIE1hdGguUEk7IAoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTGlnaHQgU2VxdWVuY2luZyAmIFNvdW5kCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsID0gdGhpcy5zdGFkaXVtLmxpZ2h0Q291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsaWdodFByb2dyZXNzID0gTWF0aC5tYXgoMCwgKHQgLSAwLjIpIC8gMC42KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2ZUNvdW50ID0gTWF0aC5mbG9vcihsaWdodFByb2dyZXNzICogdG90YWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyICJSb2FyIHRvIExpZmUiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGlnaHRQcm9ncmVzcyA+IDAuNSAmJiAhdGhpcy5faGFzUm9hcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faGFzUm9hcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdnb2FsJywgeyB2b2x1bWU6IDEuMCwgcmF0ZTogMC43IH0pOyAvLyBEZWVwIHJvYXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAwLjgsIHJhdGU6IDAuNSB9KTsgLy8gV2hvb3NoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgxLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpIDwgdG90YWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpIDw9IGFjdGl2ZUNvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IHRoaXMuc3RhZGl1bS5saWdodFNwcml0ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcHJpdGUgJiYgIXNwcml0ZS52aXNpYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YWRpdW0udHVybk9uTGlnaHQoaSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluZHVzdHJpYWwgTGlnaHQgU0ZYCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpdGNoID0gMC41ICsgKGkgLyB0b3RhbCkgKiAwLjU7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ2ltcGFjdCcsIHsgdm9sdW1lOiAwLjQsIHJhdGU6IHBpdGNoLCB2YXJpYW5jZTogMC4wIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDAuMik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gMi4gIlRoZSBSb2FyIiAtIFN3ZWVwaW5nIGNyb3dkIHNob3QKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogNC4wLAogICAgICAgICAgICAgICAgICAgIG9uU3RhcnQ6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJMRUdFTkRBUlkgQVJFTkEiLCAibm9ybWFsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuY2FtZXJhTWFuYWdlcikgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDEuMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdnb2FsJywgeyB2b2x1bWU6IDAuNyB9KTsgLy8gQ3Jvd2QgY2hlZXIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZTogKHQsIGNhbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhc3BlY3QgPSB3aW5kb3cuaW5uZXJXaWR0aCAvIHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNQb3J0cmFpdCA9IGFzcGVjdCA8IDEuMDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gLU1hdGguUEkvMiArICh0ICogTWF0aC5QSSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBpc1BvcnRyYWl0ID8gODUgOiA2NTsgLy8gUHVsbCBiYWNrIGluIHBvcnRyYWl0CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24uc2V0KE1hdGguY29zKGFuZ2xlKSpyLCAxNSwgTWF0aC5zaW4oYW5nbGUpKnIpOwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ubG9va0F0KDAsIDUsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyAzLiAiSG9tZSBHbG9yeSIgLSBPcmJpdCBIb21lIFRlYW0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogMy41LAogICAgICAgICAgICAgICAgICAgIG9uU3RhcnQ6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJCRVNBSUQgQVVST0NIUyIsICJzbGFtIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnY2VsZWJyYXRlJywgMC4yKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdkYXNoJywgeyB2b2x1bWU6IDAuNSB9KTsgLy8gV2hvb3NoCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB1cGRhdGU6ICh0LCBjYW0pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYXNwZWN0ID0gd2luZG93LmlubmVyV2lkdGggLyB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzUG9ydHJhaXQgPSBhc3BlY3QgPCAxLjA7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBPcmJpdCBIb21lIFRlYW0gKFNpZGUgMSwgLVopCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIC0yMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5QSSArICh0ICogMS41KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IGlzUG9ydHJhaXQgPyAyMCA6IDEyOyAvLyBQdWxsIGJhY2sgaWYgcG9ydHJhaXQKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLnBvc2l0aW9uLnNldChjZW50ZXIueCArIE1hdGguY29zKGFuZ2xlKSpyLCA0LCBjZW50ZXIueiArIE1hdGguc2luKGFuZ2xlKSpyKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdChjZW50ZXIueCwgMiwgY2VudGVyLnopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyA0LiAiRW5lbXkgR2F0ZXMiIC0gVHJhY2tpbmcgQXdheSBUZWFtCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDMuNSwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiTFVDQSBHT0VSUyIsICJzbGFtIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnaWRsZScsIDAuMikpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAwLjUgfSk7IC8vIFdob29zaAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1BvcnRyYWl0ID0gYXNwZWN0IDwgMS4wOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJhY2tpbmcgQXdheSBUZWFtIChTaWRlIC0xLCArWikKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSBuZXcgVEhSRUUuVmVjdG9yMygtMTUsIDIsIDI1KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gbmV3IFRIUkVFLlZlY3RvcjMoMTUsIDIsIDI1KTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1BvcnRyYWl0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydC54ICo9IDEuNTsgZW5kLnggKj0gMS41OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQueiArPSAxMDsgZW5kLnogKz0gMTA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5wb3NpdGlvbi5sZXJwVmVjdG9ycyhzdGFydCwgZW5kLCB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FtLmxvb2tBdCgwLCAzLCAyNSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIDUuICJUaGUgU3BoZXJlIiAtIFpvb20gdG8gY2VudGVyCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDIuMCwKICAgICAgICAgICAgICAgICAgICBvblN0YXJ0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQkxJVFogT0ZGISIsICJzbGFtIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc3RhZGl1bSkgdGhpcy5zdGFkaXVtLnNldEFsbExpZ2h0cyh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5hdWRpb01hbmFnZXIpIHRoaXMuYXVkaW9NYW5hZ2VyLnBsYXlTRlgoJ3doaXN0bGUnLCB7IHZvbHVtZTogMC44IH0pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlOiAodCwgY2FtKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzcGVjdCA9IHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1BvcnRyYWl0ID0gYXNwZWN0IDwgMS4wOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcDEgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAzMCwgaXNQb3J0cmFpdCA/IDcwIDogNTApOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwMiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDE0LCAyMik7IC8vIEdhbWVwbGF5IGNhbQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdCA9IHQgKiB0OwogICAgICAgICAgICAgICAgICAgICAgICBjYW0ucG9zaXRpb24ubGVycFZlY3RvcnMocDEsIHAyLCBzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbS5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBdOwogICAgICAgIH0KCiAgICAgICAgX2luamVjdFN0eWxlcygpIHsKICAgICAgICAgICAgaWYgKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmbHV4LWR5bmFtaWMtc3R5bGVzJykpIHJldHVybjsKICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpOwogICAgICAgICAgICBzdHlsZS5pZCA9ICdmbHV4LWR5bmFtaWMtc3R5bGVzJzsKc3R5bGUudGV4dENvbnRlbnQgPSBgCiAgICAgICAgICAgICAgICBAa2V5ZnJhbWVzIHRleHRTbGFtIHsKICAgICAgICAgICAgICAgICAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDQpOyBvcGFjaXR5OiAwOyBsZXR0ZXItc3BhY2luZzogNTBweDsgfQogICAgICAgICAgICAgICAgICAgIDEwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyBvcGFjaXR5OiAxOyBsZXR0ZXItc3BhY2luZzogNXB4OyB9CiAgICAgICAgICAgICAgICAgICAgMTUlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4xKTsgfQogICAgICAgICAgICAgICAgICAgIDIwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEpOyB9CiAgICAgICAgICAgICAgICAgICAgODAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMSk7IG9wYWNpdHk6IDE7IGZpbHRlcjogYmx1cigwcHgpOyB9CiAgICAgICAgICAgICAgICAgICAgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDEuNSk7IG9wYWNpdHk6IDA7IGZpbHRlcjogYmx1cigxMHB4KTsgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAuYW5ub3VuY2VtZW50LXNsYW0gewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgICAgICAgICB0b3A6IDQ1JTsgbGVmdDogNTAlOwogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiAxMDAlOwogICAgICAgICAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgICAgICAgICBmb250LWZhbWlseTogJ0ltcGFjdCcsIHNhbnMtc2VyaWY7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiA5NnB4OwogICAgICAgICAgICAgICAgICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgICAgICAgICAgICAgICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20sICNmZmZmZmYgMCUsICNmZmRkMDAgNDUlLCAjZmY4ODAwIDEwMCUpOwogICAgICAgICAgICAgICAgICAgIC13ZWJraXQtYmFja2dyb3VuZC1jbGlwOiB0ZXh0OwogICAgICAgICAgICAgICAgICAgIC13ZWJraXQtdGV4dC1maWxsLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4IHJnYmEoMCwwLDAsMSkpIGRyb3Atc2hhZG93KDAgMCAzMHB4IHJnYmEoMjU1LCAxMDAsIDAsIDAuNikpOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDIwMDA7CiAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uOiB0ZXh0U2xhbSAxLjhzIGN1YmljLWJlemllcigwLjEsIDAuOCwgMC4xLCAxKSBmb3J3YXJkczsKICAgICAgICAgICAgICAgICAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgICAgICAgICAgICAgICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC5tb2RhbC1vdmVybGF5IHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7IHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IGNlbnRlciwgcmdiYSgxMCwgMjUsIDYwLCAwLjk1KSAwJSwgcmdiYSgwLCAwLCAwLCAwLjk4KSAxMDAlKTsKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiBmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsgYWxpZ24taXRlbXM6IGNlbnRlcjsgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgICAgICAgICAgICAgICB6LWluZGV4OiAxOTAwOwogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IDA7IHBvaW50ZXItZXZlbnRzOiBub25lOyB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuOHM7CiAgICAgICAgICAgICAgICAgICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDhweCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAubW9kYWwtb3ZlcmxheS5hY3RpdmUgeyBvcGFjaXR5OiAxOyBwb2ludGVyLWV2ZW50czogYXV0bzsgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAubW9kYWwtdGl0bGUgewogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnR2FyYW1vbmQnLCBzZXJpZjsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDUycHg7IGNvbG9yOiAjZmZmOwogICAgICAgICAgICAgICAgICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICMwMGFhZmYsIDAgMCA0MHB4ICMwMDQ0YWE7CiAgICAgICAgICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMzBweDsKICAgICAgICAgICAgICAgICAgICBib3JkZXItYm90dG9tOiAycHggc29saWQgIzAwYWFmZjsKICAgICAgICAgICAgICAgICAgICBwYWRkaW5nLWJvdHRvbTogMTBweDsKICAgICAgICAgICAgICAgICAgICB3aWR0aDogODAlOyB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IDVweDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLm1vZGFsLXNjb3JlLWNvbnRhaW5lciB7CiAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgZ2FwOiA0MHB4OwogICAgICAgICAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDQwcHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAubW9kYWwtc2NvcmUgewogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnSW1wYWN0Jywgc2Fucy1zZXJpZjsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDgwcHg7IGNvbG9yOiAjZmZkNzAwOwogICAgICAgICAgICAgICAgICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1zaGFkb3c6IDAgMCAyMHB4ICNiODg2MGI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAubW9kYWwtdnMgewogICAgICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiAyNHB4OyBjb2xvcjogIzAwYWFmZjsgb3BhY2l0eTogMC43OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC5mbGFzaC1vdmVybGF5IHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7IHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgICAgICAgICAgICAgICAgICB6LWluZGV4OiAyMTAwOwogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IDA7IHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC4xcyBlYXNlLW91dDsKICAgICAgICAgICAgICAgICAgICBtaXgtYmxlbmQtbW9kZTogb3ZlcmxheTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBAa2V5ZnJhbWVzIGNsYXNoUG9wIHsKICAgICAgICAgICAgICAgICAgICAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDAuNSk7IG9wYWNpdHk6IDE7IH0KICAgICAgICAgICAgICAgICAgICA1MCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgxLjUpOyBvcGFjaXR5OiAwLjg7IH0KICAgICAgICAgICAgICAgICAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMi4wKTsgb3BhY2l0eTogMDsgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC5jbGFzaC1zcGFyayB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiA2MHB4OyBoZWlnaHQ6IDYwcHg7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgI2ZmZmZmZiAwJSwgI2ZmZmYwMCA0MCUsIHRyYW5zcGFyZW50IDcwJSk7CiAgICAgICAgICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICAgICAgICAgICAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICAgICAgICAgIHotaW5kZXg6IDE1MDA7CiAgICAgICAgICAgICAgICAgICAgbWl4LWJsZW5kLW1vZGU6IHNjcmVlbjsKICAgICAgICAgICAgICAgICAgICBhbmltYXRpb246IGNsYXNoUG9wIDAuM3MgZWFzZS1vdXQgZm9yd2FyZHM7CiAgICAgICAgICAgICAgICAgICAgYm94LXNoYWRvdzogMCAwIDIwcHggI2ZmYWEwMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKICAgICAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZSk7CiAgICAgICAgfQoKICAgICAgICByZWdpc3RlclRlYW1zKGhvbWVUZWFtLCBhd2F5VGVhbSwgYmFsbCkgewogICAgICAgICAgICB0aGlzLnRlYW1zLmhvbWUgPSBob21lVGVhbTsKICAgICAgICAgICAgdGhpcy50ZWFtcy5hd2F5ID0gYXdheVRlYW07CnRoaXMuZW50aXRpZXMuYmFsbCA9IGJhbGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsaXplIE1pbmlNYXAKICAgICAgICAgICAgaWYgKHRoaXMubWluaU1hcCkgewogICAgICAgICAgICAgICAgdGhpcy5taW5pTWFwLmluaXQoaG9tZVRlYW0sIGF3YXlUZWFtLCBiYWxsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9pbml0VUkoKSB7CiAgICAgICAgICAgIC8vIEJpbmQgdG8gZXhpc3RpbmcgSFRNTCBlbGVtZW50cwogICAgICAgICAgICB0aGlzLnVpLnNjb3JlUGxheWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Njb3JlLXBsYXllcicpOwogICAgICAgICAgICB0aGlzLnVpLnNjb3JlQ3B1ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Njb3JlLWNwdScpOwogICAgICAgICAgICB0aGlzLnVpLnRpbWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RpbWVyLWRpc3BsYXknKTsKICAgICAgICAgICAgdGhpcy51aS5oYWxmID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hhbGYtaW5kaWNhdG9yJyk7CiAgICAgICAgICAgIHRoaXMudWkuYW5ub3VuY2VtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Fubm91bmNlbWVudCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy51aS50ZWNoRmxhc2ggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGVjaC1mbGFzaC1vdmVybGF5Jyk7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoU3ViID0gdGhpcy51aS50ZWNoRmxhc2gucXVlcnlTZWxlY3RvcignLnRlY2gtc3ViLXRleHQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnVpLnRlY2hUaW1lckZpbGwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudGVjaC10aW1lci1maWxsJyk7CgogICAgICAgICAgICAvLyBCaW5kIFBsYXllciBTdGF0dXMgUGFuZWwKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpOwogICAgICAgICAgICB0aGlzLnVpLnN0YXR1c1BhbmVsLm5hbWUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAuY2hhci1uYW1lJyk7CiAgICAgICAgICAgIHRoaXMudWkuc3RhdHVzUGFuZWwuaHBCYXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAuaHAtYmFyLWZpbGwnKTsKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5ocFRleHQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAuaHAtdmFsdWUnKTsKICAgICAgICAgICAgdGhpcy51aS5zdGF0dXNQYW5lbC5leHBCYXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGxheWVyLXN0YXR1cy1wYW5lbCAudGVjaC1iYXItZmlsbCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5kIEdhbWUgTWVudSBCaW5kaW5ncwogICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLWdhbWUtbWVudScpOwogICAgICAgICAgICBjb25zdCBidG5SZW1hdGNoID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1idG4tcmVtYXRjaCcpOwogICAgICAgICAgICBjb25zdCBidG5FeGl0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZC1idG4tZXhpdCcpOwoKICAgICAgICAgICAgaWYgKGJ0blJlbWF0Y2gpIHsKICAgICAgICAgICAgICAgIGJ0blJlbWF0Y2guYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZUVuZE1lbnUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0TWF0Y2godGhpcy5nYW1lTW9kZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYnRuRXhpdCkgewogICAgICAgICAgICAgICAgYnRuRXhpdC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlRW5kTWVudSgpOwogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLm1lbnVNYW5hZ2VyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdtZW51JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ3JlYXRlIE1vZGFsIE92ZXJsYXkgKEZvciBIYWxmdGltZSBvbmx5IG5vdykKICAgICAgICAgICAgdGhpcy51aS5tb2RhbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTmFtZSA9ICdtb2RhbC1vdmVybGF5JzsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5pbm5lckhUTUwgPSBgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC10aXRsZSI+SEFMRiBUSU1FPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC1zY29yZS1jb250YWluZXIiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXNjb3JlIiBpZD0ibW9kYWwtc2NvcmUtaG9tZSI+MDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLXZzIj4tPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtc2NvcmUiIGlkPSJtb2RhbC1zY29yZS1hd2F5Ij4wPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgaWQ9Im1vZGFsLW1zZyIgc3R5bGU9ImNvbG9yOiAjMDBhYWZmOyBmb250LXNpemU6IDE0cHg7IGxldHRlci1zcGFjaW5nOiAycHg7Ij5QUkVQQVJJTkcgMk5EIEhBTEYuLi48L2Rpdj4KICAgICAgICAgICAgYDsKICAgICAgICAgICAgdGhpcy51aUxheWVyLmFwcGVuZENoaWxkKHRoaXMudWkubW9kYWwpOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIEZsYXNoIE92ZXJsYXkKICAgICAgICAgICAgdGhpcy51aS5mbGFzaCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0aGlzLnVpLmZsYXNoLmNsYXNzTmFtZSA9ICdmbGFzaC1vdmVybGF5JzsKICAgICAgICAgICAgdGhpcy51aUxheWVyLmFwcGVuZENoaWxkKHRoaXMudWkuZmxhc2gpOwoKICAgICAgICAgICAgLy8gSW5pdGlhbCBTdGF0ZQogICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRpbWVyKSB0aGlzLnVpLnRpbWVyLmlubmVyVGV4dCA9ICIwMDowMCI7CiAgICAgICAgfQogICAgICAgIF91cGRhdGVTY29yZVVJKCkgewogICAgICAgICAgICBpZiAodGhpcy51aS5zY29yZVBsYXllcikgdGhpcy51aS5zY29yZVBsYXllci5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnNjb3JlQ3B1KSB0aGlzLnVpLnNjb3JlQ3B1LmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuYXdheTsKICAgICAgICB9Cgp1cGRhdGVQcmFjdGljZShkdCkgewogICAgICAgICAgICAvLyBEZWxlZ2F0ZSBsb2dpYyB0byBQcmFjdGljZU1hbmFnZXIKICAgICAgICAgICAgaWYgKHRoaXMucHJhY3RpY2VNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLnByYWN0aWNlTWFuYWdlci51cGRhdGUoZHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIC8vIC0tLSBQSFlTSUNTICYgTE9HSUMgVVBEQVRFIChGaXhlZCBUaW1lc3RlcCkgLS0tCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbnRybyAmIE1lbnUgYXJlIHB1cmVseSB2aXN1YWwgc3RhdGVzLCBoYW5kbGVkIGluIHVwZGF0ZVZpc3VhbHMKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdpbnRybycgfHwgdGhpcy5zdGF0ZSA9PT0gJ21lbnUnKSByZXR1cm47CgogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2JsaXR6X2NoYXJnZScpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUJsaXR6Q2hhcmdlKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gJ2JsaXR6X2xhdW5jaCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUJsaXR6TGF1bmNoKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdhY3RpdmUnKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVUaW1lcigpOwogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tIYWxmVGltZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9jaGVja0dvYWxzKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVGVjaGNvcHkgTG9naWMgKFRpbWVyKQogICAgICAgICAgICBpZiAodGhpcy50ZWNoQ29weVN0YXRlLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLnRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmRUZWNoQ29weVdpbmRvdyhmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgLy8gLS0tIFZJU1VBTCBVUERBVEUgKE9uY2UgUGVyIEZyYW1lKSAtLS0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnaW50cm8nKSB7CiAgICAgICAgICAgICAgICAvLyBQbGF5ZXIgV2FybXVwIEFuaW1hdGlvbnMKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUludHJvV2FybXVwKGR0KTsKCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaW50cm9TaG90cyB8fCB0aGlzLmludHJvU2hvdHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5za2lwSW50cm8oKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3Qgc2hvdCA9IHRoaXMuaW50cm9TaG90c1t0aGlzLmludHJvU2hvdEluZGV4XTsKICAgICAgICAgICAgICAgIHRoaXMuaW50cm9TaG90VGltZXIgKz0gZHQ7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuaW50cm9TaG90VGltZXIgPj0gc2hvdC5kdXJhdGlvbikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaW50cm9TaG90SW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmludHJvU2hvdFRpbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnRyb1Nob3RJbmRleCA+PSB0aGlzLmludHJvU2hvdHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2tpcEludHJvKCk7IC8vIERvbmUKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5leHQgc2hvdCBzdGFydAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXh0U2hvdCA9IHRoaXMuaW50cm9TaG90c1t0aGlzLmludHJvU2hvdEluZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5leHRTaG90Lm9uU3RhcnQpIG5leHRTaG90Lm9uU3RhcnQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBjdXJyZW50IHNob3QKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gdGhpcy5pbnRyb1Nob3RUaW1lciAvIHNob3QuZHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhICYmIHNob3QudXBkYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3QudXBkYXRlKHQsIHRoaXMuY2FtZXJhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlID09PSAnbWVudScpIHsKICAgICAgICAgICAgICAgIC8vIC0tLSBQT1BVTEFURSBBUkVOQSBGT1IgQi1ST0xMIC0tLQogICAgICAgICAgICAgICAgY29uc3QgYW5pbWF0ZVRlYW0gPSAodGVhbSkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICghdGVhbSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIHRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBHZW50bGUgYm9iYmluZyB0byBzaW11bGF0ZSB0cmVhZGluZyB3YXRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSBwLmhvbWVQb3NpdGlvbi55ICsgTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDAyICsgcC5tZXNoLmlkKSAqIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBpZGxlIGFuaW1hdGlvbiBpcyBwbGF5aW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0ZSAhPT0gJ2lkbGUnKSBwLnBsYXkoJ2lkbGUnLCAwLjUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAubWl4ZXIpIHAubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGFuaW1hdGVUZWFtKHRoaXMudGVhbXMuaG9tZSk7CiAgICAgICAgICAgICAgICBhbmltYXRlVGVhbSh0aGlzLnRlYW1zLmF3YXkpOwoKICAgICAgICAgICAgICAgIC8vIC0tLSBDSU5FTUFUSUMgQi1ST0xMIC0tLQogICAgICAgICAgICAgICAgaWYgKHRoaXMubWVudVNob3RzICYmIHRoaXMubWVudVNob3RzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzaG90ID0gdGhpcy5tZW51U2hvdHNbdGhpcy5tZW51U2hvdEluZGV4XTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lbnVTaG90VGltZXIgKz0gZHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubWVudVNob3RUaW1lciA+PSBzaG90LmR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVudVNob3RUaW1lciA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVudVNob3RJbmRleCA9ICh0aGlzLm1lbnVTaG90SW5kZXggKyAxKSAlIHRoaXMubWVudVNob3RzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gTm9ybWFsaXplIHRpbWUgKDAgdG8gMSkKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ID0gdGhpcy5tZW51U2hvdFRpbWVyIC8gc2hvdC5kdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvdC51cGRhdGUodCwgdGhpcy5jYW1lcmEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBbWJpZW50IEZYIGluIE1lbnUKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlciAmJiBNYXRoLnJhbmRvbSgpIDwgMC4yKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFuZ2UgPSA2MDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSpyYW5nZSwgCiAgICAgICAgICAgICAgICAgICAgICAgIC0xMCArIE1hdGgucmFuZG9tKCkqMjAsIAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKnJhbmdlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignYnViYmxlJywgcG9zLCB7IGxpZmU6IDMuMCArIE1hdGgucmFuZG9tKCkqMi4wLCBzY2FsZTogMC4zICsgTWF0aC5yYW5kb20oKSowLjQgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVXBkYXRlIEJhY2tncm91bmQgU3lzdGVtcwogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB0aGlzLnBhcnRpY2xlTWFuYWdlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgVGVjaGNvcHkgVUkKICAgICAgICAgICAgaWYgKHRoaXMudGVjaENvcHlTdGF0ZS5hY3RpdmUgJiYgdGhpcy51aS50ZWNoVGltZXJGaWxsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwY3QgPSBNYXRoLm1heCgwLCAodGhpcy50ZWNoQ29weVN0YXRlLnRpbWVyIC8gdGhpcy50ZWNoQ29weVN0YXRlLm1heFRpbWUpICogMTAwKTsKICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9IGAke3BjdH0lYDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ29sb3Igc2hpZnQgYmFzZWQgb24gdXJnZW5jeQogICAgICAgICAgICAgICAgaWYgKHBjdCA8IDMwKSB0aGlzLnVpLnRlY2hUaW1lckZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICcjZmYwMDAwJzsKICAgICAgICAgICAgICAgIGVsc2UgdGhpcy51aS50ZWNoVGltZXJGaWxsLnN0eWxlLmJhY2tncm91bmQgPSAnbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjZmZmZmZmLCAjMDBmZmZmKSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEdlbmVyYWwgVmlzdWFscyAoQWx3YXlzIFJ1biBleGNlcHQgSW50cm8vTWVudSkKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdtZW51JyAmJiB0aGlzLnN0YXRlICE9PSAnaW50cm8nKSB7CiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgYmFuZCBwb3NzZXNzaW9uIGRpc3BsYXkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC51cGRhdGVCYW5kUG9zc2Vzc2lvbiAmJiB0aGlzLmVudGl0aWVzICYmIHRoaXMuZW50aXRpZXMuYmFsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaG9tZUhhc0JhbGwgPSBiYWxsLmhvbGRlciAmJiBiYWxsLmhvbGRlci50ZWFtICYmIGJhbGwuaG9sZGVyLnRlYW0uaXNIdW1hbjsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC51cGRhdGVCYW5kUG9zc2Vzc2lvbihob21lSGFzQmFsbCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMubWluaU1hcCkgdGhpcy5taW5pTWFwLnVwZGF0ZSgpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZmxvYXRpbmdUZXh0KSB0aGlzLmZsb2F0aW5nVGV4dC51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyKSB0aGlzLnBhcnRpY2xlTWFuYWdlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFydGljbGVzKGR0KTsgLy8gTGVnYWN5IHNwYXJrcwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlR29hbFRyYW5zcGFyZW5jeSgpOyAvLyBEeW5hbWljIEdvYWwgRmFkaW5nCiAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWJ1Z1Zpc3VhbGl6ZXIpIHRoaXMuZGVidWdWaXN1YWxpemVyLnVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlR29hbFRyYW5zcGFyZW5jeSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmNhbWVyYSkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZ29hbHMgPSBbd2luZG93LmZsdXguZ29hbEEsIHdpbmRvdy5mbHV4LmdvYWxCXTsKICAgICAgICAgICAgY29uc3QgZmFkZURpc3QgPSAzNS4wOyAvLyBEaXN0YW5jZSB0byBzdGFydCBmYWRpbmcKICAgICAgICAgICAgY29uc3QgbWluRmFkZURpc3QgPSAxNS4wOyAvLyBEaXN0YW5jZSB3aGVyZSBpdCdzIG1vc3QgdHJhbnNwYXJlbnQKICAgICAgICAgICAgY29uc3QgbWluT3BhY2l0eSA9IDAuMjsKCiAgICAgICAgICAgIGdvYWxzLmZvckVhY2goZ29hbCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWdvYWwpIHJldHVybjsKCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlzdGFuY2UgZnJvbSBjYW1lcmEgdG8gZ29hbCBwb3NpdGlvbgogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMuY2FtZXJhLnBvc2l0aW9uLmRpc3RhbmNlVG8oZ29hbC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBvcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCBmYWRlRGlzdCkgewogICAgICAgICAgICAgICAgICAgIC8vIExpbmVhciBmYWRlCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdCA9IChkaXN0IC0gbWluRmFkZURpc3QpIC8gKGZhZGVEaXN0IC0gbWluRmFkZURpc3QpOwogICAgICAgICAgICAgICAgICAgIG9wYWNpdHkgPSBUSFJFRS5NYXRoVXRpbHMuY2xhbXAodCwgMC4wLCAxLjApICogKDEuMCAtIG1pbk9wYWNpdHkpICsgbWluT3BhY2l0eTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCBpc1RyYW5zcGFyZW50ID0gb3BhY2l0eSA8IDAuOTk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgdG8gYWxsIG1lc2hlcyBpbiBnb2FsIGhpZXJhcmNoeQogICAgICAgICAgICAgICAgZ29hbC50cmF2ZXJzZShjaGlsZCA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLmlzTWVzaCAmJiBjaGlsZC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXQgPSBjaGlsZC5tYXRlcmlhbDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgdXBkYXRlIGlmIGNoYW5nZWQgdG8gbWluaW1pemUgb3ZlcmhlYWQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKG1hdC5vcGFjaXR5IC0gb3BhY2l0eSkgPiAwLjAxIHx8IG1hdC50cmFuc3BhcmVudCAhPT0gaXNUcmFuc3BhcmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Lm9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0LnRyYW5zcGFyZW50ID0gaXNUcmFuc3BhcmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIERpc2FibGUgZGVwdGhXcml0ZSB3aGVuIHRyYW5zcGFyZW50IHNvIHdlIGNhbiBzZWUgdGhlIGJhbGwgaW5zaWRlIHRoZSBuZXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdC5kZXB0aFdyaXRlID0gIWlzVHJhbnNwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXQubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwp9CiAgICAgICAgX3VwZGF0ZU9mZnNjcmVlbkluZGljYXRvcigpIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMudGVhbXMuaG9tZSA/IHRoaXMudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXIgOiBudWxsOwogICAgICAgICAgICBjb25zdCBpbmRpY2F0b3IgPSB0aGlzLnVpLm9mZnNjcmVlbkluZGljYXRvcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghcCB8fCAhcC5tZXNoIHx8ICF0aGlzLmNhbWVyYSB8fCAhaW5kaWNhdG9yKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBHZXQgUGxheWVyIFBvc2l0aW9uIChDZW50ZXIgTWFzcykKICAgICAgICAgICAgY29uc3QgcG9zID0gcC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgIHBvcy55ICs9IDEuMDsgCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAyLiBQcm9qZWN0IHRvIE5vcm1hbGl6ZWQgRGV2aWNlIENvb3JkaW5hdGVzIChOREMpIFstMSwgMV0KICAgICAgICAgICAgdGhpcy5fdGVtcFZlYy5jb3B5KHBvcykucHJvamVjdCh0aGlzLmNhbWVyYSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBDaGVjayBpZiBCZWhpbmQgQ2FtZXJhCiAgICAgICAgICAgIGNvbnN0IGNhbUZ3ZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKGNhbUZ3ZCk7CiAgICAgICAgICAgIGNvbnN0IHRvUGxheWVyID0gcG9zLmNsb25lKCkuc3ViKHRoaXMuY2FtZXJhLnBvc2l0aW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgY29uc3QgZG90ID0gY2FtRndkLmRvdCh0b1BsYXllcik7CiAgICAgICAgICAgIGNvbnN0IGlzQmVoaW5kID0gZG90IDwgMC4yOyAvLyBCdWZmZXIgdG8gcHJldmVudCBmbGlwcGluZyBhdCBlZGdlCgogICAgICAgICAgICAvLyA0LiBDaGVjayBCb3VuZHMKICAgICAgICAgICAgY29uc3QgaXNPZmZTY3JlZW4gPSAoCiAgICAgICAgICAgICAgICB0aGlzLl90ZW1wVmVjLnggPCAtMC45IHx8IHRoaXMuX3RlbXBWZWMueCA+IDAuOSB8fAogICAgICAgICAgICAgICAgdGhpcy5fdGVtcFZlYy55IDwgLTAuOSB8fCB0aGlzLl90ZW1wVmVjLnkgPiAwLjkgfHwKICAgICAgICAgICAgICAgIGlzQmVoaW5kCiAgICAgICAgICAgICk7CgogICAgICAgICAgICBpZiAoaXNPZmZTY3JlZW4pIHsKICAgICAgICAgICAgICAgIGluZGljYXRvci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHggPSB0aGlzLl90ZW1wVmVjLng7CiAgICAgICAgICAgICAgICBsZXQgeSA9IHRoaXMuX3RlbXBWZWMueTsKCiAgICAgICAgICAgICAgICAvLyBJZiBiZWhpbmQsIGludmVydCBjb29yZGluYXRlcyB0byBwb2ludCBjb3JyZWN0bHkKICAgICAgICAgICAgICAgIGlmIChpc0JlaGluZCkgewogICAgICAgICAgICAgICAgICAgIHggPSAteDsKICAgICAgICAgICAgICAgICAgICB5ID0gLXk7CiAgICAgICAgICAgICAgICAgICAgLy8gRml4IHNpbmd1bGFyaXR5IGlmIGV4YWN0bHkgYmVoaW5kIGNlbnRlcgogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyh4KSA8IDAuMDEgJiYgTWF0aC5hYnMoeSkgPCAwLjAxKSB5ID0gLTE7IAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENsYW1wIHRvIHNjcmVlbiBlZGdlcwogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCB0byBmaW5kIHRoZSBpbnRlcnNlY3Rpb24gb2YgdGhlIHZlY3RvciAoeCx5KSB3aXRoIHRoZSBib3ggWy0wLjksIDAuOV0KICAgICAgICAgICAgICAgIGNvbnN0IHBhZGRpbmcgPSAwLjk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSB0byBnZXQgZGlyZWN0aW9uCiAgICAgICAgICAgICAgICBjb25zdCBtYWcgPSBNYXRoLnNxcnQoeCp4ICsgeSp5KTsKICAgICAgICAgICAgICAgIGNvbnN0IG54ID0geCAvIG1hZzsKICAgICAgICAgICAgICAgIGNvbnN0IG55ID0geSAvIG1hZzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmF5Y2FzdCB0byBib3ggZWRnZXMKICAgICAgICAgICAgICAgIC8vIFZlcnRpY2FsIGVkZ2VzOiB4ID0gKy8tIHBhZGRpbmcKICAgICAgICAgICAgICAgIC8vIEhvcml6b250YWwgZWRnZXM6IHkgPSArLy0gcGFkZGluZwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBdm9pZCBkaXZpZGUgYnkgemVybwogICAgICAgICAgICAgICAgY29uc3QgdHggPSAoTWF0aC5hYnMobngpID4gMC4wMDEpID8gKG54ID4gMCA/IHBhZGRpbmcgOiAtcGFkZGluZykgLyBueCA6IDk5OTsKICAgICAgICAgICAgICAgIGNvbnN0IHR5ID0gKE1hdGguYWJzKG55KSA+IDAuMDAxKSA/IChueSA+IDAgPyBwYWRkaW5nIDogLXBhZGRpbmcpIC8gbnkgOiA5OTk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFVzZSB0aGUgbmVhcmVzdCBpbnRlcnNlY3Rpb24gKHNtYWxsZXN0IHBvc2l0aXZlIHQpCiAgICAgICAgICAgICAgICAvLyBTaW5jZSB3ZSBhcmUgcHJvamVjdGluZyBmcm9tIGNlbnRlciAoMCwwKSB0byAobngsbnkpLCB0IG11c3QgYmUgcG9zaXRpdmUuCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gTWF0aC5taW4oTWF0aC5hYnModHgpLCBNYXRoLmFicyh0eSkpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBzY3JlZW5YID0gbnggKiB0OwogICAgICAgICAgICAgICAgY29uc3Qgc2NyZWVuWSA9IG55ICogdDsKCiAgICAgICAgICAgICAgICAvLyBDb252ZXJ0IE5EQyB0byBQaXhlbHMKICAgICAgICAgICAgICAgIGNvbnN0IHdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBoZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHB4ID0gKHNjcmVlblggKiAwLjUgKyAwLjUpICogd2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBweSA9ICgtKHNjcmVlblkpICogMC41ICsgMC41KSAqIGhlaWdodDsKCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgUm90YXRpb24KICAgICAgICAgICAgICAgIC8vIEFycm93IHBvaW50cyBVUCBieSBkZWZhdWx0LgogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCBpdCB0byBwb2ludCBpbiBkaXJlY3Rpb24gKG54LCBueSkgb24gc2NyZWVuLgogICAgICAgICAgICAgICAgLy8gU2NyZWVuIFkgaXMgZG93biAoaW52ZXJ0ZWQgZnJvbSBXZWJHTCBZKS4KICAgICAgICAgICAgICAgIC8vIFNvICgwLCAxKSBpbiBOREMgaXMgVVAuICgwLCAtMSkgaW4gTkRDIGlzIERPV04uCiAgICAgICAgICAgICAgICAvLyBhdGFuMih5LCB4KSBnaXZlcyBhbmdsZSBmcm9tICtYLgogICAgICAgICAgICAgICAgLy8gV2Ugd2FudCBhbmdsZSBmcm9tICtZIChVcCkuCiAgICAgICAgICAgICAgICAvLyBSb3RhdGlvbiA9IFBJLzIgLSBhbmdsZS4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKG55LCBueCk7CiAgICAgICAgICAgICAgICBjb25zdCByb3QgPSAoTWF0aC5QSSAvIDIpIC0gYW5nbGU7CgogICAgICAgICAgICAgICAgaW5kaWNhdG9yLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHtweH1weCwgJHtweX1weCkgcm90YXRlKCR7cm90fXJhZClgOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgaW5kaWNhdG9yLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVUaW1lcigpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnVpLnRpbWVyKSByZXR1cm47CiAgICAgICAgICAgIC8vIENsYW1wIHRvIGhhbGYgZHVyYXRpb24gZm9yIGRpc3BsYXkgaWYgd2UgZ28gc2xpZ2h0bHkgb3ZlciBiZWZvcmUgdGljawogICAgICAgICAgICBjb25zdCB0ID0gTWF0aC5taW4odGhpcy50aW1lLCB0aGlzLmhhbGZEdXJhdGlvbik7CiAgICAgICAgICAgIGNvbnN0IG1pbnV0ZXMgPSBNYXRoLmZsb29yKHQgLyA2MCk7CiAgICAgICAgICAgIGNvbnN0IHNlY29uZHMgPSBNYXRoLmZsb29yKHQgJSA2MCk7CiAgICAgICAgICAgIHRoaXMudWkudGltZXIuaW5uZXJUZXh0ID0gYCR7bWludXRlcy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9OiR7c2Vjb25kcy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9YDsKICAgICAgICB9CiAgICAgICAgX2NoZWNrSGFsZlRpbWUoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnRpbWUgPj0gdGhpcy5oYWxmRHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5kSGFsZigpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKZW5kSGFsZigpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdoYWxmdGltZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdG9wIGFsbCBwbGF5ZXJzCiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGFsZiA9PT0gMSkgewogICAgICAgICAgICAgICAgdGhpcy5fc2hvd01vZGFsKCJIQUxGIFRJTUUiLCAiUFJFUEFSSU5HIDJORCBIQUxGLi4uIik7CiAgICAgICAgICAgICAgICAKLy8gT3B0aW9uYWw6IFBsYXkgd2hpc3RsZSBzb3VuZCBoZXJlIGlmIGF2YWlsYWJsZQogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCd3aGlzdGxlJyk7CgogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZU1vZGFsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydFNlY29uZEhhbGYoKTsKICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRW5kIG9mIDJuZCBIYWxmIG9yIE92ZXJ0aW1lIFBlcmlvZAogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuaG9tZSA9PT0gdGhpcy5zY29yZS5hd2F5KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVElFRCAtIEdvIHRvIE92ZXJ0aW1lIChHb2xkZW4gR29hbCkKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93TW9kYWwoIk9WRVJUSU1FIiwgIkdPTERFTiBHT0FMIFJVTEUgQUNUSVZFIik7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVNb2RhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0T3ZlcnRpbWUoKTsKICAgICAgICAgICAgICAgICAgICB9LCA0MDAwKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV2lubmVyIGRlY2lkZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZEdhbWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3RhcnRTZWNvbmRIYWxmKCkgewogICAgICAgICAgICB0aGlzLmhhbGYgPSAyOwogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYuaW5uZXJUZXh0ID0gIjJuZCBIQUxGIjsKICAgICAgICAgICAgdGhpcy5yZXNldFJvdW5kKG51bGwpOyAvLyBOZXV0cmFsIEJsaXR6LW9mZiBmb3IgMm5kIGhhbGYgc3RhcnQKICAgICAgICB9CgogICAgICAgIHN0YXJ0T3ZlcnRpbWUoKSB7CiAgICAgICAgICAgIHRoaXMuaGFsZisrOwogICAgICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgICAgICB0aGlzLmlzT3ZlcnRpbWUgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnVpLmhhbGYuaW5uZXJUZXh0ID0gIk9WRVJUSU1FIjsKICAgICAgICAgICAgdGhpcy5yZXNldFJvdW5kKG51bGwpOyAvLyBOZXV0cmFsIEJsaXR6LW9mZgogICAgICAgIH0KCmVuZEdhbWUoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnZ2FtZW92ZXInOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcCBwbGF5ZXJzCiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiBwLnNldElucHV0KDAsIDApKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwoKICAgICAgICAgICAgbGV0IG1zZyA9ICJEUkFXIjsKICAgICAgICAgICAgaWYgKHRoaXMuc2NvcmUuaG9tZSA+IHRoaXMuc2NvcmUuYXdheSkgbXNnID0gIlZJQ1RPUlkiOwogICAgICAgICAgICBpZiAodGhpcy5zY29yZS5hd2F5ID4gdGhpcy5zY29yZS5ob21lKSBtc2cgPSAiREVGRUFUIjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBvcHVsYXRlIEVuZCBHYW1lIE1lbnUKICAgICAgICAgICAgaWYgKHRoaXMudWkuZW5kTWVudSkgewogICAgICAgICAgICAgICAgY29uc3QgdGl0bGVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtcmVzdWx0LXRpdGxlJyk7CiAgICAgICAgICAgICAgICBjb25zdCBob21lU2NvcmVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtc2NvcmUtaG9tZScpOwogICAgICAgICAgICAgICAgY29uc3QgYXdheVNjb3JlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLXNjb3JlLWF3YXknKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRpdGxlRWwpIHsKICAgICAgICAgICAgICAgICAgICB0aXRsZUVsLmlubmVyVGV4dCA9IG1zZzsKICAgICAgICAgICAgICAgICAgICB0aXRsZUVsLnN0eWxlLmNvbG9yID0gKG1zZyA9PT0gIlZJQ1RPUlkiKSA/ICIjMDBmZmZmIiA6ICgobXNnID09PSAiREVGRUFUIikgPyAiI2ZmNDQ0NCIgOiAiI2ZmZmZmZiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGhvbWVTY29yZUVsKSBob21lU2NvcmVFbC5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgICAgICBpZiAoYXdheVNjb3JlRWwpIGF3YXlTY29yZUVsLmlubmVyVGV4dCA9IHRoaXMuc2NvcmUuYXdheTsKCiAgICAgICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1lbnVNb2RlKHRydWUpOyAvLyBIaWRlIEhVRAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdG9wIE11c2ljIG9uIEdhbWUgT3ZlcgogICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnN0b3BCR00oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVFbmRNZW51KCkgewogICAgICAgICAgICBpZiAodGhpcy51aS5lbmRNZW51KSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmVuZE1lbnUuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1lbnVNb2RlKGZhbHNlKTsgLy8gU2hvdyBIVUQKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3Nob3dNb2RhbCh0aXRsZSwgc3VidGV4dCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkubW9kYWwpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignLm1vZGFsLXRpdGxlJykuaW5uZXJUZXh0ID0gdGl0bGU7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLXNjb3JlLWhvbWUnKS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmhvbWU7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLXNjb3JlLWF3YXknKS5pbm5lclRleHQgPSB0aGlzLnNjb3JlLmF3YXk7CiAgICAgICAgICAgIHRoaXMudWkubW9kYWwucXVlcnlTZWxlY3RvcignI21vZGFsLW1zZycpLmlubmVyVGV4dCA9IHN1YnRleHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnVpLm1vZGFsLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBIVUQgZWxlbWVudHMKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2h1ZC10b3AnKS5zdHlsZS5vcGFjaXR5ID0gJzAnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXN0YXR1cy1wYW5lbCcpLnN0eWxlLm9wYWNpdHkgPSAnMCc7CiAgICAgICAgfQoKICAgICAgICBfaGlkZU1vZGFsKCkgewogICAgICAgICAgICBpZiAoIXRoaXMudWkubW9kYWwpIHJldHVybjsKICAgICAgICAgICAgdGhpcy51aS5tb2RhbC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNob3cgSFVEIGVsZW1lbnRzCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdodWQtdG9wJykuc3R5bGUub3BhY2l0eSA9ICcxJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BsYXllci1zdGF0dXMtcGFuZWwnKS5zdHlsZS5vcGFjaXR5ID0gJzEnOwogICAgICAgIH0KCl9jaGVja0dvYWxzKCkgewogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoIWJhbGwgfHwgIWJhbGwubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgcG9zID0gYmFsbC5tZXNoLnBvc2l0aW9uOwoKICAgICAgICAgICAgLy8gUHJlY2lzZSBHb2FsIERldGVjdGlvbgogICAgICAgICAgICAvLyBWaXN1YWwgR29hbCBpcyBhdCBaID0gKy8tIDI4LgogICAgICAgICAgICAvLyBXZSBkZWZpbmUgYSAiR29hbCBNb3V0aCIgYm94IG1hdGNoaW5nIEdvYWxpZS5qcyAoV2lkdGggMTQsIEhlaWdodCA4KS4KLy8gV2UgZGVmaW5lIGEgIkdvYWwgTW91dGgiIGJveCBtYXRjaGluZyB0aGUgdmlzdWFsIG5ldC4KICAgICAgICAgICAgLy8gQXJlbmEgUmFkaXVzIGlzIDMyLiBHb2FsIGlzIHJvdWdobHkgMjJtIHdpZGUsIDE4bSBoaWdoLgovLyBBcmVuYSBSYWRpdXMgaXMgMzIuIEdvYWwgaXMgcm91Z2hseSAyMm0gd2lkZSwgMThtIGhpZ2guCiAgICAgICAgICAgIGNvbnN0IGhhbGZXaWR0aCA9IDExLjA7IC8vIEluY3JlYXNlZCB0byAxMSAoV2lkdGggMjIpIHRvIGNhdGNoIGNvcm5lcnMKICAgICAgICAgICAgY29uc3QgaGFsZkhlaWdodCA9IDkuMDsgLy8gSW5jcmVhc2VkIHRvIDkgKEhlaWdodCAxOCkgdG8gY2F0Y2ggaGlnaCBzaG90cwpjb25zdCBnb2FsWU9mZnNldCA9IC02LjA7IC8vIE1vdmVkIGRvd24gdG8gbWF0Y2ggdmlzdWFsIG1vZGVsICgtNi4wbSkKCmNvbnN0IHRyaWdnZXJaID0gNDAuNTsgLy8gVHJpZ2dlciBlYXJsaWVyICh3YXMgNDMuNSkgdG8gZW5zdXJlIHJlZ2lzdHJhdGlvbiBiZWZvcmUgYm91bmNlCgogICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLnopID4gdHJpZ2dlclopIHsKICAgICAgICAgICAgICAgIC8vIFBSRVZFTlQgT1dOIEdPQUwgQlkgQ0FSUklFUiAoVXNlciBSZXF1ZXN0KQogICAgICAgICAgICAgICAgLy8gSWYgdGhlIGJhbGwgaXMgaGVsZCBieSB0aGUgdGVhbSBkZWZlbmRpbmcgdGhpcyBnb2FsLCBkbyBub3QgY291bnQgaXQuCiAgICAgICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIb21lIChTaWRlIDEpIGRlZmVuZHMgK1ouIElmIHBvcy56ID4gMCAoSG9tZSBHb2FsKSBhbmQgaG9sZGVyIGlzIEhvbWUsIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPiAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gMSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIC8vIEF3YXkgKFNpZGUgLTEpIGRlZmVuZHMgLVouIElmIHBvcy56IDwgMCAoQXdheSBHb2FsKSBhbmQgaG9sZGVyIGlzIEF3YXksIGlnbm9yZS4KICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwICYmIGJhbGwuaG9sZGVyLnRlYW0uc2lkZSA9PT0gLTEpIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyLiBDaGVjayBGcmFtZSAoTXVzdCBiZSB3aXRoaW4gd2lkdGgvaGVpZ2h0KQovLyAyLiBDaGVjayBGcmFtZSAoTXVzdCBiZSB3aXRoaW4gd2lkdGgvaGVpZ2h0LCBhY2NvdW50aW5nIGZvciBZIG9mZnNldCkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwb3MueCkgPD0gaGFsZldpZHRoICYmIE1hdGguYWJzKHBvcy55IC0gZ29hbFlPZmZzZXQpIDw9IGhhbGZIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ29hbFNjb3JlZCgnaG9tZScpOyAvLyBIb21lIGF0dGFja3MgLVoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdvYWxTY29yZWQoJ2F3YXknKTsgLy8gQXdheSBhdHRhY2tzICtaCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKZ29hbFNjb3JlZChzY29yZXIpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJTVBBQ1QgRlJBTUU6IEdPQUwKICAgICAgICAgICAgdGhpcy50cmlnZ2VySW1wYWN0KDAuNCwgJ3NoYXR0ZXInKTsgLy8gTWFzc2l2ZSBmcmVlemUgZm9yIGdvYWwKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVYUCBSRVdBUkQ6IEdvYWwKICAgICAgICAgICAgLy8gRmluZCB3aG8gc2NvcmVkIChMYXN0IGhvbGRlciBvZiBiYWxsKQogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLmxhc3RIb2xkZXIgJiYgYmFsbC5sYXN0SG9sZGVyLnRlYW0uaWQgPT09IHNjb3JlcikgewogICAgICAgICAgICAgICAgYmFsbC5sYXN0SG9sZGVyLmdhaW5FeHAoMTApOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2dvYWwnOwogICAgICAgICAgICB0aGlzLnNjb3JlW3Njb3Jlcl0rKzsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gMS4gVklTQ0VSQUwgU0hBS0UgJiBQQVJUSUNMRVMKICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDIuMCk7IC8vIEhlYXZ5IHNoYWtlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIHRoaXMuZW50aXRpZXMuYmFsbCAmJiB0aGlzLmVudGl0aWVzLmJhbGwubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgZ29hbFBvcyA9IHRoaXMuZW50aXRpZXMuYmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAvLyBNYXNzaXZlIEdvYWwgRXhwbG9zaW9uCiAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgZ29hbFBvcywgeyBzY2FsZTogMTUuMCwgbGlmZTogMC44IH0pOwogICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgZ29hbFBvcywgeyBzY2FsZTogMTAuMCB9KTsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDMwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGVicmlzJywgZ29hbFBvcywgeyBzY2FsZTogMC44IH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIDIuIFNDUkVFTiBGTEFTSAogICAgICAgICAgICBpZiAodGhpcy51aS5mbGFzaCkgewogICAgICAgICAgICAgICAgdGhpcy51aS5mbGFzaC5zdHlsZS5vcGFjaXR5ID0gJzAuOCc7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy51aS5mbGFzaC5zdHlsZS5vcGFjaXR5ID0gJzAnOyB9LCAxMDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBHT0xERU4gR09BTCBDSEVDSwogICAgICAgICAgICBpZiAodGhpcy5pc092ZXJ0aW1lKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dBbm5vdW5jZW1lbnQoIkdPTERFTiBHT0FMISIsICdzbGFtJyk7CiAgICAgICAgICAgICAgICAvLyBFbmQgZ2FtZSBhZnRlciBzaG9ydCBkZWxheQogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmRHYW1lKCk7CiAgICAgICAgICAgICAgICB9LCAzMDAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNC4gU0xBTSBBTk5PVU5DRU1FTlQgKE5vcm1hbCkKLy8gNC4gU0xBTSBBTk5PVU5DRU1FTlQgKE5vcm1hbCkKICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJHT0FMISIsICdzbGFtJyk7CiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZ29hbCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgc2VxdWVuY2UKICAgICAgICAgICAgLy8gU2NvcmVkLXVwb24gdGVhbSBnZXRzIGJhbGwKICAgICAgICAgICAgY29uc3QgbG9zZXIgPSBzY29yZXIgPT09ICdob21lJyA/ICdhd2F5JyA6ICdob21lJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZBU1RFUiBGTE9XOiBSZWR1Y2VkIGRlbGF5IGZyb20gMzAwMG1zIHRvIDEyMDBtcwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChsb3Nlcik7CiAgICAgICAgICAgIH0sIDIwMDApOyAvLyBTbGlnaHRseSBsb25nZXIgdG8gYXBwcmVjaWF0ZSB0aGUgIkdPQUwiIHNsYW0KICAgICAgICB9CgpzaG93QW5ub3VuY2VtZW50KHRleHQsIHR5cGUgPSAnbm9ybWFsJywgZHVyYXRpb24gPSAyMDAwKSB7CiAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5hbm5vdW5jZW1lbnQ7CiAgICAgICAgICAgIGlmICghZWwpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENsZWFyIHByZXZpb3VzIHRpbWVvdXQKICAgICAgICAgICAgaWYgKHRoaXMuX2Fubm91bmNlVGltZW91dCkgewogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX2Fubm91bmNlVGltZW91dCk7CiAgICAgICAgICAgICAgICB0aGlzLl9hbm5vdW5jZVRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBBbmltYXRpb24gYnkgY2xvbmluZwogICAgICAgICAgICBjb25zdCBuZXdFbCA9IGVsLmNsb25lTm9kZSh0cnVlKTsKICAgICAgICAgICAgZWwucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQobmV3RWwsIGVsKTsKICAgICAgICAgICAgdGhpcy51aS5hbm5vdW5jZW1lbnQgPSBuZXdFbDsKCiAgICAgICAgICAgIG5ld0VsLmlubmVyVGV4dCA9IHRleHQ7CiAgICAgICAgICAgIG5ld0VsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgQ2xhc3MgYmFzZWQgb24gdHlwZQogICAgICAgICAgICBuZXdFbC5jbGFzc05hbWUgPSAnJzsgLy8gUmVzZXQgY2xhc3NlcwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3NsYW0nKSB7CiAgICAgICAgICAgICAgICBuZXdFbC5jbGFzc0xpc3QuYWRkKCdhbm5vdW5jZW1lbnQtc2xhbScpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRGVmYXVsdCBzdHlsZQogICAgICAgICAgICAgICAgbmV3RWwuc3R5bGUuYW5pbWF0aW9uID0gJ25vbmUnOwogICAgICAgICAgICAgICAgbmV3RWwub2Zmc2V0SGVpZ2h0OyAvKiB0cmlnZ2VyIHJlZmxvdyAqLwogICAgICAgICAgICAgICAgbmV3RWwuc3R5bGUuYW5pbWF0aW9uID0gJ2Fubm91bmNlU2xpZGUgMC41cyBjdWJpYy1iZXppZXIoMC4xNzUsIDAuODg1LCAwLjMyLCAxLjI3NSknOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBdXRvLWhpZGUKICAgICAgICAgICAgaWYgKGR1cmF0aW9uID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fYW5ub3VuY2VUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlQW5ub3VuY2VtZW50KCk7CiAgICAgICAgICAgICAgICB9LCBkdXJhdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGhpZGVBbm5vdW5jZW1lbnQoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLmFubm91bmNlbWVudCkgewogICAgICAgICAgICAgICAgdGhpcy51aS5hbm5vdW5jZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCnJlc2V0Um91bmQocG9zc2Vzc2lvblRlYW1JZCkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gJ3Jlc2V0JzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENsZWFyIHBlcnNpc3RlbnQgdmlzdWFscwogICAgICAgICAgICBpZiAodGhpcy5nbHlwaE1hbmFnZXIpIHRoaXMuZ2x5cGhNYW5hZ2VyLmNsZWFyKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gT3B0aW9uYWw6IENsZWFyIHBhcnRpY2xlcyBpZiBuZWVkZWQsIHRob3VnaCB0aGV5IHNlbGYtZXhwaXJlIHF1aWNrbHkKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgQmFsbAogICAgICAgICAgICBpZiAodGhpcy5lbnRpdGllcy5iYWxsKSB0aGlzLmVudGl0aWVzLmJhbGwucmVzZXQoKTsKICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCkgdGhpcy5lbnRpdGllcy5iYWxsLnJlc2V0KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCBUZWFtcwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBiYWxsIGhvbGRlcgogICAgICAgICAgICBpZiAodGhpcy5lbnRpdGllcy5iYWxsKSB0aGlzLmVudGl0aWVzLmJhbGwuZHJvcCgpOwoKICAgICAgICAgICAgLy8gQ1JJVElDQUw6IFNuYXAgY2FtZXJhIHRvIHByZXZlbnQgZGlzb3JpZW50YXRpb24KICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgLy8gRm9yY2UgdXBkYXRlIHRhcmdldCBmaXJzdCAodXN1YWxseSBiYWxsKQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZW50aXRpZXMuYmFsbCAmJiB0aGlzLmVudGl0aWVzLmJhbGwubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhTWFuYWdlci5zZXRUYXJnZXQodGhpcy5lbnRpdGllcy5iYWxsLm1lc2gsIHRoaXMuZW50aXRpZXMuYmFsbC52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGQVNURVIgRkxPVzogUmVkdWNlZCBkZWxheSBmcm9tIDIwMDBtcyB0byAxMDBtcwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRLaWNrb2ZmKHBvc3Nlc3Npb25UZWFtSWQpOwp9LCAxMDApOwogICAgICAgIH0KCnN0YXJ0S2lja29mZihwb3NzZXNzaW9uVGVhbUlkKSB7CiAgICAgICAgICAgIC8vIFN0b3AgYWxsIHBsYXllcnMgaW1tZWRpYXRlbHkKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHAuc2V0SW5wdXQoMCwgMCkpOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5hd2F5KSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gcC5zZXRJbnB1dCgwLCAwKSk7CgogICAgICAgICAgICAvLyBJZiBhIHRlYW0gaGFzIHBvc3Nlc3Npb24gKGFmdGVyIGdvYWwpLCBzdGFuZGFyZCBraWNrb2ZmCiAgICAgICAgICAgIGlmIChwb3NzZXNzaW9uVGVhbUlkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gJ2tpY2tvZmYnOwogICAgICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJCTElUWiBPRkYhIiwgJ3NsYW0nKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvTWFuYWdlcikgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnd2hpc3RsZScpOwoKICAgICAgICAgICAgICAgIGNvbnN0IHRlYW0gPSB0aGlzLnRlYW1zW3Bvc3Nlc3Npb25UZWFtSWRdOwogICAgICAgICAgICAgICAgaWYgKHRlYW0pIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtZiA9IHRlYW0ucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgICAgICAgICBpZiAobWYgJiYgdGhpcy5lbnRpdGllcy5iYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW50aXRpZXMuYmFsbC5ncmFiKG1mKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNuYXAgY2FtZXJhIHRvIG5ldyBob2xkZXIKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldChtZi5tZXNoLCBtZi52ZWxvY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc25hcFRvVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnYWN0aXZlJzsKICAgICAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBORVVUUkFMIEtJQ0tPRkY6ICJUaGUgQmxpdHogT2ZmIiBDaW5lbWF0aWMgU2VxdWVuY2UKICAgICAgICAgICAgICAgIHRoaXMuX3N0YXJ0TmV1dHJhbEJsaXR6T2ZmKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpfc3RhcnROZXV0cmFsQmxpdHpPZmYoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnYmxpdHpfY2hhcmdlJzsKICAgICAgICAgICAgdGhpcy5ibGl0elRpbWVyID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDEuIFJlc2V0IEJhbGwgdG8gQ2VudGVyIChEZWVwKQogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2gpIHsKICAgICAgICAgICAgICAgIGJhbGwuZHJvcCgpOwogICAgICAgICAgICAgICAgYmFsbC5tZXNoLnBvc2l0aW9uLnNldCgwLCAtNSwgMCk7IC8vIFN0YXJ0IERFRVAgKC01bSkgZm9yICJncm91bmQgdXAiIHJpc2UKICAgICAgICAgICAgICAgIGJhbGwudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgYmFsbC5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgLy8gUmVzZXQgdmlzdWFscwogICAgICAgICAgICAgICAgaWYgKGJhbGwuZGVmb3JtTm9kZSkgYmFsbC5kZWZvcm1Ob2RlLnNjYWxlLnNldCgxLCAxLCAxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gUG9zaXRpb24gQ2FwdGFpbnMgKE1GcykKICAgICAgICAgICAgY29uc3QgaG9tZU1GID0gdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIGNvbnN0IGF3YXlNRiA9IHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwoKICAgICAgICAgICAgaWYgKGhvbWVNRiAmJiBob21lTUYubWVzaCkgewogICAgICAgICAgICAgICAgaG9tZU1GLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDgpOyAvLyA4bSBiYWNrCiAgICAgICAgICAgICAgICBob21lTUYubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBob21lTUYucGxheSgnaWRsZScsIDAuMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGF3YXlNRiAmJiBhd2F5TUYubWVzaCkgewogICAgICAgICAgICAgICAgYXdheU1GLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC04KTsgLy8gOG0gYmFjawogICAgICAgICAgICAgICAgYXdheU1GLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgYXdheU1GLnBsYXkoJ2lkbGUnLCAwLjEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBDYW1lcmEgRm9jdXMKICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhTWFuYWdlciAmJiBiYWxsICYmIGJhbGwubWVzaCkgewogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNldFRhcmdldChiYWxsLm1lc2gsIG51bGwpOwogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICAgICAgLy8gWm9vbSBpbiB0aWdodAogICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLmN1cnJlbnRQdWxsQmFjayA9IC0xMjsgCiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIubWFudWFsT3JiaXRQaXRjaCA9IDAuNDsgLy8gTG9vayBkb3duIHN0ZWVwCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJ1aWxkIFRlbnNpb24KICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KCJSRUFEWS4uLiIsICdub3JtYWwnKTsKICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdzd2ltJywgeyB2b2x1bWU6IDAuNSB9KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVCbGl0ekNoYXJnZShkdCkgewogICAgICAgICAgICB0aGlzLmJsaXR6VGltZXIgKz0gZHQ7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBjaGFyZ2VEdXJhdGlvbiA9IDIuMDsgLy8gTG9uZ2VyIGJ1aWxkIHVwIGZvciBjaW5lbWF0aWMgZmVlbAoKICAgICAgICAgICAgLy8gUEhBU0UgMTogQ0hBUkdFIChSaXNpbmcgZnJvbSBkZXB0aHMpCiAgICAgICAgICAgIGlmICh0aGlzLmJsaXR6VGltZXIgPCBjaGFyZ2VEdXJhdGlvbikgewogICAgICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMuYmxpdHpUaW1lciAvIGNoYXJnZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgZWFzZVQgPSB0ICogdDsgLy8gUXVhZHJhdGljIGVhc2UgaW4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmlzZSBmcm9tIC01IHRvIDAgKEdyb3VuZCB1cCBlZmZlY3QpCiAgICAgICAgICAgICAgICBiYWxsLm1lc2gucG9zaXRpb24ueSA9IC01LjAgKyAoNS4wICogZWFzZVQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTcGluIHVwIChFeHBvbmVudGlhbCkKICAgICAgICAgICAgICAgIGJhbGwubWVzaC5yb3RhdGlvbi55ICs9ICgxMC4wICsgNTAuMCAqIHQpICogZHQ7CiAgICAgICAgICAgICAgICBiYWxsLm1lc2gucm90YXRpb24ueCArPSAoNS4wICsgMjAuMCAqIHQpICogZHQ7CgogICAgICAgICAgICAgICAgLy8gU3F1YXNoIChGbGF0dGVuIGxpa2UgYSBkaXNjIGJ1aWxkaW5nIGVuZXJneSkKICAgICAgICAgICAgICAgIGlmIChiYWxsLmRlZm9ybU5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBFeHRyZW1lIHNxdWFzaCBhdCB0aGUgZW5kCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3F1YXNoID0gMS4wIC0gKDAuNyAqIGVhc2VUKTsgLy8gRmxhdHRlbiBZIHRvIDAuMwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0cmV0Y2ggPSAxLjAgKyAoMC41ICogZWFzZVQpOyAvLyBFeHBhbmQgWFoKICAgICAgICAgICAgICAgICAgICBiYWxsLmRlZm9ybU5vZGUuc2NhbGUuc2V0KHN0cmV0Y2gsIHNxdWFzaCwgc3RyZXRjaCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2FtZXJhIFNoYWtlIGluY3JlYXNpbmcKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHRoaXMuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjIgKiB0KTsKCiAgICAgICAgICAgICAgICAvLyBQYXJ0aWNsZXM6IFJpc2luZyBFbmVyZ3kgZnJvbSBncm91bmQKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnRpY2xlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIC8vIEJ1YmJsZXMgcmlzaW5nIGZhc3QKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb3VudCA9IE1hdGguZmxvb3IodCAqIDgpICsgMTsKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByID0gMi4wICogKDEuMCAtIHQpOyAvLyBSYWRpdXMgc2hyaW5rcyBhcyBpdCBnZXRzIGNsb3NlciB0byBsYXVuY2gKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeCA9IE1hdGguY29zKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHogPSBNYXRoLnNpbihhbmdsZSkgKiByOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB5ID0gYmFsbC5tZXNoLnBvc2l0aW9uLnkgLSAxLjA7IC8vIEJlbG93IGJhbGwKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdidWJibGUnLCBuZXcgVEhSRUUuVmVjdG9yMyh4LCB5LCB6KSwgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZmU6IDAuNCwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTogMC4yICsgdCAqIDAuNSAKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IAogICAgICAgICAgICAvLyBQSEFTRSAyOiBMQVVOQ0gKICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5zdGF0ZSA9PT0gJ2JsaXR6X2NoYXJnZScpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnYmxpdHpfbGF1bmNoJzsKICAgICAgICAgICAgICAgIHRoaXMuYmxpdHpUaW1lciA9IDA7IC8vIFJlc2V0IGZvciBsYXVuY2ggcGhhc2UKCiAgICAgICAgICAgICAgICAvLyBUSU1FRCBBTk5PVU5DRU1FTlQKICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Fubm91bmNlbWVudCgiQkxJVFogT0ZGISIsICdzbGFtJyk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdpbXBhY3QnLCB7IHZvbHVtZTogMS4wIH0pOyAvLyBCb29tCiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb01hbmFnZXIucGxheVNGWCgnZGFzaCcsIHsgdm9sdW1lOiAxLjAgfSk7ICAgLy8gV2hvb3NoCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTGF1bmNoIEJhbGwKICAgICAgICAgICAgICAgIGJhbGwudmVsb2NpdHkuc2V0KDAsIDM1LCAwKTsgLy8gU2hvb3QgVVAgRkFTVAogICAgICAgICAgICAgICAgaWYgKGJhbGwuZGVmb3JtTm9kZSkgYmFsbC5kZWZvcm1Ob2RlLnNjYWxlLnNldCgwLjQsIDMuMCwgMC40KTsgLy8gRXh0cmVtZSBzdHJldGNoIHZlcnRpY2FsCgogICAgICAgICAgICAgICAgLy8gRlg6IE1hc3NpdmUgR3JvdW5kIEVydXB0aW9uCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignc2hvY2t3YXZlJywgYmFsbC5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiA4LjAgfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ2ZsYXNoJywgYmFsbC5tZXNoLnBvc2l0aW9uLCB7IHNjYWxlOiA2LjAgfSk7CiAgICAgICAgICAgICAgICAgICAgLy8gVmVydGljYWwgc3RyZWFtCiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8MTA7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gYmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHAueSArPSBpICogMC41OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGFzaF9zdHJlYW0nLCBwLCB7IHNjYWxlOiAzLjAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW1lcmFNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLmFkZFNoYWtlKDMuMCk7IC8vIEhlYXZ5IHNoYWtlCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLmN1cnJlbnRQdWxsQmFjayA9IDEwOyAvLyBab29tIG91dCBmYXN0CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFNYW5hZ2VyLm1hbnVhbE9yYml0UGl0Y2ggPSAwLjA7IC8vIExldmVsIG91dAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENhcHRhaW5zIEp1bXAKICAgICAgICAgICAgICAgIGNvbnN0IGhvbWVNRiA9IHRoaXMudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQocCA9PiBwLnJvbGUgPT09ICdNRicpOwogICAgICAgICAgICAgICAgY29uc3QgYXdheU1GID0gdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CgogICAgICAgICAgICAgICAgY29uc3QganVtcFRvID0gKHApID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAgfHwgIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IGJhbGwubWVzaC5wb3NpdGlvbi5jbG9uZSgpLnN1YihwLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIGRpci55ID0gMS4yOyAvLyBTdGVlcCBqdW1wCiAgICAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5jb3B5KGRpcikubXVsdGlwbHlTY2FsYXIoMTguMCk7IC8vIEZhc3QganVtcAogICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2F0Y2hfanVtcCcsIDAuMSk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGp1bXBUbyhob21lTUYpOwogICAgICAgICAgICAgICAganVtcFRvKGF3YXlNRik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF91cGRhdGVCbGl0ekxhdW5jaChkdCkgewogICAgICAgICAgICB0aGlzLmJsaXR6VGltZXIgKz0gZHQ7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB0aGlzLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBncmF2aXR5IG1hbnVhbGx5IGZvciBjaW5lbWF0aWMgZmVlbCAoSW5jcmVhc2VkIGdyYXZpdHkgZm9yIHNuYXBwaWVyIGFyYykKICAgICAgICAgICAgYmFsbC52ZWxvY2l0eS55IC09IDQwLjAgKiBkdDsgCiAgICAgICAgICAgIGJhbGwubWVzaC5wb3NpdGlvbi5hZGRTY2FsZWRWZWN0b3IoYmFsbC52ZWxvY2l0eSwgZHQpOwoKICAgICAgICAgICAgLy8gTW92ZSBQbGF5ZXJzIG1hbnVhbGx5CiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZUp1bXBlciA9IChwKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXAgfHwgIXAubWVzaCkgcmV0dXJuOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS55IC09IDI1LjAgKiBkdDsgLy8gR3Jhdml0eQogICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLmFkZFNjYWxlZFZlY3RvcihwLnZlbG9jaXR5LCBkdCk7CiAgICAgICAgICAgICAgICBwLm1lc2gubG9va0F0KGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb25zdCBob21lTUYgPSB0aGlzLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgY29uc3QgYXdheU1GID0gdGhpcy50ZWFtcy5hd2F5LnBsYXllcnMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB1cGRhdGVKdW1wZXIoaG9tZU1GKTsKICAgICAgICAgICAgdXBkYXRlSnVtcGVyKGF3YXlNRik7CgogICAgICAgICAgICAvLyBQSEFTRSAzOiBHUkFCIChBcGV4IH4wLjdzKQogICAgICAgICAgICBpZiAodGhpcy5ibGl0elRpbWVyID4gMC43ICYmIHRoaXMuc3RhdGUgPT09ICdibGl0el9sYXVuY2gnKSB7CiAgICAgICAgICAgICAgICAvLyBEZXRlcm1pbmUgV2lubmVyICg1MC81MCArIFN0YXQgYmlhcykKICAgICAgICAgICAgICAgIGNvbnN0IGhvbWVTcCA9IGhvbWVNRi5nZXRTdGF0KCdTUCcpOwogICAgICAgICAgICAgICAgY29uc3QgYXdheVNwID0gYXdheU1GLmdldFN0YXQoJ1NQJyk7CiAgICAgICAgICAgICAgICBjb25zdCB0b3RhbCA9IGhvbWVTcCArIGF3YXlTcDsKICAgICAgICAgICAgICAgIGNvbnN0IHJvbGwgPSBNYXRoLnJhbmRvbSgpICogdG90YWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHdpbm5lciA9IChyb2xsIDwgaG9tZVNwKSA/IGhvbWVNRiA6IGF3YXlNRjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgYmFsbC5ncmFiKHdpbm5lcik7CiAgICAgICAgICAgICAgICB0aGlzLmhpZGVBbm5vdW5jZW1lbnQoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mbG9hdGluZ1RleHQuc3Bhd24oIldPTiEiLCB3aW5uZXIubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBUcmFuc2l0aW9uIHRvIEFjdGl2ZQogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9ICdhY3RpdmUnOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYSB0byB3aW5uZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbWVyYU1hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYU1hbmFnZXIuc2V0VGFyZ2V0KHdpbm5lci5tZXNoLCB3aW5uZXIudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuY2FtZXJhTWFuYWdlci5zbmFwVG9UYXJnZXQoKTsgLy8gT3B0aW9uYWw6IEtlZXAgc21vb3RoIG9yIHNuYXAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKLy8gSW5pdGlhbCBzdGFydAovLyBJbml0aWFsIHN0YXJ0CnN0YXJ0TWF0Y2gobW9kZSA9ICdub3JtYWwnKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZU1vZGUgPSBtb2RlOwogICAgICAgICAgICBjb25zb2xlLmxvZygiU3RhcnRpbmcgTWF0Y2ggaW4gbW9kZToiLCBtb2RlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IFNjb3JlCiAgICAgICAgICAgIHRoaXMuc2NvcmUuaG9tZSA9IDA7CiAgICAgICAgICAgIHRoaXMuc2NvcmUuYXdheSA9IDA7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjb3JlVUkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IFRpbWUKICAgICAgICAgICAgdGhpcy50aW1lID0gMDsKICAgICAgICAgICAgdGhpcy5oYWxmID0gMTsKICAgICAgICAgICAgaWYgKHRoaXMudWkuaGFsZikgdGhpcy51aS5oYWxmLmlubmVyVGV4dCA9ICIxc3QiOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKG1vZGUgPT09ICdwcmFjdGljZScpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLmhhbGYpIHRoaXMudWkuaGFsZi5pbm5lclRleHQgPSAiUFJBQyI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IFByYWN0aWNlIE1hbmFnZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMucHJhY3RpY2VNYW5hZ2VyLnN0YXJ0KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSW4gcHJhY3RpY2UsIGVuc3VyZSBBSSBpcyBlbmFibGVkIGZvciBzcGFycmluZwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5haUVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTdGFydCBCR00gaW1tZWRpYXRlbHkgZm9yIHByYWN0aWNlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gU2tpcCBpbnRybyBmb3IgcHJhY3RpY2UKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIFByYWN0aWNlIE1hbmFnZXIgaXMgc3RvcHBlZCBpZiBub3JtYWwgZ2FtZQogICAgICAgICAgICAgICAgaWYgKHRoaXMucHJhY3RpY2VNYW5hZ2VyKSB0aGlzLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNhZmV0eTogRW5zdXJlIGFsbCBwbGF5ZXJzIGFyZSB2aXNpYmxlIChpbiBjYXNlIFByYWN0aWNlIGhpZCB0aGVtKQogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7IGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSB0cnVlOyB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlYW1zLmF3YXkuYWlFbmFibGVkID0gdHJ1ZTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9IHRydWU7IH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IENpbmVtYXRpYyBJbnRybwogICAgICAgICAgICAgICAgdGhpcy5zdGFydEludHJvU2VxdWVuY2UoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnNraXBJbnRybygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpbnRybycpIHJldHVybjsKICAgICAgICAgICAgY29uc29sZS5sb2coIkludHJvIENvbXBsZXRlL1NraXBwZWQiKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUkVTVE9SRSBVSSBFTEVNRU5UUwovLyBSRVNUT1JFIFVJIEVMRU1FTlRTCiAgICAgICAgICAgIGNvbnN0IHVpRWxlbWVudHMgPSBbCiAgICAgICAgICAgICAgICAnaHVkLXRvcCcsIAogICAgICAgICAgICAgICAgJ3BsYXllci1zdGF0dXMtcGFuZWwnLCAKICAgICAgICAgICAgICAgICdtaW5pbWFwLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2dvYWwtZGlzdGFuY2UtY29udGFpbmVyJywgCiAgICAgICAgICAgICAgICAnYWN0aW9uLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2pveXN0aWNrLWhpdC16b25lJywgCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXpvbmUnLAogICAgICAgICAgICAgICAgJ2F1dG8tdG9nZ2xlJywgCiAgICAgICAgICAgICAgICAnc2V0dGluZ3MtYnV0dG9uJywKICAgICAgICAgICAgICAgICdjb250cm9scy1oaW50JwogICAgICAgICAgICBdOwogICAgICAgICAgICAKICAgICAgICAgICAgdWlFbGVtZW50cy5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJyc7IC8vIFJldmVydCB0byBDU1MgZGVmYXVsdAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEhpZGUgQ2luZW1hdGljIEJhcnMKICAgICAgICAgICAgY29uc3QgYmFycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaW5lbWF0aWMtYmFycycpOwogICAgICAgICAgICBpZiAoYmFycykgewogICAgICAgICAgICAgICAgYmFycy5xdWVyeVNlbGVjdG9yQWxsKCcuYmFyJykuZm9yRWFjaChiID0+IGIuc3R5bGUuaGVpZ2h0ID0gJzAnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKLy8gTGlnaHRzIG9uCiAgICAgICAgICAgIGlmICh0aGlzLnN0YWRpdW0pIHRoaXMuc3RhZGl1bS5zZXRBbGxMaWdodHModHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCBwbGF5ZXJzIHRvIGlkbGUKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuaG9tZSkgdGhpcy50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChwID0+IHAucGxheSgnaWRsZScsIDAuMSkpOwogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5hd2F5KSB0aGlzLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gcC5wbGF5KCdpZGxlJywgMC4xKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFydCBCR00gYWZ0ZXIgaW50cm8KICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9NYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvTWFuYWdlci5wbGF5QkdNKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMucmVzZXRSb3VuZChudWxsKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0SW50cm9TZXF1ZW5jZSgpIHsKCiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAnaW50cm8nOwogICAgICAgICAgICB0aGlzLmludHJvU2hvdEluZGV4ID0gMDsKICAgICAgICAgICAgdGhpcy5pbnRyb1Nob3RUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuX2hhc1JvYXJlZCA9IGZhbHNlOyAvLyBSZXNldCByb2FyIGZsYWcKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluaXRpYWwgc2V0dXAKICAgICAgICAgICAgaWYgKHRoaXMuc3RhZGl1bSkgdGhpcy5zdGFkaXVtLnNldEFsbExpZ2h0cyhmYWxzZSk7CgogICAgICAgICAgICAvLyBISURFIEFMTCBVSSBFTEVNRU5UUwogICAgICAgICAgICBjb25zdCB1aUVsZW1lbnRzID0gWwogICAgICAgICAgICAgICAgJ2h1ZC10b3AnLCAKICAgICAgICAgICAgICAgICdwbGF5ZXItc3RhdHVzLXBhbmVsJywgCiAgICAgICAgICAgICAgICAnbWluaW1hcC1jb250YWluZXInLCAKICAgICAgICAgICAgICAgICdnb2FsLWRpc3RhbmNlLWNvbnRhaW5lcicsIAogICAgICAgICAgICAgICAgJ2FjdGlvbi1jb250YWluZXInLCAKICAgICAgICAgICAgICAgICd0YWNrbGUtYnV0dG9uJywgCiAgICAgICAgICAgICAgICAnam95c3RpY2staGl0LXpvbmUnLCAKICAgICAgICAgICAgICAgICdhaW0tam95c3RpY2stem9uZScsCiAgICAgICAgICAgICAgICAnam95c3RpY2stdmlzdWFsLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXZpc3VhbCcsCiAgICAgICAgICAgICAgICAnYXV0by10b2dnbGUnLCAKICAgICAgICAgICAgICAgICdzZXR0aW5ncy1idXR0b24nLAogICAgICAgICAgICAgICAgJ2NvbnRyb2xzLWhpbnQnLAogICAgICAgICAgICAgICAgJ2NoYXJnZS1tZXRlci1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ3ByYWN0aWNlLXJlc3RvcmUtYnRuJwogICAgICAgICAgICBdOwogICAgICAgICAgICAKICAgICAgICAgICAgdWlFbGVtZW50cy5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFNob3cgQ2luZW1hdGljIEJhcnMKICAgICAgICAgICAgY29uc3QgYmFycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaW5lbWF0aWMtYmFycycpOwogICAgICAgICAgICBpZiAoYmFycykgewogICAgICAgICAgICAgICAgYmFycy5xdWVyeVNlbGVjdG9yQWxsKCcuYmFyJykuZm9yRWFjaChiID0+IGIuc3R5bGUuaGVpZ2h0ID0gJzEwJScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy50ZWFtcy5ob21lKSB0aGlzLnRlYW1zLmhvbWUucmVzZXRQb3NpdGlvbnMoKTsKICAgICAgICAgICAgaWYgKHRoaXMudGVhbXMuYXdheSkgdGhpcy50ZWFtcy5hd2F5LnJlc2V0UG9zaXRpb25zKCk7CiAgICAgICAgICAgIGlmICh0aGlzLmVudGl0aWVzLmJhbGwpIHRoaXMuZW50aXRpZXMuYmFsbC5yZXNldCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVHJpZ2dlciBmaXJzdCBzaG90IHN0YXJ0CiAgICAgICAgICAgIGlmICh0aGlzLmludHJvU2hvdHMgJiYgdGhpcy5pbnRyb1Nob3RzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmludHJvU2hvdHNbMF0ub25TdGFydCkgdGhpcy5pbnRyb1Nob3RzWzBdLm9uU3RhcnQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2tpcEludHJvKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9Cl91cGRhdGVJbnRyb1dhcm11cChkdCkgewogICAgICAgICAgICBjb25zdCBhbGxQbGF5ZXJzID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmhvbWUpIGFsbFBsYXllcnMucHVzaCguLi50aGlzLnRlYW1zLmhvbWUucGxheWVycyk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlYW1zLmF3YXkpIGFsbFBsYXllcnMucHVzaCguLi50aGlzLnRlYW1zLmF3YXkucGxheWVycyk7CgogICAgICAgICAgICBhbGxQbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXAubWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBtaXhlciB1cGRhdGVzIChzaW5jZSBnYW1lIGxvb3AgbWlnaHQgc2tpcCBwbGF5ZXIudXBkYXRlIGluIGludHJvIHN0YXRlKQogICAgICAgICAgICAgICAgaWYgKHAubWl4ZXIpIHAubWl4ZXIudXBkYXRlKGR0KTsKCiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIHdhcm11cCB0aW1lciBpZiBuZWVkZWQKICAgICAgICAgICAgICAgIGlmIChwLl93YXJtdXBUaW1lciA9PT0gdW5kZWZpbmVkKSBwLl93YXJtdXBUaW1lciA9IE1hdGgucmFuZG9tKCkgKiAyLjA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHAuX3dhcm11cFRpbWVyIC09IGR0OwoKICAgICAgICAgICAgICAgIGlmIChwLl93YXJtdXBUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUGljayBuZXh0IGFjdGlvbiB0aW1lICgycyB0byA1cykKICAgICAgICAgICAgICAgICAgICBwLl93YXJtdXBUaW1lciA9IDIuMCArIE1hdGgucmFuZG9tKCkgKiAzLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFuZCA9IE1hdGgucmFuZG9tKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJhbmQgPCAwLjQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdpZGxlJywgMC41KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhbmQgPCAwLjYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdzd2ltJywgMC41KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhbmQgPCAwLjgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gIlN0cmV0Y2giIC8gQ2VsZWJyYXRlCiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgnY2VsZWJyYXRlJywgMC41KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJhbmQgPCAwLjkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5wbGF5KCdjYXRjaCcsIDAuNSk7IC8vIENoZWNraW5nIGdsb3ZlcwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAucGxheSgncmVhY3QnLCAwLjUpOyAvLyBTaGFrZSBvZmYKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gR2VudGxlIGJvYmJpbmcgKHRyZWFkaW5nIHdhdGVyKQogICAgICAgICAgICAgICAgaWYgKHAuaG9tZVBvc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnkgPSBwLmhvbWVQb3NpdGlvbi55ICsgTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDAzICsgcC5tZXNoLmlkKSAqIDAuMzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKc2V0TWVudU1vZGUoaXNBY3RpdmUpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGlzQWN0aXZlID8gJ21lbnUnIDogJ2FjdGl2ZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaXNBY3RpdmUgJiYgdGhpcy5hdWRpb01hbmFnZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9NYW5hZ2VyLnN0b3BCR00oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTGlzdCBvZiBzdGF0aWMgSFVEIGVsZW1lbnRzIHRvIHRvZ2dsZQogICAgICAgICAgICBjb25zdCBzdGF0aWNVSSA9IFsKICAgICAgICAgICAgICAgICdodWQtdG9wJywKICAgICAgICAgICAgICAgICdwbGF5ZXItc3RhdHVzLXBhbmVsJywKICAgICAgICAgICAgICAgICdhY3Rpb24tY29udGFpbmVyJywKICAgICAgICAgICAgICAgICdqb3lzdGljay1oaXQtem9uZScsCiAgICAgICAgICAgICAgICAnYWltLWpveXN0aWNrLXpvbmUnLAogICAgICAgICAgICAgICAgJ21pbmltYXAtY29udGFpbmVyJywKICAgICAgICAgICAgICAgICdnb2FsLWRpc3RhbmNlLWNvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAnc2V0dGluZ3MtYnV0dG9uJywKICAgICAgICAgICAgICAgICdhdXRvLXRvZ2dsZScsCiAgICAgICAgICAgICAgICAndGFja2xlLWJ1dHRvbicsCiAgICAgICAgICAgICAgICAnY29udHJvbHMtaGludCcKICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIC8vIExpc3Qgb2YgZHluYW1pYyBlbGVtZW50cyB0byBGT1JDRSBISURFIGluIG1lbnUKICAgICAgICAgICAgY29uc3QgZHluYW1pY1VJID0gWwogICAgICAgICAgICAgICAgJ2pveXN0aWNrLXZpc3VhbC1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ2FpbS1qb3lzdGljay12aXN1YWwnLAogICAgICAgICAgICAgICAgJ2NoYXJnZS1tZXRlci1jb250YWluZXInLAogICAgICAgICAgICAgICAgJ3RlY2gtZmxhc2gtb3ZlcmxheScsCiAgICAgICAgICAgICAgICAncHJhY3RpY2UtcmVzdG9yZS1idG4nCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBpZiAoaXNBY3RpdmUpIHsKICAgICAgICAgICAgICAgIC8vIEhJREUgQUxMCiAgICAgICAgICAgICAgICBbLi4uc3RhdGljVUksIC4uLmR5bmFtaWNVSV0uZm9yRWFjaChpZCA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBTSE9XIFNUQVRJQyBPTkxZCiAgICAgICAgICAgICAgICBzdGF0aWNVSS5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlkID09PSAnaHVkLXRvcCcgfHwgaWQgPT09ICdhY3Rpb24tY29udGFpbmVyJykgZWwuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBlbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIC8vIER5bmFtaWMgb25lcyByZW1haW4gaGlkZGVuL2NvbnRyb2xsZWQgYnkgdGhlaXIgbG9naWMKICAgICAgICAgICAgfQogICAgICAgIH0KdG9nZ2xlRGVtb01vZGUoKSB7CiAgICAgICAgICAgIHRoaXMuaXNEZW1vTW9kZSA9ICF0aGlzLmlzRGVtb01vZGU7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJEZW1vIE1vZGU6IiwgdGhpcy5pc0RlbW9Nb2RlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBVSSBCdXR0b24KICAgICAgICAgICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F1dG8tdG9nZ2xlJyk7CiAgICAgICAgICAgIGlmIChidG4pIHsKICAgICAgICAgICAgICAgIGJ0bi5pbm5lclRleHQgPSB0aGlzLmlzRGVtb01vZGUgPyAiQVVUTyBQSUxPVCIgOiAiTUFOVUFMIjsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzRGVtb01vZGUpIHsKICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQW5ub3VuY2VtZW50CiAgICAgICAgICAgIGNvbnN0IHRleHQgPSB0aGlzLmlzRGVtb01vZGUgPyAiQVVUTyBQSUxPVCIgOiAiTUFOVUFMIjsKICAgICAgICAgICAgdGhpcy5zaG93QW5ub3VuY2VtZW50KHRleHQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIEZsYWlyOiBTcGF3biB0ZXh0IGFib3ZlIGFjdGl2ZSBwbGF5ZXIKICAgICAgICAgICAgaWYgKHRoaXMuaXNEZW1vTW9kZSAmJiB0aGlzLmZsb2F0aW5nVGV4dCAmJiB0aGlzLnRlYW1zLmhvbWUgJiYgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciAmJiB0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKCJBSSBFTkdBR0VEIiwgdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllci5tZXNoLnBvc2l0aW9uLCAiZ29hbCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBdXRvLWhpZGUgYW5ub3VuY2VtZW50CnNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkuYW5ub3VuY2VtZW50ICYmIHRoaXMudWkuYW5ub3VuY2VtZW50LmlubmVyVGV4dCA9PT0gdGV4dCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUFubm91bmNlbWVudCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBURUNIQ09QWSBTWVNURU0gLS0tCgogICAgICAgIHRyaWdnZXJUZWNoRXZlbnQoc291cmNlUGxheWVyLCB0ZWNoTmFtZSkgewogICAgICAgICAgICBpZiAoIXNvdXJjZVBsYXllciB8fCAhc291cmNlUGxheWVyLnRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIC8vIEZpbmQgb3Bwb3NpbmcgdGVhbQogICAgICAgICAgICBjb25zdCBvcHBUZWFtSWQgPSBzb3VyY2VQbGF5ZXIudGVhbS5pZCA9PT0gJ2hvbWUnID8gJ2F3YXknIDogJ2hvbWUnOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gdGhpcy50ZWFtc1tvcHBUZWFtSWRdOwogICAgICAgICAgICBpZiAoIW9wcFRlYW0pIHJldHVybjsKCiAgICAgICAgICAgIC8vIEZpbmQgd2hvIGlzIG1hcmtpbmcgdGhpcyBzb3VyY2UKICAgICAgICAgICAgY29uc3QgbGVhcm5lcnMgPSBvcHBUZWFtLnBsYXllcnMuZmlsdGVyKHAgPT4gcC5tYXJraW5nID09PSBzb3VyY2VQbGF5ZXIpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGxlYXJuZXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gT25seSBzaG93IFVJIGlmIHRoZSBsZWFybmluZyB0ZWFtIGlzIEh1bWFuIChIb21lKQogICAgICAgICAgICAvLyAoT3IgaWYgd2UgYXJlIGluIERlbW8gbW9kZSBhbmQgd2FudCB0byBzZWUgaXQgaGFwcGVuIGZvciBIb21lIHRlYW0pCiAgICAgICAgICAgIGlmIChvcHBUZWFtLmlzSHVtYW4pIHsKICAgICAgICAgICAgICAgIC8vIEZpbHRlciBvdXQgdGhvc2Ugd2hvIGFscmVhZHkga25vdyBpdAogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRMZWFybmVycyA9IGxlYXJuZXJzLmZpbHRlcihwID0+ICFwLmxlYXJuZWRUZWNocy5pbmNsdWRlcyh0ZWNoTmFtZSkpOwogICAgICAgICAgICAgICAgaWYgKHZhbGlkTGVhcm5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRUZWNoQ29weVdpbmRvdyh0ZWNoTmFtZSwgdmFsaWRMZWFybmVycyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzdGFydFRlY2hDb3B5V2luZG93KHRlY2hOYW1lLCBsZWFybmVycykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50ZWNoQ29weVN0YXRlLm1heFRpbWUgPSAwLjY7IC8vIDAuNnMgd2luZG93CiAgICAgICAgICAgIHRoaXMudGVjaENvcHlTdGF0ZS50aW1lciA9IHRoaXMudGVjaENvcHlTdGF0ZS5tYXhUaW1lOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUudGVjaCA9IHRlY2hOYW1lOwogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUubGVhcm5lcnMgPSBsZWFybmVyczsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNob3cgVUkKICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaEZsYXNoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgdGhpcy51aS50ZWNoRmxhc2guc3R5bGUuYmFja2dyb3VuZCA9ICIiOyAvLyBSZXNldCBiYWNrZ3JvdW5kCiAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlRFQ0hDT1BZISI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hTdWIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hTdWIuaW5uZXJUZXh0ID0gdGVjaE5hbWUucmVwbGFjZSgnXycsICcgJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IGJhcgogICAgICAgICAgICAgICAgaWYgKHRoaXMudWkudGVjaFRpbWVyRmlsbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudWkudGVjaFRpbWVyRmlsbC5zdHlsZS53aWR0aCA9ICcxMDAlJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCmF0dGVtcHRUZWNoQ29weSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdWNjZXNzIQogICAgICAgICAgICBjb25zdCB0ZWNoID0gdGhpcy50ZWNoQ29weVN0YXRlLnRlY2g7CiAgICAgICAgICAgIGNvbnN0IGxlYXJuZXJzID0gdGhpcy50ZWNoQ29weVN0YXRlLmxlYXJuZXJzOwogICAgICAgICAgICAKICAgICAgICAgICAgbGVhcm5lcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIC8vIERvdWJsZSBjaGVjayB0byBwcmV2ZW50IGR1cGxpY2F0ZXMKICAgICAgICAgICAgICAgIGlmICghcC5sZWFybmVkVGVjaHMuaW5jbHVkZXModGVjaCkpIHsKICAgICAgICAgICAgICAgICAgICBwLmxlYXJuZWRUZWNocy5wdXNoKHRlY2gpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3Aucm9sZX0gbGVhcm5lZCAke3RlY2h9IWApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDEuIEZsb2F0aW5nIFRleHQKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5mbG9hdGluZ1RleHQgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmxvYXRpbmdUZXh0LnNwYXduKGBMRUFSTkVEIWAsIHAubWVzaC5wb3NpdGlvbiwgInRlY2giKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gUGFydGljbGUgRWZmZWN0IChTcGlyYWwpCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFydGljbGVNYW5hZ2VyICYmIHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biBtdWx0aXBsZSBwYXJ0aWNsZXMgZm9yIGEgc3dpcmwgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDEwOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGkgKiA1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5lbmRUZWNoQ29weVdpbmRvdyh0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKZW5kVGVjaENvcHlXaW5kb3coc3VjY2VzcykgewogICAgICAgICAgICB0aGlzLnRlY2hDb3B5U3RhdGUuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLnVpLnRlY2hGbGFzaCkgewogICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5xdWVyeVNlbGVjdG9yKCcudGVjaC10ZXh0JykuaW5uZXJUZXh0ID0gIlNVQ0NFU1MhIjsKICAgICAgICAgICAgICAgICAgICAvLyBGbGFzaCBzdWNjZXNzIGNvbG9yIChXaGl0ZSBmbGFzaCkKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5iYWNrZ3JvdW5kID0gInJnYmEoMjU1LCAyNTUsIDI1NSwgMC44KSI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSGlkZSBhZnRlciBzaG9ydCBkZWxheSB0byBzaG93IHRoZSBzdWNjZXNzIGZsYXNoCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOyAKICAgICAgICAgICAgICAgICAgICB9LCAzMDApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBGYWlsZWQgLyBNaXNzZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnRlY2hGbGFzaC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQpfdXBkYXRlUGxheWVyU3RhdHVzVUkoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy50ZWFtcy5ob21lIHx8ICF0aGlzLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBwID0gdGhpcy50ZWFtcy5ob21lLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgY29uc3QgdWkgPSB0aGlzLnVpLnN0YXR1c1BhbmVsOwogICAgICAgICAgICAKLy8gVUkgVXBkYXRlcyAoQWN0aW9uIEJ1dHRvbiBDb250ZXh0KQogICAgICAgICAgICAgICAgdWkuY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBOYW1lICYgTGV2ZWwKICAgICAgICAgICAgICAgIGlmICh1aS5uYW1lKSB1aS5uYW1lLmlubmVyVGV4dCA9IGAke3AuY2hhcmFjdGVyTmFtZSB8fCBwLnJvbGV9IExWJHtwLmxldmVsfWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEhQCiAgICAgICAgICAgICAgICBpZiAodWkuaHBCYXIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBocFBjdCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEwMCwgKHAuc3RhdHMuSFAgLyBwLnN0YXRzLm1heEhQKSAqIDEwMCkpOwogICAgICAgICAgICAgICAgICAgIHVpLmhwQmFyLnN0eWxlLndpZHRoID0gYCR7aHBQY3R9JWA7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29sb3Igc2hpZnQKICAgICAgICAgICAgICAgICAgICBpZiAoaHBQY3QgPCAyNSkgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmZjAwMDAsICNmZjQ0NDQpJzsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChocFBjdCA8IDUwKSB1aS5ocEJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2ZmZmYwMCwgI2ZmZmY4OCknOwogICAgICAgICAgICAgICAgICAgIGVsc2UgdWkuaHBCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMwMGZmMDAsICNjY2ZmY2MpJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1aS5ocFRleHQpIHVpLmhwVGV4dC5pbm5lclRleHQgPSBgJHtNYXRoLmZsb29yKHAuc3RhdHMuSFApfS8ke3Auc3RhdHMubWF4SFB9YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRVhQCiAgICAgICAgICAgICAgICBpZiAodWkuZXhwQmFyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwUGN0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMTAwLCAocC5leHAgLyBwLm5leHRMZXZlbEV4cCkgKiAxMDApKTsKICAgICAgICAgICAgICAgICAgICB1aS5leHBCYXIuc3R5bGUud2lkdGggPSBgJHtleHBQY3R9JWA7CnVpLmV4cEJhci5zdHlsZS53aWR0aCA9IGAke2V4cFBjdH0lYDsKICAgICAgICAgICAgICAgIH0KICAgICAgICB9CgpfaW5pdFBhcnRpY2xlcygpIHsKICAgICAgICAgICAgdGhpcy5hY3RpdmVTcGFya3MgPSBbXTsKICAgICAgICAgICAgdGhpcy5zcGFya1Bvb2wgPSBbXTsKICAgICAgICAgICAgY29uc3QgcG9vbFNpemUgPSA0MDsgLy8gU3VmZmljaWVudCBmb3IgY29udGludW91cyBncmluZGluZwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb29sU2l6ZTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSBuZXcgVEhSRUUuU3ByaXRlKF9zcGFya01hdGVyaWFsLmNsb25lKCkpOwogICAgICAgICAgICAgICAgc3ByaXRlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHNwcml0ZSk7CiAgICAgICAgICAgICAgICB0aGlzLnNwYXJrUG9vbC5wdXNoKHNwcml0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNwYXduQ2xhc2gocG9zLCBpbnRlbnNpdHkgPSAxLjApIHsKICAgICAgICAgICAgLy8gRmluZCBmcmVlIHNwYXJrCiAgICAgICAgICAgIGNvbnN0IHNwYXJrID0gdGhpcy5zcGFya1Bvb2wuZmluZChzID0+ICFzLnZpc2libGUpOwogICAgICAgICAgICBpZiAoIXNwYXJrKSByZXR1cm47IC8vIFBvb2wgZXhoYXVzdGVkCiAgICAgICAgICAgIAogICAgICAgICAgICBzcGFyay5wb3NpdGlvbi5jb3B5KHBvcyk7CiAgICAgICAgICAgIHNwYXJrLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmFuZG9taXplIHJvdGF0aW9uCiAgICAgICAgICAgIHNwYXJrLm1hdGVyaWFsLnJvdGF0aW9uID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsaXplIEFjdGl2ZSBTdGF0ZQogICAgICAgICAgICB0aGlzLmFjdGl2ZVNwYXJrcy5wdXNoKHsKICAgICAgICAgICAgICAgIG1lc2g6IHNwYXJrLAogICAgICAgICAgICAgICAgYWdlOiAwLAogICAgICAgICAgICAgICAgbGlmZTogMC4xNSArIE1hdGgucmFuZG9tKCkgKiAwLjE1LCAvLyBGYXN0LCBwdW5jaHkgc3BhcmtzCiAgICAgICAgICAgICAgICBtYXhTY2FsZTogMi41ICogaW50ZW5zaXR5LAogICAgICAgICAgICAgICAgdmVsb2NpdHk6IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpLTAuNSkqOCwgCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCktMC41KSo4LCAKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpKjgKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfdXBkYXRlUGFydGljbGVzKGR0KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmFjdGl2ZVNwYXJrcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuYWN0aXZlU3BhcmtzW2ldOwogICAgICAgICAgICAgICAgcC5hZ2UgKz0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChwLmFnZSA+PSBwLmxpZmUpIHsKICAgICAgICAgICAgICAgICAgICBwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlU3BhcmtzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgdCA9IHAuYWdlIC8gcC5saWZlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBFeHBhbmQKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRTY2FsZSA9IDAuNSArIChwLm1heFNjYWxlIC0gMC41KSAqIHQ7CiAgICAgICAgICAgICAgICBwLm1lc2guc2NhbGUuc2V0U2NhbGFyKGN1cnJlbnRTY2FsZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZhZGUgb3V0CiAgICAgICAgICAgICAgICBwLm1lc2gubWF0ZXJpYWwub3BhY2l0eSA9IDEuMCAtICh0ICogdCk7IC8vIFF1YWRyYXRpYyBmYWRlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE1vdmUKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5hZGRTY2FsZWRWZWN0b3IocC52ZWxvY2l0eSwgZHQpOwogICAgICAgICAgICAgICAgcC5tZXNoLm1hdGVyaWFsLnJvdGF0aW9uICs9IDEwLjAgKiBkdDsKICAgICAgICAgICAgfQogICAgICAgIH0KCi8vIEhlbHBlciBmb3IgaW1wYWN0IGZyYW1lcwoKdHJpZ2dlckltcGFjdChkdXJhdGlvbiwgdHlwZSA9ICdkZWZhdWx0JykgewogICAgICAgICAgICB0aGlzLmltcGFjdFBhdXNlID0gZHVyYXRpb247CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKICAgICAgICAgICAgaWYgKCFjb250YWluZXIpIHJldHVybjsKCiAgICAgICAgICAgIC8vIFJlc2V0IGNsYXNzZXMgdG8gZW5zdXJlIGFuaW1hdGlvbiByZXN0YXJ0cwogICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZSgnaW1wYWN0LWZ4JywgJ2ltcGFjdC1oZWF2eScsICdpbXBhY3Qtc2hhdHRlcicpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRm9yY2UgcmVmbG93CiAgICAgICAgICAgIHZvaWQgY29udGFpbmVyLm9mZnNldFdpZHRoOwoKICAgICAgICAgICAgbGV0IGNsYXNzTmFtZSA9ICdpbXBhY3QtZngnOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2hlYXZ5JykgY2xhc3NOYW1lID0gJ2ltcGFjdC1oZWF2eSc7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnc2hhdHRlcicpIGNsYXNzTmFtZSA9ICdpbXBhY3Qtc2hhdHRlcic7CgogICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LmFkZChjbGFzc05hbWUpOwoKICAgICAgICAgICAgLy8gQXV0by1yZW1vdmUgY2xhc3MgYWZ0ZXIgZHVyYXRpb24KICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpOwogICAgICAgICAgICB9LCBkdXJhdGlvbiAqIDEwMDAgKyAxMDApOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5HYW1lTWFuYWdlciA9IEdhbWVNYW5hZ2VyOwp9KSgpOw==","AIPlayer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzCiAgICBjb25zdCBfYWlWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3RhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhbkRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhblRvT3BwID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF90ZW1wVmVjMSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlYzIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEFJUGxheWVyIGV4dGVuZHMgd2luZG93LmZsdXguUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSkgewogICAgICAgICAgICBzdXBlcihzY2VuZSwgcm9sZSk7CiAgICAgICAgICAgIHRoaXMuYmFsbFJlZiA9IG51bGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGF0cyBhcmUgbWFuYWdlZCBieSBUZWFtL01haW4gb3IgZGVmYXVsdCBQbGF5ZXIgdmFsdWVzLgogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIC8vIFN0YXRlIE1hY2hpbmUKICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB0aGlzLmRlY2lzaW9uVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLmRlY2lzaW9uSW50ZXJ2YWwgPSAwLjU7IC8vIFNsb3dlciBkZWNpc2lvbnMKCiAgICAgICAgICAgIC8vIC0tLSBQRVJDRVBUSU9OIFNZU1RFTSAoUmVhY3Rpb24gVGltZSkgLS0tCiAgICAgICAgICAgIHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5yZWFjdGlvblNwZWVkID0gMS41OyAKICAgICAgICAgICAgdGhpcy5hbnRpY2lwYXRpb25UaW1lID0gMC4yOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJvbGUgQ29uZmlnCiAgICAgICAgICAgIHRoaXMuaXNGb3J3YXJkID0gWydMRicsICdSRiddLmluY2x1ZGVzKHJvbGUpOwogICAgICAgICAgICB0aGlzLmlzTWlkZmllbGRlciA9IHJvbGUgPT09ICdNRic7CiAgICAgICAgICAgIHRoaXMuaXNEZWZlbmRlciA9IFsnTEQnLCAnUkQnXS5pbmNsdWRlcyhyb2xlKTsKCiAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLl9hc3NpZ25EZWZhdWx0VGVjaHMoKTsKICAgICAgICB9CgogICAgICAgIF9hc3NpZ25EZWZhdWx0VGVjaHMoKSB7CiAgICAgICAgICAgIGNvbnN0IHRhY2tsZVRlY2hzID0gWyd2ZW5vbScsICd3aXRoZXInLCAnZHJhaW4nXTsKICAgICAgICAgICAgY29uc3Qgc2hvb3RUZWNocyA9IFsndmVub20nLCAnc3BoZXJlJywgJ2ludmlzaWJsZSddOwogICAgICAgICAgICBjb25zdCBwYXNzVGVjaHMgPSBbJ3Zlbm9tJywgJ3dpdGhlcicsICduYXAnXTsKICAgICAgICAgICAgY29uc3QgcGFzc2l2ZVRlY2hzID0gWydicmF3bGVyJywgJ2VsaXRlX2RlZmVuc2UnXTsKCiAgICAgICAgICAgIGNvbnN0IHBpY2sgPSAoYXJyKSA9PiBhcnJbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogYXJyLmxlbmd0aCldOwogICAgICAgICAgICBjb25zdCBjaGFuY2UgPSAocHJvYikgPT4gTWF0aC5yYW5kb20oKSA8IHByb2I7CgogICAgICAgICAgICBpZiAodGhpcy5pc0RlZmVuZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMykpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4yKSkgdGhpcy50ZWNocy5wYXNzaXZlID0gcGljayhwYXNzaXZlVGVjaHMpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNNaWRmaWVsZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy5zaG9vdCA9IHBpY2soc2hvb3RUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjMpKSB0aGlzLnRlY2hzLnNob290ID0gcGljayhzaG9vdFRlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy50YWNrbGUgPSBwaWNrKHRhY2tsZVRlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy5wYXNzaXZlID0gcGljayhwYXNzaXZlVGVjaHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQaHlzaWNzKGR0KSB7CiAgICAgICAgICAgIC8vIFNhZmV0eTogQXV0by1saW5rIGJhbGwgaWYgbWlzc2luZwogICAgICAgICAgICBpZiAoIXRoaXMuYmFsbFJlZiAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhbGxSZWYgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgaXNQcmFjdGljZSA9IGdhbWUgJiYgZ2FtZS5nYW1lTW9kZSA9PT0gJ3ByYWN0aWNlJzsKICAgICAgICAgICAgY29uc3QgaXNBY3RpdmUgPSBnYW1lICYmIGdhbWUuc3RhdGUgPT09ICdhY3RpdmUnOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFpc0FjdGl2ZSAmJiAhaXNQcmFjdGljZSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBpc0RlbW8gPSBnYW1lICYmIGdhbWUuaXNEZW1vTW9kZTsKICAgICAgICAgICAgY29uc3QgaXNJbmNhcGFjaXRhdGVkID0gKHRoaXMuc3R1blRpbWVyID4gMCkgfHwgKHRoaXMuc3RhdHVzLm5hcCA+IDApOwogICAgICAgICAgICBjb25zdCBpc0h1bWFuVGVhbSA9IHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uaXNIdW1hbjsKICAgICAgICAgICAgY29uc3QgaXNBY3RpdmVQbGF5ZXIgPSB0aGlzLnRlYW0gJiYgKHRoaXMudGVhbS5hY3RpdmVQbGF5ZXIgPT09IHRoaXMpOwogICAgICAgICAgICBjb25zdCBzaG91bGRSdW5BSSA9ICghaXNIdW1hblRlYW0gfHwgaXNEZW1vIHx8IChpc0h1bWFuVGVhbSAmJiAhaXNBY3RpdmVQbGF5ZXIpKTsKICAgICAgICAgICAgY29uc3QgaXNUZWFtQUlFbmFibGVkID0gdGhpcy50ZWFtID8gdGhpcy50ZWFtLmFpRW5hYmxlZCA6IHRydWU7CgogICAgICAgICAgICBpZiAoaXNJbmNhcGFjaXRhdGVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHNob3VsZFJ1bkFJICYmIGlzVGVhbUFJRW5hYmxlZCkgewogICAgICAgICAgICAgICAgLy8gUGVyY2VwdGlvbiBVcGRhdGUKICAgICAgICAgICAgICAgIGlmICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVhbFRhcmdldCA9IHRoaXMuYmFsbFJlZi5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZi5ob2xkZXIgJiYgdGhpcy5iYWxsUmVmLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQgPSB0aGlzLmJhbGxSZWYuaG9sZGVyLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZi5ob2xkZXIudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQuYWRkU2NhbGVkVmVjdG9yKHRoaXMuYmFsbFJlZi5ob2xkZXIudmVsb2NpdHksIHRoaXMuYW50aWNpcGF0aW9uVGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYmFsbFJlZi52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgICAgICByZWFsVGFyZ2V0LmFkZFNjYWxlZFZlY3Rvcih0aGlzLmJhbGxSZWYudmVsb2NpdHksIHRoaXMuYW50aWNpcGF0aW9uVGltZSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFscGhhID0gTWF0aC5taW4oMS4wLCBkdCAqIHRoaXMucmVhY3Rpb25TcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJjZWl2ZWRUYXJnZXRQb3MubGVycChyZWFsVGFyZ2V0LCBhbHBoYSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRGVjaXNpb24KICAgICAgICAgICAgICAgIHRoaXMuZGVjaXNpb25UaW1lciArPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlY2lzaW9uVGltZXIgPiB0aGlzLmRlY2lzaW9uSW50ZXJ2YWwpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRlY2lzaW9uVGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2V2YWx1YXRlU3RhdGUoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBFeGVjdXRpb24KICAgICAgICAgICAgICAgIHRoaXMuX2V4ZWN1dGVTdGF0ZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEludGVyY2VwdGlvbgogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaEltbXVuaXR5VGltZXIgPiAwKSB0aGlzLnRlY2hJbW11bml0eVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnRlcmNlcHRpb25QcmVzc3VyZShkdCk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSHVtYW4gY29udHJvbGxlZCBvciBkaXNhYmxlZAogICAgICAgICAgICAgICAgY29uc3QgaXNEcml2ZW5CeUh1bWFuID0gaXNIdW1hblRlYW0gJiYgaXNBY3RpdmVQbGF5ZXIgJiYgIWlzRGVtbzsKICAgICAgICAgICAgICAgIGlmICghaXNEcml2ZW5CeUh1bWFuKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5SW50ZXJjZXB0aW9uUHJlc3N1cmUoZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzdXBlci51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgc3VwZXIudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKICAgICAgICBfZXZhbHVhdGVTdGF0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmJhbGxSZWYpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdBVFRBQ0tfQ0FSUlknOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWJhbGwuaG9sZGVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnUkVUVVJOX0hPTUUnOwogICAgICAgICAgICAgICAgY29uc3QgYmlhcyA9ICh0aGlzLmFpU3RhdGUgPT09ICdDSEFTRScpID8gMC44IDogMS4wOwogICAgICAgICAgICAgICAgY29uc3QgbXlEaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKSAqIGJpYXM7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBpc0Nsb3Nlc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcCBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocCA9PT0gdGhpcykgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAucm9sZSA9PT0gJ0dMJykgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnN0YXR1cyAmJiBwLnN0YXR1cy5uYXAgPiAwKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBEaXN0ID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBEaXN0IDwgbXlEaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0Nsb3Nlc3QgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChpc0Nsb3Nlc3QpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnQ0hBU0UnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIudGVhbSA9PT0gdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnU1VQUE9SVCc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlci50ZWFtICE9PSB0aGlzLnRlYW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdERUZFTkQnOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfZXhlY3V0ZVN0YXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzd2l0Y2ggKHRoaXMuYWlTdGF0ZSkgewogICAgICAgICAgICAgICAgY2FzZSAnQVRUQUNLX0NBUlJZJzogdGhpcy5fc3RhdGVBdHRhY2tDYXJyeShkdCk7IGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnU1VQUE9SVCc6IHRoaXMuX3N0YXRlU3VwcG9ydChkdCk7IGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnREVGRU5EJzogdGhpcy5fc3RhdGVEZWZlbmQoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0NIQVNFJzogdGhpcy5fc3RhdGVDaGFzZShkdCk7IGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnUkVUVVJOX0hPTUUnOiAKICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHRoaXMuX3N0YXRlUmV0dXJuSG9tZShkdCk7IGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfc3RhdGVBdHRhY2tDYXJyeShkdCkgewogICAgICAgICAgICBjb25zdCBhdHRhY2tEaXIgPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLTEgOiAxOwpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsWiA9IGdvYWxEaXN0ICogYXR0YWNrRGlyOwogICAgICAgICAgICAKICAgICAgICAgICAgX3RhcmdldFBvcy5zZXQoMCwgMCwgZ29hbFopOwogICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKCiAgICAgICAgICAgIGNvbnN0IGRpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChkaXN0VG9Hb2FsIDwgMjAuMCAmJiAhdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zbWFydFRocm93KHRoaXMuYmFsbFJlZiwgJ1NIJyk7IAogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBpc1N1cnJvdW5kZWQgPSB0aGlzLl9pc1N1cnJvdW5kZWQoKTsKICAgICAgICAgICAgY29uc3QgbG93RU4gPSB0aGlzLmN1cnJlbnRFTiA8IDEwOwogICAgICAgICAgICBjb25zdCBpc1BsYXltYWtlciA9IHRoaXMuaXNNaWRmaWVsZGVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKChpc1N1cnJvdW5kZWQgfHwgbG93RU4gfHwgaXNQbGF5bWFrZXIpICYmICF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJlc3RNYXRlID0gdGhpcy5fZmluZEJlc3RQYXNzVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICBpZiAoYmVzdE1hdGUpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgc2hvdWxkUGFzcyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGlmIChpc1N1cnJvdW5kZWQgfHwgbG93RU4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvdWxkUGFzcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc1BsYXltYWtlcikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBteURpc3QgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0ZURpc3QgPSBNYXRoLmFicyhiZXN0TWF0ZS5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRlRGlzdCA8IG15RGlzdCAtIDUuMCkgc2hvdWxkUGFzcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIChzaG91bGRQYXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoYmVzdE1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3NtYXJ0VGhyb3codGhpcy5iYWxsUmVmLCAnUEEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGlzU3Vycm91bmRlZCAmJiAhdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zbWFydFRocm93KHRoaXMuYmFsbFJlZiwgJ1NIJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9pc1N1cnJvdW5kZWQoKSB7CiAgICAgICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmIChwLm1lc2ggJiYgcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5tZXNoLnBvc2l0aW9uKSA8IDQuMCkgewogICAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvdW50ID49IDI7CiAgICAgICAgfQoKICAgICAgICBfc21hcnRUaHJvdyhiYWxsLCBmb3JjZWRUeXBlID0gbnVsbCkgewogICAgICAgICAgICBsZXQgdHlwZSA9IGZvcmNlZFR5cGU7CiAgICAgICAgICAgIGlmICghdHlwZSkgewogICAgICAgICAgICAgICAgX3RlbXBWZWMxLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgY29uc3QgYXR0YWNrRGlyID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtMSA6IDE7CiAgICAgICAgICAgICAgICBjb25zdCBpc0FpbWluZ0dvYWwgPSAoX3RlbXBWZWMxLnogKiBhdHRhY2tEaXIgPiAwLjUpOwogICAgICAgICAgICAgICAgdHlwZSA9IGlzQWltaW5nR29hbCA/ICdTSCcgOiAnUEEnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCB0ZWNoTmFtZSA9ICh0eXBlID09PSAnU0gnKSA/IHRoaXMudGVjaHMuc2hvb3QgOiB0aGlzLnRlY2hzLnBhc3M7CiAgICAgICAgICAgIGxldCBiYXNlQ29zdCA9ICh0eXBlID09PSAnU0gnKSA/IDIwIDogMTA7CiAgICAgICAgICAgIGxldCB0ZWNoQ29zdCA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh0ZWNoTmFtZS5pbmNsdWRlcygnbmFwJykpIHRlY2hDb3N0ID0gMzA7CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNoTmFtZS5pbmNsdWRlcygnc3BoZXJlJykgfHwgdGVjaE5hbWUuaW5jbHVkZXMoJ2ludmlzaWJsZScpKSB0ZWNoQ29zdCA9IDI1OwogICAgICAgICAgICAgICAgZWxzZSB0ZWNoQ29zdCA9IDIwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCB0b3RhbENvc3QgPSBiYXNlQ29zdCArIHRlY2hDb3N0OwogICAgICAgICAgICBsZXQgdGVtcFRlY2ggPSBudWxsOwogICAgICAgICAgICBpZiAodGVjaE5hbWUgJiYgdGhpcy5zdGF0cy5IUCA8IHRvdGFsQ29zdCAmJiB0aGlzLnN0YXRzLkhQID49IGJhc2VDb3N0KSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgIHRlbXBUZWNoID0gdGhpcy50ZWNocy5zaG9vdDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlY2hzLnNob290ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGVtcFRlY2ggPSB0aGlzLnRlY2hzLnBhc3M7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWNocy5wYXNzID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgdHlwZSk7CgogICAgICAgICAgICBpZiAodGVtcFRlY2gpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB0aGlzLnRlY2hzLnNob290ID0gdGVtcFRlY2g7CiAgICAgICAgICAgICAgICBlbHNlIHRoaXMudGVjaHMucGFzcyA9IHRlbXBUZWNoOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfc3RhdGVDaGFzZShkdCkgewogICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGhpcy5wZXJjZWl2ZWRUYXJnZXRQb3MpOwogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5iYWxsUmVmOwogICAgICAgICAgICBpZiAoYmFsbC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMS4wKSB7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmFkZFNjYWxlZFZlY3RvcihiYWxsLnZlbG9jaXR5LCAwLjMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwogICAgICAgIH0KCiAgICAgICAgX3N0YXRlUmV0dXJuSG9tZShkdCkgewogICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGhpcy5ob21lUG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICB9CgogICAgICAgIF9zdGF0ZVN1cHBvcnQoZHQpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKICAgICAgICAgICAgY29uc3QgY2FycmllciA9IGJhbGwuaG9sZGVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFjYXJyaWVyIHx8ICFjYXJyaWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0YXRlUmV0dXJuSG9tZShkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGJhbGxQb3MgPSBjYXJyaWVyLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IGF0dGFja0RpciA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtMSA6IDE7CmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC1nb2FsRGlzdCA6IGdvYWxEaXN0OwoKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSB0aGlzLl9jYWxjdWxhdGVQcmVzc3VyZU9uUGxheWVyKGNhcnJpZXIpOwoKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgX3RhcmdldFBvcy56ICs9IGJhbGxQb3MueiAqIDAuNjsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgbGV0IHRhcmdldFogPSBiYWxsUG9zLnogKyAoYXR0YWNrRGlyICogMTUuMCk7IAogICAgICAgICAgICAgICAgaWYgKHByZXNzdXJlID4gMC44KSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0WiA9IGJhbGxQb3MueiArIChhdHRhY2tEaXIgKiA4LjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IERhdGUubm93KCkgKiAwLjAwMTsKICAgICAgICAgICAgICAgIGNvbnN0IHdlYXZlID0gTWF0aC5zaW4odGltZSArIHRoaXMubWVzaC5pZCkgKiA2LjA7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnggPSB0aGlzLmhvbWVQb3NpdGlvbi54ICsgd2VhdmU7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSB0YXJnZXRaOwoKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzTWlkZmllbGRlcikgewogICAgICAgICAgICAgICAgaWYgKHByZXNzdXJlID4gMC44KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2lkZSA9ICh0aGlzLm1lc2gucG9zaXRpb24ueCA+IGJhbGxQb3MueCkgPyAxIDogLTE7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy54ID0gYmFsbFBvcy54ICsgKHNpZGUgKiAxMC4wKTsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSBiYWxsUG9zLnogLSAoYXR0YWNrRGlyICogMi4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWlkWiA9IChiYWxsUG9zLnogKyBnb2FsWikgKiAwLjQ1OwogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueiA9IG1pZFo7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJhbGxQb3MueCA8IC01KSBfdGFyZ2V0UG9zLnggPSA1OwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGJhbGxQb3MueCA+IDUpIF90YXJnZXRQb3MueCA9IC01OwogICAgICAgICAgICAgICAgICAgIGVsc2UgX3RhcmdldFBvcy54ID0gKHRoaXMuaG9tZVBvc2l0aW9uLnggPiAwID8gOCA6IC04KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBzYWZldHlEaXN0ID0gMTIuMDsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueiA9IGJhbGxQb3MueiAtIChhdHRhY2tEaXIgKiBzYWZldHlEaXN0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgX3RhcmdldFBvcy56ID0gTWF0aC5taW4oMzgsIF90YXJnZXRQb3Mueik7CiAgICAgICAgICAgICAgICBlbHNlIF90YXJnZXRQb3MueiA9IE1hdGgubWF4KC0zOCwgX3RhcmdldFBvcy56KTsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueCA9IGJhbGxQb3MueCAqIDAuNiArIHRoaXMuaG9tZVBvc2l0aW9uLnggKiAwLjQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLl9pc1BhdGhCbG9ja2VkKF90YXJnZXRQb3MsIGJhbGxQb3MpKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEuY29weShfdGFyZ2V0UG9zKTsgX3RlbXBWZWMxLnggLT0gOC4wOwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLmNvcHkoX3RhcmdldFBvcyk7IF90ZW1wVmVjMi54ICs9IDguMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYmxvY2tlZEwgPSB0aGlzLl9pc1BhdGhCbG9ja2VkKF90ZW1wVmVjMSwgYmFsbFBvcyk7CiAgICAgICAgICAgICAgICBjb25zdCBibG9ja2VkUiA9IHRoaXMuX2lzUGF0aEJsb2NrZWQoX3RlbXBWZWMyLCBiYWxsUG9zKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCFibG9ja2VkTCAmJiAhYmxvY2tlZFIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoX3RhcmdldFBvcy54IC0gX3RlbXBWZWMxLngpIDwgTWF0aC5hYnMoX3RhcmdldFBvcy54IC0gX3RlbXBWZWMyLngpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzEpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWJsb2NrZWRMKSB7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KF90ZW1wVmVjMSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFibG9ja2VkUikgewogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmxlcnAoYmFsbFBvcywgMC40KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fYXZvaWRUZWFtbWF0ZXMoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwogICAgICAgIH0KCiAgICAgICAgX3N0YXRlRGVmZW5kKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldFBvcyA9IHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zOwogICAgICAgICAgICBjb25zdCBkaXN0VG9CYWxsID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGFyZ2V0UG9zKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGxldCBwcmVzc1JhbmdlID0gdGhpcy5pc0RlZmVuZGVyID8gMTIuMCA6IDguMDsKICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMudGFja2xlICYmIHRoaXMuc3RhdHMuSFAgPiAyMCkgewogICAgICAgICAgICAgICAgcHJlc3NSYW5nZSArPSA1LjA7IAogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgYW1JQ2xvc2VzdCA9IHRydWU7CiAgICAgICAgICAgIGNvbnN0IG15RGlzdFNxID0gZGlzdFRvQmFsbCAqIGRpc3RUb0JhbGw7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBmb3IoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgICAgIGlmIChtYXRlID09PSB0aGlzIHx8ICFtYXRlLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIGlmIChtYXRlLnJvbGUgPT09ICdHTCcgfHwgbWF0ZS5zdGF0dXMubmFwID4gMCB8fCBtYXRlLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRTcSA9IG1hdGUubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvU3F1YXJlZCh0YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgICAgIGlmIChkU3EgPCBteURpc3RTcSkgewogICAgICAgICAgICAgICAgICAgICAgICBhbUlDbG9zZXN0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKaWYgKGFtSUNsb3Nlc3QpIHsKICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgPSAxMDAuMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb015R29hbCA9IE1hdGguYWJzKHRhcmdldFBvcy56IC0gKHRoaXMudGVhbS5zaWRlID09PSAxID8gNDQuNSA6IC00NC41KSk7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvTXlHb2FsIDwgMjAuMCkgewogICAgICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgPSAxNS4wOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwcmVzc1JhbmdlID0gOC4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoZGlzdFRvQmFsbCA8IHByZXNzUmFuZ2UpIHsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMy4wICYmICF0aGlzLmlzRGFzaGluZyAmJiB0aGlzLmN1cnJlbnRFTiA+IDUgJiYgTWF0aC5yYW5kb20oKSA8IDAuMDIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBfdGVtcFZlYzEuc3ViVmVjdG9ycyh0YXJnZXRQb3MsIHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlyLmFkZFNjYWxlZFZlY3Rvcih0aGlzLmJhbGxSZWYudmVsb2NpdHksIDAuMSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuZGFzaChkaXIueCwgZGlyLnopOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWFya2luZyAmJiB0aGlzLm1hcmtpbmcubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgbWFya1BvcyA9IHRoaXMubWFya2luZy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgbXlHb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyA0NiA6IC00NjsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5zZXQoMCwgMCwgbXlHb2FsWiAtIG1hcmtQb3Mueik7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkobWFya1BvcykuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjMSwgMy41KTsKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgX3RhcmdldFBvcy56ICs9IHRoaXMuYmFsbFJlZi5tZXNoLnBvc2l0aW9uLnogKiAwLjY7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5pc0RlZmVuZGVyKSB7CmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IG15R29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gZ29hbERpc3QgOiAtZ29hbERpc3Q7CiAgICAgICAgICAgICAgICBjb25zdCBtaWRwb2ludCA9ICh0aGlzLmJhbGxSZWYubWVzaC5wb3NpdGlvbi56ICsgbXlHb2FsWikgKiAwLjU7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSAoX3RhcmdldFBvcy56ICsgbWlkcG9pbnQpICogMC41OwogICAgICAgICAgICB9Cgpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBsaW1pdFogPSBnb2FsRGlzdCAtIDIuNTsKICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gTWF0aC5tYXgoLWxpbWl0WiwgTWF0aC5taW4obGltaXRaLCBfdGFyZ2V0UG9zLnopKTsKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CiAgICAgICAgfQoKICAgICAgICBfYXZvaWRHb2FsQ3JlYXNlKHRhcmdldFBvcykgewogICAgICAgICAgICBjb25zdCBjcmVhc2VSYWRpdXMgPSAxMC4wOwpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FscyA9IFt7IHg6IDAsIHo6IC1nb2FsRGlzdCB9LCB7IHg6IDAsIHo6IGdvYWxEaXN0IH1dOwoKICAgICAgICAgICAgZ29hbHMuZm9yRWFjaChnb2FsID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGR4ID0gdGFyZ2V0UG9zLnggLSBnb2FsLng7CiAgICAgICAgICAgICAgICBjb25zdCBkeiA9IHRhcmdldFBvcy56IC0gZ29hbC56OwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFNxID0gZHgqZHggKyBkeipkejsKCiAgICAgICAgICAgICAgICBpZiAoZGlzdFNxIDwgY3JlYXNlUmFkaXVzICogY3JlYXNlUmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkaXN0U3EpOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gMC4wMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBjcmVhc2VSYWRpdXMgLyBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MueCA9IGdvYWwueCArIGR4ICogcmF0aW87CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy56ID0gZ29hbC56ICsgZHogKiByYXRpbzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MueiA9IGdvYWwueiArIChnb2FsLnogPiAwID8gLWNyZWFzZVJhZGl1cyA6IGNyZWFzZVJhZGl1cyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNvbnN0IGFyZW5hUmFkaXVzID0gNDUuMDsKICAgICAgICAgICAgY29uc3QgZFNxID0gdGFyZ2V0UG9zLnggKiB0YXJnZXRQb3MueCArIHRhcmdldFBvcy56ICogdGFyZ2V0UG9zLno7CiAgICAgICAgICAgIGlmIChkU3EgPiBhcmVuYVJhZGl1cyphcmVuYVJhZGl1cykgewogICAgICAgICAgICAgICAgY29uc3QgZCA9IE1hdGguc3FydChkU3EpOwogICAgICAgICAgICAgICAgY29uc3QgciA9IGFyZW5hUmFkaXVzIC8gZDsKICAgICAgICAgICAgICAgIHRhcmdldFBvcy54ICo9IHI7CiAgICAgICAgICAgICAgICB0YXJnZXRQb3MueiAqPSByOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfZmluZEJlc3RQYXNzVGFyZ2V0KCkgewogICAgICAgICAgICBsZXQgYmVzdFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIGxldCBtYXhTY29yZSA9IC1JbmZpbml0eTsKY29uc3QgZ29hbERpc3QgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UgfHwgNDEuNTsKICAgICAgICAgICAgY29uc3QgZ29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CgogICAgICAgICAgICBmb3IgKGNvbnN0IG1hdGUgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmIChtYXRlID09PSB0aGlzKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmICghbWF0ZS5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChtYXRlLnN0YXR1cy5uYXAgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChtYXRlLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8obWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgNC4wKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gMzAuMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9pc1BhdGhCbG9ja2VkKG1hdGUubWVzaC5wb3NpdGlvbikpIGNvbnRpbnVlOyAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHNjb3JlID0gMDsKICAgICAgICAgICAgICAgIGNvbnN0IG15RGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgY29uc3QgbWF0ZURpc3RUb0dvYWwgPSBNYXRoLmFicyhtYXRlLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gbXlEaXN0VG9Hb2FsIC0gbWF0ZURpc3RUb0dvYWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNjb3JlICs9IHByb2dyZXNzICogMS41OyAKICAgICAgICAgICAgICAgIGlmIChtYXRlRGlzdFRvR29hbCA8IDE1LjApIHNjb3JlICs9IDEwLjA7CiAgICAgICAgICAgICAgICBpZiAobWF0ZURpc3RUb0dvYWwgPCA4LjApIHNjb3JlICs9IDE1LjA7CgogICAgICAgICAgICAgICAgY29uc3Qgb3Blbm5lc3MgPSB0aGlzLl9jYWxjdWxhdGVPcGVubmVzcyhtYXRlKTsKICAgICAgICAgICAgICAgIHNjb3JlICs9IG9wZW5uZXNzICogMy4wOwoKICAgICAgICAgICAgICAgIGlmIChtYXRlLmlzRm9yd2FyZCkgc2NvcmUgKz0gNS4wOwogICAgICAgICAgICAgICAgc2NvcmUgLT0gZGlzdCAqIDAuNTsKCiAgICAgICAgICAgICAgICBpZiAoc2NvcmUgPiBtYXhTY29yZSkgewogICAgICAgICAgICAgICAgICAgIG1heFNjb3JlID0gc2NvcmU7CiAgICAgICAgICAgICAgICAgICAgYmVzdFRhcmdldCA9IG1hdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJlc3RUYXJnZXQ7CiAgICAgICAgfQoKICAgICAgICBfY2FsY3VsYXRlT3Blbm5lc3MocGxheWVyKSB7CiAgICAgICAgICAgIGxldCBtaW5EZWZEaXN0ID0gOTk5OwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiAwOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKCiAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCB8fCBvcHAuc3RhdHVzLm5hcCA+IDAgfHwgb3BwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZCA9IHBsYXllci5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGQgPCBtaW5EZWZEaXN0KSBtaW5EZWZEaXN0ID0gZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gTWF0aC5taW4obWluRGVmRGlzdCwgOC4wKTsKICAgICAgICB9CgogICAgICAgIF9pc1BhdGhCbG9ja2VkKHRhcmdldFBvcywgc3RhcnRQb3MgPSBudWxsKSB7CiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gc3RhcnRQb3MgfHwgdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBlbmQgPSB0YXJnZXRQb3M7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBzdGFydC5kaXN0YW5jZVRvKGVuZCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBfc2NhbkRpci5zdWJWZWN0b3JzKGVuZCwgc3RhcnQpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAodGhpcy50ZWFtLmlkID09PSAnaG9tZScpID8gZ2FtZS50ZWFtcy5hd2F5IDogZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBjb25zdCBzYWZldHlSYWRpdXMgPSAyLjU7IAoKICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9wcC5tZXNoIHx8IG9wcC5zdGF0dXMubmFwID4gMCB8fCBvcHAuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9zY2FuVG9PcHAuc3ViVmVjdG9ycyhvcHAubWVzaC5wb3NpdGlvbiwgc3RhcnQpOwogICAgICAgICAgICAgICAgY29uc3QgcHJvamVjdGlvbiA9IF9zY2FuVG9PcHAuZG90KF9zY2FuRGlyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHByb2plY3Rpb24gPiAwICYmIHByb2plY3Rpb24gPCBkaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGVycERpc3RTcSA9IF9zY2FuVG9PcHAubGVuZ3RoU3EoKSAtIChwcm9qZWN0aW9uICogcHJvamVjdGlvbik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBlcnBEaXN0U3EgPCAoc2FmZXR5UmFkaXVzICogc2FmZXR5UmFkaXVzKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgX21vdmVUbyh0YXJnZXQpIHsKICAgICAgICAgICAgX2FpVmVjLnN1YlZlY3RvcnModGFyZ2V0LCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICBfYWlWZWMueSA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBfYWlWZWMubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKGRpc3RTcSA+IDEuMCkgewogICAgICAgICAgICAgICAgX2FpVmVjLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dChfYWlWZWMueCwgX2FpVmVjLnopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC44KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5SW50ZXJjZXB0aW9uUHJlc3N1cmUoZHQpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIGlmIChiYWxsLnN0YXRlICE9PSAnZnJlZScgfHwgYmFsbC52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMS4wKSByZXR1cm47CiAgICAgICAgICAgIGlmIChiYWxsLmlzSW52aXNpYmxlKSByZXR1cm47CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IHJhbmdlID0gMi4wOwogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5wYXNzaXZlID09PSAnYnJhd2xlcicgfHwgdGhpcy50ZWNocy5wYXNzaXZlID09PSAnZWxpdGVfZGVmZW5zZScpIHsKICAgICAgICAgICAgICAgIHJhbmdlICs9IDEuNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIGlmIChkaXN0ID4gcmFuZ2UpIHJldHVybjsKCiAgICAgICAgICAgIF9zY2FuVG9PcHAuc3ViVmVjdG9ycyh0aGlzLm1lc2gucG9zaXRpb24sIGJhbGwubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIF90ZW1wVmVjMS5jb3B5KGJhbGwudmVsb2NpdHkpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaGVhZGluZ0RvdCA9IF90ZW1wVmVjMS5kb3QoX3NjYW5Ub09wcCk7CiAgICAgICAgICAgIGlmIChoZWFkaW5nRG90IDwgMC43KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBkaXN0RmFjdG9yID0gTWF0aC5tYXgoMCwgMS4wIC0gKGRpc3QgLyByYW5nZSkpOwogICAgICAgICAgICBjb25zdCBwcmVzc3VyZSA9IDEuNTsKCiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlciAtPSBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgPSAodGhpcy5fYWNjdW11bGF0ZWRCbG9jayB8fCAwKSArIHByZXNzdXJlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgPj0gNS4wKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IE1hdGguZmxvb3IodGhpcy5fYWNjdW11bGF0ZWRCbG9jayk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRCbG9jayAtPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsgCiAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGAtJHt2YWx9YCwgYmFsbC5tZXNoLnBvc2l0aW9uLCAiYmxvY2siLCBiYWxsLm1lc2gpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAoZGlzdEZhY3RvciAqIDAuOCkpIHsgCiAgICAgICAgICAgICAgICBfdGVtcFZlYzIuY29weSh0aGlzLm1lc2gucG9zaXRpb24pLmxlcnAoYmFsbC5tZXNoLnBvc2l0aW9uLCAwLjUgKyAoTWF0aC5yYW5kb20oKS0wLjUpKjAuMik7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzIueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLnkgKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zcGF3bkNsYXNoKF90ZW1wVmVjMiwgMC42KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCAmJiBiYWxsLnBvd2VyVHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlclR5cGUgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgeyAKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTE9DS0VEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiYWxsLnRlY2huaXF1ZSAmJiB0aGlzLnRlY2hJbW11bml0eVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICBjb25zdCB0ZWNoID0gYmFsbC50ZWNobmlxdWU7CiAgICAgICAgICAgICAgICBpZiAodGVjaC50eXBlID09PSAndmVub20nKSB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDE1LjApOwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaC50eXBlID09PSAnbmFwJykgdGhpcy5hcHBseVN0YXR1cygnbmFwJywgOC4wKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2gudHlwZSA9PT0gJ3dpdGhlcicpIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDE1LjAsICdCTCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2FsY3VsYXRlUHJlc3N1cmVPblBsYXllcihwbGF5ZXIpIHsKICAgICAgICAgICAgaWYgKCFwbGF5ZXIgfHwgIXBsYXllci5tZXNoKSByZXR1cm4gMDsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm4gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAocGxheWVyLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGxldCBwcmVzc3VyZSA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2ggfHwgb3BwLnN0YXR1cy5uYXAgPiAwIHx8IG9wcC5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBwbGF5ZXIubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG9wcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgMTAuMCkgewogICAgICAgICAgICAgICAgICAgIHByZXNzdXJlICs9ICgxMC4wIC0gZGlzdCkgLyAxMC4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcmVzc3VyZTsKICAgICAgICB9CgogICAgICAgIF9hdm9pZFRlYW1tYXRlcyh0YXJnZXRQb3MpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW0pIHJldHVybjsKICAgICAgICAgICAgZm9yIChjb25zdCBtYXRlIG9mIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcyB8fCAhbWF0ZS5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChtYXRlLmhhc0JhbGwpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGFyZ2V0UG9zLmRpc3RhbmNlVG8obWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgX3RlbXBWZWMxLnN1YlZlY3RvcnModGFyZ2V0UG9zLCBtYXRlLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMxLCA1LjAgLSBkaXN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5BSVBsYXllciA9IEFJUGxheWVyOwp9KSgpOw==","./AIPlayer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzCiAgICBjb25zdCBfYWlWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3RhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhbkRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhblRvT3BwID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF90ZW1wVmVjMSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlYzIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEFJUGxheWVyIGV4dGVuZHMgd2luZG93LmZsdXguUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSkgewogICAgICAgICAgICBzdXBlcihzY2VuZSwgcm9sZSk7CiAgICAgICAgICAgIHRoaXMuYmFsbFJlZiA9IG51bGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGF0cyBhcmUgbWFuYWdlZCBieSBUZWFtL01haW4gb3IgZGVmYXVsdCBQbGF5ZXIgdmFsdWVzLgogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIC8vIFN0YXRlIE1hY2hpbmUKICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB0aGlzLmRlY2lzaW9uVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLmRlY2lzaW9uSW50ZXJ2YWwgPSAwLjU7IC8vIFNsb3dlciBkZWNpc2lvbnMKCiAgICAgICAgICAgIC8vIC0tLSBQRVJDRVBUSU9OIFNZU1RFTSAoUmVhY3Rpb24gVGltZSkgLS0tCiAgICAgICAgICAgIHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5yZWFjdGlvblNwZWVkID0gMS41OyAKICAgICAgICAgICAgdGhpcy5hbnRpY2lwYXRpb25UaW1lID0gMC4yOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJvbGUgQ29uZmlnCiAgICAgICAgICAgIHRoaXMuaXNGb3J3YXJkID0gWydMRicsICdSRiddLmluY2x1ZGVzKHJvbGUpOwogICAgICAgICAgICB0aGlzLmlzTWlkZmllbGRlciA9IHJvbGUgPT09ICdNRic7CiAgICAgICAgICAgIHRoaXMuaXNEZWZlbmRlciA9IFsnTEQnLCAnUkQnXS5pbmNsdWRlcyhyb2xlKTsKCiAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLl9hc3NpZ25EZWZhdWx0VGVjaHMoKTsKICAgICAgICB9CgogICAgICAgIF9hc3NpZ25EZWZhdWx0VGVjaHMoKSB7CiAgICAgICAgICAgIGNvbnN0IHRhY2tsZVRlY2hzID0gWyd2ZW5vbScsICd3aXRoZXInLCAnZHJhaW4nXTsKICAgICAgICAgICAgY29uc3Qgc2hvb3RUZWNocyA9IFsndmVub20nLCAnc3BoZXJlJywgJ2ludmlzaWJsZSddOwogICAgICAgICAgICBjb25zdCBwYXNzVGVjaHMgPSBbJ3Zlbm9tJywgJ3dpdGhlcicsICduYXAnXTsKICAgICAgICAgICAgY29uc3QgcGFzc2l2ZVRlY2hzID0gWydicmF3bGVyJywgJ2VsaXRlX2RlZmVuc2UnXTsKCiAgICAgICAgICAgIGNvbnN0IHBpY2sgPSAoYXJyKSA9PiBhcnJbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogYXJyLmxlbmd0aCldOwogICAgICAgICAgICBjb25zdCBjaGFuY2UgPSAocHJvYikgPT4gTWF0aC5yYW5kb20oKSA8IHByb2I7CgogICAgICAgICAgICBpZiAodGhpcy5pc0RlZmVuZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMykpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4yKSkgdGhpcy50ZWNocy5wYXNzaXZlID0gcGljayhwYXNzaXZlVGVjaHMpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNNaWRmaWVsZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy5zaG9vdCA9IHBpY2soc2hvb3RUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjMpKSB0aGlzLnRlY2hzLnNob290ID0gcGljayhzaG9vdFRlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy50YWNrbGUgPSBwaWNrKHRhY2tsZVRlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy5wYXNzaXZlID0gcGljayhwYXNzaXZlVGVjaHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQaHlzaWNzKGR0KSB7CiAgICAgICAgICAgIC8vIFNhZmV0eTogQXV0by1saW5rIGJhbGwgaWYgbWlzc2luZwogICAgICAgICAgICBpZiAoIXRoaXMuYmFsbFJlZiAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhbGxSZWYgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgaXNQcmFjdGljZSA9IGdhbWUgJiYgZ2FtZS5nYW1lTW9kZSA9PT0gJ3ByYWN0aWNlJzsKICAgICAgICAgICAgY29uc3QgaXNBY3RpdmUgPSBnYW1lICYmIGdhbWUuc3RhdGUgPT09ICdhY3RpdmUnOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFpc0FjdGl2ZSAmJiAhaXNQcmFjdGljZSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBpc0RlbW8gPSBnYW1lICYmIGdhbWUuaXNEZW1vTW9kZTsKICAgICAgICAgICAgY29uc3QgaXNJbmNhcGFjaXRhdGVkID0gKHRoaXMuc3R1blRpbWVyID4gMCkgfHwgKHRoaXMuc3RhdHVzLm5hcCA+IDApOwogICAgICAgICAgICBjb25zdCBpc0h1bWFuVGVhbSA9IHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uaXNIdW1hbjsKICAgICAgICAgICAgY29uc3QgaXNBY3RpdmVQbGF5ZXIgPSB0aGlzLnRlYW0gJiYgKHRoaXMudGVhbS5hY3RpdmVQbGF5ZXIgPT09IHRoaXMpOwogICAgICAgICAgICBjb25zdCBzaG91bGRSdW5BSSA9ICghaXNIdW1hblRlYW0gfHwgaXNEZW1vIHx8IChpc0h1bWFuVGVhbSAmJiAhaXNBY3RpdmVQbGF5ZXIpKTsKICAgICAgICAgICAgY29uc3QgaXNUZWFtQUlFbmFibGVkID0gdGhpcy50ZWFtID8gdGhpcy50ZWFtLmFpRW5hYmxlZCA6IHRydWU7CgogICAgICAgICAgICBpZiAoaXNJbmNhcGFjaXRhdGVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHNob3VsZFJ1bkFJICYmIGlzVGVhbUFJRW5hYmxlZCkgewogICAgICAgICAgICAgICAgLy8gUGVyY2VwdGlvbiBVcGRhdGUKICAgICAgICAgICAgICAgIGlmICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVhbFRhcmdldCA9IHRoaXMuYmFsbFJlZi5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZi5ob2xkZXIgJiYgdGhpcy5iYWxsUmVmLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQgPSB0aGlzLmJhbGxSZWYuaG9sZGVyLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZi5ob2xkZXIudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQuYWRkU2NhbGVkVmVjdG9yKHRoaXMuYmFsbFJlZi5ob2xkZXIudmVsb2NpdHksIHRoaXMuYW50aWNpcGF0aW9uVGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYmFsbFJlZi52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgICAgICByZWFsVGFyZ2V0LmFkZFNjYWxlZFZlY3Rvcih0aGlzLmJhbGxSZWYudmVsb2NpdHksIHRoaXMuYW50aWNpcGF0aW9uVGltZSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFscGhhID0gTWF0aC5taW4oMS4wLCBkdCAqIHRoaXMucmVhY3Rpb25TcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJjZWl2ZWRUYXJnZXRQb3MubGVycChyZWFsVGFyZ2V0LCBhbHBoYSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRGVjaXNpb24KICAgICAgICAgICAgICAgIHRoaXMuZGVjaXNpb25UaW1lciArPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlY2lzaW9uVGltZXIgPiB0aGlzLmRlY2lzaW9uSW50ZXJ2YWwpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRlY2lzaW9uVGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2V2YWx1YXRlU3RhdGUoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBFeGVjdXRpb24KICAgICAgICAgICAgICAgIHRoaXMuX2V4ZWN1dGVTdGF0ZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEludGVyY2VwdGlvbgogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaEltbXVuaXR5VGltZXIgPiAwKSB0aGlzLnRlY2hJbW11bml0eVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnRlcmNlcHRpb25QcmVzc3VyZShkdCk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSHVtYW4gY29udHJvbGxlZCBvciBkaXNhYmxlZAogICAgICAgICAgICAgICAgY29uc3QgaXNEcml2ZW5CeUh1bWFuID0gaXNIdW1hblRlYW0gJiYgaXNBY3RpdmVQbGF5ZXIgJiYgIWlzRGVtbzsKICAgICAgICAgICAgICAgIGlmICghaXNEcml2ZW5CeUh1bWFuKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5SW50ZXJjZXB0aW9uUHJlc3N1cmUoZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzdXBlci51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgc3VwZXIudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKICAgICAgICBfZXZhbHVhdGVTdGF0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmJhbGxSZWYpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdBVFRBQ0tfQ0FSUlknOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWJhbGwuaG9sZGVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnUkVUVVJOX0hPTUUnOwogICAgICAgICAgICAgICAgY29uc3QgYmlhcyA9ICh0aGlzLmFpU3RhdGUgPT09ICdDSEFTRScpID8gMC44IDogMS4wOwogICAgICAgICAgICAgICAgY29uc3QgbXlEaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKSAqIGJpYXM7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBpc0Nsb3Nlc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcCBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocCA9PT0gdGhpcykgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAucm9sZSA9PT0gJ0dMJykgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnN0YXR1cyAmJiBwLnN0YXR1cy5uYXAgPiAwKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBEaXN0ID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBEaXN0IDwgbXlEaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0Nsb3Nlc3QgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChpc0Nsb3Nlc3QpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnQ0hBU0UnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIudGVhbSA9PT0gdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnU1VQUE9SVCc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlci50ZWFtICE9PSB0aGlzLnRlYW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdERUZFTkQnOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfZXhlY3V0ZVN0YXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzd2l0Y2ggKHRoaXMuYWlTdGF0ZSkgewogICAgICAgICAgICAgICAgY2FzZSAnQVRUQUNLX0NBUlJZJzogdGhpcy5fc3RhdGVBdHRhY2tDYXJyeShkdCk7IGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnU1VQUE9SVCc6IHRoaXMuX3N0YXRlU3VwcG9ydChkdCk7IGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnREVGRU5EJzogdGhpcy5fc3RhdGVEZWZlbmQoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0NIQVNFJzogdGhpcy5fc3RhdGVDaGFzZShkdCk7IGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnUkVUVVJOX0hPTUUnOiAKICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHRoaXMuX3N0YXRlUmV0dXJuSG9tZShkdCk7IGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfc3RhdGVBdHRhY2tDYXJyeShkdCkgewogICAgICAgICAgICBjb25zdCBhdHRhY2tEaXIgPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLTEgOiAxOwpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsWiA9IGdvYWxEaXN0ICogYXR0YWNrRGlyOwogICAgICAgICAgICAKICAgICAgICAgICAgX3RhcmdldFBvcy5zZXQoMCwgMCwgZ29hbFopOwogICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKCiAgICAgICAgICAgIGNvbnN0IGRpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChkaXN0VG9Hb2FsIDwgMjAuMCAmJiAhdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zbWFydFRocm93KHRoaXMuYmFsbFJlZiwgJ1NIJyk7IAogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBpc1N1cnJvdW5kZWQgPSB0aGlzLl9pc1N1cnJvdW5kZWQoKTsKICAgICAgICAgICAgY29uc3QgbG93RU4gPSB0aGlzLmN1cnJlbnRFTiA8IDEwOwogICAgICAgICAgICBjb25zdCBpc1BsYXltYWtlciA9IHRoaXMuaXNNaWRmaWVsZGVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKChpc1N1cnJvdW5kZWQgfHwgbG93RU4gfHwgaXNQbGF5bWFrZXIpICYmICF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJlc3RNYXRlID0gdGhpcy5fZmluZEJlc3RQYXNzVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICBpZiAoYmVzdE1hdGUpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgc2hvdWxkUGFzcyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGlmIChpc1N1cnJvdW5kZWQgfHwgbG93RU4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvdWxkUGFzcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc1BsYXltYWtlcikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBteURpc3QgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0ZURpc3QgPSBNYXRoLmFicyhiZXN0TWF0ZS5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRlRGlzdCA8IG15RGlzdCAtIDUuMCkgc2hvdWxkUGFzcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIChzaG91bGRQYXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoYmVzdE1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3NtYXJ0VGhyb3codGhpcy5iYWxsUmVmLCAnUEEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGlzU3Vycm91bmRlZCAmJiAhdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zbWFydFRocm93KHRoaXMuYmFsbFJlZiwgJ1NIJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9pc1N1cnJvdW5kZWQoKSB7CiAgICAgICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmIChwLm1lc2ggJiYgcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5tZXNoLnBvc2l0aW9uKSA8IDQuMCkgewogICAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvdW50ID49IDI7CiAgICAgICAgfQoKICAgICAgICBfc21hcnRUaHJvdyhiYWxsLCBmb3JjZWRUeXBlID0gbnVsbCkgewogICAgICAgICAgICBsZXQgdHlwZSA9IGZvcmNlZFR5cGU7CiAgICAgICAgICAgIGlmICghdHlwZSkgewogICAgICAgICAgICAgICAgX3RlbXBWZWMxLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgY29uc3QgYXR0YWNrRGlyID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtMSA6IDE7CiAgICAgICAgICAgICAgICBjb25zdCBpc0FpbWluZ0dvYWwgPSAoX3RlbXBWZWMxLnogKiBhdHRhY2tEaXIgPiAwLjUpOwogICAgICAgICAgICAgICAgdHlwZSA9IGlzQWltaW5nR29hbCA/ICdTSCcgOiAnUEEnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCB0ZWNoTmFtZSA9ICh0eXBlID09PSAnU0gnKSA/IHRoaXMudGVjaHMuc2hvb3QgOiB0aGlzLnRlY2hzLnBhc3M7CiAgICAgICAgICAgIGxldCBiYXNlQ29zdCA9ICh0eXBlID09PSAnU0gnKSA/IDIwIDogMTA7CiAgICAgICAgICAgIGxldCB0ZWNoQ29zdCA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh0ZWNoTmFtZS5pbmNsdWRlcygnbmFwJykpIHRlY2hDb3N0ID0gMzA7CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNoTmFtZS5pbmNsdWRlcygnc3BoZXJlJykgfHwgdGVjaE5hbWUuaW5jbHVkZXMoJ2ludmlzaWJsZScpKSB0ZWNoQ29zdCA9IDI1OwogICAgICAgICAgICAgICAgZWxzZSB0ZWNoQ29zdCA9IDIwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCB0b3RhbENvc3QgPSBiYXNlQ29zdCArIHRlY2hDb3N0OwogICAgICAgICAgICBsZXQgdGVtcFRlY2ggPSBudWxsOwogICAgICAgICAgICBpZiAodGVjaE5hbWUgJiYgdGhpcy5zdGF0cy5IUCA8IHRvdGFsQ29zdCAmJiB0aGlzLnN0YXRzLkhQID49IGJhc2VDb3N0KSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgIHRlbXBUZWNoID0gdGhpcy50ZWNocy5zaG9vdDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlY2hzLnNob290ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGVtcFRlY2ggPSB0aGlzLnRlY2hzLnBhc3M7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWNocy5wYXNzID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgdHlwZSk7CgogICAgICAgICAgICBpZiAodGVtcFRlY2gpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB0aGlzLnRlY2hzLnNob290ID0gdGVtcFRlY2g7CiAgICAgICAgICAgICAgICBlbHNlIHRoaXMudGVjaHMucGFzcyA9IHRlbXBUZWNoOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfc3RhdGVDaGFzZShkdCkgewogICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGhpcy5wZXJjZWl2ZWRUYXJnZXRQb3MpOwogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5iYWxsUmVmOwogICAgICAgICAgICBpZiAoYmFsbC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMS4wKSB7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmFkZFNjYWxlZFZlY3RvcihiYWxsLnZlbG9jaXR5LCAwLjMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwogICAgICAgIH0KCiAgICAgICAgX3N0YXRlUmV0dXJuSG9tZShkdCkgewogICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGhpcy5ob21lUG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICB9CgogICAgICAgIF9zdGF0ZVN1cHBvcnQoZHQpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKICAgICAgICAgICAgY29uc3QgY2FycmllciA9IGJhbGwuaG9sZGVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFjYXJyaWVyIHx8ICFjYXJyaWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0YXRlUmV0dXJuSG9tZShkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGJhbGxQb3MgPSBjYXJyaWVyLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IGF0dGFja0RpciA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtMSA6IDE7CmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC1nb2FsRGlzdCA6IGdvYWxEaXN0OwoKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSB0aGlzLl9jYWxjdWxhdGVQcmVzc3VyZU9uUGxheWVyKGNhcnJpZXIpOwoKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgX3RhcmdldFBvcy56ICs9IGJhbGxQb3MueiAqIDAuNjsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgbGV0IHRhcmdldFogPSBiYWxsUG9zLnogKyAoYXR0YWNrRGlyICogMTUuMCk7IAogICAgICAgICAgICAgICAgaWYgKHByZXNzdXJlID4gMC44KSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0WiA9IGJhbGxQb3MueiArIChhdHRhY2tEaXIgKiA4LjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IERhdGUubm93KCkgKiAwLjAwMTsKICAgICAgICAgICAgICAgIGNvbnN0IHdlYXZlID0gTWF0aC5zaW4odGltZSArIHRoaXMubWVzaC5pZCkgKiA2LjA7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnggPSB0aGlzLmhvbWVQb3NpdGlvbi54ICsgd2VhdmU7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSB0YXJnZXRaOwoKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzTWlkZmllbGRlcikgewogICAgICAgICAgICAgICAgaWYgKHByZXNzdXJlID4gMC44KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2lkZSA9ICh0aGlzLm1lc2gucG9zaXRpb24ueCA+IGJhbGxQb3MueCkgPyAxIDogLTE7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy54ID0gYmFsbFBvcy54ICsgKHNpZGUgKiAxMC4wKTsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSBiYWxsUG9zLnogLSAoYXR0YWNrRGlyICogMi4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWlkWiA9IChiYWxsUG9zLnogKyBnb2FsWikgKiAwLjQ1OwogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueiA9IG1pZFo7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJhbGxQb3MueCA8IC01KSBfdGFyZ2V0UG9zLnggPSA1OwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGJhbGxQb3MueCA+IDUpIF90YXJnZXRQb3MueCA9IC01OwogICAgICAgICAgICAgICAgICAgIGVsc2UgX3RhcmdldFBvcy54ID0gKHRoaXMuaG9tZVBvc2l0aW9uLnggPiAwID8gOCA6IC04KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBzYWZldHlEaXN0ID0gMTIuMDsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueiA9IGJhbGxQb3MueiAtIChhdHRhY2tEaXIgKiBzYWZldHlEaXN0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgX3RhcmdldFBvcy56ID0gTWF0aC5taW4oMzgsIF90YXJnZXRQb3Mueik7CiAgICAgICAgICAgICAgICBlbHNlIF90YXJnZXRQb3MueiA9IE1hdGgubWF4KC0zOCwgX3RhcmdldFBvcy56KTsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueCA9IGJhbGxQb3MueCAqIDAuNiArIHRoaXMuaG9tZVBvc2l0aW9uLnggKiAwLjQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLl9pc1BhdGhCbG9ja2VkKF90YXJnZXRQb3MsIGJhbGxQb3MpKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEuY29weShfdGFyZ2V0UG9zKTsgX3RlbXBWZWMxLnggLT0gOC4wOwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLmNvcHkoX3RhcmdldFBvcyk7IF90ZW1wVmVjMi54ICs9IDguMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYmxvY2tlZEwgPSB0aGlzLl9pc1BhdGhCbG9ja2VkKF90ZW1wVmVjMSwgYmFsbFBvcyk7CiAgICAgICAgICAgICAgICBjb25zdCBibG9ja2VkUiA9IHRoaXMuX2lzUGF0aEJsb2NrZWQoX3RlbXBWZWMyLCBiYWxsUG9zKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCFibG9ja2VkTCAmJiAhYmxvY2tlZFIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoX3RhcmdldFBvcy54IC0gX3RlbXBWZWMxLngpIDwgTWF0aC5hYnMoX3RhcmdldFBvcy54IC0gX3RlbXBWZWMyLngpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzEpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWJsb2NrZWRMKSB7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KF90ZW1wVmVjMSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFibG9ja2VkUikgewogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmxlcnAoYmFsbFBvcywgMC40KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fYXZvaWRUZWFtbWF0ZXMoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwogICAgICAgIH0KCiAgICAgICAgX3N0YXRlRGVmZW5kKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldFBvcyA9IHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zOwogICAgICAgICAgICBjb25zdCBkaXN0VG9CYWxsID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGFyZ2V0UG9zKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGxldCBwcmVzc1JhbmdlID0gdGhpcy5pc0RlZmVuZGVyID8gMTIuMCA6IDguMDsKICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMudGFja2xlICYmIHRoaXMuc3RhdHMuSFAgPiAyMCkgewogICAgICAgICAgICAgICAgcHJlc3NSYW5nZSArPSA1LjA7IAogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgYW1JQ2xvc2VzdCA9IHRydWU7CiAgICAgICAgICAgIGNvbnN0IG15RGlzdFNxID0gZGlzdFRvQmFsbCAqIGRpc3RUb0JhbGw7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBmb3IoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgICAgIGlmIChtYXRlID09PSB0aGlzIHx8ICFtYXRlLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIGlmIChtYXRlLnJvbGUgPT09ICdHTCcgfHwgbWF0ZS5zdGF0dXMubmFwID4gMCB8fCBtYXRlLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRTcSA9IG1hdGUubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvU3F1YXJlZCh0YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgICAgIGlmIChkU3EgPCBteURpc3RTcSkgewogICAgICAgICAgICAgICAgICAgICAgICBhbUlDbG9zZXN0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKaWYgKGFtSUNsb3Nlc3QpIHsKICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgPSAxMDAuMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb015R29hbCA9IE1hdGguYWJzKHRhcmdldFBvcy56IC0gKHRoaXMudGVhbS5zaWRlID09PSAxID8gNDQuNSA6IC00NC41KSk7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvTXlHb2FsIDwgMjAuMCkgewogICAgICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgPSAxNS4wOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwcmVzc1JhbmdlID0gOC4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoZGlzdFRvQmFsbCA8IHByZXNzUmFuZ2UpIHsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMy4wICYmICF0aGlzLmlzRGFzaGluZyAmJiB0aGlzLmN1cnJlbnRFTiA+IDUgJiYgTWF0aC5yYW5kb20oKSA8IDAuMDIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBfdGVtcFZlYzEuc3ViVmVjdG9ycyh0YXJnZXRQb3MsIHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlyLmFkZFNjYWxlZFZlY3Rvcih0aGlzLmJhbGxSZWYudmVsb2NpdHksIDAuMSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuZGFzaChkaXIueCwgZGlyLnopOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWFya2luZyAmJiB0aGlzLm1hcmtpbmcubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgbWFya1BvcyA9IHRoaXMubWFya2luZy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgbXlHb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyA0NiA6IC00NjsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5zZXQoMCwgMCwgbXlHb2FsWiAtIG1hcmtQb3Mueik7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkobWFya1BvcykuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjMSwgMy41KTsKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgX3RhcmdldFBvcy56ICs9IHRoaXMuYmFsbFJlZi5tZXNoLnBvc2l0aW9uLnogKiAwLjY7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5pc0RlZmVuZGVyKSB7CmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IG15R29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gZ29hbERpc3QgOiAtZ29hbERpc3Q7CiAgICAgICAgICAgICAgICBjb25zdCBtaWRwb2ludCA9ICh0aGlzLmJhbGxSZWYubWVzaC5wb3NpdGlvbi56ICsgbXlHb2FsWikgKiAwLjU7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSAoX3RhcmdldFBvcy56ICsgbWlkcG9pbnQpICogMC41OwogICAgICAgICAgICB9Cgpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBsaW1pdFogPSBnb2FsRGlzdCAtIDIuNTsKICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gTWF0aC5tYXgoLWxpbWl0WiwgTWF0aC5taW4obGltaXRaLCBfdGFyZ2V0UG9zLnopKTsKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CiAgICAgICAgfQoKICAgICAgICBfYXZvaWRHb2FsQ3JlYXNlKHRhcmdldFBvcykgewogICAgICAgICAgICBjb25zdCBjcmVhc2VSYWRpdXMgPSAxMC4wOwpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FscyA9IFt7IHg6IDAsIHo6IC1nb2FsRGlzdCB9LCB7IHg6IDAsIHo6IGdvYWxEaXN0IH1dOwoKICAgICAgICAgICAgZ29hbHMuZm9yRWFjaChnb2FsID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGR4ID0gdGFyZ2V0UG9zLnggLSBnb2FsLng7CiAgICAgICAgICAgICAgICBjb25zdCBkeiA9IHRhcmdldFBvcy56IC0gZ29hbC56OwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFNxID0gZHgqZHggKyBkeipkejsKCiAgICAgICAgICAgICAgICBpZiAoZGlzdFNxIDwgY3JlYXNlUmFkaXVzICogY3JlYXNlUmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkaXN0U3EpOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gMC4wMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBjcmVhc2VSYWRpdXMgLyBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MueCA9IGdvYWwueCArIGR4ICogcmF0aW87CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy56ID0gZ29hbC56ICsgZHogKiByYXRpbzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MueiA9IGdvYWwueiArIChnb2FsLnogPiAwID8gLWNyZWFzZVJhZGl1cyA6IGNyZWFzZVJhZGl1cyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNvbnN0IGFyZW5hUmFkaXVzID0gNDUuMDsKICAgICAgICAgICAgY29uc3QgZFNxID0gdGFyZ2V0UG9zLnggKiB0YXJnZXRQb3MueCArIHRhcmdldFBvcy56ICogdGFyZ2V0UG9zLno7CiAgICAgICAgICAgIGlmIChkU3EgPiBhcmVuYVJhZGl1cyphcmVuYVJhZGl1cykgewogICAgICAgICAgICAgICAgY29uc3QgZCA9IE1hdGguc3FydChkU3EpOwogICAgICAgICAgICAgICAgY29uc3QgciA9IGFyZW5hUmFkaXVzIC8gZDsKICAgICAgICAgICAgICAgIHRhcmdldFBvcy54ICo9IHI7CiAgICAgICAgICAgICAgICB0YXJnZXRQb3MueiAqPSByOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfZmluZEJlc3RQYXNzVGFyZ2V0KCkgewogICAgICAgICAgICBsZXQgYmVzdFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIGxldCBtYXhTY29yZSA9IC1JbmZpbml0eTsKY29uc3QgZ29hbERpc3QgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UgfHwgNDEuNTsKICAgICAgICAgICAgY29uc3QgZ29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CgogICAgICAgICAgICBmb3IgKGNvbnN0IG1hdGUgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmIChtYXRlID09PSB0aGlzKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmICghbWF0ZS5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChtYXRlLnN0YXR1cy5uYXAgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChtYXRlLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8obWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgNC4wKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gMzAuMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9pc1BhdGhCbG9ja2VkKG1hdGUubWVzaC5wb3NpdGlvbikpIGNvbnRpbnVlOyAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHNjb3JlID0gMDsKICAgICAgICAgICAgICAgIGNvbnN0IG15RGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgY29uc3QgbWF0ZURpc3RUb0dvYWwgPSBNYXRoLmFicyhtYXRlLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gbXlEaXN0VG9Hb2FsIC0gbWF0ZURpc3RUb0dvYWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNjb3JlICs9IHByb2dyZXNzICogMS41OyAKICAgICAgICAgICAgICAgIGlmIChtYXRlRGlzdFRvR29hbCA8IDE1LjApIHNjb3JlICs9IDEwLjA7CiAgICAgICAgICAgICAgICBpZiAobWF0ZURpc3RUb0dvYWwgPCA4LjApIHNjb3JlICs9IDE1LjA7CgogICAgICAgICAgICAgICAgY29uc3Qgb3Blbm5lc3MgPSB0aGlzLl9jYWxjdWxhdGVPcGVubmVzcyhtYXRlKTsKICAgICAgICAgICAgICAgIHNjb3JlICs9IG9wZW5uZXNzICogMy4wOwoKICAgICAgICAgICAgICAgIGlmIChtYXRlLmlzRm9yd2FyZCkgc2NvcmUgKz0gNS4wOwogICAgICAgICAgICAgICAgc2NvcmUgLT0gZGlzdCAqIDAuNTsKCiAgICAgICAgICAgICAgICBpZiAoc2NvcmUgPiBtYXhTY29yZSkgewogICAgICAgICAgICAgICAgICAgIG1heFNjb3JlID0gc2NvcmU7CiAgICAgICAgICAgICAgICAgICAgYmVzdFRhcmdldCA9IG1hdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJlc3RUYXJnZXQ7CiAgICAgICAgfQoKICAgICAgICBfY2FsY3VsYXRlT3Blbm5lc3MocGxheWVyKSB7CiAgICAgICAgICAgIGxldCBtaW5EZWZEaXN0ID0gOTk5OwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiAwOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKCiAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCB8fCBvcHAuc3RhdHVzLm5hcCA+IDAgfHwgb3BwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZCA9IHBsYXllci5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGQgPCBtaW5EZWZEaXN0KSBtaW5EZWZEaXN0ID0gZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gTWF0aC5taW4obWluRGVmRGlzdCwgOC4wKTsKICAgICAgICB9CgogICAgICAgIF9pc1BhdGhCbG9ja2VkKHRhcmdldFBvcywgc3RhcnRQb3MgPSBudWxsKSB7CiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gc3RhcnRQb3MgfHwgdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBlbmQgPSB0YXJnZXRQb3M7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBzdGFydC5kaXN0YW5jZVRvKGVuZCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBfc2NhbkRpci5zdWJWZWN0b3JzKGVuZCwgc3RhcnQpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAodGhpcy50ZWFtLmlkID09PSAnaG9tZScpID8gZ2FtZS50ZWFtcy5hd2F5IDogZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBjb25zdCBzYWZldHlSYWRpdXMgPSAyLjU7IAoKICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9wcC5tZXNoIHx8IG9wcC5zdGF0dXMubmFwID4gMCB8fCBvcHAuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9zY2FuVG9PcHAuc3ViVmVjdG9ycyhvcHAubWVzaC5wb3NpdGlvbiwgc3RhcnQpOwogICAgICAgICAgICAgICAgY29uc3QgcHJvamVjdGlvbiA9IF9zY2FuVG9PcHAuZG90KF9zY2FuRGlyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHByb2plY3Rpb24gPiAwICYmIHByb2plY3Rpb24gPCBkaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGVycERpc3RTcSA9IF9zY2FuVG9PcHAubGVuZ3RoU3EoKSAtIChwcm9qZWN0aW9uICogcHJvamVjdGlvbik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBlcnBEaXN0U3EgPCAoc2FmZXR5UmFkaXVzICogc2FmZXR5UmFkaXVzKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgX21vdmVUbyh0YXJnZXQpIHsKICAgICAgICAgICAgX2FpVmVjLnN1YlZlY3RvcnModGFyZ2V0LCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICBfYWlWZWMueSA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBfYWlWZWMubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKGRpc3RTcSA+IDEuMCkgewogICAgICAgICAgICAgICAgX2FpVmVjLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dChfYWlWZWMueCwgX2FpVmVjLnopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC44KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5SW50ZXJjZXB0aW9uUHJlc3N1cmUoZHQpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIGlmIChiYWxsLnN0YXRlICE9PSAnZnJlZScgfHwgYmFsbC52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMS4wKSByZXR1cm47CiAgICAgICAgICAgIGlmIChiYWxsLmlzSW52aXNpYmxlKSByZXR1cm47CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IHJhbmdlID0gMi4wOwogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5wYXNzaXZlID09PSAnYnJhd2xlcicgfHwgdGhpcy50ZWNocy5wYXNzaXZlID09PSAnZWxpdGVfZGVmZW5zZScpIHsKICAgICAgICAgICAgICAgIHJhbmdlICs9IDEuNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIGlmIChkaXN0ID4gcmFuZ2UpIHJldHVybjsKCiAgICAgICAgICAgIF9zY2FuVG9PcHAuc3ViVmVjdG9ycyh0aGlzLm1lc2gucG9zaXRpb24sIGJhbGwubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIF90ZW1wVmVjMS5jb3B5KGJhbGwudmVsb2NpdHkpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaGVhZGluZ0RvdCA9IF90ZW1wVmVjMS5kb3QoX3NjYW5Ub09wcCk7CiAgICAgICAgICAgIGlmIChoZWFkaW5nRG90IDwgMC43KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBkaXN0RmFjdG9yID0gTWF0aC5tYXgoMCwgMS4wIC0gKGRpc3QgLyByYW5nZSkpOwogICAgICAgICAgICBjb25zdCBwcmVzc3VyZSA9IDEuNTsKCiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlciAtPSBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgPSAodGhpcy5fYWNjdW11bGF0ZWRCbG9jayB8fCAwKSArIHByZXNzdXJlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgPj0gNS4wKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IE1hdGguZmxvb3IodGhpcy5fYWNjdW11bGF0ZWRCbG9jayk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRCbG9jayAtPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsgCiAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGAtJHt2YWx9YCwgYmFsbC5tZXNoLnBvc2l0aW9uLCAiYmxvY2siLCBiYWxsLm1lc2gpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAoZGlzdEZhY3RvciAqIDAuOCkpIHsgCiAgICAgICAgICAgICAgICBfdGVtcFZlYzIuY29weSh0aGlzLm1lc2gucG9zaXRpb24pLmxlcnAoYmFsbC5tZXNoLnBvc2l0aW9uLCAwLjUgKyAoTWF0aC5yYW5kb20oKS0wLjUpKjAuMik7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzIueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLnkgKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zcGF3bkNsYXNoKF90ZW1wVmVjMiwgMC42KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCAmJiBiYWxsLnBvd2VyVHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlclR5cGUgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgeyAKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTE9DS0VEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiYWxsLnRlY2huaXF1ZSAmJiB0aGlzLnRlY2hJbW11bml0eVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICBjb25zdCB0ZWNoID0gYmFsbC50ZWNobmlxdWU7CiAgICAgICAgICAgICAgICBpZiAodGVjaC50eXBlID09PSAndmVub20nKSB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDE1LjApOwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaC50eXBlID09PSAnbmFwJykgdGhpcy5hcHBseVN0YXR1cygnbmFwJywgOC4wKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2gudHlwZSA9PT0gJ3dpdGhlcicpIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDE1LjAsICdCTCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2FsY3VsYXRlUHJlc3N1cmVPblBsYXllcihwbGF5ZXIpIHsKICAgICAgICAgICAgaWYgKCFwbGF5ZXIgfHwgIXBsYXllci5tZXNoKSByZXR1cm4gMDsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm4gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAocGxheWVyLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGxldCBwcmVzc3VyZSA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2ggfHwgb3BwLnN0YXR1cy5uYXAgPiAwIHx8IG9wcC5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBwbGF5ZXIubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG9wcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgMTAuMCkgewogICAgICAgICAgICAgICAgICAgIHByZXNzdXJlICs9ICgxMC4wIC0gZGlzdCkgLyAxMC4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcmVzc3VyZTsKICAgICAgICB9CgogICAgICAgIF9hdm9pZFRlYW1tYXRlcyh0YXJnZXRQb3MpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW0pIHJldHVybjsKICAgICAgICAgICAgZm9yIChjb25zdCBtYXRlIG9mIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcyB8fCAhbWF0ZS5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChtYXRlLmhhc0JhbGwpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGFyZ2V0UG9zLmRpc3RhbmNlVG8obWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgX3RlbXBWZWMxLnN1YlZlY3RvcnModGFyZ2V0UG9zLCBtYXRlLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMxLCA1LjAgLSBkaXN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5BSVBsYXllciA9IEFJUGxheWVyOwp9KSgpOw==","/AIPlayer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzCiAgICBjb25zdCBfYWlWZWMgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX3RhcmdldFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhbkRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfc2NhblRvT3BwID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF90ZW1wVmVjMSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlYzIgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEFJUGxheWVyIGV4dGVuZHMgd2luZG93LmZsdXguUGxheWVyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgcm9sZSkgewogICAgICAgICAgICBzdXBlcihzY2VuZSwgcm9sZSk7CiAgICAgICAgICAgIHRoaXMuYmFsbFJlZiA9IG51bGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGF0cyBhcmUgbWFuYWdlZCBieSBUZWFtL01haW4gb3IgZGVmYXVsdCBQbGF5ZXIgdmFsdWVzLgogICAgICAgICAgICB0aGlzLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsKCiAgICAgICAgICAgIC8vIFN0YXRlIE1hY2hpbmUKICAgICAgICAgICAgdGhpcy5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB0aGlzLmRlY2lzaW9uVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLmRlY2lzaW9uSW50ZXJ2YWwgPSAwLjU7IC8vIFNsb3dlciBkZWNpc2lvbnMKCiAgICAgICAgICAgIC8vIC0tLSBQRVJDRVBUSU9OIFNZU1RFTSAoUmVhY3Rpb24gVGltZSkgLS0tCiAgICAgICAgICAgIHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5yZWFjdGlvblNwZWVkID0gMS41OyAKICAgICAgICAgICAgdGhpcy5hbnRpY2lwYXRpb25UaW1lID0gMC4yOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJvbGUgQ29uZmlnCiAgICAgICAgICAgIHRoaXMuaXNGb3J3YXJkID0gWydMRicsICdSRiddLmluY2x1ZGVzKHJvbGUpOwogICAgICAgICAgICB0aGlzLmlzTWlkZmllbGRlciA9IHJvbGUgPT09ICdNRic7CiAgICAgICAgICAgIHRoaXMuaXNEZWZlbmRlciA9IFsnTEQnLCAnUkQnXS5pbmNsdWRlcyhyb2xlKTsKCiAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLl9hc3NpZ25EZWZhdWx0VGVjaHMoKTsKICAgICAgICB9CgogICAgICAgIF9hc3NpZ25EZWZhdWx0VGVjaHMoKSB7CiAgICAgICAgICAgIGNvbnN0IHRhY2tsZVRlY2hzID0gWyd2ZW5vbScsICd3aXRoZXInLCAnZHJhaW4nXTsKICAgICAgICAgICAgY29uc3Qgc2hvb3RUZWNocyA9IFsndmVub20nLCAnc3BoZXJlJywgJ2ludmlzaWJsZSddOwogICAgICAgICAgICBjb25zdCBwYXNzVGVjaHMgPSBbJ3Zlbm9tJywgJ3dpdGhlcicsICduYXAnXTsKICAgICAgICAgICAgY29uc3QgcGFzc2l2ZVRlY2hzID0gWydicmF3bGVyJywgJ2VsaXRlX2RlZmVuc2UnXTsKCiAgICAgICAgICAgIGNvbnN0IHBpY2sgPSAoYXJyKSA9PiBhcnJbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogYXJyLmxlbmd0aCldOwogICAgICAgICAgICBjb25zdCBjaGFuY2UgPSAocHJvYikgPT4gTWF0aC5yYW5kb20oKSA8IHByb2I7CgogICAgICAgICAgICBpZiAodGhpcy5pc0RlZmVuZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMykpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4yKSkgdGhpcy50ZWNocy5wYXNzaXZlID0gcGljayhwYXNzaXZlVGVjaHMpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNNaWRmaWVsZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMudGFja2xlID0gcGljayh0YWNrbGVUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMikpIHRoaXMudGVjaHMucGFzcyA9IHBpY2socGFzc1RlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy5zaG9vdCA9IHBpY2soc2hvb3RUZWNocyk7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmNlKDAuMSkpIHRoaXMudGVjaHMucGFzc2l2ZSA9IHBpY2socGFzc2l2ZVRlY2hzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgaWYgKGNoYW5jZSgwLjMpKSB0aGlzLnRlY2hzLnNob290ID0gcGljayhzaG9vdFRlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy50YWNrbGUgPSBwaWNrKHRhY2tsZVRlY2hzKTsKICAgICAgICAgICAgICAgIGlmIChjaGFuY2UoMC4xKSkgdGhpcy50ZWNocy5wYXNzaXZlID0gcGljayhwYXNzaXZlVGVjaHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVQaHlzaWNzKGR0KSB7CiAgICAgICAgICAgIC8vIFNhZmV0eTogQXV0by1saW5rIGJhbGwgaWYgbWlzc2luZwogICAgICAgICAgICBpZiAoIXRoaXMuYmFsbFJlZiAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhbGxSZWYgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgY29uc3QgaXNQcmFjdGljZSA9IGdhbWUgJiYgZ2FtZS5nYW1lTW9kZSA9PT0gJ3ByYWN0aWNlJzsKICAgICAgICAgICAgY29uc3QgaXNBY3RpdmUgPSBnYW1lICYmIGdhbWUuc3RhdGUgPT09ICdhY3RpdmUnOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFpc0FjdGl2ZSAmJiAhaXNQcmFjdGljZSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBpc0RlbW8gPSBnYW1lICYmIGdhbWUuaXNEZW1vTW9kZTsKICAgICAgICAgICAgY29uc3QgaXNJbmNhcGFjaXRhdGVkID0gKHRoaXMuc3R1blRpbWVyID4gMCkgfHwgKHRoaXMuc3RhdHVzLm5hcCA+IDApOwogICAgICAgICAgICBjb25zdCBpc0h1bWFuVGVhbSA9IHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uaXNIdW1hbjsKICAgICAgICAgICAgY29uc3QgaXNBY3RpdmVQbGF5ZXIgPSB0aGlzLnRlYW0gJiYgKHRoaXMudGVhbS5hY3RpdmVQbGF5ZXIgPT09IHRoaXMpOwogICAgICAgICAgICBjb25zdCBzaG91bGRSdW5BSSA9ICghaXNIdW1hblRlYW0gfHwgaXNEZW1vIHx8IChpc0h1bWFuVGVhbSAmJiAhaXNBY3RpdmVQbGF5ZXIpKTsKICAgICAgICAgICAgY29uc3QgaXNUZWFtQUlFbmFibGVkID0gdGhpcy50ZWFtID8gdGhpcy50ZWFtLmFpRW5hYmxlZCA6IHRydWU7CgogICAgICAgICAgICBpZiAoaXNJbmNhcGFjaXRhdGVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHNob3VsZFJ1bkFJICYmIGlzVGVhbUFJRW5hYmxlZCkgewogICAgICAgICAgICAgICAgLy8gUGVyY2VwdGlvbiBVcGRhdGUKICAgICAgICAgICAgICAgIGlmICh0aGlzLmJhbGxSZWYgJiYgdGhpcy5iYWxsUmVmLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVhbFRhcmdldCA9IHRoaXMuYmFsbFJlZi5tZXNoLnBvc2l0aW9uLmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZi5ob2xkZXIgJiYgdGhpcy5iYWxsUmVmLmhvbGRlci5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQgPSB0aGlzLmJhbGxSZWYuaG9sZGVyLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZi5ob2xkZXIudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxUYXJnZXQuYWRkU2NhbGVkVmVjdG9yKHRoaXMuYmFsbFJlZi5ob2xkZXIudmVsb2NpdHksIHRoaXMuYW50aWNpcGF0aW9uVGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYmFsbFJlZi52ZWxvY2l0eSkgewogICAgICAgICAgICAgICAgICAgICAgICByZWFsVGFyZ2V0LmFkZFNjYWxlZFZlY3Rvcih0aGlzLmJhbGxSZWYudmVsb2NpdHksIHRoaXMuYW50aWNpcGF0aW9uVGltZSAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFscGhhID0gTWF0aC5taW4oMS4wLCBkdCAqIHRoaXMucmVhY3Rpb25TcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJjZWl2ZWRUYXJnZXRQb3MubGVycChyZWFsVGFyZ2V0LCBhbHBoYSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRGVjaXNpb24KICAgICAgICAgICAgICAgIHRoaXMuZGVjaXNpb25UaW1lciArPSBkdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlY2lzaW9uVGltZXIgPiB0aGlzLmRlY2lzaW9uSW50ZXJ2YWwpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRlY2lzaW9uVGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2V2YWx1YXRlU3RhdGUoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBFeGVjdXRpb24KICAgICAgICAgICAgICAgIHRoaXMuX2V4ZWN1dGVTdGF0ZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEludGVyY2VwdGlvbgogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVjaEltbXVuaXR5VGltZXIgPiAwKSB0aGlzLnRlY2hJbW11bml0eVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgdGhpcy5fYXBwbHlJbnRlcmNlcHRpb25QcmVzc3VyZShkdCk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSHVtYW4gY29udHJvbGxlZCBvciBkaXNhYmxlZAogICAgICAgICAgICAgICAgY29uc3QgaXNEcml2ZW5CeUh1bWFuID0gaXNIdW1hblRlYW0gJiYgaXNBY3RpdmVQbGF5ZXIgJiYgIWlzRGVtbzsKICAgICAgICAgICAgICAgIGlmICghaXNEcml2ZW5CeUh1bWFuKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5SW50ZXJjZXB0aW9uUHJlc3N1cmUoZHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzdXBlci51cGRhdGVQaHlzaWNzKGR0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgc3VwZXIudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgfQoKICAgICAgICBfZXZhbHVhdGVTdGF0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmJhbGxSZWYpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKCiAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdBVFRBQ0tfQ0FSUlknOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWJhbGwuaG9sZGVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnUkVUVVJOX0hPTUUnOwogICAgICAgICAgICAgICAgY29uc3QgYmlhcyA9ICh0aGlzLmFpU3RhdGUgPT09ICdDSEFTRScpID8gMC44IDogMS4wOwogICAgICAgICAgICAgICAgY29uc3QgbXlEaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKSAqIGJpYXM7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBpc0Nsb3Nlc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcCBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocCA9PT0gdGhpcykgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAucm9sZSA9PT0gJ0dMJykgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnN0YXR1cyAmJiBwLnN0YXR1cy5uYXAgPiAwKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBEaXN0ID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBEaXN0IDwgbXlEaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0Nsb3Nlc3QgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChpc0Nsb3Nlc3QpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnQ0hBU0UnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYmFsbC5ob2xkZXIudGVhbSA9PT0gdGhpcy50ZWFtKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFpU3RhdGUgPSAnU1VQUE9SVCc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiYWxsLmhvbGRlci50ZWFtICE9PSB0aGlzLnRlYW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuYWlTdGF0ZSA9ICdERUZFTkQnOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfZXhlY3V0ZVN0YXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5iYWxsUmVmKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0KDAsIDApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzd2l0Y2ggKHRoaXMuYWlTdGF0ZSkgewogICAgICAgICAgICAgICAgY2FzZSAnQVRUQUNLX0NBUlJZJzogdGhpcy5fc3RhdGVBdHRhY2tDYXJyeShkdCk7IGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnU1VQUE9SVCc6IHRoaXMuX3N0YXRlU3VwcG9ydChkdCk7IGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnREVGRU5EJzogdGhpcy5fc3RhdGVEZWZlbmQoZHQpOyBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0NIQVNFJzogdGhpcy5fc3RhdGVDaGFzZShkdCk7IGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnUkVUVVJOX0hPTUUnOiAKICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHRoaXMuX3N0YXRlUmV0dXJuSG9tZShkdCk7IGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfc3RhdGVBdHRhY2tDYXJyeShkdCkgewogICAgICAgICAgICBjb25zdCBhdHRhY2tEaXIgPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLTEgOiAxOwpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsWiA9IGdvYWxEaXN0ICogYXR0YWNrRGlyOwogICAgICAgICAgICAKICAgICAgICAgICAgX3RhcmdldFBvcy5zZXQoMCwgMCwgZ29hbFopOwogICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKCiAgICAgICAgICAgIGNvbnN0IGRpc3RUb0dvYWwgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChkaXN0VG9Hb2FsIDwgMjAuMCAmJiAhdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zbWFydFRocm93KHRoaXMuYmFsbFJlZiwgJ1NIJyk7IAogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBpc1N1cnJvdW5kZWQgPSB0aGlzLl9pc1N1cnJvdW5kZWQoKTsKICAgICAgICAgICAgY29uc3QgbG93RU4gPSB0aGlzLmN1cnJlbnRFTiA8IDEwOwogICAgICAgICAgICBjb25zdCBpc1BsYXltYWtlciA9IHRoaXMuaXNNaWRmaWVsZGVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKChpc1N1cnJvdW5kZWQgfHwgbG93RU4gfHwgaXNQbGF5bWFrZXIpICYmICF0aGlzLmlzVGhyb3dpbmcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJlc3RNYXRlID0gdGhpcy5fZmluZEJlc3RQYXNzVGFyZ2V0KCk7CiAgICAgICAgICAgICAgICBpZiAoYmVzdE1hdGUpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgc2hvdWxkUGFzcyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGlmIChpc1N1cnJvdW5kZWQgfHwgbG93RU4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvdWxkUGFzcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc1BsYXltYWtlcikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBteURpc3QgPSBNYXRoLmFicyh0aGlzLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0ZURpc3QgPSBNYXRoLmFicyhiZXN0TWF0ZS5tZXNoLnBvc2l0aW9uLnogLSBnb2FsWik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRlRGlzdCA8IG15RGlzdCAtIDUuMCkgc2hvdWxkUGFzcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIChzaG91bGRQYXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5sb29rQXQoYmVzdE1hdGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3NtYXJ0VGhyb3codGhpcy5iYWxsUmVmLCAnUEEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGlzU3Vycm91bmRlZCAmJiAhdGhpcy5pc1Rocm93aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zbWFydFRocm93KHRoaXMuYmFsbFJlZiwgJ1NIJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9pc1N1cnJvdW5kZWQoKSB7CiAgICAgICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghZ2FtZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmIChwLm1lc2ggJiYgcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5tZXNoLnBvc2l0aW9uKSA8IDQuMCkgewogICAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvdW50ID49IDI7CiAgICAgICAgfQoKICAgICAgICBfc21hcnRUaHJvdyhiYWxsLCBmb3JjZWRUeXBlID0gbnVsbCkgewogICAgICAgICAgICBsZXQgdHlwZSA9IGZvcmNlZFR5cGU7CiAgICAgICAgICAgIGlmICghdHlwZSkgewogICAgICAgICAgICAgICAgX3RlbXBWZWMxLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24odGhpcy5tZXNoLnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgY29uc3QgYXR0YWNrRGlyID0gKHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtMSA6IDE7CiAgICAgICAgICAgICAgICBjb25zdCBpc0FpbWluZ0dvYWwgPSAoX3RlbXBWZWMxLnogKiBhdHRhY2tEaXIgPiAwLjUpOwogICAgICAgICAgICAgICAgdHlwZSA9IGlzQWltaW5nR29hbCA/ICdTSCcgOiAnUEEnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCB0ZWNoTmFtZSA9ICh0eXBlID09PSAnU0gnKSA/IHRoaXMudGVjaHMuc2hvb3QgOiB0aGlzLnRlY2hzLnBhc3M7CiAgICAgICAgICAgIGxldCBiYXNlQ29zdCA9ICh0eXBlID09PSAnU0gnKSA/IDIwIDogMTA7CiAgICAgICAgICAgIGxldCB0ZWNoQ29zdCA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGVjaE5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh0ZWNoTmFtZS5pbmNsdWRlcygnbmFwJykpIHRlY2hDb3N0ID0gMzA7CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZWNoTmFtZS5pbmNsdWRlcygnc3BoZXJlJykgfHwgdGVjaE5hbWUuaW5jbHVkZXMoJ2ludmlzaWJsZScpKSB0ZWNoQ29zdCA9IDI1OwogICAgICAgICAgICAgICAgZWxzZSB0ZWNoQ29zdCA9IDIwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCB0b3RhbENvc3QgPSBiYXNlQ29zdCArIHRlY2hDb3N0OwogICAgICAgICAgICBsZXQgdGVtcFRlY2ggPSBudWxsOwogICAgICAgICAgICBpZiAodGVjaE5hbWUgJiYgdGhpcy5zdGF0cy5IUCA8IHRvdGFsQ29zdCAmJiB0aGlzLnN0YXRzLkhQID49IGJhc2VDb3N0KSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgICAgIHRlbXBUZWNoID0gdGhpcy50ZWNocy5zaG9vdDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRlY2hzLnNob290ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGVtcFRlY2ggPSB0aGlzLnRlY2hzLnBhc3M7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZWNocy5wYXNzID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy50aHJvd0JhbGwoYmFsbCwgdHlwZSk7CgogICAgICAgICAgICBpZiAodGVtcFRlY2gpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnU0gnKSB0aGlzLnRlY2hzLnNob290ID0gdGVtcFRlY2g7CiAgICAgICAgICAgICAgICBlbHNlIHRoaXMudGVjaHMucGFzcyA9IHRlbXBUZWNoOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfc3RhdGVDaGFzZShkdCkgewogICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGhpcy5wZXJjZWl2ZWRUYXJnZXRQb3MpOwogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5iYWxsUmVmOwogICAgICAgICAgICBpZiAoYmFsbC52ZWxvY2l0eS5sZW5ndGhTcSgpID4gMS4wKSB7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmFkZFNjYWxlZFZlY3RvcihiYWxsLnZlbG9jaXR5LCAwLjMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwogICAgICAgIH0KCiAgICAgICAgX3N0YXRlUmV0dXJuSG9tZShkdCkgewogICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGhpcy5ob21lUG9zaXRpb24pOwogICAgICAgICAgICB0aGlzLl9hdm9pZEdvYWxDcmVhc2UoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICB9CgogICAgICAgIF9zdGF0ZVN1cHBvcnQoZHQpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKICAgICAgICAgICAgY29uc3QgY2FycmllciA9IGJhbGwuaG9sZGVyOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFjYXJyaWVyIHx8ICFjYXJyaWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0YXRlUmV0dXJuSG9tZShkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGJhbGxQb3MgPSBjYXJyaWVyLm1lc2gucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IGF0dGFja0RpciA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyAtMSA6IDE7CmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IGdvYWxaID0gKHRoaXMudGVhbS5zaWRlID09PSAxKSA/IC1nb2FsRGlzdCA6IGdvYWxEaXN0OwoKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSB0aGlzLl9jYWxjdWxhdGVQcmVzc3VyZU9uUGxheWVyKGNhcnJpZXIpOwoKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgX3RhcmdldFBvcy56ICs9IGJhbGxQb3MueiAqIDAuNjsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzRm9yd2FyZCkgewogICAgICAgICAgICAgICAgbGV0IHRhcmdldFogPSBiYWxsUG9zLnogKyAoYXR0YWNrRGlyICogMTUuMCk7IAogICAgICAgICAgICAgICAgaWYgKHByZXNzdXJlID4gMC44KSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0WiA9IGJhbGxQb3MueiArIChhdHRhY2tEaXIgKiA4LjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IERhdGUubm93KCkgKiAwLjAwMTsKICAgICAgICAgICAgICAgIGNvbnN0IHdlYXZlID0gTWF0aC5zaW4odGltZSArIHRoaXMubWVzaC5pZCkgKiA2LjA7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnggPSB0aGlzLmhvbWVQb3NpdGlvbi54ICsgd2VhdmU7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSB0YXJnZXRaOwoKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzTWlkZmllbGRlcikgewogICAgICAgICAgICAgICAgaWYgKHByZXNzdXJlID4gMC44KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2lkZSA9ICh0aGlzLm1lc2gucG9zaXRpb24ueCA+IGJhbGxQb3MueCkgPyAxIDogLTE7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy54ID0gYmFsbFBvcy54ICsgKHNpZGUgKiAxMC4wKTsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSBiYWxsUG9zLnogLSAoYXR0YWNrRGlyICogMi4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWlkWiA9IChiYWxsUG9zLnogKyBnb2FsWikgKiAwLjQ1OwogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueiA9IG1pZFo7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJhbGxQb3MueCA8IC01KSBfdGFyZ2V0UG9zLnggPSA1OwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGJhbGxQb3MueCA+IDUpIF90YXJnZXRQb3MueCA9IC01OwogICAgICAgICAgICAgICAgICAgIGVsc2UgX3RhcmdldFBvcy54ID0gKHRoaXMuaG9tZVBvc2l0aW9uLnggPiAwID8gOCA6IC04KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBzYWZldHlEaXN0ID0gMTIuMDsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueiA9IGJhbGxQb3MueiAtIChhdHRhY2tEaXIgKiBzYWZldHlEaXN0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgX3RhcmdldFBvcy56ID0gTWF0aC5taW4oMzgsIF90YXJnZXRQb3Mueik7CiAgICAgICAgICAgICAgICBlbHNlIF90YXJnZXRQb3MueiA9IE1hdGgubWF4KC0zOCwgX3RhcmdldFBvcy56KTsKICAgICAgICAgICAgICAgIF90YXJnZXRQb3MueCA9IGJhbGxQb3MueCAqIDAuNiArIHRoaXMuaG9tZVBvc2l0aW9uLnggKiAwLjQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLl9pc1BhdGhCbG9ja2VkKF90YXJnZXRQb3MsIGJhbGxQb3MpKSB7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEuY29weShfdGFyZ2V0UG9zKTsgX3RlbXBWZWMxLnggLT0gOC4wOwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLmNvcHkoX3RhcmdldFBvcyk7IF90ZW1wVmVjMi54ICs9IDguMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYmxvY2tlZEwgPSB0aGlzLl9pc1BhdGhCbG9ja2VkKF90ZW1wVmVjMSwgYmFsbFBvcyk7CiAgICAgICAgICAgICAgICBjb25zdCBibG9ja2VkUiA9IHRoaXMuX2lzUGF0aEJsb2NrZWQoX3RlbXBWZWMyLCBiYWxsUG9zKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCFibG9ja2VkTCAmJiAhYmxvY2tlZFIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoX3RhcmdldFBvcy54IC0gX3RlbXBWZWMxLngpIDwgTWF0aC5hYnMoX3RhcmdldFBvcy54IC0gX3RlbXBWZWMyLngpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzEpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWJsb2NrZWRMKSB7CiAgICAgICAgICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KF90ZW1wVmVjMSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFibG9ja2VkUikgewogICAgICAgICAgICAgICAgICAgIF90YXJnZXRQb3MuY29weShfdGVtcFZlYzIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmxlcnAoYmFsbFBvcywgMC40KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fYXZvaWRUZWFtbWF0ZXMoX3RhcmdldFBvcyk7CiAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgdGhpcy5fbW92ZVRvKF90YXJnZXRQb3MpOwogICAgICAgIH0KCiAgICAgICAgX3N0YXRlRGVmZW5kKGR0KSB7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldFBvcyA9IHRoaXMucGVyY2VpdmVkVGFyZ2V0UG9zOwogICAgICAgICAgICBjb25zdCBkaXN0VG9CYWxsID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGFyZ2V0UG9zKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGxldCBwcmVzc1JhbmdlID0gdGhpcy5pc0RlZmVuZGVyID8gMTIuMCA6IDguMDsKICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMudGFja2xlICYmIHRoaXMuc3RhdHMuSFAgPiAyMCkgewogICAgICAgICAgICAgICAgcHJlc3NSYW5nZSArPSA1LjA7IAogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgYW1JQ2xvc2VzdCA9IHRydWU7CiAgICAgICAgICAgIGNvbnN0IG15RGlzdFNxID0gZGlzdFRvQmFsbCAqIGRpc3RUb0JhbGw7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy50ZWFtICYmIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBmb3IoY29uc3QgbWF0ZSBvZiB0aGlzLnRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgICAgIGlmIChtYXRlID09PSB0aGlzIHx8ICFtYXRlLm1lc2gpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIGlmIChtYXRlLnJvbGUgPT09ICdHTCcgfHwgbWF0ZS5zdGF0dXMubmFwID4gMCB8fCBtYXRlLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRTcSA9IG1hdGUubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvU3F1YXJlZCh0YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgICAgIGlmIChkU3EgPCBteURpc3RTcSkgewogICAgICAgICAgICAgICAgICAgICAgICBhbUlDbG9zZXN0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKaWYgKGFtSUNsb3Nlc3QpIHsKICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgPSAxMDAuMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb015R29hbCA9IE1hdGguYWJzKHRhcmdldFBvcy56IC0gKHRoaXMudGVhbS5zaWRlID09PSAxID8gNDQuNSA6IC00NC41KSk7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvTXlHb2FsIDwgMjAuMCkgewogICAgICAgICAgICAgICAgICAgIHByZXNzUmFuZ2UgPSAxNS4wOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwcmVzc1JhbmdlID0gOC4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoZGlzdFRvQmFsbCA8IHByZXNzUmFuZ2UpIHsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMy4wICYmICF0aGlzLmlzRGFzaGluZyAmJiB0aGlzLmN1cnJlbnRFTiA+IDUgJiYgTWF0aC5yYW5kb20oKSA8IDAuMDIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBfdGVtcFZlYzEuc3ViVmVjdG9ycyh0YXJnZXRQb3MsIHRoaXMubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFsbFJlZiAmJiB0aGlzLmJhbGxSZWYudmVsb2NpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlyLmFkZFNjYWxlZFZlY3Rvcih0aGlzLmJhbGxSZWYudmVsb2NpdHksIDAuMSkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuZGFzaChkaXIueCwgZGlyLnopOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkodGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWFya2luZyAmJiB0aGlzLm1hcmtpbmcubWVzaCkgewogICAgICAgICAgICAgICAgY29uc3QgbWFya1BvcyA9IHRoaXMubWFya2luZy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgbXlHb2FsWiA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSkgPyA0NiA6IC00NjsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMS5zZXQoMCwgMCwgbXlHb2FsWiAtIG1hcmtQb3Mueik7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzEubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLmNvcHkobWFya1BvcykuYWRkU2NhbGVkVmVjdG9yKF90ZW1wVmVjMSwgMy41KTsKICAgICAgICAgICAgICAgIHRoaXMuX2F2b2lkR29hbENyZWFzZShfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUbyhfdGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX3RhcmdldFBvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgX3RhcmdldFBvcy56ICs9IHRoaXMuYmFsbFJlZi5tZXNoLnBvc2l0aW9uLnogKiAwLjY7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5pc0RlZmVuZGVyKSB7CmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IG15R29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gZ29hbERpc3QgOiAtZ29hbERpc3Q7CiAgICAgICAgICAgICAgICBjb25zdCBtaWRwb2ludCA9ICh0aGlzLmJhbGxSZWYubWVzaC5wb3NpdGlvbi56ICsgbXlHb2FsWikgKiAwLjU7CiAgICAgICAgICAgICAgICBfdGFyZ2V0UG9zLnogPSAoX3RhcmdldFBvcy56ICsgbWlkcG9pbnQpICogMC41OwogICAgICAgICAgICB9Cgpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBsaW1pdFogPSBnb2FsRGlzdCAtIDIuNTsKICAgICAgICAgICAgX3RhcmdldFBvcy56ID0gTWF0aC5tYXgoLWxpbWl0WiwgTWF0aC5taW4obGltaXRaLCBfdGFyZ2V0UG9zLnopKTsKICAgICAgICAgICAgdGhpcy5fYXZvaWRHb2FsQ3JlYXNlKF90YXJnZXRQb3MpOwogICAgICAgICAgICB0aGlzLl9tb3ZlVG8oX3RhcmdldFBvcyk7CiAgICAgICAgfQoKICAgICAgICBfYXZvaWRHb2FsQ3JlYXNlKHRhcmdldFBvcykgewogICAgICAgICAgICBjb25zdCBjcmVhc2VSYWRpdXMgPSAxMC4wOwpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FscyA9IFt7IHg6IDAsIHo6IC1nb2FsRGlzdCB9LCB7IHg6IDAsIHo6IGdvYWxEaXN0IH1dOwoKICAgICAgICAgICAgZ29hbHMuZm9yRWFjaChnb2FsID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGR4ID0gdGFyZ2V0UG9zLnggLSBnb2FsLng7CiAgICAgICAgICAgICAgICBjb25zdCBkeiA9IHRhcmdldFBvcy56IC0gZ29hbC56OwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFNxID0gZHgqZHggKyBkeipkejsKCiAgICAgICAgICAgICAgICBpZiAoZGlzdFNxIDwgY3JlYXNlUmFkaXVzICogY3JlYXNlUmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkaXN0U3EpOwogICAgICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gMC4wMDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBjcmVhc2VSYWRpdXMgLyBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MueCA9IGdvYWwueCArIGR4ICogcmF0aW87CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy56ID0gZ29hbC56ICsgZHogKiByYXRpbzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3MueiA9IGdvYWwueiArIChnb2FsLnogPiAwID8gLWNyZWFzZVJhZGl1cyA6IGNyZWFzZVJhZGl1cyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNvbnN0IGFyZW5hUmFkaXVzID0gNDUuMDsKICAgICAgICAgICAgY29uc3QgZFNxID0gdGFyZ2V0UG9zLnggKiB0YXJnZXRQb3MueCArIHRhcmdldFBvcy56ICogdGFyZ2V0UG9zLno7CiAgICAgICAgICAgIGlmIChkU3EgPiBhcmVuYVJhZGl1cyphcmVuYVJhZGl1cykgewogICAgICAgICAgICAgICAgY29uc3QgZCA9IE1hdGguc3FydChkU3EpOwogICAgICAgICAgICAgICAgY29uc3QgciA9IGFyZW5hUmFkaXVzIC8gZDsKICAgICAgICAgICAgICAgIHRhcmdldFBvcy54ICo9IHI7CiAgICAgICAgICAgICAgICB0YXJnZXRQb3MueiAqPSByOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfZmluZEJlc3RQYXNzVGFyZ2V0KCkgewogICAgICAgICAgICBsZXQgYmVzdFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIGxldCBtYXhTY29yZSA9IC1JbmZpbml0eTsKY29uc3QgZ29hbERpc3QgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UgfHwgNDEuNTsKICAgICAgICAgICAgY29uc3QgZ29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gLWdvYWxEaXN0IDogZ29hbERpc3Q7CgogICAgICAgICAgICBmb3IgKGNvbnN0IG1hdGUgb2YgdGhpcy50ZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmIChtYXRlID09PSB0aGlzKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmICghbWF0ZS5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChtYXRlLnN0YXR1cy5uYXAgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChtYXRlLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8obWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgNC4wKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gMzAuMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9pc1BhdGhCbG9ja2VkKG1hdGUubWVzaC5wb3NpdGlvbikpIGNvbnRpbnVlOyAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHNjb3JlID0gMDsKICAgICAgICAgICAgICAgIGNvbnN0IG15RGlzdFRvR29hbCA9IE1hdGguYWJzKHRoaXMubWVzaC5wb3NpdGlvbi56IC0gZ29hbFopOwogICAgICAgICAgICAgICAgY29uc3QgbWF0ZURpc3RUb0dvYWwgPSBNYXRoLmFicyhtYXRlLm1lc2gucG9zaXRpb24ueiAtIGdvYWxaKTsKICAgICAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gbXlEaXN0VG9Hb2FsIC0gbWF0ZURpc3RUb0dvYWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNjb3JlICs9IHByb2dyZXNzICogMS41OyAKICAgICAgICAgICAgICAgIGlmIChtYXRlRGlzdFRvR29hbCA8IDE1LjApIHNjb3JlICs9IDEwLjA7CiAgICAgICAgICAgICAgICBpZiAobWF0ZURpc3RUb0dvYWwgPCA4LjApIHNjb3JlICs9IDE1LjA7CgogICAgICAgICAgICAgICAgY29uc3Qgb3Blbm5lc3MgPSB0aGlzLl9jYWxjdWxhdGVPcGVubmVzcyhtYXRlKTsKICAgICAgICAgICAgICAgIHNjb3JlICs9IG9wZW5uZXNzICogMy4wOwoKICAgICAgICAgICAgICAgIGlmIChtYXRlLmlzRm9yd2FyZCkgc2NvcmUgKz0gNS4wOwogICAgICAgICAgICAgICAgc2NvcmUgLT0gZGlzdCAqIDAuNTsKCiAgICAgICAgICAgICAgICBpZiAoc2NvcmUgPiBtYXhTY29yZSkgewogICAgICAgICAgICAgICAgICAgIG1heFNjb3JlID0gc2NvcmU7CiAgICAgICAgICAgICAgICAgICAgYmVzdFRhcmdldCA9IG1hdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJlc3RUYXJnZXQ7CiAgICAgICAgfQoKICAgICAgICBfY2FsY3VsYXRlT3Blbm5lc3MocGxheWVyKSB7CiAgICAgICAgICAgIGxldCBtaW5EZWZEaXN0ID0gOTk5OwogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybiAwOwogICAgICAgICAgICBjb25zdCBvcHBUZWFtID0gKHRoaXMudGVhbS5pZCA9PT0gJ2hvbWUnKSA/IGdhbWUudGVhbXMuYXdheSA6IGdhbWUudGVhbXMuaG9tZTsKCiAgICAgICAgICAgIGZvciAoY29uc3Qgb3BwIG9mIG9wcFRlYW0ucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKCFvcHAubWVzaCB8fCBvcHAuc3RhdHVzLm5hcCA+IDAgfHwgb3BwLnN0dW5UaW1lciA+IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZCA9IHBsYXllci5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8ob3BwLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKGQgPCBtaW5EZWZEaXN0KSBtaW5EZWZEaXN0ID0gZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gTWF0aC5taW4obWluRGVmRGlzdCwgOC4wKTsKICAgICAgICB9CgogICAgICAgIF9pc1BhdGhCbG9ja2VkKHRhcmdldFBvcywgc3RhcnRQb3MgPSBudWxsKSB7CiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gc3RhcnRQb3MgfHwgdGhpcy5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICBjb25zdCBlbmQgPSB0YXJnZXRQb3M7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBzdGFydC5kaXN0YW5jZVRvKGVuZCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBfc2NhbkRpci5zdWJWZWN0b3JzKGVuZCwgc3RhcnQpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAodGhpcy50ZWFtLmlkID09PSAnaG9tZScpID8gZ2FtZS50ZWFtcy5hd2F5IDogZ2FtZS50ZWFtcy5ob21lOwogICAgICAgICAgICBjb25zdCBzYWZldHlSYWRpdXMgPSAyLjU7IAoKICAgICAgICAgICAgZm9yIChjb25zdCBvcHAgb2Ygb3BwVGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9wcC5tZXNoIHx8IG9wcC5zdGF0dXMubmFwID4gMCB8fCBvcHAuc3R1blRpbWVyID4gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9zY2FuVG9PcHAuc3ViVmVjdG9ycyhvcHAubWVzaC5wb3NpdGlvbiwgc3RhcnQpOwogICAgICAgICAgICAgICAgY29uc3QgcHJvamVjdGlvbiA9IF9zY2FuVG9PcHAuZG90KF9zY2FuRGlyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHByb2plY3Rpb24gPiAwICYmIHByb2plY3Rpb24gPCBkaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGVycERpc3RTcSA9IF9zY2FuVG9PcHAubGVuZ3RoU3EoKSAtIChwcm9qZWN0aW9uICogcHJvamVjdGlvbik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBlcnBEaXN0U3EgPCAoc2FmZXR5UmFkaXVzICogc2FmZXR5UmFkaXVzKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgX21vdmVUbyh0YXJnZXQpIHsKICAgICAgICAgICAgX2FpVmVjLnN1YlZlY3RvcnModGFyZ2V0LCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICBfYWlWZWMueSA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBkaXN0U3EgPSBfYWlWZWMubGVuZ3RoU3EoKTsKICAgICAgICAgICAgaWYgKGRpc3RTcSA+IDEuMCkgewogICAgICAgICAgICAgICAgX2FpVmVjLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dChfYWlWZWMueCwgX2FpVmVjLnopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zZXRJbnB1dCgwLCAwKTsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoMC44KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2FwcGx5SW50ZXJjZXB0aW9uUHJlc3N1cmUoZHQpIHsKICAgICAgICAgICAgY29uc3QgYmFsbCA9IHRoaXMuYmFsbFJlZjsKICAgICAgICAgICAgaWYgKCFiYWxsIHx8ICFiYWxsLm1lc2gpIHJldHVybjsKCiAgICAgICAgICAgIGlmIChiYWxsLnN0YXRlICE9PSAnZnJlZScgfHwgYmFsbC52ZWxvY2l0eS5sZW5ndGhTcSgpIDwgMS4wKSByZXR1cm47CiAgICAgICAgICAgIGlmIChiYWxsLmlzSW52aXNpYmxlKSByZXR1cm47CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cy5uYXAgPiAwIHx8IHRoaXMuc3R1blRpbWVyID4gMCkgcmV0dXJuOwoKICAgICAgICAgICAgbGV0IHJhbmdlID0gMi4wOwogICAgICAgICAgICBpZiAodGhpcy50ZWNocy5wYXNzaXZlID09PSAnYnJhd2xlcicgfHwgdGhpcy50ZWNocy5wYXNzaXZlID09PSAnZWxpdGVfZGVmZW5zZScpIHsKICAgICAgICAgICAgICAgIHJhbmdlICs9IDEuNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIGlmIChkaXN0ID4gcmFuZ2UpIHJldHVybjsKCiAgICAgICAgICAgIF9zY2FuVG9PcHAuc3ViVmVjdG9ycyh0aGlzLm1lc2gucG9zaXRpb24sIGJhbGwubWVzaC5wb3NpdGlvbikubm9ybWFsaXplKCk7CiAgICAgICAgICAgIF90ZW1wVmVjMS5jb3B5KGJhbGwudmVsb2NpdHkpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaGVhZGluZ0RvdCA9IF90ZW1wVmVjMS5kb3QoX3NjYW5Ub09wcCk7CiAgICAgICAgICAgIGlmIChoZWFkaW5nRG90IDwgMC43KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBkaXN0RmFjdG9yID0gTWF0aC5tYXgoMCwgMS4wIC0gKGRpc3QgLyByYW5nZSkpOwogICAgICAgICAgICBjb25zdCBwcmVzc3VyZSA9IDEuNTsKCiAgICAgICAgICAgIGlmIChiYWxsLnBvd2VyID4gMCkgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlciAtPSBwcmVzc3VyZTsKICAgICAgICAgICAgICAgIHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgPSAodGhpcy5fYWNjdW11bGF0ZWRCbG9jayB8fCAwKSArIHByZXNzdXJlOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FjY3VtdWxhdGVkQmxvY2sgPj0gNS4wKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IE1hdGguZmxvb3IodGhpcy5fYWNjdW11bGF0ZWRCbG9jayk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRCbG9jayAtPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsgCiAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKGAtJHt2YWx9YCwgYmFsbC5tZXNoLnBvc2l0aW9uLCAiYmxvY2siLCBiYWxsLm1lc2gpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAoZGlzdEZhY3RvciAqIDAuOCkpIHsgCiAgICAgICAgICAgICAgICBfdGVtcFZlYzIuY29weSh0aGlzLm1lc2gucG9zaXRpb24pLmxlcnAoYmFsbC5tZXNoLnBvc2l0aW9uLCAwLjUgKyAoTWF0aC5yYW5kb20oKS0wLjUpKjAuMik7CiAgICAgICAgICAgICAgICBfdGVtcFZlYzIueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogMC41OwogICAgICAgICAgICAgICAgX3RlbXBWZWMyLnkgKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIDAuNTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjMi56ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3Bhd25DbGFzaCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5zcGF3bkNsYXNoKF90ZW1wVmVjMiwgMC42KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCAmJiBiYWxsLnBvd2VyVHlwZSA9PT0gJ1NIJykgewogICAgICAgICAgICAgICAgYmFsbC5wb3dlclR5cGUgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dCkgeyAKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJCTE9DS0VEIiwgdGhpcy5tZXNoLnBvc2l0aW9uLCAiY29taWMtaW1wYWN0Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiYWxsLnRlY2huaXF1ZSAmJiB0aGlzLnRlY2hJbW11bml0eVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICBjb25zdCB0ZWNoID0gYmFsbC50ZWNobmlxdWU7CiAgICAgICAgICAgICAgICBpZiAodGVjaC50eXBlID09PSAndmVub20nKSB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDE1LjApOwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGVjaC50eXBlID09PSAnbmFwJykgdGhpcy5hcHBseVN0YXR1cygnbmFwJywgOC4wKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlY2gudHlwZSA9PT0gJ3dpdGhlcicpIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDE1LjAsICdCTCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfY2FsY3VsYXRlUHJlc3N1cmVPblBsYXllcihwbGF5ZXIpIHsKICAgICAgICAgICAgaWYgKCFwbGF5ZXIgfHwgIXBsYXllci5tZXNoKSByZXR1cm4gMDsKICAgICAgICAgICAgY29uc3QgZ2FtZSA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFnYW1lKSByZXR1cm4gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IG9wcFRlYW0gPSAocGxheWVyLnRlYW0uaWQgPT09ICdob21lJykgPyBnYW1lLnRlYW1zLmF3YXkgOiBnYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGxldCBwcmVzc3VyZSA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGNvbnN0IG9wcCBvZiBvcHBUZWFtLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGlmICghb3BwLm1lc2ggfHwgb3BwLnN0YXR1cy5uYXAgPiAwIHx8IG9wcC5zdHVuVGltZXIgPiAwKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBwbGF5ZXIubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKG9wcC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgMTAuMCkgewogICAgICAgICAgICAgICAgICAgIHByZXNzdXJlICs9ICgxMC4wIC0gZGlzdCkgLyAxMC4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcmVzc3VyZTsKICAgICAgICB9CgogICAgICAgIF9hdm9pZFRlYW1tYXRlcyh0YXJnZXRQb3MpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnRlYW0pIHJldHVybjsKICAgICAgICAgICAgZm9yIChjb25zdCBtYXRlIG9mIHRoaXMudGVhbS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0ZSA9PT0gdGhpcyB8fCAhbWF0ZS5tZXNoKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGlmIChtYXRlLmhhc0JhbGwpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGFyZ2V0UG9zLmRpc3RhbmNlVG8obWF0ZS5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgNS4wKSB7CiAgICAgICAgICAgICAgICAgICAgX3RlbXBWZWMxLnN1YlZlY3RvcnModGFyZ2V0UG9zLCBtYXRlLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgICAgICAgIHRhcmdldFBvcy5hZGRTY2FsZWRWZWN0b3IoX3RlbXBWZWMxLCA1LjAgLSBkaXN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5BSVBsYXllciA9IEFJUGxheWVyOwp9KSgpOw==","Team.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIEZvcm1hdGlvbiBEZWZpbml0aW9ucyAoQ29vcmRpbmF0ZXMgZm9yIFNpZGUgMTogRGVmZW5kcyArWiwgQXR0YWNrcyAtWikKICAgIC8vIFg6IExlZnQoLSkvUmlnaHQoKyksIFo6IEZvcndhcmQoLSkvQmFjaygrKQogICAgY29uc3QgRk9STUFUSU9OUyA9IHsKICAgICAgICAnTm9ybWFsJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiA1IH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTEwLCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxMCwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdDZW50ZXIgQXR0YWNrJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAwIH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTQsIHo6IC0xNSB9LCAnUkYnOiB7IHg6IDQsIHo6IC0xNSB9CiAgICAgICAgfSwKICAgICAgICAnUmlnaHQgU2lkZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IDAsIHo6IDE1IH0sICdSRCc6IHsgeDogMTIsIHo6IDE1IH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiA1LCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxNSwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdMZWZ0IFNpZGUnOiB7CiAgICAgICAgICAgICdHTCc6IHsgeDogMCwgejogMjUgfSwKICAgICAgICAgICAgJ0xEJzogeyB4OiAtMTIsIHo6IDE1IH0sICdSRCc6IHsgeDogMCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAtMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTUsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IC01LCB6OiAtMTAgfQogICAgICAgIH0sCiAgICAgICAgJ0FsbC1PdXQgRGVmZW5zZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IC02LCB6OiAyMCB9LCAnUkQnOiB7IHg6IDYsIHo6IDIwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMTAgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTAsIHo6IDUgfSwgJ1JGJzogeyB4OiAxMCwgejogNSB9CiAgICAgICAgfSwKICAgICAgICAnRmxhdCBMaW5lJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDAgfSwgJ1JEJzogeyB4OiA4LCB6OiAwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMCB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xNSwgejogMCB9LCAnUkYnOiB7IHg6IDE1LCB6OiAwIH0KICAgICAgICB9LAogICAgICAgICdDb3VudGVyJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDIwIH0sICdSRCc6IHsgeDogOCwgejogMjAgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAxNSB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xMiwgejogLTIwIH0sICdSRic6IHsgeDogMTIsIHo6IC0yMCB9CiAgICAgICAgfSwKICAgICAgICAnRG91YmxlIFNpZGVzJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTE4LCB6OiAxNSB9LCAnUkQnOiB7IHg6IDE4LCB6OiAxNSB9LAogICAgICAgICAgICAnTUYnOiB7IHg6IDAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTgsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IDE4LCB6OiAtMTAgfQogICAgICAgIH0KICAgIH07CgoKCiAgICAvLyAtLS0gRW5lbXkgSW5kaWNhdG9yIChSZWQgQXJyb3cgU3ByaXRlKSAtLS0KICAgIC8vIFNoYXJlZCB0ZXh0dXJlL21hdGVyaWFsIHNvIHdlIGRvbid0IGNyZWF0ZSA2IGNhbnZhc2VzLgpjb25zdCBfZW5lbXlBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7CiAgICAgICAgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBjLndpZHRoLCBjLmhlaWdodCk7CiAgICAgICAgCiAgICAgICAgLy8gQXJyb3cgcG9pbnRpbmcgRE9XTgogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDYsIDEyKTsgICAKICAgICAgICBjdHgubGluZVRvKDU4LCAxMik7ICAKICAgICAgICBjdHgubGluZVRvKDMyLCA1Mik7ICAKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmYwMDAwJzsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpJzsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCmNvbnN0IF9wbGF5ZXJBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgYy53aWR0aCwgYy5oZWlnaHQpOwogICAgICAgIAogICAgICAgIC8vIEFycm93IHBvaW50aW5nIERPV04KICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyg2LCAxMik7ICAgCiAgICAgICAgY3R4LmxpbmVUbyg1OCwgMTIpOyAgCiAgICAgICAgY3R4LmxpbmVUbygzMiwgNTIpOyAgCiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwZmYwMCc7IC8vIEdyZWVuCiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsMjU1LDI1NSwwLjk1KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGMud2lkdGgsIGMuaGVpZ2h0KTsKICAgICAgICAKICAgICAgICAvLyBBcnJvdyBwb2ludGluZyBET1dOCiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oNiwgMTIpOyAgIAogICAgICAgIGN0eC5saW5lVG8oNTgsIDEyKTsgIAogICAgICAgIGN0eC5saW5lVG8oMzIsIDUyKTsgIAogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOyAvLyBXaGl0ZQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX2VuZW15QXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2VuZW15QXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CiAgICBjb25zdCBfcGxheWVyQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3BsYXllckFycm93VGV4dHVyZSwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoVGVzdDogZmFsc2UsIGRlcHRoV3JpdGU6IGZhbHNlIH0pOwogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3RlYW1tYXRlQXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CmNsYXNzIFRlYW0gewogICAgICAgIC8qKgogICAgICAgICAqIEdlbmVyYXRlcyBhbmQgYXBwbGllcyBzdGF0cyB0byBhIHBsYXllciBiYXNlZCBvbiByb2xlIGFuZCBsZXZlbC4KICAgICAgICAgKiBDZW50cmFsaXplcyBiYWxhbmNpbmcgdG8gZW5zdXJlIGhpZ2gtbGV2ZWwgcGxheSBmZWVscyBkaXN0aW5jdC4KICAgICAgICAgKi8KICAgICAgICBzdGF0aWMgZ2VuZXJhdGVTdGF0cyhwbGF5ZXIsIHJvbGUsIGxldmVsID0gMSwgaXNIdW1hbiA9IGZhbHNlKSB7CiAgICAgICAgICAgIC8vIDEuIERlZmluZSBSb2xlIEJhc2VsaW5lcyAoTGV2ZWwgMSkKICAgICAgICAgICAgLy8gQmFsYW5jZWQgdG8gYmUgd2VhayBidXQgZnVuY3Rpb25hbCBhdCBMZXZlbCAxCiAgICAgICAgICAgIGNvbnN0IGJhc2UgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLCBTUDogNTUsIEVOOiAxMCwgQVQ6IDUsIFBBOiA1LCBCTDogNSwgU0g6IDUsIENBOiA1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBSb2xlIFNwZWNpYWxpemF0aW9ucwogICAgICAgICAgICBzd2l0Y2gocm9sZSkgewogICAgICAgICAgICAgICAgY2FzZSAnTEYnOiBjYXNlICdSRic6IC8vIFN0cmlrZXJzCiAgICAgICAgICAgICAgICAgICAgYmFzZS5TSCArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLkVOICs9IDU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdNRic6IC8vIFBsYXltYWtlcnMKICAgICAgICAgICAgICAgICAgICBiYXNlLlBBICs9IDEwOyBiYXNlLkFUICs9IDg7IGJhc2UuRU4gKz0gODsgYmFzZS5TUCArPSAyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnTEQnOiBjYXNlICdSRCc6IC8vIERlZmVuZGVycwogICAgICAgICAgICAgICAgICAgIGJhc2UuQVQgKz0gMTI7IGJhc2UuQkwgKz0gMTA7IGJhc2UuUEEgKz0gNTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogLy8gR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFzZS5DQSArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLlBBICs9IDE1OyAvLyBTdHJvbmcgYXJtCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFNjYWxpbmcgRmFjdG9ycyAoUGVyIExldmVsKQogICAgICAgICAgICAvLyBEZXNpZ25lZCBzbyBMZXZlbCA1MCBpcyAiR29kIFRpZXIiIGFuZCBMZXZlbCAxIGlzICJSb29raWUiCiAgICAgICAgICAgIGNvbnN0IGdyb3d0aCA9IHsKICAgICAgICAgICAgICAgIEhQOiAxNSwgICAgLy8gKzE1MDAgSFAgYXQgTHZsIDk5CiAgICAgICAgICAgICAgICBTUDogMC41LCAgIC8vICs1MCBTUCBhdCBMdmwgOTkgKFNwZWVkIGRlbW9uKQogICAgICAgICAgICAgICAgUHJpbWFyeTogMC44LCAvLyArODAgU3RhdCBhdCBMdmwgOTkKICAgICAgICAgICAgICAgIFNlY29uZGFyeTogMC41IC8vICs1MCBTdGF0IGF0IEx2bCA5OQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIHNjYWxlCiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHZhbCwgcmF0ZSkgPT4gTWF0aC5mbG9vcih2YWwgKyAoKGxldmVsIC0gMSkgKiByYXRlKSk7CgogICAgICAgICAgICAvLyBBcHBseSBTY2FsaW5nCiAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCA9IHNjYWxlKGJhc2UuSFAsIGdyb3d0aC5IUCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTUDogQ2FwIGF0IDk5LCBidXQgZW5zdXJlIGhpZ2ggbGV2ZWxzIGZlZWwgRkFTVAogICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TUCwgZ3Jvd3RoLlNQKSk7CgogICAgICAgICAgICAvLyBTdGF0IGRpc3RyaWJ1dGlvbiBiYXNlZCBvbiByb2xlIHByaW9yaXRpZXMKICAgICAgICAgICAgaWYgKFsnTEYnLCAnUkYnXS5pbmNsdWRlcyhyb2xlKSkgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlNIID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuU0gsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5FTiwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguU2Vjb25kYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb2xlID09PSAnTUYnKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU0ggPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TSCwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChbJ0xEJywgJ1JEJ10uaW5jbHVkZXMocm9sZSkpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjIpKTsgLy8gRGVmZW5kZXJzIGJhZCBhdCBzaG9vdGluZwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGUgPT09ICdHTCcpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5DQSA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkNBLCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlBBID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuUEEsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjMpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSHVtYW4gUGxheWVyIEJvbnVzIChUaGUgIkhlcm8iIEZlZWwpCiAgICAgICAgICAgIC8vIEdpdmVzIHRoZSBwbGF5ZXIgYSBzbGlnaHQgZWRnZSB0byBtYWtlIGdhbWVwbGF5IGZlZWwgcHVuY2h5Ci8vIDMuIEh1bWFuIFBsYXllciBCb251cyAoVGhlICJIZXJvIiBGZWVsKQogICAgICAgICAgICAvLyBHaXZlcyB0aGUgcGxheWVyIGEgc2xpZ2h0IGVkZ2UgdG8gbWFrZSBnYW1lcGxheSBmZWVsIHB1bmNoeQogICAgICAgICAgICBpZiAoaXNIdW1hbikgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkhQICs9IDMwMDsgLy8gVGFua2llciAod2FzIDE1MCkKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TUCArPSA4OyAgIC8vIEZhc3RlciAod2FzIDUpCiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gKz0gMTA7ICAgLy8gSGFyZGVyIHRvIHRhY2tsZSAod2FzIDUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEtleSBTdGF0IEJvb3N0CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ0xGJyB8fCByb2xlID09PSAnUkYnKSBwbGF5ZXIuc3RhdHMuU0ggKz0gNTsKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnTUYnKSBwbGF5ZXIuc3RhdHMuUEEgKz0gNTsKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnTEQnIHx8IHJvbGUgPT09ICdSRCcpIHBsYXllci5zdGF0cy5BVCArPSA1OwogICAgICAgICAgICAgICAgaWYgKHJvbGUgPT09ICdHTCcpIHBsYXllci5zdGF0cy5DQSArPSA1OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA0LiBGaW5hbGl6ZQogICAgICAgICAgICBwbGF5ZXIuc3RhdHMubWF4SFAgPSBwbGF5ZXIuc3RhdHMuSFA7CiAgICAgICAgICAgIHBsYXllci5sZXZlbCA9IGxldmVsOwogICAgICAgICAgICBwbGF5ZXIuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwogICAgICAgIH0KCmNvbnN0cnVjdG9yKHNjZW5lLCBpZCwgc2lkZSwgY29sb3IsIGlzSHVtYW4pIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmlkID0gaWQ7IC8vICdob21lJyBvciAnYXdheScKICAgICAgICAgICAgdGhpcy5zaWRlID0gc2lkZTsgLy8gMSAoRGVmZW5kcyArWikgb3IgLTEgKERlZmVuZHMgLVopCiAgICAgICAgICAgIHRoaXMuY29sb3IgPSBjb2xvcjsKICAgICAgICAgICAgdGhpcy5pc0h1bWFuID0gaXNIdW1hbjsKICAgICAgICAgICAgdGhpcy5haUVuYWJsZWQgPSB0cnVlOyAvLyBNYXN0ZXIgc3dpdGNoIGZvciBBSSBsb2dpYwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzID0gW107CiAgICAgICAgICAgIHRoaXMuYWN0aXZlUGxheWVyID0gbnVsbDsgLy8gVGhlIHBsYXllciBjdXJyZW50bHkgY29udHJvbGxlZC9mb2N1c2VkCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGb3JtYXRpb24gQW5jaG9ycwogICAgICAgICAgICB0aGlzLmN1cnJlbnRGb3JtYXRpb24gPSAnTm9ybWFsJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBsYXllciBJbmRpY2F0b3IgKEdyZWVuIEFycm93KQogICAgICAgICAgICBpZiAodGhpcy5pc0h1bWFuKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXllckFycm93ID0gbmV3IFRIUkVFLlNwcml0ZShfcGxheWVyQXJyb3dNYXRlcmlhbCk7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXllckFycm93LnNjYWxlLnNldCgwLjgsIDAuOCwgMS4wKTsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cucmVuZGVyT3JkZXIgPSAxMDAwOyAvLyBPbiB0b3AKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYXNzaWduTWFya3Mob3Bwb3NpbmdUZWFtKSB7CiAgICAgICAgICAgIC8vIFNpbXBsZSBhdXRvLWFzc2lnbiBsb2dpYzogTWFyayB0aGUgcGxheWVyIGluIHRoZSAibWF0Y2hpbmciIHBvc2l0aW9uCiAgICAgICAgICAgIC8vIExGPC0+UkQsIFJGPC0+TEQsIE1GPC0+TUYsIExEPC0+UkYsIFJEPC0+TEYsIEdMPC0+TEYKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0Um9sZSA9ICdNRic7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHAucm9sZSkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgJ0xGJzogdGFyZ2V0Um9sZSA9ICdSRCc7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ1JGJzogdGFyZ2V0Um9sZSA9ICdMRCc7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ01GJzogdGFyZ2V0Um9sZSA9ICdNRic7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ0xEJzogdGFyZ2V0Um9sZSA9ICdSRic7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ1JEJzogdGFyZ2V0Um9sZSA9ICdMRic7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogdGFyZ2V0Um9sZSA9ICdMRic7IGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IG9wcG9zaW5nVGVhbS5wbGF5ZXJzLmZpbmQob3AgPT4gb3Aucm9sZSA9PT0gdGFyZ2V0Um9sZSk7CiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICAgICAgICAgICAgcC5tYXJraW5nID0gdGFyZ2V0OwogICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGAke3RoaXMuaWR9ICR7cC5yb2xlfSBtYXJrZWQgJHt0YXJnZXQucm9sZX1gKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBhZGRQbGF5ZXIocGxheWVyKSB7CiAgICAgICAgICAgIHRoaXMucGxheWVycy5wdXNoKHBsYXllcik7CiAgICAgICAgICAgIHBsYXllci50ZWFtID0gdGhpczsKCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBIb21lIFBvc2l0aW9uIGJhc2VkIG9uIEZvcm1hdGlvbgogICAgICAgICAgICB0aGlzLl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocGxheWVyKTsKCiAgICAgICAgICAgIC8vIEVuZW15IGluZGljYXRvcjogcmVkIGFycm93cyBvdmVyIHRoZSBBd2F5IHRlYW0gKHNvIGVuZW1pZXMgYXJlIHJlYWRhYmxlKQovLyBFbmVteSBpbmRpY2F0b3I6IHJlZCBhcnJvd3Mgb3ZlciB0aGUgQXdheSB0ZWFtCiAgICAgICAgICAgIGlmICh0aGlzLmlkID09PSAnYXdheScgJiYgcGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFycm93ID0gbmV3IFRIUkVFLlNwcml0ZShfZW5lbXlBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIGFycm93LnNjYWxlLnNldCgwLjgsIDAuOCwgMS4wKTsKICAgICAgICAgICAgICAgIGFycm93LnBvc2l0aW9uLnNldCgwLCAzLjIsIDApOyAvLyBhYm92ZSBoZWFkCiAgICAgICAgICAgICAgICBhcnJvdy5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLmFkZChhcnJvdyk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuZW5lbXlBcnJvdyA9IGFycm93OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUZWFtbWF0ZSBpbmRpY2F0b3I6IFdoaXRlIGFycm93cyBmb3IgaW5hY3RpdmUgaHVtYW5zCiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4gJiYgcGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFycm93ID0gbmV3IFRIUkVFLlNwcml0ZShfdGVhbW1hdGVBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIGFycm93LnNjYWxlLnNldCgwLjYsIDAuNiwgMS4wKTsKICAgICAgICAgICAgICAgIGFycm93LnBvc2l0aW9uLnNldCgwLCAzLjIsIDApOwogICAgICAgICAgICAgICAgYXJyb3cucmVuZGVyT3JkZXIgPSA5OTk7CiAgICAgICAgICAgICAgICBhcnJvdy52aXNpYmxlID0gZmFsc2U7IC8vIEhpZGRlbiBieSBkZWZhdWx0LCBtYW5hZ2VkIGJ5IHNldEFjdGl2ZVBsYXllcgogICAgICAgICAgICAgICAgcGxheWVyLm1lc2guYWRkKGFycm93KTsKICAgICAgICAgICAgICAgIHBsYXllci50ZWFtbWF0ZUFycm93ID0gYXJyb3c7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNldEZvcm1hdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGlmICghRk9STUFUSU9OU1tuYW1lXSkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRGb3JtYXRpb24gPSBuYW1lOwogICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgVGVhbSAke3RoaXMuaWR9IHN3aXRjaGVkIHRvICR7bmFtZX1gKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGxheWVySG9tZVBvc2l0aW9uKHApOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfdXBkYXRlUGxheWVySG9tZVBvc2l0aW9uKHBsYXllcikgewogICAgICAgICAgICBjb25zdCBkYXRhID0gRk9STUFUSU9OU1t0aGlzLmN1cnJlbnRGb3JtYXRpb25dOwogICAgICAgICAgICBpZiAoIWRhdGEpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGRhdGFbcGxheWVyLnJvbGVdOwogICAgICAgICAgICBpZiAob2Zmc2V0KSB7CiAgICAgICAgICAgICAgICAvLyBYIFBvc2l0aW9uOgogICAgICAgICAgICAgICAgLy8gRm9ybWF0aW9uczogLVggaXMgTGVmdCwgK1ggaXMgUmlnaHQuCiAgICAgICAgICAgICAgICAvLyBIb21lIFRlYW0gKFNpZGUgMSkgZmFjZXMgLVouIExlZnQgaXMgLVguIFVzZSBvZmZzZXQueCBhcyBpcy4KICAgICAgICAgICAgICAgIGxldCB4UG9zID0gb2Zmc2V0Lng7CiAgICAgICAgICAgICAgICBsZXQgelBvcyA9IG9mZnNldC56ICogdGhpcy5zaWRlOwoKICAgICAgICAgICAgICAgIHBsYXllci5ob21lUG9zaXRpb24uc2V0KHhQb3MsIDAsIHpQb3MpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBd2F5IFRlYW0gKFNpZGUgLTEpIGZhY2VzICtaLiBMZWZ0IGlzICtYLiBGbGlwIFguCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaWRlID09PSAtMSkgewogICAgICAgICAgICAgICAgICAgIHBsYXllci5ob21lUG9zaXRpb24ueCAqPSAtMTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldCBpbml0aWFsIHBvc2l0aW9uCiAgICAgICAgICAgIGlmIChwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgcGxheWVyLm1lc2gucG9zaXRpb24uY29weShwbGF5ZXIuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyICgwLDAsMCkKICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucGxheWVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMucGxheWVyc1tpXS51cGRhdGVQaHlzaWNzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJzW2ldLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayBpZiBub3Qgc3BsaXQgeWV0CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJzW2ldLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbikgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVBY3RpdmVQbGF5ZXJTZWxlY3Rpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucGxheWVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMucGxheWVyc1tpXS51cGRhdGVWaXN1YWxzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJzW2ldLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVBY3RpdmVQbGF5ZXJTZWxlY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKCFiYWxsKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBPRkZFTlNFOiBJZiB3ZSBoYXZlIHRoZSBiYWxsLCBhY3RpdmUgcGxheWVyIGlzIHRoZSBob2xkZXIKICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVBsYXllciAhPT0gYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihiYWxsLmhvbGRlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIERFRkVOU0U6IFNlbGVjdCBjbG9zZXN0IHRvIGJhbGwKICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBPbmx5IGNoZWNrIGV2ZXJ5IGZldyBmcmFtZXMgb3IgaWYgZGlzdGFuY2UgaXMgc2lnbmlmaWNhbnQKICAgICAgICAgICAgbGV0IGNsb3Nlc3QgPSBudWxsOwogICAgICAgICAgICBsZXQgbWluRHN0ID0gSW5maW5pdHk7CgogICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocC5yb2xlID09PSAnR0wnKSBjb250aW51ZTsgLy8gRG9uJ3QgYXV0by1zd2l0Y2ggdG8gZ29hbGllIHVzdWFsbHkKICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICBjb25zdCBkID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkIDwgbWluRHN0KSB7CiAgICAgICAgICAgICAgICAgICAgbWluRHN0ID0gZDsKICAgICAgICAgICAgICAgICAgICBjbG9zZXN0ID0gcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNsb3Nlc3QgJiYgY2xvc2VzdCAhPT0gdGhpcy5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0QWN0aXZlUGxheWVyKGNsb3Nlc3QpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKc2V0QWN0aXZlUGxheWVyKHBsYXllcikgewogICAgICAgICAgICAvLyBSZXNldCBpbnB1dCBvbiBwcmV2aW91cwogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlUGxheWVyLnNldElucHV0KDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYWN0aXZlUGxheWVyID0gcGxheWVyOwoKICAgICAgICAgICAgLy8gVmlzdWFsIEluZGljYXRvcnMKICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbikgewogICAgICAgICAgICAgICAgLy8gMS4gR3JlZW4gQXJyb3cgZm9yIEFjdGl2ZQogICAgICAgICAgICAgICAgaWYgKHRoaXMucGxheWVyQXJyb3cgJiYgcGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5hZGQodGhpcy5wbGF5ZXJBcnJvdyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJBcnJvdy5wb3NpdGlvbi5zZXQoMCwgMy41LCAwKTsgLy8gRmxvYXQgYWJvdmUgaGVhZAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDIuIFdoaXRlIEFycm93cyBmb3IgT3RoZXJzCiAgICAgICAgICAgICAgICB0aGlzLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAocC50ZWFtbWF0ZUFycm93KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAudGVhbW1hdGVBcnJvdy52aXNpYmxlID0gKHAgIT09IHBsYXllcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpyZXNldFBvc2l0aW9ucygpIHsKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHRoaXMucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5jb3B5KHAuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBQaHlzaWNzCiAgICAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgcC5pbnB1dFZlY3Rvci5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgcC5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBwLmlzVGhyb3dpbmcgPSBmYWxzZTsKcC5sb3NlQmFsbCgpOyAvLyBEcm9wIGJhbGwgaWYgaG9sZGluZwogICAgICAgICAgICAgICAgICAgIHAuY2FuQ2F0Y2ggPSB0cnVlOyAvLyBGb3JjZSByZXNldCBjYXBhYmlsaXR5CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgU3RhdHMKICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgICAgICAgICAgCi8vIE9yaWVudGF0aW9uOiBGYWNlIENlbnRlcgogICAgICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuc3luY1JvdGF0aW9uKSBwLnN5bmNSb3RhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IEFuaW1hdGlvbgogICAgICAgICAgICAgICAgICAgIHAucGxheSgnaWRsZScsIDAuMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUmVzZXQgYWN0aXZlIHBsYXllciB0byBNRgogICAgICAgICAgICBjb25zdCBtZiA9IHRoaXMucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgaWYgKG1mKSB0aGlzLnNldEFjdGl2ZVBsYXllcihtZik7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LlRlYW0gPSBUZWFtOwp9KSgpOw==","./Team.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIEZvcm1hdGlvbiBEZWZpbml0aW9ucyAoQ29vcmRpbmF0ZXMgZm9yIFNpZGUgMTogRGVmZW5kcyArWiwgQXR0YWNrcyAtWikKICAgIC8vIFg6IExlZnQoLSkvUmlnaHQoKyksIFo6IEZvcndhcmQoLSkvQmFjaygrKQogICAgY29uc3QgRk9STUFUSU9OUyA9IHsKICAgICAgICAnTm9ybWFsJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiA1IH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTEwLCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxMCwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdDZW50ZXIgQXR0YWNrJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAwIH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTQsIHo6IC0xNSB9LCAnUkYnOiB7IHg6IDQsIHo6IC0xNSB9CiAgICAgICAgfSwKICAgICAgICAnUmlnaHQgU2lkZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IDAsIHo6IDE1IH0sICdSRCc6IHsgeDogMTIsIHo6IDE1IH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiA1LCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxNSwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdMZWZ0IFNpZGUnOiB7CiAgICAgICAgICAgICdHTCc6IHsgeDogMCwgejogMjUgfSwKICAgICAgICAgICAgJ0xEJzogeyB4OiAtMTIsIHo6IDE1IH0sICdSRCc6IHsgeDogMCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAtMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTUsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IC01LCB6OiAtMTAgfQogICAgICAgIH0sCiAgICAgICAgJ0FsbC1PdXQgRGVmZW5zZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IC02LCB6OiAyMCB9LCAnUkQnOiB7IHg6IDYsIHo6IDIwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMTAgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTAsIHo6IDUgfSwgJ1JGJzogeyB4OiAxMCwgejogNSB9CiAgICAgICAgfSwKICAgICAgICAnRmxhdCBMaW5lJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDAgfSwgJ1JEJzogeyB4OiA4LCB6OiAwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMCB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xNSwgejogMCB9LCAnUkYnOiB7IHg6IDE1LCB6OiAwIH0KICAgICAgICB9LAogICAgICAgICdDb3VudGVyJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDIwIH0sICdSRCc6IHsgeDogOCwgejogMjAgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAxNSB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xMiwgejogLTIwIH0sICdSRic6IHsgeDogMTIsIHo6IC0yMCB9CiAgICAgICAgfSwKICAgICAgICAnRG91YmxlIFNpZGVzJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTE4LCB6OiAxNSB9LCAnUkQnOiB7IHg6IDE4LCB6OiAxNSB9LAogICAgICAgICAgICAnTUYnOiB7IHg6IDAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTgsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IDE4LCB6OiAtMTAgfQogICAgICAgIH0KICAgIH07CgoKCiAgICAvLyAtLS0gRW5lbXkgSW5kaWNhdG9yIChSZWQgQXJyb3cgU3ByaXRlKSAtLS0KICAgIC8vIFNoYXJlZCB0ZXh0dXJlL21hdGVyaWFsIHNvIHdlIGRvbid0IGNyZWF0ZSA2IGNhbnZhc2VzLgpjb25zdCBfZW5lbXlBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7CiAgICAgICAgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBjLndpZHRoLCBjLmhlaWdodCk7CiAgICAgICAgCiAgICAgICAgLy8gQXJyb3cgcG9pbnRpbmcgRE9XTgogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDYsIDEyKTsgICAKICAgICAgICBjdHgubGluZVRvKDU4LCAxMik7ICAKICAgICAgICBjdHgubGluZVRvKDMyLCA1Mik7ICAKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmYwMDAwJzsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpJzsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCmNvbnN0IF9wbGF5ZXJBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgYy53aWR0aCwgYy5oZWlnaHQpOwogICAgICAgIAogICAgICAgIC8vIEFycm93IHBvaW50aW5nIERPV04KICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyg2LCAxMik7ICAgCiAgICAgICAgY3R4LmxpbmVUbyg1OCwgMTIpOyAgCiAgICAgICAgY3R4LmxpbmVUbygzMiwgNTIpOyAgCiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwZmYwMCc7IC8vIEdyZWVuCiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsMjU1LDI1NSwwLjk1KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGMud2lkdGgsIGMuaGVpZ2h0KTsKICAgICAgICAKICAgICAgICAvLyBBcnJvdyBwb2ludGluZyBET1dOCiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oNiwgMTIpOyAgIAogICAgICAgIGN0eC5saW5lVG8oNTgsIDEyKTsgIAogICAgICAgIGN0eC5saW5lVG8oMzIsIDUyKTsgIAogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOyAvLyBXaGl0ZQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX2VuZW15QXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2VuZW15QXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CiAgICBjb25zdCBfcGxheWVyQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3BsYXllckFycm93VGV4dHVyZSwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoVGVzdDogZmFsc2UsIGRlcHRoV3JpdGU6IGZhbHNlIH0pOwogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3RlYW1tYXRlQXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CmNsYXNzIFRlYW0gewogICAgICAgIC8qKgogICAgICAgICAqIEdlbmVyYXRlcyBhbmQgYXBwbGllcyBzdGF0cyB0byBhIHBsYXllciBiYXNlZCBvbiByb2xlIGFuZCBsZXZlbC4KICAgICAgICAgKiBDZW50cmFsaXplcyBiYWxhbmNpbmcgdG8gZW5zdXJlIGhpZ2gtbGV2ZWwgcGxheSBmZWVscyBkaXN0aW5jdC4KICAgICAgICAgKi8KICAgICAgICBzdGF0aWMgZ2VuZXJhdGVTdGF0cyhwbGF5ZXIsIHJvbGUsIGxldmVsID0gMSwgaXNIdW1hbiA9IGZhbHNlKSB7CiAgICAgICAgICAgIC8vIDEuIERlZmluZSBSb2xlIEJhc2VsaW5lcyAoTGV2ZWwgMSkKICAgICAgICAgICAgLy8gQmFsYW5jZWQgdG8gYmUgd2VhayBidXQgZnVuY3Rpb25hbCBhdCBMZXZlbCAxCiAgICAgICAgICAgIGNvbnN0IGJhc2UgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLCBTUDogNTUsIEVOOiAxMCwgQVQ6IDUsIFBBOiA1LCBCTDogNSwgU0g6IDUsIENBOiA1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBSb2xlIFNwZWNpYWxpemF0aW9ucwogICAgICAgICAgICBzd2l0Y2gocm9sZSkgewogICAgICAgICAgICAgICAgY2FzZSAnTEYnOiBjYXNlICdSRic6IC8vIFN0cmlrZXJzCiAgICAgICAgICAgICAgICAgICAgYmFzZS5TSCArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLkVOICs9IDU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdNRic6IC8vIFBsYXltYWtlcnMKICAgICAgICAgICAgICAgICAgICBiYXNlLlBBICs9IDEwOyBiYXNlLkFUICs9IDg7IGJhc2UuRU4gKz0gODsgYmFzZS5TUCArPSAyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnTEQnOiBjYXNlICdSRCc6IC8vIERlZmVuZGVycwogICAgICAgICAgICAgICAgICAgIGJhc2UuQVQgKz0gMTI7IGJhc2UuQkwgKz0gMTA7IGJhc2UuUEEgKz0gNTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogLy8gR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFzZS5DQSArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLlBBICs9IDE1OyAvLyBTdHJvbmcgYXJtCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFNjYWxpbmcgRmFjdG9ycyAoUGVyIExldmVsKQogICAgICAgICAgICAvLyBEZXNpZ25lZCBzbyBMZXZlbCA1MCBpcyAiR29kIFRpZXIiIGFuZCBMZXZlbCAxIGlzICJSb29raWUiCiAgICAgICAgICAgIGNvbnN0IGdyb3d0aCA9IHsKICAgICAgICAgICAgICAgIEhQOiAxNSwgICAgLy8gKzE1MDAgSFAgYXQgTHZsIDk5CiAgICAgICAgICAgICAgICBTUDogMC41LCAgIC8vICs1MCBTUCBhdCBMdmwgOTkgKFNwZWVkIGRlbW9uKQogICAgICAgICAgICAgICAgUHJpbWFyeTogMC44LCAvLyArODAgU3RhdCBhdCBMdmwgOTkKICAgICAgICAgICAgICAgIFNlY29uZGFyeTogMC41IC8vICs1MCBTdGF0IGF0IEx2bCA5OQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIHNjYWxlCiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHZhbCwgcmF0ZSkgPT4gTWF0aC5mbG9vcih2YWwgKyAoKGxldmVsIC0gMSkgKiByYXRlKSk7CgogICAgICAgICAgICAvLyBBcHBseSBTY2FsaW5nCiAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCA9IHNjYWxlKGJhc2UuSFAsIGdyb3d0aC5IUCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTUDogQ2FwIGF0IDk5LCBidXQgZW5zdXJlIGhpZ2ggbGV2ZWxzIGZlZWwgRkFTVAogICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TUCwgZ3Jvd3RoLlNQKSk7CgogICAgICAgICAgICAvLyBTdGF0IGRpc3RyaWJ1dGlvbiBiYXNlZCBvbiByb2xlIHByaW9yaXRpZXMKICAgICAgICAgICAgaWYgKFsnTEYnLCAnUkYnXS5pbmNsdWRlcyhyb2xlKSkgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlNIID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuU0gsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5FTiwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguU2Vjb25kYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb2xlID09PSAnTUYnKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU0ggPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TSCwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChbJ0xEJywgJ1JEJ10uaW5jbHVkZXMocm9sZSkpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjIpKTsgLy8gRGVmZW5kZXJzIGJhZCBhdCBzaG9vdGluZwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGUgPT09ICdHTCcpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5DQSA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkNBLCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlBBID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuUEEsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjMpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSHVtYW4gUGxheWVyIEJvbnVzIChUaGUgIkhlcm8iIEZlZWwpCiAgICAgICAgICAgIC8vIEdpdmVzIHRoZSBwbGF5ZXIgYSBzbGlnaHQgZWRnZSB0byBtYWtlIGdhbWVwbGF5IGZlZWwgcHVuY2h5Ci8vIDMuIEh1bWFuIFBsYXllciBCb251cyAoVGhlICJIZXJvIiBGZWVsKQogICAgICAgICAgICAvLyBHaXZlcyB0aGUgcGxheWVyIGEgc2xpZ2h0IGVkZ2UgdG8gbWFrZSBnYW1lcGxheSBmZWVsIHB1bmNoeQogICAgICAgICAgICBpZiAoaXNIdW1hbikgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkhQICs9IDMwMDsgLy8gVGFua2llciAod2FzIDE1MCkKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TUCArPSA4OyAgIC8vIEZhc3RlciAod2FzIDUpCiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gKz0gMTA7ICAgLy8gSGFyZGVyIHRvIHRhY2tsZSAod2FzIDUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEtleSBTdGF0IEJvb3N0CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ0xGJyB8fCByb2xlID09PSAnUkYnKSBwbGF5ZXIuc3RhdHMuU0ggKz0gNTsKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnTUYnKSBwbGF5ZXIuc3RhdHMuUEEgKz0gNTsKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnTEQnIHx8IHJvbGUgPT09ICdSRCcpIHBsYXllci5zdGF0cy5BVCArPSA1OwogICAgICAgICAgICAgICAgaWYgKHJvbGUgPT09ICdHTCcpIHBsYXllci5zdGF0cy5DQSArPSA1OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA0LiBGaW5hbGl6ZQogICAgICAgICAgICBwbGF5ZXIuc3RhdHMubWF4SFAgPSBwbGF5ZXIuc3RhdHMuSFA7CiAgICAgICAgICAgIHBsYXllci5sZXZlbCA9IGxldmVsOwogICAgICAgICAgICBwbGF5ZXIuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwogICAgICAgIH0KCmNvbnN0cnVjdG9yKHNjZW5lLCBpZCwgc2lkZSwgY29sb3IsIGlzSHVtYW4pIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmlkID0gaWQ7IC8vICdob21lJyBvciAnYXdheScKICAgICAgICAgICAgdGhpcy5zaWRlID0gc2lkZTsgLy8gMSAoRGVmZW5kcyArWikgb3IgLTEgKERlZmVuZHMgLVopCiAgICAgICAgICAgIHRoaXMuY29sb3IgPSBjb2xvcjsKICAgICAgICAgICAgdGhpcy5pc0h1bWFuID0gaXNIdW1hbjsKICAgICAgICAgICAgdGhpcy5haUVuYWJsZWQgPSB0cnVlOyAvLyBNYXN0ZXIgc3dpdGNoIGZvciBBSSBsb2dpYwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzID0gW107CiAgICAgICAgICAgIHRoaXMuYWN0aXZlUGxheWVyID0gbnVsbDsgLy8gVGhlIHBsYXllciBjdXJyZW50bHkgY29udHJvbGxlZC9mb2N1c2VkCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGb3JtYXRpb24gQW5jaG9ycwogICAgICAgICAgICB0aGlzLmN1cnJlbnRGb3JtYXRpb24gPSAnTm9ybWFsJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBsYXllciBJbmRpY2F0b3IgKEdyZWVuIEFycm93KQogICAgICAgICAgICBpZiAodGhpcy5pc0h1bWFuKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXllckFycm93ID0gbmV3IFRIUkVFLlNwcml0ZShfcGxheWVyQXJyb3dNYXRlcmlhbCk7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXllckFycm93LnNjYWxlLnNldCgwLjgsIDAuOCwgMS4wKTsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cucmVuZGVyT3JkZXIgPSAxMDAwOyAvLyBPbiB0b3AKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYXNzaWduTWFya3Mob3Bwb3NpbmdUZWFtKSB7CiAgICAgICAgICAgIC8vIFNpbXBsZSBhdXRvLWFzc2lnbiBsb2dpYzogTWFyayB0aGUgcGxheWVyIGluIHRoZSAibWF0Y2hpbmciIHBvc2l0aW9uCiAgICAgICAgICAgIC8vIExGPC0+UkQsIFJGPC0+TEQsIE1GPC0+TUYsIExEPC0+UkYsIFJEPC0+TEYsIEdMPC0+TEYKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0Um9sZSA9ICdNRic7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHAucm9sZSkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgJ0xGJzogdGFyZ2V0Um9sZSA9ICdSRCc7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ1JGJzogdGFyZ2V0Um9sZSA9ICdMRCc7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ01GJzogdGFyZ2V0Um9sZSA9ICdNRic7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ0xEJzogdGFyZ2V0Um9sZSA9ICdSRic7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ1JEJzogdGFyZ2V0Um9sZSA9ICdMRic7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogdGFyZ2V0Um9sZSA9ICdMRic7IGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IG9wcG9zaW5nVGVhbS5wbGF5ZXJzLmZpbmQob3AgPT4gb3Aucm9sZSA9PT0gdGFyZ2V0Um9sZSk7CiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICAgICAgICAgICAgcC5tYXJraW5nID0gdGFyZ2V0OwogICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGAke3RoaXMuaWR9ICR7cC5yb2xlfSBtYXJrZWQgJHt0YXJnZXQucm9sZX1gKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBhZGRQbGF5ZXIocGxheWVyKSB7CiAgICAgICAgICAgIHRoaXMucGxheWVycy5wdXNoKHBsYXllcik7CiAgICAgICAgICAgIHBsYXllci50ZWFtID0gdGhpczsKCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBIb21lIFBvc2l0aW9uIGJhc2VkIG9uIEZvcm1hdGlvbgogICAgICAgICAgICB0aGlzLl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocGxheWVyKTsKCiAgICAgICAgICAgIC8vIEVuZW15IGluZGljYXRvcjogcmVkIGFycm93cyBvdmVyIHRoZSBBd2F5IHRlYW0gKHNvIGVuZW1pZXMgYXJlIHJlYWRhYmxlKQovLyBFbmVteSBpbmRpY2F0b3I6IHJlZCBhcnJvd3Mgb3ZlciB0aGUgQXdheSB0ZWFtCiAgICAgICAgICAgIGlmICh0aGlzLmlkID09PSAnYXdheScgJiYgcGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFycm93ID0gbmV3IFRIUkVFLlNwcml0ZShfZW5lbXlBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIGFycm93LnNjYWxlLnNldCgwLjgsIDAuOCwgMS4wKTsKICAgICAgICAgICAgICAgIGFycm93LnBvc2l0aW9uLnNldCgwLCAzLjIsIDApOyAvLyBhYm92ZSBoZWFkCiAgICAgICAgICAgICAgICBhcnJvdy5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLmFkZChhcnJvdyk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuZW5lbXlBcnJvdyA9IGFycm93OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUZWFtbWF0ZSBpbmRpY2F0b3I6IFdoaXRlIGFycm93cyBmb3IgaW5hY3RpdmUgaHVtYW5zCiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4gJiYgcGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFycm93ID0gbmV3IFRIUkVFLlNwcml0ZShfdGVhbW1hdGVBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIGFycm93LnNjYWxlLnNldCgwLjYsIDAuNiwgMS4wKTsKICAgICAgICAgICAgICAgIGFycm93LnBvc2l0aW9uLnNldCgwLCAzLjIsIDApOwogICAgICAgICAgICAgICAgYXJyb3cucmVuZGVyT3JkZXIgPSA5OTk7CiAgICAgICAgICAgICAgICBhcnJvdy52aXNpYmxlID0gZmFsc2U7IC8vIEhpZGRlbiBieSBkZWZhdWx0LCBtYW5hZ2VkIGJ5IHNldEFjdGl2ZVBsYXllcgogICAgICAgICAgICAgICAgcGxheWVyLm1lc2guYWRkKGFycm93KTsKICAgICAgICAgICAgICAgIHBsYXllci50ZWFtbWF0ZUFycm93ID0gYXJyb3c7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNldEZvcm1hdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGlmICghRk9STUFUSU9OU1tuYW1lXSkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRGb3JtYXRpb24gPSBuYW1lOwogICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgVGVhbSAke3RoaXMuaWR9IHN3aXRjaGVkIHRvICR7bmFtZX1gKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGxheWVySG9tZVBvc2l0aW9uKHApOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfdXBkYXRlUGxheWVySG9tZVBvc2l0aW9uKHBsYXllcikgewogICAgICAgICAgICBjb25zdCBkYXRhID0gRk9STUFUSU9OU1t0aGlzLmN1cnJlbnRGb3JtYXRpb25dOwogICAgICAgICAgICBpZiAoIWRhdGEpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGRhdGFbcGxheWVyLnJvbGVdOwogICAgICAgICAgICBpZiAob2Zmc2V0KSB7CiAgICAgICAgICAgICAgICAvLyBYIFBvc2l0aW9uOgogICAgICAgICAgICAgICAgLy8gRm9ybWF0aW9uczogLVggaXMgTGVmdCwgK1ggaXMgUmlnaHQuCiAgICAgICAgICAgICAgICAvLyBIb21lIFRlYW0gKFNpZGUgMSkgZmFjZXMgLVouIExlZnQgaXMgLVguIFVzZSBvZmZzZXQueCBhcyBpcy4KICAgICAgICAgICAgICAgIGxldCB4UG9zID0gb2Zmc2V0Lng7CiAgICAgICAgICAgICAgICBsZXQgelBvcyA9IG9mZnNldC56ICogdGhpcy5zaWRlOwoKICAgICAgICAgICAgICAgIHBsYXllci5ob21lUG9zaXRpb24uc2V0KHhQb3MsIDAsIHpQb3MpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBd2F5IFRlYW0gKFNpZGUgLTEpIGZhY2VzICtaLiBMZWZ0IGlzICtYLiBGbGlwIFguCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaWRlID09PSAtMSkgewogICAgICAgICAgICAgICAgICAgIHBsYXllci5ob21lUG9zaXRpb24ueCAqPSAtMTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldCBpbml0aWFsIHBvc2l0aW9uCiAgICAgICAgICAgIGlmIChwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgcGxheWVyLm1lc2gucG9zaXRpb24uY29weShwbGF5ZXIuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyICgwLDAsMCkKICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucGxheWVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMucGxheWVyc1tpXS51cGRhdGVQaHlzaWNzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJzW2ldLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayBpZiBub3Qgc3BsaXQgeWV0CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJzW2ldLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbikgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVBY3RpdmVQbGF5ZXJTZWxlY3Rpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucGxheWVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMucGxheWVyc1tpXS51cGRhdGVWaXN1YWxzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJzW2ldLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVBY3RpdmVQbGF5ZXJTZWxlY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKCFiYWxsKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBPRkZFTlNFOiBJZiB3ZSBoYXZlIHRoZSBiYWxsLCBhY3RpdmUgcGxheWVyIGlzIHRoZSBob2xkZXIKICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVBsYXllciAhPT0gYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihiYWxsLmhvbGRlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIERFRkVOU0U6IFNlbGVjdCBjbG9zZXN0IHRvIGJhbGwKICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBPbmx5IGNoZWNrIGV2ZXJ5IGZldyBmcmFtZXMgb3IgaWYgZGlzdGFuY2UgaXMgc2lnbmlmaWNhbnQKICAgICAgICAgICAgbGV0IGNsb3Nlc3QgPSBudWxsOwogICAgICAgICAgICBsZXQgbWluRHN0ID0gSW5maW5pdHk7CgogICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocC5yb2xlID09PSAnR0wnKSBjb250aW51ZTsgLy8gRG9uJ3QgYXV0by1zd2l0Y2ggdG8gZ29hbGllIHVzdWFsbHkKICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICBjb25zdCBkID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkIDwgbWluRHN0KSB7CiAgICAgICAgICAgICAgICAgICAgbWluRHN0ID0gZDsKICAgICAgICAgICAgICAgICAgICBjbG9zZXN0ID0gcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNsb3Nlc3QgJiYgY2xvc2VzdCAhPT0gdGhpcy5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0QWN0aXZlUGxheWVyKGNsb3Nlc3QpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKc2V0QWN0aXZlUGxheWVyKHBsYXllcikgewogICAgICAgICAgICAvLyBSZXNldCBpbnB1dCBvbiBwcmV2aW91cwogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlUGxheWVyLnNldElucHV0KDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYWN0aXZlUGxheWVyID0gcGxheWVyOwoKICAgICAgICAgICAgLy8gVmlzdWFsIEluZGljYXRvcnMKICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbikgewogICAgICAgICAgICAgICAgLy8gMS4gR3JlZW4gQXJyb3cgZm9yIEFjdGl2ZQogICAgICAgICAgICAgICAgaWYgKHRoaXMucGxheWVyQXJyb3cgJiYgcGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5hZGQodGhpcy5wbGF5ZXJBcnJvdyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJBcnJvdy5wb3NpdGlvbi5zZXQoMCwgMy41LCAwKTsgLy8gRmxvYXQgYWJvdmUgaGVhZAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDIuIFdoaXRlIEFycm93cyBmb3IgT3RoZXJzCiAgICAgICAgICAgICAgICB0aGlzLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAocC50ZWFtbWF0ZUFycm93KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAudGVhbW1hdGVBcnJvdy52aXNpYmxlID0gKHAgIT09IHBsYXllcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpyZXNldFBvc2l0aW9ucygpIHsKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHRoaXMucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5jb3B5KHAuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBQaHlzaWNzCiAgICAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgcC5pbnB1dFZlY3Rvci5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgcC5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBwLmlzVGhyb3dpbmcgPSBmYWxzZTsKcC5sb3NlQmFsbCgpOyAvLyBEcm9wIGJhbGwgaWYgaG9sZGluZwogICAgICAgICAgICAgICAgICAgIHAuY2FuQ2F0Y2ggPSB0cnVlOyAvLyBGb3JjZSByZXNldCBjYXBhYmlsaXR5CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgU3RhdHMKICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgICAgICAgICAgCi8vIE9yaWVudGF0aW9uOiBGYWNlIENlbnRlcgogICAgICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuc3luY1JvdGF0aW9uKSBwLnN5bmNSb3RhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IEFuaW1hdGlvbgogICAgICAgICAgICAgICAgICAgIHAucGxheSgnaWRsZScsIDAuMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUmVzZXQgYWN0aXZlIHBsYXllciB0byBNRgogICAgICAgICAgICBjb25zdCBtZiA9IHRoaXMucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgaWYgKG1mKSB0aGlzLnNldEFjdGl2ZVBsYXllcihtZik7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LlRlYW0gPSBUZWFtOwp9KSgpOw==","/Team.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIEZvcm1hdGlvbiBEZWZpbml0aW9ucyAoQ29vcmRpbmF0ZXMgZm9yIFNpZGUgMTogRGVmZW5kcyArWiwgQXR0YWNrcyAtWikKICAgIC8vIFg6IExlZnQoLSkvUmlnaHQoKyksIFo6IEZvcndhcmQoLSkvQmFjaygrKQogICAgY29uc3QgRk9STUFUSU9OUyA9IHsKICAgICAgICAnTm9ybWFsJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiA1IH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTEwLCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxMCwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdDZW50ZXIgQXR0YWNrJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDE1IH0sICdSRCc6IHsgeDogOCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAwIH0sCiAgICAgICAgICAgICdMRic6IHsgeDogLTQsIHo6IC0xNSB9LCAnUkYnOiB7IHg6IDQsIHo6IC0xNSB9CiAgICAgICAgfSwKICAgICAgICAnUmlnaHQgU2lkZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IDAsIHo6IDE1IH0sICdSRCc6IHsgeDogMTIsIHo6IDE1IH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiA1LCB6OiAtMTAgfSwgJ1JGJzogeyB4OiAxNSwgejogLTEwIH0KICAgICAgICB9LAogICAgICAgICdMZWZ0IFNpZGUnOiB7CiAgICAgICAgICAgICdHTCc6IHsgeDogMCwgejogMjUgfSwKICAgICAgICAgICAgJ0xEJzogeyB4OiAtMTIsIHo6IDE1IH0sICdSRCc6IHsgeDogMCwgejogMTUgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAtMTAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTUsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IC01LCB6OiAtMTAgfQogICAgICAgIH0sCiAgICAgICAgJ0FsbC1PdXQgRGVmZW5zZSc6IHsKICAgICAgICAgICAgJ0dMJzogeyB4OiAwLCB6OiAyNSB9LAogICAgICAgICAgICAnTEQnOiB7IHg6IC02LCB6OiAyMCB9LCAnUkQnOiB7IHg6IDYsIHo6IDIwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMTAgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTAsIHo6IDUgfSwgJ1JGJzogeyB4OiAxMCwgejogNSB9CiAgICAgICAgfSwKICAgICAgICAnRmxhdCBMaW5lJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDAgfSwgJ1JEJzogeyB4OiA4LCB6OiAwIH0sCiAgICAgICAgICAgICdNRic6IHsgeDogMCwgejogMCB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xNSwgejogMCB9LCAnUkYnOiB7IHg6IDE1LCB6OiAwIH0KICAgICAgICB9LAogICAgICAgICdDb3VudGVyJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTgsIHo6IDIwIH0sICdSRCc6IHsgeDogOCwgejogMjAgfSwKICAgICAgICAgICAgJ01GJzogeyB4OiAwLCB6OiAxNSB9LAogICAgICAgICAgICAnTEYnOiB7IHg6IC0xMiwgejogLTIwIH0sICdSRic6IHsgeDogMTIsIHo6IC0yMCB9CiAgICAgICAgfSwKICAgICAgICAnRG91YmxlIFNpZGVzJzogewogICAgICAgICAgICAnR0wnOiB7IHg6IDAsIHo6IDI1IH0sCiAgICAgICAgICAgICdMRCc6IHsgeDogLTE4LCB6OiAxNSB9LCAnUkQnOiB7IHg6IDE4LCB6OiAxNSB9LAogICAgICAgICAgICAnTUYnOiB7IHg6IDAsIHo6IDUgfSwKICAgICAgICAgICAgJ0xGJzogeyB4OiAtMTgsIHo6IC0xMCB9LCAnUkYnOiB7IHg6IDE4LCB6OiAtMTAgfQogICAgICAgIH0KICAgIH07CgoKCiAgICAvLyAtLS0gRW5lbXkgSW5kaWNhdG9yIChSZWQgQXJyb3cgU3ByaXRlKSAtLS0KICAgIC8vIFNoYXJlZCB0ZXh0dXJlL21hdGVyaWFsIHNvIHdlIGRvbid0IGNyZWF0ZSA2IGNhbnZhc2VzLgpjb25zdCBfZW5lbXlBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7CiAgICAgICAgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBjLndpZHRoLCBjLmhlaWdodCk7CiAgICAgICAgCiAgICAgICAgLy8gQXJyb3cgcG9pbnRpbmcgRE9XTgogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDYsIDEyKTsgICAKICAgICAgICBjdHgubGluZVRvKDU4LCAxMik7ICAKICAgICAgICBjdHgubGluZVRvKDMyLCA1Mik7ICAKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmYwMDAwJzsKICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIGN0eC5saW5lV2lkdGggPSA0OwogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpJzsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCmNvbnN0IF9wbGF5ZXJBcnJvd1RleHR1cmUgPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgYy53aWR0aCwgYy5oZWlnaHQpOwogICAgICAgIAogICAgICAgIC8vIEFycm93IHBvaW50aW5nIERPV04KICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyg2LCAxMik7ICAgCiAgICAgICAgY3R4LmxpbmVUbyg1OCwgMTIpOyAgCiAgICAgICAgY3R4LmxpbmVUbygzMiwgNTIpOyAgCiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwZmYwMCc7IC8vIEdyZWVuCiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsMjU1LDI1NSwwLjk1KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGMud2lkdGgsIGMuaGVpZ2h0KTsKICAgICAgICAKICAgICAgICAvLyBBcnJvdyBwb2ludGluZyBET1dOCiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oNiwgMTIpOyAgIAogICAgICAgIGN0eC5saW5lVG8oNTgsIDEyKTsgIAogICAgICAgIGN0eC5saW5lVG8oMzIsIDUyKTsgIAogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOyAvLyBXaGl0ZQogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDQ7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgY29uc3QgX2VuZW15QXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX2VuZW15QXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CiAgICBjb25zdCBfcGxheWVyQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3BsYXllckFycm93VGV4dHVyZSwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoVGVzdDogZmFsc2UsIGRlcHRoV3JpdGU6IGZhbHNlIH0pOwogICAgY29uc3QgX3RlYW1tYXRlQXJyb3dNYXRlcmlhbCA9IG5ldyBUSFJFRS5TcHJpdGVNYXRlcmlhbCh7IG1hcDogX3RlYW1tYXRlQXJyb3dUZXh0dXJlLCB0cmFuc3BhcmVudDogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UgfSk7CmNsYXNzIFRlYW0gewogICAgICAgIC8qKgogICAgICAgICAqIEdlbmVyYXRlcyBhbmQgYXBwbGllcyBzdGF0cyB0byBhIHBsYXllciBiYXNlZCBvbiByb2xlIGFuZCBsZXZlbC4KICAgICAgICAgKiBDZW50cmFsaXplcyBiYWxhbmNpbmcgdG8gZW5zdXJlIGhpZ2gtbGV2ZWwgcGxheSBmZWVscyBkaXN0aW5jdC4KICAgICAgICAgKi8KICAgICAgICBzdGF0aWMgZ2VuZXJhdGVTdGF0cyhwbGF5ZXIsIHJvbGUsIGxldmVsID0gMSwgaXNIdW1hbiA9IGZhbHNlKSB7CiAgICAgICAgICAgIC8vIDEuIERlZmluZSBSb2xlIEJhc2VsaW5lcyAoTGV2ZWwgMSkKICAgICAgICAgICAgLy8gQmFsYW5jZWQgdG8gYmUgd2VhayBidXQgZnVuY3Rpb25hbCBhdCBMZXZlbCAxCiAgICAgICAgICAgIGNvbnN0IGJhc2UgPSB7CiAgICAgICAgICAgICAgICBIUDogMTAwLCBTUDogNTUsIEVOOiAxMCwgQVQ6IDUsIFBBOiA1LCBCTDogNSwgU0g6IDUsIENBOiA1CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBSb2xlIFNwZWNpYWxpemF0aW9ucwogICAgICAgICAgICBzd2l0Y2gocm9sZSkgewogICAgICAgICAgICAgICAgY2FzZSAnTEYnOiBjYXNlICdSRic6IC8vIFN0cmlrZXJzCiAgICAgICAgICAgICAgICAgICAgYmFzZS5TSCArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLkVOICs9IDU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdNRic6IC8vIFBsYXltYWtlcnMKICAgICAgICAgICAgICAgICAgICBiYXNlLlBBICs9IDEwOyBiYXNlLkFUICs9IDg7IGJhc2UuRU4gKz0gODsgYmFzZS5TUCArPSAyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnTEQnOiBjYXNlICdSRCc6IC8vIERlZmVuZGVycwogICAgICAgICAgICAgICAgICAgIGJhc2UuQVQgKz0gMTI7IGJhc2UuQkwgKz0gMTA7IGJhc2UuUEEgKz0gNTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogLy8gR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFzZS5DQSArPSAxMDsgYmFzZS5TUCArPSA1OyBiYXNlLlBBICs9IDE1OyAvLyBTdHJvbmcgYXJtCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIFNjYWxpbmcgRmFjdG9ycyAoUGVyIExldmVsKQogICAgICAgICAgICAvLyBEZXNpZ25lZCBzbyBMZXZlbCA1MCBpcyAiR29kIFRpZXIiIGFuZCBMZXZlbCAxIGlzICJSb29raWUiCiAgICAgICAgICAgIGNvbnN0IGdyb3d0aCA9IHsKICAgICAgICAgICAgICAgIEhQOiAxNSwgICAgLy8gKzE1MDAgSFAgYXQgTHZsIDk5CiAgICAgICAgICAgICAgICBTUDogMC41LCAgIC8vICs1MCBTUCBhdCBMdmwgOTkgKFNwZWVkIGRlbW9uKQogICAgICAgICAgICAgICAgUHJpbWFyeTogMC44LCAvLyArODAgU3RhdCBhdCBMdmwgOTkKICAgICAgICAgICAgICAgIFNlY29uZGFyeTogMC41IC8vICs1MCBTdGF0IGF0IEx2bCA5OQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIHNjYWxlCiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gKHZhbCwgcmF0ZSkgPT4gTWF0aC5mbG9vcih2YWwgKyAoKGxldmVsIC0gMSkgKiByYXRlKSk7CgogICAgICAgICAgICAvLyBBcHBseSBTY2FsaW5nCiAgICAgICAgICAgIHBsYXllci5zdGF0cy5IUCA9IHNjYWxlKGJhc2UuSFAsIGdyb3d0aC5IUCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTUDogQ2FwIGF0IDk5LCBidXQgZW5zdXJlIGhpZ2ggbGV2ZWxzIGZlZWwgRkFTVAogICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU1AgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TUCwgZ3Jvd3RoLlNQKSk7CgogICAgICAgICAgICAvLyBTdGF0IGRpc3RyaWJ1dGlvbiBiYXNlZCBvbiByb2xlIHByaW9yaXRpZXMKICAgICAgICAgICAgaWYgKFsnTEYnLCAnUkYnXS5pbmNsdWRlcyhyb2xlKSkgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlNIID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuU0gsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5FTiwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguU2Vjb25kYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb2xlID09PSAnTUYnKSB7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlByaW1hcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuU0ggPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5TSCwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChbJ0xEJywgJ1JEJ10uaW5jbHVkZXMocm9sZSkpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5BVCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkFULCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkJMID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuQkwsIGdyb3d0aC5QcmltYXJ5KSk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuUEEgPSBNYXRoLm1pbig5OSwgc2NhbGUoYmFzZS5QQSwgZ3Jvd3RoLlNlY29uZGFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkVOID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuRU4sIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjIpKTsgLy8gRGVmZW5kZXJzIGJhZCBhdCBzaG9vdGluZwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGUgPT09ICdHTCcpIHsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5DQSA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLkNBLCBncm93dGguUHJpbWFyeSkpOwogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLlBBID0gTWF0aC5taW4oOTksIHNjYWxlKGJhc2UuUEEsIGdyb3d0aC5TZWNvbmRhcnkpKTsKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TSCA9IE1hdGgubWluKDk5LCBzY2FsZShiYXNlLlNILCAwLjMpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gSHVtYW4gUGxheWVyIEJvbnVzIChUaGUgIkhlcm8iIEZlZWwpCiAgICAgICAgICAgIC8vIEdpdmVzIHRoZSBwbGF5ZXIgYSBzbGlnaHQgZWRnZSB0byBtYWtlIGdhbWVwbGF5IGZlZWwgcHVuY2h5Ci8vIDMuIEh1bWFuIFBsYXllciBCb251cyAoVGhlICJIZXJvIiBGZWVsKQogICAgICAgICAgICAvLyBHaXZlcyB0aGUgcGxheWVyIGEgc2xpZ2h0IGVkZ2UgdG8gbWFrZSBnYW1lcGxheSBmZWVsIHB1bmNoeQogICAgICAgICAgICBpZiAoaXNIdW1hbikgewogICAgICAgICAgICAgICAgcGxheWVyLnN0YXRzLkhQICs9IDMwMDsgLy8gVGFua2llciAod2FzIDE1MCkKICAgICAgICAgICAgICAgIHBsYXllci5zdGF0cy5TUCArPSA4OyAgIC8vIEZhc3RlciAod2FzIDUpCiAgICAgICAgICAgICAgICBwbGF5ZXIuc3RhdHMuRU4gKz0gMTA7ICAgLy8gSGFyZGVyIHRvIHRhY2tsZSAod2FzIDUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEtleSBTdGF0IEJvb3N0CiAgICAgICAgICAgICAgICBpZiAocm9sZSA9PT0gJ0xGJyB8fCByb2xlID09PSAnUkYnKSBwbGF5ZXIuc3RhdHMuU0ggKz0gNTsKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnTUYnKSBwbGF5ZXIuc3RhdHMuUEEgKz0gNTsKICAgICAgICAgICAgICAgIGlmIChyb2xlID09PSAnTEQnIHx8IHJvbGUgPT09ICdSRCcpIHBsYXllci5zdGF0cy5BVCArPSA1OwogICAgICAgICAgICAgICAgaWYgKHJvbGUgPT09ICdHTCcpIHBsYXllci5zdGF0cy5DQSArPSA1OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA0LiBGaW5hbGl6ZQogICAgICAgICAgICBwbGF5ZXIuc3RhdHMubWF4SFAgPSBwbGF5ZXIuc3RhdHMuSFA7CiAgICAgICAgICAgIHBsYXllci5sZXZlbCA9IGxldmVsOwogICAgICAgICAgICBwbGF5ZXIuX3VwZGF0ZURlcml2ZWRTdGF0cygpOwogICAgICAgIH0KCmNvbnN0cnVjdG9yKHNjZW5lLCBpZCwgc2lkZSwgY29sb3IsIGlzSHVtYW4pIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLmlkID0gaWQ7IC8vICdob21lJyBvciAnYXdheScKICAgICAgICAgICAgdGhpcy5zaWRlID0gc2lkZTsgLy8gMSAoRGVmZW5kcyArWikgb3IgLTEgKERlZmVuZHMgLVopCiAgICAgICAgICAgIHRoaXMuY29sb3IgPSBjb2xvcjsKICAgICAgICAgICAgdGhpcy5pc0h1bWFuID0gaXNIdW1hbjsKICAgICAgICAgICAgdGhpcy5haUVuYWJsZWQgPSB0cnVlOyAvLyBNYXN0ZXIgc3dpdGNoIGZvciBBSSBsb2dpYwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzID0gW107CiAgICAgICAgICAgIHRoaXMuYWN0aXZlUGxheWVyID0gbnVsbDsgLy8gVGhlIHBsYXllciBjdXJyZW50bHkgY29udHJvbGxlZC9mb2N1c2VkCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGb3JtYXRpb24gQW5jaG9ycwogICAgICAgICAgICB0aGlzLmN1cnJlbnRGb3JtYXRpb24gPSAnTm9ybWFsJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBsYXllciBJbmRpY2F0b3IgKEdyZWVuIEFycm93KQogICAgICAgICAgICBpZiAodGhpcy5pc0h1bWFuKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXllckFycm93ID0gbmV3IFRIUkVFLlNwcml0ZShfcGxheWVyQXJyb3dNYXRlcmlhbCk7CiAgICAgICAgICAgICAgICB0aGlzLnBsYXllckFycm93LnNjYWxlLnNldCgwLjgsIDAuOCwgMS4wKTsKICAgICAgICAgICAgICAgIHRoaXMucGxheWVyQXJyb3cucmVuZGVyT3JkZXIgPSAxMDAwOyAvLyBPbiB0b3AKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYXNzaWduTWFya3Mob3Bwb3NpbmdUZWFtKSB7CiAgICAgICAgICAgIC8vIFNpbXBsZSBhdXRvLWFzc2lnbiBsb2dpYzogTWFyayB0aGUgcGxheWVyIGluIHRoZSAibWF0Y2hpbmciIHBvc2l0aW9uCiAgICAgICAgICAgIC8vIExGPC0+UkQsIFJGPC0+TEQsIE1GPC0+TUYsIExEPC0+UkYsIFJEPC0+TEYsIEdMPC0+TEYKICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0Um9sZSA9ICdNRic7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHAucm9sZSkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgJ0xGJzogdGFyZ2V0Um9sZSA9ICdSRCc7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ1JGJzogdGFyZ2V0Um9sZSA9ICdMRCc7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ01GJzogdGFyZ2V0Um9sZSA9ICdNRic7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ0xEJzogdGFyZ2V0Um9sZSA9ICdSRic7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ1JEJzogdGFyZ2V0Um9sZSA9ICdMRic7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ0dMJzogdGFyZ2V0Um9sZSA9ICdMRic7IGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IG9wcG9zaW5nVGVhbS5wbGF5ZXJzLmZpbmQob3AgPT4gb3Aucm9sZSA9PT0gdGFyZ2V0Um9sZSk7CiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICAgICAgICAgICAgcC5tYXJraW5nID0gdGFyZ2V0OwogICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGAke3RoaXMuaWR9ICR7cC5yb2xlfSBtYXJrZWQgJHt0YXJnZXQucm9sZX1gKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBhZGRQbGF5ZXIocGxheWVyKSB7CiAgICAgICAgICAgIHRoaXMucGxheWVycy5wdXNoKHBsYXllcik7CiAgICAgICAgICAgIHBsYXllci50ZWFtID0gdGhpczsKCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBIb21lIFBvc2l0aW9uIGJhc2VkIG9uIEZvcm1hdGlvbgogICAgICAgICAgICB0aGlzLl91cGRhdGVQbGF5ZXJIb21lUG9zaXRpb24ocGxheWVyKTsKCiAgICAgICAgICAgIC8vIEVuZW15IGluZGljYXRvcjogcmVkIGFycm93cyBvdmVyIHRoZSBBd2F5IHRlYW0gKHNvIGVuZW1pZXMgYXJlIHJlYWRhYmxlKQovLyBFbmVteSBpbmRpY2F0b3I6IHJlZCBhcnJvd3Mgb3ZlciB0aGUgQXdheSB0ZWFtCiAgICAgICAgICAgIGlmICh0aGlzLmlkID09PSAnYXdheScgJiYgcGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFycm93ID0gbmV3IFRIUkVFLlNwcml0ZShfZW5lbXlBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIGFycm93LnNjYWxlLnNldCgwLjgsIDAuOCwgMS4wKTsKICAgICAgICAgICAgICAgIGFycm93LnBvc2l0aW9uLnNldCgwLCAzLjIsIDApOyAvLyBhYm92ZSBoZWFkCiAgICAgICAgICAgICAgICBhcnJvdy5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLmFkZChhcnJvdyk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuZW5lbXlBcnJvdyA9IGFycm93OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUZWFtbWF0ZSBpbmRpY2F0b3I6IFdoaXRlIGFycm93cyBmb3IgaW5hY3RpdmUgaHVtYW5zCiAgICAgICAgICAgIGlmICh0aGlzLmlzSHVtYW4gJiYgcGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFycm93ID0gbmV3IFRIUkVFLlNwcml0ZShfdGVhbW1hdGVBcnJvd01hdGVyaWFsKTsKICAgICAgICAgICAgICAgIGFycm93LnNjYWxlLnNldCgwLjYsIDAuNiwgMS4wKTsKICAgICAgICAgICAgICAgIGFycm93LnBvc2l0aW9uLnNldCgwLCAzLjIsIDApOwogICAgICAgICAgICAgICAgYXJyb3cucmVuZGVyT3JkZXIgPSA5OTk7CiAgICAgICAgICAgICAgICBhcnJvdy52aXNpYmxlID0gZmFsc2U7IC8vIEhpZGRlbiBieSBkZWZhdWx0LCBtYW5hZ2VkIGJ5IHNldEFjdGl2ZVBsYXllcgogICAgICAgICAgICAgICAgcGxheWVyLm1lc2guYWRkKGFycm93KTsKICAgICAgICAgICAgICAgIHBsYXllci50ZWFtbWF0ZUFycm93ID0gYXJyb3c7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNldEZvcm1hdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGlmICghRk9STUFUSU9OU1tuYW1lXSkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRGb3JtYXRpb24gPSBuYW1lOwogICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgVGVhbSAke3RoaXMuaWR9IHN3aXRjaGVkIHRvICR7bmFtZX1gKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGxheWVySG9tZVBvc2l0aW9uKHApOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgpfdXBkYXRlUGxheWVySG9tZVBvc2l0aW9uKHBsYXllcikgewogICAgICAgICAgICBjb25zdCBkYXRhID0gRk9STUFUSU9OU1t0aGlzLmN1cnJlbnRGb3JtYXRpb25dOwogICAgICAgICAgICBpZiAoIWRhdGEpIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGRhdGFbcGxheWVyLnJvbGVdOwogICAgICAgICAgICBpZiAob2Zmc2V0KSB7CiAgICAgICAgICAgICAgICAvLyBYIFBvc2l0aW9uOgogICAgICAgICAgICAgICAgLy8gRm9ybWF0aW9uczogLVggaXMgTGVmdCwgK1ggaXMgUmlnaHQuCiAgICAgICAgICAgICAgICAvLyBIb21lIFRlYW0gKFNpZGUgMSkgZmFjZXMgLVouIExlZnQgaXMgLVguIFVzZSBvZmZzZXQueCBhcyBpcy4KICAgICAgICAgICAgICAgIGxldCB4UG9zID0gb2Zmc2V0Lng7CiAgICAgICAgICAgICAgICBsZXQgelBvcyA9IG9mZnNldC56ICogdGhpcy5zaWRlOwoKICAgICAgICAgICAgICAgIHBsYXllci5ob21lUG9zaXRpb24uc2V0KHhQb3MsIDAsIHpQb3MpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBd2F5IFRlYW0gKFNpZGUgLTEpIGZhY2VzICtaLiBMZWZ0IGlzICtYLiBGbGlwIFguCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaWRlID09PSAtMSkgewogICAgICAgICAgICAgICAgICAgIHBsYXllci5ob21lUG9zaXRpb24ueCAqPSAtMTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldCBpbml0aWFsIHBvc2l0aW9uCiAgICAgICAgICAgIGlmIChwbGF5ZXIubWVzaCkgewogICAgICAgICAgICAgICAgcGxheWVyLm1lc2gucG9zaXRpb24uY29weShwbGF5ZXIuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyICgwLDAsMCkKICAgICAgICAgICAgICAgIHBsYXllci5tZXNoLmxvb2tBdCgwLCAwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucGxheWVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMucGxheWVyc1tpXS51cGRhdGVQaHlzaWNzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJzW2ldLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayBpZiBub3Qgc3BsaXQgeWV0CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJzW2ldLnVwZGF0ZShkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbikgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVBY3RpdmVQbGF5ZXJTZWxlY3Rpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlVmlzdWFscyhkdCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucGxheWVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMucGxheWVyc1tpXS51cGRhdGVWaXN1YWxzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJzW2ldLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVBY3RpdmVQbGF5ZXJTZWxlY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKCFiYWxsKSByZXR1cm47CgogICAgICAgICAgICAvLyAxLiBPRkZFTlNFOiBJZiB3ZSBoYXZlIHRoZSBiYWxsLCBhY3RpdmUgcGxheWVyIGlzIHRoZSBob2xkZXIKICAgICAgICAgICAgaWYgKGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVBsYXllciAhPT0gYmFsbC5ob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVBsYXllcihiYWxsLmhvbGRlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIuIERFRkVOU0U6IFNlbGVjdCBjbG9zZXN0IHRvIGJhbGwKICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBPbmx5IGNoZWNrIGV2ZXJ5IGZldyBmcmFtZXMgb3IgaWYgZGlzdGFuY2UgaXMgc2lnbmlmaWNhbnQKICAgICAgICAgICAgbGV0IGNsb3Nlc3QgPSBudWxsOwogICAgICAgICAgICBsZXQgbWluRHN0ID0gSW5maW5pdHk7CgogICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocC5yb2xlID09PSAnR0wnKSBjb250aW51ZTsgLy8gRG9uJ3QgYXV0by1zd2l0Y2ggdG8gZ29hbGllIHVzdWFsbHkKICAgICAgICAgICAgICAgIGlmICghcC5tZXNoKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICBjb25zdCBkID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8oYmFsbC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmIChkIDwgbWluRHN0KSB7CiAgICAgICAgICAgICAgICAgICAgbWluRHN0ID0gZDsKICAgICAgICAgICAgICAgICAgICBjbG9zZXN0ID0gcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNsb3Nlc3QgJiYgY2xvc2VzdCAhPT0gdGhpcy5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0QWN0aXZlUGxheWVyKGNsb3Nlc3QpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKc2V0QWN0aXZlUGxheWVyKHBsYXllcikgewogICAgICAgICAgICAvLyBSZXNldCBpbnB1dCBvbiBwcmV2aW91cwogICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVQbGF5ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlUGxheWVyLnNldElucHV0KDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYWN0aXZlUGxheWVyID0gcGxheWVyOwoKICAgICAgICAgICAgLy8gVmlzdWFsIEluZGljYXRvcnMKICAgICAgICAgICAgaWYgKHRoaXMuaXNIdW1hbikgewogICAgICAgICAgICAgICAgLy8gMS4gR3JlZW4gQXJyb3cgZm9yIEFjdGl2ZQogICAgICAgICAgICAgICAgaWYgKHRoaXMucGxheWVyQXJyb3cgJiYgcGxheWVyLm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICBwbGF5ZXIubWVzaC5hZGQodGhpcy5wbGF5ZXJBcnJvdyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJBcnJvdy5wb3NpdGlvbi5zZXQoMCwgMy41LCAwKTsgLy8gRmxvYXQgYWJvdmUgaGVhZAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDIuIFdoaXRlIEFycm93cyBmb3IgT3RoZXJzCiAgICAgICAgICAgICAgICB0aGlzLnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAocC50ZWFtbWF0ZUFycm93KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAudGVhbW1hdGVBcnJvdy52aXNpYmxlID0gKHAgIT09IHBsYXllcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpyZXNldFBvc2l0aW9ucygpIHsKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHRoaXMucGxheWVycykgewogICAgICAgICAgICAgICAgaWYgKHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5jb3B5KHAuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBQaHlzaWNzCiAgICAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgcC5pbnB1dFZlY3Rvci5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgcC5pc0Rhc2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBwLmlzVGhyb3dpbmcgPSBmYWxzZTsKcC5sb3NlQmFsbCgpOyAvLyBEcm9wIGJhbGwgaWYgaG9sZGluZwogICAgICAgICAgICAgICAgICAgIHAuY2FuQ2F0Y2ggPSB0cnVlOyAvLyBGb3JjZSByZXNldCBjYXBhYmlsaXR5CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgU3RhdHMKICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuc3RhdHMuRU47CiAgICAgICAgICAgICAgICAgICAgCi8vIE9yaWVudGF0aW9uOiBGYWNlIENlbnRlcgogICAgICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuc3luY1JvdGF0aW9uKSBwLnN5bmNSb3RhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IEFuaW1hdGlvbgogICAgICAgICAgICAgICAgICAgIHAucGxheSgnaWRsZScsIDAuMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUmVzZXQgYWN0aXZlIHBsYXllciB0byBNRgogICAgICAgICAgICBjb25zdCBtZiA9IHRoaXMucGxheWVycy5maW5kKHAgPT4gcC5yb2xlID09PSAnTUYnKTsKICAgICAgICAgICAgaWYgKG1mKSB0aGlzLnNldEFjdGl2ZVBsYXllcihtZik7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LlRlYW0gPSBUZWFtOwp9KSgpOw==","Goalie.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgIAogICAgLy8gUmV1c2FibGUgdmVjdG9ycyB0byBhdm9pZCBHQwpjb25zdCBfZ1ZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ1BvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfYmFsbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZmFjZVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ29hbENlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlY0cgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEdvYWxpZSBleHRlbmRzIHdpbmRvdy5mbHV4LlBsYXllciB7CmNvbnN0cnVjdG9yKHNjZW5lLCByb2xlKSB7CiAgICAgICAgICAgIHN1cGVyKHNjZW5lLCByb2xlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdvYWxpZSBTcGVjaWZpYyBTdGF0cyAoQnVmZmVkIGZvciBQbGF5YWJpbGl0eSkKICAgICAgICAgICAgdGhpcy5zdGF0cy5DQSA9IDMwOyAvLyBDYXRjaAogICAgICAgICAgICB0aGlzLnN0YXRzLlNQID0gNDA7IC8vIFNwZWVkCiAgICAgICAgICAgIHRoaXMuc3RhdHMuRU4gPSA1MDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJVRkZFRDogU3Ryb25nIGFybSBmb3IgY2xlYXJpbmcgdGhlIHpvbmUKICAgICAgICAgICAgdGhpcy5zdGF0cy5QQSA9IDQ1OyAvLyBXYXMgMjAgLSBOb3cgc3Ryb25nIGVub3VnaCB0byByZWFjaCBtaWRmaWVsZAogICAgICAgICAgICB0aGlzLnN0YXRzLlNIID0gMzU7IC8vIFdhcyAxMCAtIERlY2VudCBjbGVhcmFuY2Uga2ljawogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CgogICAgICAgICAgICAvLyBHb2FsIERpbWVuc2lvbnMgKFNhdmUgQm94KSAtIE1hdGNoZXMgR2FtZU1hbmFnZXIgZGV0ZWN0aW9uCiAgICAgICAgICAgIHRoaXMuZ29hbFdpZHRoID0gMjIuMDsgCiAgICAgICAgICAgIHRoaXMuZ29hbEhlaWdodCA9IDE4LjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2F2ZSBNZWNoYW5pY3MKICAgICAgICAgICAgdGhpcy5zYXZlUmFkaXVzID0gNi4wOyAKICAgICAgICAgICAgdGhpcy5wcmVzc3VyZU11bHRpcGxpZXIgPSA1LjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVjaHMKICAgICAgICAgICAgdGhpcy50ZWNocyA9IHsKICAgICAgICAgICAgICAgIGFjdGl2ZTogbnVsbCwgCiAgICAgICAgICAgICAgICBwYXNzaXZlOiBudWxsIAogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQUkgU3RhdGUKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRTYXZlID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN1cGVyIEdvYWxpZSBTdGF0ZQogICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyID0gMDsKCi8vIFBlcmNlcHRpb24gU21vb3RoaW5nIChSZWFjdGlvbiBEZWxheSkKICAgICAgICAgICAgdGhpcy5wZXJjZWl2ZWRCYWxsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5yZWFjdGlvblNwZWVkID0gNC4wOyAvLyBMb3dlciA9IG1vcmUgZGVsYXkvc21vb3RoaW5nCiAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAwOwogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICAvLyAxLiBTdXBlciBHb2FsaWUgVGltZXIKICAgICAgICAgICAgaWYgKHRoaXMuaXNTdXBlckdvYWxpZSkgewogICAgICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3VwZXJHb2FsaWVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1N1cGVyR29hbGllID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDIuIFBvc3Nlc3Npb24gTG9naWMgKEJhbGwgSGVsZCkKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVQcmVzc3VyZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBpc0h1bWFuQ29udHJvbGxlZCA9IHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uaXNIdW1hbiAmJiB0aGlzLnRlYW0uYWN0aXZlUGxheWVyID09PSB0aGlzICYmICFnYW1lLmlzRGVtb01vZGU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChpc0h1bWFuQ29udHJvbGxlZCkgewogICAgICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9haVBvc3Nlc3Npb25Mb2dpYyhkdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIERlZmVuc2UgLyBTYXZlIExvZ2ljIChObyBCYWxsKQogICAgICAgICAgICBpZiAodGhpcy5kYXNoQ29vbGRvd24gPiAwKSB0aGlzLmRhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuY2xhc2hDb29sZG93biA+IDApIHRoaXMuY2xhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCkgdGhpcy5zdHVuVGltZXIgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmltbXVuaXR5VGltZXIgPiAwKSB0aGlzLmltbXVuaXR5VGltZXIgLT0gZHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXNMb2dpYyhkdCk7CgogICAgICAgICAgICBpZiAodGhpcy5zdHVuVGltZXIgPiAwIHx8IHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2NvbnN0cmFpbkJvdW5kcygpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9kZWZlbnNlTG9naWMoZHQpOwogICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXR1c1Zpc3VhbHMoZHQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5taXhlcikgdGhpcy5taXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlSFBCYXIoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlSFBCYXIoKTsKICAgICAgICB9CgpfY29uc3RyYWluQm91bmRzKCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1lc2gucG9zaXRpb247CgogICAgICAgICAgICBjb25zdCBzaWRlID0gdGhpcy50ZWFtID8gdGhpcy50ZWFtLnNpZGUgOiAxOwogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gWCBCb3VuZHMgKFdpZHRoIG9mIHBlbmFsdHkgYXJlYSArLy0gMTBtKSAtPiBJbmNyZWFzZWQgZm9yIG1hc3NpdmUgZ29hbApjb25zdCB4TGltaXQgPSAyMC4wOyAvLyBSZWR1Y2VkIHdpZHRoIG9mIGdvYWxpZSBtb3ZlbWVudAogICAgICAgICAgICBpZiAocG9zLnggPiB4TGltaXQpIHsgcG9zLnggPSB4TGltaXQ7IHRoaXMudmVsb2NpdHkueCA9IDA7IH0KICAgICAgICAgICAgaWYgKHBvcy54IDwgLXhMaW1pdCkgeyBwb3MueCA9IC14TGltaXQ7IHRoaXMudmVsb2NpdHkueCA9IDA7IH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFkgQm91bmRzCiAgICAgICAgICAgIGNvbnN0IHlMaW1pdCA9IDEyLjA7IC8vIFJlZHVjZWQgaGVpZ2h0IGNlaWxpbmcKICAgICAgICAgICAgaWYgKHBvcy55ID4geUxpbWl0KSB7IHBvcy55ID0geUxpbWl0OyB0aGlzLnZlbG9jaXR5LnkgPSAwOyB9CiAgICAgICAgICAgIGlmIChwb3MueSA8IC15TGltaXQpIHsgcG9zLnkgPSAteUxpbWl0OyB0aGlzLnZlbG9jaXR5LnkgPSAwOyB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBaIEJvdW5kcyAoRGVwdGgpCi8vIFogQm91bmRzIChEZXB0aCkKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKICAgICAgICAgICAgaWYgKHNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IGdvYWxEaXN0IC0gMC41KSB7IHBvcy56ID0gZ29hbERpc3QgLSAwLjU7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IDIwLjApIHsgcG9zLnogPSAyMC4wOyB0aGlzLnZlbG9jaXR5LnogPSAwOyB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAtZ29hbERpc3QgKyAwLjUpIHsgcG9zLnogPSAtZ29hbERpc3QgKyAwLjU7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IC0yMC4wKSB7IHBvcy56ID0gLTIwLjA7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgfQogICAgICAgIH0KCi8vIE92ZXJyaWRlIHRocm93QmFsbCB0byBmaXggIndlYWsgdGhyb3ciIGlzc3VlCi8vIE92ZXJyaWRlIHRocm93QmFsbCB0byBmaXggIndlYWsgdGhyb3ciIGlzc3VlIGFuZCByZWR1Y2UgbG9mdAogICAgICAgIHRocm93QmFsbChiYWxsLCBmb3JjZWRUeXBlID0gbnVsbCwgcG93ZXJNdWx0aXBsaWVyID0gMS4wKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gdHJ1ZTsKICAgICAgICAgICAgY29uc3QgdHlwZSA9IGZvcmNlZFR5cGUgfHwgJ1BBJzsKICAgICAgICAgICAgY29uc3QgYm9vc3QgPSAxLjI7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsUG93ZXIgPSBwb3dlck11bHRpcGxpZXIgKiBib29zdDsKCiAgICAgICAgICAgIC8vIEFuaW1hdGlvbgogICAgICAgICAgICBjb25zdCB0aHJvd0tleSA9ICh0eXBlID09PSAnU0gnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfc2hvdCddKSA/ICd0aHJvd19zaG90JyA6ICd0aHJvd19wYXNzJzsKICAgICAgICAgICAgdGhpcy5wbGF5T25lU2hvdCh0aHJvd0tleSwgMC4xLCB7IHRpbWVTY2FsZTogMS4yIH0pOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNMRUFSISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWFjdGlvbiIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgfHwgKGJhbGwgJiYgYmFsbC5ob2xkZXIgPT09IHRoaXMpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIERpcmVjdGlvbgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbmFsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSRURVQ0VEIExPRlQ6IEdvYWxpZSB0aHJvd3MgZmxhdHRlciAoMC4yNSBpbnN0ZWFkIG9mIDAuOCkKICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMjU7IAogICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgU3RhdHMKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdFZhbCA9IHRoaXMuZ2V0U3RhdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IGZpbmFsUG93ZXI7CgogICAgICAgICAgICAgICAgICAgIGJhbGwuc2hvb3QoZmluYWxEaXIsIHN0YXRWYWwsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEV4dHJhIGdyYWNlIHBlcmlvZCBmb3IgR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFsbC5jYXRjaEdyYWNlUGVyaW9kID0gMC42OwoKICAgICAgICAgICAgICAgICAgICB0aGlzLmxvc2VCYWxsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duID0gMS4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAzMDApOyAvLyBXaW5kdXAgdGltZQoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CiAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgfQoKX2RlZmVuc2VMb2dpYyhkdCkgewogICAgICAgICAgICAvLyAwLiBHYW1lIFN0YXRlIENoZWNrCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyAtLS0gUEVSQ0VQVElPTiBVUERBVEUgLS0tCiAgICAgICAgICAgIC8vIFNtb290aGx5IGludGVycG9sYXRlIHBlcmNlaXZlZCBwb3NpdGlvbiB0b3dhcmRzIHJlYWwgYmFsbCBwb3NpdGlvbgogICAgICAgICAgICAvLyBUaGlzIGNyZWF0ZXMgYSBuYXR1cmFsIHJlYWN0aW9uIGRlbGF5IGFuZCBwcmV2ZW50cyBqaXR0ZXJ5IG1pcnJvcmluZwogICAgICAgICAgICB0aGlzLnBlcmNlaXZlZEJhbGxQb3MubGVycChiYWxsLm1lc2gucG9zaXRpb24sIGR0ICogdGhpcy5yZWFjdGlvblNwZWVkKTsKCiAgICAgICAgICAgIC8vIERldGVybWluZSBUaHJlYXQgU291cmNlCiAgICAgICAgICAgIGxldCB0aHJlYXRQb3MgPSBfYmFsbFBvczsKICAgICAgICAgICAgbGV0IGlzVGhyZWF0ID0gZmFsc2U7CmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IG15R29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gZ29hbERpc3QgOiAtZ29hbERpc3Q7CgogICAgICAgICAgICAvLyBDYXNlIEE6IEJhbGwgaXMgSGVsZCAoUHJlLXRocm93KQogICAgICAgICAgICBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2hlbGQnICYmIGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgLy8gVHJhY2sgaG9sZGVyLCBidXQgdXNlIHBlcmNlaXZlZCBwb3NpdGlvbiBpZiB3ZSB3YW50ZWQgdG8gc2ltdWxhdGUgcmVhZGluZyB0aGUgcGxheWVyCiAgICAgICAgICAgICAgICAvLyBGb3Igbm93LCB0cmFja2luZyB0aGUgYmFsbCAod2hpY2ggaXMgb24gdGhlIHBsYXllcikgdmlhIHBlcmNlaXZlZFBvcyBpcyBzdWZmaWNpZW50CiAgICAgICAgICAgICAgICB0aHJlYXRQb3MgPSB0aGlzLnBlcmNlaXZlZEJhbGxQb3M7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGhvbGRlciBpcyBpbiBhdHRhY2tpbmcgaGFsZiBvciBuZWFyIGVub3VnaAogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRocmVhdFBvcy56IC0gbXlHb2FsWik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvR29hbCA8IDQwLjApIHsgLy8gSWYgdGhleSBhcmUgd2l0aGluIDQwbSwgdHJhY2sgdGhlbQogICAgICAgICAgICAgICAgICAgIGlzVGhyZWF0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSAKICAgICAgICAgICAgLy8gQ2FzZSBCOiBCYWxsIGlzIEZyZWUgKFNob3QvUGFzcykKICAgICAgICAgICAgZWxzZSBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICB0aHJlYXRQb3MgPSB0aGlzLnBlcmNlaXZlZEJhbGxQb3M7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERpcmVjdGlvbiBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgbW92aW5nVG93YXJkcyA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSAmJiBiYWxsLnZlbG9jaXR5LnogPiAwKSB8fCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAodGhpcy50ZWFtLnNpZGUgPT09IC0xICYmIGJhbGwudmVsb2NpdHkueiA8IDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQb3NpdGlvbiBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgaW5Gcm9udE9mR29hbCA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSAmJiB0aHJlYXRQb3MueiA8IDQ1LjApIHx8IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLnRlYW0uc2lkZSA9PT0gLTEgJiYgdGhyZWF0UG9zLnogPiAtNDUuMCk7CgogICAgICAgICAgICAgICAgaXNUaHJlYXQgPSBtb3ZpbmdUb3dhcmRzICYmIGluRnJvbnRPZkdvYWw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzVGhyZWF0KSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gUE9TSVRJT05JTkc6IEFOR0xFIENVVFRJTkcgLS0tCiAgICAgICAgICAgICAgICBfYmFsbFBvcy5jb3B5KHRocmVhdFBvcyk7IC8vIFVwZGF0ZSByZWZlcmVuY2UgZm9yIGxvb2tBdAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAxLiBDYWxjdWxhdGUgR29hbCBDZW50ZXIKLy8gMS4gQ2FsY3VsYXRlIEdvYWwgQ2VudGVyIChBZGp1c3RlZCBmb3IgWSBvZmZzZXQpCl9nb2FsQ2VudGVyLnNldCgwLCAtNi4wLCBteUdvYWxaKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMi4gVmVjdG9yIGZyb20gR29hbCB0byBCYWxsCiAgICAgICAgICAgICAgICBfdGVtcFZlY0cuc3ViVmVjdG9ycyhfYmFsbFBvcywgX2dvYWxDZW50ZXIpOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IF90ZW1wVmVjRy5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjRy5ub3JtYWxpemUoKTsgLy8gTm93IGhvbGRzIGRpcmVjdGlvbgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAzLiBEZXRlcm1pbmUgRXh0ZW5zaW9uIChIb3cgZmFyIG91dCB0byBzdGVwKQogICAgICAgICAgICAgICAgLy8gQmFzZTogMS41bSBvZmYgbGluZS4KICAgICAgICAgICAgICAgIC8vIE1heDogNi4wbSBvZmYgbGluZSAoQ3V0dGluZyBhbmdsZSkuCiAgICAgICAgICAgICAgICAvLyBTY2FsZSBiYXNlZCBvbiBiYWxsIHByb3hpbWl0eTogQ2xvc2VyIGJhbGwgPSBNb3JlIGV4dGVuc2lvbiAodG8gYSBwb2ludCkKbGV0IGV4dGVuc2lvbiA9IDEuNTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMzAuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gMS4wIC0gKE1hdGgubWF4KDAsIGRpc3RUb0JhbGwgLSA1LjApIC8gMjUuMCk7IAogICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbiA9IDEuNSArICg0LjUgKiByYXRpbyk7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCi8vIFNhZmV0eTogRG9uJ3QgZ28gcGFzdCB0aGUgYmFsbCAoa2VlcCAxbSBidWZmZXIpCiAgICAgICAgICAgICAgICBleHRlbnNpb24gPSBNYXRoLm1pbihleHRlbnNpb24sIGRpc3RUb0JhbGwgLSAxLjApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyA0LiBDYWxjdWxhdGUgVGFyZ2V0IFBvc2l0aW9uIChCYXNlIEludGVyY2VwdGlvbikKICAgICAgICAgICAgICAgIF9nUG9zLmNvcHkoX2dvYWxDZW50ZXIpLmFkZChfdGVtcFZlY0cubXVsdGlwbHlTY2FsYXIoZXh0ZW5zaW9uKSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDUuIFZlcnRpY2FsIE92ZXJyaWRlIChKdW1wIHRvIG1lZXQgYmFsbCkKICAgICAgICAgICAgICAgIC8vIEV4cGxpY2l0bHkgc2V0IFkgdG8gbWF0Y2ggYmFsbCBoZWlnaHQgaWYgaXQncyBoaWdoCiAgICAgICAgICAgICAgICBpZiAoX2JhbGxQb3MueSA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIF9nUG9zLnkgPSBfYmFsbFBvcy55OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gMC41OyAvLyBEZWZhdWx0IHN0YW5jZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDYuIENsYW1wIHRvIEdvYWwgQm94IERpbWVuc2lvbnMgKExhdGVyYWwvVmVydGljYWwgTGltaXRzKQogICAgICAgICAgICAgICAgLy8gR29hbCBXaWR0aCAyMiAoKy8tIDExKSwgSGVpZ2h0IDE4ICgrLy0gOSkuCiAgICAgICAgICAgICAgICAvLyBBbGxvdyBzbGlnaHRseSBvdXRzaWRlIHBvc3RzIHRvIGNvdmVyIGFuZ2xlcy4KICAgICAgICAgICAgICAgIGNvbnN0IGNsYW1wWCA9IHRoaXMuZ29hbFdpZHRoICogMC42OyAvLyArLy0gMTMuMgpjb25zdCBjbGFtcFkgPSAxMi4wOyAvLyBSZWR1Y2VkIG1heCBqdW1wIGhlaWdodAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfZ1Bvcy54ID0gTWF0aC5tYXgoLWNsYW1wWCwgTWF0aC5taW4oY2xhbXBYLCBfZ1Bvcy54KSk7CiAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gTWF0aC5tYXgoLWNsYW1wWSwgTWF0aC5taW4oY2xhbXBZLCBfZ1Bvcy55KSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDYuIExlYWQgdGhlIGJhbGwgc2xpZ2h0bHkgaWYgaXQgaGFzIGxhdGVyYWwgdmVsb2NpdHkgKEFudGljaXBhdGlvbikKaWYgKGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDEuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFudGljaXBhdGlvbiA9IGJhbGwudmVsb2NpdHkuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigwLjI1KTsgLy8gMC4yNXMgbGVhZAogICAgICAgICAgICAgICAgICAgIGFudGljaXBhdGlvbi56ID0gMDsgLy8gT25seSBsYXRlcmFsIGxlYWQKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy5hZGQoYW50aWNpcGF0aW9uKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAogICAgICAgICAgICBpZiAodGhpcy50ZWFtLnNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIF9nUG9zLnogPSBNYXRoLm1pbihnb2FsRGlzdCAtIDAuNSwgX2dQb3Mueik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfZ1Bvcy56ID0gTWF0aC5tYXgoLWdvYWxEaXN0ICsgMC41LCBfZ1Bvcy56KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE1vdmUgdG93YXJkcyB0YXJnZXQKICAgICAgICAgICAgICAgIGNvbnN0IG1vdmVEaXIgPSBfZ1ZlYy5zdWJWZWN0b3JzKF9nUG9zLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvVGFyZ2V0ID0gbW92ZURpci5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGRpc3RUb1RhcmdldCA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgIG1vdmVEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgLy8gQnVyc3Qgc3BlZWQgZm9yIHNhdmVzIGlmIGJhbGwgaXMgY2xvc2UKICAgICAgICAgICAgICAgICAgICBjb25zdCB1cmdlbmN5ID0gKGRpc3RUb0JhbGwgPCAxMC4wKSA/IDEuNSA6IDEuMDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMubWF4U3BlZWQgKiB1cmdlbmN5OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQobW92ZURpci5tdWx0aXBseVNjYWxhcihzcGVlZCAqIGR0KSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRmFjZSBiYWxsCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdChfYmFsbFBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdzd2ltJykgdGhpcy5wbGF5KCdzd2ltJywgMC4yKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpZGxlJykgdGhpcy5wbGF5KCdpZGxlJywgMC4yKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KF9iYWxsUG9zKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gU0FWRSBNRUNIQU5JQyAtLS0KICAgICAgICAgICAgICAgIC8vIElmIGJhbGwgaXMgd2l0aGluIHJhbmdlLCBhcHBseSBDQSBwcmVzc3VyZQogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHRoaXMuc2F2ZVJhZGl1cykgeyAKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hcHBseVNhdmVQcmVzc3VyZShiYWxsLCBkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gSURMRSAvIFJFVFVSTiBUTyBQT1NUIC0tLQogICAgICAgICAgICAgICAgLy8gUmV0dXJuIHRvIGhvbWUgcG9zaXRpb24gKHVzdWFsbHkgY2VudGVyIG9mIGdvYWwpCiAgICAgICAgICAgICAgICBfZ1Bvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGNvbnN0IG1vdmVEaXIgPSBfZ1ZlYy5zdWJWZWN0b3JzKF9nUG9zLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAobW92ZURpci5sZW5ndGgoKSA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIG1vdmVEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChtb3ZlRGlyLm11bHRpcGx5U2NhbGFyKHRoaXMubWF4U3BlZWQgKiAwLjYgKiBkdCkpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnc3dpbScpIHRoaXMucGxheSgnc3dpbScsIDAuMik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnaWRsZScpIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyIGZpZWxkCiAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlTYXZlUHJlc3N1cmUoYmFsbCwgZHQpIHsKICAgICAgICAgICAgLy8gSWYgR29hbGllIGlzIEFzbGVlcCwgdGhleSBjYW5ub3Qgc2F2ZS4KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKCiAgICAgICAgICAgIC8vIC0tLSBTVVBFUiBHT0FMSUUgVFJJR0dFUiAtLS0KICAgICAgICAgICAgLy8gVHJpZ2dlciBpZjogVGVjaCBlcXVpcHBlZCwgTm90IGFjdGl2ZSwgQmFsbCBoYXMgcG93ZXIsIEJhbGwgaXMgY2xvc2UKICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMuYWN0aXZlID09PSAnc3VwZXJfZ29hbGllJyAmJiAhdGhpcy5pc1N1cGVyR29hbGllICYmIGJhbGwucG93ZXIgPiA1LjApIHsKICAgICAgICAgICAgICAgIC8vIENoYW5jZSB0byB0cmlnZ2VyIChIaWdoIGNoYW5jZSBmb3IgQUksIG9yIGNoZWNrIEhQKQogICAgICAgICAgICAgICAgLy8gQ29zdDogMTAgSFAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQID49IDEwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSAxMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3VwZXJHb2FsaWVUaW1lciA9IDEuNTsgLy8gTGFzdHMgMS41cwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gdXNlZCBTVVBFUiBHT0FMSUUhYCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU1VQRVIgR09BTElFISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInNhdmUiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVHJpZ2dlciBUZWNoY29weSBFdmVudAogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQodGhpcywgJ3N1cGVyX2dvYWxpZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIEVmZmVjdGl2ZSBDQQogICAgICAgICAgICBsZXQgY2EgPSB0aGlzLmdldFN0YXQoJ0NBJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBTdXBlciBHb2FsaWUgQm9udXMgKGUuZy4gKzUwJSArIEZsYXQgMTApCiAgICAgICAgICAgIGlmICh0aGlzLmlzU3VwZXJHb2FsaWUpIHsKICAgICAgICAgICAgICAgIGNhID0gKGNhICogMS41KSArIDEwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBHcmlwIEdsb3ZlcyAoUGFzc2l2ZSkKICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMucGFzc2l2ZSA9PT0gJ2dyaXBfZ2xvdmVzJykgewogICAgICAgICAgICAgICAgY2EgKz0gNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIFByZXNzdXJlCiAgICAgICAgICAgIC8vIFByZXNzdXJlID0gQ0EgKiBkdCAqIE11bHRpcGxpZXIKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSBjYSAqIGR0ICogdGhpcy5wcmVzc3VyZU11bHRpcGxpZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA+IDApIHsKICAgICAgICAgICAgICAgIGJhbGwucG93ZXIgLT0gcHJlc3N1cmU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjawogICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRTYXZlICs9IHByZXNzdXJlOwogICAgICAgICAgICAgICAgLy8gVEhST1RUTEU6IEluY3JlYXNlZCB0aHJlc2hvbGQgdG8gMTIuMAogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FjY3VtdWxhdGVkU2F2ZSA+PSAxMi4wKSB7IAogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZFNhdmUgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBcHBseSBCYWxsIFRlY2huaXF1ZSB0byBHb2FsaWUgKFJpc2sgb2YgY2F0Y2hpbmcgc3BlY2lhbCBzaG90cykKLy8gQXBwbHkgQmFsbCBUZWNobmlxdWUgdG8gR29hbGllIChSaXNrIG9mIGNhdGNoaW5nIHNwZWNpYWwgc2hvdHMpCiAgICAgICAgICAgIGlmIChiYWxsLnRlY2huaXF1ZSAmJiB0aGlzLnRlY2hJbW11bml0eVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICBjb25zdCB0ZWNoID0gYmFsbC50ZWNobmlxdWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZWNoLnR5cGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDE1LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICduYXAnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseVN0YXR1cygnbmFwJywgOC4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGVjaC50eXBlID09PSAnd2l0aGVyJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDE1LjAsICdDQScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayBSZXN1bHQKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCAmJiB0aGlzLnN0YXR1cy5uYXAgPD0gMCkgewogICAgICAgICAgICAgICAgLy8gQ0FUQ0gKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hCYWxsKGJhbGwpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjYXRjaEJhbGwoYmFsbCkgewogICAgICAgICAgICBiYWxsLmdyYWIodGhpcyk7CiAgICAgICAgICAgIHRoaXMucGxheSgnY2F0Y2gnLCAwLjEpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiU0FWRUQgYnkgIiArIHRoaXMucm9sZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFWFAgUkVXQVJEOiBTYXZlCiAgICAgICAgICAgIHRoaXMuZ2FpbkV4cCg1KTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTQVZFRCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KDAuMTUsICdoZWF2eScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgdGhyb3cgdGltZXIKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICB9CgpfYWlQb3NzZXNzaW9uTG9naWMoZHQpIHsKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyICs9IGR0OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSG9sZCBmb3IgYSBtb21lbnQgKDEuNXMpIHRoZW4gdGhyb3cKICAgICAgICAgICAgaWYgKHRoaXMudGhyb3dUaW1lciA+IDEuNSkgewogICAgICAgICAgICAgICAgLy8gRmluZCBiZXN0IHRhcmdldDogUHJlZmVyIE1GIG9yIERlZmVuZGVycywgYnV0IG11c3QgYmUgc29tZXdoYXQgZGlzdGFudCB0byBhdm9pZCAiaGFuZG9mZiIgbG9vawogICAgICAgICAgICAgICAgLy8gRmlsdGVyIGZvciB0ZWFtbWF0ZXMgPiA4IHVuaXRzIGF3YXkgaWYgcG9zc2libGUKICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkTWF0ZXMgPSB0aGlzLnRlYW0ucGxheWVycy5maWx0ZXIocCA9PiAKICAgICAgICAgICAgICAgICAgICBwICE9PSB0aGlzICYmIAogICAgICAgICAgICAgICAgICAgIHAubWVzaCAmJiAKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0aGlzLm1lc2gucG9zaXRpb24pID4gOC4wCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIGxldCB0YXJnZXQgPSBudWxsOwoKICAgICAgICAgICAgICAgIC8vIFByaW9yaXR5IDE6IE1pZGZpZWxkZXIgKFBsYXltYWtlcikKICAgICAgICAgICAgICAgIHRhcmdldCA9IHZhbGlkTWF0ZXMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFByaW9yaXR5IDI6IERlZmVuZGVycwogICAgICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHRhcmdldCA9IHZhbGlkTWF0ZXMuZmluZChwID0+IHAucm9sZSA9PT0gJ0xEJyB8fCBwLnJvbGUgPT09ICdSRCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eSAzOiBBbnlvbmUgb3BlbiAoZmFsbGJhY2sgdG8gY2xvc2UgcmFuZ2UgaWYgbm8gb25lIGlzIGZhcikKICAgICAgICAgICAgICAgIGlmICghdGFyZ2V0KSB0YXJnZXQgPSB0aGlzLnRlYW0ucGxheWVycy5maW5kKHAgPT4gcCAhPT0gdGhpcyAmJiBwLnJvbGUgIT09ICdHTCcpOwoKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0Lm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAvLyBBSU1JTkcgTE9HSUM6IExvZnQgdGhlIHBhc3MKICAgICAgICAgICAgICAgICAgICAvLyBMb29rIGF0IHRhcmdldCwgYnV0IGFpbSBzbGlnaHRseSB1cCB0byBjcmVhdGUgYW4gYXJjCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9zID0gdGFyZ2V0Lm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlzdGFuY2UKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMb2Z0IGZhY3RvcjogVGhlIGZ1cnRoZXIgYXdheSwgdGhlIGhpZ2hlciB3ZSBhaW0KICAgICAgICAgICAgICAgICAgICAvLyAyMCB1bml0cyBhd2F5IC0+IEFpbSA1IHVuaXRzIGFib3ZlIGhlYWQKICAgICAgICAgICAgICAgICAgICBjb25zdCBsb2Z0ID0gTWF0aC5tYXgoMS4wLCBkaXN0ICogMC4yNSk7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnkgKz0gbG9mdDsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdCh0YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFRocm93CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGhyb3dCYWxsKGJhbGwsICdQQScpOyAKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnJvbGV9IHRocm93cyB0byAke3RhcmdldC5yb2xlfSAoRGlzdDogJHtkaXN0LnRvRml4ZWQoMSl9KWApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBDbGVhciBpdCBmb3J3YXJkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdCgwLCA1LCAwKTsgLy8gQWltIHVwLWNlbnRlcgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCAnU0gnKTsgLy8gSGFyZCBjbGVhcgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLnRocm93VGltZXIgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkdvYWxpZSA9IEdvYWxpZTsKfSkoKTs=","./Goalie.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgIAogICAgLy8gUmV1c2FibGUgdmVjdG9ycyB0byBhdm9pZCBHQwpjb25zdCBfZ1ZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ1BvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfYmFsbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZmFjZVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ29hbENlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlY0cgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEdvYWxpZSBleHRlbmRzIHdpbmRvdy5mbHV4LlBsYXllciB7CmNvbnN0cnVjdG9yKHNjZW5lLCByb2xlKSB7CiAgICAgICAgICAgIHN1cGVyKHNjZW5lLCByb2xlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdvYWxpZSBTcGVjaWZpYyBTdGF0cyAoQnVmZmVkIGZvciBQbGF5YWJpbGl0eSkKICAgICAgICAgICAgdGhpcy5zdGF0cy5DQSA9IDMwOyAvLyBDYXRjaAogICAgICAgICAgICB0aGlzLnN0YXRzLlNQID0gNDA7IC8vIFNwZWVkCiAgICAgICAgICAgIHRoaXMuc3RhdHMuRU4gPSA1MDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJVRkZFRDogU3Ryb25nIGFybSBmb3IgY2xlYXJpbmcgdGhlIHpvbmUKICAgICAgICAgICAgdGhpcy5zdGF0cy5QQSA9IDQ1OyAvLyBXYXMgMjAgLSBOb3cgc3Ryb25nIGVub3VnaCB0byByZWFjaCBtaWRmaWVsZAogICAgICAgICAgICB0aGlzLnN0YXRzLlNIID0gMzU7IC8vIFdhcyAxMCAtIERlY2VudCBjbGVhcmFuY2Uga2ljawogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CgogICAgICAgICAgICAvLyBHb2FsIERpbWVuc2lvbnMgKFNhdmUgQm94KSAtIE1hdGNoZXMgR2FtZU1hbmFnZXIgZGV0ZWN0aW9uCiAgICAgICAgICAgIHRoaXMuZ29hbFdpZHRoID0gMjIuMDsgCiAgICAgICAgICAgIHRoaXMuZ29hbEhlaWdodCA9IDE4LjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2F2ZSBNZWNoYW5pY3MKICAgICAgICAgICAgdGhpcy5zYXZlUmFkaXVzID0gNi4wOyAKICAgICAgICAgICAgdGhpcy5wcmVzc3VyZU11bHRpcGxpZXIgPSA1LjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVjaHMKICAgICAgICAgICAgdGhpcy50ZWNocyA9IHsKICAgICAgICAgICAgICAgIGFjdGl2ZTogbnVsbCwgCiAgICAgICAgICAgICAgICBwYXNzaXZlOiBudWxsIAogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQUkgU3RhdGUKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRTYXZlID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN1cGVyIEdvYWxpZSBTdGF0ZQogICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyID0gMDsKCi8vIFBlcmNlcHRpb24gU21vb3RoaW5nIChSZWFjdGlvbiBEZWxheSkKICAgICAgICAgICAgdGhpcy5wZXJjZWl2ZWRCYWxsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5yZWFjdGlvblNwZWVkID0gNC4wOyAvLyBMb3dlciA9IG1vcmUgZGVsYXkvc21vb3RoaW5nCiAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAwOwogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICAvLyAxLiBTdXBlciBHb2FsaWUgVGltZXIKICAgICAgICAgICAgaWYgKHRoaXMuaXNTdXBlckdvYWxpZSkgewogICAgICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3VwZXJHb2FsaWVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1N1cGVyR29hbGllID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDIuIFBvc3Nlc3Npb24gTG9naWMgKEJhbGwgSGVsZCkKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVQcmVzc3VyZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBpc0h1bWFuQ29udHJvbGxlZCA9IHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uaXNIdW1hbiAmJiB0aGlzLnRlYW0uYWN0aXZlUGxheWVyID09PSB0aGlzICYmICFnYW1lLmlzRGVtb01vZGU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChpc0h1bWFuQ29udHJvbGxlZCkgewogICAgICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9haVBvc3Nlc3Npb25Mb2dpYyhkdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIERlZmVuc2UgLyBTYXZlIExvZ2ljIChObyBCYWxsKQogICAgICAgICAgICBpZiAodGhpcy5kYXNoQ29vbGRvd24gPiAwKSB0aGlzLmRhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuY2xhc2hDb29sZG93biA+IDApIHRoaXMuY2xhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCkgdGhpcy5zdHVuVGltZXIgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmltbXVuaXR5VGltZXIgPiAwKSB0aGlzLmltbXVuaXR5VGltZXIgLT0gZHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXNMb2dpYyhkdCk7CgogICAgICAgICAgICBpZiAodGhpcy5zdHVuVGltZXIgPiAwIHx8IHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2NvbnN0cmFpbkJvdW5kcygpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9kZWZlbnNlTG9naWMoZHQpOwogICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXR1c1Zpc3VhbHMoZHQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5taXhlcikgdGhpcy5taXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlSFBCYXIoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlSFBCYXIoKTsKICAgICAgICB9CgpfY29uc3RyYWluQm91bmRzKCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1lc2gucG9zaXRpb247CgogICAgICAgICAgICBjb25zdCBzaWRlID0gdGhpcy50ZWFtID8gdGhpcy50ZWFtLnNpZGUgOiAxOwogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gWCBCb3VuZHMgKFdpZHRoIG9mIHBlbmFsdHkgYXJlYSArLy0gMTBtKSAtPiBJbmNyZWFzZWQgZm9yIG1hc3NpdmUgZ29hbApjb25zdCB4TGltaXQgPSAyMC4wOyAvLyBSZWR1Y2VkIHdpZHRoIG9mIGdvYWxpZSBtb3ZlbWVudAogICAgICAgICAgICBpZiAocG9zLnggPiB4TGltaXQpIHsgcG9zLnggPSB4TGltaXQ7IHRoaXMudmVsb2NpdHkueCA9IDA7IH0KICAgICAgICAgICAgaWYgKHBvcy54IDwgLXhMaW1pdCkgeyBwb3MueCA9IC14TGltaXQ7IHRoaXMudmVsb2NpdHkueCA9IDA7IH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFkgQm91bmRzCiAgICAgICAgICAgIGNvbnN0IHlMaW1pdCA9IDEyLjA7IC8vIFJlZHVjZWQgaGVpZ2h0IGNlaWxpbmcKICAgICAgICAgICAgaWYgKHBvcy55ID4geUxpbWl0KSB7IHBvcy55ID0geUxpbWl0OyB0aGlzLnZlbG9jaXR5LnkgPSAwOyB9CiAgICAgICAgICAgIGlmIChwb3MueSA8IC15TGltaXQpIHsgcG9zLnkgPSAteUxpbWl0OyB0aGlzLnZlbG9jaXR5LnkgPSAwOyB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBaIEJvdW5kcyAoRGVwdGgpCi8vIFogQm91bmRzIChEZXB0aCkKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKICAgICAgICAgICAgaWYgKHNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IGdvYWxEaXN0IC0gMC41KSB7IHBvcy56ID0gZ29hbERpc3QgLSAwLjU7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IDIwLjApIHsgcG9zLnogPSAyMC4wOyB0aGlzLnZlbG9jaXR5LnogPSAwOyB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAtZ29hbERpc3QgKyAwLjUpIHsgcG9zLnogPSAtZ29hbERpc3QgKyAwLjU7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IC0yMC4wKSB7IHBvcy56ID0gLTIwLjA7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgfQogICAgICAgIH0KCi8vIE92ZXJyaWRlIHRocm93QmFsbCB0byBmaXggIndlYWsgdGhyb3ciIGlzc3VlCi8vIE92ZXJyaWRlIHRocm93QmFsbCB0byBmaXggIndlYWsgdGhyb3ciIGlzc3VlIGFuZCByZWR1Y2UgbG9mdAogICAgICAgIHRocm93QmFsbChiYWxsLCBmb3JjZWRUeXBlID0gbnVsbCwgcG93ZXJNdWx0aXBsaWVyID0gMS4wKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gdHJ1ZTsKICAgICAgICAgICAgY29uc3QgdHlwZSA9IGZvcmNlZFR5cGUgfHwgJ1BBJzsKICAgICAgICAgICAgY29uc3QgYm9vc3QgPSAxLjI7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsUG93ZXIgPSBwb3dlck11bHRpcGxpZXIgKiBib29zdDsKCiAgICAgICAgICAgIC8vIEFuaW1hdGlvbgogICAgICAgICAgICBjb25zdCB0aHJvd0tleSA9ICh0eXBlID09PSAnU0gnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfc2hvdCddKSA/ICd0aHJvd19zaG90JyA6ICd0aHJvd19wYXNzJzsKICAgICAgICAgICAgdGhpcy5wbGF5T25lU2hvdCh0aHJvd0tleSwgMC4xLCB7IHRpbWVTY2FsZTogMS4yIH0pOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNMRUFSISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWFjdGlvbiIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgfHwgKGJhbGwgJiYgYmFsbC5ob2xkZXIgPT09IHRoaXMpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIERpcmVjdGlvbgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbmFsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSRURVQ0VEIExPRlQ6IEdvYWxpZSB0aHJvd3MgZmxhdHRlciAoMC4yNSBpbnN0ZWFkIG9mIDAuOCkKICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMjU7IAogICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgU3RhdHMKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdFZhbCA9IHRoaXMuZ2V0U3RhdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IGZpbmFsUG93ZXI7CgogICAgICAgICAgICAgICAgICAgIGJhbGwuc2hvb3QoZmluYWxEaXIsIHN0YXRWYWwsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEV4dHJhIGdyYWNlIHBlcmlvZCBmb3IgR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFsbC5jYXRjaEdyYWNlUGVyaW9kID0gMC42OwoKICAgICAgICAgICAgICAgICAgICB0aGlzLmxvc2VCYWxsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duID0gMS4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAzMDApOyAvLyBXaW5kdXAgdGltZQoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CiAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgfQoKX2RlZmVuc2VMb2dpYyhkdCkgewogICAgICAgICAgICAvLyAwLiBHYW1lIFN0YXRlIENoZWNrCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyAtLS0gUEVSQ0VQVElPTiBVUERBVEUgLS0tCiAgICAgICAgICAgIC8vIFNtb290aGx5IGludGVycG9sYXRlIHBlcmNlaXZlZCBwb3NpdGlvbiB0b3dhcmRzIHJlYWwgYmFsbCBwb3NpdGlvbgogICAgICAgICAgICAvLyBUaGlzIGNyZWF0ZXMgYSBuYXR1cmFsIHJlYWN0aW9uIGRlbGF5IGFuZCBwcmV2ZW50cyBqaXR0ZXJ5IG1pcnJvcmluZwogICAgICAgICAgICB0aGlzLnBlcmNlaXZlZEJhbGxQb3MubGVycChiYWxsLm1lc2gucG9zaXRpb24sIGR0ICogdGhpcy5yZWFjdGlvblNwZWVkKTsKCiAgICAgICAgICAgIC8vIERldGVybWluZSBUaHJlYXQgU291cmNlCiAgICAgICAgICAgIGxldCB0aHJlYXRQb3MgPSBfYmFsbFBvczsKICAgICAgICAgICAgbGV0IGlzVGhyZWF0ID0gZmFsc2U7CmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IG15R29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gZ29hbERpc3QgOiAtZ29hbERpc3Q7CgogICAgICAgICAgICAvLyBDYXNlIEE6IEJhbGwgaXMgSGVsZCAoUHJlLXRocm93KQogICAgICAgICAgICBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2hlbGQnICYmIGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgLy8gVHJhY2sgaG9sZGVyLCBidXQgdXNlIHBlcmNlaXZlZCBwb3NpdGlvbiBpZiB3ZSB3YW50ZWQgdG8gc2ltdWxhdGUgcmVhZGluZyB0aGUgcGxheWVyCiAgICAgICAgICAgICAgICAvLyBGb3Igbm93LCB0cmFja2luZyB0aGUgYmFsbCAod2hpY2ggaXMgb24gdGhlIHBsYXllcikgdmlhIHBlcmNlaXZlZFBvcyBpcyBzdWZmaWNpZW50CiAgICAgICAgICAgICAgICB0aHJlYXRQb3MgPSB0aGlzLnBlcmNlaXZlZEJhbGxQb3M7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGhvbGRlciBpcyBpbiBhdHRhY2tpbmcgaGFsZiBvciBuZWFyIGVub3VnaAogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRocmVhdFBvcy56IC0gbXlHb2FsWik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvR29hbCA8IDQwLjApIHsgLy8gSWYgdGhleSBhcmUgd2l0aGluIDQwbSwgdHJhY2sgdGhlbQogICAgICAgICAgICAgICAgICAgIGlzVGhyZWF0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSAKICAgICAgICAgICAgLy8gQ2FzZSBCOiBCYWxsIGlzIEZyZWUgKFNob3QvUGFzcykKICAgICAgICAgICAgZWxzZSBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICB0aHJlYXRQb3MgPSB0aGlzLnBlcmNlaXZlZEJhbGxQb3M7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERpcmVjdGlvbiBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgbW92aW5nVG93YXJkcyA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSAmJiBiYWxsLnZlbG9jaXR5LnogPiAwKSB8fCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAodGhpcy50ZWFtLnNpZGUgPT09IC0xICYmIGJhbGwudmVsb2NpdHkueiA8IDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQb3NpdGlvbiBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgaW5Gcm9udE9mR29hbCA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSAmJiB0aHJlYXRQb3MueiA8IDQ1LjApIHx8IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLnRlYW0uc2lkZSA9PT0gLTEgJiYgdGhyZWF0UG9zLnogPiAtNDUuMCk7CgogICAgICAgICAgICAgICAgaXNUaHJlYXQgPSBtb3ZpbmdUb3dhcmRzICYmIGluRnJvbnRPZkdvYWw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzVGhyZWF0KSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gUE9TSVRJT05JTkc6IEFOR0xFIENVVFRJTkcgLS0tCiAgICAgICAgICAgICAgICBfYmFsbFBvcy5jb3B5KHRocmVhdFBvcyk7IC8vIFVwZGF0ZSByZWZlcmVuY2UgZm9yIGxvb2tBdAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAxLiBDYWxjdWxhdGUgR29hbCBDZW50ZXIKLy8gMS4gQ2FsY3VsYXRlIEdvYWwgQ2VudGVyIChBZGp1c3RlZCBmb3IgWSBvZmZzZXQpCl9nb2FsQ2VudGVyLnNldCgwLCAtNi4wLCBteUdvYWxaKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMi4gVmVjdG9yIGZyb20gR29hbCB0byBCYWxsCiAgICAgICAgICAgICAgICBfdGVtcFZlY0cuc3ViVmVjdG9ycyhfYmFsbFBvcywgX2dvYWxDZW50ZXIpOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IF90ZW1wVmVjRy5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjRy5ub3JtYWxpemUoKTsgLy8gTm93IGhvbGRzIGRpcmVjdGlvbgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAzLiBEZXRlcm1pbmUgRXh0ZW5zaW9uIChIb3cgZmFyIG91dCB0byBzdGVwKQogICAgICAgICAgICAgICAgLy8gQmFzZTogMS41bSBvZmYgbGluZS4KICAgICAgICAgICAgICAgIC8vIE1heDogNi4wbSBvZmYgbGluZSAoQ3V0dGluZyBhbmdsZSkuCiAgICAgICAgICAgICAgICAvLyBTY2FsZSBiYXNlZCBvbiBiYWxsIHByb3hpbWl0eTogQ2xvc2VyIGJhbGwgPSBNb3JlIGV4dGVuc2lvbiAodG8gYSBwb2ludCkKbGV0IGV4dGVuc2lvbiA9IDEuNTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMzAuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gMS4wIC0gKE1hdGgubWF4KDAsIGRpc3RUb0JhbGwgLSA1LjApIC8gMjUuMCk7IAogICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbiA9IDEuNSArICg0LjUgKiByYXRpbyk7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCi8vIFNhZmV0eTogRG9uJ3QgZ28gcGFzdCB0aGUgYmFsbCAoa2VlcCAxbSBidWZmZXIpCiAgICAgICAgICAgICAgICBleHRlbnNpb24gPSBNYXRoLm1pbihleHRlbnNpb24sIGRpc3RUb0JhbGwgLSAxLjApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyA0LiBDYWxjdWxhdGUgVGFyZ2V0IFBvc2l0aW9uIChCYXNlIEludGVyY2VwdGlvbikKICAgICAgICAgICAgICAgIF9nUG9zLmNvcHkoX2dvYWxDZW50ZXIpLmFkZChfdGVtcFZlY0cubXVsdGlwbHlTY2FsYXIoZXh0ZW5zaW9uKSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDUuIFZlcnRpY2FsIE92ZXJyaWRlIChKdW1wIHRvIG1lZXQgYmFsbCkKICAgICAgICAgICAgICAgIC8vIEV4cGxpY2l0bHkgc2V0IFkgdG8gbWF0Y2ggYmFsbCBoZWlnaHQgaWYgaXQncyBoaWdoCiAgICAgICAgICAgICAgICBpZiAoX2JhbGxQb3MueSA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIF9nUG9zLnkgPSBfYmFsbFBvcy55OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gMC41OyAvLyBEZWZhdWx0IHN0YW5jZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDYuIENsYW1wIHRvIEdvYWwgQm94IERpbWVuc2lvbnMgKExhdGVyYWwvVmVydGljYWwgTGltaXRzKQogICAgICAgICAgICAgICAgLy8gR29hbCBXaWR0aCAyMiAoKy8tIDExKSwgSGVpZ2h0IDE4ICgrLy0gOSkuCiAgICAgICAgICAgICAgICAvLyBBbGxvdyBzbGlnaHRseSBvdXRzaWRlIHBvc3RzIHRvIGNvdmVyIGFuZ2xlcy4KICAgICAgICAgICAgICAgIGNvbnN0IGNsYW1wWCA9IHRoaXMuZ29hbFdpZHRoICogMC42OyAvLyArLy0gMTMuMgpjb25zdCBjbGFtcFkgPSAxMi4wOyAvLyBSZWR1Y2VkIG1heCBqdW1wIGhlaWdodAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfZ1Bvcy54ID0gTWF0aC5tYXgoLWNsYW1wWCwgTWF0aC5taW4oY2xhbXBYLCBfZ1Bvcy54KSk7CiAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gTWF0aC5tYXgoLWNsYW1wWSwgTWF0aC5taW4oY2xhbXBZLCBfZ1Bvcy55KSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDYuIExlYWQgdGhlIGJhbGwgc2xpZ2h0bHkgaWYgaXQgaGFzIGxhdGVyYWwgdmVsb2NpdHkgKEFudGljaXBhdGlvbikKaWYgKGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDEuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFudGljaXBhdGlvbiA9IGJhbGwudmVsb2NpdHkuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigwLjI1KTsgLy8gMC4yNXMgbGVhZAogICAgICAgICAgICAgICAgICAgIGFudGljaXBhdGlvbi56ID0gMDsgLy8gT25seSBsYXRlcmFsIGxlYWQKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy5hZGQoYW50aWNpcGF0aW9uKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAogICAgICAgICAgICBpZiAodGhpcy50ZWFtLnNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIF9nUG9zLnogPSBNYXRoLm1pbihnb2FsRGlzdCAtIDAuNSwgX2dQb3Mueik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfZ1Bvcy56ID0gTWF0aC5tYXgoLWdvYWxEaXN0ICsgMC41LCBfZ1Bvcy56KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE1vdmUgdG93YXJkcyB0YXJnZXQKICAgICAgICAgICAgICAgIGNvbnN0IG1vdmVEaXIgPSBfZ1ZlYy5zdWJWZWN0b3JzKF9nUG9zLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvVGFyZ2V0ID0gbW92ZURpci5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGRpc3RUb1RhcmdldCA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgIG1vdmVEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgLy8gQnVyc3Qgc3BlZWQgZm9yIHNhdmVzIGlmIGJhbGwgaXMgY2xvc2UKICAgICAgICAgICAgICAgICAgICBjb25zdCB1cmdlbmN5ID0gKGRpc3RUb0JhbGwgPCAxMC4wKSA/IDEuNSA6IDEuMDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMubWF4U3BlZWQgKiB1cmdlbmN5OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQobW92ZURpci5tdWx0aXBseVNjYWxhcihzcGVlZCAqIGR0KSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRmFjZSBiYWxsCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdChfYmFsbFBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdzd2ltJykgdGhpcy5wbGF5KCdzd2ltJywgMC4yKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpZGxlJykgdGhpcy5wbGF5KCdpZGxlJywgMC4yKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KF9iYWxsUG9zKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gU0FWRSBNRUNIQU5JQyAtLS0KICAgICAgICAgICAgICAgIC8vIElmIGJhbGwgaXMgd2l0aGluIHJhbmdlLCBhcHBseSBDQSBwcmVzc3VyZQogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHRoaXMuc2F2ZVJhZGl1cykgeyAKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hcHBseVNhdmVQcmVzc3VyZShiYWxsLCBkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gSURMRSAvIFJFVFVSTiBUTyBQT1NUIC0tLQogICAgICAgICAgICAgICAgLy8gUmV0dXJuIHRvIGhvbWUgcG9zaXRpb24gKHVzdWFsbHkgY2VudGVyIG9mIGdvYWwpCiAgICAgICAgICAgICAgICBfZ1Bvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGNvbnN0IG1vdmVEaXIgPSBfZ1ZlYy5zdWJWZWN0b3JzKF9nUG9zLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAobW92ZURpci5sZW5ndGgoKSA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIG1vdmVEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChtb3ZlRGlyLm11bHRpcGx5U2NhbGFyKHRoaXMubWF4U3BlZWQgKiAwLjYgKiBkdCkpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnc3dpbScpIHRoaXMucGxheSgnc3dpbScsIDAuMik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnaWRsZScpIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyIGZpZWxkCiAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlTYXZlUHJlc3N1cmUoYmFsbCwgZHQpIHsKICAgICAgICAgICAgLy8gSWYgR29hbGllIGlzIEFzbGVlcCwgdGhleSBjYW5ub3Qgc2F2ZS4KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKCiAgICAgICAgICAgIC8vIC0tLSBTVVBFUiBHT0FMSUUgVFJJR0dFUiAtLS0KICAgICAgICAgICAgLy8gVHJpZ2dlciBpZjogVGVjaCBlcXVpcHBlZCwgTm90IGFjdGl2ZSwgQmFsbCBoYXMgcG93ZXIsIEJhbGwgaXMgY2xvc2UKICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMuYWN0aXZlID09PSAnc3VwZXJfZ29hbGllJyAmJiAhdGhpcy5pc1N1cGVyR29hbGllICYmIGJhbGwucG93ZXIgPiA1LjApIHsKICAgICAgICAgICAgICAgIC8vIENoYW5jZSB0byB0cmlnZ2VyIChIaWdoIGNoYW5jZSBmb3IgQUksIG9yIGNoZWNrIEhQKQogICAgICAgICAgICAgICAgLy8gQ29zdDogMTAgSFAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQID49IDEwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSAxMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3VwZXJHb2FsaWVUaW1lciA9IDEuNTsgLy8gTGFzdHMgMS41cwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gdXNlZCBTVVBFUiBHT0FMSUUhYCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU1VQRVIgR09BTElFISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInNhdmUiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVHJpZ2dlciBUZWNoY29weSBFdmVudAogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQodGhpcywgJ3N1cGVyX2dvYWxpZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIEVmZmVjdGl2ZSBDQQogICAgICAgICAgICBsZXQgY2EgPSB0aGlzLmdldFN0YXQoJ0NBJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBTdXBlciBHb2FsaWUgQm9udXMgKGUuZy4gKzUwJSArIEZsYXQgMTApCiAgICAgICAgICAgIGlmICh0aGlzLmlzU3VwZXJHb2FsaWUpIHsKICAgICAgICAgICAgICAgIGNhID0gKGNhICogMS41KSArIDEwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBHcmlwIEdsb3ZlcyAoUGFzc2l2ZSkKICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMucGFzc2l2ZSA9PT0gJ2dyaXBfZ2xvdmVzJykgewogICAgICAgICAgICAgICAgY2EgKz0gNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIFByZXNzdXJlCiAgICAgICAgICAgIC8vIFByZXNzdXJlID0gQ0EgKiBkdCAqIE11bHRpcGxpZXIKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSBjYSAqIGR0ICogdGhpcy5wcmVzc3VyZU11bHRpcGxpZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA+IDApIHsKICAgICAgICAgICAgICAgIGJhbGwucG93ZXIgLT0gcHJlc3N1cmU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjawogICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRTYXZlICs9IHByZXNzdXJlOwogICAgICAgICAgICAgICAgLy8gVEhST1RUTEU6IEluY3JlYXNlZCB0aHJlc2hvbGQgdG8gMTIuMAogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FjY3VtdWxhdGVkU2F2ZSA+PSAxMi4wKSB7IAogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZFNhdmUgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBcHBseSBCYWxsIFRlY2huaXF1ZSB0byBHb2FsaWUgKFJpc2sgb2YgY2F0Y2hpbmcgc3BlY2lhbCBzaG90cykKLy8gQXBwbHkgQmFsbCBUZWNobmlxdWUgdG8gR29hbGllIChSaXNrIG9mIGNhdGNoaW5nIHNwZWNpYWwgc2hvdHMpCiAgICAgICAgICAgIGlmIChiYWxsLnRlY2huaXF1ZSAmJiB0aGlzLnRlY2hJbW11bml0eVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICBjb25zdCB0ZWNoID0gYmFsbC50ZWNobmlxdWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZWNoLnR5cGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDE1LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICduYXAnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseVN0YXR1cygnbmFwJywgOC4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGVjaC50eXBlID09PSAnd2l0aGVyJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDE1LjAsICdDQScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayBSZXN1bHQKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCAmJiB0aGlzLnN0YXR1cy5uYXAgPD0gMCkgewogICAgICAgICAgICAgICAgLy8gQ0FUQ0gKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hCYWxsKGJhbGwpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjYXRjaEJhbGwoYmFsbCkgewogICAgICAgICAgICBiYWxsLmdyYWIodGhpcyk7CiAgICAgICAgICAgIHRoaXMucGxheSgnY2F0Y2gnLCAwLjEpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiU0FWRUQgYnkgIiArIHRoaXMucm9sZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFWFAgUkVXQVJEOiBTYXZlCiAgICAgICAgICAgIHRoaXMuZ2FpbkV4cCg1KTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTQVZFRCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KDAuMTUsICdoZWF2eScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgdGhyb3cgdGltZXIKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICB9CgpfYWlQb3NzZXNzaW9uTG9naWMoZHQpIHsKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyICs9IGR0OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSG9sZCBmb3IgYSBtb21lbnQgKDEuNXMpIHRoZW4gdGhyb3cKICAgICAgICAgICAgaWYgKHRoaXMudGhyb3dUaW1lciA+IDEuNSkgewogICAgICAgICAgICAgICAgLy8gRmluZCBiZXN0IHRhcmdldDogUHJlZmVyIE1GIG9yIERlZmVuZGVycywgYnV0IG11c3QgYmUgc29tZXdoYXQgZGlzdGFudCB0byBhdm9pZCAiaGFuZG9mZiIgbG9vawogICAgICAgICAgICAgICAgLy8gRmlsdGVyIGZvciB0ZWFtbWF0ZXMgPiA4IHVuaXRzIGF3YXkgaWYgcG9zc2libGUKICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkTWF0ZXMgPSB0aGlzLnRlYW0ucGxheWVycy5maWx0ZXIocCA9PiAKICAgICAgICAgICAgICAgICAgICBwICE9PSB0aGlzICYmIAogICAgICAgICAgICAgICAgICAgIHAubWVzaCAmJiAKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0aGlzLm1lc2gucG9zaXRpb24pID4gOC4wCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIGxldCB0YXJnZXQgPSBudWxsOwoKICAgICAgICAgICAgICAgIC8vIFByaW9yaXR5IDE6IE1pZGZpZWxkZXIgKFBsYXltYWtlcikKICAgICAgICAgICAgICAgIHRhcmdldCA9IHZhbGlkTWF0ZXMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFByaW9yaXR5IDI6IERlZmVuZGVycwogICAgICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHRhcmdldCA9IHZhbGlkTWF0ZXMuZmluZChwID0+IHAucm9sZSA9PT0gJ0xEJyB8fCBwLnJvbGUgPT09ICdSRCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eSAzOiBBbnlvbmUgb3BlbiAoZmFsbGJhY2sgdG8gY2xvc2UgcmFuZ2UgaWYgbm8gb25lIGlzIGZhcikKICAgICAgICAgICAgICAgIGlmICghdGFyZ2V0KSB0YXJnZXQgPSB0aGlzLnRlYW0ucGxheWVycy5maW5kKHAgPT4gcCAhPT0gdGhpcyAmJiBwLnJvbGUgIT09ICdHTCcpOwoKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0Lm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAvLyBBSU1JTkcgTE9HSUM6IExvZnQgdGhlIHBhc3MKICAgICAgICAgICAgICAgICAgICAvLyBMb29rIGF0IHRhcmdldCwgYnV0IGFpbSBzbGlnaHRseSB1cCB0byBjcmVhdGUgYW4gYXJjCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9zID0gdGFyZ2V0Lm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlzdGFuY2UKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMb2Z0IGZhY3RvcjogVGhlIGZ1cnRoZXIgYXdheSwgdGhlIGhpZ2hlciB3ZSBhaW0KICAgICAgICAgICAgICAgICAgICAvLyAyMCB1bml0cyBhd2F5IC0+IEFpbSA1IHVuaXRzIGFib3ZlIGhlYWQKICAgICAgICAgICAgICAgICAgICBjb25zdCBsb2Z0ID0gTWF0aC5tYXgoMS4wLCBkaXN0ICogMC4yNSk7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnkgKz0gbG9mdDsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdCh0YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFRocm93CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGhyb3dCYWxsKGJhbGwsICdQQScpOyAKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnJvbGV9IHRocm93cyB0byAke3RhcmdldC5yb2xlfSAoRGlzdDogJHtkaXN0LnRvRml4ZWQoMSl9KWApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBDbGVhciBpdCBmb3J3YXJkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdCgwLCA1LCAwKTsgLy8gQWltIHVwLWNlbnRlcgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCAnU0gnKTsgLy8gSGFyZCBjbGVhcgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLnRocm93VGltZXIgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkdvYWxpZSA9IEdvYWxpZTsKfSkoKTs=","/Goalie.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgIAogICAgLy8gUmV1c2FibGUgdmVjdG9ycyB0byBhdm9pZCBHQwpjb25zdCBfZ1ZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ1BvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfYmFsbFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZmFjZVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfZ29hbENlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGVtcFZlY0cgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgIGNsYXNzIEdvYWxpZSBleHRlbmRzIHdpbmRvdy5mbHV4LlBsYXllciB7CmNvbnN0cnVjdG9yKHNjZW5lLCByb2xlKSB7CiAgICAgICAgICAgIHN1cGVyKHNjZW5lLCByb2xlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdvYWxpZSBTcGVjaWZpYyBTdGF0cyAoQnVmZmVkIGZvciBQbGF5YWJpbGl0eSkKICAgICAgICAgICAgdGhpcy5zdGF0cy5DQSA9IDMwOyAvLyBDYXRjaAogICAgICAgICAgICB0aGlzLnN0YXRzLlNQID0gNDA7IC8vIFNwZWVkCiAgICAgICAgICAgIHRoaXMuc3RhdHMuRU4gPSA1MDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJVRkZFRDogU3Ryb25nIGFybSBmb3IgY2xlYXJpbmcgdGhlIHpvbmUKICAgICAgICAgICAgdGhpcy5zdGF0cy5QQSA9IDQ1OyAvLyBXYXMgMjAgLSBOb3cgc3Ryb25nIGVub3VnaCB0byByZWFjaCBtaWRmaWVsZAogICAgICAgICAgICB0aGlzLnN0YXRzLlNIID0gMzU7IC8vIFdhcyAxMCAtIERlY2VudCBjbGVhcmFuY2Uga2ljawogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVyaXZlZFN0YXRzKCk7CgogICAgICAgICAgICAvLyBHb2FsIERpbWVuc2lvbnMgKFNhdmUgQm94KSAtIE1hdGNoZXMgR2FtZU1hbmFnZXIgZGV0ZWN0aW9uCiAgICAgICAgICAgIHRoaXMuZ29hbFdpZHRoID0gMjIuMDsgCiAgICAgICAgICAgIHRoaXMuZ29hbEhlaWdodCA9IDE4LjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2F2ZSBNZWNoYW5pY3MKICAgICAgICAgICAgdGhpcy5zYXZlUmFkaXVzID0gNi4wOyAKICAgICAgICAgICAgdGhpcy5wcmVzc3VyZU11bHRpcGxpZXIgPSA1LjA7IAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVjaHMKICAgICAgICAgICAgdGhpcy50ZWNocyA9IHsKICAgICAgICAgICAgICAgIGFjdGl2ZTogbnVsbCwgCiAgICAgICAgICAgICAgICBwYXNzaXZlOiBudWxsIAogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQUkgU3RhdGUKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRTYXZlID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN1cGVyIEdvYWxpZSBTdGF0ZQogICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyID0gMDsKCi8vIFBlcmNlcHRpb24gU21vb3RoaW5nIChSZWFjdGlvbiBEZWxheSkKICAgICAgICAgICAgdGhpcy5wZXJjZWl2ZWRCYWxsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5yZWFjdGlvblNwZWVkID0gNC4wOyAvLyBMb3dlciA9IG1vcmUgZGVsYXkvc21vb3RoaW5nCiAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAwOwogICAgICAgIH0KCnVwZGF0ZShkdCkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbHMoZHQpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlUGh5c2ljcyhkdCkgewogICAgICAgICAgICAvLyAxLiBTdXBlciBHb2FsaWUgVGltZXIKICAgICAgICAgICAgaWYgKHRoaXMuaXNTdXBlckdvYWxpZSkgewogICAgICAgICAgICAgICAgdGhpcy5zdXBlckdvYWxpZVRpbWVyIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3VwZXJHb2FsaWVUaW1lciA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1N1cGVyR29hbGllID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDIuIFBvc3Nlc3Npb24gTG9naWMgKEJhbGwgSGVsZCkKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tUYWNrbGVQcmVzc3VyZShkdCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgICAgICBjb25zdCBpc0h1bWFuQ29udHJvbGxlZCA9IHRoaXMudGVhbSAmJiB0aGlzLnRlYW0uaXNIdW1hbiAmJiB0aGlzLnRlYW0uYWN0aXZlUGxheWVyID09PSB0aGlzICYmICFnYW1lLmlzRGVtb01vZGU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChpc0h1bWFuQ29udHJvbGxlZCkgewogICAgICAgICAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVBoeXNpY3MoZHQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNUaHJvd2luZykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9haVBvc3Nlc3Npb25Mb2dpYyhkdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXQoMCwgMCk7CiAgICAgICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlUGh5c2ljcyhkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIERlZmVuc2UgLyBTYXZlIExvZ2ljIChObyBCYWxsKQogICAgICAgICAgICBpZiAodGhpcy5kYXNoQ29vbGRvd24gPiAwKSB0aGlzLmRhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuY2xhc2hDb29sZG93biA+IDApIHRoaXMuY2xhc2hDb29sZG93biAtPSBkdDsKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCkgdGhpcy5zdHVuVGltZXIgLT0gZHQ7CiAgICAgICAgICAgIGlmICh0aGlzLmltbXVuaXR5VGltZXIgPiAwKSB0aGlzLmltbXVuaXR5VGltZXIgLT0gZHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0dXNMb2dpYyhkdCk7CgogICAgICAgICAgICBpZiAodGhpcy5zdHVuVGltZXIgPiAwIHx8IHRoaXMuc3RhdHVzLm5hcCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2NvbnN0cmFpbkJvdW5kcygpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9kZWZlbnNlTG9naWMoZHQpOwogICAgICAgICAgICB0aGlzLl9jb25zdHJhaW5Cb3VuZHMoKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZVZpc3VhbHMoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgc3VwZXIudXBkYXRlVmlzdWFscyhkdCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXR1c1Zpc3VhbHMoZHQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3R1blRpbWVyID4gMCB8fCB0aGlzLnN0YXR1cy5uYXAgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5taXhlcikgdGhpcy5taXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlSFBCYXIoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWl4ZXIpIHRoaXMubWl4ZXIudXBkYXRlKGR0KTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlSFBCYXIoKTsKICAgICAgICB9CgpfY29uc3RyYWluQm91bmRzKCkgewogICAgICAgICAgICBpZiAoIXRoaXMubWVzaCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBwb3MgPSB0aGlzLm1lc2gucG9zaXRpb247CgogICAgICAgICAgICBjb25zdCBzaWRlID0gdGhpcy50ZWFtID8gdGhpcy50ZWFtLnNpZGUgOiAxOwogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gWCBCb3VuZHMgKFdpZHRoIG9mIHBlbmFsdHkgYXJlYSArLy0gMTBtKSAtPiBJbmNyZWFzZWQgZm9yIG1hc3NpdmUgZ29hbApjb25zdCB4TGltaXQgPSAyMC4wOyAvLyBSZWR1Y2VkIHdpZHRoIG9mIGdvYWxpZSBtb3ZlbWVudAogICAgICAgICAgICBpZiAocG9zLnggPiB4TGltaXQpIHsgcG9zLnggPSB4TGltaXQ7IHRoaXMudmVsb2NpdHkueCA9IDA7IH0KICAgICAgICAgICAgaWYgKHBvcy54IDwgLXhMaW1pdCkgeyBwb3MueCA9IC14TGltaXQ7IHRoaXMudmVsb2NpdHkueCA9IDA7IH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFkgQm91bmRzCiAgICAgICAgICAgIGNvbnN0IHlMaW1pdCA9IDEyLjA7IC8vIFJlZHVjZWQgaGVpZ2h0IGNlaWxpbmcKICAgICAgICAgICAgaWYgKHBvcy55ID4geUxpbWl0KSB7IHBvcy55ID0geUxpbWl0OyB0aGlzLnZlbG9jaXR5LnkgPSAwOyB9CiAgICAgICAgICAgIGlmIChwb3MueSA8IC15TGltaXQpIHsgcG9zLnkgPSAteUxpbWl0OyB0aGlzLnZlbG9jaXR5LnkgPSAwOyB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBaIEJvdW5kcyAoRGVwdGgpCi8vIFogQm91bmRzIChEZXB0aCkKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKLy8gQ0xBTVAgWjogUHJldmVudCBHb2FsaWUgZnJvbSBnb2luZyBpbnRvIHRoZSBuZXQgb3IgYmVoaW5kIGdvYWwKICAgICAgICAgICAgaWYgKHNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IGdvYWxEaXN0IC0gMC41KSB7IHBvcy56ID0gZ29hbERpc3QgLSAwLjU7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgICAgIGlmIChwb3MueiA8IDIwLjApIHsgcG9zLnogPSAyMC4wOyB0aGlzLnZlbG9jaXR5LnogPSAwOyB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAocG9zLnogPCAtZ29hbERpc3QgKyAwLjUpIHsgcG9zLnogPSAtZ29hbERpc3QgKyAwLjU7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgICAgIGlmIChwb3MueiA+IC0yMC4wKSB7IHBvcy56ID0gLTIwLjA7IHRoaXMudmVsb2NpdHkueiA9IDA7IH0KICAgICAgICAgICAgfQogICAgICAgIH0KCi8vIE92ZXJyaWRlIHRocm93QmFsbCB0byBmaXggIndlYWsgdGhyb3ciIGlzc3VlCi8vIE92ZXJyaWRlIHRocm93QmFsbCB0byBmaXggIndlYWsgdGhyb3ciIGlzc3VlIGFuZCByZWR1Y2UgbG9mdAogICAgICAgIHRocm93QmFsbChiYWxsLCBmb3JjZWRUeXBlID0gbnVsbCwgcG93ZXJNdWx0aXBsaWVyID0gMS4wKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYXNCYWxsIHx8IHRoaXMuaXNUaHJvd2luZykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5pc1Rocm93aW5nID0gdHJ1ZTsKICAgICAgICAgICAgY29uc3QgdHlwZSA9IGZvcmNlZFR5cGUgfHwgJ1BBJzsKICAgICAgICAgICAgY29uc3QgYm9vc3QgPSAxLjI7CiAgICAgICAgICAgIGNvbnN0IGZpbmFsUG93ZXIgPSBwb3dlck11bHRpcGxpZXIgKiBib29zdDsKCiAgICAgICAgICAgIC8vIEFuaW1hdGlvbgogICAgICAgICAgICBjb25zdCB0aHJvd0tleSA9ICh0eXBlID09PSAnU0gnICYmIHRoaXMuYWN0aW9uc1sndGhyb3dfc2hvdCddKSA/ICd0aHJvd19zaG90JyA6ICd0aHJvd19wYXNzJzsKICAgICAgICAgICAgdGhpcy5wbGF5T25lU2hvdCh0aHJvd0tleSwgMC4xLCB7IHRpbWVTY2FsZTogMS4yIH0pOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkNMRUFSISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWFjdGlvbiIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhc0JhbGwgfHwgKGJhbGwgJiYgYmFsbC5ob2xkZXIgPT09IHRoaXMpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIERpcmVjdGlvbgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbmFsRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMubWVzaC5xdWF0ZXJuaW9uKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSRURVQ0VEIExPRlQ6IEdvYWxpZSB0aHJvd3MgZmxhdHRlciAoMC4yNSBpbnN0ZWFkIG9mIDAuOCkKICAgICAgICAgICAgICAgICAgICBmaW5hbERpci55ICs9IDAuMjU7IAogICAgICAgICAgICAgICAgICAgIGZpbmFsRGlyLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgU3RhdHMKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdFZhbCA9IHRoaXMuZ2V0U3RhdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0VmFsICo9IGZpbmFsUG93ZXI7CgogICAgICAgICAgICAgICAgICAgIGJhbGwuc2hvb3QoZmluYWxEaXIsIHN0YXRWYWwsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEV4dHJhIGdyYWNlIHBlcmlvZCBmb3IgR29hbGllCiAgICAgICAgICAgICAgICAgICAgYmFsbC5jYXRjaEdyYWNlUGVyaW9kID0gMC42OwoKICAgICAgICAgICAgICAgICAgICB0aGlzLmxvc2VCYWxsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYXRjaENvb2xkb3duID0gMS4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAzMDApOyAvLyBXaW5kdXAgdGltZQoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmlzVGhyb3dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY29tb3Rpb25BbmltKDAuMik7CiAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgfQoKX2RlZmVuc2VMb2dpYyhkdCkgewogICAgICAgICAgICAvLyAwLiBHYW1lIFN0YXRlIENoZWNrCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgIT09ICdhY3RpdmUnKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBiYWxsID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGlmICghYmFsbCB8fCAhYmFsbC5tZXNoKSByZXR1cm47CgogICAgICAgICAgICAvLyAtLS0gUEVSQ0VQVElPTiBVUERBVEUgLS0tCiAgICAgICAgICAgIC8vIFNtb290aGx5IGludGVycG9sYXRlIHBlcmNlaXZlZCBwb3NpdGlvbiB0b3dhcmRzIHJlYWwgYmFsbCBwb3NpdGlvbgogICAgICAgICAgICAvLyBUaGlzIGNyZWF0ZXMgYSBuYXR1cmFsIHJlYWN0aW9uIGRlbGF5IGFuZCBwcmV2ZW50cyBqaXR0ZXJ5IG1pcnJvcmluZwogICAgICAgICAgICB0aGlzLnBlcmNlaXZlZEJhbGxQb3MubGVycChiYWxsLm1lc2gucG9zaXRpb24sIGR0ICogdGhpcy5yZWFjdGlvblNwZWVkKTsKCiAgICAgICAgICAgIC8vIERldGVybWluZSBUaHJlYXQgU291cmNlCiAgICAgICAgICAgIGxldCB0aHJlYXRQb3MgPSBfYmFsbFBvczsKICAgICAgICAgICAgbGV0IGlzVGhyZWF0ID0gZmFsc2U7CmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgIGNvbnN0IG15R29hbFogPSAodGhpcy50ZWFtLnNpZGUgPT09IDEpID8gZ29hbERpc3QgOiAtZ29hbERpc3Q7CgogICAgICAgICAgICAvLyBDYXNlIEE6IEJhbGwgaXMgSGVsZCAoUHJlLXRocm93KQogICAgICAgICAgICBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2hlbGQnICYmIGJhbGwuaG9sZGVyICYmIGJhbGwuaG9sZGVyLnRlYW0gIT09IHRoaXMudGVhbSkgewogICAgICAgICAgICAgICAgLy8gVHJhY2sgaG9sZGVyLCBidXQgdXNlIHBlcmNlaXZlZCBwb3NpdGlvbiBpZiB3ZSB3YW50ZWQgdG8gc2ltdWxhdGUgcmVhZGluZyB0aGUgcGxheWVyCiAgICAgICAgICAgICAgICAvLyBGb3Igbm93LCB0cmFja2luZyB0aGUgYmFsbCAod2hpY2ggaXMgb24gdGhlIHBsYXllcikgdmlhIHBlcmNlaXZlZFBvcyBpcyBzdWZmaWNpZW50CiAgICAgICAgICAgICAgICB0aHJlYXRQb3MgPSB0aGlzLnBlcmNlaXZlZEJhbGxQb3M7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGhvbGRlciBpcyBpbiBhdHRhY2tpbmcgaGFsZiBvciBuZWFyIGVub3VnaAogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvR29hbCA9IE1hdGguYWJzKHRocmVhdFBvcy56IC0gbXlHb2FsWik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdFRvR29hbCA8IDQwLjApIHsgLy8gSWYgdGhleSBhcmUgd2l0aGluIDQwbSwgdHJhY2sgdGhlbQogICAgICAgICAgICAgICAgICAgIGlzVGhyZWF0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSAKICAgICAgICAgICAgLy8gQ2FzZSBCOiBCYWxsIGlzIEZyZWUgKFNob3QvUGFzcykKICAgICAgICAgICAgZWxzZSBpZiAoYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICB0aHJlYXRQb3MgPSB0aGlzLnBlcmNlaXZlZEJhbGxQb3M7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERpcmVjdGlvbiBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgbW92aW5nVG93YXJkcyA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSAmJiBiYWxsLnZlbG9jaXR5LnogPiAwKSB8fCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAodGhpcy50ZWFtLnNpZGUgPT09IC0xICYmIGJhbGwudmVsb2NpdHkueiA8IDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQb3NpdGlvbiBDaGVjawogICAgICAgICAgICAgICAgY29uc3QgaW5Gcm9udE9mR29hbCA9ICh0aGlzLnRlYW0uc2lkZSA9PT0gMSAmJiB0aHJlYXRQb3MueiA8IDQ1LjApIHx8IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLnRlYW0uc2lkZSA9PT0gLTEgJiYgdGhyZWF0UG9zLnogPiAtNDUuMCk7CgogICAgICAgICAgICAgICAgaXNUaHJlYXQgPSBtb3ZpbmdUb3dhcmRzICYmIGluRnJvbnRPZkdvYWw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzVGhyZWF0KSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gUE9TSVRJT05JTkc6IEFOR0xFIENVVFRJTkcgLS0tCiAgICAgICAgICAgICAgICBfYmFsbFBvcy5jb3B5KHRocmVhdFBvcyk7IC8vIFVwZGF0ZSByZWZlcmVuY2UgZm9yIGxvb2tBdAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAxLiBDYWxjdWxhdGUgR29hbCBDZW50ZXIKLy8gMS4gQ2FsY3VsYXRlIEdvYWwgQ2VudGVyIChBZGp1c3RlZCBmb3IgWSBvZmZzZXQpCl9nb2FsQ2VudGVyLnNldCgwLCAtNi4wLCBteUdvYWxaKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gMi4gVmVjdG9yIGZyb20gR29hbCB0byBCYWxsCiAgICAgICAgICAgICAgICBfdGVtcFZlY0cuc3ViVmVjdG9ycyhfYmFsbFBvcywgX2dvYWxDZW50ZXIpOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvQmFsbCA9IF90ZW1wVmVjRy5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIF90ZW1wVmVjRy5ub3JtYWxpemUoKTsgLy8gTm93IGhvbGRzIGRpcmVjdGlvbgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyAzLiBEZXRlcm1pbmUgRXh0ZW5zaW9uIChIb3cgZmFyIG91dCB0byBzdGVwKQogICAgICAgICAgICAgICAgLy8gQmFzZTogMS41bSBvZmYgbGluZS4KICAgICAgICAgICAgICAgIC8vIE1heDogNi4wbSBvZmYgbGluZSAoQ3V0dGluZyBhbmdsZSkuCiAgICAgICAgICAgICAgICAvLyBTY2FsZSBiYXNlZCBvbiBiYWxsIHByb3hpbWl0eTogQ2xvc2VyIGJhbGwgPSBNb3JlIGV4dGVuc2lvbiAodG8gYSBwb2ludCkKbGV0IGV4dGVuc2lvbiA9IDEuNTsKICAgICAgICAgICAgICAgIGlmIChkaXN0VG9CYWxsIDwgMzAuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gMS4wIC0gKE1hdGgubWF4KDAsIGRpc3RUb0JhbGwgLSA1LjApIC8gMjUuMCk7IAogICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbiA9IDEuNSArICg0LjUgKiByYXRpbyk7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCi8vIFNhZmV0eTogRG9uJ3QgZ28gcGFzdCB0aGUgYmFsbCAoa2VlcCAxbSBidWZmZXIpCiAgICAgICAgICAgICAgICBleHRlbnNpb24gPSBNYXRoLm1pbihleHRlbnNpb24sIGRpc3RUb0JhbGwgLSAxLjApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyA0LiBDYWxjdWxhdGUgVGFyZ2V0IFBvc2l0aW9uIChCYXNlIEludGVyY2VwdGlvbikKICAgICAgICAgICAgICAgIF9nUG9zLmNvcHkoX2dvYWxDZW50ZXIpLmFkZChfdGVtcFZlY0cubXVsdGlwbHlTY2FsYXIoZXh0ZW5zaW9uKSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDUuIFZlcnRpY2FsIE92ZXJyaWRlIChKdW1wIHRvIG1lZXQgYmFsbCkKICAgICAgICAgICAgICAgIC8vIEV4cGxpY2l0bHkgc2V0IFkgdG8gbWF0Y2ggYmFsbCBoZWlnaHQgaWYgaXQncyBoaWdoCiAgICAgICAgICAgICAgICBpZiAoX2JhbGxQb3MueSA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIF9nUG9zLnkgPSBfYmFsbFBvcy55OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gMC41OyAvLyBEZWZhdWx0IHN0YW5jZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDYuIENsYW1wIHRvIEdvYWwgQm94IERpbWVuc2lvbnMgKExhdGVyYWwvVmVydGljYWwgTGltaXRzKQogICAgICAgICAgICAgICAgLy8gR29hbCBXaWR0aCAyMiAoKy8tIDExKSwgSGVpZ2h0IDE4ICgrLy0gOSkuCiAgICAgICAgICAgICAgICAvLyBBbGxvdyBzbGlnaHRseSBvdXRzaWRlIHBvc3RzIHRvIGNvdmVyIGFuZ2xlcy4KICAgICAgICAgICAgICAgIGNvbnN0IGNsYW1wWCA9IHRoaXMuZ29hbFdpZHRoICogMC42OyAvLyArLy0gMTMuMgpjb25zdCBjbGFtcFkgPSAxMi4wOyAvLyBSZWR1Y2VkIG1heCBqdW1wIGhlaWdodAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfZ1Bvcy54ID0gTWF0aC5tYXgoLWNsYW1wWCwgTWF0aC5taW4oY2xhbXBYLCBfZ1Bvcy54KSk7CiAgICAgICAgICAgICAgICBfZ1Bvcy55ID0gTWF0aC5tYXgoLWNsYW1wWSwgTWF0aC5taW4oY2xhbXBZLCBfZ1Bvcy55KSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIDYuIExlYWQgdGhlIGJhbGwgc2xpZ2h0bHkgaWYgaXQgaGFzIGxhdGVyYWwgdmVsb2NpdHkgKEFudGljaXBhdGlvbikKaWYgKGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDEuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFudGljaXBhdGlvbiA9IGJhbGwudmVsb2NpdHkuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigwLjI1KTsgLy8gMC4yNXMgbGVhZAogICAgICAgICAgICAgICAgICAgIGFudGljaXBhdGlvbi56ID0gMDsgLy8gT25seSBsYXRlcmFsIGxlYWQKICAgICAgICAgICAgICAgICAgICBfZ1Bvcy5hZGQoYW50aWNpcGF0aW9uKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAovLyBDTEFNUCBaOiBQcmV2ZW50IEdvYWxpZSBmcm9tIGdvaW5nIGludG8gdGhlIG5ldCBvciBiZWhpbmQgZ29hbAogICAgICAgICAgICBpZiAodGhpcy50ZWFtLnNpZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIF9nUG9zLnogPSBNYXRoLm1pbihnb2FsRGlzdCAtIDAuNSwgX2dQb3Mueik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfZ1Bvcy56ID0gTWF0aC5tYXgoLWdvYWxEaXN0ICsgMC41LCBfZ1Bvcy56KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE1vdmUgdG93YXJkcyB0YXJnZXQKICAgICAgICAgICAgICAgIGNvbnN0IG1vdmVEaXIgPSBfZ1ZlYy5zdWJWZWN0b3JzKF9nUG9zLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdFRvVGFyZ2V0ID0gbW92ZURpci5sZW5ndGgoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGRpc3RUb1RhcmdldCA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgIG1vdmVEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgLy8gQnVyc3Qgc3BlZWQgZm9yIHNhdmVzIGlmIGJhbGwgaXMgY2xvc2UKICAgICAgICAgICAgICAgICAgICBjb25zdCB1cmdlbmN5ID0gKGRpc3RUb0JhbGwgPCAxMC4wKSA/IDEuNSA6IDEuMDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMubWF4U3BlZWQgKiB1cmdlbmN5OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzaC5wb3NpdGlvbi5hZGQobW92ZURpci5tdWx0aXBseVNjYWxhcihzcGVlZCAqIGR0KSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRmFjZSBiYWxsCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdChfYmFsbFBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdzd2ltJykgdGhpcy5wbGF5KCdzd2ltJywgMC4yKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09ICdpZGxlJykgdGhpcy5wbGF5KCdpZGxlJywgMC4yKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KF9iYWxsUG9zKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gU0FWRSBNRUNIQU5JQyAtLS0KICAgICAgICAgICAgICAgIC8vIElmIGJhbGwgaXMgd2l0aGluIHJhbmdlLCBhcHBseSBDQSBwcmVzc3VyZQogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRoaXMubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGJhbGwubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHRoaXMuc2F2ZVJhZGl1cykgeyAKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hcHBseVNhdmVQcmVzc3VyZShiYWxsLCBkdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAtLS0gSURMRSAvIFJFVFVSTiBUTyBQT1NUIC0tLQogICAgICAgICAgICAgICAgLy8gUmV0dXJuIHRvIGhvbWUgcG9zaXRpb24gKHVzdWFsbHkgY2VudGVyIG9mIGdvYWwpCiAgICAgICAgICAgICAgICBfZ1Bvcy5jb3B5KHRoaXMuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGNvbnN0IG1vdmVEaXIgPSBfZ1ZlYy5zdWJWZWN0b3JzKF9nUG9zLCB0aGlzLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAobW92ZURpci5sZW5ndGgoKSA+IDAuNSkgewogICAgICAgICAgICAgICAgICAgIG1vdmVEaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLnBvc2l0aW9uLmFkZChtb3ZlRGlyLm11bHRpcGx5U2NhbGFyKHRoaXMubWF4U3BlZWQgKiAwLjYgKiBkdCkpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnc3dpbScpIHRoaXMucGxheSgnc3dpbScsIDAuMik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSAnaWRsZScpIHRoaXMucGxheSgnaWRsZScsIDAuMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyIGZpZWxkCiAgICAgICAgICAgICAgICB0aGlzLm1lc2gubG9va0F0KDAsIDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfYXBwbHlTYXZlUHJlc3N1cmUoYmFsbCwgZHQpIHsKICAgICAgICAgICAgLy8gSWYgR29hbGllIGlzIEFzbGVlcCwgdGhleSBjYW5ub3Qgc2F2ZS4KICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzLm5hcCA+IDApIHJldHVybjsKCiAgICAgICAgICAgIC8vIC0tLSBTVVBFUiBHT0FMSUUgVFJJR0dFUiAtLS0KICAgICAgICAgICAgLy8gVHJpZ2dlciBpZjogVGVjaCBlcXVpcHBlZCwgTm90IGFjdGl2ZSwgQmFsbCBoYXMgcG93ZXIsIEJhbGwgaXMgY2xvc2UKICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMuYWN0aXZlID09PSAnc3VwZXJfZ29hbGllJyAmJiAhdGhpcy5pc1N1cGVyR29hbGllICYmIGJhbGwucG93ZXIgPiA1LjApIHsKICAgICAgICAgICAgICAgIC8vIENoYW5jZSB0byB0cmlnZ2VyIChIaWdoIGNoYW5jZSBmb3IgQUksIG9yIGNoZWNrIEhQKQogICAgICAgICAgICAgICAgLy8gQ29zdDogMTAgSFAKICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRzLkhQID49IDEwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5IUCAtPSAxMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzU3VwZXJHb2FsaWUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3VwZXJHb2FsaWVUaW1lciA9IDEuNTsgLy8gTGFzdHMgMS41cwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMucm9sZX0gdXNlZCBTVVBFUiBHT0FMSUUhYCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmZsb2F0aW5nVGV4dC5zcGF3bigiU1VQRVIgR09BTElFISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgInNhdmUiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVHJpZ2dlciBUZWNoY29weSBFdmVudAogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJUZWNoRXZlbnQodGhpcywgJ3N1cGVyX2dvYWxpZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIEVmZmVjdGl2ZSBDQQogICAgICAgICAgICBsZXQgY2EgPSB0aGlzLmdldFN0YXQoJ0NBJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBTdXBlciBHb2FsaWUgQm9udXMgKGUuZy4gKzUwJSArIEZsYXQgMTApCiAgICAgICAgICAgIGlmICh0aGlzLmlzU3VwZXJHb2FsaWUpIHsKICAgICAgICAgICAgICAgIGNhID0gKGNhICogMS41KSArIDEwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBHcmlwIEdsb3ZlcyAoUGFzc2l2ZSkKICAgICAgICAgICAgaWYgKHRoaXMudGVjaHMucGFzc2l2ZSA9PT0gJ2dyaXBfZ2xvdmVzJykgewogICAgICAgICAgICAgICAgY2EgKz0gNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIFByZXNzdXJlCiAgICAgICAgICAgIC8vIFByZXNzdXJlID0gQ0EgKiBkdCAqIE11bHRpcGxpZXIKICAgICAgICAgICAgY29uc3QgcHJlc3N1cmUgPSBjYSAqIGR0ICogdGhpcy5wcmVzc3VyZU11bHRpcGxpZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA+IDApIHsKICAgICAgICAgICAgICAgIGJhbGwucG93ZXIgLT0gcHJlc3N1cmU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZpc3VhbCBGZWVkYmFjawogICAgICAgICAgICAgICAgdGhpcy5fYWNjdW11bGF0ZWRTYXZlICs9IHByZXNzdXJlOwogICAgICAgICAgICAgICAgLy8gVEhST1RUTEU6IEluY3JlYXNlZCB0aHJlc2hvbGQgdG8gMTIuMAogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FjY3VtdWxhdGVkU2F2ZSA+PSAxMi4wKSB7IAogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5mbG9hdGluZ1RleHQuc3Bhd24oIkJMT0NLISIsIHRoaXMubWVzaC5wb3NpdGlvbiwgImNvbWljLWltcGFjdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9hY2N1bXVsYXRlZFNhdmUgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBcHBseSBCYWxsIFRlY2huaXF1ZSB0byBHb2FsaWUgKFJpc2sgb2YgY2F0Y2hpbmcgc3BlY2lhbCBzaG90cykKLy8gQXBwbHkgQmFsbCBUZWNobmlxdWUgdG8gR29hbGllIChSaXNrIG9mIGNhdGNoaW5nIHNwZWNpYWwgc2hvdHMpCiAgICAgICAgICAgIGlmIChiYWxsLnRlY2huaXF1ZSAmJiB0aGlzLnRlY2hJbW11bml0eVRpbWVyIDw9IDApIHsKICAgICAgICAgICAgICAgIHRoaXMudGVjaEltbXVuaXR5VGltZXIgPSAyLjA7CiAgICAgICAgICAgICAgICBjb25zdCB0ZWNoID0gYmFsbC50ZWNobmlxdWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZWNoLnR5cGUgPT09ICd2ZW5vbScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5U3RhdHVzKCd2ZW5vbScsIDE1LjApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZWNoLnR5cGUgPT09ICduYXAnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseVN0YXR1cygnbmFwJywgOC4wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGVjaC50eXBlID09PSAnd2l0aGVyJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0dXMoJ3dpdGhlcicsIDE1LjAsICdDQScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayBSZXN1bHQKICAgICAgICAgICAgaWYgKGJhbGwucG93ZXIgPD0gMCAmJiB0aGlzLnN0YXR1cy5uYXAgPD0gMCkgewogICAgICAgICAgICAgICAgLy8gQ0FUQ0gKICAgICAgICAgICAgICAgIHRoaXMuY2F0Y2hCYWxsKGJhbGwpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjYXRjaEJhbGwoYmFsbCkgewogICAgICAgICAgICBiYWxsLmdyYWIodGhpcyk7CiAgICAgICAgICAgIHRoaXMucGxheSgnY2F0Y2gnLCAwLjEpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiU0FWRUQgYnkgIiArIHRoaXMucm9sZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFWFAgUkVXQVJEOiBTYXZlCiAgICAgICAgICAgIHRoaXMuZ2FpbkV4cCg1KTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJTQVZFRCEiLCB0aGlzLm1lc2gucG9zaXRpb24sICJjb21pYy1pbXBhY3QiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnRyaWdnZXJJbXBhY3QpIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS50cmlnZ2VySW1wYWN0KDAuMTUsICdoZWF2eScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgdGhyb3cgdGltZXIKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyID0gMDsKICAgICAgICB9CgpfYWlQb3NzZXNzaW9uTG9naWMoZHQpIHsKICAgICAgICAgICAgdGhpcy50aHJvd1RpbWVyICs9IGR0OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSG9sZCBmb3IgYSBtb21lbnQgKDEuNXMpIHRoZW4gdGhyb3cKICAgICAgICAgICAgaWYgKHRoaXMudGhyb3dUaW1lciA+IDEuNSkgewogICAgICAgICAgICAgICAgLy8gRmluZCBiZXN0IHRhcmdldDogUHJlZmVyIE1GIG9yIERlZmVuZGVycywgYnV0IG11c3QgYmUgc29tZXdoYXQgZGlzdGFudCB0byBhdm9pZCAiaGFuZG9mZiIgbG9vawogICAgICAgICAgICAgICAgLy8gRmlsdGVyIGZvciB0ZWFtbWF0ZXMgPiA4IHVuaXRzIGF3YXkgaWYgcG9zc2libGUKICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkTWF0ZXMgPSB0aGlzLnRlYW0ucGxheWVycy5maWx0ZXIocCA9PiAKICAgICAgICAgICAgICAgICAgICBwICE9PSB0aGlzICYmIAogICAgICAgICAgICAgICAgICAgIHAubWVzaCAmJiAKICAgICAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uZGlzdGFuY2VUbyh0aGlzLm1lc2gucG9zaXRpb24pID4gOC4wCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIGxldCB0YXJnZXQgPSBudWxsOwoKICAgICAgICAgICAgICAgIC8vIFByaW9yaXR5IDE6IE1pZGZpZWxkZXIgKFBsYXltYWtlcikKICAgICAgICAgICAgICAgIHRhcmdldCA9IHZhbGlkTWF0ZXMuZmluZChwID0+IHAucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFByaW9yaXR5IDI6IERlZmVuZGVycwogICAgICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHRhcmdldCA9IHZhbGlkTWF0ZXMuZmluZChwID0+IHAucm9sZSA9PT0gJ0xEJyB8fCBwLnJvbGUgPT09ICdSRCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQcmlvcml0eSAzOiBBbnlvbmUgb3BlbiAoZmFsbGJhY2sgdG8gY2xvc2UgcmFuZ2UgaWYgbm8gb25lIGlzIGZhcikKICAgICAgICAgICAgICAgIGlmICghdGFyZ2V0KSB0YXJnZXQgPSB0aGlzLnRlYW0ucGxheWVycy5maW5kKHAgPT4gcCAhPT0gdGhpcyAmJiBwLnJvbGUgIT09ICdHTCcpOwoKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0Lm1lc2gpIHsKICAgICAgICAgICAgICAgICAgICAvLyBBSU1JTkcgTE9HSUM6IExvZnQgdGhlIHBhc3MKICAgICAgICAgICAgICAgICAgICAvLyBMb29rIGF0IHRhcmdldCwgYnV0IGFpbSBzbGlnaHRseSB1cCB0byBjcmVhdGUgYW4gYXJjCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0UG9zID0gdGFyZ2V0Lm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlzdGFuY2UKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gdGhpcy5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG8odGFyZ2V0UG9zKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMb2Z0IGZhY3RvcjogVGhlIGZ1cnRoZXIgYXdheSwgdGhlIGhpZ2hlciB3ZSBhaW0KICAgICAgICAgICAgICAgICAgICAvLyAyMCB1bml0cyBhd2F5IC0+IEFpbSA1IHVuaXRzIGFib3ZlIGhlYWQKICAgICAgICAgICAgICAgICAgICBjb25zdCBsb2Z0ID0gTWF0aC5tYXgoMS4wLCBkaXN0ICogMC4yNSk7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zLnkgKz0gbG9mdDsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdCh0YXJnZXRQb3MpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFRocm93CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFsbCA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5lbnRpdGllcy5iYWxsOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGhyb3dCYWxsKGJhbGwsICdQQScpOyAKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnJvbGV9IHRocm93cyB0byAke3RhcmdldC5yb2xlfSAoRGlzdDogJHtkaXN0LnRvRml4ZWQoMSl9KWApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBDbGVhciBpdCBmb3J3YXJkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNoLmxvb2tBdCgwLCA1LCAwKTsgLy8gQWltIHVwLWNlbnRlcgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRocm93QmFsbChiYWxsLCAnU0gnKTsgLy8gSGFyZCBjbGVhcgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLnRocm93VGltZXIgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkdvYWxpZSA9IEdvYWxpZTsKfSkoKTs=","MiniMap.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNaW5pTWFwIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcCcpOwogICAgICAgICAgICB0aGlzLmNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAvLyBPcHRpbWl6YXRpb246IGFscGhhOiB0cnVlIGlzIG5lZWRlZCBmb3IgdHJhbnNwYXJlbnQgYmFja2dyb3VuZAogICAgICAgICAgICB0aGlzLmN0eCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJywgeyBhbHBoYTogdHJ1ZSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhpZ2ggRFBJIHNjYWxpbmcgKDJ4IGZvciByZXRpbmEgc2hhcnBuZXNzIG9uIDEwMHB4IGNvbnRhaW5lcikKICAgICAgICAgICAgdGhpcy5zaXplID0gMjAwOyAKICAgICAgICAgICAgdGhpcy5jYW52YXMud2lkdGggPSB0aGlzLnNpemU7CiAgICAgICAgICAgIHRoaXMuY2FudmFzLmhlaWdodCA9IHRoaXMuc2l6ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5jYW52YXMuc3R5bGUsIHsKICAgICAgICAgICAgICAgIHdpZHRoOiAnMTAwJScsCiAgICAgICAgICAgICAgICBoZWlnaHQ6ICcxMDAlJywKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogJzUwJScsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAnYmxvY2snCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYW55IGV4aXN0aW5nIGNoaWxkcmVuIChlLmcuIGZyb20gcHJldmlvdXMgaW5pdHMpCiAgICAgICAgICAgICAgICB3aGlsZSAodGhpcy5jb250YWluZXIuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZUNoaWxkKHRoaXMuY29udGFpbmVyLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5jYW52YXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLndvcmxkUmFkaXVzID0gMzA7IC8vIEFyZW5hIHJhZGl1cwogICAgICAgICAgICB0aGlzLmhvbWVUZWFtID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hd2F5VGVhbSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpbml0KGhvbWVUZWFtLCBhd2F5VGVhbSwgYmFsbCkgewogICAgICAgICAgICB0aGlzLmhvbWVUZWFtID0gaG9tZVRlYW07CiAgICAgICAgICAgIHRoaXMuYXdheVRlYW0gPSBhd2F5VGVhbTsKICAgICAgICAgICAgdGhpcy5iYWxsID0gYmFsbDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmN0eCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICAgICAgICAgIGNvbnN0IHNpemUgPSB0aGlzLnNpemU7CiAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IHNpemUgLyAyOwogICAgICAgICAgICAvLyBNYXAgd29ybGQgcmFkaXVzICgzMCkgdG8gY2FudmFzIHJhZGl1cyAoYXBwcm94IDkwcHggdG8gbGVhdmUgcGFkZGluZykKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAoY2VudGVyIC0gMTApIC8gdGhpcy53b3JsZFJhZGl1czsgCgogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIHNpemUsIHNpemUpOwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIGRyYXcgZW50aXRpZXMKICAgICAgICAgICAgY29uc3QgZHJhd0VudGl0eSA9IChlbnRpdHksIGNvbG9yLCByYWRpdXMsIGlzUmluZyA9IGZhbHNlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWVudGl0eS5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNraXAgaWYgZXhwbGljaXRseSBpbnZpc2libGUgKGUuZy4gQmFsbCBpbnZpc2libGUgc2hvdCwgb3IgUHJhY3RpY2UgZHVtbWllcykKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuaXNJbnZpc2libGUpIHJldHVybjsKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkubWVzaC52aXNpYmxlID09PSBmYWxzZSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IGVudGl0eS5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBNYXAgTG9naWM6IC1aIGlzIFRvcCAoSG9tZSBBdHRhY2spLCArWiBpcyBCb3R0b20KICAgICAgICAgICAgICAgIC8vIENhbnZhczogMCwwIGlzIFRvcC1MZWZ0LgogICAgICAgICAgICAgICAgLy8gQ2VudGVyIGlzIDEwMCwxMDAuCiAgICAgICAgICAgICAgICAvLyBXb3JsZCBYIC0+IENhbnZhcyBYCiAgICAgICAgICAgICAgICAvLyBXb3JsZCBaIC0+IENhbnZhcyBZCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBkeCA9IHBvcy54ICogc2NhbGU7CiAgICAgICAgICAgICAgICBsZXQgZHkgPSBwb3MueiAqIHNjYWxlOwoKICAgICAgICAgICAgICAgIC8vIENsYW1wIHRvIGNpcmN1bGFyIGJvdW5kcwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKICAgICAgICAgICAgICAgIGNvbnN0IG1heERpc3QgPSBjZW50ZXIgLSByYWRpdXMgLSAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguYXRhbjIoZHksIGR4KTsKICAgICAgICAgICAgICAgICAgICBkeCA9IE1hdGguY29zKGFuZ2xlKSAqIG1heERpc3Q7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBNYXRoLnNpbihhbmdsZSkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBjZW50ZXIgKyBkeDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjZW50ZXIgKyBkeTsKCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIHJhZGl1cywgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNSaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIERyYXcgSG9tZSBUZWFtCiAgICAgICAgICAgIGlmICh0aGlzLmhvbWVUZWFtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmUgPSB0aGlzLmhvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5ob21lVGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuaG9tZVRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAnIzYwYzBkMCc7IC8vIEN5YW4KICAgICAgICAgICAgICAgICAgICBsZXQgciA9IDY7IC8vIDJ4IHNjYWxlIG9mIDNweAoKICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29sb3IgPSAnIzMzMzMzMyc7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHAgPT09IGFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICcjMDBmZjAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDg7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSAnI2ZmYWEwMCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHIgPSA3OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZHJhd0VudGl0eShwLCBjb2xvciwgcik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsICcjZmZmZmZmJywgciArIDIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBBd2F5IFRlYW0KICAgICAgICAgICAgaWYgKHRoaXMuYXdheVRlYW0pIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5hd2F5VGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuYXdheVRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAnI2ZmNDQ0NCc7CiAgICAgICAgICAgICAgICAgICAgbGV0IHIgPSA2OwoKICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29sb3IgPSAnIzMzMzMzMyc7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICcjZmZhYTAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDc7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsIGNvbG9yLCByKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsICcjZmZmZmZmJywgciArIDIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBCYWxsIChpZiBmcmVlKQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHRoaXMuYmFsbCwgJyNmZjAwY2MnLCA3KTsKICAgICAgICAgICAgICAgIGRyYXdFbnRpdHkodGhpcy5iYWxsLCAnI2ZmZmZmZicsIDksIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4Lk1pbmlNYXAgPSBNaW5pTWFwOwp9KSgpOw==","./MiniMap.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNaW5pTWFwIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcCcpOwogICAgICAgICAgICB0aGlzLmNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAvLyBPcHRpbWl6YXRpb246IGFscGhhOiB0cnVlIGlzIG5lZWRlZCBmb3IgdHJhbnNwYXJlbnQgYmFja2dyb3VuZAogICAgICAgICAgICB0aGlzLmN0eCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJywgeyBhbHBoYTogdHJ1ZSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhpZ2ggRFBJIHNjYWxpbmcgKDJ4IGZvciByZXRpbmEgc2hhcnBuZXNzIG9uIDEwMHB4IGNvbnRhaW5lcikKICAgICAgICAgICAgdGhpcy5zaXplID0gMjAwOyAKICAgICAgICAgICAgdGhpcy5jYW52YXMud2lkdGggPSB0aGlzLnNpemU7CiAgICAgICAgICAgIHRoaXMuY2FudmFzLmhlaWdodCA9IHRoaXMuc2l6ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5jYW52YXMuc3R5bGUsIHsKICAgICAgICAgICAgICAgIHdpZHRoOiAnMTAwJScsCiAgICAgICAgICAgICAgICBoZWlnaHQ6ICcxMDAlJywKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogJzUwJScsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAnYmxvY2snCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYW55IGV4aXN0aW5nIGNoaWxkcmVuIChlLmcuIGZyb20gcHJldmlvdXMgaW5pdHMpCiAgICAgICAgICAgICAgICB3aGlsZSAodGhpcy5jb250YWluZXIuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZUNoaWxkKHRoaXMuY29udGFpbmVyLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5jYW52YXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLndvcmxkUmFkaXVzID0gMzA7IC8vIEFyZW5hIHJhZGl1cwogICAgICAgICAgICB0aGlzLmhvbWVUZWFtID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hd2F5VGVhbSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpbml0KGhvbWVUZWFtLCBhd2F5VGVhbSwgYmFsbCkgewogICAgICAgICAgICB0aGlzLmhvbWVUZWFtID0gaG9tZVRlYW07CiAgICAgICAgICAgIHRoaXMuYXdheVRlYW0gPSBhd2F5VGVhbTsKICAgICAgICAgICAgdGhpcy5iYWxsID0gYmFsbDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmN0eCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICAgICAgICAgIGNvbnN0IHNpemUgPSB0aGlzLnNpemU7CiAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IHNpemUgLyAyOwogICAgICAgICAgICAvLyBNYXAgd29ybGQgcmFkaXVzICgzMCkgdG8gY2FudmFzIHJhZGl1cyAoYXBwcm94IDkwcHggdG8gbGVhdmUgcGFkZGluZykKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAoY2VudGVyIC0gMTApIC8gdGhpcy53b3JsZFJhZGl1czsgCgogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIHNpemUsIHNpemUpOwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIGRyYXcgZW50aXRpZXMKICAgICAgICAgICAgY29uc3QgZHJhd0VudGl0eSA9IChlbnRpdHksIGNvbG9yLCByYWRpdXMsIGlzUmluZyA9IGZhbHNlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWVudGl0eS5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNraXAgaWYgZXhwbGljaXRseSBpbnZpc2libGUgKGUuZy4gQmFsbCBpbnZpc2libGUgc2hvdCwgb3IgUHJhY3RpY2UgZHVtbWllcykKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuaXNJbnZpc2libGUpIHJldHVybjsKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkubWVzaC52aXNpYmxlID09PSBmYWxzZSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IGVudGl0eS5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBNYXAgTG9naWM6IC1aIGlzIFRvcCAoSG9tZSBBdHRhY2spLCArWiBpcyBCb3R0b20KICAgICAgICAgICAgICAgIC8vIENhbnZhczogMCwwIGlzIFRvcC1MZWZ0LgogICAgICAgICAgICAgICAgLy8gQ2VudGVyIGlzIDEwMCwxMDAuCiAgICAgICAgICAgICAgICAvLyBXb3JsZCBYIC0+IENhbnZhcyBYCiAgICAgICAgICAgICAgICAvLyBXb3JsZCBaIC0+IENhbnZhcyBZCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBkeCA9IHBvcy54ICogc2NhbGU7CiAgICAgICAgICAgICAgICBsZXQgZHkgPSBwb3MueiAqIHNjYWxlOwoKICAgICAgICAgICAgICAgIC8vIENsYW1wIHRvIGNpcmN1bGFyIGJvdW5kcwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKICAgICAgICAgICAgICAgIGNvbnN0IG1heERpc3QgPSBjZW50ZXIgLSByYWRpdXMgLSAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguYXRhbjIoZHksIGR4KTsKICAgICAgICAgICAgICAgICAgICBkeCA9IE1hdGguY29zKGFuZ2xlKSAqIG1heERpc3Q7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBNYXRoLnNpbihhbmdsZSkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBjZW50ZXIgKyBkeDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjZW50ZXIgKyBkeTsKCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIHJhZGl1cywgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNSaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIERyYXcgSG9tZSBUZWFtCiAgICAgICAgICAgIGlmICh0aGlzLmhvbWVUZWFtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmUgPSB0aGlzLmhvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5ob21lVGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuaG9tZVRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAnIzYwYzBkMCc7IC8vIEN5YW4KICAgICAgICAgICAgICAgICAgICBsZXQgciA9IDY7IC8vIDJ4IHNjYWxlIG9mIDNweAoKICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29sb3IgPSAnIzMzMzMzMyc7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHAgPT09IGFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICcjMDBmZjAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDg7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSAnI2ZmYWEwMCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHIgPSA3OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZHJhd0VudGl0eShwLCBjb2xvciwgcik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsICcjZmZmZmZmJywgciArIDIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBBd2F5IFRlYW0KICAgICAgICAgICAgaWYgKHRoaXMuYXdheVRlYW0pIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5hd2F5VGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuYXdheVRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAnI2ZmNDQ0NCc7CiAgICAgICAgICAgICAgICAgICAgbGV0IHIgPSA2OwoKICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29sb3IgPSAnIzMzMzMzMyc7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICcjZmZhYTAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDc7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsIGNvbG9yLCByKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsICcjZmZmZmZmJywgciArIDIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBCYWxsIChpZiBmcmVlKQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHRoaXMuYmFsbCwgJyNmZjAwY2MnLCA3KTsKICAgICAgICAgICAgICAgIGRyYXdFbnRpdHkodGhpcy5iYWxsLCAnI2ZmZmZmZicsIDksIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4Lk1pbmlNYXAgPSBNaW5pTWFwOwp9KSgpOw==","/MiniMap.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNaW5pTWFwIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcCcpOwogICAgICAgICAgICB0aGlzLmNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAvLyBPcHRpbWl6YXRpb246IGFscGhhOiB0cnVlIGlzIG5lZWRlZCBmb3IgdHJhbnNwYXJlbnQgYmFja2dyb3VuZAogICAgICAgICAgICB0aGlzLmN0eCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJywgeyBhbHBoYTogdHJ1ZSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhpZ2ggRFBJIHNjYWxpbmcgKDJ4IGZvciByZXRpbmEgc2hhcnBuZXNzIG9uIDEwMHB4IGNvbnRhaW5lcikKICAgICAgICAgICAgdGhpcy5zaXplID0gMjAwOyAKICAgICAgICAgICAgdGhpcy5jYW52YXMud2lkdGggPSB0aGlzLnNpemU7CiAgICAgICAgICAgIHRoaXMuY2FudmFzLmhlaWdodCA9IHRoaXMuc2l6ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5jYW52YXMuc3R5bGUsIHsKICAgICAgICAgICAgICAgIHdpZHRoOiAnMTAwJScsCiAgICAgICAgICAgICAgICBoZWlnaHQ6ICcxMDAlJywKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogJzUwJScsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAnYmxvY2snCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYW55IGV4aXN0aW5nIGNoaWxkcmVuIChlLmcuIGZyb20gcHJldmlvdXMgaW5pdHMpCiAgICAgICAgICAgICAgICB3aGlsZSAodGhpcy5jb250YWluZXIuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZUNoaWxkKHRoaXMuY29udGFpbmVyLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5jYW52YXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLndvcmxkUmFkaXVzID0gMzA7IC8vIEFyZW5hIHJhZGl1cwogICAgICAgICAgICB0aGlzLmhvbWVUZWFtID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hd2F5VGVhbSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuYmFsbCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpbml0KGhvbWVUZWFtLCBhd2F5VGVhbSwgYmFsbCkgewogICAgICAgICAgICB0aGlzLmhvbWVUZWFtID0gaG9tZVRlYW07CiAgICAgICAgICAgIHRoaXMuYXdheVRlYW0gPSBhd2F5VGVhbTsKICAgICAgICAgICAgdGhpcy5iYWxsID0gYmFsbDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZSgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmN0eCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICAgICAgICAgIGNvbnN0IHNpemUgPSB0aGlzLnNpemU7CiAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IHNpemUgLyAyOwogICAgICAgICAgICAvLyBNYXAgd29ybGQgcmFkaXVzICgzMCkgdG8gY2FudmFzIHJhZGl1cyAoYXBwcm94IDkwcHggdG8gbGVhdmUgcGFkZGluZykKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAoY2VudGVyIC0gMTApIC8gdGhpcy53b3JsZFJhZGl1czsgCgogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIHNpemUsIHNpemUpOwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIGRyYXcgZW50aXRpZXMKICAgICAgICAgICAgY29uc3QgZHJhd0VudGl0eSA9IChlbnRpdHksIGNvbG9yLCByYWRpdXMsIGlzUmluZyA9IGZhbHNlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWVudGl0eS5tZXNoKSByZXR1cm47CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNraXAgaWYgZXhwbGljaXRseSBpbnZpc2libGUgKGUuZy4gQmFsbCBpbnZpc2libGUgc2hvdCwgb3IgUHJhY3RpY2UgZHVtbWllcykKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkuaXNJbnZpc2libGUpIHJldHVybjsKICAgICAgICAgICAgICAgIGlmIChlbnRpdHkubWVzaC52aXNpYmxlID09PSBmYWxzZSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IGVudGl0eS5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBNYXAgTG9naWM6IC1aIGlzIFRvcCAoSG9tZSBBdHRhY2spLCArWiBpcyBCb3R0b20KICAgICAgICAgICAgICAgIC8vIENhbnZhczogMCwwIGlzIFRvcC1MZWZ0LgogICAgICAgICAgICAgICAgLy8gQ2VudGVyIGlzIDEwMCwxMDAuCiAgICAgICAgICAgICAgICAvLyBXb3JsZCBYIC0+IENhbnZhcyBYCiAgICAgICAgICAgICAgICAvLyBXb3JsZCBaIC0+IENhbnZhcyBZCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBkeCA9IHBvcy54ICogc2NhbGU7CiAgICAgICAgICAgICAgICBsZXQgZHkgPSBwb3MueiAqIHNjYWxlOwoKICAgICAgICAgICAgICAgIC8vIENsYW1wIHRvIGNpcmN1bGFyIGJvdW5kcwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKICAgICAgICAgICAgICAgIGNvbnN0IG1heERpc3QgPSBjZW50ZXIgLSByYWRpdXMgLSAyOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IG1heERpc3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IE1hdGguYXRhbjIoZHksIGR4KTsKICAgICAgICAgICAgICAgICAgICBkeCA9IE1hdGguY29zKGFuZ2xlKSAqIG1heERpc3Q7CiAgICAgICAgICAgICAgICAgICAgZHkgPSBNYXRoLnNpbihhbmdsZSkgKiBtYXhEaXN0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBjZW50ZXIgKyBkeDsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjZW50ZXIgKyBkeTsKCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHgsIHksIHJhZGl1cywgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaXNSaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIERyYXcgSG9tZSBUZWFtCiAgICAgICAgICAgIGlmICh0aGlzLmhvbWVUZWFtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmUgPSB0aGlzLmhvbWVUZWFtLmFjdGl2ZVBsYXllcjsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5ob21lVGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuaG9tZVRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAnIzYwYzBkMCc7IC8vIEN5YW4KICAgICAgICAgICAgICAgICAgICBsZXQgciA9IDY7IC8vIDJ4IHNjYWxlIG9mIDNweAoKICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29sb3IgPSAnIzMzMzMzMyc7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHAgPT09IGFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICcjMDBmZjAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDg7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwLmhhc0JhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSAnI2ZmYWEwMCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHIgPSA3OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZHJhd0VudGl0eShwLCBjb2xvciwgcik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsICcjZmZmZmZmJywgciArIDIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBBd2F5IFRlYW0KICAgICAgICAgICAgaWYgKHRoaXMuYXdheVRlYW0pIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5hd2F5VGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuYXdheVRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAnI2ZmNDQ0NCc7CiAgICAgICAgICAgICAgICAgICAgbGV0IHIgPSA2OwoKICAgICAgICAgICAgICAgICAgICBpZiAocC5zdGF0dXMgJiYgcC5zdGF0dXMubmFwID4gMCkgY29sb3IgPSAnIzMzMzMzMyc7CiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICcjZmZhYTAwJzsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IDc7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsIGNvbG9yLCByKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHAsICcjZmZmZmZmJywgciArIDIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBCYWxsIChpZiBmcmVlKQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICBkcmF3RW50aXR5KHRoaXMuYmFsbCwgJyNmZjAwY2MnLCA3KTsKICAgICAgICAgICAgICAgIGRyYXdFbnRpdHkodGhpcy5iYWxsLCAnI2ZmZmZmZicsIDksIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4Lk1pbmlNYXAgPSBNaW5pTWFwOwp9KSgpOw==","FloatingTextManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBGbG9hdGluZ1RleHRNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgY29udGFpbmVySWQsIGNhbWVyYSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKTsKICAgICAgICAgICAgdGhpcy50ZXh0cyA9IFtdOyAvLyBBY3RpdmUgaW5zdGFuY2VzCiAgICAgICAgICAgIHRoaXMucG9vbCA9IFtdOyAgLy8gSW5hY3RpdmUgaW5zdGFuY2VzCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXVzYWJsZSB2ZWN0b3IgZm9yIHByb2plY3Rpb24KICAgICAgICAgICAgdGhpcy5fdGVtcFYgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gUHJlLWFsbG9jYXRlIHBvb2wgKDMwIGVsZW1lbnRzKQogICAgICAgICAgICB0aGlzLl9leHBhbmRQb29sKDMwKTsKICAgICAgICB9CgogICAgICAgIF9leHBhbmRQb29sKGNvdW50KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgICB3cmFwcGVyLmNsYXNzTmFtZSA9ICdmbG9hdGluZy10ZXh0LXdyYXBwZXInOwogICAgICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgLy8gRm9yY2UgaGFyZHdhcmUgYWNjZWxlcmF0aW9uIGhpbnQKICAgICAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUud2lsbENoYW5nZSA9ICd0cmFuc2Zvcm0sIG9wYWNpdHknOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgICAgIGlubmVyLmNsYXNzTmFtZSA9ICdmbG9hdGluZy10ZXh0LWlubmVyJzsKICAgICAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaW5uZXIpOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgogICAgICAgICAgICAgICAgdGhpcy5wb29sLnB1c2goewogICAgICAgICAgICAgICAgICAgIGVsOiB3cmFwcGVyLAogICAgICAgICAgICAgICAgICAgIGlubmVyOiBpbm5lciwKICAgICAgICAgICAgICAgICAgICB3b3JsZFBvczogbmV3IFRIUkVFLlZlY3RvcjMoKSwKICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgZ3Jhdml0eTogMCwKICAgICAgICAgICAgICAgICAgICBkcmFnOiAwLAogICAgICAgICAgICAgICAgICAgIGVsYXN0aWNpdHk6IDAuNiwKICAgICAgICAgICAgICAgICAgICBmbG9vclk6IC05OTksCiAgICAgICAgICAgICAgICAgICAgbGlmZTogMCwKICAgICAgICAgICAgICAgICAgICBtYXhMaWZlOiAxLjAsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBudWxsCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odGV4dCwgd29ybGRQb3MsIHR5cGUgPSAnZGVmYXVsdCcsIHRhcmdldCA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmNvbnRhaW5lciB8fCAhdGhpcy5jYW1lcmEpIHJldHVybjsKCiAgICAgICAgICAgIGxldCBpbnN0YW5jZSA9IHRoaXMucG9vbC5wb3AoKTsKICAgICAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgICAgICAgdGhpcy5fZXhwYW5kUG9vbCg1KTsKICAgICAgICAgICAgICAgIGluc3RhbmNlID0gdGhpcy5wb29sLnBvcCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBTdGF0ZQogICAgICAgICAgICBpbnN0YW5jZS53b3JsZFBvcy5jb3B5KHdvcmxkUG9zKTsKICAgICAgICAgICAgaW5zdGFuY2Uub2Zmc2V0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgaW5zdGFuY2UuZHJhZyA9IDA7CiAgICAgICAgICAgIGluc3RhbmNlLmVsYXN0aWNpdHkgPSAwLjY7CiAgICAgICAgICAgIGluc3RhbmNlLmZsb29yWSA9IC05OTk7CiAgICAgICAgICAgIGluc3RhbmNlLnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgaW5zdGFuY2UuZWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIGluc3RhbmNlLmVsLnN0eWxlLm9wYWNpdHkgPSAnMSc7CiAgICAgICAgICAgIC8vIE1vdmUgb2Zmc2NyZWVuIGluaXRpYWxseSB0byBwcmV2ZW50IGZsYXNoCiAgICAgICAgICAgIGluc3RhbmNlLmVsLnN0eWxlLnRyYW5zZm9ybSA9ICd0cmFuc2xhdGUzZCgtOTk5OXB4LCAtOTk5OXB4LCAwKSc7IAoKICAgICAgICAgICAgLy8gVXBkYXRlIFRleHQgJiBDbGFzc2VzCiAgICAgICAgICAgIGluc3RhbmNlLmlubmVyLmlubmVyVGV4dCA9IHRleHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTbWFydCBDbGFzcyBBc3NpZ25tZW50CiAgICAgICAgICAgIGxldCBjbGFzc2VzID0gWydmbG9hdGluZy10ZXh0LWlubmVyJ107CiAgICAgICAgICAgIGNsYXNzZXMucHVzaCh0eXBlKTsKCiAgICAgICAgICAgIGNvbnN0IHVwcGVyID0gdGV4dC50b1N0cmluZygpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgIGlmICh1cHBlci5pbmNsdWRlcygnUE9JU09OJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1ZFTk9NJykpIGNsYXNzZXMucHVzaCgndmVub20nKTsKICAgICAgICAgICAgZWxzZSBpZiAodXBwZXIuaW5jbHVkZXMoJ1NMRUVQJykgfHwgdXBwZXIuaW5jbHVkZXMoJ05BUCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdaWlonKSkgY2xhc3Nlcy5wdXNoKCdzbGVlcCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnV0lUSEVSJykpIGNsYXNzZXMucHVzaCgnd2l0aGVyJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICd0ZWNoJyB8fCB1cHBlci5pbmNsdWRlcygnU0hPVCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdKRUNIVCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdUQUNLTEUnKSkgY2xhc3Nlcy5wdXNoKCd0ZWNoJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdjb21pYy1pbXBhY3QnKSBjbGFzc2VzLnB1c2goJ2NvbWljLWltcGFjdCcpOwogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnY29taWMtYWN0aW9uJykgY2xhc3Nlcy5wdXNoKCdjb21pYy1hY3Rpb24nKTsKICAgICAgICAgICAgZWxzZSBpZiAoIWlzTmFOKHBhcnNlSW50KHRleHQpKSAmJiB0eXBlICE9PSAnc2NvcmUnKSBjbGFzc2VzLnB1c2goJ2RhbWFnZScpOwogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnc2F2ZScgfHwgdHlwZSA9PT0gJ2Jsb2NrJykgY2xhc3Nlcy5wdXNoKCdzYXZlJyk7CgogICAgICAgICAgICBpbnN0YW5jZS5pbm5lci5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oJyAnKTsKCiAgICAgICAgICAgIC8vIFBoeXNpY3MgU2V0dXAKICAgICAgICAgICAgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ2RhbWFnZScpIHx8IGNsYXNzZXMuaW5jbHVkZXMoJ3NhdmUnKSB8fCBjbGFzc2VzLmluY2x1ZGVzKCdibG9jaycpKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS50YXJnZXQgPSBudWxsOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDQwLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5kcmFnID0gMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UuZmxvb3JZID0gLTQuMDsKICAgICAgICAgICAgICAgIGNvbnN0IHNwcmVhZCA9IDYuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzcHJlYWQsCiAgICAgICAgICAgICAgICAgICAgMTUuMCArIE1hdGgucmFuZG9tKCkgKiA1LjAsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc3ByZWFkCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAyLjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnY29taWMtaW1wYWN0JykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMiwgMS4wLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIpOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDAuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAwLjU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnY29taWMtYWN0aW9uJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDIuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMC40OwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDAuNDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCd0ZWNoJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDIuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm9mZnNldC55ID0gMi4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3NsZWVwJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAtMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAuNSwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMy4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDMuMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAzLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDUuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAxLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMS4wOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXRhcmdldCkgewogICAgICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS53b3JsZFBvcy56ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0YW5jZS53b3JsZFBvcy55ICs9IDEuMDsKCiAgICAgICAgICAgIHRoaXMudGV4dHMucHVzaChpbnN0YW5jZSk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUG9zaXRpb24oaW5zdGFuY2UpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLnRleHRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gdGhpcy50ZXh0c1tpXTsKICAgICAgICAgICAgICAgIHQubGlmZSAtPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAodC50YXJnZXQgJiYgdC50YXJnZXQucGFyZW50KSB7IAogICAgICAgICAgICAgICAgICAgIHQud29ybGRQb3MuY29weSh0LnRhcmdldC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdC53b3JsZFBvcy55ICs9IDEuMDsgCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHQuZ3Jhdml0eSAhPT0gMCB8fCB0LnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdC52ZWxvY2l0eS55IC09IHQuZ3Jhdml0eSAqIGR0OwogICAgICAgICAgICAgICAgICAgIGlmICh0LmRyYWcgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgoMCwgMS4wIC0gKHQuZHJhZyAqIGR0KSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0Lm9mZnNldC5hZGRTY2FsZWRWZWN0b3IodC52ZWxvY2l0eSwgZHQpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodC5vZmZzZXQueSA8IHQuZmxvb3JZKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQub2Zmc2V0LnkgPSB0LmZsb29yWTsKICAgICAgICAgICAgICAgICAgICAgICAgdC52ZWxvY2l0eS55ICo9IC10LmVsYXN0aWNpdHk7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueCAqPSAwLjc7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueiAqPSAwLjc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyh0LnZlbG9jaXR5LnkpIDwgMi4wKSB0LnZlbG9jaXR5LnkgPSAwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodC5saWZlIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0LmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wb29sLnB1c2godCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZXh0cy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlUG9zaXRpb24odCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQubGlmZSA8IHQubWF4TGlmZSAqIDAuMykgewogICAgICAgICAgICAgICAgICAgICAgICB0LmVsLnN0eWxlLm9wYWNpdHkgPSB0LmxpZmUgLyAodC5tYXhMaWZlICogMC4zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZVBvc2l0aW9uKHQpIHsKICAgICAgICAgICAgdGhpcy5fdGVtcFYuY29weSh0LndvcmxkUG9zKS5hZGQodC5vZmZzZXQpOwogICAgICAgICAgICB0aGlzLl90ZW1wVi5wcm9qZWN0KHRoaXMuY2FtZXJhKTsKCiAgICAgICAgICAgIC8vIE9wdGltaXphdGlvbjogQ2hlY2sgYm91bmRzIGJlZm9yZSBzZXR0aW5nIHN0eWxlIHRvIGF2b2lkIHVubmVjZXNzYXJ5IHBhaW50CiAgICAgICAgICAgIGlmICh0aGlzLl90ZW1wVi56ID4gMSB8fCBNYXRoLmFicyh0aGlzLl90ZW1wVi54KSA+IDEuMSB8fCBNYXRoLmFicyh0aGlzLl90ZW1wVi55KSA+IDEuMSkgewogICAgICAgICAgICAgICAgIC8vIE9mZnNjcmVlbgogICAgICAgICAgICAgICAgIGlmICh0LmVsLnN0eWxlLmRpc3BsYXkgIT09ICdub25lJykgdC5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHQuZWwuc3R5bGUuZGlzcGxheSA9PT0gJ25vbmUnKSB0LmVsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB4ID0gKHRoaXMuX3RlbXBWLnggKiAuNSArIC41KSAqIHRoaXMuY29udGFpbmVyLmNsaWVudFdpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgeSA9ICgtKHRoaXMuX3RlbXBWLnkgKiAuNSkgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRIZWlnaHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFVzZSB0cmFuc2xhdGUzZCBmb3IgR1BVIGFjY2VsZXJhdGlvbgogICAgICAgICAgICAgICAgdC5lbC5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlM2QoJHt4LnRvRml4ZWQoMSl9cHgsICR7eS50b0ZpeGVkKDEpfXB4LCAwKWA7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguRmxvYXRpbmdUZXh0TWFuYWdlciA9IEZsb2F0aW5nVGV4dE1hbmFnZXI7Cn0pKCk7","./FloatingTextManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBGbG9hdGluZ1RleHRNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgY29udGFpbmVySWQsIGNhbWVyYSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKTsKICAgICAgICAgICAgdGhpcy50ZXh0cyA9IFtdOyAvLyBBY3RpdmUgaW5zdGFuY2VzCiAgICAgICAgICAgIHRoaXMucG9vbCA9IFtdOyAgLy8gSW5hY3RpdmUgaW5zdGFuY2VzCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXVzYWJsZSB2ZWN0b3IgZm9yIHByb2plY3Rpb24KICAgICAgICAgICAgdGhpcy5fdGVtcFYgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gUHJlLWFsbG9jYXRlIHBvb2wgKDMwIGVsZW1lbnRzKQogICAgICAgICAgICB0aGlzLl9leHBhbmRQb29sKDMwKTsKICAgICAgICB9CgogICAgICAgIF9leHBhbmRQb29sKGNvdW50KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgICB3cmFwcGVyLmNsYXNzTmFtZSA9ICdmbG9hdGluZy10ZXh0LXdyYXBwZXInOwogICAgICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgLy8gRm9yY2UgaGFyZHdhcmUgYWNjZWxlcmF0aW9uIGhpbnQKICAgICAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUud2lsbENoYW5nZSA9ICd0cmFuc2Zvcm0sIG9wYWNpdHknOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgICAgIGlubmVyLmNsYXNzTmFtZSA9ICdmbG9hdGluZy10ZXh0LWlubmVyJzsKICAgICAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaW5uZXIpOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgogICAgICAgICAgICAgICAgdGhpcy5wb29sLnB1c2goewogICAgICAgICAgICAgICAgICAgIGVsOiB3cmFwcGVyLAogICAgICAgICAgICAgICAgICAgIGlubmVyOiBpbm5lciwKICAgICAgICAgICAgICAgICAgICB3b3JsZFBvczogbmV3IFRIUkVFLlZlY3RvcjMoKSwKICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgZ3Jhdml0eTogMCwKICAgICAgICAgICAgICAgICAgICBkcmFnOiAwLAogICAgICAgICAgICAgICAgICAgIGVsYXN0aWNpdHk6IDAuNiwKICAgICAgICAgICAgICAgICAgICBmbG9vclk6IC05OTksCiAgICAgICAgICAgICAgICAgICAgbGlmZTogMCwKICAgICAgICAgICAgICAgICAgICBtYXhMaWZlOiAxLjAsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBudWxsCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odGV4dCwgd29ybGRQb3MsIHR5cGUgPSAnZGVmYXVsdCcsIHRhcmdldCA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmNvbnRhaW5lciB8fCAhdGhpcy5jYW1lcmEpIHJldHVybjsKCiAgICAgICAgICAgIGxldCBpbnN0YW5jZSA9IHRoaXMucG9vbC5wb3AoKTsKICAgICAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgICAgICAgdGhpcy5fZXhwYW5kUG9vbCg1KTsKICAgICAgICAgICAgICAgIGluc3RhbmNlID0gdGhpcy5wb29sLnBvcCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBTdGF0ZQogICAgICAgICAgICBpbnN0YW5jZS53b3JsZFBvcy5jb3B5KHdvcmxkUG9zKTsKICAgICAgICAgICAgaW5zdGFuY2Uub2Zmc2V0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgaW5zdGFuY2UuZHJhZyA9IDA7CiAgICAgICAgICAgIGluc3RhbmNlLmVsYXN0aWNpdHkgPSAwLjY7CiAgICAgICAgICAgIGluc3RhbmNlLmZsb29yWSA9IC05OTk7CiAgICAgICAgICAgIGluc3RhbmNlLnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgaW5zdGFuY2UuZWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIGluc3RhbmNlLmVsLnN0eWxlLm9wYWNpdHkgPSAnMSc7CiAgICAgICAgICAgIC8vIE1vdmUgb2Zmc2NyZWVuIGluaXRpYWxseSB0byBwcmV2ZW50IGZsYXNoCiAgICAgICAgICAgIGluc3RhbmNlLmVsLnN0eWxlLnRyYW5zZm9ybSA9ICd0cmFuc2xhdGUzZCgtOTk5OXB4LCAtOTk5OXB4LCAwKSc7IAoKICAgICAgICAgICAgLy8gVXBkYXRlIFRleHQgJiBDbGFzc2VzCiAgICAgICAgICAgIGluc3RhbmNlLmlubmVyLmlubmVyVGV4dCA9IHRleHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTbWFydCBDbGFzcyBBc3NpZ25tZW50CiAgICAgICAgICAgIGxldCBjbGFzc2VzID0gWydmbG9hdGluZy10ZXh0LWlubmVyJ107CiAgICAgICAgICAgIGNsYXNzZXMucHVzaCh0eXBlKTsKCiAgICAgICAgICAgIGNvbnN0IHVwcGVyID0gdGV4dC50b1N0cmluZygpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgIGlmICh1cHBlci5pbmNsdWRlcygnUE9JU09OJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1ZFTk9NJykpIGNsYXNzZXMucHVzaCgndmVub20nKTsKICAgICAgICAgICAgZWxzZSBpZiAodXBwZXIuaW5jbHVkZXMoJ1NMRUVQJykgfHwgdXBwZXIuaW5jbHVkZXMoJ05BUCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdaWlonKSkgY2xhc3Nlcy5wdXNoKCdzbGVlcCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnV0lUSEVSJykpIGNsYXNzZXMucHVzaCgnd2l0aGVyJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICd0ZWNoJyB8fCB1cHBlci5pbmNsdWRlcygnU0hPVCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdKRUNIVCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdUQUNLTEUnKSkgY2xhc3Nlcy5wdXNoKCd0ZWNoJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdjb21pYy1pbXBhY3QnKSBjbGFzc2VzLnB1c2goJ2NvbWljLWltcGFjdCcpOwogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnY29taWMtYWN0aW9uJykgY2xhc3Nlcy5wdXNoKCdjb21pYy1hY3Rpb24nKTsKICAgICAgICAgICAgZWxzZSBpZiAoIWlzTmFOKHBhcnNlSW50KHRleHQpKSAmJiB0eXBlICE9PSAnc2NvcmUnKSBjbGFzc2VzLnB1c2goJ2RhbWFnZScpOwogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnc2F2ZScgfHwgdHlwZSA9PT0gJ2Jsb2NrJykgY2xhc3Nlcy5wdXNoKCdzYXZlJyk7CgogICAgICAgICAgICBpbnN0YW5jZS5pbm5lci5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oJyAnKTsKCiAgICAgICAgICAgIC8vIFBoeXNpY3MgU2V0dXAKICAgICAgICAgICAgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ2RhbWFnZScpIHx8IGNsYXNzZXMuaW5jbHVkZXMoJ3NhdmUnKSB8fCBjbGFzc2VzLmluY2x1ZGVzKCdibG9jaycpKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS50YXJnZXQgPSBudWxsOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDQwLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5kcmFnID0gMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UuZmxvb3JZID0gLTQuMDsKICAgICAgICAgICAgICAgIGNvbnN0IHNwcmVhZCA9IDYuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzcHJlYWQsCiAgICAgICAgICAgICAgICAgICAgMTUuMCArIE1hdGgucmFuZG9tKCkgKiA1LjAsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc3ByZWFkCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAyLjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnY29taWMtaW1wYWN0JykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMiwgMS4wLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIpOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDAuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAwLjU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnY29taWMtYWN0aW9uJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDIuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMC40OwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDAuNDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCd0ZWNoJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDIuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm9mZnNldC55ID0gMi4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3NsZWVwJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAtMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAuNSwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMy4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDMuMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAzLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDUuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAxLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMS4wOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXRhcmdldCkgewogICAgICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS53b3JsZFBvcy56ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0YW5jZS53b3JsZFBvcy55ICs9IDEuMDsKCiAgICAgICAgICAgIHRoaXMudGV4dHMucHVzaChpbnN0YW5jZSk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUG9zaXRpb24oaW5zdGFuY2UpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLnRleHRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gdGhpcy50ZXh0c1tpXTsKICAgICAgICAgICAgICAgIHQubGlmZSAtPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAodC50YXJnZXQgJiYgdC50YXJnZXQucGFyZW50KSB7IAogICAgICAgICAgICAgICAgICAgIHQud29ybGRQb3MuY29weSh0LnRhcmdldC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdC53b3JsZFBvcy55ICs9IDEuMDsgCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHQuZ3Jhdml0eSAhPT0gMCB8fCB0LnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdC52ZWxvY2l0eS55IC09IHQuZ3Jhdml0eSAqIGR0OwogICAgICAgICAgICAgICAgICAgIGlmICh0LmRyYWcgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgoMCwgMS4wIC0gKHQuZHJhZyAqIGR0KSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0Lm9mZnNldC5hZGRTY2FsZWRWZWN0b3IodC52ZWxvY2l0eSwgZHQpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodC5vZmZzZXQueSA8IHQuZmxvb3JZKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQub2Zmc2V0LnkgPSB0LmZsb29yWTsKICAgICAgICAgICAgICAgICAgICAgICAgdC52ZWxvY2l0eS55ICo9IC10LmVsYXN0aWNpdHk7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueCAqPSAwLjc7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueiAqPSAwLjc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyh0LnZlbG9jaXR5LnkpIDwgMi4wKSB0LnZlbG9jaXR5LnkgPSAwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodC5saWZlIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0LmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wb29sLnB1c2godCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZXh0cy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlUG9zaXRpb24odCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQubGlmZSA8IHQubWF4TGlmZSAqIDAuMykgewogICAgICAgICAgICAgICAgICAgICAgICB0LmVsLnN0eWxlLm9wYWNpdHkgPSB0LmxpZmUgLyAodC5tYXhMaWZlICogMC4zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZVBvc2l0aW9uKHQpIHsKICAgICAgICAgICAgdGhpcy5fdGVtcFYuY29weSh0LndvcmxkUG9zKS5hZGQodC5vZmZzZXQpOwogICAgICAgICAgICB0aGlzLl90ZW1wVi5wcm9qZWN0KHRoaXMuY2FtZXJhKTsKCiAgICAgICAgICAgIC8vIE9wdGltaXphdGlvbjogQ2hlY2sgYm91bmRzIGJlZm9yZSBzZXR0aW5nIHN0eWxlIHRvIGF2b2lkIHVubmVjZXNzYXJ5IHBhaW50CiAgICAgICAgICAgIGlmICh0aGlzLl90ZW1wVi56ID4gMSB8fCBNYXRoLmFicyh0aGlzLl90ZW1wVi54KSA+IDEuMSB8fCBNYXRoLmFicyh0aGlzLl90ZW1wVi55KSA+IDEuMSkgewogICAgICAgICAgICAgICAgIC8vIE9mZnNjcmVlbgogICAgICAgICAgICAgICAgIGlmICh0LmVsLnN0eWxlLmRpc3BsYXkgIT09ICdub25lJykgdC5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHQuZWwuc3R5bGUuZGlzcGxheSA9PT0gJ25vbmUnKSB0LmVsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB4ID0gKHRoaXMuX3RlbXBWLnggKiAuNSArIC41KSAqIHRoaXMuY29udGFpbmVyLmNsaWVudFdpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgeSA9ICgtKHRoaXMuX3RlbXBWLnkgKiAuNSkgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRIZWlnaHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFVzZSB0cmFuc2xhdGUzZCBmb3IgR1BVIGFjY2VsZXJhdGlvbgogICAgICAgICAgICAgICAgdC5lbC5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlM2QoJHt4LnRvRml4ZWQoMSl9cHgsICR7eS50b0ZpeGVkKDEpfXB4LCAwKWA7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguRmxvYXRpbmdUZXh0TWFuYWdlciA9IEZsb2F0aW5nVGV4dE1hbmFnZXI7Cn0pKCk7","/FloatingTextManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBGbG9hdGluZ1RleHRNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSwgY29udGFpbmVySWQsIGNhbWVyYSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKTsKICAgICAgICAgICAgdGhpcy50ZXh0cyA9IFtdOyAvLyBBY3RpdmUgaW5zdGFuY2VzCiAgICAgICAgICAgIHRoaXMucG9vbCA9IFtdOyAgLy8gSW5hY3RpdmUgaW5zdGFuY2VzCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXVzYWJsZSB2ZWN0b3IgZm9yIHByb2plY3Rpb24KICAgICAgICAgICAgdGhpcy5fdGVtcFYgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gUHJlLWFsbG9jYXRlIHBvb2wgKDMwIGVsZW1lbnRzKQogICAgICAgICAgICB0aGlzLl9leHBhbmRQb29sKDMwKTsKICAgICAgICB9CgogICAgICAgIF9leHBhbmRQb29sKGNvdW50KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIpIHJldHVybjsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgICB3cmFwcGVyLmNsYXNzTmFtZSA9ICdmbG9hdGluZy10ZXh0LXdyYXBwZXInOwogICAgICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgLy8gRm9yY2UgaGFyZHdhcmUgYWNjZWxlcmF0aW9uIGhpbnQKICAgICAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUud2lsbENoYW5nZSA9ICd0cmFuc2Zvcm0sIG9wYWNpdHknOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgICAgIGlubmVyLmNsYXNzTmFtZSA9ICdmbG9hdGluZy10ZXh0LWlubmVyJzsKICAgICAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaW5uZXIpOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgogICAgICAgICAgICAgICAgdGhpcy5wb29sLnB1c2goewogICAgICAgICAgICAgICAgICAgIGVsOiB3cmFwcGVyLAogICAgICAgICAgICAgICAgICAgIGlubmVyOiBpbm5lciwKICAgICAgICAgICAgICAgICAgICB3b3JsZFBvczogbmV3IFRIUkVFLlZlY3RvcjMoKSwKICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgZ3Jhdml0eTogMCwKICAgICAgICAgICAgICAgICAgICBkcmFnOiAwLAogICAgICAgICAgICAgICAgICAgIGVsYXN0aWNpdHk6IDAuNiwKICAgICAgICAgICAgICAgICAgICBmbG9vclk6IC05OTksCiAgICAgICAgICAgICAgICAgICAgbGlmZTogMCwKICAgICAgICAgICAgICAgICAgICBtYXhMaWZlOiAxLjAsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBudWxsCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odGV4dCwgd29ybGRQb3MsIHR5cGUgPSAnZGVmYXVsdCcsIHRhcmdldCA9IG51bGwpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmNvbnRhaW5lciB8fCAhdGhpcy5jYW1lcmEpIHJldHVybjsKCiAgICAgICAgICAgIGxldCBpbnN0YW5jZSA9IHRoaXMucG9vbC5wb3AoKTsKICAgICAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgICAgICAgdGhpcy5fZXhwYW5kUG9vbCg1KTsKICAgICAgICAgICAgICAgIGluc3RhbmNlID0gdGhpcy5wb29sLnBvcCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXNldCBTdGF0ZQogICAgICAgICAgICBpbnN0YW5jZS53b3JsZFBvcy5jb3B5KHdvcmxkUG9zKTsKICAgICAgICAgICAgaW5zdGFuY2Uub2Zmc2V0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICAgICAgICBpbnN0YW5jZS5ncmF2aXR5ID0gMDsKICAgICAgICAgICAgaW5zdGFuY2UuZHJhZyA9IDA7CiAgICAgICAgICAgIGluc3RhbmNlLmVsYXN0aWNpdHkgPSAwLjY7CiAgICAgICAgICAgIGluc3RhbmNlLmZsb29yWSA9IC05OTk7CiAgICAgICAgICAgIGluc3RhbmNlLnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgaW5zdGFuY2UuZWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIGluc3RhbmNlLmVsLnN0eWxlLm9wYWNpdHkgPSAnMSc7CiAgICAgICAgICAgIC8vIE1vdmUgb2Zmc2NyZWVuIGluaXRpYWxseSB0byBwcmV2ZW50IGZsYXNoCiAgICAgICAgICAgIGluc3RhbmNlLmVsLnN0eWxlLnRyYW5zZm9ybSA9ICd0cmFuc2xhdGUzZCgtOTk5OXB4LCAtOTk5OXB4LCAwKSc7IAoKICAgICAgICAgICAgLy8gVXBkYXRlIFRleHQgJiBDbGFzc2VzCiAgICAgICAgICAgIGluc3RhbmNlLmlubmVyLmlubmVyVGV4dCA9IHRleHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTbWFydCBDbGFzcyBBc3NpZ25tZW50CiAgICAgICAgICAgIGxldCBjbGFzc2VzID0gWydmbG9hdGluZy10ZXh0LWlubmVyJ107CiAgICAgICAgICAgIGNsYXNzZXMucHVzaCh0eXBlKTsKCiAgICAgICAgICAgIGNvbnN0IHVwcGVyID0gdGV4dC50b1N0cmluZygpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgIGlmICh1cHBlci5pbmNsdWRlcygnUE9JU09OJykgfHwgdXBwZXIuaW5jbHVkZXMoJ1ZFTk9NJykpIGNsYXNzZXMucHVzaCgndmVub20nKTsKICAgICAgICAgICAgZWxzZSBpZiAodXBwZXIuaW5jbHVkZXMoJ1NMRUVQJykgfHwgdXBwZXIuaW5jbHVkZXMoJ05BUCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdaWlonKSkgY2xhc3Nlcy5wdXNoKCdzbGVlcCcpOwogICAgICAgICAgICBlbHNlIGlmICh1cHBlci5pbmNsdWRlcygnV0lUSEVSJykpIGNsYXNzZXMucHVzaCgnd2l0aGVyJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICd0ZWNoJyB8fCB1cHBlci5pbmNsdWRlcygnU0hPVCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdKRUNIVCcpIHx8IHVwcGVyLmluY2x1ZGVzKCdUQUNLTEUnKSkgY2xhc3Nlcy5wdXNoKCd0ZWNoJyk7CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdjb21pYy1pbXBhY3QnKSBjbGFzc2VzLnB1c2goJ2NvbWljLWltcGFjdCcpOwogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnY29taWMtYWN0aW9uJykgY2xhc3Nlcy5wdXNoKCdjb21pYy1hY3Rpb24nKTsKICAgICAgICAgICAgZWxzZSBpZiAoIWlzTmFOKHBhcnNlSW50KHRleHQpKSAmJiB0eXBlICE9PSAnc2NvcmUnKSBjbGFzc2VzLnB1c2goJ2RhbWFnZScpOwogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnc2F2ZScgfHwgdHlwZSA9PT0gJ2Jsb2NrJykgY2xhc3Nlcy5wdXNoKCdzYXZlJyk7CgogICAgICAgICAgICBpbnN0YW5jZS5pbm5lci5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oJyAnKTsKCiAgICAgICAgICAgIC8vIFBoeXNpY3MgU2V0dXAKICAgICAgICAgICAgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ2RhbWFnZScpIHx8IGNsYXNzZXMuaW5jbHVkZXMoJ3NhdmUnKSB8fCBjbGFzc2VzLmluY2x1ZGVzKCdibG9jaycpKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS50YXJnZXQgPSBudWxsOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDQwLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5kcmFnID0gMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UuZmxvb3JZID0gLTQuMDsKICAgICAgICAgICAgICAgIGNvbnN0IHNwcmVhZCA9IDYuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzcHJlYWQsCiAgICAgICAgICAgICAgICAgICAgMTUuMCArIE1hdGgucmFuZG9tKCkgKiA1LjAsCiAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogc3ByZWFkCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAyLjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnY29taWMtaW1wYWN0JykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KChNYXRoLnJhbmRvbSgpLTAuNSkqMiwgMS4wLCAoTWF0aC5yYW5kb20oKS0wLjUpKjIpOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubGlmZSA9IDAuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm1heExpZmUgPSAwLjU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xhc3Nlcy5pbmNsdWRlcygnY29taWMtYWN0aW9uJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDIuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMC40OwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDAuNDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjbGFzc2VzLmluY2x1ZGVzKCd0ZWNoJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAwOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDIuMCwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMi41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDIuNTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLm9mZnNldC55ID0gMi4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsYXNzZXMuaW5jbHVkZXMoJ3NsZWVwJykpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmdyYXZpdHkgPSAtMC41OwogICAgICAgICAgICAgICAgaW5zdGFuY2UudmVsb2NpdHkuc2V0KDAsIDAuNSwgMCk7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5saWZlID0gMy4wOwogICAgICAgICAgICAgICAgaW5zdGFuY2UubWF4TGlmZSA9IDMuMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLnZlbG9jaXR5LnNldCgwLCAzLjAsIDApOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuZ3Jhdml0eSA9IDUuMDsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmxpZmUgPSAxLjA7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5tYXhMaWZlID0gMS4wOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXRhcmdldCkgewogICAgICAgICAgICAgICAgaW5zdGFuY2Uud29ybGRQb3MueCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjU7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS53b3JsZFBvcy56ICs9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0YW5jZS53b3JsZFBvcy55ICs9IDEuMDsKCiAgICAgICAgICAgIHRoaXMudGV4dHMucHVzaChpbnN0YW5jZSk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUG9zaXRpb24oaW5zdGFuY2UpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLnRleHRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gdGhpcy50ZXh0c1tpXTsKICAgICAgICAgICAgICAgIHQubGlmZSAtPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAodC50YXJnZXQgJiYgdC50YXJnZXQucGFyZW50KSB7IAogICAgICAgICAgICAgICAgICAgIHQud29ybGRQb3MuY29weSh0LnRhcmdldC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdC53b3JsZFBvcy55ICs9IDEuMDsgCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHQuZ3Jhdml0eSAhPT0gMCB8fCB0LnZlbG9jaXR5Lmxlbmd0aFNxKCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdC52ZWxvY2l0eS55IC09IHQuZ3Jhdml0eSAqIGR0OwogICAgICAgICAgICAgICAgICAgIGlmICh0LmRyYWcgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgoMCwgMS4wIC0gKHQuZHJhZyAqIGR0KSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0Lm9mZnNldC5hZGRTY2FsZWRWZWN0b3IodC52ZWxvY2l0eSwgZHQpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodC5vZmZzZXQueSA8IHQuZmxvb3JZKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQub2Zmc2V0LnkgPSB0LmZsb29yWTsKICAgICAgICAgICAgICAgICAgICAgICAgdC52ZWxvY2l0eS55ICo9IC10LmVsYXN0aWNpdHk7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueCAqPSAwLjc7CiAgICAgICAgICAgICAgICAgICAgICAgIHQudmVsb2NpdHkueiAqPSAwLjc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyh0LnZlbG9jaXR5LnkpIDwgMi4wKSB0LnZlbG9jaXR5LnkgPSAwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodC5saWZlIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0LmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wb29sLnB1c2godCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZXh0cy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlUG9zaXRpb24odCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQubGlmZSA8IHQubWF4TGlmZSAqIDAuMykgewogICAgICAgICAgICAgICAgICAgICAgICB0LmVsLnN0eWxlLm9wYWNpdHkgPSB0LmxpZmUgLyAodC5tYXhMaWZlICogMC4zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZVBvc2l0aW9uKHQpIHsKICAgICAgICAgICAgdGhpcy5fdGVtcFYuY29weSh0LndvcmxkUG9zKS5hZGQodC5vZmZzZXQpOwogICAgICAgICAgICB0aGlzLl90ZW1wVi5wcm9qZWN0KHRoaXMuY2FtZXJhKTsKCiAgICAgICAgICAgIC8vIE9wdGltaXphdGlvbjogQ2hlY2sgYm91bmRzIGJlZm9yZSBzZXR0aW5nIHN0eWxlIHRvIGF2b2lkIHVubmVjZXNzYXJ5IHBhaW50CiAgICAgICAgICAgIGlmICh0aGlzLl90ZW1wVi56ID4gMSB8fCBNYXRoLmFicyh0aGlzLl90ZW1wVi54KSA+IDEuMSB8fCBNYXRoLmFicyh0aGlzLl90ZW1wVi55KSA+IDEuMSkgewogICAgICAgICAgICAgICAgIC8vIE9mZnNjcmVlbgogICAgICAgICAgICAgICAgIGlmICh0LmVsLnN0eWxlLmRpc3BsYXkgIT09ICdub25lJykgdC5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHQuZWwuc3R5bGUuZGlzcGxheSA9PT0gJ25vbmUnKSB0LmVsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCB4ID0gKHRoaXMuX3RlbXBWLnggKiAuNSArIC41KSAqIHRoaXMuY29udGFpbmVyLmNsaWVudFdpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgeSA9ICgtKHRoaXMuX3RlbXBWLnkgKiAuNSkgKyAuNSkgKiB0aGlzLmNvbnRhaW5lci5jbGllbnRIZWlnaHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFVzZSB0cmFuc2xhdGUzZCBmb3IgR1BVIGFjY2VsZXJhdGlvbgogICAgICAgICAgICAgICAgdC5lbC5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlM2QoJHt4LnRvRml4ZWQoMSl9cHgsICR7eS50b0ZpeGVkKDEpfXB4LCAwKWA7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguRmxvYXRpbmdUZXh0TWFuYWdlciA9IEZsb2F0aW5nVGV4dE1hbmFnZXI7Cn0pKCk7","CameraManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzIHRvIGF2b2lkIEdhcmJhZ2UgQ29sbGVjdGlvbgogICAgY29uc3QgX2lkZWFsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9pZGVhbExvb2sgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF92ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGFyZ2V0V29ybGRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9nb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICBjbGFzcyBDYW1lcmFNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihjYW1lcmEsIHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CgogICAgICAgICAgICAvLyAtLS0gSU1QUk9WRUQgQ09ORklHVVJBVElPTiAtLS0KLy8gLS0tIElNUFJPVkVEIENPTkZJR1VSQVRJT04gLS0tCiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gewogICAgICAgICAgICAgICAgLy8gRklYRUQgUEVSU1BFQ1RJVkUgU0VUVElOR1MKICAgICAgICAgICAgICAgIGJhc2VEaXN0YW5jZTogMjAuMCwgICAvLyBTbGlnaHRseSBjbG9zZXIgZm9yIGltbWVyc2lvbgogICAgICAgICAgICAgICAgYmFzZUhlaWdodDogMTIuMCwgICAgIC8vIExvd2VyIGFuZ2xlIGZvciBjaGFzZSBmZWVsCgogICAgICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEZhc3RlciwgbW9yZSByZXNwb25zaXZlIHNtb290aGluZwogICAgICAgICAgICAgICAgZm9sbG93U3BlZWQ6IDYuMCwgICAgIC8vIFNuYXBwaWVyIGZvbGxvdwogICAgICAgICAgICAgICAgbG9va1NwZWVkOiA0LjAsICAgICAgIC8vIFJlc3BvbnNpdmUgbG9vay1hdAoKICAgICAgICAgICAgICAgIC8vIER5bmFtaWMgRk9WCiAgICAgICAgICAgICAgICBmb3ZCYXNlOiA1MCwKICAgICAgICAgICAgICAgIGZvdk1heDogNzAsICAgICAgICAgICAvLyBIaWdoZXIgbWF4IGZvciBzcGVlZCBzZW5zYXRpb24KCiAgICAgICAgICAgICAgICAvLyBJTVBST1ZFRDogTG9vay1haGVhZCBzZXR0aW5ncwogICAgICAgICAgICAgICAgbG9va0FoZWFkRGlzdGFuY2U6IDEwLjAsIC8vIExvb2sgZnVydGhlciBhaGVhZAogICAgICAgICAgICAgICAgbG9va0FoZWFkU21vb3RoaW5nOiA0LjAsCgogICAgICAgICAgICAgICAgLy8gU21hcnQgZnJhbWluZwogICAgICAgICAgICAgICAgYmFsbFRyYWNrV2VpZ2h0OiAwLjE1LCAKICAgICAgICAgICAgICAgIHRocmVhdEF3YXJlbmVzczogdHJ1ZQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gU3RhdGUKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmJhbGwgPSBudWxsOyAvLyBEaXJlY3QgYmFsbCByZWZlcmVuY2UgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICAgICAgdGhpcy50YXJnZXRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnRhcmdldElucHV0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZElucHV0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZExvb2tBaGVhZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBDYW1lcmEgU3RhdGUKICAgICAgICAgICAgdGhpcy5wb3MgPSBjYW1lcmEucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIE9yYml0IFN0YXRlCiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IE1hdGguUEk7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0WWF3ID0gTWF0aC5QSTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBNYW51YWwgb3JiaXQgZnJvbSB0b3VjaCAocmlnaHQgc2lkZSBvZiBzY3JlZW4pCiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSAwOwogICAgICAgICAgICB0aGlzLm9yYml0U2Vuc2l0aXZpdHkgPSAwLjAwNDsKICAgICAgICAgICAgdGhpcy5hdXRvUmVjZW50ZXJUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyRGVsYXkgPSAzLjA7CgovLyBTaGFrZQogICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gMDsKICAgICAgICAgICAgdGhpcy5zaGFrZVJvbGwgPSAwOyAvLyBORVc6IFJvdGF0aW9uYWwgc2hha2UKdGhpcy5zaGFrZU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSA9IDA7CiAgICAgICAgICAgIHRoaXMucm9sbEltcHVsc2UgPSAwOyAvLyBORVc6IER5bmFtaWMgdGlsdCBmb3IgY3VydmVzCgogICAgICAgICAgICAvLyBDaW5lbWF0aWMgU3RhdGUKICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVHlwZSA9ICdkZWZhdWx0JzsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNFbmRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IER5bmFtaWMgcHVsbC1iYWNrIGJhc2VkIG9uIGFjdGlvbgogICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4UHVsbEJhY2sgPSA4OwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBTZXQgYmFsbCByZWZlcmVuY2UgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICBzZXRCYWxsKGJhbGwpIHsKICAgICAgICAgICAgdGhpcy5iYWxsID0gYmFsbDsKICAgICAgICB9CgogICAgICAgIC8vIElNUFJPVkVEOiBHZXQgY2FtZXJhLXJlbGF0aXZlIGlucHV0IHRyYW5zZm9ybWF0aW9uCiAgICAgICAgZ2V0Q2FtZXJhUmVsYXRpdmVJbnB1dChpbnB1dFgsIGlucHV0WikgewogICAgICAgICAgICB0aGlzLmNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKCiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKSwgX2NhbUZ3ZCkubm9ybWFsaXplKCk7CgogICAgICAgICAgICAvLyBUcmFuc2Zvcm0gaW5wdXQgdG8gd29ybGQgc3BhY2UKICAgICAgICAgICAgY29uc3Qgd29ybGRYID0gKGlucHV0WCAqIF9jYW1SaWdodC54KSArIChpbnB1dFogKiBfY2FtRndkLngpOwogICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoaW5wdXRYICogX2NhbVJpZ2h0LnopICsgKGlucHV0WiAqIF9jYW1Gd2Queik7CgogICAgICAgICAgICByZXR1cm4geyB4OiB3b3JsZFgsIHo6IHdvcmxkWiB9OwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBNYW51YWwgb3JiaXQgaW5wdXQgZnJvbSB0b3VjaAogICAgICAgIGhhbmRsZU9yYml0SW5wdXQoZHgsIGR5KSB7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgKz0gZHggKiB0aGlzLm9yYml0U2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCArPSBkeSAqIHRoaXMub3JiaXRTZW5zaXRpdml0eSAqIDAuNTsKCiAgICAgICAgICAgIC8vIENsYW1wIHBpdGNoCiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IE1hdGgubWF4KC0wLjMsIE1hdGgubWluKDAuNSwgdGhpcy5tYW51YWxPcmJpdFBpdGNoKSk7CgogICAgICAgICAgICAvLyBSZXNldCBhdXRvLXJlY2VudGVyIHRpbWVyCiAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyVGltZXIgPSAwOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBSZWNlbnRlciBjYW1lcmEKICAgICAgICByZWNlbnRlcigpIHsKICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyA9IDA7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IDA7CiAgICAgICAgfQoKICAgICAgICBwbGF5Q2luZW1hdGljKHR5cGUsIHRhcmdldCwgZHVyYXRpb24gPSAxLjUpIHsKICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY0R1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1R5cGUgPSB0eXBlOwoKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydFBvcy5jb3B5KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydExvb2suY29weSh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLmFkZEZvdkltcHVsc2UoLTE1KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVDaW5lbWF0aWMoZHQpIHsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUaW1lciArPSBkdDsKICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBNYXRoLm1pbigxLjAsIHRoaXMuY2luZW1hdGljVGltZXIgLyB0aGlzLmNpbmVtYXRpY0R1cmF0aW9uKTsKCiAgICAgICAgICAgIGNvbnN0IHQgPSAxIC0gTWF0aC5wb3coMSAtIHByb2dyZXNzLCAzKTsKCiAgICAgICAgICAgIGxldCBhY3RpdmVUYXJnZXQgPSB0aGlzLnRhcmdldDsKICAgICAgICAgICAgbGV0IGlzQmFsbFRyYWNraW5nID0gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCA6IG51bGw7CgogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2ggJiYgYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnICYmIGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDIuMCkgewogICAgICAgICAgICAgICAgYWN0aXZlVGFyZ2V0ID0gYmFsbC5tZXNoOwogICAgICAgICAgICAgICAgaXNCYWxsVHJhY2tpbmcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWFjdGl2ZVRhcmdldCkgewogICAgICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhY3RpdmVUYXJnZXQuZ2V0V29ybGRQb3NpdGlvbihfdGFyZ2V0V29ybGRQb3MpOwoKICAgICAgICAgICAgY29uc3QgZW5kTG9vayA9IF90YXJnZXRXb3JsZFBvcy5jbG9uZSgpOwogICAgICAgICAgICBsZXQgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgbGV0IHJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIGlmIChpc0JhbGxUcmFja2luZykgewogICAgICAgICAgICAgICAgZW5kTG9vay5hZGRTY2FsZWRWZWN0b3IoYmFsbC52ZWxvY2l0eSwgMC4zKTsKCiAgICAgICAgICAgICAgICBmd2QuY29weShiYWxsLnZlbG9jaXR5KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgIGlmIChmd2QubGVuZ3RoU3EoKSA8IDAuMDEpIGZ3ZC5zZXQoMCwwLDEpOwogICAgICAgICAgICAgICAgZndkLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgIHJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIGZ3ZCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbmRMb29rLnkgKz0gMS41OwogICAgICAgICAgICAgICAgZndkLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24oYWN0aXZlVGFyZ2V0LnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgcmlnaHQuc2V0KDEsIDAsIDApLmFwcGx5UXVhdGVybmlvbihhY3RpdmVUYXJnZXQucXVhdGVybmlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGVuZFBvcyA9IF90YXJnZXRXb3JsZFBvcy5jbG9uZSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ2plY2h0JykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGlzQmFsbFRyYWNraW5nID8gMTQuMCA6IDEwLjA7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmd2QuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtZGlzdCkuYWRkKHJpZ2h0LmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMy4wKSk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSA2LjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5jaW5lbWF0aWNUeXBlID09PSAnc3BoZXJlJykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGlzQmFsbFRyYWNraW5nID8gMTYuMCA6IDEyLjA7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmd2QuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtZGlzdCk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSAxMC4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ2ludmlzaWJsZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSAxMi4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QgKiAwLjUpLmFkZChyaWdodC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKGRpc3QpKTsKICAgICAgICAgICAgICAgIGVuZFBvcy5hZGQob2Zmc2V0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy55ICs9IDUuMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE0LjAgOiAxMC4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gNS4wOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnBvcy5sZXJwKGVuZFBvcywgZHQgKiA0LjApOwogICAgICAgICAgICB0aGlzLmxvb2tBdC5sZXJwKGVuZExvb2ssIGR0ICogNi4wKTsKCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLmNvcHkodGhpcy5wb3MpOwogICAgICAgICAgICB0aGlzLmNhbWVyYS5sb29rQXQodGhpcy5sb29rQXQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2luZW1hdGljVGltZXIgPj0gdGhpcy5jaW5lbWF0aWNEdXJhdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKc2V0VGFyZ2V0KG1lc2gsIHZlbG9jaXR5LCBpbnB1dCwgaXNBaW1pbmcgPSBmYWxzZSkgewogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG1lc2g7CiAgICAgICAgICAgIGlmICh2ZWxvY2l0eSkgdGhpcy50YXJnZXRWZWwuY29weSh2ZWxvY2l0eSk7CiAgICAgICAgICAgIGlmIChpbnB1dCkgdGhpcy50YXJnZXRJbnB1dC5jb3B5KGlucHV0KTsKICAgICAgICAgICAgZWxzZSB0aGlzLnRhcmdldElucHV0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5pc0FpbWluZyA9IGlzQWltaW5nOwogICAgICAgIH0KCiAgICAgICAgLy8gS2VlcCBmb3IgY29tcGF0aWJpbGl0eQogICAgICAgIGhhbmRsZUlucHV0KGR4LCBkeSkgewogICAgICAgICAgICB0aGlzLmhhbmRsZU9yYml0SW5wdXQoZHgsIGR5KTsKICAgICAgICB9CgogICAgICAgIGdldFlhdygpIHsgcmV0dXJuIHRoaXMuY3VycmVudFlhdzsgfQoKICAgICAgICBhZGRTaGFrZShhbW91bnQpIHsKCiAgICAgICAgICAgIHRoaXMuc2hha2VJbnRlbnNpdHkgPSBNYXRoLm1pbih0aGlzLnNoYWtlSW50ZW5zaXR5ICsgYW1vdW50LCA0LjApOyAvLyBJbmNyZWFzZWQgY2FwCiAgICAgICAgICAgIHRoaXMuc2hha2VSb2xsID0gTWF0aC5taW4odGhpcy5zaGFrZVJvbGwgKyBhbW91bnQgKiAwLjIsIDAuOCk7IC8vIEFkZCByb2xsCiAgICAgICAgfQogICAgICAgIGFkZEZvdkltcHVsc2UoYW1vdW50KSB7CiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSA9IE1hdGgubWluKHRoaXMuZm92SW1wdWxzZSArIGFtb3VudCwgMzApOwoKICAgICAgICB9CiAgICAgICAgYWRkUm9sbEltcHVsc2UoYW1vdW50KSB7CiAgICAgICAgICAgIHRoaXMucm9sbEltcHVsc2UgKz0gYW1vdW50OwogICAgICAgICAgICAvLyBDbGFtcAogICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlID0gTWF0aC5tYXgoLTAuNSwgTWF0aC5taW4oMC41LCB0aGlzLnJvbGxJbXB1bHNlKSk7Cn0KCiAgICAgICAgc25hcFRvVGFyZ2V0KCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGFyZ2V0KSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIHRoaXMuX2NhbGN1bGF0ZUlkZWFsU3RhdGUoMCk7CgogICAgICAgICAgICB0aGlzLnBvcy5jb3B5KF9pZGVhbFBvcyk7CiAgICAgICAgICAgIHRoaXMubG9va0F0LmNvcHkoX2lkZWFsTG9vayk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IHRoaXMudGFyZ2V0WWF3OwoKICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uY29weSh0aGlzLnBvcyk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmxvb2tBdCh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLnNtb290aGVkSW5wdXQuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLCAwLCAwKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0NpbmVtYXRpYykgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQ2luZW1hdGljKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLnRhcmdldCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgc2FmZUR0ID0gTWF0aC5taW4oZHQsIDAuMDUpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEF1dG8tcmVjZW50ZXIgbG9naWMgKE9ubHkgaWYgbm90IGFpbWluZykKICAgICAgICAgICAgaWYgKCF0aGlzLmlzQWltaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyICs9IHNhZmVEdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1dG9SZWNlbnRlclRpbWVyID4gdGhpcy5hdXRvUmVjZW50ZXJEZWxheSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY2VudGVyU3BlZWQgPSAyLjAgKiBzYWZlRHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyAqPSAoMS4wIC0gcmVjZW50ZXJTcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFBpdGNoICo9ICgxLjAgLSByZWNlbnRlclNwZWVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IFNtYXJ0IHB1bGwtYmFjayBiYXNlZCBvbiBiYWxsIHNwZWVkCiAgICAgICAgICAgIGlmICh0aGlzLmJhbGwgJiYgdGhpcy5iYWxsLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsU3BlZWQgPSB0aGlzLmJhbGwudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRQdWxsQmFjayA9IE1hdGgubWluKHRoaXMubWF4UHVsbEJhY2ssIGJhbGxTcGVlZCAqIDAuMyk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayArPSAodGFyZ2V0UHVsbEJhY2sgLSB0aGlzLmN1cnJlbnRQdWxsQmFjaykgKiBzYWZlRHQgKiAzLjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayAqPSAoMS4wIC0gc2FmZUR0ICogMi4wKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMS4gVXBkYXRlIFRhcmdldCBJbmZvCiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBTdGF0ZQogICAgICAgICAgICB0aGlzLl9jYWxjdWxhdGVJZGVhbFN0YXRlKHNhZmVEdCk7CgogICAgICAgICAgICAvLyAzLiBJTVBST1ZFRDogRmFzdGVyLCBtb3JlIHJlc3BvbnNpdmUgc21vb3RoaW5nCi8vIDMuIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKICAgICAgICAgICAgLy8gRHluYW1pYyBmb2xsb3cgc3BlZWQgYmFzZWQgb24gZGlzdGFuY2UgZXJyb3IgKENhdGNoLXVwIGxvZ2ljKQogICAgICAgICAgICBjb25zdCBkaXN0RXJyb3IgPSB0aGlzLnBvcy5kaXN0YW5jZVRvKF9pZGVhbFBvcyk7CiAgICAgICAgICAgIGNvbnN0IGR5bmFtaWNGb2xsb3cgPSB0aGlzLmNvbmZpZy5mb2xsb3dTcGVlZCArIChkaXN0RXJyb3IgKiAwLjIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3Qgc3BlZWRNdWx0ID0gdGhpcy5pc0FpbWluZyA/IDIuMCA6IDEuMDsKICAgICAgICAgICAgY29uc3QgbG9va0ZhY3RvciA9IDEuMCAtIE1hdGguZXhwKC10aGlzLmNvbmZpZy5sb29rU3BlZWQgKiBzcGVlZE11bHQgKiBzYWZlRHQpOwogICAgICAgICAgICBjb25zdCBwb3NGYWN0b3IgPSAxLjAgLSBNYXRoLmV4cCgtZHluYW1pY0ZvbGxvdyAqIHNwZWVkTXVsdCAqIHNhZmVEdCk7CgogICAgICAgICAgICB0aGlzLnBvcy5sZXJwKF9pZGVhbFBvcywgcG9zRmFjdG9yKTsKICAgICAgICAgICAgdGhpcy5wb3MubGVycChfaWRlYWxQb3MsIHBvc0ZhY3Rvcik7CiAgICAgICAgICAgIHRoaXMubG9va0F0LmxlcnAoX2lkZWFsTG9vaywgbG9va0ZhY3Rvcik7CgogICAgICAgICAgICAvLyA0LiBTY3JlZW4gU2hha2UgKFBvc2l0aW9uICYgUm90YXRpb24pCiAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlSW50ZW5zaXR5ID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgZGVjYXkgPSA4LjAgKiBzYWZlRHQ7IC8vIEZhc3QgZGVjYXkgZm9yIHNuYXBweSBmZWVsCiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5IC09IGRlY2F5OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hha2VJbnRlbnNpdHkgPCAwKSB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gMDsKCiAgICAgICAgICAgICAgICBjb25zdCBzaGFrZU1hZyA9IHRoaXMuc2hha2VJbnRlbnNpdHkgKiAwLjU7CiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlT2Zmc2V0LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZU1hZywKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZU1hZywKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZU1hZwogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hha2VPZmZzZXQuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSb2xsIFNoYWtlCiAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlUm9sbCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hha2VSb2xsIC09IDUuMCAqIHNhZmVEdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlUm9sbCA8IDApIHRoaXMuc2hha2VSb2xsID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhLnJvdGF0aW9uLnogPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiB0aGlzLnNoYWtlUm9sbDsKfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhLnJvdGF0aW9uLnogPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBDdXJ2ZSBUaWx0IChSb2xsIEltcHVsc2UpCiAgICAgICAgICAgIGlmIChNYXRoLmFicyh0aGlzLnJvbGxJbXB1bHNlKSA+IDAuMDAxKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5yb3RhdGlvbi56ICs9IHRoaXMucm9sbEltcHVsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlICo9ICgxLjAgLSA0LjAgKiBzYWZlRHQpOyAvLyBEZWNheQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA1LiBEeW5hbWljIEZPVgovLyA1LiBEeW5hbWljIEZPVgogICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudGFyZ2V0VmVsLmxlbmd0aCgpOwogICAgICAgICAgICBjb25zdCBzcGVlZFJhdGlvID0gTWF0aC5taW4oc3BlZWQgLyAyNS4wLCAxLjApOwogICAgICAgICAgICBjb25zdCB3YXJwID0gc3BlZWRSYXRpbyAqIHNwZWVkUmF0aW87CgogICAgICAgICAgICAvLyBab29tIGluIHNsaWdodGx5IHdoZW4gYWltaW5nCiAgICAgICAgICAgIGNvbnN0IGFpbVpvb20gPSB0aGlzLmlzQWltaW5nID8gLTEwIDogMDsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0Rm92ID0gdGhpcy5jb25maWcuZm92QmFzZSArICh0aGlzLmNvbmZpZy5mb3ZNYXggLSB0aGlzLmNvbmZpZy5mb3ZCYXNlKSAqIHdhcnAgKyB0aGlzLmZvdkltcHVsc2UgKyBhaW1ab29tOwoKICAgICAgICAgICAgdGhpcy5mb3ZJbXB1bHNlICo9IE1hdGgubWF4KDAsIDEuMCAtICg2LjAgKiBzYWZlRHQpKTsKCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmZvdiArPSAodGFyZ2V0Rm92IC0gdGhpcy5jYW1lcmEuZm92KSAqIDQuMCAqIHNhZmVEdDsKICAgICAgICAgICAgdGhpcy5jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwoKICAgICAgICAgICAgLy8gNi4gQXBwbHkgdG8gQ2FtZXJhCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLmNvcHkodGhpcy5wb3MpLmFkZCh0aGlzLnNoYWtlT2Zmc2V0KTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKICAgICAgICB9CgpfY2FsY3VsYXRlSWRlYWxTdGF0ZShkdCkgewogICAgICAgICAgICBjb25zdCB0UG9zID0gX3RhcmdldFdvcmxkUG9zOwoKICAgICAgICAgICAgLy8gLS0tIEFJTSBNT0RFIE9WRVJSSURFIC0tLQogICAgICAgICAgICBpZiAodGhpcy5pc0FpbWluZykgewogICAgICAgICAgICAgICAgLy8gUmVsYXhlZCBBaW0gTW9kZTogWm9vbSBpbiBidXQgbWFpbnRhaW4gb3JpZW50YXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IGFpbURpc3QgPSAxNC4wOyAKICAgICAgICAgICAgICAgIGNvbnN0IGFpbUhlaWdodCA9IDYuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXNlIE1hbnVhbCBPcmJpdCBMb2dpYyAoQ29uc2lzdGVudCB3aXRoIFN0YW5kYXJkIE1vZGUpCiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVEaXN0YW5jZSA9IGFpbURpc3Q7CiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVIZWlnaHQgPSBhaW1IZWlnaHQgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmFzZSBaIG9mZnNldCAoQ2FtZXJhIGRlZmF1bHRzIHRvICtaKQogICAgICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBcHBseSBPcmJpdCBSb3RhdGlvbgogICAgICAgICAgICAgICAgY29uc3QgZmluYWxYID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgY29uc3QgZmluYWxaID0gY2FtWiAqIE1hdGguY29zKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbFopOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmNvcHkodFBvcyk7CiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLnkgKz0gMS4wOyAvLyBMb29rIGF0IHBsYXllciBjZW50ZXIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzYWJsZSBsb29rLWFoZWFkIHRvIGtlZXAgZnJhbWluZyBzdGFibGUgd2hpbGUgYWltaW5nCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFNUQU5EQVJEIE1PREUgLS0tCgogICAgICAgICAgICAvLyAwLiBUaHJlYXQgQXNzZXNzbWVudCAoRHluYW1pYyBQdWxsLWJhY2spCiAgICAgICAgICAgIGxldCB0aHJlYXRQdWxsYmFjayA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLmNvbmZpZy50aHJlYXRBd2FyZW5lc3MpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRocmVhdCA9IHRoaXMuX2NhbGN1bGF0ZVRocmVhdExldmVsKHRQb3MpOwogICAgICAgICAgICAgICAgdGhyZWF0UHVsbGJhY2sgPSB0aHJlYXQgKiA2LjA7IC8vIFB1bGwgYmFjayB1cCB0byA2IHVuaXRzCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBBcHBseSBtYW51YWwgb3JiaXQKICAgICAgICAgICAgLy8gMS4gQ2FsY3VsYXRlIElkZWFsIFBvc2l0aW9uIHdpdGggcHVsbC1iYWNrCiAgICAgICAgICAgIGNvbnN0IGVmZmVjdGl2ZURpc3RhbmNlID0gdGhpcy5jb25maWcuYmFzZURpc3RhbmNlICsgdGhpcy5jdXJyZW50UHVsbEJhY2sgKyB0aHJlYXRQdWxsYmFjazsKICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlSGVpZ2h0ID0gdGhpcy5jb25maWcuYmFzZUhlaWdodCArIHRoaXMuY3VycmVudFB1bGxCYWNrICogMC4zICsgdGhyZWF0UHVsbGJhY2sgKiAwLjUgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKCiAgICAgICAgICAgIC8vIEJhc2Ugb2Zmc2V0IChDYW1lcmEgdXN1YWxseSBzaXRzIGF0ICtaIHJlbGF0aXZlIHRvIHRhcmdldCkKICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwoKICAgICAgICAgICAgLy8gQXBwbHkgT3JiaXQgUm90YXRpb24KICAgICAgICAgICAgY29uc3QgZmluYWxDYW1YID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICBjb25zdCBmaW5hbENhbVogPSBjYW1aICogTWF0aC5jb3ModGhpcy5tYW51YWxPcmJpdFlhdyk7CgogICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsQ2FtWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbENhbVopOwoKICAgICAgICAgICAgLy8gQ2xhbXAgdG8gYXJlbmEgYm91bmRzIChyb3VnaGx5KSB0byBwcmV2ZW50IGNsaXBwaW5nIHRocm91Z2ggd2FsbHMKICAgICAgICAgICAgaWYgKF9pZGVhbFBvcy56ID4gNDguMCkgX2lkZWFsUG9zLnogPSA0OC4wOwogICAgICAgICAgICBpZiAoX2lkZWFsUG9zLnogPCAtNDguMCkgX2lkZWFsUG9zLnogPSAtNDguMDsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBMb29rQXQgd2l0aCBJTVBST1ZFRCBsb29rLWFoZWFkCiAgICAgICAgICAgIF9pZGVhbExvb2suY29weSh0UG9zKTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBWZWxvY2l0eS1iYXNlZCBsb29rLWFoZWFkCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFZlbC5sZW5ndGhTcSgpID4gMC41KSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudGFyZ2V0VmVsLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3QgbG9va0FoZWFkRmFjdG9yID0gTWF0aC5taW4oMS4wLCBzcGVlZCAvIDE1LjApICogdGhpcy5jb25maWcubG9va0FoZWFkRGlzdGFuY2U7CgogICAgICAgICAgICAgICAgY29uc3QgdmVsRGlyID0gdGhpcy50YXJnZXRWZWwuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIF9sb29rQWhlYWQuY29weSh2ZWxEaXIpLm11bHRpcGx5U2NhbGFyKGxvb2tBaGVhZEZhY3Rvcik7CgogICAgICAgICAgICAgICAgLy8gU21vb3RoIHRoZSBsb29rLWFoZWFkCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLmxlcnAoX2xvb2tBaGVhZCwgZHQgKiB0aGlzLmNvbmZpZy5sb29rQWhlYWRTbW9vdGhpbmcpOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay5hZGQodGhpcy5zbW9vdGhlZExvb2tBaGVhZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLm11bHRpcGx5U2NhbGFyKDEuMCAtIGR0ICogMy4wKTsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2suYWRkKHRoaXMuc21vb3RoZWRMb29rQWhlYWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfaWRlYWxMb29rLnkgKj0gMC41OyAvLyBMb29rIHNsaWdodGx5IGxvd2VyIHRoYW4gYWN0dWFsIHRhcmdldCBoZWlnaHQKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBJbmNsdWRlIGJhbGwgaW4gZnJhbWluZyB3aGVuIG5lYXJieQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5tZXNoICYmIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxQb3MgPSB0aGlzLmJhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSB0UG9zLmRpc3RhbmNlVG8oYmFsbFBvcyk7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCAyNSAmJiBkaXN0VG9CYWxsID4gMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxXZWlnaHQgPSBNYXRoLm1heCgwLCAxIC0gZGlzdFRvQmFsbCAvIDI1KSAqIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodDsKICAgICAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmxlcnAoYmFsbFBvcywgYmFsbFdlaWdodCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIElucHV0IEFudGljaXBhdGlvbiAoU21vb3RoZWQpCiAgICAgICAgICAgIHRoaXMuc21vb3RoZWRJbnB1dC5sZXJwKHRoaXMudGFyZ2V0SW5wdXQsIGR0ICogMy4wKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnNtb290aGVkSW5wdXQubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueCArPSB0aGlzLnNtb290aGVkSW5wdXQueCAqIDQuMDsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueiArPSB0aGlzLnNtb290aGVkSW5wdXQueiAqIDQuMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NhbGN1bGF0ZVRocmVhdExldmVsKGNlbnRlclBvcykgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSkgcmV0dXJuIDA7CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgZGVuc2l0eSA9IDA7CiAgICAgICAgICAgIGNvbnN0IGNoZWNrVGVhbSA9ICh0ZWFtKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXRlYW0pIHJldHVybjsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBpZiAocC5tZXNoICYmIHAubWVzaCAhPT0gdGhpcy50YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZFNxID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG9TcXVhcmVkKGNlbnRlclBvcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkU3EgPCA2NC4wKSB7IC8vIDhtIHJhZGl1cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVuc2l0eSArPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGNoZWNrVGVhbShnYW1lLnRlYW1zLmhvbWUpOwogICAgICAgICAgICBjaGVja1RlYW0oZ2FtZS50ZWFtcy5hd2F5KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBNYXRoLm1pbigxLjAsIGRlbnNpdHkgLyA0LjApOyAvLyBDYXAgYXQgNCBwbGF5ZXJzCiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IEdldCBmb3J3YXJkIGRpcmVjdGlvbiBmb3IgVUkgcmVmZXJlbmNlCiAgICAgICAgZ2V0Rm9yd2FyZERpcmVjdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX2NhbUZ3ZC5jbG9uZSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBHZXQgcmlnaHQgZGlyZWN0aW9uCiAgICAgICAgZ2V0UmlnaHREaXJlY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IHRoaXMuZ2V0Rm9yd2FyZERpcmVjdGlvbigpOwogICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApLCBmd2QpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICByZXR1cm4gX2NhbVJpZ2h0LmNsb25lKCk7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkNhbWVyYU1hbmFnZXIgPSBDYW1lcmFNYW5hZ2VyOwp9KSgpOwo=","./CameraManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzIHRvIGF2b2lkIEdhcmJhZ2UgQ29sbGVjdGlvbgogICAgY29uc3QgX2lkZWFsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9pZGVhbExvb2sgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF92ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGFyZ2V0V29ybGRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9nb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICBjbGFzcyBDYW1lcmFNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihjYW1lcmEsIHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CgogICAgICAgICAgICAvLyAtLS0gSU1QUk9WRUQgQ09ORklHVVJBVElPTiAtLS0KLy8gLS0tIElNUFJPVkVEIENPTkZJR1VSQVRJT04gLS0tCiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gewogICAgICAgICAgICAgICAgLy8gRklYRUQgUEVSU1BFQ1RJVkUgU0VUVElOR1MKICAgICAgICAgICAgICAgIGJhc2VEaXN0YW5jZTogMjAuMCwgICAvLyBTbGlnaHRseSBjbG9zZXIgZm9yIGltbWVyc2lvbgogICAgICAgICAgICAgICAgYmFzZUhlaWdodDogMTIuMCwgICAgIC8vIExvd2VyIGFuZ2xlIGZvciBjaGFzZSBmZWVsCgogICAgICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEZhc3RlciwgbW9yZSByZXNwb25zaXZlIHNtb290aGluZwogICAgICAgICAgICAgICAgZm9sbG93U3BlZWQ6IDYuMCwgICAgIC8vIFNuYXBwaWVyIGZvbGxvdwogICAgICAgICAgICAgICAgbG9va1NwZWVkOiA0LjAsICAgICAgIC8vIFJlc3BvbnNpdmUgbG9vay1hdAoKICAgICAgICAgICAgICAgIC8vIER5bmFtaWMgRk9WCiAgICAgICAgICAgICAgICBmb3ZCYXNlOiA1MCwKICAgICAgICAgICAgICAgIGZvdk1heDogNzAsICAgICAgICAgICAvLyBIaWdoZXIgbWF4IGZvciBzcGVlZCBzZW5zYXRpb24KCiAgICAgICAgICAgICAgICAvLyBJTVBST1ZFRDogTG9vay1haGVhZCBzZXR0aW5ncwogICAgICAgICAgICAgICAgbG9va0FoZWFkRGlzdGFuY2U6IDEwLjAsIC8vIExvb2sgZnVydGhlciBhaGVhZAogICAgICAgICAgICAgICAgbG9va0FoZWFkU21vb3RoaW5nOiA0LjAsCgogICAgICAgICAgICAgICAgLy8gU21hcnQgZnJhbWluZwogICAgICAgICAgICAgICAgYmFsbFRyYWNrV2VpZ2h0OiAwLjE1LCAKICAgICAgICAgICAgICAgIHRocmVhdEF3YXJlbmVzczogdHJ1ZQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gU3RhdGUKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmJhbGwgPSBudWxsOyAvLyBEaXJlY3QgYmFsbCByZWZlcmVuY2UgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICAgICAgdGhpcy50YXJnZXRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnRhcmdldElucHV0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZElucHV0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZExvb2tBaGVhZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBDYW1lcmEgU3RhdGUKICAgICAgICAgICAgdGhpcy5wb3MgPSBjYW1lcmEucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIE9yYml0IFN0YXRlCiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IE1hdGguUEk7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0WWF3ID0gTWF0aC5QSTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBNYW51YWwgb3JiaXQgZnJvbSB0b3VjaCAocmlnaHQgc2lkZSBvZiBzY3JlZW4pCiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSAwOwogICAgICAgICAgICB0aGlzLm9yYml0U2Vuc2l0aXZpdHkgPSAwLjAwNDsKICAgICAgICAgICAgdGhpcy5hdXRvUmVjZW50ZXJUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyRGVsYXkgPSAzLjA7CgovLyBTaGFrZQogICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gMDsKICAgICAgICAgICAgdGhpcy5zaGFrZVJvbGwgPSAwOyAvLyBORVc6IFJvdGF0aW9uYWwgc2hha2UKdGhpcy5zaGFrZU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSA9IDA7CiAgICAgICAgICAgIHRoaXMucm9sbEltcHVsc2UgPSAwOyAvLyBORVc6IER5bmFtaWMgdGlsdCBmb3IgY3VydmVzCgogICAgICAgICAgICAvLyBDaW5lbWF0aWMgU3RhdGUKICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVHlwZSA9ICdkZWZhdWx0JzsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNFbmRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IER5bmFtaWMgcHVsbC1iYWNrIGJhc2VkIG9uIGFjdGlvbgogICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4UHVsbEJhY2sgPSA4OwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBTZXQgYmFsbCByZWZlcmVuY2UgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICBzZXRCYWxsKGJhbGwpIHsKICAgICAgICAgICAgdGhpcy5iYWxsID0gYmFsbDsKICAgICAgICB9CgogICAgICAgIC8vIElNUFJPVkVEOiBHZXQgY2FtZXJhLXJlbGF0aXZlIGlucHV0IHRyYW5zZm9ybWF0aW9uCiAgICAgICAgZ2V0Q2FtZXJhUmVsYXRpdmVJbnB1dChpbnB1dFgsIGlucHV0WikgewogICAgICAgICAgICB0aGlzLmNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKCiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKSwgX2NhbUZ3ZCkubm9ybWFsaXplKCk7CgogICAgICAgICAgICAvLyBUcmFuc2Zvcm0gaW5wdXQgdG8gd29ybGQgc3BhY2UKICAgICAgICAgICAgY29uc3Qgd29ybGRYID0gKGlucHV0WCAqIF9jYW1SaWdodC54KSArIChpbnB1dFogKiBfY2FtRndkLngpOwogICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoaW5wdXRYICogX2NhbVJpZ2h0LnopICsgKGlucHV0WiAqIF9jYW1Gd2Queik7CgogICAgICAgICAgICByZXR1cm4geyB4OiB3b3JsZFgsIHo6IHdvcmxkWiB9OwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBNYW51YWwgb3JiaXQgaW5wdXQgZnJvbSB0b3VjaAogICAgICAgIGhhbmRsZU9yYml0SW5wdXQoZHgsIGR5KSB7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgKz0gZHggKiB0aGlzLm9yYml0U2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCArPSBkeSAqIHRoaXMub3JiaXRTZW5zaXRpdml0eSAqIDAuNTsKCiAgICAgICAgICAgIC8vIENsYW1wIHBpdGNoCiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IE1hdGgubWF4KC0wLjMsIE1hdGgubWluKDAuNSwgdGhpcy5tYW51YWxPcmJpdFBpdGNoKSk7CgogICAgICAgICAgICAvLyBSZXNldCBhdXRvLXJlY2VudGVyIHRpbWVyCiAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyVGltZXIgPSAwOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBSZWNlbnRlciBjYW1lcmEKICAgICAgICByZWNlbnRlcigpIHsKICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyA9IDA7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IDA7CiAgICAgICAgfQoKICAgICAgICBwbGF5Q2luZW1hdGljKHR5cGUsIHRhcmdldCwgZHVyYXRpb24gPSAxLjUpIHsKICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY0R1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1R5cGUgPSB0eXBlOwoKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydFBvcy5jb3B5KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydExvb2suY29weSh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLmFkZEZvdkltcHVsc2UoLTE1KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVDaW5lbWF0aWMoZHQpIHsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUaW1lciArPSBkdDsKICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBNYXRoLm1pbigxLjAsIHRoaXMuY2luZW1hdGljVGltZXIgLyB0aGlzLmNpbmVtYXRpY0R1cmF0aW9uKTsKCiAgICAgICAgICAgIGNvbnN0IHQgPSAxIC0gTWF0aC5wb3coMSAtIHByb2dyZXNzLCAzKTsKCiAgICAgICAgICAgIGxldCBhY3RpdmVUYXJnZXQgPSB0aGlzLnRhcmdldDsKICAgICAgICAgICAgbGV0IGlzQmFsbFRyYWNraW5nID0gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCA6IG51bGw7CgogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2ggJiYgYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnICYmIGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDIuMCkgewogICAgICAgICAgICAgICAgYWN0aXZlVGFyZ2V0ID0gYmFsbC5tZXNoOwogICAgICAgICAgICAgICAgaXNCYWxsVHJhY2tpbmcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWFjdGl2ZVRhcmdldCkgewogICAgICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhY3RpdmVUYXJnZXQuZ2V0V29ybGRQb3NpdGlvbihfdGFyZ2V0V29ybGRQb3MpOwoKICAgICAgICAgICAgY29uc3QgZW5kTG9vayA9IF90YXJnZXRXb3JsZFBvcy5jbG9uZSgpOwogICAgICAgICAgICBsZXQgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgbGV0IHJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIGlmIChpc0JhbGxUcmFja2luZykgewogICAgICAgICAgICAgICAgZW5kTG9vay5hZGRTY2FsZWRWZWN0b3IoYmFsbC52ZWxvY2l0eSwgMC4zKTsKCiAgICAgICAgICAgICAgICBmd2QuY29weShiYWxsLnZlbG9jaXR5KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgIGlmIChmd2QubGVuZ3RoU3EoKSA8IDAuMDEpIGZ3ZC5zZXQoMCwwLDEpOwogICAgICAgICAgICAgICAgZndkLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgIHJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIGZ3ZCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbmRMb29rLnkgKz0gMS41OwogICAgICAgICAgICAgICAgZndkLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24oYWN0aXZlVGFyZ2V0LnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgcmlnaHQuc2V0KDEsIDAsIDApLmFwcGx5UXVhdGVybmlvbihhY3RpdmVUYXJnZXQucXVhdGVybmlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGVuZFBvcyA9IF90YXJnZXRXb3JsZFBvcy5jbG9uZSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ2plY2h0JykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGlzQmFsbFRyYWNraW5nID8gMTQuMCA6IDEwLjA7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmd2QuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtZGlzdCkuYWRkKHJpZ2h0LmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMy4wKSk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSA2LjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5jaW5lbWF0aWNUeXBlID09PSAnc3BoZXJlJykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGlzQmFsbFRyYWNraW5nID8gMTYuMCA6IDEyLjA7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmd2QuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtZGlzdCk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSAxMC4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ2ludmlzaWJsZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSAxMi4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QgKiAwLjUpLmFkZChyaWdodC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKGRpc3QpKTsKICAgICAgICAgICAgICAgIGVuZFBvcy5hZGQob2Zmc2V0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy55ICs9IDUuMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE0LjAgOiAxMC4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gNS4wOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnBvcy5sZXJwKGVuZFBvcywgZHQgKiA0LjApOwogICAgICAgICAgICB0aGlzLmxvb2tBdC5sZXJwKGVuZExvb2ssIGR0ICogNi4wKTsKCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLmNvcHkodGhpcy5wb3MpOwogICAgICAgICAgICB0aGlzLmNhbWVyYS5sb29rQXQodGhpcy5sb29rQXQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2luZW1hdGljVGltZXIgPj0gdGhpcy5jaW5lbWF0aWNEdXJhdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKc2V0VGFyZ2V0KG1lc2gsIHZlbG9jaXR5LCBpbnB1dCwgaXNBaW1pbmcgPSBmYWxzZSkgewogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG1lc2g7CiAgICAgICAgICAgIGlmICh2ZWxvY2l0eSkgdGhpcy50YXJnZXRWZWwuY29weSh2ZWxvY2l0eSk7CiAgICAgICAgICAgIGlmIChpbnB1dCkgdGhpcy50YXJnZXRJbnB1dC5jb3B5KGlucHV0KTsKICAgICAgICAgICAgZWxzZSB0aGlzLnRhcmdldElucHV0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5pc0FpbWluZyA9IGlzQWltaW5nOwogICAgICAgIH0KCiAgICAgICAgLy8gS2VlcCBmb3IgY29tcGF0aWJpbGl0eQogICAgICAgIGhhbmRsZUlucHV0KGR4LCBkeSkgewogICAgICAgICAgICB0aGlzLmhhbmRsZU9yYml0SW5wdXQoZHgsIGR5KTsKICAgICAgICB9CgogICAgICAgIGdldFlhdygpIHsgcmV0dXJuIHRoaXMuY3VycmVudFlhdzsgfQoKICAgICAgICBhZGRTaGFrZShhbW91bnQpIHsKCiAgICAgICAgICAgIHRoaXMuc2hha2VJbnRlbnNpdHkgPSBNYXRoLm1pbih0aGlzLnNoYWtlSW50ZW5zaXR5ICsgYW1vdW50LCA0LjApOyAvLyBJbmNyZWFzZWQgY2FwCiAgICAgICAgICAgIHRoaXMuc2hha2VSb2xsID0gTWF0aC5taW4odGhpcy5zaGFrZVJvbGwgKyBhbW91bnQgKiAwLjIsIDAuOCk7IC8vIEFkZCByb2xsCiAgICAgICAgfQogICAgICAgIGFkZEZvdkltcHVsc2UoYW1vdW50KSB7CiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSA9IE1hdGgubWluKHRoaXMuZm92SW1wdWxzZSArIGFtb3VudCwgMzApOwoKICAgICAgICB9CiAgICAgICAgYWRkUm9sbEltcHVsc2UoYW1vdW50KSB7CiAgICAgICAgICAgIHRoaXMucm9sbEltcHVsc2UgKz0gYW1vdW50OwogICAgICAgICAgICAvLyBDbGFtcAogICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlID0gTWF0aC5tYXgoLTAuNSwgTWF0aC5taW4oMC41LCB0aGlzLnJvbGxJbXB1bHNlKSk7Cn0KCiAgICAgICAgc25hcFRvVGFyZ2V0KCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGFyZ2V0KSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIHRoaXMuX2NhbGN1bGF0ZUlkZWFsU3RhdGUoMCk7CgogICAgICAgICAgICB0aGlzLnBvcy5jb3B5KF9pZGVhbFBvcyk7CiAgICAgICAgICAgIHRoaXMubG9va0F0LmNvcHkoX2lkZWFsTG9vayk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IHRoaXMudGFyZ2V0WWF3OwoKICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uY29weSh0aGlzLnBvcyk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmxvb2tBdCh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLnNtb290aGVkSW5wdXQuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLCAwLCAwKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0NpbmVtYXRpYykgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQ2luZW1hdGljKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLnRhcmdldCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgc2FmZUR0ID0gTWF0aC5taW4oZHQsIDAuMDUpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEF1dG8tcmVjZW50ZXIgbG9naWMgKE9ubHkgaWYgbm90IGFpbWluZykKICAgICAgICAgICAgaWYgKCF0aGlzLmlzQWltaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyICs9IHNhZmVEdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1dG9SZWNlbnRlclRpbWVyID4gdGhpcy5hdXRvUmVjZW50ZXJEZWxheSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY2VudGVyU3BlZWQgPSAyLjAgKiBzYWZlRHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyAqPSAoMS4wIC0gcmVjZW50ZXJTcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFBpdGNoICo9ICgxLjAgLSByZWNlbnRlclNwZWVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IFNtYXJ0IHB1bGwtYmFjayBiYXNlZCBvbiBiYWxsIHNwZWVkCiAgICAgICAgICAgIGlmICh0aGlzLmJhbGwgJiYgdGhpcy5iYWxsLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsU3BlZWQgPSB0aGlzLmJhbGwudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRQdWxsQmFjayA9IE1hdGgubWluKHRoaXMubWF4UHVsbEJhY2ssIGJhbGxTcGVlZCAqIDAuMyk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayArPSAodGFyZ2V0UHVsbEJhY2sgLSB0aGlzLmN1cnJlbnRQdWxsQmFjaykgKiBzYWZlRHQgKiAzLjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayAqPSAoMS4wIC0gc2FmZUR0ICogMi4wKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMS4gVXBkYXRlIFRhcmdldCBJbmZvCiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBTdGF0ZQogICAgICAgICAgICB0aGlzLl9jYWxjdWxhdGVJZGVhbFN0YXRlKHNhZmVEdCk7CgogICAgICAgICAgICAvLyAzLiBJTVBST1ZFRDogRmFzdGVyLCBtb3JlIHJlc3BvbnNpdmUgc21vb3RoaW5nCi8vIDMuIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKICAgICAgICAgICAgLy8gRHluYW1pYyBmb2xsb3cgc3BlZWQgYmFzZWQgb24gZGlzdGFuY2UgZXJyb3IgKENhdGNoLXVwIGxvZ2ljKQogICAgICAgICAgICBjb25zdCBkaXN0RXJyb3IgPSB0aGlzLnBvcy5kaXN0YW5jZVRvKF9pZGVhbFBvcyk7CiAgICAgICAgICAgIGNvbnN0IGR5bmFtaWNGb2xsb3cgPSB0aGlzLmNvbmZpZy5mb2xsb3dTcGVlZCArIChkaXN0RXJyb3IgKiAwLjIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3Qgc3BlZWRNdWx0ID0gdGhpcy5pc0FpbWluZyA/IDIuMCA6IDEuMDsKICAgICAgICAgICAgY29uc3QgbG9va0ZhY3RvciA9IDEuMCAtIE1hdGguZXhwKC10aGlzLmNvbmZpZy5sb29rU3BlZWQgKiBzcGVlZE11bHQgKiBzYWZlRHQpOwogICAgICAgICAgICBjb25zdCBwb3NGYWN0b3IgPSAxLjAgLSBNYXRoLmV4cCgtZHluYW1pY0ZvbGxvdyAqIHNwZWVkTXVsdCAqIHNhZmVEdCk7CgogICAgICAgICAgICB0aGlzLnBvcy5sZXJwKF9pZGVhbFBvcywgcG9zRmFjdG9yKTsKICAgICAgICAgICAgdGhpcy5wb3MubGVycChfaWRlYWxQb3MsIHBvc0ZhY3Rvcik7CiAgICAgICAgICAgIHRoaXMubG9va0F0LmxlcnAoX2lkZWFsTG9vaywgbG9va0ZhY3Rvcik7CgogICAgICAgICAgICAvLyA0LiBTY3JlZW4gU2hha2UgKFBvc2l0aW9uICYgUm90YXRpb24pCiAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlSW50ZW5zaXR5ID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgZGVjYXkgPSA4LjAgKiBzYWZlRHQ7IC8vIEZhc3QgZGVjYXkgZm9yIHNuYXBweSBmZWVsCiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5IC09IGRlY2F5OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hha2VJbnRlbnNpdHkgPCAwKSB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gMDsKCiAgICAgICAgICAgICAgICBjb25zdCBzaGFrZU1hZyA9IHRoaXMuc2hha2VJbnRlbnNpdHkgKiAwLjU7CiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlT2Zmc2V0LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZU1hZywKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZU1hZywKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZU1hZwogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hha2VPZmZzZXQuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSb2xsIFNoYWtlCiAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlUm9sbCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hha2VSb2xsIC09IDUuMCAqIHNhZmVEdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlUm9sbCA8IDApIHRoaXMuc2hha2VSb2xsID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhLnJvdGF0aW9uLnogPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiB0aGlzLnNoYWtlUm9sbDsKfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhLnJvdGF0aW9uLnogPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBDdXJ2ZSBUaWx0IChSb2xsIEltcHVsc2UpCiAgICAgICAgICAgIGlmIChNYXRoLmFicyh0aGlzLnJvbGxJbXB1bHNlKSA+IDAuMDAxKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5yb3RhdGlvbi56ICs9IHRoaXMucm9sbEltcHVsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlICo9ICgxLjAgLSA0LjAgKiBzYWZlRHQpOyAvLyBEZWNheQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA1LiBEeW5hbWljIEZPVgovLyA1LiBEeW5hbWljIEZPVgogICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudGFyZ2V0VmVsLmxlbmd0aCgpOwogICAgICAgICAgICBjb25zdCBzcGVlZFJhdGlvID0gTWF0aC5taW4oc3BlZWQgLyAyNS4wLCAxLjApOwogICAgICAgICAgICBjb25zdCB3YXJwID0gc3BlZWRSYXRpbyAqIHNwZWVkUmF0aW87CgogICAgICAgICAgICAvLyBab29tIGluIHNsaWdodGx5IHdoZW4gYWltaW5nCiAgICAgICAgICAgIGNvbnN0IGFpbVpvb20gPSB0aGlzLmlzQWltaW5nID8gLTEwIDogMDsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0Rm92ID0gdGhpcy5jb25maWcuZm92QmFzZSArICh0aGlzLmNvbmZpZy5mb3ZNYXggLSB0aGlzLmNvbmZpZy5mb3ZCYXNlKSAqIHdhcnAgKyB0aGlzLmZvdkltcHVsc2UgKyBhaW1ab29tOwoKICAgICAgICAgICAgdGhpcy5mb3ZJbXB1bHNlICo9IE1hdGgubWF4KDAsIDEuMCAtICg2LjAgKiBzYWZlRHQpKTsKCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmZvdiArPSAodGFyZ2V0Rm92IC0gdGhpcy5jYW1lcmEuZm92KSAqIDQuMCAqIHNhZmVEdDsKICAgICAgICAgICAgdGhpcy5jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwoKICAgICAgICAgICAgLy8gNi4gQXBwbHkgdG8gQ2FtZXJhCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLmNvcHkodGhpcy5wb3MpLmFkZCh0aGlzLnNoYWtlT2Zmc2V0KTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKICAgICAgICB9CgpfY2FsY3VsYXRlSWRlYWxTdGF0ZShkdCkgewogICAgICAgICAgICBjb25zdCB0UG9zID0gX3RhcmdldFdvcmxkUG9zOwoKICAgICAgICAgICAgLy8gLS0tIEFJTSBNT0RFIE9WRVJSSURFIC0tLQogICAgICAgICAgICBpZiAodGhpcy5pc0FpbWluZykgewogICAgICAgICAgICAgICAgLy8gUmVsYXhlZCBBaW0gTW9kZTogWm9vbSBpbiBidXQgbWFpbnRhaW4gb3JpZW50YXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IGFpbURpc3QgPSAxNC4wOyAKICAgICAgICAgICAgICAgIGNvbnN0IGFpbUhlaWdodCA9IDYuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXNlIE1hbnVhbCBPcmJpdCBMb2dpYyAoQ29uc2lzdGVudCB3aXRoIFN0YW5kYXJkIE1vZGUpCiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVEaXN0YW5jZSA9IGFpbURpc3Q7CiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVIZWlnaHQgPSBhaW1IZWlnaHQgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmFzZSBaIG9mZnNldCAoQ2FtZXJhIGRlZmF1bHRzIHRvICtaKQogICAgICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBcHBseSBPcmJpdCBSb3RhdGlvbgogICAgICAgICAgICAgICAgY29uc3QgZmluYWxYID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgY29uc3QgZmluYWxaID0gY2FtWiAqIE1hdGguY29zKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbFopOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmNvcHkodFBvcyk7CiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLnkgKz0gMS4wOyAvLyBMb29rIGF0IHBsYXllciBjZW50ZXIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzYWJsZSBsb29rLWFoZWFkIHRvIGtlZXAgZnJhbWluZyBzdGFibGUgd2hpbGUgYWltaW5nCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFNUQU5EQVJEIE1PREUgLS0tCgogICAgICAgICAgICAvLyAwLiBUaHJlYXQgQXNzZXNzbWVudCAoRHluYW1pYyBQdWxsLWJhY2spCiAgICAgICAgICAgIGxldCB0aHJlYXRQdWxsYmFjayA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLmNvbmZpZy50aHJlYXRBd2FyZW5lc3MpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRocmVhdCA9IHRoaXMuX2NhbGN1bGF0ZVRocmVhdExldmVsKHRQb3MpOwogICAgICAgICAgICAgICAgdGhyZWF0UHVsbGJhY2sgPSB0aHJlYXQgKiA2LjA7IC8vIFB1bGwgYmFjayB1cCB0byA2IHVuaXRzCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBBcHBseSBtYW51YWwgb3JiaXQKICAgICAgICAgICAgLy8gMS4gQ2FsY3VsYXRlIElkZWFsIFBvc2l0aW9uIHdpdGggcHVsbC1iYWNrCiAgICAgICAgICAgIGNvbnN0IGVmZmVjdGl2ZURpc3RhbmNlID0gdGhpcy5jb25maWcuYmFzZURpc3RhbmNlICsgdGhpcy5jdXJyZW50UHVsbEJhY2sgKyB0aHJlYXRQdWxsYmFjazsKICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlSGVpZ2h0ID0gdGhpcy5jb25maWcuYmFzZUhlaWdodCArIHRoaXMuY3VycmVudFB1bGxCYWNrICogMC4zICsgdGhyZWF0UHVsbGJhY2sgKiAwLjUgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKCiAgICAgICAgICAgIC8vIEJhc2Ugb2Zmc2V0IChDYW1lcmEgdXN1YWxseSBzaXRzIGF0ICtaIHJlbGF0aXZlIHRvIHRhcmdldCkKICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwoKICAgICAgICAgICAgLy8gQXBwbHkgT3JiaXQgUm90YXRpb24KICAgICAgICAgICAgY29uc3QgZmluYWxDYW1YID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICBjb25zdCBmaW5hbENhbVogPSBjYW1aICogTWF0aC5jb3ModGhpcy5tYW51YWxPcmJpdFlhdyk7CgogICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsQ2FtWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbENhbVopOwoKICAgICAgICAgICAgLy8gQ2xhbXAgdG8gYXJlbmEgYm91bmRzIChyb3VnaGx5KSB0byBwcmV2ZW50IGNsaXBwaW5nIHRocm91Z2ggd2FsbHMKICAgICAgICAgICAgaWYgKF9pZGVhbFBvcy56ID4gNDguMCkgX2lkZWFsUG9zLnogPSA0OC4wOwogICAgICAgICAgICBpZiAoX2lkZWFsUG9zLnogPCAtNDguMCkgX2lkZWFsUG9zLnogPSAtNDguMDsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBMb29rQXQgd2l0aCBJTVBST1ZFRCBsb29rLWFoZWFkCiAgICAgICAgICAgIF9pZGVhbExvb2suY29weSh0UG9zKTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBWZWxvY2l0eS1iYXNlZCBsb29rLWFoZWFkCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFZlbC5sZW5ndGhTcSgpID4gMC41KSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudGFyZ2V0VmVsLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3QgbG9va0FoZWFkRmFjdG9yID0gTWF0aC5taW4oMS4wLCBzcGVlZCAvIDE1LjApICogdGhpcy5jb25maWcubG9va0FoZWFkRGlzdGFuY2U7CgogICAgICAgICAgICAgICAgY29uc3QgdmVsRGlyID0gdGhpcy50YXJnZXRWZWwuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIF9sb29rQWhlYWQuY29weSh2ZWxEaXIpLm11bHRpcGx5U2NhbGFyKGxvb2tBaGVhZEZhY3Rvcik7CgogICAgICAgICAgICAgICAgLy8gU21vb3RoIHRoZSBsb29rLWFoZWFkCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLmxlcnAoX2xvb2tBaGVhZCwgZHQgKiB0aGlzLmNvbmZpZy5sb29rQWhlYWRTbW9vdGhpbmcpOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay5hZGQodGhpcy5zbW9vdGhlZExvb2tBaGVhZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLm11bHRpcGx5U2NhbGFyKDEuMCAtIGR0ICogMy4wKTsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2suYWRkKHRoaXMuc21vb3RoZWRMb29rQWhlYWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfaWRlYWxMb29rLnkgKj0gMC41OyAvLyBMb29rIHNsaWdodGx5IGxvd2VyIHRoYW4gYWN0dWFsIHRhcmdldCBoZWlnaHQKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBJbmNsdWRlIGJhbGwgaW4gZnJhbWluZyB3aGVuIG5lYXJieQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5tZXNoICYmIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxQb3MgPSB0aGlzLmJhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSB0UG9zLmRpc3RhbmNlVG8oYmFsbFBvcyk7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCAyNSAmJiBkaXN0VG9CYWxsID4gMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxXZWlnaHQgPSBNYXRoLm1heCgwLCAxIC0gZGlzdFRvQmFsbCAvIDI1KSAqIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodDsKICAgICAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmxlcnAoYmFsbFBvcywgYmFsbFdlaWdodCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIElucHV0IEFudGljaXBhdGlvbiAoU21vb3RoZWQpCiAgICAgICAgICAgIHRoaXMuc21vb3RoZWRJbnB1dC5sZXJwKHRoaXMudGFyZ2V0SW5wdXQsIGR0ICogMy4wKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnNtb290aGVkSW5wdXQubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueCArPSB0aGlzLnNtb290aGVkSW5wdXQueCAqIDQuMDsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueiArPSB0aGlzLnNtb290aGVkSW5wdXQueiAqIDQuMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NhbGN1bGF0ZVRocmVhdExldmVsKGNlbnRlclBvcykgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSkgcmV0dXJuIDA7CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgZGVuc2l0eSA9IDA7CiAgICAgICAgICAgIGNvbnN0IGNoZWNrVGVhbSA9ICh0ZWFtKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXRlYW0pIHJldHVybjsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBpZiAocC5tZXNoICYmIHAubWVzaCAhPT0gdGhpcy50YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZFNxID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG9TcXVhcmVkKGNlbnRlclBvcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkU3EgPCA2NC4wKSB7IC8vIDhtIHJhZGl1cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVuc2l0eSArPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGNoZWNrVGVhbShnYW1lLnRlYW1zLmhvbWUpOwogICAgICAgICAgICBjaGVja1RlYW0oZ2FtZS50ZWFtcy5hd2F5KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBNYXRoLm1pbigxLjAsIGRlbnNpdHkgLyA0LjApOyAvLyBDYXAgYXQgNCBwbGF5ZXJzCiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IEdldCBmb3J3YXJkIGRpcmVjdGlvbiBmb3IgVUkgcmVmZXJlbmNlCiAgICAgICAgZ2V0Rm9yd2FyZERpcmVjdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX2NhbUZ3ZC5jbG9uZSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBHZXQgcmlnaHQgZGlyZWN0aW9uCiAgICAgICAgZ2V0UmlnaHREaXJlY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IHRoaXMuZ2V0Rm9yd2FyZERpcmVjdGlvbigpOwogICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApLCBmd2QpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICByZXR1cm4gX2NhbVJpZ2h0LmNsb25lKCk7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkNhbWVyYU1hbmFnZXIgPSBDYW1lcmFNYW5hZ2VyOwp9KSgpOwo=","/CameraManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyBSZXVzYWJsZSB2ZWN0b3JzIHRvIGF2b2lkIEdhcmJhZ2UgQ29sbGVjdGlvbgogICAgY29uc3QgX2lkZWFsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9pZGVhbExvb2sgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2N1cnJlbnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF92ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfdGFyZ2V0V29ybGRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICBjb25zdCBfbG9va0FoZWFkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9nb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgIGNvbnN0IF9jYW1Gd2QgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgY29uc3QgX2NhbVJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICBjbGFzcyBDYW1lcmFNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihjYW1lcmEsIHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CgogICAgICAgICAgICAvLyAtLS0gSU1QUk9WRUQgQ09ORklHVVJBVElPTiAtLS0KLy8gLS0tIElNUFJPVkVEIENPTkZJR1VSQVRJT04gLS0tCiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gewogICAgICAgICAgICAgICAgLy8gRklYRUQgUEVSU1BFQ1RJVkUgU0VUVElOR1MKICAgICAgICAgICAgICAgIGJhc2VEaXN0YW5jZTogMjAuMCwgICAvLyBTbGlnaHRseSBjbG9zZXIgZm9yIGltbWVyc2lvbgogICAgICAgICAgICAgICAgYmFzZUhlaWdodDogMTIuMCwgICAgIC8vIExvd2VyIGFuZ2xlIGZvciBjaGFzZSBmZWVsCgogICAgICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEZhc3RlciwgbW9yZSByZXNwb25zaXZlIHNtb290aGluZwogICAgICAgICAgICAgICAgZm9sbG93U3BlZWQ6IDYuMCwgICAgIC8vIFNuYXBwaWVyIGZvbGxvdwogICAgICAgICAgICAgICAgbG9va1NwZWVkOiA0LjAsICAgICAgIC8vIFJlc3BvbnNpdmUgbG9vay1hdAoKICAgICAgICAgICAgICAgIC8vIER5bmFtaWMgRk9WCiAgICAgICAgICAgICAgICBmb3ZCYXNlOiA1MCwKICAgICAgICAgICAgICAgIGZvdk1heDogNzAsICAgICAgICAgICAvLyBIaWdoZXIgbWF4IGZvciBzcGVlZCBzZW5zYXRpb24KCiAgICAgICAgICAgICAgICAvLyBJTVBST1ZFRDogTG9vay1haGVhZCBzZXR0aW5ncwogICAgICAgICAgICAgICAgbG9va0FoZWFkRGlzdGFuY2U6IDEwLjAsIC8vIExvb2sgZnVydGhlciBhaGVhZAogICAgICAgICAgICAgICAgbG9va0FoZWFkU21vb3RoaW5nOiA0LjAsCgogICAgICAgICAgICAgICAgLy8gU21hcnQgZnJhbWluZwogICAgICAgICAgICAgICAgYmFsbFRyYWNrV2VpZ2h0OiAwLjE1LCAKICAgICAgICAgICAgICAgIHRocmVhdEF3YXJlbmVzczogdHJ1ZQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gU3RhdGUKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmJhbGwgPSBudWxsOyAvLyBEaXJlY3QgYmFsbCByZWZlcmVuY2UgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICAgICAgdGhpcy50YXJnZXRWZWwgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwogICAgICAgICAgICB0aGlzLnRhcmdldElucHV0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZElucHV0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5zbW9vdGhlZExvb2tBaGVhZCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CgogICAgICAgICAgICAvLyBDYW1lcmEgU3RhdGUKICAgICAgICAgICAgdGhpcy5wb3MgPSBjYW1lcmEucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgdGhpcy5sb29rQXQgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKTsKCiAgICAgICAgICAgIC8vIE9yYml0IFN0YXRlCiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IE1hdGguUEk7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0WWF3ID0gTWF0aC5QSTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBNYW51YWwgb3JiaXQgZnJvbSB0b3VjaCAocmlnaHQgc2lkZSBvZiBzY3JlZW4pCiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgPSAwOwogICAgICAgICAgICB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggPSAwOwogICAgICAgICAgICB0aGlzLm9yYml0U2Vuc2l0aXZpdHkgPSAwLjAwNDsKICAgICAgICAgICAgdGhpcy5hdXRvUmVjZW50ZXJUaW1lciA9IDA7CiAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyRGVsYXkgPSAzLjA7CgovLyBTaGFrZQogICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gMDsKICAgICAgICAgICAgdGhpcy5zaGFrZVJvbGwgPSAwOyAvLyBORVc6IFJvdGF0aW9uYWwgc2hha2UKdGhpcy5zaGFrZU9mZnNldCA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSA9IDA7CiAgICAgICAgICAgIHRoaXMucm9sbEltcHVsc2UgPSAwOyAvLyBORVc6IER5bmFtaWMgdGlsdCBmb3IgY3VydmVzCgogICAgICAgICAgICAvLyBDaW5lbWF0aWMgU3RhdGUKICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1RpbWVyID0gMDsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVHlwZSA9ICdkZWZhdWx0JzsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljU3RhcnRMb29rID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNFbmRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IER5bmFtaWMgcHVsbC1iYWNrIGJhc2VkIG9uIGFjdGlvbgogICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4UHVsbEJhY2sgPSA4OwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBTZXQgYmFsbCByZWZlcmVuY2UgZm9yIHNtYXJ0IGZyYW1pbmcKICAgICAgICBzZXRCYWxsKGJhbGwpIHsKICAgICAgICAgICAgdGhpcy5iYWxsID0gYmFsbDsKICAgICAgICB9CgogICAgICAgIC8vIElNUFJPVkVEOiBHZXQgY2FtZXJhLXJlbGF0aXZlIGlucHV0IHRyYW5zZm9ybWF0aW9uCiAgICAgICAgZ2V0Q2FtZXJhUmVsYXRpdmVJbnB1dChpbnB1dFgsIGlucHV0WikgewogICAgICAgICAgICB0aGlzLmNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbihfY2FtRndkKTsKICAgICAgICAgICAgX2NhbUZ3ZC55ID0gMDsKCiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NhbVJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKSwgX2NhbUZ3ZCkubm9ybWFsaXplKCk7CgogICAgICAgICAgICAvLyBUcmFuc2Zvcm0gaW5wdXQgdG8gd29ybGQgc3BhY2UKICAgICAgICAgICAgY29uc3Qgd29ybGRYID0gKGlucHV0WCAqIF9jYW1SaWdodC54KSArIChpbnB1dFogKiBfY2FtRndkLngpOwogICAgICAgICAgICBjb25zdCB3b3JsZFogPSAoaW5wdXRYICogX2NhbVJpZ2h0LnopICsgKGlucHV0WiAqIF9jYW1Gd2Queik7CgogICAgICAgICAgICByZXR1cm4geyB4OiB3b3JsZFgsIHo6IHdvcmxkWiB9OwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBNYW51YWwgb3JiaXQgaW5wdXQgZnJvbSB0b3VjaAogICAgICAgIGhhbmRsZU9yYml0SW5wdXQoZHgsIGR5KSB7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRZYXcgKz0gZHggKiB0aGlzLm9yYml0U2Vuc2l0aXZpdHk7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCArPSBkeSAqIHRoaXMub3JiaXRTZW5zaXRpdml0eSAqIDAuNTsKCiAgICAgICAgICAgIC8vIENsYW1wIHBpdGNoCiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IE1hdGgubWF4KC0wLjMsIE1hdGgubWluKDAuNSwgdGhpcy5tYW51YWxPcmJpdFBpdGNoKSk7CgogICAgICAgICAgICAvLyBSZXNldCBhdXRvLXJlY2VudGVyIHRpbWVyCiAgICAgICAgICAgIHRoaXMuYXV0b1JlY2VudGVyVGltZXIgPSAwOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBSZWNlbnRlciBjYW1lcmEKICAgICAgICByZWNlbnRlcigpIHsKICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyA9IDA7CiAgICAgICAgICAgIHRoaXMubWFudWFsT3JiaXRQaXRjaCA9IDA7CiAgICAgICAgfQoKICAgICAgICBwbGF5Q2luZW1hdGljKHR5cGUsIHRhcmdldCwgZHVyYXRpb24gPSAxLjUpIHsKICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2luZW1hdGljVGltZXIgPSAwOwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY0R1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgICB0aGlzLmNpbmVtYXRpY1R5cGUgPSB0eXBlOwoKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydFBvcy5jb3B5KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNTdGFydExvb2suY29weSh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLmFkZEZvdkltcHVsc2UoLTE1KTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVDaW5lbWF0aWMoZHQpIHsKICAgICAgICAgICAgdGhpcy5jaW5lbWF0aWNUaW1lciArPSBkdDsKICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBNYXRoLm1pbigxLjAsIHRoaXMuY2luZW1hdGljVGltZXIgLyB0aGlzLmNpbmVtYXRpY0R1cmF0aW9uKTsKCiAgICAgICAgICAgIGNvbnN0IHQgPSAxIC0gTWF0aC5wb3coMSAtIHByb2dyZXNzLCAzKTsKCiAgICAgICAgICAgIGxldCBhY3RpdmVUYXJnZXQgPSB0aGlzLnRhcmdldDsKICAgICAgICAgICAgbGV0IGlzQmFsbFRyYWNraW5nID0gZmFsc2U7CiAgICAgICAgICAgIGNvbnN0IGJhbGwgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgPyB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZW50aXRpZXMuYmFsbCA6IG51bGw7CgogICAgICAgICAgICBpZiAoYmFsbCAmJiBiYWxsLm1lc2ggJiYgYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnICYmIGJhbGwudmVsb2NpdHkubGVuZ3RoU3EoKSA+IDIuMCkgewogICAgICAgICAgICAgICAgYWN0aXZlVGFyZ2V0ID0gYmFsbC5tZXNoOwogICAgICAgICAgICAgICAgaXNCYWxsVHJhY2tpbmcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWFjdGl2ZVRhcmdldCkgewogICAgICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhY3RpdmVUYXJnZXQuZ2V0V29ybGRQb3NpdGlvbihfdGFyZ2V0V29ybGRQb3MpOwoKICAgICAgICAgICAgY29uc3QgZW5kTG9vayA9IF90YXJnZXRXb3JsZFBvcy5jbG9uZSgpOwogICAgICAgICAgICBsZXQgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKICAgICAgICAgICAgbGV0IHJpZ2h0ID0gbmV3IFRIUkVFLlZlY3RvcjMoKTsKCiAgICAgICAgICAgIGlmIChpc0JhbGxUcmFja2luZykgewogICAgICAgICAgICAgICAgZW5kTG9vay5hZGRTY2FsZWRWZWN0b3IoYmFsbC52ZWxvY2l0eSwgMC4zKTsKCiAgICAgICAgICAgICAgICBmd2QuY29weShiYWxsLnZlbG9jaXR5KS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIGZ3ZC55ID0gMDsKICAgICAgICAgICAgICAgIGlmIChmd2QubGVuZ3RoU3EoKSA8IDAuMDEpIGZ3ZC5zZXQoMCwwLDEpOwogICAgICAgICAgICAgICAgZndkLm5vcm1hbGl6ZSgpOwoKICAgICAgICAgICAgICAgIHJpZ2h0LmNyb3NzVmVjdG9ycyhuZXcgVEhSRUUuVmVjdG9yMygwLDEsMCksIGZ3ZCkubm9ybWFsaXplKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbmRMb29rLnkgKz0gMS41OwogICAgICAgICAgICAgICAgZndkLnNldCgwLCAwLCAxKS5hcHBseVF1YXRlcm5pb24oYWN0aXZlVGFyZ2V0LnF1YXRlcm5pb24pOwogICAgICAgICAgICAgICAgcmlnaHQuc2V0KDEsIDAsIDApLmFwcGx5UXVhdGVybmlvbihhY3RpdmVUYXJnZXQucXVhdGVybmlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGVuZFBvcyA9IF90YXJnZXRXb3JsZFBvcy5jbG9uZSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ2plY2h0JykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGlzQmFsbFRyYWNraW5nID8gMTQuMCA6IDEwLjA7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmd2QuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtZGlzdCkuYWRkKHJpZ2h0LmNsb25lKCkubXVsdGlwbHlTY2FsYXIoMy4wKSk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSA2LjA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5jaW5lbWF0aWNUeXBlID09PSAnc3BoZXJlJykgewogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IGlzQmFsbFRyYWNraW5nID8gMTYuMCA6IDEyLjA7CiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmd2QuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtZGlzdCk7CiAgICAgICAgICAgICAgICBlbmRQb3MuYWRkKG9mZnNldCk7CiAgICAgICAgICAgICAgICBlbmRQb3MueSArPSAxMC4wOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2luZW1hdGljVHlwZSA9PT0gJ2ludmlzaWJsZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSAxMi4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QgKiAwLjUpLmFkZChyaWdodC5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKGRpc3QpKTsKICAgICAgICAgICAgICAgIGVuZFBvcy5hZGQob2Zmc2V0KTsKICAgICAgICAgICAgICAgIGVuZFBvcy55ICs9IDUuMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBpc0JhbGxUcmFja2luZyA/IDE0LjAgOiAxMC4wOwogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZndkLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLWRpc3QpOwogICAgICAgICAgICAgICAgZW5kUG9zLmFkZChvZmZzZXQpOwogICAgICAgICAgICAgICAgZW5kUG9zLnkgKz0gNS4wOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnBvcy5sZXJwKGVuZFBvcywgZHQgKiA0LjApOwogICAgICAgICAgICB0aGlzLmxvb2tBdC5sZXJwKGVuZExvb2ssIGR0ICogNi4wKTsKCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLmNvcHkodGhpcy5wb3MpOwogICAgICAgICAgICB0aGlzLmNhbWVyYS5sb29rQXQodGhpcy5sb29rQXQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2luZW1hdGljVGltZXIgPj0gdGhpcy5jaW5lbWF0aWNEdXJhdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5pc0NpbmVtYXRpYyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKc2V0VGFyZ2V0KG1lc2gsIHZlbG9jaXR5LCBpbnB1dCwgaXNBaW1pbmcgPSBmYWxzZSkgewogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG1lc2g7CiAgICAgICAgICAgIGlmICh2ZWxvY2l0eSkgdGhpcy50YXJnZXRWZWwuY29weSh2ZWxvY2l0eSk7CiAgICAgICAgICAgIGlmIChpbnB1dCkgdGhpcy50YXJnZXRJbnB1dC5jb3B5KGlucHV0KTsKICAgICAgICAgICAgZWxzZSB0aGlzLnRhcmdldElucHV0LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgdGhpcy5pc0FpbWluZyA9IGlzQWltaW5nOwogICAgICAgIH0KCiAgICAgICAgLy8gS2VlcCBmb3IgY29tcGF0aWJpbGl0eQogICAgICAgIGhhbmRsZUlucHV0KGR4LCBkeSkgewogICAgICAgICAgICB0aGlzLmhhbmRsZU9yYml0SW5wdXQoZHgsIGR5KTsKICAgICAgICB9CgogICAgICAgIGdldFlhdygpIHsgcmV0dXJuIHRoaXMuY3VycmVudFlhdzsgfQoKICAgICAgICBhZGRTaGFrZShhbW91bnQpIHsKCiAgICAgICAgICAgIHRoaXMuc2hha2VJbnRlbnNpdHkgPSBNYXRoLm1pbih0aGlzLnNoYWtlSW50ZW5zaXR5ICsgYW1vdW50LCA0LjApOyAvLyBJbmNyZWFzZWQgY2FwCiAgICAgICAgICAgIHRoaXMuc2hha2VSb2xsID0gTWF0aC5taW4odGhpcy5zaGFrZVJvbGwgKyBhbW91bnQgKiAwLjIsIDAuOCk7IC8vIEFkZCByb2xsCiAgICAgICAgfQogICAgICAgIGFkZEZvdkltcHVsc2UoYW1vdW50KSB7CiAgICAgICAgICAgIHRoaXMuZm92SW1wdWxzZSA9IE1hdGgubWluKHRoaXMuZm92SW1wdWxzZSArIGFtb3VudCwgMzApOwoKICAgICAgICB9CiAgICAgICAgYWRkUm9sbEltcHVsc2UoYW1vdW50KSB7CiAgICAgICAgICAgIHRoaXMucm9sbEltcHVsc2UgKz0gYW1vdW50OwogICAgICAgICAgICAvLyBDbGFtcAogICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlID0gTWF0aC5tYXgoLTAuNSwgTWF0aC5taW4oMC41LCB0aGlzLnJvbGxJbXB1bHNlKSk7Cn0KCiAgICAgICAgc25hcFRvVGFyZ2V0KCkgewogICAgICAgICAgICBpZiAoIXRoaXMudGFyZ2V0KSByZXR1cm47CiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIHRoaXMuX2NhbGN1bGF0ZUlkZWFsU3RhdGUoMCk7CgogICAgICAgICAgICB0aGlzLnBvcy5jb3B5KF9pZGVhbFBvcyk7CiAgICAgICAgICAgIHRoaXMubG9va0F0LmNvcHkoX2lkZWFsTG9vayk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFlhdyA9IHRoaXMudGFyZ2V0WWF3OwoKICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uY29weSh0aGlzLnBvcyk7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmxvb2tBdCh0aGlzLmxvb2tBdCk7CgogICAgICAgICAgICB0aGlzLnNtb290aGVkSW5wdXQuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLCAwLCAwKTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0NpbmVtYXRpYykgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlQ2luZW1hdGljKGR0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLnRhcmdldCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgc2FmZUR0ID0gTWF0aC5taW4oZHQsIDAuMDUpOwoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IEF1dG8tcmVjZW50ZXIgbG9naWMgKE9ubHkgaWYgbm90IGFpbWluZykKICAgICAgICAgICAgaWYgKCF0aGlzLmlzQWltaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF1dG9SZWNlbnRlclRpbWVyICs9IHNhZmVEdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1dG9SZWNlbnRlclRpbWVyID4gdGhpcy5hdXRvUmVjZW50ZXJEZWxheSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY2VudGVyU3BlZWQgPSAyLjAgKiBzYWZlRHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFlhdyAqPSAoMS4wIC0gcmVjZW50ZXJTcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW51YWxPcmJpdFBpdGNoICo9ICgxLjAgLSByZWNlbnRlclNwZWVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSU1QUk9WRUQ6IFNtYXJ0IHB1bGwtYmFjayBiYXNlZCBvbiBiYWxsIHNwZWVkCiAgICAgICAgICAgIGlmICh0aGlzLmJhbGwgJiYgdGhpcy5iYWxsLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICBjb25zdCBiYWxsU3BlZWQgPSB0aGlzLmJhbGwudmVsb2NpdHkubGVuZ3RoKCk7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRQdWxsQmFjayA9IE1hdGgubWluKHRoaXMubWF4UHVsbEJhY2ssIGJhbGxTcGVlZCAqIDAuMyk7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayArPSAodGFyZ2V0UHVsbEJhY2sgLSB0aGlzLmN1cnJlbnRQdWxsQmFjaykgKiBzYWZlRHQgKiAzLjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQdWxsQmFjayAqPSAoMS4wIC0gc2FmZUR0ICogMi4wKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMS4gVXBkYXRlIFRhcmdldCBJbmZvCiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmdldFdvcmxkUG9zaXRpb24oX3RhcmdldFdvcmxkUG9zKTsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBTdGF0ZQogICAgICAgICAgICB0aGlzLl9jYWxjdWxhdGVJZGVhbFN0YXRlKHNhZmVEdCk7CgogICAgICAgICAgICAvLyAzLiBJTVBST1ZFRDogRmFzdGVyLCBtb3JlIHJlc3BvbnNpdmUgc21vb3RoaW5nCi8vIDMuIElNUFJPVkVEOiBGYXN0ZXIsIG1vcmUgcmVzcG9uc2l2ZSBzbW9vdGhpbmcKICAgICAgICAgICAgLy8gRHluYW1pYyBmb2xsb3cgc3BlZWQgYmFzZWQgb24gZGlzdGFuY2UgZXJyb3IgKENhdGNoLXVwIGxvZ2ljKQogICAgICAgICAgICBjb25zdCBkaXN0RXJyb3IgPSB0aGlzLnBvcy5kaXN0YW5jZVRvKF9pZGVhbFBvcyk7CiAgICAgICAgICAgIGNvbnN0IGR5bmFtaWNGb2xsb3cgPSB0aGlzLmNvbmZpZy5mb2xsb3dTcGVlZCArIChkaXN0RXJyb3IgKiAwLjIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3Qgc3BlZWRNdWx0ID0gdGhpcy5pc0FpbWluZyA/IDIuMCA6IDEuMDsKICAgICAgICAgICAgY29uc3QgbG9va0ZhY3RvciA9IDEuMCAtIE1hdGguZXhwKC10aGlzLmNvbmZpZy5sb29rU3BlZWQgKiBzcGVlZE11bHQgKiBzYWZlRHQpOwogICAgICAgICAgICBjb25zdCBwb3NGYWN0b3IgPSAxLjAgLSBNYXRoLmV4cCgtZHluYW1pY0ZvbGxvdyAqIHNwZWVkTXVsdCAqIHNhZmVEdCk7CgogICAgICAgICAgICB0aGlzLnBvcy5sZXJwKF9pZGVhbFBvcywgcG9zRmFjdG9yKTsKICAgICAgICAgICAgdGhpcy5wb3MubGVycChfaWRlYWxQb3MsIHBvc0ZhY3Rvcik7CiAgICAgICAgICAgIHRoaXMubG9va0F0LmxlcnAoX2lkZWFsTG9vaywgbG9va0ZhY3Rvcik7CgogICAgICAgICAgICAvLyA0LiBTY3JlZW4gU2hha2UgKFBvc2l0aW9uICYgUm90YXRpb24pCiAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlSW50ZW5zaXR5ID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgZGVjYXkgPSA4LjAgKiBzYWZlRHQ7IC8vIEZhc3QgZGVjYXkgZm9yIHNuYXBweSBmZWVsCiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlSW50ZW5zaXR5IC09IGRlY2F5OwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2hha2VJbnRlbnNpdHkgPCAwKSB0aGlzLnNoYWtlSW50ZW5zaXR5ID0gMDsKCiAgICAgICAgICAgICAgICBjb25zdCBzaGFrZU1hZyA9IHRoaXMuc2hha2VJbnRlbnNpdHkgKiAwLjU7CiAgICAgICAgICAgICAgICB0aGlzLnNoYWtlT2Zmc2V0LnNldCgKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZU1hZywKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZU1hZywKICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzaGFrZU1hZwogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hha2VPZmZzZXQuc2V0KDAsIDAsIDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSb2xsIFNoYWtlCiAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlUm9sbCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hha2VSb2xsIC09IDUuMCAqIHNhZmVEdDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNoYWtlUm9sbCA8IDApIHRoaXMuc2hha2VSb2xsID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhLnJvdGF0aW9uLnogPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiB0aGlzLnNoYWtlUm9sbDsKfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FtZXJhLnJvdGF0aW9uLnogPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBDdXJ2ZSBUaWx0IChSb2xsIEltcHVsc2UpCiAgICAgICAgICAgIGlmIChNYXRoLmFicyh0aGlzLnJvbGxJbXB1bHNlKSA+IDAuMDAxKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYS5yb3RhdGlvbi56ICs9IHRoaXMucm9sbEltcHVsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnJvbGxJbXB1bHNlICo9ICgxLjAgLSA0LjAgKiBzYWZlRHQpOyAvLyBEZWNheQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA1LiBEeW5hbWljIEZPVgovLyA1LiBEeW5hbWljIEZPVgogICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudGFyZ2V0VmVsLmxlbmd0aCgpOwogICAgICAgICAgICBjb25zdCBzcGVlZFJhdGlvID0gTWF0aC5taW4oc3BlZWQgLyAyNS4wLCAxLjApOwogICAgICAgICAgICBjb25zdCB3YXJwID0gc3BlZWRSYXRpbyAqIHNwZWVkUmF0aW87CgogICAgICAgICAgICAvLyBab29tIGluIHNsaWdodGx5IHdoZW4gYWltaW5nCiAgICAgICAgICAgIGNvbnN0IGFpbVpvb20gPSB0aGlzLmlzQWltaW5nID8gLTEwIDogMDsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0Rm92ID0gdGhpcy5jb25maWcuZm92QmFzZSArICh0aGlzLmNvbmZpZy5mb3ZNYXggLSB0aGlzLmNvbmZpZy5mb3ZCYXNlKSAqIHdhcnAgKyB0aGlzLmZvdkltcHVsc2UgKyBhaW1ab29tOwoKICAgICAgICAgICAgdGhpcy5mb3ZJbXB1bHNlICo9IE1hdGgubWF4KDAsIDEuMCAtICg2LjAgKiBzYWZlRHQpKTsKCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmZvdiArPSAodGFyZ2V0Rm92IC0gdGhpcy5jYW1lcmEuZm92KSAqIDQuMCAqIHNhZmVEdDsKICAgICAgICAgICAgdGhpcy5jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwoKICAgICAgICAgICAgLy8gNi4gQXBwbHkgdG8gQ2FtZXJhCiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLmNvcHkodGhpcy5wb3MpLmFkZCh0aGlzLnNoYWtlT2Zmc2V0KTsKICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMubG9va0F0KTsKICAgICAgICB9CgpfY2FsY3VsYXRlSWRlYWxTdGF0ZShkdCkgewogICAgICAgICAgICBjb25zdCB0UG9zID0gX3RhcmdldFdvcmxkUG9zOwoKICAgICAgICAgICAgLy8gLS0tIEFJTSBNT0RFIE9WRVJSSURFIC0tLQogICAgICAgICAgICBpZiAodGhpcy5pc0FpbWluZykgewogICAgICAgICAgICAgICAgLy8gUmVsYXhlZCBBaW0gTW9kZTogWm9vbSBpbiBidXQgbWFpbnRhaW4gb3JpZW50YXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IGFpbURpc3QgPSAxNC4wOyAKICAgICAgICAgICAgICAgIGNvbnN0IGFpbUhlaWdodCA9IDYuMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVXNlIE1hbnVhbCBPcmJpdCBMb2dpYyAoQ29uc2lzdGVudCB3aXRoIFN0YW5kYXJkIE1vZGUpCiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVEaXN0YW5jZSA9IGFpbURpc3Q7CiAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVIZWlnaHQgPSBhaW1IZWlnaHQgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmFzZSBaIG9mZnNldCAoQ2FtZXJhIGRlZmF1bHRzIHRvICtaKQogICAgICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBcHBseSBPcmJpdCBSb3RhdGlvbgogICAgICAgICAgICAgICAgY29uc3QgZmluYWxYID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgY29uc3QgZmluYWxaID0gY2FtWiAqIE1hdGguY29zKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbFopOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmNvcHkodFBvcyk7CiAgICAgICAgICAgICAgICBfaWRlYWxMb29rLnkgKz0gMS4wOyAvLyBMb29rIGF0IHBsYXllciBjZW50ZXIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzYWJsZSBsb29rLWFoZWFkIHRvIGtlZXAgZnJhbWluZyBzdGFibGUgd2hpbGUgYWltaW5nCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLS0tIFNUQU5EQVJEIE1PREUgLS0tCgogICAgICAgICAgICAvLyAwLiBUaHJlYXQgQXNzZXNzbWVudCAoRHluYW1pYyBQdWxsLWJhY2spCiAgICAgICAgICAgIGxldCB0aHJlYXRQdWxsYmFjayA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLmNvbmZpZy50aHJlYXRBd2FyZW5lc3MpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRocmVhdCA9IHRoaXMuX2NhbGN1bGF0ZVRocmVhdExldmVsKHRQb3MpOwogICAgICAgICAgICAgICAgdGhyZWF0UHVsbGJhY2sgPSB0aHJlYXQgKiA2LjA7IC8vIFB1bGwgYmFjayB1cCB0byA2IHVuaXRzCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBBcHBseSBtYW51YWwgb3JiaXQKICAgICAgICAgICAgLy8gMS4gQ2FsY3VsYXRlIElkZWFsIFBvc2l0aW9uIHdpdGggcHVsbC1iYWNrCiAgICAgICAgICAgIGNvbnN0IGVmZmVjdGl2ZURpc3RhbmNlID0gdGhpcy5jb25maWcuYmFzZURpc3RhbmNlICsgdGhpcy5jdXJyZW50UHVsbEJhY2sgKyB0aHJlYXRQdWxsYmFjazsKICAgICAgICAgICAgY29uc3QgZWZmZWN0aXZlSGVpZ2h0ID0gdGhpcy5jb25maWcuYmFzZUhlaWdodCArIHRoaXMuY3VycmVudFB1bGxCYWNrICogMC4zICsgdGhyZWF0UHVsbGJhY2sgKiAwLjUgKyB0aGlzLm1hbnVhbE9yYml0UGl0Y2ggKiAxMDsKCiAgICAgICAgICAgIC8vIEJhc2Ugb2Zmc2V0IChDYW1lcmEgdXN1YWxseSBzaXRzIGF0ICtaIHJlbGF0aXZlIHRvIHRhcmdldCkKICAgICAgICAgICAgY29uc3QgY2FtWiA9IGVmZmVjdGl2ZURpc3RhbmNlOwoKICAgICAgICAgICAgLy8gQXBwbHkgT3JiaXQgUm90YXRpb24KICAgICAgICAgICAgY29uc3QgZmluYWxDYW1YID0gY2FtWiAqIE1hdGguc2luKHRoaXMubWFudWFsT3JiaXRZYXcpOwogICAgICAgICAgICBjb25zdCBmaW5hbENhbVogPSBjYW1aICogTWF0aC5jb3ModGhpcy5tYW51YWxPcmJpdFlhdyk7CgogICAgICAgICAgICBfaWRlYWxQb3Muc2V0KHRQb3MueCArIGZpbmFsQ2FtWCwgdFBvcy55ICsgZWZmZWN0aXZlSGVpZ2h0LCB0UG9zLnogKyBmaW5hbENhbVopOwoKICAgICAgICAgICAgLy8gQ2xhbXAgdG8gYXJlbmEgYm91bmRzIChyb3VnaGx5KSB0byBwcmV2ZW50IGNsaXBwaW5nIHRocm91Z2ggd2FsbHMKICAgICAgICAgICAgaWYgKF9pZGVhbFBvcy56ID4gNDguMCkgX2lkZWFsUG9zLnogPSA0OC4wOwogICAgICAgICAgICBpZiAoX2lkZWFsUG9zLnogPCAtNDguMCkgX2lkZWFsUG9zLnogPSAtNDguMDsKCiAgICAgICAgICAgIC8vIDIuIENhbGN1bGF0ZSBJZGVhbCBMb29rQXQgd2l0aCBJTVBST1ZFRCBsb29rLWFoZWFkCiAgICAgICAgICAgIF9pZGVhbExvb2suY29weSh0UG9zKTsKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBWZWxvY2l0eS1iYXNlZCBsb29rLWFoZWFkCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFZlbC5sZW5ndGhTcSgpID4gMC41KSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMudGFyZ2V0VmVsLmxlbmd0aCgpOwogICAgICAgICAgICAgICAgY29uc3QgbG9va0FoZWFkRmFjdG9yID0gTWF0aC5taW4oMS4wLCBzcGVlZCAvIDE1LjApICogdGhpcy5jb25maWcubG9va0FoZWFkRGlzdGFuY2U7CgogICAgICAgICAgICAgICAgY29uc3QgdmVsRGlyID0gdGhpcy50YXJnZXRWZWwuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIF9sb29rQWhlYWQuY29weSh2ZWxEaXIpLm11bHRpcGx5U2NhbGFyKGxvb2tBaGVhZEZhY3Rvcik7CgogICAgICAgICAgICAgICAgLy8gU21vb3RoIHRoZSBsb29rLWFoZWFkCiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLmxlcnAoX2xvb2tBaGVhZCwgZHQgKiB0aGlzLmNvbmZpZy5sb29rQWhlYWRTbW9vdGhpbmcpOwogICAgICAgICAgICAgICAgX2lkZWFsTG9vay5hZGQodGhpcy5zbW9vdGhlZExvb2tBaGVhZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNtb290aGVkTG9va0FoZWFkLm11bHRpcGx5U2NhbGFyKDEuMCAtIGR0ICogMy4wKTsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2suYWRkKHRoaXMuc21vb3RoZWRMb29rQWhlYWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfaWRlYWxMb29rLnkgKj0gMC41OyAvLyBMb29rIHNsaWdodGx5IGxvd2VyIHRoYW4gYWN0dWFsIHRhcmdldCBoZWlnaHQKCiAgICAgICAgICAgIC8vIElNUFJPVkVEOiBJbmNsdWRlIGJhbGwgaW4gZnJhbWluZyB3aGVuIG5lYXJieQogICAgICAgICAgICBpZiAodGhpcy5iYWxsICYmIHRoaXMuYmFsbC5tZXNoICYmIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxQb3MgPSB0aGlzLmJhbGwubWVzaC5wb3NpdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RUb0JhbGwgPSB0UG9zLmRpc3RhbmNlVG8oYmFsbFBvcyk7CgogICAgICAgICAgICAgICAgaWYgKGRpc3RUb0JhbGwgPCAyNSAmJiBkaXN0VG9CYWxsID4gMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhbGxXZWlnaHQgPSBNYXRoLm1heCgwLCAxIC0gZGlzdFRvQmFsbCAvIDI1KSAqIHRoaXMuY29uZmlnLmJhbGxUcmFja1dlaWdodDsKICAgICAgICAgICAgICAgICAgICBfaWRlYWxMb29rLmxlcnAoYmFsbFBvcywgYmFsbFdlaWdodCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDMuIElucHV0IEFudGljaXBhdGlvbiAoU21vb3RoZWQpCiAgICAgICAgICAgIHRoaXMuc21vb3RoZWRJbnB1dC5sZXJwKHRoaXMudGFyZ2V0SW5wdXQsIGR0ICogMy4wKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnNtb290aGVkSW5wdXQubGVuZ3RoU3EoKSA+IDAuMDEpIHsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueCArPSB0aGlzLnNtb290aGVkSW5wdXQueCAqIDQuMDsKICAgICAgICAgICAgICAgIF9pZGVhbExvb2sueiArPSB0aGlzLnNtb290aGVkSW5wdXQueiAqIDQuMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NhbGN1bGF0ZVRocmVhdExldmVsKGNlbnRlclBvcykgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSkgcmV0dXJuIDA7CiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2U7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgZGVuc2l0eSA9IDA7CiAgICAgICAgICAgIGNvbnN0IGNoZWNrVGVhbSA9ICh0ZWFtKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXRlYW0pIHJldHVybjsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGVhbS5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHRlYW0ucGxheWVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBpZiAocC5tZXNoICYmIHAubWVzaCAhPT0gdGhpcy50YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZFNxID0gcC5tZXNoLnBvc2l0aW9uLmRpc3RhbmNlVG9TcXVhcmVkKGNlbnRlclBvcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkU3EgPCA2NC4wKSB7IC8vIDhtIHJhZGl1cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVuc2l0eSArPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGNoZWNrVGVhbShnYW1lLnRlYW1zLmhvbWUpOwogICAgICAgICAgICBjaGVja1RlYW0oZ2FtZS50ZWFtcy5hd2F5KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBNYXRoLm1pbigxLjAsIGRlbnNpdHkgLyA0LjApOyAvLyBDYXAgYXQgNCBwbGF5ZXJzCiAgICAgICAgfQoKICAgICAgICAvLyBORVc6IEdldCBmb3J3YXJkIGRpcmVjdGlvbiBmb3IgVUkgcmVmZXJlbmNlCiAgICAgICAgZ2V0Rm9yd2FyZERpcmVjdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5jYW1lcmEuZ2V0V29ybGREaXJlY3Rpb24oX2NhbUZ3ZCk7CiAgICAgICAgICAgIF9jYW1Gd2QueSA9IDA7CiAgICAgICAgICAgIGlmIChfY2FtRndkLmxlbmd0aFNxKCkgPCAwLjAwMSkgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5zZXQoMCwgMCwgLTEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2NhbUZ3ZC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX2NhbUZ3ZC5jbG9uZSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gTkVXOiBHZXQgcmlnaHQgZGlyZWN0aW9uCiAgICAgICAgZ2V0UmlnaHREaXJlY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IGZ3ZCA9IHRoaXMuZ2V0Rm9yd2FyZERpcmVjdGlvbigpOwogICAgICAgICAgICBfY2FtUmlnaHQuY3Jvc3NWZWN0b3JzKG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApLCBmd2QpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICByZXR1cm4gX2NhbVJpZ2h0LmNsb25lKCk7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkNhbWVyYU1hbmFnZXIgPSBDYW1lcmFNYW5hZ2VyOwp9KSgpOwo=","ParticleManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUT1JTIC0tLQogICAgCiAgICAvLyAxLiBWZW5vbSBCdWJibGUgKEdyZWVuLCBzaGlueSwgc2hhcnApCiAgICBjb25zdCBfdmVub21UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMzIsIDMyLCA0LCAzMiwgMzIsIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgxNTAsIDI1NSwgMTAwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgwLCAyMDAsIDAsIDAuNSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCA1MCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45KSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDIwLCAyMCwgNiwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDIuIFNsZWVwIFp6egogICAgY29uc3QgX25hcFRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZvbnQgPSAnYm9sZCBpdGFsaWMgNDhweCBzYW5zLXNlcmlmJzsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gJyMwMDAwZmYnOwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gNDsKICAgICAgICBjdHguZmlsbFRleHQoJ1onLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gMy4gV2l0aGVyIFNtb2tlIChPcHRpbWl6ZWQgdG8gMzJ4MzIpCiAgICBjb25zdCBfd2l0aGVyVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDE2LCAxNiwgMCwgMTYsIDE2LCAxNik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoODAsIDgwLCA4MCwgMC44KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoNDAsIDQwLCA0MCwgMC40KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIDMyLCAzMik7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA0LiBTaG9ja3dhdmUgUmluZyAoT3B0aW1pemVkIHRvIDY0eDY0KQogICAgY29uc3QgX3Nob2Nrd2F2ZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgY3ggPSAzMiwgY3kgPSAzMjsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGN4LCBjeSwgMjAsIGN4LCBjeSwgMzApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC41LCAncmdiYSgyNTUsIDI1NSwgMjU1LCAxKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIDY0LCA2NCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA1LiBGbGFzaCBTdGFyIChPcHRpbWl6ZWQgdG8gMzJ4MzIpCiAgICBjb25zdCBfZmxhc2hUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGN4ID0gMTYsIGN5ID0gMTY7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgZm9yKGxldCBpPTA7IGk8NDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGEgPSAoaSAqIE1hdGguUEkgLyAyKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyhjeCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYSkqMTUsIGN5ICsgTWF0aC5zaW4oYSkqMTUpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYSArIDAuMikqNSwgY3kgKyBNYXRoLnNpbihhICsgMC4yKSo1KTsKICAgICAgICB9CiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGN4LCBjeSwgMCwgY3gsIGN5LCAxMCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyhjeCwgY3ksIDEwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNi4gRGVicmlzIFNoYXJkIChOZXcpCiAgICBjb25zdCBfZGVicmlzVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDE2LCAwKTsgY3R4LmxpbmVUbygzMiwgMTYpOyBjdHgubGluZVRvKDE2LCAzMik7IGN0eC5saW5lVG8oMCwgMTYpOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA3LiBCdWJibGUgVGV4dHVyZSAoTmV3OiBBZXN0aGV0aWMgJiBTdWJ0bGUpCiAgICBjb25zdCBfYnViYmxlVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIDY0LCA2NCk7CgogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMzIsIDMyLCAwLCAzMiwgMzIsIDI4KTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjk1KScpOyAKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjMsICdyZ2JhKDIwMCwgMjQwLCAyNTUsIDAuNCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjgsICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCAwLCAwLCAwKScpOwogICAgICAgIAogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYygzMiwgMzIsIDMwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgyNTUsIDI1NSwgMjU1LCAxLjApJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IAogICAgICAgIGN0eC5hcmMoMjAsIDIwLCA0LCAwLCBNYXRoLlBJICogMik7IAogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA4LiBNaWNybyBCdWJibGUgKE5ldzogU2hhcnAsIGhpZ2gtdmlzIGNhdml0YXRpb24pCiAgICBjb25zdCBfbWljcm9CdWJibGVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgMzIsIDMyKTsKICAgICAgICAKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDE2LCAxNiwgMCwgMTYsIDE2LCAxNik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMS4wKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuMywgJ3JnYmEoMjIwLCAyNTUsIDI1NSwgMC44KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNiwgJ3JnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEuMCwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMTYsIDE2LCAxNiwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDkuIERhc2ggU3RyZWFtIChTcXVhcmUgZm9yIFBvaW50cykKICAgIGNvbnN0IF9kYXNoU3RyZWFtVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICAvLyBEcmF3IGEgc3RyZWFrIGluIHRoZSBtaWRkbGUKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZUxpbmVhckdyYWRpZW50KDAsIDAsIDY0LCAwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgwLCAyNTUsIDI1NSwgMCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjUsICdyZ2JhKDIwMCwgMjU1LCAyNTUsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCAyNTUsIDI1NSwgMCknKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguZmlsbFJlY3QoMCwgMjgsIDY0LCA4KTsgLy8gQ2VudGVyZWQgdmVydGljYWxseQogICAgICAgIAogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gLS0tIFBBUlRJQ0xFIEJBVENIIFNZU1RFTSAoVEhSRUUuUG9pbnRzKSAtLS0KICAgIGNsYXNzIFBhcnRpY2xlQmF0Y2ggewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lLCB0ZXh0dXJlLCBtYXhQYXJ0aWNsZXMgPSAyMDAsIGJsZW5kaW5nID0gVEhSRUUuQWRkaXRpdmVCbGVuZGluZykgewogICAgICAgICAgICB0aGlzLm1heFBhcnRpY2xlcyA9IG1heFBhcnRpY2xlczsKICAgICAgICAgICAgdGhpcy5hY3RpdmVDb3VudCA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDUFUgU3RhdGUKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXMgPSBbXTsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8bWF4UGFydGljbGVzOyBpKyspIHsKICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVzLnB1c2goewogICAgICAgICAgICAgICAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgcG9zOiBuZXcgVEhSRUUuVmVjdG9yMygpLAogICAgICAgICAgICAgICAgICAgIHZlbDogbmV3IFRIUkVFLlZlY3RvcjMoKSwKICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLAogICAgICAgICAgICAgICAgICAgIG1heExpZmU6IDEsCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDEsCiAgICAgICAgICAgICAgICAgICAgc3RhcnRTY2FsZTogMSwKICAgICAgICAgICAgICAgICAgICByb3RhdGlvbjogMCwKICAgICAgICAgICAgICAgICAgICBncmF2aXR5OiAwLAogICAgICAgICAgICAgICAgICAgIGRyYWc6IDAsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IG5ldyBUSFJFRS5Db2xvcigxLDEsMSksCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEdQVSBCdWZmZXJzCiAgICAgICAgICAgIHRoaXMucG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShtYXhQYXJ0aWNsZXMgKiAzKTsKICAgICAgICAgICAgdGhpcy5zaXplcyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzKTsKICAgICAgICAgICAgdGhpcy5yb3RhdGlvbnMgPSBuZXcgRmxvYXQzMkFycmF5KG1heFBhcnRpY2xlcyk7CiAgICAgICAgICAgIHRoaXMub3BhY2l0aWVzID0gbmV3IEZsb2F0MzJBcnJheShtYXhQYXJ0aWNsZXMpOwogICAgICAgICAgICB0aGlzLmNvbG9ycyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzICogMyk7CgogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMucG9zaXRpb25zLCAzKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ3NpemUnLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMuc2l6ZXMsIDEpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgncm90YXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMucm90YXRpb25zLCAxKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ29wYWNpdHknLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMub3BhY2l0aWVzLCAxKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ2NvbG9yJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZSh0aGlzLmNvbG9ycywgMykpOwoKICAgICAgICAgICAgLy8gU2hhZGVyIE1hdGVyaWFsCiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICB1bmlmb3JtczogewogICAgICAgICAgICAgICAgICAgIG1hcDogeyB2YWx1ZTogdGV4dHVyZSB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IHNpemU7CiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IHJvdGF0aW9uOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBvcGFjaXR5OwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSB2ZWMzIGNvbG9yOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdlJvdGF0aW9uOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdk9wYWNpdHk7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMzIHZDb2xvcjsKICAgICAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZSb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICB2T3BhY2l0eSA9IG9wYWNpdHk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZDb2xvciA9IGNvbG9yOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWM0IG12UG9zaXRpb24gPSBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KHBvc2l0aW9uLCAxLjApOwogICAgICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtdlBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTaXplIGF0dGVudWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGdsX1BvaW50U2l6ZSA9IHNpemUgKiAoMzAwLjAgLyAtbXZQb3NpdGlvbi56KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIHNhbXBsZXIyRCBtYXA7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2Um90YXRpb247CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2T3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdkNvbG9yOwogICAgICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiB1diA9IGdsX1BvaW50Q29vcmQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgY2VudGVyZWQgPSB1diAtIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgYyA9IGNvcyh2Um90YXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBzID0gc2luKHZSb3RhdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgcm90YXRlZCA9IHZlYzIoY2VudGVyZWQueCAqIGMgLSBjZW50ZXJlZC55ICogcywgY2VudGVyZWQueCAqIHMgKyBjZW50ZXJlZC55ICogYykgKyAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzQgdGV4ID0gdGV4dHVyZTJEKG1hcCwgcm90YXRlZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQodGV4LnJnYiAqIHZDb2xvciwgdGV4LmEgKiB2T3BhY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYCwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBibGVuZGluZzogYmxlbmRpbmcKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuUG9pbnRzKGdlbywgbWF0KTsKICAgICAgICAgICAgdGhpcy5tZXNoLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgc2NlbmUuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMb2dpYyBob29rCiAgICAgICAgICAgIHRoaXMudXBkYXRlTG9naWMgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgc3Bhd24ocG9zLCBvcHRpb25zKSB7CiAgICAgICAgICAgIC8vIEZpbmQgZmlyc3QgaW5hY3RpdmUKICAgICAgICAgICAgbGV0IHAgPSBudWxsOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLm1heFBhcnRpY2xlczsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZighdGhpcy5wYXJ0aWNsZXNbaV0uYWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgcCA9IHRoaXMucGFydGljbGVzW2ldOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIXApIHJldHVybjsgLy8gUG9vbCBmdWxsCgogICAgICAgICAgICBwLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgIHAucG9zLmNvcHkocG9zKTsKICAgICAgICAgICAgcC5saWZlID0gb3B0aW9ucy5saWZlIHx8IDEuMDsKICAgICAgICAgICAgcC5tYXhMaWZlID0gcC5saWZlOwogICAgICAgICAgICBwLnN0YXJ0U2NhbGUgPSBvcHRpb25zLnNjYWxlIHx8IDEuMDsKICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZTsKICAgICAgICAgICAgcC5yb3RhdGlvbiA9IG9wdGlvbnMucm90YXRpb24gfHwgMDsKICAgICAgICAgICAgcC52ZWwuY29weShvcHRpb25zLnZlbG9jaXR5IHx8IG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICBwLmdyYXZpdHkgPSBvcHRpb25zLmdyYXZpdHkgfHwgMDsKICAgICAgICAgICAgcC5kcmFnID0gb3B0aW9ucy5kcmFnIHx8IDA7CiAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbG9yKSBwLmNvbG9yLnNldChvcHRpb25zLmNvbG9yKTsKICAgICAgICAgICAgZWxzZSBwLmNvbG9yLnNldEhleCgweGZmZmZmZik7CiAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBsZXQgYWN0aXZlQ291bnQgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5tYXhQYXJ0aWNsZXM7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMucGFydGljbGVzW2ldOwogICAgICAgICAgICAgICAgaWYgKCFwLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2l6ZXNbaV0gPSAwOyAvLyBIaWRlCiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcC5saWZlIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHAubGlmZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcC5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNpemVzW2ldID0gMDsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBQaHlzaWNzCiAgICAgICAgICAgICAgICBpZiAocC5ncmF2aXR5ICE9PSAwKSBwLnZlbC55IC09IHAuZ3Jhdml0eSAqIGR0OwogICAgICAgICAgICAgICAgaWYgKHAuZHJhZyAhPT0gMCkgcC52ZWwubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgoMCwgMS4wIC0gcC5kcmFnICogZHQpKTsKICAgICAgICAgICAgICAgIHAucG9zLmFkZFNjYWxlZFZlY3RvcihwLnZlbCwgZHQpOwoKICAgICAgICAgICAgICAgIC8vIExvZ2ljCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gMS4wIC0gKHAubGlmZSAvIHAubWF4TGlmZSk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy51cGRhdGVMb2dpYykgewogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTG9naWMocCwgdCwgZHQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBCdWZmZXJzCiAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uc1tpKjNdID0gcC5wb3MueDsKICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25zW2kqMysxXSA9IHAucG9zLnk7CiAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uc1tpKjMrMl0gPSBwLnBvcy56OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLnNpemVzW2ldID0gcC5zY2FsZTsKICAgICAgICAgICAgICAgIHRoaXMucm90YXRpb25zW2ldID0gcC5yb3RhdGlvbjsKICAgICAgICAgICAgICAgIHRoaXMub3BhY2l0aWVzW2ldID0gcC5vcGFjaXR5OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmNvbG9yc1tpKjNdID0gcC5jb2xvci5yOwogICAgICAgICAgICAgICAgdGhpcy5jb2xvcnNbaSozKzFdID0gcC5jb2xvci5nOwogICAgICAgICAgICAgICAgdGhpcy5jb2xvcnNbaSozKzJdID0gcC5jb2xvci5iOwoKICAgICAgICAgICAgICAgIGFjdGl2ZUNvdW50Kys7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhY3RpdmVDb3VudCA+IDAgfHwgdGhpcy5hY3RpdmVDb3VudCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLnNpemUubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMucm90YXRpb24ubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMub3BhY2l0eS5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5jb2xvci5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hY3RpdmVDb3VudCA9IGFjdGl2ZUNvdW50OwogICAgICAgIH0KICAgIH0KCiAgICBjbGFzcyBQYXJ0aWNsZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5iYXRjaGVzID0ge307CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsaXplIEJhdGNoZXMKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ3Zlbm9tJywgX3Zlbm9tVGV4LCAxMDAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnBvcy54ICs9IE1hdGguc2luKHQgKiAxMCArIHAucG9zLnkpICogMC4wNTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOCAqICgxLjAgLSBNYXRoLnBvdyh0LCAzKSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ25hcCcsIF9uYXBUZXgsIDUwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMC41ICsgdCAqIDEuNSk7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSBNYXRoLnBvdyh0LCAyKTsKICAgICAgICAgICAgICAgIHAucG9zLnggKz0gTWF0aC5zaW4odCAqIDUpICogMC4wMjsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnd2l0aGVyJywgX3dpdGhlclRleCwgMTAwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuNiAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAucm90YXRpb24gKz0gMC4wNTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnbGVhcm5lZCcsIF92ZW5vbVRleCwgNTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5jb2xvci5zZXRIZXgoMHgwMGZmZmYpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdzaG9ja3dhdmUnLCBfc2hvY2t3YXZlVGV4LCAyMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiBNYXRoLnBvdyh0LCAwLjUpICogNS4wOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMS4wIC0gTWF0aC5wb3codCwgMik7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ2ZsYXNoJywgX2ZsYXNoVGV4LCA1MCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wIC0gdCk7CiAgICAgICAgICAgICAgICBwLnJvdGF0aW9uICs9IDAuMjsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnZGVicmlzJywgX2RlYnJpc1RleCwgMTAwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAucm90YXRpb24gKz0gMC4yOwogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnYnViYmxlJywgX2J1YmJsZVRleCwgMjAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5wb3MueCArPSBNYXRoLnNpbih0ICogMTAgKyBwLnBvcy56KSAqIDAuMDI7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCArIHQgKiAwLjIpOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMC42ICogKDEuMCAtIE1hdGgucG93KHQsIDIpKTsKICAgICAgICAgICAgICAgIHAuY29sb3Iuc2V0SGV4KDB4YWFjY2ZmKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnYnViYmxlX21pY3JvJywgX21pY3JvQnViYmxlVGV4LCAzMDAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMC45ICogKDEuMCAtIHQpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdkYXNoX3N0cmVhbScsIF9kYXNoU3RyZWFtVGV4LCAxMDAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAwLjggKiAoMS4wIC0gdCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgX2NyZWF0ZUJhdGNoKG5hbWUsIHRleCwgY291bnQsIGJsZW5kaW5nLCBsb2dpYykgewogICAgICAgICAgICBjb25zdCBiYXRjaCA9IG5ldyBQYXJ0aWNsZUJhdGNoKHRoaXMuc2NlbmUsIHRleCwgY291bnQsIGJsZW5kaW5nKTsKICAgICAgICAgICAgaWYgKGxvZ2ljKSBiYXRjaC51cGRhdGVMb2dpYyA9IGxvZ2ljOwogICAgICAgICAgICB0aGlzLmJhdGNoZXNbbmFtZV0gPSBiYXRjaDsKICAgICAgICB9CgogICAgICAgIHNwYXduKHR5cGUsIHBvcywgb3B0aW9ucyA9IHt9KSB7CiAgICAgICAgICAgIGNvbnN0IGJhdGNoID0gdGhpcy5iYXRjaGVzW3R5cGVdOwogICAgICAgICAgICBpZiAoYmF0Y2gpIHsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgcGh5c2ljcyBwYXJhbXMgaWYgbm90IHByb3ZpZGVkCiAgICAgICAgICAgICAgICBjb25zdCBvcHRzID0geyAuLi5vcHRpb25zIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gb3B0cy5saWZlIHx8IDEuMCArIE1hdGgucmFuZG9tKCkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgb3B0cy52ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEuMCArIE1hdGgucmFuZG9tKCksIDApOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjMgKyBNYXRoLnJhbmRvbSgpICogMC4yOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSowLjIsIDAuNSwgKE1hdGgucmFuZG9tKCktMC41KSowLjIpOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICd3aXRoZXInKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMS41OwogICAgICAgICAgICAgICAgICAgIG9wdHMudmVsb2NpdHkgPSBuZXcgVEhSRUUuVmVjdG9yMygoTWF0aC5yYW5kb20oKS0wLjUpKjAuNSwgMC41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuNSk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2hvY2t3YXZlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IG9wdHMubGlmZSB8fCAwLjQ7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IG9wdHMuc2NhbGUgfHwgMi4wOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZmxhc2gnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMC4yOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSBvcHRzLnNjYWxlIHx8IDMuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnJvdGF0aW9uID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdkZWJyaXMnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMS41OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gNS4wICsgTWF0aC5yYW5kb20oKSAqIDEwLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy52ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogc3BlZWQsCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpICogc3BlZWQgKiAwLjUpICsgMi4wLAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogc3BlZWQKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIG9wdHMuZ3Jhdml0eSA9IDIwLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5kcmFnID0gMS4wOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAob3B0cy5zY2FsZSB8fCAwLjMpICogKDAuNSArIE1hdGgucmFuZG9tKCkpOwogICAgICAgICAgICAgICAgICAgIG9wdHMucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2J1YmJsZScpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAxLjAgKyBNYXRoLnJhbmRvbSgpICogMS4wOwogICAgICAgICAgICAgICAgICAgIG9wdHMudmVsb2NpdHkgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41LAogICAgICAgICAgICAgICAgICAgICAgICAwLjUgKyBNYXRoLnJhbmRvbSgpICogMS4wLAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjUKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAob3B0cy5zY2FsZSB8fCAwLjE1KSAqICgwLjggKyBNYXRoLnJhbmRvbSgpICogMC40KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2J1YmJsZV9taWNybycpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAwLjQgKyBNYXRoLnJhbmRvbSgpICogMC40OwogICAgICAgICAgICAgICAgICAgIG9wdHMudmVsb2NpdHkgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMS41LAogICAgICAgICAgICAgICAgICAgICAgICAxLjUgKyBNYXRoLnJhbmRvbSgpICogMi4wLAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxLjUKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAob3B0cy5zY2FsZSB8fCAwLjE1KSAqICgwLjggKyBNYXRoLnJhbmRvbSgpICogMC41KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Rhc2hfc3RyZWFtJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuMzsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gb3B0cy5zY2FsZSB8fCAyLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGJhdGNoLnNwYXduKHBvcywgb3B0cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLmJhdGNoZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmF0Y2hlc1trZXldLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyID0gUGFydGljbGVNYW5hZ2VyOwp9KSgpOw==","./ParticleManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUT1JTIC0tLQogICAgCiAgICAvLyAxLiBWZW5vbSBCdWJibGUgKEdyZWVuLCBzaGlueSwgc2hhcnApCiAgICBjb25zdCBfdmVub21UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMzIsIDMyLCA0LCAzMiwgMzIsIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgxNTAsIDI1NSwgMTAwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgwLCAyMDAsIDAsIDAuNSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCA1MCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45KSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDIwLCAyMCwgNiwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDIuIFNsZWVwIFp6egogICAgY29uc3QgX25hcFRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZvbnQgPSAnYm9sZCBpdGFsaWMgNDhweCBzYW5zLXNlcmlmJzsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gJyMwMDAwZmYnOwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gNDsKICAgICAgICBjdHguZmlsbFRleHQoJ1onLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gMy4gV2l0aGVyIFNtb2tlIChPcHRpbWl6ZWQgdG8gMzJ4MzIpCiAgICBjb25zdCBfd2l0aGVyVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDE2LCAxNiwgMCwgMTYsIDE2LCAxNik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoODAsIDgwLCA4MCwgMC44KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoNDAsIDQwLCA0MCwgMC40KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIDMyLCAzMik7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA0LiBTaG9ja3dhdmUgUmluZyAoT3B0aW1pemVkIHRvIDY0eDY0KQogICAgY29uc3QgX3Nob2Nrd2F2ZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgY3ggPSAzMiwgY3kgPSAzMjsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGN4LCBjeSwgMjAsIGN4LCBjeSwgMzApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC41LCAncmdiYSgyNTUsIDI1NSwgMjU1LCAxKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIDY0LCA2NCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA1LiBGbGFzaCBTdGFyIChPcHRpbWl6ZWQgdG8gMzJ4MzIpCiAgICBjb25zdCBfZmxhc2hUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGN4ID0gMTYsIGN5ID0gMTY7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgZm9yKGxldCBpPTA7IGk8NDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGEgPSAoaSAqIE1hdGguUEkgLyAyKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyhjeCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYSkqMTUsIGN5ICsgTWF0aC5zaW4oYSkqMTUpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYSArIDAuMikqNSwgY3kgKyBNYXRoLnNpbihhICsgMC4yKSo1KTsKICAgICAgICB9CiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGN4LCBjeSwgMCwgY3gsIGN5LCAxMCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyhjeCwgY3ksIDEwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNi4gRGVicmlzIFNoYXJkIChOZXcpCiAgICBjb25zdCBfZGVicmlzVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDE2LCAwKTsgY3R4LmxpbmVUbygzMiwgMTYpOyBjdHgubGluZVRvKDE2LCAzMik7IGN0eC5saW5lVG8oMCwgMTYpOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA3LiBCdWJibGUgVGV4dHVyZSAoTmV3OiBBZXN0aGV0aWMgJiBTdWJ0bGUpCiAgICBjb25zdCBfYnViYmxlVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIDY0LCA2NCk7CgogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMzIsIDMyLCAwLCAzMiwgMzIsIDI4KTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjk1KScpOyAKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjMsICdyZ2JhKDIwMCwgMjQwLCAyNTUsIDAuNCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjgsICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCAwLCAwLCAwKScpOwogICAgICAgIAogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYygzMiwgMzIsIDMwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgyNTUsIDI1NSwgMjU1LCAxLjApJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IAogICAgICAgIGN0eC5hcmMoMjAsIDIwLCA0LCAwLCBNYXRoLlBJICogMik7IAogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA4LiBNaWNybyBCdWJibGUgKE5ldzogU2hhcnAsIGhpZ2gtdmlzIGNhdml0YXRpb24pCiAgICBjb25zdCBfbWljcm9CdWJibGVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgMzIsIDMyKTsKICAgICAgICAKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDE2LCAxNiwgMCwgMTYsIDE2LCAxNik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMS4wKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuMywgJ3JnYmEoMjIwLCAyNTUsIDI1NSwgMC44KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNiwgJ3JnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEuMCwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMTYsIDE2LCAxNiwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDkuIERhc2ggU3RyZWFtIChTcXVhcmUgZm9yIFBvaW50cykKICAgIGNvbnN0IF9kYXNoU3RyZWFtVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICAvLyBEcmF3IGEgc3RyZWFrIGluIHRoZSBtaWRkbGUKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZUxpbmVhckdyYWRpZW50KDAsIDAsIDY0LCAwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgwLCAyNTUsIDI1NSwgMCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjUsICdyZ2JhKDIwMCwgMjU1LCAyNTUsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCAyNTUsIDI1NSwgMCknKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguZmlsbFJlY3QoMCwgMjgsIDY0LCA4KTsgLy8gQ2VudGVyZWQgdmVydGljYWxseQogICAgICAgIAogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gLS0tIFBBUlRJQ0xFIEJBVENIIFNZU1RFTSAoVEhSRUUuUG9pbnRzKSAtLS0KICAgIGNsYXNzIFBhcnRpY2xlQmF0Y2ggewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lLCB0ZXh0dXJlLCBtYXhQYXJ0aWNsZXMgPSAyMDAsIGJsZW5kaW5nID0gVEhSRUUuQWRkaXRpdmVCbGVuZGluZykgewogICAgICAgICAgICB0aGlzLm1heFBhcnRpY2xlcyA9IG1heFBhcnRpY2xlczsKICAgICAgICAgICAgdGhpcy5hY3RpdmVDb3VudCA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDUFUgU3RhdGUKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXMgPSBbXTsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8bWF4UGFydGljbGVzOyBpKyspIHsKICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVzLnB1c2goewogICAgICAgICAgICAgICAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgcG9zOiBuZXcgVEhSRUUuVmVjdG9yMygpLAogICAgICAgICAgICAgICAgICAgIHZlbDogbmV3IFRIUkVFLlZlY3RvcjMoKSwKICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLAogICAgICAgICAgICAgICAgICAgIG1heExpZmU6IDEsCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDEsCiAgICAgICAgICAgICAgICAgICAgc3RhcnRTY2FsZTogMSwKICAgICAgICAgICAgICAgICAgICByb3RhdGlvbjogMCwKICAgICAgICAgICAgICAgICAgICBncmF2aXR5OiAwLAogICAgICAgICAgICAgICAgICAgIGRyYWc6IDAsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IG5ldyBUSFJFRS5Db2xvcigxLDEsMSksCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEdQVSBCdWZmZXJzCiAgICAgICAgICAgIHRoaXMucG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShtYXhQYXJ0aWNsZXMgKiAzKTsKICAgICAgICAgICAgdGhpcy5zaXplcyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzKTsKICAgICAgICAgICAgdGhpcy5yb3RhdGlvbnMgPSBuZXcgRmxvYXQzMkFycmF5KG1heFBhcnRpY2xlcyk7CiAgICAgICAgICAgIHRoaXMub3BhY2l0aWVzID0gbmV3IEZsb2F0MzJBcnJheShtYXhQYXJ0aWNsZXMpOwogICAgICAgICAgICB0aGlzLmNvbG9ycyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzICogMyk7CgogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMucG9zaXRpb25zLCAzKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ3NpemUnLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMuc2l6ZXMsIDEpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgncm90YXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMucm90YXRpb25zLCAxKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ29wYWNpdHknLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMub3BhY2l0aWVzLCAxKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ2NvbG9yJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZSh0aGlzLmNvbG9ycywgMykpOwoKICAgICAgICAgICAgLy8gU2hhZGVyIE1hdGVyaWFsCiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICB1bmlmb3JtczogewogICAgICAgICAgICAgICAgICAgIG1hcDogeyB2YWx1ZTogdGV4dHVyZSB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IHNpemU7CiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IHJvdGF0aW9uOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBvcGFjaXR5OwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSB2ZWMzIGNvbG9yOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdlJvdGF0aW9uOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdk9wYWNpdHk7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMzIHZDb2xvcjsKICAgICAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZSb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICB2T3BhY2l0eSA9IG9wYWNpdHk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZDb2xvciA9IGNvbG9yOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWM0IG12UG9zaXRpb24gPSBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KHBvc2l0aW9uLCAxLjApOwogICAgICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtdlBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTaXplIGF0dGVudWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGdsX1BvaW50U2l6ZSA9IHNpemUgKiAoMzAwLjAgLyAtbXZQb3NpdGlvbi56KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIHNhbXBsZXIyRCBtYXA7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2Um90YXRpb247CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2T3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdkNvbG9yOwogICAgICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiB1diA9IGdsX1BvaW50Q29vcmQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgY2VudGVyZWQgPSB1diAtIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgYyA9IGNvcyh2Um90YXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBzID0gc2luKHZSb3RhdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgcm90YXRlZCA9IHZlYzIoY2VudGVyZWQueCAqIGMgLSBjZW50ZXJlZC55ICogcywgY2VudGVyZWQueCAqIHMgKyBjZW50ZXJlZC55ICogYykgKyAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzQgdGV4ID0gdGV4dHVyZTJEKG1hcCwgcm90YXRlZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQodGV4LnJnYiAqIHZDb2xvciwgdGV4LmEgKiB2T3BhY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYCwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBibGVuZGluZzogYmxlbmRpbmcKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuUG9pbnRzKGdlbywgbWF0KTsKICAgICAgICAgICAgdGhpcy5tZXNoLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgc2NlbmUuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMb2dpYyBob29rCiAgICAgICAgICAgIHRoaXMudXBkYXRlTG9naWMgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgc3Bhd24ocG9zLCBvcHRpb25zKSB7CiAgICAgICAgICAgIC8vIEZpbmQgZmlyc3QgaW5hY3RpdmUKICAgICAgICAgICAgbGV0IHAgPSBudWxsOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLm1heFBhcnRpY2xlczsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZighdGhpcy5wYXJ0aWNsZXNbaV0uYWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgcCA9IHRoaXMucGFydGljbGVzW2ldOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIXApIHJldHVybjsgLy8gUG9vbCBmdWxsCgogICAgICAgICAgICBwLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgIHAucG9zLmNvcHkocG9zKTsKICAgICAgICAgICAgcC5saWZlID0gb3B0aW9ucy5saWZlIHx8IDEuMDsKICAgICAgICAgICAgcC5tYXhMaWZlID0gcC5saWZlOwogICAgICAgICAgICBwLnN0YXJ0U2NhbGUgPSBvcHRpb25zLnNjYWxlIHx8IDEuMDsKICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZTsKICAgICAgICAgICAgcC5yb3RhdGlvbiA9IG9wdGlvbnMucm90YXRpb24gfHwgMDsKICAgICAgICAgICAgcC52ZWwuY29weShvcHRpb25zLnZlbG9jaXR5IHx8IG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICBwLmdyYXZpdHkgPSBvcHRpb25zLmdyYXZpdHkgfHwgMDsKICAgICAgICAgICAgcC5kcmFnID0gb3B0aW9ucy5kcmFnIHx8IDA7CiAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbG9yKSBwLmNvbG9yLnNldChvcHRpb25zLmNvbG9yKTsKICAgICAgICAgICAgZWxzZSBwLmNvbG9yLnNldEhleCgweGZmZmZmZik7CiAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBsZXQgYWN0aXZlQ291bnQgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5tYXhQYXJ0aWNsZXM7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMucGFydGljbGVzW2ldOwogICAgICAgICAgICAgICAgaWYgKCFwLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2l6ZXNbaV0gPSAwOyAvLyBIaWRlCiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcC5saWZlIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHAubGlmZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcC5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNpemVzW2ldID0gMDsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBQaHlzaWNzCiAgICAgICAgICAgICAgICBpZiAocC5ncmF2aXR5ICE9PSAwKSBwLnZlbC55IC09IHAuZ3Jhdml0eSAqIGR0OwogICAgICAgICAgICAgICAgaWYgKHAuZHJhZyAhPT0gMCkgcC52ZWwubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgoMCwgMS4wIC0gcC5kcmFnICogZHQpKTsKICAgICAgICAgICAgICAgIHAucG9zLmFkZFNjYWxlZFZlY3RvcihwLnZlbCwgZHQpOwoKICAgICAgICAgICAgICAgIC8vIExvZ2ljCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gMS4wIC0gKHAubGlmZSAvIHAubWF4TGlmZSk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy51cGRhdGVMb2dpYykgewogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTG9naWMocCwgdCwgZHQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBCdWZmZXJzCiAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uc1tpKjNdID0gcC5wb3MueDsKICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25zW2kqMysxXSA9IHAucG9zLnk7CiAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uc1tpKjMrMl0gPSBwLnBvcy56OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLnNpemVzW2ldID0gcC5zY2FsZTsKICAgICAgICAgICAgICAgIHRoaXMucm90YXRpb25zW2ldID0gcC5yb3RhdGlvbjsKICAgICAgICAgICAgICAgIHRoaXMub3BhY2l0aWVzW2ldID0gcC5vcGFjaXR5OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmNvbG9yc1tpKjNdID0gcC5jb2xvci5yOwogICAgICAgICAgICAgICAgdGhpcy5jb2xvcnNbaSozKzFdID0gcC5jb2xvci5nOwogICAgICAgICAgICAgICAgdGhpcy5jb2xvcnNbaSozKzJdID0gcC5jb2xvci5iOwoKICAgICAgICAgICAgICAgIGFjdGl2ZUNvdW50Kys7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhY3RpdmVDb3VudCA+IDAgfHwgdGhpcy5hY3RpdmVDb3VudCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLnNpemUubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMucm90YXRpb24ubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMub3BhY2l0eS5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5jb2xvci5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hY3RpdmVDb3VudCA9IGFjdGl2ZUNvdW50OwogICAgICAgIH0KICAgIH0KCiAgICBjbGFzcyBQYXJ0aWNsZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5iYXRjaGVzID0ge307CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsaXplIEJhdGNoZXMKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ3Zlbm9tJywgX3Zlbm9tVGV4LCAxMDAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnBvcy54ICs9IE1hdGguc2luKHQgKiAxMCArIHAucG9zLnkpICogMC4wNTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOCAqICgxLjAgLSBNYXRoLnBvdyh0LCAzKSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ25hcCcsIF9uYXBUZXgsIDUwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMC41ICsgdCAqIDEuNSk7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSBNYXRoLnBvdyh0LCAyKTsKICAgICAgICAgICAgICAgIHAucG9zLnggKz0gTWF0aC5zaW4odCAqIDUpICogMC4wMjsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnd2l0aGVyJywgX3dpdGhlclRleCwgMTAwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuNiAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAucm90YXRpb24gKz0gMC4wNTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnbGVhcm5lZCcsIF92ZW5vbVRleCwgNTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5jb2xvci5zZXRIZXgoMHgwMGZmZmYpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdzaG9ja3dhdmUnLCBfc2hvY2t3YXZlVGV4LCAyMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiBNYXRoLnBvdyh0LCAwLjUpICogNS4wOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMS4wIC0gTWF0aC5wb3codCwgMik7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ2ZsYXNoJywgX2ZsYXNoVGV4LCA1MCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wIC0gdCk7CiAgICAgICAgICAgICAgICBwLnJvdGF0aW9uICs9IDAuMjsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnZGVicmlzJywgX2RlYnJpc1RleCwgMTAwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAucm90YXRpb24gKz0gMC4yOwogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnYnViYmxlJywgX2J1YmJsZVRleCwgMjAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5wb3MueCArPSBNYXRoLnNpbih0ICogMTAgKyBwLnBvcy56KSAqIDAuMDI7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCArIHQgKiAwLjIpOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMC42ICogKDEuMCAtIE1hdGgucG93KHQsIDIpKTsKICAgICAgICAgICAgICAgIHAuY29sb3Iuc2V0SGV4KDB4YWFjY2ZmKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnYnViYmxlX21pY3JvJywgX21pY3JvQnViYmxlVGV4LCAzMDAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMC45ICogKDEuMCAtIHQpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdkYXNoX3N0cmVhbScsIF9kYXNoU3RyZWFtVGV4LCAxMDAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAwLjggKiAoMS4wIC0gdCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgX2NyZWF0ZUJhdGNoKG5hbWUsIHRleCwgY291bnQsIGJsZW5kaW5nLCBsb2dpYykgewogICAgICAgICAgICBjb25zdCBiYXRjaCA9IG5ldyBQYXJ0aWNsZUJhdGNoKHRoaXMuc2NlbmUsIHRleCwgY291bnQsIGJsZW5kaW5nKTsKICAgICAgICAgICAgaWYgKGxvZ2ljKSBiYXRjaC51cGRhdGVMb2dpYyA9IGxvZ2ljOwogICAgICAgICAgICB0aGlzLmJhdGNoZXNbbmFtZV0gPSBiYXRjaDsKICAgICAgICB9CgogICAgICAgIHNwYXduKHR5cGUsIHBvcywgb3B0aW9ucyA9IHt9KSB7CiAgICAgICAgICAgIGNvbnN0IGJhdGNoID0gdGhpcy5iYXRjaGVzW3R5cGVdOwogICAgICAgICAgICBpZiAoYmF0Y2gpIHsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgcGh5c2ljcyBwYXJhbXMgaWYgbm90IHByb3ZpZGVkCiAgICAgICAgICAgICAgICBjb25zdCBvcHRzID0geyAuLi5vcHRpb25zIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gb3B0cy5saWZlIHx8IDEuMCArIE1hdGgucmFuZG9tKCkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgb3B0cy52ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEuMCArIE1hdGgucmFuZG9tKCksIDApOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjMgKyBNYXRoLnJhbmRvbSgpICogMC4yOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSowLjIsIDAuNSwgKE1hdGgucmFuZG9tKCktMC41KSowLjIpOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICd3aXRoZXInKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMS41OwogICAgICAgICAgICAgICAgICAgIG9wdHMudmVsb2NpdHkgPSBuZXcgVEhSRUUuVmVjdG9yMygoTWF0aC5yYW5kb20oKS0wLjUpKjAuNSwgMC41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuNSk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2hvY2t3YXZlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IG9wdHMubGlmZSB8fCAwLjQ7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IG9wdHMuc2NhbGUgfHwgMi4wOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZmxhc2gnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMC4yOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSBvcHRzLnNjYWxlIHx8IDMuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnJvdGF0aW9uID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdkZWJyaXMnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMS41OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gNS4wICsgTWF0aC5yYW5kb20oKSAqIDEwLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy52ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogc3BlZWQsCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpICogc3BlZWQgKiAwLjUpICsgMi4wLAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogc3BlZWQKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIG9wdHMuZ3Jhdml0eSA9IDIwLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5kcmFnID0gMS4wOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAob3B0cy5zY2FsZSB8fCAwLjMpICogKDAuNSArIE1hdGgucmFuZG9tKCkpOwogICAgICAgICAgICAgICAgICAgIG9wdHMucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2J1YmJsZScpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAxLjAgKyBNYXRoLnJhbmRvbSgpICogMS4wOwogICAgICAgICAgICAgICAgICAgIG9wdHMudmVsb2NpdHkgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41LAogICAgICAgICAgICAgICAgICAgICAgICAwLjUgKyBNYXRoLnJhbmRvbSgpICogMS4wLAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjUKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAob3B0cy5zY2FsZSB8fCAwLjE1KSAqICgwLjggKyBNYXRoLnJhbmRvbSgpICogMC40KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2J1YmJsZV9taWNybycpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAwLjQgKyBNYXRoLnJhbmRvbSgpICogMC40OwogICAgICAgICAgICAgICAgICAgIG9wdHMudmVsb2NpdHkgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMS41LAogICAgICAgICAgICAgICAgICAgICAgICAxLjUgKyBNYXRoLnJhbmRvbSgpICogMi4wLAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxLjUKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAob3B0cy5zY2FsZSB8fCAwLjE1KSAqICgwLjggKyBNYXRoLnJhbmRvbSgpICogMC41KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Rhc2hfc3RyZWFtJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuMzsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gb3B0cy5zY2FsZSB8fCAyLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGJhdGNoLnNwYXduKHBvcywgb3B0cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLmJhdGNoZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmF0Y2hlc1trZXldLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyID0gUGFydGljbGVNYW5hZ2VyOwp9KSgpOw==","/ParticleManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUT1JTIC0tLQogICAgCiAgICAvLyAxLiBWZW5vbSBCdWJibGUgKEdyZWVuLCBzaGlueSwgc2hhcnApCiAgICBjb25zdCBfdmVub21UZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gNjQ7IGMuaGVpZ2h0ID0gNjQ7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMzIsIDMyLCA0LCAzMiwgMzIsIDMwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgxNTAsIDI1NSwgMTAwLCAwLjkpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC44LCAncmdiYSgwLCAyMDAsIDAsIDAuNSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCA1MCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMzIsIDMyLCAzMCwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMC45KSc7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKDIwLCAyMCwgNiwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDIuIFNsZWVwIFp6egogICAgY29uc3QgX25hcFRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY3R4LmZvbnQgPSAnYm9sZCBpdGFsaWMgNDhweCBzYW5zLXNlcmlmJzsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gJyMwMDAwZmYnOwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gNDsKICAgICAgICBjdHguZmlsbFRleHQoJ1onLCAzMiwgMzIpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gMy4gV2l0aGVyIFNtb2tlIChPcHRpbWl6ZWQgdG8gMzJ4MzIpCiAgICBjb25zdCBfd2l0aGVyVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDE2LCAxNiwgMCwgMTYsIDE2LCAxNik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoODAsIDgwLCA4MCwgMC44KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoNDAsIDQwLCA0MCwgMC40KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDAsIDAsIDAsIDApJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIDMyLCAzMik7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA0LiBTaG9ja3dhdmUgUmluZyAoT3B0aW1pemVkIHRvIDY0eDY0KQogICAgY29uc3QgX3Nob2Nrd2F2ZVRleCA9ICgoKSA9PiB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSA2NDsgYy5oZWlnaHQgPSA2NDsKICAgICAgICBjb25zdCBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgY29uc3QgY3ggPSAzMiwgY3kgPSAzMjsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGN4LCBjeSwgMjAsIGN4LCBjeSwgMzApOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMC41LCAncmdiYSgyNTUsIDI1NSwgMjU1LCAxKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDApJyk7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGc7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIDY0LCA2NCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA1LiBGbGFzaCBTdGFyIChPcHRpbWl6ZWQgdG8gMzJ4MzIpCiAgICBjb25zdCBfZmxhc2hUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGNvbnN0IGN4ID0gMTYsIGN5ID0gMTY7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgZm9yKGxldCBpPTA7IGk8NDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGEgPSAoaSAqIE1hdGguUEkgLyAyKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyhjeCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYSkqMTUsIGN5ICsgTWF0aC5zaW4oYSkqMTUpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgTWF0aC5jb3MoYSArIDAuMikqNSwgY3kgKyBNYXRoLnNpbihhICsgMC4yKSo1KTsKICAgICAgICB9CiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGN4LCBjeSwgMCwgY3gsIGN5LCAxMCk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwKScpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyhjeCwgY3ksIDEwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gNi4gRGVicmlzIFNoYXJkIChOZXcpCiAgICBjb25zdCBfZGVicmlzVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDMyOyBjLmhlaWdodCA9IDMyOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDE2LCAwKTsgY3R4LmxpbmVUbygzMiwgMTYpOyBjdHgubGluZVRvKDE2LCAzMik7IGN0eC5saW5lVG8oMCwgMTYpOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA3LiBCdWJibGUgVGV4dHVyZSAoTmV3OiBBZXN0aGV0aWMgJiBTdWJ0bGUpCiAgICBjb25zdCBfYnViYmxlVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIDY0LCA2NCk7CgogICAgICAgIGNvbnN0IGcgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoMzIsIDMyLCAwLCAzMiwgMzIsIDI4KTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgyNTUsIDI1NSwgMjU1LCAwLjk1KScpOyAKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjMsICdyZ2JhKDIwMCwgMjQwLCAyNTUsIDAuNCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjgsICdyZ2JhKDEwMCwgMjAwLCAyNTUsIDAuMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCAwLCAwLCAwKScpOwogICAgICAgIAogICAgICAgIGN0eC5maWxsU3R5bGUgPSBnOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYygzMiwgMzIsIDMwLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgIAogICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgyNTUsIDI1NSwgMjU1LCAxLjApJzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IAogICAgICAgIGN0eC5hcmMoMjAsIDIwLCA0LCAwLCBNYXRoLlBJICogMik7IAogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgfSkoKTsKCiAgICAvLyA4LiBNaWNybyBCdWJibGUgKE5ldzogU2hhcnAsIGhpZ2gtdmlzIGNhdml0YXRpb24pCiAgICBjb25zdCBfbWljcm9CdWJibGVUZXggPSAoKCkgPT4gewogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gMzI7IGMuaGVpZ2h0ID0gMzI7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgMzIsIDMyKTsKICAgICAgICAKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDE2LCAxNiwgMCwgMTYsIDE2LCAxNik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMS4wKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuMywgJ3JnYmEoMjIwLCAyNTUsIDI1NSwgMC44KScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDAuNiwgJ3JnYmEoMTAwLCAyMDAsIDI1NSwgMC4zKScpOwogICAgICAgIGcuYWRkQ29sb3JTdG9wKDEuMCwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoMTYsIDE2LCAxNiwgMCwgTWF0aC5QSSoyKTsgY3R4LmZpbGwoKTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIC8vIDkuIERhc2ggU3RyZWFtIChTcXVhcmUgZm9yIFBvaW50cykKICAgIGNvbnN0IF9kYXNoU3RyZWFtVGV4ID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICAvLyBEcmF3IGEgc3RyZWFrIGluIHRoZSBtaWRkbGUKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZUxpbmVhckdyYWRpZW50KDAsIDAsIDY0LCAwKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLCAncmdiYSgwLCAyNTUsIDI1NSwgMCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjUsICdyZ2JhKDIwMCwgMjU1LCAyNTUsIDAuOCknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgxLCAncmdiYSgwLCAyNTUsIDI1NSwgMCknKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguZmlsbFJlY3QoMCwgMjgsIDY0LCA4KTsgLy8gQ2VudGVyZWQgdmVydGljYWxseQogICAgICAgIAogICAgICAgIHJldHVybiBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjKTsKICAgIH0pKCk7CgogICAgLy8gLS0tIFBBUlRJQ0xFIEJBVENIIFNZU1RFTSAoVEhSRUUuUG9pbnRzKSAtLS0KICAgIGNsYXNzIFBhcnRpY2xlQmF0Y2ggewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lLCB0ZXh0dXJlLCBtYXhQYXJ0aWNsZXMgPSAyMDAsIGJsZW5kaW5nID0gVEhSRUUuQWRkaXRpdmVCbGVuZGluZykgewogICAgICAgICAgICB0aGlzLm1heFBhcnRpY2xlcyA9IG1heFBhcnRpY2xlczsKICAgICAgICAgICAgdGhpcy5hY3RpdmVDb3VudCA9IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDUFUgU3RhdGUKICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXMgPSBbXTsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8bWF4UGFydGljbGVzOyBpKyspIHsKICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVzLnB1c2goewogICAgICAgICAgICAgICAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgcG9zOiBuZXcgVEhSRUUuVmVjdG9yMygpLAogICAgICAgICAgICAgICAgICAgIHZlbDogbmV3IFRIUkVFLlZlY3RvcjMoKSwKICAgICAgICAgICAgICAgICAgICBsaWZlOiAwLAogICAgICAgICAgICAgICAgICAgIG1heExpZmU6IDEsCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IDEsCiAgICAgICAgICAgICAgICAgICAgc3RhcnRTY2FsZTogMSwKICAgICAgICAgICAgICAgICAgICByb3RhdGlvbjogMCwKICAgICAgICAgICAgICAgICAgICBncmF2aXR5OiAwLAogICAgICAgICAgICAgICAgICAgIGRyYWc6IDAsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IG5ldyBUSFJFRS5Db2xvcigxLDEsMSksCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEdQVSBCdWZmZXJzCiAgICAgICAgICAgIHRoaXMucG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShtYXhQYXJ0aWNsZXMgKiAzKTsKICAgICAgICAgICAgdGhpcy5zaXplcyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzKTsKICAgICAgICAgICAgdGhpcy5yb3RhdGlvbnMgPSBuZXcgRmxvYXQzMkFycmF5KG1heFBhcnRpY2xlcyk7CiAgICAgICAgICAgIHRoaXMub3BhY2l0aWVzID0gbmV3IEZsb2F0MzJBcnJheShtYXhQYXJ0aWNsZXMpOwogICAgICAgICAgICB0aGlzLmNvbG9ycyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4UGFydGljbGVzICogMyk7CgogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgncG9zaXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMucG9zaXRpb25zLCAzKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ3NpemUnLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMuc2l6ZXMsIDEpKTsKICAgICAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgncm90YXRpb24nLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMucm90YXRpb25zLCAxKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ29wYWNpdHknLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKHRoaXMub3BhY2l0aWVzLCAxKSk7CiAgICAgICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ2NvbG9yJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZSh0aGlzLmNvbG9ycywgMykpOwoKICAgICAgICAgICAgLy8gU2hhZGVyIE1hdGVyaWFsCiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCh7CiAgICAgICAgICAgICAgICB1bmlmb3JtczogewogICAgICAgICAgICAgICAgICAgIG1hcDogeyB2YWx1ZTogdGV4dHVyZSB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiBgCiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IHNpemU7CiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IHJvdGF0aW9uOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBvcGFjaXR5OwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSB2ZWMzIGNvbG9yOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdlJvdGF0aW9uOwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdk9wYWNpdHk7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMzIHZDb2xvcjsKICAgICAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZSb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICB2T3BhY2l0eSA9IG9wYWNpdHk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZDb2xvciA9IGNvbG9yOwogICAgICAgICAgICAgICAgICAgICAgICB2ZWM0IG12UG9zaXRpb24gPSBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KHBvc2l0aW9uLCAxLjApOwogICAgICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtdlBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTaXplIGF0dGVudWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGdsX1BvaW50U2l6ZSA9IHNpemUgKiAoMzAwLjAgLyAtbXZQb3NpdGlvbi56KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBgLAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIHNhbXBsZXIyRCBtYXA7CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2Um90YXRpb247CiAgICAgICAgICAgICAgICAgICAgdmFyeWluZyBmbG9hdCB2T3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdkNvbG9yOwogICAgICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmVjMiB1diA9IGdsX1BvaW50Q29vcmQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgY2VudGVyZWQgPSB1diAtIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxvYXQgYyA9IGNvcyh2Um90YXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdCBzID0gc2luKHZSb3RhdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzIgcm90YXRlZCA9IHZlYzIoY2VudGVyZWQueCAqIGMgLSBjZW50ZXJlZC55ICogcywgY2VudGVyZWQueCAqIHMgKyBjZW50ZXJlZC55ICogYykgKyAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlYzQgdGV4ID0gdGV4dHVyZTJEKG1hcCwgcm90YXRlZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQodGV4LnJnYiAqIHZDb2xvciwgdGV4LmEgKiB2T3BhY2l0eSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYCwKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBibGVuZGluZzogYmxlbmRpbmcKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuUG9pbnRzKGdlbywgbWF0KTsKICAgICAgICAgICAgdGhpcy5tZXNoLmZydXN0dW1DdWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgc2NlbmUuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMb2dpYyBob29rCiAgICAgICAgICAgIHRoaXMudXBkYXRlTG9naWMgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgc3Bhd24ocG9zLCBvcHRpb25zKSB7CiAgICAgICAgICAgIC8vIEZpbmQgZmlyc3QgaW5hY3RpdmUKICAgICAgICAgICAgbGV0IHAgPSBudWxsOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLm1heFBhcnRpY2xlczsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZighdGhpcy5wYXJ0aWNsZXNbaV0uYWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgcCA9IHRoaXMucGFydGljbGVzW2ldOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIXApIHJldHVybjsgLy8gUG9vbCBmdWxsCgogICAgICAgICAgICBwLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgIHAucG9zLmNvcHkocG9zKTsKICAgICAgICAgICAgcC5saWZlID0gb3B0aW9ucy5saWZlIHx8IDEuMDsKICAgICAgICAgICAgcC5tYXhMaWZlID0gcC5saWZlOwogICAgICAgICAgICBwLnN0YXJ0U2NhbGUgPSBvcHRpb25zLnNjYWxlIHx8IDEuMDsKICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZTsKICAgICAgICAgICAgcC5yb3RhdGlvbiA9IG9wdGlvbnMucm90YXRpb24gfHwgMDsKICAgICAgICAgICAgcC52ZWwuY29weShvcHRpb25zLnZlbG9jaXR5IHx8IG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICBwLmdyYXZpdHkgPSBvcHRpb25zLmdyYXZpdHkgfHwgMDsKICAgICAgICAgICAgcC5kcmFnID0gb3B0aW9ucy5kcmFnIHx8IDA7CiAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbG9yKSBwLmNvbG9yLnNldChvcHRpb25zLmNvbG9yKTsKICAgICAgICAgICAgZWxzZSBwLmNvbG9yLnNldEhleCgweGZmZmZmZik7CiAgICAgICAgICAgIHAub3BhY2l0eSA9IDEuMDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBsZXQgYWN0aXZlQ291bnQgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5tYXhQYXJ0aWNsZXM7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMucGFydGljbGVzW2ldOwogICAgICAgICAgICAgICAgaWYgKCFwLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2l6ZXNbaV0gPSAwOyAvLyBIaWRlCiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcC5saWZlIC09IGR0OwogICAgICAgICAgICAgICAgaWYgKHAubGlmZSA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcC5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNpemVzW2ldID0gMDsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBQaHlzaWNzCiAgICAgICAgICAgICAgICBpZiAocC5ncmF2aXR5ICE9PSAwKSBwLnZlbC55IC09IHAuZ3Jhdml0eSAqIGR0OwogICAgICAgICAgICAgICAgaWYgKHAuZHJhZyAhPT0gMCkgcC52ZWwubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgoMCwgMS4wIC0gcC5kcmFnICogZHQpKTsKICAgICAgICAgICAgICAgIHAucG9zLmFkZFNjYWxlZFZlY3RvcihwLnZlbCwgZHQpOwoKICAgICAgICAgICAgICAgIC8vIExvZ2ljCiAgICAgICAgICAgICAgICBjb25zdCB0ID0gMS4wIC0gKHAubGlmZSAvIHAubWF4TGlmZSk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy51cGRhdGVMb2dpYykgewogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTG9naWMocCwgdCwgZHQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBCdWZmZXJzCiAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uc1tpKjNdID0gcC5wb3MueDsKICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25zW2kqMysxXSA9IHAucG9zLnk7CiAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uc1tpKjMrMl0gPSBwLnBvcy56OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLnNpemVzW2ldID0gcC5zY2FsZTsKICAgICAgICAgICAgICAgIHRoaXMucm90YXRpb25zW2ldID0gcC5yb3RhdGlvbjsKICAgICAgICAgICAgICAgIHRoaXMub3BhY2l0aWVzW2ldID0gcC5vcGFjaXR5OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmNvbG9yc1tpKjNdID0gcC5jb2xvci5yOwogICAgICAgICAgICAgICAgdGhpcy5jb2xvcnNbaSozKzFdID0gcC5jb2xvci5nOwogICAgICAgICAgICAgICAgdGhpcy5jb2xvcnNbaSozKzJdID0gcC5jb2xvci5iOwoKICAgICAgICAgICAgICAgIGFjdGl2ZUNvdW50Kys7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhY3RpdmVDb3VudCA+IDAgfHwgdGhpcy5hY3RpdmVDb3VudCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMubWVzaC5nZW9tZXRyeS5hdHRyaWJ1dGVzLnNpemUubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMucm90YXRpb24ubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMub3BhY2l0eS5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLm1lc2guZ2VvbWV0cnkuYXR0cmlidXRlcy5jb2xvci5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hY3RpdmVDb3VudCA9IGFjdGl2ZUNvdW50OwogICAgICAgIH0KICAgIH0KCiAgICBjbGFzcyBQYXJ0aWNsZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNjZW5lKSB7CiAgICAgICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTsKICAgICAgICAgICAgdGhpcy5iYXRjaGVzID0ge307CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBJbml0aWFsaXplIEJhdGNoZXMKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ3Zlbm9tJywgX3Zlbm9tVGV4LCAxMDAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnBvcy54ICs9IE1hdGguc2luKHQgKiAxMCArIHAucG9zLnkpICogMC4wNTsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuOCAqICgxLjAgLSBNYXRoLnBvdyh0LCAzKSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ25hcCcsIF9uYXBUZXgsIDUwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMC41ICsgdCAqIDEuNSk7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSBNYXRoLnBvdyh0LCAyKTsKICAgICAgICAgICAgICAgIHAucG9zLnggKz0gTWF0aC5zaW4odCAqIDUpICogMC4wMjsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnd2l0aGVyJywgX3dpdGhlclRleCwgMTAwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAub3BhY2l0eSA9IDAuNiAqICgxLjAgLSB0KTsKICAgICAgICAgICAgICAgIHAucm90YXRpb24gKz0gMC4wNTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnbGVhcm5lZCcsIF92ZW5vbVRleCwgNTAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAxLjAgLSB0OwogICAgICAgICAgICAgICAgcC5jb2xvci5zZXRIZXgoMHgwMGZmZmYpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdzaG9ja3dhdmUnLCBfc2hvY2t3YXZlVGV4LCAyMCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiBNYXRoLnBvdyh0LCAwLjUpICogNS4wOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMS4wIC0gTWF0aC5wb3codCwgMik7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fY3JlYXRlQmF0Y2goJ2ZsYXNoJywgX2ZsYXNoVGV4LCA1MCwgVEhSRUUuQWRkaXRpdmVCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAuc2NhbGUgPSBwLnN0YXJ0U2NhbGUgKiAoMS4wIC0gdCk7CiAgICAgICAgICAgICAgICBwLnJvdGF0aW9uICs9IDAuMjsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnZGVicmlzJywgX2RlYnJpc1RleCwgMTAwLCBUSFJFRS5Ob3JtYWxCbGVuZGluZywgKHAsIHQpID0+IHsKICAgICAgICAgICAgICAgIHAucm90YXRpb24gKz0gMC4yOwogICAgICAgICAgICAgICAgcC5zY2FsZSA9IHAuc3RhcnRTY2FsZSAqICgxLjAgLSB0KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnYnViYmxlJywgX2J1YmJsZVRleCwgMjAwLCBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLCAocCwgdCkgPT4gewogICAgICAgICAgICAgICAgcC5wb3MueCArPSBNYXRoLnNpbih0ICogMTAgKyBwLnBvcy56KSAqIDAuMDI7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCArIHQgKiAwLjIpOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMC42ICogKDEuMCAtIE1hdGgucG93KHQsIDIpKTsKICAgICAgICAgICAgICAgIHAuY29sb3Iuc2V0SGV4KDB4YWFjY2ZmKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLl9jcmVhdGVCYXRjaCgnYnViYmxlX21pY3JvJywgX21pY3JvQnViYmxlVGV4LCAzMDAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLnNjYWxlID0gcC5zdGFydFNjYWxlICogKDEuMCAtIHQpOwogICAgICAgICAgICAgICAgcC5vcGFjaXR5ID0gMC45ICogKDEuMCAtIHQpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUJhdGNoKCdkYXNoX3N0cmVhbScsIF9kYXNoU3RyZWFtVGV4LCAxMDAsIFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsIChwLCB0KSA9PiB7CiAgICAgICAgICAgICAgICBwLm9wYWNpdHkgPSAwLjggKiAoMS4wIC0gdCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgX2NyZWF0ZUJhdGNoKG5hbWUsIHRleCwgY291bnQsIGJsZW5kaW5nLCBsb2dpYykgewogICAgICAgICAgICBjb25zdCBiYXRjaCA9IG5ldyBQYXJ0aWNsZUJhdGNoKHRoaXMuc2NlbmUsIHRleCwgY291bnQsIGJsZW5kaW5nKTsKICAgICAgICAgICAgaWYgKGxvZ2ljKSBiYXRjaC51cGRhdGVMb2dpYyA9IGxvZ2ljOwogICAgICAgICAgICB0aGlzLmJhdGNoZXNbbmFtZV0gPSBiYXRjaDsKICAgICAgICB9CgogICAgICAgIHNwYXduKHR5cGUsIHBvcywgb3B0aW9ucyA9IHt9KSB7CiAgICAgICAgICAgIGNvbnN0IGJhdGNoID0gdGhpcy5iYXRjaGVzW3R5cGVdOwogICAgICAgICAgICBpZiAoYmF0Y2gpIHsKICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgcGh5c2ljcyBwYXJhbXMgaWYgbm90IHByb3ZpZGVkCiAgICAgICAgICAgICAgICBjb25zdCBvcHRzID0geyAuLi5vcHRpb25zIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAndmVub20nKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gb3B0cy5saWZlIHx8IDEuMCArIE1hdGgucmFuZG9tKCkgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgb3B0cy52ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEuMCArIE1hdGgucmFuZG9tKCksIDApOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjMgKyBNYXRoLnJhbmRvbSgpICogMC4yOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbmFwJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDIuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnZlbG9jaXR5ID0gbmV3IFRIUkVFLlZlY3RvcjMoKE1hdGgucmFuZG9tKCktMC41KSowLjIsIDAuNSwgKE1hdGgucmFuZG9tKCktMC41KSowLjIpOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAwLjQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICd3aXRoZXInKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMS41OwogICAgICAgICAgICAgICAgICAgIG9wdHMudmVsb2NpdHkgPSBuZXcgVEhSRUUuVmVjdG9yMygoTWF0aC5yYW5kb20oKS0wLjUpKjAuNSwgMC41LCAoTWF0aC5yYW5kb20oKS0wLjUpKjAuNSk7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2hvY2t3YXZlJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IG9wdHMubGlmZSB8fCAwLjQ7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5zY2FsZSA9IG9wdHMuc2NhbGUgfHwgMi4wOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZmxhc2gnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMC4yOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSBvcHRzLnNjYWxlIHx8IDMuMDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnJvdGF0aW9uID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdkZWJyaXMnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5saWZlID0gMS41OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gNS4wICsgTWF0aC5yYW5kb20oKSAqIDEwLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy52ZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogc3BlZWQsCiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLnJhbmRvbSgpICogc3BlZWQgKiAwLjUpICsgMi4wLAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKS0wLjUpICogc3BlZWQKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIG9wdHMuZ3Jhdml0eSA9IDIwLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5kcmFnID0gMS4wOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAob3B0cy5zY2FsZSB8fCAwLjMpICogKDAuNSArIE1hdGgucmFuZG9tKCkpOwogICAgICAgICAgICAgICAgICAgIG9wdHMucm90YXRpb24gPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2J1YmJsZScpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAxLjAgKyBNYXRoLnJhbmRvbSgpICogMS4wOwogICAgICAgICAgICAgICAgICAgIG9wdHMudmVsb2NpdHkgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC41LAogICAgICAgICAgICAgICAgICAgICAgICAwLjUgKyBNYXRoLnJhbmRvbSgpICogMS4wLAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAwLjUKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAob3B0cy5zY2FsZSB8fCAwLjE1KSAqICgwLjggKyBNYXRoLnJhbmRvbSgpICogMC40KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2J1YmJsZV9taWNybycpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmxpZmUgPSAwLjQgKyBNYXRoLnJhbmRvbSgpICogMC40OwogICAgICAgICAgICAgICAgICAgIG9wdHMudmVsb2NpdHkgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMS41LAogICAgICAgICAgICAgICAgICAgICAgICAxLjUgKyBNYXRoLnJhbmRvbSgpICogMi4wLAogICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxLjUKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIG9wdHMuc2NhbGUgPSAob3B0cy5zY2FsZSB8fCAwLjE1KSAqICgwLjggKyBNYXRoLnJhbmRvbSgpICogMC41KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Rhc2hfc3RyZWFtJykgewogICAgICAgICAgICAgICAgICAgIG9wdHMubGlmZSA9IDAuMzsKICAgICAgICAgICAgICAgICAgICBvcHRzLnNjYWxlID0gb3B0cy5zY2FsZSB8fCAyLjA7CiAgICAgICAgICAgICAgICAgICAgb3B0cy5yb3RhdGlvbiA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGJhdGNoLnNwYXduKHBvcywgb3B0cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLmJhdGNoZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmF0Y2hlc1trZXldLnVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguUGFydGljbGVNYW5hZ2VyID0gUGFydGljbGVNYW5hZ2VyOwp9KSgpOw==","DevTools.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFRvb2x0aXAgRGVzY3JpcHRpb25zIGZvciBMb25nLVByZXNzCiAgICBjb25zdCBUT09MVElQX0RFU0NSSVBUSU9OUyA9IHsKICAgICAgICAnU1VCU1RFUFMnOiAiUGh5c2ljcyBpdGVyYXRpb25zIHBlciBmcmFtZS4gSGlnaGVyID0gbW9yZSBzdGFibGUsIG1vcmUgQ1BVLiIsCiAgICAgICAgJ1NUT1BfU1BFRUQnOiAiVmVsb2NpdHkgdGhyZXNob2xkIGJlbG93IHdoaWNoIHRoZSBiYWxsIHNuYXBzIHRvIGEgaGFsdC4iLAogICAgICAgICdXQVRFUl9EUkFHX0xJTkVBUic6ICJCYXNlIHdhdGVyIHJlc2lzdGFuY2UuIFNsb3dzIGJhbGwgbGluZWFybHkuIiwKICAgICAgICAnV0FURVJfRFJBR19RVUFEJzogIlF1YWRyYXRpYyBkcmFnLiBTbG93cyBoaWdoLXNwZWVkIGJhbGxzIHNpZ25pZmljYW50bHkuIiwKICAgICAgICAnU1BJTl9EUkFHJzogIkhvdyBmYXN0IHRoZSBiYWxsJ3Mgc3BpbiBkZWNheXMgb3ZlciB0aW1lLiIsCiAgICAgICAgJ01BR05VU19FTkFCTEVEJzogIkVuYWJsZXMgdGhlIE1hZ251cyBlZmZlY3QgKGN1cnZlIGZyb20gc3BpbikuIiwKICAgICAgICAnTUFHTlVTX0NPRUZGJzogIlN0cmVuZ3RoIG9mIHRoZSBjdXJ2ZSBmb3JjZSByZWxhdGl2ZSB0byBzcGluL3NwZWVkLiIsCiAgICAgICAgJ01BR05VU19DQVAnOiAiTWF4aW11bSBjdXJ2ZSBmb3JjZSBhbGxvd2VkIChwcmV2ZW50cyBwaHlzaWNzIGV4cGxvc2lvbnMpLiIsCiAgICAgICAgJ0RFUFRIX1RBUkdFVF9ZJzogIklkZWFsIFkgaGVpZ2h0IHRoZSBiYWxsIHRyaWVzIHRvIGZsb2F0IGF0LiIsCiAgICAgICAgJ0RFUFRIX1NQUklORyc6ICJTdHJlbmd0aCBvZiB0aGUgZm9yY2UgcHVsbGluZyBiYWxsIHRvIFRhcmdldCBZLiIsCiAgICAgICAgJ0RFUFRIX0RBTVAnOiAiRGFtcGluZyBvbiB2ZXJ0aWNhbCBtb3ZlbWVudCB0byBwcmV2ZW50IG9zY2lsbGF0aW9uLiIsCiAgICAgICAgJ0JPVU5EQVJZX1JBRElVUyc6ICJSYWRpdXMgb2YgdGhlIGNpcmN1bGFyIGFyZW5hIHdhbGwuIiwKICAgICAgICAnQk9VTkRBUllfSEVJR0hUJzogIkhlaWdodCBvZiB0aGUgYXJlbmEgY2VpbGluZy9mbG9vci4iLAogICAgICAgICdXQUxMX1NPRlRfQlVGRkVSJzogIkRpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMuIiwKICAgICAgICAnV0FMTF9TT0ZUX0ZPUkNFJzogIkZvcmNlIHB1c2hpbmcgYmFsbCBhd2F5IGZyb20gd2FsbCBiZWZvcmUgaW1wYWN0LiIsCiAgICAgICAgJ1dBTExfRUxBU1RJQ0lUWSc6ICJCb3VuY2luZXNzIG9mIHRoZSB3YWxsICgwID0gZGVhZCB0aHVkLCAxID0gcGVyZmVjdCBib3VuY2UpLiIsCiAgICAgICAgJ1dBTExfRlJJQ1RJT04nOiAiRnJpY3Rpb24gd2hlbiBzbGlkaW5nIGFsb25nIHRoZSB3YWxsLiIsCiAgICAgICAgJ0ZMT09SX0VMQVNUSUNJVFknOiAiQm91bmNpbmVzcyBvZiB0aGUgZmxvb3IvY2VpbGluZy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9FTkFCTEVEJzogIkVuYWJsZXMgdGhlIGV4dGVuZGVkIGNvcnJpZG9yIGZvciB0aGUgZ29hbC4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9YJzogIkhhbGYtd2lkdGggb2YgdGhlIGdvYWwgcG9ja2V0IGNvcnJpZG9yLiIsCiAgICAgICAgJ0dPQUxfUE9DS0VUX1onOiAiWi1kZXB0aCB3aGVyZSB0aGUgcG9ja2V0IHN0YXJ0cy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9SQURJVVMnOiAiRWZmZWN0aXZlIHJhZGl1cyBpbnNpZGUgdGhlIHBvY2tldC4iLAogICAgICAgICdMQVVOQ0hfU1BFRURfU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBTdGF0IFBvd2VyIHRvIFBoeXNpY3MgVmVsb2NpdHkuIiwKICAgICAgICAnTEFVTkNIX1NQRUVEX0NBUCc6ICJNYXhpbXVtIHBoeXNpY2FsIHNwZWVkIHRoZSBiYWxsIGNhbiBiZSB0aHJvd24uIiwKICAgICAgICAnU1dJUEVfTUlOX1BYJzogIk1pbmltdW0gc3dpcGUgZGlzdGFuY2UgdG8gcmVnaXN0ZXIgYSB0aHJvdy4iLAogICAgICAgICdBSU1fRFhfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgaG9yaXpvbnRhbCBhaW0gZnJvbSBzd2lwZS4iLAogICAgICAgICdBSU1fRFlfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgdmVydGljYWwgYWltIGZyb20gc3dpcGUuIiwKICAgICAgICAnUE9XRVJfQkFTRSc6ICJCYXNlIHBvd2VyIG11bHRpcGxpZXIgZm9yIGEgcXVpY2sgdGFwLiIsCiAgICAgICAgJ1BPV0VSX1JBTkdFJzogIkFkZGl0aW9uYWwgcG93ZXIgbXVsdGlwbGllciBhdCBmdWxsIGNoYXJnZS4iLAogICAgICAgICdQT1dFUl9NQVhfQk9OVVNfUkFUSU8nOiAiQ2hhcmdlIHRocmVzaG9sZCBmb3IgJ01heCBQb3dlcicgYm9udXMuIiwKICAgICAgICAnUE9XRVJfTUFYX01VTFRJUExJRVInOiAiTXVsdGlwbGllciBhcHBsaWVkIHdoZW4gaGl0dGluZyBNYXggUG93ZXIuIiwKICAgICAgICAnQ1VSVkVfRU5BQkxFRCc6ICJFbmFibGVzIGN1cnZlIHNob3RzIHZpYSBjdXJ2ZWQgc3dpcGVzLiIsCiAgICAgICAgJ0NVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQnOiAiSG93IGN1cnZlZCBhIHN3aXBlIG11c3QgYmUgdG8gdHJpZ2dlciBzcGluLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBzd2lwZSBjdXJ2ZSB0byBiYWxsIHNwaW4uIiwKICAgICAgICAnQ1VSVkVfU1BFRURfTVVMVCc6ICJNdWx0aXBsaWVyIGZvciBzcGluIGJhc2VkIG9uIHN3aXBlIHNwZWVkLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fQ0FQJzogIk1heGltdW0gc3BpbiBhbGxvd2VkIGZyb20gYSBjdXJ2ZSB0aHJvdy4iLAogICAgICAgICdDVVJWRV9QRVJGRUNUX1NQSU4nOiAiU3BpbiB0aHJlc2hvbGQgdG8gdHJpZ2dlciAnUGVyZmVjdCBDdXJ2ZScgRlguIiwKICAgICAgICAndGltZVNjYWxlJzogIkdsb2JhbCBnYW1lIHNwZWVkIG11bHRpcGxpZXIuIiwKICAgICAgICAnZGVtb01vZGUnOiAiVG9nZ2xlIEFJIHZzIEFJIGF1dG8tcGxheS4iLAogICAgICAgICdyZXNvbHV0aW9uJzogIkludGVybmFsIHJlbmRlciByZXNvbHV0aW9uIHNjYWxlICgwLjUgPSBoYWxmIHJlcykuIiwKICAgICAgICAnYXJlbmFPcGFjaXR5JzogIk9wYWNpdHkgb2YgdGhlIG91dGVyIGFyZW5hIGdyaWQuIiwKJ2FyZW5hMk9wYWNpdHknOiAiT3BhY2l0eSBvZiB0aGUgaW5uZXIgaGV4IGdyaWQuIiwKCiAgICAgICAgJ0dPQUxfRElTVEFOQ0UnOiAiRGlzdGFuY2Ugb2YgdGhlIGdvYWxzIGZyb20gdGhlIGNlbnRlciAoWi1heGlzKS4iCiAgICB9OwogICAgY2xhc3MgRGV2VG9vbHMgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gbGlsLWd1aSBhdHRhY2hlcyB0byB3aW5kb3cubGlsIGJ5IGRlZmF1bHQgaW4gVU1EIGJ1aWxkCiAgICAgICAgICAgIGlmICghd2luZG93LmxpbCB8fCAhd2luZG93LmxpbC5HVUkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiRGV2VG9vbHM6IGxpbC1ndWkgbm90IGZvdW5kLiIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9Cgpjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKICAgICAgICAgICAgdGhpcy5ndWkgPSBuZXcgd2luZG93LmxpbC5HVUkoeyB0aXRsZTogJ0ZsdXggRGV2VG9vbHMnLCBjb250YWluZXI6IGNvbnRhaW5lciB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBvc2l0aW9uIGFzIGEgY29sbGFwc2VkIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gUG9zaXRpb24gYXMgYSBzbGlkaW5nIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gUG9zaXRpb24gYXMgYSBzbGlkaW5nIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gV3JhcHBlciBmb3Igc2xpZGluZyBhbmltYXRpb24KICAgICAgICAgICAgY29uc3Qgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS50b3AgPSAnMTAwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnJpZ2h0ID0gJy0yNjBweCc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUud2lkdGggPSAnMjYwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnRyYW5zaXRpb24gPSAncmlnaHQgMC4zcyBjdWJpYy1iZXppZXIoMC4yLCAwLjgsIDAuMiwgMS4wKSc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUuekluZGV4ID0gJzk5OTknOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUuZmxleERpcmVjdGlvbiA9ICdjb2x1bW4nOwogICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgogICAgICAgICAgICBjb25zdCBkb20gPSB0aGlzLmd1aS5kb21FbGVtZW50OwogICAgICAgICAgICBkb20uc3R5bGUud2lkdGggPSAnMTAwJSc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5zZXRQcm9wZXJ0eSgnLS13aWR0aCcsICcxMDAlJyk7CiAgICAgICAgICAgIGRvbS5zdHlsZS5tYXhIZWlnaHQgPSAnODB2aCc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvd1kgPSAnYXV0byc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvd1ggPSAnaGlkZGVuJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgR1VJIGludG8gd3JhcHBlcgogICAgICAgICAgICB3cmFwcGVyLmFwcGVuZENoaWxkKGRvbSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDcmVhdGUgVG9nZ2xlIEhhbmRsZQogICAgICAgICAgICBjb25zdCBoYW5kbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmxlZnQgPSAnLTQwcHgnOyAvLyBQcm90cnVkZSB0byB0aGUgbGVmdAogICAgICAgICAgICBoYW5kbGUuc3R5bGUudG9wID0gJzAnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUud2lkdGggPSAnNDBweCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5oZWlnaHQgPSAnNDBweCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAncmdiYSgwLCAyMCwgNDAsIDAuOSknOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyID0gJzFweCBzb2xpZCAjMDBmZmZmJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlclJpZ2h0ID0gJ25vbmUnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyVG9wTGVmdFJhZGl1cyA9ICc4cHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyQm90dG9tTGVmdFJhZGl1cyA9ICc4cHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuY3Vyc29yID0gJ3BvaW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmp1c3RpZnlDb250ZW50ID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5hbGlnbkl0ZW1zID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5jb2xvciA9ICcjMDBmZmZmJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmZvbnRTaXplID0gJzIwcHgnOwogICAgICAgICAgICBoYW5kbGUuaW5uZXJIVE1MID0gJ+KamSc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5ib3hTaGFkb3cgPSAnLTVweCAwIDEwcHggcmdiYSgwLDAsMCwwLjUpJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaGFuZGxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBMb2dpYwogICAgICAgICAgICBsZXQgaXNPcGVuID0gZmFsc2U7CiAgICAgICAgICAgIGhhbmRsZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyAvLyBQcmV2ZW50IGdhbWUgaW5wdXRzCiAgICAgICAgICAgICAgICBpc09wZW4gPSAhaXNPcGVuOwogICAgICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5yaWdodCA9IGlzT3BlbiA/ICcwcHgnIDogJy0yNjBweCc7CiAgICAgICAgICAgICAgICBoYW5kbGUuaW5uZXJIVE1MID0gaXNPcGVuID8gJ8K7JyA6ICfimpknOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gRGVmYXVsdCBnbG9iYWwgdGltZVNjYWxlIGlmIG5vdCBzZXQKaWYgKHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9PT0gdW5kZWZpbmVkKSB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjg7Cgp0aGlzLl9zZXR1cEdlbmVyYWwoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBHYW1lU3RhdGUoKTsKdGhpcy5fc2V0dXBPdmVybGF5cygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFRlYW1zKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwUGxheWVySW5zcGVjdG9yKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwQmFsbFNhbmRib3goKTsKdGhpcy5fc2V0dXBGWExhYigpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFZpc3VhbERlYnVnKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwVmlzdWFscygpOwp0aGlzLl9zZXR1cFZpc3VhbHMoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBBdWRpbygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFRvb2x0aXBzKCk7CiAgICAgICAgfQoKICAgICAgICBfc2V0dXBUb29sdGlwcygpIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIFRvb2x0aXAgRE9NCiAgICAgICAgICAgIHRoaXMudG9vbHRpcEVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy50b29sdGlwRWwuc3R5bGUsIHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAnZml4ZWQnLAogICAgICAgICAgICAgICAgdG9wOiAnNTAlJywKICAgICAgICAgICAgICAgIGxlZnQ6ICc1MCUnLAogICAgICAgICAgICAgICAgdHJhbnNmb3JtOiAndHJhbnNsYXRlKC01MCUsIC01MCUpJywKICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogJ3JnYmEoMCwgMTAsIDMwLCAwLjk1KScsCiAgICAgICAgICAgICAgICBib3JkZXI6ICcycHggc29saWQgIzAwZmZmZicsCiAgICAgICAgICAgICAgICBwYWRkaW5nOiAnMjBweCcsCiAgICAgICAgICAgICAgICBjb2xvcjogJyNmZmYnLAogICAgICAgICAgICAgICAgZm9udEZhbWlseTogJ21vbm9zcGFjZScsCiAgICAgICAgICAgICAgICBmb250U2l6ZTogJzE0cHgnLAogICAgICAgICAgICAgICAgbWF4V2lkdGg6ICczMDBweCcsCiAgICAgICAgICAgICAgICB6SW5kZXg6ICcxMDAwMCcsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAnbm9uZScsCiAgICAgICAgICAgICAgICBwb2ludGVyRXZlbnRzOiAnbm9uZScsCiAgICAgICAgICAgICAgICBib3hTaGFkb3c6ICcwIDAgMjBweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjMpJywKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogJzhweCcsCiAgICAgICAgICAgICAgICB0ZXh0QWxpZ246ICdjZW50ZXInCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMudG9vbHRpcEVsKTsKCiAgICAgICAgICAgIC8vIFJlY3Vyc2l2ZSBmdW5jdGlvbiB0byBhdHRhY2ggbGlzdGVuZXJzCiAgICAgICAgICAgIGNvbnN0IGF0dGFjaCA9IChndWkpID0+IHsKICAgICAgICAgICAgICAgIC8vIENvbnRyb2xsZXJzCiAgICAgICAgICAgICAgICBpZiAoZ3VpLmNvbnRyb2xsZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgZ3VpLmNvbnRyb2xsZXJzLmZvckVhY2goYyA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRvbSA9IGMuZG9tRWxlbWVudC5jbG9zZXN0KCcuY29udHJvbGxlcicpOyAvLyBsaWwtZ3VpIHN0cnVjdHVyZQogICAgICAgICAgICAgICAgICAgICAgICBpZihkb20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gZG9tLnF1ZXJ5U2VsZWN0b3IoJy5uYW1lJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihsYWJlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2FkZExvbmdQcmVzcyhsYWJlbCwgYy5wcm9wZXJ0eSwgYy5fbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIFN1Yi1mb2xkZXJzCiAgICAgICAgICAgICAgICBpZihndWkuZm9sZGVycykgewogICAgICAgICAgICAgICAgICAgIGd1aS5mb2xkZXJzLmZvckVhY2goZiA9PiBhdHRhY2goZikpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gV2FpdCBhIHRpY2sgZm9yIEdVSSB0byBmdWxseSByZW5kZXIgRE9NCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gYXR0YWNoKHRoaXMuZ3VpKSwgMTAwKTsKICAgICAgICB9CgogICAgICAgIF9hZGRMb25nUHJlc3MoZWxlbWVudCwgcHJvcGVydHksIG5hbWUpIHsKICAgICAgICAgICAgbGV0IHRpbWVyID0gbnVsbDsKICAgICAgICAgICAgY29uc3QgZHVyYXRpb24gPSA1MDA7IC8vIDAuNXMKCiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIHRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd1Rvb2x0aXAocHJvcGVydHksIG5hbWUpOwogICAgICAgICAgICAgICAgfSwgZHVyYXRpb24pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgZW5kID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYodGltZXIpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpOwogICAgICAgICAgICAgICAgICAgIHRpbWVyID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVUb29sdGlwKCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHN0YXJ0KTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0Jywgc3RhcnQsIHtwYXNzaXZlOiB0cnVlfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBlbmQpOwogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCBlbmQpOwogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgZW5kKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGVuZCk7CiAgICAgICAgfQoKICAgICAgICBfc2hvd1Rvb2x0aXAocHJvcCwgbmFtZSkgewogICAgICAgICAgICBjb25zdCBkZXNjID0gVE9PTFRJUF9ERVNDUklQVElPTlNbcHJvcF07CiAgICAgICAgICAgIGlmKGRlc2MpIHsKICAgICAgICAgICAgICAgIHRoaXMudG9vbHRpcEVsLmlubmVySFRNTCA9IGA8c3Ryb25nIHN0eWxlPSJjb2xvcjojMDBmZmZmOyBmb250LXNpemU6MTZweDsiPiR7bmFtZSB8fCBwcm9wfTwvc3Ryb25nPjxicj48YnI+JHtkZXNjfWA7CiAgICAgICAgICAgICAgICB0aGlzLnRvb2x0aXBFbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVUb29sdGlwKCkgewogICAgICAgICAgICBpZiAodGhpcy50b29sdGlwRWwpIHRoaXMudG9vbHRpcEVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQoKCl9zZXR1cEdlbmVyYWwoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignR2VuZXJhbCcpOwogICAgICAgICAgICAKY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgdGltZVNjYWxlOiB3aW5kb3cuZmx1eC50aW1lU2NhbGUsCiAgICAgICAgICAgICAgICBkZW1vTW9kZTogdGhpcy5nYW1lLmlzRGVtb01vZGUsCiAgICAgICAgICAgICAgICB0b2dnbGVIVUQ6IHRydWUsCiAgICAgICAgICAgICAgICByZXNvbHV0aW9uOiAwLjUwLAphcmVuYU9wYWNpdHk6IDAuMywKICAgICAgICAgICAgICAgIGFyZW5hMk9wYWNpdHk6IDAuMjUKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndGltZVNjYWxlJywgMC4wLCA1LjApLm5hbWUoJ0dhbWUgU3BlZWQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9IHY7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdkZW1vTW9kZScpLm5hbWUoJ0RlbW8gTW9kZScpLmxpc3RlbigpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5pc0RlbW9Nb2RlICE9PSB2KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRvZ2dsZURlbW9Nb2RlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICd0b2dnbGVIVUQnKS5uYW1lKCdTaG93IEhVRCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgY29uc3QgaHVkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJyk7CiAgICAgICAgICAgICAgICBpZiAoaHVkKSB7CiAgICAgICAgICAgICAgICAgICAgaHVkLnN0eWxlLnZpc2liaWxpdHkgPSB2ID8gJ3Zpc2libGUnIDogJ2hpZGRlbic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdyZXNvbHV0aW9uJywgMC4xLCAyLjApLm5hbWUoJ1Jlc29sdXRpb24gU2NhbGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHcgPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICAgICAgICAgIGNvbnN0IGggPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICBjb25zdCByZW5kZXJlciA9IHRoaXMuZ2FtZS5yZW5kZXJlcjsKICAgICAgICAgICAgICAgIGlmIChyZW5kZXJlcikgewogICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyLnNldFNpemUodyAqIHYsIGggKiB2LCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYU9wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnQXJlbmEgMSBPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjb25zdCBibGVuZE1vZGVzID0gewogICAgICAgICAgICAgICAgJ05vcm1hbCc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ0FkZGl0aXZlJzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICdNdWx0aXBseSc6IFRIUkVFLk11bHRpcGx5QmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnU3VidHJhY3RpdmUnOiBUSFJFRS5TdWJ0cmFjdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ05vQmxlbmRpbmcnOiBUSFJFRS5Ob0JsZW5kaW5nCiAgICAgICAgICAgIH07CnBhcmFtcy5hcmVuYUJsZW5kID0gJ05vcm1hbCc7CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hQmxlbmQnLCBPYmplY3Qua2V5cyhibGVuZE1vZGVzKSkubmFtZSgnQXJlbmEgMSBCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwuYmxlbmRpbmcgPSBibGVuZE1vZGVzW3ZdOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gQXJlbmEgMiBDb250cm9scwpmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hMk9wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnQXJlbmEgMiBPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoMiAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlID0gdjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgpwYXJhbXMuYXJlbmEyQmxlbmQgPSAnQWRkaXRpdmUnOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hMkJsZW5kJywgT2JqZWN0LmtleXMoYmxlbmRNb2RlcykpLm5hbWUoJ0FyZW5hIDIgQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2gyICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLmJsZW5kaW5nID0gYmxlbmRNb2Rlc1t2XTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBkZWZhdWx0cwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBwYXJhbXMuYXJlbmFPcGFjaXR5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2gyICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwub3BhY2l0eSA9IHBhcmFtcy5hcmVuYTJPcGFjaXR5OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gQXJlbmEgR3JhcGhpY3MgQ29udHJvbHMgLS0tCiAgICAgICAgICAgIHRoaXMuX3NldHVwQXJlbmFHcmFwaGljcygpOwogICAgICAgIH0KCiAgICAgICAgX3NldHVwQXJlbmFHcmFwaGljcygpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdBcmVuYSBHcmFwaGljcycpOwoKICAgICAgICAgICAgY29uc3QgdGhyZWVCbGVuZHMgPSB7CiAgICAgICAgICAgICAgICAnTm9ybWFsJzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnQWRkaXRpdmUnOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICdNdWx0aXBseSc6IFRIUkVFLk11bHRpcGx5QmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnTm9CbGVuZGluZyc6IFRIUkVFLk5vQmxlbmRpbmcKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIC0tLSBCbHVlIEJhbmQgLS0tCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCkgewogICAgICAgICAgICAgICAgY29uc3QgYmx1ZUZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0JsdWUgQmFuZCcpOwogICAgICAgICAgICAgICAgY29uc3QgYmx1ZVBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2ggPyB3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2gudmlzaWJsZSA6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd2luZG93LmZsdXguYmx1ZUJhbmRNYXQub3BhY2l0eSB8fCAwLjM1LAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnTm9ybWFsJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGJsdWVGb2xkZXIuYWRkKGJsdWVQYXJhbXMsICd2aXNpYmxlJykubmFtZSgnVmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2gpIHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaC52aXNpYmxlID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgYmx1ZUZvbGRlci5hZGQoYmx1ZVBhcmFtcywgJ29wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCkgd2luZG93LmZsdXguYmx1ZUJhbmRNYXQub3BhY2l0eSA9IHY7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGJsdWVGb2xkZXIuYWRkKGJsdWVQYXJhbXMsICdibGVuZCcsIE9iamVjdC5rZXlzKHRocmVlQmxlbmRzKSkubmFtZSgnQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYmx1ZUJhbmRNYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNYXQuYmxlbmRpbmcgPSB0aHJlZUJsZW5kc1t2XTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNYXQubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gR29sZCBCYW5kIC0tLQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ29sZEJhbmRNYXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdvbGRGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdHb2xkIEJhbmQnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGdvbGRQYXJhbXMgPSB7CiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogd2luZG93LmZsdXguZ29sZEJhbmRNZXNoID8gd2luZG93LmZsdXguZ29sZEJhbmRNZXNoLnZpc2libGUgOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5vcGFjaXR5IHx8IDAuMzUsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdOb3JtYWwnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZ29sZEZvbGRlci5hZGQoZ29sZFBhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdWaXNpYmxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvbGRCYW5kTWVzaCkgd2luZG93LmZsdXguZ29sZEJhbmRNZXNoLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBnb2xkRm9sZGVyLmFkZChnb2xkUGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMS4wKS5uYW1lKCdPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0KSB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZ29sZEZvbGRlci5hZGQoZ29sZFBhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5uYW1lKCdCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBZZWxsb3cgQXJyb3dzIC0tLQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJyb3dNYXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFycm93Rm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignWWVsbG93IEFycm93cycpOwogICAgICAgICAgICAgICAgY29uc3QgYXJyb3dQYXJhbXMgPSB7CiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogd2luZG93LmZsdXguYXJyb3dHcm91cCA/IHdpbmRvdy5mbHV4LmFycm93R3JvdXAudmlzaWJsZSA6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd2luZG93LmZsdXguYXJyb3dNYXQub3BhY2l0eSB8fCAwLjgsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdBZGRpdGl2ZScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBhcnJvd0ZvbGRlci5hZGQoYXJyb3dQYXJhbXMsICd2aXNpYmxlJykubmFtZSgnVmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcnJvd0dyb3VwKSB3aW5kb3cuZmx1eC5hcnJvd0dyb3VwLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBhcnJvd0ZvbGRlci5hZGQoYXJyb3dQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ09wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJyb3dNYXQpIHdpbmRvdy5mbHV4LmFycm93TWF0Lm9wYWNpdHkgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBhcnJvd0ZvbGRlci5hZGQoYXJyb3dQYXJhbXMsICdibGVuZCcsIE9iamVjdC5rZXlzKHRocmVlQmxlbmRzKSkubmFtZSgnQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJyb3dNYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJyb3dNYXQuYmxlbmRpbmcgPSB0aHJlZUJsZW5kc1t2XTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJyb3dNYXQubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gRmxvb3IgR2x5cGggLS0tCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0KSB7CiAgICAgICAgICAgICAgICBjb25zdCBmbG9vckZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0Zsb29yIEdseXBoJyk7CiAgICAgICAgICAgICAgICBjb25zdCBmbG9vclBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWVzaCA/IHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNZXNoLnZpc2libGUgOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQub3BhY2l0eSB8fCAwLjM1LAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnQWRkaXRpdmUnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZmxvb3JGb2xkZXIuYWRkKGZsb29yUGFyYW1zLCAndmlzaWJsZScpLm5hbWUoJ1Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZmxvb3JHbHlwaE1lc2gpIHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNZXNoLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmbG9vckZvbGRlci5hZGQoZmxvb3JQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ09wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZmxvb3JHbHlwaE1hdCkgd2luZG93LmZsdXguZmxvb3JHbHlwaE1hdC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZmxvb3JGb2xkZXIuYWRkKGZsb29yUGFyYW1zLCAnYmxlbmQnLCBPYmplY3Qua2V5cyh0aHJlZUJsZW5kcykpLm5hbWUoJ0JsZW5kJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZmxvb3JHbHlwaE1hdC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9zZXR1cE92ZXJsYXlzKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ092ZXJsYXlzICYgRlgnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDEuIEdJRiBPdmVybGF5CiAgICAgICAgICAgIGNvbnN0IGdpZkVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NjcmVlbi1vdmVybGF5LWdpZicpOwogICAgICAgICAgICBpZiAoZ2lmRWwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdpZlBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB0cnVlLApvcGFjaXR5OiAwLjYyLAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnb3ZlcmxheScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdTY3JlZW4gR0lGJyk7CiAgICAgICAgICAgICAgICBnRm9sZGVyLmFkZChnaWZQYXJhbXMsICd2aXNpYmxlJykub25DaGFuZ2UodiA9PiBnaWZFbC5zdHlsZS5kaXNwbGF5ID0gdiA/ICdibG9jaycgOiAnbm9uZScpOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMS4wKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLm9wYWNpdHkgPSB2KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYmxlbmRNb2RlcyA9IFsKICAgICAgICAgICAgICAgICAgICAnbm9ybWFsJywgJ211bHRpcGx5JywgJ3NjcmVlbicsICdvdmVybGF5JywgCiAgICAgICAgICAgICAgICAgICAgJ2RhcmtlbicsICdsaWdodGVuJywgJ2NvbG9yLWRvZGdlJywgJ2NvbG9yLWJ1cm4nLCAKICAgICAgICAgICAgICAgICAgICAnaGFyZC1saWdodCcsICdzb2Z0LWxpZ2h0JywgJ2RpZmZlcmVuY2UnLCAnZXhjbHVzaW9uJywgCiAgICAgICAgICAgICAgICAgICAgJ2h1ZScsICdzYXR1cmF0aW9uJywgJ2NvbG9yJywgJ2x1bWlub3NpdHknCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAnYmxlbmQnLCBibGVuZE1vZGVzKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLm1peEJsZW5kTW9kZSA9IHYpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBXYXRlciBPdmVybGF5CiAgICAgICAgICAgIGNvbnN0IHdvID0gdGhpcy5nYW1lLndhdGVyT3ZlcmxheTsKICAgICAgICAgICAgaWYgKHdvICYmIHdvLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdXYXRlciBTaGFkZXInKTsKICAgICAgICAgICAgICAgIGNvbnN0IHdQYXJhbXMgPSB7IAogICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkgPyB3by5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eS52YWx1ZSA6IDAuNSwKICAgICAgICAgICAgICAgICAgICBibGVuZDogJ0FkZGl0aXZlJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ3Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IHdvLm1lc2gudmlzaWJsZSA9IHYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAod28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkpIHsKICAgICAgICAgICAgICAgICAgICB3Rm9sZGVyLmFkZCh3UGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMi4wKS5vbkNoYW5nZSh2ID0+IHdvLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlID0gdik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGhyZWVCbGVuZHMgPSB7CiAgICAgICAgICAgICAgICAgICAgJ05vcm1hbCc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdBZGRpdGl2ZSc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICAnTXVsdGlwbHknOiBUSFJFRS5NdWx0aXBseUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdOb0JsZW5kaW5nJzogVEhSRUUuTm9CbGVuZGluZwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICB3by5tYXRlcmlhbC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgIHdvLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBMaWdodCBTaGFmdHMKICAgICAgICAgICAgY29uc3QgbHMgPSB0aGlzLmdhbWUubGlnaHRTaGFmdHM7CiAgICAgICAgICAgIGlmIChscyAmJiBscy5jb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGxQYXJhbXMgPSB7IHZpc2libGU6IHRydWUgfTsKICAgICAgICAgICAgICAgIGZvbGRlci5hZGQobFBhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdMaWdodCBTaGFmdHMnKS5vbkNoYW5nZSh2ID0+IGxzLmNvbnRhaW5lci52aXNpYmxlID0gdik7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpfc2V0dXBHYW1lU3RhdGUoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignR2FtZSBTdGF0ZScpOwogICAgICAgICAgICBjb25zdCBnbSA9IHRoaXMuZ2FtZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIGZvcmNlSG9tZUdvYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5nb2FsU2NvcmVkKCdob21lJyk7IAogICAgICAgICAgICAgICAgICAgIGVsc2UgY29uc29sZS53YXJuKCJHYW1lIG11c3QgYmUgYWN0aXZlIHRvIHRyaWdnZXIgZ29hbCIpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGZvcmNlQXdheUdvYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5nb2FsU2NvcmVkKCdhd2F5Jyk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb25zb2xlLndhcm4oIkdhbWUgbXVzdCBiZSBhY3RpdmUgdG8gdHJpZ2dlciBnb2FsIik7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZm9yY2VIYWxmdGltZTogKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmKGdtLnN0YXRlID09PSAnYWN0aXZlJykgZ20uZW5kSGFsZigpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHJlc2V0Um91bmQ6ICgpID0+IGdtLnJlc2V0Um91bmQoKSwKICAgICAgICAgICAgICAgIGV4aXRUb01lbnU6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPSAnbWVudSc7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgcHJhY3RpY2UgaWYgcnVubmluZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlSG9tZUdvYWwnKS5uYW1lKCdUcmlnZ2VyIEhvbWUgR29hbCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlQXdheUdvYWwnKS5uYW1lKCdUcmlnZ2VyIEF3YXkgR29hbCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlSGFsZnRpbWUnKS5uYW1lKCdGb3JjZSBIYWxmdGltZScpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3Jlc2V0Um91bmQnKS5uYW1lKCdSZXNldCBSb3VuZCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2V4aXRUb01lbnUnKS5uYW1lKCdFeGl0IHRvIE1lbnUnKTsKICAgICAgICB9CgogICAgICAgIF9zZXR1cFRlYW1zKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1RlYW1zJyk7CiAgICAgICAgICAgIGlmICghdGhpcy5nYW1lLnRlYW1zLmhvbWUgfHwgIXRoaXMuZ2FtZS50ZWFtcy5hd2F5KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBob21lID0gdGhpcy5nYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGNvbnN0IGF3YXkgPSB0aGlzLmdhbWUudGVhbXMuYXdheTsKCiAgICAgICAgICAgIC8vIEhvbWUKICAgICAgICAgICAgY29uc3QgaEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0hvbWUgVGVhbScpOwogICAgICAgICAgICBoRm9sZGVyLmFkZChob21lLCAnaXNIdW1hbicpLm5hbWUoJ0lzIEh1bWFuIENvbnRyb2xsZWQnKS5saXN0ZW4oKTsKICAgICAgICAgICAgaEZvbGRlci5hZGQoaG9tZSwgJ2FpRW5hYmxlZCcpLm5hbWUoJ0FJIExvZ2ljIEVuYWJsZWQnKS5saXN0ZW4oKTsKCiAgICAgICAgICAgIC8vIEF3YXkKICAgICAgICAgICAgY29uc3QgYUZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0F3YXkgVGVhbScpOwogICAgICAgICAgICBhRm9sZGVyLmFkZChhd2F5LCAnaXNIdW1hbicpLm5hbWUoJ0lzIEh1bWFuIENvbnRyb2xsZWQnKS5saXN0ZW4oKTsKICAgICAgICAgICAgYUZvbGRlci5hZGQoYXdheSwgJ2FpRW5hYmxlZCcpLm5hbWUoJ0FJIExvZ2ljIEVuYWJsZWQnKS5saXN0ZW4oKTsKCiAgICAgICAgfQoKX3NldHVwUGxheWVySW5zcGVjdG9yKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1BsYXllciBJbnNwZWN0b3IgKEhvbWUgQWN0aXZlKScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGVscGVyIHRvIGdldCBjdXJyZW50IGFjdGl2ZSBwbGF5ZXIgc2FmZWx5CiAgICAgICAgICAgIGNvbnN0IGdldEFjdGl2ZSA9ICgpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5nYW1lLnRlYW1zLmhvbWUgJiYgdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSAKICAgICAgICAgICAgICAgICAgICA/IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciAKICAgICAgICAgICAgICAgICAgICA6IG51bGw7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBQcm94eSBvYmplY3QgdG8gYmluZCBHVUkgdG8gZHluYW1pYyB0YXJnZXQKICAgICAgICAgICAgY29uc3QgcHJveHkgPSB7CiAgICAgICAgICAgICAgICBnZXQgUm9sZSgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5yb2xlIDogJy0nOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGdldCBHb2RNb2RlKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLmlzR29kTW9kZSA6IGZhbHNlOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgR29kTW9kZSh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmlzR29kTW9kZSA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBSdW50aW1lIFZhbHVlcwogICAgICAgICAgICAgICAgZ2V0IEhQKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkhQIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEhQKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuSFAgPSB2OyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGdldCBDdXJyZW50RU4oKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuY3VycmVudEVOIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEN1cnJlbnRFTih2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmN1cnJlbnRFTiA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBCYXNlIFN0YXRzCiAgICAgICAgICAgICAgICBnZXQgTWF4SFAoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMubWF4SFAgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgTWF4SFAodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5tYXhIUCA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgU1AoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuU1AgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgU1AodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5TUCA9IHY7IAogICAgICAgICAgICAgICAgICAgICAgICBwLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsgCiAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEVOKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkVOIDogMDsgCiAgICAgICAgICAgICAgICB9LCAKICAgICAgICAgICAgICAgIHNldCBFTih2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHMuRU4gPSB2OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEFUKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkFUIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEFUKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQVQgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFBBKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlBBIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFBBKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuUEEgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEJMKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkJMIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEJMKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQkwgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFNIKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlNIIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFNIKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuU0ggPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IENBKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkNBIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IENBKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQ0EgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLy8gQWN0aW9ucwogICAgICAgICAgICAgICAgTGV2ZWxVcDogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5sZXZlbFVwKCk7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEZ1bGxIZWFsOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsgCiAgICAgICAgICAgICAgICAgICAgaWYocCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7IAogICAgICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuZ2V0U3RhdCgnRU4nKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLnZlbm9tID0gMDsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLm5hcCA9IDA7IAogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGsgaW4gcC5zdGF0dXMud2l0aGVyKSBwLnN0YXR1cy53aXRoZXJba10gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZih3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJGVUxMIEhFQUwiLCBwLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIERyYWluRU46ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBwLmZ1bWJsZSgpOyAvLyBUcmlnZ2VyIGZ1bWJsZSBsb2dpYwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocHJveHksICdSb2xlJykubGlzdGVuKCkuZGlzYWJsZSgpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHByb3h5LCAnR29kTW9kZScpLm5hbWUoJ0dvZCBNb2RlIChJbmYgSFAvRU4pJykubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBydEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ1J1bnRpbWUgU3RhdHVzJyk7CiAgICAgICAgICAgIHJ0Rm9sZGVyLmFkZChwcm94eSwgJ0hQJywgMCwgOTk5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHJ0Rm9sZGVyLmFkZChwcm94eSwgJ0N1cnJlbnRFTicsIDAsIDEwMCkubmFtZSgnQ3VycmVudCBFTicpLmxpc3RlbigpOwoKICAgICAgICAgICAgY29uc3Qgc3RhdEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0Jhc2UgU3RhdHMnKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdNYXhIUCcsIDEwMCwgOTk5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnRU4nLCAwLCA5OSkubmFtZSgnTWF4IEVOJykubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnU1AnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQVQnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnUEEnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQkwnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnU0gnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQ0EnLCAwLCA5OSkubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBhY3Rpb25Gb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdBY3Rpb25zJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdMZXZlbFVwJykubmFtZSgnSW5zdGFudCBMZXZlbCBVcCcpOwogICAgICAgICAgICBhY3Rpb25Gb2xkZXIuYWRkKHByb3h5LCAnRnVsbEhlYWwnKS5uYW1lKCdGdWxsIEhlYWwgJiBDdXJlJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdEcmFpbkVOJykubmFtZSgnRHJhaW4gRU4gKEZ1bWJsZSknKTsKICAgICAgICB9Cgpfc2V0dXBCYWxsU2FuZGJveCgpIHsKICAgIGNvbnN0IHJvb3QgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0JhbGwgTGFiIChUaHJvdyAmIFBoeXNpY3MpJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBTaGFyZWQgc3RhdGUgb2JqZWN0IChsaXZlcyBvbiB3aW5kb3cuZmx1eCBzbyBpdCBzdXJ2aXZlcyByZWxvYWRzKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBsYWIgPSB3aW5kb3cuZmx1eC5iYWxsTGFiID0gd2luZG93LmZsdXguYmFsbExhYiB8fCB7fTsKICAgIGxhYi5nYW1lID0gdGhpcy5nYW1lOwoKICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnOwogICAgY29uc3QgVEMgPSB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZzsKCiAgICBpZiAoIUMgfHwgIVRDKSB7CiAgICAgICAgY29uc29sZS53YXJuKCJCYWxsIExhYjogTWlzc2luZyBCYWxsQ29uZmlnIG9yIFRocm93Q29uZmlnLiIpOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEhlbHBlcnMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgZ2V0QmFsbCA9ICgpID0+IHRoaXMuZ2FtZSAmJiB0aGlzLmdhbWUuZW50aXRpZXMgPyB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICBjb25zdCBnZXRBY3RpdmUgPSAoKSA9PiB0aGlzLmdhbWUgJiYgdGhpcy5nYW1lLnRlYW1zICYmIHRoaXMuZ2FtZS50ZWFtcy5ob21lID8gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKCiAgICBjb25zdCBlbnN1cmVQcmV2aWV3TGluZSA9ICgpID0+IHsKICAgICAgICBpZiAobGFiLnByZXZpZXdMaW5lKSByZXR1cm47CiAgICAgICAgaWYgKCF0aGlzLmdhbWUgfHwgIXRoaXMuZ2FtZS5zY2VuZSkgcmV0dXJuOwoKICAgICAgICBjb25zdCBnZW9tID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgdHJhbnNwYXJlbnQ6IHRydWUsIG9wYWNpdHk6IDAuOTUgfSk7CiAgICAgICAgY29uc3QgbGluZSA9IG5ldyBUSFJFRS5MaW5lKGdlb20sIG1hdCk7CiAgICAgICAgbGluZS5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgbGluZS5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKGxpbmUpOwogICAgICAgIGxhYi5wcmV2aWV3TGluZSA9IGxpbmU7CiAgICB9OwoKICAgIGNvbnN0IGNsZWFyUHJldmlld0xpbmUgPSAoKSA9PiB7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3TGluZSAmJiBsYWIucHJldmlld0xpbmUuZ2VvbWV0cnkpIHsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBBIHNhZmUgImdob3N0IGJhbGwiIHRoYXQgY2FuIHVzZSBCYWxsLnVwZGF0ZUZyZWUgd2l0aG91dCBzcGF3bmluZyBGWAogICAgY29uc3QgbWFrZUdob3N0QmFsbCA9IChwb3MsIHZlbCwgc3BpbikgPT4gewogICAgICAgIGNvbnN0IGdiID0gewogICAgICAgICAgICBtZXNoOiB7IHBvc2l0aW9uOiBwb3MuY2xvbmUoKSB9LAogICAgICAgICAgICB2ZWxvY2l0eTogdmVsLmNsb25lKCksCiAgICAgICAgICAgIGFuZ3VsYXJWZWxvY2l0eTogKHNwaW4gPyBzcGluLmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpKSwKICAgICAgICAgICAgYWNjdW11bGF0ZWRSb3RhdGlvbjogbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwKICAgICAgICAgICAgcG93ZXI6IDAsCiAgICAgICAgICAgIGRlY2F5UmF0ZTogMCwKICAgICAgICAgICAgX2J1YmJsZVRpbWVyOiA5OTksCiAgICAgICAgICAgIF9naG9zdDogdHJ1ZSwKICAgICAgICAgICAgZGVmb3JtTm9kZTogbnVsbAogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGdiOwogICAgfTsKCiAgICAvLyBVc2UgQmFsbC51cGRhdGVGcmVlIGZvciBmYWl0aGZ1bCB0cmFqZWN0b3J5IHByZWRpY3Rpb24KICAgIGNvbnN0IHNpbXVsYXRlID0gKGdob3N0QmFsbCwgc3RlcHMsIHN0ZXBEdCkgPT4gewogICAgICAgIGNvbnN0IHB0cyA9IFtdOwogICAgICAgIHB0cy5wdXNoKGdob3N0QmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCkpOwogICAgICAgIGNvbnN0IHByb3RvID0gd2luZG93LmZsdXguQmFsbCAmJiB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZTsKICAgICAgICBpZiAoIXByb3RvIHx8IHR5cGVvZiBwcm90by51cGRhdGVGcmVlICE9PSAnZnVuY3Rpb24nKSByZXR1cm4gcHRzOwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ZXBzOyBpKyspIHsKICAgICAgICAgICAgcHJvdG8udXBkYXRlRnJlZS5jYWxsKGdob3N0QmFsbCwgc3RlcER0KTsKICAgICAgICAgICAgcHRzLnB1c2goZ2hvc3RCYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwdHM7CiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gUHJldmlldyArIHJlY29yZC9yZXBsYXkgcnVudGltZSBsb29wCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KbGFiLnByZXZpZXcgPSBsYWIucHJldmlldyB8fCB7CiAgICAgICAgZW5hYmxlZDogZmFsc2UsCiAgICAgICAgc291cmNlOiAnQ2Fubm9uJywKICAgICAgICBzdGVwczogMTIwLAogICAgICAgIHN0ZXBEdDogMS82MCwKICAgICAgICByZWZyZXNoSHo6IDEwLAogICAgICAgIHNob3dPbkhlbGRPbmx5OiBmYWxzZQogICAgfTsKCiAgICBsYWIuY2Fubm9uID0gbGFiLmNhbm5vbiB8fCB7CiAgICAgICAgeWF3OiAwLAogICAgICAgIHBpdGNoOiAwLAogICAgICAgIHBvd2VyOiAyMCwKICAgICAgICB0eXBlOiAnU0gnLAogICAgICAgIHNwaW5YOiAwLAogICAgICAgIHNwaW5ZOiAwLAogICAgICAgIHNwaW5aOiAwLAogICAgICAgIGZpcmVCdXJzdDogMSwKICAgICAgICBzcHJlYWREZWc6IDAKICAgIH07CgogICAgbGFiLnJlY29yZGluZyA9IGxhYi5yZWNvcmRpbmcgfHwgewogICAgICAgIGlzUmVjb3JkaW5nOiBmYWxzZSwKICAgICAgICBmcmFtZXM6IFtdLAogICAgICAgIG1heFNlY29uZHM6IDEyCiAgICB9OwoKICAgIGxhYi5yZXBsYXkgPSBsYWIucmVwbGF5IHx8IHsKICAgICAgICBpc1JlcGxheWluZzogZmFsc2UsCiAgICAgICAgZnJhbWVzOiBbXSwKICAgICAgICBpZHg6IDAsCiAgICAgICAgbG9vcDogdHJ1ZSwKICAgICAgICBzcGVlZDogMS4wCiAgICB9OwoKICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgbGFiLnRhcmdldEJhbGwgPSBudWxsOwoKICAgIGxhYi5hcHBseVJlcGxheUZyYW1lID0gKGJhbGwsIGR0KSA9PiB7CiAgICAgICAgY29uc3QgcmVwID0gbGFiLnJlcGxheTsKICAgICAgICBpZiAoIXJlcCB8fCAhcmVwLmlzUmVwbGF5aW5nIHx8ICFyZXAuZnJhbWVzIHx8IHJlcC5mcmFtZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBBZHZhbmNlIHRpbWUgYnkgc3RlcHBpbmcgaW5kaWNlcyAoZnJhbWUtYmFzZWQpCiAgICAgICAgY29uc3Qgc3RlcCA9IE1hdGgubWF4KDEsIE1hdGguZmxvb3IocmVwLnNwZWVkKSk7CiAgICAgICAgcmVwLmlkeCArPSBzdGVwOwoKICAgICAgICBpZiAocmVwLmlkeCA+PSByZXAuZnJhbWVzLmxlbmd0aCkgewogICAgICAgICAgICBpZiAocmVwLmxvb3ApIHJlcC5pZHggPSAwOwogICAgICAgICAgICBlbHNlIHsgcmVwLmlzUmVwbGF5aW5nID0gZmFsc2U7IGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOyByZXR1cm47IH0KICAgICAgICB9CgogICAgICAgIGNvbnN0IGYgPSByZXAuZnJhbWVzW3JlcC5pZHhdOwogICAgICAgIGlmICghZikgcmV0dXJuOwoKICAgICAgICBiYWxsLmRyb3AoKTsgLy8gZW5zdXJlIG5vIGhvbGRlciBsb2dpYyBmaWdodHMgdXMKICAgICAgICBiYWxsLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIGJhbGwubWVzaC5wb3NpdGlvbi5zZXQoZi5weCwgZi5weSwgZi5weik7CiAgICAgICAgYmFsbC52ZWxvY2l0eS5zZXQoZi52eCwgZi52eSwgZi52eik7CiAgICAgICAgYmFsbC5hbmd1bGFyVmVsb2NpdHkuc2V0KGYuc3gsIGYuc3ksIGYuc3opOwogICAgfTsKCiAgICBsYWIuX3ByZXZpZXdUaW1lciA9IGxhYi5fcHJldmlld1RpbWVyIHx8IDA7CgogICAgbGFiLnVwZGF0ZSA9IChkdCkgPT4gewogICAgICAgIC8vIC0tLSByZWNvcmRpbmcgLS0tCiAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICBpZiAoYiAmJiBsYWIucmVjb3JkaW5nICYmIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcpIHsKICAgICAgICAgICAgY29uc3QgciA9IGxhYi5yZWNvcmRpbmc7CiAgICAgICAgICAgIGNvbnN0IG1heEZyYW1lcyA9IE1hdGguZmxvb3IoKHIubWF4U2Vjb25kcyB8fCAxMikgLyAoZHQgfHwgKDEvNjApKSk7CiAgICAgICAgICAgIGlmIChyLmZyYW1lcy5sZW5ndGggPiBtYXhGcmFtZXMpIHIuZnJhbWVzLnNoaWZ0KCk7CiAgICAgICAgICAgIHIuZnJhbWVzLnB1c2goewogICAgICAgICAgICAgICAgcHg6IGIubWVzaC5wb3NpdGlvbi54LCBweTogYi5tZXNoLnBvc2l0aW9uLnksIHB6OiBiLm1lc2gucG9zaXRpb24ueiwKICAgICAgICAgICAgICAgIHZ4OiBiLnZlbG9jaXR5LngsIHZ5OiBiLnZlbG9jaXR5LnksIHZ6OiBiLnZlbG9jaXR5LnosCiAgICAgICAgICAgICAgICBzeDogYi5hbmd1bGFyVmVsb2NpdHkueCwgc3k6IGIuYW5ndWxhclZlbG9jaXR5LnksIHN6OiBiLmFuZ3VsYXJWZWxvY2l0eS56CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIHByZXZpZXcgcmVmcmVzaCAtLS0KICAgICAgICBsYWIuX3ByZXZpZXdUaW1lciArPSBkdDsKICAgICAgICBjb25zdCByZWZyZXNoSW50ZXJ2YWwgPSAxLjAgLyBNYXRoLm1heCgxLCAobGFiLnByZXZpZXcucmVmcmVzaEh6IHx8IDEwKSk7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LmVuYWJsZWQgJiYgbGFiLl9wcmV2aWV3VGltZXIgPj0gcmVmcmVzaEludGVydmFsKSB7CiAgICAgICAgICAgIGxhYi5fcHJldmlld1RpbWVyID0gMDsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfQogICAgfTsKCiAgICBsYWIucmVmcmVzaFByZXZpZXcgPSAoKSA9PiB7CiAgICAgICAgaWYgKCFsYWIucHJldmlldy5lbmFibGVkKSB7IGNsZWFyUHJldmlld0xpbmUoKTsgcmV0dXJuOyB9CiAgICAgICAgZW5zdXJlUHJldmlld0xpbmUoKTsKCiAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgaWYgKCFiIHx8ICFiLm1lc2gpIHJldHVybjsKCiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LnNob3dPbkhlbGRPbmx5ICYmIGIuc3RhdGUgIT09ICdoZWxkJykgewogICAgICAgICAgICBjbGVhclByZXZpZXdMaW5lKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIERlY2lkZSBwcmV2aWV3IHNvdXJjZQogICAgICAgIGxldCBzdGFydFBvcyA9IGIubWVzaC5wb3NpdGlvbjsKICAgICAgICBsZXQgc3RhcnRWZWwgPSBiLnZlbG9jaXR5OwogICAgICAgIGxldCBzdGFydFNwaW4gPSBiLmFuZ3VsYXJWZWxvY2l0eTsKCiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LnNvdXJjZSA9PT0gJ0Nhbm5vbicpIHsKICAgICAgICAgICAgLy8gQ2Fubm9uIGFsd2F5cyBsYXVuY2hlcyBmcm9tIGJhbGwgcG9zaXRpb24gKG9yIHBsYXllciBpZiBoZWxkKQogICAgICAgICAgICBjb25zdCB5YXdSYWQgPSAobGFiLmNhbm5vbi55YXcgfHwgMCkgKiBNYXRoLlBJIC8gMTgwOwogICAgICAgICAgICBjb25zdCBwaXRjaFJhZCA9IChsYWIuY2Fubm9uLnBpdGNoIHx8IDApICogTWF0aC5QSSAvIDE4MDsKCiAgICAgICAgICAgIGNvbnN0IGRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgTWF0aC5zaW4oeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIE1hdGguc2luKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIC1NYXRoLmNvcyh5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpCiAgICAgICAgICAgICkubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBjYXAgPSAod2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfQ0FQICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkxBVU5DSF9TUEVFRF9DQVAgOiA4NS4wKTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAod2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfU0NBTEUgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX1NDQUxFIDogMS4wKTsKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSBNYXRoLm1pbigobGFiLmNhbm5vbi5wb3dlciB8fCAyMCkgKiBzY2FsZSwgY2FwKTsKCiAgICAgICAgICAgIHN0YXJ0UG9zID0gKGIuc3RhdGUgPT09ICdoZWxkJyAmJiBwICYmIHAubWVzaCkgPyBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMS4yLCAwKSkgOiBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgc3RhcnRWZWwgPSBkaXIubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICBzdGFydFNwaW4gPSBuZXcgVEhSRUUuVmVjdG9yMyhsYWIuY2Fubm9uLnNwaW5YIHx8IDAsIGxhYi5jYW5ub24uc3BpblkgfHwgMCwgbGFiLmNhbm5vbi5zcGluWiB8fCAwKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGdob3N0ID0gbWFrZUdob3N0QmFsbChzdGFydFBvcy5jbG9uZSgpLCBzdGFydFZlbC5jbG9uZSgpLCBzdGFydFNwaW4pOwogICAgICAgIGNvbnN0IHB0cyA9IHNpbXVsYXRlKGdob3N0LCBNYXRoLmZsb29yKGxhYi5wcmV2aWV3LnN0ZXBzIHx8IDEyMCksIChsYWIucHJldmlldy5zdGVwRHQgfHwgKDEvNjApKSk7CgogICAgICAgIGlmIChsYWIucHJldmlld0xpbmUpIHsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCkuc2V0RnJvbVBvaW50cyhwdHMpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IEJhbGwgUGh5c2ljcyAoQmFsbENvbmZpZykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcGh5cyA9IHJvb3QuYWRkRm9sZGVyKCdCYWxsIFBoeXNpY3MgKEJhbGxDb25maWcpJyk7CgogICAgY29uc3QgaW50ZWcgPSBwaHlzLmFkZEZvbGRlcignSW50ZWdyYXRpb24nKTsKICAgIGludGVnLmFkZChDLCAnU1VCU1RFUFMnLCAxLCAxMiwgMSkubmFtZSgnU3Vic3RlcHMnKTsKICAgIGludGVnLmFkZChDLCAnU1RPUF9TUEVFRCcsIDAuMCwgMC4yKS5uYW1lKCdTdG9wIFNwZWVkJyk7CgogICAgY29uc3QgZHJhZyA9IHBoeXMuYWRkRm9sZGVyKCdXYXRlciBEcmFnJyk7CiAgICBkcmFnLmFkZChDLCAnV0FURVJfRFJBR19MSU5FQVInLCAwLjAsIDIuMCkubmFtZSgnTGluZWFyIERyYWcnKTsKICAgIGRyYWcuYWRkKEMsICdXQVRFUl9EUkFHX1FVQUQnLCAwLjAsIDAuMDUpLm5hbWUoJ1F1YWRyYXRpYyBEcmFnJyk7CgogICAgY29uc3Qgc3BpbiA9IHBoeXMuYWRkRm9sZGVyKCdTcGluJyk7CiAgICBzcGluLmFkZChDLCAnU1BJTl9EUkFHJywgMC4wLCAzLjApLm5hbWUoJ1NwaW4gRGVjYXknKTsKCiAgICBjb25zdCBtYWdudXMgPSBwaHlzLmFkZEZvbGRlcignTWFnbnVzJyk7CiAgICBtYWdudXMuYWRkKEMsICdNQUdOVVNfRU5BQkxFRCcpLm5hbWUoJ0VuYWJsZWQnKTsKICAgIG1hZ251cy5hZGQoQywgJ01BR05VU19DT0VGRicsIDAuMCwgMC41KS5uYW1lKCdDb2VmZicpOwogICAgbWFnbnVzLmFkZChDLCAnTUFHTlVTX0NBUCcsIDAuMCwgMjAwLjApLm5hbWUoJ0NhcCcpOwoKICAgIGNvbnN0IGRlcHRoID0gcGh5cy5hZGRGb2xkZXIoJ0RlcHRoIENvbnN0cmFpbnQnKTsKICAgIGRlcHRoLmFkZChDLCAnREVQVEhfVEFSR0VUX1knLCAtNS4wLCA1LjApLm5hbWUoJ1RhcmdldCBZJyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX1NQUklORycsIDAuMCwgMTAuMCkubmFtZSgnU3ByaW5nJyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX0RBTVAnLCAwLjAsIDYuMCkubmFtZSgnRGFtcCcpOwoKICAgIGNvbnN0IGFyZW5hID0gcGh5cy5hZGRGb2xkZXIoJ0FyZW5hIEJvdW5kYXJ5Jyk7CiAgICBhcmVuYS5hZGQoQywgJ0JPVU5EQVJZX1JBRElVUycsIDEwLjAsIDEyMC4wKS5uYW1lKCdSYWRpdXMnKTsKICAgIGFyZW5hLmFkZChDLCAnQk9VTkRBUllfSEVJR0hUJywgMi4wLCA0MC4wKS5uYW1lKCdIZWlnaHQnKTsKYXJlbmEuYWRkKEMsICdCT1VOREFSWV9IRUlHSFQnLCAyLjAsIDQwLjApLm5hbWUoJ0hlaWdodCcpOwogICAgYXJlbmEuYWRkKEMsICdHT0FMX0RJU1RBTkNFJywgMjAuMCwgNjAuMCkubmFtZSgnR29hbCBEaXN0YW5jZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQSkgd2luZG93LmZsdXguZ29hbEEucG9zaXRpb24ueiA9IC12OwogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQikgd2luZG93LmZsdXguZ29hbEIucG9zaXRpb24ueiA9IHY7CiAgICAgICAgLy8gVXBkYXRlIERlYnVnIFZpc3VhbHMgaWYgYWN0aXZlCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZGVidWdWaXN1YWxpemVyKSB7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5kZWJ1Z1Zpc3VhbGl6ZXIudXBkYXRlR29hbFZvbHVtZXMoKTsKICAgICAgICB9CiAgICB9KTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9TT0ZUX0JVRkZFUicsIDAuMCwgMjAuMCkubmFtZSgnU29mdCBCdWZmZXInKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9TT0ZUX0ZPUkNFJywgMC4wLCAyMDAuMCkubmFtZSgnU29mdCBGb3JjZScpOwogICAgYXJlbmEuYWRkKEMsICdXQUxMX0VMQVNUSUNJVFknLCAwLjAsIDEuMCkubmFtZSgnV2FsbCBCb3VuY2UnKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9GUklDVElPTicsIDAuMCwgMS4wKS5uYW1lKCdXYWxsIEZyaWN0aW9uJyk7CiAgICBhcmVuYS5hZGQoQywgJ0ZMT09SX0VMQVNUSUNJVFknLCAwLjAsIDEuMCkubmFtZSgnQ2VpbC9GbG9vciBCb3VuY2UnKTsKCiAgICBjb25zdCBwb2NrZXQgPSBhcmVuYS5hZGRGb2xkZXIoJ0dvYWwgUG9ja2V0Jyk7CiAgICBwb2NrZXQuYWRkKEMsICdHT0FMX1BPQ0tFVF9FTkFCTEVEJykubmFtZSgnRW5hYmxlZCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfWCcsIDAuMCwgNDAuMCkubmFtZSgnUG9ja2V0IEhhbGYtWCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfWicsIDAuMCwgNTAuMCkubmFtZSgnUG9ja2V0IFN0YXJ0IHxafCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfUkFESVVTJywgMTAuMCwgMTIwLjApLm5hbWUoJ1BvY2tldCBSYWRpdXMnKTsKCiAgICBjb25zdCBsYXVuY2ggPSBwaHlzLmFkZEZvbGRlcignTGF1bmNoIE1hcHBpbmcnKTsKICAgIGxhdW5jaC5hZGQoQywgJ0xBVU5DSF9TUEVFRF9TQ0FMRScsIDAuMSwgNS4wKS5uYW1lKCdTcGVlZCBTY2FsZScpOwogICAgbGF1bmNoLmFkZChDLCAnTEFVTkNIX1NQRUVEX0NBUCcsIDEwLjAsIDIwMC4wKS5uYW1lKCdTcGVlZCBDYXAnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogVGhyb3cgbWFwcGluZyAoUGxheWVyLnJlbGVhc2VDaGFyZ2UgLT4gQmFsbC5zaG9vdCkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgdGhyb3dNYXAgPSByb290LmFkZEZvbGRlcignVGhyb3cgTWFwcGluZyAoVGhyb3dDb25maWcpJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdTV0lQRV9NSU5fUFgnLCAwLCAxMjAsIDEpLm5hbWUoJ1N3aXBlIE1pbiBQWCcpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnQUlNX0RYX1NDQUxFJywgMC4xLCA1LjApLm5hbWUoJ0FpbSBYIFNjYWxlJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdBSU1fRFlfU0NBTEUnLCAwLjEsIDUuMCkubmFtZSgnQWltIFkgU2NhbGUnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX0JBU0UnLCAwLjEsIDMuMCkubmFtZSgnUG93ZXIgQmFzZScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnUE9XRVJfUkFOR0UnLCAwLjAsIDMuMCkubmFtZSgnUG93ZXIgUmFuZ2UnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX01BWF9CT05VU19SQVRJTycsIDAuMCwgMS4wKS5uYW1lKCdNYXggQm9udXMgUmF0aW8nKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX01BWF9NVUxUSVBMSUVSJywgMS4wLCA2LjApLm5hbWUoJ01heCBNdWx0aXBsaWVyJyk7CgogICAgY29uc3QgY3VydmVNYXAgPSB0aHJvd01hcC5hZGRGb2xkZXIoJ0N1cnZlJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9FTkFCTEVEJykubmFtZSgnRW5hYmxlZCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRCcsIDAuMCwgMS4wKS5uYW1lKCdJbnB1dCBUaHJlc2hvbGQnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX1NQSU5fU0NBTEUnLCAwLjAsIDQwMDAuMCkubmFtZSgnU3BpbiBTY2FsZScpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfU1BFRURfTVVMVCcsIDAuMCwgNS4wKS5uYW1lKCdTd2lwZSBTcGVlZCBNdWx0Jyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9TUElOX0NBUCcsIDAuMCwgNjAwMC4wKS5uYW1lKCdTcGluIENhcCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfUEVSRkVDVF9TUElOJywgMC4wLCAyMDAwLjApLm5hbWUoJ1BlcmZlY3QgVGhyZXNob2xkJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFRlbGVwb3J0IC8gU3RhdGUgdG9vbHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgdHAgPSByb290LmFkZEZvbGRlcignVGVsZXBvcnQgLyBSZXNldCcpOwogICAgY29uc3QgdHBQYXJhbXMgPSB7CiAgICAgICAgVG9DZW50ZXI6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgaWYgKGIpIGIucmVzZXQoKTsgfSwKICAgICAgICBUb0FjdGl2ZVBsYXllcjogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBjb25zdCBwID0gZ2V0QWN0aXZlKCk7IGlmIChiICYmIHApIGIuZ3JhYihwKTsgfSwKICAgICAgICBUb0hvbWVHb2FsOiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGlmIChiKSB7IGIuZHJvcCgpOyBiLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDI1KTsgYi52ZWxvY2l0eS5zZXQoMCwwLDApOyBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOyB9IH0sCiAgICAgICAgVG9Bd2F5R29hbDogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMjUpOyBiLnZlbG9jaXR5LnNldCgwLDAsMCk7IGIuYW5ndWxhclZlbG9jaXR5LnNldCgwLDAsMCk7IH0gfSwKICAgICAgICBUb1NreTogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAxMCwgMCk7IGIudmVsb2NpdHkuc2V0KDAsMCwwKTsgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsgfSB9LAogICAgICAgIENsZWFyUHJldmlldzogKCkgPT4gY2xlYXJQcmV2aWV3TGluZSgpCiAgICB9OwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9DZW50ZXInKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvQWN0aXZlUGxheWVyJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0hvbWVHb2FsJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0F3YXlHb2FsJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb1NreScpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnQ2xlYXJQcmV2aWV3Jyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFNob3QgQ2Fubm9uIChmb3JjZSBmaXJlIHdpdGggcGFyYW1zKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBjYW5ub24gPSByb290LmFkZEZvbGRlcignU2hvdCBDYW5ub24nKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3lhdycsIC0xODAsIDE4MCwgMSkubmFtZSgnWWF3IChkZWcpJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdwaXRjaCcsIC04OSwgODksIDEpLm5hbWUoJ1BpdGNoIChkZWcpJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdwb3dlcicsIDAsIDEyMCwgMC4xKS5uYW1lKCdQb3dlcicpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAndHlwZScsIFsnUEEnLCdTSCddKS5uYW1lKCdUeXBlJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcGluWCcsIC0zMDAwLCAzMDAwLCAxKS5uYW1lKCdTcGluIFgnKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwaW5ZJywgLTMwMDAsIDMwMDAsIDEpLm5hbWUoJ1NwaW4gWScpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnc3BpblonLCAtMzAwMCwgMzAwMCwgMSkubmFtZSgnU3BpbiBaJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdmaXJlQnVyc3QnLCAxLCAxMCwgMSkubmFtZSgnQnVyc3QgQ291bnQnKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwcmVhZERlZycsIDAsIDMwLCAwLjUpLm5hbWUoJ1NwcmVhZCAoZGVnKScpOwoKICAgIGNvbnN0IGZpcmVQYXJhbXMgPSB7CiAgICAgICAgRmlyZTogKCkgPT4gewogICAgICAgICAgICBjb25zdCBiID0gZ2V0QmFsbCgpOwogICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgIGlmICghYikgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgeWF3UmFkID0gKGxhYi5jYW5ub24ueWF3IHx8IDApICogTWF0aC5QSSAvIDE4MDsKICAgICAgICAgICAgY29uc3QgcGl0Y2hSYWQgPSAobGFiLmNhbm5vbi5waXRjaCB8fCAwKSAqIE1hdGguUEkgLyAxODA7CgogICAgICAgICAgICBjb25zdCBiYXNlRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICBNYXRoLnNpbih5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpLAogICAgICAgICAgICAgICAgTWF0aC5zaW4ocGl0Y2hSYWQpLAogICAgICAgICAgICAgICAgLU1hdGguY29zKHlhd1JhZCkgKiBNYXRoLmNvcyhwaXRjaFJhZCkKICAgICAgICAgICAgKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gKGIuc3RhdGUgPT09ICdoZWxkJyAmJiBwICYmIHAubWVzaCkgPyBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMS4yLCAwKSkgOiBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKCiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgKGxhYi5jYW5ub24uZmlyZUJ1cnN0IHx8IDEpOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IGJhc2VEaXIuY2xvbmUoKTsKICAgICAgICAgICAgICAgIGlmIChsYWIuY2Fubm9uLnNwcmVhZERlZyA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcHJlYWQgPSAobGFiLmNhbm5vbi5zcHJlYWREZWcgKiBNYXRoLlBJIC8gMTgwKTsKICAgICAgICAgICAgICAgICAgICBkaXIueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogc3ByZWFkOwogICAgICAgICAgICAgICAgICAgIGRpci55ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcHJlYWQ7CiAgICAgICAgICAgICAgICAgICAgZGlyLnogKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIHNwcmVhZDsKICAgICAgICAgICAgICAgICAgICBkaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYi5kcm9wKCk7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24uY29weShzdGFydCk7CiAgICAgICAgICAgICAgICBiLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOwoKICAgICAgICAgICAgICAgIGNvbnN0IHNwaW4gPSBuZXcgVEhSRUUuVmVjdG9yMyhsYWIuY2Fubm9uLnNwaW5YIHx8IDAsIGxhYi5jYW5ub24uc3BpblkgfHwgMCwgbGFiLmNhbm5vbi5zcGluWiB8fCAwKTsKICAgICAgICAgICAgICAgIGIuc2hvb3QoZGlyLCBsYWIuY2Fubm9uLnBvd2VyIHx8IDIwLCBsYWIuY2Fubm9uLnR5cGUgfHwgJ1NIJywgbnVsbCwgc3Bpbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgY2Fubm9uLmFkZChmaXJlUGFyYW1zLCAnRmlyZScpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBUcmFqZWN0b3J5IFByZXZpZXcKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcHJldmlldyA9IHJvb3QuYWRkRm9sZGVyKCdUcmFqZWN0b3J5IFByZXZpZXcnKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnZW5hYmxlZCcpLm5hbWUoJ0VuYWJsZWQnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3NvdXJjZScsIFsnQ2Fubm9uJywgJ0xpdmUgQmFsbCddKS5uYW1lKCdTb3VyY2UnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3N0ZXBzJywgMTAsIDYwMCwgMSkubmFtZSgnU3RlcHMnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3N0ZXBEdCcsIDEvMjQwLCAxLzE1LCAxLzI0MCkubmFtZSgnU3RlcCBkdCcpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAncmVmcmVzaEh6JywgMSwgNjAsIDEpLm5hbWUoJ1JlZnJlc2ggSHonKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc2hvd09uSGVsZE9ubHknKS5uYW1lKCdPbmx5IHdoZW4gSGVsZCcpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKCiAgICBjb25zdCBwcmV2aWV3QnRucyA9IHsKICAgICAgICBSZWZyZXNoOiAoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSwKICAgICAgICBIaWRlOiAoKSA9PiB7IGxhYi5wcmV2aWV3LmVuYWJsZWQgPSBmYWxzZTsgY2xlYXJQcmV2aWV3TGluZSgpOyB9CiAgICB9OwogICAgcHJldmlldy5hZGQocHJldmlld0J0bnMsICdSZWZyZXNoJyk7CiAgICBwcmV2aWV3LmFkZChwcmV2aWV3QnRucywgJ0hpZGUnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogUmVjb3JkIC8gUmVwbGF5CiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHJyID0gcm9vdC5hZGRGb2xkZXIoJ1JlY29yZCAvIFJlcGxheScpOwogICAgY29uc3QgcnJQYXJhbXMgPSB7CiAgICAgICAgUmVjb3JkOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcgPSB0cnVlOwogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmZyYW1lcyA9IFtdOwogICAgICAgIH0sCiAgICAgICAgU3RvcDogKCkgPT4gewogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmlzUmVjb3JkaW5nID0gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICBVc2VSZWNvcmRpbmdGb3JSZXBsYXk6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlcGxheS5mcmFtZXMgPSAobGFiLnJlY29yZGluZy5mcmFtZXMgfHwgW10pLnNsaWNlKCk7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaWR4ID0gMDsKICAgICAgICB9LAogICAgICAgIFBsYXk6ICgpID0+IHsKICAgICAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICAgICAgaWYgKCFiKSByZXR1cm47CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaXNSZXBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICBsYWIudGFyZ2V0QmFsbCA9IGI7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaWR4ID0gMDsKICAgICAgICB9LAogICAgICAgIFBhdXNlOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgbGFiLmlzUmVwbGF5aW5nID0gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICBDbGVhcjogKCkgPT4gewogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmZyYW1lcyA9IFtdOwogICAgICAgICAgICBsYWIucmVwbGF5LmZyYW1lcyA9IFtdOwogICAgICAgICAgICBsYWIucmVwbGF5LmlkeCA9IDA7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgbGFiLmlzUmVwbGF5aW5nID0gZmFsc2U7CiAgICAgICAgfQogICAgfTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1JlY29yZCcpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnU3RvcCcpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnVXNlUmVjb3JkaW5nRm9yUmVwbGF5JykubmFtZSgnQ29weSBSZWMgLT4gUmVwbGF5Jyk7CiAgICByci5hZGQobGFiLnJlcGxheSwgJ2xvb3AnKS5uYW1lKCdMb29wJyk7CiAgICByci5hZGQobGFiLnJlcGxheSwgJ3NwZWVkJywgMC4yNSwgNi4wLCAwLjI1KS5uYW1lKCdSZXBsYXkgU3BlZWQnKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1BsYXknKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1BhdXNlJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdDbGVhcicpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBQcmVzZXRzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHByZXNldHMgPSByb290LmFkZEZvbGRlcignUHJlc2V0cycpOwogICAgY29uc3QgUCA9IHsKICAgICAgICBWYW5pbGxhOiAoKSA9PiB7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oQywgewogICAgICAgICAgICAgICAgU1VCU1RFUFM6IDIsCiAgICAgICAgICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMTUsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX1FVQUQ6IDAuMDAyLAogICAgICAgICAgICAgICAgU1BJTl9EUkFHOiAwLjQwLAogICAgICAgICAgICAgICAgTUFHTlVTX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ09FRkY6IDAuMDgsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ0FQOiA2MC4wLAogICAgICAgICAgICAgICAgREVQVEhfVEFSR0VUX1k6IDAuMCwKICAgICAgICAgICAgICAgIERFUFRIX1NQUklORzogMS4wLAogICAgICAgICAgICAgICAgREVQVEhfREFNUDogMS41LAogICAgICAgICAgICAgICAgQk9VTkRBUllfUkFESVVTOiAzMy4wLAogICAgICAgICAgICAgICAgQk9VTkRBUllfSEVJR0hUOiAxNS4wLAogICAgICAgICAgICAgICAgV0FMTF9TT0ZUX0JVRkZFUjogMy4wLAogICAgICAgICAgICAgICAgV0FMTF9TT0ZUX0ZPUkNFOiAyMC4wLAogICAgICAgICAgICAgICAgV0FMTF9FTEFTVElDSVRZOiAwLjMwLAogICAgICAgICAgICAgICAgV0FMTF9GUklDVElPTjogMC45NSwKICAgICAgICAgICAgICAgIEZMT09SX0VMQVNUSUNJVFk6IDAuNDAsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgR09BTF9QT0NLRVRfWDogMTIuMCwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX1o6IDI1LjAsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9SQURJVVM6IDQ1LjAsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfU0NBTEU6IDEuMCwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDg1LjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0sCiAgICAgICAgQXJjYWRlQ3VydmU6ICgpID0+IHsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihDLCB7CiAgICAgICAgICAgICAgICBNQUdOVVNfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIE1BR05VU19DT0VGRjogMC4xNiwKICAgICAgICAgICAgICAgIE1BR05VU19DQVA6IDkwLjAsCiAgICAgICAgICAgICAgICBTUElOX0RSQUc6IDAuMjUsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX0xJTkVBUjogMC4xMiwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDEsCiAgICAgICAgICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDM1LjAsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfQ0FQOiAxMTAuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihUQywgewogICAgICAgICAgICAgICAgQ1VSVkVfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIENVUlZFX1NQSU5fU0NBTEU6IDE1MDAuMCwKICAgICAgICAgICAgICAgIENVUlZFX1NQSU5fQ0FQOiAzMDAwLjAsCiAgICAgICAgICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDcwMC4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsYWIucmVmcmVzaFByZXZpZXcoKTsKICAgICAgICB9LAogICAgICAgIFNuYXBweVJlYWxpc3RpYzogKCkgPT4gewogICAgICAgICAgICBPYmplY3QuYXNzaWduKEMsIHsKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfTElORUFSOiAwLjI1LAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19RVUFEOiAwLjAwNiwKICAgICAgICAgICAgICAgIE1BR05VU19DT0VGRjogMC4wNSwKICAgICAgICAgICAgICAgIE1BR05VU19DQVA6IDQwLjAsCiAgICAgICAgICAgICAgICBTUElOX0RSQUc6IDAuNzUsCiAgICAgICAgICAgICAgICBTVE9QX1NQRUVEOiAwLjA1LAogICAgICAgICAgICAgICAgTEFVTkNIX1NQRUVEX0NBUDogNzAuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfQogICAgfTsKICAgIHByZXNldHMuYWRkKFAsICdWYW5pbGxhJyk7CiAgICBwcmVzZXRzLmFkZChQLCAnQXJjYWRlQ3VydmUnKTsKICAgIHByZXNldHMuYWRkKFAsICdTbmFwcHlSZWFsaXN0aWMnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogU25hcHNob3QgLyBFeHBvcnQKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3Qgc25hcHNob3QgPSByb290LmFkZEZvbGRlcignU25hcHNob3QgLyBFeHBvcnQnKTsKCiAgICBjb25zdCBfcm91bmQgPSAobiwgcGxhY2VzID0gNCkgPT4gewogICAgICAgIGlmICghTnVtYmVyLmlzRmluaXRlKG4pKSByZXR1cm4gbnVsbDsKICAgICAgICBjb25zdCBwID0gTWF0aC5wb3coMTAsIHBsYWNlcyk7CiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQobiAqIHApIC8gcDsKICAgIH07CgogICAgY29uc3QgX3YzID0gKHYsIHBsYWNlcyA9IDQpID0+IHsKICAgICAgICBpZiAoIXYpIHJldHVybiBudWxsOwogICAgICAgIHJldHVybiBbX3JvdW5kKHYueCwgcGxhY2VzKSwgX3JvdW5kKHYueSwgcGxhY2VzKSwgX3JvdW5kKHYueiwgcGxhY2VzKV07CiAgICB9OwoKICAgIGNvbnN0IF9jbG9uZUpzb24gPSAob2JqKSA9PiB7CiAgICAgICAgaWYgKCFvYmopIHJldHVybiBudWxsOwogICAgICAgIHRyeSB7IHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KG9iaikpOyB9IGNhdGNoIChlKSB7IHJldHVybiBudWxsOyB9CiAgICB9OwoKICAgIGNvbnN0IF9wbGF5ZXJTbmFwID0gKHApID0+IHsKICAgICAgICBpZiAoIXApIHJldHVybiBudWxsOwogICAgICAgIGNvbnN0IGFuaW0gPSAocC5hY3RpdmVBY3Rpb24gJiYgcC5hY3RpdmVBY3Rpb24uX2NsaXApID8gcC5hY3RpdmVBY3Rpb24uX2NsaXAubmFtZSA6IChwLnN0YXRlIHx8IG51bGwpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG5hbWU6IHAuY2hhcmFjdGVyTmFtZSB8fCBwLm5hbWUgfHwgbnVsbCwKICAgICAgICAgICAgcm9sZTogcC5yb2xlIHx8IG51bGwsCiAgICAgICAgICAgIHN0YXRlOiBwLnN0YXRlIHx8IG51bGwsCiAgICAgICAgICAgIGhhc0JhbGw6ICEhcC5oYXNCYWxsLAogICAgICAgICAgICBpc1Rocm93aW5nOiAhIXAuaXNUaHJvd2luZywKICAgICAgICAgICAgaXNDaGFyZ2luZzogISFwLmlzQ2hhcmdpbmcsCiAgICAgICAgICAgIGlzRGFzaGluZzogISFwLmlzRGFzaGluZywKICAgICAgICAgICAgZGFzaENvb2xkb3duOiBfcm91bmQocC5kYXNoQ29vbGRvd24sIDQpLAogICAgICAgICAgICBwb3M6IF92MyhwLm1lc2ggJiYgcC5tZXNoLnBvc2l0aW9uKSwKICAgICAgICAgICAgdmVsOiBfdjMocC52ZWxvY2l0eSksCiAgICAgICAgICAgIGlucHV0OiBfdjMocC5pbnB1dFZlY3RvciksCiAgICAgICAgICAgIHN0YXRzOiBwLnN0YXRzID8gX2Nsb25lSnNvbihwLnN0YXRzKSA6IG51bGwsCiAgICAgICAgICAgIGFuaW0KICAgICAgICB9OwogICAgfTsKCiAgICBjb25zdCBfdGVhbVNuYXAgPSAodCkgPT4gewogICAgICAgIGlmICghdCkgcmV0dXJuIG51bGw7CiAgICAgICAgY29uc3QgYWN0aXZlID0gdC5hY3RpdmVQbGF5ZXIgPyBfcGxheWVyU25hcCh0LmFjdGl2ZVBsYXllcikgOiBudWxsOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGlkOiB0LmlkIHx8IG51bGwsCiAgICAgICAgICAgIHNpZGU6IHQuc2lkZSwKICAgICAgICAgICAgaXNIdW1hbjogISF0LmlzSHVtYW4sCiAgICAgICAgICAgIGFpRW5hYmxlZDogISF0LmFpRW5hYmxlZCwKICAgICAgICAgICAgY3VycmVudEZvcm1hdGlvbjogdC5jdXJyZW50Rm9ybWF0aW9uIHx8IG51bGwsCiAgICAgICAgICAgIGFjdGl2ZVBsYXllcjogYWN0aXZlLAogICAgICAgICAgICBwbGF5ZXJzOiBBcnJheS5pc0FycmF5KHQucGxheWVycykgPyB0LnBsYXllcnMubWFwKF9wbGF5ZXJTbmFwKSA6IFtdCiAgICAgICAgfTsKICAgIH07CgogICAgY29uc3QgYnVpbGRTbmFwc2hvdCA9ICgpID0+IHsKICAgICAgICBjb25zdCBnYW1lID0gdGhpcy5nYW1lIHx8IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSB8fCBudWxsOwogICAgICAgIGNvbnN0IGJhbGwgPSBnYW1lICYmIGdhbWUuZW50aXRpZXMgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgIGNvbnN0IGNhbU1nciA9IGdhbWUgPyBnYW1lLmNhbWVyYU1hbmFnZXIgOiBudWxsOwogICAgICAgIGNvbnN0IGNhbSA9IChjYW1NZ3IgJiYgY2FtTWdyLmNhbWVyYSkgPyBjYW1NZ3IuY2FtZXJhIDogKGdhbWUgPyBnYW1lLmNhbWVyYSA6IG51bGwpOwoKICAgICAgICBjb25zdCBiYWxsU25hcCA9IGJhbGwgPyB7CiAgICAgICAgICAgIHN0YXRlOiBiYWxsLnN0YXRlIHx8IG51bGwsCiAgICAgICAgICAgIGlzSW52aXNpYmxlOiAhIWJhbGwuaXNJbnZpc2libGUsCiAgICAgICAgICAgIGhvbGRlcjogYmFsbC5ob2xkZXIgPyAoYmFsbC5ob2xkZXIuY2hhcmFjdGVyTmFtZSB8fCBiYWxsLmhvbGRlci5uYW1lIHx8IG51bGwpIDogbnVsbCwKICAgICAgICAgICAgbGFzdEhvbGRlcjogYmFsbC5sYXN0SG9sZGVyID8gKGJhbGwubGFzdEhvbGRlci5jaGFyYWN0ZXJOYW1lIHx8IGJhbGwubGFzdEhvbGRlci5uYW1lIHx8IG51bGwpIDogbnVsbCwKICAgICAgICAgICAgcG9zOiBfdjMoYmFsbC5tZXNoICYmIGJhbGwubWVzaC5wb3NpdGlvbiksCiAgICAgICAgICAgIHZlbDogX3YzKGJhbGwudmVsb2NpdHkpLAogICAgICAgICAgICBhbmdWZWw6IF92MyhiYWxsLmFuZ3VsYXJWZWxvY2l0eSksCiAgICAgICAgICAgIHBvd2VyOiBfcm91bmQoYmFsbC5wb3dlciwgNCksCiAgICAgICAgICAgIHNob3RUeXBlOiBiYWxsLnNob3RUeXBlIHx8IG51bGwKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgY29uc3QgY2FtZXJhU25hcCA9IGNhbSA/IHsKICAgICAgICAgICAgcG9zOiBfdjMoY2FtLnBvc2l0aW9uKSwKICAgICAgICAgICAgcm90OiBjYW0ucm90YXRpb24gPyBbX3JvdW5kKGNhbS5yb3RhdGlvbi54LCA0KSwgX3JvdW5kKGNhbS5yb3RhdGlvbi55LCA0KSwgX3JvdW5kKGNhbS5yb3RhdGlvbi56LCA0KV0gOiBudWxsLAogICAgICAgICAgICBmb3Y6IF9yb3VuZChjYW0uZm92LCA0KSwKICAgICAgICAgICAgbmVhcjogX3JvdW5kKGNhbS5uZWFyLCA2KSwKICAgICAgICAgICAgZmFyOiBfcm91bmQoY2FtLmZhciwgNCkKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgY29uc3QgY2FtTWdyU25hcCA9IGNhbU1nciA/IHsKICAgICAgICAgICAgbW9kZTogY2FtTWdyLm1vZGUgfHwgbnVsbCwKICAgICAgICAgICAgdGFyZ2V0TmFtZTogKGNhbU1nci50YXJnZXQgJiYgKGNhbU1nci50YXJnZXQuY2hhcmFjdGVyTmFtZSB8fCBjYW1NZ3IudGFyZ2V0Lm5hbWUpKSB8fCBudWxsLAogICAgICAgICAgICBzZXR0aW5nczogY2FtTWdyLnNldHRpbmdzID8gX2Nsb25lSnNvbihjYW1NZ3Iuc2V0dGluZ3MpIDogbnVsbAogICAgICAgIH0gOiBudWxsOwoKICAgICAgICBjb25zdCBkZWJ1Z0lPID0gd2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX2RlYnVnSU8gPyB3aW5kb3cuZmx1eC5fZGVidWdJTyA6IG51bGw7CiAgICAgICAgY29uc3QgaW5wdXRTbmFwID0gZGVidWdJTyA/IHsKICAgICAgICAgICAgc2V0dGluZ3M6IGRlYnVnSU8uc2V0dGluZ3MgPyBfY2xvbmVKc29uKGRlYnVnSU8uc2V0dGluZ3MpIDogbnVsbCwKICAgICAgICAgICAgcGVyZjogZGVidWdJTy5wZXJmID8gX2Nsb25lSnNvbihkZWJ1Z0lPLnBlcmYpIDogbnVsbCwKICAgICAgICAgICAgbW92ZTogKGRlYnVnSU8uaW5wdXQgJiYgZGVidWdJTy5pbnB1dC5tb3ZlKSA/IHsKICAgICAgICAgICAgICAgIHRvdWNoSWQ6IGRlYnVnSU8uaW5wdXQubW92ZS50b3VjaElkID8/IG51bGwsCiAgICAgICAgICAgICAgICBkcmFnZ2luZzogISFkZWJ1Z0lPLmlucHV0Lm1vdmUuZHJhZ2dpbmcsCiAgICAgICAgICAgICAgICB2ZWN0b3I6IGRlYnVnSU8uaW5wdXQubW92ZS52ZWN0b3IgPyBfY2xvbmVKc29uKGRlYnVnSU8uaW5wdXQubW92ZS52ZWN0b3IpIDogbnVsbAogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgYWltOiAoZGVidWdJTy5pbnB1dCAmJiBkZWJ1Z0lPLmlucHV0LmFpbSkgPyB7CiAgICAgICAgICAgICAgICB0b3VjaElkOiBkZWJ1Z0lPLmlucHV0LmFpbS50b3VjaElkID8/IG51bGwsCiAgICAgICAgICAgICAgICBkcmFnZ2luZzogISFkZWJ1Z0lPLmlucHV0LmFpbS5kcmFnZ2luZywKICAgICAgICAgICAgICAgIHZlY3RvcjogZGVidWdJTy5pbnB1dC5haW0udmVjdG9yID8gX2Nsb25lSnNvbihkZWJ1Z0lPLmlucHV0LmFpbS52ZWN0b3IpIDogbnVsbAogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgc3dpcGU6IChkZWJ1Z0lPLmlucHV0ICYmIGRlYnVnSU8uaW5wdXQuc3dpcGUpID8gewogICAgICAgICAgICAgICAgdG91Y2hJZDogZGVidWdJTy5pbnB1dC5zd2lwZS50b3VjaElkID8/IG51bGwsCiAgICAgICAgICAgICAgICBzdGFydDogZGVidWdJTy5pbnB1dC5zd2lwZS5zdGFydCA/IF9jbG9uZUpzb24oZGVidWdJTy5pbnB1dC5zd2lwZS5zdGFydCkgOiBudWxsLAogICAgICAgICAgICAgICAgcG9pbnRzOiBBcnJheS5pc0FycmF5KGRlYnVnSU8uaW5wdXQuc3dpcGUucG9pbnRzKSA/IGRlYnVnSU8uaW5wdXQuc3dpcGUucG9pbnRzLnNsaWNlKC0zMikubWFwKF9jbG9uZUpzb24pIDogW10KICAgICAgICAgICAgfSA6IG51bGwKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbWV0YTogewogICAgICAgICAgICAgICAgdGltZXN0YW1wSVNPOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksCiAgICAgICAgICAgICAgICBocmVmOiAodHlwZW9mIGxvY2F0aW9uICE9PSAndW5kZWZpbmVkJyAmJiBsb2NhdGlvbi5ocmVmKSA/IGxvY2F0aW9uLmhyZWYgOiBudWxsLAogICAgICAgICAgICAgICAgdXNlckFnZW50OiAodHlwZW9mIG5hdmlnYXRvciAhPT0gJ3VuZGVmaW5lZCcgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudCkgPyBuYXZpZ2F0b3IudXNlckFnZW50IDogbnVsbAogICAgICAgICAgICB9LAogICAgICAgICAgICBnYW1lOiBnYW1lID8gewogICAgICAgICAgICAgICAgc2NvcmU6IGdhbWUuc2NvcmUgPyBfY2xvbmVKc29uKGdhbWUuc2NvcmUpIDogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWU6IF9yb3VuZChnYW1lLnRpbWUsIDQpLAogICAgICAgICAgICAgICAgaGFsZjogZ2FtZS5oYWxmID8/IG51bGwsCiAgICAgICAgICAgICAgICBoYWxmRHVyYXRpb246IF9yb3VuZChnYW1lLmhhbGZEdXJhdGlvbiwgNCksCiAgICAgICAgICAgICAgICBpc092ZXJ0aW1lOiAhIWdhbWUuaXNPdmVydGltZSwKICAgICAgICAgICAgICAgIGlzRGVtb01vZGU6ICEhZ2FtZS5pc0RlbW9Nb2RlCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBjb25maWc6IHsKICAgICAgICAgICAgICAgIEJhbGxDb25maWc6ICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnKSA/IF9jbG9uZUpzb24od2luZG93LmZsdXguQmFsbENvbmZpZykgOiBudWxsLAogICAgICAgICAgICAgICAgVGhyb3dDb25maWc6ICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZykgPyBfY2xvbmVKc29uKHdpbmRvdy5mbHV4LlRocm93Q29uZmlnKSA6IG51bGwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2FtZXJhOiBjYW1lcmFTbmFwLAogICAgICAgICAgICBjYW1lcmFNYW5hZ2VyOiBjYW1NZ3JTbmFwLAogICAgICAgICAgICBiYWxsOiBiYWxsU25hcCwKICAgICAgICAgICAgdGVhbXM6IGdhbWUgPyB7CiAgICAgICAgICAgICAgICBob21lOiBfdGVhbVNuYXAoZ2FtZS50ZWFtcyAmJiBnYW1lLnRlYW1zLmhvbWUpLAogICAgICAgICAgICAgICAgYXdheTogX3RlYW1TbmFwKGdhbWUudGVhbXMgJiYgZ2FtZS50ZWFtcy5hd2F5KQogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgaW5wdXQ6IGlucHV0U25hcAogICAgICAgIH07CiAgICB9OwoKICAgIGNvbnN0IF9jb3B5VGV4dCA9IGFzeW5jICh0ZXh0KSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKG5hdmlnYXRvci5jbGlwYm9hcmQgJiYgbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQpIHsKICAgICAgICAgICAgICAgIGF3YWl0IG5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KHRleHQpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIC8vIEZhbGxiYWNrCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgdGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZXh0YXJlYScpOwogICAgICAgICAgICB0YS52YWx1ZSA9IHRleHQ7CiAgICAgICAgICAgIHRhLnN0eWxlLnBvc2l0aW9uID0gJ2ZpeGVkJzsKICAgICAgICAgICAgdGEuc3R5bGUubGVmdCA9ICctOTk5OXB4JzsKICAgICAgICAgICAgdGEuc3R5bGUudG9wID0gJy05OTk5cHgnOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRhKTsKICAgICAgICAgICAgdGEuZm9jdXMoKTsKICAgICAgICAgICAgdGEuc2VsZWN0KCk7CiAgICAgICAgICAgIGNvbnN0IG9rID0gZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0YSk7CiAgICAgICAgICAgIHJldHVybiBvazsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CgogICAgY29uc3QgX2Rvd25sb2FkVGV4dCA9IChmaWxlbmFtZSwgdGV4dCkgPT4gewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbdGV4dF0sIHsgdHlwZTogJ2FwcGxpY2F0aW9uL2pzb24nIH0pOwogICAgICAgICAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOwogICAgICAgICAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgICAgICBhLmhyZWYgPSB1cmw7CiAgICAgICAgICAgIGEuZG93bmxvYWQgPSBmaWxlbmFtZTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhKTsKICAgICAgICAgICAgYS5jbGljaygpOwogICAgICAgICAgICBhLnJlbW92ZSgpOwogICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKHVybCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1NuYXBzaG90IGRvd25sb2FkIGZhaWxlZDonLCBlKTsKICAgICAgICB9CiAgICB9OwoKICAgIGNvbnN0IHNuYXBzaG90QWN0aW9ucyA9IHsKICAgICAgICBDb3B5U25hcHNob3Q6IGFzeW5jICgpID0+IHsKICAgICAgICAgICAgY29uc3Qgc25hcCA9IGJ1aWxkU25hcHNob3QoKTsKICAgICAgICAgICAgY29uc3QgdGV4dCA9IEpTT04uc3RyaW5naWZ5KHNuYXAsIG51bGwsIDIpOwogICAgICAgICAgICBjb25zdCBvayA9IGF3YWl0IF9jb3B5VGV4dCh0ZXh0KTsKICAgICAgICAgICAgY29uc29sZS5sb2coJ1tTbmFwc2hvdF0nLCBzbmFwKTsKICAgICAgICAgICAgaWYgKCFvaykgY29uc29sZS53YXJuKCdTbmFwc2hvdDogY29weSBmYWlsZWQgKHNlZSBjb25zb2xlKS4nKTsKICAgICAgICB9LAogICAgICAgIERvd25sb2FkU25hcHNob3Q6ICgpID0+IHsKICAgICAgICAgICAgY29uc3Qgc25hcCA9IGJ1aWxkU25hcHNob3QoKTsKICAgICAgICAgICAgY29uc3QgdGV4dCA9IEpTT04uc3RyaW5naWZ5KHNuYXAsIG51bGwsIDIpOwogICAgICAgICAgICBfZG93bmxvYWRUZXh0KCdzbmFwc2hvdC5qc29uJywgdGV4dCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbU25hcHNob3RdJywgc25hcCk7CiAgICAgICAgfQogICAgfTsKCiAgICBzbmFwc2hvdC5hZGQoc25hcHNob3RBY3Rpb25zLCAnQ29weVNuYXBzaG90JykubmFtZSgnQ29weSBKU09OIFNuYXBzaG90Jyk7CiAgICBzbmFwc2hvdC5hZGQoc25hcHNob3RBY3Rpb25zLCAnRG93bmxvYWRTbmFwc2hvdCcpLm5hbWUoJ0Rvd25sb2FkIHNuYXBzaG90Lmpzb24nKTsKCn0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5EZXZUb29scyA9IERldlRvb2xzOwoKICAgIERldlRvb2xzLnByb3RvdHlwZS5fc2V0dXBWaXN1YWxEZWJ1ZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignVmlzdWFsIERlYnVnZ2luZycpOwogICAgICAgIGNvbnN0IGR2ID0gdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcjsKICAgICAgICBpZiAoIWR2KSByZXR1cm47Cgpjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIGVuYWJsZWQ6IGR2LmVuYWJsZWQsCiAgICAgICAgICAgIGhpdGJveGVzOiBkdi5zaG93SGl0Ym94ZXMsCiAgICAgICAgICAgIHZlY3RvcnM6IGR2LnNob3dWZWN0b3JzLAogICAgICAgICAgICBhaTogZHYuc2hvd0FJLAogICAgICAgICAgICBnb2FsVm9sdW1lOiBkdi5zaG93R29hbFZvbHVtZQogICAgICAgIH07CgogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZW5hYmxlZCcpLm5hbWUoJ0VuYWJsZSBWaXN1YWxpemVyJykub25DaGFuZ2UodiA9PiBkdi5lbmFibGVkID0gdik7CiAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdoaXRib3hlcycpLm5hbWUoJ1Nob3cgSGl0Ym94ZXMnKS5vbkNoYW5nZSh2ID0+IGR2LnNob3dIaXRib3hlcyA9IHYpOwogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndmVjdG9ycycpLm5hbWUoJ1Nob3cgVmVjdG9ycycpLm9uQ2hhbmdlKHYgPT4gZHYuc2hvd1ZlY3RvcnMgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2FpJykubmFtZSgnU2hvdyBBSSBQZXJjZXB0aW9uJykub25DaGFuZ2UodiA9PiBkdi5zaG93QUkgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2dvYWxWb2x1bWUnKS5uYW1lKCdTaG93IEdvYWwgVm9sdW1lJykub25DaGFuZ2UodiA9PiBkdi5zaG93R29hbFZvbHVtZSA9IHYpOwogICAgfTsKCiAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwRlhMYWIgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0ZYIExhYiAmIFVJIFRlc3QnKTsKICAgICAgICAKICAgICAgICBjb25zdCBnZXRUYXJnZXRQb3MgPSAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIHJldHVybiBwICYmIHAubWVzaCA/IHAubWVzaC5wb3NpdGlvbiA6IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDIsIDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGZ4UGFyYW1zID0gewogICAgICAgICAgICBTcGF3blZlbm9tOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCd2ZW5vbScsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25OYXA6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ25hcCcsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25XaXRoZXI6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3dpdGhlcicsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25MZWFybmVkOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bkNsYXNoOiAoKSA9PiB0aGlzLmdhbWUuc3Bhd25DbGFzaChnZXRUYXJnZXRQb3MoKSksCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgZnhTdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdQYXJ0aWNsZXMnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3blZlbm9tJyk7CiAgICAgICAgZnhTdWIuYWRkKGZ4UGFyYW1zLCAnU3Bhd25OYXAnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3bldpdGhlcicpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduTGVhcm5lZCcpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduQ2xhc2gnKTsKCiAgICAgICAgY29uc3QgdHh0UGFyYW1zID0gewogICAgICAgICAgICBUZXh0OiAiVEVTVCIsCiAgICAgICAgICAgIFR5cGU6ICJkYW1hZ2UiLAogICAgICAgICAgICBTcGF3bjogKCkgPT4gewogICAgICAgICAgICAgICAgaWYodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bih0eHRQYXJhbXMuVGV4dCwgZ2V0VGFyZ2V0UG9zKCksIHR4dFBhcmFtcy5UeXBlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgY29uc3QgdHh0U3ViID0gZm9sZGVyLmFkZEZvbGRlcignRmxvYXRpbmcgVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVHlwZScsIFsnZGFtYWdlJywgJ2hlYWwnLCAnc3RhdHVzJywgJ3RlY2gnLCAnY29taWMtaW1wYWN0JywgJ2NvbWljLWFjdGlvbicsICdzYXZlJywgJ2Jsb2NrJywgJ2RlZmF1bHQnXSk7CiAgICAgICAgdHh0U3ViLmFkZCh0eHRQYXJhbXMsICdTcGF3bicpLm5hbWUoJ1NwYXduIFRleHQnKTsKCiAgICAgICAgY29uc3QgY2FtUGFyYW1zID0gewogICAgICAgICAgICBTaGFrZVNtYWxsOiAoKSA9PiB0aGlzLmdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpLAogICAgICAgICAgICBTaGFrZUJpZzogKCkgPT4gdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMi4wKSwKICAgICAgICAgICAgSW1wYWN0TGlnaHQ6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMSwgJ2RlZmF1bHQnKSwKICAgICAgICAgICAgSW1wYWN0SGVhdnk6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMiwgJ2hlYXZ5JyksCiAgICAgICAgICAgIEltcGFjdFNoYXR0ZXI6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuNCwgJ3NoYXR0ZXInKSwKICAgICAgICB9OwoKICAgICAgICBjb25zdCBjYW1TdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdDYW1lcmEgJiBJbXBhY3QnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlU21hbGwnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlQmlnJyk7CiAgICAgICAgY2FtU3ViLmFkZChjYW1QYXJhbXMsICdJbXBhY3RMaWdodCcpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnSW1wYWN0SGVhdnknKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ0ltcGFjdFNoYXR0ZXInKTsKICAgIH07CgoKRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFZpc3VhbHMgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0Fzc2V0IEZvcmdlJyk7CiAgICAgICAgCiAgICAgICAgY29uc3QgZm9yZ2VTdGF0ZSA9IHsKICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgYXNzZXROYW1lOiAnVGlkdXMnLAogICAgICAgICAgICBhbmltTmFtZTogJ2lkbGUnLAogICAgICAgICAgICBwb3NYOiAwLCBwb3NZOiAwLCBwb3NaOiAwLAogICAgICAgICAgICByb3RYOiAwLCByb3RZOiAwLCByb3RaOiAwLAogICAgICAgICAgICBzY2FsZTogMS4wLAogICAgICAgICAgICBjYW1EaXN0OiA1LCBjYW1IZWlnaHQ6IDEuNSwgY2FtUm90OiAwCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgYXNzZXRzID0gewogICAgICAgICAgICAnVGlkdXMnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2RhNzg4YmVmMjU4YzRmMGI4ZDllZjFhY2MxOWM1NTY3LmdsYicsCiAgICAgICAgICAgICdXYWtrYSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJywKICAgICAgICAgICAgJ0xldHR5JzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy80M2FjZTM0YzZmZDk0MjE1OTY3ZTg0MmJmOTA5ZGE1ZS5nbGInLAogICAgICAgICAgICAnRGF0dG8nOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2U2ZDY3ZWNiMmU0YzQ3MTViZDczYTQwNzk1ZTFkM2Q1LmdsYicsCiAgICAgICAgICAgICdKYXNzdSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJywKICAgICAgICAgICAgJ0JvdHRhJzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hZDE1NWVmZWRjMGQ0OGZkYWQwOWRhM2UxY2FlOWM5Ny5nbGInLAogICAgICAgICAgICAnQmFsbCc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTIxYWU4Nzg4ZTU4NGUzNzhhNzlkOTczMmEwNzUzNTYuZ2xiJywKICAgICAgICAgICAgJ0dvYWwnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2E1MTZiZDkwZmE3YzRkZWRiNWRjYmZkZjgwM2YxM2Q1LmdsYicKICAgICAgICB9OwoKICAgICAgICBsZXQgY3VycmVudEFzc2V0ID0gbnVsbDsKCiAgICAgICAgY29uc3QgdXBkYXRlVHJhbnNmb3JtID0gKCkgPT4gewogICAgICAgICAgICBpZiAoY3VycmVudEFzc2V0KSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQucG9zaXRpb24uc2V0KGZvcmdlU3RhdGUucG9zWCwgZm9yZ2VTdGF0ZS5wb3NZLCBmb3JnZVN0YXRlLnBvc1opOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0LnJvdGF0aW9uLnNldChmb3JnZVN0YXRlLnJvdFgsIGZvcmdlU3RhdGUucm90WSwgZm9yZ2VTdGF0ZS5yb3RaKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRBc3NldC5zY2FsZS5zZXRTY2FsYXIoZm9yZ2VTdGF0ZS5zY2FsZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjb25zdCB1cGRhdGVDYW1lcmEgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghZm9yZ2VTdGF0ZS5hY3RpdmUpIHJldHVybjsKICAgICAgICAgICAgLy8gT3JiaXQgYXJvdW5kICgxMDAwLCBZLCAxMDAwKQogICAgICAgICAgICBjb25zdCBjeCA9IDEwMDAgKyBNYXRoLnNpbihmb3JnZVN0YXRlLmNhbVJvdCkgKiBmb3JnZVN0YXRlLmNhbURpc3Q7CiAgICAgICAgICAgIGNvbnN0IGN6ID0gMTAwMCArIE1hdGguY29zKGZvcmdlU3RhdGUuY2FtUm90KSAqIGZvcmdlU3RhdGUuY2FtRGlzdDsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhbWVyYS5wb3NpdGlvbi5zZXQoY3gsIGZvcmdlU3RhdGUuY2FtSGVpZ2h0LCBjeik7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW1lcmEubG9va0F0KDEwMDAsIGZvcmdlU3RhdGUucG9zWSArIDEsIDEwMDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IHBsYXlBbmltYXRpb24gPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghdGhpcy52aXpNaXhlciB8fCAhdGhpcy52aXpDbGlwcykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnZpek1peGVyLnN0b3BBbGxBY3Rpb24oKTsKICAgICAgICAgICAgaWYgKGZvcmdlU3RhdGUuYW5pbU5hbWUgPT09ICdub25lJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUgPT09IGZvcmdlU3RhdGUuYW5pbU5hbWUpOwogICAgICAgICAgICBpZiAoIWNsaXApIGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhmb3JnZVN0YXRlLmFuaW1OYW1lLnRvTG93ZXJDYXNlKCkpKTsKICAgICAgICAgICAgaWYgKGNsaXApIHRoaXMudml6TWl4ZXIuY2xpcEFjdGlvbihjbGlwKS5wbGF5KCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3Qgc3Bhd25Bc3NldCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBwcmV2aW91cwogICAgICAgICAgICB3aGlsZSh0aGlzLnZpekdyb3VwLmNoaWxkcmVuLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy52aXpHcm91cC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucmVtb3ZlKGNoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52aXpNaXhlciA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnRBc3NldCA9IG51bGw7CgogICAgICAgICAgICBjb25zdCB1cmwgPSBhc3NldHNbZm9yZ2VTdGF0ZS5hc3NldE5hbWVdOwogICAgICAgICAgICBpZiAoIXVybCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc29sZS5sb2coIkZvcmdlOiBTcGF3bmluZyIsIGZvcmdlU3RhdGUuYXNzZXROYW1lKTsKCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbCh1cmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSBhcmUgc3RpbGwgaW4gZm9yZ2UgbW9kZSBiZWZvcmUgYWRkaW5nCiAgICAgICAgICAgICAgICBpZiAoIWZvcmdlU3RhdGUuYWN0aXZlKSByZXR1cm47CgogICAgICAgICAgICAgICAgY29uc3QgbW9kZWwgPSBnbHRmLnNjZW5lOwogICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cC5hZGQobW9kZWwpOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0ID0gbW9kZWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IG1vZGVsIHRyYW5zZm9ybSByZWxhdGl2ZSB0byBncm91cAogICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIG1vZGVsLnJvdGF0aW9uLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZVRyYW5zZm9ybSgpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmLmFuaW1hdGlvbnMgJiYgZ2x0Zi5hbmltYXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpek1peGVyID0gbmV3IFRIUkVFLkFuaW1hdGlvbk1peGVyKG1vZGVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekNsaXBzID0gZ2x0Zi5hbmltYXRpb25zOwogICAgICAgICAgICAgICAgICAgIHBsYXlBbmltYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgdG9nZ2xlRm9yZ2UgPSAoaXNBY3RpdmUpID0+IHsKICAgICAgICAgICAgZm9yZ2VTdGF0ZS5hY3RpdmUgPSBpc0FjdGl2ZTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlzRm9yZ2VNb2RlID0gaXNBY3RpdmU7IC8vIENyaXRpY2FsOiBUZWxsIG1haW4uanMgdG8gc3RvcCBnYW1lIGxvb3AKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBHYW1lIFZpc2liaWxpdHkgKEhpZGUgZXZlcnl0aGluZyBpbiB0aGUgbWFpbiBhcmVuYSkKICAgICAgICAgICAgY29uc3QgZ2FtZUxheWVyID0gW3RoaXMuZ2FtZS50ZWFtcy5ob21lLCB0aGlzLmdhbWUudGVhbXMuYXdheSwgdGhpcy5nYW1lLmVudGl0aWVzLmJhbGxdOwogICAgICAgICAgICBnYW1lTGF5ZXIuZm9yRWFjaCh0ID0+IHsKICAgICAgICAgICAgICAgIGlmKHQgJiYgdC5wbGF5ZXJzKSB0LnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsgfSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmKHQgJiYgdC5tZXNoKSB0Lm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCkgd2luZG93LmZsdXguYXJlbmFNZXNoLnZpc2libGUgPSAhaXNBY3RpdmU7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIpIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLnN0YWRpdW0gJiYgdGhpcy5nYW1lLnN0YWRpdW0uY29udGFpbmVyKSB0aGlzLmdhbWUuc3RhZGl1bS5jb250YWluZXIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLndhdGVyT3ZlcmxheSAmJiB0aGlzLmdhbWUud2F0ZXJPdmVybGF5Lm1lc2gpIHRoaXMuZ2FtZS53YXRlck92ZXJsYXkubWVzaC52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBVSQogICAgICAgICAgICBjb25zdCB1aSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpOwogICAgICAgICAgICBpZih1aSkgdWkuc3R5bGUuZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2ZsZXgnOwoKICAgICAgICAgICAgaWYgKGlzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIEZvcmdlIFNjZW5lIGlmIG5lZWRlZAogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwUGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy52aXpHcm91cFBhcmVudCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucG9zaXRpb24uc2V0KDEwMDAsIDAsIDEwMDApOyAvLyBGYXIgYXdheSBmcm9tIGFyZW5hCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQodGhpcy52aXpHcm91cCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdyaWQgPSBuZXcgVEhSRUUuR3JpZEhlbHBlcigyMCwgMjAsIDB4MDBmZmZmLCAweDQ0NDQ0NCk7CiAgICAgICAgICAgICAgICAgICAgZ3JpZC5wb3NpdGlvbi5zZXQoMTAwMCwgMCwgMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQoZ3JpZCk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMudml6TGlnaHQgPSBuZXcgVEhSRUUuRGlyZWN0aW9uYWxMaWdodCgweGZmZmZmZiwgMS4wKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnBvc2l0aW9uLnNldCgxMDA1LCAxMCwgMTAwNSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZCh0aGlzLnZpekxpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekFtYmllbnQgPSBuZXcgVEhSRUUuQW1iaWVudExpZ2h0KDB4NDA0MDQwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKHRoaXMudml6QW1iaWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXBQYXJlbnQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy52aXpBbWJpZW50LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzcGF3bkFzc2V0KCk7CiAgICAgICAgICAgICAgICB1cGRhdGVDYW1lcmEoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBHYW1lCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpHcm91cFBhcmVudCkgdGhpcy52aXpHcm91cFBhcmVudC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpMaWdodCkgdGhpcy52aXpMaWdodC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpBbWJpZW50KSB0aGlzLnZpekFtYmllbnQudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYSBiYWNrIHRvIGdhbWUgdGFyZ2V0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIpIHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZm9sZGVyLmFkZChmb3JnZVN0YXRlLCAnYWN0aXZlJykubmFtZSgnRW5hYmxlIEZvcmdlJykub25DaGFuZ2UodG9nZ2xlRm9yZ2UpOwogICAgICAgIGZvbGRlci5hZGQoZm9yZ2VTdGF0ZSwgJ2Fzc2V0TmFtZScsIE9iamVjdC5rZXlzKGFzc2V0cykpLm5hbWUoJ1NlbGVjdCBBc3NldCcpLm9uQ2hhbmdlKHNwYXduQXNzZXQpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRmID0gZm9sZGVyLmFkZEZvbGRlcignVHJhbnNmb3JtJyk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NYJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NZJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NaJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdyb3RYJywgMCwgNi4yOCkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3JvdFknLCAwLCA2LjI4KS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwogICAgICAgIHRmLmFkZChmb3JnZVN0YXRlLCAncm90WicsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdzY2FsZScsIDAuMSwgMy4wKS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwoKICAgICAgICBmb2xkZXIuYWRkKGZvcmdlU3RhdGUsICdhbmltTmFtZScsIFsnbm9uZScsICdpZGxlJywgJ3N3aW0nLCAndGhyb3cnLCAnY2F0Y2gnLCAncmVhY3QnXSkubmFtZSgnQW5pbWF0aW9uJykub25DaGFuZ2UocGxheUFuaW1hdGlvbik7CgogICAgICAgIGNvbnN0IGNmID0gZm9sZGVyLmFkZEZvbGRlcignQ2FtZXJhJyk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1EaXN0JywgMiwgMTUpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1IZWlnaHQnLCAwLCAxMCkub25DaGFuZ2UodXBkYXRlQ2FtZXJhKTsKICAgICAgICBjZi5hZGQoZm9yZ2VTdGF0ZSwgJ2NhbVJvdCcsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CgogICAgICAgIC8vIEhvb2sgR2FtZSBMb29wCiAgICAgICAgY29uc3Qgb3JpZ2luYWxVcGRhdGUgPSB0aGlzLmdhbWUudXBkYXRlLmJpbmQodGhpcy5nYW1lKTsKICAgICAgICB0aGlzLmdhbWUudXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIGlmIChmb3JnZVN0YXRlLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgLy8gRm9yZ2UgTW9kZTogT25seSB1cGRhdGUgZm9yZ2UgY29tcG9uZW50cyBhbmQgcmVuZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpNaXhlcikgdGhpcy52aXpNaXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGb3JjZSBDYW1lcmEgVXBkYXRlIGhlcmUgc2luY2UgbWFpbi5qcyBsb29wIGlzIHNraXBwZWQKICAgICAgICAgICAgICAgIHVwZGF0ZUNhbWVyYSgpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucmVuZGVyZXIgJiYgdGhpcy5nYW1lLnNjZW5lICYmIHRoaXMuZ2FtZS5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIucmVuZGVyKHRoaXMuZ2FtZS5zY2VuZSwgdGhpcy5nYW1lLmNhbWVyYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOb3JtYWwgTW9kZTogUnVuIHN0YW5kYXJkIGdhbWUgdXBkYXRlCiAgICAgICAgICAgICAgICBvcmlnaW5hbFVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KfTsKICAgICAgICB9OwoKICAgICAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwQXVkaW8gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdBdWRpbyBTZXR0aW5ncycpOwogICAgICAgICAgICBjb25zdCBhbSA9IHRoaXMuZ2FtZS5hdWRpb01hbmFnZXI7CiAgICAgICAgICAgIGlmICghYW0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIG1hc3RlcjogYW0ubWFzdGVyVm9sdW1lLAogICAgICAgICAgICAgICAgYmdtOiBhbS5iZ21MZXZlbCwKICAgICAgICAgICAgICAgIHNmeDogYW0uc2Z4TGV2ZWwsCiAgICAgICAgICAgICAgICBtdXRlOiBhbS5pc011dGVkCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ21hc3RlcicsIDAuMCwgMS4wKS5uYW1lKCdNYXN0ZXIgVm9sdW1lJykub25DaGFuZ2UodiA9PiBhbS5zZXRNYXN0ZXJWb2x1bWUodikpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2JnbScsIDAuMCwgMi4wKS5uYW1lKCdCR00gTGV2ZWwnKS5vbkNoYW5nZSh2ID0+IGFtLnNldEJHTUxldmVsKHYpKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdzZngnLCAwLjAsIDIuMCkubmFtZSgnU0ZYIExldmVsJykub25DaGFuZ2UodiA9PiBhbS5zZXRTRlhMZXZlbCh2KSk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnbXV0ZScpLm5hbWUoJ011dGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGFtLnRvZ2dsZU11dGUoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCn0pKCk7","./DevTools.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFRvb2x0aXAgRGVzY3JpcHRpb25zIGZvciBMb25nLVByZXNzCiAgICBjb25zdCBUT09MVElQX0RFU0NSSVBUSU9OUyA9IHsKICAgICAgICAnU1VCU1RFUFMnOiAiUGh5c2ljcyBpdGVyYXRpb25zIHBlciBmcmFtZS4gSGlnaGVyID0gbW9yZSBzdGFibGUsIG1vcmUgQ1BVLiIsCiAgICAgICAgJ1NUT1BfU1BFRUQnOiAiVmVsb2NpdHkgdGhyZXNob2xkIGJlbG93IHdoaWNoIHRoZSBiYWxsIHNuYXBzIHRvIGEgaGFsdC4iLAogICAgICAgICdXQVRFUl9EUkFHX0xJTkVBUic6ICJCYXNlIHdhdGVyIHJlc2lzdGFuY2UuIFNsb3dzIGJhbGwgbGluZWFybHkuIiwKICAgICAgICAnV0FURVJfRFJBR19RVUFEJzogIlF1YWRyYXRpYyBkcmFnLiBTbG93cyBoaWdoLXNwZWVkIGJhbGxzIHNpZ25pZmljYW50bHkuIiwKICAgICAgICAnU1BJTl9EUkFHJzogIkhvdyBmYXN0IHRoZSBiYWxsJ3Mgc3BpbiBkZWNheXMgb3ZlciB0aW1lLiIsCiAgICAgICAgJ01BR05VU19FTkFCTEVEJzogIkVuYWJsZXMgdGhlIE1hZ251cyBlZmZlY3QgKGN1cnZlIGZyb20gc3BpbikuIiwKICAgICAgICAnTUFHTlVTX0NPRUZGJzogIlN0cmVuZ3RoIG9mIHRoZSBjdXJ2ZSBmb3JjZSByZWxhdGl2ZSB0byBzcGluL3NwZWVkLiIsCiAgICAgICAgJ01BR05VU19DQVAnOiAiTWF4aW11bSBjdXJ2ZSBmb3JjZSBhbGxvd2VkIChwcmV2ZW50cyBwaHlzaWNzIGV4cGxvc2lvbnMpLiIsCiAgICAgICAgJ0RFUFRIX1RBUkdFVF9ZJzogIklkZWFsIFkgaGVpZ2h0IHRoZSBiYWxsIHRyaWVzIHRvIGZsb2F0IGF0LiIsCiAgICAgICAgJ0RFUFRIX1NQUklORyc6ICJTdHJlbmd0aCBvZiB0aGUgZm9yY2UgcHVsbGluZyBiYWxsIHRvIFRhcmdldCBZLiIsCiAgICAgICAgJ0RFUFRIX0RBTVAnOiAiRGFtcGluZyBvbiB2ZXJ0aWNhbCBtb3ZlbWVudCB0byBwcmV2ZW50IG9zY2lsbGF0aW9uLiIsCiAgICAgICAgJ0JPVU5EQVJZX1JBRElVUyc6ICJSYWRpdXMgb2YgdGhlIGNpcmN1bGFyIGFyZW5hIHdhbGwuIiwKICAgICAgICAnQk9VTkRBUllfSEVJR0hUJzogIkhlaWdodCBvZiB0aGUgYXJlbmEgY2VpbGluZy9mbG9vci4iLAogICAgICAgICdXQUxMX1NPRlRfQlVGRkVSJzogIkRpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMuIiwKICAgICAgICAnV0FMTF9TT0ZUX0ZPUkNFJzogIkZvcmNlIHB1c2hpbmcgYmFsbCBhd2F5IGZyb20gd2FsbCBiZWZvcmUgaW1wYWN0LiIsCiAgICAgICAgJ1dBTExfRUxBU1RJQ0lUWSc6ICJCb3VuY2luZXNzIG9mIHRoZSB3YWxsICgwID0gZGVhZCB0aHVkLCAxID0gcGVyZmVjdCBib3VuY2UpLiIsCiAgICAgICAgJ1dBTExfRlJJQ1RJT04nOiAiRnJpY3Rpb24gd2hlbiBzbGlkaW5nIGFsb25nIHRoZSB3YWxsLiIsCiAgICAgICAgJ0ZMT09SX0VMQVNUSUNJVFknOiAiQm91bmNpbmVzcyBvZiB0aGUgZmxvb3IvY2VpbGluZy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9FTkFCTEVEJzogIkVuYWJsZXMgdGhlIGV4dGVuZGVkIGNvcnJpZG9yIGZvciB0aGUgZ29hbC4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9YJzogIkhhbGYtd2lkdGggb2YgdGhlIGdvYWwgcG9ja2V0IGNvcnJpZG9yLiIsCiAgICAgICAgJ0dPQUxfUE9DS0VUX1onOiAiWi1kZXB0aCB3aGVyZSB0aGUgcG9ja2V0IHN0YXJ0cy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9SQURJVVMnOiAiRWZmZWN0aXZlIHJhZGl1cyBpbnNpZGUgdGhlIHBvY2tldC4iLAogICAgICAgICdMQVVOQ0hfU1BFRURfU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBTdGF0IFBvd2VyIHRvIFBoeXNpY3MgVmVsb2NpdHkuIiwKICAgICAgICAnTEFVTkNIX1NQRUVEX0NBUCc6ICJNYXhpbXVtIHBoeXNpY2FsIHNwZWVkIHRoZSBiYWxsIGNhbiBiZSB0aHJvd24uIiwKICAgICAgICAnU1dJUEVfTUlOX1BYJzogIk1pbmltdW0gc3dpcGUgZGlzdGFuY2UgdG8gcmVnaXN0ZXIgYSB0aHJvdy4iLAogICAgICAgICdBSU1fRFhfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgaG9yaXpvbnRhbCBhaW0gZnJvbSBzd2lwZS4iLAogICAgICAgICdBSU1fRFlfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgdmVydGljYWwgYWltIGZyb20gc3dpcGUuIiwKICAgICAgICAnUE9XRVJfQkFTRSc6ICJCYXNlIHBvd2VyIG11bHRpcGxpZXIgZm9yIGEgcXVpY2sgdGFwLiIsCiAgICAgICAgJ1BPV0VSX1JBTkdFJzogIkFkZGl0aW9uYWwgcG93ZXIgbXVsdGlwbGllciBhdCBmdWxsIGNoYXJnZS4iLAogICAgICAgICdQT1dFUl9NQVhfQk9OVVNfUkFUSU8nOiAiQ2hhcmdlIHRocmVzaG9sZCBmb3IgJ01heCBQb3dlcicgYm9udXMuIiwKICAgICAgICAnUE9XRVJfTUFYX01VTFRJUExJRVInOiAiTXVsdGlwbGllciBhcHBsaWVkIHdoZW4gaGl0dGluZyBNYXggUG93ZXIuIiwKICAgICAgICAnQ1VSVkVfRU5BQkxFRCc6ICJFbmFibGVzIGN1cnZlIHNob3RzIHZpYSBjdXJ2ZWQgc3dpcGVzLiIsCiAgICAgICAgJ0NVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQnOiAiSG93IGN1cnZlZCBhIHN3aXBlIG11c3QgYmUgdG8gdHJpZ2dlciBzcGluLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBzd2lwZSBjdXJ2ZSB0byBiYWxsIHNwaW4uIiwKICAgICAgICAnQ1VSVkVfU1BFRURfTVVMVCc6ICJNdWx0aXBsaWVyIGZvciBzcGluIGJhc2VkIG9uIHN3aXBlIHNwZWVkLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fQ0FQJzogIk1heGltdW0gc3BpbiBhbGxvd2VkIGZyb20gYSBjdXJ2ZSB0aHJvdy4iLAogICAgICAgICdDVVJWRV9QRVJGRUNUX1NQSU4nOiAiU3BpbiB0aHJlc2hvbGQgdG8gdHJpZ2dlciAnUGVyZmVjdCBDdXJ2ZScgRlguIiwKICAgICAgICAndGltZVNjYWxlJzogIkdsb2JhbCBnYW1lIHNwZWVkIG11bHRpcGxpZXIuIiwKICAgICAgICAnZGVtb01vZGUnOiAiVG9nZ2xlIEFJIHZzIEFJIGF1dG8tcGxheS4iLAogICAgICAgICdyZXNvbHV0aW9uJzogIkludGVybmFsIHJlbmRlciByZXNvbHV0aW9uIHNjYWxlICgwLjUgPSBoYWxmIHJlcykuIiwKICAgICAgICAnYXJlbmFPcGFjaXR5JzogIk9wYWNpdHkgb2YgdGhlIG91dGVyIGFyZW5hIGdyaWQuIiwKJ2FyZW5hMk9wYWNpdHknOiAiT3BhY2l0eSBvZiB0aGUgaW5uZXIgaGV4IGdyaWQuIiwKCiAgICAgICAgJ0dPQUxfRElTVEFOQ0UnOiAiRGlzdGFuY2Ugb2YgdGhlIGdvYWxzIGZyb20gdGhlIGNlbnRlciAoWi1heGlzKS4iCiAgICB9OwogICAgY2xhc3MgRGV2VG9vbHMgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gbGlsLWd1aSBhdHRhY2hlcyB0byB3aW5kb3cubGlsIGJ5IGRlZmF1bHQgaW4gVU1EIGJ1aWxkCiAgICAgICAgICAgIGlmICghd2luZG93LmxpbCB8fCAhd2luZG93LmxpbC5HVUkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiRGV2VG9vbHM6IGxpbC1ndWkgbm90IGZvdW5kLiIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9Cgpjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKICAgICAgICAgICAgdGhpcy5ndWkgPSBuZXcgd2luZG93LmxpbC5HVUkoeyB0aXRsZTogJ0ZsdXggRGV2VG9vbHMnLCBjb250YWluZXI6IGNvbnRhaW5lciB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBvc2l0aW9uIGFzIGEgY29sbGFwc2VkIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gUG9zaXRpb24gYXMgYSBzbGlkaW5nIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gUG9zaXRpb24gYXMgYSBzbGlkaW5nIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gV3JhcHBlciBmb3Igc2xpZGluZyBhbmltYXRpb24KICAgICAgICAgICAgY29uc3Qgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS50b3AgPSAnMTAwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnJpZ2h0ID0gJy0yNjBweCc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUud2lkdGggPSAnMjYwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnRyYW5zaXRpb24gPSAncmlnaHQgMC4zcyBjdWJpYy1iZXppZXIoMC4yLCAwLjgsIDAuMiwgMS4wKSc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUuekluZGV4ID0gJzk5OTknOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUuZmxleERpcmVjdGlvbiA9ICdjb2x1bW4nOwogICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgogICAgICAgICAgICBjb25zdCBkb20gPSB0aGlzLmd1aS5kb21FbGVtZW50OwogICAgICAgICAgICBkb20uc3R5bGUud2lkdGggPSAnMTAwJSc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5zZXRQcm9wZXJ0eSgnLS13aWR0aCcsICcxMDAlJyk7CiAgICAgICAgICAgIGRvbS5zdHlsZS5tYXhIZWlnaHQgPSAnODB2aCc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvd1kgPSAnYXV0byc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvd1ggPSAnaGlkZGVuJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgR1VJIGludG8gd3JhcHBlcgogICAgICAgICAgICB3cmFwcGVyLmFwcGVuZENoaWxkKGRvbSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDcmVhdGUgVG9nZ2xlIEhhbmRsZQogICAgICAgICAgICBjb25zdCBoYW5kbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmxlZnQgPSAnLTQwcHgnOyAvLyBQcm90cnVkZSB0byB0aGUgbGVmdAogICAgICAgICAgICBoYW5kbGUuc3R5bGUudG9wID0gJzAnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUud2lkdGggPSAnNDBweCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5oZWlnaHQgPSAnNDBweCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAncmdiYSgwLCAyMCwgNDAsIDAuOSknOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyID0gJzFweCBzb2xpZCAjMDBmZmZmJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlclJpZ2h0ID0gJ25vbmUnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyVG9wTGVmdFJhZGl1cyA9ICc4cHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyQm90dG9tTGVmdFJhZGl1cyA9ICc4cHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuY3Vyc29yID0gJ3BvaW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmp1c3RpZnlDb250ZW50ID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5hbGlnbkl0ZW1zID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5jb2xvciA9ICcjMDBmZmZmJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmZvbnRTaXplID0gJzIwcHgnOwogICAgICAgICAgICBoYW5kbGUuaW5uZXJIVE1MID0gJ+KamSc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5ib3hTaGFkb3cgPSAnLTVweCAwIDEwcHggcmdiYSgwLDAsMCwwLjUpJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaGFuZGxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBMb2dpYwogICAgICAgICAgICBsZXQgaXNPcGVuID0gZmFsc2U7CiAgICAgICAgICAgIGhhbmRsZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyAvLyBQcmV2ZW50IGdhbWUgaW5wdXRzCiAgICAgICAgICAgICAgICBpc09wZW4gPSAhaXNPcGVuOwogICAgICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5yaWdodCA9IGlzT3BlbiA/ICcwcHgnIDogJy0yNjBweCc7CiAgICAgICAgICAgICAgICBoYW5kbGUuaW5uZXJIVE1MID0gaXNPcGVuID8gJ8K7JyA6ICfimpknOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gRGVmYXVsdCBnbG9iYWwgdGltZVNjYWxlIGlmIG5vdCBzZXQKaWYgKHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9PT0gdW5kZWZpbmVkKSB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjg7Cgp0aGlzLl9zZXR1cEdlbmVyYWwoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBHYW1lU3RhdGUoKTsKdGhpcy5fc2V0dXBPdmVybGF5cygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFRlYW1zKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwUGxheWVySW5zcGVjdG9yKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwQmFsbFNhbmRib3goKTsKdGhpcy5fc2V0dXBGWExhYigpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFZpc3VhbERlYnVnKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwVmlzdWFscygpOwp0aGlzLl9zZXR1cFZpc3VhbHMoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBBdWRpbygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFRvb2x0aXBzKCk7CiAgICAgICAgfQoKICAgICAgICBfc2V0dXBUb29sdGlwcygpIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIFRvb2x0aXAgRE9NCiAgICAgICAgICAgIHRoaXMudG9vbHRpcEVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy50b29sdGlwRWwuc3R5bGUsIHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAnZml4ZWQnLAogICAgICAgICAgICAgICAgdG9wOiAnNTAlJywKICAgICAgICAgICAgICAgIGxlZnQ6ICc1MCUnLAogICAgICAgICAgICAgICAgdHJhbnNmb3JtOiAndHJhbnNsYXRlKC01MCUsIC01MCUpJywKICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogJ3JnYmEoMCwgMTAsIDMwLCAwLjk1KScsCiAgICAgICAgICAgICAgICBib3JkZXI6ICcycHggc29saWQgIzAwZmZmZicsCiAgICAgICAgICAgICAgICBwYWRkaW5nOiAnMjBweCcsCiAgICAgICAgICAgICAgICBjb2xvcjogJyNmZmYnLAogICAgICAgICAgICAgICAgZm9udEZhbWlseTogJ21vbm9zcGFjZScsCiAgICAgICAgICAgICAgICBmb250U2l6ZTogJzE0cHgnLAogICAgICAgICAgICAgICAgbWF4V2lkdGg6ICczMDBweCcsCiAgICAgICAgICAgICAgICB6SW5kZXg6ICcxMDAwMCcsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAnbm9uZScsCiAgICAgICAgICAgICAgICBwb2ludGVyRXZlbnRzOiAnbm9uZScsCiAgICAgICAgICAgICAgICBib3hTaGFkb3c6ICcwIDAgMjBweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjMpJywKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogJzhweCcsCiAgICAgICAgICAgICAgICB0ZXh0QWxpZ246ICdjZW50ZXInCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMudG9vbHRpcEVsKTsKCiAgICAgICAgICAgIC8vIFJlY3Vyc2l2ZSBmdW5jdGlvbiB0byBhdHRhY2ggbGlzdGVuZXJzCiAgICAgICAgICAgIGNvbnN0IGF0dGFjaCA9IChndWkpID0+IHsKICAgICAgICAgICAgICAgIC8vIENvbnRyb2xsZXJzCiAgICAgICAgICAgICAgICBpZiAoZ3VpLmNvbnRyb2xsZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgZ3VpLmNvbnRyb2xsZXJzLmZvckVhY2goYyA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRvbSA9IGMuZG9tRWxlbWVudC5jbG9zZXN0KCcuY29udHJvbGxlcicpOyAvLyBsaWwtZ3VpIHN0cnVjdHVyZQogICAgICAgICAgICAgICAgICAgICAgICBpZihkb20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gZG9tLnF1ZXJ5U2VsZWN0b3IoJy5uYW1lJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihsYWJlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2FkZExvbmdQcmVzcyhsYWJlbCwgYy5wcm9wZXJ0eSwgYy5fbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIFN1Yi1mb2xkZXJzCiAgICAgICAgICAgICAgICBpZihndWkuZm9sZGVycykgewogICAgICAgICAgICAgICAgICAgIGd1aS5mb2xkZXJzLmZvckVhY2goZiA9PiBhdHRhY2goZikpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gV2FpdCBhIHRpY2sgZm9yIEdVSSB0byBmdWxseSByZW5kZXIgRE9NCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gYXR0YWNoKHRoaXMuZ3VpKSwgMTAwKTsKICAgICAgICB9CgogICAgICAgIF9hZGRMb25nUHJlc3MoZWxlbWVudCwgcHJvcGVydHksIG5hbWUpIHsKICAgICAgICAgICAgbGV0IHRpbWVyID0gbnVsbDsKICAgICAgICAgICAgY29uc3QgZHVyYXRpb24gPSA1MDA7IC8vIDAuNXMKCiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIHRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd1Rvb2x0aXAocHJvcGVydHksIG5hbWUpOwogICAgICAgICAgICAgICAgfSwgZHVyYXRpb24pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgZW5kID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYodGltZXIpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpOwogICAgICAgICAgICAgICAgICAgIHRpbWVyID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVUb29sdGlwKCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHN0YXJ0KTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0Jywgc3RhcnQsIHtwYXNzaXZlOiB0cnVlfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBlbmQpOwogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCBlbmQpOwogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgZW5kKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGVuZCk7CiAgICAgICAgfQoKICAgICAgICBfc2hvd1Rvb2x0aXAocHJvcCwgbmFtZSkgewogICAgICAgICAgICBjb25zdCBkZXNjID0gVE9PTFRJUF9ERVNDUklQVElPTlNbcHJvcF07CiAgICAgICAgICAgIGlmKGRlc2MpIHsKICAgICAgICAgICAgICAgIHRoaXMudG9vbHRpcEVsLmlubmVySFRNTCA9IGA8c3Ryb25nIHN0eWxlPSJjb2xvcjojMDBmZmZmOyBmb250LXNpemU6MTZweDsiPiR7bmFtZSB8fCBwcm9wfTwvc3Ryb25nPjxicj48YnI+JHtkZXNjfWA7CiAgICAgICAgICAgICAgICB0aGlzLnRvb2x0aXBFbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVUb29sdGlwKCkgewogICAgICAgICAgICBpZiAodGhpcy50b29sdGlwRWwpIHRoaXMudG9vbHRpcEVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQoKCl9zZXR1cEdlbmVyYWwoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignR2VuZXJhbCcpOwogICAgICAgICAgICAKY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgdGltZVNjYWxlOiB3aW5kb3cuZmx1eC50aW1lU2NhbGUsCiAgICAgICAgICAgICAgICBkZW1vTW9kZTogdGhpcy5nYW1lLmlzRGVtb01vZGUsCiAgICAgICAgICAgICAgICB0b2dnbGVIVUQ6IHRydWUsCiAgICAgICAgICAgICAgICByZXNvbHV0aW9uOiAwLjUwLAphcmVuYU9wYWNpdHk6IDAuMywKICAgICAgICAgICAgICAgIGFyZW5hMk9wYWNpdHk6IDAuMjUKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndGltZVNjYWxlJywgMC4wLCA1LjApLm5hbWUoJ0dhbWUgU3BlZWQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9IHY7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdkZW1vTW9kZScpLm5hbWUoJ0RlbW8gTW9kZScpLmxpc3RlbigpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5pc0RlbW9Nb2RlICE9PSB2KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRvZ2dsZURlbW9Nb2RlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICd0b2dnbGVIVUQnKS5uYW1lKCdTaG93IEhVRCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgY29uc3QgaHVkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJyk7CiAgICAgICAgICAgICAgICBpZiAoaHVkKSB7CiAgICAgICAgICAgICAgICAgICAgaHVkLnN0eWxlLnZpc2liaWxpdHkgPSB2ID8gJ3Zpc2libGUnIDogJ2hpZGRlbic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdyZXNvbHV0aW9uJywgMC4xLCAyLjApLm5hbWUoJ1Jlc29sdXRpb24gU2NhbGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHcgPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICAgICAgICAgIGNvbnN0IGggPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICBjb25zdCByZW5kZXJlciA9IHRoaXMuZ2FtZS5yZW5kZXJlcjsKICAgICAgICAgICAgICAgIGlmIChyZW5kZXJlcikgewogICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyLnNldFNpemUodyAqIHYsIGggKiB2LCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYU9wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnQXJlbmEgMSBPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjb25zdCBibGVuZE1vZGVzID0gewogICAgICAgICAgICAgICAgJ05vcm1hbCc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ0FkZGl0aXZlJzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICdNdWx0aXBseSc6IFRIUkVFLk11bHRpcGx5QmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnU3VidHJhY3RpdmUnOiBUSFJFRS5TdWJ0cmFjdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ05vQmxlbmRpbmcnOiBUSFJFRS5Ob0JsZW5kaW5nCiAgICAgICAgICAgIH07CnBhcmFtcy5hcmVuYUJsZW5kID0gJ05vcm1hbCc7CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hQmxlbmQnLCBPYmplY3Qua2V5cyhibGVuZE1vZGVzKSkubmFtZSgnQXJlbmEgMSBCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwuYmxlbmRpbmcgPSBibGVuZE1vZGVzW3ZdOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gQXJlbmEgMiBDb250cm9scwpmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hMk9wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnQXJlbmEgMiBPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoMiAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlID0gdjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgpwYXJhbXMuYXJlbmEyQmxlbmQgPSAnQWRkaXRpdmUnOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hMkJsZW5kJywgT2JqZWN0LmtleXMoYmxlbmRNb2RlcykpLm5hbWUoJ0FyZW5hIDIgQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2gyICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLmJsZW5kaW5nID0gYmxlbmRNb2Rlc1t2XTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBkZWZhdWx0cwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBwYXJhbXMuYXJlbmFPcGFjaXR5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2gyICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwub3BhY2l0eSA9IHBhcmFtcy5hcmVuYTJPcGFjaXR5OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gQXJlbmEgR3JhcGhpY3MgQ29udHJvbHMgLS0tCiAgICAgICAgICAgIHRoaXMuX3NldHVwQXJlbmFHcmFwaGljcygpOwogICAgICAgIH0KCiAgICAgICAgX3NldHVwQXJlbmFHcmFwaGljcygpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdBcmVuYSBHcmFwaGljcycpOwoKICAgICAgICAgICAgY29uc3QgdGhyZWVCbGVuZHMgPSB7CiAgICAgICAgICAgICAgICAnTm9ybWFsJzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnQWRkaXRpdmUnOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICdNdWx0aXBseSc6IFRIUkVFLk11bHRpcGx5QmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnTm9CbGVuZGluZyc6IFRIUkVFLk5vQmxlbmRpbmcKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIC0tLSBCbHVlIEJhbmQgLS0tCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCkgewogICAgICAgICAgICAgICAgY29uc3QgYmx1ZUZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0JsdWUgQmFuZCcpOwogICAgICAgICAgICAgICAgY29uc3QgYmx1ZVBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2ggPyB3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2gudmlzaWJsZSA6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd2luZG93LmZsdXguYmx1ZUJhbmRNYXQub3BhY2l0eSB8fCAwLjM1LAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnTm9ybWFsJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGJsdWVGb2xkZXIuYWRkKGJsdWVQYXJhbXMsICd2aXNpYmxlJykubmFtZSgnVmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2gpIHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaC52aXNpYmxlID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgYmx1ZUZvbGRlci5hZGQoYmx1ZVBhcmFtcywgJ29wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCkgd2luZG93LmZsdXguYmx1ZUJhbmRNYXQub3BhY2l0eSA9IHY7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGJsdWVGb2xkZXIuYWRkKGJsdWVQYXJhbXMsICdibGVuZCcsIE9iamVjdC5rZXlzKHRocmVlQmxlbmRzKSkubmFtZSgnQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYmx1ZUJhbmRNYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNYXQuYmxlbmRpbmcgPSB0aHJlZUJsZW5kc1t2XTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNYXQubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gR29sZCBCYW5kIC0tLQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ29sZEJhbmRNYXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdvbGRGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdHb2xkIEJhbmQnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGdvbGRQYXJhbXMgPSB7CiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogd2luZG93LmZsdXguZ29sZEJhbmRNZXNoID8gd2luZG93LmZsdXguZ29sZEJhbmRNZXNoLnZpc2libGUgOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5vcGFjaXR5IHx8IDAuMzUsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdOb3JtYWwnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZ29sZEZvbGRlci5hZGQoZ29sZFBhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdWaXNpYmxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvbGRCYW5kTWVzaCkgd2luZG93LmZsdXguZ29sZEJhbmRNZXNoLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBnb2xkRm9sZGVyLmFkZChnb2xkUGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMS4wKS5uYW1lKCdPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0KSB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZ29sZEZvbGRlci5hZGQoZ29sZFBhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5uYW1lKCdCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBZZWxsb3cgQXJyb3dzIC0tLQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJyb3dNYXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFycm93Rm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignWWVsbG93IEFycm93cycpOwogICAgICAgICAgICAgICAgY29uc3QgYXJyb3dQYXJhbXMgPSB7CiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogd2luZG93LmZsdXguYXJyb3dHcm91cCA/IHdpbmRvdy5mbHV4LmFycm93R3JvdXAudmlzaWJsZSA6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd2luZG93LmZsdXguYXJyb3dNYXQub3BhY2l0eSB8fCAwLjgsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdBZGRpdGl2ZScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBhcnJvd0ZvbGRlci5hZGQoYXJyb3dQYXJhbXMsICd2aXNpYmxlJykubmFtZSgnVmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcnJvd0dyb3VwKSB3aW5kb3cuZmx1eC5hcnJvd0dyb3VwLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBhcnJvd0ZvbGRlci5hZGQoYXJyb3dQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ09wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJyb3dNYXQpIHdpbmRvdy5mbHV4LmFycm93TWF0Lm9wYWNpdHkgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBhcnJvd0ZvbGRlci5hZGQoYXJyb3dQYXJhbXMsICdibGVuZCcsIE9iamVjdC5rZXlzKHRocmVlQmxlbmRzKSkubmFtZSgnQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJyb3dNYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJyb3dNYXQuYmxlbmRpbmcgPSB0aHJlZUJsZW5kc1t2XTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJyb3dNYXQubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gRmxvb3IgR2x5cGggLS0tCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0KSB7CiAgICAgICAgICAgICAgICBjb25zdCBmbG9vckZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0Zsb29yIEdseXBoJyk7CiAgICAgICAgICAgICAgICBjb25zdCBmbG9vclBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWVzaCA/IHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNZXNoLnZpc2libGUgOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQub3BhY2l0eSB8fCAwLjM1LAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnQWRkaXRpdmUnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZmxvb3JGb2xkZXIuYWRkKGZsb29yUGFyYW1zLCAndmlzaWJsZScpLm5hbWUoJ1Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZmxvb3JHbHlwaE1lc2gpIHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNZXNoLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmbG9vckZvbGRlci5hZGQoZmxvb3JQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ09wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZmxvb3JHbHlwaE1hdCkgd2luZG93LmZsdXguZmxvb3JHbHlwaE1hdC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZmxvb3JGb2xkZXIuYWRkKGZsb29yUGFyYW1zLCAnYmxlbmQnLCBPYmplY3Qua2V5cyh0aHJlZUJsZW5kcykpLm5hbWUoJ0JsZW5kJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZmxvb3JHbHlwaE1hdC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9zZXR1cE92ZXJsYXlzKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ092ZXJsYXlzICYgRlgnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDEuIEdJRiBPdmVybGF5CiAgICAgICAgICAgIGNvbnN0IGdpZkVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NjcmVlbi1vdmVybGF5LWdpZicpOwogICAgICAgICAgICBpZiAoZ2lmRWwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdpZlBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB0cnVlLApvcGFjaXR5OiAwLjYyLAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnb3ZlcmxheScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdTY3JlZW4gR0lGJyk7CiAgICAgICAgICAgICAgICBnRm9sZGVyLmFkZChnaWZQYXJhbXMsICd2aXNpYmxlJykub25DaGFuZ2UodiA9PiBnaWZFbC5zdHlsZS5kaXNwbGF5ID0gdiA/ICdibG9jaycgOiAnbm9uZScpOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMS4wKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLm9wYWNpdHkgPSB2KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYmxlbmRNb2RlcyA9IFsKICAgICAgICAgICAgICAgICAgICAnbm9ybWFsJywgJ211bHRpcGx5JywgJ3NjcmVlbicsICdvdmVybGF5JywgCiAgICAgICAgICAgICAgICAgICAgJ2RhcmtlbicsICdsaWdodGVuJywgJ2NvbG9yLWRvZGdlJywgJ2NvbG9yLWJ1cm4nLCAKICAgICAgICAgICAgICAgICAgICAnaGFyZC1saWdodCcsICdzb2Z0LWxpZ2h0JywgJ2RpZmZlcmVuY2UnLCAnZXhjbHVzaW9uJywgCiAgICAgICAgICAgICAgICAgICAgJ2h1ZScsICdzYXR1cmF0aW9uJywgJ2NvbG9yJywgJ2x1bWlub3NpdHknCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAnYmxlbmQnLCBibGVuZE1vZGVzKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLm1peEJsZW5kTW9kZSA9IHYpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBXYXRlciBPdmVybGF5CiAgICAgICAgICAgIGNvbnN0IHdvID0gdGhpcy5nYW1lLndhdGVyT3ZlcmxheTsKICAgICAgICAgICAgaWYgKHdvICYmIHdvLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdXYXRlciBTaGFkZXInKTsKICAgICAgICAgICAgICAgIGNvbnN0IHdQYXJhbXMgPSB7IAogICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkgPyB3by5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eS52YWx1ZSA6IDAuNSwKICAgICAgICAgICAgICAgICAgICBibGVuZDogJ0FkZGl0aXZlJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ3Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IHdvLm1lc2gudmlzaWJsZSA9IHYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAod28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkpIHsKICAgICAgICAgICAgICAgICAgICB3Rm9sZGVyLmFkZCh3UGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMi4wKS5vbkNoYW5nZSh2ID0+IHdvLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlID0gdik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGhyZWVCbGVuZHMgPSB7CiAgICAgICAgICAgICAgICAgICAgJ05vcm1hbCc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdBZGRpdGl2ZSc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICAnTXVsdGlwbHknOiBUSFJFRS5NdWx0aXBseUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdOb0JsZW5kaW5nJzogVEhSRUUuTm9CbGVuZGluZwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICB3by5tYXRlcmlhbC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgIHdvLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBMaWdodCBTaGFmdHMKICAgICAgICAgICAgY29uc3QgbHMgPSB0aGlzLmdhbWUubGlnaHRTaGFmdHM7CiAgICAgICAgICAgIGlmIChscyAmJiBscy5jb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGxQYXJhbXMgPSB7IHZpc2libGU6IHRydWUgfTsKICAgICAgICAgICAgICAgIGZvbGRlci5hZGQobFBhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdMaWdodCBTaGFmdHMnKS5vbkNoYW5nZSh2ID0+IGxzLmNvbnRhaW5lci52aXNpYmxlID0gdik7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpfc2V0dXBHYW1lU3RhdGUoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignR2FtZSBTdGF0ZScpOwogICAgICAgICAgICBjb25zdCBnbSA9IHRoaXMuZ2FtZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIGZvcmNlSG9tZUdvYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5nb2FsU2NvcmVkKCdob21lJyk7IAogICAgICAgICAgICAgICAgICAgIGVsc2UgY29uc29sZS53YXJuKCJHYW1lIG11c3QgYmUgYWN0aXZlIHRvIHRyaWdnZXIgZ29hbCIpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGZvcmNlQXdheUdvYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5nb2FsU2NvcmVkKCdhd2F5Jyk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb25zb2xlLndhcm4oIkdhbWUgbXVzdCBiZSBhY3RpdmUgdG8gdHJpZ2dlciBnb2FsIik7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZm9yY2VIYWxmdGltZTogKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmKGdtLnN0YXRlID09PSAnYWN0aXZlJykgZ20uZW5kSGFsZigpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHJlc2V0Um91bmQ6ICgpID0+IGdtLnJlc2V0Um91bmQoKSwKICAgICAgICAgICAgICAgIGV4aXRUb01lbnU6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPSAnbWVudSc7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgcHJhY3RpY2UgaWYgcnVubmluZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlSG9tZUdvYWwnKS5uYW1lKCdUcmlnZ2VyIEhvbWUgR29hbCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlQXdheUdvYWwnKS5uYW1lKCdUcmlnZ2VyIEF3YXkgR29hbCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlSGFsZnRpbWUnKS5uYW1lKCdGb3JjZSBIYWxmdGltZScpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3Jlc2V0Um91bmQnKS5uYW1lKCdSZXNldCBSb3VuZCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2V4aXRUb01lbnUnKS5uYW1lKCdFeGl0IHRvIE1lbnUnKTsKICAgICAgICB9CgogICAgICAgIF9zZXR1cFRlYW1zKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1RlYW1zJyk7CiAgICAgICAgICAgIGlmICghdGhpcy5nYW1lLnRlYW1zLmhvbWUgfHwgIXRoaXMuZ2FtZS50ZWFtcy5hd2F5KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBob21lID0gdGhpcy5nYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGNvbnN0IGF3YXkgPSB0aGlzLmdhbWUudGVhbXMuYXdheTsKCiAgICAgICAgICAgIC8vIEhvbWUKICAgICAgICAgICAgY29uc3QgaEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0hvbWUgVGVhbScpOwogICAgICAgICAgICBoRm9sZGVyLmFkZChob21lLCAnaXNIdW1hbicpLm5hbWUoJ0lzIEh1bWFuIENvbnRyb2xsZWQnKS5saXN0ZW4oKTsKICAgICAgICAgICAgaEZvbGRlci5hZGQoaG9tZSwgJ2FpRW5hYmxlZCcpLm5hbWUoJ0FJIExvZ2ljIEVuYWJsZWQnKS5saXN0ZW4oKTsKCiAgICAgICAgICAgIC8vIEF3YXkKICAgICAgICAgICAgY29uc3QgYUZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0F3YXkgVGVhbScpOwogICAgICAgICAgICBhRm9sZGVyLmFkZChhd2F5LCAnaXNIdW1hbicpLm5hbWUoJ0lzIEh1bWFuIENvbnRyb2xsZWQnKS5saXN0ZW4oKTsKICAgICAgICAgICAgYUZvbGRlci5hZGQoYXdheSwgJ2FpRW5hYmxlZCcpLm5hbWUoJ0FJIExvZ2ljIEVuYWJsZWQnKS5saXN0ZW4oKTsKCiAgICAgICAgfQoKX3NldHVwUGxheWVySW5zcGVjdG9yKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1BsYXllciBJbnNwZWN0b3IgKEhvbWUgQWN0aXZlKScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGVscGVyIHRvIGdldCBjdXJyZW50IGFjdGl2ZSBwbGF5ZXIgc2FmZWx5CiAgICAgICAgICAgIGNvbnN0IGdldEFjdGl2ZSA9ICgpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5nYW1lLnRlYW1zLmhvbWUgJiYgdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSAKICAgICAgICAgICAgICAgICAgICA/IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciAKICAgICAgICAgICAgICAgICAgICA6IG51bGw7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBQcm94eSBvYmplY3QgdG8gYmluZCBHVUkgdG8gZHluYW1pYyB0YXJnZXQKICAgICAgICAgICAgY29uc3QgcHJveHkgPSB7CiAgICAgICAgICAgICAgICBnZXQgUm9sZSgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5yb2xlIDogJy0nOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGdldCBHb2RNb2RlKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLmlzR29kTW9kZSA6IGZhbHNlOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgR29kTW9kZSh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmlzR29kTW9kZSA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBSdW50aW1lIFZhbHVlcwogICAgICAgICAgICAgICAgZ2V0IEhQKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkhQIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEhQKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuSFAgPSB2OyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGdldCBDdXJyZW50RU4oKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuY3VycmVudEVOIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEN1cnJlbnRFTih2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmN1cnJlbnRFTiA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBCYXNlIFN0YXRzCiAgICAgICAgICAgICAgICBnZXQgTWF4SFAoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMubWF4SFAgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgTWF4SFAodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5tYXhIUCA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgU1AoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuU1AgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgU1AodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5TUCA9IHY7IAogICAgICAgICAgICAgICAgICAgICAgICBwLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsgCiAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEVOKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkVOIDogMDsgCiAgICAgICAgICAgICAgICB9LCAKICAgICAgICAgICAgICAgIHNldCBFTih2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHMuRU4gPSB2OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEFUKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkFUIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEFUKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQVQgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFBBKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlBBIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFBBKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuUEEgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEJMKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkJMIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEJMKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQkwgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFNIKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlNIIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFNIKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuU0ggPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IENBKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkNBIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IENBKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQ0EgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLy8gQWN0aW9ucwogICAgICAgICAgICAgICAgTGV2ZWxVcDogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5sZXZlbFVwKCk7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEZ1bGxIZWFsOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsgCiAgICAgICAgICAgICAgICAgICAgaWYocCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7IAogICAgICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuZ2V0U3RhdCgnRU4nKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLnZlbm9tID0gMDsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLm5hcCA9IDA7IAogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGsgaW4gcC5zdGF0dXMud2l0aGVyKSBwLnN0YXR1cy53aXRoZXJba10gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZih3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJGVUxMIEhFQUwiLCBwLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIERyYWluRU46ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBwLmZ1bWJsZSgpOyAvLyBUcmlnZ2VyIGZ1bWJsZSBsb2dpYwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocHJveHksICdSb2xlJykubGlzdGVuKCkuZGlzYWJsZSgpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHByb3h5LCAnR29kTW9kZScpLm5hbWUoJ0dvZCBNb2RlIChJbmYgSFAvRU4pJykubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBydEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ1J1bnRpbWUgU3RhdHVzJyk7CiAgICAgICAgICAgIHJ0Rm9sZGVyLmFkZChwcm94eSwgJ0hQJywgMCwgOTk5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHJ0Rm9sZGVyLmFkZChwcm94eSwgJ0N1cnJlbnRFTicsIDAsIDEwMCkubmFtZSgnQ3VycmVudCBFTicpLmxpc3RlbigpOwoKICAgICAgICAgICAgY29uc3Qgc3RhdEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0Jhc2UgU3RhdHMnKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdNYXhIUCcsIDEwMCwgOTk5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnRU4nLCAwLCA5OSkubmFtZSgnTWF4IEVOJykubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnU1AnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQVQnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnUEEnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQkwnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnU0gnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQ0EnLCAwLCA5OSkubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBhY3Rpb25Gb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdBY3Rpb25zJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdMZXZlbFVwJykubmFtZSgnSW5zdGFudCBMZXZlbCBVcCcpOwogICAgICAgICAgICBhY3Rpb25Gb2xkZXIuYWRkKHByb3h5LCAnRnVsbEhlYWwnKS5uYW1lKCdGdWxsIEhlYWwgJiBDdXJlJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdEcmFpbkVOJykubmFtZSgnRHJhaW4gRU4gKEZ1bWJsZSknKTsKICAgICAgICB9Cgpfc2V0dXBCYWxsU2FuZGJveCgpIHsKICAgIGNvbnN0IHJvb3QgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0JhbGwgTGFiIChUaHJvdyAmIFBoeXNpY3MpJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBTaGFyZWQgc3RhdGUgb2JqZWN0IChsaXZlcyBvbiB3aW5kb3cuZmx1eCBzbyBpdCBzdXJ2aXZlcyByZWxvYWRzKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBsYWIgPSB3aW5kb3cuZmx1eC5iYWxsTGFiID0gd2luZG93LmZsdXguYmFsbExhYiB8fCB7fTsKICAgIGxhYi5nYW1lID0gdGhpcy5nYW1lOwoKICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnOwogICAgY29uc3QgVEMgPSB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZzsKCiAgICBpZiAoIUMgfHwgIVRDKSB7CiAgICAgICAgY29uc29sZS53YXJuKCJCYWxsIExhYjogTWlzc2luZyBCYWxsQ29uZmlnIG9yIFRocm93Q29uZmlnLiIpOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEhlbHBlcnMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgZ2V0QmFsbCA9ICgpID0+IHRoaXMuZ2FtZSAmJiB0aGlzLmdhbWUuZW50aXRpZXMgPyB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICBjb25zdCBnZXRBY3RpdmUgPSAoKSA9PiB0aGlzLmdhbWUgJiYgdGhpcy5nYW1lLnRlYW1zICYmIHRoaXMuZ2FtZS50ZWFtcy5ob21lID8gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKCiAgICBjb25zdCBlbnN1cmVQcmV2aWV3TGluZSA9ICgpID0+IHsKICAgICAgICBpZiAobGFiLnByZXZpZXdMaW5lKSByZXR1cm47CiAgICAgICAgaWYgKCF0aGlzLmdhbWUgfHwgIXRoaXMuZ2FtZS5zY2VuZSkgcmV0dXJuOwoKICAgICAgICBjb25zdCBnZW9tID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgdHJhbnNwYXJlbnQ6IHRydWUsIG9wYWNpdHk6IDAuOTUgfSk7CiAgICAgICAgY29uc3QgbGluZSA9IG5ldyBUSFJFRS5MaW5lKGdlb20sIG1hdCk7CiAgICAgICAgbGluZS5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgbGluZS5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKGxpbmUpOwogICAgICAgIGxhYi5wcmV2aWV3TGluZSA9IGxpbmU7CiAgICB9OwoKICAgIGNvbnN0IGNsZWFyUHJldmlld0xpbmUgPSAoKSA9PiB7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3TGluZSAmJiBsYWIucHJldmlld0xpbmUuZ2VvbWV0cnkpIHsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBBIHNhZmUgImdob3N0IGJhbGwiIHRoYXQgY2FuIHVzZSBCYWxsLnVwZGF0ZUZyZWUgd2l0aG91dCBzcGF3bmluZyBGWAogICAgY29uc3QgbWFrZUdob3N0QmFsbCA9IChwb3MsIHZlbCwgc3BpbikgPT4gewogICAgICAgIGNvbnN0IGdiID0gewogICAgICAgICAgICBtZXNoOiB7IHBvc2l0aW9uOiBwb3MuY2xvbmUoKSB9LAogICAgICAgICAgICB2ZWxvY2l0eTogdmVsLmNsb25lKCksCiAgICAgICAgICAgIGFuZ3VsYXJWZWxvY2l0eTogKHNwaW4gPyBzcGluLmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpKSwKICAgICAgICAgICAgYWNjdW11bGF0ZWRSb3RhdGlvbjogbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwKICAgICAgICAgICAgcG93ZXI6IDAsCiAgICAgICAgICAgIGRlY2F5UmF0ZTogMCwKICAgICAgICAgICAgX2J1YmJsZVRpbWVyOiA5OTksCiAgICAgICAgICAgIF9naG9zdDogdHJ1ZSwKICAgICAgICAgICAgZGVmb3JtTm9kZTogbnVsbAogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGdiOwogICAgfTsKCiAgICAvLyBVc2UgQmFsbC51cGRhdGVGcmVlIGZvciBmYWl0aGZ1bCB0cmFqZWN0b3J5IHByZWRpY3Rpb24KICAgIGNvbnN0IHNpbXVsYXRlID0gKGdob3N0QmFsbCwgc3RlcHMsIHN0ZXBEdCkgPT4gewogICAgICAgIGNvbnN0IHB0cyA9IFtdOwogICAgICAgIHB0cy5wdXNoKGdob3N0QmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCkpOwogICAgICAgIGNvbnN0IHByb3RvID0gd2luZG93LmZsdXguQmFsbCAmJiB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZTsKICAgICAgICBpZiAoIXByb3RvIHx8IHR5cGVvZiBwcm90by51cGRhdGVGcmVlICE9PSAnZnVuY3Rpb24nKSByZXR1cm4gcHRzOwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ZXBzOyBpKyspIHsKICAgICAgICAgICAgcHJvdG8udXBkYXRlRnJlZS5jYWxsKGdob3N0QmFsbCwgc3RlcER0KTsKICAgICAgICAgICAgcHRzLnB1c2goZ2hvc3RCYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwdHM7CiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gUHJldmlldyArIHJlY29yZC9yZXBsYXkgcnVudGltZSBsb29wCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KbGFiLnByZXZpZXcgPSBsYWIucHJldmlldyB8fCB7CiAgICAgICAgZW5hYmxlZDogZmFsc2UsCiAgICAgICAgc291cmNlOiAnQ2Fubm9uJywKICAgICAgICBzdGVwczogMTIwLAogICAgICAgIHN0ZXBEdDogMS82MCwKICAgICAgICByZWZyZXNoSHo6IDEwLAogICAgICAgIHNob3dPbkhlbGRPbmx5OiBmYWxzZQogICAgfTsKCiAgICBsYWIuY2Fubm9uID0gbGFiLmNhbm5vbiB8fCB7CiAgICAgICAgeWF3OiAwLAogICAgICAgIHBpdGNoOiAwLAogICAgICAgIHBvd2VyOiAyMCwKICAgICAgICB0eXBlOiAnU0gnLAogICAgICAgIHNwaW5YOiAwLAogICAgICAgIHNwaW5ZOiAwLAogICAgICAgIHNwaW5aOiAwLAogICAgICAgIGZpcmVCdXJzdDogMSwKICAgICAgICBzcHJlYWREZWc6IDAKICAgIH07CgogICAgbGFiLnJlY29yZGluZyA9IGxhYi5yZWNvcmRpbmcgfHwgewogICAgICAgIGlzUmVjb3JkaW5nOiBmYWxzZSwKICAgICAgICBmcmFtZXM6IFtdLAogICAgICAgIG1heFNlY29uZHM6IDEyCiAgICB9OwoKICAgIGxhYi5yZXBsYXkgPSBsYWIucmVwbGF5IHx8IHsKICAgICAgICBpc1JlcGxheWluZzogZmFsc2UsCiAgICAgICAgZnJhbWVzOiBbXSwKICAgICAgICBpZHg6IDAsCiAgICAgICAgbG9vcDogdHJ1ZSwKICAgICAgICBzcGVlZDogMS4wCiAgICB9OwoKICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgbGFiLnRhcmdldEJhbGwgPSBudWxsOwoKICAgIGxhYi5hcHBseVJlcGxheUZyYW1lID0gKGJhbGwsIGR0KSA9PiB7CiAgICAgICAgY29uc3QgcmVwID0gbGFiLnJlcGxheTsKICAgICAgICBpZiAoIXJlcCB8fCAhcmVwLmlzUmVwbGF5aW5nIHx8ICFyZXAuZnJhbWVzIHx8IHJlcC5mcmFtZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBBZHZhbmNlIHRpbWUgYnkgc3RlcHBpbmcgaW5kaWNlcyAoZnJhbWUtYmFzZWQpCiAgICAgICAgY29uc3Qgc3RlcCA9IE1hdGgubWF4KDEsIE1hdGguZmxvb3IocmVwLnNwZWVkKSk7CiAgICAgICAgcmVwLmlkeCArPSBzdGVwOwoKICAgICAgICBpZiAocmVwLmlkeCA+PSByZXAuZnJhbWVzLmxlbmd0aCkgewogICAgICAgICAgICBpZiAocmVwLmxvb3ApIHJlcC5pZHggPSAwOwogICAgICAgICAgICBlbHNlIHsgcmVwLmlzUmVwbGF5aW5nID0gZmFsc2U7IGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOyByZXR1cm47IH0KICAgICAgICB9CgogICAgICAgIGNvbnN0IGYgPSByZXAuZnJhbWVzW3JlcC5pZHhdOwogICAgICAgIGlmICghZikgcmV0dXJuOwoKICAgICAgICBiYWxsLmRyb3AoKTsgLy8gZW5zdXJlIG5vIGhvbGRlciBsb2dpYyBmaWdodHMgdXMKICAgICAgICBiYWxsLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIGJhbGwubWVzaC5wb3NpdGlvbi5zZXQoZi5weCwgZi5weSwgZi5weik7CiAgICAgICAgYmFsbC52ZWxvY2l0eS5zZXQoZi52eCwgZi52eSwgZi52eik7CiAgICAgICAgYmFsbC5hbmd1bGFyVmVsb2NpdHkuc2V0KGYuc3gsIGYuc3ksIGYuc3opOwogICAgfTsKCiAgICBsYWIuX3ByZXZpZXdUaW1lciA9IGxhYi5fcHJldmlld1RpbWVyIHx8IDA7CgogICAgbGFiLnVwZGF0ZSA9IChkdCkgPT4gewogICAgICAgIC8vIC0tLSByZWNvcmRpbmcgLS0tCiAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICBpZiAoYiAmJiBsYWIucmVjb3JkaW5nICYmIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcpIHsKICAgICAgICAgICAgY29uc3QgciA9IGxhYi5yZWNvcmRpbmc7CiAgICAgICAgICAgIGNvbnN0IG1heEZyYW1lcyA9IE1hdGguZmxvb3IoKHIubWF4U2Vjb25kcyB8fCAxMikgLyAoZHQgfHwgKDEvNjApKSk7CiAgICAgICAgICAgIGlmIChyLmZyYW1lcy5sZW5ndGggPiBtYXhGcmFtZXMpIHIuZnJhbWVzLnNoaWZ0KCk7CiAgICAgICAgICAgIHIuZnJhbWVzLnB1c2goewogICAgICAgICAgICAgICAgcHg6IGIubWVzaC5wb3NpdGlvbi54LCBweTogYi5tZXNoLnBvc2l0aW9uLnksIHB6OiBiLm1lc2gucG9zaXRpb24ueiwKICAgICAgICAgICAgICAgIHZ4OiBiLnZlbG9jaXR5LngsIHZ5OiBiLnZlbG9jaXR5LnksIHZ6OiBiLnZlbG9jaXR5LnosCiAgICAgICAgICAgICAgICBzeDogYi5hbmd1bGFyVmVsb2NpdHkueCwgc3k6IGIuYW5ndWxhclZlbG9jaXR5LnksIHN6OiBiLmFuZ3VsYXJWZWxvY2l0eS56CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIHByZXZpZXcgcmVmcmVzaCAtLS0KICAgICAgICBsYWIuX3ByZXZpZXdUaW1lciArPSBkdDsKICAgICAgICBjb25zdCByZWZyZXNoSW50ZXJ2YWwgPSAxLjAgLyBNYXRoLm1heCgxLCAobGFiLnByZXZpZXcucmVmcmVzaEh6IHx8IDEwKSk7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LmVuYWJsZWQgJiYgbGFiLl9wcmV2aWV3VGltZXIgPj0gcmVmcmVzaEludGVydmFsKSB7CiAgICAgICAgICAgIGxhYi5fcHJldmlld1RpbWVyID0gMDsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfQogICAgfTsKCiAgICBsYWIucmVmcmVzaFByZXZpZXcgPSAoKSA9PiB7CiAgICAgICAgaWYgKCFsYWIucHJldmlldy5lbmFibGVkKSB7IGNsZWFyUHJldmlld0xpbmUoKTsgcmV0dXJuOyB9CiAgICAgICAgZW5zdXJlUHJldmlld0xpbmUoKTsKCiAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgaWYgKCFiIHx8ICFiLm1lc2gpIHJldHVybjsKCiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LnNob3dPbkhlbGRPbmx5ICYmIGIuc3RhdGUgIT09ICdoZWxkJykgewogICAgICAgICAgICBjbGVhclByZXZpZXdMaW5lKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIERlY2lkZSBwcmV2aWV3IHNvdXJjZQogICAgICAgIGxldCBzdGFydFBvcyA9IGIubWVzaC5wb3NpdGlvbjsKICAgICAgICBsZXQgc3RhcnRWZWwgPSBiLnZlbG9jaXR5OwogICAgICAgIGxldCBzdGFydFNwaW4gPSBiLmFuZ3VsYXJWZWxvY2l0eTsKCiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LnNvdXJjZSA9PT0gJ0Nhbm5vbicpIHsKICAgICAgICAgICAgLy8gQ2Fubm9uIGFsd2F5cyBsYXVuY2hlcyBmcm9tIGJhbGwgcG9zaXRpb24gKG9yIHBsYXllciBpZiBoZWxkKQogICAgICAgICAgICBjb25zdCB5YXdSYWQgPSAobGFiLmNhbm5vbi55YXcgfHwgMCkgKiBNYXRoLlBJIC8gMTgwOwogICAgICAgICAgICBjb25zdCBwaXRjaFJhZCA9IChsYWIuY2Fubm9uLnBpdGNoIHx8IDApICogTWF0aC5QSSAvIDE4MDsKCiAgICAgICAgICAgIGNvbnN0IGRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgTWF0aC5zaW4oeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIE1hdGguc2luKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIC1NYXRoLmNvcyh5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpCiAgICAgICAgICAgICkubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBjYXAgPSAod2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfQ0FQICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkxBVU5DSF9TUEVFRF9DQVAgOiA4NS4wKTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAod2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfU0NBTEUgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX1NDQUxFIDogMS4wKTsKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSBNYXRoLm1pbigobGFiLmNhbm5vbi5wb3dlciB8fCAyMCkgKiBzY2FsZSwgY2FwKTsKCiAgICAgICAgICAgIHN0YXJ0UG9zID0gKGIuc3RhdGUgPT09ICdoZWxkJyAmJiBwICYmIHAubWVzaCkgPyBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMS4yLCAwKSkgOiBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgc3RhcnRWZWwgPSBkaXIubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICBzdGFydFNwaW4gPSBuZXcgVEhSRUUuVmVjdG9yMyhsYWIuY2Fubm9uLnNwaW5YIHx8IDAsIGxhYi5jYW5ub24uc3BpblkgfHwgMCwgbGFiLmNhbm5vbi5zcGluWiB8fCAwKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGdob3N0ID0gbWFrZUdob3N0QmFsbChzdGFydFBvcy5jbG9uZSgpLCBzdGFydFZlbC5jbG9uZSgpLCBzdGFydFNwaW4pOwogICAgICAgIGNvbnN0IHB0cyA9IHNpbXVsYXRlKGdob3N0LCBNYXRoLmZsb29yKGxhYi5wcmV2aWV3LnN0ZXBzIHx8IDEyMCksIChsYWIucHJldmlldy5zdGVwRHQgfHwgKDEvNjApKSk7CgogICAgICAgIGlmIChsYWIucHJldmlld0xpbmUpIHsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCkuc2V0RnJvbVBvaW50cyhwdHMpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IEJhbGwgUGh5c2ljcyAoQmFsbENvbmZpZykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcGh5cyA9IHJvb3QuYWRkRm9sZGVyKCdCYWxsIFBoeXNpY3MgKEJhbGxDb25maWcpJyk7CgogICAgY29uc3QgaW50ZWcgPSBwaHlzLmFkZEZvbGRlcignSW50ZWdyYXRpb24nKTsKICAgIGludGVnLmFkZChDLCAnU1VCU1RFUFMnLCAxLCAxMiwgMSkubmFtZSgnU3Vic3RlcHMnKTsKICAgIGludGVnLmFkZChDLCAnU1RPUF9TUEVFRCcsIDAuMCwgMC4yKS5uYW1lKCdTdG9wIFNwZWVkJyk7CgogICAgY29uc3QgZHJhZyA9IHBoeXMuYWRkRm9sZGVyKCdXYXRlciBEcmFnJyk7CiAgICBkcmFnLmFkZChDLCAnV0FURVJfRFJBR19MSU5FQVInLCAwLjAsIDIuMCkubmFtZSgnTGluZWFyIERyYWcnKTsKICAgIGRyYWcuYWRkKEMsICdXQVRFUl9EUkFHX1FVQUQnLCAwLjAsIDAuMDUpLm5hbWUoJ1F1YWRyYXRpYyBEcmFnJyk7CgogICAgY29uc3Qgc3BpbiA9IHBoeXMuYWRkRm9sZGVyKCdTcGluJyk7CiAgICBzcGluLmFkZChDLCAnU1BJTl9EUkFHJywgMC4wLCAzLjApLm5hbWUoJ1NwaW4gRGVjYXknKTsKCiAgICBjb25zdCBtYWdudXMgPSBwaHlzLmFkZEZvbGRlcignTWFnbnVzJyk7CiAgICBtYWdudXMuYWRkKEMsICdNQUdOVVNfRU5BQkxFRCcpLm5hbWUoJ0VuYWJsZWQnKTsKICAgIG1hZ251cy5hZGQoQywgJ01BR05VU19DT0VGRicsIDAuMCwgMC41KS5uYW1lKCdDb2VmZicpOwogICAgbWFnbnVzLmFkZChDLCAnTUFHTlVTX0NBUCcsIDAuMCwgMjAwLjApLm5hbWUoJ0NhcCcpOwoKICAgIGNvbnN0IGRlcHRoID0gcGh5cy5hZGRGb2xkZXIoJ0RlcHRoIENvbnN0cmFpbnQnKTsKICAgIGRlcHRoLmFkZChDLCAnREVQVEhfVEFSR0VUX1knLCAtNS4wLCA1LjApLm5hbWUoJ1RhcmdldCBZJyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX1NQUklORycsIDAuMCwgMTAuMCkubmFtZSgnU3ByaW5nJyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX0RBTVAnLCAwLjAsIDYuMCkubmFtZSgnRGFtcCcpOwoKICAgIGNvbnN0IGFyZW5hID0gcGh5cy5hZGRGb2xkZXIoJ0FyZW5hIEJvdW5kYXJ5Jyk7CiAgICBhcmVuYS5hZGQoQywgJ0JPVU5EQVJZX1JBRElVUycsIDEwLjAsIDEyMC4wKS5uYW1lKCdSYWRpdXMnKTsKICAgIGFyZW5hLmFkZChDLCAnQk9VTkRBUllfSEVJR0hUJywgMi4wLCA0MC4wKS5uYW1lKCdIZWlnaHQnKTsKYXJlbmEuYWRkKEMsICdCT1VOREFSWV9IRUlHSFQnLCAyLjAsIDQwLjApLm5hbWUoJ0hlaWdodCcpOwogICAgYXJlbmEuYWRkKEMsICdHT0FMX0RJU1RBTkNFJywgMjAuMCwgNjAuMCkubmFtZSgnR29hbCBEaXN0YW5jZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQSkgd2luZG93LmZsdXguZ29hbEEucG9zaXRpb24ueiA9IC12OwogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQikgd2luZG93LmZsdXguZ29hbEIucG9zaXRpb24ueiA9IHY7CiAgICAgICAgLy8gVXBkYXRlIERlYnVnIFZpc3VhbHMgaWYgYWN0aXZlCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZGVidWdWaXN1YWxpemVyKSB7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5kZWJ1Z1Zpc3VhbGl6ZXIudXBkYXRlR29hbFZvbHVtZXMoKTsKICAgICAgICB9CiAgICB9KTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9TT0ZUX0JVRkZFUicsIDAuMCwgMjAuMCkubmFtZSgnU29mdCBCdWZmZXInKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9TT0ZUX0ZPUkNFJywgMC4wLCAyMDAuMCkubmFtZSgnU29mdCBGb3JjZScpOwogICAgYXJlbmEuYWRkKEMsICdXQUxMX0VMQVNUSUNJVFknLCAwLjAsIDEuMCkubmFtZSgnV2FsbCBCb3VuY2UnKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9GUklDVElPTicsIDAuMCwgMS4wKS5uYW1lKCdXYWxsIEZyaWN0aW9uJyk7CiAgICBhcmVuYS5hZGQoQywgJ0ZMT09SX0VMQVNUSUNJVFknLCAwLjAsIDEuMCkubmFtZSgnQ2VpbC9GbG9vciBCb3VuY2UnKTsKCiAgICBjb25zdCBwb2NrZXQgPSBhcmVuYS5hZGRGb2xkZXIoJ0dvYWwgUG9ja2V0Jyk7CiAgICBwb2NrZXQuYWRkKEMsICdHT0FMX1BPQ0tFVF9FTkFCTEVEJykubmFtZSgnRW5hYmxlZCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfWCcsIDAuMCwgNDAuMCkubmFtZSgnUG9ja2V0IEhhbGYtWCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfWicsIDAuMCwgNTAuMCkubmFtZSgnUG9ja2V0IFN0YXJ0IHxafCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfUkFESVVTJywgMTAuMCwgMTIwLjApLm5hbWUoJ1BvY2tldCBSYWRpdXMnKTsKCiAgICBjb25zdCBsYXVuY2ggPSBwaHlzLmFkZEZvbGRlcignTGF1bmNoIE1hcHBpbmcnKTsKICAgIGxhdW5jaC5hZGQoQywgJ0xBVU5DSF9TUEVFRF9TQ0FMRScsIDAuMSwgNS4wKS5uYW1lKCdTcGVlZCBTY2FsZScpOwogICAgbGF1bmNoLmFkZChDLCAnTEFVTkNIX1NQRUVEX0NBUCcsIDEwLjAsIDIwMC4wKS5uYW1lKCdTcGVlZCBDYXAnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogVGhyb3cgbWFwcGluZyAoUGxheWVyLnJlbGVhc2VDaGFyZ2UgLT4gQmFsbC5zaG9vdCkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgdGhyb3dNYXAgPSByb290LmFkZEZvbGRlcignVGhyb3cgTWFwcGluZyAoVGhyb3dDb25maWcpJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdTV0lQRV9NSU5fUFgnLCAwLCAxMjAsIDEpLm5hbWUoJ1N3aXBlIE1pbiBQWCcpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnQUlNX0RYX1NDQUxFJywgMC4xLCA1LjApLm5hbWUoJ0FpbSBYIFNjYWxlJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdBSU1fRFlfU0NBTEUnLCAwLjEsIDUuMCkubmFtZSgnQWltIFkgU2NhbGUnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX0JBU0UnLCAwLjEsIDMuMCkubmFtZSgnUG93ZXIgQmFzZScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnUE9XRVJfUkFOR0UnLCAwLjAsIDMuMCkubmFtZSgnUG93ZXIgUmFuZ2UnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX01BWF9CT05VU19SQVRJTycsIDAuMCwgMS4wKS5uYW1lKCdNYXggQm9udXMgUmF0aW8nKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX01BWF9NVUxUSVBMSUVSJywgMS4wLCA2LjApLm5hbWUoJ01heCBNdWx0aXBsaWVyJyk7CgogICAgY29uc3QgY3VydmVNYXAgPSB0aHJvd01hcC5hZGRGb2xkZXIoJ0N1cnZlJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9FTkFCTEVEJykubmFtZSgnRW5hYmxlZCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRCcsIDAuMCwgMS4wKS5uYW1lKCdJbnB1dCBUaHJlc2hvbGQnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX1NQSU5fU0NBTEUnLCAwLjAsIDQwMDAuMCkubmFtZSgnU3BpbiBTY2FsZScpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfU1BFRURfTVVMVCcsIDAuMCwgNS4wKS5uYW1lKCdTd2lwZSBTcGVlZCBNdWx0Jyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9TUElOX0NBUCcsIDAuMCwgNjAwMC4wKS5uYW1lKCdTcGluIENhcCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfUEVSRkVDVF9TUElOJywgMC4wLCAyMDAwLjApLm5hbWUoJ1BlcmZlY3QgVGhyZXNob2xkJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFRlbGVwb3J0IC8gU3RhdGUgdG9vbHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgdHAgPSByb290LmFkZEZvbGRlcignVGVsZXBvcnQgLyBSZXNldCcpOwogICAgY29uc3QgdHBQYXJhbXMgPSB7CiAgICAgICAgVG9DZW50ZXI6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgaWYgKGIpIGIucmVzZXQoKTsgfSwKICAgICAgICBUb0FjdGl2ZVBsYXllcjogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBjb25zdCBwID0gZ2V0QWN0aXZlKCk7IGlmIChiICYmIHApIGIuZ3JhYihwKTsgfSwKICAgICAgICBUb0hvbWVHb2FsOiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGlmIChiKSB7IGIuZHJvcCgpOyBiLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDI1KTsgYi52ZWxvY2l0eS5zZXQoMCwwLDApOyBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOyB9IH0sCiAgICAgICAgVG9Bd2F5R29hbDogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMjUpOyBiLnZlbG9jaXR5LnNldCgwLDAsMCk7IGIuYW5ndWxhclZlbG9jaXR5LnNldCgwLDAsMCk7IH0gfSwKICAgICAgICBUb1NreTogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAxMCwgMCk7IGIudmVsb2NpdHkuc2V0KDAsMCwwKTsgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsgfSB9LAogICAgICAgIENsZWFyUHJldmlldzogKCkgPT4gY2xlYXJQcmV2aWV3TGluZSgpCiAgICB9OwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9DZW50ZXInKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvQWN0aXZlUGxheWVyJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0hvbWVHb2FsJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0F3YXlHb2FsJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb1NreScpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnQ2xlYXJQcmV2aWV3Jyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFNob3QgQ2Fubm9uIChmb3JjZSBmaXJlIHdpdGggcGFyYW1zKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBjYW5ub24gPSByb290LmFkZEZvbGRlcignU2hvdCBDYW5ub24nKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3lhdycsIC0xODAsIDE4MCwgMSkubmFtZSgnWWF3IChkZWcpJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdwaXRjaCcsIC04OSwgODksIDEpLm5hbWUoJ1BpdGNoIChkZWcpJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdwb3dlcicsIDAsIDEyMCwgMC4xKS5uYW1lKCdQb3dlcicpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAndHlwZScsIFsnUEEnLCdTSCddKS5uYW1lKCdUeXBlJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcGluWCcsIC0zMDAwLCAzMDAwLCAxKS5uYW1lKCdTcGluIFgnKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwaW5ZJywgLTMwMDAsIDMwMDAsIDEpLm5hbWUoJ1NwaW4gWScpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnc3BpblonLCAtMzAwMCwgMzAwMCwgMSkubmFtZSgnU3BpbiBaJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdmaXJlQnVyc3QnLCAxLCAxMCwgMSkubmFtZSgnQnVyc3QgQ291bnQnKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwcmVhZERlZycsIDAsIDMwLCAwLjUpLm5hbWUoJ1NwcmVhZCAoZGVnKScpOwoKICAgIGNvbnN0IGZpcmVQYXJhbXMgPSB7CiAgICAgICAgRmlyZTogKCkgPT4gewogICAgICAgICAgICBjb25zdCBiID0gZ2V0QmFsbCgpOwogICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgIGlmICghYikgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgeWF3UmFkID0gKGxhYi5jYW5ub24ueWF3IHx8IDApICogTWF0aC5QSSAvIDE4MDsKICAgICAgICAgICAgY29uc3QgcGl0Y2hSYWQgPSAobGFiLmNhbm5vbi5waXRjaCB8fCAwKSAqIE1hdGguUEkgLyAxODA7CgogICAgICAgICAgICBjb25zdCBiYXNlRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICBNYXRoLnNpbih5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpLAogICAgICAgICAgICAgICAgTWF0aC5zaW4ocGl0Y2hSYWQpLAogICAgICAgICAgICAgICAgLU1hdGguY29zKHlhd1JhZCkgKiBNYXRoLmNvcyhwaXRjaFJhZCkKICAgICAgICAgICAgKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gKGIuc3RhdGUgPT09ICdoZWxkJyAmJiBwICYmIHAubWVzaCkgPyBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMS4yLCAwKSkgOiBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKCiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgKGxhYi5jYW5ub24uZmlyZUJ1cnN0IHx8IDEpOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IGJhc2VEaXIuY2xvbmUoKTsKICAgICAgICAgICAgICAgIGlmIChsYWIuY2Fubm9uLnNwcmVhZERlZyA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcHJlYWQgPSAobGFiLmNhbm5vbi5zcHJlYWREZWcgKiBNYXRoLlBJIC8gMTgwKTsKICAgICAgICAgICAgICAgICAgICBkaXIueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogc3ByZWFkOwogICAgICAgICAgICAgICAgICAgIGRpci55ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcHJlYWQ7CiAgICAgICAgICAgICAgICAgICAgZGlyLnogKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIHNwcmVhZDsKICAgICAgICAgICAgICAgICAgICBkaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYi5kcm9wKCk7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24uY29weShzdGFydCk7CiAgICAgICAgICAgICAgICBiLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOwoKICAgICAgICAgICAgICAgIGNvbnN0IHNwaW4gPSBuZXcgVEhSRUUuVmVjdG9yMyhsYWIuY2Fubm9uLnNwaW5YIHx8IDAsIGxhYi5jYW5ub24uc3BpblkgfHwgMCwgbGFiLmNhbm5vbi5zcGluWiB8fCAwKTsKICAgICAgICAgICAgICAgIGIuc2hvb3QoZGlyLCBsYWIuY2Fubm9uLnBvd2VyIHx8IDIwLCBsYWIuY2Fubm9uLnR5cGUgfHwgJ1NIJywgbnVsbCwgc3Bpbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgY2Fubm9uLmFkZChmaXJlUGFyYW1zLCAnRmlyZScpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBUcmFqZWN0b3J5IFByZXZpZXcKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcHJldmlldyA9IHJvb3QuYWRkRm9sZGVyKCdUcmFqZWN0b3J5IFByZXZpZXcnKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnZW5hYmxlZCcpLm5hbWUoJ0VuYWJsZWQnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3NvdXJjZScsIFsnQ2Fubm9uJywgJ0xpdmUgQmFsbCddKS5uYW1lKCdTb3VyY2UnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3N0ZXBzJywgMTAsIDYwMCwgMSkubmFtZSgnU3RlcHMnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3N0ZXBEdCcsIDEvMjQwLCAxLzE1LCAxLzI0MCkubmFtZSgnU3RlcCBkdCcpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAncmVmcmVzaEh6JywgMSwgNjAsIDEpLm5hbWUoJ1JlZnJlc2ggSHonKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc2hvd09uSGVsZE9ubHknKS5uYW1lKCdPbmx5IHdoZW4gSGVsZCcpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKCiAgICBjb25zdCBwcmV2aWV3QnRucyA9IHsKICAgICAgICBSZWZyZXNoOiAoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSwKICAgICAgICBIaWRlOiAoKSA9PiB7IGxhYi5wcmV2aWV3LmVuYWJsZWQgPSBmYWxzZTsgY2xlYXJQcmV2aWV3TGluZSgpOyB9CiAgICB9OwogICAgcHJldmlldy5hZGQocHJldmlld0J0bnMsICdSZWZyZXNoJyk7CiAgICBwcmV2aWV3LmFkZChwcmV2aWV3QnRucywgJ0hpZGUnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogUmVjb3JkIC8gUmVwbGF5CiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHJyID0gcm9vdC5hZGRGb2xkZXIoJ1JlY29yZCAvIFJlcGxheScpOwogICAgY29uc3QgcnJQYXJhbXMgPSB7CiAgICAgICAgUmVjb3JkOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcgPSB0cnVlOwogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmZyYW1lcyA9IFtdOwogICAgICAgIH0sCiAgICAgICAgU3RvcDogKCkgPT4gewogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmlzUmVjb3JkaW5nID0gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICBVc2VSZWNvcmRpbmdGb3JSZXBsYXk6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlcGxheS5mcmFtZXMgPSAobGFiLnJlY29yZGluZy5mcmFtZXMgfHwgW10pLnNsaWNlKCk7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaWR4ID0gMDsKICAgICAgICB9LAogICAgICAgIFBsYXk6ICgpID0+IHsKICAgICAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICAgICAgaWYgKCFiKSByZXR1cm47CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaXNSZXBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICBsYWIudGFyZ2V0QmFsbCA9IGI7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaWR4ID0gMDsKICAgICAgICB9LAogICAgICAgIFBhdXNlOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgbGFiLmlzUmVwbGF5aW5nID0gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICBDbGVhcjogKCkgPT4gewogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmZyYW1lcyA9IFtdOwogICAgICAgICAgICBsYWIucmVwbGF5LmZyYW1lcyA9IFtdOwogICAgICAgICAgICBsYWIucmVwbGF5LmlkeCA9IDA7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgbGFiLmlzUmVwbGF5aW5nID0gZmFsc2U7CiAgICAgICAgfQogICAgfTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1JlY29yZCcpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnU3RvcCcpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnVXNlUmVjb3JkaW5nRm9yUmVwbGF5JykubmFtZSgnQ29weSBSZWMgLT4gUmVwbGF5Jyk7CiAgICByci5hZGQobGFiLnJlcGxheSwgJ2xvb3AnKS5uYW1lKCdMb29wJyk7CiAgICByci5hZGQobGFiLnJlcGxheSwgJ3NwZWVkJywgMC4yNSwgNi4wLCAwLjI1KS5uYW1lKCdSZXBsYXkgU3BlZWQnKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1BsYXknKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1BhdXNlJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdDbGVhcicpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBQcmVzZXRzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHByZXNldHMgPSByb290LmFkZEZvbGRlcignUHJlc2V0cycpOwogICAgY29uc3QgUCA9IHsKICAgICAgICBWYW5pbGxhOiAoKSA9PiB7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oQywgewogICAgICAgICAgICAgICAgU1VCU1RFUFM6IDIsCiAgICAgICAgICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMTUsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX1FVQUQ6IDAuMDAyLAogICAgICAgICAgICAgICAgU1BJTl9EUkFHOiAwLjQwLAogICAgICAgICAgICAgICAgTUFHTlVTX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ09FRkY6IDAuMDgsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ0FQOiA2MC4wLAogICAgICAgICAgICAgICAgREVQVEhfVEFSR0VUX1k6IDAuMCwKICAgICAgICAgICAgICAgIERFUFRIX1NQUklORzogMS4wLAogICAgICAgICAgICAgICAgREVQVEhfREFNUDogMS41LAogICAgICAgICAgICAgICAgQk9VTkRBUllfUkFESVVTOiAzMy4wLAogICAgICAgICAgICAgICAgQk9VTkRBUllfSEVJR0hUOiAxNS4wLAogICAgICAgICAgICAgICAgV0FMTF9TT0ZUX0JVRkZFUjogMy4wLAogICAgICAgICAgICAgICAgV0FMTF9TT0ZUX0ZPUkNFOiAyMC4wLAogICAgICAgICAgICAgICAgV0FMTF9FTEFTVElDSVRZOiAwLjMwLAogICAgICAgICAgICAgICAgV0FMTF9GUklDVElPTjogMC45NSwKICAgICAgICAgICAgICAgIEZMT09SX0VMQVNUSUNJVFk6IDAuNDAsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgR09BTF9QT0NLRVRfWDogMTIuMCwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX1o6IDI1LjAsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9SQURJVVM6IDQ1LjAsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfU0NBTEU6IDEuMCwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDg1LjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0sCiAgICAgICAgQXJjYWRlQ3VydmU6ICgpID0+IHsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihDLCB7CiAgICAgICAgICAgICAgICBNQUdOVVNfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIE1BR05VU19DT0VGRjogMC4xNiwKICAgICAgICAgICAgICAgIE1BR05VU19DQVA6IDkwLjAsCiAgICAgICAgICAgICAgICBTUElOX0RSQUc6IDAuMjUsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX0xJTkVBUjogMC4xMiwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDEsCiAgICAgICAgICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDM1LjAsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfQ0FQOiAxMTAuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihUQywgewogICAgICAgICAgICAgICAgQ1VSVkVfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIENVUlZFX1NQSU5fU0NBTEU6IDE1MDAuMCwKICAgICAgICAgICAgICAgIENVUlZFX1NQSU5fQ0FQOiAzMDAwLjAsCiAgICAgICAgICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDcwMC4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsYWIucmVmcmVzaFByZXZpZXcoKTsKICAgICAgICB9LAogICAgICAgIFNuYXBweVJlYWxpc3RpYzogKCkgPT4gewogICAgICAgICAgICBPYmplY3QuYXNzaWduKEMsIHsKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfTElORUFSOiAwLjI1LAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19RVUFEOiAwLjAwNiwKICAgICAgICAgICAgICAgIE1BR05VU19DT0VGRjogMC4wNSwKICAgICAgICAgICAgICAgIE1BR05VU19DQVA6IDQwLjAsCiAgICAgICAgICAgICAgICBTUElOX0RSQUc6IDAuNzUsCiAgICAgICAgICAgICAgICBTVE9QX1NQRUVEOiAwLjA1LAogICAgICAgICAgICAgICAgTEFVTkNIX1NQRUVEX0NBUDogNzAuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfQogICAgfTsKICAgIHByZXNldHMuYWRkKFAsICdWYW5pbGxhJyk7CiAgICBwcmVzZXRzLmFkZChQLCAnQXJjYWRlQ3VydmUnKTsKICAgIHByZXNldHMuYWRkKFAsICdTbmFwcHlSZWFsaXN0aWMnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogU25hcHNob3QgLyBFeHBvcnQKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3Qgc25hcHNob3QgPSByb290LmFkZEZvbGRlcignU25hcHNob3QgLyBFeHBvcnQnKTsKCiAgICBjb25zdCBfcm91bmQgPSAobiwgcGxhY2VzID0gNCkgPT4gewogICAgICAgIGlmICghTnVtYmVyLmlzRmluaXRlKG4pKSByZXR1cm4gbnVsbDsKICAgICAgICBjb25zdCBwID0gTWF0aC5wb3coMTAsIHBsYWNlcyk7CiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQobiAqIHApIC8gcDsKICAgIH07CgogICAgY29uc3QgX3YzID0gKHYsIHBsYWNlcyA9IDQpID0+IHsKICAgICAgICBpZiAoIXYpIHJldHVybiBudWxsOwogICAgICAgIHJldHVybiBbX3JvdW5kKHYueCwgcGxhY2VzKSwgX3JvdW5kKHYueSwgcGxhY2VzKSwgX3JvdW5kKHYueiwgcGxhY2VzKV07CiAgICB9OwoKICAgIGNvbnN0IF9jbG9uZUpzb24gPSAob2JqKSA9PiB7CiAgICAgICAgaWYgKCFvYmopIHJldHVybiBudWxsOwogICAgICAgIHRyeSB7IHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KG9iaikpOyB9IGNhdGNoIChlKSB7IHJldHVybiBudWxsOyB9CiAgICB9OwoKICAgIGNvbnN0IF9wbGF5ZXJTbmFwID0gKHApID0+IHsKICAgICAgICBpZiAoIXApIHJldHVybiBudWxsOwogICAgICAgIGNvbnN0IGFuaW0gPSAocC5hY3RpdmVBY3Rpb24gJiYgcC5hY3RpdmVBY3Rpb24uX2NsaXApID8gcC5hY3RpdmVBY3Rpb24uX2NsaXAubmFtZSA6IChwLnN0YXRlIHx8IG51bGwpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG5hbWU6IHAuY2hhcmFjdGVyTmFtZSB8fCBwLm5hbWUgfHwgbnVsbCwKICAgICAgICAgICAgcm9sZTogcC5yb2xlIHx8IG51bGwsCiAgICAgICAgICAgIHN0YXRlOiBwLnN0YXRlIHx8IG51bGwsCiAgICAgICAgICAgIGhhc0JhbGw6ICEhcC5oYXNCYWxsLAogICAgICAgICAgICBpc1Rocm93aW5nOiAhIXAuaXNUaHJvd2luZywKICAgICAgICAgICAgaXNDaGFyZ2luZzogISFwLmlzQ2hhcmdpbmcsCiAgICAgICAgICAgIGlzRGFzaGluZzogISFwLmlzRGFzaGluZywKICAgICAgICAgICAgZGFzaENvb2xkb3duOiBfcm91bmQocC5kYXNoQ29vbGRvd24sIDQpLAogICAgICAgICAgICBwb3M6IF92MyhwLm1lc2ggJiYgcC5tZXNoLnBvc2l0aW9uKSwKICAgICAgICAgICAgdmVsOiBfdjMocC52ZWxvY2l0eSksCiAgICAgICAgICAgIGlucHV0OiBfdjMocC5pbnB1dFZlY3RvciksCiAgICAgICAgICAgIHN0YXRzOiBwLnN0YXRzID8gX2Nsb25lSnNvbihwLnN0YXRzKSA6IG51bGwsCiAgICAgICAgICAgIGFuaW0KICAgICAgICB9OwogICAgfTsKCiAgICBjb25zdCBfdGVhbVNuYXAgPSAodCkgPT4gewogICAgICAgIGlmICghdCkgcmV0dXJuIG51bGw7CiAgICAgICAgY29uc3QgYWN0aXZlID0gdC5hY3RpdmVQbGF5ZXIgPyBfcGxheWVyU25hcCh0LmFjdGl2ZVBsYXllcikgOiBudWxsOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGlkOiB0LmlkIHx8IG51bGwsCiAgICAgICAgICAgIHNpZGU6IHQuc2lkZSwKICAgICAgICAgICAgaXNIdW1hbjogISF0LmlzSHVtYW4sCiAgICAgICAgICAgIGFpRW5hYmxlZDogISF0LmFpRW5hYmxlZCwKICAgICAgICAgICAgY3VycmVudEZvcm1hdGlvbjogdC5jdXJyZW50Rm9ybWF0aW9uIHx8IG51bGwsCiAgICAgICAgICAgIGFjdGl2ZVBsYXllcjogYWN0aXZlLAogICAgICAgICAgICBwbGF5ZXJzOiBBcnJheS5pc0FycmF5KHQucGxheWVycykgPyB0LnBsYXllcnMubWFwKF9wbGF5ZXJTbmFwKSA6IFtdCiAgICAgICAgfTsKICAgIH07CgogICAgY29uc3QgYnVpbGRTbmFwc2hvdCA9ICgpID0+IHsKICAgICAgICBjb25zdCBnYW1lID0gdGhpcy5nYW1lIHx8IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSB8fCBudWxsOwogICAgICAgIGNvbnN0IGJhbGwgPSBnYW1lICYmIGdhbWUuZW50aXRpZXMgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgIGNvbnN0IGNhbU1nciA9IGdhbWUgPyBnYW1lLmNhbWVyYU1hbmFnZXIgOiBudWxsOwogICAgICAgIGNvbnN0IGNhbSA9IChjYW1NZ3IgJiYgY2FtTWdyLmNhbWVyYSkgPyBjYW1NZ3IuY2FtZXJhIDogKGdhbWUgPyBnYW1lLmNhbWVyYSA6IG51bGwpOwoKICAgICAgICBjb25zdCBiYWxsU25hcCA9IGJhbGwgPyB7CiAgICAgICAgICAgIHN0YXRlOiBiYWxsLnN0YXRlIHx8IG51bGwsCiAgICAgICAgICAgIGlzSW52aXNpYmxlOiAhIWJhbGwuaXNJbnZpc2libGUsCiAgICAgICAgICAgIGhvbGRlcjogYmFsbC5ob2xkZXIgPyAoYmFsbC5ob2xkZXIuY2hhcmFjdGVyTmFtZSB8fCBiYWxsLmhvbGRlci5uYW1lIHx8IG51bGwpIDogbnVsbCwKICAgICAgICAgICAgbGFzdEhvbGRlcjogYmFsbC5sYXN0SG9sZGVyID8gKGJhbGwubGFzdEhvbGRlci5jaGFyYWN0ZXJOYW1lIHx8IGJhbGwubGFzdEhvbGRlci5uYW1lIHx8IG51bGwpIDogbnVsbCwKICAgICAgICAgICAgcG9zOiBfdjMoYmFsbC5tZXNoICYmIGJhbGwubWVzaC5wb3NpdGlvbiksCiAgICAgICAgICAgIHZlbDogX3YzKGJhbGwudmVsb2NpdHkpLAogICAgICAgICAgICBhbmdWZWw6IF92MyhiYWxsLmFuZ3VsYXJWZWxvY2l0eSksCiAgICAgICAgICAgIHBvd2VyOiBfcm91bmQoYmFsbC5wb3dlciwgNCksCiAgICAgICAgICAgIHNob3RUeXBlOiBiYWxsLnNob3RUeXBlIHx8IG51bGwKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgY29uc3QgY2FtZXJhU25hcCA9IGNhbSA/IHsKICAgICAgICAgICAgcG9zOiBfdjMoY2FtLnBvc2l0aW9uKSwKICAgICAgICAgICAgcm90OiBjYW0ucm90YXRpb24gPyBbX3JvdW5kKGNhbS5yb3RhdGlvbi54LCA0KSwgX3JvdW5kKGNhbS5yb3RhdGlvbi55LCA0KSwgX3JvdW5kKGNhbS5yb3RhdGlvbi56LCA0KV0gOiBudWxsLAogICAgICAgICAgICBmb3Y6IF9yb3VuZChjYW0uZm92LCA0KSwKICAgICAgICAgICAgbmVhcjogX3JvdW5kKGNhbS5uZWFyLCA2KSwKICAgICAgICAgICAgZmFyOiBfcm91bmQoY2FtLmZhciwgNCkKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgY29uc3QgY2FtTWdyU25hcCA9IGNhbU1nciA/IHsKICAgICAgICAgICAgbW9kZTogY2FtTWdyLm1vZGUgfHwgbnVsbCwKICAgICAgICAgICAgdGFyZ2V0TmFtZTogKGNhbU1nci50YXJnZXQgJiYgKGNhbU1nci50YXJnZXQuY2hhcmFjdGVyTmFtZSB8fCBjYW1NZ3IudGFyZ2V0Lm5hbWUpKSB8fCBudWxsLAogICAgICAgICAgICBzZXR0aW5nczogY2FtTWdyLnNldHRpbmdzID8gX2Nsb25lSnNvbihjYW1NZ3Iuc2V0dGluZ3MpIDogbnVsbAogICAgICAgIH0gOiBudWxsOwoKICAgICAgICBjb25zdCBkZWJ1Z0lPID0gd2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX2RlYnVnSU8gPyB3aW5kb3cuZmx1eC5fZGVidWdJTyA6IG51bGw7CiAgICAgICAgY29uc3QgaW5wdXRTbmFwID0gZGVidWdJTyA/IHsKICAgICAgICAgICAgc2V0dGluZ3M6IGRlYnVnSU8uc2V0dGluZ3MgPyBfY2xvbmVKc29uKGRlYnVnSU8uc2V0dGluZ3MpIDogbnVsbCwKICAgICAgICAgICAgcGVyZjogZGVidWdJTy5wZXJmID8gX2Nsb25lSnNvbihkZWJ1Z0lPLnBlcmYpIDogbnVsbCwKICAgICAgICAgICAgbW92ZTogKGRlYnVnSU8uaW5wdXQgJiYgZGVidWdJTy5pbnB1dC5tb3ZlKSA/IHsKICAgICAgICAgICAgICAgIHRvdWNoSWQ6IGRlYnVnSU8uaW5wdXQubW92ZS50b3VjaElkID8/IG51bGwsCiAgICAgICAgICAgICAgICBkcmFnZ2luZzogISFkZWJ1Z0lPLmlucHV0Lm1vdmUuZHJhZ2dpbmcsCiAgICAgICAgICAgICAgICB2ZWN0b3I6IGRlYnVnSU8uaW5wdXQubW92ZS52ZWN0b3IgPyBfY2xvbmVKc29uKGRlYnVnSU8uaW5wdXQubW92ZS52ZWN0b3IpIDogbnVsbAogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgYWltOiAoZGVidWdJTy5pbnB1dCAmJiBkZWJ1Z0lPLmlucHV0LmFpbSkgPyB7CiAgICAgICAgICAgICAgICB0b3VjaElkOiBkZWJ1Z0lPLmlucHV0LmFpbS50b3VjaElkID8/IG51bGwsCiAgICAgICAgICAgICAgICBkcmFnZ2luZzogISFkZWJ1Z0lPLmlucHV0LmFpbS5kcmFnZ2luZywKICAgICAgICAgICAgICAgIHZlY3RvcjogZGVidWdJTy5pbnB1dC5haW0udmVjdG9yID8gX2Nsb25lSnNvbihkZWJ1Z0lPLmlucHV0LmFpbS52ZWN0b3IpIDogbnVsbAogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgc3dpcGU6IChkZWJ1Z0lPLmlucHV0ICYmIGRlYnVnSU8uaW5wdXQuc3dpcGUpID8gewogICAgICAgICAgICAgICAgdG91Y2hJZDogZGVidWdJTy5pbnB1dC5zd2lwZS50b3VjaElkID8/IG51bGwsCiAgICAgICAgICAgICAgICBzdGFydDogZGVidWdJTy5pbnB1dC5zd2lwZS5zdGFydCA/IF9jbG9uZUpzb24oZGVidWdJTy5pbnB1dC5zd2lwZS5zdGFydCkgOiBudWxsLAogICAgICAgICAgICAgICAgcG9pbnRzOiBBcnJheS5pc0FycmF5KGRlYnVnSU8uaW5wdXQuc3dpcGUucG9pbnRzKSA/IGRlYnVnSU8uaW5wdXQuc3dpcGUucG9pbnRzLnNsaWNlKC0zMikubWFwKF9jbG9uZUpzb24pIDogW10KICAgICAgICAgICAgfSA6IG51bGwKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbWV0YTogewogICAgICAgICAgICAgICAgdGltZXN0YW1wSVNPOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksCiAgICAgICAgICAgICAgICBocmVmOiAodHlwZW9mIGxvY2F0aW9uICE9PSAndW5kZWZpbmVkJyAmJiBsb2NhdGlvbi5ocmVmKSA/IGxvY2F0aW9uLmhyZWYgOiBudWxsLAogICAgICAgICAgICAgICAgdXNlckFnZW50OiAodHlwZW9mIG5hdmlnYXRvciAhPT0gJ3VuZGVmaW5lZCcgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudCkgPyBuYXZpZ2F0b3IudXNlckFnZW50IDogbnVsbAogICAgICAgICAgICB9LAogICAgICAgICAgICBnYW1lOiBnYW1lID8gewogICAgICAgICAgICAgICAgc2NvcmU6IGdhbWUuc2NvcmUgPyBfY2xvbmVKc29uKGdhbWUuc2NvcmUpIDogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWU6IF9yb3VuZChnYW1lLnRpbWUsIDQpLAogICAgICAgICAgICAgICAgaGFsZjogZ2FtZS5oYWxmID8/IG51bGwsCiAgICAgICAgICAgICAgICBoYWxmRHVyYXRpb246IF9yb3VuZChnYW1lLmhhbGZEdXJhdGlvbiwgNCksCiAgICAgICAgICAgICAgICBpc092ZXJ0aW1lOiAhIWdhbWUuaXNPdmVydGltZSwKICAgICAgICAgICAgICAgIGlzRGVtb01vZGU6ICEhZ2FtZS5pc0RlbW9Nb2RlCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBjb25maWc6IHsKICAgICAgICAgICAgICAgIEJhbGxDb25maWc6ICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnKSA/IF9jbG9uZUpzb24od2luZG93LmZsdXguQmFsbENvbmZpZykgOiBudWxsLAogICAgICAgICAgICAgICAgVGhyb3dDb25maWc6ICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZykgPyBfY2xvbmVKc29uKHdpbmRvdy5mbHV4LlRocm93Q29uZmlnKSA6IG51bGwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2FtZXJhOiBjYW1lcmFTbmFwLAogICAgICAgICAgICBjYW1lcmFNYW5hZ2VyOiBjYW1NZ3JTbmFwLAogICAgICAgICAgICBiYWxsOiBiYWxsU25hcCwKICAgICAgICAgICAgdGVhbXM6IGdhbWUgPyB7CiAgICAgICAgICAgICAgICBob21lOiBfdGVhbVNuYXAoZ2FtZS50ZWFtcyAmJiBnYW1lLnRlYW1zLmhvbWUpLAogICAgICAgICAgICAgICAgYXdheTogX3RlYW1TbmFwKGdhbWUudGVhbXMgJiYgZ2FtZS50ZWFtcy5hd2F5KQogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgaW5wdXQ6IGlucHV0U25hcAogICAgICAgIH07CiAgICB9OwoKICAgIGNvbnN0IF9jb3B5VGV4dCA9IGFzeW5jICh0ZXh0KSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKG5hdmlnYXRvci5jbGlwYm9hcmQgJiYgbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQpIHsKICAgICAgICAgICAgICAgIGF3YWl0IG5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KHRleHQpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIC8vIEZhbGxiYWNrCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgdGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZXh0YXJlYScpOwogICAgICAgICAgICB0YS52YWx1ZSA9IHRleHQ7CiAgICAgICAgICAgIHRhLnN0eWxlLnBvc2l0aW9uID0gJ2ZpeGVkJzsKICAgICAgICAgICAgdGEuc3R5bGUubGVmdCA9ICctOTk5OXB4JzsKICAgICAgICAgICAgdGEuc3R5bGUudG9wID0gJy05OTk5cHgnOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRhKTsKICAgICAgICAgICAgdGEuZm9jdXMoKTsKICAgICAgICAgICAgdGEuc2VsZWN0KCk7CiAgICAgICAgICAgIGNvbnN0IG9rID0gZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0YSk7CiAgICAgICAgICAgIHJldHVybiBvazsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CgogICAgY29uc3QgX2Rvd25sb2FkVGV4dCA9IChmaWxlbmFtZSwgdGV4dCkgPT4gewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbdGV4dF0sIHsgdHlwZTogJ2FwcGxpY2F0aW9uL2pzb24nIH0pOwogICAgICAgICAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOwogICAgICAgICAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgICAgICBhLmhyZWYgPSB1cmw7CiAgICAgICAgICAgIGEuZG93bmxvYWQgPSBmaWxlbmFtZTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhKTsKICAgICAgICAgICAgYS5jbGljaygpOwogICAgICAgICAgICBhLnJlbW92ZSgpOwogICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKHVybCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1NuYXBzaG90IGRvd25sb2FkIGZhaWxlZDonLCBlKTsKICAgICAgICB9CiAgICB9OwoKICAgIGNvbnN0IHNuYXBzaG90QWN0aW9ucyA9IHsKICAgICAgICBDb3B5U25hcHNob3Q6IGFzeW5jICgpID0+IHsKICAgICAgICAgICAgY29uc3Qgc25hcCA9IGJ1aWxkU25hcHNob3QoKTsKICAgICAgICAgICAgY29uc3QgdGV4dCA9IEpTT04uc3RyaW5naWZ5KHNuYXAsIG51bGwsIDIpOwogICAgICAgICAgICBjb25zdCBvayA9IGF3YWl0IF9jb3B5VGV4dCh0ZXh0KTsKICAgICAgICAgICAgY29uc29sZS5sb2coJ1tTbmFwc2hvdF0nLCBzbmFwKTsKICAgICAgICAgICAgaWYgKCFvaykgY29uc29sZS53YXJuKCdTbmFwc2hvdDogY29weSBmYWlsZWQgKHNlZSBjb25zb2xlKS4nKTsKICAgICAgICB9LAogICAgICAgIERvd25sb2FkU25hcHNob3Q6ICgpID0+IHsKICAgICAgICAgICAgY29uc3Qgc25hcCA9IGJ1aWxkU25hcHNob3QoKTsKICAgICAgICAgICAgY29uc3QgdGV4dCA9IEpTT04uc3RyaW5naWZ5KHNuYXAsIG51bGwsIDIpOwogICAgICAgICAgICBfZG93bmxvYWRUZXh0KCdzbmFwc2hvdC5qc29uJywgdGV4dCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbU25hcHNob3RdJywgc25hcCk7CiAgICAgICAgfQogICAgfTsKCiAgICBzbmFwc2hvdC5hZGQoc25hcHNob3RBY3Rpb25zLCAnQ29weVNuYXBzaG90JykubmFtZSgnQ29weSBKU09OIFNuYXBzaG90Jyk7CiAgICBzbmFwc2hvdC5hZGQoc25hcHNob3RBY3Rpb25zLCAnRG93bmxvYWRTbmFwc2hvdCcpLm5hbWUoJ0Rvd25sb2FkIHNuYXBzaG90Lmpzb24nKTsKCn0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5EZXZUb29scyA9IERldlRvb2xzOwoKICAgIERldlRvb2xzLnByb3RvdHlwZS5fc2V0dXBWaXN1YWxEZWJ1ZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignVmlzdWFsIERlYnVnZ2luZycpOwogICAgICAgIGNvbnN0IGR2ID0gdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcjsKICAgICAgICBpZiAoIWR2KSByZXR1cm47Cgpjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIGVuYWJsZWQ6IGR2LmVuYWJsZWQsCiAgICAgICAgICAgIGhpdGJveGVzOiBkdi5zaG93SGl0Ym94ZXMsCiAgICAgICAgICAgIHZlY3RvcnM6IGR2LnNob3dWZWN0b3JzLAogICAgICAgICAgICBhaTogZHYuc2hvd0FJLAogICAgICAgICAgICBnb2FsVm9sdW1lOiBkdi5zaG93R29hbFZvbHVtZQogICAgICAgIH07CgogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZW5hYmxlZCcpLm5hbWUoJ0VuYWJsZSBWaXN1YWxpemVyJykub25DaGFuZ2UodiA9PiBkdi5lbmFibGVkID0gdik7CiAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdoaXRib3hlcycpLm5hbWUoJ1Nob3cgSGl0Ym94ZXMnKS5vbkNoYW5nZSh2ID0+IGR2LnNob3dIaXRib3hlcyA9IHYpOwogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndmVjdG9ycycpLm5hbWUoJ1Nob3cgVmVjdG9ycycpLm9uQ2hhbmdlKHYgPT4gZHYuc2hvd1ZlY3RvcnMgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2FpJykubmFtZSgnU2hvdyBBSSBQZXJjZXB0aW9uJykub25DaGFuZ2UodiA9PiBkdi5zaG93QUkgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2dvYWxWb2x1bWUnKS5uYW1lKCdTaG93IEdvYWwgVm9sdW1lJykub25DaGFuZ2UodiA9PiBkdi5zaG93R29hbFZvbHVtZSA9IHYpOwogICAgfTsKCiAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwRlhMYWIgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0ZYIExhYiAmIFVJIFRlc3QnKTsKICAgICAgICAKICAgICAgICBjb25zdCBnZXRUYXJnZXRQb3MgPSAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIHJldHVybiBwICYmIHAubWVzaCA/IHAubWVzaC5wb3NpdGlvbiA6IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDIsIDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGZ4UGFyYW1zID0gewogICAgICAgICAgICBTcGF3blZlbm9tOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCd2ZW5vbScsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25OYXA6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ25hcCcsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25XaXRoZXI6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3dpdGhlcicsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25MZWFybmVkOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bkNsYXNoOiAoKSA9PiB0aGlzLmdhbWUuc3Bhd25DbGFzaChnZXRUYXJnZXRQb3MoKSksCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgZnhTdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdQYXJ0aWNsZXMnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3blZlbm9tJyk7CiAgICAgICAgZnhTdWIuYWRkKGZ4UGFyYW1zLCAnU3Bhd25OYXAnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3bldpdGhlcicpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduTGVhcm5lZCcpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduQ2xhc2gnKTsKCiAgICAgICAgY29uc3QgdHh0UGFyYW1zID0gewogICAgICAgICAgICBUZXh0OiAiVEVTVCIsCiAgICAgICAgICAgIFR5cGU6ICJkYW1hZ2UiLAogICAgICAgICAgICBTcGF3bjogKCkgPT4gewogICAgICAgICAgICAgICAgaWYodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bih0eHRQYXJhbXMuVGV4dCwgZ2V0VGFyZ2V0UG9zKCksIHR4dFBhcmFtcy5UeXBlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgY29uc3QgdHh0U3ViID0gZm9sZGVyLmFkZEZvbGRlcignRmxvYXRpbmcgVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVHlwZScsIFsnZGFtYWdlJywgJ2hlYWwnLCAnc3RhdHVzJywgJ3RlY2gnLCAnY29taWMtaW1wYWN0JywgJ2NvbWljLWFjdGlvbicsICdzYXZlJywgJ2Jsb2NrJywgJ2RlZmF1bHQnXSk7CiAgICAgICAgdHh0U3ViLmFkZCh0eHRQYXJhbXMsICdTcGF3bicpLm5hbWUoJ1NwYXduIFRleHQnKTsKCiAgICAgICAgY29uc3QgY2FtUGFyYW1zID0gewogICAgICAgICAgICBTaGFrZVNtYWxsOiAoKSA9PiB0aGlzLmdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpLAogICAgICAgICAgICBTaGFrZUJpZzogKCkgPT4gdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMi4wKSwKICAgICAgICAgICAgSW1wYWN0TGlnaHQ6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMSwgJ2RlZmF1bHQnKSwKICAgICAgICAgICAgSW1wYWN0SGVhdnk6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMiwgJ2hlYXZ5JyksCiAgICAgICAgICAgIEltcGFjdFNoYXR0ZXI6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuNCwgJ3NoYXR0ZXInKSwKICAgICAgICB9OwoKICAgICAgICBjb25zdCBjYW1TdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdDYW1lcmEgJiBJbXBhY3QnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlU21hbGwnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlQmlnJyk7CiAgICAgICAgY2FtU3ViLmFkZChjYW1QYXJhbXMsICdJbXBhY3RMaWdodCcpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnSW1wYWN0SGVhdnknKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ0ltcGFjdFNoYXR0ZXInKTsKICAgIH07CgoKRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFZpc3VhbHMgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0Fzc2V0IEZvcmdlJyk7CiAgICAgICAgCiAgICAgICAgY29uc3QgZm9yZ2VTdGF0ZSA9IHsKICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgYXNzZXROYW1lOiAnVGlkdXMnLAogICAgICAgICAgICBhbmltTmFtZTogJ2lkbGUnLAogICAgICAgICAgICBwb3NYOiAwLCBwb3NZOiAwLCBwb3NaOiAwLAogICAgICAgICAgICByb3RYOiAwLCByb3RZOiAwLCByb3RaOiAwLAogICAgICAgICAgICBzY2FsZTogMS4wLAogICAgICAgICAgICBjYW1EaXN0OiA1LCBjYW1IZWlnaHQ6IDEuNSwgY2FtUm90OiAwCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgYXNzZXRzID0gewogICAgICAgICAgICAnVGlkdXMnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2RhNzg4YmVmMjU4YzRmMGI4ZDllZjFhY2MxOWM1NTY3LmdsYicsCiAgICAgICAgICAgICdXYWtrYSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJywKICAgICAgICAgICAgJ0xldHR5JzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy80M2FjZTM0YzZmZDk0MjE1OTY3ZTg0MmJmOTA5ZGE1ZS5nbGInLAogICAgICAgICAgICAnRGF0dG8nOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2U2ZDY3ZWNiMmU0YzQ3MTViZDczYTQwNzk1ZTFkM2Q1LmdsYicsCiAgICAgICAgICAgICdKYXNzdSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJywKICAgICAgICAgICAgJ0JvdHRhJzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hZDE1NWVmZWRjMGQ0OGZkYWQwOWRhM2UxY2FlOWM5Ny5nbGInLAogICAgICAgICAgICAnQmFsbCc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTIxYWU4Nzg4ZTU4NGUzNzhhNzlkOTczMmEwNzUzNTYuZ2xiJywKICAgICAgICAgICAgJ0dvYWwnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2E1MTZiZDkwZmE3YzRkZWRiNWRjYmZkZjgwM2YxM2Q1LmdsYicKICAgICAgICB9OwoKICAgICAgICBsZXQgY3VycmVudEFzc2V0ID0gbnVsbDsKCiAgICAgICAgY29uc3QgdXBkYXRlVHJhbnNmb3JtID0gKCkgPT4gewogICAgICAgICAgICBpZiAoY3VycmVudEFzc2V0KSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQucG9zaXRpb24uc2V0KGZvcmdlU3RhdGUucG9zWCwgZm9yZ2VTdGF0ZS5wb3NZLCBmb3JnZVN0YXRlLnBvc1opOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0LnJvdGF0aW9uLnNldChmb3JnZVN0YXRlLnJvdFgsIGZvcmdlU3RhdGUucm90WSwgZm9yZ2VTdGF0ZS5yb3RaKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRBc3NldC5zY2FsZS5zZXRTY2FsYXIoZm9yZ2VTdGF0ZS5zY2FsZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjb25zdCB1cGRhdGVDYW1lcmEgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghZm9yZ2VTdGF0ZS5hY3RpdmUpIHJldHVybjsKICAgICAgICAgICAgLy8gT3JiaXQgYXJvdW5kICgxMDAwLCBZLCAxMDAwKQogICAgICAgICAgICBjb25zdCBjeCA9IDEwMDAgKyBNYXRoLnNpbihmb3JnZVN0YXRlLmNhbVJvdCkgKiBmb3JnZVN0YXRlLmNhbURpc3Q7CiAgICAgICAgICAgIGNvbnN0IGN6ID0gMTAwMCArIE1hdGguY29zKGZvcmdlU3RhdGUuY2FtUm90KSAqIGZvcmdlU3RhdGUuY2FtRGlzdDsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhbWVyYS5wb3NpdGlvbi5zZXQoY3gsIGZvcmdlU3RhdGUuY2FtSGVpZ2h0LCBjeik7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW1lcmEubG9va0F0KDEwMDAsIGZvcmdlU3RhdGUucG9zWSArIDEsIDEwMDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IHBsYXlBbmltYXRpb24gPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghdGhpcy52aXpNaXhlciB8fCAhdGhpcy52aXpDbGlwcykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnZpek1peGVyLnN0b3BBbGxBY3Rpb24oKTsKICAgICAgICAgICAgaWYgKGZvcmdlU3RhdGUuYW5pbU5hbWUgPT09ICdub25lJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUgPT09IGZvcmdlU3RhdGUuYW5pbU5hbWUpOwogICAgICAgICAgICBpZiAoIWNsaXApIGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhmb3JnZVN0YXRlLmFuaW1OYW1lLnRvTG93ZXJDYXNlKCkpKTsKICAgICAgICAgICAgaWYgKGNsaXApIHRoaXMudml6TWl4ZXIuY2xpcEFjdGlvbihjbGlwKS5wbGF5KCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3Qgc3Bhd25Bc3NldCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBwcmV2aW91cwogICAgICAgICAgICB3aGlsZSh0aGlzLnZpekdyb3VwLmNoaWxkcmVuLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy52aXpHcm91cC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucmVtb3ZlKGNoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52aXpNaXhlciA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnRBc3NldCA9IG51bGw7CgogICAgICAgICAgICBjb25zdCB1cmwgPSBhc3NldHNbZm9yZ2VTdGF0ZS5hc3NldE5hbWVdOwogICAgICAgICAgICBpZiAoIXVybCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc29sZS5sb2coIkZvcmdlOiBTcGF3bmluZyIsIGZvcmdlU3RhdGUuYXNzZXROYW1lKTsKCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbCh1cmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSBhcmUgc3RpbGwgaW4gZm9yZ2UgbW9kZSBiZWZvcmUgYWRkaW5nCiAgICAgICAgICAgICAgICBpZiAoIWZvcmdlU3RhdGUuYWN0aXZlKSByZXR1cm47CgogICAgICAgICAgICAgICAgY29uc3QgbW9kZWwgPSBnbHRmLnNjZW5lOwogICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cC5hZGQobW9kZWwpOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0ID0gbW9kZWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IG1vZGVsIHRyYW5zZm9ybSByZWxhdGl2ZSB0byBncm91cAogICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIG1vZGVsLnJvdGF0aW9uLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZVRyYW5zZm9ybSgpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmLmFuaW1hdGlvbnMgJiYgZ2x0Zi5hbmltYXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpek1peGVyID0gbmV3IFRIUkVFLkFuaW1hdGlvbk1peGVyKG1vZGVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekNsaXBzID0gZ2x0Zi5hbmltYXRpb25zOwogICAgICAgICAgICAgICAgICAgIHBsYXlBbmltYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgdG9nZ2xlRm9yZ2UgPSAoaXNBY3RpdmUpID0+IHsKICAgICAgICAgICAgZm9yZ2VTdGF0ZS5hY3RpdmUgPSBpc0FjdGl2ZTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlzRm9yZ2VNb2RlID0gaXNBY3RpdmU7IC8vIENyaXRpY2FsOiBUZWxsIG1haW4uanMgdG8gc3RvcCBnYW1lIGxvb3AKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBHYW1lIFZpc2liaWxpdHkgKEhpZGUgZXZlcnl0aGluZyBpbiB0aGUgbWFpbiBhcmVuYSkKICAgICAgICAgICAgY29uc3QgZ2FtZUxheWVyID0gW3RoaXMuZ2FtZS50ZWFtcy5ob21lLCB0aGlzLmdhbWUudGVhbXMuYXdheSwgdGhpcy5nYW1lLmVudGl0aWVzLmJhbGxdOwogICAgICAgICAgICBnYW1lTGF5ZXIuZm9yRWFjaCh0ID0+IHsKICAgICAgICAgICAgICAgIGlmKHQgJiYgdC5wbGF5ZXJzKSB0LnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsgfSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmKHQgJiYgdC5tZXNoKSB0Lm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCkgd2luZG93LmZsdXguYXJlbmFNZXNoLnZpc2libGUgPSAhaXNBY3RpdmU7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIpIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLnN0YWRpdW0gJiYgdGhpcy5nYW1lLnN0YWRpdW0uY29udGFpbmVyKSB0aGlzLmdhbWUuc3RhZGl1bS5jb250YWluZXIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLndhdGVyT3ZlcmxheSAmJiB0aGlzLmdhbWUud2F0ZXJPdmVybGF5Lm1lc2gpIHRoaXMuZ2FtZS53YXRlck92ZXJsYXkubWVzaC52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBVSQogICAgICAgICAgICBjb25zdCB1aSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpOwogICAgICAgICAgICBpZih1aSkgdWkuc3R5bGUuZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2ZsZXgnOwoKICAgICAgICAgICAgaWYgKGlzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIEZvcmdlIFNjZW5lIGlmIG5lZWRlZAogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwUGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy52aXpHcm91cFBhcmVudCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucG9zaXRpb24uc2V0KDEwMDAsIDAsIDEwMDApOyAvLyBGYXIgYXdheSBmcm9tIGFyZW5hCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQodGhpcy52aXpHcm91cCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdyaWQgPSBuZXcgVEhSRUUuR3JpZEhlbHBlcigyMCwgMjAsIDB4MDBmZmZmLCAweDQ0NDQ0NCk7CiAgICAgICAgICAgICAgICAgICAgZ3JpZC5wb3NpdGlvbi5zZXQoMTAwMCwgMCwgMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQoZ3JpZCk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMudml6TGlnaHQgPSBuZXcgVEhSRUUuRGlyZWN0aW9uYWxMaWdodCgweGZmZmZmZiwgMS4wKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnBvc2l0aW9uLnNldCgxMDA1LCAxMCwgMTAwNSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZCh0aGlzLnZpekxpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekFtYmllbnQgPSBuZXcgVEhSRUUuQW1iaWVudExpZ2h0KDB4NDA0MDQwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKHRoaXMudml6QW1iaWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXBQYXJlbnQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy52aXpBbWJpZW50LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzcGF3bkFzc2V0KCk7CiAgICAgICAgICAgICAgICB1cGRhdGVDYW1lcmEoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBHYW1lCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpHcm91cFBhcmVudCkgdGhpcy52aXpHcm91cFBhcmVudC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpMaWdodCkgdGhpcy52aXpMaWdodC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpBbWJpZW50KSB0aGlzLnZpekFtYmllbnQudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYSBiYWNrIHRvIGdhbWUgdGFyZ2V0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIpIHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZm9sZGVyLmFkZChmb3JnZVN0YXRlLCAnYWN0aXZlJykubmFtZSgnRW5hYmxlIEZvcmdlJykub25DaGFuZ2UodG9nZ2xlRm9yZ2UpOwogICAgICAgIGZvbGRlci5hZGQoZm9yZ2VTdGF0ZSwgJ2Fzc2V0TmFtZScsIE9iamVjdC5rZXlzKGFzc2V0cykpLm5hbWUoJ1NlbGVjdCBBc3NldCcpLm9uQ2hhbmdlKHNwYXduQXNzZXQpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRmID0gZm9sZGVyLmFkZEZvbGRlcignVHJhbnNmb3JtJyk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NYJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NZJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NaJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdyb3RYJywgMCwgNi4yOCkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3JvdFknLCAwLCA2LjI4KS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwogICAgICAgIHRmLmFkZChmb3JnZVN0YXRlLCAncm90WicsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdzY2FsZScsIDAuMSwgMy4wKS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwoKICAgICAgICBmb2xkZXIuYWRkKGZvcmdlU3RhdGUsICdhbmltTmFtZScsIFsnbm9uZScsICdpZGxlJywgJ3N3aW0nLCAndGhyb3cnLCAnY2F0Y2gnLCAncmVhY3QnXSkubmFtZSgnQW5pbWF0aW9uJykub25DaGFuZ2UocGxheUFuaW1hdGlvbik7CgogICAgICAgIGNvbnN0IGNmID0gZm9sZGVyLmFkZEZvbGRlcignQ2FtZXJhJyk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1EaXN0JywgMiwgMTUpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1IZWlnaHQnLCAwLCAxMCkub25DaGFuZ2UodXBkYXRlQ2FtZXJhKTsKICAgICAgICBjZi5hZGQoZm9yZ2VTdGF0ZSwgJ2NhbVJvdCcsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CgogICAgICAgIC8vIEhvb2sgR2FtZSBMb29wCiAgICAgICAgY29uc3Qgb3JpZ2luYWxVcGRhdGUgPSB0aGlzLmdhbWUudXBkYXRlLmJpbmQodGhpcy5nYW1lKTsKICAgICAgICB0aGlzLmdhbWUudXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIGlmIChmb3JnZVN0YXRlLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgLy8gRm9yZ2UgTW9kZTogT25seSB1cGRhdGUgZm9yZ2UgY29tcG9uZW50cyBhbmQgcmVuZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpNaXhlcikgdGhpcy52aXpNaXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGb3JjZSBDYW1lcmEgVXBkYXRlIGhlcmUgc2luY2UgbWFpbi5qcyBsb29wIGlzIHNraXBwZWQKICAgICAgICAgICAgICAgIHVwZGF0ZUNhbWVyYSgpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucmVuZGVyZXIgJiYgdGhpcy5nYW1lLnNjZW5lICYmIHRoaXMuZ2FtZS5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIucmVuZGVyKHRoaXMuZ2FtZS5zY2VuZSwgdGhpcy5nYW1lLmNhbWVyYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOb3JtYWwgTW9kZTogUnVuIHN0YW5kYXJkIGdhbWUgdXBkYXRlCiAgICAgICAgICAgICAgICBvcmlnaW5hbFVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KfTsKICAgICAgICB9OwoKICAgICAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwQXVkaW8gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdBdWRpbyBTZXR0aW5ncycpOwogICAgICAgICAgICBjb25zdCBhbSA9IHRoaXMuZ2FtZS5hdWRpb01hbmFnZXI7CiAgICAgICAgICAgIGlmICghYW0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIG1hc3RlcjogYW0ubWFzdGVyVm9sdW1lLAogICAgICAgICAgICAgICAgYmdtOiBhbS5iZ21MZXZlbCwKICAgICAgICAgICAgICAgIHNmeDogYW0uc2Z4TGV2ZWwsCiAgICAgICAgICAgICAgICBtdXRlOiBhbS5pc011dGVkCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ21hc3RlcicsIDAuMCwgMS4wKS5uYW1lKCdNYXN0ZXIgVm9sdW1lJykub25DaGFuZ2UodiA9PiBhbS5zZXRNYXN0ZXJWb2x1bWUodikpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2JnbScsIDAuMCwgMi4wKS5uYW1lKCdCR00gTGV2ZWwnKS5vbkNoYW5nZSh2ID0+IGFtLnNldEJHTUxldmVsKHYpKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdzZngnLCAwLjAsIDIuMCkubmFtZSgnU0ZYIExldmVsJykub25DaGFuZ2UodiA9PiBhbS5zZXRTRlhMZXZlbCh2KSk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnbXV0ZScpLm5hbWUoJ011dGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGFtLnRvZ2dsZU11dGUoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCn0pKCk7","/DevTools.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFRvb2x0aXAgRGVzY3JpcHRpb25zIGZvciBMb25nLVByZXNzCiAgICBjb25zdCBUT09MVElQX0RFU0NSSVBUSU9OUyA9IHsKICAgICAgICAnU1VCU1RFUFMnOiAiUGh5c2ljcyBpdGVyYXRpb25zIHBlciBmcmFtZS4gSGlnaGVyID0gbW9yZSBzdGFibGUsIG1vcmUgQ1BVLiIsCiAgICAgICAgJ1NUT1BfU1BFRUQnOiAiVmVsb2NpdHkgdGhyZXNob2xkIGJlbG93IHdoaWNoIHRoZSBiYWxsIHNuYXBzIHRvIGEgaGFsdC4iLAogICAgICAgICdXQVRFUl9EUkFHX0xJTkVBUic6ICJCYXNlIHdhdGVyIHJlc2lzdGFuY2UuIFNsb3dzIGJhbGwgbGluZWFybHkuIiwKICAgICAgICAnV0FURVJfRFJBR19RVUFEJzogIlF1YWRyYXRpYyBkcmFnLiBTbG93cyBoaWdoLXNwZWVkIGJhbGxzIHNpZ25pZmljYW50bHkuIiwKICAgICAgICAnU1BJTl9EUkFHJzogIkhvdyBmYXN0IHRoZSBiYWxsJ3Mgc3BpbiBkZWNheXMgb3ZlciB0aW1lLiIsCiAgICAgICAgJ01BR05VU19FTkFCTEVEJzogIkVuYWJsZXMgdGhlIE1hZ251cyBlZmZlY3QgKGN1cnZlIGZyb20gc3BpbikuIiwKICAgICAgICAnTUFHTlVTX0NPRUZGJzogIlN0cmVuZ3RoIG9mIHRoZSBjdXJ2ZSBmb3JjZSByZWxhdGl2ZSB0byBzcGluL3NwZWVkLiIsCiAgICAgICAgJ01BR05VU19DQVAnOiAiTWF4aW11bSBjdXJ2ZSBmb3JjZSBhbGxvd2VkIChwcmV2ZW50cyBwaHlzaWNzIGV4cGxvc2lvbnMpLiIsCiAgICAgICAgJ0RFUFRIX1RBUkdFVF9ZJzogIklkZWFsIFkgaGVpZ2h0IHRoZSBiYWxsIHRyaWVzIHRvIGZsb2F0IGF0LiIsCiAgICAgICAgJ0RFUFRIX1NQUklORyc6ICJTdHJlbmd0aCBvZiB0aGUgZm9yY2UgcHVsbGluZyBiYWxsIHRvIFRhcmdldCBZLiIsCiAgICAgICAgJ0RFUFRIX0RBTVAnOiAiRGFtcGluZyBvbiB2ZXJ0aWNhbCBtb3ZlbWVudCB0byBwcmV2ZW50IG9zY2lsbGF0aW9uLiIsCiAgICAgICAgJ0JPVU5EQVJZX1JBRElVUyc6ICJSYWRpdXMgb2YgdGhlIGNpcmN1bGFyIGFyZW5hIHdhbGwuIiwKICAgICAgICAnQk9VTkRBUllfSEVJR0hUJzogIkhlaWdodCBvZiB0aGUgYXJlbmEgY2VpbGluZy9mbG9vci4iLAogICAgICAgICdXQUxMX1NPRlRfQlVGRkVSJzogIkRpc3RhbmNlIGZyb20gd2FsbCB3aGVyZSBzb2Z0IHJlcHVsc2lvbiBiZWdpbnMuIiwKICAgICAgICAnV0FMTF9TT0ZUX0ZPUkNFJzogIkZvcmNlIHB1c2hpbmcgYmFsbCBhd2F5IGZyb20gd2FsbCBiZWZvcmUgaW1wYWN0LiIsCiAgICAgICAgJ1dBTExfRUxBU1RJQ0lUWSc6ICJCb3VuY2luZXNzIG9mIHRoZSB3YWxsICgwID0gZGVhZCB0aHVkLCAxID0gcGVyZmVjdCBib3VuY2UpLiIsCiAgICAgICAgJ1dBTExfRlJJQ1RJT04nOiAiRnJpY3Rpb24gd2hlbiBzbGlkaW5nIGFsb25nIHRoZSB3YWxsLiIsCiAgICAgICAgJ0ZMT09SX0VMQVNUSUNJVFknOiAiQm91bmNpbmVzcyBvZiB0aGUgZmxvb3IvY2VpbGluZy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9FTkFCTEVEJzogIkVuYWJsZXMgdGhlIGV4dGVuZGVkIGNvcnJpZG9yIGZvciB0aGUgZ29hbC4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9YJzogIkhhbGYtd2lkdGggb2YgdGhlIGdvYWwgcG9ja2V0IGNvcnJpZG9yLiIsCiAgICAgICAgJ0dPQUxfUE9DS0VUX1onOiAiWi1kZXB0aCB3aGVyZSB0aGUgcG9ja2V0IHN0YXJ0cy4iLAogICAgICAgICdHT0FMX1BPQ0tFVF9SQURJVVMnOiAiRWZmZWN0aXZlIHJhZGl1cyBpbnNpZGUgdGhlIHBvY2tldC4iLAogICAgICAgICdMQVVOQ0hfU1BFRURfU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBTdGF0IFBvd2VyIHRvIFBoeXNpY3MgVmVsb2NpdHkuIiwKICAgICAgICAnTEFVTkNIX1NQRUVEX0NBUCc6ICJNYXhpbXVtIHBoeXNpY2FsIHNwZWVkIHRoZSBiYWxsIGNhbiBiZSB0aHJvd24uIiwKICAgICAgICAnU1dJUEVfTUlOX1BYJzogIk1pbmltdW0gc3dpcGUgZGlzdGFuY2UgdG8gcmVnaXN0ZXIgYSB0aHJvdy4iLAogICAgICAgICdBSU1fRFhfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgaG9yaXpvbnRhbCBhaW0gZnJvbSBzd2lwZS4iLAogICAgICAgICdBSU1fRFlfU0NBTEUnOiAiU2Vuc2l0aXZpdHkgb2YgdmVydGljYWwgYWltIGZyb20gc3dpcGUuIiwKICAgICAgICAnUE9XRVJfQkFTRSc6ICJCYXNlIHBvd2VyIG11bHRpcGxpZXIgZm9yIGEgcXVpY2sgdGFwLiIsCiAgICAgICAgJ1BPV0VSX1JBTkdFJzogIkFkZGl0aW9uYWwgcG93ZXIgbXVsdGlwbGllciBhdCBmdWxsIGNoYXJnZS4iLAogICAgICAgICdQT1dFUl9NQVhfQk9OVVNfUkFUSU8nOiAiQ2hhcmdlIHRocmVzaG9sZCBmb3IgJ01heCBQb3dlcicgYm9udXMuIiwKICAgICAgICAnUE9XRVJfTUFYX01VTFRJUExJRVInOiAiTXVsdGlwbGllciBhcHBsaWVkIHdoZW4gaGl0dGluZyBNYXggUG93ZXIuIiwKICAgICAgICAnQ1VSVkVfRU5BQkxFRCc6ICJFbmFibGVzIGN1cnZlIHNob3RzIHZpYSBjdXJ2ZWQgc3dpcGVzLiIsCiAgICAgICAgJ0NVUlZFX0lOVEVOU0lUWV9USFJFU0hPTEQnOiAiSG93IGN1cnZlZCBhIHN3aXBlIG11c3QgYmUgdG8gdHJpZ2dlciBzcGluLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fU0NBTEUnOiAiTXVsdGlwbGllciBmb3IgY29udmVydGluZyBzd2lwZSBjdXJ2ZSB0byBiYWxsIHNwaW4uIiwKICAgICAgICAnQ1VSVkVfU1BFRURfTVVMVCc6ICJNdWx0aXBsaWVyIGZvciBzcGluIGJhc2VkIG9uIHN3aXBlIHNwZWVkLiIsCiAgICAgICAgJ0NVUlZFX1NQSU5fQ0FQJzogIk1heGltdW0gc3BpbiBhbGxvd2VkIGZyb20gYSBjdXJ2ZSB0aHJvdy4iLAogICAgICAgICdDVVJWRV9QRVJGRUNUX1NQSU4nOiAiU3BpbiB0aHJlc2hvbGQgdG8gdHJpZ2dlciAnUGVyZmVjdCBDdXJ2ZScgRlguIiwKICAgICAgICAndGltZVNjYWxlJzogIkdsb2JhbCBnYW1lIHNwZWVkIG11bHRpcGxpZXIuIiwKICAgICAgICAnZGVtb01vZGUnOiAiVG9nZ2xlIEFJIHZzIEFJIGF1dG8tcGxheS4iLAogICAgICAgICdyZXNvbHV0aW9uJzogIkludGVybmFsIHJlbmRlciByZXNvbHV0aW9uIHNjYWxlICgwLjUgPSBoYWxmIHJlcykuIiwKICAgICAgICAnYXJlbmFPcGFjaXR5JzogIk9wYWNpdHkgb2YgdGhlIG91dGVyIGFyZW5hIGdyaWQuIiwKJ2FyZW5hMk9wYWNpdHknOiAiT3BhY2l0eSBvZiB0aGUgaW5uZXIgaGV4IGdyaWQuIiwKCiAgICAgICAgJ0dPQUxfRElTVEFOQ0UnOiAiRGlzdGFuY2Ugb2YgdGhlIGdvYWxzIGZyb20gdGhlIGNlbnRlciAoWi1heGlzKS4iCiAgICB9OwogICAgY2xhc3MgRGV2VG9vbHMgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gbGlsLWd1aSBhdHRhY2hlcyB0byB3aW5kb3cubGlsIGJ5IGRlZmF1bHQgaW4gVU1EIGJ1aWxkCiAgICAgICAgICAgIGlmICghd2luZG93LmxpbCB8fCAhd2luZG93LmxpbC5HVUkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiRGV2VG9vbHM6IGxpbC1ndWkgbm90IGZvdW5kLiIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9Cgpjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS1jb250YWluZXInKTsKICAgICAgICAgICAgdGhpcy5ndWkgPSBuZXcgd2luZG93LmxpbC5HVUkoeyB0aXRsZTogJ0ZsdXggRGV2VG9vbHMnLCBjb250YWluZXI6IGNvbnRhaW5lciB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBvc2l0aW9uIGFzIGEgY29sbGFwc2VkIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gUG9zaXRpb24gYXMgYSBzbGlkaW5nIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gUG9zaXRpb24gYXMgYSBzbGlkaW5nIHRhYiBvbiB0aGUgcmlnaHQgZnJhbWUKLy8gV3JhcHBlciBmb3Igc2xpZGluZyBhbmltYXRpb24KICAgICAgICAgICAgY29uc3Qgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgd3JhcHBlci5zdHlsZS50b3AgPSAnMTAwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnJpZ2h0ID0gJy0yNjBweCc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUud2lkdGggPSAnMjYwcHgnOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLnRyYW5zaXRpb24gPSAncmlnaHQgMC4zcyBjdWJpYy1iZXppZXIoMC4yLCAwLjgsIDAuMiwgMS4wKSc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUuekluZGV4ID0gJzk5OTknOwogICAgICAgICAgICB3cmFwcGVyLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgIHdyYXBwZXIuc3R5bGUuZmxleERpcmVjdGlvbiA9ICdjb2x1bW4nOwogICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgogICAgICAgICAgICBjb25zdCBkb20gPSB0aGlzLmd1aS5kb21FbGVtZW50OwogICAgICAgICAgICBkb20uc3R5bGUud2lkdGggPSAnMTAwJSc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5zZXRQcm9wZXJ0eSgnLS13aWR0aCcsICcxMDAlJyk7CiAgICAgICAgICAgIGRvbS5zdHlsZS5tYXhIZWlnaHQgPSAnODB2aCc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvd1kgPSAnYXV0byc7CiAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvd1ggPSAnaGlkZGVuJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vdmUgR1VJIGludG8gd3JhcHBlcgogICAgICAgICAgICB3cmFwcGVyLmFwcGVuZENoaWxkKGRvbSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDcmVhdGUgVG9nZ2xlIEhhbmRsZQogICAgICAgICAgICBjb25zdCBoYW5kbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmxlZnQgPSAnLTQwcHgnOyAvLyBQcm90cnVkZSB0byB0aGUgbGVmdAogICAgICAgICAgICBoYW5kbGUuc3R5bGUudG9wID0gJzAnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUud2lkdGggPSAnNDBweCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5oZWlnaHQgPSAnNDBweCc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAncmdiYSgwLCAyMCwgNDAsIDAuOSknOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyID0gJzFweCBzb2xpZCAjMDBmZmZmJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmJvcmRlclJpZ2h0ID0gJ25vbmUnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyVG9wTGVmdFJhZGl1cyA9ICc4cHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuYm9yZGVyQm90dG9tTGVmdFJhZGl1cyA9ICc4cHgnOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuY3Vyc29yID0gJ3BvaW50ZXInOwogICAgICAgICAgICBoYW5kbGUuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmp1c3RpZnlDb250ZW50ID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5hbGlnbkl0ZW1zID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5jb2xvciA9ICcjMDBmZmZmJzsKICAgICAgICAgICAgaGFuZGxlLnN0eWxlLmZvbnRTaXplID0gJzIwcHgnOwogICAgICAgICAgICBoYW5kbGUuaW5uZXJIVE1MID0gJ+KamSc7CiAgICAgICAgICAgIGhhbmRsZS5zdHlsZS5ib3hTaGFkb3cgPSAnLTVweCAwIDEwcHggcmdiYSgwLDAsMCwwLjUpJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaGFuZGxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBMb2dpYwogICAgICAgICAgICBsZXQgaXNPcGVuID0gZmFsc2U7CiAgICAgICAgICAgIGhhbmRsZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyAvLyBQcmV2ZW50IGdhbWUgaW5wdXRzCiAgICAgICAgICAgICAgICBpc09wZW4gPSAhaXNPcGVuOwogICAgICAgICAgICAgICAgd3JhcHBlci5zdHlsZS5yaWdodCA9IGlzT3BlbiA/ICcwcHgnIDogJy0yNjBweCc7CiAgICAgICAgICAgICAgICBoYW5kbGUuaW5uZXJIVE1MID0gaXNPcGVuID8gJ8K7JyA6ICfimpknOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gRGVmYXVsdCBnbG9iYWwgdGltZVNjYWxlIGlmIG5vdCBzZXQKaWYgKHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9PT0gdW5kZWZpbmVkKSB3aW5kb3cuZmx1eC50aW1lU2NhbGUgPSAwLjg7Cgp0aGlzLl9zZXR1cEdlbmVyYWwoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBHYW1lU3RhdGUoKTsKdGhpcy5fc2V0dXBPdmVybGF5cygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFRlYW1zKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwUGxheWVySW5zcGVjdG9yKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwQmFsbFNhbmRib3goKTsKdGhpcy5fc2V0dXBGWExhYigpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFZpc3VhbERlYnVnKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwVmlzdWFscygpOwp0aGlzLl9zZXR1cFZpc3VhbHMoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dXBBdWRpbygpOwogICAgICAgICAgICB0aGlzLl9zZXR1cFRvb2x0aXBzKCk7CiAgICAgICAgfQoKICAgICAgICBfc2V0dXBUb29sdGlwcygpIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIFRvb2x0aXAgRE9NCiAgICAgICAgICAgIHRoaXMudG9vbHRpcEVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy50b29sdGlwRWwuc3R5bGUsIHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAnZml4ZWQnLAogICAgICAgICAgICAgICAgdG9wOiAnNTAlJywKICAgICAgICAgICAgICAgIGxlZnQ6ICc1MCUnLAogICAgICAgICAgICAgICAgdHJhbnNmb3JtOiAndHJhbnNsYXRlKC01MCUsIC01MCUpJywKICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogJ3JnYmEoMCwgMTAsIDMwLCAwLjk1KScsCiAgICAgICAgICAgICAgICBib3JkZXI6ICcycHggc29saWQgIzAwZmZmZicsCiAgICAgICAgICAgICAgICBwYWRkaW5nOiAnMjBweCcsCiAgICAgICAgICAgICAgICBjb2xvcjogJyNmZmYnLAogICAgICAgICAgICAgICAgZm9udEZhbWlseTogJ21vbm9zcGFjZScsCiAgICAgICAgICAgICAgICBmb250U2l6ZTogJzE0cHgnLAogICAgICAgICAgICAgICAgbWF4V2lkdGg6ICczMDBweCcsCiAgICAgICAgICAgICAgICB6SW5kZXg6ICcxMDAwMCcsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAnbm9uZScsCiAgICAgICAgICAgICAgICBwb2ludGVyRXZlbnRzOiAnbm9uZScsCiAgICAgICAgICAgICAgICBib3hTaGFkb3c6ICcwIDAgMjBweCByZ2JhKDAsIDI1NSwgMjU1LCAwLjMpJywKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogJzhweCcsCiAgICAgICAgICAgICAgICB0ZXh0QWxpZ246ICdjZW50ZXInCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMudG9vbHRpcEVsKTsKCiAgICAgICAgICAgIC8vIFJlY3Vyc2l2ZSBmdW5jdGlvbiB0byBhdHRhY2ggbGlzdGVuZXJzCiAgICAgICAgICAgIGNvbnN0IGF0dGFjaCA9IChndWkpID0+IHsKICAgICAgICAgICAgICAgIC8vIENvbnRyb2xsZXJzCiAgICAgICAgICAgICAgICBpZiAoZ3VpLmNvbnRyb2xsZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgZ3VpLmNvbnRyb2xsZXJzLmZvckVhY2goYyA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRvbSA9IGMuZG9tRWxlbWVudC5jbG9zZXN0KCcuY29udHJvbGxlcicpOyAvLyBsaWwtZ3VpIHN0cnVjdHVyZQogICAgICAgICAgICAgICAgICAgICAgICBpZihkb20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gZG9tLnF1ZXJ5U2VsZWN0b3IoJy5uYW1lJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihsYWJlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2FkZExvbmdQcmVzcyhsYWJlbCwgYy5wcm9wZXJ0eSwgYy5fbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIFN1Yi1mb2xkZXJzCiAgICAgICAgICAgICAgICBpZihndWkuZm9sZGVycykgewogICAgICAgICAgICAgICAgICAgIGd1aS5mb2xkZXJzLmZvckVhY2goZiA9PiBhdHRhY2goZikpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gV2FpdCBhIHRpY2sgZm9yIEdVSSB0byBmdWxseSByZW5kZXIgRE9NCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gYXR0YWNoKHRoaXMuZ3VpKSwgMTAwKTsKICAgICAgICB9CgogICAgICAgIF9hZGRMb25nUHJlc3MoZWxlbWVudCwgcHJvcGVydHksIG5hbWUpIHsKICAgICAgICAgICAgbGV0IHRpbWVyID0gbnVsbDsKICAgICAgICAgICAgY29uc3QgZHVyYXRpb24gPSA1MDA7IC8vIDAuNXMKCiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIHRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd1Rvb2x0aXAocHJvcGVydHksIG5hbWUpOwogICAgICAgICAgICAgICAgfSwgZHVyYXRpb24pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29uc3QgZW5kID0gKCkgPT4gewogICAgICAgICAgICAgICAgaWYodGltZXIpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpOwogICAgICAgICAgICAgICAgICAgIHRpbWVyID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2hpZGVUb29sdGlwKCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHN0YXJ0KTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0Jywgc3RhcnQsIHtwYXNzaXZlOiB0cnVlfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBlbmQpOwogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCBlbmQpOwogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgZW5kKTsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGVuZCk7CiAgICAgICAgfQoKICAgICAgICBfc2hvd1Rvb2x0aXAocHJvcCwgbmFtZSkgewogICAgICAgICAgICBjb25zdCBkZXNjID0gVE9PTFRJUF9ERVNDUklQVElPTlNbcHJvcF07CiAgICAgICAgICAgIGlmKGRlc2MpIHsKICAgICAgICAgICAgICAgIHRoaXMudG9vbHRpcEVsLmlubmVySFRNTCA9IGA8c3Ryb25nIHN0eWxlPSJjb2xvcjojMDBmZmZmOyBmb250LXNpemU6MTZweDsiPiR7bmFtZSB8fCBwcm9wfTwvc3Ryb25nPjxicj48YnI+JHtkZXNjfWA7CiAgICAgICAgICAgICAgICB0aGlzLnRvb2x0aXBFbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2hpZGVUb29sdGlwKCkgewogICAgICAgICAgICBpZiAodGhpcy50b29sdGlwRWwpIHRoaXMudG9vbHRpcEVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQoKCl9zZXR1cEdlbmVyYWwoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignR2VuZXJhbCcpOwogICAgICAgICAgICAKY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgdGltZVNjYWxlOiB3aW5kb3cuZmx1eC50aW1lU2NhbGUsCiAgICAgICAgICAgICAgICBkZW1vTW9kZTogdGhpcy5nYW1lLmlzRGVtb01vZGUsCiAgICAgICAgICAgICAgICB0b2dnbGVIVUQ6IHRydWUsCiAgICAgICAgICAgICAgICByZXNvbHV0aW9uOiAwLjUwLAphcmVuYU9wYWNpdHk6IDAuMywKICAgICAgICAgICAgICAgIGFyZW5hMk9wYWNpdHk6IDAuMjUKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndGltZVNjYWxlJywgMC4wLCA1LjApLm5hbWUoJ0dhbWUgU3BlZWQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnRpbWVTY2FsZSA9IHY7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdkZW1vTW9kZScpLm5hbWUoJ0RlbW8gTW9kZScpLmxpc3RlbigpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5pc0RlbW9Nb2RlICE9PSB2KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRvZ2dsZURlbW9Nb2RlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICd0b2dnbGVIVUQnKS5uYW1lKCdTaG93IEhVRCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgY29uc3QgaHVkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VpLWxheWVyJyk7CiAgICAgICAgICAgICAgICBpZiAoaHVkKSB7CiAgICAgICAgICAgICAgICAgICAgaHVkLnN0eWxlLnZpc2liaWxpdHkgPSB2ID8gJ3Zpc2libGUnIDogJ2hpZGRlbic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdyZXNvbHV0aW9uJywgMC4xLCAyLjApLm5hbWUoJ1Jlc29sdXRpb24gU2NhbGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHcgPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICAgICAgICAgIGNvbnN0IGggPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICBjb25zdCByZW5kZXJlciA9IHRoaXMuZ2FtZS5yZW5kZXJlcjsKICAgICAgICAgICAgICAgIGlmIChyZW5kZXJlcikgewogICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyLnNldFNpemUodyAqIHYsIGggKiB2LCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKZm9sZGVyLmFkZChwYXJhbXMsICdhcmVuYU9wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnQXJlbmEgMSBPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjb25zdCBibGVuZE1vZGVzID0gewogICAgICAgICAgICAgICAgJ05vcm1hbCc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ0FkZGl0aXZlJzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICdNdWx0aXBseSc6IFRIUkVFLk11bHRpcGx5QmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnU3VidHJhY3RpdmUnOiBUSFJFRS5TdWJ0cmFjdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ05vQmxlbmRpbmcnOiBUSFJFRS5Ob0JsZW5kaW5nCiAgICAgICAgICAgIH07CnBhcmFtcy5hcmVuYUJsZW5kID0gJ05vcm1hbCc7CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hQmxlbmQnLCBPYmplY3Qua2V5cyhibGVuZE1vZGVzKSkubmFtZSgnQXJlbmEgMSBCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gubWF0ZXJpYWwuYmxlbmRpbmcgPSBibGVuZE1vZGVzW3ZdOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gQXJlbmEgMiBDb250cm9scwpmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hMk9wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnQXJlbmEgMiBPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoMiAmJiB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlID0gdjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgpwYXJhbXMuYXJlbmEyQmxlbmQgPSAnQWRkaXRpdmUnOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2FyZW5hMkJsZW5kJywgT2JqZWN0LmtleXMoYmxlbmRNb2RlcykpLm5hbWUoJ0FyZW5hIDIgQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2gyICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLmJsZW5kaW5nID0gYmxlbmRNb2Rlc1t2XTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5hcmVuYU1lc2gyLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBseSBkZWZhdWx0cwogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJlbmFNZXNoICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaC5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJlbmFNZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBwYXJhbXMuYXJlbmFPcGFjaXR5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcmVuYU1lc2gyICYmIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIubWF0ZXJpYWwub3BhY2l0eSA9IHBhcmFtcy5hcmVuYTJPcGFjaXR5OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gQXJlbmEgR3JhcGhpY3MgQ29udHJvbHMgLS0tCiAgICAgICAgICAgIHRoaXMuX3NldHVwQXJlbmFHcmFwaGljcygpOwogICAgICAgIH0KCiAgICAgICAgX3NldHVwQXJlbmFHcmFwaGljcygpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdBcmVuYSBHcmFwaGljcycpOwoKICAgICAgICAgICAgY29uc3QgdGhyZWVCbGVuZHMgPSB7CiAgICAgICAgICAgICAgICAnTm9ybWFsJzogVEhSRUUuTm9ybWFsQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnQWRkaXRpdmUnOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICdNdWx0aXBseSc6IFRIUkVFLk11bHRpcGx5QmxlbmRpbmcsCiAgICAgICAgICAgICAgICAnTm9CbGVuZGluZyc6IFRIUkVFLk5vQmxlbmRpbmcKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIC0tLSBCbHVlIEJhbmQgLS0tCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCkgewogICAgICAgICAgICAgICAgY29uc3QgYmx1ZUZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0JsdWUgQmFuZCcpOwogICAgICAgICAgICAgICAgY29uc3QgYmx1ZVBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2ggPyB3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2gudmlzaWJsZSA6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd2luZG93LmZsdXguYmx1ZUJhbmRNYXQub3BhY2l0eSB8fCAwLjM1LAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnTm9ybWFsJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGJsdWVGb2xkZXIuYWRkKGJsdWVQYXJhbXMsICd2aXNpYmxlJykubmFtZSgnVmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1lc2gpIHdpbmRvdy5mbHV4LmJsdWVCYW5kTWVzaC52aXNpYmxlID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgYmx1ZUZvbGRlci5hZGQoYmx1ZVBhcmFtcywgJ29wYWNpdHknLCAwLjAsIDEuMCkubmFtZSgnT3BhY2l0eScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5ibHVlQmFuZE1hdCkgd2luZG93LmZsdXguYmx1ZUJhbmRNYXQub3BhY2l0eSA9IHY7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGJsdWVGb2xkZXIuYWRkKGJsdWVQYXJhbXMsICdibGVuZCcsIE9iamVjdC5rZXlzKHRocmVlQmxlbmRzKSkubmFtZSgnQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYmx1ZUJhbmRNYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNYXQuYmxlbmRpbmcgPSB0aHJlZUJsZW5kc1t2XTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYmx1ZUJhbmRNYXQubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gR29sZCBCYW5kIC0tLQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ29sZEJhbmRNYXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdvbGRGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdHb2xkIEJhbmQnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGdvbGRQYXJhbXMgPSB7CiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogd2luZG93LmZsdXguZ29sZEJhbmRNZXNoID8gd2luZG93LmZsdXguZ29sZEJhbmRNZXNoLnZpc2libGUgOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5vcGFjaXR5IHx8IDAuMzUsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdOb3JtYWwnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZ29sZEZvbGRlci5hZGQoZ29sZFBhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdWaXNpYmxlJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvbGRCYW5kTWVzaCkgd2luZG93LmZsdXguZ29sZEJhbmRNZXNoLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBnb2xkRm9sZGVyLmFkZChnb2xkUGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMS4wKS5uYW1lKCdPcGFjaXR5Jykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdvbGRCYW5kTWF0KSB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZ29sZEZvbGRlci5hZGQoZ29sZFBhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5uYW1lKCdCbGVuZCcpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdCkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nb2xkQmFuZE1hdC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC0tLSBZZWxsb3cgQXJyb3dzIC0tLQogICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJyb3dNYXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFycm93Rm9sZGVyID0gZm9sZGVyLmFkZEZvbGRlcignWWVsbG93IEFycm93cycpOwogICAgICAgICAgICAgICAgY29uc3QgYXJyb3dQYXJhbXMgPSB7CiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogd2luZG93LmZsdXguYXJyb3dHcm91cCA/IHdpbmRvdy5mbHV4LmFycm93R3JvdXAudmlzaWJsZSA6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd2luZG93LmZsdXguYXJyb3dNYXQub3BhY2l0eSB8fCAwLjgsCiAgICAgICAgICAgICAgICAgICAgYmxlbmQ6ICdBZGRpdGl2ZScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBhcnJvd0ZvbGRlci5hZGQoYXJyb3dQYXJhbXMsICd2aXNpYmxlJykubmFtZSgnVmlzaWJsZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5hcnJvd0dyb3VwKSB3aW5kb3cuZmx1eC5hcnJvd0dyb3VwLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBhcnJvd0ZvbGRlci5hZGQoYXJyb3dQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ09wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJyb3dNYXQpIHdpbmRvdy5mbHV4LmFycm93TWF0Lm9wYWNpdHkgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBhcnJvd0ZvbGRlci5hZGQoYXJyb3dQYXJhbXMsICdibGVuZCcsIE9iamVjdC5rZXlzKHRocmVlQmxlbmRzKSkubmFtZSgnQmxlbmQnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguYXJyb3dNYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJyb3dNYXQuYmxlbmRpbmcgPSB0aHJlZUJsZW5kc1t2XTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguYXJyb3dNYXQubmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAtLS0gRmxvb3IgR2x5cGggLS0tCiAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0KSB7CiAgICAgICAgICAgICAgICBjb25zdCBmbG9vckZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0Zsb29yIEdseXBoJyk7CiAgICAgICAgICAgICAgICBjb25zdCBmbG9vclBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWVzaCA/IHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNZXNoLnZpc2libGUgOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQub3BhY2l0eSB8fCAwLjM1LAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnQWRkaXRpdmUnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZmxvb3JGb2xkZXIuYWRkKGZsb29yUGFyYW1zLCAndmlzaWJsZScpLm5hbWUoJ1Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZmxvb3JHbHlwaE1lc2gpIHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNZXNoLnZpc2libGUgPSB2OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmbG9vckZvbGRlci5hZGQoZmxvb3JQYXJhbXMsICdvcGFjaXR5JywgMC4wLCAxLjApLm5hbWUoJ09wYWNpdHknKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZmxvb3JHbHlwaE1hdCkgd2luZG93LmZsdXguZmxvb3JHbHlwaE1hdC5vcGFjaXR5ID0gdjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZmxvb3JGb2xkZXIuYWRkKGZsb29yUGFyYW1zLCAnYmxlbmQnLCBPYmplY3Qua2V5cyh0aHJlZUJsZW5kcykpLm5hbWUoJ0JsZW5kJykub25DaGFuZ2UodiA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmZsb29yR2x5cGhNYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZmxvb3JHbHlwaE1hdC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5mbG9vckdseXBoTWF0Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9zZXR1cE92ZXJsYXlzKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ092ZXJsYXlzICYgRlgnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIDEuIEdJRiBPdmVybGF5CiAgICAgICAgICAgIGNvbnN0IGdpZkVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NjcmVlbi1vdmVybGF5LWdpZicpOwogICAgICAgICAgICBpZiAoZ2lmRWwpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdpZlBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB0cnVlLApvcGFjaXR5OiAwLjYyLAogICAgICAgICAgICAgICAgICAgIGJsZW5kOiAnb3ZlcmxheScKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdTY3JlZW4gR0lGJyk7CiAgICAgICAgICAgICAgICBnRm9sZGVyLmFkZChnaWZQYXJhbXMsICd2aXNpYmxlJykub25DaGFuZ2UodiA9PiBnaWZFbC5zdHlsZS5kaXNwbGF5ID0gdiA/ICdibG9jaycgOiAnbm9uZScpOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMS4wKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLm9wYWNpdHkgPSB2KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgYmxlbmRNb2RlcyA9IFsKICAgICAgICAgICAgICAgICAgICAnbm9ybWFsJywgJ211bHRpcGx5JywgJ3NjcmVlbicsICdvdmVybGF5JywgCiAgICAgICAgICAgICAgICAgICAgJ2RhcmtlbicsICdsaWdodGVuJywgJ2NvbG9yLWRvZGdlJywgJ2NvbG9yLWJ1cm4nLCAKICAgICAgICAgICAgICAgICAgICAnaGFyZC1saWdodCcsICdzb2Z0LWxpZ2h0JywgJ2RpZmZlcmVuY2UnLCAnZXhjbHVzaW9uJywgCiAgICAgICAgICAgICAgICAgICAgJ2h1ZScsICdzYXR1cmF0aW9uJywgJ2NvbG9yJywgJ2x1bWlub3NpdHknCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgZ0ZvbGRlci5hZGQoZ2lmUGFyYW1zLCAnYmxlbmQnLCBibGVuZE1vZGVzKS5vbkNoYW5nZSh2ID0+IGdpZkVsLnN0eWxlLm1peEJsZW5kTW9kZSA9IHYpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBXYXRlciBPdmVybGF5CiAgICAgICAgICAgIGNvbnN0IHdvID0gdGhpcy5nYW1lLndhdGVyT3ZlcmxheTsKICAgICAgICAgICAgaWYgKHdvICYmIHdvLm1lc2gpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdGb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdXYXRlciBTaGFkZXInKTsKICAgICAgICAgICAgICAgIGNvbnN0IHdQYXJhbXMgPSB7IAogICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogd28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkgPyB3by5tYXRlcmlhbC51bmlmb3Jtcy51T3BhY2l0eS52YWx1ZSA6IDAuNSwKICAgICAgICAgICAgICAgICAgICBibGVuZDogJ0FkZGl0aXZlJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ3Zpc2libGUnKS5vbkNoYW5nZSh2ID0+IHdvLm1lc2gudmlzaWJsZSA9IHYpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAod28ubWF0ZXJpYWwudW5pZm9ybXMudU9wYWNpdHkpIHsKICAgICAgICAgICAgICAgICAgICB3Rm9sZGVyLmFkZCh3UGFyYW1zLCAnb3BhY2l0eScsIDAuMCwgMi4wKS5vbkNoYW5nZSh2ID0+IHdvLm1hdGVyaWFsLnVuaWZvcm1zLnVPcGFjaXR5LnZhbHVlID0gdik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdGhyZWVCbGVuZHMgPSB7CiAgICAgICAgICAgICAgICAgICAgJ05vcm1hbCc6IFRIUkVFLk5vcm1hbEJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdBZGRpdGl2ZSc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgJ1N1YnRyYWN0aXZlJzogVEhSRUUuU3VidHJhY3RpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICAnTXVsdGlwbHknOiBUSFJFRS5NdWx0aXBseUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgICdOb0JsZW5kaW5nJzogVEhSRUUuTm9CbGVuZGluZwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd0ZvbGRlci5hZGQod1BhcmFtcywgJ2JsZW5kJywgT2JqZWN0LmtleXModGhyZWVCbGVuZHMpKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgICAgICB3by5tYXRlcmlhbC5ibGVuZGluZyA9IHRocmVlQmxlbmRzW3ZdOwogICAgICAgICAgICAgICAgICAgIHdvLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAzLiBMaWdodCBTaGFmdHMKICAgICAgICAgICAgY29uc3QgbHMgPSB0aGlzLmdhbWUubGlnaHRTaGFmdHM7CiAgICAgICAgICAgIGlmIChscyAmJiBscy5jb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGxQYXJhbXMgPSB7IHZpc2libGU6IHRydWUgfTsKICAgICAgICAgICAgICAgIGZvbGRlci5hZGQobFBhcmFtcywgJ3Zpc2libGUnKS5uYW1lKCdMaWdodCBTaGFmdHMnKS5vbkNoYW5nZSh2ID0+IGxzLmNvbnRhaW5lci52aXNpYmxlID0gdik7CiAgICAgICAgICAgIH0KICAgICAgICB9Cgpfc2V0dXBHYW1lU3RhdGUoKSB7CiAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignR2FtZSBTdGF0ZScpOwogICAgICAgICAgICBjb25zdCBnbSA9IHRoaXMuZ2FtZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIGZvcmNlSG9tZUdvYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5nb2FsU2NvcmVkKCdob21lJyk7IAogICAgICAgICAgICAgICAgICAgIGVsc2UgY29uc29sZS53YXJuKCJHYW1lIG11c3QgYmUgYWN0aXZlIHRvIHRyaWdnZXIgZ29hbCIpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGZvcmNlQXdheUdvYWw6ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgaWYoZ20uc3RhdGUgPT09ICdhY3RpdmUnKSBnbS5nb2FsU2NvcmVkKCdhd2F5Jyk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb25zb2xlLndhcm4oIkdhbWUgbXVzdCBiZSBhY3RpdmUgdG8gdHJpZ2dlciBnb2FsIik7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZm9yY2VIYWxmdGltZTogKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmKGdtLnN0YXRlID09PSAnYWN0aXZlJykgZ20uZW5kSGFsZigpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHJlc2V0Um91bmQ6ICgpID0+IGdtLnJlc2V0Um91bmQoKSwKICAgICAgICAgICAgICAgIGV4aXRUb01lbnU6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPSAnbWVudSc7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgcHJhY3RpY2UgaWYgcnVubmluZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnByYWN0aWNlTWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLnByYWN0aWNlTWFuYWdlci5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlSG9tZUdvYWwnKS5uYW1lKCdUcmlnZ2VyIEhvbWUgR29hbCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlQXdheUdvYWwnKS5uYW1lKCdUcmlnZ2VyIEF3YXkgR29hbCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2ZvcmNlSGFsZnRpbWUnKS5uYW1lKCdGb3JjZSBIYWxmdGltZScpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ3Jlc2V0Um91bmQnKS5uYW1lKCdSZXNldCBSb3VuZCcpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2V4aXRUb01lbnUnKS5uYW1lKCdFeGl0IHRvIE1lbnUnKTsKICAgICAgICB9CgogICAgICAgIF9zZXR1cFRlYW1zKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1RlYW1zJyk7CiAgICAgICAgICAgIGlmICghdGhpcy5nYW1lLnRlYW1zLmhvbWUgfHwgIXRoaXMuZ2FtZS50ZWFtcy5hd2F5KSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBob21lID0gdGhpcy5nYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGNvbnN0IGF3YXkgPSB0aGlzLmdhbWUudGVhbXMuYXdheTsKCiAgICAgICAgICAgIC8vIEhvbWUKICAgICAgICAgICAgY29uc3QgaEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0hvbWUgVGVhbScpOwogICAgICAgICAgICBoRm9sZGVyLmFkZChob21lLCAnaXNIdW1hbicpLm5hbWUoJ0lzIEh1bWFuIENvbnRyb2xsZWQnKS5saXN0ZW4oKTsKICAgICAgICAgICAgaEZvbGRlci5hZGQoaG9tZSwgJ2FpRW5hYmxlZCcpLm5hbWUoJ0FJIExvZ2ljIEVuYWJsZWQnKS5saXN0ZW4oKTsKCiAgICAgICAgICAgIC8vIEF3YXkKICAgICAgICAgICAgY29uc3QgYUZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0F3YXkgVGVhbScpOwogICAgICAgICAgICBhRm9sZGVyLmFkZChhd2F5LCAnaXNIdW1hbicpLm5hbWUoJ0lzIEh1bWFuIENvbnRyb2xsZWQnKS5saXN0ZW4oKTsKICAgICAgICAgICAgYUZvbGRlci5hZGQoYXdheSwgJ2FpRW5hYmxlZCcpLm5hbWUoJ0FJIExvZ2ljIEVuYWJsZWQnKS5saXN0ZW4oKTsKCiAgICAgICAgfQoKX3NldHVwUGxheWVySW5zcGVjdG9yKCkgewogICAgICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ1BsYXllciBJbnNwZWN0b3IgKEhvbWUgQWN0aXZlKScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGVscGVyIHRvIGdldCBjdXJyZW50IGFjdGl2ZSBwbGF5ZXIgc2FmZWx5CiAgICAgICAgICAgIGNvbnN0IGdldEFjdGl2ZSA9ICgpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5nYW1lLnRlYW1zLmhvbWUgJiYgdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyKSAKICAgICAgICAgICAgICAgICAgICA/IHRoaXMuZ2FtZS50ZWFtcy5ob21lLmFjdGl2ZVBsYXllciAKICAgICAgICAgICAgICAgICAgICA6IG51bGw7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBQcm94eSBvYmplY3QgdG8gYmluZCBHVUkgdG8gZHluYW1pYyB0YXJnZXQKICAgICAgICAgICAgY29uc3QgcHJveHkgPSB7CiAgICAgICAgICAgICAgICBnZXQgUm9sZSgpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwID8gcC5yb2xlIDogJy0nOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGdldCBHb2RNb2RlKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLmlzR29kTW9kZSA6IGZhbHNlOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgR29kTW9kZSh2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmlzR29kTW9kZSA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBSdW50aW1lIFZhbHVlcwogICAgICAgICAgICAgICAgZ2V0IEhQKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkhQIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEhQKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuSFAgPSB2OyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGdldCBDdXJyZW50RU4oKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuY3VycmVudEVOIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEN1cnJlbnRFTih2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSBwLmN1cnJlbnRFTiA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBCYXNlIFN0YXRzCiAgICAgICAgICAgICAgICBnZXQgTWF4SFAoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMubWF4SFAgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgTWF4SFAodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5zdGF0cy5tYXhIUCA9IHY7IAogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBnZXQgU1AoKSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcCA/IHAuc3RhdHMuU1AgOiAwOyAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQgU1AodikgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5TUCA9IHY7IAogICAgICAgICAgICAgICAgICAgICAgICBwLl91cGRhdGVEZXJpdmVkU3RhdHMoKTsgCiAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEVOKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkVOIDogMDsgCiAgICAgICAgICAgICAgICB9LCAKICAgICAgICAgICAgICAgIHNldCBFTih2KSB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZihwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHMuRU4gPSB2OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEFUKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkFUIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEFUKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQVQgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFBBKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlBBIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFBBKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuUEEgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IEJMKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkJMIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IEJMKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQkwgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IFNIKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLlNIIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IFNIKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuU0ggPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ2V0IENBKCkgeyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgPyBwLnN0YXRzLkNBIDogMDsgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0IENBKHYpIHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHAuc3RhdHMuQ0EgPSB2OyAKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLy8gQWN0aW9ucwogICAgICAgICAgICAgICAgTGV2ZWxVcDogKCkgPT4geyAKICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocCkgcC5sZXZlbFVwKCk7IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEZ1bGxIZWFsOiAoKSA9PiB7IAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBnZXRBY3RpdmUoKTsgCiAgICAgICAgICAgICAgICAgICAgaWYocCkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7IAogICAgICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRFTiA9IHAuZ2V0U3RhdCgnRU4nKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLnZlbm9tID0gMDsgCiAgICAgICAgICAgICAgICAgICAgICAgIHAuc3RhdHVzLm5hcCA9IDA7IAogICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGsgaW4gcC5zdGF0dXMud2l0aGVyKSBwLnN0YXR1cy53aXRoZXJba10gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZih3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZmxvYXRpbmdUZXh0LnNwYXduKCJGVUxMIEhFQUwiLCBwLm1lc2gucG9zaXRpb24sICJoZWFsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIERyYWluRU46ICgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IGdldEFjdGl2ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmKHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50RU4gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBwLmZ1bWJsZSgpOyAvLyBUcmlnZ2VyIGZ1bWJsZSBsb2dpYwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvbGRlci5hZGQocHJveHksICdSb2xlJykubGlzdGVuKCkuZGlzYWJsZSgpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHByb3h5LCAnR29kTW9kZScpLm5hbWUoJ0dvZCBNb2RlIChJbmYgSFAvRU4pJykubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBydEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ1J1bnRpbWUgU3RhdHVzJyk7CiAgICAgICAgICAgIHJ0Rm9sZGVyLmFkZChwcm94eSwgJ0hQJywgMCwgOTk5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHJ0Rm9sZGVyLmFkZChwcm94eSwgJ0N1cnJlbnRFTicsIDAsIDEwMCkubmFtZSgnQ3VycmVudCBFTicpLmxpc3RlbigpOwoKICAgICAgICAgICAgY29uc3Qgc3RhdEZvbGRlciA9IGZvbGRlci5hZGRGb2xkZXIoJ0Jhc2UgU3RhdHMnKTsKICAgICAgICAgICAgc3RhdEZvbGRlci5hZGQocHJveHksICdNYXhIUCcsIDEwMCwgOTk5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnRU4nLCAwLCA5OSkubmFtZSgnTWF4IEVOJykubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnU1AnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQVQnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnUEEnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQkwnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnU0gnLCAwLCA5OSkubGlzdGVuKCk7CiAgICAgICAgICAgIHN0YXRGb2xkZXIuYWRkKHByb3h5LCAnQ0EnLCAwLCA5OSkubGlzdGVuKCk7CgogICAgICAgICAgICBjb25zdCBhY3Rpb25Gb2xkZXIgPSBmb2xkZXIuYWRkRm9sZGVyKCdBY3Rpb25zJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdMZXZlbFVwJykubmFtZSgnSW5zdGFudCBMZXZlbCBVcCcpOwogICAgICAgICAgICBhY3Rpb25Gb2xkZXIuYWRkKHByb3h5LCAnRnVsbEhlYWwnKS5uYW1lKCdGdWxsIEhlYWwgJiBDdXJlJyk7CiAgICAgICAgICAgIGFjdGlvbkZvbGRlci5hZGQocHJveHksICdEcmFpbkVOJykubmFtZSgnRHJhaW4gRU4gKEZ1bWJsZSknKTsKICAgICAgICB9Cgpfc2V0dXBCYWxsU2FuZGJveCgpIHsKICAgIGNvbnN0IHJvb3QgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0JhbGwgTGFiIChUaHJvdyAmIFBoeXNpY3MpJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBTaGFyZWQgc3RhdGUgb2JqZWN0IChsaXZlcyBvbiB3aW5kb3cuZmx1eCBzbyBpdCBzdXJ2aXZlcyByZWxvYWRzKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBsYWIgPSB3aW5kb3cuZmx1eC5iYWxsTGFiID0gd2luZG93LmZsdXguYmFsbExhYiB8fCB7fTsKICAgIGxhYi5nYW1lID0gdGhpcy5nYW1lOwoKICAgIGNvbnN0IEMgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnOwogICAgY29uc3QgVEMgPSB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZzsKCiAgICBpZiAoIUMgfHwgIVRDKSB7CiAgICAgICAgY29uc29sZS53YXJuKCJCYWxsIExhYjogTWlzc2luZyBCYWxsQ29uZmlnIG9yIFRocm93Q29uZmlnLiIpOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEhlbHBlcnMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgZ2V0QmFsbCA9ICgpID0+IHRoaXMuZ2FtZSAmJiB0aGlzLmdhbWUuZW50aXRpZXMgPyB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbCA6IG51bGw7CiAgICBjb25zdCBnZXRBY3RpdmUgPSAoKSA9PiB0aGlzLmdhbWUgJiYgdGhpcy5nYW1lLnRlYW1zICYmIHRoaXMuZ2FtZS50ZWFtcy5ob21lID8gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyIDogbnVsbDsKCiAgICBjb25zdCBlbnN1cmVQcmV2aWV3TGluZSA9ICgpID0+IHsKICAgICAgICBpZiAobGFiLnByZXZpZXdMaW5lKSByZXR1cm47CiAgICAgICAgaWYgKCF0aGlzLmdhbWUgfHwgIXRoaXMuZ2FtZS5zY2VuZSkgcmV0dXJuOwoKICAgICAgICBjb25zdCBnZW9tID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgdHJhbnNwYXJlbnQ6IHRydWUsIG9wYWNpdHk6IDAuOTUgfSk7CiAgICAgICAgY29uc3QgbGluZSA9IG5ldyBUSFJFRS5MaW5lKGdlb20sIG1hdCk7CiAgICAgICAgbGluZS5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7CiAgICAgICAgbGluZS5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKGxpbmUpOwogICAgICAgIGxhYi5wcmV2aWV3TGluZSA9IGxpbmU7CiAgICB9OwoKICAgIGNvbnN0IGNsZWFyUHJldmlld0xpbmUgPSAoKSA9PiB7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3TGluZSAmJiBsYWIucHJldmlld0xpbmUuZ2VvbWV0cnkpIHsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBBIHNhZmUgImdob3N0IGJhbGwiIHRoYXQgY2FuIHVzZSBCYWxsLnVwZGF0ZUZyZWUgd2l0aG91dCBzcGF3bmluZyBGWAogICAgY29uc3QgbWFrZUdob3N0QmFsbCA9IChwb3MsIHZlbCwgc3BpbikgPT4gewogICAgICAgIGNvbnN0IGdiID0gewogICAgICAgICAgICBtZXNoOiB7IHBvc2l0aW9uOiBwb3MuY2xvbmUoKSB9LAogICAgICAgICAgICB2ZWxvY2l0eTogdmVsLmNsb25lKCksCiAgICAgICAgICAgIGFuZ3VsYXJWZWxvY2l0eTogKHNwaW4gPyBzcGluLmNsb25lKCkgOiBuZXcgVEhSRUUuVmVjdG9yMygpKSwKICAgICAgICAgICAgYWNjdW11bGF0ZWRSb3RhdGlvbjogbmV3IFRIUkVFLlF1YXRlcm5pb24oKSwKICAgICAgICAgICAgcG93ZXI6IDAsCiAgICAgICAgICAgIGRlY2F5UmF0ZTogMCwKICAgICAgICAgICAgX2J1YmJsZVRpbWVyOiA5OTksCiAgICAgICAgICAgIF9naG9zdDogdHJ1ZSwKICAgICAgICAgICAgZGVmb3JtTm9kZTogbnVsbAogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGdiOwogICAgfTsKCiAgICAvLyBVc2UgQmFsbC51cGRhdGVGcmVlIGZvciBmYWl0aGZ1bCB0cmFqZWN0b3J5IHByZWRpY3Rpb24KICAgIGNvbnN0IHNpbXVsYXRlID0gKGdob3N0QmFsbCwgc3RlcHMsIHN0ZXBEdCkgPT4gewogICAgICAgIGNvbnN0IHB0cyA9IFtdOwogICAgICAgIHB0cy5wdXNoKGdob3N0QmFsbC5tZXNoLnBvc2l0aW9uLmNsb25lKCkpOwogICAgICAgIGNvbnN0IHByb3RvID0gd2luZG93LmZsdXguQmFsbCAmJiB3aW5kb3cuZmx1eC5CYWxsLnByb3RvdHlwZTsKICAgICAgICBpZiAoIXByb3RvIHx8IHR5cGVvZiBwcm90by51cGRhdGVGcmVlICE9PSAnZnVuY3Rpb24nKSByZXR1cm4gcHRzOwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ZXBzOyBpKyspIHsKICAgICAgICAgICAgcHJvdG8udXBkYXRlRnJlZS5jYWxsKGdob3N0QmFsbCwgc3RlcER0KTsKICAgICAgICAgICAgcHRzLnB1c2goZ2hvc3RCYWxsLm1lc2gucG9zaXRpb24uY2xvbmUoKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwdHM7CiAgICB9OwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gUHJldmlldyArIHJlY29yZC9yZXBsYXkgcnVudGltZSBsb29wCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KbGFiLnByZXZpZXcgPSBsYWIucHJldmlldyB8fCB7CiAgICAgICAgZW5hYmxlZDogZmFsc2UsCiAgICAgICAgc291cmNlOiAnQ2Fubm9uJywKICAgICAgICBzdGVwczogMTIwLAogICAgICAgIHN0ZXBEdDogMS82MCwKICAgICAgICByZWZyZXNoSHo6IDEwLAogICAgICAgIHNob3dPbkhlbGRPbmx5OiBmYWxzZQogICAgfTsKCiAgICBsYWIuY2Fubm9uID0gbGFiLmNhbm5vbiB8fCB7CiAgICAgICAgeWF3OiAwLAogICAgICAgIHBpdGNoOiAwLAogICAgICAgIHBvd2VyOiAyMCwKICAgICAgICB0eXBlOiAnU0gnLAogICAgICAgIHNwaW5YOiAwLAogICAgICAgIHNwaW5ZOiAwLAogICAgICAgIHNwaW5aOiAwLAogICAgICAgIGZpcmVCdXJzdDogMSwKICAgICAgICBzcHJlYWREZWc6IDAKICAgIH07CgogICAgbGFiLnJlY29yZGluZyA9IGxhYi5yZWNvcmRpbmcgfHwgewogICAgICAgIGlzUmVjb3JkaW5nOiBmYWxzZSwKICAgICAgICBmcmFtZXM6IFtdLAogICAgICAgIG1heFNlY29uZHM6IDEyCiAgICB9OwoKICAgIGxhYi5yZXBsYXkgPSBsYWIucmVwbGF5IHx8IHsKICAgICAgICBpc1JlcGxheWluZzogZmFsc2UsCiAgICAgICAgZnJhbWVzOiBbXSwKICAgICAgICBpZHg6IDAsCiAgICAgICAgbG9vcDogdHJ1ZSwKICAgICAgICBzcGVlZDogMS4wCiAgICB9OwoKICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgbGFiLnRhcmdldEJhbGwgPSBudWxsOwoKICAgIGxhYi5hcHBseVJlcGxheUZyYW1lID0gKGJhbGwsIGR0KSA9PiB7CiAgICAgICAgY29uc3QgcmVwID0gbGFiLnJlcGxheTsKICAgICAgICBpZiAoIXJlcCB8fCAhcmVwLmlzUmVwbGF5aW5nIHx8ICFyZXAuZnJhbWVzIHx8IHJlcC5mcmFtZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBBZHZhbmNlIHRpbWUgYnkgc3RlcHBpbmcgaW5kaWNlcyAoZnJhbWUtYmFzZWQpCiAgICAgICAgY29uc3Qgc3RlcCA9IE1hdGgubWF4KDEsIE1hdGguZmxvb3IocmVwLnNwZWVkKSk7CiAgICAgICAgcmVwLmlkeCArPSBzdGVwOwoKICAgICAgICBpZiAocmVwLmlkeCA+PSByZXAuZnJhbWVzLmxlbmd0aCkgewogICAgICAgICAgICBpZiAocmVwLmxvb3ApIHJlcC5pZHggPSAwOwogICAgICAgICAgICBlbHNlIHsgcmVwLmlzUmVwbGF5aW5nID0gZmFsc2U7IGxhYi5pc1JlcGxheWluZyA9IGZhbHNlOyByZXR1cm47IH0KICAgICAgICB9CgogICAgICAgIGNvbnN0IGYgPSByZXAuZnJhbWVzW3JlcC5pZHhdOwogICAgICAgIGlmICghZikgcmV0dXJuOwoKICAgICAgICBiYWxsLmRyb3AoKTsgLy8gZW5zdXJlIG5vIGhvbGRlciBsb2dpYyBmaWdodHMgdXMKICAgICAgICBiYWxsLnN0YXRlID0gJ2ZyZWUnOwogICAgICAgIGJhbGwubWVzaC5wb3NpdGlvbi5zZXQoZi5weCwgZi5weSwgZi5weik7CiAgICAgICAgYmFsbC52ZWxvY2l0eS5zZXQoZi52eCwgZi52eSwgZi52eik7CiAgICAgICAgYmFsbC5hbmd1bGFyVmVsb2NpdHkuc2V0KGYuc3gsIGYuc3ksIGYuc3opOwogICAgfTsKCiAgICBsYWIuX3ByZXZpZXdUaW1lciA9IGxhYi5fcHJldmlld1RpbWVyIHx8IDA7CgogICAgbGFiLnVwZGF0ZSA9IChkdCkgPT4gewogICAgICAgIC8vIC0tLSByZWNvcmRpbmcgLS0tCiAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICBpZiAoYiAmJiBsYWIucmVjb3JkaW5nICYmIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcpIHsKICAgICAgICAgICAgY29uc3QgciA9IGxhYi5yZWNvcmRpbmc7CiAgICAgICAgICAgIGNvbnN0IG1heEZyYW1lcyA9IE1hdGguZmxvb3IoKHIubWF4U2Vjb25kcyB8fCAxMikgLyAoZHQgfHwgKDEvNjApKSk7CiAgICAgICAgICAgIGlmIChyLmZyYW1lcy5sZW5ndGggPiBtYXhGcmFtZXMpIHIuZnJhbWVzLnNoaWZ0KCk7CiAgICAgICAgICAgIHIuZnJhbWVzLnB1c2goewogICAgICAgICAgICAgICAgcHg6IGIubWVzaC5wb3NpdGlvbi54LCBweTogYi5tZXNoLnBvc2l0aW9uLnksIHB6OiBiLm1lc2gucG9zaXRpb24ueiwKICAgICAgICAgICAgICAgIHZ4OiBiLnZlbG9jaXR5LngsIHZ5OiBiLnZlbG9jaXR5LnksIHZ6OiBiLnZlbG9jaXR5LnosCiAgICAgICAgICAgICAgICBzeDogYi5hbmd1bGFyVmVsb2NpdHkueCwgc3k6IGIuYW5ndWxhclZlbG9jaXR5LnksIHN6OiBiLmFuZ3VsYXJWZWxvY2l0eS56CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIHByZXZpZXcgcmVmcmVzaCAtLS0KICAgICAgICBsYWIuX3ByZXZpZXdUaW1lciArPSBkdDsKICAgICAgICBjb25zdCByZWZyZXNoSW50ZXJ2YWwgPSAxLjAgLyBNYXRoLm1heCgxLCAobGFiLnByZXZpZXcucmVmcmVzaEh6IHx8IDEwKSk7CiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LmVuYWJsZWQgJiYgbGFiLl9wcmV2aWV3VGltZXIgPj0gcmVmcmVzaEludGVydmFsKSB7CiAgICAgICAgICAgIGxhYi5fcHJldmlld1RpbWVyID0gMDsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfQogICAgfTsKCiAgICBsYWIucmVmcmVzaFByZXZpZXcgPSAoKSA9PiB7CiAgICAgICAgaWYgKCFsYWIucHJldmlldy5lbmFibGVkKSB7IGNsZWFyUHJldmlld0xpbmUoKTsgcmV0dXJuOyB9CiAgICAgICAgZW5zdXJlUHJldmlld0xpbmUoKTsKCiAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgaWYgKCFiIHx8ICFiLm1lc2gpIHJldHVybjsKCiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LnNob3dPbkhlbGRPbmx5ICYmIGIuc3RhdGUgIT09ICdoZWxkJykgewogICAgICAgICAgICBjbGVhclByZXZpZXdMaW5lKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIERlY2lkZSBwcmV2aWV3IHNvdXJjZQogICAgICAgIGxldCBzdGFydFBvcyA9IGIubWVzaC5wb3NpdGlvbjsKICAgICAgICBsZXQgc3RhcnRWZWwgPSBiLnZlbG9jaXR5OwogICAgICAgIGxldCBzdGFydFNwaW4gPSBiLmFuZ3VsYXJWZWxvY2l0eTsKCiAgICAgICAgaWYgKGxhYi5wcmV2aWV3LnNvdXJjZSA9PT0gJ0Nhbm5vbicpIHsKICAgICAgICAgICAgLy8gQ2Fubm9uIGFsd2F5cyBsYXVuY2hlcyBmcm9tIGJhbGwgcG9zaXRpb24gKG9yIHBsYXllciBpZiBoZWxkKQogICAgICAgICAgICBjb25zdCB5YXdSYWQgPSAobGFiLmNhbm5vbi55YXcgfHwgMCkgKiBNYXRoLlBJIC8gMTgwOwogICAgICAgICAgICBjb25zdCBwaXRjaFJhZCA9IChsYWIuY2Fubm9uLnBpdGNoIHx8IDApICogTWF0aC5QSSAvIDE4MDsKCiAgICAgICAgICAgIGNvbnN0IGRpciA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICAgICAgTWF0aC5zaW4oeWF3UmFkKSAqIE1hdGguY29zKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIE1hdGguc2luKHBpdGNoUmFkKSwKICAgICAgICAgICAgICAgIC1NYXRoLmNvcyh5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpCiAgICAgICAgICAgICkubm9ybWFsaXplKCk7CgogICAgICAgICAgICBjb25zdCBjYXAgPSAod2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfQ0FQICE9PSB1bmRlZmluZWQgPyB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkxBVU5DSF9TUEVFRF9DQVAgOiA4NS4wKTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAod2luZG93LmZsdXguQmFsbENvbmZpZy5MQVVOQ0hfU1BFRURfU0NBTEUgIT09IHVuZGVmaW5lZCA/IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuTEFVTkNIX1NQRUVEX1NDQUxFIDogMS4wKTsKICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSBNYXRoLm1pbigobGFiLmNhbm5vbi5wb3dlciB8fCAyMCkgKiBzY2FsZSwgY2FwKTsKCiAgICAgICAgICAgIHN0YXJ0UG9zID0gKGIuc3RhdGUgPT09ICdoZWxkJyAmJiBwICYmIHAubWVzaCkgPyBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMS4yLCAwKSkgOiBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgc3RhcnRWZWwgPSBkaXIubXVsdGlwbHlTY2FsYXIoc3BlZWQpOwogICAgICAgICAgICBzdGFydFNwaW4gPSBuZXcgVEhSRUUuVmVjdG9yMyhsYWIuY2Fubm9uLnNwaW5YIHx8IDAsIGxhYi5jYW5ub24uc3BpblkgfHwgMCwgbGFiLmNhbm5vbi5zcGluWiB8fCAwKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGdob3N0ID0gbWFrZUdob3N0QmFsbChzdGFydFBvcy5jbG9uZSgpLCBzdGFydFZlbC5jbG9uZSgpLCBzdGFydFNwaW4pOwogICAgICAgIGNvbnN0IHB0cyA9IHNpbXVsYXRlKGdob3N0LCBNYXRoLmZsb29yKGxhYi5wcmV2aWV3LnN0ZXBzIHx8IDEyMCksIChsYWIucHJldmlldy5zdGVwRHQgfHwgKDEvNjApKSk7CgogICAgICAgIGlmIChsYWIucHJldmlld0xpbmUpIHsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgbGFiLnByZXZpZXdMaW5lLmdlb21ldHJ5ID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCkuc2V0RnJvbVBvaW50cyhwdHMpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IEJhbGwgUGh5c2ljcyAoQmFsbENvbmZpZykKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcGh5cyA9IHJvb3QuYWRkRm9sZGVyKCdCYWxsIFBoeXNpY3MgKEJhbGxDb25maWcpJyk7CgogICAgY29uc3QgaW50ZWcgPSBwaHlzLmFkZEZvbGRlcignSW50ZWdyYXRpb24nKTsKICAgIGludGVnLmFkZChDLCAnU1VCU1RFUFMnLCAxLCAxMiwgMSkubmFtZSgnU3Vic3RlcHMnKTsKICAgIGludGVnLmFkZChDLCAnU1RPUF9TUEVFRCcsIDAuMCwgMC4yKS5uYW1lKCdTdG9wIFNwZWVkJyk7CgogICAgY29uc3QgZHJhZyA9IHBoeXMuYWRkRm9sZGVyKCdXYXRlciBEcmFnJyk7CiAgICBkcmFnLmFkZChDLCAnV0FURVJfRFJBR19MSU5FQVInLCAwLjAsIDIuMCkubmFtZSgnTGluZWFyIERyYWcnKTsKICAgIGRyYWcuYWRkKEMsICdXQVRFUl9EUkFHX1FVQUQnLCAwLjAsIDAuMDUpLm5hbWUoJ1F1YWRyYXRpYyBEcmFnJyk7CgogICAgY29uc3Qgc3BpbiA9IHBoeXMuYWRkRm9sZGVyKCdTcGluJyk7CiAgICBzcGluLmFkZChDLCAnU1BJTl9EUkFHJywgMC4wLCAzLjApLm5hbWUoJ1NwaW4gRGVjYXknKTsKCiAgICBjb25zdCBtYWdudXMgPSBwaHlzLmFkZEZvbGRlcignTWFnbnVzJyk7CiAgICBtYWdudXMuYWRkKEMsICdNQUdOVVNfRU5BQkxFRCcpLm5hbWUoJ0VuYWJsZWQnKTsKICAgIG1hZ251cy5hZGQoQywgJ01BR05VU19DT0VGRicsIDAuMCwgMC41KS5uYW1lKCdDb2VmZicpOwogICAgbWFnbnVzLmFkZChDLCAnTUFHTlVTX0NBUCcsIDAuMCwgMjAwLjApLm5hbWUoJ0NhcCcpOwoKICAgIGNvbnN0IGRlcHRoID0gcGh5cy5hZGRGb2xkZXIoJ0RlcHRoIENvbnN0cmFpbnQnKTsKICAgIGRlcHRoLmFkZChDLCAnREVQVEhfVEFSR0VUX1knLCAtNS4wLCA1LjApLm5hbWUoJ1RhcmdldCBZJyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX1NQUklORycsIDAuMCwgMTAuMCkubmFtZSgnU3ByaW5nJyk7CiAgICBkZXB0aC5hZGQoQywgJ0RFUFRIX0RBTVAnLCAwLjAsIDYuMCkubmFtZSgnRGFtcCcpOwoKICAgIGNvbnN0IGFyZW5hID0gcGh5cy5hZGRGb2xkZXIoJ0FyZW5hIEJvdW5kYXJ5Jyk7CiAgICBhcmVuYS5hZGQoQywgJ0JPVU5EQVJZX1JBRElVUycsIDEwLjAsIDEyMC4wKS5uYW1lKCdSYWRpdXMnKTsKICAgIGFyZW5hLmFkZChDLCAnQk9VTkRBUllfSEVJR0hUJywgMi4wLCA0MC4wKS5uYW1lKCdIZWlnaHQnKTsKYXJlbmEuYWRkKEMsICdCT1VOREFSWV9IRUlHSFQnLCAyLjAsIDQwLjApLm5hbWUoJ0hlaWdodCcpOwogICAgYXJlbmEuYWRkKEMsICdHT0FMX0RJU1RBTkNFJywgMjAuMCwgNjAuMCkubmFtZSgnR29hbCBEaXN0YW5jZScpLm9uQ2hhbmdlKHYgPT4gewogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQSkgd2luZG93LmZsdXguZ29hbEEucG9zaXRpb24ueiA9IC12OwogICAgICAgIGlmICh3aW5kb3cuZmx1eC5nb2FsQikgd2luZG93LmZsdXguZ29hbEIucG9zaXRpb24ueiA9IHY7CiAgICAgICAgLy8gVXBkYXRlIERlYnVnIFZpc3VhbHMgaWYgYWN0aXZlCiAgICAgICAgaWYgKHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSAmJiB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UuZGVidWdWaXN1YWxpemVyKSB7CiAgICAgICAgICAgIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5kZWJ1Z1Zpc3VhbGl6ZXIudXBkYXRlR29hbFZvbHVtZXMoKTsKICAgICAgICB9CiAgICB9KTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9TT0ZUX0JVRkZFUicsIDAuMCwgMjAuMCkubmFtZSgnU29mdCBCdWZmZXInKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9TT0ZUX0ZPUkNFJywgMC4wLCAyMDAuMCkubmFtZSgnU29mdCBGb3JjZScpOwogICAgYXJlbmEuYWRkKEMsICdXQUxMX0VMQVNUSUNJVFknLCAwLjAsIDEuMCkubmFtZSgnV2FsbCBCb3VuY2UnKTsKICAgIGFyZW5hLmFkZChDLCAnV0FMTF9GUklDVElPTicsIDAuMCwgMS4wKS5uYW1lKCdXYWxsIEZyaWN0aW9uJyk7CiAgICBhcmVuYS5hZGQoQywgJ0ZMT09SX0VMQVNUSUNJVFknLCAwLjAsIDEuMCkubmFtZSgnQ2VpbC9GbG9vciBCb3VuY2UnKTsKCiAgICBjb25zdCBwb2NrZXQgPSBhcmVuYS5hZGRGb2xkZXIoJ0dvYWwgUG9ja2V0Jyk7CiAgICBwb2NrZXQuYWRkKEMsICdHT0FMX1BPQ0tFVF9FTkFCTEVEJykubmFtZSgnRW5hYmxlZCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfWCcsIDAuMCwgNDAuMCkubmFtZSgnUG9ja2V0IEhhbGYtWCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfWicsIDAuMCwgNTAuMCkubmFtZSgnUG9ja2V0IFN0YXJ0IHxafCcpOwogICAgcG9ja2V0LmFkZChDLCAnR09BTF9QT0NLRVRfUkFESVVTJywgMTAuMCwgMTIwLjApLm5hbWUoJ1BvY2tldCBSYWRpdXMnKTsKCiAgICBjb25zdCBsYXVuY2ggPSBwaHlzLmFkZEZvbGRlcignTGF1bmNoIE1hcHBpbmcnKTsKICAgIGxhdW5jaC5hZGQoQywgJ0xBVU5DSF9TUEVFRF9TQ0FMRScsIDAuMSwgNS4wKS5uYW1lKCdTcGVlZCBTY2FsZScpOwogICAgbGF1bmNoLmFkZChDLCAnTEFVTkNIX1NQRUVEX0NBUCcsIDEwLjAsIDIwMC4wKS5uYW1lKCdTcGVlZCBDYXAnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogVGhyb3cgbWFwcGluZyAoUGxheWVyLnJlbGVhc2VDaGFyZ2UgLT4gQmFsbC5zaG9vdCkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgdGhyb3dNYXAgPSByb290LmFkZEZvbGRlcignVGhyb3cgTWFwcGluZyAoVGhyb3dDb25maWcpJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdTV0lQRV9NSU5fUFgnLCAwLCAxMjAsIDEpLm5hbWUoJ1N3aXBlIE1pbiBQWCcpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnQUlNX0RYX1NDQUxFJywgMC4xLCA1LjApLm5hbWUoJ0FpbSBYIFNjYWxlJyk7CiAgICB0aHJvd01hcC5hZGQoVEMsICdBSU1fRFlfU0NBTEUnLCAwLjEsIDUuMCkubmFtZSgnQWltIFkgU2NhbGUnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX0JBU0UnLCAwLjEsIDMuMCkubmFtZSgnUG93ZXIgQmFzZScpOwogICAgdGhyb3dNYXAuYWRkKFRDLCAnUE9XRVJfUkFOR0UnLCAwLjAsIDMuMCkubmFtZSgnUG93ZXIgUmFuZ2UnKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX01BWF9CT05VU19SQVRJTycsIDAuMCwgMS4wKS5uYW1lKCdNYXggQm9udXMgUmF0aW8nKTsKICAgIHRocm93TWFwLmFkZChUQywgJ1BPV0VSX01BWF9NVUxUSVBMSUVSJywgMS4wLCA2LjApLm5hbWUoJ01heCBNdWx0aXBsaWVyJyk7CgogICAgY29uc3QgY3VydmVNYXAgPSB0aHJvd01hcC5hZGRGb2xkZXIoJ0N1cnZlJyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9FTkFCTEVEJykubmFtZSgnRW5hYmxlZCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfSU5URU5TSVRZX1RIUkVTSE9MRCcsIDAuMCwgMS4wKS5uYW1lKCdJbnB1dCBUaHJlc2hvbGQnKTsKICAgIGN1cnZlTWFwLmFkZChUQywgJ0NVUlZFX1NQSU5fU0NBTEUnLCAwLjAsIDQwMDAuMCkubmFtZSgnU3BpbiBTY2FsZScpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfU1BFRURfTVVMVCcsIDAuMCwgNS4wKS5uYW1lKCdTd2lwZSBTcGVlZCBNdWx0Jyk7CiAgICBjdXJ2ZU1hcC5hZGQoVEMsICdDVVJWRV9TUElOX0NBUCcsIDAuMCwgNjAwMC4wKS5uYW1lKCdTcGluIENhcCcpOwogICAgY3VydmVNYXAuYWRkKFRDLCAnQ1VSVkVfUEVSRkVDVF9TUElOJywgMC4wLCAyMDAwLjApLm5hbWUoJ1BlcmZlY3QgVGhyZXNob2xkJyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFRlbGVwb3J0IC8gU3RhdGUgdG9vbHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgdHAgPSByb290LmFkZEZvbGRlcignVGVsZXBvcnQgLyBSZXNldCcpOwogICAgY29uc3QgdHBQYXJhbXMgPSB7CiAgICAgICAgVG9DZW50ZXI6ICgpID0+IHsgY29uc3QgYiA9IGdldEJhbGwoKTsgaWYgKGIpIGIucmVzZXQoKTsgfSwKICAgICAgICBUb0FjdGl2ZVBsYXllcjogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBjb25zdCBwID0gZ2V0QWN0aXZlKCk7IGlmIChiICYmIHApIGIuZ3JhYihwKTsgfSwKICAgICAgICBUb0hvbWVHb2FsOiAoKSA9PiB7IGNvbnN0IGIgPSBnZXRCYWxsKCk7IGlmIChiKSB7IGIuZHJvcCgpOyBiLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDI1KTsgYi52ZWxvY2l0eS5zZXQoMCwwLDApOyBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOyB9IH0sCiAgICAgICAgVG9Bd2F5R29hbDogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMjUpOyBiLnZlbG9jaXR5LnNldCgwLDAsMCk7IGIuYW5ndWxhclZlbG9jaXR5LnNldCgwLDAsMCk7IH0gfSwKICAgICAgICBUb1NreTogKCkgPT4geyBjb25zdCBiID0gZ2V0QmFsbCgpOyBpZiAoYikgeyBiLmRyb3AoKTsgYi5tZXNoLnBvc2l0aW9uLnNldCgwLCAxMCwgMCk7IGIudmVsb2NpdHkuc2V0KDAsMCwwKTsgYi5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsMCwwKTsgfSB9LAogICAgICAgIENsZWFyUHJldmlldzogKCkgPT4gY2xlYXJQcmV2aWV3TGluZSgpCiAgICB9OwogICAgdHAuYWRkKHRwUGFyYW1zLCAnVG9DZW50ZXInKTsKICAgIHRwLmFkZCh0cFBhcmFtcywgJ1RvQWN0aXZlUGxheWVyJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0hvbWVHb2FsJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb0F3YXlHb2FsJyk7CiAgICB0cC5hZGQodHBQYXJhbXMsICdUb1NreScpOwogICAgdHAuYWRkKHRwUGFyYW1zLCAnQ2xlYXJQcmV2aWV3Jyk7CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBGb2xkZXI6IFNob3QgQ2Fubm9uIChmb3JjZSBmaXJlIHdpdGggcGFyYW1zKQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBjb25zdCBjYW5ub24gPSByb290LmFkZEZvbGRlcignU2hvdCBDYW5ub24nKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3lhdycsIC0xODAsIDE4MCwgMSkubmFtZSgnWWF3IChkZWcpJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdwaXRjaCcsIC04OSwgODksIDEpLm5hbWUoJ1BpdGNoIChkZWcpJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdwb3dlcicsIDAsIDEyMCwgMC4xKS5uYW1lKCdQb3dlcicpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAndHlwZScsIFsnUEEnLCdTSCddKS5uYW1lKCdUeXBlJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdzcGluWCcsIC0zMDAwLCAzMDAwLCAxKS5uYW1lKCdTcGluIFgnKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwaW5ZJywgLTMwMDAsIDMwMDAsIDEpLm5hbWUoJ1NwaW4gWScpOwogICAgY2Fubm9uLmFkZChsYWIuY2Fubm9uLCAnc3BpblonLCAtMzAwMCwgMzAwMCwgMSkubmFtZSgnU3BpbiBaJyk7CiAgICBjYW5ub24uYWRkKGxhYi5jYW5ub24sICdmaXJlQnVyc3QnLCAxLCAxMCwgMSkubmFtZSgnQnVyc3QgQ291bnQnKTsKICAgIGNhbm5vbi5hZGQobGFiLmNhbm5vbiwgJ3NwcmVhZERlZycsIDAsIDMwLCAwLjUpLm5hbWUoJ1NwcmVhZCAoZGVnKScpOwoKICAgIGNvbnN0IGZpcmVQYXJhbXMgPSB7CiAgICAgICAgRmlyZTogKCkgPT4gewogICAgICAgICAgICBjb25zdCBiID0gZ2V0QmFsbCgpOwogICAgICAgICAgICBjb25zdCBwID0gZ2V0QWN0aXZlKCk7CiAgICAgICAgICAgIGlmICghYikgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgeWF3UmFkID0gKGxhYi5jYW5ub24ueWF3IHx8IDApICogTWF0aC5QSSAvIDE4MDsKICAgICAgICAgICAgY29uc3QgcGl0Y2hSYWQgPSAobGFiLmNhbm5vbi5waXRjaCB8fCAwKSAqIE1hdGguUEkgLyAxODA7CgogICAgICAgICAgICBjb25zdCBiYXNlRGlyID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgICAgICAgICBNYXRoLnNpbih5YXdSYWQpICogTWF0aC5jb3MocGl0Y2hSYWQpLAogICAgICAgICAgICAgICAgTWF0aC5zaW4ocGl0Y2hSYWQpLAogICAgICAgICAgICAgICAgLU1hdGguY29zKHlhd1JhZCkgKiBNYXRoLmNvcyhwaXRjaFJhZCkKICAgICAgICAgICAgKS5ub3JtYWxpemUoKTsKCiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gKGIuc3RhdGUgPT09ICdoZWxkJyAmJiBwICYmIHAubWVzaCkgPyBwLm1lc2gucG9zaXRpb24uY2xvbmUoKS5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMS4yLCAwKSkgOiBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKCiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgKGxhYi5jYW5ub24uZmlyZUJ1cnN0IHx8IDEpOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRpciA9IGJhc2VEaXIuY2xvbmUoKTsKICAgICAgICAgICAgICAgIGlmIChsYWIuY2Fubm9uLnNwcmVhZERlZyA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcHJlYWQgPSAobGFiLmNhbm5vbi5zcHJlYWREZWcgKiBNYXRoLlBJIC8gMTgwKTsKICAgICAgICAgICAgICAgICAgICBkaXIueCArPSAoTWF0aC5yYW5kb20oKS0wLjUpICogc3ByZWFkOwogICAgICAgICAgICAgICAgICAgIGRpci55ICs9IChNYXRoLnJhbmRvbSgpLTAuNSkgKiBzcHJlYWQ7CiAgICAgICAgICAgICAgICAgICAgZGlyLnogKz0gKE1hdGgucmFuZG9tKCktMC41KSAqIHNwcmVhZDsKICAgICAgICAgICAgICAgICAgICBkaXIubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYi5kcm9wKCk7CiAgICAgICAgICAgICAgICBiLm1lc2gucG9zaXRpb24uY29weShzdGFydCk7CiAgICAgICAgICAgICAgICBiLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwwLDApOwoKICAgICAgICAgICAgICAgIGNvbnN0IHNwaW4gPSBuZXcgVEhSRUUuVmVjdG9yMyhsYWIuY2Fubm9uLnNwaW5YIHx8IDAsIGxhYi5jYW5ub24uc3BpblkgfHwgMCwgbGFiLmNhbm5vbi5zcGluWiB8fCAwKTsKICAgICAgICAgICAgICAgIGIuc2hvb3QoZGlyLCBsYWIuY2Fubm9uLnBvd2VyIHx8IDIwLCBsYWIuY2Fubm9uLnR5cGUgfHwgJ1NIJywgbnVsbCwgc3Bpbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgY2Fubm9uLmFkZChmaXJlUGFyYW1zLCAnRmlyZScpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBUcmFqZWN0b3J5IFByZXZpZXcKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3QgcHJldmlldyA9IHJvb3QuYWRkRm9sZGVyKCdUcmFqZWN0b3J5IFByZXZpZXcnKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnZW5hYmxlZCcpLm5hbWUoJ0VuYWJsZWQnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3NvdXJjZScsIFsnQ2Fubm9uJywgJ0xpdmUgQmFsbCddKS5uYW1lKCdTb3VyY2UnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3N0ZXBzJywgMTAsIDYwMCwgMSkubmFtZSgnU3RlcHMnKS5vbkNoYW5nZSgoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSk7CiAgICBwcmV2aWV3LmFkZChsYWIucHJldmlldywgJ3N0ZXBEdCcsIDEvMjQwLCAxLzE1LCAxLzI0MCkubmFtZSgnU3RlcCBkdCcpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAncmVmcmVzaEh6JywgMSwgNjAsIDEpLm5hbWUoJ1JlZnJlc2ggSHonKTsKICAgIHByZXZpZXcuYWRkKGxhYi5wcmV2aWV3LCAnc2hvd09uSGVsZE9ubHknKS5uYW1lKCdPbmx5IHdoZW4gSGVsZCcpLm9uQ2hhbmdlKCgpID0+IGxhYi5yZWZyZXNoUHJldmlldygpKTsKCiAgICBjb25zdCBwcmV2aWV3QnRucyA9IHsKICAgICAgICBSZWZyZXNoOiAoKSA9PiBsYWIucmVmcmVzaFByZXZpZXcoKSwKICAgICAgICBIaWRlOiAoKSA9PiB7IGxhYi5wcmV2aWV3LmVuYWJsZWQgPSBmYWxzZTsgY2xlYXJQcmV2aWV3TGluZSgpOyB9CiAgICB9OwogICAgcHJldmlldy5hZGQocHJldmlld0J0bnMsICdSZWZyZXNoJyk7CiAgICBwcmV2aWV3LmFkZChwcmV2aWV3QnRucywgJ0hpZGUnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogUmVjb3JkIC8gUmVwbGF5CiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHJyID0gcm9vdC5hZGRGb2xkZXIoJ1JlY29yZCAvIFJlcGxheScpOwogICAgY29uc3QgcnJQYXJhbXMgPSB7CiAgICAgICAgUmVjb3JkOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZWNvcmRpbmcuaXNSZWNvcmRpbmcgPSB0cnVlOwogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmZyYW1lcyA9IFtdOwogICAgICAgIH0sCiAgICAgICAgU3RvcDogKCkgPT4gewogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmlzUmVjb3JkaW5nID0gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICBVc2VSZWNvcmRpbmdGb3JSZXBsYXk6ICgpID0+IHsKICAgICAgICAgICAgbGFiLnJlcGxheS5mcmFtZXMgPSAobGFiLnJlY29yZGluZy5mcmFtZXMgfHwgW10pLnNsaWNlKCk7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaWR4ID0gMDsKICAgICAgICB9LAogICAgICAgIFBsYXk6ICgpID0+IHsKICAgICAgICAgICAgY29uc3QgYiA9IGdldEJhbGwoKTsKICAgICAgICAgICAgaWYgKCFiKSByZXR1cm47CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaXNSZXBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICBsYWIuaXNSZXBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICBsYWIudGFyZ2V0QmFsbCA9IGI7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaWR4ID0gMDsKICAgICAgICB9LAogICAgICAgIFBhdXNlOiAoKSA9PiB7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgbGFiLmlzUmVwbGF5aW5nID0gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICBDbGVhcjogKCkgPT4gewogICAgICAgICAgICBsYWIucmVjb3JkaW5nLmZyYW1lcyA9IFtdOwogICAgICAgICAgICBsYWIucmVwbGF5LmZyYW1lcyA9IFtdOwogICAgICAgICAgICBsYWIucmVwbGF5LmlkeCA9IDA7CiAgICAgICAgICAgIGxhYi5yZXBsYXkuaXNSZXBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgbGFiLmlzUmVwbGF5aW5nID0gZmFsc2U7CiAgICAgICAgfQogICAgfTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1JlY29yZCcpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnU3RvcCcpOwogICAgcnIuYWRkKHJyUGFyYW1zLCAnVXNlUmVjb3JkaW5nRm9yUmVwbGF5JykubmFtZSgnQ29weSBSZWMgLT4gUmVwbGF5Jyk7CiAgICByci5hZGQobGFiLnJlcGxheSwgJ2xvb3AnKS5uYW1lKCdMb29wJyk7CiAgICByci5hZGQobGFiLnJlcGxheSwgJ3NwZWVkJywgMC4yNSwgNi4wLCAwLjI1KS5uYW1lKCdSZXBsYXkgU3BlZWQnKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1BsYXknKTsKICAgIHJyLmFkZChyclBhcmFtcywgJ1BhdXNlJyk7CiAgICByci5hZGQocnJQYXJhbXMsICdDbGVhcicpOwoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRm9sZGVyOiBQcmVzZXRzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGNvbnN0IHByZXNldHMgPSByb290LmFkZEZvbGRlcignUHJlc2V0cycpOwogICAgY29uc3QgUCA9IHsKICAgICAgICBWYW5pbGxhOiAoKSA9PiB7CiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oQywgewogICAgICAgICAgICAgICAgU1VCU1RFUFM6IDIsCiAgICAgICAgICAgICAgICBTVE9QX1NQRUVEOiAwLjAyLAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19MSU5FQVI6IDAuMTUsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX1FVQUQ6IDAuMDAyLAogICAgICAgICAgICAgICAgU1BJTl9EUkFHOiAwLjQwLAogICAgICAgICAgICAgICAgTUFHTlVTX0VOQUJMRUQ6IHRydWUsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ09FRkY6IDAuMDgsCiAgICAgICAgICAgICAgICBNQUdOVVNfQ0FQOiA2MC4wLAogICAgICAgICAgICAgICAgREVQVEhfVEFSR0VUX1k6IDAuMCwKICAgICAgICAgICAgICAgIERFUFRIX1NQUklORzogMS4wLAogICAgICAgICAgICAgICAgREVQVEhfREFNUDogMS41LAogICAgICAgICAgICAgICAgQk9VTkRBUllfUkFESVVTOiAzMy4wLAogICAgICAgICAgICAgICAgQk9VTkRBUllfSEVJR0hUOiAxNS4wLAogICAgICAgICAgICAgICAgV0FMTF9TT0ZUX0JVRkZFUjogMy4wLAogICAgICAgICAgICAgICAgV0FMTF9TT0ZUX0ZPUkNFOiAyMC4wLAogICAgICAgICAgICAgICAgV0FMTF9FTEFTVElDSVRZOiAwLjMwLAogICAgICAgICAgICAgICAgV0FMTF9GUklDVElPTjogMC45NSwKICAgICAgICAgICAgICAgIEZMT09SX0VMQVNUSUNJVFk6IDAuNDAsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9FTkFCTEVEOiB0cnVlLAogICAgICAgICAgICAgICAgR09BTF9QT0NLRVRfWDogMTIuMCwKICAgICAgICAgICAgICAgIEdPQUxfUE9DS0VUX1o6IDI1LjAsCiAgICAgICAgICAgICAgICBHT0FMX1BPQ0tFVF9SQURJVVM6IDQ1LjAsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfU0NBTEU6IDEuMCwKICAgICAgICAgICAgICAgIExBVU5DSF9TUEVFRF9DQVA6IDg1LjAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhYi5yZWZyZXNoUHJldmlldygpOwogICAgICAgIH0sCiAgICAgICAgQXJjYWRlQ3VydmU6ICgpID0+IHsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihDLCB7CiAgICAgICAgICAgICAgICBNQUdOVVNfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIE1BR05VU19DT0VGRjogMC4xNiwKICAgICAgICAgICAgICAgIE1BR05VU19DQVA6IDkwLjAsCiAgICAgICAgICAgICAgICBTUElOX0RSQUc6IDAuMjUsCiAgICAgICAgICAgICAgICBXQVRFUl9EUkFHX0xJTkVBUjogMC4xMiwKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfUVVBRDogMC4wMDEsCiAgICAgICAgICAgICAgICBXQUxMX1NPRlRfRk9SQ0U6IDM1LjAsCiAgICAgICAgICAgICAgICBMQVVOQ0hfU1BFRURfQ0FQOiAxMTAuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihUQywgewogICAgICAgICAgICAgICAgQ1VSVkVfRU5BQkxFRDogdHJ1ZSwKICAgICAgICAgICAgICAgIENVUlZFX1NQSU5fU0NBTEU6IDE1MDAuMCwKICAgICAgICAgICAgICAgIENVUlZFX1NQSU5fQ0FQOiAzMDAwLjAsCiAgICAgICAgICAgICAgICBDVVJWRV9QRVJGRUNUX1NQSU46IDcwMC4wCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsYWIucmVmcmVzaFByZXZpZXcoKTsKICAgICAgICB9LAogICAgICAgIFNuYXBweVJlYWxpc3RpYzogKCkgPT4gewogICAgICAgICAgICBPYmplY3QuYXNzaWduKEMsIHsKICAgICAgICAgICAgICAgIFdBVEVSX0RSQUdfTElORUFSOiAwLjI1LAogICAgICAgICAgICAgICAgV0FURVJfRFJBR19RVUFEOiAwLjAwNiwKICAgICAgICAgICAgICAgIE1BR05VU19DT0VGRjogMC4wNSwKICAgICAgICAgICAgICAgIE1BR05VU19DQVA6IDQwLjAsCiAgICAgICAgICAgICAgICBTUElOX0RSQUc6IDAuNzUsCiAgICAgICAgICAgICAgICBTVE9QX1NQRUVEOiAwLjA1LAogICAgICAgICAgICAgICAgTEFVTkNIX1NQRUVEX0NBUDogNzAuMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGFiLnJlZnJlc2hQcmV2aWV3KCk7CiAgICAgICAgfQogICAgfTsKICAgIHByZXNldHMuYWRkKFAsICdWYW5pbGxhJyk7CiAgICBwcmVzZXRzLmFkZChQLCAnQXJjYWRlQ3VydmUnKTsKICAgIHByZXNldHMuYWRkKFAsICdTbmFwcHlSZWFsaXN0aWMnKTsKCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEZvbGRlcjogU25hcHNob3QgLyBFeHBvcnQKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgY29uc3Qgc25hcHNob3QgPSByb290LmFkZEZvbGRlcignU25hcHNob3QgLyBFeHBvcnQnKTsKCiAgICBjb25zdCBfcm91bmQgPSAobiwgcGxhY2VzID0gNCkgPT4gewogICAgICAgIGlmICghTnVtYmVyLmlzRmluaXRlKG4pKSByZXR1cm4gbnVsbDsKICAgICAgICBjb25zdCBwID0gTWF0aC5wb3coMTAsIHBsYWNlcyk7CiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQobiAqIHApIC8gcDsKICAgIH07CgogICAgY29uc3QgX3YzID0gKHYsIHBsYWNlcyA9IDQpID0+IHsKICAgICAgICBpZiAoIXYpIHJldHVybiBudWxsOwogICAgICAgIHJldHVybiBbX3JvdW5kKHYueCwgcGxhY2VzKSwgX3JvdW5kKHYueSwgcGxhY2VzKSwgX3JvdW5kKHYueiwgcGxhY2VzKV07CiAgICB9OwoKICAgIGNvbnN0IF9jbG9uZUpzb24gPSAob2JqKSA9PiB7CiAgICAgICAgaWYgKCFvYmopIHJldHVybiBudWxsOwogICAgICAgIHRyeSB7IHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KG9iaikpOyB9IGNhdGNoIChlKSB7IHJldHVybiBudWxsOyB9CiAgICB9OwoKICAgIGNvbnN0IF9wbGF5ZXJTbmFwID0gKHApID0+IHsKICAgICAgICBpZiAoIXApIHJldHVybiBudWxsOwogICAgICAgIGNvbnN0IGFuaW0gPSAocC5hY3RpdmVBY3Rpb24gJiYgcC5hY3RpdmVBY3Rpb24uX2NsaXApID8gcC5hY3RpdmVBY3Rpb24uX2NsaXAubmFtZSA6IChwLnN0YXRlIHx8IG51bGwpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG5hbWU6IHAuY2hhcmFjdGVyTmFtZSB8fCBwLm5hbWUgfHwgbnVsbCwKICAgICAgICAgICAgcm9sZTogcC5yb2xlIHx8IG51bGwsCiAgICAgICAgICAgIHN0YXRlOiBwLnN0YXRlIHx8IG51bGwsCiAgICAgICAgICAgIGhhc0JhbGw6ICEhcC5oYXNCYWxsLAogICAgICAgICAgICBpc1Rocm93aW5nOiAhIXAuaXNUaHJvd2luZywKICAgICAgICAgICAgaXNDaGFyZ2luZzogISFwLmlzQ2hhcmdpbmcsCiAgICAgICAgICAgIGlzRGFzaGluZzogISFwLmlzRGFzaGluZywKICAgICAgICAgICAgZGFzaENvb2xkb3duOiBfcm91bmQocC5kYXNoQ29vbGRvd24sIDQpLAogICAgICAgICAgICBwb3M6IF92MyhwLm1lc2ggJiYgcC5tZXNoLnBvc2l0aW9uKSwKICAgICAgICAgICAgdmVsOiBfdjMocC52ZWxvY2l0eSksCiAgICAgICAgICAgIGlucHV0OiBfdjMocC5pbnB1dFZlY3RvciksCiAgICAgICAgICAgIHN0YXRzOiBwLnN0YXRzID8gX2Nsb25lSnNvbihwLnN0YXRzKSA6IG51bGwsCiAgICAgICAgICAgIGFuaW0KICAgICAgICB9OwogICAgfTsKCiAgICBjb25zdCBfdGVhbVNuYXAgPSAodCkgPT4gewogICAgICAgIGlmICghdCkgcmV0dXJuIG51bGw7CiAgICAgICAgY29uc3QgYWN0aXZlID0gdC5hY3RpdmVQbGF5ZXIgPyBfcGxheWVyU25hcCh0LmFjdGl2ZVBsYXllcikgOiBudWxsOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGlkOiB0LmlkIHx8IG51bGwsCiAgICAgICAgICAgIHNpZGU6IHQuc2lkZSwKICAgICAgICAgICAgaXNIdW1hbjogISF0LmlzSHVtYW4sCiAgICAgICAgICAgIGFpRW5hYmxlZDogISF0LmFpRW5hYmxlZCwKICAgICAgICAgICAgY3VycmVudEZvcm1hdGlvbjogdC5jdXJyZW50Rm9ybWF0aW9uIHx8IG51bGwsCiAgICAgICAgICAgIGFjdGl2ZVBsYXllcjogYWN0aXZlLAogICAgICAgICAgICBwbGF5ZXJzOiBBcnJheS5pc0FycmF5KHQucGxheWVycykgPyB0LnBsYXllcnMubWFwKF9wbGF5ZXJTbmFwKSA6IFtdCiAgICAgICAgfTsKICAgIH07CgogICAgY29uc3QgYnVpbGRTbmFwc2hvdCA9ICgpID0+IHsKICAgICAgICBjb25zdCBnYW1lID0gdGhpcy5nYW1lIHx8IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZSB8fCBudWxsOwogICAgICAgIGNvbnN0IGJhbGwgPSBnYW1lICYmIGdhbWUuZW50aXRpZXMgPyBnYW1lLmVudGl0aWVzLmJhbGwgOiBudWxsOwogICAgICAgIGNvbnN0IGNhbU1nciA9IGdhbWUgPyBnYW1lLmNhbWVyYU1hbmFnZXIgOiBudWxsOwogICAgICAgIGNvbnN0IGNhbSA9IChjYW1NZ3IgJiYgY2FtTWdyLmNhbWVyYSkgPyBjYW1NZ3IuY2FtZXJhIDogKGdhbWUgPyBnYW1lLmNhbWVyYSA6IG51bGwpOwoKICAgICAgICBjb25zdCBiYWxsU25hcCA9IGJhbGwgPyB7CiAgICAgICAgICAgIHN0YXRlOiBiYWxsLnN0YXRlIHx8IG51bGwsCiAgICAgICAgICAgIGlzSW52aXNpYmxlOiAhIWJhbGwuaXNJbnZpc2libGUsCiAgICAgICAgICAgIGhvbGRlcjogYmFsbC5ob2xkZXIgPyAoYmFsbC5ob2xkZXIuY2hhcmFjdGVyTmFtZSB8fCBiYWxsLmhvbGRlci5uYW1lIHx8IG51bGwpIDogbnVsbCwKICAgICAgICAgICAgbGFzdEhvbGRlcjogYmFsbC5sYXN0SG9sZGVyID8gKGJhbGwubGFzdEhvbGRlci5jaGFyYWN0ZXJOYW1lIHx8IGJhbGwubGFzdEhvbGRlci5uYW1lIHx8IG51bGwpIDogbnVsbCwKICAgICAgICAgICAgcG9zOiBfdjMoYmFsbC5tZXNoICYmIGJhbGwubWVzaC5wb3NpdGlvbiksCiAgICAgICAgICAgIHZlbDogX3YzKGJhbGwudmVsb2NpdHkpLAogICAgICAgICAgICBhbmdWZWw6IF92MyhiYWxsLmFuZ3VsYXJWZWxvY2l0eSksCiAgICAgICAgICAgIHBvd2VyOiBfcm91bmQoYmFsbC5wb3dlciwgNCksCiAgICAgICAgICAgIHNob3RUeXBlOiBiYWxsLnNob3RUeXBlIHx8IG51bGwKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgY29uc3QgY2FtZXJhU25hcCA9IGNhbSA/IHsKICAgICAgICAgICAgcG9zOiBfdjMoY2FtLnBvc2l0aW9uKSwKICAgICAgICAgICAgcm90OiBjYW0ucm90YXRpb24gPyBbX3JvdW5kKGNhbS5yb3RhdGlvbi54LCA0KSwgX3JvdW5kKGNhbS5yb3RhdGlvbi55LCA0KSwgX3JvdW5kKGNhbS5yb3RhdGlvbi56LCA0KV0gOiBudWxsLAogICAgICAgICAgICBmb3Y6IF9yb3VuZChjYW0uZm92LCA0KSwKICAgICAgICAgICAgbmVhcjogX3JvdW5kKGNhbS5uZWFyLCA2KSwKICAgICAgICAgICAgZmFyOiBfcm91bmQoY2FtLmZhciwgNCkKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgY29uc3QgY2FtTWdyU25hcCA9IGNhbU1nciA/IHsKICAgICAgICAgICAgbW9kZTogY2FtTWdyLm1vZGUgfHwgbnVsbCwKICAgICAgICAgICAgdGFyZ2V0TmFtZTogKGNhbU1nci50YXJnZXQgJiYgKGNhbU1nci50YXJnZXQuY2hhcmFjdGVyTmFtZSB8fCBjYW1NZ3IudGFyZ2V0Lm5hbWUpKSB8fCBudWxsLAogICAgICAgICAgICBzZXR0aW5nczogY2FtTWdyLnNldHRpbmdzID8gX2Nsb25lSnNvbihjYW1NZ3Iuc2V0dGluZ3MpIDogbnVsbAogICAgICAgIH0gOiBudWxsOwoKICAgICAgICBjb25zdCBkZWJ1Z0lPID0gd2luZG93LmZsdXggJiYgd2luZG93LmZsdXguX2RlYnVnSU8gPyB3aW5kb3cuZmx1eC5fZGVidWdJTyA6IG51bGw7CiAgICAgICAgY29uc3QgaW5wdXRTbmFwID0gZGVidWdJTyA/IHsKICAgICAgICAgICAgc2V0dGluZ3M6IGRlYnVnSU8uc2V0dGluZ3MgPyBfY2xvbmVKc29uKGRlYnVnSU8uc2V0dGluZ3MpIDogbnVsbCwKICAgICAgICAgICAgcGVyZjogZGVidWdJTy5wZXJmID8gX2Nsb25lSnNvbihkZWJ1Z0lPLnBlcmYpIDogbnVsbCwKICAgICAgICAgICAgbW92ZTogKGRlYnVnSU8uaW5wdXQgJiYgZGVidWdJTy5pbnB1dC5tb3ZlKSA/IHsKICAgICAgICAgICAgICAgIHRvdWNoSWQ6IGRlYnVnSU8uaW5wdXQubW92ZS50b3VjaElkID8/IG51bGwsCiAgICAgICAgICAgICAgICBkcmFnZ2luZzogISFkZWJ1Z0lPLmlucHV0Lm1vdmUuZHJhZ2dpbmcsCiAgICAgICAgICAgICAgICB2ZWN0b3I6IGRlYnVnSU8uaW5wdXQubW92ZS52ZWN0b3IgPyBfY2xvbmVKc29uKGRlYnVnSU8uaW5wdXQubW92ZS52ZWN0b3IpIDogbnVsbAogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgYWltOiAoZGVidWdJTy5pbnB1dCAmJiBkZWJ1Z0lPLmlucHV0LmFpbSkgPyB7CiAgICAgICAgICAgICAgICB0b3VjaElkOiBkZWJ1Z0lPLmlucHV0LmFpbS50b3VjaElkID8/IG51bGwsCiAgICAgICAgICAgICAgICBkcmFnZ2luZzogISFkZWJ1Z0lPLmlucHV0LmFpbS5kcmFnZ2luZywKICAgICAgICAgICAgICAgIHZlY3RvcjogZGVidWdJTy5pbnB1dC5haW0udmVjdG9yID8gX2Nsb25lSnNvbihkZWJ1Z0lPLmlucHV0LmFpbS52ZWN0b3IpIDogbnVsbAogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgc3dpcGU6IChkZWJ1Z0lPLmlucHV0ICYmIGRlYnVnSU8uaW5wdXQuc3dpcGUpID8gewogICAgICAgICAgICAgICAgdG91Y2hJZDogZGVidWdJTy5pbnB1dC5zd2lwZS50b3VjaElkID8/IG51bGwsCiAgICAgICAgICAgICAgICBzdGFydDogZGVidWdJTy5pbnB1dC5zd2lwZS5zdGFydCA/IF9jbG9uZUpzb24oZGVidWdJTy5pbnB1dC5zd2lwZS5zdGFydCkgOiBudWxsLAogICAgICAgICAgICAgICAgcG9pbnRzOiBBcnJheS5pc0FycmF5KGRlYnVnSU8uaW5wdXQuc3dpcGUucG9pbnRzKSA/IGRlYnVnSU8uaW5wdXQuc3dpcGUucG9pbnRzLnNsaWNlKC0zMikubWFwKF9jbG9uZUpzb24pIDogW10KICAgICAgICAgICAgfSA6IG51bGwKICAgICAgICB9IDogbnVsbDsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbWV0YTogewogICAgICAgICAgICAgICAgdGltZXN0YW1wSVNPOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksCiAgICAgICAgICAgICAgICBocmVmOiAodHlwZW9mIGxvY2F0aW9uICE9PSAndW5kZWZpbmVkJyAmJiBsb2NhdGlvbi5ocmVmKSA/IGxvY2F0aW9uLmhyZWYgOiBudWxsLAogICAgICAgICAgICAgICAgdXNlckFnZW50OiAodHlwZW9mIG5hdmlnYXRvciAhPT0gJ3VuZGVmaW5lZCcgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudCkgPyBuYXZpZ2F0b3IudXNlckFnZW50IDogbnVsbAogICAgICAgICAgICB9LAogICAgICAgICAgICBnYW1lOiBnYW1lID8gewogICAgICAgICAgICAgICAgc2NvcmU6IGdhbWUuc2NvcmUgPyBfY2xvbmVKc29uKGdhbWUuc2NvcmUpIDogbnVsbCwKICAgICAgICAgICAgICAgIHRpbWU6IF9yb3VuZChnYW1lLnRpbWUsIDQpLAogICAgICAgICAgICAgICAgaGFsZjogZ2FtZS5oYWxmID8/IG51bGwsCiAgICAgICAgICAgICAgICBoYWxmRHVyYXRpb246IF9yb3VuZChnYW1lLmhhbGZEdXJhdGlvbiwgNCksCiAgICAgICAgICAgICAgICBpc092ZXJ0aW1lOiAhIWdhbWUuaXNPdmVydGltZSwKICAgICAgICAgICAgICAgIGlzRGVtb01vZGU6ICEhZ2FtZS5pc0RlbW9Nb2RlCiAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICBjb25maWc6IHsKICAgICAgICAgICAgICAgIEJhbGxDb25maWc6ICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnKSA/IF9jbG9uZUpzb24od2luZG93LmZsdXguQmFsbENvbmZpZykgOiBudWxsLAogICAgICAgICAgICAgICAgVGhyb3dDb25maWc6ICh3aW5kb3cuZmx1eCAmJiB3aW5kb3cuZmx1eC5UaHJvd0NvbmZpZykgPyBfY2xvbmVKc29uKHdpbmRvdy5mbHV4LlRocm93Q29uZmlnKSA6IG51bGwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2FtZXJhOiBjYW1lcmFTbmFwLAogICAgICAgICAgICBjYW1lcmFNYW5hZ2VyOiBjYW1NZ3JTbmFwLAogICAgICAgICAgICBiYWxsOiBiYWxsU25hcCwKICAgICAgICAgICAgdGVhbXM6IGdhbWUgPyB7CiAgICAgICAgICAgICAgICBob21lOiBfdGVhbVNuYXAoZ2FtZS50ZWFtcyAmJiBnYW1lLnRlYW1zLmhvbWUpLAogICAgICAgICAgICAgICAgYXdheTogX3RlYW1TbmFwKGdhbWUudGVhbXMgJiYgZ2FtZS50ZWFtcy5hd2F5KQogICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgaW5wdXQ6IGlucHV0U25hcAogICAgICAgIH07CiAgICB9OwoKICAgIGNvbnN0IF9jb3B5VGV4dCA9IGFzeW5jICh0ZXh0KSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKG5hdmlnYXRvci5jbGlwYm9hcmQgJiYgbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQpIHsKICAgICAgICAgICAgICAgIGF3YWl0IG5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KHRleHQpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIC8vIEZhbGxiYWNrCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgdGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZXh0YXJlYScpOwogICAgICAgICAgICB0YS52YWx1ZSA9IHRleHQ7CiAgICAgICAgICAgIHRhLnN0eWxlLnBvc2l0aW9uID0gJ2ZpeGVkJzsKICAgICAgICAgICAgdGEuc3R5bGUubGVmdCA9ICctOTk5OXB4JzsKICAgICAgICAgICAgdGEuc3R5bGUudG9wID0gJy05OTk5cHgnOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRhKTsKICAgICAgICAgICAgdGEuZm9jdXMoKTsKICAgICAgICAgICAgdGEuc2VsZWN0KCk7CiAgICAgICAgICAgIGNvbnN0IG9rID0gZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0YSk7CiAgICAgICAgICAgIHJldHVybiBvazsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CgogICAgY29uc3QgX2Rvd25sb2FkVGV4dCA9IChmaWxlbmFtZSwgdGV4dCkgPT4gewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbdGV4dF0sIHsgdHlwZTogJ2FwcGxpY2F0aW9uL2pzb24nIH0pOwogICAgICAgICAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOwogICAgICAgICAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgICAgICBhLmhyZWYgPSB1cmw7CiAgICAgICAgICAgIGEuZG93bmxvYWQgPSBmaWxlbmFtZTsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhKTsKICAgICAgICAgICAgYS5jbGljaygpOwogICAgICAgICAgICBhLnJlbW92ZSgpOwogICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKHVybCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1NuYXBzaG90IGRvd25sb2FkIGZhaWxlZDonLCBlKTsKICAgICAgICB9CiAgICB9OwoKICAgIGNvbnN0IHNuYXBzaG90QWN0aW9ucyA9IHsKICAgICAgICBDb3B5U25hcHNob3Q6IGFzeW5jICgpID0+IHsKICAgICAgICAgICAgY29uc3Qgc25hcCA9IGJ1aWxkU25hcHNob3QoKTsKICAgICAgICAgICAgY29uc3QgdGV4dCA9IEpTT04uc3RyaW5naWZ5KHNuYXAsIG51bGwsIDIpOwogICAgICAgICAgICBjb25zdCBvayA9IGF3YWl0IF9jb3B5VGV4dCh0ZXh0KTsKICAgICAgICAgICAgY29uc29sZS5sb2coJ1tTbmFwc2hvdF0nLCBzbmFwKTsKICAgICAgICAgICAgaWYgKCFvaykgY29uc29sZS53YXJuKCdTbmFwc2hvdDogY29weSBmYWlsZWQgKHNlZSBjb25zb2xlKS4nKTsKICAgICAgICB9LAogICAgICAgIERvd25sb2FkU25hcHNob3Q6ICgpID0+IHsKICAgICAgICAgICAgY29uc3Qgc25hcCA9IGJ1aWxkU25hcHNob3QoKTsKICAgICAgICAgICAgY29uc3QgdGV4dCA9IEpTT04uc3RyaW5naWZ5KHNuYXAsIG51bGwsIDIpOwogICAgICAgICAgICBfZG93bmxvYWRUZXh0KCdzbmFwc2hvdC5qc29uJywgdGV4dCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbU25hcHNob3RdJywgc25hcCk7CiAgICAgICAgfQogICAgfTsKCiAgICBzbmFwc2hvdC5hZGQoc25hcHNob3RBY3Rpb25zLCAnQ29weVNuYXBzaG90JykubmFtZSgnQ29weSBKU09OIFNuYXBzaG90Jyk7CiAgICBzbmFwc2hvdC5hZGQoc25hcHNob3RBY3Rpb25zLCAnRG93bmxvYWRTbmFwc2hvdCcpLm5hbWUoJ0Rvd25sb2FkIHNuYXBzaG90Lmpzb24nKTsKCn0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5EZXZUb29scyA9IERldlRvb2xzOwoKICAgIERldlRvb2xzLnByb3RvdHlwZS5fc2V0dXBWaXN1YWxEZWJ1ZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IGZvbGRlciA9IHRoaXMuZ3VpLmFkZEZvbGRlcignVmlzdWFsIERlYnVnZ2luZycpOwogICAgICAgIGNvbnN0IGR2ID0gdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplcjsKICAgICAgICBpZiAoIWR2KSByZXR1cm47Cgpjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgIGVuYWJsZWQ6IGR2LmVuYWJsZWQsCiAgICAgICAgICAgIGhpdGJveGVzOiBkdi5zaG93SGl0Ym94ZXMsCiAgICAgICAgICAgIHZlY3RvcnM6IGR2LnNob3dWZWN0b3JzLAogICAgICAgICAgICBhaTogZHYuc2hvd0FJLAogICAgICAgICAgICBnb2FsVm9sdW1lOiBkdi5zaG93R29hbFZvbHVtZQogICAgICAgIH07CgogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnZW5hYmxlZCcpLm5hbWUoJ0VuYWJsZSBWaXN1YWxpemVyJykub25DaGFuZ2UodiA9PiBkdi5lbmFibGVkID0gdik7CiAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdoaXRib3hlcycpLm5hbWUoJ1Nob3cgSGl0Ym94ZXMnKS5vbkNoYW5nZSh2ID0+IGR2LnNob3dIaXRib3hlcyA9IHYpOwogICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAndmVjdG9ycycpLm5hbWUoJ1Nob3cgVmVjdG9ycycpLm9uQ2hhbmdlKHYgPT4gZHYuc2hvd1ZlY3RvcnMgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2FpJykubmFtZSgnU2hvdyBBSSBQZXJjZXB0aW9uJykub25DaGFuZ2UodiA9PiBkdi5zaG93QUkgPSB2KTsKICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2dvYWxWb2x1bWUnKS5uYW1lKCdTaG93IEdvYWwgVm9sdW1lJykub25DaGFuZ2UodiA9PiBkdi5zaG93R29hbFZvbHVtZSA9IHYpOwogICAgfTsKCiAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwRlhMYWIgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0ZYIExhYiAmIFVJIFRlc3QnKTsKICAgICAgICAKICAgICAgICBjb25zdCBnZXRUYXJnZXRQb3MgPSAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIHJldHVybiBwICYmIHAubWVzaCA/IHAubWVzaC5wb3NpdGlvbiA6IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDIsIDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IGZ4UGFyYW1zID0gewogICAgICAgICAgICBTcGF3blZlbm9tOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCd2ZW5vbScsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25OYXA6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ25hcCcsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25XaXRoZXI6ICgpID0+IHRoaXMuZ2FtZS5wYXJ0aWNsZU1hbmFnZXIuc3Bhd24oJ3dpdGhlcicsIGdldFRhcmdldFBvcygpKSwKICAgICAgICAgICAgU3Bhd25MZWFybmVkOiAoKSA9PiB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdsZWFybmVkJywgZ2V0VGFyZ2V0UG9zKCkpLAogICAgICAgICAgICBTcGF3bkNsYXNoOiAoKSA9PiB0aGlzLmdhbWUuc3Bhd25DbGFzaChnZXRUYXJnZXRQb3MoKSksCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgZnhTdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdQYXJ0aWNsZXMnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3blZlbm9tJyk7CiAgICAgICAgZnhTdWIuYWRkKGZ4UGFyYW1zLCAnU3Bhd25OYXAnKTsKICAgICAgICBmeFN1Yi5hZGQoZnhQYXJhbXMsICdTcGF3bldpdGhlcicpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduTGVhcm5lZCcpOwogICAgICAgIGZ4U3ViLmFkZChmeFBhcmFtcywgJ1NwYXduQ2xhc2gnKTsKCiAgICAgICAgY29uc3QgdHh0UGFyYW1zID0gewogICAgICAgICAgICBUZXh0OiAiVEVTVCIsCiAgICAgICAgICAgIFR5cGU6ICJkYW1hZ2UiLAogICAgICAgICAgICBTcGF3bjogKCkgPT4gewogICAgICAgICAgICAgICAgaWYodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bih0eHRQYXJhbXMuVGV4dCwgZ2V0VGFyZ2V0UG9zKCksIHR4dFBhcmFtcy5UeXBlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgY29uc3QgdHh0U3ViID0gZm9sZGVyLmFkZEZvbGRlcignRmxvYXRpbmcgVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVGV4dCcpOwogICAgICAgIHR4dFN1Yi5hZGQodHh0UGFyYW1zLCAnVHlwZScsIFsnZGFtYWdlJywgJ2hlYWwnLCAnc3RhdHVzJywgJ3RlY2gnLCAnY29taWMtaW1wYWN0JywgJ2NvbWljLWFjdGlvbicsICdzYXZlJywgJ2Jsb2NrJywgJ2RlZmF1bHQnXSk7CiAgICAgICAgdHh0U3ViLmFkZCh0eHRQYXJhbXMsICdTcGF3bicpLm5hbWUoJ1NwYXduIFRleHQnKTsKCiAgICAgICAgY29uc3QgY2FtUGFyYW1zID0gewogICAgICAgICAgICBTaGFrZVNtYWxsOiAoKSA9PiB0aGlzLmdhbWUuY2FtZXJhTWFuYWdlci5hZGRTaGFrZSgwLjUpLAogICAgICAgICAgICBTaGFrZUJpZzogKCkgPT4gdGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIuYWRkU2hha2UoMi4wKSwKICAgICAgICAgICAgSW1wYWN0TGlnaHQ6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMSwgJ2RlZmF1bHQnKSwKICAgICAgICAgICAgSW1wYWN0SGVhdnk6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuMiwgJ2hlYXZ5JyksCiAgICAgICAgICAgIEltcGFjdFNoYXR0ZXI6ICgpID0+IHRoaXMuZ2FtZS50cmlnZ2VySW1wYWN0KDAuNCwgJ3NoYXR0ZXInKSwKICAgICAgICB9OwoKICAgICAgICBjb25zdCBjYW1TdWIgPSBmb2xkZXIuYWRkRm9sZGVyKCdDYW1lcmEgJiBJbXBhY3QnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlU21hbGwnKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ1NoYWtlQmlnJyk7CiAgICAgICAgY2FtU3ViLmFkZChjYW1QYXJhbXMsICdJbXBhY3RMaWdodCcpOwogICAgICAgIGNhbVN1Yi5hZGQoY2FtUGFyYW1zLCAnSW1wYWN0SGVhdnknKTsKICAgICAgICBjYW1TdWIuYWRkKGNhbVBhcmFtcywgJ0ltcGFjdFNoYXR0ZXInKTsKICAgIH07CgoKRGV2VG9vbHMucHJvdG90eXBlLl9zZXR1cFZpc3VhbHMgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBmb2xkZXIgPSB0aGlzLmd1aS5hZGRGb2xkZXIoJ0Fzc2V0IEZvcmdlJyk7CiAgICAgICAgCiAgICAgICAgY29uc3QgZm9yZ2VTdGF0ZSA9IHsKICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgYXNzZXROYW1lOiAnVGlkdXMnLAogICAgICAgICAgICBhbmltTmFtZTogJ2lkbGUnLAogICAgICAgICAgICBwb3NYOiAwLCBwb3NZOiAwLCBwb3NaOiAwLAogICAgICAgICAgICByb3RYOiAwLCByb3RZOiAwLCByb3RaOiAwLAogICAgICAgICAgICBzY2FsZTogMS4wLAogICAgICAgICAgICBjYW1EaXN0OiA1LCBjYW1IZWlnaHQ6IDEuNSwgY2FtUm90OiAwCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgYXNzZXRzID0gewogICAgICAgICAgICAnVGlkdXMnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2RhNzg4YmVmMjU4YzRmMGI4ZDllZjFhY2MxOWM1NTY3LmdsYicsCiAgICAgICAgICAgICdXYWtrYSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTkxMTRjOTg5NTE2NDdjOWI4ZGE3NGIwYmQzNjM2Y2IuZ2xiJywKICAgICAgICAgICAgJ0xldHR5JzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy80M2FjZTM0YzZmZDk0MjE1OTY3ZTg0MmJmOTA5ZGE1ZS5nbGInLAogICAgICAgICAgICAnRGF0dG8nOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2U2ZDY3ZWNiMmU0YzQ3MTViZDczYTQwNzk1ZTFkM2Q1LmdsYicsCiAgICAgICAgICAgICdKYXNzdSc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvODIxNjQ1OTU2NzM1NGU2Mzk1OGQ0MTA4ZDgyOGRlOTguZ2xiJywKICAgICAgICAgICAgJ0JvdHRhJzogJ2h0dHBzOi8vY2RuLnRpbnlnbGIuY29tL21vZGVscy9hZDE1NWVmZWRjMGQ0OGZkYWQwOWRhM2UxY2FlOWM5Ny5nbGInLAogICAgICAgICAgICAnQmFsbCc6ICdodHRwczovL2Nkbi50aW55Z2xiLmNvbS9tb2RlbHMvNTIxYWU4Nzg4ZTU4NGUzNzhhNzlkOTczMmEwNzUzNTYuZ2xiJywKICAgICAgICAgICAgJ0dvYWwnOiAnaHR0cHM6Ly9jZG4udGlueWdsYi5jb20vbW9kZWxzL2E1MTZiZDkwZmE3YzRkZWRiNWRjYmZkZjgwM2YxM2Q1LmdsYicKICAgICAgICB9OwoKICAgICAgICBsZXQgY3VycmVudEFzc2V0ID0gbnVsbDsKCiAgICAgICAgY29uc3QgdXBkYXRlVHJhbnNmb3JtID0gKCkgPT4gewogICAgICAgICAgICBpZiAoY3VycmVudEFzc2V0KSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQucG9zaXRpb24uc2V0KGZvcmdlU3RhdGUucG9zWCwgZm9yZ2VTdGF0ZS5wb3NZLCBmb3JnZVN0YXRlLnBvc1opOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0LnJvdGF0aW9uLnNldChmb3JnZVN0YXRlLnJvdFgsIGZvcmdlU3RhdGUucm90WSwgZm9yZ2VTdGF0ZS5yb3RaKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRBc3NldC5zY2FsZS5zZXRTY2FsYXIoZm9yZ2VTdGF0ZS5zY2FsZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjb25zdCB1cGRhdGVDYW1lcmEgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghZm9yZ2VTdGF0ZS5hY3RpdmUpIHJldHVybjsKICAgICAgICAgICAgLy8gT3JiaXQgYXJvdW5kICgxMDAwLCBZLCAxMDAwKQogICAgICAgICAgICBjb25zdCBjeCA9IDEwMDAgKyBNYXRoLnNpbihmb3JnZVN0YXRlLmNhbVJvdCkgKiBmb3JnZVN0YXRlLmNhbURpc3Q7CiAgICAgICAgICAgIGNvbnN0IGN6ID0gMTAwMCArIE1hdGguY29zKGZvcmdlU3RhdGUuY2FtUm90KSAqIGZvcmdlU3RhdGUuY2FtRGlzdDsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhbWVyYS5wb3NpdGlvbi5zZXQoY3gsIGZvcmdlU3RhdGUuY2FtSGVpZ2h0LCBjeik7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW1lcmEubG9va0F0KDEwMDAsIGZvcmdlU3RhdGUucG9zWSArIDEsIDEwMDApOwogICAgICAgIH07CgogICAgICAgIGNvbnN0IHBsYXlBbmltYXRpb24gPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghdGhpcy52aXpNaXhlciB8fCAhdGhpcy52aXpDbGlwcykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnZpek1peGVyLnN0b3BBbGxBY3Rpb24oKTsKICAgICAgICAgICAgaWYgKGZvcmdlU3RhdGUuYW5pbU5hbWUgPT09ICdub25lJykgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUgPT09IGZvcmdlU3RhdGUuYW5pbU5hbWUpOwogICAgICAgICAgICBpZiAoIWNsaXApIGNsaXAgPSB0aGlzLnZpekNsaXBzLmZpbmQoYyA9PiBjLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhmb3JnZVN0YXRlLmFuaW1OYW1lLnRvTG93ZXJDYXNlKCkpKTsKICAgICAgICAgICAgaWYgKGNsaXApIHRoaXMudml6TWl4ZXIuY2xpcEFjdGlvbihjbGlwKS5wbGF5KCk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3Qgc3Bhd25Bc3NldCA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciBwcmV2aW91cwogICAgICAgICAgICB3aGlsZSh0aGlzLnZpekdyb3VwLmNoaWxkcmVuLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy52aXpHcm91cC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucmVtb3ZlKGNoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy52aXpNaXhlciA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnRBc3NldCA9IG51bGw7CgogICAgICAgICAgICBjb25zdCB1cmwgPSBhc3NldHNbZm9yZ2VTdGF0ZS5hc3NldE5hbWVdOwogICAgICAgICAgICBpZiAoIXVybCkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc29sZS5sb2coIkZvcmdlOiBTcGF3bmluZyIsIGZvcmdlU3RhdGUuYXNzZXROYW1lKTsKCiAgICAgICAgICAgIHdpbmRvdy5mbHV4LkFzc2V0TG9hZGVyLmxvYWRNb2RlbCh1cmwsIChnbHRmKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSBhcmUgc3RpbGwgaW4gZm9yZ2UgbW9kZSBiZWZvcmUgYWRkaW5nCiAgICAgICAgICAgICAgICBpZiAoIWZvcmdlU3RhdGUuYWN0aXZlKSByZXR1cm47CgogICAgICAgICAgICAgICAgY29uc3QgbW9kZWwgPSBnbHRmLnNjZW5lOwogICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cC5hZGQobW9kZWwpOwogICAgICAgICAgICAgICAgY3VycmVudEFzc2V0ID0gbW9kZWw7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlc2V0IG1vZGVsIHRyYW5zZm9ybSByZWxhdGl2ZSB0byBncm91cAogICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIG1vZGVsLnJvdGF0aW9uLnNldCgwLDAsMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZVRyYW5zZm9ybSgpOwoKICAgICAgICAgICAgICAgIGlmIChnbHRmLmFuaW1hdGlvbnMgJiYgZ2x0Zi5hbmltYXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpek1peGVyID0gbmV3IFRIUkVFLkFuaW1hdGlvbk1peGVyKG1vZGVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekNsaXBzID0gZ2x0Zi5hbmltYXRpb25zOwogICAgICAgICAgICAgICAgICAgIHBsYXlBbmltYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgdG9nZ2xlRm9yZ2UgPSAoaXNBY3RpdmUpID0+IHsKICAgICAgICAgICAgZm9yZ2VTdGF0ZS5hY3RpdmUgPSBpc0FjdGl2ZTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlzRm9yZ2VNb2RlID0gaXNBY3RpdmU7IC8vIENyaXRpY2FsOiBUZWxsIG1haW4uanMgdG8gc3RvcCBnYW1lIGxvb3AKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRvZ2dsZSBHYW1lIFZpc2liaWxpdHkgKEhpZGUgZXZlcnl0aGluZyBpbiB0aGUgbWFpbiBhcmVuYSkKICAgICAgICAgICAgY29uc3QgZ2FtZUxheWVyID0gW3RoaXMuZ2FtZS50ZWFtcy5ob21lLCB0aGlzLmdhbWUudGVhbXMuYXdheSwgdGhpcy5nYW1lLmVudGl0aWVzLmJhbGxdOwogICAgICAgICAgICBnYW1lTGF5ZXIuZm9yRWFjaCh0ID0+IHsKICAgICAgICAgICAgICAgIGlmKHQgJiYgdC5wbGF5ZXJzKSB0LnBsYXllcnMuZm9yRWFjaChwID0+IHsgaWYocC5tZXNoKSBwLm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsgfSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmKHQgJiYgdC5tZXNoKSB0Lm1lc2gudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaCkgd2luZG93LmZsdXguYXJlbmFNZXNoLnZpc2libGUgPSAhaXNBY3RpdmU7CiAgICAgICAgICAgIGlmKHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIpIHdpbmRvdy5mbHV4LmFyZW5hTWVzaDIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLnN0YWRpdW0gJiYgdGhpcy5nYW1lLnN0YWRpdW0uY29udGFpbmVyKSB0aGlzLmdhbWUuc3RhZGl1bS5jb250YWluZXIudmlzaWJsZSA9ICFpc0FjdGl2ZTsKICAgICAgICAgICAgaWYodGhpcy5nYW1lLndhdGVyT3ZlcmxheSAmJiB0aGlzLmdhbWUud2F0ZXJPdmVybGF5Lm1lc2gpIHRoaXMuZ2FtZS53YXRlck92ZXJsYXkubWVzaC52aXNpYmxlID0gIWlzQWN0aXZlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGlkZSBVSQogICAgICAgICAgICBjb25zdCB1aSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1aS1sYXllcicpOwogICAgICAgICAgICBpZih1aSkgdWkuc3R5bGUuZGlzcGxheSA9IGlzQWN0aXZlID8gJ25vbmUnIDogJ2ZsZXgnOwoKICAgICAgICAgICAgaWYgKGlzQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIEZvcmdlIFNjZW5lIGlmIG5lZWRlZAogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnZpekdyb3VwUGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy52aXpHcm91cFBhcmVudCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXAucG9zaXRpb24uc2V0KDEwMDAsIDAsIDEwMDApOyAvLyBGYXIgYXdheSBmcm9tIGFyZW5hCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQodGhpcy52aXpHcm91cCk7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGdyaWQgPSBuZXcgVEhSRUUuR3JpZEhlbHBlcigyMCwgMjAsIDB4MDBmZmZmLCAweDQ0NDQ0NCk7CiAgICAgICAgICAgICAgICAgICAgZ3JpZC5wb3NpdGlvbi5zZXQoMTAwMCwgMCwgMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXpHcm91cFBhcmVudC5hZGQoZ3JpZCk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMudml6TGlnaHQgPSBuZXcgVEhSRUUuRGlyZWN0aW9uYWxMaWdodCgweGZmZmZmZiwgMS4wKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnBvc2l0aW9uLnNldCgxMDA1LCAxMCwgMTAwNSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNjZW5lLmFkZCh0aGlzLnZpekxpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpekFtYmllbnQgPSBuZXcgVEhSRUUuQW1iaWVudExpZ2h0KDB4NDA0MDQwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKHRoaXMudml6QW1iaWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudml6R3JvdXBQYXJlbnQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnZpekxpZ2h0LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy52aXpBbWJpZW50LnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzcGF3bkFzc2V0KCk7CiAgICAgICAgICAgICAgICB1cGRhdGVDYW1lcmEoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBHYW1lCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpHcm91cFBhcmVudCkgdGhpcy52aXpHcm91cFBhcmVudC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpMaWdodCkgdGhpcy52aXpMaWdodC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpBbWJpZW50KSB0aGlzLnZpekFtYmllbnQudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYSBiYWNrIHRvIGdhbWUgdGFyZ2V0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhbWVyYU1hbmFnZXIpIHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyLnNuYXBUb1RhcmdldCgpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZm9sZGVyLmFkZChmb3JnZVN0YXRlLCAnYWN0aXZlJykubmFtZSgnRW5hYmxlIEZvcmdlJykub25DaGFuZ2UodG9nZ2xlRm9yZ2UpOwogICAgICAgIGZvbGRlci5hZGQoZm9yZ2VTdGF0ZSwgJ2Fzc2V0TmFtZScsIE9iamVjdC5rZXlzKGFzc2V0cykpLm5hbWUoJ1NlbGVjdCBBc3NldCcpLm9uQ2hhbmdlKHNwYXduQXNzZXQpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRmID0gZm9sZGVyLmFkZEZvbGRlcignVHJhbnNmb3JtJyk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NYJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NZJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdwb3NaJywgLTUsIDUpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdyb3RYJywgMCwgNi4yOCkub25DaGFuZ2UodXBkYXRlVHJhbnNmb3JtKTsKICAgICAgICB0Zi5hZGQoZm9yZ2VTdGF0ZSwgJ3JvdFknLCAwLCA2LjI4KS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwogICAgICAgIHRmLmFkZChmb3JnZVN0YXRlLCAncm90WicsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZVRyYW5zZm9ybSk7CiAgICAgICAgdGYuYWRkKGZvcmdlU3RhdGUsICdzY2FsZScsIDAuMSwgMy4wKS5vbkNoYW5nZSh1cGRhdGVUcmFuc2Zvcm0pOwoKICAgICAgICBmb2xkZXIuYWRkKGZvcmdlU3RhdGUsICdhbmltTmFtZScsIFsnbm9uZScsICdpZGxlJywgJ3N3aW0nLCAndGhyb3cnLCAnY2F0Y2gnLCAncmVhY3QnXSkubmFtZSgnQW5pbWF0aW9uJykub25DaGFuZ2UocGxheUFuaW1hdGlvbik7CgogICAgICAgIGNvbnN0IGNmID0gZm9sZGVyLmFkZEZvbGRlcignQ2FtZXJhJyk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1EaXN0JywgMiwgMTUpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CiAgICAgICAgY2YuYWRkKGZvcmdlU3RhdGUsICdjYW1IZWlnaHQnLCAwLCAxMCkub25DaGFuZ2UodXBkYXRlQ2FtZXJhKTsKICAgICAgICBjZi5hZGQoZm9yZ2VTdGF0ZSwgJ2NhbVJvdCcsIDAsIDYuMjgpLm9uQ2hhbmdlKHVwZGF0ZUNhbWVyYSk7CgogICAgICAgIC8vIEhvb2sgR2FtZSBMb29wCiAgICAgICAgY29uc3Qgb3JpZ2luYWxVcGRhdGUgPSB0aGlzLmdhbWUudXBkYXRlLmJpbmQodGhpcy5nYW1lKTsKICAgICAgICB0aGlzLmdhbWUudXBkYXRlID0gKGR0KSA9PiB7CiAgICAgICAgICAgIGlmIChmb3JnZVN0YXRlLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgLy8gRm9yZ2UgTW9kZTogT25seSB1cGRhdGUgZm9yZ2UgY29tcG9uZW50cyBhbmQgcmVuZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXpNaXhlcikgdGhpcy52aXpNaXhlci51cGRhdGUoZHQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBGb3JjZSBDYW1lcmEgVXBkYXRlIGhlcmUgc2luY2UgbWFpbi5qcyBsb29wIGlzIHNraXBwZWQKICAgICAgICAgICAgICAgIHVwZGF0ZUNhbWVyYSgpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucmVuZGVyZXIgJiYgdGhpcy5nYW1lLnNjZW5lICYmIHRoaXMuZ2FtZS5jYW1lcmEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIucmVuZGVyKHRoaXMuZ2FtZS5zY2VuZSwgdGhpcy5nYW1lLmNhbWVyYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOb3JtYWwgTW9kZTogUnVuIHN0YW5kYXJkIGdhbWUgdXBkYXRlCiAgICAgICAgICAgICAgICBvcmlnaW5hbFVwZGF0ZShkdCk7CiAgICAgICAgICAgIH0KfTsKICAgICAgICB9OwoKICAgICAgICBEZXZUb29scy5wcm90b3R5cGUuX3NldHVwQXVkaW8gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5ndWkuYWRkRm9sZGVyKCdBdWRpbyBTZXR0aW5ncycpOwogICAgICAgICAgICBjb25zdCBhbSA9IHRoaXMuZ2FtZS5hdWRpb01hbmFnZXI7CiAgICAgICAgICAgIGlmICghYW0pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgIG1hc3RlcjogYW0ubWFzdGVyVm9sdW1lLAogICAgICAgICAgICAgICAgYmdtOiBhbS5iZ21MZXZlbCwKICAgICAgICAgICAgICAgIHNmeDogYW0uc2Z4TGV2ZWwsCiAgICAgICAgICAgICAgICBtdXRlOiBhbS5pc011dGVkCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ21hc3RlcicsIDAuMCwgMS4wKS5uYW1lKCdNYXN0ZXIgVm9sdW1lJykub25DaGFuZ2UodiA9PiBhbS5zZXRNYXN0ZXJWb2x1bWUodikpOwogICAgICAgICAgICBmb2xkZXIuYWRkKHBhcmFtcywgJ2JnbScsIDAuMCwgMi4wKS5uYW1lKCdCR00gTGV2ZWwnKS5vbkNoYW5nZSh2ID0+IGFtLnNldEJHTUxldmVsKHYpKTsKICAgICAgICAgICAgZm9sZGVyLmFkZChwYXJhbXMsICdzZngnLCAwLjAsIDIuMCkubmFtZSgnU0ZYIExldmVsJykub25DaGFuZ2UodiA9PiBhbS5zZXRTRlhMZXZlbCh2KSk7CiAgICAgICAgICAgIGZvbGRlci5hZGQocGFyYW1zLCAnbXV0ZScpLm5hbWUoJ011dGUnKS5vbkNoYW5nZSh2ID0+IHsKICAgICAgICAgICAgICAgIGFtLnRvZ2dsZU11dGUoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCn0pKCk7","DebugVisualizer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBEZWJ1Z1Zpc3VhbGl6ZXIgewpjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dWZWN0b3JzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0FJID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0dvYWxWb2x1bWUgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMudmlzdWFscyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hdGVyaWFscwogICAgICAgICAgICB0aGlzLm1hdFRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4yIH0pOwogICAgICAgICAgICB0aGlzLm1hdENhdGNoID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZjAwLCB3aXJlZnJhbWU6IHRydWUsIHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjIgfSk7CiAgICAgICAgICAgIHRoaXMubWF0VmVsID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZjAwIH0pOyAvLyBZZWxsb3cgVmVsb2NpdHkKICAgICAgICAgICAgdGhpcy5tYXRJbnB1dCA9IG5ldyBUSFJFRS5MaW5lQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiB9KTsgLy8gQ3lhbiBJbnB1dAogICAgICAgICAgICB0aGlzLm1hdEFJID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmYwMGZmIH0pOyAvLyBNYWdlbnRhIEFJIFBlcmNlcHRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJpZXMKICAgICAgICAgICAgdGhpcy5nZW9DeWxpbmRlciA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEsIDEsIDAuMSwgMTYpOwogICAgICAgICAgICB0aGlzLmdlb0N5bGluZGVyLnRyYW5zbGF0ZSgwLCAwLjA1LCAwKTsKCiAgICAgICAgICAgIC8vIEdvYWwgVm9sdW1lIFZpc3VhbGl6YXRpb24gKFJlZCBUcmFuc3BhcmVudCBCb3gpCiAgICAgICAgICAgIGNvbnN0IGdvYWxHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoMjIsIDE4LCAxMCk7CiAgICAgICAgICAgIGNvbnN0IGdvYWxNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmMDAwMCwgCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLjI1LCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UgCiAgICAgICAgICAgIH0pOwoKdGhpcy5nb2FsVm9sMSA9IG5ldyBUSFJFRS5NZXNoKGdvYWxHZW8sIGdvYWxNYXQpOwogICAgICAgICAgICB0aGlzLmdvYWxWb2wxLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5nb2FsVm9sMSk7CgogICAgICAgICAgICB0aGlzLmdvYWxWb2wyID0gbmV3IFRIUkVFLk1lc2goZ29hbEdlbywgZ29hbE1hdCk7CiAgICAgICAgICAgIHRoaXMuZ29hbFZvbDIudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmdvYWxWb2wyKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudXBkYXRlR29hbFZvbHVtZXMoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdXBkYXRlR29hbFZvbHVtZXMoKSB7CmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMSkgdGhpcy5nb2FsVm9sMS5wb3NpdGlvbi5zZXQoMCwgLTYuMCwgLShnb2FsRGlzdCArIDUuMCkpOwogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMikgdGhpcy5nb2FsVm9sMi5wb3NpdGlvbi5zZXQoMCwgLTYuMCwgKGdvYWxEaXN0ICsgNS4wKSk7CiAgICAgICAgfQoKCnVwZGF0ZSgpIHsKICAgICAgICAgICAgLy8gVXBkYXRlIHN0YXRpYyBkZWJ1Z3MKICAgICAgICAgICAgaWYgKHRoaXMuZ29hbFZvbDEpIHRoaXMuZ29hbFZvbDEudmlzaWJsZSA9IHRoaXMuZW5hYmxlZCAmJiB0aGlzLnNob3dHb2FsVm9sdW1lOwogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMikgdGhpcy5nb2FsVm9sMi52aXNpYmxlID0gdGhpcy5lbmFibGVkICYmIHRoaXMuc2hvd0dvYWxWb2x1bWU7CgogICAgICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMudmlzdWFscy5zaXplID4gMCkgdGhpcy5jbGVhcigpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIWdhbWUudGVhbXMuaG9tZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZW50aXRpZXMgPSBbCiAgICAgICAgICAgICAgICAuLi5nYW1lLnRlYW1zLmhvbWUucGxheWVycywKICAgICAgICAgICAgICAgIC4uLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLAogICAgICAgICAgICAgICAgZ2FtZS5lbnRpdGllcy5iYWxsCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBlbnRpdGllcy5mb3JFYWNoKGUgPT4gewogICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHYgPSB0aGlzLnZpc3VhbHMuZ2V0KGUpOwogICAgICAgICAgICAgICAgaWYgKCF2KSB7CiAgICAgICAgICAgICAgICAgICAgdiA9IHRoaXMuY3JlYXRlVmlzdWFsKGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmlzdWFscy5zZXQoZSwgdik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbChlLCB2KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBjcmVhdGVWaXN1YWwoZW50aXR5KSB7CiAgICAgICAgICAgIGNvbnN0IGdyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKGdyb3VwKTsKCiAgICAgICAgICAgIC8vIEhpdGJveGVzCiAgICAgICAgICAgIGNvbnN0IHRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoKHRoaXMuZ2VvQ3lsaW5kZXIsIHRoaXMubWF0VGFja2xlKTsKICAgICAgICAgICAgY29uc3QgY2F0Y2hSID0gbmV3IFRIUkVFLk1lc2godGhpcy5nZW9DeWxpbmRlciwgdGhpcy5tYXRDYXRjaCk7CiAgICAgICAgICAgIGdyb3VwLmFkZCh0YWNrbGUpOwogICAgICAgICAgICBncm91cC5hZGQoY2F0Y2hSKTsKCiAgICAgICAgICAgIC8vIExpbmVzCiAgICAgICAgICAgIGNvbnN0IHZlbExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRWZWwpOwogICAgICAgICAgICBjb25zdCBpbnB1dExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRJbnB1dCk7CiAgICAgICAgICAgIGNvbnN0IGFpTGluZSA9IHRoaXMuY3JlYXRlTGluZSh0aGlzLm1hdEFJKTsgLy8gTGluZSB0byBwZXJjZWl2ZWQgdGFyZ2V0CiAgICAgICAgICAgIAogICAgICAgICAgICBncm91cC5hZGQodmVsTGluZSk7CiAgICAgICAgICAgIGdyb3VwLmFkZChpbnB1dExpbmUpOwogICAgICAgICAgICBncm91cC5hZGQoYWlMaW5lKTsKCiAgICAgICAgICAgIHJldHVybiB7IGdyb3VwLCB0YWNrbGUsIGNhdGNoUiwgdmVsTGluZSwgaW5wdXRMaW5lLCBhaUxpbmUgfTsKICAgICAgICB9CgogICAgICAgIGNyZWF0ZUxpbmUobWF0KSB7CiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpLnNldEZyb21Qb2ludHMoW25ldyBUSFJFRS5WZWN0b3IzKCksIG5ldyBUSFJFRS5WZWN0b3IzKCldKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5MaW5lKGdlbywgbWF0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUxpbmUobGluZSwgc3RhcnQsIGVuZCkgewogICAgICAgICAgICBjb25zdCBwb3MgPSBsaW5lLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24uYXJyYXk7CiAgICAgICAgICAgIHBvc1swXSA9IHN0YXJ0Lng7IHBvc1sxXSA9IHN0YXJ0Lnk7IHBvc1syXSA9IHN0YXJ0Lno7CiAgICAgICAgICAgIHBvc1szXSA9IGVuZC54OyBwb3NbNF0gPSBlbmQueTsgcG9zWzVdID0gZW5kLno7CiAgICAgICAgICAgIGxpbmUuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGxpbmUudmlzaWJsZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWwoZSwgdikgewogICAgICAgICAgICB2Lmdyb3VwLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGl0Ym94ZXMgKExvY2FsIHRvIGVudGl0eSBwb3NpdGlvbikKICAgICAgICAgICAgdi50YWNrbGUucG9zaXRpb24uY29weShlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB2LmNhdGNoUi5wb3NpdGlvbi5jb3B5KGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5zaG93SGl0Ym94ZXMgJiYgZS5yb2xlKSB7CiAgICAgICAgICAgICAgICB2LnRhY2tsZS52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnN0IHJUID0gZS50YWNrbGVSYWRpdXMgfHwgMi41OwogICAgICAgICAgICAgICAgdi50YWNrbGUuc2NhbGUuc2V0KHJULCAxLCByVCk7CgogICAgICAgICAgICAgICAgdi5jYXRjaFIudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBMb2dpYyBmcm9tIG1haW4uanMgY2hlY2tCYWxsR3JhYgogICAgICAgICAgICAgICAgY29uc3QgckMgPSBlLmlzRGFzaGluZyA/IDQuMCA6IDIuNTsgCiAgICAgICAgICAgICAgICB2LmNhdGNoUi5zY2FsZS5zZXQockMsIDEsIHJDKTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnBvc2l0aW9uLnkgPSBlLm1lc2gucG9zaXRpb24ueSArIDAuMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYudGFja2xlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVmVjdG9ycyAoR2xvYmFsIGxpbmVzKQogICAgICAgICAgICBjb25zdCBvcmlnaW4gPSBlLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgb3JpZ2luLnkgKz0gMS4wOyAvLyBMaWZ0IHVwCgogICAgICAgICAgICBpZiAodGhpcy5zaG93VmVjdG9ycykgewogICAgICAgICAgICAgICAgLy8gVmVsb2NpdHkKICAgICAgICAgICAgICAgIGlmIChlLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTGluZSh2LnZlbExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElucHV0CiAgICAgICAgICAgICAgICBpZiAoZS5pbnB1dFZlY3RvciAmJiBlLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUuaW5wdXRWZWN0b3IuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigzLjApKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxpbmUodi5pbnB1dExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdi5pbnB1dExpbmUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdi52ZWxMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuaW5wdXRMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQUkKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd0FJICYmIGUucGVyY2VpdmVkVGFyZ2V0UG9zKSB7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGxpbmUgdG8gcGVyY2VpdmVkIHRhcmdldAogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVMaW5lKHYuYWlMaW5lLCBvcmlnaW4sIGUucGVyY2VpdmVkVGFyZ2V0UG9zKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYuYWlMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2xlYXIoKSB7CiAgICAgICAgICAgIHRoaXMudmlzdWFscy5mb3JFYWNoKHYgPT4gewogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5yZW1vdmUodi5ncm91cCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnZpc3VhbHMuY2xlYXIoKTsKICAgICAgICB9CiAgICB9CiAgICB3aW5kb3cuZmx1eC5EZWJ1Z1Zpc3VhbGl6ZXIgPSBEZWJ1Z1Zpc3VhbGl6ZXI7Cn0pKCk7","./DebugVisualizer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBEZWJ1Z1Zpc3VhbGl6ZXIgewpjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dWZWN0b3JzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0FJID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0dvYWxWb2x1bWUgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMudmlzdWFscyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hdGVyaWFscwogICAgICAgICAgICB0aGlzLm1hdFRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4yIH0pOwogICAgICAgICAgICB0aGlzLm1hdENhdGNoID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZjAwLCB3aXJlZnJhbWU6IHRydWUsIHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjIgfSk7CiAgICAgICAgICAgIHRoaXMubWF0VmVsID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZjAwIH0pOyAvLyBZZWxsb3cgVmVsb2NpdHkKICAgICAgICAgICAgdGhpcy5tYXRJbnB1dCA9IG5ldyBUSFJFRS5MaW5lQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiB9KTsgLy8gQ3lhbiBJbnB1dAogICAgICAgICAgICB0aGlzLm1hdEFJID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmYwMGZmIH0pOyAvLyBNYWdlbnRhIEFJIFBlcmNlcHRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJpZXMKICAgICAgICAgICAgdGhpcy5nZW9DeWxpbmRlciA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEsIDEsIDAuMSwgMTYpOwogICAgICAgICAgICB0aGlzLmdlb0N5bGluZGVyLnRyYW5zbGF0ZSgwLCAwLjA1LCAwKTsKCiAgICAgICAgICAgIC8vIEdvYWwgVm9sdW1lIFZpc3VhbGl6YXRpb24gKFJlZCBUcmFuc3BhcmVudCBCb3gpCiAgICAgICAgICAgIGNvbnN0IGdvYWxHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoMjIsIDE4LCAxMCk7CiAgICAgICAgICAgIGNvbnN0IGdvYWxNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmMDAwMCwgCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLjI1LCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UgCiAgICAgICAgICAgIH0pOwoKdGhpcy5nb2FsVm9sMSA9IG5ldyBUSFJFRS5NZXNoKGdvYWxHZW8sIGdvYWxNYXQpOwogICAgICAgICAgICB0aGlzLmdvYWxWb2wxLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5nb2FsVm9sMSk7CgogICAgICAgICAgICB0aGlzLmdvYWxWb2wyID0gbmV3IFRIUkVFLk1lc2goZ29hbEdlbywgZ29hbE1hdCk7CiAgICAgICAgICAgIHRoaXMuZ29hbFZvbDIudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmdvYWxWb2wyKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudXBkYXRlR29hbFZvbHVtZXMoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdXBkYXRlR29hbFZvbHVtZXMoKSB7CmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMSkgdGhpcy5nb2FsVm9sMS5wb3NpdGlvbi5zZXQoMCwgLTYuMCwgLShnb2FsRGlzdCArIDUuMCkpOwogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMikgdGhpcy5nb2FsVm9sMi5wb3NpdGlvbi5zZXQoMCwgLTYuMCwgKGdvYWxEaXN0ICsgNS4wKSk7CiAgICAgICAgfQoKCnVwZGF0ZSgpIHsKICAgICAgICAgICAgLy8gVXBkYXRlIHN0YXRpYyBkZWJ1Z3MKICAgICAgICAgICAgaWYgKHRoaXMuZ29hbFZvbDEpIHRoaXMuZ29hbFZvbDEudmlzaWJsZSA9IHRoaXMuZW5hYmxlZCAmJiB0aGlzLnNob3dHb2FsVm9sdW1lOwogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMikgdGhpcy5nb2FsVm9sMi52aXNpYmxlID0gdGhpcy5lbmFibGVkICYmIHRoaXMuc2hvd0dvYWxWb2x1bWU7CgogICAgICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMudmlzdWFscy5zaXplID4gMCkgdGhpcy5jbGVhcigpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIWdhbWUudGVhbXMuaG9tZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZW50aXRpZXMgPSBbCiAgICAgICAgICAgICAgICAuLi5nYW1lLnRlYW1zLmhvbWUucGxheWVycywKICAgICAgICAgICAgICAgIC4uLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLAogICAgICAgICAgICAgICAgZ2FtZS5lbnRpdGllcy5iYWxsCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBlbnRpdGllcy5mb3JFYWNoKGUgPT4gewogICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHYgPSB0aGlzLnZpc3VhbHMuZ2V0KGUpOwogICAgICAgICAgICAgICAgaWYgKCF2KSB7CiAgICAgICAgICAgICAgICAgICAgdiA9IHRoaXMuY3JlYXRlVmlzdWFsKGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmlzdWFscy5zZXQoZSwgdik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbChlLCB2KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBjcmVhdGVWaXN1YWwoZW50aXR5KSB7CiAgICAgICAgICAgIGNvbnN0IGdyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKGdyb3VwKTsKCiAgICAgICAgICAgIC8vIEhpdGJveGVzCiAgICAgICAgICAgIGNvbnN0IHRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoKHRoaXMuZ2VvQ3lsaW5kZXIsIHRoaXMubWF0VGFja2xlKTsKICAgICAgICAgICAgY29uc3QgY2F0Y2hSID0gbmV3IFRIUkVFLk1lc2godGhpcy5nZW9DeWxpbmRlciwgdGhpcy5tYXRDYXRjaCk7CiAgICAgICAgICAgIGdyb3VwLmFkZCh0YWNrbGUpOwogICAgICAgICAgICBncm91cC5hZGQoY2F0Y2hSKTsKCiAgICAgICAgICAgIC8vIExpbmVzCiAgICAgICAgICAgIGNvbnN0IHZlbExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRWZWwpOwogICAgICAgICAgICBjb25zdCBpbnB1dExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRJbnB1dCk7CiAgICAgICAgICAgIGNvbnN0IGFpTGluZSA9IHRoaXMuY3JlYXRlTGluZSh0aGlzLm1hdEFJKTsgLy8gTGluZSB0byBwZXJjZWl2ZWQgdGFyZ2V0CiAgICAgICAgICAgIAogICAgICAgICAgICBncm91cC5hZGQodmVsTGluZSk7CiAgICAgICAgICAgIGdyb3VwLmFkZChpbnB1dExpbmUpOwogICAgICAgICAgICBncm91cC5hZGQoYWlMaW5lKTsKCiAgICAgICAgICAgIHJldHVybiB7IGdyb3VwLCB0YWNrbGUsIGNhdGNoUiwgdmVsTGluZSwgaW5wdXRMaW5lLCBhaUxpbmUgfTsKICAgICAgICB9CgogICAgICAgIGNyZWF0ZUxpbmUobWF0KSB7CiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpLnNldEZyb21Qb2ludHMoW25ldyBUSFJFRS5WZWN0b3IzKCksIG5ldyBUSFJFRS5WZWN0b3IzKCldKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5MaW5lKGdlbywgbWF0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUxpbmUobGluZSwgc3RhcnQsIGVuZCkgewogICAgICAgICAgICBjb25zdCBwb3MgPSBsaW5lLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24uYXJyYXk7CiAgICAgICAgICAgIHBvc1swXSA9IHN0YXJ0Lng7IHBvc1sxXSA9IHN0YXJ0Lnk7IHBvc1syXSA9IHN0YXJ0Lno7CiAgICAgICAgICAgIHBvc1szXSA9IGVuZC54OyBwb3NbNF0gPSBlbmQueTsgcG9zWzVdID0gZW5kLno7CiAgICAgICAgICAgIGxpbmUuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGxpbmUudmlzaWJsZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWwoZSwgdikgewogICAgICAgICAgICB2Lmdyb3VwLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGl0Ym94ZXMgKExvY2FsIHRvIGVudGl0eSBwb3NpdGlvbikKICAgICAgICAgICAgdi50YWNrbGUucG9zaXRpb24uY29weShlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB2LmNhdGNoUi5wb3NpdGlvbi5jb3B5KGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5zaG93SGl0Ym94ZXMgJiYgZS5yb2xlKSB7CiAgICAgICAgICAgICAgICB2LnRhY2tsZS52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnN0IHJUID0gZS50YWNrbGVSYWRpdXMgfHwgMi41OwogICAgICAgICAgICAgICAgdi50YWNrbGUuc2NhbGUuc2V0KHJULCAxLCByVCk7CgogICAgICAgICAgICAgICAgdi5jYXRjaFIudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBMb2dpYyBmcm9tIG1haW4uanMgY2hlY2tCYWxsR3JhYgogICAgICAgICAgICAgICAgY29uc3QgckMgPSBlLmlzRGFzaGluZyA/IDQuMCA6IDIuNTsgCiAgICAgICAgICAgICAgICB2LmNhdGNoUi5zY2FsZS5zZXQockMsIDEsIHJDKTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnBvc2l0aW9uLnkgPSBlLm1lc2gucG9zaXRpb24ueSArIDAuMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYudGFja2xlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVmVjdG9ycyAoR2xvYmFsIGxpbmVzKQogICAgICAgICAgICBjb25zdCBvcmlnaW4gPSBlLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgb3JpZ2luLnkgKz0gMS4wOyAvLyBMaWZ0IHVwCgogICAgICAgICAgICBpZiAodGhpcy5zaG93VmVjdG9ycykgewogICAgICAgICAgICAgICAgLy8gVmVsb2NpdHkKICAgICAgICAgICAgICAgIGlmIChlLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTGluZSh2LnZlbExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElucHV0CiAgICAgICAgICAgICAgICBpZiAoZS5pbnB1dFZlY3RvciAmJiBlLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUuaW5wdXRWZWN0b3IuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigzLjApKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxpbmUodi5pbnB1dExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdi5pbnB1dExpbmUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdi52ZWxMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuaW5wdXRMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQUkKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd0FJICYmIGUucGVyY2VpdmVkVGFyZ2V0UG9zKSB7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGxpbmUgdG8gcGVyY2VpdmVkIHRhcmdldAogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVMaW5lKHYuYWlMaW5lLCBvcmlnaW4sIGUucGVyY2VpdmVkVGFyZ2V0UG9zKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYuYWlMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2xlYXIoKSB7CiAgICAgICAgICAgIHRoaXMudmlzdWFscy5mb3JFYWNoKHYgPT4gewogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5yZW1vdmUodi5ncm91cCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnZpc3VhbHMuY2xlYXIoKTsKICAgICAgICB9CiAgICB9CiAgICB3aW5kb3cuZmx1eC5EZWJ1Z1Zpc3VhbGl6ZXIgPSBEZWJ1Z1Zpc3VhbGl6ZXI7Cn0pKCk7","/DebugVisualizer.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBEZWJ1Z1Zpc3VhbGl6ZXIgewpjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dIaXRib3hlcyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3dWZWN0b3JzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0FJID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2hvd0dvYWxWb2x1bWUgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMudmlzdWFscyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1hdGVyaWFscwogICAgICAgICAgICB0aGlzLm1hdFRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmMDAwMCwgd2lyZWZyYW1lOiB0cnVlLCB0cmFuc3BhcmVudDogdHJ1ZSwgb3BhY2l0eTogMC4yIH0pOwogICAgICAgICAgICB0aGlzLm1hdENhdGNoID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4MDBmZjAwLCB3aXJlZnJhbWU6IHRydWUsIHRyYW5zcGFyZW50OiB0cnVlLCBvcGFjaXR5OiAwLjIgfSk7CiAgICAgICAgICAgIHRoaXMubWF0VmVsID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmZmZjAwIH0pOyAvLyBZZWxsb3cgVmVsb2NpdHkKICAgICAgICAgICAgdGhpcy5tYXRJbnB1dCA9IG5ldyBUSFJFRS5MaW5lQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwZmZmZiB9KTsgLy8gQ3lhbiBJbnB1dAogICAgICAgICAgICB0aGlzLm1hdEFJID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ZmYwMGZmIH0pOyAvLyBNYWdlbnRhIEFJIFBlcmNlcHRpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEdlb21ldHJpZXMKICAgICAgICAgICAgdGhpcy5nZW9DeWxpbmRlciA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEsIDEsIDAuMSwgMTYpOwogICAgICAgICAgICB0aGlzLmdlb0N5bGluZGVyLnRyYW5zbGF0ZSgwLCAwLjA1LCAwKTsKCiAgICAgICAgICAgIC8vIEdvYWwgVm9sdW1lIFZpc3VhbGl6YXRpb24gKFJlZCBUcmFuc3BhcmVudCBCb3gpCiAgICAgICAgICAgIGNvbnN0IGdvYWxHZW8gPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoMjIsIDE4LCAxMCk7CiAgICAgICAgICAgIGNvbnN0IGdvYWxNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmMDAwMCwgCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLjI1LCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UgCiAgICAgICAgICAgIH0pOwoKdGhpcy5nb2FsVm9sMSA9IG5ldyBUSFJFRS5NZXNoKGdvYWxHZW8sIGdvYWxNYXQpOwogICAgICAgICAgICB0aGlzLmdvYWxWb2wxLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQodGhpcy5nb2FsVm9sMSk7CgogICAgICAgICAgICB0aGlzLmdvYWxWb2wyID0gbmV3IFRIUkVFLk1lc2goZ29hbEdlbywgZ29hbE1hdCk7CiAgICAgICAgICAgIHRoaXMuZ29hbFZvbDIudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmdvYWxWb2wyKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudXBkYXRlR29hbFZvbHVtZXMoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdXBkYXRlR29hbFZvbHVtZXMoKSB7CmNvbnN0IGdvYWxEaXN0ID0gKHdpbmRvdy5mbHV4LkJhbGxDb25maWcgJiYgd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFKSB8fCA0MS41OwogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMSkgdGhpcy5nb2FsVm9sMS5wb3NpdGlvbi5zZXQoMCwgLTYuMCwgLShnb2FsRGlzdCArIDUuMCkpOwogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMikgdGhpcy5nb2FsVm9sMi5wb3NpdGlvbi5zZXQoMCwgLTYuMCwgKGdvYWxEaXN0ICsgNS4wKSk7CiAgICAgICAgfQoKCnVwZGF0ZSgpIHsKICAgICAgICAgICAgLy8gVXBkYXRlIHN0YXRpYyBkZWJ1Z3MKICAgICAgICAgICAgaWYgKHRoaXMuZ29hbFZvbDEpIHRoaXMuZ29hbFZvbDEudmlzaWJsZSA9IHRoaXMuZW5hYmxlZCAmJiB0aGlzLnNob3dHb2FsVm9sdW1lOwogICAgICAgICAgICBpZiAodGhpcy5nb2FsVm9sMikgdGhpcy5nb2FsVm9sMi52aXNpYmxlID0gdGhpcy5lbmFibGVkICYmIHRoaXMuc2hvd0dvYWxWb2x1bWU7CgogICAgICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMudmlzdWFscy5zaXplID4gMCkgdGhpcy5jbGVhcigpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBnYW1lID0gd2luZG93LmZsdXguZ2FtZUluc3RhbmNlOwogICAgICAgICAgICBpZiAoIWdhbWUgfHwgIWdhbWUudGVhbXMuaG9tZSkgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgZW50aXRpZXMgPSBbCiAgICAgICAgICAgICAgICAuLi5nYW1lLnRlYW1zLmhvbWUucGxheWVycywKICAgICAgICAgICAgICAgIC4uLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLAogICAgICAgICAgICAgICAgZ2FtZS5lbnRpdGllcy5iYWxsCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBlbnRpdGllcy5mb3JFYWNoKGUgPT4gewogICAgICAgICAgICAgICAgaWYgKCFlIHx8ICFlLm1lc2gpIHJldHVybjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGV0IHYgPSB0aGlzLnZpc3VhbHMuZ2V0KGUpOwogICAgICAgICAgICAgICAgaWYgKCF2KSB7CiAgICAgICAgICAgICAgICAgICAgdiA9IHRoaXMuY3JlYXRlVmlzdWFsKGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmlzdWFscy5zZXQoZSwgdik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVZpc3VhbChlLCB2KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBjcmVhdGVWaXN1YWwoZW50aXR5KSB7CiAgICAgICAgICAgIGNvbnN0IGdyb3VwID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKGdyb3VwKTsKCiAgICAgICAgICAgIC8vIEhpdGJveGVzCiAgICAgICAgICAgIGNvbnN0IHRhY2tsZSA9IG5ldyBUSFJFRS5NZXNoKHRoaXMuZ2VvQ3lsaW5kZXIsIHRoaXMubWF0VGFja2xlKTsKICAgICAgICAgICAgY29uc3QgY2F0Y2hSID0gbmV3IFRIUkVFLk1lc2godGhpcy5nZW9DeWxpbmRlciwgdGhpcy5tYXRDYXRjaCk7CiAgICAgICAgICAgIGdyb3VwLmFkZCh0YWNrbGUpOwogICAgICAgICAgICBncm91cC5hZGQoY2F0Y2hSKTsKCiAgICAgICAgICAgIC8vIExpbmVzCiAgICAgICAgICAgIGNvbnN0IHZlbExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRWZWwpOwogICAgICAgICAgICBjb25zdCBpbnB1dExpbmUgPSB0aGlzLmNyZWF0ZUxpbmUodGhpcy5tYXRJbnB1dCk7CiAgICAgICAgICAgIGNvbnN0IGFpTGluZSA9IHRoaXMuY3JlYXRlTGluZSh0aGlzLm1hdEFJKTsgLy8gTGluZSB0byBwZXJjZWl2ZWQgdGFyZ2V0CiAgICAgICAgICAgIAogICAgICAgICAgICBncm91cC5hZGQodmVsTGluZSk7CiAgICAgICAgICAgIGdyb3VwLmFkZChpbnB1dExpbmUpOwogICAgICAgICAgICBncm91cC5hZGQoYWlMaW5lKTsKCiAgICAgICAgICAgIHJldHVybiB7IGdyb3VwLCB0YWNrbGUsIGNhdGNoUiwgdmVsTGluZSwgaW5wdXRMaW5lLCBhaUxpbmUgfTsKICAgICAgICB9CgogICAgICAgIGNyZWF0ZUxpbmUobWF0KSB7CiAgICAgICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpLnNldEZyb21Qb2ludHMoW25ldyBUSFJFRS5WZWN0b3IzKCksIG5ldyBUSFJFRS5WZWN0b3IzKCldKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5MaW5lKGdlbywgbWF0KTsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUxpbmUobGluZSwgc3RhcnQsIGVuZCkgewogICAgICAgICAgICBjb25zdCBwb3MgPSBsaW5lLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24uYXJyYXk7CiAgICAgICAgICAgIHBvc1swXSA9IHN0YXJ0Lng7IHBvc1sxXSA9IHN0YXJ0Lnk7IHBvc1syXSA9IHN0YXJ0Lno7CiAgICAgICAgICAgIHBvc1szXSA9IGVuZC54OyBwb3NbNF0gPSBlbmQueTsgcG9zWzVdID0gZW5kLno7CiAgICAgICAgICAgIGxpbmUuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGxpbmUudmlzaWJsZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVWaXN1YWwoZSwgdikgewogICAgICAgICAgICB2Lmdyb3VwLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSGl0Ym94ZXMgKExvY2FsIHRvIGVudGl0eSBwb3NpdGlvbikKICAgICAgICAgICAgdi50YWNrbGUucG9zaXRpb24uY29weShlLm1lc2gucG9zaXRpb24pOwogICAgICAgICAgICB2LmNhdGNoUi5wb3NpdGlvbi5jb3B5KGUubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5zaG93SGl0Ym94ZXMgJiYgZS5yb2xlKSB7CiAgICAgICAgICAgICAgICB2LnRhY2tsZS52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnN0IHJUID0gZS50YWNrbGVSYWRpdXMgfHwgMi41OwogICAgICAgICAgICAgICAgdi50YWNrbGUuc2NhbGUuc2V0KHJULCAxLCByVCk7CgogICAgICAgICAgICAgICAgdi5jYXRjaFIudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyBMb2dpYyBmcm9tIG1haW4uanMgY2hlY2tCYWxsR3JhYgogICAgICAgICAgICAgICAgY29uc3QgckMgPSBlLmlzRGFzaGluZyA/IDQuMCA6IDIuNTsgCiAgICAgICAgICAgICAgICB2LmNhdGNoUi5zY2FsZS5zZXQockMsIDEsIHJDKTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnBvc2l0aW9uLnkgPSBlLm1lc2gucG9zaXRpb24ueSArIDAuMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYudGFja2xlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuY2F0Y2hSLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVmVjdG9ycyAoR2xvYmFsIGxpbmVzKQogICAgICAgICAgICBjb25zdCBvcmlnaW4gPSBlLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgb3JpZ2luLnkgKz0gMS4wOyAvLyBMaWZ0IHVwCgogICAgICAgICAgICBpZiAodGhpcy5zaG93VmVjdG9ycykgewogICAgICAgICAgICAgICAgLy8gVmVsb2NpdHkKICAgICAgICAgICAgICAgIGlmIChlLnZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUudmVsb2NpdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTGluZSh2LnZlbExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElucHV0CiAgICAgICAgICAgICAgICBpZiAoZS5pbnB1dFZlY3RvciAmJiBlLmlucHV0VmVjdG9yLmxlbmd0aFNxKCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gb3JpZ2luLmNsb25lKCkuYWRkKGUuaW5wdXRWZWN0b3IuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigzLjApKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxpbmUodi5pbnB1dExpbmUsIG9yaWdpbiwgZW5kKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdi5pbnB1dExpbmUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdi52ZWxMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHYuaW5wdXRMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQUkKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd0FJICYmIGUucGVyY2VpdmVkVGFyZ2V0UG9zKSB7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGxpbmUgdG8gcGVyY2VpdmVkIHRhcmdldAogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVMaW5lKHYuYWlMaW5lLCBvcmlnaW4sIGUucGVyY2VpdmVkVGFyZ2V0UG9zKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYuYWlMaW5lLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2xlYXIoKSB7CiAgICAgICAgICAgIHRoaXMudmlzdWFscy5mb3JFYWNoKHYgPT4gewogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5yZW1vdmUodi5ncm91cCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnZpc3VhbHMuY2xlYXIoKTsKICAgICAgICB9CiAgICB9CiAgICB3aW5kb3cuZmx1eC5EZWJ1Z1Zpc3VhbGl6ZXIgPSBEZWJ1Z1Zpc3VhbGl6ZXI7Cn0pKCk7","MenuManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNZW51TWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3IoZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZU1hbmFnZXI7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tbWVudScpOwogICAgICAgICAgICB0aGlzLml0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLm1lbnUtaXRlbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zZXR1cEV2ZW50cygpOwogICAgICAgIH0KCiAgICAgICAgc2V0dXBFdmVudHMoKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIFByZXZlbnQgY2xpY2stdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlU2VsZWN0aW9uKGl0ZW0uZGF0YXNldC5hY3Rpb24pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKaXRlbS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWVudGVyJywgKCkgPT4gewogICAgICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBQbGF5IGhvdmVyIHNvdW5kCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIpIHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIucGxheVNGWCgnbWVudScsIHsgdm9sdW1lOiAwLjUsIHZhcmlhbmNlOiAwLjA1IH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaGFuZGxlU2VsZWN0aW9uKGFjdGlvbikgewogICAgICAgICAgICBjb25zb2xlLmxvZygiTWVudSBTZWxlY3Rpb246IiwgYWN0aW9uKTsKY29uc29sZS5sb2coIk1lbnUgU2VsZWN0aW9uOiIsIGFjdGlvbik7CmlmIChhY3Rpb24gPT09ICdub3JtYWwnKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmF1ZGlvTWFuYWdlcikgdGhpcy5nYW1lLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdtZW51JywgeyB2b2x1bWU6IDEuMCB9KTsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ25vcm1hbCcpOwp9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhcnRNYXRjaCgncHJhY3RpY2UnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdiYWxsX2xhYicpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGwgPSAnYmFsbF9sYWInOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ3ByYWN0aWNlJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnb3B0aW9ucycpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJPcHRpb25zIGNsaWNrZWQgKE5vdCBpbXBsZW1lbnRlZCkiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2hvdygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGlkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZShmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguTWVudU1hbmFnZXIgPSBNZW51TWFuYWdlcjsKfSkoKTs=","./MenuManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNZW51TWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3IoZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZU1hbmFnZXI7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tbWVudScpOwogICAgICAgICAgICB0aGlzLml0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLm1lbnUtaXRlbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zZXR1cEV2ZW50cygpOwogICAgICAgIH0KCiAgICAgICAgc2V0dXBFdmVudHMoKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIFByZXZlbnQgY2xpY2stdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlU2VsZWN0aW9uKGl0ZW0uZGF0YXNldC5hY3Rpb24pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKaXRlbS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWVudGVyJywgKCkgPT4gewogICAgICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBQbGF5IGhvdmVyIHNvdW5kCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIpIHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIucGxheVNGWCgnbWVudScsIHsgdm9sdW1lOiAwLjUsIHZhcmlhbmNlOiAwLjA1IH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaGFuZGxlU2VsZWN0aW9uKGFjdGlvbikgewogICAgICAgICAgICBjb25zb2xlLmxvZygiTWVudSBTZWxlY3Rpb246IiwgYWN0aW9uKTsKY29uc29sZS5sb2coIk1lbnUgU2VsZWN0aW9uOiIsIGFjdGlvbik7CmlmIChhY3Rpb24gPT09ICdub3JtYWwnKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmF1ZGlvTWFuYWdlcikgdGhpcy5nYW1lLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdtZW51JywgeyB2b2x1bWU6IDEuMCB9KTsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ25vcm1hbCcpOwp9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhcnRNYXRjaCgncHJhY3RpY2UnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdiYWxsX2xhYicpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGwgPSAnYmFsbF9sYWInOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ3ByYWN0aWNlJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnb3B0aW9ucycpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJPcHRpb25zIGNsaWNrZWQgKE5vdCBpbXBsZW1lbnRlZCkiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2hvdygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGlkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZShmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguTWVudU1hbmFnZXIgPSBNZW51TWFuYWdlcjsKfSkoKTs=","/MenuManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBNZW51TWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3IoZ2FtZU1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZU1hbmFnZXI7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tbWVudScpOwogICAgICAgICAgICB0aGlzLml0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLm1lbnUtaXRlbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zZXR1cEV2ZW50cygpOwogICAgICAgIH0KCiAgICAgICAgc2V0dXBFdmVudHMoKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgICAgICAgIGl0ZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIFByZXZlbnQgY2xpY2stdGhyb3VnaAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlU2VsZWN0aW9uKGl0ZW0uZGF0YXNldC5hY3Rpb24pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKaXRlbS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWVudGVyJywgKCkgPT4gewogICAgICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsOiBQbGF5IGhvdmVyIHNvdW5kCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIpIHRoaXMuZ2FtZS5hdWRpb01hbmFnZXIucGxheVNGWCgnbWVudScsIHsgdm9sdW1lOiAwLjUsIHZhcmlhbmNlOiAwLjA1IH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaGFuZGxlU2VsZWN0aW9uKGFjdGlvbikgewogICAgICAgICAgICBjb25zb2xlLmxvZygiTWVudSBTZWxlY3Rpb246IiwgYWN0aW9uKTsKY29uc29sZS5sb2coIk1lbnUgU2VsZWN0aW9uOiIsIGFjdGlvbik7CmlmIChhY3Rpb24gPT09ICdub3JtYWwnKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmF1ZGlvTWFuYWdlcikgdGhpcy5nYW1lLmF1ZGlvTWFuYWdlci5wbGF5U0ZYKCdtZW51JywgeyB2b2x1bWU6IDEuMCB9KTsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ25vcm1hbCcpOwp9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3ByYWN0aWNlJykgewogICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhcnRNYXRjaCgncHJhY3RpY2UnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdiYWxsX2xhYicpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGwgPSAnYmFsbF9sYWInOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXJ0TWF0Y2goJ3ByYWN0aWNlJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnb3B0aW9ucycpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJPcHRpb25zIGNsaWNrZWQgKE5vdCBpbXBsZW1lbnRlZCkiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2hvdygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGlkZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zZXRNZW51TW9kZShmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguTWVudU1hbmFnZXIgPSBNZW51TWFuYWdlcjsKfSkoKTs=","PracticeManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQcmFjdGljZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREcmlsbCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZSA9IHt9OyAKICAgICAgICAgICAgCnRoaXMuZHJpbGxzID0gewogICAgICAgICAgICAgICAgJ2ZyZWUnOiB7IG5hbWU6ICdGUkVFIFJPQU0nLCBzZXR1cDogdGhpcy5fc2V0dXBGcmVlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BGcmVlLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdiYWxsX2xhYic6IHsgbmFtZTogJ0JBTEwgTEFCJywgc2V0dXA6IHRoaXMuX3NldHVwQmFsbExhYi5iaW5kKHRoaXMpLCBsb29wOiB0aGlzLl9sb29wQmFsbExhYi5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAnc2hvb3RpbmcnOiB7IG5hbWU6ICdTSE9PVElORyBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cFNob290aW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BTaG9vdGluZy5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncGFzc2luZyc6IHsgbmFtZTogJ1BBU1NJTkcgRFJJTEwnLCBzZXR1cDogdGhpcy5fc2V0dXBQYXNzaW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BQYXNzaW5nLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdkZWZlbnNlJzogeyBuYW1lOiAnREVGRU5TRSBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cERlZmVuc2UuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcERlZmVuc2UuYmluZCh0aGlzKSB9LAogICAgICAgICAgICAgICAgJ2N1cnZlJzogeyBuYW1lOiAnQ1VSVkUgU0hPVCcsIHNldHVwOiB0aGlzLl9zZXR1cEN1cnZlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BDdXJ2ZS5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncmFwaWRfZmlyZSc6IHsgbmFtZTogJ1JBUElEIEZJUkUnLCBzZXR1cDogdGhpcy5fc2V0dXBSYXBpZEZpcmUuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcFJhcGlkRmlyZS5iaW5kKHRoaXMpIH0KICAgICAgICAgICAgfTsKCnRoaXMudWkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2Utb3ZlcmxheScpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dlc3R1cmUtaGludCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gewogICAgICAgICAgICAgICAgaW5mU3RhdHM6IHRydWUsCiAgICAgICAgICAgICAgICBhaUR1bW15OiB0cnVlLAogICAgICAgICAgICAgICAgc2hvd0hpdGJveGVzOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy50YXJnZXRSaW5nID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107IC8vIEFycmF5IHRvIHRyYWNrIHZpc3VhbCBjb3BpZXMgb2YgdGhyb3duIGJhbGxzCiAgICAgICAgICAgIHRoaXMuX2luaXRWaXN1YWxzKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwRXZlbnRzKCk7CiAgICAgICAgfQoKICAgICAgICBfaW5pdFZpc3VhbHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBhIGdsb3dpbmcgcmluZyBmb3IgdGFyZ2V0cwogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMS41LCAxLjgsIDMyKTsKICAgICAgICAgICAgZ2VvbWV0cnkucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBmZmZmLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gQWRkIHRvIHNjZW5lIHZpYSBnYW1lIG1hbmFnZXIgcmVmZXJlbmNlCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc2NlbmUpIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy50YXJnZXRSaW5nKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0KCkgewp0aGlzLmlzUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAvLyBJZiBtZW51IHJlcXVlc3RlZCBhIHNwZWNpZmljIGRyaWxsIChlLmcuLCBCYWxsIExhYiksIGhvbm9yIGl0IG9uY2UuCiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGw7CiAgICAgICAgICAgIGlmIChyZXEgJiYgdGhpcy5kcmlsbHNbcmVxXSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChyZXEpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXgucmVxdWVzdGVkUHJhY3RpY2VEcmlsbCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldERyaWxsKCdmcmVlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBIVUQgaXMgdmlzaWJsZQogICAgICAgICAgICBjb25zdCBodWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKTsKICAgICAgICAgICAgaWYoaHVkKSBodWQuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICB9CgogICAgICAgIHN0b3AoKSB7CgogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlUGFuZWwoKTsKICAgICAgICAgICAgdGhpcy5faGlkZVJlc3RvcmVCdG4oKTsKdGhpcy5fY2xlYXJEcmlsbCgpOwogICAgICAgICAgICAKLy8gQ2xlYXIgR2hvc3QgQmFsbHMKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYi5tZXNoKSB0aGlzLmdhbWUuc2NlbmUucmVtb3ZlKGIubWVzaCk7CiAgICAgICAgICAgICAgICBpZiAoYi50cmFpbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50cmFpbC5tZXNoLmdlb21ldHJ5KSBiLnRyYWlsLm1lc2guZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gZmFsc2U7CgogICAgICAgICAgICAvLyBSZXN0b3JlIEF3YXkgVGVhbSBWaXNpYmlsaXR5IGZvciBOb3JtYWwgTWF0Y2gKLy8gUmVzdG9yZSBBd2F5IFRlYW0gVmlzaWJpbGl0eSBmb3IgTm9ybWFsIE1hdGNoCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgICAgIGlmKHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi55ID0gMDsgLy8gRW5zdXJlIHRoZXkgYXJlbid0IHN0dWNrIHVuZGVyIGZsb29yCiAgICAgICAgICAgICAgICAgICAgICAgIHAuY2FuQ2F0Y2ggPSB0cnVlOyAvLyBSZXN0b3JlIGNhdGNoaW5nCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERpc2FibGUgZGVidWcgdmlzdWFscyBpZiB0aGV5IHdlcmUgb24KICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIuZW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5zaG93SGl0Ym94ZXMgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2V0RHJpbGwoa2V5KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5kcmlsbHNba2V5XSkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLl9jbGVhckRyaWxsKCk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudERyaWxsID0ga2V5OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFVJCiAgICAgICAgICAgIGlmICh0aGlzLnVpKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3JBbGwoJy5kcmlsbC1idG4nKS5mb3JFYWNoKGJ0biA9PiB7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC50b2dnbGUoJ2FjdGl2ZScsIGJ0bi5kYXRhc2V0LmRyaWxsID09PSBrZXkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJ1biBTZXR1cAogICAgICAgICAgICB0aGlzLmRyaWxsc1trZXldLnNldHVwKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBbm5vdW5jZW1lbnQKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zaG93QW5ub3VuY2VtZW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2hvd0Fubm91bmNlbWVudCh0aGlzLmRyaWxsc1trZXldLm5hbWUsICdub3JtYWwnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc1J1bm5pbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENvbW1vbiBQcmFjdGljZSBMb2dpYyAoSW5maW5pdGUgU3RhdHMpCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuaW5mU3RhdHMpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5SW5maW5pdGVTdGF0cygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEcmlsbCBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RHJpbGwgJiYgdGhpcy5kcmlsbHNbdGhpcy5jdXJyZW50RHJpbGxdLmxvb3ApIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxzW3RoaXMuY3VycmVudERyaWxsXS5sb29wKGR0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFscyBBbmltYXRpb24KLy8gVmlzdWFscyBBbmltYXRpb24KICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZyAmJiB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnJvdGF0aW9uLnogKz0gZHQ7IC8vIFNwaW4KICAgICAgICAgICAgICAgIGNvbnN0IHMgPSAxLjAgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDUpICogMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnNjYWxlLnNldChzLCBzLCBzKTsKICAgICAgICAgICAgfQoKLy8gVXBkYXRlIEdob3N0IEJhbGxzCiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmdob3N0QmFsbHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmdob3N0QmFsbHNbaV07CiAgICAgICAgICAgICAgICBiLmxpZmUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIC0tLSBQSFlTSUNTICYgVklTVUFMUyBERUxFR0FUSU9OIC0tLQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LkJhbGwgJiYgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlRnJlZSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGwucHJvdG90eXBlLnVwZGF0ZUZyZWUuY2FsbChiLCBkdCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlVmlzdWFscy5jYWxsKGIsIGR0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgVHJhaWwKICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhaWxQb3MgPSBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi5kZWZvcm1Ob2RlKSB0cmFpbFBvcy55ICs9IGIuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgIGIudHJhaWwudXBkYXRlKHRyYWlsUG9zKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gR09BTCBERVRFQ1RJT04gRk9SIEdIT1NUIEJBTExTIC0tLQogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gYi5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgLy8gQ2hlY2sgWiBkZXB0aCAoR29hbCBpcyBhdCArLy0gMjgsIHRyaWdnZXIgYXQgMjkpCmlmIChNYXRoLmFicyhwb3MueikgPiA0MC4wKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gR29hbCBCb3ggRGltZW5zaW9ucyAoTWF0Y2hlcyBHYW1lTWFuYWdlcikKICAgICAgICAgICAgICAgICAgICBjb25zdCBoYWxmV2lkdGggPSAxMS4wOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhbGZIZWlnaHQgPSA5LjA7CmNvbnN0IGdvYWxZT2Zmc2V0ID0gLTYuMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLngpIDw9IGhhbGZXaWR0aCAmJiBNYXRoLmFicyhwb3MueSAtIGdvYWxZT2Zmc2V0KSA8PSBoYWxmSGVpZ2h0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdPQUwhCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biBHb2FsIEZYCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBwb3MsIHsgc2NhbGU6IDguMCwgbGlmZTogMC41IH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBwb3MsIHsgc2NhbGU6IDUuMCB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlYnJpcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBrPTA7IGs8MTA7IGsrKykgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGVicmlzJywgcG9zLCB7IHNjYWxlOiAwLjUgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkdPQUwiLCBwb3MsICJnb2FsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gS2lsbCBiYWxsIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICAgICAgICAgIGIubGlmZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENsZWFudXAKICAgICAgICAgICAgICAgIGlmIChiLmxpZmUgPD0gMCB8fCBiLm1lc2gucG9zaXRpb24ueSA8IC0xMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi5tZXNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50cmFpbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUucmVtb3ZlKGIudHJhaWwubWVzaCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsLm1lc2guZ2VvbWV0cnkpIGIudHJhaWwubWVzaC5nZW9tZXRyeS5kaXNwb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2hvc3RCYWxscy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zZXR1cEV2ZW50cygpIHsKCiAgICAgICAgICAgIC8vIE1pbmltaXplIC8gUmVzdG9yZQogICAgICAgICAgICBjb25zdCBtaW5CdG4gPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoJyNwLW1pbmltaXplJyk7CiAgICAgICAgICAgIGlmIChtaW5CdG4pIHsKICAgICAgICAgICAgICAgIG1pbkJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUGFuZWwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93UmVzdG9yZUJ0bigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHJlc3RvcmVCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2UtcmVzdG9yZS1idG4nKTsKICAgICAgICAgICAgaWYgKHJlc3RvcmVCdG4pIHsKICAgICAgICAgICAgICAgIHJlc3RvcmVCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd1BhbmVsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZVJlc3RvcmVCdG4oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEcmlsbCBCdXR0b25zCiAgICAgICAgICAgIHRoaXMudWkucXVlcnlTZWxlY3RvckFsbCgnLmRyaWxsLWJ0bicpLmZvckVhY2goYnRuID0+IHsKICAgICAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldERyaWxsKGJ0bi5kYXRhc2V0LmRyaWxsKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFJlc2V0IEJhbGwKICAgICAgICAgICAgY29uc3QgcmVzZXRCdG4gPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoJyNwLXJlc2V0LWJhbGwnKTsKICAgICAgICAgICAgaWYgKHJlc2V0QnRuKSB7CiAgICAgICAgICAgICAgICByZXNldEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEV4aXQKICAgICAgICAgICAgY29uc3QgZXhpdEJ0biA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI3AtZXhpdCcpOwogICAgICAgICAgICBpZiAoZXhpdEJ0bikgewogICAgICAgICAgICAgICAgZXhpdEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPSAnbWVudSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPcHRpb25zIFRvZ2dsZXMKICAgICAgICAgICAgdGhpcy5fYmluZFRvZ2dsZSgnb3B0LWluZi1zdGF0JywgJ2luZlN0YXRzJyk7CiAgICAgICAgICAgIHRoaXMuX2JpbmRUb2dnbGUoJ29wdC1haS1kdW1teScsICdhaUR1bW15JywgKHZhbCkgPT4gewogICAgICAgICAgICAgICAgLy8gVXBkYXRlIEFJIER1bW15IHN0YXRlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLnRlYW1zLmF3YXkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5haUVuYWJsZWQgPSAhdmFsOyAvLyBJZiBkdW1teSBpcyBUUlVFLCBBSSBpcyBGQUxTRQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5fYmluZFRvZ2dsZSgnb3B0LWhpdGJveGVzJywgJ3Nob3dIaXRib3hlcycsICh2YWwpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5lbmFibGVkID0gdmFsOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIuc2hvd0hpdGJveGVzID0gdmFsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEtleWJvYXJkIFNob3J0Y3V0IGZvciBSZXNldCAoUikKLy8gS2V5Ym9hcmQgU2hvcnRjdXQgZm9yIFJlc2V0IChSKQogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc1J1bm5pbmcgJiYgZS5rZXkudG9Mb3dlckNhc2UoKSA9PT0gJ3InICYmICFlLnJlcGVhdCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCl9iaW5kVG9nZ2xlKGlkLCBvcHRpb25LZXksIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKGAjJHtpZH1gKTsKICAgICAgICAgICAgaWYgKCFlbCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIHVwZGF0ZSB2aXN1YWxzCiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZVZpc3VhbCA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGlzQWN0aXZlID0gdGhpcy5vcHRpb25zW29wdGlvbktleV07CiAgICAgICAgICAgICAgICBlbC5jbGFzc0xpc3QudG9nZ2xlKCdhY3RpdmUnLCBpc0FjdGl2ZSk7CiAgICAgICAgICAgICAgICBjb25zdCBib3ggPSBlbC5xdWVyeVNlbGVjdG9yKCcuY2hlY2tib3gnKTsKICAgICAgICAgICAgICAgIGlmIChib3gpIGJveC5pbm5lclRleHQgPSBpc0FjdGl2ZSA/ICfilqMnIDogJ+KWoSc7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIHZpc3VhbCBzdGF0ZSBpbW1lZGlhdGVseQogICAgICAgICAgICB1cGRhdGVWaXN1YWwoKTsKCiAgICAgICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnNbb3B0aW9uS2V5XSA9ICF0aGlzLm9wdGlvbnNbb3B0aW9uS2V5XTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdXBkYXRlVmlzdWFsKCk7CgogICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayh0aGlzLm9wdGlvbnNbb3B0aW9uS2V5XSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCgogICAgICAgIF9zZXR1cEJhbGxMYWIoKSB7CiAgICAgICAgICAgIHRoaXMuX3NldEluc3RydWN0aW9uKCJCQUxMIExBQjogT3BlbiBEZXZUb29scyDihpIgQmFsbCBMYWIuIFVzZSBTaG90IENhbm5vbiArIHRyYWplY3RvcnkgcHJldmlldyArIHJlY29yZC9yZXBsYXkuIik7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9IDA7CgogICAgICAgICAgICBjb25zdCBob21lID0gdGhpcy5nYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGNvbnN0IGF3YXkgPSB0aGlzLmdhbWUudGVhbXMuYXdheTsKICAgICAgICAgICAgY29uc3QgcCA9IGhvbWUgPyBob21lLmFjdGl2ZVBsYXllciA6IG51bGw7CiAgICAgICAgICAgIGlmICghcCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gU29sbyBtb2RlOiBoaWRlIGV2ZXJ5b25lIGV4Y2VwdCB0aGUgYWN0aXZlIHBsYXllcgogICAgICAgICAgICBpZiAoaG9tZSAmJiBob21lLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGhvbWUucGxheWVycy5mb3JFYWNoKG1hdGUgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChtYXRlLm1lc2gpIG1hdGUubWVzaC52aXNpYmxlID0gKG1hdGUgPT09IHApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGF3YXkgJiYgYXdheS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBhd2F5LnBsYXllcnMuZm9yRWFjaChvcHAgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChvcHAubWVzaCkgb3BwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFBsYWNlIGFjdGl2ZSBwbGF5ZXIgYXQgY2VudGVyIGZhY2luZyB0aGUgYXdheSBnb2FsCiAgICAgICAgICAgIGlmIChwLm1lc2gpIHsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7CmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgICAgICBwLm1lc2gubG9va0F0KDAsIDAsIC1nb2FsRGlzdCk7CiAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGlmIChwLnN5bmNSb3RhdGlvbikgcC5zeW5jUm90YXRpb24oKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmlnIHN0YXRzIHNvIHlvdSBjYW4gdGVzdCBleHRyZW1lcwogICAgICAgICAgICBpZiAocC5zdGF0cykgewogICAgICAgICAgICAgICAgcC5zdGF0cy5TSCA9IDk5OwogICAgICAgICAgICAgICAgcC5zdGF0cy5QQSA9IDk5OwogICAgICAgICAgICAgICAgcC5zdGF0cy5FTiA9IDk5OwogICAgICAgICAgICAgICAgcC5zdGF0cy5tYXhIUCA9IE1hdGgubWF4KHAuc3RhdHMubWF4SFAgfHwgOTk5LCA5OTkpOwogICAgICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEEgY2xlYXIgdGFyZ2V0IG1hcmtlciAocHVyZWx5IHZpc3VhbCkKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnNldCgwLCAwLjEsIC0xOCk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmYwMGZmKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgogICAgICAgIF9sb29wQmFsbExhYihkdCkgewogICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIGlmICghYiB8fCAhcCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQXV0by1yZXNldCBiYWxsIGJhY2sgdG8gcGxheWVyIG9uY2UgaXQgY29tZXMgdG8gcmVzdCwKICAgICAgICAgICAgLy8gc28geW91IGNhbiBzcGFtIHZhcmlhdGlvbnMgd2l0aG91dCB0b3VjaGluZyBhbnl0aGluZy4KICAgICAgICAgICAgaWYgKGIuc3RhdGUgPT09ICdmcmVlJykgewogICAgICAgICAgICAgICAgY29uc3Qgc3RvcHBlZCA9IChiLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAwLjAxKSAmJiAoYi5wb3dlciA8PSAwLjAxKTsKICAgICAgICAgICAgICAgIGlmIChzdG9wcGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9ICh0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyIHx8IDApICsgZHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPiAwLjQ1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2xpZ2h0IHRhcmdldCBib2IgKGhlbHBzIGRlcHRoIHBlcmNlcHRpb24pCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcgJiYgdGhpcy50YXJnZXRSaW5nLnZpc2libGUpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi55ID0gMC4xICsgTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDAzKSAqIDAuMDU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9hcHBseUluZmluaXRlU3RhdHMoKSB7CiAgICAgICAgICAgIGNvbnN0IGhvbWUgPSB0aGlzLmdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgaWYgKGhvbWUpIHsKICAgICAgICAgICAgICAgIGhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOwogICAgICAgICAgICAgICAgICAgIHAuY3VycmVudEVOID0gcC5zdGF0cy5FTjsKICAgICAgICAgICAgICAgICAgICBwLnN0YXR1cy52ZW5vbSA9IDA7CiAgICAgICAgICAgICAgICAgICAgcC5zdGF0dXMubmFwID0gMDsKICAgICAgICAgICAgICAgICAgICBwLnN0dW5UaW1lciA9IDA7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NsZWFyRHJpbGwoKSB7CgogICAgICAgICAgICAvLyBSZXNldCBwb3NpdGlvbnMsIGNsZWFyIGR1bW1pZXMsIHJlc2V0IHNjb3JlCiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUgPSB7IHNjb3JlOiAwLCB0aW1lcjogMCwgc3RhZ2U6IDAsIHJlc2V0dGluZzogZmFsc2UgfTsKICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSgwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENsZWFyIEdseXBocwogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmdseXBoTWFuYWdlcikgdGhpcy5nYW1lLmdseXBoTWFuYWdlci5jbGVhcigpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFJlc2V0IHRlYW1zIHRvIGRlZmF1bHQgcG9zaXRpb25zCgogICAgICAgICAgICAvLyBSZXNldCB0ZWFtcyB0byBkZWZhdWx0IHBvc2l0aW9ucwogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5yZXNldFBvc2l0aW9ucygpOwogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5yZXNldFBvc2l0aW9ucygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgQUkgRHVtbXkgc2V0dGluZwogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnRlYW1zLmF3YXkpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LmFpRW5hYmxlZCA9ICF0aGlzLm9wdGlvbnMuYWlEdW1teTsKICAgICAgICAgICAgfQovLyBIaWRlIGF3YXkgdGVhbSBieSBkZWZhdWx0IGluIGRyaWxscyB1bmxlc3Mgc3BlY2lmaWVkCiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgLTEwMDAsIDApOyAvLyBNb3ZlIFdBWSBhd2F5IHRvIHByZXZlbnQgaW50ZXJhY3Rpb24KICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIHAuY2FuQ2F0Y2ggPSBmYWxzZTsgLy8gRGlzYWJsZSBjYXRjaGluZwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBIb21lIHRlYW0gaXMgdmlzaWJsZQogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfcmVzZXRCYWxsVG9QbGF5ZXIoKSB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKHAgJiYgYikgewogICAgICAgICAgICAgICAgYi5yZXNldCgpOwogICAgICAgICAgICAgICAgYi5ncmFiKHApOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlJFU0VUIiwgcC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyKSB0aGlzLmdhbWUuY2FtZXJhTWFuYWdlci5zbmFwVG9UYXJnZXQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVNjb3JlVUkodmFsKSB7CiAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjZHJpbGwtc2NvcmUnKTsKICAgICAgICAgICAgaWYgKGVsKSBlbC5pbm5lclRleHQgPSBgU0NPUkU6ICR7dmFsfWA7CiAgICAgICAgfQoKICAgICAgICBfc2V0SW5zdHJ1Y3Rpb24odGV4dCkgewogICAgICAgICAgICAgY29uc3QgZWwgPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoJyNkcmlsbC1pbnN0cnVjdGlvbicpOwogICAgICAgICAgICAgaWYgKGVsKSBlbC5pbm5lclRleHQgPSB0ZXh0OwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIERSSUxMUyAtLS0KCl9zZXR1cEZyZWUoKSB7CiAgICAgICAgICAgIHRoaXMuX3NldEluc3RydWN0aW9uKCJGcmVlIHByYWN0aWNlLiBJbmZpbml0ZSBIUC9FTi4iKTsKICAgICAgICAgICAgLy8gU2hvdyBldmVyeW9uZQogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5jb3B5KHAuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHAuY2FuQ2F0Y2ggPSB0cnVlOyAvLyBSZXN0b3JlIGNhcGFiaWxpdHkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQogICAgICAgIF9sb29wRnJlZShkdCkge30KCiAgICAgICAgX3NldHVwU2hvb3RpbmcoKSB7CgogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiU2NvcmUgb24gdGhlIEdvYWxpZSEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOyAvLyBDbGVhciByZXNldCBmbGFnCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXR1cDogQWN0aXZlIFBsYXllciBhdCAxOG0sIEdvYWxpZSBpbiBuZXQuCiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIGNvbnN0IGcgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHAgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC0xMCk7IC8vIDE4bSBvdXQgKEhvbWUgYXR0YWNrcyAtWikKY29uc3QgZ29hbERpc3QgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UgfHwgNDEuNTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLWdvYWxEaXN0KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZyAmJiBnLm1lc2gpIHsKICAgICAgICAgICAgICAgIGcubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGcubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTI3KTsKICAgICAgICAgICAgICAgIGcubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBnLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9sb29wU2hvb3RpbmcoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGdvYWwgc2NvcmVkIChHYW1lTWFuYWdlciBoYW5kbGVzIHRoZSBhY3R1YWwgZ29hbCBldmVudCwgYnV0IHdlIHRyYWNrIHJlc2V0KQogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YXRlID09PSAnZ29hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRoaXMuZHJpbGxTdGF0ZS5zY29yZSk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhdGUgPSAnYWN0aXZlJzsgLy8gSGlqYWNrIHN0YXRlIGJhY2sKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBTaG9vdGluZygpLCAxMDAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgZ29hbGllIGNhdGNoZXMKICAgICAgICAgICAgY29uc3QgZyA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ0dMJyk7CiAgICAgICAgICAgIGlmIChnICYmIGcuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTQVZFRCIsIGcubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBTaG9vdGluZygpLCAxMDAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3NldHVwUGFzc2luZygpIHsKCiAgICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiUGFzcyB0byB0aGUgbW92aW5nIHRhcmdldCEiKTsKICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgICAvLyBTZXR1cDogQWN0aXZlIFBsYXllciBjZW50ZXIuIDEgVGVhbW1hdGUgcnVubmluZyBwYXR0ZXJucy4KICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQoeCA9PiB4ICE9PSBwICYmIHgucm9sZSAhPT0gJ0dMJyk7CiAgICAgICAgICAgICAKICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS50YXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICAgICAKICAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAxMCk7CiAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgfQogICAgICAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOwogICAgICAgICAgICAgICAgIHRhcmdldC5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgIHRhcmdldC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgfQogICAgICAgICAgICAgCiAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KCiAgICAgICAgX2xvb3BQYXNzaW5nKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmRyaWxsU3RhdGUudGFyZ2V0OwogICAgICAgICAgICBpZiAoIXRhcmdldCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTW92ZSB0YXJnZXQgaW4gY2lyY2xlCiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS50aW1lciArPSBkdDsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gucG9zaXRpb24ueCA9IE1hdGguc2luKHRoaXMuZHJpbGxTdGF0ZS50aW1lcikgKiAxMDsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gucG9zaXRpb24ueiA9IC0xMCArIE1hdGguY29zKHRoaXMuZHJpbGxTdGF0ZS50aW1lciAqIDAuNSkgKiA1OwogICAgICAgICAgICB0YXJnZXQubWVzaC5sb29rQXQoMCwwLDEwKTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBSaW5nCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi5jb3B5KHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi55ID0gMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweDAwZmZmZik7IC8vIEN5YW4KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRhcmdldC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5zY29yZSsrOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIk5JQ0UgUEFTUyEiLCB0YXJnZXQubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVzZXQKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRhcmdldC5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NldHVwUGFzc2luZygpOyAvLyBSZS1zZXR1cCB0byByZXNldCBwb3NpdGlvbnMKICAgICAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgX3NldHVwRGVmZW5zZSgpIHsKCiAgICAgICAgICAgIHRoaXMuX3NldEluc3RydWN0aW9uKCJUYWNrbGUgdGhlIGF0dGFja2VyISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBhdHRhY2tlciA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuYXR0YWNrZXIgPSBhdHRhY2tlcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDIwKTsgLy8gTmVhciBvd24gZ29hbAogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhdHRhY2tlcikgewogICAgICAgICAgICAgICAgYXR0YWNrZXIubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGF0dGFja2VyLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC0xMCk7CiAgICAgICAgICAgICAgICBhdHRhY2tlci52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgLy8gR2l2ZSBiYWxsIHRvIGF0dGFja2VyCiAgICAgICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICBiLnJlc2V0KCk7CiAgICAgICAgICAgICAgICBiLmdyYWIoYXR0YWNrZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9sb29wRGVmZW5zZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgYXR0YWNrZXIgPSB0aGlzLmRyaWxsU3RhdGUuYXR0YWNrZXI7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWF0dGFja2VyIHx8ICFwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBdHRhY2tlciBydW5zIHRvIGdvYWwgKCtaKQovLyBBdHRhY2tlciBydW5zIHRvIGdvYWwgKCtaKQogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbERpc3QpOwogICAgICAgICAgICBjb25zdCBkaXIgPSBnb2FsUG9zLmNsb25lKCkuc3ViKGF0dGFja2VyLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFJpbmcgb24gQXR0YWNrZXIKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLmNvcHkoYXR0YWNrZXIubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZjAwMDApOyAvLyBSZWQgZm9yIGVuZW15CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhdHRhY2tlci5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBhdHRhY2tlci5zZXRJbnB1dChkaXIueCwgZGlyLnopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQmFsbCBsb3N0IChUYWNrbGVkKQogICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCB8fCB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTVE9QUEVEISIsIHAubWVzaC5wb3NpdGlvbiwgImJsb2NrIik7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cERlZmVuc2UoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZhaWwgY29uZGl0aW9uOiBBdHRhY2tlciBzY29yZXMgKEdhbWVNYW5hZ2VyIGhhbmRsZXMgZ29hbCBjaGVjaykKICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc3RhdGUgPT09ICdnb2FsJykgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhdGUgPSAnYWN0aXZlJzsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJGQUlMRUQiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBEZWZlbnNlKCksIDEwMDApOwogICAgICAgICAgICB9Cn0KCiAgICAgICAgX3NldHVwQ3VydmUoKSB7CnRoaXMuX3NldEluc3RydWN0aW9uKCJTd2lwZSBhIENVUlZFICggKSApIHRvIGJ5cGFzcyB0aGUgZGVmZW5kZXIhIik7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFNob3cgZ2VzdHVyZSBoaW50CiAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDbGVhciBhbnkgZXhpc3RpbmcgdGltZW91dAogICAgICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCkgY2xlYXJUaW1lb3V0KHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEF1dG8gaGlkZSBhZnRlciA0cwogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAvLyBVc2UgYSBkZWZlbmRlciBkdW1teQogICAgICAgICAgICBjb25zdCBkZWZlbmRlciA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ0xEJyk7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5kZWZlbmRlciA9IGRlZmVuZGVyOwoKICAgICAgICAgICAgaWYgKHApIHsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMTUpOwpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGVmZW5kZXIpIHsKICAgICAgICAgICAgICAgIGRlZmVuZGVyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBkZWZlbmRlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCA1KTsgLy8gMTBtIGluIGZyb250IG9mIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIubWVzaC5sb29rQXQoMCwgMCwgMTUpOyAvLyBGYWNlIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEJvb3N0IEJMIHRvIGVuc3VyZSBzdHJhaWdodCBzaG90cyBhcmUgYmxvY2tlZAogICAgICAgICAgICAgICAgZGVmZW5kZXIuc3RhdHMuQkwgPSA5OTsgCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhleSBkb24ndCBtb3ZlCiAgICAgICAgICAgICAgICBkZWZlbmRlci5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUYXJnZXQgUmluZyBiZWhpbmQgZGVmZW5kZXIKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnNldCgwLCAwLjEsIC0xMCk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4MDBmZmZmKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgpfbG9vcEN1cnZlKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IGRlZmVuZGVyID0gdGhpcy5kcmlsbFN0YXRlLmRlZmVuZGVyOwoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgYmFsbCBwYXNzZWQgdGhlIGRlZmVuZGVyIGxpbmUgKHogPCAwKQogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAwKSB7CiAgICAgICAgICAgICAgICAvLyBTdWNjZXNzIHpvbmUgKFdpdGhpbiA1bSB3aWR0aCkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhiYWxsLm1lc2gucG9zaXRpb24ueCkgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRUQhIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBDdXJ2ZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGJsb2NrZWQgKEJhbGwgc3RvcHBlZCBvciBwb3dlciBkcmFpbmVkIHNpZ25pZmljYW50bHkgbmVhciBkZWZlbmRlcikKICAgICAgICAgICAgaWYgKGRlZmVuZGVyICYmIGJhbGwubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGRlZmVuZGVyLm1lc2gucG9zaXRpb24pIDwgMy4wKSB7CiAgICAgICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA8PSAwIHx8IGJhbGwudmVsb2NpdHkubGVuZ3RoKCkgPCAxLjApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0tFRCIsIGRlZmVuZGVyLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZS1zaG93IGhpbnQgb24gZmFpbHVyZSB0byBndWlkZSBwbGF5ZXIKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTWlzc2VkIC8gT3V0IG9mIGJvdW5kcwogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAtMTUpIHsKICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiTUlTU0VEIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgLy8gUmUtc2hvdyBoaW50IG9uIG1pc3MKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX3NldHVwUmFwaWRGaXJlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVU5MSU1JVEVEIEFNTU8hIFNwYW0gdGhyb3dzISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBGaW5kIFRpZHVzIG9yIGRlZmF1bHQgdG8gTEYKICAgICAgICAgICAgbGV0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQoeCA9PiB4LmNoYXJhY3Rlck5hbWUgJiYgeC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKTsKICAgICAgICAgICAgaWYgKCFwKSBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnTEYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldCBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5zZXRBY3RpdmVQbGF5ZXIocCk7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBCb29zdCBzdGF0cyBmb3IgZnVuCiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlBBID0gOTk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEhJREUgRVZFUllPTkUgKEFsb25lIE1vZGUpCiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChtYXRlID0+IHsKICAgICAgICAgICAgICAgIGlmIChtYXRlICE9PSBwICYmIG1hdGUubWVzaCkgbWF0ZS5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChvcHAgPT4gewogICAgICAgICAgICAgICAgaWYgKG9wcC5tZXNoKSBvcHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgpfbG9vcFJhcGlkRmlyZShkdCkgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CgogICAgICAgICAgICBpZiAoIXAgfHwgIWIpIHJldHVybjsKCiAgICAgICAgICAgIC8vIERldGVjdCBpZiBiYWxsIHdhcyBqdXN0IHRocm93biAoaXMgZnJlZSkKICAgICAgICAgICAgaWYgKGIuc3RhdGUgPT09ICdmcmVlJykgewogICAgICAgICAgICAgICAgLy8gMS4gU3Bhd24gR2hvc3QgQmFsbCAoVmlzdWFsIENvcHkpCiAgICAgICAgICAgICAgICAvLyBDbG9uZSB0aGUgbWVzaCBoaWVyYXJjaHkgdG8gcHJlc2VydmUgRGVmb3JtL1NwaW4gbm9kZXMKICAgICAgICAgICAgICAgIGNvbnN0IGdob3N0TWVzaCA9IGIubWVzaC5jbG9uZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdmlzaWJpbGl0eSBhbmQgYWRkIHRvIHNjZW5lCiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKGdob3N0TWVzaCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlLWJpbmQgaW50ZXJuYWwgcmVmZXJlbmNlcyBmb3IgdGhlIHBoeXNpY3MgZW5naW5lCiAgICAgICAgICAgICAgICAvLyBIaWVyYXJjaHk6IE1lc2ggLT4gRGVmb3JtTm9kZSAtPiBTcGluTm9kZQogICAgICAgICAgICAgICAgY29uc3QgZGVmb3JtTm9kZSA9IGdob3N0TWVzaC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5Ob2RlID0gZGVmb3JtTm9kZSA/IGRlZm9ybU5vZGUuY2hpbGRyZW5bMF0gOiBudWxsOwoKICAgICAgICAgICAgICAgIC8vIERldGVybWluZSBUcmFpbCBDb2xvciBiYXNlZCBvbiBUZWNoCiAgICAgICAgICAgICAgICBsZXQgdHJhaWxDb2xvciA9IDB4ZmY0NDAwOyAvLyBEZWZhdWx0IFNIIChPcmFuZ2UpCiAgICAgICAgICAgICAgICBpZiAoYi50ZWNobmlxdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ3Zlbm9tJykgdHJhaWxDb2xvciA9IDB4YWEwMGZmOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICd3aXRoZXInKSB0cmFpbENvbG9yID0gMHg4ODg4ODg7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ25hcCcpIHRyYWlsQ29sb3IgPSAweDAwMDA4ODsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnc3BoZXJlJykgdHJhaWxDb2xvciA9IDB4MDBmZmZmOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICdqZWNodCcpIHRyYWlsQ29sb3IgPSAweGZmMDAwMDsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnaW52aXNpYmxlJykgdHJhaWxDb2xvciA9IDB4NDQ0NDQ0OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChiLnBvd2VyVHlwZSA9PT0gJ1BBJykgewogICAgICAgICAgICAgICAgICAgIHRyYWlsQ29sb3IgPSAweDAwYWFmZjsgLy8gUGFzcyAoQmx1ZSkKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDcmVhdGUgVHJhaWwKICAgICAgICAgICAgICAgIGNvbnN0IHRyYWlsID0gbmV3IHdpbmRvdy5mbHV4LlRyYWlsUmVuZGVyZXIodGhpcy5nYW1lLnNjZW5lKTsKICAgICAgICAgICAgICAgIHRyYWlsLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0cmFpbC5zZXRDb2xvcih0cmFpbENvbG9yKTsKICAgICAgICAgICAgICAgIHRyYWlsLnJlc2V0KGdob3N0TWVzaC5wb3NpdGlvbik7CgogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIGEgIk1vY2siIEJhbGwgb2JqZWN0IHRoYXQgc2F0aXNmaWVzIEJhbGwuanMgcGh5c2ljcyByZXF1aXJlbWVudHMKICAgICAgICAgICAgICAgIGNvbnN0IGdob3N0QmFsbCA9IHsKICAgICAgICAgICAgICAgICAgICBtZXNoOiBnaG9zdE1lc2gsCiAgICAgICAgICAgICAgICAgICAgZGVmb3JtTm9kZTogZGVmb3JtTm9kZSwKICAgICAgICAgICAgICAgICAgICBzcGluTm9kZTogc3Bpbk5vZGUsCiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IGIudmVsb2NpdHkuY2xvbmUoKSwKICAgICAgICAgICAgICAgICAgICBhbmd1bGFyVmVsb2NpdHk6IGIuYW5ndWxhclZlbG9jaXR5ID8gYi5hbmd1bGFyVmVsb2NpdHkuY2xvbmUoKSA6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgYWNjdW11bGF0ZWRSb3RhdGlvbjogYi5hY2N1bXVsYXRlZFJvdGF0aW9uID8gYi5hY2N1bXVsYXRlZFJvdGF0aW9uLmNsb25lKCkgOiBuZXcgVEhSRUUuUXVhdGVybmlvbigpLAogICAgICAgICAgICAgICAgICAgIHN0YXRlOiAnZnJlZScsCiAgICAgICAgICAgICAgICAgICAgcG93ZXI6IGIucG93ZXIsCiAgICAgICAgICAgICAgICAgICAgcG93ZXJUeXBlOiBiLnBvd2VyVHlwZSwKICAgICAgICAgICAgICAgICAgICB0ZWNobmlxdWU6IGIudGVjaG5pcXVlLAogICAgICAgICAgICAgICAgICAgIGlzSW52aXNpYmxlOiBiLmlzSW52aXNpYmxlLAogICAgICAgICAgICAgICAgICAgIGxpZmU6IDUuMCwgLy8gRW5vdWdoIHRpbWUgdG8gcmVhY2ggZ29hbAogICAgICAgICAgICAgICAgICAgIHRyYWlsOiB0cmFpbCwKICAgICAgICAgICAgICAgICAgICBfYnViYmxlVGltZXI6IDAsCiAgICAgICAgICAgICAgICAgICAgX2dob3N0OiB0cnVlLAogICAgICAgICAgICAgICAgICAgIC8vIE1vY2sgbWV0aG9kcwogICAgICAgICAgICAgICAgICAgIHJlc2V0OiAoKSA9PiB7fSwgCiAgICAgICAgICAgICAgICAgICAgZHJvcDogKCkgPT4ge30sCiAgICAgICAgICAgICAgICAgICAgcmV2ZWFsOiAoKSA9PiB7fQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSB2aXNpYmlsaXR5CiAgICAgICAgICAgICAgICBnaG9zdE1lc2gudmlzaWJsZSA9ICFiLmlzSW52aXNpYmxlOwoKICAgICAgICAgICAgICAgIHRoaXMuZ2hvc3RCYWxscy5wdXNoKGdob3N0QmFsbCk7CgovLyAyLiBSZXNldCBSZWFsIEJhbGwgdG8gUGxheWVyIElOU1RBTlRMWQogICAgICAgICAgICAgICAgYi52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZJWDogRm9yY2UgYmFsbCBwb3NpdGlvbiB0byBiZSBleHBsaWNpdGx5IGluIGZyb250IG9mIHRoZSBwbGF5ZXIKICAgICAgICAgICAgICAgIC8vIFRoaXMgcHJldmVudHMgYW55IGxvZ2ljIGZyb20gdGhpbmtpbmcgdGhlIGJhbGwgaXMgYmVoaW5kIGFuZCB0cmlnZ2VyaW5nIGEgdHVybgogICAgICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHAubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIGIubWVzaC5wb3NpdGlvbi5jb3B5KHAubWVzaC5wb3NpdGlvbikuYWRkKGZ3ZC5tdWx0aXBseVNjYWxhcigwLjgpKTsKICAgICAgICAgICAgICAgIGIubWVzaC5wb3NpdGlvbi55ICs9IDEuMDsKCiAgICAgICAgICAgICAgICAvLyBNYW51YWwgQXR0YWNoIChCeXBhc3MgJ2NhdGNoJyBhbmltYXRpb24pCiAgICAgICAgICAgICAgICBiLmhvbGRlciA9IHA7CiAgICAgICAgICAgICAgICBiLnN0YXRlID0gJ2hlbGQnOwogICAgICAgICAgICAgICAgcC5oYXNCYWxsID0gdHJ1ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVzZXQgUGxheWVyIFRocm93IFN0YXRlIHNvIHRoZXkgY2FuIGZpcmUgYWdhaW4gaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIHAuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcC5jYXRjaENvb2xkb3duID0gMDsKCiAgICAgICAgICAgICAgICAvLyBTeW5jIHJvdGF0aW9uIHRvIHByZXZlbnQgc25hcHBpbmcKICAgICAgICAgICAgICAgIGlmIChwLnN5bmNSb3RhdGlvbikgcC5zeW5jUm90YXRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5zdXJlIGluZmluaXRlIHN0YXRzCiAgICAgICAgICAgIHAuY3VycmVudEVOID0gcC5zdGF0cy5FTjsKICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7CiAgICAgICAgfQoKICAgICAgICBfc2hvd1BhbmVsKCkgewogICAgICAgICAgICBpZiAodGhpcy51aSkgdGhpcy51aS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICB9CgogICAgICAgIF9oaWRlUGFuZWwoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnVpKSB0aGlzLnVpLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dSZXN0b3JlQnRuKCkgewogICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2UtcmVzdG9yZS1idG4nKTsKICAgICAgICAgICAgaWYgKGJ0bikgYnRuLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgIH0KCiAgICAgICAgX2hpZGVSZXN0b3JlQnRuKCkgewogICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2UtcmVzdG9yZS1idG4nKTsKICAgICAgICAgICAgaWYgKGJ0bikgYnRuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQogICAgfQp3aW5kb3cuZmx1eC5QcmFjdGljZU1hbmFnZXIgPSBQcmFjdGljZU1hbmFnZXI7Cn0pKCk7","./PracticeManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQcmFjdGljZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREcmlsbCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZSA9IHt9OyAKICAgICAgICAgICAgCnRoaXMuZHJpbGxzID0gewogICAgICAgICAgICAgICAgJ2ZyZWUnOiB7IG5hbWU6ICdGUkVFIFJPQU0nLCBzZXR1cDogdGhpcy5fc2V0dXBGcmVlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BGcmVlLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdiYWxsX2xhYic6IHsgbmFtZTogJ0JBTEwgTEFCJywgc2V0dXA6IHRoaXMuX3NldHVwQmFsbExhYi5iaW5kKHRoaXMpLCBsb29wOiB0aGlzLl9sb29wQmFsbExhYi5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAnc2hvb3RpbmcnOiB7IG5hbWU6ICdTSE9PVElORyBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cFNob290aW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BTaG9vdGluZy5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncGFzc2luZyc6IHsgbmFtZTogJ1BBU1NJTkcgRFJJTEwnLCBzZXR1cDogdGhpcy5fc2V0dXBQYXNzaW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BQYXNzaW5nLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdkZWZlbnNlJzogeyBuYW1lOiAnREVGRU5TRSBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cERlZmVuc2UuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcERlZmVuc2UuYmluZCh0aGlzKSB9LAogICAgICAgICAgICAgICAgJ2N1cnZlJzogeyBuYW1lOiAnQ1VSVkUgU0hPVCcsIHNldHVwOiB0aGlzLl9zZXR1cEN1cnZlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BDdXJ2ZS5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncmFwaWRfZmlyZSc6IHsgbmFtZTogJ1JBUElEIEZJUkUnLCBzZXR1cDogdGhpcy5fc2V0dXBSYXBpZEZpcmUuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcFJhcGlkRmlyZS5iaW5kKHRoaXMpIH0KICAgICAgICAgICAgfTsKCnRoaXMudWkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2Utb3ZlcmxheScpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dlc3R1cmUtaGludCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gewogICAgICAgICAgICAgICAgaW5mU3RhdHM6IHRydWUsCiAgICAgICAgICAgICAgICBhaUR1bW15OiB0cnVlLAogICAgICAgICAgICAgICAgc2hvd0hpdGJveGVzOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy50YXJnZXRSaW5nID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107IC8vIEFycmF5IHRvIHRyYWNrIHZpc3VhbCBjb3BpZXMgb2YgdGhyb3duIGJhbGxzCiAgICAgICAgICAgIHRoaXMuX2luaXRWaXN1YWxzKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwRXZlbnRzKCk7CiAgICAgICAgfQoKICAgICAgICBfaW5pdFZpc3VhbHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBhIGdsb3dpbmcgcmluZyBmb3IgdGFyZ2V0cwogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMS41LCAxLjgsIDMyKTsKICAgICAgICAgICAgZ2VvbWV0cnkucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBmZmZmLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gQWRkIHRvIHNjZW5lIHZpYSBnYW1lIG1hbmFnZXIgcmVmZXJlbmNlCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc2NlbmUpIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy50YXJnZXRSaW5nKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0KCkgewp0aGlzLmlzUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAvLyBJZiBtZW51IHJlcXVlc3RlZCBhIHNwZWNpZmljIGRyaWxsIChlLmcuLCBCYWxsIExhYiksIGhvbm9yIGl0IG9uY2UuCiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGw7CiAgICAgICAgICAgIGlmIChyZXEgJiYgdGhpcy5kcmlsbHNbcmVxXSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChyZXEpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXgucmVxdWVzdGVkUHJhY3RpY2VEcmlsbCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldERyaWxsKCdmcmVlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBIVUQgaXMgdmlzaWJsZQogICAgICAgICAgICBjb25zdCBodWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKTsKICAgICAgICAgICAgaWYoaHVkKSBodWQuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICB9CgogICAgICAgIHN0b3AoKSB7CgogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlUGFuZWwoKTsKICAgICAgICAgICAgdGhpcy5faGlkZVJlc3RvcmVCdG4oKTsKdGhpcy5fY2xlYXJEcmlsbCgpOwogICAgICAgICAgICAKLy8gQ2xlYXIgR2hvc3QgQmFsbHMKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYi5tZXNoKSB0aGlzLmdhbWUuc2NlbmUucmVtb3ZlKGIubWVzaCk7CiAgICAgICAgICAgICAgICBpZiAoYi50cmFpbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50cmFpbC5tZXNoLmdlb21ldHJ5KSBiLnRyYWlsLm1lc2guZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gZmFsc2U7CgogICAgICAgICAgICAvLyBSZXN0b3JlIEF3YXkgVGVhbSBWaXNpYmlsaXR5IGZvciBOb3JtYWwgTWF0Y2gKLy8gUmVzdG9yZSBBd2F5IFRlYW0gVmlzaWJpbGl0eSBmb3IgTm9ybWFsIE1hdGNoCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgICAgIGlmKHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi55ID0gMDsgLy8gRW5zdXJlIHRoZXkgYXJlbid0IHN0dWNrIHVuZGVyIGZsb29yCiAgICAgICAgICAgICAgICAgICAgICAgIHAuY2FuQ2F0Y2ggPSB0cnVlOyAvLyBSZXN0b3JlIGNhdGNoaW5nCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERpc2FibGUgZGVidWcgdmlzdWFscyBpZiB0aGV5IHdlcmUgb24KICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIuZW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5zaG93SGl0Ym94ZXMgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2V0RHJpbGwoa2V5KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5kcmlsbHNba2V5XSkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLl9jbGVhckRyaWxsKCk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudERyaWxsID0ga2V5OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFVJCiAgICAgICAgICAgIGlmICh0aGlzLnVpKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3JBbGwoJy5kcmlsbC1idG4nKS5mb3JFYWNoKGJ0biA9PiB7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC50b2dnbGUoJ2FjdGl2ZScsIGJ0bi5kYXRhc2V0LmRyaWxsID09PSBrZXkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJ1biBTZXR1cAogICAgICAgICAgICB0aGlzLmRyaWxsc1trZXldLnNldHVwKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBbm5vdW5jZW1lbnQKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zaG93QW5ub3VuY2VtZW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2hvd0Fubm91bmNlbWVudCh0aGlzLmRyaWxsc1trZXldLm5hbWUsICdub3JtYWwnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc1J1bm5pbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENvbW1vbiBQcmFjdGljZSBMb2dpYyAoSW5maW5pdGUgU3RhdHMpCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuaW5mU3RhdHMpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5SW5maW5pdGVTdGF0cygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEcmlsbCBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RHJpbGwgJiYgdGhpcy5kcmlsbHNbdGhpcy5jdXJyZW50RHJpbGxdLmxvb3ApIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxzW3RoaXMuY3VycmVudERyaWxsXS5sb29wKGR0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFscyBBbmltYXRpb24KLy8gVmlzdWFscyBBbmltYXRpb24KICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZyAmJiB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnJvdGF0aW9uLnogKz0gZHQ7IC8vIFNwaW4KICAgICAgICAgICAgICAgIGNvbnN0IHMgPSAxLjAgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDUpICogMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnNjYWxlLnNldChzLCBzLCBzKTsKICAgICAgICAgICAgfQoKLy8gVXBkYXRlIEdob3N0IEJhbGxzCiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmdob3N0QmFsbHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmdob3N0QmFsbHNbaV07CiAgICAgICAgICAgICAgICBiLmxpZmUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIC0tLSBQSFlTSUNTICYgVklTVUFMUyBERUxFR0FUSU9OIC0tLQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LkJhbGwgJiYgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlRnJlZSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGwucHJvdG90eXBlLnVwZGF0ZUZyZWUuY2FsbChiLCBkdCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlVmlzdWFscy5jYWxsKGIsIGR0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgVHJhaWwKICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhaWxQb3MgPSBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi5kZWZvcm1Ob2RlKSB0cmFpbFBvcy55ICs9IGIuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgIGIudHJhaWwudXBkYXRlKHRyYWlsUG9zKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gR09BTCBERVRFQ1RJT04gRk9SIEdIT1NUIEJBTExTIC0tLQogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gYi5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgLy8gQ2hlY2sgWiBkZXB0aCAoR29hbCBpcyBhdCArLy0gMjgsIHRyaWdnZXIgYXQgMjkpCmlmIChNYXRoLmFicyhwb3MueikgPiA0MC4wKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gR29hbCBCb3ggRGltZW5zaW9ucyAoTWF0Y2hlcyBHYW1lTWFuYWdlcikKICAgICAgICAgICAgICAgICAgICBjb25zdCBoYWxmV2lkdGggPSAxMS4wOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhbGZIZWlnaHQgPSA5LjA7CmNvbnN0IGdvYWxZT2Zmc2V0ID0gLTYuMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLngpIDw9IGhhbGZXaWR0aCAmJiBNYXRoLmFicyhwb3MueSAtIGdvYWxZT2Zmc2V0KSA8PSBoYWxmSGVpZ2h0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdPQUwhCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biBHb2FsIEZYCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBwb3MsIHsgc2NhbGU6IDguMCwgbGlmZTogMC41IH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBwb3MsIHsgc2NhbGU6IDUuMCB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlYnJpcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBrPTA7IGs8MTA7IGsrKykgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGVicmlzJywgcG9zLCB7IHNjYWxlOiAwLjUgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkdPQUwiLCBwb3MsICJnb2FsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gS2lsbCBiYWxsIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICAgICAgICAgIGIubGlmZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENsZWFudXAKICAgICAgICAgICAgICAgIGlmIChiLmxpZmUgPD0gMCB8fCBiLm1lc2gucG9zaXRpb24ueSA8IC0xMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi5tZXNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50cmFpbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUucmVtb3ZlKGIudHJhaWwubWVzaCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsLm1lc2guZ2VvbWV0cnkpIGIudHJhaWwubWVzaC5nZW9tZXRyeS5kaXNwb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2hvc3RCYWxscy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zZXR1cEV2ZW50cygpIHsKCiAgICAgICAgICAgIC8vIE1pbmltaXplIC8gUmVzdG9yZQogICAgICAgICAgICBjb25zdCBtaW5CdG4gPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoJyNwLW1pbmltaXplJyk7CiAgICAgICAgICAgIGlmIChtaW5CdG4pIHsKICAgICAgICAgICAgICAgIG1pbkJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUGFuZWwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93UmVzdG9yZUJ0bigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHJlc3RvcmVCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2UtcmVzdG9yZS1idG4nKTsKICAgICAgICAgICAgaWYgKHJlc3RvcmVCdG4pIHsKICAgICAgICAgICAgICAgIHJlc3RvcmVCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd1BhbmVsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZVJlc3RvcmVCdG4oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEcmlsbCBCdXR0b25zCiAgICAgICAgICAgIHRoaXMudWkucXVlcnlTZWxlY3RvckFsbCgnLmRyaWxsLWJ0bicpLmZvckVhY2goYnRuID0+IHsKICAgICAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldERyaWxsKGJ0bi5kYXRhc2V0LmRyaWxsKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFJlc2V0IEJhbGwKICAgICAgICAgICAgY29uc3QgcmVzZXRCdG4gPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoJyNwLXJlc2V0LWJhbGwnKTsKICAgICAgICAgICAgaWYgKHJlc2V0QnRuKSB7CiAgICAgICAgICAgICAgICByZXNldEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEV4aXQKICAgICAgICAgICAgY29uc3QgZXhpdEJ0biA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI3AtZXhpdCcpOwogICAgICAgICAgICBpZiAoZXhpdEJ0bikgewogICAgICAgICAgICAgICAgZXhpdEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPSAnbWVudSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPcHRpb25zIFRvZ2dsZXMKICAgICAgICAgICAgdGhpcy5fYmluZFRvZ2dsZSgnb3B0LWluZi1zdGF0JywgJ2luZlN0YXRzJyk7CiAgICAgICAgICAgIHRoaXMuX2JpbmRUb2dnbGUoJ29wdC1haS1kdW1teScsICdhaUR1bW15JywgKHZhbCkgPT4gewogICAgICAgICAgICAgICAgLy8gVXBkYXRlIEFJIER1bW15IHN0YXRlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLnRlYW1zLmF3YXkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5haUVuYWJsZWQgPSAhdmFsOyAvLyBJZiBkdW1teSBpcyBUUlVFLCBBSSBpcyBGQUxTRQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5fYmluZFRvZ2dsZSgnb3B0LWhpdGJveGVzJywgJ3Nob3dIaXRib3hlcycsICh2YWwpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5lbmFibGVkID0gdmFsOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIuc2hvd0hpdGJveGVzID0gdmFsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEtleWJvYXJkIFNob3J0Y3V0IGZvciBSZXNldCAoUikKLy8gS2V5Ym9hcmQgU2hvcnRjdXQgZm9yIFJlc2V0IChSKQogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc1J1bm5pbmcgJiYgZS5rZXkudG9Mb3dlckNhc2UoKSA9PT0gJ3InICYmICFlLnJlcGVhdCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCl9iaW5kVG9nZ2xlKGlkLCBvcHRpb25LZXksIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKGAjJHtpZH1gKTsKICAgICAgICAgICAgaWYgKCFlbCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIHVwZGF0ZSB2aXN1YWxzCiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZVZpc3VhbCA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGlzQWN0aXZlID0gdGhpcy5vcHRpb25zW29wdGlvbktleV07CiAgICAgICAgICAgICAgICBlbC5jbGFzc0xpc3QudG9nZ2xlKCdhY3RpdmUnLCBpc0FjdGl2ZSk7CiAgICAgICAgICAgICAgICBjb25zdCBib3ggPSBlbC5xdWVyeVNlbGVjdG9yKCcuY2hlY2tib3gnKTsKICAgICAgICAgICAgICAgIGlmIChib3gpIGJveC5pbm5lclRleHQgPSBpc0FjdGl2ZSA/ICfilqMnIDogJ+KWoSc7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIHZpc3VhbCBzdGF0ZSBpbW1lZGlhdGVseQogICAgICAgICAgICB1cGRhdGVWaXN1YWwoKTsKCiAgICAgICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnNbb3B0aW9uS2V5XSA9ICF0aGlzLm9wdGlvbnNbb3B0aW9uS2V5XTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdXBkYXRlVmlzdWFsKCk7CgogICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayh0aGlzLm9wdGlvbnNbb3B0aW9uS2V5XSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCgogICAgICAgIF9zZXR1cEJhbGxMYWIoKSB7CiAgICAgICAgICAgIHRoaXMuX3NldEluc3RydWN0aW9uKCJCQUxMIExBQjogT3BlbiBEZXZUb29scyDihpIgQmFsbCBMYWIuIFVzZSBTaG90IENhbm5vbiArIHRyYWplY3RvcnkgcHJldmlldyArIHJlY29yZC9yZXBsYXkuIik7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9IDA7CgogICAgICAgICAgICBjb25zdCBob21lID0gdGhpcy5nYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGNvbnN0IGF3YXkgPSB0aGlzLmdhbWUudGVhbXMuYXdheTsKICAgICAgICAgICAgY29uc3QgcCA9IGhvbWUgPyBob21lLmFjdGl2ZVBsYXllciA6IG51bGw7CiAgICAgICAgICAgIGlmICghcCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gU29sbyBtb2RlOiBoaWRlIGV2ZXJ5b25lIGV4Y2VwdCB0aGUgYWN0aXZlIHBsYXllcgogICAgICAgICAgICBpZiAoaG9tZSAmJiBob21lLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGhvbWUucGxheWVycy5mb3JFYWNoKG1hdGUgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChtYXRlLm1lc2gpIG1hdGUubWVzaC52aXNpYmxlID0gKG1hdGUgPT09IHApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGF3YXkgJiYgYXdheS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBhd2F5LnBsYXllcnMuZm9yRWFjaChvcHAgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChvcHAubWVzaCkgb3BwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFBsYWNlIGFjdGl2ZSBwbGF5ZXIgYXQgY2VudGVyIGZhY2luZyB0aGUgYXdheSBnb2FsCiAgICAgICAgICAgIGlmIChwLm1lc2gpIHsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7CmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgICAgICBwLm1lc2gubG9va0F0KDAsIDAsIC1nb2FsRGlzdCk7CiAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGlmIChwLnN5bmNSb3RhdGlvbikgcC5zeW5jUm90YXRpb24oKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmlnIHN0YXRzIHNvIHlvdSBjYW4gdGVzdCBleHRyZW1lcwogICAgICAgICAgICBpZiAocC5zdGF0cykgewogICAgICAgICAgICAgICAgcC5zdGF0cy5TSCA9IDk5OwogICAgICAgICAgICAgICAgcC5zdGF0cy5QQSA9IDk5OwogICAgICAgICAgICAgICAgcC5zdGF0cy5FTiA9IDk5OwogICAgICAgICAgICAgICAgcC5zdGF0cy5tYXhIUCA9IE1hdGgubWF4KHAuc3RhdHMubWF4SFAgfHwgOTk5LCA5OTkpOwogICAgICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEEgY2xlYXIgdGFyZ2V0IG1hcmtlciAocHVyZWx5IHZpc3VhbCkKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnNldCgwLCAwLjEsIC0xOCk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmYwMGZmKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgogICAgICAgIF9sb29wQmFsbExhYihkdCkgewogICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIGlmICghYiB8fCAhcCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQXV0by1yZXNldCBiYWxsIGJhY2sgdG8gcGxheWVyIG9uY2UgaXQgY29tZXMgdG8gcmVzdCwKICAgICAgICAgICAgLy8gc28geW91IGNhbiBzcGFtIHZhcmlhdGlvbnMgd2l0aG91dCB0b3VjaGluZyBhbnl0aGluZy4KICAgICAgICAgICAgaWYgKGIuc3RhdGUgPT09ICdmcmVlJykgewogICAgICAgICAgICAgICAgY29uc3Qgc3RvcHBlZCA9IChiLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAwLjAxKSAmJiAoYi5wb3dlciA8PSAwLjAxKTsKICAgICAgICAgICAgICAgIGlmIChzdG9wcGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9ICh0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyIHx8IDApICsgZHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPiAwLjQ1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2xpZ2h0IHRhcmdldCBib2IgKGhlbHBzIGRlcHRoIHBlcmNlcHRpb24pCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcgJiYgdGhpcy50YXJnZXRSaW5nLnZpc2libGUpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi55ID0gMC4xICsgTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDAzKSAqIDAuMDU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9hcHBseUluZmluaXRlU3RhdHMoKSB7CiAgICAgICAgICAgIGNvbnN0IGhvbWUgPSB0aGlzLmdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgaWYgKGhvbWUpIHsKICAgICAgICAgICAgICAgIGhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOwogICAgICAgICAgICAgICAgICAgIHAuY3VycmVudEVOID0gcC5zdGF0cy5FTjsKICAgICAgICAgICAgICAgICAgICBwLnN0YXR1cy52ZW5vbSA9IDA7CiAgICAgICAgICAgICAgICAgICAgcC5zdGF0dXMubmFwID0gMDsKICAgICAgICAgICAgICAgICAgICBwLnN0dW5UaW1lciA9IDA7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NsZWFyRHJpbGwoKSB7CgogICAgICAgICAgICAvLyBSZXNldCBwb3NpdGlvbnMsIGNsZWFyIGR1bW1pZXMsIHJlc2V0IHNjb3JlCiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUgPSB7IHNjb3JlOiAwLCB0aW1lcjogMCwgc3RhZ2U6IDAsIHJlc2V0dGluZzogZmFsc2UgfTsKICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSgwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENsZWFyIEdseXBocwogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmdseXBoTWFuYWdlcikgdGhpcy5nYW1lLmdseXBoTWFuYWdlci5jbGVhcigpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFJlc2V0IHRlYW1zIHRvIGRlZmF1bHQgcG9zaXRpb25zCgogICAgICAgICAgICAvLyBSZXNldCB0ZWFtcyB0byBkZWZhdWx0IHBvc2l0aW9ucwogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5yZXNldFBvc2l0aW9ucygpOwogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5yZXNldFBvc2l0aW9ucygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgQUkgRHVtbXkgc2V0dGluZwogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnRlYW1zLmF3YXkpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LmFpRW5hYmxlZCA9ICF0aGlzLm9wdGlvbnMuYWlEdW1teTsKICAgICAgICAgICAgfQovLyBIaWRlIGF3YXkgdGVhbSBieSBkZWZhdWx0IGluIGRyaWxscyB1bmxlc3Mgc3BlY2lmaWVkCiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgLTEwMDAsIDApOyAvLyBNb3ZlIFdBWSBhd2F5IHRvIHByZXZlbnQgaW50ZXJhY3Rpb24KICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIHAuY2FuQ2F0Y2ggPSBmYWxzZTsgLy8gRGlzYWJsZSBjYXRjaGluZwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBIb21lIHRlYW0gaXMgdmlzaWJsZQogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfcmVzZXRCYWxsVG9QbGF5ZXIoKSB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKHAgJiYgYikgewogICAgICAgICAgICAgICAgYi5yZXNldCgpOwogICAgICAgICAgICAgICAgYi5ncmFiKHApOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlJFU0VUIiwgcC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyKSB0aGlzLmdhbWUuY2FtZXJhTWFuYWdlci5zbmFwVG9UYXJnZXQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVNjb3JlVUkodmFsKSB7CiAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjZHJpbGwtc2NvcmUnKTsKICAgICAgICAgICAgaWYgKGVsKSBlbC5pbm5lclRleHQgPSBgU0NPUkU6ICR7dmFsfWA7CiAgICAgICAgfQoKICAgICAgICBfc2V0SW5zdHJ1Y3Rpb24odGV4dCkgewogICAgICAgICAgICAgY29uc3QgZWwgPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoJyNkcmlsbC1pbnN0cnVjdGlvbicpOwogICAgICAgICAgICAgaWYgKGVsKSBlbC5pbm5lclRleHQgPSB0ZXh0OwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIERSSUxMUyAtLS0KCl9zZXR1cEZyZWUoKSB7CiAgICAgICAgICAgIHRoaXMuX3NldEluc3RydWN0aW9uKCJGcmVlIHByYWN0aWNlLiBJbmZpbml0ZSBIUC9FTi4iKTsKICAgICAgICAgICAgLy8gU2hvdyBldmVyeW9uZQogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5jb3B5KHAuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHAuY2FuQ2F0Y2ggPSB0cnVlOyAvLyBSZXN0b3JlIGNhcGFiaWxpdHkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQogICAgICAgIF9sb29wRnJlZShkdCkge30KCiAgICAgICAgX3NldHVwU2hvb3RpbmcoKSB7CgogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiU2NvcmUgb24gdGhlIEdvYWxpZSEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOyAvLyBDbGVhciByZXNldCBmbGFnCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXR1cDogQWN0aXZlIFBsYXllciBhdCAxOG0sIEdvYWxpZSBpbiBuZXQuCiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIGNvbnN0IGcgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHAgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC0xMCk7IC8vIDE4bSBvdXQgKEhvbWUgYXR0YWNrcyAtWikKY29uc3QgZ29hbERpc3QgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UgfHwgNDEuNTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLWdvYWxEaXN0KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZyAmJiBnLm1lc2gpIHsKICAgICAgICAgICAgICAgIGcubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGcubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTI3KTsKICAgICAgICAgICAgICAgIGcubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBnLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9sb29wU2hvb3RpbmcoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGdvYWwgc2NvcmVkIChHYW1lTWFuYWdlciBoYW5kbGVzIHRoZSBhY3R1YWwgZ29hbCBldmVudCwgYnV0IHdlIHRyYWNrIHJlc2V0KQogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YXRlID09PSAnZ29hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRoaXMuZHJpbGxTdGF0ZS5zY29yZSk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhdGUgPSAnYWN0aXZlJzsgLy8gSGlqYWNrIHN0YXRlIGJhY2sKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBTaG9vdGluZygpLCAxMDAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgZ29hbGllIGNhdGNoZXMKICAgICAgICAgICAgY29uc3QgZyA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ0dMJyk7CiAgICAgICAgICAgIGlmIChnICYmIGcuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTQVZFRCIsIGcubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBTaG9vdGluZygpLCAxMDAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3NldHVwUGFzc2luZygpIHsKCiAgICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiUGFzcyB0byB0aGUgbW92aW5nIHRhcmdldCEiKTsKICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgICAvLyBTZXR1cDogQWN0aXZlIFBsYXllciBjZW50ZXIuIDEgVGVhbW1hdGUgcnVubmluZyBwYXR0ZXJucy4KICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQoeCA9PiB4ICE9PSBwICYmIHgucm9sZSAhPT0gJ0dMJyk7CiAgICAgICAgICAgICAKICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS50YXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICAgICAKICAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAxMCk7CiAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgfQogICAgICAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOwogICAgICAgICAgICAgICAgIHRhcmdldC5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgIHRhcmdldC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgfQogICAgICAgICAgICAgCiAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KCiAgICAgICAgX2xvb3BQYXNzaW5nKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmRyaWxsU3RhdGUudGFyZ2V0OwogICAgICAgICAgICBpZiAoIXRhcmdldCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTW92ZSB0YXJnZXQgaW4gY2lyY2xlCiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS50aW1lciArPSBkdDsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gucG9zaXRpb24ueCA9IE1hdGguc2luKHRoaXMuZHJpbGxTdGF0ZS50aW1lcikgKiAxMDsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gucG9zaXRpb24ueiA9IC0xMCArIE1hdGguY29zKHRoaXMuZHJpbGxTdGF0ZS50aW1lciAqIDAuNSkgKiA1OwogICAgICAgICAgICB0YXJnZXQubWVzaC5sb29rQXQoMCwwLDEwKTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBSaW5nCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi5jb3B5KHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi55ID0gMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweDAwZmZmZik7IC8vIEN5YW4KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRhcmdldC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5zY29yZSsrOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIk5JQ0UgUEFTUyEiLCB0YXJnZXQubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVzZXQKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRhcmdldC5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NldHVwUGFzc2luZygpOyAvLyBSZS1zZXR1cCB0byByZXNldCBwb3NpdGlvbnMKICAgICAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgX3NldHVwRGVmZW5zZSgpIHsKCiAgICAgICAgICAgIHRoaXMuX3NldEluc3RydWN0aW9uKCJUYWNrbGUgdGhlIGF0dGFja2VyISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBhdHRhY2tlciA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuYXR0YWNrZXIgPSBhdHRhY2tlcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDIwKTsgLy8gTmVhciBvd24gZ29hbAogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhdHRhY2tlcikgewogICAgICAgICAgICAgICAgYXR0YWNrZXIubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGF0dGFja2VyLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC0xMCk7CiAgICAgICAgICAgICAgICBhdHRhY2tlci52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgLy8gR2l2ZSBiYWxsIHRvIGF0dGFja2VyCiAgICAgICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICBiLnJlc2V0KCk7CiAgICAgICAgICAgICAgICBiLmdyYWIoYXR0YWNrZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9sb29wRGVmZW5zZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgYXR0YWNrZXIgPSB0aGlzLmRyaWxsU3RhdGUuYXR0YWNrZXI7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWF0dGFja2VyIHx8ICFwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBdHRhY2tlciBydW5zIHRvIGdvYWwgKCtaKQovLyBBdHRhY2tlciBydW5zIHRvIGdvYWwgKCtaKQogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbERpc3QpOwogICAgICAgICAgICBjb25zdCBkaXIgPSBnb2FsUG9zLmNsb25lKCkuc3ViKGF0dGFja2VyLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFJpbmcgb24gQXR0YWNrZXIKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLmNvcHkoYXR0YWNrZXIubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZjAwMDApOyAvLyBSZWQgZm9yIGVuZW15CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhdHRhY2tlci5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBhdHRhY2tlci5zZXRJbnB1dChkaXIueCwgZGlyLnopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQmFsbCBsb3N0IChUYWNrbGVkKQogICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCB8fCB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTVE9QUEVEISIsIHAubWVzaC5wb3NpdGlvbiwgImJsb2NrIik7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cERlZmVuc2UoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZhaWwgY29uZGl0aW9uOiBBdHRhY2tlciBzY29yZXMgKEdhbWVNYW5hZ2VyIGhhbmRsZXMgZ29hbCBjaGVjaykKICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc3RhdGUgPT09ICdnb2FsJykgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhdGUgPSAnYWN0aXZlJzsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJGQUlMRUQiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBEZWZlbnNlKCksIDEwMDApOwogICAgICAgICAgICB9Cn0KCiAgICAgICAgX3NldHVwQ3VydmUoKSB7CnRoaXMuX3NldEluc3RydWN0aW9uKCJTd2lwZSBhIENVUlZFICggKSApIHRvIGJ5cGFzcyB0aGUgZGVmZW5kZXIhIik7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFNob3cgZ2VzdHVyZSBoaW50CiAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDbGVhciBhbnkgZXhpc3RpbmcgdGltZW91dAogICAgICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCkgY2xlYXJUaW1lb3V0KHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEF1dG8gaGlkZSBhZnRlciA0cwogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAvLyBVc2UgYSBkZWZlbmRlciBkdW1teQogICAgICAgICAgICBjb25zdCBkZWZlbmRlciA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ0xEJyk7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5kZWZlbmRlciA9IGRlZmVuZGVyOwoKICAgICAgICAgICAgaWYgKHApIHsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMTUpOwpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGVmZW5kZXIpIHsKICAgICAgICAgICAgICAgIGRlZmVuZGVyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBkZWZlbmRlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCA1KTsgLy8gMTBtIGluIGZyb250IG9mIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIubWVzaC5sb29rQXQoMCwgMCwgMTUpOyAvLyBGYWNlIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEJvb3N0IEJMIHRvIGVuc3VyZSBzdHJhaWdodCBzaG90cyBhcmUgYmxvY2tlZAogICAgICAgICAgICAgICAgZGVmZW5kZXIuc3RhdHMuQkwgPSA5OTsgCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhleSBkb24ndCBtb3ZlCiAgICAgICAgICAgICAgICBkZWZlbmRlci5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUYXJnZXQgUmluZyBiZWhpbmQgZGVmZW5kZXIKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnNldCgwLCAwLjEsIC0xMCk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4MDBmZmZmKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgpfbG9vcEN1cnZlKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IGRlZmVuZGVyID0gdGhpcy5kcmlsbFN0YXRlLmRlZmVuZGVyOwoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgYmFsbCBwYXNzZWQgdGhlIGRlZmVuZGVyIGxpbmUgKHogPCAwKQogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAwKSB7CiAgICAgICAgICAgICAgICAvLyBTdWNjZXNzIHpvbmUgKFdpdGhpbiA1bSB3aWR0aCkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhiYWxsLm1lc2gucG9zaXRpb24ueCkgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRUQhIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBDdXJ2ZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGJsb2NrZWQgKEJhbGwgc3RvcHBlZCBvciBwb3dlciBkcmFpbmVkIHNpZ25pZmljYW50bHkgbmVhciBkZWZlbmRlcikKICAgICAgICAgICAgaWYgKGRlZmVuZGVyICYmIGJhbGwubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGRlZmVuZGVyLm1lc2gucG9zaXRpb24pIDwgMy4wKSB7CiAgICAgICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA8PSAwIHx8IGJhbGwudmVsb2NpdHkubGVuZ3RoKCkgPCAxLjApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0tFRCIsIGRlZmVuZGVyLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZS1zaG93IGhpbnQgb24gZmFpbHVyZSB0byBndWlkZSBwbGF5ZXIKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTWlzc2VkIC8gT3V0IG9mIGJvdW5kcwogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAtMTUpIHsKICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiTUlTU0VEIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgLy8gUmUtc2hvdyBoaW50IG9uIG1pc3MKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX3NldHVwUmFwaWRGaXJlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVU5MSU1JVEVEIEFNTU8hIFNwYW0gdGhyb3dzISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBGaW5kIFRpZHVzIG9yIGRlZmF1bHQgdG8gTEYKICAgICAgICAgICAgbGV0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQoeCA9PiB4LmNoYXJhY3Rlck5hbWUgJiYgeC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKTsKICAgICAgICAgICAgaWYgKCFwKSBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnTEYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldCBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5zZXRBY3RpdmVQbGF5ZXIocCk7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBCb29zdCBzdGF0cyBmb3IgZnVuCiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlBBID0gOTk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEhJREUgRVZFUllPTkUgKEFsb25lIE1vZGUpCiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChtYXRlID0+IHsKICAgICAgICAgICAgICAgIGlmIChtYXRlICE9PSBwICYmIG1hdGUubWVzaCkgbWF0ZS5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChvcHAgPT4gewogICAgICAgICAgICAgICAgaWYgKG9wcC5tZXNoKSBvcHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgpfbG9vcFJhcGlkRmlyZShkdCkgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CgogICAgICAgICAgICBpZiAoIXAgfHwgIWIpIHJldHVybjsKCiAgICAgICAgICAgIC8vIERldGVjdCBpZiBiYWxsIHdhcyBqdXN0IHRocm93biAoaXMgZnJlZSkKICAgICAgICAgICAgaWYgKGIuc3RhdGUgPT09ICdmcmVlJykgewogICAgICAgICAgICAgICAgLy8gMS4gU3Bhd24gR2hvc3QgQmFsbCAoVmlzdWFsIENvcHkpCiAgICAgICAgICAgICAgICAvLyBDbG9uZSB0aGUgbWVzaCBoaWVyYXJjaHkgdG8gcHJlc2VydmUgRGVmb3JtL1NwaW4gbm9kZXMKICAgICAgICAgICAgICAgIGNvbnN0IGdob3N0TWVzaCA9IGIubWVzaC5jbG9uZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdmlzaWJpbGl0eSBhbmQgYWRkIHRvIHNjZW5lCiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKGdob3N0TWVzaCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlLWJpbmQgaW50ZXJuYWwgcmVmZXJlbmNlcyBmb3IgdGhlIHBoeXNpY3MgZW5naW5lCiAgICAgICAgICAgICAgICAvLyBIaWVyYXJjaHk6IE1lc2ggLT4gRGVmb3JtTm9kZSAtPiBTcGluTm9kZQogICAgICAgICAgICAgICAgY29uc3QgZGVmb3JtTm9kZSA9IGdob3N0TWVzaC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5Ob2RlID0gZGVmb3JtTm9kZSA/IGRlZm9ybU5vZGUuY2hpbGRyZW5bMF0gOiBudWxsOwoKICAgICAgICAgICAgICAgIC8vIERldGVybWluZSBUcmFpbCBDb2xvciBiYXNlZCBvbiBUZWNoCiAgICAgICAgICAgICAgICBsZXQgdHJhaWxDb2xvciA9IDB4ZmY0NDAwOyAvLyBEZWZhdWx0IFNIIChPcmFuZ2UpCiAgICAgICAgICAgICAgICBpZiAoYi50ZWNobmlxdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ3Zlbm9tJykgdHJhaWxDb2xvciA9IDB4YWEwMGZmOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICd3aXRoZXInKSB0cmFpbENvbG9yID0gMHg4ODg4ODg7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ25hcCcpIHRyYWlsQ29sb3IgPSAweDAwMDA4ODsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnc3BoZXJlJykgdHJhaWxDb2xvciA9IDB4MDBmZmZmOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICdqZWNodCcpIHRyYWlsQ29sb3IgPSAweGZmMDAwMDsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnaW52aXNpYmxlJykgdHJhaWxDb2xvciA9IDB4NDQ0NDQ0OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChiLnBvd2VyVHlwZSA9PT0gJ1BBJykgewogICAgICAgICAgICAgICAgICAgIHRyYWlsQ29sb3IgPSAweDAwYWFmZjsgLy8gUGFzcyAoQmx1ZSkKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDcmVhdGUgVHJhaWwKICAgICAgICAgICAgICAgIGNvbnN0IHRyYWlsID0gbmV3IHdpbmRvdy5mbHV4LlRyYWlsUmVuZGVyZXIodGhpcy5nYW1lLnNjZW5lKTsKICAgICAgICAgICAgICAgIHRyYWlsLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0cmFpbC5zZXRDb2xvcih0cmFpbENvbG9yKTsKICAgICAgICAgICAgICAgIHRyYWlsLnJlc2V0KGdob3N0TWVzaC5wb3NpdGlvbik7CgogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIGEgIk1vY2siIEJhbGwgb2JqZWN0IHRoYXQgc2F0aXNmaWVzIEJhbGwuanMgcGh5c2ljcyByZXF1aXJlbWVudHMKICAgICAgICAgICAgICAgIGNvbnN0IGdob3N0QmFsbCA9IHsKICAgICAgICAgICAgICAgICAgICBtZXNoOiBnaG9zdE1lc2gsCiAgICAgICAgICAgICAgICAgICAgZGVmb3JtTm9kZTogZGVmb3JtTm9kZSwKICAgICAgICAgICAgICAgICAgICBzcGluTm9kZTogc3Bpbk5vZGUsCiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IGIudmVsb2NpdHkuY2xvbmUoKSwKICAgICAgICAgICAgICAgICAgICBhbmd1bGFyVmVsb2NpdHk6IGIuYW5ndWxhclZlbG9jaXR5ID8gYi5hbmd1bGFyVmVsb2NpdHkuY2xvbmUoKSA6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgYWNjdW11bGF0ZWRSb3RhdGlvbjogYi5hY2N1bXVsYXRlZFJvdGF0aW9uID8gYi5hY2N1bXVsYXRlZFJvdGF0aW9uLmNsb25lKCkgOiBuZXcgVEhSRUUuUXVhdGVybmlvbigpLAogICAgICAgICAgICAgICAgICAgIHN0YXRlOiAnZnJlZScsCiAgICAgICAgICAgICAgICAgICAgcG93ZXI6IGIucG93ZXIsCiAgICAgICAgICAgICAgICAgICAgcG93ZXJUeXBlOiBiLnBvd2VyVHlwZSwKICAgICAgICAgICAgICAgICAgICB0ZWNobmlxdWU6IGIudGVjaG5pcXVlLAogICAgICAgICAgICAgICAgICAgIGlzSW52aXNpYmxlOiBiLmlzSW52aXNpYmxlLAogICAgICAgICAgICAgICAgICAgIGxpZmU6IDUuMCwgLy8gRW5vdWdoIHRpbWUgdG8gcmVhY2ggZ29hbAogICAgICAgICAgICAgICAgICAgIHRyYWlsOiB0cmFpbCwKICAgICAgICAgICAgICAgICAgICBfYnViYmxlVGltZXI6IDAsCiAgICAgICAgICAgICAgICAgICAgX2dob3N0OiB0cnVlLAogICAgICAgICAgICAgICAgICAgIC8vIE1vY2sgbWV0aG9kcwogICAgICAgICAgICAgICAgICAgIHJlc2V0OiAoKSA9PiB7fSwgCiAgICAgICAgICAgICAgICAgICAgZHJvcDogKCkgPT4ge30sCiAgICAgICAgICAgICAgICAgICAgcmV2ZWFsOiAoKSA9PiB7fQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSB2aXNpYmlsaXR5CiAgICAgICAgICAgICAgICBnaG9zdE1lc2gudmlzaWJsZSA9ICFiLmlzSW52aXNpYmxlOwoKICAgICAgICAgICAgICAgIHRoaXMuZ2hvc3RCYWxscy5wdXNoKGdob3N0QmFsbCk7CgovLyAyLiBSZXNldCBSZWFsIEJhbGwgdG8gUGxheWVyIElOU1RBTlRMWQogICAgICAgICAgICAgICAgYi52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZJWDogRm9yY2UgYmFsbCBwb3NpdGlvbiB0byBiZSBleHBsaWNpdGx5IGluIGZyb250IG9mIHRoZSBwbGF5ZXIKICAgICAgICAgICAgICAgIC8vIFRoaXMgcHJldmVudHMgYW55IGxvZ2ljIGZyb20gdGhpbmtpbmcgdGhlIGJhbGwgaXMgYmVoaW5kIGFuZCB0cmlnZ2VyaW5nIGEgdHVybgogICAgICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHAubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIGIubWVzaC5wb3NpdGlvbi5jb3B5KHAubWVzaC5wb3NpdGlvbikuYWRkKGZ3ZC5tdWx0aXBseVNjYWxhcigwLjgpKTsKICAgICAgICAgICAgICAgIGIubWVzaC5wb3NpdGlvbi55ICs9IDEuMDsKCiAgICAgICAgICAgICAgICAvLyBNYW51YWwgQXR0YWNoIChCeXBhc3MgJ2NhdGNoJyBhbmltYXRpb24pCiAgICAgICAgICAgICAgICBiLmhvbGRlciA9IHA7CiAgICAgICAgICAgICAgICBiLnN0YXRlID0gJ2hlbGQnOwogICAgICAgICAgICAgICAgcC5oYXNCYWxsID0gdHJ1ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVzZXQgUGxheWVyIFRocm93IFN0YXRlIHNvIHRoZXkgY2FuIGZpcmUgYWdhaW4gaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIHAuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcC5jYXRjaENvb2xkb3duID0gMDsKCiAgICAgICAgICAgICAgICAvLyBTeW5jIHJvdGF0aW9uIHRvIHByZXZlbnQgc25hcHBpbmcKICAgICAgICAgICAgICAgIGlmIChwLnN5bmNSb3RhdGlvbikgcC5zeW5jUm90YXRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5zdXJlIGluZmluaXRlIHN0YXRzCiAgICAgICAgICAgIHAuY3VycmVudEVOID0gcC5zdGF0cy5FTjsKICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7CiAgICAgICAgfQoKICAgICAgICBfc2hvd1BhbmVsKCkgewogICAgICAgICAgICBpZiAodGhpcy51aSkgdGhpcy51aS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICB9CgogICAgICAgIF9oaWRlUGFuZWwoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnVpKSB0aGlzLnVpLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dSZXN0b3JlQnRuKCkgewogICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2UtcmVzdG9yZS1idG4nKTsKICAgICAgICAgICAgaWYgKGJ0bikgYnRuLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgIH0KCiAgICAgICAgX2hpZGVSZXN0b3JlQnRuKCkgewogICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2UtcmVzdG9yZS1idG4nKTsKICAgICAgICAgICAgaWYgKGJ0bikgYnRuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQogICAgfQp3aW5kb3cuZmx1eC5QcmFjdGljZU1hbmFnZXIgPSBQcmFjdGljZU1hbmFnZXI7Cn0pKCk7","/PracticeManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBQcmFjdGljZU1hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKGdhbWVNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuZ2FtZSA9IGdhbWVNYW5hZ2VyOwogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREcmlsbCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZSA9IHt9OyAKICAgICAgICAgICAgCnRoaXMuZHJpbGxzID0gewogICAgICAgICAgICAgICAgJ2ZyZWUnOiB7IG5hbWU6ICdGUkVFIFJPQU0nLCBzZXR1cDogdGhpcy5fc2V0dXBGcmVlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BGcmVlLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdiYWxsX2xhYic6IHsgbmFtZTogJ0JBTEwgTEFCJywgc2V0dXA6IHRoaXMuX3NldHVwQmFsbExhYi5iaW5kKHRoaXMpLCBsb29wOiB0aGlzLl9sb29wQmFsbExhYi5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAnc2hvb3RpbmcnOiB7IG5hbWU6ICdTSE9PVElORyBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cFNob290aW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BTaG9vdGluZy5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncGFzc2luZyc6IHsgbmFtZTogJ1BBU1NJTkcgRFJJTEwnLCBzZXR1cDogdGhpcy5fc2V0dXBQYXNzaW5nLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BQYXNzaW5nLmJpbmQodGhpcykgfSwKICAgICAgICAgICAgICAgICdkZWZlbnNlJzogeyBuYW1lOiAnREVGRU5TRSBEUklMTCcsIHNldHVwOiB0aGlzLl9zZXR1cERlZmVuc2UuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcERlZmVuc2UuYmluZCh0aGlzKSB9LAogICAgICAgICAgICAgICAgJ2N1cnZlJzogeyBuYW1lOiAnQ1VSVkUgU0hPVCcsIHNldHVwOiB0aGlzLl9zZXR1cEN1cnZlLmJpbmQodGhpcyksIGxvb3A6IHRoaXMuX2xvb3BDdXJ2ZS5iaW5kKHRoaXMpIH0sCiAgICAgICAgICAgICAgICAncmFwaWRfZmlyZSc6IHsgbmFtZTogJ1JBUElEIEZJUkUnLCBzZXR1cDogdGhpcy5fc2V0dXBSYXBpZEZpcmUuYmluZCh0aGlzKSwgbG9vcDogdGhpcy5fbG9vcFJhcGlkRmlyZS5iaW5kKHRoaXMpIH0KICAgICAgICAgICAgfTsKCnRoaXMudWkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2Utb3ZlcmxheScpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dlc3R1cmUtaGludCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gewogICAgICAgICAgICAgICAgaW5mU3RhdHM6IHRydWUsCiAgICAgICAgICAgICAgICBhaUR1bW15OiB0cnVlLAogICAgICAgICAgICAgICAgc2hvd0hpdGJveGVzOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy50YXJnZXRSaW5nID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107IC8vIEFycmF5IHRvIHRyYWNrIHZpc3VhbCBjb3BpZXMgb2YgdGhyb3duIGJhbGxzCiAgICAgICAgICAgIHRoaXMuX2luaXRWaXN1YWxzKCk7CiAgICAgICAgICAgIHRoaXMuX3NldHVwRXZlbnRzKCk7CiAgICAgICAgfQoKICAgICAgICBfaW5pdFZpc3VhbHMoKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBhIGdsb3dpbmcgcmluZyBmb3IgdGFyZ2V0cwogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoMS41LCAxLjgsIDMyKTsKICAgICAgICAgICAgZ2VvbWV0cnkucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4MDBmZmZmLCAKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgb3BhY2l0eTogMC42LAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIG1hdGVyaWFsKTsKICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gQWRkIHRvIHNjZW5lIHZpYSBnYW1lIG1hbmFnZXIgcmVmZXJlbmNlCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc2NlbmUpIHRoaXMuZ2FtZS5zY2VuZS5hZGQodGhpcy50YXJnZXRSaW5nKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0KCkgewp0aGlzLmlzUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3Nob3dQYW5lbCgpOwogICAgICAgICAgICAvLyBJZiBtZW51IHJlcXVlc3RlZCBhIHNwZWNpZmljIGRyaWxsIChlLmcuLCBCYWxsIExhYiksIGhvbm9yIGl0IG9uY2UuCiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHdpbmRvdy5mbHV4ICYmIHdpbmRvdy5mbHV4LnJlcXVlc3RlZFByYWN0aWNlRHJpbGw7CiAgICAgICAgICAgIGlmIChyZXEgJiYgdGhpcy5kcmlsbHNbcmVxXSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXREcmlsbChyZXEpOwogICAgICAgICAgICAgICAgd2luZG93LmZsdXgucmVxdWVzdGVkUHJhY3RpY2VEcmlsbCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldERyaWxsKCdmcmVlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBIVUQgaXMgdmlzaWJsZQogICAgICAgICAgICBjb25zdCBodWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndWktbGF5ZXInKTsKICAgICAgICAgICAgaWYoaHVkKSBodWQuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICB9CgogICAgICAgIHN0b3AoKSB7CgogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9oaWRlUGFuZWwoKTsKICAgICAgICAgICAgdGhpcy5faGlkZVJlc3RvcmVCdG4oKTsKdGhpcy5fY2xlYXJEcmlsbCgpOwogICAgICAgICAgICAKLy8gQ2xlYXIgR2hvc3QgQmFsbHMKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYi5tZXNoKSB0aGlzLmdhbWUuc2NlbmUucmVtb3ZlKGIubWVzaCk7CiAgICAgICAgICAgICAgICBpZiAoYi50cmFpbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi50cmFpbC5tZXNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50cmFpbC5tZXNoLmdlb21ldHJ5KSBiLnRyYWlsLm1lc2guZ2VvbWV0cnkuZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5naG9zdEJhbGxzID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gZmFsc2U7CgogICAgICAgICAgICAvLyBSZXN0b3JlIEF3YXkgVGVhbSBWaXNpYmlsaXR5IGZvciBOb3JtYWwgTWF0Y2gKLy8gUmVzdG9yZSBBd2F5IFRlYW0gVmlzaWJpbGl0eSBmb3IgTm9ybWFsIE1hdGNoCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGVhbXMuYXdheSkgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnRlYW1zLmF3YXkucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgICAgIGlmKHAubWVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICBwLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi55ID0gMDsgLy8gRW5zdXJlIHRoZXkgYXJlbid0IHN0dWNrIHVuZGVyIGZsb29yCiAgICAgICAgICAgICAgICAgICAgICAgIHAuY2FuQ2F0Y2ggPSB0cnVlOyAvLyBSZXN0b3JlIGNhdGNoaW5nCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERpc2FibGUgZGVidWcgdmlzdWFscyBpZiB0aGV5IHdlcmUgb24KICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIuZW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5zaG93SGl0Ym94ZXMgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2V0RHJpbGwoa2V5KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5kcmlsbHNba2V5XSkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLl9jbGVhckRyaWxsKCk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudERyaWxsID0ga2V5OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFVJCiAgICAgICAgICAgIGlmICh0aGlzLnVpKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3JBbGwoJy5kcmlsbC1idG4nKS5mb3JFYWNoKGJ0biA9PiB7CiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTGlzdC50b2dnbGUoJ2FjdGl2ZScsIGJ0bi5kYXRhc2V0LmRyaWxsID09PSBrZXkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJ1biBTZXR1cAogICAgICAgICAgICB0aGlzLmRyaWxsc1trZXldLnNldHVwKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBbm5vdW5jZW1lbnQKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zaG93QW5ub3VuY2VtZW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2hvd0Fubm91bmNlbWVudCh0aGlzLmRyaWxsc1trZXldLm5hbWUsICdub3JtYWwnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc1J1bm5pbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENvbW1vbiBQcmFjdGljZSBMb2dpYyAoSW5maW5pdGUgU3RhdHMpCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuaW5mU3RhdHMpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5SW5maW5pdGVTdGF0cygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEcmlsbCBMb2dpYwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RHJpbGwgJiYgdGhpcy5kcmlsbHNbdGhpcy5jdXJyZW50RHJpbGxdLmxvb3ApIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxzW3RoaXMuY3VycmVudERyaWxsXS5sb29wKGR0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFscyBBbmltYXRpb24KLy8gVmlzdWFscyBBbmltYXRpb24KICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZyAmJiB0aGlzLnRhcmdldFJpbmcudmlzaWJsZSkgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnJvdGF0aW9uLnogKz0gZHQ7IC8vIFNwaW4KICAgICAgICAgICAgICAgIGNvbnN0IHMgPSAxLjAgKyBNYXRoLnNpbihEYXRlLm5vdygpICogMC4wMDUpICogMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnNjYWxlLnNldChzLCBzLCBzKTsKICAgICAgICAgICAgfQoKLy8gVXBkYXRlIEdob3N0IEJhbGxzCiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmdob3N0QmFsbHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmdob3N0QmFsbHNbaV07CiAgICAgICAgICAgICAgICBiLmxpZmUgLT0gZHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIC0tLSBQSFlTSUNTICYgVklTVUFMUyBERUxFR0FUSU9OIC0tLQogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5mbHV4LkJhbGwgJiYgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlRnJlZSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4LkJhbGwucHJvdG90eXBlLnVwZGF0ZUZyZWUuY2FsbChiLCBkdCk7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmZsdXguQmFsbC5wcm90b3R5cGUudXBkYXRlVmlzdWFscy5jYWxsKGIsIGR0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgVHJhaWwKICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhaWxQb3MgPSBiLm1lc2gucG9zaXRpb24uY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi5kZWZvcm1Ob2RlKSB0cmFpbFBvcy55ICs9IGIuZGVmb3JtTm9kZS5wb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgIGIudHJhaWwudXBkYXRlKHRyYWlsUG9zKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAtLS0gR09BTCBERVRFQ1RJT04gRk9SIEdIT1NUIEJBTExTIC0tLQogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gYi5tZXNoLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgLy8gQ2hlY2sgWiBkZXB0aCAoR29hbCBpcyBhdCArLy0gMjgsIHRyaWdnZXIgYXQgMjkpCmlmIChNYXRoLmFicyhwb3MueikgPiA0MC4wKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gR29hbCBCb3ggRGltZW5zaW9ucyAoTWF0Y2hlcyBHYW1lTWFuYWdlcikKICAgICAgICAgICAgICAgICAgICBjb25zdCBoYWxmV2lkdGggPSAxMS4wOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhbGZIZWlnaHQgPSA5LjA7CmNvbnN0IGdvYWxZT2Zmc2V0ID0gLTYuMDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocG9zLngpIDw9IGhhbGZXaWR0aCAmJiBNYXRoLmFicyhwb3MueSAtIGdvYWxZT2Zmc2V0KSA8PSBoYWxmSGVpZ2h0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdPQUwhCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGF3biBHb2FsIEZYCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGFydGljbGVNYW5hZ2VyLnNwYXduKCdzaG9ja3dhdmUnLCBwb3MsIHsgc2NhbGU6IDguMCwgbGlmZTogMC41IH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZmxhc2gnLCBwb3MsIHsgc2NhbGU6IDUuMCB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlYnJpcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBrPTA7IGs8MTA7IGsrKykgdGhpcy5nYW1lLnBhcnRpY2xlTWFuYWdlci5zcGF3bignZGVicmlzJywgcG9zLCB7IHNjYWxlOiAwLjUgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIkdPQUwiLCBwb3MsICJnb2FsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gS2lsbCBiYWxsIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICAgICAgICAgIGIubGlmZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENsZWFudXAKICAgICAgICAgICAgICAgIGlmIChiLmxpZmUgPD0gMCB8fCBiLm1lc2gucG9zaXRpb24ueSA8IC0xMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zY2VuZS5yZW1vdmUoYi5tZXNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50cmFpbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUucmVtb3ZlKGIudHJhaWwubWVzaCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiLnRyYWlsLm1lc2guZ2VvbWV0cnkpIGIudHJhaWwubWVzaC5nZW9tZXRyeS5kaXNwb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2hvc3RCYWxscy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9zZXR1cEV2ZW50cygpIHsKCiAgICAgICAgICAgIC8vIE1pbmltaXplIC8gUmVzdG9yZQogICAgICAgICAgICBjb25zdCBtaW5CdG4gPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoJyNwLW1pbmltaXplJyk7CiAgICAgICAgICAgIGlmIChtaW5CdG4pIHsKICAgICAgICAgICAgICAgIG1pbkJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlUGFuZWwoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaG93UmVzdG9yZUJ0bigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHJlc3RvcmVCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2UtcmVzdG9yZS1idG4nKTsKICAgICAgICAgICAgaWYgKHJlc3RvcmVCdG4pIHsKICAgICAgICAgICAgICAgIHJlc3RvcmVCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hvd1BhbmVsKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZVJlc3RvcmVCdG4oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEcmlsbCBCdXR0b25zCiAgICAgICAgICAgIHRoaXMudWkucXVlcnlTZWxlY3RvckFsbCgnLmRyaWxsLWJ0bicpLmZvckVhY2goYnRuID0+IHsKICAgICAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldERyaWxsKGJ0bi5kYXRhc2V0LmRyaWxsKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFJlc2V0IEJhbGwKICAgICAgICAgICAgY29uc3QgcmVzZXRCdG4gPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoJyNwLXJlc2V0LWJhbGwnKTsKICAgICAgICAgICAgaWYgKHJlc2V0QnRuKSB7CiAgICAgICAgICAgICAgICByZXNldEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEV4aXQKICAgICAgICAgICAgY29uc3QgZXhpdEJ0biA9IHRoaXMudWkucXVlcnlTZWxlY3RvcignI3AtZXhpdCcpOwogICAgICAgICAgICBpZiAoZXhpdEJ0bikgewogICAgICAgICAgICAgICAgZXhpdEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZsdXguZ2FtZUluc3RhbmNlICYmIHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5tZW51TWFuYWdlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UubWVudU1hbmFnZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2Uuc3RhdGUgPSAnbWVudSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPcHRpb25zIFRvZ2dsZXMKICAgICAgICAgICAgdGhpcy5fYmluZFRvZ2dsZSgnb3B0LWluZi1zdGF0JywgJ2luZlN0YXRzJyk7CiAgICAgICAgICAgIHRoaXMuX2JpbmRUb2dnbGUoJ29wdC1haS1kdW1teScsICdhaUR1bW15JywgKHZhbCkgPT4gewogICAgICAgICAgICAgICAgLy8gVXBkYXRlIEFJIER1bW15IHN0YXRlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLnRlYW1zLmF3YXkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5haUVuYWJsZWQgPSAhdmFsOyAvLyBJZiBkdW1teSBpcyBUUlVFLCBBSSBpcyBGQUxTRQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5fYmluZFRvZ2dsZSgnb3B0LWhpdGJveGVzJywgJ3Nob3dIaXRib3hlcycsICh2YWwpID0+IHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZGVidWdWaXN1YWxpemVyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmRlYnVnVmlzdWFsaXplci5lbmFibGVkID0gdmFsOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5kZWJ1Z1Zpc3VhbGl6ZXIuc2hvd0hpdGJveGVzID0gdmFsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEtleWJvYXJkIFNob3J0Y3V0IGZvciBSZXNldCAoUikKLy8gS2V5Ym9hcmQgU2hvcnRjdXQgZm9yIFJlc2V0IChSKQogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc1J1bm5pbmcgJiYgZS5rZXkudG9Mb3dlckNhc2UoKSA9PT0gJ3InICYmICFlLnJlcGVhdCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCl9iaW5kVG9nZ2xlKGlkLCBvcHRpb25LZXksIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKGAjJHtpZH1gKTsKICAgICAgICAgICAgaWYgKCFlbCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gSGVscGVyIHRvIHVwZGF0ZSB2aXN1YWxzCiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZVZpc3VhbCA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGlzQWN0aXZlID0gdGhpcy5vcHRpb25zW29wdGlvbktleV07CiAgICAgICAgICAgICAgICBlbC5jbGFzc0xpc3QudG9nZ2xlKCdhY3RpdmUnLCBpc0FjdGl2ZSk7CiAgICAgICAgICAgICAgICBjb25zdCBib3ggPSBlbC5xdWVyeVNlbGVjdG9yKCcuY2hlY2tib3gnKTsKICAgICAgICAgICAgICAgIGlmIChib3gpIGJveC5pbm5lclRleHQgPSBpc0FjdGl2ZSA/ICfilqMnIDogJ+KWoSc7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIHZpc3VhbCBzdGF0ZSBpbW1lZGlhdGVseQogICAgICAgICAgICB1cGRhdGVWaXN1YWwoKTsKCiAgICAgICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnNbb3B0aW9uS2V5XSA9ICF0aGlzLm9wdGlvbnNbb3B0aW9uS2V5XTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdXBkYXRlVmlzdWFsKCk7CgogICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayh0aGlzLm9wdGlvbnNbb3B0aW9uS2V5XSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCgogICAgICAgIF9zZXR1cEJhbGxMYWIoKSB7CiAgICAgICAgICAgIHRoaXMuX3NldEluc3RydWN0aW9uKCJCQUxMIExBQjogT3BlbiBEZXZUb29scyDihpIgQmFsbCBMYWIuIFVzZSBTaG90IENhbm5vbiArIHRyYWplY3RvcnkgcHJldmlldyArIHJlY29yZC9yZXBsYXkuIik7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9IDA7CgogICAgICAgICAgICBjb25zdCBob21lID0gdGhpcy5nYW1lLnRlYW1zLmhvbWU7CiAgICAgICAgICAgIGNvbnN0IGF3YXkgPSB0aGlzLmdhbWUudGVhbXMuYXdheTsKICAgICAgICAgICAgY29uc3QgcCA9IGhvbWUgPyBob21lLmFjdGl2ZVBsYXllciA6IG51bGw7CiAgICAgICAgICAgIGlmICghcCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gU29sbyBtb2RlOiBoaWRlIGV2ZXJ5b25lIGV4Y2VwdCB0aGUgYWN0aXZlIHBsYXllcgogICAgICAgICAgICBpZiAoaG9tZSAmJiBob21lLnBsYXllcnMpIHsKICAgICAgICAgICAgICAgIGhvbWUucGxheWVycy5mb3JFYWNoKG1hdGUgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChtYXRlLm1lc2gpIG1hdGUubWVzaC52aXNpYmxlID0gKG1hdGUgPT09IHApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGF3YXkgJiYgYXdheS5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBhd2F5LnBsYXllcnMuZm9yRWFjaChvcHAgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChvcHAubWVzaCkgb3BwLm1lc2gudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFBsYWNlIGFjdGl2ZSBwbGF5ZXIgYXQgY2VudGVyIGZhY2luZyB0aGUgYXdheSBnb2FsCiAgICAgICAgICAgIGlmIChwLm1lc2gpIHsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7CmNvbnN0IGdvYWxEaXN0ID0gd2luZG93LmZsdXguQmFsbENvbmZpZy5HT0FMX0RJU1RBTkNFIHx8IDQxLjU7CiAgICAgICAgICAgICAgICBwLm1lc2gubG9va0F0KDAsIDAsIC1nb2FsRGlzdCk7CiAgICAgICAgICAgICAgICBwLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgICAgICAgICAgIGlmIChwLnN5bmNSb3RhdGlvbikgcC5zeW5jUm90YXRpb24oKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmlnIHN0YXRzIHNvIHlvdSBjYW4gdGVzdCBleHRyZW1lcwogICAgICAgICAgICBpZiAocC5zdGF0cykgewogICAgICAgICAgICAgICAgcC5zdGF0cy5TSCA9IDk5OwogICAgICAgICAgICAgICAgcC5zdGF0cy5QQSA9IDk5OwogICAgICAgICAgICAgICAgcC5zdGF0cy5FTiA9IDk5OwogICAgICAgICAgICAgICAgcC5zdGF0cy5tYXhIUCA9IE1hdGgubWF4KHAuc3RhdHMubWF4SFAgfHwgOTk5LCA5OTkpOwogICAgICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEEgY2xlYXIgdGFyZ2V0IG1hcmtlciAocHVyZWx5IHZpc3VhbCkKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnNldCgwLCAwLjEsIC0xOCk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4ZmYwMGZmKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgogICAgICAgIF9sb29wQmFsbExhYihkdCkgewogICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIGlmICghYiB8fCAhcCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gQXV0by1yZXNldCBiYWxsIGJhY2sgdG8gcGxheWVyIG9uY2UgaXQgY29tZXMgdG8gcmVzdCwKICAgICAgICAgICAgLy8gc28geW91IGNhbiBzcGFtIHZhcmlhdGlvbnMgd2l0aG91dCB0b3VjaGluZyBhbnl0aGluZy4KICAgICAgICAgICAgaWYgKGIuc3RhdGUgPT09ICdmcmVlJykgewogICAgICAgICAgICAgICAgY29uc3Qgc3RvcHBlZCA9IChiLnZlbG9jaXR5Lmxlbmd0aFNxKCkgPCAwLjAxKSAmJiAoYi5wb3dlciA8PSAwLjAxKTsKICAgICAgICAgICAgICAgIGlmIChzdG9wcGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9ICh0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyIHx8IDApICsgZHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPiAwLjQ1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5fYXV0b1Jlc2V0VGltZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLl9hdXRvUmVzZXRUaW1lciA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuX2F1dG9SZXNldFRpbWVyID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2xpZ2h0IHRhcmdldCBib2IgKGhlbHBzIGRlcHRoIHBlcmNlcHRpb24pCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcgJiYgdGhpcy50YXJnZXRSaW5nLnZpc2libGUpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi55ID0gMC4xICsgTWF0aC5zaW4oRGF0ZS5ub3coKSAqIDAuMDAzKSAqIDAuMDU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9hcHBseUluZmluaXRlU3RhdHMoKSB7CiAgICAgICAgICAgIGNvbnN0IGhvbWUgPSB0aGlzLmdhbWUudGVhbXMuaG9tZTsKICAgICAgICAgICAgaWYgKGhvbWUpIHsKICAgICAgICAgICAgICAgIGhvbWUucGxheWVycy5mb3JFYWNoKHAgPT4gewogICAgICAgICAgICAgICAgICAgIHAuc3RhdHMuSFAgPSBwLnN0YXRzLm1heEhQOwogICAgICAgICAgICAgICAgICAgIHAuY3VycmVudEVOID0gcC5zdGF0cy5FTjsKICAgICAgICAgICAgICAgICAgICBwLnN0YXR1cy52ZW5vbSA9IDA7CiAgICAgICAgICAgICAgICAgICAgcC5zdGF0dXMubmFwID0gMDsKICAgICAgICAgICAgICAgICAgICBwLnN0dW5UaW1lciA9IDA7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2NsZWFyRHJpbGwoKSB7CgogICAgICAgICAgICAvLyBSZXNldCBwb3NpdGlvbnMsIGNsZWFyIGR1bW1pZXMsIHJlc2V0IHNjb3JlCiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUgPSB7IHNjb3JlOiAwLCB0aW1lcjogMCwgc3RhZ2U6IDAsIHJlc2V0dGluZzogZmFsc2UgfTsKICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSgwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENsZWFyIEdseXBocwogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmdseXBoTWFuYWdlcikgdGhpcy5nYW1lLmdseXBoTWFuYWdlci5jbGVhcigpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFJlc2V0IHRlYW1zIHRvIGRlZmF1bHQgcG9zaXRpb25zCgogICAgICAgICAgICAvLyBSZXNldCB0ZWFtcyB0byBkZWZhdWx0IHBvc2l0aW9ucwogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5yZXNldFBvc2l0aW9ucygpOwogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5yZXNldFBvc2l0aW9ucygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwbHkgQUkgRHVtbXkgc2V0dGluZwogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnRlYW1zLmF3YXkpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LmFpRW5hYmxlZCA9ICF0aGlzLm9wdGlvbnMuYWlEdW1teTsKICAgICAgICAgICAgfQovLyBIaWRlIGF3YXkgdGVhbSBieSBkZWZhdWx0IGluIGRyaWxscyB1bmxlc3Mgc3BlY2lmaWVkCiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIGlmKHAubWVzaCkgcC5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgLTEwMDAsIDApOyAvLyBNb3ZlIFdBWSBhd2F5IHRvIHByZXZlbnQgaW50ZXJhY3Rpb24KICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIHAuY2FuQ2F0Y2ggPSBmYWxzZTsgLy8gRGlzYWJsZSBjYXRjaGluZwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuc3VyZSBIb21lIHRlYW0gaXMgdmlzaWJsZQogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfcmVzZXRCYWxsVG9QbGF5ZXIoKSB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIGNvbnN0IGIgPSB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbDsKICAgICAgICAgICAgaWYgKHAgJiYgYikgewogICAgICAgICAgICAgICAgYi5yZXNldCgpOwogICAgICAgICAgICAgICAgYi5ncmFiKHApOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIlJFU0VUIiwgcC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTbmFwIGNhbWVyYQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5jYW1lcmFNYW5hZ2VyKSB0aGlzLmdhbWUuY2FtZXJhTWFuYWdlci5zbmFwVG9UYXJnZXQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3VwZGF0ZVNjb3JlVUkodmFsKSB7CiAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy51aS5xdWVyeVNlbGVjdG9yKCcjZHJpbGwtc2NvcmUnKTsKICAgICAgICAgICAgaWYgKGVsKSBlbC5pbm5lclRleHQgPSBgU0NPUkU6ICR7dmFsfWA7CiAgICAgICAgfQoKICAgICAgICBfc2V0SW5zdHJ1Y3Rpb24odGV4dCkgewogICAgICAgICAgICAgY29uc3QgZWwgPSB0aGlzLnVpLnF1ZXJ5U2VsZWN0b3IoJyNkcmlsbC1pbnN0cnVjdGlvbicpOwogICAgICAgICAgICAgaWYgKGVsKSBlbC5pbm5lclRleHQgPSB0ZXh0OwogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIERSSUxMUyAtLS0KCl9zZXR1cEZyZWUoKSB7CiAgICAgICAgICAgIHRoaXMuX3NldEluc3RydWN0aW9uKCJGcmVlIHByYWN0aWNlLiBJbmZpbml0ZSBIUC9FTi4iKTsKICAgICAgICAgICAgLy8gU2hvdyBldmVyeW9uZQogICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBpZihwLm1lc2gpIHAubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5jb3B5KHAuaG9tZVBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHAuY2FuQ2F0Y2ggPSB0cnVlOyAvLyBSZXN0b3JlIGNhcGFiaWxpdHkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQogICAgICAgIF9sb29wRnJlZShkdCkge30KCiAgICAgICAgX3NldHVwU2hvb3RpbmcoKSB7CgogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiU2NvcmUgb24gdGhlIEdvYWxpZSEiKTsKICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IGZhbHNlOyAvLyBDbGVhciByZXNldCBmbGFnCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXR1cDogQWN0aXZlIFBsYXllciBhdCAxOG0sIEdvYWxpZSBpbiBuZXQuCiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIGNvbnN0IGcgPSB0aGlzLmdhbWUudGVhbXMuYXdheS5wbGF5ZXJzLmZpbmQoeCA9PiB4LnJvbGUgPT09ICdHTCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHAgJiYgcC5tZXNoKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC0xMCk7IC8vIDE4bSBvdXQgKEhvbWUgYXR0YWNrcyAtWikKY29uc3QgZ29hbERpc3QgPSB3aW5kb3cuZmx1eC5CYWxsQ29uZmlnLkdPQUxfRElTVEFOQ0UgfHwgNDEuNTsKICAgICAgICAgICAgICAgIHAubWVzaC5sb29rQXQoMCwgMCwgLWdvYWxEaXN0KTsKICAgICAgICAgICAgICAgIHAudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZyAmJiBnLm1lc2gpIHsKICAgICAgICAgICAgICAgIGcubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGcubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgLTI3KTsKICAgICAgICAgICAgICAgIGcubWVzaC5sb29rQXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBnLnZlbG9jaXR5LnNldCgwLDAsMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuX3Jlc2V0QmFsbFRvUGxheWVyKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9sb29wU2hvb3RpbmcoZHQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGdvYWwgc2NvcmVkIChHYW1lTWFuYWdlciBoYW5kbGVzIHRoZSBhY3R1YWwgZ29hbCBldmVudCwgYnV0IHdlIHRyYWNrIHJlc2V0KQogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YXRlID09PSAnZ29hbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVTY29yZVVJKHRoaXMuZHJpbGxTdGF0ZS5zY29yZSk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhdGUgPSAnYWN0aXZlJzsgLy8gSGlqYWNrIHN0YXRlIGJhY2sKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBTaG9vdGluZygpLCAxMDAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgZ29hbGllIGNhdGNoZXMKICAgICAgICAgICAgY29uc3QgZyA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ0dMJyk7CiAgICAgICAgICAgIGlmIChnICYmIGcuaGFzQmFsbCkgewogICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTQVZFRCIsIGcubWVzaC5wb3NpdGlvbiwgImRhbWFnZSIpOwogICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBTaG9vdGluZygpLCAxMDAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX3NldHVwUGFzc2luZygpIHsKCiAgICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiUGFzcyB0byB0aGUgbW92aW5nIHRhcmdldCEiKTsKICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgICAvLyBTZXR1cDogQWN0aXZlIFBsYXllciBjZW50ZXIuIDEgVGVhbW1hdGUgcnVubmluZyBwYXR0ZXJucy4KICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQoeCA9PiB4ICE9PSBwICYmIHgucm9sZSAhPT0gJ0dMJyk7CiAgICAgICAgICAgICAKICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS50YXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICAgICAKICAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICAgcC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAxMCk7CiAgICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgfQogICAgICAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICAgICAgIHRhcmdldC5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCAtMTApOwogICAgICAgICAgICAgICAgIHRhcmdldC5tZXNoLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgIHRhcmdldC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgfQogICAgICAgICAgICAgCiAgICAgICAgICAgICB0aGlzLl9yZXNldEJhbGxUb1BsYXllcigpOwogICAgICAgIH0KCiAgICAgICAgX2xvb3BQYXNzaW5nKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmRyaWxsU3RhdGUudGFyZ2V0OwogICAgICAgICAgICBpZiAoIXRhcmdldCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTW92ZSB0YXJnZXQgaW4gY2lyY2xlCiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS50aW1lciArPSBkdDsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gucG9zaXRpb24ueCA9IE1hdGguc2luKHRoaXMuZHJpbGxTdGF0ZS50aW1lcikgKiAxMDsKICAgICAgICAgICAgdGFyZ2V0Lm1lc2gucG9zaXRpb24ueiA9IC0xMCArIE1hdGguY29zKHRoaXMuZHJpbGxTdGF0ZS50aW1lciAqIDAuNSkgKiA1OwogICAgICAgICAgICB0YXJnZXQubWVzaC5sb29rQXQoMCwwLDEwKTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBSaW5nCiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldFJpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi5jb3B5KHRhcmdldC5tZXNoLnBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5wb3NpdGlvbi55ID0gMC4xOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweDAwZmZmZik7IC8vIEN5YW4KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRhcmdldC5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5zY29yZSsrOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQpIHRoaXMuZ2FtZS5mbG9hdGluZ1RleHQuc3Bhd24oIk5JQ0UgUEFTUyEiLCB0YXJnZXQubWVzaC5wb3NpdGlvbiwgImhlYWwiKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVzZXQKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRhcmdldC5sb3NlQmFsbCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NldHVwUGFzc2luZygpOyAvLyBSZS1zZXR1cCB0byByZXNldCBwb3NpdGlvbnMKICAgICAgICAgICAgICAgIH0sIDgwMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgX3NldHVwRGVmZW5zZSgpIHsKCiAgICAgICAgICAgIHRoaXMuX3NldEluc3RydWN0aW9uKCJUYWNrbGUgdGhlIGF0dGFja2VyISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBhdHRhY2tlciA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ01GJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuYXR0YWNrZXIgPSBhdHRhY2tlcjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDIwKTsgLy8gTmVhciBvd24gZ29hbAogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhdHRhY2tlcikgewogICAgICAgICAgICAgICAgYXR0YWNrZXIubWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGF0dGFja2VyLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIC0xMCk7CiAgICAgICAgICAgICAgICBhdHRhY2tlci52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgLy8gR2l2ZSBiYWxsIHRvIGF0dGFja2VyCiAgICAgICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgICAgICBiLnJlc2V0KCk7CiAgICAgICAgICAgICAgICBiLmdyYWIoYXR0YWNrZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIF9sb29wRGVmZW5zZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgYXR0YWNrZXIgPSB0aGlzLmRyaWxsU3RhdGUuYXR0YWNrZXI7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5hY3RpdmVQbGF5ZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWF0dGFja2VyIHx8ICFwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBdHRhY2tlciBydW5zIHRvIGdvYWwgKCtaKQovLyBBdHRhY2tlciBydW5zIHRvIGdvYWwgKCtaKQogICAgICAgICAgICBjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICBjb25zdCBnb2FsUG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgZ29hbERpc3QpOwogICAgICAgICAgICBjb25zdCBkaXIgPSBnb2FsUG9zLmNsb25lKCkuc3ViKGF0dGFja2VyLm1lc2gucG9zaXRpb24pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFJpbmcgb24gQXR0YWNrZXIKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLmNvcHkoYXR0YWNrZXIubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcucG9zaXRpb24ueSA9IDAuMTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmluZy5tYXRlcmlhbC5jb2xvci5zZXRIZXgoMHhmZjAwMDApOyAvLyBSZWQgZm9yIGVuZW15CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhdHRhY2tlci5oYXNCYWxsKSB7CiAgICAgICAgICAgICAgICBhdHRhY2tlci5zZXRJbnB1dChkaXIueCwgZGlyLnopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQmFsbCBsb3N0IChUYWNrbGVkKQogICAgICAgICAgICAgICAgaWYgKHAuaGFzQmFsbCB8fCB0aGlzLmdhbWUuZW50aXRpZXMuYmFsbC5zdGF0ZSA9PT0gJ2ZyZWUnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJTVE9QUEVEISIsIHAubWVzaC5wb3NpdGlvbiwgImJsb2NrIik7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cERlZmVuc2UoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZhaWwgY29uZGl0aW9uOiBBdHRhY2tlciBzY29yZXMgKEdhbWVNYW5hZ2VyIGhhbmRsZXMgZ29hbCBjaGVjaykKICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc3RhdGUgPT09ICdnb2FsJykgewogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhdGUgPSAnYWN0aXZlJzsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJGQUlMRUQiLCBwLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBEZWZlbnNlKCksIDEwMDApOwogICAgICAgICAgICB9Cn0KCiAgICAgICAgX3NldHVwQ3VydmUoKSB7CnRoaXMuX3NldEluc3RydWN0aW9uKCJTd2lwZSBhIENVUlZFICggKSApIHRvIGJ5cGFzcyB0aGUgZGVmZW5kZXIhIik7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5yZXNldHRpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIFNob3cgZ2VzdHVyZSBoaW50CiAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDbGVhciBhbnkgZXhpc3RpbmcgdGltZW91dAogICAgICAgICAgICAgICAgaWYgKHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCkgY2xlYXJUaW1lb3V0KHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEF1dG8gaGlkZSBhZnRlciA0cwogICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLmhpbnRUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2VzdHVyZUhpbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICAvLyBVc2UgYSBkZWZlbmRlciBkdW1teQogICAgICAgICAgICBjb25zdCBkZWZlbmRlciA9IHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZmluZCh4ID0+IHgucm9sZSA9PT0gJ0xEJyk7CiAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5kZWZlbmRlciA9IGRlZmVuZGVyOwoKICAgICAgICAgICAgaWYgKHApIHsKICAgICAgICAgICAgICAgIHAubWVzaC5wb3NpdGlvbi5zZXQoMCwgMCwgMTUpOwpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGVmZW5kZXIpIHsKICAgICAgICAgICAgICAgIGRlZmVuZGVyLm1lc2gudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBkZWZlbmRlci5tZXNoLnBvc2l0aW9uLnNldCgwLCAwLCA1KTsgLy8gMTBtIGluIGZyb250IG9mIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIubWVzaC5sb29rQXQoMCwgMCwgMTUpOyAvLyBGYWNlIHBsYXllcgogICAgICAgICAgICAgICAgZGVmZW5kZXIudmVsb2NpdHkuc2V0KDAsMCwwKTsKICAgICAgICAgICAgICAgIC8vIEJvb3N0IEJMIHRvIGVuc3VyZSBzdHJhaWdodCBzaG90cyBhcmUgYmxvY2tlZAogICAgICAgICAgICAgICAgZGVmZW5kZXIuc3RhdHMuQkwgPSA5OTsgCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhleSBkb24ndCBtb3ZlCiAgICAgICAgICAgICAgICBkZWZlbmRlci5haVN0YXRlID0gJ0lETEUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUYXJnZXQgUmluZyBiZWhpbmQgZGVmZW5kZXIKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0UmluZykgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSaW5nLnBvc2l0aW9uLnNldCgwLCAwLjEsIC0xMCk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJpbmcubWF0ZXJpYWwuY29sb3Iuc2V0SGV4KDB4MDBmZmZmKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgpfbG9vcEN1cnZlKGR0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBiYWxsID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CiAgICAgICAgICAgIGNvbnN0IGRlZmVuZGVyID0gdGhpcy5kcmlsbFN0YXRlLmRlZmVuZGVyOwoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgYmFsbCBwYXNzZWQgdGhlIGRlZmVuZGVyIGxpbmUgKHogPCAwKQogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAwKSB7CiAgICAgICAgICAgICAgICAvLyBTdWNjZXNzIHpvbmUgKFdpdGhpbiA1bSB3aWR0aCkKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhiYWxsLm1lc2gucG9zaXRpb24ueCkgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnJlc2V0dGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmlsbFN0YXRlLnNjb3JlKys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2NvcmVVSSh0aGlzLmRyaWxsU3RhdGUuc2NvcmUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZmxvYXRpbmdUZXh0KSB0aGlzLmdhbWUuZmxvYXRpbmdUZXh0LnNwYXduKCJDVVJWRUQhIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAidGVjaCIpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fc2V0dXBDdXJ2ZSgpLCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGJsb2NrZWQgKEJhbGwgc3RvcHBlZCBvciBwb3dlciBkcmFpbmVkIHNpZ25pZmljYW50bHkgbmVhciBkZWZlbmRlcikKICAgICAgICAgICAgaWYgKGRlZmVuZGVyICYmIGJhbGwubWVzaC5wb3NpdGlvbi5kaXN0YW5jZVRvKGRlZmVuZGVyLm1lc2gucG9zaXRpb24pIDwgMy4wKSB7CiAgICAgICAgICAgICAgICBpZiAoYmFsbC5wb3dlciA8PSAwIHx8IGJhbGwudmVsb2NpdHkubGVuZ3RoKCkgPCAxLjApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiQkxPQ0tFRCIsIGRlZmVuZGVyLm1lc2gucG9zaXRpb24sICJkYW1hZ2UiKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSZS1zaG93IGhpbnQgb24gZmFpbHVyZSB0byBndWlkZSBwbGF5ZXIKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVIaW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTWlzc2VkIC8gT3V0IG9mIGJvdW5kcwogICAgICAgICAgICBpZiAoYmFsbC5tZXNoLnBvc2l0aW9uLnogPCAtMTUpIHsKICAgICAgICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmZsb2F0aW5nVGV4dCkgdGhpcy5nYW1lLmZsb2F0aW5nVGV4dC5zcGF3bigiTUlTU0VEIiwgYmFsbC5tZXNoLnBvc2l0aW9uLCAiZGFtYWdlIik7CiAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgLy8gUmUtc2hvdyBoaW50IG9uIG1pc3MKICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZUhpbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVIaW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRyaWxsU3RhdGUuaGludFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJpbGxTdGF0ZS5oaW50VGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXN0dXJlSGludCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXN0dXJlSGludC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIDQwMDApOwogICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9zZXR1cEN1cnZlKCksIDEwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKX3NldHVwUmFwaWRGaXJlKCkgewogICAgICAgICAgICB0aGlzLl9zZXRJbnN0cnVjdGlvbigiVU5MSU1JVEVEIEFNTU8hIFNwYW0gdGhyb3dzISIpOwogICAgICAgICAgICB0aGlzLmRyaWxsU3RhdGUucmVzZXR0aW5nID0gZmFsc2U7CgogICAgICAgICAgICAvLyBGaW5kIFRpZHVzIG9yIGRlZmF1bHQgdG8gTEYKICAgICAgICAgICAgbGV0IHAgPSB0aGlzLmdhbWUudGVhbXMuaG9tZS5wbGF5ZXJzLmZpbmQoeCA9PiB4LmNoYXJhY3Rlck5hbWUgJiYgeC5jaGFyYWN0ZXJOYW1lLmluY2x1ZGVzKCdUaWR1cycpKTsKICAgICAgICAgICAgaWYgKCFwKSBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUucGxheWVycy5maW5kKHggPT4geC5yb2xlID09PSAnTEYnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldCBhY3RpdmUgcGxheWVyCiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUudGVhbXMuaG9tZS5zZXRBY3RpdmVQbGF5ZXIocCk7CiAgICAgICAgICAgICAgICBwLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwpjb25zdCBnb2FsRGlzdCA9IHdpbmRvdy5mbHV4LkJhbGxDb25maWcuR09BTF9ESVNUQU5DRSB8fCA0MS41OwogICAgICAgICAgICAgICAgcC5tZXNoLmxvb2tBdCgwLCAwLCAtZ29hbERpc3QpOwogICAgICAgICAgICAgICAgcC52ZWxvY2l0eS5zZXQoMCwwLDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBCb29zdCBzdGF0cyBmb3IgZnVuCiAgICAgICAgICAgICAgICBwLnN0YXRzLlNIID0gOTk7CiAgICAgICAgICAgICAgICBwLnN0YXRzLlBBID0gOTk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEhJREUgRVZFUllPTkUgKEFsb25lIE1vZGUpCiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5ob21lLnBsYXllcnMuZm9yRWFjaChtYXRlID0+IHsKICAgICAgICAgICAgICAgIGlmIChtYXRlICE9PSBwICYmIG1hdGUubWVzaCkgbWF0ZS5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS50ZWFtcy5hd2F5LnBsYXllcnMuZm9yRWFjaChvcHAgPT4gewogICAgICAgICAgICAgICAgaWYgKG9wcC5tZXNoKSBvcHAubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5fcmVzZXRCYWxsVG9QbGF5ZXIoKTsKICAgICAgICB9CgpfbG9vcFJhcGlkRmlyZShkdCkgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nYW1lLnRlYW1zLmhvbWUuYWN0aXZlUGxheWVyOwogICAgICAgICAgICBjb25zdCBiID0gdGhpcy5nYW1lLmVudGl0aWVzLmJhbGw7CgogICAgICAgICAgICBpZiAoIXAgfHwgIWIpIHJldHVybjsKCiAgICAgICAgICAgIC8vIERldGVjdCBpZiBiYWxsIHdhcyBqdXN0IHRocm93biAoaXMgZnJlZSkKICAgICAgICAgICAgaWYgKGIuc3RhdGUgPT09ICdmcmVlJykgewogICAgICAgICAgICAgICAgLy8gMS4gU3Bhd24gR2hvc3QgQmFsbCAoVmlzdWFsIENvcHkpCiAgICAgICAgICAgICAgICAvLyBDbG9uZSB0aGUgbWVzaCBoaWVyYXJjaHkgdG8gcHJlc2VydmUgRGVmb3JtL1NwaW4gbm9kZXMKICAgICAgICAgICAgICAgIGNvbnN0IGdob3N0TWVzaCA9IGIubWVzaC5jbG9uZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdmlzaWJpbGl0eSBhbmQgYWRkIHRvIHNjZW5lCiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc2NlbmUuYWRkKGdob3N0TWVzaCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlLWJpbmQgaW50ZXJuYWwgcmVmZXJlbmNlcyBmb3IgdGhlIHBoeXNpY3MgZW5naW5lCiAgICAgICAgICAgICAgICAvLyBIaWVyYXJjaHk6IE1lc2ggLT4gRGVmb3JtTm9kZSAtPiBTcGluTm9kZQogICAgICAgICAgICAgICAgY29uc3QgZGVmb3JtTm9kZSA9IGdob3N0TWVzaC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIGNvbnN0IHNwaW5Ob2RlID0gZGVmb3JtTm9kZSA/IGRlZm9ybU5vZGUuY2hpbGRyZW5bMF0gOiBudWxsOwoKICAgICAgICAgICAgICAgIC8vIERldGVybWluZSBUcmFpbCBDb2xvciBiYXNlZCBvbiBUZWNoCiAgICAgICAgICAgICAgICBsZXQgdHJhaWxDb2xvciA9IDB4ZmY0NDAwOyAvLyBEZWZhdWx0IFNIIChPcmFuZ2UpCiAgICAgICAgICAgICAgICBpZiAoYi50ZWNobmlxdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ3Zlbm9tJykgdHJhaWxDb2xvciA9IDB4YWEwMGZmOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICd3aXRoZXInKSB0cmFpbENvbG9yID0gMHg4ODg4ODg7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYi50ZWNobmlxdWUudHlwZSA9PT0gJ25hcCcpIHRyYWlsQ29sb3IgPSAweDAwMDA4ODsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnc3BoZXJlJykgdHJhaWxDb2xvciA9IDB4MDBmZmZmOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGIudGVjaG5pcXVlLnR5cGUgPT09ICdqZWNodCcpIHRyYWlsQ29sb3IgPSAweGZmMDAwMDsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiLnRlY2huaXF1ZS50eXBlID09PSAnaW52aXNpYmxlJykgdHJhaWxDb2xvciA9IDB4NDQ0NDQ0OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChiLnBvd2VyVHlwZSA9PT0gJ1BBJykgewogICAgICAgICAgICAgICAgICAgIHRyYWlsQ29sb3IgPSAweDAwYWFmZjsgLy8gUGFzcyAoQmx1ZSkKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDcmVhdGUgVHJhaWwKICAgICAgICAgICAgICAgIGNvbnN0IHRyYWlsID0gbmV3IHdpbmRvdy5mbHV4LlRyYWlsUmVuZGVyZXIodGhpcy5nYW1lLnNjZW5lKTsKICAgICAgICAgICAgICAgIHRyYWlsLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0cmFpbC5zZXRDb2xvcih0cmFpbENvbG9yKTsKICAgICAgICAgICAgICAgIHRyYWlsLnJlc2V0KGdob3N0TWVzaC5wb3NpdGlvbik7CgogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIGEgIk1vY2siIEJhbGwgb2JqZWN0IHRoYXQgc2F0aXNmaWVzIEJhbGwuanMgcGh5c2ljcyByZXF1aXJlbWVudHMKICAgICAgICAgICAgICAgIGNvbnN0IGdob3N0QmFsbCA9IHsKICAgICAgICAgICAgICAgICAgICBtZXNoOiBnaG9zdE1lc2gsCiAgICAgICAgICAgICAgICAgICAgZGVmb3JtTm9kZTogZGVmb3JtTm9kZSwKICAgICAgICAgICAgICAgICAgICBzcGluTm9kZTogc3Bpbk5vZGUsCiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IGIudmVsb2NpdHkuY2xvbmUoKSwKICAgICAgICAgICAgICAgICAgICBhbmd1bGFyVmVsb2NpdHk6IGIuYW5ndWxhclZlbG9jaXR5ID8gYi5hbmd1bGFyVmVsb2NpdHkuY2xvbmUoKSA6IG5ldyBUSFJFRS5WZWN0b3IzKCksCiAgICAgICAgICAgICAgICAgICAgYWNjdW11bGF0ZWRSb3RhdGlvbjogYi5hY2N1bXVsYXRlZFJvdGF0aW9uID8gYi5hY2N1bXVsYXRlZFJvdGF0aW9uLmNsb25lKCkgOiBuZXcgVEhSRUUuUXVhdGVybmlvbigpLAogICAgICAgICAgICAgICAgICAgIHN0YXRlOiAnZnJlZScsCiAgICAgICAgICAgICAgICAgICAgcG93ZXI6IGIucG93ZXIsCiAgICAgICAgICAgICAgICAgICAgcG93ZXJUeXBlOiBiLnBvd2VyVHlwZSwKICAgICAgICAgICAgICAgICAgICB0ZWNobmlxdWU6IGIudGVjaG5pcXVlLAogICAgICAgICAgICAgICAgICAgIGlzSW52aXNpYmxlOiBiLmlzSW52aXNpYmxlLAogICAgICAgICAgICAgICAgICAgIGxpZmU6IDUuMCwgLy8gRW5vdWdoIHRpbWUgdG8gcmVhY2ggZ29hbAogICAgICAgICAgICAgICAgICAgIHRyYWlsOiB0cmFpbCwKICAgICAgICAgICAgICAgICAgICBfYnViYmxlVGltZXI6IDAsCiAgICAgICAgICAgICAgICAgICAgX2dob3N0OiB0cnVlLAogICAgICAgICAgICAgICAgICAgIC8vIE1vY2sgbWV0aG9kcwogICAgICAgICAgICAgICAgICAgIHJlc2V0OiAoKSA9PiB7fSwgCiAgICAgICAgICAgICAgICAgICAgZHJvcDogKCkgPT4ge30sCiAgICAgICAgICAgICAgICAgICAgcmV2ZWFsOiAoKSA9PiB7fQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSB2aXNpYmlsaXR5CiAgICAgICAgICAgICAgICBnaG9zdE1lc2gudmlzaWJsZSA9ICFiLmlzSW52aXNpYmxlOwoKICAgICAgICAgICAgICAgIHRoaXMuZ2hvc3RCYWxscy5wdXNoKGdob3N0QmFsbCk7CgovLyAyLiBSZXNldCBSZWFsIEJhbGwgdG8gUGxheWVyIElOU1RBTlRMWQogICAgICAgICAgICAgICAgYi52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICBiLmFuZ3VsYXJWZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZJWDogRm9yY2UgYmFsbCBwb3NpdGlvbiB0byBiZSBleHBsaWNpdGx5IGluIGZyb250IG9mIHRoZSBwbGF5ZXIKICAgICAgICAgICAgICAgIC8vIFRoaXMgcHJldmVudHMgYW55IGxvZ2ljIGZyb20gdGhpbmtpbmcgdGhlIGJhbGwgaXMgYmVoaW5kIGFuZCB0cmlnZ2VyaW5nIGEgdHVybgogICAgICAgICAgICAgICAgY29uc3QgZndkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKHAubWVzaC5xdWF0ZXJuaW9uKTsKICAgICAgICAgICAgICAgIGIubWVzaC5wb3NpdGlvbi5jb3B5KHAubWVzaC5wb3NpdGlvbikuYWRkKGZ3ZC5tdWx0aXBseVNjYWxhcigwLjgpKTsKICAgICAgICAgICAgICAgIGIubWVzaC5wb3NpdGlvbi55ICs9IDEuMDsKCiAgICAgICAgICAgICAgICAvLyBNYW51YWwgQXR0YWNoIChCeXBhc3MgJ2NhdGNoJyBhbmltYXRpb24pCiAgICAgICAgICAgICAgICBiLmhvbGRlciA9IHA7CiAgICAgICAgICAgICAgICBiLnN0YXRlID0gJ2hlbGQnOwogICAgICAgICAgICAgICAgcC5oYXNCYWxsID0gdHJ1ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gUmVzZXQgUGxheWVyIFRocm93IFN0YXRlIHNvIHRoZXkgY2FuIGZpcmUgYWdhaW4gaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIHAuaXNUaHJvd2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcC5jYXRjaENvb2xkb3duID0gMDsKCiAgICAgICAgICAgICAgICAvLyBTeW5jIHJvdGF0aW9uIHRvIHByZXZlbnQgc25hcHBpbmcKICAgICAgICAgICAgICAgIGlmIChwLnN5bmNSb3RhdGlvbikgcC5zeW5jUm90YXRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW5zdXJlIGluZmluaXRlIHN0YXRzCiAgICAgICAgICAgIHAuY3VycmVudEVOID0gcC5zdGF0cy5FTjsKICAgICAgICAgICAgcC5zdGF0cy5IUCA9IHAuc3RhdHMubWF4SFA7CiAgICAgICAgfQoKICAgICAgICBfc2hvd1BhbmVsKCkgewogICAgICAgICAgICBpZiAodGhpcy51aSkgdGhpcy51aS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICB9CgogICAgICAgIF9oaWRlUGFuZWwoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnVpKSB0aGlzLnVpLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgIH0KCiAgICAgICAgX3Nob3dSZXN0b3JlQnRuKCkgewogICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2UtcmVzdG9yZS1idG4nKTsKICAgICAgICAgICAgaWYgKGJ0bikgYnRuLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgIH0KCiAgICAgICAgX2hpZGVSZXN0b3JlQnRuKCkgewogICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJhY3RpY2UtcmVzdG9yZS1idG4nKTsKICAgICAgICAgICAgaWYgKGJ0bikgYnRuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQogICAgfQp3aW5kb3cuZmx1eC5QcmFjdGljZU1hbmFnZXIgPSBQcmFjdGljZU1hbmFnZXI7Cn0pKCk7","WaterOverlay.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gSGlnaC1RdWFsaXR5IE5vaXNlIFRleHR1cmUgR2VuZXJhdG9yIC0tLQogICAgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBzaXplID0gNTEyOwogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gc2l6ZTsgYy5oZWlnaHQgPSBzaXplOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMwMDAwMDAnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzaXplLCBzaXplKTsKICAgICAgICAKICAgICAgICAvLyBHZW5lcmF0ZSBzZWFtbGVzcyBub2lzZSAoUGVybGluLWlzaCB2aWEgbGF5ZXJlZCByYW5kb20gY2lyY2xlcy9ncmFkaWVudHMpCiAgICAgICAgY29uc3QgZHJhd05vaXNlTGF5ZXIgPSAoc2NhbGUsIGFscGhhKSA9PiB7CiAgICAgICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IGFscGhhOwogICAgICAgICAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ2xpZ2h0ZXInOyAvLyBBZGRpdGl2ZQogICAgICAgICAgICBjb25zdCBjb3VudCA9IDMwMCAqIHNjYWxlOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCByID0gKE1hdGgucmFuZG9tKCkgKiAzMCArIDEwKSAvIHNjYWxlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgsIHksIDAsIHgsIHksIHIpOwogICAgICAgICAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJyM4ODg4ODgnKTsKICAgICAgICAgICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICd0cmFuc3BhcmVudCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyh4LCB5LCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBXcmFwIGFyb3VuZCBmb3Igc2VhbWxlc3MgdGlsaW5nCiAgICAgICAgICAgICAgICBbW3gtc2l6ZSwgeV0sIFt4K3NpemUsIHldLCBbeCwgeS1zaXplXSwgW3gsIHkrc2l6ZV1dLmZvckVhY2gocG9zID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnMiA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChwb3NbMF0sIHBvc1sxXSwgMCwgcG9zWzBdLCBwb3NbMV0sIHIpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgwLCAnIzg4ODg4OCcpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgxLCAndHJhbnNwYXJlbnQnKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzI7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKHBvc1swXSwgcG9zWzFdLCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIAogICAgICAgIGRyYXdOb2lzZUxheWVyKDEuMCwgMC4zKTsKICAgICAgICBkcmF3Tm9pc2VMYXllcigyLjAsIDAuMik7CiAgICAgICAgZHJhd05vaXNlTGF5ZXIoNC4wLCAwLjEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9KSgpOwoKICAgIGNsYXNzIFdhdGVyT3ZlcmxheSB7CiAgICAgICAgY29uc3RydWN0b3IoY2FtZXJhKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVsbHNjcmVlbiBxdWFkCiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMik7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CgogICAgICAgICAgICBjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHROb2lzZTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CgogICAgICAgICAgICAgICAgLy8gRkZYIFBhbGV0dGUgKEFkZGl0aXZlIEZyaWVuZGx5KQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0RFRVAgPSB2ZWMzKDAuMCwgMC4wNSwgMC4yKTsgICAgIC8vIERlZXAgQmx1ZQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0dMT1cgPSB2ZWMzKDAuMCwgMC42LCAwLjkpOyAgICAgIC8vIEN5YW4gR2xvdwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1JBWSAgPSB2ZWMzKDAuNSwgMC44LCAxLjApOyAgICAgIC8vIExpZ2h0IFNoYWZ0cwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1BZUkUgPSB2ZWMzKDEuMCwgMC44NSwgMC41KTsgICAgIC8vIFB5cmVmbHkgR29sZAoKICAgICAgICAgICAgICAgIC8vIDR4NCBCYXllciBNYXRyaXggZm9yIE9yZGVyZWQgRGl0aGVyaW5nCiAgICAgICAgICAgICAgICBmbG9hdCBiYXllcjR4NCh2ZWMyIHV2KSB7CiAgICAgICAgICAgICAgICAgICAgaW50IHggPSBpbnQobW9kKHV2LngsIDQuMCkpOwogICAgICAgICAgICAgICAgICAgIGludCB5ID0gaW50KG1vZCh1di55LCA0LjApKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB2ID0gMC4wOwogICAgICAgICAgICAgICAgICAgIGlmICh5ID09IDApIHsgaWYgKHggPT0gMCkgdiA9IDAuMDsgZWxzZSBpZiAoeCA9PSAxKSB2ID0gOC4wOyBlbHNlIGlmICh4ID09IDIpIHYgPSAyLjA7IGVsc2UgdiA9IDEwLjA7IH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh5ID09IDEpIHsgaWYgKHggPT0gMCkgdiA9IDEyLjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDQuMDsgZWxzZSBpZiAoeCA9PSAyKSB2ID0gMTQuMDsgZWxzZSB2ID0gNi4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAyKSB7IGlmICh4ID09IDApIHYgPSAzLjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDExLjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDEuMDsgZWxzZSB2ID0gOS4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7IGlmICh4ID09IDApIHYgPSAxNS4wOyBlbHNlIGlmICh4ID09IDEpIHYgPSA3LjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDEzLjA7IGVsc2UgdiA9IDUuMDsgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB2IC8gMTYuMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjMiB1diA9IHZVdjsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB0ID0gdVRpbWUgKiAwLjEyOwoKICAgICAgICAgICAgICAgICAgICAvLyAxLiBEaXN0b3J0aW9uIChMb29rdXAgMSkKICAgICAgICAgICAgICAgICAgICBmbG9hdCB3YXJwID0gdGV4dHVyZTJEKHROb2lzZSwgdXYgKiAwLjQgKyB2ZWMyKHQgKiAwLjA0LCB0ICogMC4wMikpLnI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gQ2F1c3RpY3MgKExvb2t1cCAyKQogICAgICAgICAgICAgICAgICAgIHZlYzIgY1VWID0gdXYgKiAyLjAgKyB2ZWMyKHdhcnAgKiAwLjUsIHdhcnAgKiAwLjIpIC0gdmVjMih0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYyA9IHRleHR1cmUyRCh0Tm9pc2UsIGNVVikucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjID0gKGMgLSAwLjQpICogMi41OwogICAgICAgICAgICAgICAgICAgIGMgPSBtYXgoMC4wLCBjKTsKICAgICAgICAgICAgICAgICAgICBjID0gcG93KGMsIDMuMCk7IC8vIFNoYXJwZXIgY2F1c3RpY3MKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCBjYXVzdGljID0gYyAqIDEwLjA7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBjYXVzdGljQ29sb3IgPSB2ZWMzKGNhdXN0aWMgKiAwLjcsIGNhdXN0aWMsIGNhdXN0aWMgKiAxLjMpOwoKICAgICAgICAgICAgICAgICAgICAvLyAzLiBSYXlzIChMb29rdXAgMykKICAgICAgICAgICAgICAgICAgICB2ZWMyIHJheVVWID0gdmVjMih1di54ICsgd2FycCAqIDAuMSwgdXYueSAqIDAuMTUgLSB0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgcmF5cyA9IHRleHR1cmUyRCh0Tm9pc2UsIHJheVVWKS5yOwogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogcmF5czsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYXlNYXNrID0gMS4wIC0gYWJzKHV2LnkgKiAyLjAgLSAxLjApOwogICAgICAgICAgICAgICAgICAgIHJheXMgKj0gbWF4KDAuMCwgcmF5TWFzayk7CgogICAgICAgICAgICAgICAgICAgIC8vIDQuIFB5cmVmbGllcwogICAgICAgICAgICAgICAgICAgIHZlYzIgcCA9IHV2ICogNi4wOwogICAgICAgICAgICAgICAgICAgIHZlYzIgaWQgPSBmbG9vcihwKTsKICAgICAgICAgICAgICAgICAgICB2ZWMyIHN1YiA9IGZyYWN0KHApIC0gMC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4gPSBmcmFjdChzaW4oZG90KGlkLCB2ZWMyKDEyLjk4OTgsIDc4LjIzMykpKSAqIDQzNzU4LjU0NTMpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHB4ID0gZnJhY3QobiAqIDEzLjAgKyB0ICogMC4zKSAtIDAuNTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBweSA9IGZyYWN0KG4gKiA3LjAgKyB0ICogMC4yKSAtIDAuNTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB2ZWMyIGZseVBvcyA9IHZlYzIocHgsIHB5KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkMiA9IGRvdChzdWIgLSBmbHlQb3MsIHN1YiAtIGZseVBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZmx5ID0gMC4wMDA2IC8gKGQyICsgMC4wMDA1KTsKICAgICAgICAgICAgICAgICAgICBmbHkgKj0gc3RlcCgwLjYsIG4pOyAKICAgICAgICAgICAgICAgICAgICBmbHkgKj0gMC41ICsgMC41ICogc2luKHQgKiA1LjAgKyBuICogMTAuMCk7CgogICAgICAgICAgICAgICAgICAgIC8vIENvbXBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgdmVjMyBmaW5hbENvbCA9IHZlYzMoMC4wKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gVmlnbmV0dGUKICAgICAgICAgICAgICAgICAgICB2ZWMyIHZkID0gdXYgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdlNxID0gZG90KHZkLCB2ZCk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdmlnID0gdlNxICogMS41OyAKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBDX0RFRVAgKiB2aWc7CgogICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sICs9IGNhdXN0aWNDb2xvciAqIENfR0xPVyAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSByYXlzICogQ19SQVkgKiAwLjQ7CiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gZmx5ICogQ19QWVJFOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gUFNYIERJVEhFUklORyAmIFFVQU5USVpBVElPTiAtLS0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAxLiBHZXQgRGl0aGVyIFZhbHVlIChTY3JlZW4gU3BhY2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGl0aGVyID0gYmF5ZXI0eDQoZ2xfRnJhZ0Nvb3JkLnh5KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAyLiBDb2xvciBEZXB0aCBSZWR1Y3Rpb24gKGUuZy4gMzIgbGV2ZWxzID0gNSBiaXQpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgY29sb3JEZXB0aCA9IDMyLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMy4gQXBwbHkgRGl0aGVyIHRvIENvbG9yCiAgICAgICAgICAgICAgICAgICAgLy8gV2UgYWRkIG5vaXNlIGJlZm9yZSBxdWFudGl6YXRpb24gdG8gc21vb3RoIGJhbmRzCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIG1hZ25pdHVkZSBpcyAxL0RlcHRoIGNlbnRlcmVkIGFyb3VuZCAwCiAgICAgICAgICAgICAgICAgICAgdmVjMyBkaXRoZXJlZCA9IGZpbmFsQ29sICsgKGRpdGhlciAtIDAuNSkgKiAoMS4wIC8gY29sb3JEZXB0aCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gNC4gUXVhbnRpemUKICAgICAgICAgICAgICAgICAgICBkaXRoZXJlZCA9IGZsb29yKGRpdGhlcmVkICogY29sb3JEZXB0aCkgLyBjb2xvckRlcHRoOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDUuIERpdGhlcmVkIEFscGhhL0ludGVuc2l0eQogICAgICAgICAgICAgICAgICAgIC8vIEluc3RlYWQgb2Ygc2ltcGxlIGFscGhhIGJsZW5kaW5nLCB3ZSBjYW4gdXNlIGRpdGhlciB0byBicmVhayB1cCBmYWludCBkZXRhaWxzCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBnaXZlcyB0aGF0ICJjcnVuY2h5IiBsb29rIGluIGRhcmsgYXJlYXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBpbnRlbnNpdHkgPSBsZW5ndGgoZGl0aGVyZWQpOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IHNoYWRvd3Mgd2l0aCBkaXRoZXIgbm9pc2UKICAgICAgICAgICAgICAgICAgICBkaXRoZXJlZCArPSAoZGl0aGVyIC0gMC41KSAqIDAuMDI7CgogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoZGl0aGVyZWQsIHVPcGFjaXR5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9LAogICAgICAgICAgICAgICAgICAgIHVPcGFjaXR5OiB7IHZhbHVlOiAwLjUgfSwKICAgICAgICAgICAgICAgICAgICB0Tm9pc2U6IHsgdmFsdWU6IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZSB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiB2ZXJ0LAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGZyYWcsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIGRlcHRoVGVzdDogZmFsc2UsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nIC8vIEFkZGl0aXZlIGJsZW5kaW5nIHByZXZlbnRzIGRhcmsgb2NjbHVzaW9uCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSA5OTk5OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQWRkIHRvIGNhbWVyYSBzbyBpdCBzdGF5cyBvbiBzY3JlZW4KICAgICAgICAgICAgdGhpcy5jYW1lcmEuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgdGhpcy5tYXRlcmlhbC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIAogICAgd2luZG93LmZsdXguV2F0ZXJPdmVybGF5ID0gV2F0ZXJPdmVybGF5Owp9KSgpOw==","./WaterOverlay.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gSGlnaC1RdWFsaXR5IE5vaXNlIFRleHR1cmUgR2VuZXJhdG9yIC0tLQogICAgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBzaXplID0gNTEyOwogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gc2l6ZTsgYy5oZWlnaHQgPSBzaXplOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMwMDAwMDAnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzaXplLCBzaXplKTsKICAgICAgICAKICAgICAgICAvLyBHZW5lcmF0ZSBzZWFtbGVzcyBub2lzZSAoUGVybGluLWlzaCB2aWEgbGF5ZXJlZCByYW5kb20gY2lyY2xlcy9ncmFkaWVudHMpCiAgICAgICAgY29uc3QgZHJhd05vaXNlTGF5ZXIgPSAoc2NhbGUsIGFscGhhKSA9PiB7CiAgICAgICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IGFscGhhOwogICAgICAgICAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ2xpZ2h0ZXInOyAvLyBBZGRpdGl2ZQogICAgICAgICAgICBjb25zdCBjb3VudCA9IDMwMCAqIHNjYWxlOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCByID0gKE1hdGgucmFuZG9tKCkgKiAzMCArIDEwKSAvIHNjYWxlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgsIHksIDAsIHgsIHksIHIpOwogICAgICAgICAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJyM4ODg4ODgnKTsKICAgICAgICAgICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICd0cmFuc3BhcmVudCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyh4LCB5LCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBXcmFwIGFyb3VuZCBmb3Igc2VhbWxlc3MgdGlsaW5nCiAgICAgICAgICAgICAgICBbW3gtc2l6ZSwgeV0sIFt4K3NpemUsIHldLCBbeCwgeS1zaXplXSwgW3gsIHkrc2l6ZV1dLmZvckVhY2gocG9zID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnMiA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChwb3NbMF0sIHBvc1sxXSwgMCwgcG9zWzBdLCBwb3NbMV0sIHIpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgwLCAnIzg4ODg4OCcpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgxLCAndHJhbnNwYXJlbnQnKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzI7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKHBvc1swXSwgcG9zWzFdLCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIAogICAgICAgIGRyYXdOb2lzZUxheWVyKDEuMCwgMC4zKTsKICAgICAgICBkcmF3Tm9pc2VMYXllcigyLjAsIDAuMik7CiAgICAgICAgZHJhd05vaXNlTGF5ZXIoNC4wLCAwLjEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9KSgpOwoKICAgIGNsYXNzIFdhdGVyT3ZlcmxheSB7CiAgICAgICAgY29uc3RydWN0b3IoY2FtZXJhKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVsbHNjcmVlbiBxdWFkCiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMik7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CgogICAgICAgICAgICBjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHROb2lzZTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CgogICAgICAgICAgICAgICAgLy8gRkZYIFBhbGV0dGUgKEFkZGl0aXZlIEZyaWVuZGx5KQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0RFRVAgPSB2ZWMzKDAuMCwgMC4wNSwgMC4yKTsgICAgIC8vIERlZXAgQmx1ZQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0dMT1cgPSB2ZWMzKDAuMCwgMC42LCAwLjkpOyAgICAgIC8vIEN5YW4gR2xvdwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1JBWSAgPSB2ZWMzKDAuNSwgMC44LCAxLjApOyAgICAgIC8vIExpZ2h0IFNoYWZ0cwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1BZUkUgPSB2ZWMzKDEuMCwgMC44NSwgMC41KTsgICAgIC8vIFB5cmVmbHkgR29sZAoKICAgICAgICAgICAgICAgIC8vIDR4NCBCYXllciBNYXRyaXggZm9yIE9yZGVyZWQgRGl0aGVyaW5nCiAgICAgICAgICAgICAgICBmbG9hdCBiYXllcjR4NCh2ZWMyIHV2KSB7CiAgICAgICAgICAgICAgICAgICAgaW50IHggPSBpbnQobW9kKHV2LngsIDQuMCkpOwogICAgICAgICAgICAgICAgICAgIGludCB5ID0gaW50KG1vZCh1di55LCA0LjApKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB2ID0gMC4wOwogICAgICAgICAgICAgICAgICAgIGlmICh5ID09IDApIHsgaWYgKHggPT0gMCkgdiA9IDAuMDsgZWxzZSBpZiAoeCA9PSAxKSB2ID0gOC4wOyBlbHNlIGlmICh4ID09IDIpIHYgPSAyLjA7IGVsc2UgdiA9IDEwLjA7IH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh5ID09IDEpIHsgaWYgKHggPT0gMCkgdiA9IDEyLjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDQuMDsgZWxzZSBpZiAoeCA9PSAyKSB2ID0gMTQuMDsgZWxzZSB2ID0gNi4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAyKSB7IGlmICh4ID09IDApIHYgPSAzLjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDExLjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDEuMDsgZWxzZSB2ID0gOS4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7IGlmICh4ID09IDApIHYgPSAxNS4wOyBlbHNlIGlmICh4ID09IDEpIHYgPSA3LjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDEzLjA7IGVsc2UgdiA9IDUuMDsgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB2IC8gMTYuMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjMiB1diA9IHZVdjsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB0ID0gdVRpbWUgKiAwLjEyOwoKICAgICAgICAgICAgICAgICAgICAvLyAxLiBEaXN0b3J0aW9uIChMb29rdXAgMSkKICAgICAgICAgICAgICAgICAgICBmbG9hdCB3YXJwID0gdGV4dHVyZTJEKHROb2lzZSwgdXYgKiAwLjQgKyB2ZWMyKHQgKiAwLjA0LCB0ICogMC4wMikpLnI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gQ2F1c3RpY3MgKExvb2t1cCAyKQogICAgICAgICAgICAgICAgICAgIHZlYzIgY1VWID0gdXYgKiAyLjAgKyB2ZWMyKHdhcnAgKiAwLjUsIHdhcnAgKiAwLjIpIC0gdmVjMih0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYyA9IHRleHR1cmUyRCh0Tm9pc2UsIGNVVikucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjID0gKGMgLSAwLjQpICogMi41OwogICAgICAgICAgICAgICAgICAgIGMgPSBtYXgoMC4wLCBjKTsKICAgICAgICAgICAgICAgICAgICBjID0gcG93KGMsIDMuMCk7IC8vIFNoYXJwZXIgY2F1c3RpY3MKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCBjYXVzdGljID0gYyAqIDEwLjA7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBjYXVzdGljQ29sb3IgPSB2ZWMzKGNhdXN0aWMgKiAwLjcsIGNhdXN0aWMsIGNhdXN0aWMgKiAxLjMpOwoKICAgICAgICAgICAgICAgICAgICAvLyAzLiBSYXlzIChMb29rdXAgMykKICAgICAgICAgICAgICAgICAgICB2ZWMyIHJheVVWID0gdmVjMih1di54ICsgd2FycCAqIDAuMSwgdXYueSAqIDAuMTUgLSB0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgcmF5cyA9IHRleHR1cmUyRCh0Tm9pc2UsIHJheVVWKS5yOwogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogcmF5czsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYXlNYXNrID0gMS4wIC0gYWJzKHV2LnkgKiAyLjAgLSAxLjApOwogICAgICAgICAgICAgICAgICAgIHJheXMgKj0gbWF4KDAuMCwgcmF5TWFzayk7CgogICAgICAgICAgICAgICAgICAgIC8vIDQuIFB5cmVmbGllcwogICAgICAgICAgICAgICAgICAgIHZlYzIgcCA9IHV2ICogNi4wOwogICAgICAgICAgICAgICAgICAgIHZlYzIgaWQgPSBmbG9vcihwKTsKICAgICAgICAgICAgICAgICAgICB2ZWMyIHN1YiA9IGZyYWN0KHApIC0gMC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4gPSBmcmFjdChzaW4oZG90KGlkLCB2ZWMyKDEyLjk4OTgsIDc4LjIzMykpKSAqIDQzNzU4LjU0NTMpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHB4ID0gZnJhY3QobiAqIDEzLjAgKyB0ICogMC4zKSAtIDAuNTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBweSA9IGZyYWN0KG4gKiA3LjAgKyB0ICogMC4yKSAtIDAuNTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB2ZWMyIGZseVBvcyA9IHZlYzIocHgsIHB5KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkMiA9IGRvdChzdWIgLSBmbHlQb3MsIHN1YiAtIGZseVBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZmx5ID0gMC4wMDA2IC8gKGQyICsgMC4wMDA1KTsKICAgICAgICAgICAgICAgICAgICBmbHkgKj0gc3RlcCgwLjYsIG4pOyAKICAgICAgICAgICAgICAgICAgICBmbHkgKj0gMC41ICsgMC41ICogc2luKHQgKiA1LjAgKyBuICogMTAuMCk7CgogICAgICAgICAgICAgICAgICAgIC8vIENvbXBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgdmVjMyBmaW5hbENvbCA9IHZlYzMoMC4wKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gVmlnbmV0dGUKICAgICAgICAgICAgICAgICAgICB2ZWMyIHZkID0gdXYgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdlNxID0gZG90KHZkLCB2ZCk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdmlnID0gdlNxICogMS41OyAKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBDX0RFRVAgKiB2aWc7CgogICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sICs9IGNhdXN0aWNDb2xvciAqIENfR0xPVyAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSByYXlzICogQ19SQVkgKiAwLjQ7CiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gZmx5ICogQ19QWVJFOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gUFNYIERJVEhFUklORyAmIFFVQU5USVpBVElPTiAtLS0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAxLiBHZXQgRGl0aGVyIFZhbHVlIChTY3JlZW4gU3BhY2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGl0aGVyID0gYmF5ZXI0eDQoZ2xfRnJhZ0Nvb3JkLnh5KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAyLiBDb2xvciBEZXB0aCBSZWR1Y3Rpb24gKGUuZy4gMzIgbGV2ZWxzID0gNSBiaXQpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgY29sb3JEZXB0aCA9IDMyLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMy4gQXBwbHkgRGl0aGVyIHRvIENvbG9yCiAgICAgICAgICAgICAgICAgICAgLy8gV2UgYWRkIG5vaXNlIGJlZm9yZSBxdWFudGl6YXRpb24gdG8gc21vb3RoIGJhbmRzCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIG1hZ25pdHVkZSBpcyAxL0RlcHRoIGNlbnRlcmVkIGFyb3VuZCAwCiAgICAgICAgICAgICAgICAgICAgdmVjMyBkaXRoZXJlZCA9IGZpbmFsQ29sICsgKGRpdGhlciAtIDAuNSkgKiAoMS4wIC8gY29sb3JEZXB0aCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gNC4gUXVhbnRpemUKICAgICAgICAgICAgICAgICAgICBkaXRoZXJlZCA9IGZsb29yKGRpdGhlcmVkICogY29sb3JEZXB0aCkgLyBjb2xvckRlcHRoOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDUuIERpdGhlcmVkIEFscGhhL0ludGVuc2l0eQogICAgICAgICAgICAgICAgICAgIC8vIEluc3RlYWQgb2Ygc2ltcGxlIGFscGhhIGJsZW5kaW5nLCB3ZSBjYW4gdXNlIGRpdGhlciB0byBicmVhayB1cCBmYWludCBkZXRhaWxzCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBnaXZlcyB0aGF0ICJjcnVuY2h5IiBsb29rIGluIGRhcmsgYXJlYXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBpbnRlbnNpdHkgPSBsZW5ndGgoZGl0aGVyZWQpOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IHNoYWRvd3Mgd2l0aCBkaXRoZXIgbm9pc2UKICAgICAgICAgICAgICAgICAgICBkaXRoZXJlZCArPSAoZGl0aGVyIC0gMC41KSAqIDAuMDI7CgogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoZGl0aGVyZWQsIHVPcGFjaXR5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9LAogICAgICAgICAgICAgICAgICAgIHVPcGFjaXR5OiB7IHZhbHVlOiAwLjUgfSwKICAgICAgICAgICAgICAgICAgICB0Tm9pc2U6IHsgdmFsdWU6IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZSB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiB2ZXJ0LAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGZyYWcsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIGRlcHRoVGVzdDogZmFsc2UsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nIC8vIEFkZGl0aXZlIGJsZW5kaW5nIHByZXZlbnRzIGRhcmsgb2NjbHVzaW9uCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSA5OTk5OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQWRkIHRvIGNhbWVyYSBzbyBpdCBzdGF5cyBvbiBzY3JlZW4KICAgICAgICAgICAgdGhpcy5jYW1lcmEuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgdGhpcy5tYXRlcmlhbC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIAogICAgd2luZG93LmZsdXguV2F0ZXJPdmVybGF5ID0gV2F0ZXJPdmVybGF5Owp9KSgpOw==","/WaterOverlay.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gSGlnaC1RdWFsaXR5IE5vaXNlIFRleHR1cmUgR2VuZXJhdG9yIC0tLQogICAgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBzaXplID0gNTEyOwogICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjLndpZHRoID0gc2l6ZTsgYy5oZWlnaHQgPSBzaXplOwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAKICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMwMDAwMDAnOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzaXplLCBzaXplKTsKICAgICAgICAKICAgICAgICAvLyBHZW5lcmF0ZSBzZWFtbGVzcyBub2lzZSAoUGVybGluLWlzaCB2aWEgbGF5ZXJlZCByYW5kb20gY2lyY2xlcy9ncmFkaWVudHMpCiAgICAgICAgY29uc3QgZHJhd05vaXNlTGF5ZXIgPSAoc2NhbGUsIGFscGhhKSA9PiB7CiAgICAgICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IGFscGhhOwogICAgICAgICAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ2xpZ2h0ZXInOyAvLyBBZGRpdGl2ZQogICAgICAgICAgICBjb25zdCBjb3VudCA9IDMwMCAqIHNjYWxlOwogICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCB5ID0gTWF0aC5yYW5kb20oKSAqIHNpemU7CiAgICAgICAgICAgICAgICBjb25zdCByID0gKE1hdGgucmFuZG9tKCkgKiAzMCArIDEwKSAvIHNjYWxlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgsIHksIDAsIHgsIHksIHIpOwogICAgICAgICAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJyM4ODg4ODgnKTsKICAgICAgICAgICAgICAgIGcuYWRkQ29sb3JTdG9wKDEsICd0cmFuc3BhcmVudCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4LmFyYyh4LCB5LCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBXcmFwIGFyb3VuZCBmb3Igc2VhbWxlc3MgdGlsaW5nCiAgICAgICAgICAgICAgICBbW3gtc2l6ZSwgeV0sIFt4K3NpemUsIHldLCBbeCwgeS1zaXplXSwgW3gsIHkrc2l6ZV1dLmZvckVhY2gocG9zID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBnMiA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChwb3NbMF0sIHBvc1sxXSwgMCwgcG9zWzBdLCBwb3NbMV0sIHIpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgwLCAnIzg4ODg4OCcpOwogICAgICAgICAgICAgICAgICAgIGcyLmFkZENvbG9yU3RvcCgxLCAndHJhbnNwYXJlbnQnKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZzI7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKHBvc1swXSwgcG9zWzFdLCByLCAwLCBNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIAogICAgICAgIGRyYXdOb2lzZUxheWVyKDEuMCwgMC4zKTsKICAgICAgICBkcmF3Tm9pc2VMYXllcigyLjAsIDAuMik7CiAgICAgICAgZHJhd05vaXNlTGF5ZXIoNC4wLCAwLjEpOwogICAgICAgIAogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHRleC53cmFwUyA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9KSgpOwoKICAgIGNsYXNzIFdhdGVyT3ZlcmxheSB7CiAgICAgICAgY29uc3RydWN0b3IoY2FtZXJhKSB7CiAgICAgICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnVsbHNjcmVlbiBxdWFkCiAgICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwgMik7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB2ZXJ0ID0gYAogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CgogICAgICAgICAgICBjb25zdCBmcmFnID0gYAogICAgICAgICAgICAgICAgcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7CiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB1T3BhY2l0eTsKICAgICAgICAgICAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHROb2lzZTsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CgogICAgICAgICAgICAgICAgLy8gRkZYIFBhbGV0dGUgKEFkZGl0aXZlIEZyaWVuZGx5KQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0RFRVAgPSB2ZWMzKDAuMCwgMC4wNSwgMC4yKTsgICAgIC8vIERlZXAgQmx1ZQogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX0dMT1cgPSB2ZWMzKDAuMCwgMC42LCAwLjkpOyAgICAgIC8vIEN5YW4gR2xvdwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1JBWSAgPSB2ZWMzKDAuNSwgMC44LCAxLjApOyAgICAgIC8vIExpZ2h0IFNoYWZ0cwogICAgICAgICAgICAgICAgY29uc3QgdmVjMyBDX1BZUkUgPSB2ZWMzKDEuMCwgMC44NSwgMC41KTsgICAgIC8vIFB5cmVmbHkgR29sZAoKICAgICAgICAgICAgICAgIC8vIDR4NCBCYXllciBNYXRyaXggZm9yIE9yZGVyZWQgRGl0aGVyaW5nCiAgICAgICAgICAgICAgICBmbG9hdCBiYXllcjR4NCh2ZWMyIHV2KSB7CiAgICAgICAgICAgICAgICAgICAgaW50IHggPSBpbnQobW9kKHV2LngsIDQuMCkpOwogICAgICAgICAgICAgICAgICAgIGludCB5ID0gaW50KG1vZCh1di55LCA0LjApKTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB2ID0gMC4wOwogICAgICAgICAgICAgICAgICAgIGlmICh5ID09IDApIHsgaWYgKHggPT0gMCkgdiA9IDAuMDsgZWxzZSBpZiAoeCA9PSAxKSB2ID0gOC4wOyBlbHNlIGlmICh4ID09IDIpIHYgPSAyLjA7IGVsc2UgdiA9IDEwLjA7IH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh5ID09IDEpIHsgaWYgKHggPT0gMCkgdiA9IDEyLjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDQuMDsgZWxzZSBpZiAoeCA9PSAyKSB2ID0gMTQuMDsgZWxzZSB2ID0gNi4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeSA9PSAyKSB7IGlmICh4ID09IDApIHYgPSAzLjA7IGVsc2UgaWYgKHggPT0gMSkgdiA9IDExLjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDEuMDsgZWxzZSB2ID0gOS4wOyB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7IGlmICh4ID09IDApIHYgPSAxNS4wOyBlbHNlIGlmICh4ID09IDEpIHYgPSA3LjA7IGVsc2UgaWYgKHggPT0gMikgdiA9IDEzLjA7IGVsc2UgdiA9IDUuMDsgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB2IC8gMTYuMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2b2lkIG1haW4oKSB7CiAgICAgICAgICAgICAgICAgICAgdmVjMiB1diA9IHZVdjsKICAgICAgICAgICAgICAgICAgICBmbG9hdCB0ID0gdVRpbWUgKiAwLjEyOwoKICAgICAgICAgICAgICAgICAgICAvLyAxLiBEaXN0b3J0aW9uIChMb29rdXAgMSkKICAgICAgICAgICAgICAgICAgICBmbG9hdCB3YXJwID0gdGV4dHVyZTJEKHROb2lzZSwgdXYgKiAwLjQgKyB2ZWMyKHQgKiAwLjA0LCB0ICogMC4wMikpLnI7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gQ2F1c3RpY3MgKExvb2t1cCAyKQogICAgICAgICAgICAgICAgICAgIHZlYzIgY1VWID0gdXYgKiAyLjAgKyB2ZWMyKHdhcnAgKiAwLjUsIHdhcnAgKiAwLjIpIC0gdmVjMih0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgYyA9IHRleHR1cmUyRCh0Tm9pc2UsIGNVVikucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjID0gKGMgLSAwLjQpICogMi41OwogICAgICAgICAgICAgICAgICAgIGMgPSBtYXgoMC4wLCBjKTsKICAgICAgICAgICAgICAgICAgICBjID0gcG93KGMsIDMuMCk7IC8vIFNoYXJwZXIgY2F1c3RpY3MKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCBjYXVzdGljID0gYyAqIDEwLjA7CiAgICAgICAgICAgICAgICAgICAgdmVjMyBjYXVzdGljQ29sb3IgPSB2ZWMzKGNhdXN0aWMgKiAwLjcsIGNhdXN0aWMsIGNhdXN0aWMgKiAxLjMpOwoKICAgICAgICAgICAgICAgICAgICAvLyAzLiBSYXlzIChMb29rdXAgMykKICAgICAgICAgICAgICAgICAgICB2ZWMyIHJheVVWID0gdmVjMih1di54ICsgd2FycCAqIDAuMSwgdXYueSAqIDAuMTUgLSB0ICogMC4wNSk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgcmF5cyA9IHRleHR1cmUyRCh0Tm9pc2UsIHJheVVWKS5yOwogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogcmF5czsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmbG9hdCByYXlNYXNrID0gMS4wIC0gYWJzKHV2LnkgKiAyLjAgLSAxLjApOwogICAgICAgICAgICAgICAgICAgIHJheXMgKj0gbWF4KDAuMCwgcmF5TWFzayk7CgogICAgICAgICAgICAgICAgICAgIC8vIDQuIFB5cmVmbGllcwogICAgICAgICAgICAgICAgICAgIHZlYzIgcCA9IHV2ICogNi4wOwogICAgICAgICAgICAgICAgICAgIHZlYzIgaWQgPSBmbG9vcihwKTsKICAgICAgICAgICAgICAgICAgICB2ZWMyIHN1YiA9IGZyYWN0KHApIC0gMC41OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4gPSBmcmFjdChzaW4oZG90KGlkLCB2ZWMyKDEyLjk4OTgsIDc4LjIzMykpKSAqIDQzNzU4LjU0NTMpOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHB4ID0gZnJhY3QobiAqIDEzLjAgKyB0ICogMC4zKSAtIDAuNTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBweSA9IGZyYWN0KG4gKiA3LjAgKyB0ICogMC4yKSAtIDAuNTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB2ZWMyIGZseVBvcyA9IHZlYzIocHgsIHB5KTsKICAgICAgICAgICAgICAgICAgICBmbG9hdCBkMiA9IGRvdChzdWIgLSBmbHlQb3MsIHN1YiAtIGZseVBvcyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZmx5ID0gMC4wMDA2IC8gKGQyICsgMC4wMDA1KTsKICAgICAgICAgICAgICAgICAgICBmbHkgKj0gc3RlcCgwLjYsIG4pOyAKICAgICAgICAgICAgICAgICAgICBmbHkgKj0gMC41ICsgMC41ICogc2luKHQgKiA1LjAgKyBuICogMTAuMCk7CgogICAgICAgICAgICAgICAgICAgIC8vIENvbXBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgdmVjMyBmaW5hbENvbCA9IHZlYzMoMC4wKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gVmlnbmV0dGUKICAgICAgICAgICAgICAgICAgICB2ZWMyIHZkID0gdXYgLSAwLjU7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdlNxID0gZG90KHZkLCB2ZCk7CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgdmlnID0gdlNxICogMS41OyAKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSBDX0RFRVAgKiB2aWc7CgogICAgICAgICAgICAgICAgICAgIGZpbmFsQ29sICs9IGNhdXN0aWNDb2xvciAqIENfR0xPVyAqIDAuNTsKICAgICAgICAgICAgICAgICAgICBmaW5hbENvbCArPSByYXlzICogQ19SQVkgKiAwLjQ7CiAgICAgICAgICAgICAgICAgICAgZmluYWxDb2wgKz0gZmx5ICogQ19QWVJFOwoKICAgICAgICAgICAgICAgICAgICAvLyAtLS0gUFNYIERJVEhFUklORyAmIFFVQU5USVpBVElPTiAtLS0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAxLiBHZXQgRGl0aGVyIFZhbHVlIChTY3JlZW4gU3BhY2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgZGl0aGVyID0gYmF5ZXI0eDQoZ2xfRnJhZ0Nvb3JkLnh5KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAyLiBDb2xvciBEZXB0aCBSZWR1Y3Rpb24gKGUuZy4gMzIgbGV2ZWxzID0gNSBiaXQpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgY29sb3JEZXB0aCA9IDMyLjA7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gMy4gQXBwbHkgRGl0aGVyIHRvIENvbG9yCiAgICAgICAgICAgICAgICAgICAgLy8gV2UgYWRkIG5vaXNlIGJlZm9yZSBxdWFudGl6YXRpb24gdG8gc21vb3RoIGJhbmRzCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIG1hZ25pdHVkZSBpcyAxL0RlcHRoIGNlbnRlcmVkIGFyb3VuZCAwCiAgICAgICAgICAgICAgICAgICAgdmVjMyBkaXRoZXJlZCA9IGZpbmFsQ29sICsgKGRpdGhlciAtIDAuNSkgKiAoMS4wIC8gY29sb3JEZXB0aCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gNC4gUXVhbnRpemUKICAgICAgICAgICAgICAgICAgICBkaXRoZXJlZCA9IGZsb29yKGRpdGhlcmVkICogY29sb3JEZXB0aCkgLyBjb2xvckRlcHRoOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIDUuIERpdGhlcmVkIEFscGhhL0ludGVuc2l0eQogICAgICAgICAgICAgICAgICAgIC8vIEluc3RlYWQgb2Ygc2ltcGxlIGFscGhhIGJsZW5kaW5nLCB3ZSBjYW4gdXNlIGRpdGhlciB0byBicmVhayB1cCBmYWludCBkZXRhaWxzCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBnaXZlcyB0aGF0ICJjcnVuY2h5IiBsb29rIGluIGRhcmsgYXJlYXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBpbnRlbnNpdHkgPSBsZW5ndGgoZGl0aGVyZWQpOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IHNoYWRvd3Mgd2l0aCBkaXRoZXIgbm9pc2UKICAgICAgICAgICAgICAgICAgICBkaXRoZXJlZCArPSAoZGl0aGVyIC0gMC41KSAqIDAuMDI7CgogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoZGl0aGVyZWQsIHVPcGFjaXR5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIHRoaXMubWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgICAgICAgICAgICB1VGltZTogeyB2YWx1ZTogMCB9LAogICAgICAgICAgICAgICAgICAgIHVPcGFjaXR5OiB7IHZhbHVlOiAwLjUgfSwKICAgICAgICAgICAgICAgICAgICB0Tm9pc2U6IHsgdmFsdWU6IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZSB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVydGV4U2hhZGVyOiB2ZXJ0LAogICAgICAgICAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGZyYWcsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwKICAgICAgICAgICAgICAgIGRlcHRoVGVzdDogZmFsc2UsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nIC8vIEFkZGl0aXZlIGJsZW5kaW5nIHByZXZlbnRzIGRhcmsgb2NjbHVzaW9uCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5tZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2guZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSA5OTk5OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQWRkIHRvIGNhbWVyYSBzbyBpdCBzdGF5cyBvbiBzY3JlZW4KICAgICAgICAgICAgdGhpcy5jYW1lcmEuYWRkKHRoaXMubWVzaCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVwZGF0ZShkdCkgewogICAgICAgICAgICBpZiAodGhpcy5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgdGhpcy5tYXRlcmlhbC51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIAogICAgd2luZG93LmZsdXguV2F0ZXJPdmVybGF5ID0gV2F0ZXJPdmVybGF5Owp9KSgpOw==","GlyphManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUSU9OIC0tLQogICAgY29uc3QgX2NyZWF0ZUdseXBoVGV4dHVyZSA9IChjb2xvclN0ciwgdHlwZSkgPT4gewogICAgICAgIGNvbnN0IHNpemUgPSAyNTY7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSBzaXplOyBjLmhlaWdodCA9IHNpemU7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgc2l6ZSwgc2l6ZSk7CiAgICAgICAgCiAgICAgICAgLy8gR2xvdyBzZXR0aW5ncwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gMTU7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gY29sb3JTdHI7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3JTdHI7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGNvbG9yU3RyOwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKCiAgICAgICAgY29uc3QgY3ggPSBzaXplIC8gMjsKICAgICAgICBjb25zdCBjeSA9IHNpemUgLyAyOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ3JpbmcnKSB7CiAgICAgICAgICAgIC8vIE91dGVyIFJpbmcKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDY7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDExMCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBJbm5lciBSaW5nCiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoY3gsIGN5LCA5MCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBSdW5lcwpjdHguZm9udCA9ICcyNHB4IFNwaXJhLCBzYW5zLXNlcmlmJzsKICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTAwOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IGN4ICsgTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjeSArIE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICBjdHgudHJhbnNsYXRlKHgsIHkpOwogICAgICAgICAgICAgICAgY3R4LnJvdGF0ZShhbmdsZSArIE1hdGguUEkvMik7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGEgc2ltcGxlIHJ1bmUtbGlrZSBzaGFwZQogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygtNSwgLTUpOyBjdHgubGluZVRvKDUsIDApOyBjdHgubGluZVRvKC01LCA1KTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdydW5lJykgewogICAgICAgICAgICAvLyBDZW50cmFsIENvbXBsZXggUnVuZQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgNjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKGN4LCBjeSAtIDYwKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCwgY3kgKyA2MCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3ggLSA2MCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgNjAsIGN5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9OwoKICAgIGNvbnN0IF90ZWNoVGV4dHVyZSA9IF9jcmVhdGVHbHlwaFRleHR1cmUoJyMwMGZmZmYnLCAncmluZycpOyAvLyBDeWFuIFJpbmcKICAgIGNvbnN0IF9zdGF0dXNUZXh0dXJlID0gX2NyZWF0ZUdseXBoVGV4dHVyZSgnI2ZmMDBmZicsICdydW5lJyk7IC8vIE1hZ2VudGEgUnVuZQogICAgY29uc3QgX2NoYXJnZVRleHR1cmUgPSBfY3JlYXRlR2x5cGhUZXh0dXJlKCcjZmZmZjAwJywgJ3JpbmcnKTsgLy8gR29sZCBSaW5nCgogICAgY2xhc3MgR2x5cGhNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZ2x5cGhzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNYXRlcmlhbHMKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbHMgPSB7CiAgICAgICAgICAgICAgICB0ZWNoOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF90ZWNoVGV4dHVyZSwgCiAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBzdGF0dXM6IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgICAgIG1hcDogX3N0YXR1c1RleHR1cmUsIAogICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmZmZmYKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgY2hhcmdlOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF9jaGFyZ2VUZXh0dXJlLCAKICAgICAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgCiAgICAgICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUG9vbAogICAgICAgICAgICB0aGlzLnBvb2wgPSBbXTsKICAgICAgICAgICAgdGhpcy5wb29sU2l6ZSA9IDMwOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLCAxKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgdGhpcy5tYXRlcmlhbHMudGVjaCk7CiAgICAgICAgICAgICAgICBtZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1lc2gucmVuZGVyT3JkZXIgPSAyMDAwOyAvLyBEcmF3IG9uIHRvcCBvZiB3YXRlci9hcmVuYQogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQobWVzaCk7CiAgICAgICAgICAgICAgICB0aGlzLnBvb2wucHVzaChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgbWVzaCA9IHRoaXMucG9vbC5maW5kKG0gPT4gIW0udmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghbWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgbWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgbWVzaC5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWxzW3R5cGVdIHx8IHRoaXMubWF0ZXJpYWxzLnRlY2g7CiAgICAgICAgICAgIG1lc2gucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgTWF0ZXJpYWwgT3BhY2l0eQogICAgICAgICAgICBtZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CgogICAgICAgICAgICAvLyBEZWZhdWx0cwogICAgICAgICAgICBjb25zdCBzY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMS4wOwogICAgICAgICAgICBtZXNoLnNjYWxlLnNldChzY2FsZSwgc2NhbGUsIHNjYWxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9yaWVudGF0aW9uCiAgICAgICAgICAgIGlmIChvcHRpb25zLmZhY2VDYW1lcmEpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMub3JpZW50YXRpb24gPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgLy8gRmFjZSBjYW1lcmEgWS1heGlzIHJvdGF0aW9uIG9ubHkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKGNhbVBvcy54IC0gcG9zLngsIGNhbVBvcy56IC0gcG9zLnopOwogICAgICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24ueSA9IGFuZ2xlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCAoR3JvdW5kKQogICAgICAgICAgICAgICAgbWVzaC5yb3RhdGlvbi5zZXQoLU1hdGguUEkgLyAyLCAwLCBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLm9mZnNldFkpIHsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24ueSArPSBvcHRpb25zLm9mZnNldFk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2x5cGhzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogbWVzaCwKICAgICAgICAgICAgICAgIGFnZTogMCwKICAgICAgICAgICAgICAgIGxpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICBtYXhMaWZlOiBvcHRpb25zLmxpZmUgfHwgMS4wLAogICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogb3B0aW9ucy5yb3RhdGlvblNwZWVkIHx8IDEuMCwKICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IG9wdGlvbnMuc2NhbGVTcGVlZCB8fCAwLAogICAgICAgICAgICAgICAgZmFkZTogb3B0aW9ucy5mYWRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmZhZGUgOiB0cnVlLAogICAgICAgICAgICAgICAgZm9sbG93VGFyZ2V0OiBvcHRpb25zLnBhcmVudCB8fCBudWxsLAogICAgICAgICAgICAgICAgb2Zmc2V0WTogb3B0aW9ucy5vZmZzZXRZIHx8IDAKICAgICAgICAgICAgfSk7CiAgICAgICAgfQp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2x5cGhzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nbHlwaHNbaV07CiAgICAgICAgICAgICAgICBnLmFnZSArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAoZy5hZ2UgPj0gZy5saWZlKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdseXBocy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IGcuYWdlIC8gZy5tYXhMaWZlOwoKICAgICAgICAgICAgICAgIC8vIEZvbGxvdyB0YXJnZXQKICAgICAgICAgICAgICAgIGlmIChnLmZvbGxvd1RhcmdldCAmJiBnLmZvbGxvd1RhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLmNvcHkoZy5mb2xsb3dUYXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnkgKz0gZy5vZmZzZXRZOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGdyb3VuZCBvcmllbnRlZCwga2VlcCBuZWFyIGZsb29yCiAgICAgICAgICAgICAgICAgICAgaWYgKGcubWVzaC5yb3RhdGlvbi54ID09PSAtTWF0aC5QSS8yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBnLm1lc2gucG9zaXRpb24ueSA9IDAuMSArIGcub2Zmc2V0WTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uCiAgICAgICAgICAgICAgICBnLm1lc2gucm90YXRpb24ueiArPSBnLnJvdGF0aW9uU3BlZWQgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGcuc2NhbGVTcGVlZCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBnLm1lc2guc2NhbGUueCArIGcuc2NhbGVTcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgICAgIGcubWVzaC5zY2FsZS5zZXQocywgcywgcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmFkZQogICAgICAgICAgICAgICAgaWYgKGcuZmFkZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBvcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0IDwgMC4xKSBvcGFjaXR5ID0gdCAvIDAuMTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ID4gMC43KSBvcGFjaXR5ID0gMS4wIC0gKCh0IC0gMC43KSAvIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjbGVhcigpIHsKICAgICAgICAgICAgLy8gSGlkZSBhbGwgYWN0aXZlIGdseXBocyBhbmQgcmVzZXQgbGlzdAogICAgICAgICAgICBmb3IgKGNvbnN0IGcgb2YgdGhpcy5nbHlwaHMpIHsKICAgICAgICAgICAgICAgIGlmIChnLm1lc2gpIGcubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5nbHlwaHMgPSBbXTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguR2x5cGhNYW5hZ2VyID0gR2x5cGhNYW5hZ2VyOwp9KSgpOw==","./GlyphManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUSU9OIC0tLQogICAgY29uc3QgX2NyZWF0ZUdseXBoVGV4dHVyZSA9IChjb2xvclN0ciwgdHlwZSkgPT4gewogICAgICAgIGNvbnN0IHNpemUgPSAyNTY7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSBzaXplOyBjLmhlaWdodCA9IHNpemU7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgc2l6ZSwgc2l6ZSk7CiAgICAgICAgCiAgICAgICAgLy8gR2xvdyBzZXR0aW5ncwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gMTU7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gY29sb3JTdHI7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3JTdHI7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGNvbG9yU3RyOwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKCiAgICAgICAgY29uc3QgY3ggPSBzaXplIC8gMjsKICAgICAgICBjb25zdCBjeSA9IHNpemUgLyAyOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ3JpbmcnKSB7CiAgICAgICAgICAgIC8vIE91dGVyIFJpbmcKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDY7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDExMCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBJbm5lciBSaW5nCiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoY3gsIGN5LCA5MCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBSdW5lcwpjdHguZm9udCA9ICcyNHB4IFNwaXJhLCBzYW5zLXNlcmlmJzsKICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTAwOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IGN4ICsgTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjeSArIE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICBjdHgudHJhbnNsYXRlKHgsIHkpOwogICAgICAgICAgICAgICAgY3R4LnJvdGF0ZShhbmdsZSArIE1hdGguUEkvMik7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGEgc2ltcGxlIHJ1bmUtbGlrZSBzaGFwZQogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygtNSwgLTUpOyBjdHgubGluZVRvKDUsIDApOyBjdHgubGluZVRvKC01LCA1KTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdydW5lJykgewogICAgICAgICAgICAvLyBDZW50cmFsIENvbXBsZXggUnVuZQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgNjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKGN4LCBjeSAtIDYwKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCwgY3kgKyA2MCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3ggLSA2MCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgNjAsIGN5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9OwoKICAgIGNvbnN0IF90ZWNoVGV4dHVyZSA9IF9jcmVhdGVHbHlwaFRleHR1cmUoJyMwMGZmZmYnLCAncmluZycpOyAvLyBDeWFuIFJpbmcKICAgIGNvbnN0IF9zdGF0dXNUZXh0dXJlID0gX2NyZWF0ZUdseXBoVGV4dHVyZSgnI2ZmMDBmZicsICdydW5lJyk7IC8vIE1hZ2VudGEgUnVuZQogICAgY29uc3QgX2NoYXJnZVRleHR1cmUgPSBfY3JlYXRlR2x5cGhUZXh0dXJlKCcjZmZmZjAwJywgJ3JpbmcnKTsgLy8gR29sZCBSaW5nCgogICAgY2xhc3MgR2x5cGhNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZ2x5cGhzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNYXRlcmlhbHMKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbHMgPSB7CiAgICAgICAgICAgICAgICB0ZWNoOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF90ZWNoVGV4dHVyZSwgCiAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBzdGF0dXM6IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgICAgIG1hcDogX3N0YXR1c1RleHR1cmUsIAogICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmZmZmYKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgY2hhcmdlOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF9jaGFyZ2VUZXh0dXJlLCAKICAgICAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgCiAgICAgICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUG9vbAogICAgICAgICAgICB0aGlzLnBvb2wgPSBbXTsKICAgICAgICAgICAgdGhpcy5wb29sU2l6ZSA9IDMwOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLCAxKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgdGhpcy5tYXRlcmlhbHMudGVjaCk7CiAgICAgICAgICAgICAgICBtZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1lc2gucmVuZGVyT3JkZXIgPSAyMDAwOyAvLyBEcmF3IG9uIHRvcCBvZiB3YXRlci9hcmVuYQogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQobWVzaCk7CiAgICAgICAgICAgICAgICB0aGlzLnBvb2wucHVzaChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgbWVzaCA9IHRoaXMucG9vbC5maW5kKG0gPT4gIW0udmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghbWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgbWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgbWVzaC5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWxzW3R5cGVdIHx8IHRoaXMubWF0ZXJpYWxzLnRlY2g7CiAgICAgICAgICAgIG1lc2gucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgTWF0ZXJpYWwgT3BhY2l0eQogICAgICAgICAgICBtZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CgogICAgICAgICAgICAvLyBEZWZhdWx0cwogICAgICAgICAgICBjb25zdCBzY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMS4wOwogICAgICAgICAgICBtZXNoLnNjYWxlLnNldChzY2FsZSwgc2NhbGUsIHNjYWxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9yaWVudGF0aW9uCiAgICAgICAgICAgIGlmIChvcHRpb25zLmZhY2VDYW1lcmEpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMub3JpZW50YXRpb24gPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgLy8gRmFjZSBjYW1lcmEgWS1heGlzIHJvdGF0aW9uIG9ubHkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKGNhbVBvcy54IC0gcG9zLngsIGNhbVBvcy56IC0gcG9zLnopOwogICAgICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24ueSA9IGFuZ2xlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCAoR3JvdW5kKQogICAgICAgICAgICAgICAgbWVzaC5yb3RhdGlvbi5zZXQoLU1hdGguUEkgLyAyLCAwLCBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLm9mZnNldFkpIHsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24ueSArPSBvcHRpb25zLm9mZnNldFk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2x5cGhzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogbWVzaCwKICAgICAgICAgICAgICAgIGFnZTogMCwKICAgICAgICAgICAgICAgIGxpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICBtYXhMaWZlOiBvcHRpb25zLmxpZmUgfHwgMS4wLAogICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogb3B0aW9ucy5yb3RhdGlvblNwZWVkIHx8IDEuMCwKICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IG9wdGlvbnMuc2NhbGVTcGVlZCB8fCAwLAogICAgICAgICAgICAgICAgZmFkZTogb3B0aW9ucy5mYWRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmZhZGUgOiB0cnVlLAogICAgICAgICAgICAgICAgZm9sbG93VGFyZ2V0OiBvcHRpb25zLnBhcmVudCB8fCBudWxsLAogICAgICAgICAgICAgICAgb2Zmc2V0WTogb3B0aW9ucy5vZmZzZXRZIHx8IDAKICAgICAgICAgICAgfSk7CiAgICAgICAgfQp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2x5cGhzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nbHlwaHNbaV07CiAgICAgICAgICAgICAgICBnLmFnZSArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAoZy5hZ2UgPj0gZy5saWZlKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdseXBocy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IGcuYWdlIC8gZy5tYXhMaWZlOwoKICAgICAgICAgICAgICAgIC8vIEZvbGxvdyB0YXJnZXQKICAgICAgICAgICAgICAgIGlmIChnLmZvbGxvd1RhcmdldCAmJiBnLmZvbGxvd1RhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLmNvcHkoZy5mb2xsb3dUYXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnkgKz0gZy5vZmZzZXRZOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGdyb3VuZCBvcmllbnRlZCwga2VlcCBuZWFyIGZsb29yCiAgICAgICAgICAgICAgICAgICAgaWYgKGcubWVzaC5yb3RhdGlvbi54ID09PSAtTWF0aC5QSS8yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBnLm1lc2gucG9zaXRpb24ueSA9IDAuMSArIGcub2Zmc2V0WTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uCiAgICAgICAgICAgICAgICBnLm1lc2gucm90YXRpb24ueiArPSBnLnJvdGF0aW9uU3BlZWQgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGcuc2NhbGVTcGVlZCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBnLm1lc2guc2NhbGUueCArIGcuc2NhbGVTcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgICAgIGcubWVzaC5zY2FsZS5zZXQocywgcywgcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmFkZQogICAgICAgICAgICAgICAgaWYgKGcuZmFkZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBvcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0IDwgMC4xKSBvcGFjaXR5ID0gdCAvIDAuMTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ID4gMC43KSBvcGFjaXR5ID0gMS4wIC0gKCh0IC0gMC43KSAvIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjbGVhcigpIHsKICAgICAgICAgICAgLy8gSGlkZSBhbGwgYWN0aXZlIGdseXBocyBhbmQgcmVzZXQgbGlzdAogICAgICAgICAgICBmb3IgKGNvbnN0IGcgb2YgdGhpcy5nbHlwaHMpIHsKICAgICAgICAgICAgICAgIGlmIChnLm1lc2gpIGcubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5nbHlwaHMgPSBbXTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguR2x5cGhNYW5hZ2VyID0gR2x5cGhNYW5hZ2VyOwp9KSgpOw==","/GlyphManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICAvLyAtLS0gVEVYVFVSRSBHRU5FUkFUSU9OIC0tLQogICAgY29uc3QgX2NyZWF0ZUdseXBoVGV4dHVyZSA9IChjb2xvclN0ciwgdHlwZSkgPT4gewogICAgICAgIGNvbnN0IHNpemUgPSAyNTY7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGMud2lkdGggPSBzaXplOyBjLmhlaWdodCA9IHNpemU7CiAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgc2l6ZSwgc2l6ZSk7CiAgICAgICAgCiAgICAgICAgLy8gR2xvdyBzZXR0aW5ncwogICAgICAgIGN0eC5zaGFkb3dCbHVyID0gMTU7CiAgICAgICAgY3R4LnNoYWRvd0NvbG9yID0gY29sb3JTdHI7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3JTdHI7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGNvbG9yU3RyOwogICAgICAgIGN0eC5saW5lQ2FwID0gJ3JvdW5kJzsKCiAgICAgICAgY29uc3QgY3ggPSBzaXplIC8gMjsKICAgICAgICBjb25zdCBjeSA9IHNpemUgLyAyOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ3JpbmcnKSB7CiAgICAgICAgICAgIC8vIE91dGVyIFJpbmcKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDY7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmFyYyhjeCwgY3ksIDExMCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBJbm5lciBSaW5nCiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5hcmMoY3gsIGN5LCA5MCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgICAgICAvLyBSdW5lcwpjdHguZm9udCA9ICcyNHB4IFNwaXJhLCBzYW5zLXNlcmlmJzsKICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTAwOwogICAgICAgICAgICAgICAgY29uc3QgeCA9IGN4ICsgTWF0aC5jb3MoYW5nbGUpICogcjsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBjeSArIE1hdGguc2luKGFuZ2xlKSAqIHI7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICBjdHgudHJhbnNsYXRlKHgsIHkpOwogICAgICAgICAgICAgICAgY3R4LnJvdGF0ZShhbmdsZSArIE1hdGguUEkvMik7CiAgICAgICAgICAgICAgICAvLyBEcmF3IGEgc2ltcGxlIHJ1bmUtbGlrZSBzaGFwZQogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygtNSwgLTUpOyBjdHgubGluZVRvKDUsIDApOyBjdHgubGluZVRvKC01LCA1KTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdydW5lJykgewogICAgICAgICAgICAvLyBDZW50cmFsIENvbXBsZXggUnVuZQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgNjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKGN4LCBjeSAtIDYwKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhjeCwgY3kgKyA2MCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3ggLSA2MCwgY3kpOwogICAgICAgICAgICBjdHgubGluZVRvKGN4ICsgNjAsIGN5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwoKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKGN4LCBjeSwgMjAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHRleCA9IG5ldyBUSFJFRS5DYW52YXNUZXh0dXJlKGMpOwogICAgICAgIHJldHVybiB0ZXg7CiAgICB9OwoKICAgIGNvbnN0IF90ZWNoVGV4dHVyZSA9IF9jcmVhdGVHbHlwaFRleHR1cmUoJyMwMGZmZmYnLCAncmluZycpOyAvLyBDeWFuIFJpbmcKICAgIGNvbnN0IF9zdGF0dXNUZXh0dXJlID0gX2NyZWF0ZUdseXBoVGV4dHVyZSgnI2ZmMDBmZicsICdydW5lJyk7IC8vIE1hZ2VudGEgUnVuZQogICAgY29uc3QgX2NoYXJnZVRleHR1cmUgPSBfY3JlYXRlR2x5cGhUZXh0dXJlKCcjZmZmZjAwJywgJ3JpbmcnKTsgLy8gR29sZCBSaW5nCgogICAgY2xhc3MgR2x5cGhNYW5hZ2VyIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuZ2x5cGhzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNYXRlcmlhbHMKICAgICAgICAgICAgdGhpcy5tYXRlcmlhbHMgPSB7CiAgICAgICAgICAgICAgICB0ZWNoOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF90ZWNoVGV4dHVyZSwgCiAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsIAogICAgICAgICAgICAgICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgICAgICAgICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAweGZmZmZmZgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBzdGF0dXM6IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgICAgIG1hcDogX3N0YXR1c1RleHR1cmUsIAogICAgICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgICAgICBibGVuZGluZzogVEhSRUUuQWRkaXRpdmVCbGVuZGluZywKICAgICAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHhmZmZmZmYKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgY2hhcmdlOiBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgICAgICBtYXA6IF9jaGFyZ2VUZXh0dXJlLCAKICAgICAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZSwgCiAgICAgICAgICAgICAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZSwgCiAgICAgICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUG9vbAogICAgICAgICAgICB0aGlzLnBvb2wgPSBbXTsKICAgICAgICAgICAgdGhpcy5wb29sU2l6ZSA9IDMwOwogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLCAxKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMucG9vbFNpemU7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlbywgdGhpcy5tYXRlcmlhbHMudGVjaCk7CiAgICAgICAgICAgICAgICBtZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1lc2gucmVuZGVyT3JkZXIgPSAyMDAwOyAvLyBEcmF3IG9uIHRvcCBvZiB3YXRlci9hcmVuYQogICAgICAgICAgICAgICAgdGhpcy5zY2VuZS5hZGQobWVzaCk7CiAgICAgICAgICAgICAgICB0aGlzLnBvb2wucHVzaChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc3Bhd24odHlwZSwgcG9zLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgY29uc3QgbWVzaCA9IHRoaXMucG9vbC5maW5kKG0gPT4gIW0udmlzaWJsZSk7CiAgICAgICAgICAgIGlmICghbWVzaCkgcmV0dXJuOwoKICAgICAgICAgICAgbWVzaC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgbWVzaC5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWxzW3R5cGVdIHx8IHRoaXMubWF0ZXJpYWxzLnRlY2g7CiAgICAgICAgICAgIG1lc2gucG9zaXRpb24uY29weShwb3MpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgTWF0ZXJpYWwgT3BhY2l0eQogICAgICAgICAgICBtZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7CgogICAgICAgICAgICAvLyBEZWZhdWx0cwogICAgICAgICAgICBjb25zdCBzY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMS4wOwogICAgICAgICAgICBtZXNoLnNjYWxlLnNldChzY2FsZSwgc2NhbGUsIHNjYWxlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9yaWVudGF0aW9uCiAgICAgICAgICAgIGlmIChvcHRpb25zLmZhY2VDYW1lcmEpIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMub3JpZW50YXRpb24gPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICAgICAgLy8gRmFjZSBjYW1lcmEgWS1heGlzIHJvdGF0aW9uIG9ubHkKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZmx1eC5nYW1lSW5zdGFuY2UgJiYgd2luZG93LmZsdXguZ2FtZUluc3RhbmNlLmNhbWVyYSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbVBvcyA9IHdpbmRvdy5mbHV4LmdhbWVJbnN0YW5jZS5jYW1lcmEucG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKGNhbVBvcy54IC0gcG9zLngsIGNhbVBvcy56IC0gcG9zLnopOwogICAgICAgICAgICAgICAgICAgIG1lc2gucm90YXRpb24ueSA9IGFuZ2xlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCAoR3JvdW5kKQogICAgICAgICAgICAgICAgbWVzaC5yb3RhdGlvbi5zZXQoLU1hdGguUEkgLyAyLCAwLCBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLm9mZnNldFkpIHsKICAgICAgICAgICAgICAgIG1lc2gucG9zaXRpb24ueSArPSBvcHRpb25zLm9mZnNldFk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2x5cGhzLnB1c2goewogICAgICAgICAgICAgICAgbWVzaDogbWVzaCwKICAgICAgICAgICAgICAgIGFnZTogMCwKICAgICAgICAgICAgICAgIGxpZmU6IG9wdGlvbnMubGlmZSB8fCAxLjAsCiAgICAgICAgICAgICAgICBtYXhMaWZlOiBvcHRpb25zLmxpZmUgfHwgMS4wLAogICAgICAgICAgICAgICAgcm90YXRpb25TcGVlZDogb3B0aW9ucy5yb3RhdGlvblNwZWVkIHx8IDEuMCwKICAgICAgICAgICAgICAgIHNjYWxlU3BlZWQ6IG9wdGlvbnMuc2NhbGVTcGVlZCB8fCAwLAogICAgICAgICAgICAgICAgZmFkZTogb3B0aW9ucy5mYWRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmZhZGUgOiB0cnVlLAogICAgICAgICAgICAgICAgZm9sbG93VGFyZ2V0OiBvcHRpb25zLnBhcmVudCB8fCBudWxsLAogICAgICAgICAgICAgICAgb2Zmc2V0WTogb3B0aW9ucy5vZmZzZXRZIHx8IDAKICAgICAgICAgICAgfSk7CiAgICAgICAgfQp1cGRhdGUoZHQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZ2x5cGhzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnID0gdGhpcy5nbHlwaHNbaV07CiAgICAgICAgICAgICAgICBnLmFnZSArPSBkdDsKCiAgICAgICAgICAgICAgICBpZiAoZy5hZ2UgPj0gZy5saWZlKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdseXBocy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgdCA9IGcuYWdlIC8gZy5tYXhMaWZlOwoKICAgICAgICAgICAgICAgIC8vIEZvbGxvdyB0YXJnZXQKICAgICAgICAgICAgICAgIGlmIChnLmZvbGxvd1RhcmdldCAmJiBnLmZvbGxvd1RhcmdldC5tZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLmNvcHkoZy5mb2xsb3dUYXJnZXQubWVzaC5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLnBvc2l0aW9uLnkgKz0gZy5vZmZzZXRZOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGdyb3VuZCBvcmllbnRlZCwga2VlcCBuZWFyIGZsb29yCiAgICAgICAgICAgICAgICAgICAgaWYgKGcubWVzaC5yb3RhdGlvbi54ID09PSAtTWF0aC5QSS8yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBnLm1lc2gucG9zaXRpb24ueSA9IDAuMSArIGcub2Zmc2V0WTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uCiAgICAgICAgICAgICAgICBnLm1lc2gucm90YXRpb24ueiArPSBnLnJvdGF0aW9uU3BlZWQgKiBkdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGcuc2NhbGVTcGVlZCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBnLm1lc2guc2NhbGUueCArIGcuc2NhbGVTcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgICAgIGcubWVzaC5zY2FsZS5zZXQocywgcywgcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmFkZQogICAgICAgICAgICAgICAgaWYgKGcuZmFkZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBvcGFjaXR5ID0gMS4wOwogICAgICAgICAgICAgICAgICAgIGlmICh0IDwgMC4xKSBvcGFjaXR5ID0gdCAvIDAuMTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0ID4gMC43KSBvcGFjaXR5ID0gMS4wIC0gKCh0IC0gMC43KSAvIDAuMyk7CiAgICAgICAgICAgICAgICAgICAgZy5tZXNoLm1hdGVyaWFsLm9wYWNpdHkgPSBvcGFjaXR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjbGVhcigpIHsKICAgICAgICAgICAgLy8gSGlkZSBhbGwgYWN0aXZlIGdseXBocyBhbmQgcmVzZXQgbGlzdAogICAgICAgICAgICBmb3IgKGNvbnN0IGcgb2YgdGhpcy5nbHlwaHMpIHsKICAgICAgICAgICAgICAgIGlmIChnLm1lc2gpIGcubWVzaC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5nbHlwaHMgPSBbXTsKICAgICAgICB9CiAgICB9CgogICAgd2luZG93LmZsdXguR2x5cGhNYW5hZ2VyID0gR2x5cGhNYW5hZ2VyOwp9KSgpOw==","AudioManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBBdWRpb01hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgICAvLyAtLS0gQkdNIFNZU1RFTSAoSFRNTDUgQXVkaW8gZm9yIHN0cmVhbWluZykgLS0tCiAgICAgICAgICAgIHRoaXMuYmdtID0gbmV3IEF1ZGlvKCk7CiAgICAgICAgICAgIHRoaXMuYmdtLnNyYyA9ICdodHRwczovL2ZpbGVzLmNhdGJveC5tb2Uvc3AyeWh5Lm1wMyc7IC8vIEV4aXN0aW5nIEJHTQogICAgICAgICAgICB0aGlzLmJnbS5sb29wID0gdHJ1ZTsKdGhpcy5iZ20ubG9vcCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuYmdtLnZvbHVtZSA9IDAuNTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIC0tLSBTRlggU1lTVEVNIChXZWIgQXVkaW8gQVBJIGZvciBwcmVjaXNpb24gJiB2YXJpYW5jZSkgLS0tCiAgICAgICAgICAgIGNvbnN0IEF1ZGlvQ29udGV4dCA9IHdpbmRvdy5BdWRpb0NvbnRleHQgfHwgd2luZG93LndlYmtpdEF1ZGlvQ29udGV4dDsKICAgICAgICAgICAgdGhpcy5jdHggPSBuZXcgQXVkaW9Db250ZXh0KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnNmeEJ1ZmZlcnMgPSBuZXcgTWFwKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNYXN0ZXIgR2FpbiBmb3IgU0ZYCiAgICAgICAgICAgIHRoaXMuc2Z4R2FpbiA9IHRoaXMuY3R4LmNyZWF0ZUdhaW4oKTsKICAgICAgICAgICAgdGhpcy5zZnhHYWluLmNvbm5lY3QodGhpcy5jdHguZGVzdGluYXRpb24pOwogICAgICAgICAgICB0aGlzLnNmeEdhaW4uZ2Fpbi52YWx1ZSA9IDAuNTsKCiAgICAgICAgICAgIC8vIFZvbHVtZSBTdGF0ZQp0aGlzLm1hc3RlclZvbHVtZSA9IDAuODsgLy8gSW5jcmVhc2VkIGZyb20gMC41CiAgICAgICAgICAgIHRoaXMuYmdtTGV2ZWwgPSAxLjA7CiAgICAgICAgICAgIHRoaXMuc2Z4TGV2ZWwgPSAxLjA7CiAgICAgICAgICAgIHRoaXMuaXNNdXRlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3VsZEJlUGxheWluZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gLS0tIFNGWCBESUNUSU9OQVJZIChQdWJsaWMgRG9tYWluIC8gQ0MwKSAtLS0KICAgICAgICAgICAgLy8gTm90ZTogVGhlc2UgYXJlIGRpcmVjdCBsaW5rcyB0byBQaXhhYmF5IEF1ZGlvIChQdWJsaWMgRG9tYWluKS4KICAgICAgICAgICAgLy8gSW4gYSBwcm9kdWN0aW9uIGVudmlyb25tZW50LCB0aGVzZSBzaG91bGQgYmUgaG9zdGVkIGxvY2FsbHkgdG8gYXZvaWQgaG90bGlua2luZyBpc3N1ZXMuCnRoaXMuc2Z4TGlicmFyeSA9IHsKICAgICAgICAgICAgICAgIC8vIFRocm93OiBGYXN0IHdob29zaC9zd2lzaAogICAgICAgICAgICAgICAgJ3Rocm93JzogJ2h0dHBzOi8vY2RuLnBpeGFiYXkuY29tL2Rvd25sb2FkL2F1ZGlvLzIwMjIvMDMvMjQvYXVkaW9fMDc2NTlkOTVmMC5tcDM/ZmlsZW5hbWU9d2hvb3NoLW1vdGlvbi0yLTEwMjU4OS5tcDMnLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDYXRjaDogTGVhdGhlciBnbG92ZSBpbXBhY3QgKHVzaW5nIHB1bmNoL3RodWQgYXMgcHJveHkpCiAgICAgICAgICAgICAgICAnY2F0Y2gnOiAnaHR0cHM6Ly9jZG4ucGl4YWJheS5jb20vZG93bmxvYWQvYXVkaW8vMjAyMi8wMy8xNS9hdWRpb18yNzNmMGY3ZjMyLm1wMz9maWxlbmFtZT1wdW5jaC0xNDAyMzYubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVGFja2xlOiBIZWF2eSBib2R5IHRodWQKICAgICAgICAgICAgICAgICd0YWNrbGUnOiAnaHR0cHM6Ly9jZG4ucGl4YWJheS5jb20vZG93bmxvYWQvYXVkaW8vMjAyMS8wOC8wOS9hdWRpb18wM2U2MjI2MDJkLm1wMz9maWxlbmFtZT1ib2R5LWltcGFjdC00Mjc3Ny5tcDMnLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTd2ltOiBXYXRlciBzcGxhc2hpbmcKICAgICAgICAgICAgICAgICdzd2ltJzogJ2h0dHBzOi8vY2RuLnBpeGFiYXkuY29tL2Rvd25sb2FkL2F1ZGlvLzIwMjIvMDMvMTAvYXVkaW9fYzhjOGE3MzQ2Ny5tcDM/ZmlsZW5hbWU9d2F0ZXItc3BsYXNoLTgwNTI3Lm1wMycsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEdvYWw6IENyb3dkIGNoZWVyCiAgICAgICAgICAgICAgICAnZ29hbCc6ICdodHRwczovL2Nkbi5waXhhYmF5LmNvbS9kb3dubG9hZC9hdWRpby8yMDIxLzA4LzA0L2F1ZGlvXzEyYjBjNzQ0M2MubXAzP2ZpbGVuYW1lPWNyb3dkLWNoZWVyLWlpLTYyNjMubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gV2hpc3RsZTogUmVmZXJlZSB3aGlzdGxlCiAgICAgICAgICAgICAgICAnd2hpc3RsZSc6ICdodHRwczovL2Nkbi5waXhhYmF5LmNvbS9kb3dubG9hZC9hdWRpby8yMDIyLzAzLzIyL2F1ZGlvX2MyYjM3NjJiMzYubXAzP2ZpbGVuYW1lPXJlZmVyZWUtd2hpc3RsZS0xMDI5NzIubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVUk6IEJsaXBzCiAgICAgICAgICAgICAgICAnbWVudSc6ICdodHRwczovL2Nkbi5waXhhYmF5LmNvbS9kb3dubG9hZC9hdWRpby8yMDIxLzA4LzA0L2F1ZGlvX2M2ZGRmMWIzOWUubXAzP2ZpbGVuYW1lPXVpLWNsaWNrLTQzMTk2Lm1wMycsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERhc2g6IEFpciBjdXQKICAgICAgICAgICAgICAgICdkYXNoJzogJ2h0dHBzOi8vY2RuLnBpeGFiYXkuY29tL2Rvd25sb2FkL2F1ZGlvLzIwMjIvMDEvMTgvYXVkaW9fOGRiMWYxMTVhNS5tcDM/ZmlsZW5hbWU9d2hvb3NoLTYzMTYubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSW1wYWN0OiBIZWF2eSBoaXQKICAgICAgICAgICAgICAgICdpbXBhY3QnOiAnaHR0cHM6Ly9jZG4ucGl4YWJheS5jb20vZG93bmxvYWQvYXVkaW8vMjAyMi8wMy8xNS9hdWRpb183MzZmOTkwNTZjLm1wMz9maWxlbmFtZT1wdW5jaC0yLTEyMzM2OS5tcDMnCiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9wcmVsb2FkU0ZYKCk7CiAgICAgICAgICAgIHRoaXMuX2luaXRXYXRjaGRvZ3MoKTsKICAgICAgICB9CgpfaW5pdFdhdGNoZG9ncygpIHsKICAgICAgICAgICAgLy8gQkdNIExvb3AgJiBSZXN1bWUgTG9naWMKICAgICAgICAgICAgdGhpcy5iZ20uYWRkRXZlbnRMaXN0ZW5lcignZW5kZWQnLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgIXRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYmdtLmN1cnJlbnRUaW1lID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiBjb25zb2xlLndhcm4oIkJHTSBSZXBsYXkgZmFpbDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUm9idXN0IFVubG9jayBTdHJhdGVneSBmb3IgTW9iaWxlIChpT1MvQW5kcm9pZCkKICAgICAgICAgICAgY29uc3QgdW5sb2NrID0gKCkgPT4gewogICAgICAgICAgICAgICAgLy8gMS4gUmVzdW1lIFdlYiBBdWRpbyBDb250ZXh0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdHguc3RhdGUgIT09ICdydW5uaW5nJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY3R4LnJlc3VtZSgpLnRoZW4oKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygiQXVkaW9Db250ZXh0IFJlc3VtZWQgdmlhIGludGVyYWN0aW9uIik7CiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZSA9PiBjb25zb2xlLndhcm4oIkF1ZGlvQ29udGV4dCBSZXN1bWUgZmFpbDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMi4gUGxheSBTaWxlbnQgQnVmZmVyIChDcnVjaWFsIGZvciBpT1Mgd2FrZS11cCkKICAgICAgICAgICAgICAgIC8vIENyZWF0ZXMgYSB0aW55IGVtcHR5IGJ1ZmZlciBhbmQgcGxheXMgaXQgaW5zdGFudGx5IHRvIGVuZ2FnZSB0aGUgYXVkaW8gZW5naW5lCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuY3R4LmNyZWF0ZUJ1ZmZlcigxLCAxLCAyMjA1MCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc291cmNlID0gdGhpcy5jdHguY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgICAgICAgICAgc291cmNlLmJ1ZmZlciA9IGJ1ZmZlcjsKICAgICAgICAgICAgICAgICAgICBzb3VyY2UuY29ubmVjdCh0aGlzLmN0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgICAgICAgICAgc291cmNlLnN0YXJ0KDApOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSBlcnJvcnMgaGVyZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDMuIFJlc3VtZSBIVE1MNSBCR00gaWYgbmVlZGVkCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgdGhpcy5iZ20ucGF1c2VkICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUud2FybigiQkdNIFJlc3VtZSBmYWlsOiIsIGUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDQuIENsZWFudXAgbGlzdGVuZXJzCiAgICAgICAgICAgICAgICBbJ2NsaWNrJywgJ3RvdWNoc3RhcnQnLCAndG91Y2hlbmQnLCAna2V5ZG93bicsICdtb3VzZWRvd24nXS5mb3JFYWNoKGV2dCA9PiB7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldnQsIHVubG9jaywgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIEF0dGFjaCBhZ2dyZXNzaXZlIGxpc3RlbmVycwogICAgICAgICAgICBjb25zdCBvcHRzID0geyBjYXB0dXJlOiB0cnVlLCBwYXNzaXZlOiB0cnVlIH07CiAgICAgICAgICAgIFsnY2xpY2snLCAndG91Y2hzdGFydCcsICd0b3VjaGVuZCcsICdrZXlkb3duJywgJ21vdXNlZG93biddLmZvckVhY2goZXZ0ID0+IHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZ0LCB1bmxvY2ssIG9wdHMpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF9wcmVsb2FkU0ZYKCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IFtpZCwgdXJsXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLnNmeExpYnJhcnkpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRTRlgoaWQsIHVybCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGFzeW5jIGxvYWRTRlgoaWQsIHVybCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwpOwogICAgICAgICAgICAgICAgY29uc3QgYXJyYXlCdWZmZXIgPSBhd2FpdCByZXNwb25zZS5hcnJheUJ1ZmZlcigpOwogICAgICAgICAgICAgICAgY29uc3QgYXVkaW9CdWZmZXIgPSBhd2FpdCB0aGlzLmN0eC5kZWNvZGVBdWRpb0RhdGEoYXJyYXlCdWZmZXIpOwogICAgICAgICAgICAgICAgdGhpcy5zZnhCdWZmZXJzLnNldChpZCwgYXVkaW9CdWZmZXIpOwogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFNGWCBMb2FkZWQ6ICR7aWR9YCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihgQXVkaW9NYW5hZ2VyOiBGYWlsZWQgdG8gbG9hZCBTRlggJyR7aWR9JyBmcm9tICR7dXJsfWAsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBwbGF5U0ZYKGlkLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5jdHguc3RhdGUgPT09ICdzdXNwZW5kZWQnKSB0aGlzLmN0eC5yZXN1bWUoKTsKCiAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuc2Z4QnVmZmVycy5nZXQoaWQpOwogICAgICAgICAgICBpZiAoIWJ1ZmZlcikgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgc291cmNlID0gdGhpcy5jdHguY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgIHNvdXJjZS5idWZmZXIgPSBidWZmZXI7CgogICAgICAgICAgICAvLyBQaXRjaCBWYXJpYW5jZSAocHJldmVudHMgcmVwZXRpdGl2ZSBmYXRpZ3VlKQovLyBQaXRjaCBWYXJpYW5jZSAmIEJhc2UgUmF0ZQogICAgICAgICAgICBjb25zdCB2YXJpYW5jZSA9IG9wdGlvbnMudmFyaWFuY2UgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMudmFyaWFuY2UgOiAwLjE7CiAgICAgICAgICAgIGxldCByYXRlID0gb3B0aW9ucy5yYXRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnJhdGUgOiAxLjA7CgogICAgICAgICAgICBpZiAodmFyaWFuY2UgPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBSYW5kb20gcmF0ZSBiZXR3ZWVuIChyYXRlIC0gdmFyaWFuY2UpIGFuZCAocmF0ZSArIHZhcmlhbmNlKQogICAgICAgICAgICAgICAgcmF0ZSArPSAoTWF0aC5yYW5kb20oKSAqIHZhcmlhbmNlICogMiAtIHZhcmlhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBDbGFtcCByYXRlIHRvIHNhbmUgbGltaXRzCiAgICAgICAgICAgIHNvdXJjZS5wbGF5YmFja1JhdGUudmFsdWUgPSBNYXRoLm1heCgwLjEsIE1hdGgubWluKDQuMCwgcmF0ZSkpOwoKICAgICAgICAgICAgLy8gVm9sdW1lCiAgICAgICAgICAgIGNvbnN0IGdhaW5Ob2RlID0gdGhpcy5jdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICBjb25zdCB2b2wgPSBvcHRpb25zLnZvbHVtZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy52b2x1bWUgOiAxLjA7CiAgICAgICAgICAgIGdhaW5Ob2RlLmdhaW4udmFsdWUgPSB2b2w7CgogICAgICAgICAgICAvLyBHcmFwaDogU291cmNlIC0+IEdhaW4gLT4gTWFzdGVyU0ZYR2FpbiAtPiBEZXN0aW5hdGlvbgogICAgICAgICAgICBzb3VyY2UuY29ubmVjdChnYWluTm9kZSk7CiAgICAgICAgICAgIGdhaW5Ob2RlLmNvbm5lY3QodGhpcy5zZnhHYWluKTsKCiAgICAgICAgICAgIHNvdXJjZS5zdGFydCgwKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBCR00gQ09OVFJPTFMgLS0tCgogICAgICAgIHBsYXlCR00oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0ZWQpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiBjb25zb2xlLmxvZygiQkdNIEF1dG9wbGF5IHByZXZlbnRlZCwgd2FpdGluZyBmb3IgaW50ZXJhY3Rpb24uIikpOwogICAgICAgIH0KCiAgICAgICAgc3RvcEJHTSgpIHsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICAgICAgdGhpcy5iZ20uY3VycmVudFRpbWUgPSAwOwogICAgICAgIH0KCiAgICAgICAgcGF1c2VCR00oKSB7CiAgICAgICAgICAgIHRoaXMuc2hvdWxkQmVQbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuYmdtLnBhdXNlKCk7CiAgICAgICAgfQoKICAgICAgICByZXN1bWVCR00oKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc011dGVkICYmIHRoaXMuc2hvdWxkQmVQbGF5aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiB7fSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzZXRNYXN0ZXJWb2x1bWUodm9sdW1lKSB7CiAgICAgICAgICAgIHRoaXMubWFzdGVyVm9sdW1lID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgdm9sdW1lKSk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICB9CgogICAgICAgIHNldEJHTUxldmVsKGxldmVsKSB7CiAgICAgICAgICAgIHRoaXMuYmdtTGV2ZWwgPSBNYXRoLm1heCgwLCBsZXZlbCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICB9CgogICAgICAgIHNldFNGWExldmVsKGxldmVsKSB7CiAgICAgICAgICAgIHRoaXMuc2Z4TGV2ZWwgPSBNYXRoLm1heCgwLCBsZXZlbCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVWb2x1bWVzKCkgewogICAgICAgICAgICBpZiAodGhpcy5iZ20pIHsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnZvbHVtZSA9IE1hdGgubWluKDEsIHRoaXMubWFzdGVyVm9sdW1lICogdGhpcy5iZ21MZXZlbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc2Z4R2FpbikgewogICAgICAgICAgICAgICAgdGhpcy5zZnhHYWluLmdhaW4udmFsdWUgPSB0aGlzLm1hc3RlclZvbHVtZSAqIHRoaXMuc2Z4TGV2ZWw7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRvZ2dsZU11dGUoKSB7CiAgICAgICAgICAgIHRoaXMuaXNNdXRlZCA9ICF0aGlzLmlzTXV0ZWQ7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBhdXNlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmN0eC5zdXNwZW5kKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcpIHRoaXMuYmdtLnBsYXkoKS5jYXRjaChlPT57fSk7CiAgICAgICAgICAgICAgICB0aGlzLmN0eC5yZXN1bWUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5pc011dGVkOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5BdWRpb01hbmFnZXIgPSBBdWRpb01hbmFnZXI7Cn0pKCk7","./AudioManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBBdWRpb01hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgICAvLyAtLS0gQkdNIFNZU1RFTSAoSFRNTDUgQXVkaW8gZm9yIHN0cmVhbWluZykgLS0tCiAgICAgICAgICAgIHRoaXMuYmdtID0gbmV3IEF1ZGlvKCk7CiAgICAgICAgICAgIHRoaXMuYmdtLnNyYyA9ICdodHRwczovL2ZpbGVzLmNhdGJveC5tb2Uvc3AyeWh5Lm1wMyc7IC8vIEV4aXN0aW5nIEJHTQogICAgICAgICAgICB0aGlzLmJnbS5sb29wID0gdHJ1ZTsKdGhpcy5iZ20ubG9vcCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuYmdtLnZvbHVtZSA9IDAuNTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIC0tLSBTRlggU1lTVEVNIChXZWIgQXVkaW8gQVBJIGZvciBwcmVjaXNpb24gJiB2YXJpYW5jZSkgLS0tCiAgICAgICAgICAgIGNvbnN0IEF1ZGlvQ29udGV4dCA9IHdpbmRvdy5BdWRpb0NvbnRleHQgfHwgd2luZG93LndlYmtpdEF1ZGlvQ29udGV4dDsKICAgICAgICAgICAgdGhpcy5jdHggPSBuZXcgQXVkaW9Db250ZXh0KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnNmeEJ1ZmZlcnMgPSBuZXcgTWFwKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNYXN0ZXIgR2FpbiBmb3IgU0ZYCiAgICAgICAgICAgIHRoaXMuc2Z4R2FpbiA9IHRoaXMuY3R4LmNyZWF0ZUdhaW4oKTsKICAgICAgICAgICAgdGhpcy5zZnhHYWluLmNvbm5lY3QodGhpcy5jdHguZGVzdGluYXRpb24pOwogICAgICAgICAgICB0aGlzLnNmeEdhaW4uZ2Fpbi52YWx1ZSA9IDAuNTsKCiAgICAgICAgICAgIC8vIFZvbHVtZSBTdGF0ZQp0aGlzLm1hc3RlclZvbHVtZSA9IDAuODsgLy8gSW5jcmVhc2VkIGZyb20gMC41CiAgICAgICAgICAgIHRoaXMuYmdtTGV2ZWwgPSAxLjA7CiAgICAgICAgICAgIHRoaXMuc2Z4TGV2ZWwgPSAxLjA7CiAgICAgICAgICAgIHRoaXMuaXNNdXRlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3VsZEJlUGxheWluZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gLS0tIFNGWCBESUNUSU9OQVJZIChQdWJsaWMgRG9tYWluIC8gQ0MwKSAtLS0KICAgICAgICAgICAgLy8gTm90ZTogVGhlc2UgYXJlIGRpcmVjdCBsaW5rcyB0byBQaXhhYmF5IEF1ZGlvIChQdWJsaWMgRG9tYWluKS4KICAgICAgICAgICAgLy8gSW4gYSBwcm9kdWN0aW9uIGVudmlyb25tZW50LCB0aGVzZSBzaG91bGQgYmUgaG9zdGVkIGxvY2FsbHkgdG8gYXZvaWQgaG90bGlua2luZyBpc3N1ZXMuCnRoaXMuc2Z4TGlicmFyeSA9IHsKICAgICAgICAgICAgICAgIC8vIFRocm93OiBGYXN0IHdob29zaC9zd2lzaAogICAgICAgICAgICAgICAgJ3Rocm93JzogJ2h0dHBzOi8vY2RuLnBpeGFiYXkuY29tL2Rvd25sb2FkL2F1ZGlvLzIwMjIvMDMvMjQvYXVkaW9fMDc2NTlkOTVmMC5tcDM/ZmlsZW5hbWU9d2hvb3NoLW1vdGlvbi0yLTEwMjU4OS5tcDMnLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDYXRjaDogTGVhdGhlciBnbG92ZSBpbXBhY3QgKHVzaW5nIHB1bmNoL3RodWQgYXMgcHJveHkpCiAgICAgICAgICAgICAgICAnY2F0Y2gnOiAnaHR0cHM6Ly9jZG4ucGl4YWJheS5jb20vZG93bmxvYWQvYXVkaW8vMjAyMi8wMy8xNS9hdWRpb18yNzNmMGY3ZjMyLm1wMz9maWxlbmFtZT1wdW5jaC0xNDAyMzYubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVGFja2xlOiBIZWF2eSBib2R5IHRodWQKICAgICAgICAgICAgICAgICd0YWNrbGUnOiAnaHR0cHM6Ly9jZG4ucGl4YWJheS5jb20vZG93bmxvYWQvYXVkaW8vMjAyMS8wOC8wOS9hdWRpb18wM2U2MjI2MDJkLm1wMz9maWxlbmFtZT1ib2R5LWltcGFjdC00Mjc3Ny5tcDMnLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTd2ltOiBXYXRlciBzcGxhc2hpbmcKICAgICAgICAgICAgICAgICdzd2ltJzogJ2h0dHBzOi8vY2RuLnBpeGFiYXkuY29tL2Rvd25sb2FkL2F1ZGlvLzIwMjIvMDMvMTAvYXVkaW9fYzhjOGE3MzQ2Ny5tcDM/ZmlsZW5hbWU9d2F0ZXItc3BsYXNoLTgwNTI3Lm1wMycsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEdvYWw6IENyb3dkIGNoZWVyCiAgICAgICAgICAgICAgICAnZ29hbCc6ICdodHRwczovL2Nkbi5waXhhYmF5LmNvbS9kb3dubG9hZC9hdWRpby8yMDIxLzA4LzA0L2F1ZGlvXzEyYjBjNzQ0M2MubXAzP2ZpbGVuYW1lPWNyb3dkLWNoZWVyLWlpLTYyNjMubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gV2hpc3RsZTogUmVmZXJlZSB3aGlzdGxlCiAgICAgICAgICAgICAgICAnd2hpc3RsZSc6ICdodHRwczovL2Nkbi5waXhhYmF5LmNvbS9kb3dubG9hZC9hdWRpby8yMDIyLzAzLzIyL2F1ZGlvX2MyYjM3NjJiMzYubXAzP2ZpbGVuYW1lPXJlZmVyZWUtd2hpc3RsZS0xMDI5NzIubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVUk6IEJsaXBzCiAgICAgICAgICAgICAgICAnbWVudSc6ICdodHRwczovL2Nkbi5waXhhYmF5LmNvbS9kb3dubG9hZC9hdWRpby8yMDIxLzA4LzA0L2F1ZGlvX2M2ZGRmMWIzOWUubXAzP2ZpbGVuYW1lPXVpLWNsaWNrLTQzMTk2Lm1wMycsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERhc2g6IEFpciBjdXQKICAgICAgICAgICAgICAgICdkYXNoJzogJ2h0dHBzOi8vY2RuLnBpeGFiYXkuY29tL2Rvd25sb2FkL2F1ZGlvLzIwMjIvMDEvMTgvYXVkaW9fOGRiMWYxMTVhNS5tcDM/ZmlsZW5hbWU9d2hvb3NoLTYzMTYubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSW1wYWN0OiBIZWF2eSBoaXQKICAgICAgICAgICAgICAgICdpbXBhY3QnOiAnaHR0cHM6Ly9jZG4ucGl4YWJheS5jb20vZG93bmxvYWQvYXVkaW8vMjAyMi8wMy8xNS9hdWRpb183MzZmOTkwNTZjLm1wMz9maWxlbmFtZT1wdW5jaC0yLTEyMzM2OS5tcDMnCiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9wcmVsb2FkU0ZYKCk7CiAgICAgICAgICAgIHRoaXMuX2luaXRXYXRjaGRvZ3MoKTsKICAgICAgICB9CgpfaW5pdFdhdGNoZG9ncygpIHsKICAgICAgICAgICAgLy8gQkdNIExvb3AgJiBSZXN1bWUgTG9naWMKICAgICAgICAgICAgdGhpcy5iZ20uYWRkRXZlbnRMaXN0ZW5lcignZW5kZWQnLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgIXRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYmdtLmN1cnJlbnRUaW1lID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiBjb25zb2xlLndhcm4oIkJHTSBSZXBsYXkgZmFpbDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUm9idXN0IFVubG9jayBTdHJhdGVneSBmb3IgTW9iaWxlIChpT1MvQW5kcm9pZCkKICAgICAgICAgICAgY29uc3QgdW5sb2NrID0gKCkgPT4gewogICAgICAgICAgICAgICAgLy8gMS4gUmVzdW1lIFdlYiBBdWRpbyBDb250ZXh0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdHguc3RhdGUgIT09ICdydW5uaW5nJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY3R4LnJlc3VtZSgpLnRoZW4oKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygiQXVkaW9Db250ZXh0IFJlc3VtZWQgdmlhIGludGVyYWN0aW9uIik7CiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZSA9PiBjb25zb2xlLndhcm4oIkF1ZGlvQ29udGV4dCBSZXN1bWUgZmFpbDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMi4gUGxheSBTaWxlbnQgQnVmZmVyIChDcnVjaWFsIGZvciBpT1Mgd2FrZS11cCkKICAgICAgICAgICAgICAgIC8vIENyZWF0ZXMgYSB0aW55IGVtcHR5IGJ1ZmZlciBhbmQgcGxheXMgaXQgaW5zdGFudGx5IHRvIGVuZ2FnZSB0aGUgYXVkaW8gZW5naW5lCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuY3R4LmNyZWF0ZUJ1ZmZlcigxLCAxLCAyMjA1MCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc291cmNlID0gdGhpcy5jdHguY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgICAgICAgICAgc291cmNlLmJ1ZmZlciA9IGJ1ZmZlcjsKICAgICAgICAgICAgICAgICAgICBzb3VyY2UuY29ubmVjdCh0aGlzLmN0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgICAgICAgICAgc291cmNlLnN0YXJ0KDApOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSBlcnJvcnMgaGVyZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDMuIFJlc3VtZSBIVE1MNSBCR00gaWYgbmVlZGVkCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgdGhpcy5iZ20ucGF1c2VkICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUud2FybigiQkdNIFJlc3VtZSBmYWlsOiIsIGUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDQuIENsZWFudXAgbGlzdGVuZXJzCiAgICAgICAgICAgICAgICBbJ2NsaWNrJywgJ3RvdWNoc3RhcnQnLCAndG91Y2hlbmQnLCAna2V5ZG93bicsICdtb3VzZWRvd24nXS5mb3JFYWNoKGV2dCA9PiB7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldnQsIHVubG9jaywgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIEF0dGFjaCBhZ2dyZXNzaXZlIGxpc3RlbmVycwogICAgICAgICAgICBjb25zdCBvcHRzID0geyBjYXB0dXJlOiB0cnVlLCBwYXNzaXZlOiB0cnVlIH07CiAgICAgICAgICAgIFsnY2xpY2snLCAndG91Y2hzdGFydCcsICd0b3VjaGVuZCcsICdrZXlkb3duJywgJ21vdXNlZG93biddLmZvckVhY2goZXZ0ID0+IHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZ0LCB1bmxvY2ssIG9wdHMpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF9wcmVsb2FkU0ZYKCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IFtpZCwgdXJsXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLnNmeExpYnJhcnkpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRTRlgoaWQsIHVybCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGFzeW5jIGxvYWRTRlgoaWQsIHVybCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwpOwogICAgICAgICAgICAgICAgY29uc3QgYXJyYXlCdWZmZXIgPSBhd2FpdCByZXNwb25zZS5hcnJheUJ1ZmZlcigpOwogICAgICAgICAgICAgICAgY29uc3QgYXVkaW9CdWZmZXIgPSBhd2FpdCB0aGlzLmN0eC5kZWNvZGVBdWRpb0RhdGEoYXJyYXlCdWZmZXIpOwogICAgICAgICAgICAgICAgdGhpcy5zZnhCdWZmZXJzLnNldChpZCwgYXVkaW9CdWZmZXIpOwogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFNGWCBMb2FkZWQ6ICR7aWR9YCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihgQXVkaW9NYW5hZ2VyOiBGYWlsZWQgdG8gbG9hZCBTRlggJyR7aWR9JyBmcm9tICR7dXJsfWAsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBwbGF5U0ZYKGlkLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5jdHguc3RhdGUgPT09ICdzdXNwZW5kZWQnKSB0aGlzLmN0eC5yZXN1bWUoKTsKCiAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuc2Z4QnVmZmVycy5nZXQoaWQpOwogICAgICAgICAgICBpZiAoIWJ1ZmZlcikgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgc291cmNlID0gdGhpcy5jdHguY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgIHNvdXJjZS5idWZmZXIgPSBidWZmZXI7CgogICAgICAgICAgICAvLyBQaXRjaCBWYXJpYW5jZSAocHJldmVudHMgcmVwZXRpdGl2ZSBmYXRpZ3VlKQovLyBQaXRjaCBWYXJpYW5jZSAmIEJhc2UgUmF0ZQogICAgICAgICAgICBjb25zdCB2YXJpYW5jZSA9IG9wdGlvbnMudmFyaWFuY2UgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMudmFyaWFuY2UgOiAwLjE7CiAgICAgICAgICAgIGxldCByYXRlID0gb3B0aW9ucy5yYXRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnJhdGUgOiAxLjA7CgogICAgICAgICAgICBpZiAodmFyaWFuY2UgPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBSYW5kb20gcmF0ZSBiZXR3ZWVuIChyYXRlIC0gdmFyaWFuY2UpIGFuZCAocmF0ZSArIHZhcmlhbmNlKQogICAgICAgICAgICAgICAgcmF0ZSArPSAoTWF0aC5yYW5kb20oKSAqIHZhcmlhbmNlICogMiAtIHZhcmlhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBDbGFtcCByYXRlIHRvIHNhbmUgbGltaXRzCiAgICAgICAgICAgIHNvdXJjZS5wbGF5YmFja1JhdGUudmFsdWUgPSBNYXRoLm1heCgwLjEsIE1hdGgubWluKDQuMCwgcmF0ZSkpOwoKICAgICAgICAgICAgLy8gVm9sdW1lCiAgICAgICAgICAgIGNvbnN0IGdhaW5Ob2RlID0gdGhpcy5jdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICBjb25zdCB2b2wgPSBvcHRpb25zLnZvbHVtZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy52b2x1bWUgOiAxLjA7CiAgICAgICAgICAgIGdhaW5Ob2RlLmdhaW4udmFsdWUgPSB2b2w7CgogICAgICAgICAgICAvLyBHcmFwaDogU291cmNlIC0+IEdhaW4gLT4gTWFzdGVyU0ZYR2FpbiAtPiBEZXN0aW5hdGlvbgogICAgICAgICAgICBzb3VyY2UuY29ubmVjdChnYWluTm9kZSk7CiAgICAgICAgICAgIGdhaW5Ob2RlLmNvbm5lY3QodGhpcy5zZnhHYWluKTsKCiAgICAgICAgICAgIHNvdXJjZS5zdGFydCgwKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBCR00gQ09OVFJPTFMgLS0tCgogICAgICAgIHBsYXlCR00oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0ZWQpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiBjb25zb2xlLmxvZygiQkdNIEF1dG9wbGF5IHByZXZlbnRlZCwgd2FpdGluZyBmb3IgaW50ZXJhY3Rpb24uIikpOwogICAgICAgIH0KCiAgICAgICAgc3RvcEJHTSgpIHsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICAgICAgdGhpcy5iZ20uY3VycmVudFRpbWUgPSAwOwogICAgICAgIH0KCiAgICAgICAgcGF1c2VCR00oKSB7CiAgICAgICAgICAgIHRoaXMuc2hvdWxkQmVQbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuYmdtLnBhdXNlKCk7CiAgICAgICAgfQoKICAgICAgICByZXN1bWVCR00oKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc011dGVkICYmIHRoaXMuc2hvdWxkQmVQbGF5aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiB7fSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzZXRNYXN0ZXJWb2x1bWUodm9sdW1lKSB7CiAgICAgICAgICAgIHRoaXMubWFzdGVyVm9sdW1lID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgdm9sdW1lKSk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICB9CgogICAgICAgIHNldEJHTUxldmVsKGxldmVsKSB7CiAgICAgICAgICAgIHRoaXMuYmdtTGV2ZWwgPSBNYXRoLm1heCgwLCBsZXZlbCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICB9CgogICAgICAgIHNldFNGWExldmVsKGxldmVsKSB7CiAgICAgICAgICAgIHRoaXMuc2Z4TGV2ZWwgPSBNYXRoLm1heCgwLCBsZXZlbCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVWb2x1bWVzKCkgewogICAgICAgICAgICBpZiAodGhpcy5iZ20pIHsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnZvbHVtZSA9IE1hdGgubWluKDEsIHRoaXMubWFzdGVyVm9sdW1lICogdGhpcy5iZ21MZXZlbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc2Z4R2FpbikgewogICAgICAgICAgICAgICAgdGhpcy5zZnhHYWluLmdhaW4udmFsdWUgPSB0aGlzLm1hc3RlclZvbHVtZSAqIHRoaXMuc2Z4TGV2ZWw7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRvZ2dsZU11dGUoKSB7CiAgICAgICAgICAgIHRoaXMuaXNNdXRlZCA9ICF0aGlzLmlzTXV0ZWQ7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBhdXNlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmN0eC5zdXNwZW5kKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcpIHRoaXMuYmdtLnBsYXkoKS5jYXRjaChlPT57fSk7CiAgICAgICAgICAgICAgICB0aGlzLmN0eC5yZXN1bWUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5pc011dGVkOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5BdWRpb01hbmFnZXIgPSBBdWRpb01hbmFnZXI7Cn0pKCk7","/AudioManager.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBBdWRpb01hbmFnZXIgewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgICAvLyAtLS0gQkdNIFNZU1RFTSAoSFRNTDUgQXVkaW8gZm9yIHN0cmVhbWluZykgLS0tCiAgICAgICAgICAgIHRoaXMuYmdtID0gbmV3IEF1ZGlvKCk7CiAgICAgICAgICAgIHRoaXMuYmdtLnNyYyA9ICdodHRwczovL2ZpbGVzLmNhdGJveC5tb2Uvc3AyeWh5Lm1wMyc7IC8vIEV4aXN0aW5nIEJHTQogICAgICAgICAgICB0aGlzLmJnbS5sb29wID0gdHJ1ZTsKdGhpcy5iZ20ubG9vcCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuYmdtLnZvbHVtZSA9IDAuNTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIC0tLSBTRlggU1lTVEVNIChXZWIgQXVkaW8gQVBJIGZvciBwcmVjaXNpb24gJiB2YXJpYW5jZSkgLS0tCiAgICAgICAgICAgIGNvbnN0IEF1ZGlvQ29udGV4dCA9IHdpbmRvdy5BdWRpb0NvbnRleHQgfHwgd2luZG93LndlYmtpdEF1ZGlvQ29udGV4dDsKICAgICAgICAgICAgdGhpcy5jdHggPSBuZXcgQXVkaW9Db250ZXh0KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnNmeEJ1ZmZlcnMgPSBuZXcgTWFwKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNYXN0ZXIgR2FpbiBmb3IgU0ZYCiAgICAgICAgICAgIHRoaXMuc2Z4R2FpbiA9IHRoaXMuY3R4LmNyZWF0ZUdhaW4oKTsKICAgICAgICAgICAgdGhpcy5zZnhHYWluLmNvbm5lY3QodGhpcy5jdHguZGVzdGluYXRpb24pOwogICAgICAgICAgICB0aGlzLnNmeEdhaW4uZ2Fpbi52YWx1ZSA9IDAuNTsKCiAgICAgICAgICAgIC8vIFZvbHVtZSBTdGF0ZQp0aGlzLm1hc3RlclZvbHVtZSA9IDAuODsgLy8gSW5jcmVhc2VkIGZyb20gMC41CiAgICAgICAgICAgIHRoaXMuYmdtTGV2ZWwgPSAxLjA7CiAgICAgICAgICAgIHRoaXMuc2Z4TGV2ZWwgPSAxLjA7CiAgICAgICAgICAgIHRoaXMuaXNNdXRlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNob3VsZEJlUGxheWluZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gLS0tIFNGWCBESUNUSU9OQVJZIChQdWJsaWMgRG9tYWluIC8gQ0MwKSAtLS0KICAgICAgICAgICAgLy8gTm90ZTogVGhlc2UgYXJlIGRpcmVjdCBsaW5rcyB0byBQaXhhYmF5IEF1ZGlvIChQdWJsaWMgRG9tYWluKS4KICAgICAgICAgICAgLy8gSW4gYSBwcm9kdWN0aW9uIGVudmlyb25tZW50LCB0aGVzZSBzaG91bGQgYmUgaG9zdGVkIGxvY2FsbHkgdG8gYXZvaWQgaG90bGlua2luZyBpc3N1ZXMuCnRoaXMuc2Z4TGlicmFyeSA9IHsKICAgICAgICAgICAgICAgIC8vIFRocm93OiBGYXN0IHdob29zaC9zd2lzaAogICAgICAgICAgICAgICAgJ3Rocm93JzogJ2h0dHBzOi8vY2RuLnBpeGFiYXkuY29tL2Rvd25sb2FkL2F1ZGlvLzIwMjIvMDMvMjQvYXVkaW9fMDc2NTlkOTVmMC5tcDM/ZmlsZW5hbWU9d2hvb3NoLW1vdGlvbi0yLTEwMjU4OS5tcDMnLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBDYXRjaDogTGVhdGhlciBnbG92ZSBpbXBhY3QgKHVzaW5nIHB1bmNoL3RodWQgYXMgcHJveHkpCiAgICAgICAgICAgICAgICAnY2F0Y2gnOiAnaHR0cHM6Ly9jZG4ucGl4YWJheS5jb20vZG93bmxvYWQvYXVkaW8vMjAyMi8wMy8xNS9hdWRpb18yNzNmMGY3ZjMyLm1wMz9maWxlbmFtZT1wdW5jaC0xNDAyMzYubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVGFja2xlOiBIZWF2eSBib2R5IHRodWQKICAgICAgICAgICAgICAgICd0YWNrbGUnOiAnaHR0cHM6Ly9jZG4ucGl4YWJheS5jb20vZG93bmxvYWQvYXVkaW8vMjAyMS8wOC8wOS9hdWRpb18wM2U2MjI2MDJkLm1wMz9maWxlbmFtZT1ib2R5LWltcGFjdC00Mjc3Ny5tcDMnLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTd2ltOiBXYXRlciBzcGxhc2hpbmcKICAgICAgICAgICAgICAgICdzd2ltJzogJ2h0dHBzOi8vY2RuLnBpeGFiYXkuY29tL2Rvd25sb2FkL2F1ZGlvLzIwMjIvMDMvMTAvYXVkaW9fYzhjOGE3MzQ2Ny5tcDM/ZmlsZW5hbWU9d2F0ZXItc3BsYXNoLTgwNTI3Lm1wMycsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEdvYWw6IENyb3dkIGNoZWVyCiAgICAgICAgICAgICAgICAnZ29hbCc6ICdodHRwczovL2Nkbi5waXhhYmF5LmNvbS9kb3dubG9hZC9hdWRpby8yMDIxLzA4LzA0L2F1ZGlvXzEyYjBjNzQ0M2MubXAzP2ZpbGVuYW1lPWNyb3dkLWNoZWVyLWlpLTYyNjMubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gV2hpc3RsZTogUmVmZXJlZSB3aGlzdGxlCiAgICAgICAgICAgICAgICAnd2hpc3RsZSc6ICdodHRwczovL2Nkbi5waXhhYmF5LmNvbS9kb3dubG9hZC9hdWRpby8yMDIyLzAzLzIyL2F1ZGlvX2MyYjM3NjJiMzYubXAzP2ZpbGVuYW1lPXJlZmVyZWUtd2hpc3RsZS0xMDI5NzIubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gVUk6IEJsaXBzCiAgICAgICAgICAgICAgICAnbWVudSc6ICdodHRwczovL2Nkbi5waXhhYmF5LmNvbS9kb3dubG9hZC9hdWRpby8yMDIxLzA4LzA0L2F1ZGlvX2M2ZGRmMWIzOWUubXAzP2ZpbGVuYW1lPXVpLWNsaWNrLTQzMTk2Lm1wMycsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERhc2g6IEFpciBjdXQKICAgICAgICAgICAgICAgICdkYXNoJzogJ2h0dHBzOi8vY2RuLnBpeGFiYXkuY29tL2Rvd25sb2FkL2F1ZGlvLzIwMjIvMDEvMTgvYXVkaW9fOGRiMWYxMTVhNS5tcDM/ZmlsZW5hbWU9d2hvb3NoLTYzMTYubXAzJywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gSW1wYWN0OiBIZWF2eSBoaXQKICAgICAgICAgICAgICAgICdpbXBhY3QnOiAnaHR0cHM6Ly9jZG4ucGl4YWJheS5jb20vZG93bmxvYWQvYXVkaW8vMjAyMi8wMy8xNS9hdWRpb183MzZmOTkwNTZjLm1wMz9maWxlbmFtZT1wdW5jaC0yLTEyMzM2OS5tcDMnCiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9wcmVsb2FkU0ZYKCk7CiAgICAgICAgICAgIHRoaXMuX2luaXRXYXRjaGRvZ3MoKTsKICAgICAgICB9CgpfaW5pdFdhdGNoZG9ncygpIHsKICAgICAgICAgICAgLy8gQkdNIExvb3AgJiBSZXN1bWUgTG9naWMKICAgICAgICAgICAgdGhpcy5iZ20uYWRkRXZlbnRMaXN0ZW5lcignZW5kZWQnLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgIXRoaXMuaXNNdXRlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYmdtLmN1cnJlbnRUaW1lID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiBjb25zb2xlLndhcm4oIkJHTSBSZXBsYXkgZmFpbDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUm9idXN0IFVubG9jayBTdHJhdGVneSBmb3IgTW9iaWxlIChpT1MvQW5kcm9pZCkKICAgICAgICAgICAgY29uc3QgdW5sb2NrID0gKCkgPT4gewogICAgICAgICAgICAgICAgLy8gMS4gUmVzdW1lIFdlYiBBdWRpbyBDb250ZXh0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdHguc3RhdGUgIT09ICdydW5uaW5nJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY3R4LnJlc3VtZSgpLnRoZW4oKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygiQXVkaW9Db250ZXh0IFJlc3VtZWQgdmlhIGludGVyYWN0aW9uIik7CiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZSA9PiBjb25zb2xlLndhcm4oIkF1ZGlvQ29udGV4dCBSZXN1bWUgZmFpbDoiLCBlKSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMi4gUGxheSBTaWxlbnQgQnVmZmVyIChDcnVjaWFsIGZvciBpT1Mgd2FrZS11cCkKICAgICAgICAgICAgICAgIC8vIENyZWF0ZXMgYSB0aW55IGVtcHR5IGJ1ZmZlciBhbmQgcGxheXMgaXQgaW5zdGFudGx5IHRvIGVuZ2FnZSB0aGUgYXVkaW8gZW5naW5lCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuY3R4LmNyZWF0ZUJ1ZmZlcigxLCAxLCAyMjA1MCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc291cmNlID0gdGhpcy5jdHguY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgICAgICAgICAgc291cmNlLmJ1ZmZlciA9IGJ1ZmZlcjsKICAgICAgICAgICAgICAgICAgICBzb3VyY2UuY29ubmVjdCh0aGlzLmN0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgICAgICAgICAgc291cmNlLnN0YXJ0KDApOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSBlcnJvcnMgaGVyZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDMuIFJlc3VtZSBIVE1MNSBCR00gaWYgbmVlZGVkCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcgJiYgdGhpcy5iZ20ucGF1c2VkICYmICF0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUud2FybigiQkdNIFJlc3VtZSBmYWlsOiIsIGUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDQuIENsZWFudXAgbGlzdGVuZXJzCiAgICAgICAgICAgICAgICBbJ2NsaWNrJywgJ3RvdWNoc3RhcnQnLCAndG91Y2hlbmQnLCAna2V5ZG93bicsICdtb3VzZWRvd24nXS5mb3JFYWNoKGV2dCA9PiB7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldnQsIHVubG9jaywgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIEF0dGFjaCBhZ2dyZXNzaXZlIGxpc3RlbmVycwogICAgICAgICAgICBjb25zdCBvcHRzID0geyBjYXB0dXJlOiB0cnVlLCBwYXNzaXZlOiB0cnVlIH07CiAgICAgICAgICAgIFsnY2xpY2snLCAndG91Y2hzdGFydCcsICd0b3VjaGVuZCcsICdrZXlkb3duJywgJ21vdXNlZG93biddLmZvckVhY2goZXZ0ID0+IHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZ0LCB1bmxvY2ssIG9wdHMpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF9wcmVsb2FkU0ZYKCkgewogICAgICAgICAgICBmb3IgKGNvbnN0IFtpZCwgdXJsXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLnNmeExpYnJhcnkpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRTRlgoaWQsIHVybCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGFzeW5jIGxvYWRTRlgoaWQsIHVybCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwpOwogICAgICAgICAgICAgICAgY29uc3QgYXJyYXlCdWZmZXIgPSBhd2FpdCByZXNwb25zZS5hcnJheUJ1ZmZlcigpOwogICAgICAgICAgICAgICAgY29uc3QgYXVkaW9CdWZmZXIgPSBhd2FpdCB0aGlzLmN0eC5kZWNvZGVBdWRpb0RhdGEoYXJyYXlCdWZmZXIpOwogICAgICAgICAgICAgICAgdGhpcy5zZnhCdWZmZXJzLnNldChpZCwgYXVkaW9CdWZmZXIpOwogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFNGWCBMb2FkZWQ6ICR7aWR9YCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihgQXVkaW9NYW5hZ2VyOiBGYWlsZWQgdG8gbG9hZCBTRlggJyR7aWR9JyBmcm9tICR7dXJsfWAsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBwbGF5U0ZYKGlkLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNNdXRlZCkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5jdHguc3RhdGUgPT09ICdzdXNwZW5kZWQnKSB0aGlzLmN0eC5yZXN1bWUoKTsKCiAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuc2Z4QnVmZmVycy5nZXQoaWQpOwogICAgICAgICAgICBpZiAoIWJ1ZmZlcikgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3Qgc291cmNlID0gdGhpcy5jdHguY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgIHNvdXJjZS5idWZmZXIgPSBidWZmZXI7CgogICAgICAgICAgICAvLyBQaXRjaCBWYXJpYW5jZSAocHJldmVudHMgcmVwZXRpdGl2ZSBmYXRpZ3VlKQovLyBQaXRjaCBWYXJpYW5jZSAmIEJhc2UgUmF0ZQogICAgICAgICAgICBjb25zdCB2YXJpYW5jZSA9IG9wdGlvbnMudmFyaWFuY2UgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMudmFyaWFuY2UgOiAwLjE7CiAgICAgICAgICAgIGxldCByYXRlID0gb3B0aW9ucy5yYXRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnJhdGUgOiAxLjA7CgogICAgICAgICAgICBpZiAodmFyaWFuY2UgPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBSYW5kb20gcmF0ZSBiZXR3ZWVuIChyYXRlIC0gdmFyaWFuY2UpIGFuZCAocmF0ZSArIHZhcmlhbmNlKQogICAgICAgICAgICAgICAgcmF0ZSArPSAoTWF0aC5yYW5kb20oKSAqIHZhcmlhbmNlICogMiAtIHZhcmlhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBDbGFtcCByYXRlIHRvIHNhbmUgbGltaXRzCiAgICAgICAgICAgIHNvdXJjZS5wbGF5YmFja1JhdGUudmFsdWUgPSBNYXRoLm1heCgwLjEsIE1hdGgubWluKDQuMCwgcmF0ZSkpOwoKICAgICAgICAgICAgLy8gVm9sdW1lCiAgICAgICAgICAgIGNvbnN0IGdhaW5Ob2RlID0gdGhpcy5jdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICBjb25zdCB2b2wgPSBvcHRpb25zLnZvbHVtZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy52b2x1bWUgOiAxLjA7CiAgICAgICAgICAgIGdhaW5Ob2RlLmdhaW4udmFsdWUgPSB2b2w7CgogICAgICAgICAgICAvLyBHcmFwaDogU291cmNlIC0+IEdhaW4gLT4gTWFzdGVyU0ZYR2FpbiAtPiBEZXN0aW5hdGlvbgogICAgICAgICAgICBzb3VyY2UuY29ubmVjdChnYWluTm9kZSk7CiAgICAgICAgICAgIGdhaW5Ob2RlLmNvbm5lY3QodGhpcy5zZnhHYWluKTsKCiAgICAgICAgICAgIHNvdXJjZS5zdGFydCgwKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBCR00gQ09OVFJPTFMgLS0tCgogICAgICAgIHBsYXlCR00oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0ZWQpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiBjb25zb2xlLmxvZygiQkdNIEF1dG9wbGF5IHByZXZlbnRlZCwgd2FpdGluZyBmb3IgaW50ZXJhY3Rpb24uIikpOwogICAgICAgIH0KCiAgICAgICAgc3RvcEJHTSgpIHsKICAgICAgICAgICAgdGhpcy5zaG91bGRCZVBsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5iZ20ucGF1c2UoKTsKICAgICAgICAgICAgdGhpcy5iZ20uY3VycmVudFRpbWUgPSAwOwogICAgICAgIH0KCiAgICAgICAgcGF1c2VCR00oKSB7CiAgICAgICAgICAgIHRoaXMuc2hvdWxkQmVQbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuYmdtLnBhdXNlKCk7CiAgICAgICAgfQoKICAgICAgICByZXN1bWVCR00oKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc011dGVkICYmIHRoaXMuc2hvdWxkQmVQbGF5aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJnbS5wbGF5KCkuY2F0Y2goZSA9PiB7fSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgpzZXRNYXN0ZXJWb2x1bWUodm9sdW1lKSB7CiAgICAgICAgICAgIHRoaXMubWFzdGVyVm9sdW1lID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgdm9sdW1lKSk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICB9CgogICAgICAgIHNldEJHTUxldmVsKGxldmVsKSB7CiAgICAgICAgICAgIHRoaXMuYmdtTGV2ZWwgPSBNYXRoLm1heCgwLCBsZXZlbCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICB9CgogICAgICAgIHNldFNGWExldmVsKGxldmVsKSB7CiAgICAgICAgICAgIHRoaXMuc2Z4TGV2ZWwgPSBNYXRoLm1heCgwLCBsZXZlbCk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZvbHVtZXMoKTsKICAgICAgICB9CgogICAgICAgIF91cGRhdGVWb2x1bWVzKCkgewogICAgICAgICAgICBpZiAodGhpcy5iZ20pIHsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnZvbHVtZSA9IE1hdGgubWluKDEsIHRoaXMubWFzdGVyVm9sdW1lICogdGhpcy5iZ21MZXZlbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc2Z4R2FpbikgewogICAgICAgICAgICAgICAgdGhpcy5zZnhHYWluLmdhaW4udmFsdWUgPSB0aGlzLm1hc3RlclZvbHVtZSAqIHRoaXMuc2Z4TGV2ZWw7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRvZ2dsZU11dGUoKSB7CiAgICAgICAgICAgIHRoaXMuaXNNdXRlZCA9ICF0aGlzLmlzTXV0ZWQ7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0ZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmdtLnBhdXNlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmN0eC5zdXNwZW5kKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRCZVBsYXlpbmcpIHRoaXMuYmdtLnBsYXkoKS5jYXRjaChlPT57fSk7CiAgICAgICAgICAgICAgICB0aGlzLmN0eC5yZXN1bWUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5pc011dGVkOwogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5BdWRpb01hbmFnZXIgPSBBdWRpb01hbmFnZXI7Cn0pKCk7","LightShafts.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBMaWdodFNoYWZ0cyB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgIHROb2lzZTogeyB2YWx1ZTogbnVsbCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9pbml0KCk7CiAgICAgICAgfQoKX2luaXQoKSB7CiAgICAgICAgICAgIC8vIEdlb21ldHJ5OiBBIGNsdXN0ZXIgb2YgY29uZXMvY3lsaW5kZXJzCiAgICAgICAgICAgIC8vIFdlIHVzZSBhIHNpbmdsZSBnZW9tZXRyeSB3aXRoIGluc3RhbmNpbmcgb3IgbWVyZ2VkIGdlb21ldHJ5IGZvciBwZXJmb3JtYW5jZSwKICAgICAgICAgICAgLy8gYnV0IGZvciBzaW1wbGljaXR5IGFuZCBhZXN0aGV0aWMgY29udHJvbCwgbGV0J3MgdXNlIGEgZmV3IGxhcmdlIHBsYW5lcyBvciBhIGN5bGluZGVyLgogICAgICAgICAgICAvLyBBIGxhcmdlIGN5bGluZGVyIHdpdGggb3BlbiBlbmRzIHdvcmtzIHdlbGwgZm9yIGEgInBvb2wiIHNoYWZ0IGVmZmVjdC4KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluY3JlYXNlZCBsZW5ndGggdG8gOTAgdG8gYWNjb21tb2RhdGUgdGlsdCB3aXRob3V0IGNsaXBwaW5nIHRvcC9ib3R0b20KICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgzMCwgMjAsIDkwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaGFkZXIKICAgICAgICAgICAgY29uc3QgdmVydCA9IGAKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdlBvczsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2UG9zID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3NpdGlvbiwgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIGNvbnN0IGZyYWcgPSBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdE5vaXNlOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2UG9zOwoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBmYWRlIChTb2Z0IHRvcCBhbmQgYm90dG9tKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gc21vb3Roc3RlcCgwLjAsIDAuMywgdlV2LnkpICogc21vb3Roc3RlcCgxLjAsIDAuNiwgdlV2LnkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTY3JvbGxpbmcgUmF5cwogICAgICAgICAgICAgICAgICAgIC8vIExheWVyIDE6IFNsb3csIGJyb2FkIHJheXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBuMSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZlYzIodlV2LnggKiAyLjAgKyB1VGltZSAqIDAuMDIsIHZVdi55ICogMC41IC0gdVRpbWUgKiAwLjA1KSkucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMYXllciAyOiBGYXN0LCBpbnRlcmZlcmVuY2UgcmF5cwogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4yID0gdGV4dHVyZTJEKHROb2lzZSwgdmVjMih2VXYueCAqIDMuMCAtIHVUaW1lICogMC4wMywgdlV2LnkgKiAwLjUgLSB1VGltZSAqIDAuMSkpLnI7CgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheXMgPSBuMSAqIG4yOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IGludGVuc2l0eSBzaWduaWZpY2FudGx5IChSZW1vdmVkIHBvdyB0byBwcmV2ZW50IGNydXNoaW5nKQogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogMy4wOyAKCiAgICAgICAgICAgICAgICAgICAgLy8gR2xpc3RlbmluZyBTcGFya2xlcyAoSGlnaCBmcmVxdWVuY3kgbm9pc2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BhcmtsZSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZVdiAqIHZlYzIoOC4wLCAyLjApICsgdmVjMih1VGltZSAqIDAuMSwgdVRpbWUgKiAwLjMpKS5yOwogICAgICAgICAgICAgICAgICAgIHNwYXJrbGUgPSBwb3coc3BhcmtsZSwgNS4wKSAqIDEwLjA7IC8vIFNoYXJwIHBvaW50cwoKICAgICAgICAgICAgICAgICAgICAvLyBDb2xvcjogQ3lhbi9CbHVlL1doaXRlIChCcmlnaHRlciBiYXNlKQogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKDAuNiwgMC45LCAxLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENvbWJpbmUgKEhpZ2hlciBtdWx0aXBsaWVycykKICAgICAgICAgICAgICAgICAgICBmbG9hdCBmaW5hbEFscGhhID0gKHJheXMgKiAwLjggKyBzcGFya2xlICogMC40KSAqIGFscGhhOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIERpc3RhbmNlIGZhZGUgKG9wdGlvbmFsLCBoYW5kbGVkIGJ5IGZvZyB1c3VhbGx5IGJ1dCB3ZSB3YW50IGFkZGl0aXZlKQogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGZpbmFsQWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHRoaXMudW5pZm9ybXMsCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IHZlcnQsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogZnJhZywKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBDb250YWluZXIgZm9yIHRoZSBhbmdsZSAoUmVhbGlzdGljIExpZ2h0IFNvdXJjZSkKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgLy8gQW5nbGU6IENvbWluZyBmcm9tIHRvcC1sZWZ0IChzaW11bGF0aW5nIHN1cmZhY2Ugc3VuIHBlbmV0cmF0aW5nIGRlZXAgd2F0ZXIpCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJvdGF0aW9uLnogPSBNYXRoLlBJIC8gNTsgLy8gfjM2IGRlZ3JlZXMgdGlsdAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDEwOyAvLyB+MTggZGVncmVlcyBmb3J3YXJkCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnBvc2l0aW9uLnNldCgxMiwgOCwgMCk7IC8vIE9mZnNldCBzb3VyY2UgdG8gaGl0IGFyZW5hIGNlbnRlcgogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNvbnRhaW5lcik7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSAxMDA7IAogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5tZXNoKTsKCiAgICAgICAgICAgIC8vIEFkZCBhIHNlY29uZCBsYXllciBmb3IgY29yZSBpbnRlbnNpdHkKICAgICAgICAgICAgY29uc3QgY29yZUdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEyLCA4LCA5MCwgMTYsIDEsIHRydWUpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoID0gbmV3IFRIUkVFLk1lc2goY29yZUdlbywgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoLnJlbmRlck9yZGVyID0gMTAwOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jb3JlTWVzaCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExhenkgbG9hZCB0ZXh0dXJlCiAgICAgICAgICAgIGlmICghdGhpcy51bmlmb3Jtcy50Tm9pc2UudmFsdWUgJiYgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnROb2lzZS52YWx1ZSA9IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZTsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3cmFwcGluZyBpcyBjb3JyZWN0IGZvciB0aGUgY3lsaW5kZXIgVVZzCiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZS53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbG93bHkgcm90YXRlIHNoYWZ0cyBmb3IgZHluYW1pYyBmZWVsCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC5yb3RhdGlvbi55ICs9IGR0ICogMC4wMjsKICAgICAgICAgICAgaWYgKHRoaXMuY29yZU1lc2gpIHRoaXMuY29yZU1lc2gucm90YXRpb24ueSAtPSBkdCAqIDAuMDM7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkxpZ2h0U2hhZnRzID0gTGlnaHRTaGFmdHM7Cn0pKCk7","./LightShafts.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBMaWdodFNoYWZ0cyB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgIHROb2lzZTogeyB2YWx1ZTogbnVsbCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9pbml0KCk7CiAgICAgICAgfQoKX2luaXQoKSB7CiAgICAgICAgICAgIC8vIEdlb21ldHJ5OiBBIGNsdXN0ZXIgb2YgY29uZXMvY3lsaW5kZXJzCiAgICAgICAgICAgIC8vIFdlIHVzZSBhIHNpbmdsZSBnZW9tZXRyeSB3aXRoIGluc3RhbmNpbmcgb3IgbWVyZ2VkIGdlb21ldHJ5IGZvciBwZXJmb3JtYW5jZSwKICAgICAgICAgICAgLy8gYnV0IGZvciBzaW1wbGljaXR5IGFuZCBhZXN0aGV0aWMgY29udHJvbCwgbGV0J3MgdXNlIGEgZmV3IGxhcmdlIHBsYW5lcyBvciBhIGN5bGluZGVyLgogICAgICAgICAgICAvLyBBIGxhcmdlIGN5bGluZGVyIHdpdGggb3BlbiBlbmRzIHdvcmtzIHdlbGwgZm9yIGEgInBvb2wiIHNoYWZ0IGVmZmVjdC4KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluY3JlYXNlZCBsZW5ndGggdG8gOTAgdG8gYWNjb21tb2RhdGUgdGlsdCB3aXRob3V0IGNsaXBwaW5nIHRvcC9ib3R0b20KICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgzMCwgMjAsIDkwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaGFkZXIKICAgICAgICAgICAgY29uc3QgdmVydCA9IGAKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdlBvczsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2UG9zID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3NpdGlvbiwgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIGNvbnN0IGZyYWcgPSBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdE5vaXNlOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2UG9zOwoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBmYWRlIChTb2Z0IHRvcCBhbmQgYm90dG9tKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gc21vb3Roc3RlcCgwLjAsIDAuMywgdlV2LnkpICogc21vb3Roc3RlcCgxLjAsIDAuNiwgdlV2LnkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTY3JvbGxpbmcgUmF5cwogICAgICAgICAgICAgICAgICAgIC8vIExheWVyIDE6IFNsb3csIGJyb2FkIHJheXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBuMSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZlYzIodlV2LnggKiAyLjAgKyB1VGltZSAqIDAuMDIsIHZVdi55ICogMC41IC0gdVRpbWUgKiAwLjA1KSkucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMYXllciAyOiBGYXN0LCBpbnRlcmZlcmVuY2UgcmF5cwogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4yID0gdGV4dHVyZTJEKHROb2lzZSwgdmVjMih2VXYueCAqIDMuMCAtIHVUaW1lICogMC4wMywgdlV2LnkgKiAwLjUgLSB1VGltZSAqIDAuMSkpLnI7CgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheXMgPSBuMSAqIG4yOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IGludGVuc2l0eSBzaWduaWZpY2FudGx5IChSZW1vdmVkIHBvdyB0byBwcmV2ZW50IGNydXNoaW5nKQogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogMy4wOyAKCiAgICAgICAgICAgICAgICAgICAgLy8gR2xpc3RlbmluZyBTcGFya2xlcyAoSGlnaCBmcmVxdWVuY3kgbm9pc2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BhcmtsZSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZVdiAqIHZlYzIoOC4wLCAyLjApICsgdmVjMih1VGltZSAqIDAuMSwgdVRpbWUgKiAwLjMpKS5yOwogICAgICAgICAgICAgICAgICAgIHNwYXJrbGUgPSBwb3coc3BhcmtsZSwgNS4wKSAqIDEwLjA7IC8vIFNoYXJwIHBvaW50cwoKICAgICAgICAgICAgICAgICAgICAvLyBDb2xvcjogQ3lhbi9CbHVlL1doaXRlIChCcmlnaHRlciBiYXNlKQogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKDAuNiwgMC45LCAxLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENvbWJpbmUgKEhpZ2hlciBtdWx0aXBsaWVycykKICAgICAgICAgICAgICAgICAgICBmbG9hdCBmaW5hbEFscGhhID0gKHJheXMgKiAwLjggKyBzcGFya2xlICogMC40KSAqIGFscGhhOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIERpc3RhbmNlIGZhZGUgKG9wdGlvbmFsLCBoYW5kbGVkIGJ5IGZvZyB1c3VhbGx5IGJ1dCB3ZSB3YW50IGFkZGl0aXZlKQogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGZpbmFsQWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHRoaXMudW5pZm9ybXMsCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IHZlcnQsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogZnJhZywKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBDb250YWluZXIgZm9yIHRoZSBhbmdsZSAoUmVhbGlzdGljIExpZ2h0IFNvdXJjZSkKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgLy8gQW5nbGU6IENvbWluZyBmcm9tIHRvcC1sZWZ0IChzaW11bGF0aW5nIHN1cmZhY2Ugc3VuIHBlbmV0cmF0aW5nIGRlZXAgd2F0ZXIpCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJvdGF0aW9uLnogPSBNYXRoLlBJIC8gNTsgLy8gfjM2IGRlZ3JlZXMgdGlsdAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDEwOyAvLyB+MTggZGVncmVlcyBmb3J3YXJkCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnBvc2l0aW9uLnNldCgxMiwgOCwgMCk7IC8vIE9mZnNldCBzb3VyY2UgdG8gaGl0IGFyZW5hIGNlbnRlcgogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNvbnRhaW5lcik7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSAxMDA7IAogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5tZXNoKTsKCiAgICAgICAgICAgIC8vIEFkZCBhIHNlY29uZCBsYXllciBmb3IgY29yZSBpbnRlbnNpdHkKICAgICAgICAgICAgY29uc3QgY29yZUdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEyLCA4LCA5MCwgMTYsIDEsIHRydWUpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoID0gbmV3IFRIUkVFLk1lc2goY29yZUdlbywgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoLnJlbmRlck9yZGVyID0gMTAwOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jb3JlTWVzaCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExhenkgbG9hZCB0ZXh0dXJlCiAgICAgICAgICAgIGlmICghdGhpcy51bmlmb3Jtcy50Tm9pc2UudmFsdWUgJiYgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnROb2lzZS52YWx1ZSA9IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZTsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3cmFwcGluZyBpcyBjb3JyZWN0IGZvciB0aGUgY3lsaW5kZXIgVVZzCiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZS53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbG93bHkgcm90YXRlIHNoYWZ0cyBmb3IgZHluYW1pYyBmZWVsCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC5yb3RhdGlvbi55ICs9IGR0ICogMC4wMjsKICAgICAgICAgICAgaWYgKHRoaXMuY29yZU1lc2gpIHRoaXMuY29yZU1lc2gucm90YXRpb24ueSAtPSBkdCAqIDAuMDM7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkxpZ2h0U2hhZnRzID0gTGlnaHRTaGFmdHM7Cn0pKCk7","/LightShafts.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCiAgICBjbGFzcyBMaWdodFNoYWZ0cyB7CiAgICAgICAgY29uc3RydWN0b3Ioc2NlbmUpIHsKICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lOwogICAgICAgICAgICB0aGlzLm1lc2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zID0gewogICAgICAgICAgICAgICAgdVRpbWU6IHsgdmFsdWU6IDAgfSwKICAgICAgICAgICAgICAgIHROb2lzZTogeyB2YWx1ZTogbnVsbCB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9pbml0KCk7CiAgICAgICAgfQoKX2luaXQoKSB7CiAgICAgICAgICAgIC8vIEdlb21ldHJ5OiBBIGNsdXN0ZXIgb2YgY29uZXMvY3lsaW5kZXJzCiAgICAgICAgICAgIC8vIFdlIHVzZSBhIHNpbmdsZSBnZW9tZXRyeSB3aXRoIGluc3RhbmNpbmcgb3IgbWVyZ2VkIGdlb21ldHJ5IGZvciBwZXJmb3JtYW5jZSwKICAgICAgICAgICAgLy8gYnV0IGZvciBzaW1wbGljaXR5IGFuZCBhZXN0aGV0aWMgY29udHJvbCwgbGV0J3MgdXNlIGEgZmV3IGxhcmdlIHBsYW5lcyBvciBhIGN5bGluZGVyLgogICAgICAgICAgICAvLyBBIGxhcmdlIGN5bGluZGVyIHdpdGggb3BlbiBlbmRzIHdvcmtzIHdlbGwgZm9yIGEgInBvb2wiIHNoYWZ0IGVmZmVjdC4KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEluY3JlYXNlZCBsZW5ndGggdG8gOTAgdG8gYWNjb21tb2RhdGUgdGlsdCB3aXRob3V0IGNsaXBwaW5nIHRvcC9ib3R0b20KICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgzMCwgMjAsIDkwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaGFkZXIKICAgICAgICAgICAgY29uc3QgdmVydCA9IGAKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgICAgICB2YXJ5aW5nIHZlYzMgdlBvczsKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICB2VXYgPSB1djsKICAgICAgICAgICAgICAgICAgICB2UG9zID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNChwb3NpdGlvbiwgMS4wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKCiAgICAgICAgICAgIGNvbnN0IGZyYWcgPSBgCiAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdE5vaXNlOwogICAgICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZVdjsKICAgICAgICAgICAgICAgIHZhcnlpbmcgdmVjMyB2UG9zOwoKICAgICAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBmYWRlIChTb2Z0IHRvcCBhbmQgYm90dG9tKQogICAgICAgICAgICAgICAgICAgIGZsb2F0IGFscGhhID0gc21vb3Roc3RlcCgwLjAsIDAuMywgdlV2LnkpICogc21vb3Roc3RlcCgxLjAsIDAuNiwgdlV2LnkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTY3JvbGxpbmcgUmF5cwogICAgICAgICAgICAgICAgICAgIC8vIExheWVyIDE6IFNsb3csIGJyb2FkIHJheXMKICAgICAgICAgICAgICAgICAgICBmbG9hdCBuMSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZlYzIodlV2LnggKiAyLjAgKyB1VGltZSAqIDAuMDIsIHZVdi55ICogMC41IC0gdVRpbWUgKiAwLjA1KSkucjsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMYXllciAyOiBGYXN0LCBpbnRlcmZlcmVuY2UgcmF5cwogICAgICAgICAgICAgICAgICAgIGZsb2F0IG4yID0gdGV4dHVyZTJEKHROb2lzZSwgdmVjMih2VXYueCAqIDMuMCAtIHVUaW1lICogMC4wMywgdlV2LnkgKiAwLjUgLSB1VGltZSAqIDAuMSkpLnI7CgogICAgICAgICAgICAgICAgICAgIGZsb2F0IHJheXMgPSBuMSAqIG4yOwogICAgICAgICAgICAgICAgICAgIC8vIEJvb3N0IGludGVuc2l0eSBzaWduaWZpY2FudGx5IChSZW1vdmVkIHBvdyB0byBwcmV2ZW50IGNydXNoaW5nKQogICAgICAgICAgICAgICAgICAgIHJheXMgPSByYXlzICogMy4wOyAKCiAgICAgICAgICAgICAgICAgICAgLy8gR2xpc3RlbmluZyBTcGFya2xlcyAoSGlnaCBmcmVxdWVuY3kgbm9pc2UpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQgc3BhcmtsZSA9IHRleHR1cmUyRCh0Tm9pc2UsIHZVdiAqIHZlYzIoOC4wLCAyLjApICsgdmVjMih1VGltZSAqIDAuMSwgdVRpbWUgKiAwLjMpKS5yOwogICAgICAgICAgICAgICAgICAgIHNwYXJrbGUgPSBwb3coc3BhcmtsZSwgNS4wKSAqIDEwLjA7IC8vIFNoYXJwIHBvaW50cwoKICAgICAgICAgICAgICAgICAgICAvLyBDb2xvcjogQ3lhbi9CbHVlL1doaXRlIChCcmlnaHRlciBiYXNlKQogICAgICAgICAgICAgICAgICAgIHZlYzMgY29sb3IgPSB2ZWMzKDAuNiwgMC45LCAxLjApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENvbWJpbmUgKEhpZ2hlciBtdWx0aXBsaWVycykKICAgICAgICAgICAgICAgICAgICBmbG9hdCBmaW5hbEFscGhhID0gKHJheXMgKiAwLjggKyBzcGFya2xlICogMC40KSAqIGFscGhhOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIERpc3RhbmNlIGZhZGUgKG9wdGlvbmFsLCBoYW5kbGVkIGJ5IGZvZyB1c3VhbGx5IGJ1dCB3ZSB3YW50IGFkZGl0aXZlKQogICAgICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IsIGZpbmFsQWxwaGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBgOwoKICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgICAgICAgICAgdW5pZm9ybXM6IHRoaXMudW5pZm9ybXMsCiAgICAgICAgICAgICAgICB2ZXJ0ZXhTaGFkZXI6IHZlcnQsCiAgICAgICAgICAgICAgICBmcmFnbWVudFNoYWRlcjogZnJhZywKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgICAgICAgICAgYmxlbmRpbmc6IFRIUkVFLkFkZGl0aXZlQmxlbmRpbmcsCiAgICAgICAgICAgICAgICBkZXB0aFdyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBDb250YWluZXIgZm9yIHRoZSBhbmdsZSAoUmVhbGlzdGljIExpZ2h0IFNvdXJjZSkKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgICAgICAgICAgLy8gQW5nbGU6IENvbWluZyBmcm9tIHRvcC1sZWZ0IChzaW11bGF0aW5nIHN1cmZhY2Ugc3VuIHBlbmV0cmF0aW5nIGRlZXAgd2F0ZXIpCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJvdGF0aW9uLnogPSBNYXRoLlBJIC8gNTsgLy8gfjM2IGRlZ3JlZXMgdGlsdAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDEwOyAvLyB+MTggZGVncmVlcyBmb3J3YXJkCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnBvc2l0aW9uLnNldCgxMiwgOCwgMCk7IC8vIE9mZnNldCBzb3VyY2UgdG8gaGl0IGFyZW5hIGNlbnRlcgogICAgICAgICAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNvbnRhaW5lcik7CgogICAgICAgICAgICB0aGlzLm1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLm1lc2gucmVuZGVyT3JkZXIgPSAxMDA7IAogICAgICAgICAgICB0aGlzLm1lc2gucG9zaXRpb24uc2V0KDAsIDAsIDApOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5tZXNoKTsKCiAgICAgICAgICAgIC8vIEFkZCBhIHNlY29uZCBsYXllciBmb3IgY29yZSBpbnRlbnNpdHkKICAgICAgICAgICAgY29uc3QgY29yZUdlbyA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KDEyLCA4LCA5MCwgMTYsIDEsIHRydWUpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoID0gbmV3IFRIUkVFLk1lc2goY29yZUdlbywgbWF0ZXJpYWwpOwogICAgICAgICAgICB0aGlzLmNvcmVNZXNoLnJlbmRlck9yZGVyID0gMTAwOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQodGhpcy5jb3JlTWVzaCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGUoZHQpIHsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy51VGltZS52YWx1ZSArPSBkdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExhenkgbG9hZCB0ZXh0dXJlCiAgICAgICAgICAgIGlmICghdGhpcy51bmlmb3Jtcy50Tm9pc2UudmFsdWUgJiYgd2luZG93LmZsdXgubm9pc2VUZXh0dXJlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVuaWZvcm1zLnROb2lzZS52YWx1ZSA9IHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZTsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3cmFwcGluZyBpcyBjb3JyZWN0IGZvciB0aGUgY3lsaW5kZXIgVVZzCiAgICAgICAgICAgICAgICB3aW5kb3cuZmx1eC5ub2lzZVRleHR1cmUud3JhcFMgPSBUSFJFRS5SZXBlYXRXcmFwcGluZzsKICAgICAgICAgICAgICAgIHdpbmRvdy5mbHV4Lm5vaXNlVGV4dHVyZS53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTbG93bHkgcm90YXRlIHNoYWZ0cyBmb3IgZHluYW1pYyBmZWVsCiAgICAgICAgICAgIGlmICh0aGlzLm1lc2gpIHRoaXMubWVzaC5yb3RhdGlvbi55ICs9IGR0ICogMC4wMjsKICAgICAgICAgICAgaWYgKHRoaXMuY29yZU1lc2gpIHRoaXMuY29yZU1lc2gucm90YXRpb24ueSAtPSBkdCAqIDAuMDM7CiAgICAgICAgfQogICAgfQoKICAgIHdpbmRvdy5mbHV4LkxpZ2h0U2hhZnRzID0gTGlnaHRTaGFmdHM7Cn0pKCk7","Stadium.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFJldXNhYmxlIEdsb3cgZm9yIExpZ2h0cwogICAgY29uc3QgX2dsb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAzMik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjQsICdyZ2JhKDAsIDE3MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgNjQsIDY0KTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIGNvbnN0IF9nbG93TWF0ZXJpYWwgPSBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyAKICAgICAgICBtYXA6IF9nbG93VGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBTdGFkaXVtIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuY29udGFpbmVyKTsKCiAgICAgICAgICAgIC8vIENvbmZpZyBmb3IgIkhlcmN1bGVhbiIgc2NhbGUKLy8gQ29uZmlnIGZvciAiSGVyY3VsZWFuIiBzY2FsZQogICAgICAgICAgICB0aGlzLmNvbmZpZyA9IHsKICAgICAgICAgICAgICAgIHJhZGl1czogNjAsICAgICAgIC8vIFN0YXJ0IG91dHNpZGUgdGhlIGFyZW5hICg0OCByYWRpdXMpCiAgICAgICAgICAgICAgICB0aWVyczogNiwgICAgICAgICAvLyBOdW1iZXIgb2Ygc2VhdGluZyByaW5ncwogICAgICAgICAgICAgICAgdGllckhlaWdodDogMTIsCiAgICAgICAgICAgICAgICB0aWVyRGVwdGg6IDE1LAogICAgICAgICAgICAgICAgY3Jvd2RDb3VudDogODAwMCwgLy8gSW5jcmVhc2VkIGRlbnNpdHkKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDA4MGMxMCwgLy8gRGVlcCBkYXJrIGJsdWUvYmxhY2sKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4MDBhYWZmCiAgICAgICAgICAgIH07Cgp0aGlzLnJpbmdzID0gW107CiAgICAgICAgICAgIHRoaXMubGlnaHRTcHJpdGVzID0gW107IC8vIFN0b3JlIGxpZ2h0IHNwcml0ZXMgZm9yIGNpbmVtYXRpYyBjb250cm9sCiAgICAgICAgICAgIHRoaXMuY3Jvd2QgPSBudWxsOwogICAgICAgICAgICB0aGlzLmNyb3dkID0gbnVsbDsKCnRoaXMuX2J1aWxkQXJjaGl0ZWN0dXJlKCk7CiAgICAgICAgICAgIHRoaXMuX2J1aWxkQ3Jvd2QoKTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRIZXJjdWxlYW5SaW5ncygpOwogICAgICAgICAgICB0aGlzLl9idWlsZFN0YWRpdW1MaWdodHMoKTsKICAgICAgICB9CgogICAgICAgIF9idWlsZEFyY2hpdGVjdHVyZSgpIHsKICAgICAgICAgICAgLy8gMS4gVGhlIFZvaWQgQm93bCAoQmFja2dyb3VuZCBPY2NsdWRlcikKICAgICAgICAgICAgLy8gTWFzc2l2ZSBjeWxpbmRlciB0byBibG9jayB0aGUgdm9pZAogICAgICAgICAgICBjb25zdCBib3dsR2VvID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoMTgwLCA1MCwgMTIwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIGNvbnN0IGJvd2xNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgIGNvbG9yOiB0aGlzLmNvbmZpZy5zdHJ1Y3R1cmVDb2xvciwgCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgICAgIGZvZzogdHJ1ZSAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IGJvd2wgPSBuZXcgVEhSRUUuTWVzaChib3dsR2VvLCBib3dsTWF0KTsKICAgICAgICAgICAgYm93bC5wb3NpdGlvbi55ID0gMjA7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChib3dsKTsKCiAgICAgICAgICAgIC8vIDIuIFNlYXRpbmcgVGllcnMgKENvbmNlbnRyaWMgUmluZ3MpCiAgICAgICAgICAgIGNvbnN0IHRpZXJNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgxMTFhMjIsIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUgfSk7CiAgICAgICAgICAgIGNvbnN0IHJpbU1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwNDQ2NiB9KTsKCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMuY29uZmlnLnRpZXJzOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAoaSAqIHRoaXMuY29uZmlnLnRpZXJIZWlnaHQpIC0gMzA7CiAgICAgICAgICAgICAgICBjb25zdCBySW5uZXIgPSB0aGlzLmNvbmZpZy5yYWRpdXMgKyAoaSAqICh0aGlzLmNvbmZpZy50aWVyRGVwdGggKiAwLjgpKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJPdXRlciA9IHJJbm5lciArIHRoaXMuY29uZmlnLnRpZXJEZXB0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmxvb3IgUmluZwogICAgICAgICAgICAgICAgY29uc3QgcmluZ0dlbyA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkocklubmVyLCByT3V0ZXIsIDY0KTsKICAgICAgICAgICAgICAgIHJpbmdHZW8ucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKHJpbmdHZW8sIHRpZXJNYXQpOwogICAgICAgICAgICAgICAgbWVzaC5wb3NpdGlvbi55ID0geTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gR2xvd2luZyBSaW0gKFRoZSAiVGVjaCIgZmVlbCkKICAgICAgICAgICAgICAgIGNvbnN0IHJpbUdlbyA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KHJJbm5lciwgMC44LCA0LCA2NCk7CiAgICAgICAgICAgICAgICByaW1HZW8ucm90YXRlWChNYXRoLlBJIC8gMik7CiAgICAgICAgICAgICAgICBjb25zdCByaW0gPSBuZXcgVEhSRUUuTWVzaChyaW1HZW8sIHJpbU1hdCk7CiAgICAgICAgICAgICAgICByaW0ucG9zaXRpb24ueSA9IHk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQocmltKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gTWFzc2l2ZSBQaWxsYXJzIChUaGUgIkhlcmN1bGVhbiIgU3VwcG9ydCkKICAgICAgICAgICAgY29uc3QgcGlsbGFyR2VvID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KDgsIDIwMCwgOCk7CiAgICAgICAgICAgIGNvbnN0IHBpbGxhck1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDA1MDUwNSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTQwOyAvLyBGYXIgb3V0CiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gocGlsbGFyR2VvLCBwaWxsYXJNYXQpOwogICAgICAgICAgICAgICAgbWVzaC5wb3NpdGlvbi5zZXQoTWF0aC5jb3MoYW5nbGUpKnIsIDAsIE1hdGguc2luKGFuZ2xlKSpyKTsKICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KDAsMCwwKTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9idWlsZENyb3dkKCkgewogICAgICAgICAgICAvLyBJbnN0YW5jZWQgTWVzaCBmb3IgQ3Jvd2QgKExvdyBQb2x5LCBIaWdoIENvdW50KQogICAgICAgICAgICAvLyBVc2luZyBhIHNpbXBsZSB2ZXJ0aWNhbCBwbGFuZSB0aGF0IGZhY2VzIGNlbnRlcgogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjIsIDIuNSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAtLS0gQ1JPV0QgU0hBREVSIElNUExFTUVOVEFUSU9OIC0tLQogICAgICAgICAgICAvLyBBZGQgaW5zdGFuY2Utc3BlY2lmaWMgcmFuZG9tIG9mZnNldCBmb3IgYW5pbWF0aW9uIHZhcmlhdGlvbgogICAgICAgICAgICBjb25zdCBvZmZzZXRzID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLmNvbmZpZy5jcm93ZENvdW50KTsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5jb25maWcuY3Jvd2RDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBvZmZzZXRzW2ldID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdhT2Zmc2V0JywgbmV3IFRIUkVFLkluc3RhbmNlZEJ1ZmZlckF0dHJpYnV0ZShvZmZzZXRzLCAxKSk7CgogICAgICAgICAgICAvLyBDdXN0b20gU2hhZGVyIHZpYSBvbkJlZm9yZUNvbXBpbGUKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgc2lkZTogVEhSRUUuRG91YmxlU2lkZSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIG1hdC5vbkJlZm9yZUNvbXBpbGUgPSAoc2hhZGVyKSA9PiB7CiAgICAgICAgICAgICAgICBzaGFkZXIudW5pZm9ybXMudVRpbWUgPSB7IHZhbHVlOiAwIH07CiAgICAgICAgICAgICAgICB0aGlzLmNyb3dkVW5pZm9ybXMgPSBzaGFkZXIudW5pZm9ybXM7CgogICAgICAgICAgICAgICAgc2hhZGVyLnZlcnRleFNoYWRlciA9IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBhT2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkp1bXA7IC8vIFBhc3MgdG8gZnJhZ21lbnQgZm9yIGNvbG9yIHZhcmlhdGlvbgogICAgICAgICAgICAgICAgYCArIHNoYWRlci52ZXJ0ZXhTaGFkZXI7CgogICAgICAgICAgICAgICAgc2hhZGVyLnZlcnRleFNoYWRlciA9IHNoYWRlci52ZXJ0ZXhTaGFkZXIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAnI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4nLAogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICAgICAjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEFuaW1hdGlvbiBMb2dpYwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNwZWVkID0gOC4wOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSB1VGltZSAqIHNwZWVkICsgKGFPZmZzZXQgKiAxMDAuMCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSnVtcCAoU2luZSB3YXZlIGNsaXBwZWQpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQganVtcCA9IG1heCgwLjAsIHNpbih0KSk7CiAgICAgICAgICAgICAgICAgICAganVtcCA9IHBvdyhqdW1wLCAyLjApOyAvLyBTaGFycGVuIHRoZSBqdW1wIGN1cnZlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmFuZG9taXplIGp1bXAgaGVpZ2h0IHNsaWdodGx5CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgaGVpZ2h0ID0gMC41ICsgMC41ICogYU9mZnNldDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm1lZC55ICs9IGp1bXAgKiBoZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU3dheSAoU2lkZSB0byBzaWRlKQogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVkLnggKz0gY29zKHQgKiAwLjUpICogMC4xOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZKdW1wID0ganVtcDsKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIHNoYWRlci5mcmFnbWVudFNoYWRlciA9IGAKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZKdW1wOwogICAgICAgICAgICAgICAgYCArIHNoYWRlci5mcmFnbWVudFNoYWRlcjsKCiAgICAgICAgICAgICAgICBzaGFkZXIuZnJhZ21lbnRTaGFkZXIgPSBzaGFkZXIuZnJhZ21lbnRTaGFkZXIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAndmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7JywKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICAgICAgdmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQnJpZ2h0ZW4gd2hlbiBqdW1waW5nIChDaGVlcmluZyBlZmZlY3QpCiAgICAgICAgICAgICAgICAgICAgZGlmZnVzZUNvbG9yLnJnYiArPSB2ZWMzKDAuMikgKiB2SnVtcDsKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy5jcm93ZCA9IG5ldyBUSFJFRS5JbnN0YW5jZWRNZXNoKGdlbywgbWF0LCB0aGlzLmNvbmZpZy5jcm93ZENvdW50KTsKICAgICAgICAgICAgdGhpcy5jcm93ZC5pbnN0YW5jZU1hdHJpeC5zZXRVc2FnZShUSFJFRS5EeW5hbWljRHJhd1VzYWdlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9wdGltaXphdGlvbjogRW5hYmxlIGN1bGxpbmcgYW5kIG1hbnVhbGx5IHNldCBib3VuZGluZyBzcGhlcmUgdG8gY292ZXIgdGhlIHdob2xlIHN0YWRpdW0KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyBHUFUgZnJvbSBwcm9jZXNzaW5nIDI1MDAgaW5zdGFuY2VzIHdoZW4gdGhlIGVudGlyZSBzdHJ1Y3R1cmUgaXMgb3V0IG9mIHZpZXcKICAgICAgICAgICAgdGhpcy5jcm93ZC5mcnVzdHVtQ3VsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jcm93ZC5nZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSA9IG5ldyBUSFJFRS5TcGhlcmUobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksIDE1MCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBkdW1teSA9IG5ldyBUSFJFRS5PYmplY3QzRCgpOwogICAgICAgICAgICBjb25zdCBjb2xvciA9IG5ldyBUSFJFRS5Db2xvcigpOwogICAgICAgICAgICAKLy8gMS4gQ2FsY3VsYXRlIFRvdGFsIENpcmN1bWZlcmVuY2UgZm9yIGRpc3RyaWJ1dGlvbiB0byBlbnN1cmUgYWxsIHRpZXJzIGdldCBwZW9wbGUKICAgICAgICAgICAgbGV0IHRvdGFsQ2lyYyA9IDA7CiAgICAgICAgICAgIGNvbnN0IHRpZXJSYWRpaSA9IFtdOwogICAgICAgICAgICBmb3IobGV0IHQ9MDsgdDx0aGlzLmNvbmZpZy50aWVyczsgdCsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCByTWluID0gdGhpcy5jb25maWcucmFkaXVzICsgKHQgKiAodGhpcy5jb25maWcudGllckRlcHRoICogMC44KSkgKyAyOwogICAgICAgICAgICAgICAgY29uc3QgY2lyYyA9IDIgKiBNYXRoLlBJICogck1pbjsKICAgICAgICAgICAgICAgIHRvdGFsQ2lyYyArPSBjaXJjOwogICAgICAgICAgICAgICAgdGllclJhZGlpLnB1c2goeyByTWluOiByTWluLCBjaXJjOiBjaXJjIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgaWR4ID0gMDsKICAgICAgICAgICAgZm9yKGxldCB0PTA7IHQ8dGhpcy5jb25maWcudGllcnM7IHQrKykgewogICAgICAgICAgICAgICAgY29uc3QgeUJhc2UgPSAodCAqIHRoaXMuY29uZmlnLnRpZXJIZWlnaHQpIC0gMzA7CiAgICAgICAgICAgICAgICBjb25zdCB7IHJNaW4sIGNpcmMgfSA9IHRpZXJSYWRpaVt0XTsKICAgICAgICAgICAgICAgIGNvbnN0IHJNYXggPSByTWluICsgdGhpcy5jb25maWcudGllckRlcHRoIC0gMjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzdHJpYnV0ZSBwcm9wb3J0aW9uYWxseSBzbyB1cHBlciByb3dzIGRvbid0IGdldCBjdXQgb2ZmCiAgICAgICAgICAgICAgICBjb25zdCBjb3VudFBlclRpZXIgPSBNYXRoLmZsb29yKHRoaXMuY29uZmlnLmNyb3dkQ291bnQgKiAoY2lyYyAvIHRvdGFsQ2lyYykpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudFBlclRpZXI7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChpZHggPj0gdGhpcy5jb25maWcuY3Jvd2RDb3VudCkgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSByTWluICsgTWF0aC5yYW5kb20oKSAqIChyTWF4IC0gck1pbik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZHVtbXkucG9zaXRpb24uc2V0KAogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmNvcyhhbmdsZSkgKiByLAogICAgICAgICAgICAgICAgICAgICAgICB5QmFzZSArIDEuMjUsIC8vIENlbnRlciBvZiBxdWFkCiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguc2luKGFuZ2xlKSAqIHIKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyCiAgICAgICAgICAgICAgICAgICAgZHVtbXkubG9va0F0KDAsIHlCYXNlLCAwKTsKICAgICAgICAgICAgICAgICAgICBkdW1teS51cGRhdGVNYXRyaXgoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLmNyb3dkLnNldE1hdHJpeEF0KGlkeCwgZHVtbXkubWF0cml4KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSYW5kb20gVGVhbSBDb2xvcnMgKFNpbXVsYXRpbmcgZmFucykKICAgICAgICAgICAgICAgICAgICBjb25zdCByYW5kID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmFuZCA8IDAuNDUpIGNvbG9yLnNldEhleCgweDAwODhmZik7IC8vIEhvbWUgQmx1ZQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHJhbmQgPCAwLjkpIGNvbG9yLnNldEhleCgweGZmNDQ0NCk7IC8vIEF3YXkgUmVkCiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb2xvci5zZXRIZXgoMHhmZmZmZmYpOyAvLyBOZXV0cmFsL0ZsYXNoCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVmFyeSBicmlnaHRuZXNzIGZvciBkZXB0aAogICAgICAgICAgICAgICAgICAgIGNvbG9yLm11bHRpcGx5U2NhbGFyKDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2Quc2V0Q29sb3JBdChpZHgsIGNvbG9yKTsKICAgICAgICAgICAgICAgICAgICBpZHgrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHRoaXMuY3Jvd2QpOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkSGVyY3VsZWFuUmluZ3MoKSB7CiAgICAgICAgICAgIC8vIE1hc3NpdmUgZmxvYXRpbmcgcmluZ3MgdGhhdCByb3RhdGUgc2xvd2x5CiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4NDQ1NTY2LCAKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuMywKICAgICAgICAgICAgICAgIHdpcmVmcmFtZTogdHJ1ZSAvLyBUZWNoL0hvbG9ncmFwaGljIGZlZWwKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyAxLiBFcXVhdG9yaWFsIFJpbmcgKE1hc3NpdmUpCiAgICAgICAgICAgIGNvbnN0IGdlbzEgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxMTAsIDEsIDE2LCAxMDApOwogICAgICAgICAgICBjb25zdCByaW5nMSA9IG5ldyBUSFJFRS5NZXNoKGdlbzEsIG1hdCk7CiAgICAgICAgICAgIHJpbmcxLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmcxKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzEsIGF4aXM6ICd6Jywgc3BlZWQ6IDAuMDEgfSk7CgogICAgICAgICAgICAvLyAyLiBUaWx0ZWQgUmluZwogICAgICAgICAgICBjb25zdCBnZW8yID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkoMTMwLCAyLCAxNiwgMTAwKTsKICAgICAgICAgICAgY29uc3QgcmluZzIgPSBuZXcgVEhSRUUuTWVzaChnZW8yLCBtYXQpOwogICAgICAgICAgICByaW5nMi5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDM7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW5nMik7CiAgICAgICAgICAgIHRoaXMucmluZ3MucHVzaCh7IG1lc2g6IHJpbmcyLCBheGlzOiAneScsIHNwZWVkOiAtMC4wMDggfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBWZXJ0aWNhbCBSaW5nCiAgICAgICAgICAgIGNvbnN0IGdlbzMgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxNTAsIDMsIDE2LCAxMDApOwpjb25zdCByaW5nMyA9IG5ldyBUSFJFRS5NZXNoKGdlbzMsIG1hdCk7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW5nMyk7CiAgICAgICAgICAgIHRoaXMucmluZ3MucHVzaCh7IG1lc2g6IHJpbmczLCBheGlzOiAneScsIHNwZWVkOiAwLjAwNSB9KTsKICAgICAgICB9CgogICAgICAgIF9idWlsZFN0YWRpdW1MaWdodHMoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gMTY7IC8vIE51bWJlciBvZiBsaWdodHMgYXJvdW5kIHRoZSBlcXVhdG9yCiAgICAgICAgICAgIGNvbnN0IHJhZGl1cyA9IDM2OyAvLyBKdXN0IG91dHNpZGUgdGhlIGFyZW5hIGJvdW5kYXJ5ICgzMikKICAgICAgICAgICAgY29uc3QgeVBvcyA9IDA7IC8vIE1pZGRsZSBvZiB0aGUgc3BoZXJlCiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBsaWdodEdlbyA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeSgwLjQsIDgsIDgpOwogICAgICAgICAgICBjb25zdCBsaWdodE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmZmZmZiB9KTsKCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gKGkgLyBjb3VudCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLmNvcyhhbmdsZSkgKiByYWRpdXM7CiAgICAgICAgICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4oYW5nbGUpICogcmFkaXVzOwoKICAgICAgICAgICAgICAgIC8vIDEuIFBoeXNpY2FsIEZpeHR1cmUgKFRoZSBidWxiKQogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGxpZ2h0R2VvLCBsaWdodE1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnNldCh4LCB5UG9zLCB6KTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBWaXN1YWwgR2xvdyAoRmxhcmUpCiAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSBuZXcgVEhSRUUuU3ByaXRlKF9nbG93TWF0ZXJpYWwpOwovLyAyLiBWaXN1YWwgR2xvdyAoRmxhcmUpCgogICAgICAgICAgICAgICAgc3ByaXRlLnBvc2l0aW9uLnNldCh4LCB5UG9zLCB6KTsKICAgICAgICAgICAgICAgIHNwcml0ZS5zY2FsZS5zZXQoOCwgOCwgMSk7IC8vIExhcmdlIGdsb3cKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChzcHJpdGUpOwogICAgICAgICAgICAgICAgdGhpcy5saWdodFNwcml0ZXMucHVzaChzcHJpdGUpOwoKLy8gMy4gQWN0dWFsIFBvaW50IExpZ2h0IC0gUkVNT1ZFRCBmb3Igb3B0aW1pemF0aW9uCiAgICAgICAgICAgICAgICAvLyBTaW5jZSB3ZSB1c2UgTWVzaEJhc2ljTWF0ZXJpYWwgKFVubGl0KSwgcmVhbCBsaWdodHMgd2FzdGUgQ1BVL0dQVSByZXNvdXJjZXMuCiAgICAgICAgICAgICAgICAvLyBUaGUgc3ByaXRlIGdsb3cgYWJvdmUgcHJvdmlkZXMgdGhlIHZpc3VhbCBlZmZlY3QuCiAgICAgICAgICAgIH0KICAgICAgICB9CnVwZGF0ZShkdCkgewogICAgICAgICAgICAvLyBBbmltYXRlIFJpbmdzCiAgICAgICAgICAgIHRoaXMucmluZ3MuZm9yRWFjaChyID0+IHsKICAgICAgICAgICAgICAgIGlmIChyLm1lc2ggJiYgci5heGlzKSB7CiAgICAgICAgICAgICAgICAgICAgci5tZXNoLnJvdGF0aW9uW3IuYXhpc10gKz0gci5zcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBDcm93ZCBTaGFkZXIKICAgICAgICAgICAgaWYgKHRoaXMuY3Jvd2RVbmlmb3JtcykgewogICAgICAgICAgICAgICAgdGhpcy5jcm93ZFVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgTGlnaHQgUG9wcyAoQ2luZW1hdGljKQogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcy5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICAgICAgaWYgKHMudmlzaWJsZSAmJiBzLnNjYWxlLnggPiA4LjApIHsKICAgICAgICAgICAgICAgICAgICAvLyBEZWNheSBwb3AgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgcy5zY2FsZS54IC09IGR0ICogMzAuMDsKICAgICAgICAgICAgICAgICAgICBzLnNjYWxlLnkgLT0gZHQgKiAzMC4wOwogICAgICAgICAgICAgICAgICAgIGlmIChzLnNjYWxlLnggPCA4LjApIHMuc2NhbGUuc2V0KDgsIDgsIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgpzZXRBbGxMaWdodHModmlzaWJsZSkgewogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcy5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICAgICAgcy52aXNpYmxlID0gdmlzaWJsZTsKICAgICAgICAgICAgICAgIHMuc2NhbGUuc2V0KDgsIDgsIDEpOyAvLyBSZXNldCBzY2FsZQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGdldCBsaWdodENvdW50KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5saWdodFNwcml0ZXMubGVuZ3RoOwogICAgICAgIH0KCiAgICAgICAgcmVzZXRMaWdodHMoKSB7CiAgICAgICAgICAgIHRoaXMuc2V0QWxsTGlnaHRzKGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIHR1cm5PbkxpZ2h0KGluZGV4KSB7CgogICAgICAgICAgICBpZiAodGhpcy5saWdodFNwcml0ZXNbaW5kZXhdKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzID0gdGhpcy5saWdodFNwcml0ZXNbaW5kZXhdOwogICAgICAgICAgICAgICAgcy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHMubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIHMuc2NhbGUuc2V0KDIwLCAyMCwgMSk7IC8vIFBvcCBlZmZlY3QKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5TdGFkaXVtID0gU3RhZGl1bTsKfSkoKTs=","./Stadium.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFJldXNhYmxlIEdsb3cgZm9yIExpZ2h0cwogICAgY29uc3QgX2dsb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAzMik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjQsICdyZ2JhKDAsIDE3MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgNjQsIDY0KTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIGNvbnN0IF9nbG93TWF0ZXJpYWwgPSBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyAKICAgICAgICBtYXA6IF9nbG93VGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBTdGFkaXVtIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuY29udGFpbmVyKTsKCiAgICAgICAgICAgIC8vIENvbmZpZyBmb3IgIkhlcmN1bGVhbiIgc2NhbGUKLy8gQ29uZmlnIGZvciAiSGVyY3VsZWFuIiBzY2FsZQogICAgICAgICAgICB0aGlzLmNvbmZpZyA9IHsKICAgICAgICAgICAgICAgIHJhZGl1czogNjAsICAgICAgIC8vIFN0YXJ0IG91dHNpZGUgdGhlIGFyZW5hICg0OCByYWRpdXMpCiAgICAgICAgICAgICAgICB0aWVyczogNiwgICAgICAgICAvLyBOdW1iZXIgb2Ygc2VhdGluZyByaW5ncwogICAgICAgICAgICAgICAgdGllckhlaWdodDogMTIsCiAgICAgICAgICAgICAgICB0aWVyRGVwdGg6IDE1LAogICAgICAgICAgICAgICAgY3Jvd2RDb3VudDogODAwMCwgLy8gSW5jcmVhc2VkIGRlbnNpdHkKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDA4MGMxMCwgLy8gRGVlcCBkYXJrIGJsdWUvYmxhY2sKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4MDBhYWZmCiAgICAgICAgICAgIH07Cgp0aGlzLnJpbmdzID0gW107CiAgICAgICAgICAgIHRoaXMubGlnaHRTcHJpdGVzID0gW107IC8vIFN0b3JlIGxpZ2h0IHNwcml0ZXMgZm9yIGNpbmVtYXRpYyBjb250cm9sCiAgICAgICAgICAgIHRoaXMuY3Jvd2QgPSBudWxsOwogICAgICAgICAgICB0aGlzLmNyb3dkID0gbnVsbDsKCnRoaXMuX2J1aWxkQXJjaGl0ZWN0dXJlKCk7CiAgICAgICAgICAgIHRoaXMuX2J1aWxkQ3Jvd2QoKTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRIZXJjdWxlYW5SaW5ncygpOwogICAgICAgICAgICB0aGlzLl9idWlsZFN0YWRpdW1MaWdodHMoKTsKICAgICAgICB9CgogICAgICAgIF9idWlsZEFyY2hpdGVjdHVyZSgpIHsKICAgICAgICAgICAgLy8gMS4gVGhlIFZvaWQgQm93bCAoQmFja2dyb3VuZCBPY2NsdWRlcikKICAgICAgICAgICAgLy8gTWFzc2l2ZSBjeWxpbmRlciB0byBibG9jayB0aGUgdm9pZAogICAgICAgICAgICBjb25zdCBib3dsR2VvID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoMTgwLCA1MCwgMTIwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIGNvbnN0IGJvd2xNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgIGNvbG9yOiB0aGlzLmNvbmZpZy5zdHJ1Y3R1cmVDb2xvciwgCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgICAgIGZvZzogdHJ1ZSAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IGJvd2wgPSBuZXcgVEhSRUUuTWVzaChib3dsR2VvLCBib3dsTWF0KTsKICAgICAgICAgICAgYm93bC5wb3NpdGlvbi55ID0gMjA7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChib3dsKTsKCiAgICAgICAgICAgIC8vIDIuIFNlYXRpbmcgVGllcnMgKENvbmNlbnRyaWMgUmluZ3MpCiAgICAgICAgICAgIGNvbnN0IHRpZXJNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgxMTFhMjIsIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUgfSk7CiAgICAgICAgICAgIGNvbnN0IHJpbU1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwNDQ2NiB9KTsKCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMuY29uZmlnLnRpZXJzOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAoaSAqIHRoaXMuY29uZmlnLnRpZXJIZWlnaHQpIC0gMzA7CiAgICAgICAgICAgICAgICBjb25zdCBySW5uZXIgPSB0aGlzLmNvbmZpZy5yYWRpdXMgKyAoaSAqICh0aGlzLmNvbmZpZy50aWVyRGVwdGggKiAwLjgpKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJPdXRlciA9IHJJbm5lciArIHRoaXMuY29uZmlnLnRpZXJEZXB0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmxvb3IgUmluZwogICAgICAgICAgICAgICAgY29uc3QgcmluZ0dlbyA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkocklubmVyLCByT3V0ZXIsIDY0KTsKICAgICAgICAgICAgICAgIHJpbmdHZW8ucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKHJpbmdHZW8sIHRpZXJNYXQpOwogICAgICAgICAgICAgICAgbWVzaC5wb3NpdGlvbi55ID0geTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gR2xvd2luZyBSaW0gKFRoZSAiVGVjaCIgZmVlbCkKICAgICAgICAgICAgICAgIGNvbnN0IHJpbUdlbyA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KHJJbm5lciwgMC44LCA0LCA2NCk7CiAgICAgICAgICAgICAgICByaW1HZW8ucm90YXRlWChNYXRoLlBJIC8gMik7CiAgICAgICAgICAgICAgICBjb25zdCByaW0gPSBuZXcgVEhSRUUuTWVzaChyaW1HZW8sIHJpbU1hdCk7CiAgICAgICAgICAgICAgICByaW0ucG9zaXRpb24ueSA9IHk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQocmltKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gTWFzc2l2ZSBQaWxsYXJzIChUaGUgIkhlcmN1bGVhbiIgU3VwcG9ydCkKICAgICAgICAgICAgY29uc3QgcGlsbGFyR2VvID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KDgsIDIwMCwgOCk7CiAgICAgICAgICAgIGNvbnN0IHBpbGxhck1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDA1MDUwNSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTQwOyAvLyBGYXIgb3V0CiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gocGlsbGFyR2VvLCBwaWxsYXJNYXQpOwogICAgICAgICAgICAgICAgbWVzaC5wb3NpdGlvbi5zZXQoTWF0aC5jb3MoYW5nbGUpKnIsIDAsIE1hdGguc2luKGFuZ2xlKSpyKTsKICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KDAsMCwwKTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9idWlsZENyb3dkKCkgewogICAgICAgICAgICAvLyBJbnN0YW5jZWQgTWVzaCBmb3IgQ3Jvd2QgKExvdyBQb2x5LCBIaWdoIENvdW50KQogICAgICAgICAgICAvLyBVc2luZyBhIHNpbXBsZSB2ZXJ0aWNhbCBwbGFuZSB0aGF0IGZhY2VzIGNlbnRlcgogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjIsIDIuNSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAtLS0gQ1JPV0QgU0hBREVSIElNUExFTUVOVEFUSU9OIC0tLQogICAgICAgICAgICAvLyBBZGQgaW5zdGFuY2Utc3BlY2lmaWMgcmFuZG9tIG9mZnNldCBmb3IgYW5pbWF0aW9uIHZhcmlhdGlvbgogICAgICAgICAgICBjb25zdCBvZmZzZXRzID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLmNvbmZpZy5jcm93ZENvdW50KTsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5jb25maWcuY3Jvd2RDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBvZmZzZXRzW2ldID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdhT2Zmc2V0JywgbmV3IFRIUkVFLkluc3RhbmNlZEJ1ZmZlckF0dHJpYnV0ZShvZmZzZXRzLCAxKSk7CgogICAgICAgICAgICAvLyBDdXN0b20gU2hhZGVyIHZpYSBvbkJlZm9yZUNvbXBpbGUKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgc2lkZTogVEhSRUUuRG91YmxlU2lkZSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIG1hdC5vbkJlZm9yZUNvbXBpbGUgPSAoc2hhZGVyKSA9PiB7CiAgICAgICAgICAgICAgICBzaGFkZXIudW5pZm9ybXMudVRpbWUgPSB7IHZhbHVlOiAwIH07CiAgICAgICAgICAgICAgICB0aGlzLmNyb3dkVW5pZm9ybXMgPSBzaGFkZXIudW5pZm9ybXM7CgogICAgICAgICAgICAgICAgc2hhZGVyLnZlcnRleFNoYWRlciA9IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBhT2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkp1bXA7IC8vIFBhc3MgdG8gZnJhZ21lbnQgZm9yIGNvbG9yIHZhcmlhdGlvbgogICAgICAgICAgICAgICAgYCArIHNoYWRlci52ZXJ0ZXhTaGFkZXI7CgogICAgICAgICAgICAgICAgc2hhZGVyLnZlcnRleFNoYWRlciA9IHNoYWRlci52ZXJ0ZXhTaGFkZXIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAnI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4nLAogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICAgICAjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEFuaW1hdGlvbiBMb2dpYwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNwZWVkID0gOC4wOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSB1VGltZSAqIHNwZWVkICsgKGFPZmZzZXQgKiAxMDAuMCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSnVtcCAoU2luZSB3YXZlIGNsaXBwZWQpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQganVtcCA9IG1heCgwLjAsIHNpbih0KSk7CiAgICAgICAgICAgICAgICAgICAganVtcCA9IHBvdyhqdW1wLCAyLjApOyAvLyBTaGFycGVuIHRoZSBqdW1wIGN1cnZlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmFuZG9taXplIGp1bXAgaGVpZ2h0IHNsaWdodGx5CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgaGVpZ2h0ID0gMC41ICsgMC41ICogYU9mZnNldDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm1lZC55ICs9IGp1bXAgKiBoZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU3dheSAoU2lkZSB0byBzaWRlKQogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVkLnggKz0gY29zKHQgKiAwLjUpICogMC4xOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZKdW1wID0ganVtcDsKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIHNoYWRlci5mcmFnbWVudFNoYWRlciA9IGAKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZKdW1wOwogICAgICAgICAgICAgICAgYCArIHNoYWRlci5mcmFnbWVudFNoYWRlcjsKCiAgICAgICAgICAgICAgICBzaGFkZXIuZnJhZ21lbnRTaGFkZXIgPSBzaGFkZXIuZnJhZ21lbnRTaGFkZXIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAndmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7JywKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICAgICAgdmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQnJpZ2h0ZW4gd2hlbiBqdW1waW5nIChDaGVlcmluZyBlZmZlY3QpCiAgICAgICAgICAgICAgICAgICAgZGlmZnVzZUNvbG9yLnJnYiArPSB2ZWMzKDAuMikgKiB2SnVtcDsKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy5jcm93ZCA9IG5ldyBUSFJFRS5JbnN0YW5jZWRNZXNoKGdlbywgbWF0LCB0aGlzLmNvbmZpZy5jcm93ZENvdW50KTsKICAgICAgICAgICAgdGhpcy5jcm93ZC5pbnN0YW5jZU1hdHJpeC5zZXRVc2FnZShUSFJFRS5EeW5hbWljRHJhd1VzYWdlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9wdGltaXphdGlvbjogRW5hYmxlIGN1bGxpbmcgYW5kIG1hbnVhbGx5IHNldCBib3VuZGluZyBzcGhlcmUgdG8gY292ZXIgdGhlIHdob2xlIHN0YWRpdW0KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyBHUFUgZnJvbSBwcm9jZXNzaW5nIDI1MDAgaW5zdGFuY2VzIHdoZW4gdGhlIGVudGlyZSBzdHJ1Y3R1cmUgaXMgb3V0IG9mIHZpZXcKICAgICAgICAgICAgdGhpcy5jcm93ZC5mcnVzdHVtQ3VsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jcm93ZC5nZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSA9IG5ldyBUSFJFRS5TcGhlcmUobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksIDE1MCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBkdW1teSA9IG5ldyBUSFJFRS5PYmplY3QzRCgpOwogICAgICAgICAgICBjb25zdCBjb2xvciA9IG5ldyBUSFJFRS5Db2xvcigpOwogICAgICAgICAgICAKLy8gMS4gQ2FsY3VsYXRlIFRvdGFsIENpcmN1bWZlcmVuY2UgZm9yIGRpc3RyaWJ1dGlvbiB0byBlbnN1cmUgYWxsIHRpZXJzIGdldCBwZW9wbGUKICAgICAgICAgICAgbGV0IHRvdGFsQ2lyYyA9IDA7CiAgICAgICAgICAgIGNvbnN0IHRpZXJSYWRpaSA9IFtdOwogICAgICAgICAgICBmb3IobGV0IHQ9MDsgdDx0aGlzLmNvbmZpZy50aWVyczsgdCsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCByTWluID0gdGhpcy5jb25maWcucmFkaXVzICsgKHQgKiAodGhpcy5jb25maWcudGllckRlcHRoICogMC44KSkgKyAyOwogICAgICAgICAgICAgICAgY29uc3QgY2lyYyA9IDIgKiBNYXRoLlBJICogck1pbjsKICAgICAgICAgICAgICAgIHRvdGFsQ2lyYyArPSBjaXJjOwogICAgICAgICAgICAgICAgdGllclJhZGlpLnB1c2goeyByTWluOiByTWluLCBjaXJjOiBjaXJjIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgaWR4ID0gMDsKICAgICAgICAgICAgZm9yKGxldCB0PTA7IHQ8dGhpcy5jb25maWcudGllcnM7IHQrKykgewogICAgICAgICAgICAgICAgY29uc3QgeUJhc2UgPSAodCAqIHRoaXMuY29uZmlnLnRpZXJIZWlnaHQpIC0gMzA7CiAgICAgICAgICAgICAgICBjb25zdCB7IHJNaW4sIGNpcmMgfSA9IHRpZXJSYWRpaVt0XTsKICAgICAgICAgICAgICAgIGNvbnN0IHJNYXggPSByTWluICsgdGhpcy5jb25maWcudGllckRlcHRoIC0gMjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzdHJpYnV0ZSBwcm9wb3J0aW9uYWxseSBzbyB1cHBlciByb3dzIGRvbid0IGdldCBjdXQgb2ZmCiAgICAgICAgICAgICAgICBjb25zdCBjb3VudFBlclRpZXIgPSBNYXRoLmZsb29yKHRoaXMuY29uZmlnLmNyb3dkQ291bnQgKiAoY2lyYyAvIHRvdGFsQ2lyYykpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudFBlclRpZXI7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChpZHggPj0gdGhpcy5jb25maWcuY3Jvd2RDb3VudCkgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSByTWluICsgTWF0aC5yYW5kb20oKSAqIChyTWF4IC0gck1pbik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZHVtbXkucG9zaXRpb24uc2V0KAogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmNvcyhhbmdsZSkgKiByLAogICAgICAgICAgICAgICAgICAgICAgICB5QmFzZSArIDEuMjUsIC8vIENlbnRlciBvZiBxdWFkCiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguc2luKGFuZ2xlKSAqIHIKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyCiAgICAgICAgICAgICAgICAgICAgZHVtbXkubG9va0F0KDAsIHlCYXNlLCAwKTsKICAgICAgICAgICAgICAgICAgICBkdW1teS51cGRhdGVNYXRyaXgoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLmNyb3dkLnNldE1hdHJpeEF0KGlkeCwgZHVtbXkubWF0cml4KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSYW5kb20gVGVhbSBDb2xvcnMgKFNpbXVsYXRpbmcgZmFucykKICAgICAgICAgICAgICAgICAgICBjb25zdCByYW5kID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmFuZCA8IDAuNDUpIGNvbG9yLnNldEhleCgweDAwODhmZik7IC8vIEhvbWUgQmx1ZQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHJhbmQgPCAwLjkpIGNvbG9yLnNldEhleCgweGZmNDQ0NCk7IC8vIEF3YXkgUmVkCiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb2xvci5zZXRIZXgoMHhmZmZmZmYpOyAvLyBOZXV0cmFsL0ZsYXNoCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVmFyeSBicmlnaHRuZXNzIGZvciBkZXB0aAogICAgICAgICAgICAgICAgICAgIGNvbG9yLm11bHRpcGx5U2NhbGFyKDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2Quc2V0Q29sb3JBdChpZHgsIGNvbG9yKTsKICAgICAgICAgICAgICAgICAgICBpZHgrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHRoaXMuY3Jvd2QpOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkSGVyY3VsZWFuUmluZ3MoKSB7CiAgICAgICAgICAgIC8vIE1hc3NpdmUgZmxvYXRpbmcgcmluZ3MgdGhhdCByb3RhdGUgc2xvd2x5CiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4NDQ1NTY2LCAKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuMywKICAgICAgICAgICAgICAgIHdpcmVmcmFtZTogdHJ1ZSAvLyBUZWNoL0hvbG9ncmFwaGljIGZlZWwKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyAxLiBFcXVhdG9yaWFsIFJpbmcgKE1hc3NpdmUpCiAgICAgICAgICAgIGNvbnN0IGdlbzEgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxMTAsIDEsIDE2LCAxMDApOwogICAgICAgICAgICBjb25zdCByaW5nMSA9IG5ldyBUSFJFRS5NZXNoKGdlbzEsIG1hdCk7CiAgICAgICAgICAgIHJpbmcxLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmcxKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzEsIGF4aXM6ICd6Jywgc3BlZWQ6IDAuMDEgfSk7CgogICAgICAgICAgICAvLyAyLiBUaWx0ZWQgUmluZwogICAgICAgICAgICBjb25zdCBnZW8yID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkoMTMwLCAyLCAxNiwgMTAwKTsKICAgICAgICAgICAgY29uc3QgcmluZzIgPSBuZXcgVEhSRUUuTWVzaChnZW8yLCBtYXQpOwogICAgICAgICAgICByaW5nMi5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDM7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW5nMik7CiAgICAgICAgICAgIHRoaXMucmluZ3MucHVzaCh7IG1lc2g6IHJpbmcyLCBheGlzOiAneScsIHNwZWVkOiAtMC4wMDggfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBWZXJ0aWNhbCBSaW5nCiAgICAgICAgICAgIGNvbnN0IGdlbzMgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxNTAsIDMsIDE2LCAxMDApOwpjb25zdCByaW5nMyA9IG5ldyBUSFJFRS5NZXNoKGdlbzMsIG1hdCk7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW5nMyk7CiAgICAgICAgICAgIHRoaXMucmluZ3MucHVzaCh7IG1lc2g6IHJpbmczLCBheGlzOiAneScsIHNwZWVkOiAwLjAwNSB9KTsKICAgICAgICB9CgogICAgICAgIF9idWlsZFN0YWRpdW1MaWdodHMoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gMTY7IC8vIE51bWJlciBvZiBsaWdodHMgYXJvdW5kIHRoZSBlcXVhdG9yCiAgICAgICAgICAgIGNvbnN0IHJhZGl1cyA9IDM2OyAvLyBKdXN0IG91dHNpZGUgdGhlIGFyZW5hIGJvdW5kYXJ5ICgzMikKICAgICAgICAgICAgY29uc3QgeVBvcyA9IDA7IC8vIE1pZGRsZSBvZiB0aGUgc3BoZXJlCiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBsaWdodEdlbyA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeSgwLjQsIDgsIDgpOwogICAgICAgICAgICBjb25zdCBsaWdodE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmZmZmZiB9KTsKCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gKGkgLyBjb3VudCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLmNvcyhhbmdsZSkgKiByYWRpdXM7CiAgICAgICAgICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4oYW5nbGUpICogcmFkaXVzOwoKICAgICAgICAgICAgICAgIC8vIDEuIFBoeXNpY2FsIEZpeHR1cmUgKFRoZSBidWxiKQogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGxpZ2h0R2VvLCBsaWdodE1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnNldCh4LCB5UG9zLCB6KTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBWaXN1YWwgR2xvdyAoRmxhcmUpCiAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSBuZXcgVEhSRUUuU3ByaXRlKF9nbG93TWF0ZXJpYWwpOwovLyAyLiBWaXN1YWwgR2xvdyAoRmxhcmUpCgogICAgICAgICAgICAgICAgc3ByaXRlLnBvc2l0aW9uLnNldCh4LCB5UG9zLCB6KTsKICAgICAgICAgICAgICAgIHNwcml0ZS5zY2FsZS5zZXQoOCwgOCwgMSk7IC8vIExhcmdlIGdsb3cKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChzcHJpdGUpOwogICAgICAgICAgICAgICAgdGhpcy5saWdodFNwcml0ZXMucHVzaChzcHJpdGUpOwoKLy8gMy4gQWN0dWFsIFBvaW50IExpZ2h0IC0gUkVNT1ZFRCBmb3Igb3B0aW1pemF0aW9uCiAgICAgICAgICAgICAgICAvLyBTaW5jZSB3ZSB1c2UgTWVzaEJhc2ljTWF0ZXJpYWwgKFVubGl0KSwgcmVhbCBsaWdodHMgd2FzdGUgQ1BVL0dQVSByZXNvdXJjZXMuCiAgICAgICAgICAgICAgICAvLyBUaGUgc3ByaXRlIGdsb3cgYWJvdmUgcHJvdmlkZXMgdGhlIHZpc3VhbCBlZmZlY3QuCiAgICAgICAgICAgIH0KICAgICAgICB9CnVwZGF0ZShkdCkgewogICAgICAgICAgICAvLyBBbmltYXRlIFJpbmdzCiAgICAgICAgICAgIHRoaXMucmluZ3MuZm9yRWFjaChyID0+IHsKICAgICAgICAgICAgICAgIGlmIChyLm1lc2ggJiYgci5heGlzKSB7CiAgICAgICAgICAgICAgICAgICAgci5tZXNoLnJvdGF0aW9uW3IuYXhpc10gKz0gci5zcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBDcm93ZCBTaGFkZXIKICAgICAgICAgICAgaWYgKHRoaXMuY3Jvd2RVbmlmb3JtcykgewogICAgICAgICAgICAgICAgdGhpcy5jcm93ZFVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgTGlnaHQgUG9wcyAoQ2luZW1hdGljKQogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcy5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICAgICAgaWYgKHMudmlzaWJsZSAmJiBzLnNjYWxlLnggPiA4LjApIHsKICAgICAgICAgICAgICAgICAgICAvLyBEZWNheSBwb3AgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgcy5zY2FsZS54IC09IGR0ICogMzAuMDsKICAgICAgICAgICAgICAgICAgICBzLnNjYWxlLnkgLT0gZHQgKiAzMC4wOwogICAgICAgICAgICAgICAgICAgIGlmIChzLnNjYWxlLnggPCA4LjApIHMuc2NhbGUuc2V0KDgsIDgsIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgpzZXRBbGxMaWdodHModmlzaWJsZSkgewogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcy5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICAgICAgcy52aXNpYmxlID0gdmlzaWJsZTsKICAgICAgICAgICAgICAgIHMuc2NhbGUuc2V0KDgsIDgsIDEpOyAvLyBSZXNldCBzY2FsZQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGdldCBsaWdodENvdW50KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5saWdodFNwcml0ZXMubGVuZ3RoOwogICAgICAgIH0KCiAgICAgICAgcmVzZXRMaWdodHMoKSB7CiAgICAgICAgICAgIHRoaXMuc2V0QWxsTGlnaHRzKGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIHR1cm5PbkxpZ2h0KGluZGV4KSB7CgogICAgICAgICAgICBpZiAodGhpcy5saWdodFNwcml0ZXNbaW5kZXhdKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzID0gdGhpcy5saWdodFNwcml0ZXNbaW5kZXhdOwogICAgICAgICAgICAgICAgcy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHMubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIHMuc2NhbGUuc2V0KDIwLCAyMCwgMSk7IC8vIFBvcCBlZmZlY3QKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5TdGFkaXVtID0gU3RhZGl1bTsKfSkoKTs=","/Stadium.js":"data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICAgd2luZG93LmZsdXggPSB3aW5kb3cuZmx1eCB8fCB7fTsKCi8vIFJldXNhYmxlIEdsb3cgZm9yIExpZ2h0cwogICAgY29uc3QgX2dsb3dUZXh0dXJlID0gKCgpID0+IHsKICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgYy53aWR0aCA9IDY0OyBjLmhlaWdodCA9IDY0OwogICAgICAgIGNvbnN0IGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBnID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KDMyLCAzMiwgMCwgMzIsIDMyLCAzMik7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTsKICAgICAgICBnLmFkZENvbG9yU3RvcCgwLjQsICdyZ2JhKDAsIDE3MCwgMjU1LCAwLjQpJyk7CiAgICAgICAgZy5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMCwgMCwgMCwgMCknKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZzsKICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgNjQsIDY0KTsKICAgICAgICByZXR1cm4gbmV3IFRIUkVFLkNhbnZhc1RleHR1cmUoYyk7CiAgICB9KSgpOwoKICAgIGNvbnN0IF9nbG93TWF0ZXJpYWwgPSBuZXcgVEhSRUUuU3ByaXRlTWF0ZXJpYWwoeyAKICAgICAgICBtYXA6IF9nbG93VGV4dHVyZSwgCiAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsIAogICAgICAgIGJsZW5kaW5nOiBUSFJFRS5BZGRpdGl2ZUJsZW5kaW5nLAogICAgICAgIGRlcHRoV3JpdGU6IGZhbHNlCiAgICB9KTsKCiAgICBjbGFzcyBTdGFkaXVtIHsKICAgICAgICBjb25zdHJ1Y3RvcihzY2VuZSkgewogICAgICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbmV3IFRIUkVFLkdyb3VwKCk7CiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuY29udGFpbmVyKTsKCiAgICAgICAgICAgIC8vIENvbmZpZyBmb3IgIkhlcmN1bGVhbiIgc2NhbGUKLy8gQ29uZmlnIGZvciAiSGVyY3VsZWFuIiBzY2FsZQogICAgICAgICAgICB0aGlzLmNvbmZpZyA9IHsKICAgICAgICAgICAgICAgIHJhZGl1czogNjAsICAgICAgIC8vIFN0YXJ0IG91dHNpZGUgdGhlIGFyZW5hICg0OCByYWRpdXMpCiAgICAgICAgICAgICAgICB0aWVyczogNiwgICAgICAgICAvLyBOdW1iZXIgb2Ygc2VhdGluZyByaW5ncwogICAgICAgICAgICAgICAgdGllckhlaWdodDogMTIsCiAgICAgICAgICAgICAgICB0aWVyRGVwdGg6IDE1LAogICAgICAgICAgICAgICAgY3Jvd2RDb3VudDogODAwMCwgLy8gSW5jcmVhc2VkIGRlbnNpdHkKICAgICAgICAgICAgICAgIHN0cnVjdHVyZUNvbG9yOiAweDA4MGMxMCwgLy8gRGVlcCBkYXJrIGJsdWUvYmxhY2sKICAgICAgICAgICAgICAgIGxpZ2h0Q29sb3I6IDB4MDBhYWZmCiAgICAgICAgICAgIH07Cgp0aGlzLnJpbmdzID0gW107CiAgICAgICAgICAgIHRoaXMubGlnaHRTcHJpdGVzID0gW107IC8vIFN0b3JlIGxpZ2h0IHNwcml0ZXMgZm9yIGNpbmVtYXRpYyBjb250cm9sCiAgICAgICAgICAgIHRoaXMuY3Jvd2QgPSBudWxsOwogICAgICAgICAgICB0aGlzLmNyb3dkID0gbnVsbDsKCnRoaXMuX2J1aWxkQXJjaGl0ZWN0dXJlKCk7CiAgICAgICAgICAgIHRoaXMuX2J1aWxkQ3Jvd2QoKTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRIZXJjdWxlYW5SaW5ncygpOwogICAgICAgICAgICB0aGlzLl9idWlsZFN0YWRpdW1MaWdodHMoKTsKICAgICAgICB9CgogICAgICAgIF9idWlsZEFyY2hpdGVjdHVyZSgpIHsKICAgICAgICAgICAgLy8gMS4gVGhlIFZvaWQgQm93bCAoQmFja2dyb3VuZCBPY2NsdWRlcikKICAgICAgICAgICAgLy8gTWFzc2l2ZSBjeWxpbmRlciB0byBibG9jayB0aGUgdm9pZAogICAgICAgICAgICBjb25zdCBib3dsR2VvID0gbmV3IFRIUkVFLkN5bGluZGVyR2VvbWV0cnkoMTgwLCA1MCwgMTIwLCAzMiwgMSwgdHJ1ZSk7CiAgICAgICAgICAgIGNvbnN0IGJvd2xNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgIGNvbG9yOiB0aGlzLmNvbmZpZy5zdHJ1Y3R1cmVDb2xvciwgCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZSwKICAgICAgICAgICAgICAgIGZvZzogdHJ1ZSAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IGJvd2wgPSBuZXcgVEhSRUUuTWVzaChib3dsR2VvLCBib3dsTWF0KTsKICAgICAgICAgICAgYm93bC5wb3NpdGlvbi55ID0gMjA7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChib3dsKTsKCiAgICAgICAgICAgIC8vIDIuIFNlYXRpbmcgVGllcnMgKENvbmNlbnRyaWMgUmluZ3MpCiAgICAgICAgICAgIGNvbnN0IHRpZXJNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgxMTFhMjIsIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUgfSk7CiAgICAgICAgICAgIGNvbnN0IHJpbU1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDAwNDQ2NiB9KTsKCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMuY29uZmlnLnRpZXJzOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHkgPSAoaSAqIHRoaXMuY29uZmlnLnRpZXJIZWlnaHQpIC0gMzA7CiAgICAgICAgICAgICAgICBjb25zdCBySW5uZXIgPSB0aGlzLmNvbmZpZy5yYWRpdXMgKyAoaSAqICh0aGlzLmNvbmZpZy50aWVyRGVwdGggKiAwLjgpKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJPdXRlciA9IHJJbm5lciArIHRoaXMuY29uZmlnLnRpZXJEZXB0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRmxvb3IgUmluZwogICAgICAgICAgICAgICAgY29uc3QgcmluZ0dlbyA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkocklubmVyLCByT3V0ZXIsIDY0KTsKICAgICAgICAgICAgICAgIHJpbmdHZW8ucm90YXRlWCgtTWF0aC5QSSAvIDIpOwogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKHJpbmdHZW8sIHRpZXJNYXQpOwogICAgICAgICAgICAgICAgbWVzaC5wb3NpdGlvbi55ID0geTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gR2xvd2luZyBSaW0gKFRoZSAiVGVjaCIgZmVlbCkKICAgICAgICAgICAgICAgIGNvbnN0IHJpbUdlbyA9IG5ldyBUSFJFRS5Ub3J1c0dlb21ldHJ5KHJJbm5lciwgMC44LCA0LCA2NCk7CiAgICAgICAgICAgICAgICByaW1HZW8ucm90YXRlWChNYXRoLlBJIC8gMik7CiAgICAgICAgICAgICAgICBjb25zdCByaW0gPSBuZXcgVEhSRUUuTWVzaChyaW1HZW8sIHJpbU1hdCk7CiAgICAgICAgICAgICAgICByaW0ucG9zaXRpb24ueSA9IHk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGQocmltKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gTWFzc2l2ZSBQaWxsYXJzIChUaGUgIkhlcmN1bGVhbiIgU3VwcG9ydCkKICAgICAgICAgICAgY29uc3QgcGlsbGFyR2VvID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KDgsIDIwMCwgOCk7CiAgICAgICAgICAgIGNvbnN0IHBpbGxhck1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDA1MDUwNSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPDg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBjb25zdCByID0gMTQwOyAvLyBGYXIgb3V0CiAgICAgICAgICAgICAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2gocGlsbGFyR2VvLCBwaWxsYXJNYXQpOwogICAgICAgICAgICAgICAgbWVzaC5wb3NpdGlvbi5zZXQoTWF0aC5jb3MoYW5nbGUpKnIsIDAsIE1hdGguc2luKGFuZ2xlKSpyKTsKICAgICAgICAgICAgICAgIG1lc2gubG9va0F0KDAsMCwwKTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCl9idWlsZENyb3dkKCkgewogICAgICAgICAgICAvLyBJbnN0YW5jZWQgTWVzaCBmb3IgQ3Jvd2QgKExvdyBQb2x5LCBIaWdoIENvdW50KQogICAgICAgICAgICAvLyBVc2luZyBhIHNpbXBsZSB2ZXJ0aWNhbCBwbGFuZSB0aGF0IGZhY2VzIGNlbnRlcgogICAgICAgICAgICBjb25zdCBnZW8gPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSgxLjIsIDIuNSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAtLS0gQ1JPV0QgU0hBREVSIElNUExFTUVOVEFUSU9OIC0tLQogICAgICAgICAgICAvLyBBZGQgaW5zdGFuY2Utc3BlY2lmaWMgcmFuZG9tIG9mZnNldCBmb3IgYW5pbWF0aW9uIHZhcmlhdGlvbgogICAgICAgICAgICBjb25zdCBvZmZzZXRzID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLmNvbmZpZy5jcm93ZENvdW50KTsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8dGhpcy5jb25maWcuY3Jvd2RDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBvZmZzZXRzW2ldID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdhT2Zmc2V0JywgbmV3IFRIUkVFLkluc3RhbmNlZEJ1ZmZlckF0dHJpYnV0ZShvZmZzZXRzLCAxKSk7CgogICAgICAgICAgICAvLyBDdXN0b20gU2hhZGVyIHZpYSBvbkJlZm9yZUNvbXBpbGUKICAgICAgICAgICAgY29uc3QgbWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgc2lkZTogVEhSRUUuRG91YmxlU2lkZSB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIG1hdC5vbkJlZm9yZUNvbXBpbGUgPSAoc2hhZGVyKSA9PiB7CiAgICAgICAgICAgICAgICBzaGFkZXIudW5pZm9ybXMudVRpbWUgPSB7IHZhbHVlOiAwIH07CiAgICAgICAgICAgICAgICB0aGlzLmNyb3dkVW5pZm9ybXMgPSBzaGFkZXIudW5pZm9ybXM7CgogICAgICAgICAgICAgICAgc2hhZGVyLnZlcnRleFNoYWRlciA9IGAKICAgICAgICAgICAgICAgICAgICB1bmlmb3JtIGZsb2F0IHVUaW1lOwogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZSBmbG9hdCBhT2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIHZhcnlpbmcgZmxvYXQgdkp1bXA7IC8vIFBhc3MgdG8gZnJhZ21lbnQgZm9yIGNvbG9yIHZhcmlhdGlvbgogICAgICAgICAgICAgICAgYCArIHNoYWRlci52ZXJ0ZXhTaGFkZXI7CgogICAgICAgICAgICAgICAgc2hhZGVyLnZlcnRleFNoYWRlciA9IHNoYWRlci52ZXJ0ZXhTaGFkZXIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAnI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4nLAogICAgICAgICAgICAgICAgICAgIGAKICAgICAgICAgICAgICAgICAgICAjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEFuaW1hdGlvbiBMb2dpYwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHNwZWVkID0gOC4wOwogICAgICAgICAgICAgICAgICAgIGZsb2F0IHQgPSB1VGltZSAqIHNwZWVkICsgKGFPZmZzZXQgKiAxMDAuMCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gSnVtcCAoU2luZSB3YXZlIGNsaXBwZWQpCiAgICAgICAgICAgICAgICAgICAgZmxvYXQganVtcCA9IG1heCgwLjAsIHNpbih0KSk7CiAgICAgICAgICAgICAgICAgICAganVtcCA9IHBvdyhqdW1wLCAyLjApOyAvLyBTaGFycGVuIHRoZSBqdW1wIGN1cnZlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUmFuZG9taXplIGp1bXAgaGVpZ2h0IHNsaWdodGx5CiAgICAgICAgICAgICAgICAgICAgZmxvYXQgaGVpZ2h0ID0gMC41ICsgMC41ICogYU9mZnNldDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm1lZC55ICs9IGp1bXAgKiBoZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gU3dheSAoU2lkZSB0byBzaWRlKQogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVkLnggKz0gY29zKHQgKiAwLjUpICogMC4xOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZKdW1wID0ganVtcDsKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIHNoYWRlci5mcmFnbWVudFNoYWRlciA9IGAKICAgICAgICAgICAgICAgICAgICB2YXJ5aW5nIGZsb2F0IHZKdW1wOwogICAgICAgICAgICAgICAgYCArIHNoYWRlci5mcmFnbWVudFNoYWRlcjsKCiAgICAgICAgICAgICAgICBzaGFkZXIuZnJhZ21lbnRTaGFkZXIgPSBzaGFkZXIuZnJhZ21lbnRTaGFkZXIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAndmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7JywKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICAgICAgdmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQnJpZ2h0ZW4gd2hlbiBqdW1waW5nIChDaGVlcmluZyBlZmZlY3QpCiAgICAgICAgICAgICAgICAgICAgZGlmZnVzZUNvbG9yLnJnYiArPSB2ZWMzKDAuMikgKiB2SnVtcDsKICAgICAgICAgICAgICAgICAgICBgCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9OwogICAgICAgICAgICAKdGhpcy5jcm93ZCA9IG5ldyBUSFJFRS5JbnN0YW5jZWRNZXNoKGdlbywgbWF0LCB0aGlzLmNvbmZpZy5jcm93ZENvdW50KTsKICAgICAgICAgICAgdGhpcy5jcm93ZC5pbnN0YW5jZU1hdHJpeC5zZXRVc2FnZShUSFJFRS5EeW5hbWljRHJhd1VzYWdlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9wdGltaXphdGlvbjogRW5hYmxlIGN1bGxpbmcgYW5kIG1hbnVhbGx5IHNldCBib3VuZGluZyBzcGhlcmUgdG8gY292ZXIgdGhlIHdob2xlIHN0YWRpdW0KICAgICAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyBHUFUgZnJvbSBwcm9jZXNzaW5nIDI1MDAgaW5zdGFuY2VzIHdoZW4gdGhlIGVudGlyZSBzdHJ1Y3R1cmUgaXMgb3V0IG9mIHZpZXcKICAgICAgICAgICAgdGhpcy5jcm93ZC5mcnVzdHVtQ3VsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jcm93ZC5nZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSA9IG5ldyBUSFJFRS5TcGhlcmUobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCksIDE1MCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBkdW1teSA9IG5ldyBUSFJFRS5PYmplY3QzRCgpOwogICAgICAgICAgICBjb25zdCBjb2xvciA9IG5ldyBUSFJFRS5Db2xvcigpOwogICAgICAgICAgICAKLy8gMS4gQ2FsY3VsYXRlIFRvdGFsIENpcmN1bWZlcmVuY2UgZm9yIGRpc3RyaWJ1dGlvbiB0byBlbnN1cmUgYWxsIHRpZXJzIGdldCBwZW9wbGUKICAgICAgICAgICAgbGV0IHRvdGFsQ2lyYyA9IDA7CiAgICAgICAgICAgIGNvbnN0IHRpZXJSYWRpaSA9IFtdOwogICAgICAgICAgICBmb3IobGV0IHQ9MDsgdDx0aGlzLmNvbmZpZy50aWVyczsgdCsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCByTWluID0gdGhpcy5jb25maWcucmFkaXVzICsgKHQgKiAodGhpcy5jb25maWcudGllckRlcHRoICogMC44KSkgKyAyOwogICAgICAgICAgICAgICAgY29uc3QgY2lyYyA9IDIgKiBNYXRoLlBJICogck1pbjsKICAgICAgICAgICAgICAgIHRvdGFsQ2lyYyArPSBjaXJjOwogICAgICAgICAgICAgICAgdGllclJhZGlpLnB1c2goeyByTWluOiByTWluLCBjaXJjOiBjaXJjIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgaWR4ID0gMDsKICAgICAgICAgICAgZm9yKGxldCB0PTA7IHQ8dGhpcy5jb25maWcudGllcnM7IHQrKykgewogICAgICAgICAgICAgICAgY29uc3QgeUJhc2UgPSAodCAqIHRoaXMuY29uZmlnLnRpZXJIZWlnaHQpIC0gMzA7CiAgICAgICAgICAgICAgICBjb25zdCB7IHJNaW4sIGNpcmMgfSA9IHRpZXJSYWRpaVt0XTsKICAgICAgICAgICAgICAgIGNvbnN0IHJNYXggPSByTWluICsgdGhpcy5jb25maWcudGllckRlcHRoIC0gMjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gRGlzdHJpYnV0ZSBwcm9wb3J0aW9uYWxseSBzbyB1cHBlciByb3dzIGRvbid0IGdldCBjdXQgb2ZmCiAgICAgICAgICAgICAgICBjb25zdCBjb3VudFBlclRpZXIgPSBNYXRoLmZsb29yKHRoaXMuY29uZmlnLmNyb3dkQ291bnQgKiAoY2lyYyAvIHRvdGFsQ2lyYykpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxjb3VudFBlclRpZXI7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChpZHggPj0gdGhpcy5jb25maWcuY3Jvd2RDb3VudCkgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSByTWluICsgTWF0aC5yYW5kb20oKSAqIChyTWF4IC0gck1pbik7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZHVtbXkucG9zaXRpb24uc2V0KAogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmNvcyhhbmdsZSkgKiByLAogICAgICAgICAgICAgICAgICAgICAgICB5QmFzZSArIDEuMjUsIC8vIENlbnRlciBvZiBxdWFkCiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguc2luKGFuZ2xlKSAqIHIKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhY2UgY2VudGVyCiAgICAgICAgICAgICAgICAgICAgZHVtbXkubG9va0F0KDAsIHlCYXNlLCAwKTsKICAgICAgICAgICAgICAgICAgICBkdW1teS51cGRhdGVNYXRyaXgoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLmNyb3dkLnNldE1hdHJpeEF0KGlkeCwgZHVtbXkubWF0cml4KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBSYW5kb20gVGVhbSBDb2xvcnMgKFNpbXVsYXRpbmcgZmFucykKICAgICAgICAgICAgICAgICAgICBjb25zdCByYW5kID0gTWF0aC5yYW5kb20oKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmFuZCA8IDAuNDUpIGNvbG9yLnNldEhleCgweDAwODhmZik7IC8vIEhvbWUgQmx1ZQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHJhbmQgPCAwLjkpIGNvbG9yLnNldEhleCgweGZmNDQ0NCk7IC8vIEF3YXkgUmVkCiAgICAgICAgICAgICAgICAgICAgZWxzZSBjb2xvci5zZXRIZXgoMHhmZmZmZmYpOyAvLyBOZXV0cmFsL0ZsYXNoCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVmFyeSBicmlnaHRuZXNzIGZvciBkZXB0aAogICAgICAgICAgICAgICAgICAgIGNvbG9yLm11bHRpcGx5U2NhbGFyKDAuNSArIE1hdGgucmFuZG9tKCkgKiAwLjUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMuY3Jvd2Quc2V0Q29sb3JBdChpZHgsIGNvbG9yKTsKICAgICAgICAgICAgICAgICAgICBpZHgrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHRoaXMuY3Jvd2QpOwogICAgICAgIH0KCiAgICAgICAgX2J1aWxkSGVyY3VsZWFuUmluZ3MoKSB7CiAgICAgICAgICAgIC8vIE1hc3NpdmUgZmxvYXRpbmcgcmluZ3MgdGhhdCByb3RhdGUgc2xvd2x5CiAgICAgICAgICAgIGNvbnN0IG1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IAogICAgICAgICAgICAgICAgY29sb3I6IDB4NDQ1NTY2LCAKICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuMywKICAgICAgICAgICAgICAgIHdpcmVmcmFtZTogdHJ1ZSAvLyBUZWNoL0hvbG9ncmFwaGljIGZlZWwKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyAxLiBFcXVhdG9yaWFsIFJpbmcgKE1hc3NpdmUpCiAgICAgICAgICAgIGNvbnN0IGdlbzEgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxMTAsIDEsIDE2LCAxMDApOwogICAgICAgICAgICBjb25zdCByaW5nMSA9IG5ldyBUSFJFRS5NZXNoKGdlbzEsIG1hdCk7CiAgICAgICAgICAgIHJpbmcxLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkKHJpbmcxKTsKICAgICAgICAgICAgdGhpcy5yaW5ncy5wdXNoKHsgbWVzaDogcmluZzEsIGF4aXM6ICd6Jywgc3BlZWQ6IDAuMDEgfSk7CgogICAgICAgICAgICAvLyAyLiBUaWx0ZWQgUmluZwogICAgICAgICAgICBjb25zdCBnZW8yID0gbmV3IFRIUkVFLlRvcnVzR2VvbWV0cnkoMTMwLCAyLCAxNiwgMTAwKTsKICAgICAgICAgICAgY29uc3QgcmluZzIgPSBuZXcgVEhSRUUuTWVzaChnZW8yLCBtYXQpOwogICAgICAgICAgICByaW5nMi5yb3RhdGlvbi54ID0gTWF0aC5QSSAvIDM7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW5nMik7CiAgICAgICAgICAgIHRoaXMucmluZ3MucHVzaCh7IG1lc2g6IHJpbmcyLCBheGlzOiAneScsIHNwZWVkOiAtMC4wMDggfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAzLiBWZXJ0aWNhbCBSaW5nCiAgICAgICAgICAgIGNvbnN0IGdlbzMgPSBuZXcgVEhSRUUuVG9ydXNHZW9tZXRyeSgxNTAsIDMsIDE2LCAxMDApOwpjb25zdCByaW5nMyA9IG5ldyBUSFJFRS5NZXNoKGdlbzMsIG1hdCk7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChyaW5nMyk7CiAgICAgICAgICAgIHRoaXMucmluZ3MucHVzaCh7IG1lc2g6IHJpbmczLCBheGlzOiAneScsIHNwZWVkOiAwLjAwNSB9KTsKICAgICAgICB9CgogICAgICAgIF9idWlsZFN0YWRpdW1MaWdodHMoKSB7CiAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gMTY7IC8vIE51bWJlciBvZiBsaWdodHMgYXJvdW5kIHRoZSBlcXVhdG9yCiAgICAgICAgICAgIGNvbnN0IHJhZGl1cyA9IDM2OyAvLyBKdXN0IG91dHNpZGUgdGhlIGFyZW5hIGJvdW5kYXJ5ICgzMikKICAgICAgICAgICAgY29uc3QgeVBvcyA9IDA7IC8vIE1pZGRsZSBvZiB0aGUgc3BoZXJlCiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBsaWdodEdlbyA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeSgwLjQsIDgsIDgpOwogICAgICAgICAgICBjb25zdCBsaWdodE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmZmZmZiB9KTsKCiAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gKGkgLyBjb3VudCkgKiBNYXRoLlBJICogMjsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLmNvcyhhbmdsZSkgKiByYWRpdXM7CiAgICAgICAgICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4oYW5nbGUpICogcmFkaXVzOwoKICAgICAgICAgICAgICAgIC8vIDEuIFBoeXNpY2FsIEZpeHR1cmUgKFRoZSBidWxiKQogICAgICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGxpZ2h0R2VvLCBsaWdodE1hdCk7CiAgICAgICAgICAgICAgICBtZXNoLnBvc2l0aW9uLnNldCh4LCB5UG9zLCB6KTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChtZXNoKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBWaXN1YWwgR2xvdyAoRmxhcmUpCiAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSBuZXcgVEhSRUUuU3ByaXRlKF9nbG93TWF0ZXJpYWwpOwovLyAyLiBWaXN1YWwgR2xvdyAoRmxhcmUpCgogICAgICAgICAgICAgICAgc3ByaXRlLnBvc2l0aW9uLnNldCh4LCB5UG9zLCB6KTsKICAgICAgICAgICAgICAgIHNwcml0ZS5zY2FsZS5zZXQoOCwgOCwgMSk7IC8vIExhcmdlIGdsb3cKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZChzcHJpdGUpOwogICAgICAgICAgICAgICAgdGhpcy5saWdodFNwcml0ZXMucHVzaChzcHJpdGUpOwoKLy8gMy4gQWN0dWFsIFBvaW50IExpZ2h0IC0gUkVNT1ZFRCBmb3Igb3B0aW1pemF0aW9uCiAgICAgICAgICAgICAgICAvLyBTaW5jZSB3ZSB1c2UgTWVzaEJhc2ljTWF0ZXJpYWwgKFVubGl0KSwgcmVhbCBsaWdodHMgd2FzdGUgQ1BVL0dQVSByZXNvdXJjZXMuCiAgICAgICAgICAgICAgICAvLyBUaGUgc3ByaXRlIGdsb3cgYWJvdmUgcHJvdmlkZXMgdGhlIHZpc3VhbCBlZmZlY3QuCiAgICAgICAgICAgIH0KICAgICAgICB9CnVwZGF0ZShkdCkgewogICAgICAgICAgICAvLyBBbmltYXRlIFJpbmdzCiAgICAgICAgICAgIHRoaXMucmluZ3MuZm9yRWFjaChyID0+IHsKICAgICAgICAgICAgICAgIGlmIChyLm1lc2ggJiYgci5heGlzKSB7CiAgICAgICAgICAgICAgICAgICAgci5tZXNoLnJvdGF0aW9uW3IuYXhpc10gKz0gci5zcGVlZCAqIGR0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFVwZGF0ZSBDcm93ZCBTaGFkZXIKICAgICAgICAgICAgaWYgKHRoaXMuY3Jvd2RVbmlmb3JtcykgewogICAgICAgICAgICAgICAgdGhpcy5jcm93ZFVuaWZvcm1zLnVUaW1lLnZhbHVlICs9IGR0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgTGlnaHQgUG9wcyAoQ2luZW1hdGljKQogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcy5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICAgICAgaWYgKHMudmlzaWJsZSAmJiBzLnNjYWxlLnggPiA4LjApIHsKICAgICAgICAgICAgICAgICAgICAvLyBEZWNheSBwb3AgZWZmZWN0CiAgICAgICAgICAgICAgICAgICAgcy5zY2FsZS54IC09IGR0ICogMzAuMDsKICAgICAgICAgICAgICAgICAgICBzLnNjYWxlLnkgLT0gZHQgKiAzMC4wOwogICAgICAgICAgICAgICAgICAgIGlmIChzLnNjYWxlLnggPCA4LjApIHMuc2NhbGUuc2V0KDgsIDgsIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgpzZXRBbGxMaWdodHModmlzaWJsZSkgewogICAgICAgICAgICB0aGlzLmxpZ2h0U3ByaXRlcy5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICAgICAgcy52aXNpYmxlID0gdmlzaWJsZTsKICAgICAgICAgICAgICAgIHMuc2NhbGUuc2V0KDgsIDgsIDEpOyAvLyBSZXNldCBzY2FsZQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGdldCBsaWdodENvdW50KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5saWdodFNwcml0ZXMubGVuZ3RoOwogICAgICAgIH0KCiAgICAgICAgcmVzZXRMaWdodHMoKSB7CiAgICAgICAgICAgIHRoaXMuc2V0QWxsTGlnaHRzKGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIHR1cm5PbkxpZ2h0KGluZGV4KSB7CgogICAgICAgICAgICBpZiAodGhpcy5saWdodFNwcml0ZXNbaW5kZXhdKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzID0gdGhpcy5saWdodFNwcml0ZXNbaW5kZXhdOwogICAgICAgICAgICAgICAgcy52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHMubWF0ZXJpYWwub3BhY2l0eSA9IDEuMDsKICAgICAgICAgICAgICAgIHMuc2NhbGUuc2V0KDIwLCAyMCwgMSk7IC8vIFBvcCBlZmZlY3QKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB3aW5kb3cuZmx1eC5TdGFkaXVtID0gU3RhZGl1bTsKfSkoKTs="}}</script></head>
<body>
<div id="game-container">
<img id="screen-overlay-gif" src="https://i.postimg.cc/htrkgHTr/grok-video-2026-01-09-06-22-47-ezgif-com-resize.gif">
        <div id="ui-layer">
            <!-- Cinematic Letterboxing -->
            <div id="cinematic-bars">
                <div class="bar top"></div>
                <div class="bar bottom"></div>
            </div>

            <!-- Tech Copy / Event Flash System -->
            <div id="tech-flash-overlay">
                <div class="flash-line top"></div>
                <div class="tech-content-wrapper">
                    <div class="tech-text">TECHCOPY!</div>
                    <div class="tech-sub-text"></div>
                    <div class="tech-timer-track">
                        <div class="tech-timer-fill"></div>
                    </div>
                </div>
                <div class="flash-line bottom"></div>
            </div>

            <div id="loading">Loading Blitzball...</div>

            <!-- Top HUD -->
            <div id="hud-top">
                <div class="team-wing home">
                    <div class="crystal-bg"></div>
                    <div class="team-data">
                        <div class="team-name">BESAID</div>
                        <div class="team-sub">AUROCHS</div>
                    </div>
                    <div class="score-box">
                        <div id="score-player" class="score-digit">0</div>
                    </div>
                </div>

                <div class="timer-complex">
                    <div class="timer-crystal-ring"></div>
                    <div class="timer-content">
                        <div id="half-indicator">1st</div>
                        <div id="timer-display">00:00</div>
                    </div>
                </div>

                <div class="team-wing away">
                    <div class="score-box">
                        <div id="score-cpu" class="score-digit">0</div>
                    </div>
                    <div class="team-data">
                        <div class="team-name">LUCA</div>
                        <div class="team-sub">GOERS</div>
                    </div>
                    <div class="crystal-bg"></div>
                </div>
            </div>

            <!-- NEW: Goal Distance Indicator -->
            <div id="goal-distance-container">
                <div class="distance-label">GOAL</div>
                <div id="goal-distance">0m</div>
            </div>

            <!-- Mini-Map -->
            <div id="minimap-container">
                <div class="radar-rim"></div>
                <div id="minimap"></div>
                <div class="radar-label">SPHERE POOL</div>
            </div>

            <!-- Player Status Panel -->
            <div id="player-status-panel">
                <div class="char-name">TIDUS</div>
                <div class="hp-gauge-container">
                    <div class="hp-label">HP</div>
                    <div class="hp-bar-track">
                        <div class="hp-bar-fill" style="width: 100%;"></div>
                    </div>
                    <div class="hp-value">120/120</div>
                </div>
                <div class="tech-gauge-container">
                    <div class="tech-label">EXP</div>
                    <div class="tech-bar-track">
                        <div class="tech-bar-fill" style="width: 45%;"></div>
                    </div>
                </div>
            </div>

            <!-- NEW: Charge Power Meter -->
            <div id="charge-meter-container">
                <div class="charge-label">POWER</div>
                <div class="charge-meter-track">
                    <div id="charge-meter-fill"></div>
                </div>
                <div class="charge-hint">RELEASE!</div>
            </div>

            <!-- Announcement -->
            <div id="announcement">GOAL!</div>

            <!-- Controls -->
            <!-- Movement Joystick (Left) -->
            <div id="joystick-hit-zone"></div>
            <div id="joystick-visual-container">
                <div id="joystick-base"></div>
                <div id="joystick-knob"></div>
            </div>

            <!-- NEW: Aim Joystick (Right) -->
            <div id="aim-joystick-zone"></div>
            <div id="aim-joystick-visual">
                <div id="aim-joystick-base"></div>
                <div id="aim-joystick-knob"></div>
            </div>

            <div id="camera-zone"></div>

            <!-- Action Command -->
            <div id="action-container">
                <div class="command-menu-bg"></div>
                <div class="command-ring"></div>
                <div id="action-label">COMMAND</div>
                <div id="action-buttons-wrapper" style="position: relative; width: 100px; height: 100px;">
                    <div id="action-button">
                        <div class="limit-ring"></div>
                        <span class="btn-text">WAIT</span>
                        <div class="btn-glare"></div>
                    </div>
                    <div id="pass-button">
                        <div class="limit-ring"></div>
                        <span class="btn-text">PASS</span>
                        <div class="btn-glare"></div>
                    </div>
                </div>
            </div>

            <!-- NEW: Tackle Button -->
            <div id="tackle-button">
                <span class="btn-text">TACKLE</span>
                <div class="btn-glare"></div>
            </div>

            <!-- Auto/Demo Toggle -->
            <div id="auto-toggle" class="glass-btn">MANUAL</div>

            <!-- NEW: Settings Button -->
            <div id="settings-button" class="glass-btn">SETTINGS</div>

            <div id="practice-restore-btn">MENU</div>
<div id="controls-hint">WASD or Drag to Swim | Swipe to Dash</div>

            <!-- Gesture Hint Overlay -->
            <div id="gesture-hint">
                <svg width="200" height="300" viewBox="0 0 200 300" style="overflow: visible;">
                    <path class="curve-arrow" d="M100 250 Q 180 150 100 50" stroke="#00ffff" stroke-width="6" fill="none" stroke-linecap="round" stroke-dasharray="15 15"></path>
                    <polygon points="100,40 115,65 85,65" fill="#00ffff" filter="drop-shadow(0 0 5px #00ffff)"></polygon>
                </svg>
                <div class="gesture-text">SWIPE CURVE</div>
                <div class="gesture-hand"></div>
<div class="gesture-hand"></div>
            </div>

            <!-- Offscreen Player Indicator -->
            <div id="offscreen-indicator">
                <div class="arrow"></div>
            </div>

            <!-- NEW: Settings Panel -->
            <!-- NEW: Settings Panel -->
<div id="settings-panel" style="display: none;">
                <div class="settings-header">
                    <span>SETTINGS</span>
                    <button id="settings-close">X</button>
                </div>
                <div class="settings-content">
                    <div class="setting-row">
                        <label>Sensitivity</label>
                        <input type="range" id="sensitivity-slider" min="50" max="150" value="100">
                    </div>
                    <div class="setting-row">
                        <label>Aim Assist</label>
                        <input type="checkbox" id="aim-assist-toggle" checked="">
                    </div>
                    <div class="setting-row">
                        <label>Camera Shake</label>
                        <input type="checkbox" id="shake-toggle" checked="">
                    </div>
                    <div class="setting-row">
                        <label>Music Volume</label>
                        <input type="range" id="volume-slider" min="0" max="100" value="50">
                    </div>
                    <div class="setting-row" style="justify-content: center; margin-top: 20px; background: transparent;">
                        <button id="exit-to-menu-btn" class="glass-btn" style="width: 100%; border-color: #ff4444; color: #ff4444;">EXIT TO MENU</button>
                    </div>
                </div>
            </div>


            <!-- Practice Overlay -->
            <div id="practice-overlay">
                <div class="practice-panel">
                    <div class="panel-header">
                        <div class="panel-minimize-btn" id="p-minimize">-</div>
                        <div class="panel-title-group">
                            <span class="panel-title">BLITZ TRAINING</span>
                            <span class="panel-subtitle">SPHERE POOL SIMULATION</span>
                        </div>
                        <div class="panel-deco-line"></div>
                    </div>

                    <div class="panel-content">
                        <div class="panel-section">
                            <div class="section-label">DRILL SELECTION</div>
                            <div class="drill-list">
<div class="drill-btn active" data-drill="free">
                                    <span class="icon"></span> FREE ROAM
                                </div>
                                <div class="drill-btn" data-drill="ball_lab">
                                    <span class="icon"></span> BALL LAB
                                </div>
                                <div class="drill-btn" data-drill="shooting">
                                    <span class="icon"></span> SHOOTING
                                </div>
                                <div class="drill-btn" data-drill="passing">
                                    <span class="icon"></span> PASSING
                                </div>
<div class="drill-btn" data-drill="defense">
                                    <span class="icon"></span> DEFENSE
                                </div>
                                <div class="drill-btn" data-drill="curve">
<span class="icon"></span> CURVE BALL
                                </div>
                                <div class="drill-btn" data-drill="rapid_fire">
                                    <span class="icon"></span> RAPID FIRE
                                </div>
                            </div>
                        </div>

                        <div class="panel-section">
                            <div class="section-label">SYSTEM OVERRIDE</div>
                            <div class="option-list">
<div class="option-toggle active" id="opt-inf-stat">
                                    <span class="checkbox"></span> INF STATS
                                </div>
                                <div class="option-toggle active" id="opt-ai-dummy">
                                    <span class="checkbox"></span> AI DUMMY
                                </div>
                                <div class="option-toggle" id="opt-hitboxes">
                                    <span class="checkbox"></span> HITBOXES
                                </div>
                            </div>

                            <div class="section-label" style="margin-top: 15px;">COMMANDS</div>
                            <div class="action-btn" id="p-reset-ball">RESET BALL (R)</div>
                            <div class="action-btn" id="p-exit">EXIT PRACTICE</div>
                        </div>
                    </div>

                    <div class="panel-footer">
                        <div id="drill-instruction">SELECT A DRILL TO BEGIN SIMULATION</div>
                        <div id="drill-score">SCORE: 0</div>
                    </div>
                </div>
            </div>

            <!-- Main Menu -->
            <div id="main-menu" class="active">
                <div class="menu-bg-overlay"></div>
                <div class="ffx-logo-container">
                    <div class="ffx-logo-main">BLITZBALL</div>
                    <div class="ffx-logo-sub">REMASTERED</div>
                </div>
                <div class="menu-options">
                    <div class="menu-item" data-action="normal">
                        <span class="cursor">&gt;</span>
                        <span class="label">NORMAL MATCH</span>
                    </div>
                    <div class="menu-item" data-action="practice">
                        <span class="cursor">&gt;</span>
                        <span class="label">PRACTICE</span>
                    </div>
                    <div class="menu-item" data-action="ball_lab">
                        <span class="cursor">&gt;</span>
                        <span class="label">BALL LAB</span>
                    </div>
                    <div class="menu-item" data-action="options">
                        <span class="cursor">&gt;</span>
                        <span class="label">OPTIONS</span>
                    </div>
                </div>
                <div class="menu-footer">FLUX ENGINE v2.0</div>
</div>

            <!-- NEW: End Game Menu -->
            <div id="end-game-menu">
                <div class="end-bg-layer"></div>
                <div class="end-content">
                    <div class="result-header">
                        <div class="result-title" id="end-result-title">VICTORY</div>
                        <div class="result-subtitle">MATCH COMPLETE</div>
                    </div>
                    
                    <div class="final-score-container">
                        <div class="final-team home">
                            <div class="final-score-digit" id="end-score-home">3</div>
                            <div class="final-team-name">BESAID</div>
                        </div>
                        <div class="final-vs">
                            <div class="vs-line"></div>
                            <span>VS</span>
                            <div class="vs-line"></div>
                        </div>
                        <div class="final-team away">
                            <div class="final-score-digit" id="end-score-away">1</div>
                            <div class="final-team-name">LUCA</div>
                        </div>
                    </div>

                    <div class="end-options">
                        <div class="menu-item" id="end-btn-rematch">
                            <span class="cursor">&gt;</span>
                            <span class="label">REMATCH</span>
                        </div>
                        <div class="menu-item" id="end-btn-exit">
                            <span class="cursor">&gt;</span>
                            <span class="label">EXIT TO MENU</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Scripts -->
    <script>(function() {
    window.flux = window.flux || {};

    const _loader = new THREE.GLTFLoader();

    // Helper to convert a single material to Basic (Unlit/PSX)
// Helper to convert a single material to Basic (Unlit/PSX)
    function convertMaterial(oldMat, isSkinned) {
        
        // Preserve texture: Check map, then emissiveMap
        const texture = oldMat.map || oldMat.emissiveMap || null;

        // FORCE OPAQUE VISIBILITY
        // We override transparency to ensure models are always visible (fixing the "invisible model" issue).
        const params = {
            map: texture,
            color: 0xffffff,        // FORCE WHITE: Remove any tint from GLTF
            skinning: isSkinned,
            side: THREE.DoubleSide, // Render both sides to prevent backface culling invisibility
            transparent: false,     // Disable transparency to prevent sorting issues
            opacity: 1.0,           // Force full opacity
            alphaTest: 0.5,         // Strong alpha test for cutouts (nets/grates)
            vertexColors: oldMat.vertexColors, // Preserve vertex colors
            depthTest: true,
            depthWrite: true,       // Force depth write so it occludes properly
            fog: true
        };

        // Ensure texture encoding is correct for Three.js
        if (params.map) params.map.encoding = THREE.sRGBEncoding;

        return new THREE.MeshBasicMaterial(params);
    }

    window.flux.AssetLoader = {
        loadModel: function(url, onLoad, onProgress, onError) {
            _loader.load(url, function(gltf) {
                gltf.scene.traverse(function(node) {
                    if (node.isMesh) {
node.castShadow = false;
                        node.receiveShadow = false;
                        node.frustumCulled = false; // Prevent invisibility
                        if (node.material) {
                            if (Array.isArray(node.material)) {
                                node.material = node.material.map(m => convertMaterial(m, node.isSkinnedMesh));
                            } else {
                                node.material = convertMaterial(node.material, node.isSkinnedMesh);
                            }
                        }
                    }
                });
                if (onLoad) onLoad(gltf);
            }, onProgress, onError);
        }
    };
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Ball Lab / DevTools: throw & curve mapping knobs
    // (Defaults match current feel; DevTools can tweak at runtime.)
    window.flux.ThrowConfig = window.flux.ThrowConfig || {
        SWIPE_MIN_PX: 20,
        AIM_DX_SCALE: 1.0,
        AIM_DY_SCALE: 1.0,

        POWER_BASE: 1.0,
        POWER_RANGE: 0.8,          // Base multiplier = POWER_BASE + ratio*POWER_RANGE
        POWER_MAX_BONUS_RATIO: 0.95,
        POWER_MAX_MULTIPLIER: 2.5,

        CURVE_ENABLED: true,
        CURVE_INTENSITY_THRESHOLD: 0.25,
        CURVE_SPIN_SCALE: 1000.0,
        CURVE_SPEED_MULT: 1.5,
        CURVE_SPIN_CAP: 1500.0,
        CURVE_PERFECT_SPIN: 500.0
    };

// Reusable math objects
const _pVec = new THREE.Vector3();
    const _pVec2 = new THREE.Vector3();
    const _pQuat = new THREE.Quaternion();
    const _pQuat2 = new THREE.Quaternion();
    const _pTargetQuat = new THREE.Quaternion();
    const _pEuler = new THREE.Euler();
    const _pAxisY = new THREE.Vector3(0, 1, 0);
    const _pAxisZ = new THREE.Vector3(0, 0, 1);
    const _pInvQuat = new THREE.Quaternion();
    const _pTmpQuat = new THREE.Quaternion();
    const _pTmpEuler = new THREE.Euler();


class Player {
        constructor(scene, role = 'MF') {
            this.scene = scene;
            this.role = role;
            this.team = null; // Assigned by Team.addPlayer
            this.homePosition = new THREE.Vector3();

            this.mesh = null;
            this.mixer = null;
            this.actions = {};
            this.activeAction = null;
            this.state = 'idle';
                        this._animLocked = false;
            this._lockedState = null;
            this._lastLocomotion = 'idle';
this.inputVector = new THREE.Vector3(0, 0, 0);

            // Physics (Drift/Inertia Model)
            this.velocity = new THREE.Vector3(0, 0, 0);
            this.acceleration = 12.0;
            this.drag = 3.0;
            this.maxSpeed = 8.0;
            // Bone reference for holding ball
            this.handBone = null;
// Procedural animation bone refs (filled in setMesh)
this.bones = {
    hips: null,
    spine: null,
    chest: null,
    neck: null,
    head: null,
    rUpperArm: null,
    rForeArm: null,
    rHand: null,
    lUpperArm: null,
    lForeArm: null,
    lHand: null
};
this._boneBaseQuats = null; // Optional future use
this._procAnimTime = 0;
this._smoothedSpeed = 0;
this._movingLatch = false;

this.canCatch = true;
            this.catchCooldown = 0; // Replaces setTimeout for safety

            // Blitzball Stats
            this.stats = {
                HP: 100,
                maxHP: 100,
                EN: 30,
                AT: 10,
                PA: 15,
                BL: 10,
                SH: 15,
                CA: 10,
                SP: 60
            };

            // Leveling System
            this.level = 1;
            this.exp = 0;
            this.nextLevelExp = 100;

            // Status Effects & Techniques
            this.status = {
                venom: 0,
                nap: 0,
                wither: { PA: 0, SH: 0, AT: 0, BL: 0, CA: 0, SP: 0 }
            };

            this.marking = null;
            this.learnedTechs = [];

            this.techs = {
                tackle: null,
                shoot: null,
                pass: null,
                passive: null
            };

            // Visuals
            this.baseColorHex = 0xffffff;
            this.originalMaterials = [];
            this.auraMesh = null;
            this.rotationOffset = 0;
this.baseScale = 1.17; // Increased ~8%

            // Real-time Stats
            this.currentEN = this.stats.EN;
this.tackleRadius = 2.0; // Reduced from 2.5 to reduce swarm lock

            this.speed = 4.0;
            this._updateDerivedStats();

            this.hasBall = false;
            this.isThrowing = false;

            // Dash State
            this.isDashing = false;
            this.dashTime = 0;
            this.dashTotalTime = 0.5;
this.dashCooldown = 0;
            this.dashVec = new THREE.Vector3();

            // Feedback Accumulators
            this._accumulatedDamage = 0;
            this._damageTimer = 0;

            // HP Bar
            this.hpBar = null;
            this.hpBarFill = null;

            // Gameplay Flow Timers
            this.stunTimer = 0;
            this.immunityTimer = 0;

            // Banking & Verticality
            this.bankingAmount = 0;
            this.targetY = 0;

            // Encounter System
            this.isEngaged = false;
            this.clashTimer = 0;

            this.encounterTimer = 0; // Track duration of current engagement
            // Charge Mechanic
            this.isCharging = false;
            this.chargeTime = 0;
            this.maxChargeTime = 1.5;

            // FIXED: Improved Rotation State with hysteresis
            this.currentYaw = 0;
            this.targetYaw = 0;
            this.lastValidYaw = 0; // Store last known good yaw for deadzone handling
            this.pitchAmount = 0;
            this.bankingAmount = 0;
            this.facingDeadzone = 0.3; // Minimum input/velocity magnitude to update facing

            // Particle Emission Timers
            this._particleTimers = {
                venom: 0,
                nap: 0,
                wither: 0
            };

            // DevTools Flags
            this.isGodMode = false;

            // Pass Target Indicator
// Pass Target Indicator
            this.passTargetIndicator = null;
            
            // Bubble Trail Timer
            this._bubbleTimer = 0;

this._dashParticleTimer = 0;
            this.struggleIntensity = 0; // Continuous pressure factor (0.0 to 1.0)
        }

        syncRotation() {
            if (!this.mesh) return;
            const euler = new THREE.Euler().setFromQuaternion(this.mesh.quaternion, 'YXZ');
            this.currentYaw = euler.y - this.rotationOffset;
            this.targetYaw = this.currentYaw;
            this.lastValidYaw = this.currentYaw;
            this.bankingAmount = 0;
            this.pitchAmount = 0;
        }

        getStat(name) {
            let val = this.stats[name];
            if (this.status.wither[name] > 0) {
                val *= 0.5;
            }
            return val;
        }

        applyStatus(type, duration, subType = null) {
            if (type === 'venom') {
                const wasActive = this.status.venom > 1.0;
                this.status.venom = Math.max(this.status.venom, duration);

                if (!wasActive) {
                    console.log(`${this.role} poisoned!`);
                    if (window.flux.gameInstance.floatingText)
                        window.flux.gameInstance.floatingText.spawn("POISON", this.mesh.position, "status");
                }
            } else if (type === 'nap') {
                const wasActive = this.status.nap > 1.0;
                this.status.nap = Math.max(this.status.nap, duration);

                if (!wasActive) {
                    if (this.hasBall) this.fumble();
                    console.log(`${this.role} fell asleep!`);
                    if (window.flux.gameInstance.floatingText)
                        window.flux.gameInstance.floatingText.spawn("SLEEP", this.mesh.position, "status");
                }
            } else if (type === 'wither' && subType) {
                const currentVal = this.status.wither[subType] || 0;
                const wasActive = currentVal > 1.0;
                this.status.wither[subType] = Math.max(currentVal, duration);

                if (!wasActive) {
                    console.log(`${this.role} withered ${subType}!`);
                    if (window.flux.gameInstance.floatingText)
                        window.flux.gameInstance.floatingText.spawn(`WITHER ${subType}`, this.mesh.position, "status");
                }
            }
        }

        _updateDerivedStats() {
            const sp = this.getStat('SP');
            this.maxSpeed = 5.0 + (sp / 15.0);
            this.currentEN = this.getStat('EN');
        }

setMesh(sourceMesh, animations) {
            this.mesh = sourceMesh;
            this.scene.add(this.mesh);
            this._createHPBar();
            this._createAura();
            this._createPassTargetIndicator();

            // Custom Character Scaling
            if (this.characterName) {
                if (this.characterName.includes('Tidus')) this.baseScale = 1.6;
                else if (this.characterName.includes('Wakka')) this.baseScale = 1.4;
            }

            this.mesh.scale.setScalar(this.baseScale);

            this.mesh.traverse((node) => {
                if (node.isMesh && node.material) {
                    const convertOne = (mat) => {
                        const m = new THREE.MeshBasicMaterial({
                            map: mat.map || null,
                            color: new THREE.Color(0xffffff), // FORCE WHITE: Ignore source color
                            transparent: !!mat.transparent,
                            opacity: (mat.opacity !== undefined ? mat.opacity : 1),
                            alphaTest: (mat.alphaTest !== undefined ? mat.alphaTest : 0),
                            side: mat.side,
                            depthTest: mat.depthTest,
                            depthWrite: mat.depthWrite,
                            fog: true,
                            skinning: !!node.isSkinnedMesh
                        });
                        this.originalMaterials.push({ material: m, baseColor: m.color.clone() });
                        return m;
                    };
                    node.material = Array.isArray(node.material)
                        ? node.material.map(convertOne)
                        : convertOne(node.material);
                }

                if (node.isBone) {
                    const name = (node.name || '').toLowerCase();

                    // Core spine/head chain (Mixamo-friendly)
                    if (!this.bones.hips && name.includes('hips')) this.bones.hips = node;
                    if (!this.bones.spine && name.includes('spine') && !name.includes('spine2') && !name.includes('spine_2')) this.bones.spine = node;
                    if (!this.bones.chest && (name.includes('chest') || name.includes('spine2') || name.includes('spine_2'))) this.bones.chest = node;
                    if (!this.bones.neck && name.includes('neck')) this.bones.neck = node;
                    if (!this.bones.head && name.includes('head')) this.bones.head = node;

                    const isRight = name.includes('right') || name.endsWith('r') || name.includes('_r') || name.includes('.r');
                    const isLeft  = name.includes('left')  || name.endsWith('l') || name.includes('_l') || name.includes('.l');

                    // Arms/hands (Mixamo: mixamorigRightArm/RightForeArm/RightHand)
                    if (!this.bones.rUpperArm && (name.includes('rightarm') || (isRight && name.includes('upperarm')))) this.bones.rUpperArm = node;
                    if (!this.bones.rForeArm && (name.includes('rightforearm') || (isRight && name.includes('forearm')))) this.bones.rForeArm = node;
                    if (!this.bones.rHand && ((name.includes('hand') && isRight) || name.includes('righthand'))) this.bones.rHand = node;

                    if (!this.bones.lUpperArm && (name.includes('leftarm') || (isLeft && name.includes('upperarm')))) this.bones.lUpperArm = node;
                    if (!this.bones.lForeArm && (name.includes('leftforearm') || (isLeft && name.includes('forearm')))) this.bones.lForeArm = node;
                    if (!this.bones.lHand && ((name.includes('hand') && isLeft) || name.includes('lefthand'))) this.bones.lHand = node;

                    // Back-compat: ball attachment uses handBone
                    if (!this.handBone && this.bones.rHand) this.handBone = this.bones.rHand;
                }
            });

            this.mixer = new THREE.AnimationMixer(this.mesh);

            if (animations) {
                const _normClipName = (s) => (s || '')
                    .toLowerCase()
                    .replace(/[_\-]+/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();

                // Helper to strip leg tracks from action clips
                const _stripLegs = (clip) => {
                    const tracks = [];
                    clip.tracks.forEach(t => {
                        // Regex to match leg bones (Mixamo style: RightUpLeg, RightLeg, RightFoot, RightToeBase)
                        // Also generic "Leg", "Foot"
                        if (!t.name.match(/(UpLeg|Leg|Foot|Toe)/i)) {
                            tracks.push(t);
                        }
                    });
                    clip.tracks = tracks;
                    return clip;
                };

                animations.forEach((clip) => {
                    const name = _normClipName(clip.name);
                    const has = (re) => re.test(name);
                    
                    let isLocomotion = false;
                    let actionKey = null;

                    // --- Core locomotion ---
                    if (has(/tread|treading|idle|float/)) {
                        actionKey = 'idle';
                        isLocomotion = true;
                    } else if (has(/dash|sprint|burst|fast\s*swim|swim\s*fast/)) {
                        actionKey = 'dash';
                        isLocomotion = true;
                    } else if (has(/swim|freestyle|crawl/)) {
                        actionKey = 'swim';
                        isLocomotion = true;
                    
                    // --- Throwing (pass/shot variants if present) ---
                    } else if (has(/throw|toss|pitch/)) {
                        if (has(/shoot|shot|goal/)) actionKey = 'throw_shot';
                        else if (has(/pass/)) actionKey = 'throw_pass';
                        else actionKey = 'throw';

                    // --- Catching (jump/air variants if present) ---
                    } else if (has(/catch|receive|grab|intercept/)) {
                        if (has(/jump|leap|air|dive/)) actionKey = 'catch_jump';
                        else actionKey = 'catch';

                    // --- Hit / React ---
                    } else if (has(/react|hit|hurt|damage|stagger|knock/)) {
                        actionKey = 'react';

                    // --- Optional states ---
                    } else if (has(/charge|aim|ready|windup|hold/)) {
                        actionKey = 'charge';
                    } else if (has(/tackle|check|ram/)) {
                        actionKey = 'tackle';
                    } else if (has(/block|save/)) {
                        actionKey = 'block';
                    } else if (has(/celebrate|victory|cheer/)) {
                        actionKey = 'celebrate';
                    } else {
                        actionKey = clip.name;
                    }

                    // Strip legs from non-locomotion clips to allow treading water overlay
                    if (!isLocomotion && actionKey) {
                        _stripLegs(clip);
                    }

                    if (actionKey) {
                        this.actions[actionKey] = this.mixer.clipAction(clip);
                    }
                });
            }

            // Start default locomotion
            if (this.actions['idle']) {
                this.playLocomotion('idle');
            } else {
                // Fallback
                const first = Object.values(this.actions)[0];
                if(first) first.play();
            }

            // One-shot animation listener
            if (this.mixer) {
                this.mixer.addEventListener('finished', (e) => {
                    if (!this._animLocked) return;
                    if (!e || !e.action) return;
                    
                    // Check if the finished action is our current one-shot
                    if (e.action === this.activeOneShot) {
                        this._animLocked = false;
                        this._lockedState = null;
                        this.activeOneShot = null;

                        // Return to locomotion updates
                        if (!this.isThrowing) {
                            this._updateLocomotionAnim(0.15);
                        }
                    }
                });
            }
        }

        // New method for base layer (legs/body movement)
        playLocomotion(actionName, duration = 0.5) {
            const newAction = this.actions[actionName];
            if (!newAction || newAction === this.activeLocomotion) return;

            if (this.activeLocomotion) {
                this.activeLocomotion.fadeOut(duration);
            }

            newAction.reset();
            newAction.fadeIn(duration);
            newAction.play();
            this.activeLocomotion = newAction;
            this._lastLocomotion = actionName;
        }

        // Overhauled play method to handle layering
        play(actionName, duration = 0.5) {
            // If it's a locomotion state, route to playLocomotion
            if (['idle', 'swim', 'dash'].includes(actionName)) {
                this.playLocomotion(actionName, duration);
                return;
            }

            // Otherwise treat as an action layer
            const newAction = this.actions[actionName];
            if (!newAction) return;

            // If we have an active one-shot, fade it out
            if (this.activeOneShot && this.activeOneShot !== newAction) {
                this.activeOneShot.fadeOut(0.1);
            }

            newAction.reset();
            newAction.fadeIn(0.1); // Fast transition for actions
            newAction.play();
            
            this.activeOneShot = newAction;
            this.state = actionName;
        }

        _updateLocomotionAnim(duration = 0.2) {
            // Note: We NO LONGER check _animLocked here.
            // Locomotion should update continuously based on speed, 
            // running underneath the upper body action.
            
            const vx = this.velocity ? this.velocity.x : 0;
            const vz = this.velocity ? this.velocity.z : 0;
            const speed = Math.sqrt(vx * vx + vz * vz);

            // Smooth speed
            const smoothK = 1.0 - Math.pow(0.001, duration);
            this._smoothedSpeed += (speed - this._smoothedSpeed) * smoothK;

            const speedNorm = (this.maxSpeed > 0.0001) ? THREE.MathUtils.clamp(this._smoothedSpeed / this.maxSpeed, 0, 1) : 0;

            // Hysteresis
            const enterMove = 0.18;
            const exitMove = 0.10;

            const inputMoving = this.inputVector && this.inputVector.lengthSq() > 0.06;
            const velMoving = this._smoothedSpeed > (this._movingLatch ? exitMove : enterMove);

            this._movingLatch = inputMoving || velMoving;

            let target = this._movingLatch ? 'swim' : 'idle';
            if (this._movingLatch && this.isDashing && this.actions['dash']) target = 'dash';

            // Update playback rate
            const applyRate = (key) => {
                const a = this.actions[key];
                if (!a) return;
                if (key === 'swim') a.timeScale = THREE.MathUtils.lerp(0.85, 1.70, speedNorm);
                else if (key === 'dash') a.timeScale = THREE.MathUtils.lerp(1.10, 2.20, speedNorm);
                else if (key === 'idle') a.timeScale = THREE.MathUtils.lerp(0.95, 1.05, speedNorm);
            };

            applyRate(target);

            if (this._lastLocomotion !== target) {
                const a = this.actions[target];
                if (a) {
                    try { a.setLoop(THREE.LoopRepeat); } catch (_) {}
                    a.clampWhenFinished = false;
                }
                this.playLocomotion(target, duration);
            }
        }

        playOneShot(actionName, duration = 0.1, opts = {}) {
            const a = this.actions[actionName];
            if (!a) return false;

            this._animLocked = true;
            this._lockedState = actionName;

            try {
                a.reset();
                a.setLoop(THREE.LoopOnce);
                a.clampWhenFinished = true;
                a.timeScale = (opts.timeScale !== undefined ? opts.timeScale : 1.0);
            } catch (_) {}

            // Use the new play method which handles layering
            this.play(actionName, duration);
            return true;
        }
        setInput(x, z) {
            if (this.status.nap > 0) {
                this.inputVector.set(0, 0, 0);
                return;
            }
            this.inputVector.set(x, 0, z);
        }

receiveBall() {
            this.canCatch = false;
            
            // CRITICAL FIX: Reset states that might prevent shooting
            this.isThrowing = false;
            this.isCharging = false;
            this._hideChargeUI();

            if (this.status.nap > 0) {
                this.status.nap = 0;
            }

            this.hasBall = true;
            this.immunityTimer = 2.0;

            const ball = window.flux.gameInstance.entities.ball;
            if (ball && ball.lastHolder && ball.lastHolder.team === this.team && ball.lastHolder !== this) {
                ball.lastHolder.gainExp(2);
                this.gainExp(1);
            }

            const ballY = (this.ballRef && this.ballRef.mesh) ? this.ballRef.mesh.position.y : 0;
            const catchKey = (ballY > 0.25 && this.actions['catch_jump']) ? 'catch_jump' : 'catch';

            this.playOneShot(catchKey, 0.1);

            if (window.flux.gameInstance.audioManager) {
                window.flux.gameInstance.audioManager.playSFX('catch');
            }

            if (window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("SNAP!", this.mesh.position, "comic-action");
            }
        }

throwBall(ball, forcedType = null, powerMultiplier = 1.0, forcedSpin = null) {
            if (!this.hasBall || this.isThrowing) return;
            if (this.status.nap > 0) return;

            this.isThrowing = true;

            // Lock aim direction at start of throw
            this.lockedAimVector = new THREE.Vector3();

            if (this.inputVector.lengthSq() > 0.1) {
                this.lockedAimVector.copy(this.inputVector).normalize();
            } else {
                this.lockedAimVector.set(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
            }

const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
            const goalZ = (this.team && this.team.side === 1) ? -goalDist : goalDist;
            const distToGoal = Math.abs(this.mesh.position.z - goalZ);

            let type = forcedType;
            if (!type) {
                type = (distToGoal < 25) ? 'SH' : 'PA';
            }

            const isFinisher = (type === 'SH' && distToGoal < 12.0);

            let techName = (type === 'SH') ? this.techs.shoot : this.techs.pass;

            if (this.status.venom > 0 && techName) {
                if (window.flux.gameInstance.floatingText)
                    window.flux.gameInstance.floatingText.spawn("SILENCED", this.mesh.position, "status");
                techName = null;
            }

            let windupTime = 100;
            let animSpeed = 1.5;

            if (powerMultiplier > 1.1) {
                windupTime += 200;
            }

            if (isFinisher && !techName) {
                windupTime = 50;
                animSpeed = 3.0;
            }

if (techName) {
                windupTime = 400;
                animSpeed = 0.8;

                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.playCinematic(techName, this.mesh, 1.2);
                }

                this.immunityTimer = 1.5;

                if (window.flux.gameInstance.floatingText) {
                    const label = techName.replace('_', ' ').toUpperCase();
                    window.flux.gameInstance.floatingText.spawn(label, this.mesh.position, "tech");
                }

                // NEW: Spawn Tech Glyph (Vertical Casting Circle)
                if (window.flux.gameInstance.glyphManager) {
                    window.flux.gameInstance.glyphManager.spawn('tech', this.mesh.position, {
                        parent: this,
                        life: 1.2,
                        rotationSpeed: 4.0,
                        scaleSpeed: 1.5,
                        offsetY: 1.2,
                        faceCamera: true
                    });
                }
            }

            // Pick best throw clip (pass/shot variants if present)
            const throwKey =
                (type === 'SH' && this.actions['throw_shot']) ? 'throw_shot' :
                (type === 'PA' && this.actions['throw_pass']) ? 'throw_pass' :
                'throw';

this.playOneShot(throwKey, 0.1, { timeScale: animSpeed });

            if (window.flux.gameInstance.audioManager) {
                window.flux.gameInstance.audioManager.playSFX('throw');
            }

            if (window.flux.gameInstance.floatingText && !techName) {
                window.flux.gameInstance.floatingText.spawn("WHOOSH", this.mesh.position, "comic-action");
            }

setTimeout(() => {
                // Safety: If ball holder is still us, proceed. If hasBall is false but holder is us, assume sync lag and proceed.
                if (this.hasBall || (ball && ball.holder === this)) {
const throwAction = this.actions[throwKey];
                    if (throwAction) throwAction.timeScale = 1.0;

                    let finalDir = new THREE.Vector3();
                    let referenceDir = new THREE.Vector3();

if (this.overrideAimVector) {
                        finalDir.copy(this.overrideAimVector).normalize();
                        referenceDir.copy(finalDir);

                        // REMOVED: Instant rotation snap. 
                        // The update loop handles smooth rotation via targetYaw.
                        // This prevents the "flipping around" visual glitch.
                    } else {
                        finalDir.copy(this.lockedAimVector);
                        referenceDir.copy(this.lockedAimVector);
                    }

const spin = new THREE.Vector3(0, 0, 0);

                    if (forcedSpin) {
                        spin.copy(forcedSpin);
                    } else if (this.inputVector.lengthSq() > 0.1) {
                        const inputDir = this.inputVector.clone().normalize();
                        const crossY = new THREE.Vector3().crossVectors(referenceDir, inputDir).y;

                        if (Math.abs(crossY) > 0.1) {
                            spin.set(0, crossY * 12.0, 0);
                        }
                    }

                    let baseCost = (type === 'SH') ? 20 : 10;
                    let techCost = 0;
                    let techBonus = 0;
                    let techPayload = null;

                    if (techName) {
                        switch (techName) {
                            case 'venom':
                                techCost = (type === 'SH' ? 20 : 10);
                                techBonus = 3;
                                techPayload = { type: 'venom', level: 1 };
                                break;
                            case 'wither':
                                techCost = (type === 'SH' ? 20 : 10);
                                techBonus = 3;
                                techPayload = { type: 'wither', level: 1 };
                                break;
                            case 'nap':
                                techCost = (type === 'SH' ? 35 : 30);
                                techBonus = 3;
                                techPayload = { type: 'nap', level: 1 };
                                break;
                            case 'sphere':
                                if (type === 'SH') {
                                    techCost = 25;
                                    const rng = Math.floor(Math.random() * 11) + 5;
                                    techBonus = rng;
                                    techPayload = { type: 'sphere', level: 1, bonus: rng };
                                    if (window.flux.gameInstance.floatingText)
                                        window.flux.gameInstance.floatingText.spawn(`SPHERE +${rng}`, this.mesh.position, "goal");
                                }
                                break;
                            case 'jecht':
                                if (type === 'SH') {
                                    techCost = 40;
                                    techBonus = 5;
                                    techPayload = { type: 'jecht', level: 1 };
                                    this._performJechtKnockback();
                                }
                                break;
                            case 'invisible':
                                if (type === 'SH') {
                                    techCost = 25;
                                    techBonus = 2;
                                    techPayload = { type: 'invisible', level: 1 };
                                }
                                break;
                        }
                    }

                    const totalCost = baseCost + techCost;

                    let powerFactor = 1.0;
                    if (this.stats.HP < totalCost) {
                        powerFactor = 0.5;
                        this.stats.HP = 0;
                        techPayload = null;
                        techBonus = 0;
                        if (window.flux.gameInstance.floatingText)
                            window.flux.gameInstance.floatingText.spawn("TIRED", this.mesh.position, "damage");
                    } else {
                        this.stats.HP -= totalCost;
                    }

                    let statVal = this.getStat(type);
                    statVal += techBonus;
                    statVal *= powerFactor;
                    statVal *= powerMultiplier;

const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
                    const goalZ = (this.team && this.team.side === 1) ? -goalDist : goalDist;
                    const goalDir = new THREE.Vector3(0, 0, goalZ - this.mesh.position.z).normalize();
                    const goalDot = finalDir.dot(goalDir);

                    if (type === 'SH') {
                        const goalPos = new THREE.Vector3(0, 2, goalZ);
                        const toGoal = goalPos.clone().sub(this.mesh.position).normalize();

                        const sh = this.getStat('SH');
                        let assistFactor = Math.min(0.9, Math.max(0.1, sh / 100.0));

                        if (this.overrideAimVector) {
                            assistFactor *= 0.1;
                        }

                        if (goalDot > 0.2) {
                            finalDir.lerp(toGoal, assistFactor);
                        }

                        if (isFinisher) {
                            finalDir.y += 0.05;
                            if (window.flux.gameInstance.floatingText) {
                                window.flux.gameInstance.floatingText.spawn("SLAM!", this.mesh.position, "comic-impact");
                            }
} else {
                            finalDir.y += 0.25;
                        }
                        
// Goalie Loft Bonus (Prevent interception by immediate defender)
                        if (this.role === 'GL') finalDir.y += 0.8; // High loft for clearance

                    } else {
                        const target = this._findPassTargetInCone(finalDir);

                        if (target) {
                            const toMate = target.mesh.position.clone().sub(this.mesh.position);
                            if (target.velocity.lengthSq() > 0.1) {
                                toMate.addScaledVector(target.velocity, 0.5);
                            }
                            toMate.normalize();

                            const pa = this.getStat('PA');
                            let assistFactor = Math.min(1.0, 0.3 + (pa / 80.0));

                            if (this.overrideAimVector) {
                                assistFactor *= 0.1;
                            }

                            finalDir.lerp(toMate, assistFactor);

                            const dist = this.mesh.position.distanceTo(target.mesh.position);
                            finalDir.y += Math.min(0.6, dist * 0.03);
                        } else {
finalDir.y += 0.2;
                        }
                        
                        // Goalie Loft Bonus for Passing
// Goalie Loft Bonus for Passing
                        if (this.role === 'GL') finalDir.y += 0.8; // High loft for clearance
                    }

                    finalDir.normalize();

                    if (techPayload && window.flux.gameInstance && window.flux.gameInstance.triggerTechEvent) {
                        window.flux.gameInstance.triggerTechEvent(this, techName);
                    }

ball.shoot(finalDir, statVal, type, techPayload, spin);
                    
                    // Extra grace period for Goalie to prevent point-blank interceptions
                    if (this.role === 'GL') {
                        ball.catchGracePeriod = 0.6; // 0.6s immunity (approx 10-12m travel)
                    }

this.loseBall();

this.catchCooldown = 1.0; // 1s cooldown
                    this.canCatch = false;
                }
            }, windupTime);

            setTimeout(() => {
                this.isThrowing = false;
                this.overrideAimVector = null;
                this._updateLocomotionAnim(0.2);
            }, windupTime + 500);
        }

        _findPassTargetInCone(aimDir) {
            if (!this.team) return null;

            let bestTarget = null;
            let maxScore = -Infinity;

            for (const mate of this.team.players) {
                if (mate === this || !mate.mesh) continue;

                const toMate = mate.mesh.position.clone().sub(this.mesh.position).normalize();
                const dot = aimDir.dot(toMate);

                if (dot > 0.7) {
                    const dist = this.mesh.position.distanceTo(mate.mesh.position);
                    const score = (dot * 10) - (dist * 0.1);

                    if (score > maxScore) {
                        maxScore = score;
                        bestTarget = mate;
                    }
                }
            }
            return bestTarget;
        }

startCharge() {
            if (!this.hasBall || this.isThrowing || this.status.nap > 0) return;
            this.isCharging = true;
            this.chargeTime = 0;

// Visuals handled in update

            // Show charge UI
            this._updateChargeUI(0);

            // NEW: Spawn Charge Glyph (Ground Ring)
            if (window.flux.gameInstance && window.flux.gameInstance.glyphManager) {
                window.flux.gameInstance.glyphManager.spawn('charge', this.mesh.position, {
                    parent: this,
                    life: this.maxChargeTime,
                    rotationSpeed: 3.0,
                    scaleSpeed: 0.2,
                    offsetY: 0.1
                });
            }
        }

releaseCharge(dx, dy, curveInput = null) {
            if (!this.isCharging) return;
            this.isCharging = false;

            // Power Calculation
            const ratio = Math.min(this.chargeTime / this.maxChargeTime, 1.0);
            const TC = window.flux.ThrowConfig || {};

            // Base multiplier (defaults: 1.0 to 1.8)
            let multiplier = (TC.POWER_BASE !== undefined ? TC.POWER_BASE : 1.0) + (ratio * (TC.POWER_RANGE !== undefined ? TC.POWER_RANGE : 0.8));// MAX POWER BONUS: If held near max, significant boost
            if (ratio > (TC.POWER_MAX_BONUS_RATIO !== undefined ? TC.POWER_MAX_BONUS_RATIO : 0.95)) {
                multiplier = (TC.POWER_MAX_MULTIPLIER !== undefined ? TC.POWER_MAX_MULTIPLIER : 2.5); // Critical Power
                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("MAX POWER!", this.mesh.position, "comic-impact");
                }
                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.addFovImpulse(-10);
                    window.flux.gameInstance.cameraManager.addShake(1.0);
                }
            }

            this._hideChargeUI();

            // Aim Vector Calculation
            let aimVec = null;
            const swipeLen = Math.sqrt(dx*dx + dy*dy);

            if (swipeLen > (TC.SWIPE_MIN_PX !== undefined ? TC.SWIPE_MIN_PX : 20)) {
                const camera = window.flux.gameInstance.camera;
                const fwd = new THREE.Vector3();
                const right = new THREE.Vector3();

                if (camera) {
                    camera.getWorldDirection(fwd);
                    fwd.y = 0;
                    if (fwd.lengthSq() < 0.001) fwd.set(0, 0, -1);
                    else fwd.normalize();

                    right.crossVectors(fwd, new THREE.Vector3(0, 1, 0)).normalize();

                    const worldVec = new THREE.Vector3();
                    worldVec.addScaledVector(right, dx * (TC.AIM_DX_SCALE !== undefined ? TC.AIM_DX_SCALE : 1.0));
                    worldVec.addScaledVector(fwd, -dy * (TC.AIM_DY_SCALE !== undefined ? TC.AIM_DY_SCALE : 1.0));
                    worldVec.normalize();

                    aimVec = worldVec;
                    this.overrideAimVector = aimVec;
                } else {
                    aimVec = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
                    this.overrideAimVector = null;
                }
            } else {
                aimVec = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
                this.overrideAimVector = null;
            }

// --- ANALOG CURVE LOGIC ---
            // Formula: Curve = Intensity * Speed
            let spinVec = null;
            
if ((TC.CURVE_ENABLED !== false) && curveInput && Math.abs(curveInput.intensity) > (TC.CURVE_INTENSITY_THRESHOLD !== undefined ? TC.CURVE_INTENSITY_THRESHOLD : 0.25)) {
                const rawIntensity = Math.abs(curveInput.intensity);
                const sign = Math.sign(curveInput.intensity); // Positive = Right Hump = Left Curve
                const swipeSpeed = curveInput.speed || 1.0;

                // 1. Base Spin from Arc (Tuned for realism, no cyclones)
// 1. Base Spin from Arc (Herculean Boost)
                let spinMag = rawIntensity * (TC.CURVE_SPIN_SCALE !== undefined ? TC.CURVE_SPIN_SCALE : 1000.0);

                // 2. Speed Bonus (Quickness adds RPM)
                const speedBonus = Math.max(1.0, swipeSpeed * (TC.CURVE_SPEED_MULT !== undefined ? TC.CURVE_SPEED_MULT : 1.5));
                spinMag *= speedBonus;

                // Cap (Increased to 1500 for massive arcs)
                spinMag = Math.min((TC.CURVE_SPIN_CAP !== undefined ? TC.CURVE_SPIN_CAP : 1500.0), spinMag);

                // Apply Spin
                // Right Hump (Positive Intensity) -> Left Curve (Positive Spin Y)
                spinVec = new THREE.Vector3(0, spinMag * sign, 0);
                
if (spinMag > (TC.CURVE_PERFECT_SPIN !== undefined ? TC.CURVE_PERFECT_SPIN : 500.0) && window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("PERFECT CURVE", this.mesh.position, "tech");
                    if (window.flux.gameInstance.cameraManager) {
                        window.flux.gameInstance.cameraManager.addShake(0.5);
                        window.flux.gameInstance.cameraManager.addRollImpulse(sign * -0.3); // Tilt camera into the curve
                    }
                }
            }

            // Determine Type (Pass vs Shoot)
// Determine Type (Pass vs Shoot)
const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
            const goalZ = (this.team && this.team.side === 1) ? -goalDist : goalDist;
            const goalDir = new THREE.Vector3(0, 0, goalZ - this.mesh.position.z).normalize();
            const dotGoal = aimVec.dot(goalDir);

            let type = 'PA';
            const distToGoal = Math.abs(this.mesh.position.z - goalZ);

            if (dotGoal > 0.8 && distToGoal < 35.0) {
                type = 'SH';
            } else if (dotGoal > 0.5 && distToGoal < 20.0) {
                type = 'SH';
            }

            // Smart Pass Override
            const targetMate = this._findPassTargetInCone(aimVec);
            if (targetMate && type === 'SH') {
                const distMate = this.mesh.position.distanceTo(targetMate.mesh.position);
                if (distMate < 12.0) type = 'PA';
            }

            const ball = window.flux.gameInstance.entities.ball;
            if (ball) {
                this.throwBall(ball, type, multiplier, spinVec);
            }
        }

        // NEW: Charge UI methods
        _updateChargeUI(ratio) {
            const meter = document.getElementById('charge-meter-fill');
            if (meter) {
                meter.style.width = `${ratio * 100}%`;
                if (ratio > 0.9) {
                    meter.style.background = 'linear-gradient(90deg, #ff0, #f80)';
                } else if (ratio > 0.5) {
                    meter.style.background = 'linear-gradient(90deg, #0f0, #ff0)';
                } else {
                    meter.style.background = 'linear-gradient(90deg, #0af, #0f0)';
                }
            }
            const container = document.getElementById('charge-meter-container');
            if (container) container.style.display = 'block';
        }

        _hideChargeUI() {
            const container = document.getElementById('charge-meter-container');
            if (container) container.style.display = 'none';
        }

        setOverrideAim(x, z) {
            if (!this.overrideAimVector) this.overrideAimVector = new THREE.Vector3();
            this.overrideAimVector.set(x, 0, z).normalize();
        }

loseBall() {
            this.hasBall = false;
            this._hidePassTargetIndicators();
            // Fix: Ensure player can catch again if they lose possession unexpectedly
            this.canCatch = true;
            // Safety: Reset states to prevent locking
            this.isThrowing = false;
            this.isCharging = false;
            this._hideChargeUI();
        }

update(dt) {
            this.updatePhysics(dt);
            this.updateVisuals(dt);
        }

        updatePhysics(dt) {
            if (!this.mesh) return;

            // SYNC FIX: If ball thinks I hold it, but I don't, force receive
            if (this.ballRef && this.ballRef.holder === this && !this.hasBall) {
                console.warn("Syncing ball possession to player");
                this.receiveBall();
            }

            if (this.isGodMode) {
                this.stats.HP = this.stats.maxHP;
                this.currentEN = this.getStat('EN');
                this.status.venom = 0;
                this.status.nap = 0;
            }

            this._updateStatusLogic(dt);

            // Charge Logic (Physics part - Timer)
            if (this.isCharging) {
                if (!this.hasBall || this.status.nap > 0 || this.stunTimer > 0) {
                    this.isCharging = false;
                    // Reset physics props that might have been altered
                    // Visual reset happens in updateVisuals
                } else {
                    this.chargeTime += dt;
                    // AUTO-RELEASE: If held too long (3s), force release
                    if (this.chargeTime > 3.0) {
                        this.releaseCharge(0, 0); 
                        return;
                    }
                }
            }

            if (this.dashCooldown > 0) this.dashCooldown -= dt;
            if (this.clashCooldown > 0) this.clashCooldown -= dt;
            if (this.stunTimer > 0) this.stunTimer -= dt;
            if (this.immunityTimer > 0) this.immunityTimer -= dt;
            if (this.catchCooldown > 0) {
                this.catchCooldown -= dt;
                if (this.catchCooldown <= 0) this.canCatch = true;
            }

            // Dash Logic
            if (this.isDashing) {
                this.dashTime -= dt;
                
                // Smooth Rotation during Dash (Logic affecting transform)
                let diff = this.targetYaw - this.currentYaw;
                while (diff > Math.PI) diff -= Math.PI * 2;
                while (diff < -Math.PI) diff += Math.PI * 2;
                
                const turnSpeed = 15.0; 
                const change = Math.max(-turnSpeed * dt, Math.min(turnSpeed * dt, diff));
                this.currentYaw += change;

                this._checkTackleCollision();
                
                if (this.dashTime <= 0) {
                    this.isDashing = false;
                    this.dashType = null;
                } else {
                    if (this.dashType === 'vertical') {
                        _pVec.copy(this.dashVec).multiplyScalar(dt);
                        this.mesh.position.add(_pVec);
                        // Y position calculation is visual/physics hybrid, keeping here for collision consistency
                        const t = 1 - (this.dashTime / this.dashTotalTime);
                        this.mesh.position.y = Math.sin(t * Math.PI) * 3.0;
                    } else {
                        // Horizontal Dash Movement
                        _pVec.copy(this.velocity).multiplyScalar(dt);
                        this.mesh.position.add(_pVec);
                        this.mesh.position.y = 0;

                        // Rotation update
                        _pQuat.setFromAxisAngle(_pAxisY, this.currentYaw + this.rotationOffset);
                        // Visual lean is calculated in updateVisuals, but we set base orientation here
                        this.mesh.quaternion.copy(_pQuat);

                        this.velocity.multiplyScalar(0.96);
                    }
                }
                return;
            }

            // Stun/Nap Check
            if (this.status.nap > 0 || this.stunTimer > 0) {
                const dragFactor = Math.max(0, 1 - (2.0 * dt));
                this.velocity.multiplyScalar(dragFactor);

                _pVec.copy(this.velocity).multiplyScalar(dt);
                this.mesh.position.add(_pVec);
                return;
            }

            this._checkTacklePressure(dt);

            if (this.isThrowing) {
                this.velocity.multiplyScalar(Math.max(0, 1.0 - (2.0 * dt)));
                this._applySoftCollision(dt);
                this._applyGoalCrease(dt);
                _pVec.copy(this.velocity).multiplyScalar(dt);
                this.mesh.position.add(_pVec);
                this._updateVerticality(dt);
                this._updateBanking(dt); 
            } else {
                this._updatePhysics(dt);
                this._updateVerticality(dt);
                this._updateBanking(dt);
            }
        }

        updateVisuals(dt) {
            if (!this.mesh) return;

            if (this.mixer) {
                this.mixer.update(dt);
            }
            
            this._updateLocomotionAnim(dt); // Animation state logic driven by physics state
            this._updateStatusVisuals(dt);

            // Charge Visuals
            if (this.isCharging) {
                if (this.hasBall && this.status.nap <= 0 && this.stunTimer <= 0) {
                    const ratio = Math.min(this.chargeTime / this.maxChargeTime, 1.0);
                    
                    // Levitation
                    const hover = (Math.sin(Date.now() * 0.02) * 0.1) + (ratio * 0.8);
                    const shake = 0.05 + (0.1 * ratio);
                    
                    this.mesh.position.y = hover + (Math.random() - 0.5) * shake;
                    
                    // Visual Jitter
                    this.bankingAmount += (Math.random() - 0.5) * shake;
                    this.pitchAmount += (Math.random() - 0.5) * shake;

                    this.mesh.scale.setScalar(this.baseScale);
                    this._updateChargeUI(ratio);
                } else {
                    // Reset visuals if charge cancelled
                    this.mesh.position.y = 0;
                    this.mesh.scale.setScalar(this.baseScale);
                    this._hideChargeUI();
                }
            }

            // Dash Visuals (Particles & Lean)
            if (this.isDashing) {
                this._dashParticleTimer -= dt;
                if (this._dashParticleTimer <= 0) {
                    this._dashParticleTimer = 0.01;
                    if (window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                        const back = this.velocity.clone().normalize().negate();
                        if (back.lengthSq() < 0.1) back.set(0, 0, 1);
                        for(let i=0; i<2; i++) {
                            const pos = this.mesh.position.clone().add(back.multiplyScalar(0.5));
                            pos.y += 1.0 + (Math.random() - 0.5) * 0.5;
                            pos.x += (Math.random() - 0.5) * 0.5;
                            pos.z += (Math.random() - 0.5) * 0.5;
                            window.flux.gameInstance.particleManager.spawn('dash_stream', pos, { scale: 2.0 + Math.random() });
                        }
                    }
                }

                // Visual Lean for Dash
                if (this.dashType === 'horizontal' || this.dashType === 'break' || this.dashType === 'sprint') {
                    const t = 1 - (this.dashTime / this.dashTotalTime);
                    const lean = Math.sin(t * Math.PI);
                    
                    _pQuat.setFromAxisAngle(_pAxisY, this.currentYaw + this.rotationOffset);
                    
                    let pitch = 0, yaw = 0, roll = 0, lungeAmt = 0;
                    if (this.dashType !== 'sprint') {
                         pitch = 1.2 * lean; yaw = 0.8 * lean; roll = -0.6 * lean; lungeAmt = 0.8 * lean;
                    } else {
                         pitch = 0.5 * lean; lungeAmt = 0.2 * lean;
                    }

                    if (lungeAmt > 0) {
                         _pVec.set(0, 0, lungeAmt).applyQuaternion(_pQuat);
                         // Visual offset only, don't accumulate to physics position
                         // Note: We are modifying mesh.position here which is the physics transform.
                         // Ideally we should have a visual child node, but for now we add the offset.
                         // To prevent drift, we rely on physics update resetting Y and X/Z being integrated.
                         // Actually, adding to mesh.position here WILL affect physics next frame.
                         // For now, we accept this visual-impacting-physics behavior as it was in original code.
                         this.mesh.position.add(_pVec);
                    }

                    _pEuler.set(pitch, yaw, roll);
                    _pQuat2.setFromEuler(_pEuler);
                    this.mesh.quaternion.multiplyQuaternions(_pQuat, _pQuat2);
                }
            }

            // Stun/Nap Visual Reset
            if (this.status.nap > 0 || this.stunTimer > 0) {
                if (!this._animLocked && this.state !== 'idle' && this.state !== 'catch') this.play('idle', 0.5);
            }

            this._updateHPBar();
            this._updatePassTargetIndicators();

            // Bubble Trail
            const speedSq = this.velocity.lengthSq();
            if (speedSq > 1.0 && window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                this._bubbleTimer -= dt;
                if (this._bubbleTimer <= 0) {
                    const pm = window.flux.gameInstance.particleManager;
                    const backDir = this.velocity.clone().normalize().negate();
                    
                    const offset = backDir.clone().multiplyScalar(0.8);
                    offset.y = 0.5 + Math.random() * 0.5; 
                    offset.x += (Math.random()-0.5) * 0.5;
                    offset.z += (Math.random()-0.5) * 0.5;
                    pm.spawn('bubble', this.mesh.position.clone().add(offset), { scale: 0.15 + Math.random() * 0.25 });

                    if (speedSq > 40.0) {
                        for(let i=0; i<3; i++) {
                            const mOffset = backDir.clone().multiplyScalar(0.5 + Math.random()*0.5);
                            mOffset.x += (Math.random()-0.5)*0.8;
                            mOffset.y = 0.5 + (Math.random()-0.5)*0.8; 
                            mOffset.z += (Math.random()-0.5)*0.8;
                            pm.spawn('bubble_micro', this.mesh.position.clone().add(mOffset), { scale: 0.06 + Math.random()*0.08 });
                        }
                        this._bubbleTimer = 0.03; 
                    } else {
                        this._bubbleTimer = 0.1; 
                    }
                }
            }

            this._applyProceduralPose(dt);
        }

        _applyProceduralPose(dt) {
            // Advance local time (used for subtle sways)
            this._procAnimTime += dt;

            const b = this.bones;
            if (!b) return;

            const game = window.flux.gameInstance;
            const ball = (game && game.entities) ? game.entities.ball : null;

            let shouldApply = false;

            // Build a desired world-space direction we want the torso/head to bias toward.
            // NOTE: We apply this AFTER the animation mixer has posed bones, as a small additive offset.
            _pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();

            if (this.hasBall) {
                // Aim direction (prefer explicit aim vector)
                if (this.overrideAimVector) {
                    _pVec.copy(this.overrideAimVector).normalize();
                } else if (this.lockedAimVector) {
                    _pVec.copy(this.lockedAimVector).normalize();
                } else if (this.inputVector && this.inputVector.lengthSq() > 0.08) {
                    _pVec.copy(this.inputVector).normalize();
                } else {
                    _pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
                }
                shouldApply = true;
            } else if (ball && ball.mesh) {
                // Look at the ball if it's in the "awareness" radius
                const dist = this.mesh.position.distanceTo(ball.mesh.position);
                if (dist < 20.0) {
                    _pVec.subVectors(ball.mesh.position, this.mesh.position);
                    shouldApply = true;
                }
            }

            if (!shouldApply) return;

            // Convert the direction into the player's local space so yaw/pitch are stable.
            _pInvQuat.copy(this.mesh.quaternion).invert();
            _pVec.applyQuaternion(_pInvQuat).normalize();

            const lx = _pVec.x, ly = _pVec.y, lz = _pVec.z;
            const yaw = Math.atan2(lx, lz);
            const pitch = Math.atan2(ly, Math.sqrt(lx * lx + lz * lz) + 1e-6);

            const yawC = THREE.MathUtils.clamp(yaw, -0.9, 0.9);
            const pitchC = THREE.MathUtils.clamp(pitch, -0.6, 0.6);

            const speedNorm = (this.maxSpeed > 0.0001) ? THREE.MathUtils.clamp(this._smoothedSpeed / this.maxSpeed, 0, 1) : 0;
            const aimW = (this.hasBall ? (this.isCharging ? 1.0 : 0.65) : 0.35) * (1.0 - 0.35 * speedNorm);
            const headW = (this.hasBall ? 0.55 : 0.75) * (1.0 - 0.25 * speedNorm);

            // Torso bias (spine/chest)
            if (b.chest) {
                _pTmpEuler.set(-pitchC * 0.20 * aimW, yawC * 0.35 * aimW, 0);
                _pTmpQuat.setFromEuler(_pTmpEuler);
                b.chest.quaternion.multiply(_pTmpQuat);
            } else if (b.spine) {
                _pTmpEuler.set(-pitchC * 0.15 * aimW, yawC * 0.25 * aimW, 0);
                _pTmpQuat.setFromEuler(_pTmpEuler);
                b.spine.quaternion.multiply(_pTmpQuat);
            }

            // Head/neck look
            if (b.neck) {
                _pTmpEuler.set(-pitchC * 0.25 * headW, yawC * 0.45 * headW, 0);
                _pTmpQuat.setFromEuler(_pTmpEuler);
                b.neck.quaternion.multiply(_pTmpQuat);
            }
            if (b.head) {
                _pTmpEuler.set(-pitchC * 0.30 * headW, yawC * 0.55 * headW, 0);
                _pTmpQuat.setFromEuler(_pTmpEuler);
                b.head.quaternion.multiply(_pTmpQuat);
            }

            // Ball-hold / aim arm pose (keeps "swim" animation but reads as holding/aiming)
            if (this.hasBall && !this.isThrowing && !this._animLocked) {
                const t = this._procAnimTime;
                const lift = THREE.MathUtils.clamp(0.35 + (this.isCharging ? 0.55 : 0.25) - speedNorm * 0.2, 0.15, 0.95);
                const sway = Math.sin(t * 5.0) * 0.05 * (0.5 + lift);

                const raiseX = -0.55 * lift + sway;
                const raiseZ = -0.25 * lift;

                if (b.rUpperArm) {
                    _pTmpEuler.set(raiseX, yawC * 0.10 * lift, raiseZ);
                    _pTmpQuat.setFromEuler(_pTmpEuler);
                    b.rUpperArm.quaternion.multiply(_pTmpQuat);
                }
                if (b.rForeArm) {
                    _pTmpEuler.set(-0.35 * lift + sway * 0.5, 0, 0);
                    _pTmpQuat.setFromEuler(_pTmpEuler);
                    b.rForeArm.quaternion.multiply(_pTmpQuat);
                }

                // Counterbalance left arm slightly for a more dynamic silhouette
                if (b.lUpperArm) {
                    _pTmpEuler.set(0.15 * lift, -yawC * 0.05 * lift, 0.15 * lift);
                    _pTmpQuat.setFromEuler(_pTmpEuler);
                    b.lUpperArm.quaternion.multiply(_pTmpQuat);
                }
            }
        }
_updateStatus(dt) {
        // Legacy wrapper
        this._updateStatusLogic(dt);
        this._updateStatusVisuals(dt);
    }

    _updateStatusLogic(dt) {
        if (this.status.venom > 0) {
            this.status.venom -= dt;
            this.stats.HP -= 5 * dt;
            if (this.stats.HP < 0) this.stats.HP = 0;
        } else {
            if (!this.hasBall && this.stats.HP < this.stats.maxHP) {
                this.stats.HP += 5 * dt;
                if (this.stats.HP > this.stats.maxHP) this.stats.HP = this.stats.maxHP;
            }
        }

        if (this.hasBall) {
            this.stats.HP -= 2.0 * dt;
            if (this.stats.HP < 0) this.stats.HP = 0;
        }

        if (this.status.nap > 0) {
            this.status.nap -= dt;
        }

        for (let key in this.status.wither) {
            if (this.status.wither[key] > 0) {
                this.status.wither[key] -= dt;
            }
        }
    }

    _updateStatusVisuals(dt) {
        const pm = window.flux.gameInstance ? window.flux.gameInstance.particleManager : null;

        if (this.status.venom > 0) {
            this._particleTimers.venom -= dt;
            if (this._particleTimers.venom <= 0 && pm) {
                pm.spawn('venom', this.mesh.position);
                this._particleTimers.venom = 0.15;
            }
        }

        if (this.status.nap > 0) {
            this._particleTimers.nap -= dt;
            if (this._particleTimers.nap <= 0 && pm) {
                pm.spawn('nap', this.mesh.position);
                this._particleTimers.nap = 0.8;
            }
        }

        let isWithering = false;
        for (let key in this.status.wither) {
            if (this.status.wither[key] > 0) isWithering = true;
        }

        if (isWithering) {
            this._particleTimers.wither -= dt;
            if (this._particleTimers.wither <= 0 && pm) {
                pm.spawn('wither', this.mesh.position);
                this._particleTimers.wither = 0.2;
            }
        }

        this._updateVisuals();
    }

_updateVisuals() {
            // REMOVED: Yellow sphere/tint logic as per request.
            // Always revert to base color.
            this.originalMaterials.forEach(entry => {
                entry.material.color.copy(entry.baseColor);
            });
        }

        _createAura() {
            // Aura removed per user request
            this.auraMesh = null;
        }

        // NEW: Pass target indicator
        _createPassTargetIndicator() {
            // Create a ring that highlights potential pass targets
            const geo = new THREE.RingGeometry(0.8, 1.0, 16);
            const mat = new THREE.MeshBasicMaterial({
                color: 0x00ff00,
                transparent: true,
                opacity: 0.6,
                side: THREE.DoubleSide
            });
            this.passTargetIndicator = new THREE.Mesh(geo, mat);
            this.passTargetIndicator.rotation.x = -Math.PI / 2;
            this.passTargetIndicator.position.y = 0.1;
            this.passTargetIndicator.visible = false;
            this.scene.add(this.passTargetIndicator);
        }

        _updatePassTargetIndicators() {
            if (!this.hasBall || !this.team) {
                this._hidePassTargetIndicators();
                return;
            }

            // Find best pass target
            const aimDir = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion);
            const target = this._findPassTargetInCone(aimDir);

            if (target && target.mesh && this.passTargetIndicator) {
                this.passTargetIndicator.visible = true;
                this.passTargetIndicator.position.x = target.mesh.position.x;
                this.passTargetIndicator.position.z = target.mesh.position.z;
                this.passTargetIndicator.position.y = 0.1;
                this.passTargetIndicator.rotation.z += 0.05;
            } else {
                this._hidePassTargetIndicators();
            }
        }

        _hidePassTargetIndicators() {
            if (this.passTargetIndicator) {
                this.passTargetIndicator.visible = false;
            }
        }

_applySoftCollision(dt) {
            if (!this.mesh || !window.flux.gameInstance) return;

            const game = window.flux.gameInstance;
            const teams = [game.teams.home, game.teams.away];

            const repulsionRadius = 0.5; // Reduced to 0.5 to fix invisible wall issues
            const stiffness = 15.0;

            teams.forEach(team => {
                if (!team) return;
                team.players.forEach(other => {
                    if (other === this || !other.mesh) return;

                    const dx = this.mesh.position.x - other.mesh.position.x;
                    const dy = this.mesh.position.y - other.mesh.position.y;
                    const dz = this.mesh.position.z - other.mesh.position.z;

                    const distSq = dx*dx + dy*dy + dz*dz;
                    const minDist = repulsionRadius * 2.0;

                    if (distSq < minDist * minDist && distSq > 0.0001) {
                        const dist = Math.sqrt(distSq);
                        const overlap = minDist - dist;

                        const force = overlap * stiffness;

                        const nx = dx / dist;
                        const ny = dy / dist;
                        const nz = dz / dist;

                        this.velocity.x += nx * force * dt;
                        this.velocity.y += ny * force * dt;
                        this.velocity.z += nz * force * dt;
                    }
                });
            });
        }

_updatePhysics(dt) {
            this._applySoftCollision(dt);
            this._applyGoalCrease(dt);

            const inputLenSq = this.inputVector.lengthSq();
            const isInputActive = inputLenSq > 0.01;

            let currentMaxSpeed = this.maxSpeed;
            
            // STRUGGLE STATE: Hinder movement based on pressure
            // Instead of a binary 0.8 multiplier, we scale based on intensity.
            // Max struggle (1.0) reduces speed to 40%.
            if (this.struggleIntensity > 0) {
                currentMaxSpeed *= (1.0 - (this.struggleIntensity * 0.6));
            } else if (this.isEngaged) {
                // Fallback slight reduction if engaged but low pressure
                currentMaxSpeed *= 0.9;
            }
            
            if (this.isCharging) currentMaxSpeed *= 0.9;

            if (isInputActive) {
                _pVec.copy(this.inputVector).normalize();

                // Apply Struggle Jitter to direction
                // Simulates wrestling for control
                if (this.struggleIntensity > 0.3) {
                    const jitter = (Math.random() - 0.5) * this.struggleIntensity * 0.8;
                    _pVec.x += jitter;
                    _pVec.z += jitter;
                    _pVec.normalize();
                }

                const targetVelX = _pVec.x * currentMaxSpeed;
                const targetVelZ = _pVec.z * currentMaxSpeed;

                const currentSpeed = this.velocity.length();
                const speedRatio = Math.min(1.0, currentSpeed / this.maxSpeed);

                // Agility is reduced when struggling
                let agility = THREE.MathUtils.lerp(10.0, 2.0, speedRatio);
                if (this.struggleIntensity > 0) agility *= 0.5;

                const t = 1.0 - Math.pow(0.01, dt * agility);

                this.velocity.x += (targetVelX - this.velocity.x) * t;
                this.velocity.z += (targetVelZ - this.velocity.z) * t;

            } else {
                const brakeFactor = 2.0;
                const t = 1.0 - Math.pow(0.1, dt * brakeFactor);

                this.velocity.x += (0 - this.velocity.x) * t;
                this.velocity.z += (0 - this.velocity.z) * t;

                if (this.velocity.lengthSq() < 0.01) {
                    this.velocity.set(0, this.velocity.y, 0);
                }
            }

            this.velocity.y *= Math.max(0, 1.0 - (2.0 * dt));

            _pVec.copy(this.velocity).multiplyScalar(dt);
            this.mesh.position.add(_pVec);
        }

        _updateVerticality(dt) {
            let targetY = 0;

            const ball = window.flux.gameInstance.entities.ball;

            if (ball && ball.mesh && !this.hasBall) {
                const distToBall = this.mesh.position.distanceTo(ball.mesh.position);
                if (distToBall < 15.0) {
                    targetY = ball.mesh.position.y;
                }
            }

            if (this.hasBall) {
                targetY = 0.5;
            }

            const yDiff = targetY - this.mesh.position.y;

            const lift = yDiff * 10.0 * dt;
            this.velocity.y += lift;

            if (this.mesh.position.y > 8.0) {
                this.mesh.position.y = 8.0;
                this.velocity.y *= -0.5;
            } else if (this.mesh.position.y < -8.0) {
                this.mesh.position.y = -8.0;
                this.velocity.y *= -0.5;
            }
        }

        // FIXED: Improved banking with hysteresis to prevent facing flips
// FIXED: Improved banking with hysteresis to prevent facing flips
        _updateBanking(dt) {
            const inputLenSq = this.inputVector.lengthSq();
            const velLenSq = this.velocity.lengthSq();

            let targetYaw = this.targetYaw;
            let shouldUpdateYaw = false;

            // PRIORITY 1: Explicit Aim (Aim Stick / Swipe)
            if (this.overrideAimVector) {
                targetYaw = Math.atan2(this.overrideAimVector.x, this.overrideAimVector.z);
                shouldUpdateYaw = true;
            }
            // PRIORITY 2: Movement Input
            else if (inputLenSq > this.facingDeadzone * this.facingDeadzone) {
                targetYaw = Math.atan2(this.inputVector.x, this.inputVector.z);
                shouldUpdateYaw = true;
            } 
            // PRIORITY 3: Velocity (Drifting)
            else if (velLenSq > this.facingDeadzone * this.facingDeadzone) {
                targetYaw = Math.atan2(this.velocity.x, this.velocity.z);
                shouldUpdateYaw = true;
            }

            // If we should update, do so. Otherwise keep last valid yaw
            if (shouldUpdateYaw) {
                this.lastValidYaw = targetYaw;
            } else {
                targetYaw = this.lastValidYaw;
            }

            // Smooth Yaw with wrap-around handling
            let diff = targetYaw - this.currentYaw;
            while (diff > Math.PI) diff -= Math.PI * 2;
            while (diff < -Math.PI) diff += Math.PI * 2;

            const speedRatio = Math.min(1.0, this.velocity.length() / this.maxSpeed);
const turnSpeed = THREE.MathUtils.lerp(8.0, 4.0, speedRatio); // Reduced from 12.0/6.0 to reduce flipping

            // Prevent sudden snaps when diff is very large (teleport/reset scenarios)
            const maxYawChange = Math.PI * dt * turnSpeed;
            const yawChange = Math.max(-maxYawChange, Math.min(maxYawChange, diff * dt * turnSpeed));

            this.currentYaw += yawChange;
            this.targetYaw = targetYaw;

            // Banking
            const bankSensitivity = 0.8;
            const maxBank = 0.75;

            let targetBank = -diff * bankSensitivity;
            targetBank = Math.max(-maxBank, Math.min(maxBank, targetBank));

            const bankLerp = 1.0 - Math.pow(0.02, dt);
            this.bankingAmount += (targetBank - this.bankingAmount) * bankLerp;

            // Pitch
            const pitchSensitivity = 0.1;
            const maxPitch = 1.0;

            let targetPitch = -this.velocity.y * pitchSensitivity;
            targetPitch = Math.max(-maxPitch, Math.min(maxPitch, targetPitch));

            const pitchLerp = 1.0 - Math.pow(0.05, dt);
            this.pitchAmount += (targetPitch - this.pitchAmount) * pitchLerp;

            // Apply Rotation
            const finalYaw = this.currentYaw + this.rotationOffset;

            this.mesh.quaternion.setFromAxisAngle(_pAxisY, finalYaw);

            _pQuat.setFromAxisAngle(new THREE.Vector3(1, 0, 0), this.pitchAmount);
            this.mesh.quaternion.multiply(_pQuat);

            _pQuat.setFromAxisAngle(new THREE.Vector3(0, 0, 1), this.bankingAmount);
            this.mesh.quaternion.multiply(_pQuat);

            // Idle Bob
            if (velLenSq < 0.1 && !this.isEngaged) {
                const time = Date.now() * 0.0015;
                const bobPitch = Math.sin(time) * 0.03;
                const bobRoll = Math.cos(time * 0.7) * 0.02;

_pEuler.set(bobPitch, 0, bobRoll);
                _pQuat.setFromEuler(_pEuler);
                this.mesh.quaternion.multiply(_pQuat);
            }
        }

_checkTacklePressure(dt) {
            this.struggleIntensity = 0;
            
            if (!this.hasBall) {
                this.isEngaged = false;
                this.encounterTimer = 0;
                return;
            }

            if (this.immunityTimer > 0) return;
            if (this.isDashing) return;

            const game = window.flux.gameInstance;
            if (!game || !this.team) return;

            const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
            const opponentTeam = game.teams[opponentTeamId];
            if (!opponentTeam) return;

            let totalPressure = 0;
            let engagedCount = 0;
            const effectiveRadius = this.tackleRadius; 

            // Forward vector for shielding check
            _pVec.copy(_pAxisZ).applyQuaternion(this.mesh.quaternion); 

            for (const entity of opponentTeam.players) {
                if (!entity.mesh || entity.status.nap > 0 || entity.stunTimer > 0) continue;
                
                const dist = this.mesh.position.distanceTo(entity.mesh.position);
                if (dist < effectiveRadius) {
                    engagedCount++;
                    
                    // Calculate Pressure Intensity (0 to 1 based on distance)
                    const proximity = 1.0 - (dist / effectiveRadius);
                    
                    // Base Pressure from AT stat
                    let pressure = entity.getStat('AT') * proximity;

                    // Directional Shielding (Continuous)
                    const toOpp = entity.mesh.position.clone().sub(this.mesh.position).normalize();
                    const dot = _pVec.dot(toOpp);
                    
                    // If opponent is BEHIND (dot < -0.2), pressure is reduced (Shielding)
                    let isShielded = false;
                    if (dot < -0.2) {
                        pressure *= 0.5;
                        isShielded = true;
                    }

                    // Tech Modifiers (Continuous application chance)
                    if (entity.techs.tackle === 'venom') {
                        if (Math.random() < dt * 0.5) this.applyStatus('venom', 5.0);
                        pressure *= 1.2;
                    } else if (entity.techs.tackle === 'wither') {
                        if (Math.random() < dt * 0.5) this.applyStatus('wither', 5.0, 'EN');
                        pressure *= 1.2;
                    } else if (entity.techs.tackle === 'drain') {
                        const drainAmt = pressure * dt * 0.5;
                        this.stats.HP -= drainAmt;
                        entity.stats.HP += drainAmt;
                    }

                    totalPressure += pressure;

                    // Visuals: Sparks occasionally based on pressure
                    if (Math.random() < dt * 4.0 * proximity) { 
                         if (game.spawnClash) {
                            const mid = this.mesh.position.clone().lerp(entity.mesh.position, 0.5);
                            mid.y += 1.0;
                            game.spawnClash(mid, 0.5);
                        }
                    }
                    
                    // Occasional Shield Text
                    if (isShielded && Math.random() < dt * 1.0 && game.floatingText) {
                        // game.floatingText.spawn("SHIELD", this.mesh.position, "block"); // Too spammy, maybe just sound later
                    }
                }
            }

            this.isEngaged = (engagedCount > 0);

            if (this.isEngaged) {
                this.encounterTimer += dt;

                // Apply EN Drain (Continuous)
                // Scaling: 20 AT pressure -> approx 10 EN lost per second
                const drainRate = totalPressure * 0.5; 
                this.currentEN -= drainRate * dt;
                
                // Update Struggle Intensity for Physics (0.0 to 1.0)
                // Max struggle at roughly 30 pressure
                this.struggleIntensity = Math.min(1.0, totalPressure / 30.0);

                // Visual Feedback for Drain (Accumulate to avoid spam)
                this._accumulatedDamage += drainRate * dt;
                if (this._accumulatedDamage > 5.0) {
                    if (game.floatingText) {
                        game.floatingText.spawn(`-${Math.floor(this._accumulatedDamage)}`, this.mesh.position, "damage");
                    }
                    this._accumulatedDamage = 0;
                }
                
                // Hint for player if engaged too long
                if (this.encounterTimer > 1.0 && this.encounterTimer < 1.1 && this.team.isHuman && this.team.activePlayer === this) {
                     if (game.floatingText) game.floatingText.spawn("BREAK!", this.mesh.position, "tech");
                }
            } else {
                this.encounterTimer = 0;
            }

            if (this.currentEN <= 0) {
                this.fumble();
            }
        }

        _performJechtKnockback() {
            if (!this.team) return;
            const game = window.flux.gameInstance;
            const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
            const opponentTeam = game.teams[opponentTeamId];

            if (!opponentTeam) return;

            const range = 6.0;
            const force = 25.0;

            if (game.floatingText) {
                game.floatingText.spawn("JECHT SHOT!", this.mesh.position, "goal");
            }

            opponentTeam.players.forEach(p => {
                if (!p.mesh) return;
                const dist = this.mesh.position.distanceTo(p.mesh.position);
                if (dist < range) {
                    const dir = p.mesh.position.clone().sub(this.mesh.position).normalize();
                    dir.y = 0.5;
                    dir.normalize();

p.velocity.add(dir.multiplyScalar(force));

                    p.stunTimer = 2.0; // Ensure they stay down
                    p.isDashing = false;
                    const reactAction = p.actions && p.actions['react'];
                    if (reactAction) {
                        reactAction.setLoop(THREE.LoopOnce);
                        reactAction.clampWhenFinished = true;
                        p.playOneShot('react', 0.1);
} else {
                        p.play('catch', 0.5);
                    }

                    if (game.floatingText) {
                        game.floatingText.spawn("SMACK!", p.mesh.position, "damage");
                    }
                    if (game.triggerImpact) game.triggerImpact(0.15, 'shatter');
                }
            });
        }

        fumble() {
            console.log("FUMBLE! EN Depleted.");
            if (window.flux.gameInstance.floatingText && this.mesh) {
                window.flux.gameInstance.floatingText.spawn("CRASH!", this.mesh.position, "comic-impact");
            }

            this.stunTimer = 1.5;

            const backDir = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize().negate();
            backDir.x += (Math.random() - 0.5) * 0.5;
            backDir.z += (Math.random() - 0.5) * 0.5;
            backDir.normalize();

            this.velocity.add(backDir.multiplyScalar(12.0));

            if (this.hasBall) {
                const ball = window.flux.gameInstance.entities.ball;
                if (ball) {
                    const ejectDir = new THREE.Vector3(Math.random()-0.5, 0.8, Math.random()-0.5).normalize();
                    ball.shoot(ejectDir, 6.0, 'none');
this.loseBall();
                    this.canCatch = false;

                    this.currentEN = 0;
                }
            }
        }

        dash(x, z) {
            if (this.isDashing || this.dashCooldown > 0) return;
            if (this.status.nap > 0) return;

            // OFFENSE: BREAK TACKLE
            if (this.hasBall && this.isEngaged) {
                const cost = 15;

                if (this.currentEN < cost) {
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("FAILED!", this.mesh.position, "damage");
                    }
                    this.fumble();
                    return;
                }

                this.currentEN -= cost;
                this.isDashing = true;
                this.dashTime = 0.4;
                this.dashCooldown = 2.0;
                this.dashType = 'break';

_pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
this.velocity.add(_pVec.multiplyScalar(10.0)); // Nerfed from 15.0 for realism

                const game = window.flux.gameInstance;
                const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
                const opponentTeam = game.teams[opponentTeamId];

                opponentTeam.players.forEach(p => {
                    if (!p.mesh) return;
                    const dist = this.mesh.position.distanceTo(p.mesh.position);
                    if (dist < this.tackleRadius * 1.5) {
                        const pushDir = p.mesh.position.clone().sub(this.mesh.position).normalize();
                        pushDir.y = 0.5;
                        p.velocity.add(pushDir.multiplyScalar(15.0));

                        p.stunTimer = 2.0;
                        p.play('catch', 0.2);

                        if (game.floatingText) {
                            game.floatingText.spawn("STUN!", p.mesh.position, "damage");
                        }
                    }
                });

if (game.floatingText) {
                    game.floatingText.spawn("BREAK!", this.mesh.position, "tech");
                }
                
// NEW: Spawn Break Glyph (Explosive Burst)
                if (game.glyphManager) {
                    game.glyphManager.spawn('status', this.mesh.position, {
                        parent: this,
                        life: 0.5,
                        rotationSpeed: 8.0,
                        scaleSpeed: 3.0,
                        offsetY: 0.5
                    });
                }
                
// Particle Burst (Break Tackle)
// Particle Burst (Break Tackle)
                if (game.particleManager) {
for(let i=0; i<30; i++) {
                    game.particleManager.spawn('flash', this.mesh.position, { scale: 2.5 });
                    // Bubble Burst

                        const bubblePos = this.mesh.position.clone().add(new THREE.Vector3((Math.random()-0.5)*2, (Math.random()-0.5)*2, (Math.random()-0.5)*2));
                        game.particleManager.spawn('bubble', bubblePos, { scale: 0.2 + Math.random() * 0.4 });
                    }
                }

                if (game.triggerImpact) game.triggerImpact(0.15, 'heavy');

                return;
            }
            // OFFENSE: SPRINT
            if (this.hasBall) {
                const cost = 5;
                if (this.currentEN < cost) {
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("NO EN!", this.mesh.position, "damage");
                    }
                    return;
                }

                this.currentEN -= cost;
                this.isDashing = true;
                this.dashTime = 0.4;
                this.dashCooldown = 1.5;
                this.dashType = 'sprint';

const burstDir = this.velocity.clone().normalize();
                if (burstDir.lengthSq() < 0.1) burstDir.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);

this.velocity.add(burstDir.multiplyScalar(12.0)); // Nerfed from 15.0
                if (window.flux.gameInstance.audioManager) window.flux.gameInstance.audioManager.playSFX('dash');

                if (window.flux.gameInstance.cameraManager) {
                    window.flux.gameInstance.cameraManager.addFovImpulse(20);
                }
                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("DASH!", this.mesh.position, "tech");
                }
                return;
            }

            // DEFENSE: BLOCK / TACKLE
            const ball = window.flux.gameInstance.entities.ball;
            let isBlockContext = false;
            if (ball && ball.mesh) {
                const dist = this.mesh.position.distanceTo(ball.mesh.position);
                if (dist < 8.0 && ball.mesh.position.y > 2.5) {
                    isBlockContext = true;
                }
            }

            this.isDashing = true;
            this.dashTime = this.dashTotalTime;
            this.dashCooldown = 1.5;

            const len = Math.sqrt(x*x + z*z);
            const nx = (len > 0) ? x/len : 0;
            const nz = (len > 0) ? z/len : 0;

if (len > 0) {
                // Smooth turn for dash instead of snap
                this.targetYaw = Math.atan2(nx, nz);
            }
            if (isBlockContext) {
                this.dashType = 'vertical';

                const dirToBall = ball.mesh.position.clone().sub(this.mesh.position);
                dirToBall.y = 0;

                if (dirToBall.lengthSq() > 0.01) {
                    dirToBall.normalize();
                    this.dashVec.copy(dirToBall).multiplyScalar(8.0);
                } else {
                    this.dashVec.set(0, 0, 0);
                }

                const catchAction = this.actions['catch'];
                if (catchAction) {
                    catchAction.setLoop(THREE.LoopOnce);
                    catchAction.clampWhenFinished = true;
                    catchAction.timeScale = 1.5;
                }
                this.play('catch', 0.1);

                if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("BLOCK!", this.mesh.position, "default");
                }

            } else {
                this.dashType = 'horizontal';
                this._hasHitTackle = false;

                // Apply velocity impulse in dash direction
// Apply velocity impulse in dash direction
                _pVec.set(nx, 0, nz);
                if (_pVec.lengthSq() < 0.1) {
                    _pVec.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
                }
this.velocity.add(_pVec.multiplyScalar(14.0)); // Nerfed from 20.0

                const lungeAction = this.actions['throw'];
                if (lungeAction) {
                    lungeAction.setLoop(THREE.LoopOnce);
                    lungeAction.clampWhenFinished = true;
                    lungeAction.timeScale = 2.0;
                }
this.play('throw', 0.1);
                if (window.flux.gameInstance.audioManager) window.flux.gameInstance.audioManager.playSFX('dash');

                if (window.flux.gameInstance.triggerImpact) window.flux.gameInstance.triggerImpact(0.05, 'default');
            }

if (window.flux.gameInstance.cameraManager) {
                window.flux.gameInstance.cameraManager.addFovImpulse(10);
                window.flux.gameInstance.cameraManager.addShake(0.3); 
            }
            // Dash Effect
            if (window.flux.gameInstance.particleManager) {
                const dashPos = this.mesh.position.clone();
                dashPos.y += 1.0;
                window.flux.gameInstance.particleManager.spawn('shockwave', dashPos, { scale: 1.5, life: 0.3 });
                // Speed lines
                const back = this.velocity.clone().normalize().negate();
                for(let i=0; i<3; i++) {
                    const p = dashPos.clone().add(back.multiplyScalar(Math.random()));
                    p.x += (Math.random()-0.5);
                    window.flux.gameInstance.particleManager.spawn('dash_stream', p, { scale: 1.5 });
                }
            }
        }

        _createHPBar() {
            const container = new THREE.Group();

            const bgGeo = new THREE.PlaneGeometry(1.2, 0.15);
            const bgMat = new THREE.MeshBasicMaterial({ color: 0x000000, side: THREE.DoubleSide, depthTest: false });
            const bg = new THREE.Mesh(bgGeo, bgMat);
            container.add(bg);

            const fillGeo = new THREE.PlaneGeometry(1.16, 0.11);
            fillGeo.translate(0.58, 0, 0);
            const fillMat = new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.DoubleSide, depthTest: false });
            this.hpBarFill = new THREE.Mesh(fillGeo, fillMat);
            this.hpBarFill.position.set(-0.58, 0, 0.01);
            container.add(this.hpBarFill);

            this.hpBar = container;
            this.scene.add(this.hpBar);
        }

_updateHPBar() {
            if (!this.hpBar || !this.mesh) return;

            // Visibility Check: Only show if mesh is visible AND in Active/Practice states
            if (!this.mesh.visible) {
                this.hpBar.visible = false;
                return;
            }

            const game = window.flux.gameInstance;
            const allowedState = game && (game.state === 'active' || game.state === 'kickoff');
            
            if (!allowedState) {
                this.hpBar.visible = false;
                return;
            }
            this.hpBar.position.copy(this.mesh.position);
            this.hpBar.position.y += 2.2;

            if (window.flux.gameInstance && window.flux.gameInstance.camera) {
                this.hpBar.lookAt(window.flux.gameInstance.camera.position);
            }

            const pct = Math.max(0, this.stats.HP / this.stats.maxHP);
            this.hpBarFill.scale.setX(pct);

            if (pct > 0.5) this.hpBarFill.material.color.setHex(0x00ff00);
            else if (pct > 0.25) this.hpBarFill.material.color.setHex(0xffff00);
            else this.hpBarFill.material.color.setHex(0xff0000);

            // Hide if full HP to reduce clutter, unless in practice mode
            const alwaysShow = game && game.gameMode === 'practice';
            this.hpBar.visible = (pct < 0.98 || alwaysShow);
        }

        gainExp(amount) {
            if (!window.flux.gameInstance || window.flux.gameInstance.state !== 'active') return;

            this.exp += amount;

            if (this.exp >= this.nextLevelExp) {
                this.levelUp();
            }
        }

        levelUp() {
            this.level++;
            this.exp -= this.nextLevelExp;
            this.nextLevelExp = Math.floor(this.nextLevelExp * 1.5);

            const keys = ['HP', 'EN', 'AT', 'PA', 'BL', 'SH', 'CA', 'SP'];

            const hpGain = Math.floor(Math.random() * 20) + 10;
            this.stats.maxHP += hpGain;
            this.stats.HP = this.stats.maxHP;

            keys.forEach(k => {
                if (k === 'HP') return;
                if (Math.random() > 0.4) {
                    const gain = Math.floor(Math.random() * 2) + 1;
                    this.stats[k] += gain;
                }
            });

            this._updateDerivedStats();

            console.log(`${this.role} reached Level ${this.level}!`);

            if (window.flux.gameInstance.floatingText && this.mesh) {
                window.flux.gameInstance.floatingText.spawn("LEVEL UP!", this.mesh.position, "tech");
            }
        }

        _checkTackleCollision() {
            if (!this.team || this._hasHitTackle) return;

            const game = window.flux.gameInstance;
            if (!game) return;

            const opponentTeamId = this.team.id === 'home' ? 'away' : 'home';
            const opponentTeam = game.teams[opponentTeamId];

            for (const opp of opponentTeam.players) {
                if (!opp.mesh) continue;
                const dist = this.mesh.position.distanceTo(opp.mesh.position);

if (dist < 3.0) { // Increased from 2.0 for easier hits
                    this._resolveTackleHit(opp);
                    this._hasHitTackle = true;
                    return;
                }
            }
        }

_resolveTackleHit(opp) {
            this.play('idle', 0.2);
            
            if (window.flux.gameInstance.audioManager) {
                window.flux.gameInstance.audioManager.playSFX('tackle');
            }

const at = this.getStat('AT');
            let damage = at * 3.0;

            if (this.techs.tackle === 'venom') {
                opp.applyStatus('venom', 10.0);
                damage += 5;
            } else if (this.techs.tackle === 'wither') {
                opp.applyStatus('wither', 10.0, 'EN');
                damage += 5;
            } else if (this.techs.tackle === 'drain') {
                this.stats.HP += 20;
                opp.stats.HP -= 20;
                if (window.flux.gameInstance.floatingText)
                    window.flux.gameInstance.floatingText.spawn("DRAIN", this.mesh.position, "heal");
            }

            if (opp.hasBall) {
                opp.currentEN -= damage;

if (window.flux.gameInstance.floatingText) {
                    // Removed "EN" suffix for cleaner look
                    window.flux.gameInstance.floatingText.spawn(`${Math.floor(damage)}`, opp.mesh.position, "damage");
                    window.flux.gameInstance.floatingText.spawn("BAM!", opp.mesh.position, "comic-impact");
                }

                if (opp.currentEN <= 0) {
                    opp.fumble();
                } else {
                    opp.stunTimer = 0.5;
                    opp.playOneShot('react', 0.1);
}

                if (this.techs.tackle && window.flux.gameInstance.triggerTechEvent) {
                    window.flux.gameInstance.triggerTechEvent(this, this.techs.tackle);
                }

            } else {
                opp.stunTimer = 1.0;
                opp.playOneShot('react', 0.1);
if (window.flux.gameInstance.floatingText) {
                    window.flux.gameInstance.floatingText.spawn("SMACK!", opp.mesh.position, "comic-impact");
                }
            }

            const pushDir = opp.mesh.position.clone().sub(this.mesh.position).normalize();
            pushDir.y = 0.2;
            opp.velocity.add(pushDir.multiplyScalar(12.0));

            if (window.flux.gameInstance.triggerImpact) window.flux.gameInstance.triggerImpact(0.1, 'heavy');
            if (window.flux.gameInstance.cameraManager) window.flux.gameInstance.cameraManager.addShake(0.8);
            if (window.flux.gameInstance.spawnClash) {
const mid = this.mesh.position.clone().add(opp.mesh.position).multiplyScalar(0.5);
                window.flux.gameInstance.spawnClash(mid);
            }
            
// Bubble Burst (Tackle Hit)
// Bubble Burst (Tackle Hit)
            if (window.flux.gameInstance.particleManager) {
                const mid = this.mesh.position.clone().lerp(opp.mesh.position, 0.5);
                mid.y += 1.0;
                for(let i=0; i<30; i++) {
                    const bubblePos = mid.clone().add(new THREE.Vector3((Math.random()-0.5)*1.5, (Math.random()-0.5)*1.5, (Math.random()-0.5)*1.5));
                    window.flux.gameInstance.particleManager.spawn('bubble', bubblePos, { scale: 0.15 + Math.random() * 0.35 });
                }
            }
        }

        _applyGoalCrease(dt) {

const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
            const goals = [
                new THREE.Vector3(0, 0, goalDist),
                new THREE.Vector3(0, 0, -goalDist)
            ];


            const radius = 10.0;

            goals.forEach(goal => {
                const dx = this.mesh.position.x - goal.x;
                const dz = this.mesh.position.z - goal.z;
                const distSq = dx*dx + dz*dz;

                if (distSq < radius * radius) {
                    const dist = Math.sqrt(distSq);
                    const pushX = dist > 0 ? dx / dist : 1;
                    const pushZ = dist > 0 ? dz / dist : 0;

                    const force = 50.0;
                    this.velocity.x += pushX * force * dt;
                    this.velocity.z += pushZ * force * dt;

                    if (dist < radius - 0.5) {
                        const clampRatio = radius / (dist + 0.001);
                        this.mesh.position.x = goal.x + dx * clampRatio;
                        this.mesh.position.z = goal.z + dz * clampRatio;
                    }
                }
            });
        }
    }

    window.flux.Player = Player;
})();
</script>
    <script>(function() {
    window.flux = window.flux || {};

// Formation Definitions (Coordinates for Side 1: Defends +Z, Attacks -Z)
    // X: Left(-)/Right(+), Z: Forward(-)/Back(+)
    const FORMATIONS = {
        'Normal': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 15 }, 'RD': { x: 8, z: 15 },
            'MF': { x: 0, z: 5 },
            'LF': { x: -10, z: -10 }, 'RF': { x: 10, z: -10 }
        },
        'Center Attack': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 15 }, 'RD': { x: 8, z: 15 },
            'MF': { x: 0, z: 0 },
            'LF': { x: -4, z: -15 }, 'RF': { x: 4, z: -15 }
        },
        'Right Side': {
            'GL': { x: 0, z: 25 },
            'LD': { x: 0, z: 15 }, 'RD': { x: 12, z: 15 },
            'MF': { x: 10, z: 5 },
            'LF': { x: 5, z: -10 }, 'RF': { x: 15, z: -10 }
        },
        'Left Side': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -12, z: 15 }, 'RD': { x: 0, z: 15 },
            'MF': { x: -10, z: 5 },
            'LF': { x: -15, z: -10 }, 'RF': { x: -5, z: -10 }
        },
        'All-Out Defense': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -6, z: 20 }, 'RD': { x: 6, z: 20 },
            'MF': { x: 0, z: 10 },
            'LF': { x: -10, z: 5 }, 'RF': { x: 10, z: 5 }
        },
        'Flat Line': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 0 }, 'RD': { x: 8, z: 0 },
            'MF': { x: 0, z: 0 },
            'LF': { x: -15, z: 0 }, 'RF': { x: 15, z: 0 }
        },
        'Counter': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -8, z: 20 }, 'RD': { x: 8, z: 20 },
            'MF': { x: 0, z: 15 },
            'LF': { x: -12, z: -20 }, 'RF': { x: 12, z: -20 }
        },
        'Double Sides': {
            'GL': { x: 0, z: 25 },
            'LD': { x: -18, z: 15 }, 'RD': { x: 18, z: 15 },
            'MF': { x: 0, z: 5 },
            'LF': { x: -18, z: -10 }, 'RF': { x: 18, z: -10 }
        }
    };



    // --- Enemy Indicator (Red Arrow Sprite) ---
    // Shared texture/material so we don't create 6 canvases.
const _enemyArrowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64;
        c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, c.width, c.height);
        
        // Arrow pointing DOWN
        ctx.beginPath();
        ctx.moveTo(6, 12);   
        ctx.lineTo(58, 12);  
        ctx.lineTo(32, 52);  
        ctx.closePath();
        ctx.fillStyle = '#ff0000';
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = 'rgba(255,255,255,0.95)';
        ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

const _playerArrowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, c.width, c.height);
        
        // Arrow pointing DOWN
        ctx.beginPath();
        ctx.moveTo(6, 12);   
        ctx.lineTo(58, 12);  
        ctx.lineTo(32, 52);  
        ctx.closePath();
        ctx.fillStyle = '#00ff00'; // Green
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = 'rgba(255,255,255,0.95)';
        ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

    const _teammateArrowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, c.width, c.height);
        
        // Arrow pointing DOWN
        ctx.beginPath();
        ctx.moveTo(6, 12);   
        ctx.lineTo(58, 12);  
        ctx.lineTo(32, 52);  
        ctx.closePath();
        ctx.fillStyle = '#ffffff'; // White
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = 'rgba(0,0,0,0.5)';
        ctx.stroke();
        return new THREE.CanvasTexture(c);
    })();

    const _enemyArrowMaterial = new THREE.SpriteMaterial({ map: _enemyArrowTexture, transparent: true, depthTest: false, depthWrite: false });
    const _playerArrowMaterial = new THREE.SpriteMaterial({ map: _playerArrowTexture, transparent: true, depthTest: false, depthWrite: false });
    const _teammateArrowMaterial = new THREE.SpriteMaterial({ map: _teammateArrowTexture, transparent: true, depthTest: false, depthWrite: false });
class Team {
        /**
         * Generates and applies stats to a player based on role and level.
         * Centralizes balancing to ensure high-level play feels distinct.
         */
        static generateStats(player, role, level = 1, isHuman = false) {
            // 1. Define Role Baselines (Level 1)
            // Balanced to be weak but functional at Level 1
            const base = {
                HP: 100, SP: 55, EN: 10, AT: 5, PA: 5, BL: 5, SH: 5, CA: 5
            };

            // Role Specializations
            switch(role) {
                case 'LF': case 'RF': // Strikers
                    base.SH += 10; base.SP += 5; base.EN += 5;
                    break;
                case 'MF': // Playmakers
                    base.PA += 10; base.AT += 8; base.EN += 8; base.SP += 2;
                    break;
                case 'LD': case 'RD': // Defenders
                    base.AT += 12; base.BL += 10; base.PA += 5;
                    break;
                case 'GL': // Goalie
                    base.CA += 10; base.SP += 5; base.PA += 15; // Strong arm
                    break;
            }

            // 2. Scaling Factors (Per Level)
            // Designed so Level 50 is "God Tier" and Level 1 is "Rookie"
            const growth = {
                HP: 15,    // +1500 HP at Lvl 99
                SP: 0.5,   // +50 SP at Lvl 99 (Speed demon)
                Primary: 0.8, // +80 Stat at Lvl 99
                Secondary: 0.5 // +50 Stat at Lvl 99
            };

            // Helper to scale
            const scale = (val, rate) => Math.floor(val + ((level - 1) * rate));

            // Apply Scaling
            player.stats.HP = scale(base.HP, growth.HP);
            
            // SP: Cap at 99, but ensure high levels feel FAST
            player.stats.SP = Math.min(99, scale(base.SP, growth.SP));

            // Stat distribution based on role priorities
            if (['LF', 'RF'].includes(role)) {
                player.stats.SH = Math.min(99, scale(base.SH, growth.Primary));
                player.stats.EN = Math.min(99, scale(base.EN, growth.Primary));
                player.stats.AT = Math.min(99, scale(base.AT, growth.Secondary));
                player.stats.PA = Math.min(99, scale(base.PA, growth.Secondary));
                player.stats.BL = Math.min(99, scale(base.BL, growth.Secondary));
            } else if (role === 'MF') {
                player.stats.PA = Math.min(99, scale(base.PA, growth.Primary));
                player.stats.AT = Math.min(99, scale(base.AT, growth.Primary));
                player.stats.EN = Math.min(99, scale(base.EN, growth.Primary));
                player.stats.SH = Math.min(99, scale(base.SH, growth.Secondary));
                player.stats.BL = Math.min(99, scale(base.BL, growth.Secondary));
            } else if (['LD', 'RD'].includes(role)) {
                player.stats.AT = Math.min(99, scale(base.AT, growth.Primary));
                player.stats.BL = Math.min(99, scale(base.BL, growth.Primary));
                player.stats.PA = Math.min(99, scale(base.PA, growth.Secondary));
                player.stats.EN = Math.min(99, scale(base.EN, growth.Secondary));
                player.stats.SH = Math.min(99, scale(base.SH, 0.2)); // Defenders bad at shooting
            } else if (role === 'GL') {
                player.stats.CA = Math.min(99, scale(base.CA, growth.Primary));
                player.stats.PA = Math.min(99, scale(base.PA, growth.Secondary));
                player.stats.SH = Math.min(99, scale(base.SH, 0.3));
            }

            // 3. Human Player Bonus (The "Hero" Feel)
            // Gives the player a slight edge to make gameplay feel punchy
// 3. Human Player Bonus (The "Hero" Feel)
            // Gives the player a slight edge to make gameplay feel punchy
            if (isHuman) {
                player.stats.HP += 300; // Tankier (was 150)
                player.stats.SP += 8;   // Faster (was 5)
                player.stats.EN += 10;   // Harder to tackle (was 5)
                
                // Key Stat Boost
                if (role === 'LF' || role === 'RF') player.stats.SH += 5;
                if (role === 'MF') player.stats.PA += 5;
                if (role === 'LD' || role === 'RD') player.stats.AT += 5;
                if (role === 'GL') player.stats.CA += 5;
            }

            // 4. Finalize
            player.stats.maxHP = player.stats.HP;
            player.level = level;
            player._updateDerivedStats();
        }

constructor(scene, id, side, color, isHuman) {
            this.scene = scene;
            this.id = id; // 'home' or 'away'
            this.side = side; // 1 (Defends +Z) or -1 (Defends -Z)
            this.color = color;
            this.isHuman = isHuman;
            this.aiEnabled = true; // Master switch for AI logic
            
            this.players = [];
            this.activePlayer = null; // The player currently controlled/focused
            
            // Formation Anchors
            this.currentFormation = 'Normal';
            
            // Player Indicator (Green Arrow)
            if (this.isHuman) {
                this.playerArrow = new THREE.Sprite(_playerArrowMaterial);
                this.playerArrow.scale.set(0.8, 0.8, 1.0);
                this.playerArrow.renderOrder = 1000; // On top
            }
        }

        assignMarks(opposingTeam) {
            // Simple auto-assign logic: Mark the player in the "matching" position
            // LF<->RD, RF<->LD, MF<->MF, LD<->RF, RD<->LF, GL<->LF
            this.players.forEach(p => {
                let targetRole = 'MF';
                switch (p.role) {
                    case 'LF': targetRole = 'RD'; break;
                    case 'RF': targetRole = 'LD'; break;
                    case 'MF': targetRole = 'MF'; break;
                    case 'LD': targetRole = 'RF'; break;
                    case 'RD': targetRole = 'LF'; break;
                    case 'GL': targetRole = 'LF'; break;
                }

                const target = opposingTeam.players.find(op => op.role === targetRole);
                if (target) {
                    p.marking = target;
                    // console.log(`${this.id} ${p.role} marked ${target.role}`);
                }
            });
        }

        addPlayer(player) {
            this.players.push(player);
            player.team = this;

            // Calculate Home Position based on Formation
            this._updatePlayerHomePosition(player);

            // Enemy indicator: red arrows over the Away team (so enemies are readable)
// Enemy indicator: red arrows over the Away team
            if (this.id === 'away' && player.mesh) {
                const arrow = new THREE.Sprite(_enemyArrowMaterial);
                arrow.scale.set(0.8, 0.8, 1.0);
                arrow.position.set(0, 3.2, 0); // above head
                arrow.renderOrder = 999;
                player.mesh.add(arrow);
                player.enemyArrow = arrow;
            }

            // Teammate indicator: White arrows for inactive humans
            if (this.isHuman && player.mesh) {
                const arrow = new THREE.Sprite(_teammateArrowMaterial);
                arrow.scale.set(0.6, 0.6, 1.0);
                arrow.position.set(0, 3.2, 0);
                arrow.renderOrder = 999;
                arrow.visible = false; // Hidden by default, managed by setActivePlayer
                player.mesh.add(arrow);
                player.teammateArrow = arrow;
            }
        }

        setFormation(name) {
            if (!FORMATIONS[name]) return;
            this.currentFormation = name;
            // console.log(`Team ${this.id} switched to ${name}`);
            
            this.players.forEach(p => {
                this._updatePlayerHomePosition(p);
            });
        }

_updatePlayerHomePosition(player) {
            const data = FORMATIONS[this.currentFormation];
            if (!data) return;

            const offset = data[player.role];
            if (offset) {
                // X Position:
                // Formations: -X is Left, +X is Right.
                // Home Team (Side 1) faces -Z. Left is -X. Use offset.x as is.
                let xPos = offset.x;
                let zPos = offset.z * this.side;

                player.homePosition.set(xPos, 0, zPos);
                
                // Away Team (Side -1) faces +Z. Left is +X. Flip X.
                if (this.side === -1) {
                    player.homePosition.x *= -1; 
                }
            }
            
            // Set initial position
            if (player.mesh) {
                player.mesh.position.copy(player.homePosition);
                // Face center (0,0,0)
                player.mesh.lookAt(0, 0, 0);
            }
        }

update(dt) {
            this.updatePhysics(dt);
            this.updateVisuals(dt);
        }

        updatePhysics(dt) {
            for (let i = 0; i < this.players.length; i++) {
                if (this.players[i].updatePhysics) {
                    this.players[i].updatePhysics(dt);
                } else {
                    // Fallback if not split yet
                    this.players[i].update(dt);
                }
            }
            if (this.isHuman) {
                this.updateActivePlayerSelection();
            }
        }

        updateVisuals(dt) {
            for (let i = 0; i < this.players.length; i++) {
                if (this.players[i].updateVisuals) {
                    this.players[i].updateVisuals(dt);
                }
            }
        }

        updateActivePlayerSelection() {
            const ball = window.flux.gameInstance.entities.ball;
            if (!ball) return;

            // 1. OFFENSE: If we have the ball, active player is the holder
            if (ball.holder && ball.holder.team === this) {
                if (this.activePlayer !== ball.holder) {
                    this.setActivePlayer(ball.holder);
                }
                return;
            }

            // 2. DEFENSE: Select closest to ball
            // Optimization: Only check every few frames or if distance is significant
            let closest = null;
            let minDst = Infinity;

            for (const p of this.players) {
                if (p.role === 'GL') continue; // Don't auto-switch to goalie usually
                if (!p.mesh) continue;

                const d = p.mesh.position.distanceTo(ball.mesh.position);
                if (d < minDst) {
                    minDst = d;
                    closest = p;
                }
            }

            if (closest && closest !== this.activePlayer) {
                this.setActivePlayer(closest);
            }
        }

setActivePlayer(player) {
            // Reset input on previous
            if (this.activePlayer) {
                this.activePlayer.setInput(0, 0);
            }
            this.activePlayer = player;

            // Visual Indicators
            if (this.isHuman) {
                // 1. Green Arrow for Active
                if (this.playerArrow && player.mesh) {
                    player.mesh.add(this.playerArrow);
                    this.playerArrow.position.set(0, 3.5, 0); // Float above head
                }

                // 2. White Arrows for Others
                this.players.forEach(p => {
                    if (p.teammateArrow) {
                        p.teammateArrow.visible = (p !== player);
                    }
                });
            }
        }

resetPositions() {
            for (const p of this.players) {
                if (p.mesh) {
                    p.mesh.position.copy(p.homePosition);
                    
                    // Reset Physics
                    p.velocity.set(0, 0, 0);
                    p.inputVector.set(0, 0, 0);
                    p.isDashing = false;
                    p.isThrowing = false;
p.loseBall(); // Drop ball if holding
                    p.canCatch = true; // Force reset capability
                    
                    // Reset Stats
                    p.currentEN = p.stats.EN;
                    
// Orientation: Face Center
                    p.mesh.lookAt(0, 0, 0);
                    if (p.syncRotation) p.syncRotation();
                    
                    // Reset Animation
                    p.play('idle', 0.1);
                }
            }
            // Reset active player to MF
            const mf = this.players.find(p => p.role === 'MF');
            if (mf) this.setActivePlayer(mf);
        }
    }

    window.flux.Team = Team;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Reusable vectors
    const _aiVec = new THREE.Vector3();
    const _targetPos = new THREE.Vector3();
    const _scanDir = new THREE.Vector3();
    const _scanToOpp = new THREE.Vector3();
    const _tempVec1 = new THREE.Vector3();
    const _tempVec2 = new THREE.Vector3();

    class AIPlayer extends window.flux.Player {
        constructor(scene, role) {
            super(scene, role);
            this.ballRef = null;
            
            // Stats are managed by Team/Main or default Player values.
            this._updateDerivedStats();

            // State Machine
            this.aiState = 'IDLE';
            this.decisionTimer = 0;
            this.decisionInterval = 0.5; // Slower decisions

            // --- PERCEPTION SYSTEM (Reaction Time) ---
            this.perceivedTargetPos = new THREE.Vector3();
            this.reactionSpeed = 1.5; 
            this.anticipationTime = 0.2; 
            
            // Role Config
            this.isForward = ['LF', 'RF'].includes(role);
            this.isMidfielder = role === 'MF';
            this.isDefender = ['LD', 'RD'].includes(role);

            this.techImmunityTimer = 0;
            this._assignDefaultTechs();
        }

        _assignDefaultTechs() {
            const tackleTechs = ['venom', 'wither', 'drain'];
            const shootTechs = ['venom', 'sphere', 'invisible'];
            const passTechs = ['venom', 'wither', 'nap'];
            const passiveTechs = ['brawler', 'elite_defense'];

            const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
            const chance = (prob) => Math.random() < prob;

            if (this.isDefender) {
                if (chance(0.3)) this.techs.tackle = pick(tackleTechs);
                if (chance(0.1)) this.techs.pass = pick(passTechs);
                if (chance(0.2)) this.techs.passive = pick(passiveTechs);
            } else if (this.isMidfielder) {
                if (chance(0.2)) this.techs.tackle = pick(tackleTechs);
                if (chance(0.2)) this.techs.pass = pick(passTechs);
                if (chance(0.1)) this.techs.shoot = pick(shootTechs);
                if (chance(0.1)) this.techs.passive = pick(passiveTechs);
            } else if (this.isForward) {
                if (chance(0.3)) this.techs.shoot = pick(shootTechs);
                if (chance(0.1)) this.techs.tackle = pick(tackleTechs);
                if (chance(0.1)) this.techs.passive = pick(passiveTechs);
            }
        }

update(dt) {
            this.updatePhysics(dt);
            this.updateVisuals(dt);
        }

        updatePhysics(dt) {
            // Safety: Auto-link ball if missing
            if (!this.ballRef && window.flux.gameInstance && window.flux.gameInstance.entities) {
                this.ballRef = window.flux.gameInstance.entities.ball;
            }

            const game = window.flux.gameInstance;
            const isPractice = game && game.gameMode === 'practice';
            const isActive = game && game.state === 'active';
            
            if (!isActive && !isPractice) {
                this.setInput(0, 0);
                super.updatePhysics(dt);
                return;
            }

            const isDemo = game && game.isDemoMode;
            const isIncapacitated = (this.stunTimer > 0) || (this.status.nap > 0);
            const isHumanTeam = this.team && this.team.isHuman;
            const isActivePlayer = this.team && (this.team.activePlayer === this);
            const shouldRunAI = (!isHumanTeam || isDemo || (isHumanTeam && !isActivePlayer));
            const isTeamAIEnabled = this.team ? this.team.aiEnabled : true;

            if (isIncapacitated) {
                this.setInput(0, 0);
            } else if (shouldRunAI && isTeamAIEnabled) {
                // Perception Update
                if (this.ballRef && this.ballRef.mesh) {
                    let realTarget = this.ballRef.mesh.position.clone();
                    if (this.ballRef.holder && this.ballRef.holder.mesh) {
                        realTarget = this.ballRef.holder.mesh.position.clone();
                        if (this.ballRef.holder.velocity) {
                            realTarget.addScaledVector(this.ballRef.holder.velocity, this.anticipationTime);
                        }
                    } else if (this.ballRef.velocity) {
                        realTarget.addScaledVector(this.ballRef.velocity, this.anticipationTime * 0.5);
                    }
                    const alpha = Math.min(1.0, dt * this.reactionSpeed);
                    this.perceivedTargetPos.lerp(realTarget, alpha);
                }

                // Decision
                this.decisionTimer += dt;
                if (this.decisionTimer > this.decisionInterval) {
                    this.decisionTimer = 0;
                    this._evaluateState();
                }

                // Execution
                this._executeState(dt);
                
                // Interception
                if (this.techImmunityTimer > 0) this.techImmunityTimer -= dt;
                this._applyInterceptionPressure(dt);

            } else {
                // Human controlled or disabled
                const isDrivenByHuman = isHumanTeam && isActivePlayer && !isDemo;
                if (!isDrivenByHuman) {
                    this.setInput(0, 0);
                }
                this._applyInterceptionPressure(dt);
            }

            super.updatePhysics(dt);
        }

        updateVisuals(dt) {
            super.updateVisuals(dt);
        }

        _evaluateState() {
            if (!this.ballRef) return;
            const ball = this.ballRef;

            if (this.hasBall) {
                this.aiState = 'ATTACK_CARRY';
                return;
            }

            if (!ball.holder) {
                this.aiState = 'RETURN_HOME';
                const bias = (this.aiState === 'CHASE') ? 0.8 : 1.0;
                const myDist = this.mesh.position.distanceTo(ball.mesh.position) * bias;
                
                let isClosest = true;
                if (this.team && this.team.players) {
                    for (const p of this.team.players) {
                        if (p === this) continue;
                        if (!p.mesh) continue;
                        if (p.role === 'GL') continue;
                        if (p.status && p.status.nap > 0) continue;

                        const pDist = p.mesh.position.distanceTo(ball.mesh.position);
                        if (pDist < myDist) {
                            isClosest = false;
                            break;
                        }
                    }
                }

                if (isClosest) {
                    this.aiState = 'CHASE';
                }
                return;
            }

            if (ball.holder.team === this.team) {
                this.aiState = 'SUPPORT';
                return;
            }

            if (ball.holder.team !== this.team) {
                this.aiState = 'DEFEND';
                return;
            }
        }

        _executeState(dt) {
            if (!this.ballRef) {
                this.setInput(0, 0);
                return;
            }

            switch (this.aiState) {
                case 'ATTACK_CARRY': this._stateAttackCarry(dt); break;
                case 'SUPPORT': this._stateSupport(dt); break;
                case 'DEFEND': this._stateDefend(dt); break;
                case 'CHASE': this._stateChase(dt); break;
                case 'RETURN_HOME': 
                default: this._stateReturnHome(dt); break;
            }
        }

        _stateAttackCarry(dt) {
            const attackDir = (this.team.side === 1) ? -1 : 1;
const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
            const goalZ = goalDist * attackDir;
            
            _targetPos.set(0, 0, goalZ);
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);

            const distToGoal = Math.abs(this.mesh.position.z - goalZ);
            
            if (distToGoal < 20.0 && !this.isThrowing) {
                this._smartThrow(this.ballRef, 'SH'); 
                return;
            }
            
            const isSurrounded = this._isSurrounded();
            const lowEN = this.currentEN < 10;
            const isPlaymaker = this.isMidfielder;
            
            if ((isSurrounded || lowEN || isPlaymaker) && !this.isThrowing) {
                const bestMate = this._findBestPassTarget();
                if (bestMate) {
                    let shouldPass = false;
                    if (isSurrounded || lowEN) {
                        shouldPass = true;
                    } else if (isPlaymaker) {
                        const myDist = Math.abs(this.mesh.position.z - goalZ);
                        const mateDist = Math.abs(bestMate.mesh.position.z - goalZ);
                        if (mateDist < myDist - 5.0) shouldPass = true;
                    }
                    
                    if (shouldPass) {
                        this.mesh.lookAt(bestMate.mesh.position);
                        this._smartThrow(this.ballRef, 'PA');
                        return;
                    }
                }
            }
            
            if (isSurrounded && !this.isThrowing) {
                this._smartThrow(this.ballRef, 'SH');
            }
        }

        _isSurrounded() {
            let count = 0;
            const game = window.flux.gameInstance;
            if (!game) return false;
            const oppTeam = (this.team.id === 'home') ? game.teams.away : game.teams.home;
            
            for(let p of oppTeam.players) {
                if (p.mesh && p.mesh.position.distanceTo(this.mesh.position) < 4.0) {
                    count++;
                }
            }
            return count >= 2;
        }

        _smartThrow(ball, forcedType = null) {
            let type = forcedType;
            if (!type) {
                _tempVec1.set(0, 0, 1).applyQuaternion(this.mesh.quaternion);
                const attackDir = (this.team && this.team.side === 1) ? -1 : 1;
                const isAimingGoal = (_tempVec1.z * attackDir > 0.5);
                type = isAimingGoal ? 'SH' : 'PA';
            }

            const techName = (type === 'SH') ? this.techs.shoot : this.techs.pass;
            let baseCost = (type === 'SH') ? 20 : 10;
            let techCost = 0;
            
            if (techName) {
                if (techName.includes('nap')) techCost = 30;
                else if (techName.includes('sphere') || techName.includes('invisible')) techCost = 25;
                else techCost = 20;
            }

            const totalCost = baseCost + techCost;
            let tempTech = null;
            if (techName && this.stats.HP < totalCost && this.stats.HP >= baseCost) {
                if (type === 'SH') {
                    tempTech = this.techs.shoot;
                    this.techs.shoot = null;
                } else {
                    tempTech = this.techs.pass;
                    this.techs.pass = null;
                }
            }

            this.throwBall(ball, type);

            if (tempTech) {
                if (type === 'SH') this.techs.shoot = tempTech;
                else this.techs.pass = tempTech;
            }
        }

        _stateChase(dt) {
            _targetPos.copy(this.perceivedTargetPos);
            const ball = this.ballRef;
            if (ball.velocity.lengthSq() > 1.0) {
                _targetPos.addScaledVector(ball.velocity, 0.3);
            }
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);
        }

        _stateReturnHome(dt) {
            _targetPos.copy(this.homePosition);
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);
        }

        _stateSupport(dt) {
            const ball = this.ballRef;
            const carrier = ball.holder;
            
            if (!carrier || !carrier.mesh) {
                this._stateReturnHome(dt);
                return;
            }

            const ballPos = carrier.mesh.position;
            const attackDir = (this.team.side === 1) ? -1 : 1;
const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
            const goalZ = (this.team.side === 1) ? -goalDist : goalDist;

            const pressure = this._calculatePressureOnPlayer(carrier);

            _targetPos.copy(this.homePosition);
            _targetPos.z += ballPos.z * 0.6;

            if (this.isForward) {
                let targetZ = ballPos.z + (attackDir * 15.0); 
                if (pressure > 0.8) {
                    targetZ = ballPos.z + (attackDir * 8.0);
                }
                const time = Date.now() * 0.001;
                const weave = Math.sin(time + this.mesh.id) * 6.0;
                _targetPos.x = this.homePosition.x + weave;
                _targetPos.z = targetZ;

            } else if (this.isMidfielder) {
                if (pressure > 0.8) {
                    const side = (this.mesh.position.x > ballPos.x) ? 1 : -1;
                    _targetPos.x = ballPos.x + (side * 10.0);
                    _targetPos.z = ballPos.z - (attackDir * 2.0);
                } else {
                    const midZ = (ballPos.z + goalZ) * 0.45;
                    _targetPos.z = midZ;
                    if (ballPos.x < -5) _targetPos.x = 5;
                    else if (ballPos.x > 5) _targetPos.x = -5;
                    else _targetPos.x = (this.homePosition.x > 0 ? 8 : -8);
                }

            } else {
                const safetyDist = 12.0;
                _targetPos.z = ballPos.z - (attackDir * safetyDist);
                if (this.team.side === 1) _targetPos.z = Math.min(38, _targetPos.z);
                else _targetPos.z = Math.max(-38, _targetPos.z);
                _targetPos.x = ballPos.x * 0.6 + this.homePosition.x * 0.4;
            }

            if (this._isPathBlocked(_targetPos, ballPos)) {
                _tempVec1.copy(_targetPos); _tempVec1.x -= 8.0;
                _tempVec2.copy(_targetPos); _tempVec2.x += 8.0;
                
                const blockedL = this._isPathBlocked(_tempVec1, ballPos);
                const blockedR = this._isPathBlocked(_tempVec2, ballPos);
                
                if (!blockedL && !blockedR) {
                    if (Math.abs(_targetPos.x - _tempVec1.x) < Math.abs(_targetPos.x - _tempVec2.x)) {
                        _targetPos.copy(_tempVec1);
                    } else {
                        _targetPos.copy(_tempVec2);
                    }
                } else if (!blockedL) {
                    _targetPos.copy(_tempVec1);
                } else if (!blockedR) {
                    _targetPos.copy(_tempVec2);
                } else {
                    _targetPos.lerp(ballPos, 0.4);
                }
            }

            this._avoidTeammates(_targetPos);
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);
        }

        _stateDefend(dt) {
            const targetPos = this.perceivedTargetPos;
            const distToBall = this.mesh.position.distanceTo(targetPos);
            
            let pressRange = this.isDefender ? 12.0 : 8.0;
            if (this.techs.tackle && this.stats.HP > 20) {
                pressRange += 5.0; 
            }

            let amIClosest = true;
            const myDistSq = distToBall * distToBall;
            
            if (this.team && this.team.players) {
                for(const mate of this.team.players) {
                    if (mate === this || !mate.mesh) continue;
                    if (mate.role === 'GL' || mate.status.nap > 0 || mate.stunTimer > 0) continue;
                    
                    const dSq = mate.mesh.position.distanceToSquared(targetPos);
                    if (dSq < myDistSq) {
                        amIClosest = false;
                        break;
                    }
                }
            }

if (amIClosest) {
                pressRange = 100.0;
            } else {
                const distToMyGoal = Math.abs(targetPos.z - (this.team.side === 1 ? 44.5 : -44.5));
                if (distToMyGoal < 20.0) {
                    pressRange = 15.0;
                } else {
                    pressRange = 8.0;
                }
            }
            
            if (distToBall < pressRange) {
                if (distToBall < 3.0 && !this.isDashing && this.currentEN > 5 && Math.random() < 0.02) {
                    const dir = _tempVec1.subVectors(targetPos, this.mesh.position).normalize();
                    if (this.ballRef && this.ballRef.velocity) {
                        dir.addScaledVector(this.ballRef.velocity, 0.1).normalize();
                    }
                    this.dash(dir.x, dir.z);
                    return;
                }

                _targetPos.copy(targetPos);
                this._avoidGoalCrease(_targetPos);
                this._moveTo(_targetPos);
                return;
            }

            if (this.marking && this.marking.mesh) {
                const markPos = this.marking.mesh.position;
                const myGoalZ = (this.team.side === 1) ? 46 : -46;
                _tempVec1.set(0, 0, myGoalZ - markPos.z);
                _tempVec1.normalize();
                _targetPos.copy(markPos).addScaledVector(_tempVec1, 3.5);
                this._avoidGoalCrease(_targetPos);
                this._moveTo(_targetPos);
                return;
            }

            _targetPos.copy(this.homePosition);
            _targetPos.z += this.ballRef.mesh.position.z * 0.6;
            
            if (this.isDefender) {
const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
            const myGoalZ = (this.team.side === 1) ? goalDist : -goalDist;
                const midpoint = (this.ballRef.mesh.position.z + myGoalZ) * 0.5;
                _targetPos.z = (_targetPos.z + midpoint) * 0.5;
            }

const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
            const limitZ = goalDist - 2.5;
            _targetPos.z = Math.max(-limitZ, Math.min(limitZ, _targetPos.z));
            this._avoidGoalCrease(_targetPos);
            this._moveTo(_targetPos);
        }

        _avoidGoalCrease(targetPos) {
            const creaseRadius = 10.0;
const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
            const goals = [{ x: 0, z: -goalDist }, { x: 0, z: goalDist }];

            goals.forEach(goal => {
                const dx = targetPos.x - goal.x;
                const dz = targetPos.z - goal.z;
                const distSq = dx*dx + dz*dz;

                if (distSq < creaseRadius * creaseRadius) {
                    const dist = Math.sqrt(distSq);
                    if (dist > 0.001) {
                        const ratio = creaseRadius / dist;
                        targetPos.x = goal.x + dx * ratio;
                        targetPos.z = goal.z + dz * ratio;
                    } else {
                        targetPos.z = goal.z + (goal.z > 0 ? -creaseRadius : creaseRadius);
                    }
                }
            });

            const arenaRadius = 45.0;
            const dSq = targetPos.x * targetPos.x + targetPos.z * targetPos.z;
            if (dSq > arenaRadius*arenaRadius) {
                const d = Math.sqrt(dSq);
                const r = arenaRadius / d;
                targetPos.x *= r;
                targetPos.z *= r;
            }
        }

        _findBestPassTarget() {
            let bestTarget = null;
            let maxScore = -Infinity;
const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
            const goalZ = (this.team.side === 1) ? -goalDist : goalDist;

            for (const mate of this.team.players) {
                if (mate === this) continue;
                if (!mate.mesh) continue;
                if (mate.status.nap > 0) continue;
                if (mate.stunTimer > 0) continue;
                
                const dist = this.mesh.position.distanceTo(mate.mesh.position);
                if (dist < 4.0) continue;
                if (dist > 30.0) continue;
                
                if (this._isPathBlocked(mate.mesh.position)) continue; 
                
                let score = 0;
                const myDistToGoal = Math.abs(this.mesh.position.z - goalZ);
                const mateDistToGoal = Math.abs(mate.mesh.position.z - goalZ);
                const progress = myDistToGoal - mateDistToGoal;
                
                score += progress * 1.5; 
                if (mateDistToGoal < 15.0) score += 10.0;
                if (mateDistToGoal < 8.0) score += 15.0;

                const openness = this._calculateOpenness(mate);
                score += openness * 3.0;

                if (mate.isForward) score += 5.0;
                score -= dist * 0.5;

                if (score > maxScore) {
                    maxScore = score;
                    bestTarget = mate;
                }
            }
            return bestTarget;
        }

        _calculateOpenness(player) {
            let minDefDist = 999;
            const game = window.flux.gameInstance;
            if (!game) return 0;
            const oppTeam = (this.team.id === 'home') ? game.teams.away : game.teams.home;

            for (const opp of oppTeam.players) {
                if (!opp.mesh || opp.status.nap > 0 || opp.stunTimer > 0) continue;
                const d = player.mesh.position.distanceTo(opp.mesh.position);
                if (d < minDefDist) minDefDist = d;
            }
            return Math.min(minDefDist, 8.0);
        }

        _isPathBlocked(targetPos, startPos = null) {
            const start = startPos || this.mesh.position;
            const end = targetPos;
            const dist = start.distanceTo(end);
            
            _scanDir.subVectors(end, start).normalize();
            
            const game = window.flux.gameInstance;
            if (!game) return false;
            const oppTeam = (this.team.id === 'home') ? game.teams.away : game.teams.home;
            const safetyRadius = 2.5; 

            for (const opp of oppTeam.players) {
                if (!opp.mesh || opp.status.nap > 0 || opp.stunTimer > 0) continue;
                
                _scanToOpp.subVectors(opp.mesh.position, start);
                const projection = _scanToOpp.dot(_scanDir);
                
                if (projection > 0 && projection < dist) {
                    const perpDistSq = _scanToOpp.lengthSq() - (projection * projection);
                    if (perpDistSq < (safetyRadius * safetyRadius)) {
                        return true;
                    }
                }
            }
            return false;
        }

        _moveTo(target) {
            _aiVec.subVectors(target, this.mesh.position);
            _aiVec.y = 0;
            
            const distSq = _aiVec.lengthSq();
            if (distSq > 1.0) {
                _aiVec.normalize();
                this.setInput(_aiVec.x, _aiVec.z);
            } else {
                this.setInput(0, 0);
                this.velocity.multiplyScalar(0.8);
            }
        }

        _applyInterceptionPressure(dt) {
            const ball = this.ballRef;
            if (!ball || !ball.mesh) return;

            if (ball.state !== 'free' || ball.velocity.lengthSq() < 1.0) return;
            if (ball.isInvisible) return;
            if (this.status.nap > 0 || this.stunTimer > 0) return;

            let range = 2.0;
            if (this.techs.passive === 'brawler' || this.techs.passive === 'elite_defense') {
                range += 1.5;
            }

            const dist = this.mesh.position.distanceTo(ball.mesh.position);
            if (dist > range) return;

            _scanToOpp.subVectors(this.mesh.position, ball.mesh.position).normalize();
            _tempVec1.copy(ball.velocity).normalize();
            
            const headingDot = _tempVec1.dot(_scanToOpp);
            if (headingDot < 0.7) return;

            const distFactor = Math.max(0, 1.0 - (dist / range));
            const pressure = 1.5;

            if (ball.power > 0) {
                ball.power -= pressure;
                this._accumulatedBlock = (this._accumulatedBlock || 0) + pressure;
                if (this._accumulatedBlock >= 5.0) { 
                    const val = Math.floor(this._accumulatedBlock);
                    this._accumulatedBlock -= val;
                    if (window.flux.gameInstance.floatingText) { 
                         window.flux.gameInstance.floatingText.spawn(`-${val}`, ball.mesh.position, "block", ball.mesh);
                    }
                }
            }

            if (Math.random() < (distFactor * 0.8)) { 
                _tempVec2.copy(this.mesh.position).lerp(ball.mesh.position, 0.5 + (Math.random()-0.5)*0.2);
                _tempVec2.x += (Math.random()-0.5) * 0.5;
                _tempVec2.y += (Math.random()-0.5) * 0.5;
                _tempVec2.z += (Math.random()-0.5) * 0.5;
                
                if (window.flux.gameInstance.spawnClash) {
                    window.flux.gameInstance.spawnClash(_tempVec2, 0.6);
                }
            }

            if (ball.power <= 0 && ball.powerType === 'SH') {
                ball.powerType = 'none';
                if (window.flux.gameInstance.floatingText) { 
                    window.flux.gameInstance.floatingText.spawn("BLOCKED", this.mesh.position, "comic-impact");
                }
            }

            if (ball.technique && this.techImmunityTimer <= 0) {
                this.techImmunityTimer = 2.0;
                const tech = ball.technique;
                if (tech.type === 'venom') this.applyStatus('venom', 15.0);
                else if (tech.type === 'nap') this.applyStatus('nap', 8.0);
                else if (tech.type === 'wither') this.applyStatus('wither', 15.0, 'BL');
            }
        }

        _calculatePressureOnPlayer(player) {
            if (!player || !player.mesh) return 0;
            const game = window.flux.gameInstance;
            if (!game) return 0;
            
            const oppTeam = (player.team.id === 'home') ? game.teams.away : game.teams.home;
            let pressure = 0;
            
            for (const opp of oppTeam.players) {
                if (!opp.mesh || opp.status.nap > 0 || opp.stunTimer > 0) continue;
                const dist = player.mesh.position.distanceTo(opp.mesh.position);
                if (dist < 10.0) {
                    pressure += (10.0 - dist) / 10.0;
                }
            }
            return pressure;
        }

        _avoidTeammates(targetPos) {
            if (!this.team) return;
            for (const mate of this.team.players) {
                if (mate === this || !mate.mesh) continue;
                if (mate.hasBall) continue;
                
                const dist = targetPos.distanceTo(mate.mesh.position);
                if (dist < 5.0) {
                    _tempVec1.subVectors(targetPos, mate.mesh.position).normalize();
                    targetPos.addScaledVector(_tempVec1, 5.0 - dist);
                }
            }
        }
    }

    window.flux.AIPlayer = AIPlayer;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};
    
    // Reusable vectors to avoid GC
const _gVec = new THREE.Vector3();
    const _gPos = new THREE.Vector3();
    const _ballPos = new THREE.Vector3();
    const _faceVec = new THREE.Vector3();
    const _goalCenter = new THREE.Vector3();
    const _tempVecG = new THREE.Vector3();

    class Goalie extends window.flux.Player {
constructor(scene, role) {
            super(scene, role);
            
            // Goalie Specific Stats (Buffed for Playability)
            this.stats.CA = 30; // Catch
            this.stats.SP = 40; // Speed
            this.stats.EN = 50;
            
            // BUFFED: Strong arm for clearing the zone
            this.stats.PA = 45; // Was 20 - Now strong enough to reach midfield
            this.stats.SH = 35; // Was 10 - Decent clearance kick
            
            this._updateDerivedStats();

            // Goal Dimensions (Save Box) - Matches GameManager detection
            this.goalWidth = 22.0; 
            this.goalHeight = 18.0; 
            
            // Save Mechanics
            this.saveRadius = 6.0; 
            this.pressureMultiplier = 5.0; 
            
            // Techs
            this.techs = {
                active: null, 
                passive: null 
            };
            
            // AI State
            this.throwTimer = 0;
            this._accumulatedSave = 0;
            
            // Super Goalie State
            this.isSuperGoalie = false;
            this.superGoalieTimer = 0;

// Perception Smoothing (Reaction Delay)
            this.perceivedBallPos = new THREE.Vector3();
            this.reactionSpeed = 4.0; // Lower = more delay/smoothing
            this.techImmunityTimer = 0;
        }

update(dt) {
            this.updatePhysics(dt);
            this.updateVisuals(dt);
        }

        updatePhysics(dt) {
            // 1. Super Goalie Timer
            if (this.isSuperGoalie) {
                this.superGoalieTimer -= dt;
                if (this.superGoalieTimer <= 0) {
                    this.isSuperGoalie = false;
                }
            }
            
            // 2. Possession Logic (Ball Held)
            if (this.hasBall) {
                this._checkTacklePressure(dt);
                
                const game = window.flux.gameInstance;
                const isHumanControlled = this.team && this.team.isHuman && this.team.activePlayer === this && !game.isDemoMode;
                
                if (isHumanControlled) {
                    super.updatePhysics(dt);
                } else {
                    if (!this.isThrowing) {
                        this._aiPossessionLogic(dt);
                    }
                    this.setInput(0, 0);
                    super.updatePhysics(dt);
                }
                this._constrainBounds();
                return; 
            }

            // 3. Defense / Save Logic (No Ball)
            if (this.dashCooldown > 0) this.dashCooldown -= dt;
            if (this.clashCooldown > 0) this.clashCooldown -= dt;
            if (this.stunTimer > 0) this.stunTimer -= dt;
            if (this.immunityTimer > 0) this.immunityTimer -= dt;
            
            this._updateStatusLogic(dt);

            if (this.stunTimer > 0 || this.status.nap > 0) {
                this._constrainBounds();
                return;
            }

            this._defenseLogic(dt);
            this._constrainBounds();
        }

        updateVisuals(dt) {
            if (this.hasBall) {
                super.updateVisuals(dt);
                return;
            }

            this._updateStatusVisuals(dt);

            if (this.stunTimer > 0 || this.status.nap > 0) {
                if (this.mixer) this.mixer.update(dt);
                this._updateHPBar();
                return;
            }

            if (this.mixer) this.mixer.update(dt);
            this._updateHPBar();
        }

_constrainBounds() {
            if (!this.mesh) return;
            const pos = this.mesh.position;

            const side = this.team ? this.team.side : 1;
            const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
            
            // X Bounds (Width of penalty area +/- 10m) -> Increased for massive goal
const xLimit = 20.0; // Reduced width of goalie movement
            if (pos.x > xLimit) { pos.x = xLimit; this.velocity.x = 0; }
            if (pos.x < -xLimit) { pos.x = -xLimit; this.velocity.x = 0; }
            
            // Y Bounds
            const yLimit = 12.0; // Reduced height ceiling
            if (pos.y > yLimit) { pos.y = yLimit; this.velocity.y = 0; }
            if (pos.y < -yLimit) { pos.y = -yLimit; this.velocity.y = 0; }
            
            // Z Bounds (Depth)
// Z Bounds (Depth)
// CLAMP Z: Prevent Goalie from going into the net or behind goal
// CLAMP Z: Prevent Goalie from going into the net or behind goal
            if (side === 1) {
                if (pos.z > goalDist - 0.5) { pos.z = goalDist - 0.5; this.velocity.z = 0; }
                if (pos.z < 20.0) { pos.z = 20.0; this.velocity.z = 0; }
            } else {
                if (pos.z < -goalDist + 0.5) { pos.z = -goalDist + 0.5; this.velocity.z = 0; }
                if (pos.z > -20.0) { pos.z = -20.0; this.velocity.z = 0; }
            }
        }

// Override throwBall to fix "weak throw" issue
// Override throwBall to fix "weak throw" issue and reduce loft
        throwBall(ball, forcedType = null, powerMultiplier = 1.0) {
            if (!this.hasBall || this.isThrowing) return;
            
            this.isThrowing = true;
            const type = forcedType || 'PA';
            const boost = 1.2;
            const finalPower = powerMultiplier * boost;

            // Animation
            const throwKey = (type === 'SH' && this.actions['throw_shot']) ? 'throw_shot' : 'throw_pass';
            this.playOneShot(throwKey, 0.1, { timeScale: 1.2 });

            if (window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("CLEAR!", this.mesh.position, "comic-action");
            }

            setTimeout(() => {
                if (this.hasBall || (ball && ball.holder === this)) {
                    // Calculate Direction
                    const finalDir = new THREE.Vector3(0, 0, 1).applyQuaternion(this.mesh.quaternion).normalize();
                    
                    // REDUCED LOFT: Goalie throws flatter (0.25 instead of 0.8)
                    finalDir.y += 0.25; 
                    finalDir.normalize();

                    // Calculate Stats
                    let statVal = this.getStat(type);
                    statVal *= finalPower;

                    ball.shoot(finalDir, statVal, type);
                    
                    // Extra grace period for Goalie
                    ball.catchGracePeriod = 0.6;

                    this.loseBall();
                    this.catchCooldown = 1.0;
                }
            }, 300); // Windup time

            setTimeout(() => {
                this.isThrowing = false;
                this._updateLocomotionAnim(0.2);
            }, 800);
        }

_defenseLogic(dt) {
            // 0. Game State Check
            if (window.flux.gameInstance.state !== 'active') return;

            const ball = window.flux.gameInstance.entities.ball;
            if (!ball || !ball.mesh) return;

            // --- PERCEPTION UPDATE ---
            // Smoothly interpolate perceived position towards real ball position
            // This creates a natural reaction delay and prevents jittery mirroring
            this.perceivedBallPos.lerp(ball.mesh.position, dt * this.reactionSpeed);

            // Determine Threat Source
            let threatPos = _ballPos;
            let isThreat = false;
const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
            const myGoalZ = (this.team.side === 1) ? goalDist : -goalDist;

            // Case A: Ball is Held (Pre-throw)
            if (ball.state === 'held' && ball.holder && ball.holder.team !== this.team) {
                // Track holder, but use perceived position if we wanted to simulate reading the player
                // For now, tracking the ball (which is on the player) via perceivedPos is sufficient
                threatPos = this.perceivedBallPos;
                
                // Check if holder is in attacking half or near enough
                const distToGoal = Math.abs(threatPos.z - myGoalZ);
                if (distToGoal < 40.0) { // If they are within 40m, track them
                    isThreat = true;
                }
            } 
            // Case B: Ball is Free (Shot/Pass)
            else if (ball.state === 'free') {
                threatPos = this.perceivedBallPos;
                
                // Direction Check
                const movingTowards = (this.team.side === 1 && ball.velocity.z > 0) || 
                                      (this.team.side === -1 && ball.velocity.z < 0);
                
                // Position Check
                const inFrontOfGoal = (this.team.side === 1 && threatPos.z < 45.0) || 
                                      (this.team.side === -1 && threatPos.z > -45.0);

                isThreat = movingTowards && inFrontOfGoal;
            }
            if (isThreat) {
                // --- POSITIONING: ANGLE CUTTING ---
                _ballPos.copy(threatPos); // Update reference for lookAt
                
                // 1. Calculate Goal Center
// 1. Calculate Goal Center (Adjusted for Y offset)
_goalCenter.set(0, -6.0, myGoalZ);
                
                // 2. Vector from Goal to Ball
                _tempVecG.subVectors(_ballPos, _goalCenter);
                const distToBall = _tempVecG.length();
                _tempVecG.normalize(); // Now holds direction
                
                // 3. Determine Extension (How far out to step)
                // Base: 1.5m off line.
                // Max: 6.0m off line (Cutting angle).
                // Scale based on ball proximity: Closer ball = More extension (to a point)
let extension = 1.5;
                if (distToBall < 30.0) {
                    const ratio = 1.0 - (Math.max(0, distToBall - 5.0) / 25.0); 
                    extension = 1.5 + (4.5 * ratio); 
                }
                
// Safety: Don't go past the ball (keep 1m buffer)
                extension = Math.min(extension, distToBall - 1.0);
                
                // 4. Calculate Target Position (Base Interception)
                _gPos.copy(_goalCenter).add(_tempVecG.multiplyScalar(extension));
                
                // 5. Vertical Override (Jump to meet ball)
                // Explicitly set Y to match ball height if it's high
                if (_ballPos.y > 0.5) {
                    _gPos.y = _ballPos.y;
                } else {
                    _gPos.y = 0.5; // Default stance
                }

                // 6. Clamp to Goal Box Dimensions (Lateral/Vertical Limits)
                // Goal Width 22 (+/- 11), Height 18 (+/- 9).
                // Allow slightly outside posts to cover angles.
                const clampX = this.goalWidth * 0.6; // +/- 13.2
const clampY = 12.0; // Reduced max jump height
                
                _gPos.x = Math.max(-clampX, Math.min(clampX, _gPos.x));
                _gPos.y = Math.max(-clampY, Math.min(clampY, _gPos.y));
                
                // 6. Lead the ball slightly if it has lateral velocity (Anticipation)
if (ball.velocity.lengthSq() > 1.0) {
                    const anticipation = ball.velocity.clone().multiplyScalar(0.25); // 0.25s lead
                    anticipation.z = 0; // Only lateral lead
                    _gPos.add(anticipation);
                }

                // CLAMP Z: Prevent Goalie from going into the net or behind goal
// CLAMP Z: Prevent Goalie from going into the net or behind goal
// CLAMP Z: Prevent Goalie from going into the net or behind goal
// CLAMP Z: Prevent Goalie from going into the net or behind goal
            if (this.team.side === 1) {
                _gPos.z = Math.min(goalDist - 0.5, _gPos.z);
            } else {
                _gPos.z = Math.max(-goalDist + 0.5, _gPos.z);
            }

                // Move towards target
                const moveDir = _gVec.subVectors(_gPos, this.mesh.position);
                const distToTarget = moveDir.length();
                
                if (distToTarget > 0.1) {
                    moveDir.normalize();
                    // Burst speed for saves if ball is close
                    const urgency = (distToBall < 10.0) ? 1.5 : 1.0;
                    const speed = this.maxSpeed * urgency;
                    
                    this.mesh.position.add(moveDir.multiplyScalar(speed * dt));
                    
                    // Face ball
                    this.mesh.lookAt(_ballPos);
                    
                    if (this.state !== 'swim') this.play('swim', 0.2);
                } else {
                    if (this.state !== 'idle') this.play('idle', 0.2);
                    this.mesh.lookAt(_ballPos);
                }

                // --- SAVE MECHANIC ---
                // If ball is within range, apply CA pressure
                const dist = this.mesh.position.distanceTo(ball.mesh.position);
                if (dist < this.saveRadius) { 
                    this._applySavePressure(ball, dt);
                }
            } else {
                // --- IDLE / RETURN TO POST ---
                // Return to home position (usually center of goal)
                _gPos.copy(this.homePosition);
                const moveDir = _gVec.subVectors(_gPos, this.mesh.position);
                
                if (moveDir.length() > 0.5) {
                    moveDir.normalize();
                    this.mesh.position.add(moveDir.multiplyScalar(this.maxSpeed * 0.6 * dt));
                    if (this.state !== 'swim') this.play('swim', 0.2);
                } else {
                    if (this.state !== 'idle') this.play('idle', 0.2);
                }
                
                // Face center field
                this.mesh.lookAt(0, 0, 0);
            }
        }

        _applySavePressure(ball, dt) {
            // If Goalie is Asleep, they cannot save.
            if (this.status.nap > 0) return;

            // --- SUPER GOALIE TRIGGER ---
            // Trigger if: Tech equipped, Not active, Ball has power, Ball is close
            if (this.techs.active === 'super_goalie' && !this.isSuperGoalie && ball.power > 5.0) {
                // Chance to trigger (High chance for AI, or check HP)
                // Cost: 10 HP
                if (this.stats.HP >= 10) {
                    this.stats.HP -= 10;
                    this.isSuperGoalie = true;
                    this.superGoalieTimer = 1.5; // Lasts 1.5s
                    
                    console.log(`${this.role} used SUPER GOALIE!`);
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("SUPER GOALIE!", this.mesh.position, "save");
                    }
                    
                    // Trigger Techcopy Event
                    if (window.flux.gameInstance && window.flux.gameInstance.triggerTechEvent) {
                        window.flux.gameInstance.triggerTechEvent(this, 'super_goalie');
                    }
                }
            }

            // Calculate Effective CA
            let ca = this.getStat('CA');
            
            // Apply Super Goalie Bonus (e.g. +50% + Flat 10)
            if (this.isSuperGoalie) {
                ca = (ca * 1.5) + 10;
            }
            
            // Apply Grip Gloves (Passive)
            if (this.techs.passive === 'grip_gloves') {
                ca += 5;
            }

            // Calculate Pressure
            // Pressure = CA * dt * Multiplier
            const pressure = ca * dt * this.pressureMultiplier;
            
            if (ball.power > 0) {
                ball.power -= pressure;
                
                // Visual Feedback
                this._accumulatedSave += pressure;
                // THROTTLE: Increased threshold to 12.0
                if (this._accumulatedSave >= 12.0) { 
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("BLOCK!", this.mesh.position, "comic-impact");
                    }
                    this._accumulatedSave = 0;
                }
            }

            // Apply Ball Technique to Goalie (Risk of catching special shots)
// Apply Ball Technique to Goalie (Risk of catching special shots)
            if (ball.technique && this.techImmunityTimer <= 0) {
                this.techImmunityTimer = 2.0;
                const tech = ball.technique;
                
                if (tech.type === 'venom') {
                    this.applyStatus('venom', 15.0);
                } else if (tech.type === 'nap') {
                    this.applyStatus('nap', 8.0);
                } else if (tech.type === 'wither') {
                    this.applyStatus('wither', 15.0, 'CA');
                }
            }

            // Check Result
            if (ball.power <= 0 && this.status.nap <= 0) {
                // CATCH
                this.catchBall(ball);
            }
        }

        catchBall(ball) {
            ball.grab(this);
            this.play('catch', 0.1);
            console.log("SAVED by " + this.role);
            
            // EXP REWARD: Save
            this.gainExp(5);

            if (window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("SAVED!", this.mesh.position, "comic-impact");
            }
            if (window.flux.gameInstance.triggerImpact) window.flux.gameInstance.triggerImpact(0.15, 'heavy');
            
            // Reset throw timer
            this.throwTimer = 0;
        }

_aiPossessionLogic(dt) {
            this.throwTimer += dt;
            
            // Hold for a moment (1.5s) then throw
            if (this.throwTimer > 1.5) {
                // Find best target: Prefer MF or Defenders, but must be somewhat distant to avoid "handoff" look
                // Filter for teammates > 8 units away if possible
                const validMates = this.team.players.filter(p => 
                    p !== this && 
                    p.mesh && 
                    p.mesh.position.distanceTo(this.mesh.position) > 8.0
                );

                let target = null;

                // Priority 1: Midfielder (Playmaker)
                target = validMates.find(p => p.role === 'MF');
                
                // Priority 2: Defenders
                if (!target) target = validMates.find(p => p.role === 'LD' || p.role === 'RD');
                
                // Priority 3: Anyone open (fallback to close range if no one is far)
                if (!target) target = this.team.players.find(p => p !== this && p.role !== 'GL');

                if (target && target.mesh) {
                    // AIMING LOGIC: Loft the pass
                    // Look at target, but aim slightly up to create an arc
                    const targetPos = target.mesh.position.clone();
                    
                    // Calculate distance
                    const dist = this.mesh.position.distanceTo(targetPos);
                    
                    // Loft factor: The further away, the higher we aim
                    // 20 units away -> Aim 5 units above head
                    const loft = Math.max(1.0, dist * 0.25);
                    targetPos.y += loft;

                    this.mesh.lookAt(targetPos);
                    
                    // Throw
                    const ball = window.flux.gameInstance.entities.ball;
                    this.throwBall(ball, 'PA'); 
                    console.log(`${this.role} throws to ${target.role} (Dist: ${dist.toFixed(1)})`);
                } else {
                    // Clear it forward
                    this.mesh.lookAt(0, 5, 0); // Aim up-center
                    const ball = window.flux.gameInstance.entities.ball;
                    this.throwBall(ball, 'SH'); // Hard clear
                }
                
                this.throwTimer = 0;
            }
        }
    }

    window.flux.Goalie = Goalie;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Reusable math vectors to avoid GC
const _bVec = new THREE.Vector3();
    const _bDir = new THREE.Vector3();
    const _axisY = new THREE.Vector3(0, 1, 0);
    const _tempVec = new THREE.Vector3();
    const _magnusVec = new THREE.Vector3();

// Physics Configuration (Exposed for DevTools)
window.flux.BallConfig = {
        // -----------------------------------------------------------------
        // Core integration
        // -----------------------------------------------------------------
        SUBSTEPS: 2,                // Physics substeps per frame (stability at high speeds)
        STOP_SPEED: 0.02,           // Below this speed, snap to rest (prevents endless drift)

        // -----------------------------------------------------------------
        // Water resistance (physical velocity drag, NOT stat decay)
        // -----------------------------------------------------------------
        WATER_DRAG_LINEAR: 0.15,    // Linear drag term (roughly your previous WATER_DRAG)
        WATER_DRAG_QUAD: 0.002,     // Quadratic drag (stronger at high speed, helps tame rockets)

        // -----------------------------------------------------------------
        // Spin & curve
        // -----------------------------------------------------------------
        SPIN_DRAG: 0.40,            // Spin decay per second
        MAGNUS_ENABLED: true,
        MAGNUS_COEFF: 0.08,         // Lift strength
        MAGNUS_CAP: 60.0,           // Max magnus delta-V per substep (prevents explosions)

        // -----------------------------------------------------------------
        // Depth constraint (keeps ball near play plane without feeling like a hard floor)
        // -----------------------------------------------------------------
        DEPTH_TARGET_Y: 0.0,
        DEPTH_SPRING: 1.0,          // Your previous GRAVITY_SPRING
        DEPTH_DAMP: 1.5,            // Your previous GRAVITY_DAMP

        // -----------------------------------------------------------------
        // Arena boundary (soft wall + clamp)
        // -----------------------------------------------------------------
BOUNDARY_RADIUS: 46.0,
        GOAL_DISTANCE: 41.5,        // Distance of goal from center (Z-axis)
        BOUNDARY_HEIGHT: 20.0,
        BOUNDARY_HEIGHT: 20.0,
        GOAL_POCKET_ENABLED: true,
        GOAL_POCKET_X: 12.0,        // Half-width of goal pocket corridor
        GOAL_POCKET_Z: 40.0,        // Start of goal pocket corridor (abs z) - Pushed back
        GOAL_POCKET_RADIUS: 55.0,   // Effective radius when in goal pocket
        WALL_SOFT_BUFFER: 3.0,      // Distance from wall where soft repulsion begins
        WALL_SOFT_FORCE: 20.0,      // Soft repulsion strength
        WALL_ELASTICITY: 0.30,      // Bounce dampening on clamp
        WALL_FRICTION: 0.95,        // Tangential damping on wall contact

        FLOOR_ELASTICITY: 0.40,     // Bounce dampening on ceiling/floor clamp

        // -----------------------------------------------------------------
        // Throw mapping (stat force -> physical launch speed)
        // -----------------------------------------------------------------
        LAUNCH_SPEED_SCALE: 1.0,    // Multiplies force when converting to velocity
        LAUNCH_SPEED_CAP: 85.0      // Physical speed cap (was hardcoded in Ball.shoot)
    };


    
    const C = window.flux.BallConfig; // Local alias for brevity
    // --- TRAIL RENDERER ---
// --- TRAIL RENDERER ---
    class TrailRenderer {
        constructor(scene) {
            this.scene = scene;
            this.segments = 30; // More segments for smoother curves
            this.points = [];
this.baseWidth = 0.8; // Increased width for visibility
            this.currentWidth = 0.8;
            
            // Geometry
            const geometry = new THREE.BufferGeometry();
            const posData = new Float32Array(this.segments * 2 * 3);
            geometry.setAttribute('position', new THREE.BufferAttribute(posData, 3));
            
            // Indices
            const indices = [];
            for (let i=0; i<this.segments-1; i++) {
                const base = i*2;
                indices.push(base, base+1, base+2);
                indices.push(base+1, base+3, base+2);
            }
            geometry.setIndex(indices);
            
            this.material = new THREE.MeshBasicMaterial({
                color: 0x00aaff,
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.9, // Increased opacity
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            
            this.mesh = new THREE.Mesh(geometry, this.material);
            this.mesh.frustumCulled = false;
            this.scene.add(this.mesh);
            
            // Init points
            for(let i=0; i<this.segments; i++) this.points.push(new THREE.Vector3());
            this.active = false;

            // Reusable temps (avoid per-frame allocations on mobile)
            this._tmpDir = new THREE.Vector3();
            this._tmpToCam = new THREE.Vector3();
            this._tmpRight = new THREE.Vector3();
        }
        
        reset(pos) {
            for(let i=0; i<this.segments; i++) this.points[i].copy(pos);
            this.updateGeometry();
        }
        
        setColor(hex) {
            this.material.color.setHex(hex);
        }
        
        update(currentPos, speedRatio = 0.0) {
            if (!this.active) {
                this.reset(currentPos);
                return;
            }

// Dynamic Width based on speed AND SPIN (Power Visual)
            // Fast ball = Thicker. Spinning ball = Even Thicker.
            const ball = window.flux.gameInstance ? window.flux.gameInstance.entities.ball : null;
            const spinRatio = ball ? Math.min(1.0, ball.angularVelocity.length() / 30.0) : 0;
            
            const targetWidth = this.baseWidth * (0.8 + speedRatio * 1.2 + spinRatio * 2.0);
            this.currentWidth += (targetWidth - this.currentWidth) * 0.2; // Smooth transition

            // Shift points
            for (let i = this.segments - 1; i > 0; i--) {
                this.points[i].copy(this.points[i-1]);
            }
            this.points[0].copy(currentPos);
            
            this.updateGeometry();
        }
        
        updateGeometry() {
            const positions = this.mesh.geometry.attributes.position.array;
            const cam = window.flux.gameInstance ? window.flux.gameInstance.camera : null;
            if (!cam) return;
            const camPos = cam.position;
            const tempDir = this._tmpDir;
            const tempToCam = this._tmpToCam;
            const tempRight = this._tmpRight;
            for (let i=0; i<this.segments; i++) {
                const p = this.points[i];
                
                // Taper width along trail length
                const taper = 1.0 - Math.pow(i / this.segments, 2); // Quadratic taper
                const w = this.currentWidth * taper;
                
                // Calculate direction
                if (i < this.segments - 1) {
                    tempDir.subVectors(this.points[i], this.points[i+1]);
                } else {
                    tempDir.subVectors(this.points[i-1], this.points[i]);
                }
                
                if (tempDir.lengthSq() < 0.0001) tempDir.set(0, 1, 0);
                tempDir.normalize();
                
                tempToCam.subVectors(camPos, p).normalize();
                tempRight.crossVectors(tempDir, tempToCam).normalize().multiplyScalar(w);
                
                // Vert 1
                positions[i*6 + 0] = p.x - tempRight.x;
                positions[i*6 + 1] = p.y - tempRight.y;
                positions[i*6 + 2] = p.z - tempRight.z;
                
                // Vert 2
                positions[i*6 + 3] = p.x + tempRight.x;
                positions[i*6 + 4] = p.y + tempRight.y;
                positions[i*6 + 5] = p.z + tempRight.z;
            }
            this.mesh.geometry.attributes.position.needsUpdate = true;
        }
    }
class Ball {

        constructor(scene) {
            this.scene = scene;
            this.mesh = null;
            this.holder = null; 
            this.lastHolder = null; // Track who threw it last (for EXP/Assists)
            
            this.velocity = new THREE.Vector3(0, 0, 0);
            this.angularVelocity = new THREE.Vector3(0, 0, 0);
            this.state = 'free'; // 'free', 'held', 'magnetized'
            this.isInvisible = false;

            // Continuous Stats
            this.power = 0;      // Current PA or SH value
            this.powerType = 'none'; // 'PA' or 'SH'
            this.decayRate = 3.0; // Stat points lost per second (Water resistance)
            this.catchGracePeriod = 0; // Time before ball can be caught again

            // Magnet System
            this.magnetTarget = null;
            this.magnetTimer = 0;
            this.magnetDuration = 0.2; 
            this.magnetStartPos = new THREE.Vector3();
            this.magnetStartVel = new THREE.Vector3();

            // Visuals (Squash & Stretch)
            this.accumulatedRotation = new THREE.Quaternion();
            this.deformNode = null;
            this.spinNode = null;
            this.model = null;

this.initMesh();
            this.trail = new TrailRenderer(scene);
            this._bubbleTimer = 0;
}
initMesh() {
            // Hierarchy: Mesh (Pos) -> Deform (Squash/Stretch) -> Spin (Rotation) -> Model
            this.mesh = new THREE.Group();
            this.scene.add(this.mesh);

this.deformNode = new THREE.Group();
            this.deformNode.position.y = 0.0; // Reset offset so ball is centered on mesh position
            this.mesh.add(this.deformNode); // Fix: Add deformNode to mesh

            this.spinNode = new THREE.Group();
            this.deformNode.add(this.spinNode);

            // Procedural Placeholder Texture (Blitzball-ish)
            const placeholderTex = (() => {
                const c = document.createElement('canvas');
                c.width = 128; c.height = 64;
                const ctx = c.getContext('2d');
                ctx.fillStyle = '#eeeeee';
                ctx.fillRect(0,0,128,64);
                
                // Blue bumps/details
                ctx.fillStyle = '#0088ff';
                for(let i=0; i<6; i++) {
                    ctx.beginPath();
                    ctx.arc(i*25, 32, 10, 0, Math.PI*2);
                    ctx.fill();
                }
                ctx.fillStyle = '#004488';
                ctx.fillRect(0, 28, 128, 8); // Stripe
                
                return new THREE.CanvasTexture(c);
            })();

            // Placeholder Visual (Immediate feedback, persists until valid model loads)
// Placeholder Visual (Immediate feedback, persists until valid model loads)
// Placeholder Visual (Immediate feedback, persists until valid model loads)
const geometry = new THREE.SphereGeometry(0.3, 16, 16); // Scaled down ~15%
            const material = new THREE.MeshBasicMaterial({
                map: placeholderTex,
                color: 0xffffff, 
                wireframe: false, // Solid
                transparent: false,
                opacity: 1.0
            });
            this.placeholder = new THREE.Mesh(geometry, material);

            // Load GLB Model
            const url = 'https://cdn.tinyglb.com/models/521ae8788e584e378a79d9732a075356.glb';
            
            window.flux.AssetLoader.loadModel(url, (gltf) => {
                console.log("DEBUG: Ball GLB loaded.", gltf);
                
                const model = gltf.scene;

                // 1. Reset root transforms
                model.position.set(0, 0, 0);
                model.rotation.set(0, 0, 0);
                model.scale.set(1, 1, 1);
                model.updateMatrixWorld(true);

                // 2. Harden Materials & Visibility
                model.traverse((node) => {
                    if (node.isMesh) {
                        node.castShadow = false;
                        node.receiveShadow = false;
                        node.frustumCulled = false; // CRITICAL: Prevent culling if bounds are off
                        
                        if (node.material) {
                            const mats = Array.isArray(node.material) ? node.material : [node.material];
                            mats.forEach(m => {
                                m.color.setHex(0xffffff); // Force white base
                                m.side = THREE.DoubleSide;
                                m.transparent = false;
                                m.opacity = 1.0;
                                m.alphaTest = 0; // CRITICAL: Disable alpha test to prevent culling
                                m.depthWrite = true;
                                m.depthTest = true;
                            });
                        }
                    }
                });

                // 3. Compute Bounding Box
                const box = new THREE.Box3().setFromObject(model);
                const size = new THREE.Vector3();
                box.getSize(size);
                const center = new THREE.Vector3();
                box.getCenter(center);

                // 4. Validation
                const maxDim = Math.max(size.x, size.y, size.z);
                if (maxDim <= 0.001 || !isFinite(maxDim)) {
                    console.warn("Ball model has invalid dimensions. Keeping placeholder.");
                    return; 
                }

                // 5. Calculate Scale
// 5. Calculate Scale
const targetDiameter = 0.72; // Reduced scale by ~15% (was 0.85)
                const scaleFactor = targetDiameter / maxDim;

                // 6. Apply Transforms
                model.scale.setScalar(scaleFactor);
                model.position.copy(center).multiplyScalar(-scaleFactor);

                // 7. Swap Placeholder
                if (this.placeholder) {
                    this.spinNode.remove(this.placeholder);
                    if (this.placeholder.geometry) this.placeholder.geometry.dispose();
                    this.placeholder = null;
                }

                this.model = model;
                this.spinNode.add(this.model);
                console.log(`Blitzball model attached. Scale: ${scaleFactor.toFixed(4)}`);

            }, undefined, (err) => {
                console.error("Failed to load Blitzball model:", err);
                // Fallback: Keep placeholder but tint it red to indicate error
                if (this.placeholder) {
                    this.placeholder.material.color.setHex(0xffaaaa);
                }
            });
        }

update(dt) {
            // Wrapper for backward compatibility
            this.updatePhysics(dt);
            this.updateVisuals(dt);
        }

        updatePhysics(dt) {
            if (!this.mesh) return;

            // Ball Lab replay override (Physics control)
            const __lab = window.flux && window.flux.ballLab;
            if (__lab && __lab.isReplaying && __lab.targetBall === this && typeof __lab.applyReplayFrame === 'function') {
                __lab.applyReplayFrame(this, dt);
                return;
            }

            // Safety: Reset if position corrupted
            if (isNaN(this.mesh.position.x) || isNaN(this.mesh.position.y) || isNaN(this.mesh.position.z)) {
                this.reset();
                return;
            }

            // Safety: Fix "Unpickable Ball" Bug
            if (this.state === 'held' && (!this.holder || !this.holder.mesh)) {
                this.drop();
            }
            if (this.state === 'magnetized') {
                if (!this.magnetTarget || !this.magnetTarget.mesh) {
                    this.drop();
                }
                if (this.magnetTimer > 2.0) {
                    console.warn("Ball stuck in magnetized state. Dropping.");
                    this.drop();
                }
            }
            if (this.state === 'free' && this.holder !== null) {
                this.holder = null;
            }
            if (this.state === 'free' && this.velocity.lengthSq() < 0.5) {
                this.catchGracePeriod = 0;
            }

            if (this.state === 'held' && this.holder && this.holder.mesh) {
                this.updateHeld(dt);
            } else if (this.state === 'magnetized') {
                this.updateMagnetized(dt);
            } else {
                this._updateFreePhysics(dt);
            }
            
            if (this.catchGracePeriod > 0) {
                this.catchGracePeriod -= dt;
                if (this.catchGracePeriod < 0) this.catchGracePeriod = 0;
            }
        }

        updateVisuals(dt) {
            if (!this.mesh) return;

            // Ball Lab replay override (Visuals)
            const __lab = window.flux && window.flux.ballLab;
            if (__lab && __lab.isReplaying && __lab.targetBall === this) {
                if (this.trail) this.trail.active = false;
                this._updateVisualTransforms(dt);
                return;
            }

            if (this.trail) {
                const speed = this.velocity.length();
                this.trail.active = (this.state === 'free' && speed > 2.0);
                
                _bVec.copy(this.mesh.position);
                if (this.deformNode) _bVec.y += this.deformNode.position.y;

                const ratio = Math.min(speed / 60.0, 1.0);
                this.trail.update(_bVec, ratio);
            }

            this._updateVisualTransforms(dt);
            this._updateParticles(dt);
            
            if (this.mesh && !this.isInvisible) {
                this.mesh.visible = true;
                if (this.model) this.model.visible = true;
            }
        }

magnetize(target) {
            if (this.state === 'magnetized' || this.state === 'held') return;
            
            this.state = 'magnetized';
            this.magnetTarget = target;
            this.holder = target; // Logical possession so AI reacts
            this.magnetTimer = 0;
            this.magnetStartPos.copy(this.mesh.position);
            this.magnetStartVel.copy(this.velocity);
            
            // Dynamic Duration based on distance (Smoother for long range, snappy for close)
            const dist = this.mesh.position.distanceTo(target.mesh.position);
            this.magnetDuration = Math.max(0.15, Math.min(0.4, dist / 15.0));
            
            // Kill physics
            this.velocity.set(0, 0, 0);
            this.angularVelocity.set(0, 0, 0);

            // Notify player immediately so they stop chasing and play animation
            if (target.receiveBall) {
                target.receiveBall();
            }

this.reveal();
            if (window.flux.gameInstance && window.flux.gameInstance.audioManager) {
                window.flux.gameInstance.audioManager.playSFX('catch', { volume: 0.6 });
            }
        }

updateMagnetized(dt) {
            if (!this.magnetTarget || !this.magnetTarget.mesh) {
                this.drop();
                return;
            }

            this.magnetTimer += dt;
            
            // Normalized Time
            let t = this.magnetTimer / this.magnetDuration;
            if (t > 1.0) t = 1.0;

            // Target "Virtual Hand" Position (Front of Chest)
            const holderPos = this.magnetTarget.mesh.position;
            const holderQuat = this.magnetTarget.mesh.quaternion;
            
            // Offset: Forward 0.6, Up 1.0 (Chest height)
            const offset = _bVec.set(0, 1.0, 0.6).applyQuaternion(holderQuat);
            const targetPos = offset.add(holderPos);

            // --- QUADRATIC BEZIER CURVE ---
            // P0 = Start, P2 = Target
            // P1 = Control Point (Projected along initial velocity to preserve momentum feel)
            
            const p0 = this.magnetStartPos;
            const p2 = targetPos;
            
            // Calculate P1 (Control Point)
            // Project forward from P0 along start velocity vector
            // Distance of projection = 40% of total distance to target
            const dist = p0.distanceTo(p2);
            const p1 = _tempVec.copy(p0);
            
            const velLen = this.magnetStartVel.lengthSq();
            if (velLen > 1.0) {
                // Use velocity tangent
// Use velocity tangent
                _bDir.copy(this.magnetStartVel).normalize();
                p1.add(_bDir.multiplyScalar(dist * 0.4));
            } else {
                // No velocity (stationary ball), arc upwards slightly
                p1.lerp(p2, 0.5);
                p1.y += 1.5; 
            }

            // Bezier: B(t) = (1-t)^2 * P0 + 2(1-t)t * P1 + t^2 * P2
            const oneMinusT = 1.0 - t;
            const w0 = oneMinusT * oneMinusT;
            const w1 = 2.0 * oneMinusT * t;
            const w2 = t * t;
            
            this.mesh.position.x = (w0 * p0.x) + (w1 * p1.x) + (w2 * p2.x);
            this.mesh.position.y = (w0 * p0.y) + (w1 * p1.y) + (w2 * p2.y);
            this.mesh.position.z = (w0 * p0.z) + (w1 * p1.z) + (w2 * p2.z);

            // Finish
            if (t >= 1.0) {
                this.grab(this.magnetTarget);
            }
        }

updateHeld(dt) {
            // ATTACHED STATE (Virtual Attachment)
            if (!this.holder || !this.holder.mesh) {
                this.drop();
                return;
            }

            this.velocity.set(0, 0, 0);
            this.angularVelocity.set(0, 0, 0);

            // 1. Try to use Hand Bone if available (Realism)
            if (this.holder.handBone) {
                // Get world position of the hand bone
                this.holder.handBone.getWorldPosition(this.mesh.position);
                
                // Adjust slightly to sit IN the hand rather than ON the wrist
                // We can't easily know "forward" for the bone without more info, 
                // but usually GLTF bones are oriented. For now, exact bone pos is better than chest.
            } else {
                // 2. Fallback: Calculate "Carrying" Position (Right Hand Side)
                // Relative to player: Up 0.8 (Waist/Chest), Right 0.4, Forward 0.5
                const holderPos = this.holder.mesh.position;
                const holderQuat = this.holder.mesh.quaternion;
                
                // Reuse _bVec
// Reuse _bVec
                // Offset: x=0.35 (Right), y=1.3 (Chest/Hands), z=0.5 (Forward)
                _bVec.set(0.35, 1.3, 0.5).applyQuaternion(holderQuat);
                this.mesh.position.copy(holderPos).add(_bVec);
            }

// Visual Flair: Spin the ball slowly
            const rotX = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0), 2 * dt);
            const rotY = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0), 5 * dt);
            this.accumulatedRotation.multiply(rotX).multiply(rotY);
        }


updateFree(dt) {
            // Legacy wrapper
            this._updateFreePhysics(dt);
            this._updateParticles(dt);
            this._updateVisualTransforms(dt);
        }

        _updateFreePhysics(dt) {
            const C = window.flux.BallConfig || {};
            const substeps = Math.max(1, Math.floor(C.SUBSTEPS || 1));
            const stepDt = dt / substeps;

            for (let s = 0; s < substeps; s++) {
                // A) Magnus effect
                if (C.MAGNUS_ENABLED && this.angularVelocity && this.velocity) {
                    const spinSq = this.angularVelocity.lengthSq();
                    const velSq = this.velocity.lengthSq();
                    if (spinSq > 0.25 && velSq > 0.25) {
                        _magnusVec.copy(this.angularVelocity).cross(this.velocity).multiplyScalar((C.MAGNUS_COEFF || 0) * stepDt);
                        const cap = (C.MAGNUS_CAP !== undefined ? C.MAGNUS_CAP : 60.0);
                        const magLen = _magnusVec.length();
                        if (magLen > cap) _magnusVec.multiplyScalar(cap / magLen);
                        this.velocity.add(_magnusVec);
                    }
                }

                // B) Spin decay
                if (this.angularVelocity) {
                    const spinDrag = Math.max(0, 1.0 - (C.SPIN_DRAG || 0) * stepDt);
                    this.angularVelocity.multiplyScalar(spinDrag);
                }

                // C) Depth spring
                const targetY = (C.DEPTH_TARGET_Y !== undefined ? C.DEPTH_TARGET_Y : 0.0);
                const yErr = (this.mesh.position.y - targetY);
                this.velocity.y -= yErr * (C.DEPTH_SPRING || 0) * stepDt;
                this.velocity.y *= Math.max(0, 1.0 - (C.DEPTH_DAMP || 0) * stepDt);

                // D) Drag
                const vLen = this.velocity.length();
                if (vLen > 0.00001) {
                    const lin = (C.WATER_DRAG_LINEAR !== undefined ? C.WATER_DRAG_LINEAR : (C.WATER_DRAG || 0)) * stepDt;
                    const quad = (C.WATER_DRAG_QUAD || 0) * vLen * stepDt;
                    const drag = Math.max(0, 1.0 - lin - quad);
                    this.velocity.multiplyScalar(drag);

                    const stop = (C.STOP_SPEED || 0);
                    if (stop > 0 && this.velocity.lengthSq() < stop * stop) {
                        this.velocity.set(0, 0, 0);
                    }
                }

                // E) Move
                _tempVec.copy(this.velocity).multiplyScalar(stepDt);
                this.mesh.position.add(_tempVec);

                // F) Stat power decay
                if (this.power > 0) {
                    this.power -= this.decayRate * stepDt;
                    if (this.power < 0) this.power = 0;
                }

                // G) Boundary logic
                const pos = this.mesh.position;
                const distXZ = Math.sqrt(pos.x * pos.x + pos.z * pos.z);
                const boundaryRadius = (C.BOUNDARY_RADIUS !== undefined ? C.BOUNDARY_RADIUS : 33.0);
                let effectiveBoundary = boundaryRadius;

                if (C.GOAL_POCKET_ENABLED) {
                    const inGoalPocket = (Math.abs(pos.x) < (C.GOAL_POCKET_X || 12.0) && Math.abs(pos.z) > (C.GOAL_POCKET_Z || 25.0));
                    if (inGoalPocket) effectiveBoundary = (C.GOAL_POCKET_RADIUS || 45.0);
                }

                const softBuffer = Math.max(0.01, (C.WALL_SOFT_BUFFER !== undefined ? C.WALL_SOFT_BUFFER : 3.0));

                if (distXZ > effectiveBoundary - softBuffer) {
                    const penetration = distXZ - (effectiveBoundary - softBuffer);
                    const ratio = Math.max(0, Math.min(1, penetration / softBuffer));
                    _tempVec.set(-pos.x, 0, -pos.z);
                    if (_tempVec.lengthSq() > 0.0001) {
                        _tempVec.normalize();
                        const force = ratio * ratio * (C.WALL_SOFT_FORCE || 0) * stepDt;
                        this.velocity.addScaledVector(_tempVec, force);
                    }
                }

                if (distXZ > effectiveBoundary) {
                    _tempVec.set(-pos.x, 0, -pos.z);
                    if (_tempVec.lengthSq() > 0.0001) _tempVec.normalize();
                    const overlap = distXZ - effectiveBoundary;
                    pos.addScaledVector(_tempVec, overlap);
                    const vDotN = this.velocity.dot(_tempVec);
                    if (vDotN < 0) {
                        const impactSpeed = Math.abs(vDotN);
                        if (impactSpeed > 10.0 && window.flux.triggerArenaImpact) {
                            window.flux.triggerArenaImpact(pos, Math.min(impactSpeed * 0.5, 15.0));
                            if (window.flux.gameInstance && window.flux.gameInstance.audioManager) {
                                window.flux.gameInstance.audioManager.playSFX('impact', { volume: Math.min(1.0, impactSpeed * 0.05) });
                            }
                        }
                        const e = (C.WALL_ELASTICITY !== undefined ? C.WALL_ELASTICITY : 0.3);
                        const impulse = _tempVec.clone().multiplyScalar(-vDotN * (1.0 + e));
                        this.velocity.add(impulse);
                        const friction = (C.WALL_FRICTION !== undefined ? C.WALL_FRICTION : 0.95);
                        const tangent = this.velocity.clone().projectOnPlane(_tempVec);
                        this.velocity.sub(tangent.multiplyScalar(1.0 - friction));
                    }
                }

                const bh = (C.BOUNDARY_HEIGHT !== undefined ? C.BOUNDARY_HEIGHT : 15.0);
                if (Math.abs(pos.y) > bh) {
                    const sign = Math.sign(pos.y) || 1;
                    pos.y = bh * sign;
                    const fe = (C.FLOOR_ELASTICITY !== undefined ? C.FLOOR_ELASTICITY : 0.4);
                    this.velocity.y *= -fe;
                }
            }
        }

        _updateParticles(dt) {
            if (this._ghost) return;
            
            const speedSq = this.velocity.lengthSq();
            this._bubbleTimer -= dt;
            if (this._bubbleTimer <= 0) {
                const pm = window.flux.gameInstance ? window.flux.gameInstance.particleManager : null;
                if (pm) {
                    const offset = this.velocity.clone().normalize().multiplyScalar(-0.8);
                    const stdPos = this.mesh.position.clone().add(offset).add(_bDir.set((Math.random()-0.5)*0.3, (Math.random()-0.5)*0.3, (Math.random()-0.5)*0.3));
                    if (this.deformNode) stdPos.y += this.deformNode.position.y;
                    pm.spawn('bubble', stdPos, { scale: 0.4 + Math.random() * 0.4 });

                    if (speedSq > 50.0) {
                        const count = Math.min(4, Math.floor(speedSq / 60));
                        for (let i = 0; i < count; i++) {
                            const jitter = _bDir.set((Math.random()-0.5)*0.4, (Math.random()-0.5)*0.4, (Math.random()-0.5)*0.4);
                            const spawnPos = this.mesh.position.clone().add(offset).add(jitter);
                            if (this.deformNode) spawnPos.y += this.deformNode.position.y;
                            pm.spawn('bubble_micro', spawnPos, { scale: 0.05 + Math.random() * 0.1 });
                        }
                        this._bubbleTimer = 0.02;
                    } else {
                        if (Math.random() > 0.5) {
                            const jitter = _bDir.set((Math.random()-0.5)*0.2, (Math.random()-0.5)*0.2, (Math.random()-0.5)*0.2);
                            const spawnPos = this.mesh.position.clone().add(offset).add(jitter);
                            if (this.deformNode) spawnPos.y += this.deformNode.position.y;
                            pm.spawn('bubble_micro', spawnPos, { scale: 0.04 + Math.random() * 0.06 });
                        }
                        this._bubbleTimer = 0.05;
                    }
                }
            }
        }

// Stray code block removed

grab(player) {
            this.reveal(); 
            
            // Announcement: Possession (if taking from free state)
            if (this.state === 'free') {
                 if (window.flux.gameInstance && window.flux.gameInstance.showAnnouncement) {
                     window.flux.gameInstance.showAnnouncement("POSSESSION", "normal");
                 }
            }

            // Check Turnover (Possession Change)
            const previousTeam = this.holder ? this.holder.team : (this.lastHolder ? this.lastHolder.team : null);
            if (previousTeam && previousTeam !== player.team) {
                 if (window.flux.gameInstance && window.flux.gameInstance.floatingText) {
                     window.flux.gameInstance.floatingText.spawn("TURNOVER", player.mesh.position, "tech");
                 }
            }
            
            // If someone else held it, they lose it
            if (this.holder && this.holder !== player) {
                this.holder.loseBall();
            }

            this.holder = player;
            this.state = 'held';
            
            // NOTE: We do NOT parent the mesh to the player anymore.
            // This prevents the ball from flying around due to swim animations.
            // Instead, we update its position manually in updateHeld().
            
            // Notify player
            if (player.receiveBall) {
                player.receiveBall();
            }
            
            console.log("Ball grabbed by " + player.role);
        }

        drop() {
            this.reveal(); // Ensure visible
            
            // No need to detach from scene graph since we aren't parenting to player anymore.
            // Just clear holder.

            if (this.holder) {
                if (this.holder.loseBall) this.holder.loseBall();
                this.holder = null;
            }
            
            this.state = 'free';
        }
// Shoot/Pass
// Shoot/Pass
        shoot(directionVector, force, type = 'SH', technique = null, spinVector = null) {

            this.lastHolder = this.holder; // Record for EXP attribution
            
            // Fumble Detection (Type 'none' is used by Player.fumble)
            if (type === 'none') {
                if (window.flux.gameInstance && window.flux.gameInstance.showAnnouncement) {
                    window.flux.gameInstance.showAnnouncement("FUMBLE!", "slam");
                }
            }

            this.drop(); // Detach first
            
            // Set Grace Period to prevent instant interceptions/catches
            // 0.2s allows ball to clear the thrower's immediate vicinity
            this.catchGracePeriod = 0.2;

            // Physical Velocity (Visual speed)
            const C = window.flux.BallConfig || {};
            const scale = (C.LAUNCH_SPEED_SCALE !== undefined ? C.LAUNCH_SPEED_SCALE : 1.0);
            const cap = (C.LAUNCH_SPEED_CAP !== undefined ? C.LAUNCH_SPEED_CAP : 85.0);
            const speed = Math.min(force * scale, cap);
            this.velocity.copy(directionVector).normalize().multiplyScalar(speed);
            
            // Apply Spin if provided
            if (spinVector) {
                this.angularVelocity.copy(spinVector);
            } else {
                this.angularVelocity.set(0, 0, 0);
            }
            
            // Stat Power (Game Logic)
            this.power = force;
            this.powerType = type;
            this.technique = technique; 
            
            // Update Trail Color
            if (this.trail) {
                let color = 0x00aaff; // Default Blue (Pass)
                
                if (technique) {
                    if (technique.type === 'venom') color = 0x00ff00; // Green (Venom)
                    else if (technique.type === 'wither') color = 0x888888; // Grey
                    else if (technique.type === 'nap') color = 0x000088; // Dark Blue
                    else if (technique.type === 'sphere') color = 0x00ffff; // Cyan
                    else if (technique.type === 'jecht') color = 0xff0000; // Red
                    else if (technique.type === 'invisible') color = 0x444444; // Dark Grey
                } else if (type === 'SH') {
                    color = 0xff4400; // Orange/Red
                }
                
                this.trail.setColor(color);
            }
            
            // Handle Invisible Shot
            if (technique && technique.type === 'invisible') {
                this.isInvisible = true;
                if (this.mesh) this.mesh.visible = false;
                // FX: Poof
                if (window.flux.gameInstance && window.flux.gameInstance.particleManager) {
                    window.flux.gameInstance.particleManager.spawn('wither', this.mesh.position, { scale: 2.0 });
                }
                console.log("Invisible Shot!");
            }
            
            console.log(`Ball ${type} with Power: ${this.power.toFixed(1)} Spin: ${this.angularVelocity.length().toFixed(1)}`);
            
            // Visual Feedback for Curve
            if (this.angularVelocity.length() > 15.0 && window.flux.gameInstance && window.flux.gameInstance.floatingText) {
                window.flux.gameInstance.floatingText.spawn("CURVE!", this.mesh.position, "tech");
            }
        }

        reveal() {
            if (this.isInvisible) {
                // FX: Reveal Poof
                if (window.flux.gameInstance && window.flux.gameInstance.particleManager && this.mesh) {
                    window.flux.gameInstance.particleManager.spawn('wither', this.mesh.position, { scale: 2.0 });
                }
            }
            this.isInvisible = false;
            if (this.mesh) this.mesh.visible = true;
        }

// Duplicate reveal removed
        
reset() {
            this.reveal();
            this.drop();
            this.mesh.position.set(0, 0, 0);
            this.velocity.set(0, 0, 0);
            this.angularVelocity.set(0, 0, 0);
            this.catchGracePeriod = 0;
            this.power = 0;
        }
isCatchable() {
            return this.catchGracePeriod <= 0;
        }

_updateVisualTransforms(dt) {
            if (!this.deformNode || !this.spinNode) return;

            // 1. Squash & Stretch based on velocity
            const speed = this.velocity.length();
            
            if (speed > 1.0 && this.state === 'free') {
                const dir = this.velocity.clone().normalize();
                this.deformNode.quaternion.setFromUnitVectors(new THREE.Vector3(0,0,1), dir);
                
                const factor = Math.min(speed / 40.0, 1.0); 
                const stretch = 1.0 + (factor * 0.8);
                const squash = 1.0 / Math.sqrt(stretch);
                
                this.deformNode.scale.set(squash, squash, stretch);
            } else {
                this.deformNode.quaternion.identity();
                this.deformNode.scale.set(1, 1, 1);
            }

            // 2. Apply Accumulated Spin
            const invDeform = this.deformNode.quaternion.clone().invert();
            this.spinNode.quaternion.copy(invDeform.multiply(this.accumulatedRotation));

            // 3. Visual rotation integration
            const spinSq = this.angularVelocity.lengthSq();
            if (spinSq > 0.01) {
                const spinSpeed = Math.sqrt(spinSq);
                const axis = _tempVec.copy(this.angularVelocity).normalize();
                const q = new THREE.Quaternion().setFromAxisAngle(axis, spinSpeed * dt);
                this.accumulatedRotation.premultiply(q);
            } else {
                if (speed > 0.1) {
                    _tempVec.copy(this.velocity).cross(_axisY).normalize();
                    if (_tempVec.lengthSq() > 0.01) {
                        const q = new THREE.Quaternion().setFromAxisAngle(_tempVec, speed * dt);
                        this.accumulatedRotation.premultiply(q);
                    }
                }
            }
        }
    }

window.flux.Ball = Ball;
    window.flux.TrailRenderer = TrailRenderer;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class MiniMap {
        constructor() {
            this.container = document.getElementById('minimap');
            this.canvas = document.createElement('canvas');
            // Optimization: alpha: true is needed for transparent background
            this.ctx = this.canvas.getContext('2d', { alpha: true });
            
            // High DPI scaling (2x for retina sharpness on 100px container)
            this.size = 200; 
            this.canvas.width = this.size;
            this.canvas.height = this.size;
            
            Object.assign(this.canvas.style, {
                width: '100%',
                height: '100%',
                borderRadius: '50%',
                display: 'block'
            });
            
            if (this.container) {
                // Remove any existing children (e.g. from previous inits)
                while (this.container.firstChild) {
                    this.container.removeChild(this.container.firstChild);
                }
                this.container.appendChild(this.canvas);
            }

            this.worldRadius = 30; // Arena radius
            this.homeTeam = null;
            this.awayTeam = null;
            this.ball = null;
        }

        init(homeTeam, awayTeam, ball) {
            this.homeTeam = homeTeam;
            this.awayTeam = awayTeam;
            this.ball = ball;
        }

        update() {
            if (!this.ctx) return;

            const ctx = this.ctx;
            const size = this.size;
            const center = size / 2;
            // Map world radius (30) to canvas radius (approx 90px to leave padding)
            const scale = (center - 10) / this.worldRadius; 

            ctx.clearRect(0, 0, size, size);

            // Helper to draw entities
            const drawEntity = (entity, color, radius, isRing = false) => {
                if (!entity.mesh) return;
                
                // Skip if explicitly invisible (e.g. Ball invisible shot, or Practice dummies)
                if (entity.isInvisible) return;
                if (entity.mesh.visible === false) return;

                const pos = entity.mesh.position;
                
                // Map Logic: -Z is Top (Home Attack), +Z is Bottom
                // Canvas: 0,0 is Top-Left.
                // Center is 100,100.
                // World X -> Canvas X
                // World Z -> Canvas Y
                
                let dx = pos.x * scale;
                let dy = pos.z * scale;

                // Clamp to circular bounds
                const dist = Math.sqrt(dx*dx + dy*dy);
                const maxDist = center - radius - 2;
                
                if (dist > maxDist) {
                    const angle = Math.atan2(dy, dx);
                    dx = Math.cos(angle) * maxDist;
                    dy = Math.sin(angle) * maxDist;
                }

                const x = center + dx;
                const y = center + dy;

                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                
                if (isRing) {
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                } else {
                    ctx.fillStyle = color;
                    ctx.fill();
                }
            };

            // Draw Home Team
            if (this.homeTeam) {
                const active = this.homeTeam.activePlayer;
                for (let i = 0; i < this.homeTeam.players.length; i++) {
                    const p = this.homeTeam.players[i];
                    let color = '#60c0d0'; // Cyan
                    let r = 6; // 2x scale of 3px

                    if (p.status && p.status.nap > 0) color = '#333333';
                    
                    if (p === active) {
                        color = '#00ff00';
                        r = 8;
                    } else if (p.hasBall) {
                        color = '#ffaa00';
                        r = 7;
                    }

                    drawEntity(p, color, r);
                    
                    if (p.hasBall) {
                        drawEntity(p, '#ffffff', r + 2, true);
                    }
                }
            }

            // Draw Away Team
            if (this.awayTeam) {
                for (let i = 0; i < this.awayTeam.players.length; i++) {
                    const p = this.awayTeam.players[i];
                    let color = '#ff4444';
                    let r = 6;

                    if (p.status && p.status.nap > 0) color = '#333333';
                    if (p.hasBall) {
                        color = '#ffaa00';
                        r = 7;
                    }

                    drawEntity(p, color, r);

                    if (p.hasBall) {
                        drawEntity(p, '#ffffff', r + 2, true);
                    }
                }
            }

            // Draw Ball (if free)
            if (this.ball && this.ball.state === 'free') {
                drawEntity(this.ball, '#ff00cc', 7);
                drawEntity(this.ball, '#ffffff', 9, true);
            }
        }
    }

    window.flux.MiniMap = MiniMap;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

// Spark Texture (Procedural Burst)
    const _sparkTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.clearRect(0,0,64,64);
        
        // Burst shape
        const cx = 32, cy = 32;
        const spikes = 8;
        const outer = 30;
        const inner = 10;
        
        ctx.beginPath();
        for(let i=0; i<spikes*2; i++){
            const r = (i%2===0)? outer : inner;
            const a = (Math.PI*i)/spikes;
            ctx.lineTo(cx + Math.cos(a)*r, cy + Math.sin(a)*r);
        }
        ctx.closePath();
        ctx.fillStyle = '#ffcc00';
        ctx.fill();
        
        // White Core
        ctx.beginPath();
        ctx.arc(cx, cy, 8, 0, Math.PI*2);
        ctx.fillStyle = '#ffffff';
        ctx.fill();
        
        return new THREE.CanvasTexture(c);
    })();

    const _sparkMaterial = new THREE.SpriteMaterial({ 
        map: _sparkTexture, 
        transparent: true, 
        blending: THREE.AdditiveBlending,
        depthWrite: false
    });

    class GameManager {

        
constructor(scene, uiLayerId, camera, renderer) {
window.flux.gameInstance = this;
            this.renderer = renderer; // Store renderer
            this.scene = scene;
            this.camera = camera;
            this.uiLayer = document.getElementById(uiLayerId);
            
            this.score = { home: 0, away: 0 };
            this.time = 0;
            this.half = 1;
            this.halfDuration = 300; // 5 minutes (seconds)
            this.isOvertime = false;
            this.isDemoMode = false;
this.gameMode = 'normal'; // 'normal' or 'practice'
            this.isForgeMode = false; // Asset Forge State
            // Impact Frames
            this.impactPause = 0;
            
            this.state = 'menu'; // Start in menu
this.teams = {
                home: null,
                away: null
            };
            
            this.entities = {
                ball: null
            };

this.ui = {
                scorePlayer: null,
                scoreCpu: null,
                timer: null,
                half: null,
                announcement: null,
                // Player Status Panel
                statusPanel: {
                    container: null,
                    name: null,
                    hpBar: null,
                    hpText: null,
                    expBar: null
                }
            };

            // Techcopy State
            this.techCopyState = {
                active: false,
                timer: 0,
                tech: null,
                learners: []
            };

this.miniMap = new window.flux.MiniMap();
            
            // Initialize Floating Text
// Initialize Floating Text
this.floatingText = new window.flux.FloatingTextManager(scene, uiLayerId, camera);
            
            // Reusable vector for UI calculations
            this._tempVec = new THREE.Vector3();

            // Initialize Particle Manager (Status Effects)
            
// Initialize Particle Manager (Status Effects)
            this.particleManager = new window.flux.ParticleManager(scene);
this.glyphManager = null; // Injected by main.js
this._initCinematics();
            this._initParticles(); // 3D Spark System (Legacy/Impact)

this.debugVisualizer = new window.flux.DebugVisualizer(scene);
            this.practiceManager = new window.flux.PracticeManager(this); // Initialize Practice Manager
            this._injectStyles();
this._initUI();
        }

_initCinematics() {
            // Menu Background Shots (B-Roll)
            this.menuShotIndex = 0;
            this.menuShotTimer = 0;
            this.menuShots = [
                { duration: 10.0, update: (t, cam) => { cam.position.set(60, 35, 60).lerp(new THREE.Vector3(40, 25, 40), t); cam.lookAt(0, 0, 0); } },
                { duration: 8.0, update: (t, cam) => { cam.position.set(-25, 6, -25 + 50*t); cam.lookAt(0, 2, (-25 + 50*t)*0.8); } },
                { duration: 8.0, update: (t, cam) => { const a = t+3.5; cam.position.set(-10+Math.cos(a)*10, 4, -10+Math.sin(a)*10); cam.lookAt(-10, 1.5, -10); } },
                { duration: 7.0, update: (t, cam) => { cam.position.set(0, -5, 32).lerp(new THREE.Vector3(0, 8, 20), t); cam.lookAt(0, 15, 45); cam.rotation.z = (t-0.5)*0.15; } },
                { duration: 8.0, update: (t, cam) => { cam.position.set(0, 50, 0).lerp(new THREE.Vector3(0, 10, 0), t*t*(3-2*t)); cam.lookAt(0, 0, 0); cam.rotation.z = t*0.8; } }
            ];

            // Epic Intro Sequence ("Herculean")
            this.introShots = [
                // 1. "The Awakening" - Close on Sphere -> Zoom Out Upside Down -> Lights & Roar
                {
                    duration: 8.0,
                    onStart: () => { 
                        this.showAnnouncement("THE SPHERE POOL", "slam"); 
                        if(this.stadium) this.stadium.resetLights(); // Ensure dark start
                        this._hasRoared = false;
                        
                        // Ambient start sound (Deep hum / Underwater feel)
                        if(this.audioManager) this.audioManager.playSFX('swim', { volume: 1.0, rate: 0.3 });
                    },
                    update: (t, cam) => {
                        // Easing
                        const ease = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
                        const expT = Math.pow(t, 3.0); // Strong exponential zoom out

                        // Camera Motion: Start INSIDE/CLOSE (0,0,2) -> End FAR BACK/UP (0, 80, 160)
                        const startPos = new THREE.Vector3(0, 0, 2); 
                        const endPos = new THREE.Vector3(0, 80, 160); 
                        
                        cam.position.lerpVectors(startPos, endPos, expT);
                        cam.lookAt(0, 0, 0);

                        // Dynamic Roll: Turn upside down (0 -> PI)
                        cam.rotation.z = ease * Math.PI; 

                        // Light Sequencing & Sound
                        if (this.stadium) {
                            const total = this.stadium.lightCount;
                            const lightProgress = Math.max(0, (t - 0.2) / 0.6);
                            const activeCount = Math.floor(lightProgress * total);
                            
                            // Trigger "Roar to Life"
                            if (lightProgress > 0.5 && !this._hasRoared) {
                                this._hasRoared = true;
                                if(this.audioManager) {
                                    this.audioManager.playSFX('goal', { volume: 1.0, rate: 0.7 }); // Deep roar
                                    this.audioManager.playSFX('dash', { volume: 0.8, rate: 0.5 }); // Whoosh
                                }
                                if (this.cameraManager) this.cameraManager.addShake(1.5);
                            }

                            for(let i=0; i < total; i++) {
                                if (i <= activeCount) {
                                    const sprite = this.stadium.lightSprites[i];
                                    if (sprite && !sprite.visible) {
                                        this.stadium.turnOnLight(i);
                                        
                                        // Industrial Light SFX
                                        if(this.audioManager) {
                                            const pitch = 0.5 + (i / total) * 0.5; 
                                            this.audioManager.playSFX('impact', { volume: 0.4, rate: pitch, variance: 0.0 });
                                        }
                                        if (this.cameraManager) this.cameraManager.addShake(0.2);
                                    }
                                }
                            }
                        }
                    }
                },
                // 2. "The Roar" - Sweeping crowd shot
                {
                    duration: 4.0,
                    onStart: () => {
                        this.showAnnouncement("LEGENDARY ARENA", "normal");
                        if(this.cameraManager) this.cameraManager.addShake(1.0);
                        if(this.audioManager) this.audioManager.playSFX('goal', { volume: 0.7 }); // Crowd cheer
                    },
                    update: (t, cam) => {
                        const aspect = window.innerWidth / window.innerHeight;
                        const isPortrait = aspect < 1.0;
                        
                        const angle = -Math.PI/2 + (t * Math.PI * 0.5);
                        const r = isPortrait ? 85 : 65; // Pull back in portrait
                        
                        cam.position.set(Math.cos(angle)*r, 15, Math.sin(angle)*r);
                        cam.lookAt(0, 5, 0);
                    }
                },
                // 3. "Home Glory" - Orbit Home Team
                {
                    duration: 3.5,
                    onStart: () => {
                        this.showAnnouncement("BESAID AUROCHS", "slam");
                        if(this.teams.home) this.teams.home.players.forEach(p => p.play('celebrate', 0.2));
                        if(this.audioManager) this.audioManager.playSFX('dash', { volume: 0.5 }); // Whoosh
                    },
                    update: (t, cam) => {
                        const aspect = window.innerWidth / window.innerHeight;
                        const isPortrait = aspect < 1.0;

                        // Orbit Home Team (Side 1, -Z)
                        const center = new THREE.Vector3(0, 0, -20);
                        const angle = Math.PI + (t * 1.5);
                        const r = isPortrait ? 20 : 12; // Pull back if portrait
                        cam.position.set(center.x + Math.cos(angle)*r, 4, center.z + Math.sin(angle)*r);
                        cam.lookAt(center.x, 2, center.z);
                    }
                },
                // 4. "Enemy Gates" - Tracking Away Team
                {
                    duration: 3.5,
                    onStart: () => {
                        this.showAnnouncement("LUCA GOERS", "slam");
                        if(this.teams.away) this.teams.away.players.forEach(p => p.play('idle', 0.2));
                        if(this.audioManager) this.audioManager.playSFX('dash', { volume: 0.5 }); // Whoosh
                    },
                    update: (t, cam) => {
                        const aspect = window.innerWidth / window.innerHeight;
                        const isPortrait = aspect < 1.0;

                        // Tracking Away Team (Side -1, +Z)
                        const start = new THREE.Vector3(-15, 2, 25);
                        const end = new THREE.Vector3(15, 2, 25);
                        
                        if (isPortrait) {
                            start.x *= 1.5; end.x *= 1.5;
                            start.z += 10; end.z += 10;
                        }

                        cam.position.lerpVectors(start, end, t);
                        cam.lookAt(0, 3, 25);
                    }
                },
                // 5. "The Sphere" - Zoom to center
                {
                    duration: 2.0,
                    onStart: () => {
                        this.showAnnouncement("BLITZ OFF!", "slam");
                        if(this.stadium) this.stadium.setAllLights(true);
                        if(this.audioManager) this.audioManager.playSFX('whistle', { volume: 0.8 });
                    },
                    update: (t, cam) => {
                        const aspect = window.innerWidth / window.innerHeight;
                        const isPortrait = aspect < 1.0;

                        const p1 = new THREE.Vector3(0, 30, isPortrait ? 70 : 50);
                        const p2 = new THREE.Vector3(0, 14, 22); // Gameplay cam
                        const st = t * t;
                        cam.position.lerpVectors(p1, p2, st);
                        cam.lookAt(0, 0, 0);
                    }
                }
            ];
        }

        _injectStyles() {
            if (document.getElementById('flux-dynamic-styles')) return;
            const style = document.createElement('style');
            style.id = 'flux-dynamic-styles';
style.textContent = `
                @keyframes textSlam {
                    0% { transform: translate(-50%, -50%) scale(4); opacity: 0; letter-spacing: 50px; }
                    10% { transform: translate(-50%, -50%) scale(1); opacity: 1; letter-spacing: 5px; }
                    15% { transform: translate(-50%, -50%) scale(1.1); }
                    20% { transform: translate(-50%, -50%) scale(1); }
                    80% { transform: translate(-50%, -50%) scale(1); opacity: 1; filter: blur(0px); }
                    100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; filter: blur(10px); }
                }
                
                .announcement-slam {
                    position: absolute;
                    top: 45%; left: 50%;
                    transform: translate(-50%, -50%);
                    width: 100%;
                    text-align: center;
                    font-family: 'Impact', sans-serif;
                    font-size: 96px;
                    font-style: italic;
                    text-transform: uppercase;
                    background: linear-gradient(to bottom, #ffffff 0%, #ffdd00 45%, #ff8800 100%);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    filter: drop-shadow(0 0 10px rgba(0,0,0,1)) drop-shadow(0 0 30px rgba(255, 100, 0, 0.6));
                    z-index: 2000;
                    animation: textSlam 1.8s cubic-bezier(0.1, 0.8, 0.1, 1) forwards;
                    pointer-events: none;
                    white-space: nowrap;
                }

                .modal-overlay {
                    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                    background: radial-gradient(circle at center, rgba(10, 25, 60, 0.95) 0%, rgba(0, 0, 0, 0.98) 100%);
                    display: flex; justify-content: center; align-items: center; flex-direction: column;
                    z-index: 1900;
                    opacity: 0; pointer-events: none; transition: opacity 0.8s;
                    backdrop-filter: blur(8px);
                }
                .modal-overlay.active { opacity: 1; pointer-events: auto; }
                
                .modal-title {
                    font-family: 'Garamond', serif;
                    font-size: 52px; color: #fff;
                    text-transform: uppercase;
                    text-shadow: 0 0 20px #00aaff, 0 0 40px #0044aa;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #00aaff;
                    padding-bottom: 10px;
                    width: 80%; text-align: center;
                    letter-spacing: 5px;
                }
                
                .modal-score-container {
                    display: flex; align-items: center; gap: 40px;
                    margin-bottom: 40px;
                }
                .modal-score {
                    font-family: 'Impact', sans-serif;
                    font-size: 80px; color: #ffd700;
                    letter-spacing: 5px;
                    text-shadow: 0 0 20px #b8860b;
                }
                .modal-vs {
                    font-family: 'Courier New', monospace;
                    font-size: 24px; color: #00aaff; opacity: 0.7;
                }

                .flash-overlay {
                    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                    background: white;
                    z-index: 2100;
                    opacity: 0; pointer-events: none;
                    transition: opacity 0.1s ease-out;
                    mix-blend-mode: overlay;
                }

                @keyframes clashPop {
                    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
                    50% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.8; }
                    100% { transform: translate(-50%, -50%) scale(2.0); opacity: 0; }
                }

                .clash-spark {
                    position: absolute;
                    width: 60px; height: 60px;
                    background: radial-gradient(circle, #ffffff 0%, #ffff00 40%, transparent 70%);
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 1500;
                    mix-blend-mode: screen;
                    animation: clashPop 0.3s ease-out forwards;
                    box-shadow: 0 0 20px #ffaa00;
                }
            `;
            document.head.appendChild(style);
        }

        registerTeams(homeTeam, awayTeam, ball) {
            this.teams.home = homeTeam;
            this.teams.away = awayTeam;
this.entities.ball = ball;
            
            // Initialize MiniMap
            if (this.miniMap) {
                this.miniMap.init(homeTeam, awayTeam, ball);
            }
        }

_initUI() {
            // Bind to existing HTML elements
            this.ui.scorePlayer = document.getElementById('score-player');
            this.ui.scoreCpu = document.getElementById('score-cpu');
            this.ui.timer = document.getElementById('timer-display');
            this.ui.half = document.getElementById('half-indicator');
            this.ui.announcement = document.getElementById('announcement');
            
            this.ui.techFlash = document.getElementById('tech-flash-overlay');
            if (this.ui.techFlash) {
                this.ui.techSub = this.ui.techFlash.querySelector('.tech-sub-text');
            }
            this.ui.techTimerFill = document.querySelector('.tech-timer-fill');

            // Bind Player Status Panel
            this.ui.statusPanel.container = document.getElementById('player-status-panel');
            this.ui.statusPanel.name = document.querySelector('#player-status-panel .char-name');
            this.ui.statusPanel.hpBar = document.querySelector('#player-status-panel .hp-bar-fill');
            this.ui.statusPanel.hpText = document.querySelector('#player-status-panel .hp-value');
            this.ui.statusPanel.expBar = document.querySelector('#player-status-panel .tech-bar-fill');
            
            // End Game Menu Bindings
            this.ui.endMenu = document.getElementById('end-game-menu');
            const btnRematch = document.getElementById('end-btn-rematch');
            const btnExit = document.getElementById('end-btn-exit');

            if (btnRematch) {
                btnRematch.addEventListener('click', () => {
                    this._hideEndMenu();
                    this.startMatch(this.gameMode);
                });
            }
            if (btnExit) {
                btnExit.addEventListener('click', () => {
                    this._hideEndMenu();
                    if (window.flux.gameInstance.menuManager) {
                        window.flux.gameInstance.menuManager.show();
                        this.state = 'menu';
                    }
                });
            }

            // Create Modal Overlay (For Halftime only now)
            this.ui.modal = document.createElement('div');
            this.ui.modal.className = 'modal-overlay';
            this.ui.modal.innerHTML = `
                <div class="modal-title">HALF TIME</div>
                <div class="modal-score-container">
                    <div class="modal-score" id="modal-score-home">0</div>
                    <div class="modal-vs">-</div>
                    <div class="modal-score" id="modal-score-away">0</div>
                </div>
                <div id="modal-msg" style="color: #00aaff; font-size: 14px; letter-spacing: 2px;">PREPARING 2ND HALF...</div>
            `;
            this.uiLayer.appendChild(this.ui.modal);

            // Create Flash Overlay
            this.ui.flash = document.createElement('div');
            this.ui.flash.className = 'flash-overlay';
            this.uiLayer.appendChild(this.ui.flash);

            // Initial State
            this._updateScoreUI();
            if (this.ui.timer) this.ui.timer.innerText = "00:00";
        }
        _updateScoreUI() {
            if (this.ui.scorePlayer) this.ui.scorePlayer.innerText = this.score.home;
            if (this.ui.scoreCpu) this.ui.scoreCpu.innerText = this.score.away;
        }

updatePractice(dt) {
            // Delegate logic to PracticeManager
            if (this.practiceManager) {
                this.practiceManager.update(dt);
            }
        }

update(dt) {
            // --- PHYSICS & LOGIC UPDATE (Fixed Timestep) ---
            
            // Intro & Menu are purely visual states, handled in updateVisuals
            if (this.state === 'intro' || this.state === 'menu') return;

            if (this.state === 'blitz_charge') {
                this._updateBlitzCharge(dt);
                return;
            }
            if (this.state === 'blitz_launch') {
                this._updateBlitzLaunch(dt);
                return;
            }

            if (this.state === 'active') {
                this._updateTimer();
                this._checkHalfTime();
            }

            this._checkGoals();
            
            // Update Techcopy Logic (Timer)
            if (this.techCopyState.active) {
                this.techCopyState.timer -= dt;
                if (this.techCopyState.timer <= 0) {
                    this.endTechCopyWindow(false);
                }
            }
        }

        updateVisuals(dt) {
            // --- VISUAL UPDATE (Once Per Frame) ---

            if (this.state === 'intro') {
                // Player Warmup Animations
                this._updateIntroWarmup(dt);

                if (!this.introShots || this.introShots.length === 0) {
                    this.skipIntro();
                    return;
                }

                const shot = this.introShots[this.introShotIndex];
                this.introShotTimer += dt;

                if (this.introShotTimer >= shot.duration) {
                    this.introShotIndex++;
                    this.introShotTimer = 0;
                    
                    if (this.introShotIndex >= this.introShots.length) {
                        this.skipIntro(); // Done
                        return;
                    } else {
                        // Next shot start
                        const nextShot = this.introShots[this.introShotIndex];
                        if (nextShot.onStart) nextShot.onStart();
                    }
                } else {
                    // Update current shot
                    const t = this.introShotTimer / shot.duration;
                    if (this.camera && shot.update) {
                        shot.update(t, this.camera);
                    }
                }
                return;
            }

            if (this.state === 'menu') {
                // --- POPULATE ARENA FOR B-ROLL ---
                const animateTeam = (team) => {
                    if (!team) return;
                    team.players.forEach(p => {
                        if (p.mesh) {
                            p.mesh.visible = true;
                            // Gentle bobbing to simulate treading water
                            p.mesh.position.y = p.homePosition.y + Math.sin(Date.now() * 0.002 + p.mesh.id) * 0.5;
                            // Ensure idle animation is playing
                            if (p.state !== 'idle') p.play('idle', 0.5);
                            if (p.mixer) p.mixer.update(dt);
                        }
                    });
                };
                animateTeam(this.teams.home);
                animateTeam(this.teams.away);

                // --- CINEMATIC B-ROLL ---
                if (this.menuShots && this.menuShots.length > 0) {
                    const shot = this.menuShots[this.menuShotIndex];
                    this.menuShotTimer += dt;
                    
                    if (this.menuShotTimer >= shot.duration) {
                        this.menuShotTimer = 0;
                        this.menuShotIndex = (this.menuShotIndex + 1) % this.menuShots.length;
                    }
                    
                    // Normalize time (0 to 1)
                    const t = this.menuShotTimer / shot.duration;
                    if (this.camera) {
                        shot.update(t, this.camera);
                    }
                }

                // Ambient FX in Menu
                if (this.particleManager && Math.random() < 0.2) {
                    const range = 60;
                    const pos = new THREE.Vector3(
                        (Math.random()-0.5)*range, 
                        -10 + Math.random()*20, 
                        (Math.random()-0.5)*range
                    );
                    this.particleManager.spawn('bubble', pos, { life: 3.0 + Math.random()*2.0, scale: 0.3 + Math.random()*0.4 });
                }

                // Update Background Systems
                if (this.particleManager) this.particleManager.update(dt);
                return;
            }

            // Update Techcopy UI
            if (this.techCopyState.active && this.ui.techTimerFill) {
                const pct = Math.max(0, (this.techCopyState.timer / this.techCopyState.maxTime) * 100);
                this.ui.techTimerFill.style.width = `${pct}%`;
                
                // Color shift based on urgency
                if (pct < 30) this.ui.techTimerFill.style.background = '#ff0000';
                else this.ui.techTimerFill.style.background = 'linear-gradient(90deg, #ffffff, #00ffff)';
            }

            // General Visuals (Always Run except Intro/Menu)
            if (this.state !== 'menu' && this.state !== 'intro') {
                // Update band possession display
                if (window.flux.updateBandPossession && this.entities && this.entities.ball) {
                    const ball = this.entities.ball;
                    const homeHasBall = ball.holder && ball.holder.team && ball.holder.team.isHuman;
                    window.flux.updateBandPossession(homeHasBall);
                }

                if (this.miniMap) this.miniMap.update();
                if (this.floatingText) this.floatingText.update(dt);
                if (this.particleManager) this.particleManager.update(dt);
                this._updateParticles(dt); // Legacy sparks
                this._updateGoalTransparency(); // Dynamic Goal Fading
                if (this.debugVisualizer) this.debugVisualizer.update();
            }
        }

        _updateGoalTransparency() {
            if (!this.camera) return;
            
            const goals = [window.flux.goalA, window.flux.goalB];
            const fadeDist = 35.0; // Distance to start fading
            const minFadeDist = 15.0; // Distance where it's most transparent
            const minOpacity = 0.2;

            goals.forEach(goal => {
                if (!goal) return;

                // Calculate distance from camera to goal position
                const dist = this.camera.position.distanceTo(goal.position);
                
                let opacity = 1.0;
                if (dist < fadeDist) {
                    // Linear fade
                    const t = (dist - minFadeDist) / (fadeDist - minFadeDist);
                    opacity = THREE.MathUtils.clamp(t, 0.0, 1.0) * (1.0 - minOpacity) + minOpacity;
                }

                const isTransparent = opacity < 0.99;

                // Apply to all meshes in goal hierarchy
                goal.traverse(child => {
                    if (child.isMesh && child.material) {
                        const mat = child.material;
                        
                        // Only update if changed to minimize overhead
                        if (Math.abs(mat.opacity - opacity) > 0.01 || mat.transparent !== isTransparent) {
                            mat.opacity = opacity;
                            mat.transparent = isTransparent;
                            // Disable depthWrite when transparent so we can see the ball inside the net
                            mat.depthWrite = !isTransparent;
                            mat.needsUpdate = true;
                        }
                    }
                });
            });
}
        _updateOffscreenIndicator() {
            const p = this.teams.home ? this.teams.home.activePlayer : null;
            const indicator = this.ui.offscreenIndicator;
            
            if (!p || !p.mesh || !this.camera || !indicator) return;

            // 1. Get Player Position (Center Mass)
            const pos = p.mesh.position.clone();
            pos.y += 1.0; 
            
            // 2. Project to Normalized Device Coordinates (NDC) [-1, 1]
            this._tempVec.copy(pos).project(this.camera);
            
            // 3. Check if Behind Camera
            const camFwd = new THREE.Vector3();
            this.camera.getWorldDirection(camFwd);
            const toPlayer = pos.clone().sub(this.camera.position).normalize();
            const dot = camFwd.dot(toPlayer);
            const isBehind = dot < 0.2; // Buffer to prevent flipping at edge

            // 4. Check Bounds
            const isOffScreen = (
                this._tempVec.x < -0.9 || this._tempVec.x > 0.9 ||
                this._tempVec.y < -0.9 || this._tempVec.y > 0.9 ||
                isBehind
            );

            if (isOffScreen) {
                indicator.style.display = 'block';
                
                let x = this._tempVec.x;
                let y = this._tempVec.y;

                // If behind, invert coordinates to point correctly
                if (isBehind) {
                    x = -x;
                    y = -y;
                    // Fix singularity if exactly behind center
                    if (Math.abs(x) < 0.01 && Math.abs(y) < 0.01) y = -1; 
                }

                // Clamp to screen edges
                // We want to find the intersection of the vector (x,y) with the box [-0.9, 0.9]
                const padding = 0.9;
                
                // Normalize to get direction
                const mag = Math.sqrt(x*x + y*y);
                const nx = x / mag;
                const ny = y / mag;
                
                // Raycast to box edges
                // Vertical edges: x = +/- padding
                // Horizontal edges: y = +/- padding
                
                // Avoid divide by zero
                const tx = (Math.abs(nx) > 0.001) ? (nx > 0 ? padding : -padding) / nx : 999;
                const ty = (Math.abs(ny) > 0.001) ? (ny > 0 ? padding : -padding) / ny : 999;
                
                // Use the nearest intersection (smallest positive t)
                // Since we are projecting from center (0,0) to (nx,ny), t must be positive.
                const t = Math.min(Math.abs(tx), Math.abs(ty));
                
                const screenX = nx * t;
                const screenY = ny * t;

                // Convert NDC to Pixels
                const width = window.innerWidth;
                const height = window.innerHeight;
                
                const px = (screenX * 0.5 + 0.5) * width;
                const py = (-(screenY) * 0.5 + 0.5) * height;

                // Calculate Rotation
                // Arrow points UP by default.
                // We want it to point in direction (nx, ny) on screen.
                // Screen Y is down (inverted from WebGL Y).
                // So (0, 1) in NDC is UP. (0, -1) in NDC is DOWN.
                // atan2(y, x) gives angle from +X.
                // We want angle from +Y (Up).
                // Rotation = PI/2 - angle.
                
                const angle = Math.atan2(ny, nx);
                const rot = (Math.PI / 2) - angle;

                indicator.style.transform = `translate(${px}px, ${py}px) rotate(${rot}rad)`;
                
            } else {

                indicator.style.display = 'none';
            }
        }

        _updateTimer() {
            if (!this.ui.timer) return;
            // Clamp to half duration for display if we go slightly over before tick
            const t = Math.min(this.time, this.halfDuration);
            const minutes = Math.floor(t / 60);
            const seconds = Math.floor(t % 60);
            this.ui.timer.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        _checkHalfTime() {
            if (this.time >= this.halfDuration) {
                this.endHalf();
            }
        }

endHalf() {
            this.state = 'halftime';
            
            // Stop all players
            if (this.teams.home) this.teams.home.players.forEach(p => p.setInput(0, 0));
            if (this.teams.away) this.teams.away.players.forEach(p => p.setInput(0, 0));

            if (this.half === 1) {
                this._showModal("HALF TIME", "PREPARING 2ND HALF...");
                
// Optional: Play whistle sound here if available
                if (this.audioManager) this.audioManager.playSFX('whistle');

                setTimeout(() => {
                    this._hideModal();
                    this.startSecondHalf();
                }, 4000);
            } else {
                // End of 2nd Half or Overtime Period
                if (this.score.home === this.score.away) {
                    // TIED - Go to Overtime (Golden Goal)
                    this._showModal("OVERTIME", "GOLDEN GOAL RULE ACTIVE");
                    setTimeout(() => {
                        this._hideModal();
                        this.startOvertime();
                    }, 4000);
                } else {
                    // Winner decided
                    this.endGame();
                }
            }
        }

        startSecondHalf() {
            this.half = 2;
            this.time = 0;
            this.ui.half.innerText = "2nd HALF";
            this.resetRound(null); // Neutral Blitz-off for 2nd half start
        }

        startOvertime() {
            this.half++;
            this.time = 0;
            this.isOvertime = true;
            this.ui.half.innerText = "OVERTIME";
            this.resetRound(null); // Neutral Blitz-off
        }

endGame() {
            this.state = 'gameover';
            
            // Stop players
            if (this.teams.home) this.teams.home.players.forEach(p => p.setInput(0, 0));
            if (this.teams.away) this.teams.away.players.forEach(p => p.setInput(0, 0));

            let msg = "DRAW";
            if (this.score.home > this.score.away) msg = "VICTORY";
            if (this.score.away > this.score.home) msg = "DEFEAT";
            
            // Populate End Game Menu
            if (this.ui.endMenu) {
                const titleEl = document.getElementById('end-result-title');
                const homeScoreEl = document.getElementById('end-score-home');
                const awayScoreEl = document.getElementById('end-score-away');
                
                if (titleEl) {
                    titleEl.innerText = msg;
                    titleEl.style.color = (msg === "VICTORY") ? "#00ffff" : ((msg === "DEFEAT") ? "#ff4444" : "#ffffff");
                }
                if (homeScoreEl) homeScoreEl.innerText = this.score.home;
                if (awayScoreEl) awayScoreEl.innerText = this.score.away;

                this.ui.endMenu.classList.add('active');
                this.setMenuMode(true); // Hide HUD
            }

            // Stop Music on Game Over
            if (this.audioManager) {
                this.audioManager.stopBGM();
            }
        }

        _hideEndMenu() {
            if (this.ui.endMenu) {
                this.ui.endMenu.classList.remove('active');
                this.setMenuMode(false); // Show HUD
            }
        }

        _showModal(title, subtext) {
            if (!this.ui.modal) return;
            
            this.ui.modal.querySelector('.modal-title').innerText = title;
            this.ui.modal.querySelector('#modal-score-home').innerText = this.score.home;
            this.ui.modal.querySelector('#modal-score-away').innerText = this.score.away;
            this.ui.modal.querySelector('#modal-msg').innerText = subtext;
            
            this.ui.modal.classList.add('active');
            
            // Hide HUD elements
            document.getElementById('hud-top').style.opacity = '0';
            document.getElementById('player-status-panel').style.opacity = '0';
        }

        _hideModal() {
            if (!this.ui.modal) return;
            this.ui.modal.classList.remove('active');
            
            // Show HUD elements
            document.getElementById('hud-top').style.opacity = '1';
            document.getElementById('player-status-panel').style.opacity = '1';
        }

_checkGoals() {
            const ball = this.entities.ball;
            if (!ball || !ball.mesh) return;

            const pos = ball.mesh.position;

            // Precise Goal Detection
            // Visual Goal is at Z = +/- 28.
            // We define a "Goal Mouth" box matching Goalie.js (Width 14, Height 8).
// We define a "Goal Mouth" box matching the visual net.
            // Arena Radius is 32. Goal is roughly 22m wide, 18m high.
// Arena Radius is 32. Goal is roughly 22m wide, 18m high.
            const halfWidth = 11.0; // Increased to 11 (Width 22) to catch corners
            const halfHeight = 9.0; // Increased to 9 (Height 18) to catch high shots
const goalYOffset = -6.0; // Moved down to match visual model (-6.0m)

const triggerZ = 40.5; // Trigger earlier (was 43.5) to ensure registration before bounce

            if (Math.abs(pos.z) > triggerZ) {
                // PREVENT OWN GOAL BY CARRIER (User Request)
                // If the ball is held by the team defending this goal, do not count it.
                if (ball.holder) {
                    // Home (Side 1) defends +Z. If pos.z > 0 (Home Goal) and holder is Home, ignore.
                    if (pos.z > 0 && ball.holder.team.side === 1) return;
                    // Away (Side -1) defends -Z. If pos.z < 0 (Away Goal) and holder is Away, ignore.
                    if (pos.z < 0 && ball.holder.team.side === -1) return;
                }

                // 2. Check Frame (Must be within width/height)
// 2. Check Frame (Must be within width/height, accounting for Y offset)
                if (Math.abs(pos.x) <= halfWidth && Math.abs(pos.y - goalYOffset) <= halfHeight) {
                    if (pos.z < 0) {
                        this.goalScored('home'); // Home attacks -Z
                    } else {
                        this.goalScored('away'); // Away attacks +Z
                    }
                }
            }
        }

goalScored(scorer) {
            if (this.state !== 'active') return;
            
            // IMPACT FRAME: GOAL
            this.triggerImpact(0.4, 'shatter'); // Massive freeze for goal
            
            // EXP REWARD: Goal
            // Find who scored (Last holder of ball)
            const ball = this.entities.ball;
            if (ball && ball.lastHolder && ball.lastHolder.team.id === scorer) {
                ball.lastHolder.gainExp(10);
            }

            this.state = 'goal';
            this.score[scorer]++;
            this._updateScoreUI();
            
            // 1. VISCERAL SHAKE & PARTICLES
            if (this.cameraManager) {
                this.cameraManager.addShake(2.0); // Heavy shake
            }
            if (this.particleManager && this.entities.ball && this.entities.ball.mesh) {
                const goalPos = this.entities.ball.mesh.position.clone();
                // Massive Goal Explosion
                this.particleManager.spawn('shockwave', goalPos, { scale: 15.0, life: 0.8 });
                this.particleManager.spawn('flash', goalPos, { scale: 10.0 });
                for(let i=0; i<30; i++) {
                    this.particleManager.spawn('debris', goalPos, { scale: 0.8 });
                }
            }
            // 2. SCREEN FLASH
            if (this.ui.flash) {
                this.ui.flash.style.opacity = '0.8';
                setTimeout(() => { this.ui.flash.style.opacity = '0'; }, 100);
            }

            // 3. GOLDEN GOAL CHECK
            if (this.isOvertime) {
                this.showAnnouncement("GOLDEN GOAL!", 'slam');
                // End game after short delay
                setTimeout(() => {
                    this.endGame();
                }, 3000);
                return;
            }

            // 4. SLAM ANNOUNCEMENT (Normal)
// 4. SLAM ANNOUNCEMENT (Normal)
            this.showAnnouncement("GOAL!", 'slam');
            if (this.audioManager) this.audioManager.playSFX('goal');
            
            // Reset sequence
            // Scored-upon team gets ball
            const loser = scorer === 'home' ? 'away' : 'home';
            
            // FASTER FLOW: Reduced delay from 3000ms to 1200ms
            setTimeout(() => {
                this.resetRound(loser);
            }, 2000); // Slightly longer to appreciate the "GOAL" slam
        }

showAnnouncement(text, type = 'normal', duration = 2000) {
            const el = this.ui.announcement;
            if (!el) return;

            // Clear previous timeout
            if (this._announceTimeout) {
                clearTimeout(this._announceTimeout);
                this._announceTimeout = null;
            }

            // Reset Animation by cloning
            const newEl = el.cloneNode(true);
            el.parentNode.replaceChild(newEl, el);
            this.ui.announcement = newEl;

            newEl.innerText = text;
            newEl.style.display = 'block';
            
            // Apply Class based on type
            newEl.className = ''; // Reset classes
            if (type === 'slam') {
                newEl.classList.add('announcement-slam');
            } else {
                // Default style
                newEl.style.animation = 'none';
                newEl.offsetHeight; /* trigger reflow */
                newEl.style.animation = 'announceSlide 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            }

            // Auto-hide
            if (duration > 0) {
                this._announceTimeout = setTimeout(() => {
                    this.hideAnnouncement();
                }, duration);
            }
        }

        hideAnnouncement() {
            if (this.ui.announcement) {
                this.ui.announcement.style.display = 'none';
            }
        }

resetRound(possessionTeamId) {
            this.state = 'reset';
            
            // Clear persistent visuals
            if (this.glyphManager) this.glyphManager.clear();
            if (this.particleManager) {
                // Optional: Clear particles if needed, though they self-expire quickly
            }
            
            // Reset Ball
            if (this.entities.ball) this.entities.ball.reset();
            if (this.entities.ball) this.entities.ball.reset();
            
            // Reset Teams
            if (this.teams.home) this.teams.home.resetPositions();
            if (this.teams.away) this.teams.away.resetPositions();
            
            // Clear ball holder
            if (this.entities.ball) this.entities.ball.drop();

            // CRITICAL: Snap camera to prevent disorientation
            if (this.cameraManager) {
                // Force update target first (usually ball)
                if (this.entities.ball && this.entities.ball.mesh) {
                    this.cameraManager.setTarget(this.entities.ball.mesh, this.entities.ball.velocity);
                    this.cameraManager.snapToTarget();
                }
            }

            // FASTER FLOW: Reduced delay from 2000ms to 100ms
            setTimeout(() => {
                this.startKickoff(possessionTeamId);
}, 100);
        }

startKickoff(possessionTeamId) {
            // Stop all players immediately
            if (this.teams.home) this.teams.home.players.forEach(p => p.setInput(0, 0));
            if (this.teams.away) this.teams.away.players.forEach(p => p.setInput(0, 0));

            // If a team has possession (after goal), standard kickoff
            if (possessionTeamId) {
                this.state = 'kickoff';
                this.showAnnouncement("BLITZ OFF!", 'slam');
                if (this.audioManager) this.audioManager.playSFX('whistle');

                const team = this.teams[possessionTeamId];
                if (team) {
                    const mf = team.players.find(p => p.role === 'MF');
                    if (mf && this.entities.ball) {
                        this.entities.ball.grab(mf);
                        
                        // Snap camera to new holder
                        if (this.cameraManager) {
                            this.cameraManager.setTarget(mf.mesh, mf.velocity);
                            this.cameraManager.snapToTarget();
                        }
                    }
                }
                
                setTimeout(() => {
                    this.hideAnnouncement();
                    this.state = 'active';
                }, 800);
            } else {
                // NEUTRAL KICKOFF: "The Blitz Off" Cinematic Sequence
                this._startNeutralBlitzOff();
            }
        }

_startNeutralBlitzOff() {
            this.state = 'blitz_charge';
            this.blitzTimer = 0;
            
            // 1. Reset Ball to Center (Deep)
            const ball = this.entities.ball;
            if (ball && ball.mesh) {
                ball.drop();
                ball.mesh.position.set(0, -5, 0); // Start DEEP (-5m) for "ground up" rise
                ball.velocity.set(0, 0, 0);
                ball.angularVelocity.set(0, 0, 0);
                // Reset visuals
                if (ball.deformNode) ball.deformNode.scale.set(1, 1, 1);
            }

            // 2. Position Captains (MFs)
            const homeMF = this.teams.home.players.find(p => p.role === 'MF');
            const awayMF = this.teams.away.players.find(p => p.role === 'MF');

            if (homeMF && homeMF.mesh) {
                homeMF.mesh.position.set(0, 0, 8); // 8m back
                homeMF.mesh.lookAt(0, 0, 0);
                homeMF.play('idle', 0.1);
            }
            if (awayMF && awayMF.mesh) {
                awayMF.mesh.position.set(0, 0, -8); // 8m back
                awayMF.mesh.lookAt(0, 0, 0);
                awayMF.play('idle', 0.1);
            }

            // 3. Camera Focus
            if (this.cameraManager && ball && ball.mesh) {
                this.cameraManager.setTarget(ball.mesh, null);
                this.cameraManager.snapToTarget();
                // Zoom in tight
                this.cameraManager.currentPullBack = -12; 
                this.cameraManager.manualOrbitPitch = 0.4; // Look down steep
            }

            // Build Tension
            this.showAnnouncement("READY...", 'normal');
            if (this.audioManager) this.audioManager.playSFX('swim', { volume: 0.5 });
        }

        _updateBlitzCharge(dt) {
            this.blitzTimer += dt;
            const ball = this.entities.ball;
            if (!ball || !ball.mesh) return;

            const chargeDuration = 2.0; // Longer build up for cinematic feel

            // PHASE 1: CHARGE (Rising from depths)
            if (this.blitzTimer < chargeDuration) {
                const t = this.blitzTimer / chargeDuration;
                const easeT = t * t; // Quadratic ease in
                
                // Rise from -5 to 0 (Ground up effect)
                ball.mesh.position.y = -5.0 + (5.0 * easeT);
                
                // Spin up (Exponential)
                ball.mesh.rotation.y += (10.0 + 50.0 * t) * dt;
                ball.mesh.rotation.x += (5.0 + 20.0 * t) * dt;

                // Squash (Flatten like a disc building energy)
                if (ball.deformNode) {
                    // Extreme squash at the end
                    const squash = 1.0 - (0.7 * easeT); // Flatten Y to 0.3
                    const stretch = 1.0 + (0.5 * easeT); // Expand XZ
                    ball.deformNode.scale.set(stretch, squash, stretch);
                }

                // Camera Shake increasing
                if (this.cameraManager) this.cameraManager.addShake(0.2 * t);

                // Particles: Rising Energy from ground
                if (this.particleManager) {
                    // Bubbles rising fast
                    const count = Math.floor(t * 8) + 1;
                    for(let i=0; i<count; i++) {
                        const angle = Math.random() * Math.PI * 2;
                        const r = 2.0 * (1.0 - t); // Radius shrinks as it gets closer to launch
                        const x = Math.cos(angle) * r;
                        const z = Math.sin(angle) * r;
                        const y = ball.mesh.position.y - 1.0; // Below ball
                        
                        this.particleManager.spawn('bubble', new THREE.Vector3(x, y, z), { 
                            life: 0.4, 
                            scale: 0.2 + t * 0.5 
                        });
                    }
                }
            } 
            // PHASE 2: LAUNCH
            else if (this.state === 'blitz_charge') {
                this.state = 'blitz_launch';
                this.blitzTimer = 0; // Reset for launch phase

                // TIMED ANNOUNCEMENT
                this.showAnnouncement("BLITZ OFF!", 'slam');
                if (this.audioManager) {
                    this.audioManager.playSFX('impact', { volume: 1.0 }); // Boom
                    this.audioManager.playSFX('dash', { volume: 1.0 });   // Whoosh
                }

                // Launch Ball
                ball.velocity.set(0, 35, 0); // Shoot UP FAST
                if (ball.deformNode) ball.deformNode.scale.set(0.4, 3.0, 0.4); // Extreme stretch vertical

                // FX: Massive Ground Eruption
                if (this.particleManager) {
                    this.particleManager.spawn('shockwave', ball.mesh.position, { scale: 8.0 });
                    this.particleManager.spawn('flash', ball.mesh.position, { scale: 6.0 });
                    // Vertical stream
                    for(let i=0; i<10; i++) {
                        const p = ball.mesh.position.clone();
                        p.y += i * 0.5;
                        this.particleManager.spawn('dash_stream', p, { scale: 3.0 });
                    }
                }
                
                if (this.cameraManager) {
                    this.cameraManager.addShake(3.0); // Heavy shake
                    this.cameraManager.currentPullBack = 10; // Zoom out fast
                    this.cameraManager.manualOrbitPitch = 0.0; // Level out
                }

                // Captains Jump
                const homeMF = this.teams.home.players.find(p => p.role === 'MF');
                const awayMF = this.teams.away.players.find(p => p.role === 'MF');

                const jumpTo = (p) => {
                    if (!p || !p.mesh) return;
                    const dir = ball.mesh.position.clone().sub(p.mesh.position).normalize();
                    dir.y = 1.2; // Steep jump
                    p.velocity.copy(dir).multiplyScalar(18.0); // Fast jump
                    p.play('catch_jump', 0.1);
                };

                jumpTo(homeMF);
                jumpTo(awayMF);
            }
        }

        _updateBlitzLaunch(dt) {
            this.blitzTimer += dt;
            const ball = this.entities.ball;
            
            // Apply gravity manually for cinematic feel (Increased gravity for snappier arc)
            ball.velocity.y -= 40.0 * dt; 
            ball.mesh.position.addScaledVector(ball.velocity, dt);

            // Move Players manually
            const updateJumper = (p) => {
                if (!p || !p.mesh) return;
                p.velocity.y -= 25.0 * dt; // Gravity
                p.mesh.position.addScaledVector(p.velocity, dt);
                p.mesh.lookAt(ball.mesh.position);
            };

            const homeMF = this.teams.home.players.find(p => p.role === 'MF');
            const awayMF = this.teams.away.players.find(p => p.role === 'MF');
            
            updateJumper(homeMF);
            updateJumper(awayMF);

            // PHASE 3: GRAB (Apex ~0.7s)
            if (this.blitzTimer > 0.7 && this.state === 'blitz_launch') {
                // Determine Winner (50/50 + Stat bias)
                const homeSp = homeMF.getStat('SP');
                const awaySp = awayMF.getStat('SP');
                const total = homeSp + awaySp;
                const roll = Math.random() * total;
                
                const winner = (roll < homeSp) ? homeMF : awayMF;
                
                ball.grab(winner);
                this.hideAnnouncement();
                
                if (this.floatingText) {
                    this.floatingText.spawn("WON!", winner.mesh.position, "tech");
                }

                // Transition to Active
                this.state = 'active';
                
                // Snap camera to winner
                if (this.cameraManager) {
                    this.cameraManager.setTarget(winner.mesh, winner.velocity);
                    // this.cameraManager.snapToTarget(); // Optional: Keep smooth or snap
                }
            }
        }
        
// Initial start
// Initial start
startMatch(mode = 'normal') {
            this.gameMode = mode;
            console.log("Starting Match in mode:", mode);
            
            // Reset Score
            this.score.home = 0;
            this.score.away = 0;
            this._updateScoreUI();
            
            // Reset Time
            this.time = 0;
            this.half = 1;
            if (this.ui.half) this.ui.half.innerText = "1st";
            
            if (mode === 'practice') {
                if (this.ui.half) this.ui.half.innerText = "PRAC";
                
                // Start Practice Manager
                if (this.practiceManager) {
                    this.practiceManager.start();
                }

                // In practice, ensure AI is enabled for sparring
                if (this.teams.away) {
                    this.teams.away.aiEnabled = true;
                }
                
                // Start BGM immediately for practice
                if (this.audioManager) {
                    this.audioManager.playBGM();
                }

                // Skip intro for practice
                this.resetRound();
            } else {
                // Ensure Practice Manager is stopped if normal game
                if (this.practiceManager) this.practiceManager.stop();
                
                // Safety: Ensure all players are visible (in case Practice hid them)
                if (this.teams.away) {
                    this.teams.away.players.forEach(p => { if(p.mesh) p.mesh.visible = true; });
                    this.teams.away.aiEnabled = true; 
                }
                if (this.teams.home) {
                    this.teams.home.players.forEach(p => { if(p.mesh) p.mesh.visible = true; });
                }

                // Start Cinematic Intro
                this.startIntroSequence();
            }
        }

skipIntro() {
            if (this.state !== 'intro') return;
            console.log("Intro Complete/Skipped");
            
            this.hideAnnouncement();
            
            // RESTORE UI ELEMENTS
// RESTORE UI ELEMENTS
            const uiElements = [
                'hud-top', 
                'player-status-panel', 
                'minimap-container', 
                'goal-distance-container', 
                'action-container', 
                'joystick-hit-zone', 
                'aim-joystick-zone',
                'auto-toggle', 
                'settings-button',
                'controls-hint'
            ];
            
            uiElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = ''; // Revert to CSS default
            });

            // Hide Cinematic Bars
            const bars = document.getElementById('cinematic-bars');
            if (bars) {
                bars.querySelectorAll('.bar').forEach(b => b.style.height = '0');
            }
            
// Lights on
            if (this.stadium) this.stadium.setAllLights(true);
            
            // Reset players to idle
            if (this.teams.home) this.teams.home.players.forEach(p => p.play('idle', 0.1));
            if (this.teams.away) this.teams.away.players.forEach(p => p.play('idle', 0.1));
            
            // Start BGM after intro
            if (this.audioManager) {
                this.audioManager.playBGM();
            }

            this.resetRound(null);
        }

        startIntroSequence() {

            this.state = 'intro';
            this.introShotIndex = 0;
            this.introShotTimer = 0;
            this._hasRoared = false; // Reset roar flag
            
            // Initial setup
            if (this.stadium) this.stadium.setAllLights(false);

            // HIDE ALL UI ELEMENTS
            const uiElements = [
                'hud-top', 
                'player-status-panel', 
                'minimap-container', 
                'goal-distance-container', 
                'action-container', 
                'tackle-button', 
                'joystick-hit-zone', 
                'aim-joystick-zone',
                'joystick-visual-container',
                'aim-joystick-visual',
                'auto-toggle', 
                'settings-button',
                'controls-hint',
                'charge-meter-container',
                'practice-restore-btn'
            ];
            
            uiElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });

            // Show Cinematic Bars
            const bars = document.getElementById('cinematic-bars');
            if (bars) {
                bars.querySelectorAll('.bar').forEach(b => b.style.height = '10%');
            }
            
            if (this.teams.home) this.teams.home.resetPositions();
            if (this.teams.away) this.teams.away.resetPositions();
            if (this.entities.ball) this.entities.ball.reset();
            
            // Trigger first shot start
            if (this.introShots && this.introShots.length > 0) {
                if (this.introShots[0].onStart) this.introShots[0].onStart();
            } else {
                this.skipIntro();
            }
        }
_updateIntroWarmup(dt) {
            const allPlayers = [];
            if (this.teams.home) allPlayers.push(...this.teams.home.players);
            if (this.teams.away) allPlayers.push(...this.teams.away.players);

            allPlayers.forEach(p => {
                if (!p.mesh) return;

                // Ensure mixer updates (since game loop might skip player.update in intro state)
                if (p.mixer) p.mixer.update(dt);

                // Initialize warmup timer if needed
                if (p._warmupTimer === undefined) p._warmupTimer = Math.random() * 2.0;
                
                p._warmupTimer -= dt;

                if (p._warmupTimer <= 0) {
                    // Pick next action time (2s to 5s)
                    p._warmupTimer = 2.0 + Math.random() * 3.0;
                    
                    const rand = Math.random();
                    if (rand < 0.4) {
                        p.play('idle', 0.5);
                    } else if (rand < 0.6) {
                        p.play('swim', 0.5);
                    } else if (rand < 0.8) {
                        // "Stretch" / Celebrate
                        p.play('celebrate', 0.5);
                    } else if (rand < 0.9) {
                        p.play('catch', 0.5); // Checking gloves
                    } else {
                        p.play('react', 0.5); // Shake off
                    }
                }

                // Gentle bobbing (treading water)
                if (p.homePosition) {
                    p.mesh.position.y = p.homePosition.y + Math.sin(Date.now() * 0.003 + p.mesh.id) * 0.3;
                }
            });
        }

setMenuMode(isActive) {
            this.state = isActive ? 'menu' : 'active';
            
            if (isActive && this.audioManager) {
                this.audioManager.stopBGM();
            }
            
            // List of static HUD elements to toggle
            const staticUI = [
                'hud-top',
                'player-status-panel',
                'action-container',
                'joystick-hit-zone',
                'aim-joystick-zone',
                'minimap-container',
                'goal-distance-container',
                'settings-button',
                'auto-toggle',
                'tackle-button',
                'controls-hint'
            ];

            // List of dynamic elements to FORCE HIDE in menu
            const dynamicUI = [
                'joystick-visual-container',
                'aim-joystick-visual',
                'charge-meter-container',
                'tech-flash-overlay',
                'practice-restore-btn'
            ];

            if (isActive) {
                // HIDE ALL
                [...staticUI, ...dynamicUI].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
            } else {
                // SHOW STATIC ONLY
                staticUI.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (id === 'hud-top' || id === 'action-container') el.style.display = 'flex';
                        else el.style.display = 'block';
                    }
                });
                // Dynamic ones remain hidden/controlled by their logic
            }
        }
toggleDemoMode() {
            this.isDemoMode = !this.isDemoMode;
            console.log("Demo Mode:", this.isDemoMode);
            
            // Update UI Button
            const btn = document.getElementById('auto-toggle');
            if (btn) {
                btn.innerText = this.isDemoMode ? "AUTO PILOT" : "MANUAL";
                if (this.isDemoMode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
            
            // Announcement
            const text = this.isDemoMode ? "AUTO PILOT" : "MANUAL";
            this.showAnnouncement(text);
            
            // Visual Flair: Spawn text above active player
            if (this.isDemoMode && this.floatingText && this.teams.home && this.teams.home.activePlayer && this.teams.home.activePlayer.mesh) {
                this.floatingText.spawn("AI ENGAGED", this.teams.home.activePlayer.mesh.position, "goal");
            }

            // Auto-hide announcement
setTimeout(() => {
                if (this.ui.announcement && this.ui.announcement.innerText === text) {
                    this.hideAnnouncement();
                }
            }, 1500);
        }

        // --- TECHCOPY SYSTEM ---

        triggerTechEvent(sourcePlayer, techName) {
            if (!sourcePlayer || !sourcePlayer.team) return;

            // Find opposing team
            const oppTeamId = sourcePlayer.team.id === 'home' ? 'away' : 'home';
            const oppTeam = this.teams[oppTeamId];
            if (!oppTeam) return;

            // Find who is marking this source
            const learners = oppTeam.players.filter(p => p.marking === sourcePlayer);
            
            if (learners.length === 0) return;

            // Only show UI if the learning team is Human (Home)
            // (Or if we are in Demo mode and want to see it happen for Home team)
            if (oppTeam.isHuman) {
                // Filter out those who already know it
                const validLearners = learners.filter(p => !p.learnedTechs.includes(techName));
                if (validLearners.length > 0) {
                    this.startTechCopyWindow(techName, validLearners);
                }
            }
        }

startTechCopyWindow(techName, learners) {
            this.techCopyState.active = true;
            this.techCopyState.maxTime = 0.6; // 0.6s window
            this.techCopyState.timer = this.techCopyState.maxTime;
            this.techCopyState.tech = techName;
            this.techCopyState.learners = learners;
            
            // Show UI
            if (this.ui.techFlash) {
                this.ui.techFlash.style.display = 'flex';
                this.ui.techFlash.style.background = ""; // Reset background
                this.ui.techFlash.querySelector('.tech-text').innerText = "TECHCOPY!";
                
                if (this.ui.techSub) {
                    this.ui.techSub.innerText = techName.replace('_', ' ');
                }
                
                // Reset bar
                if (this.ui.techTimerFill) {
                    this.ui.techTimerFill.style.width = '100%';
                }
            }
        }

attemptTechCopy() {
            if (!this.techCopyState.active) return false;
            
            // Success!
            const tech = this.techCopyState.tech;
            const learners = this.techCopyState.learners;
            
            learners.forEach(p => {
                // Double check to prevent duplicates
                if (!p.learnedTechs.includes(tech)) {
                    p.learnedTechs.push(tech);
                    console.log(`${p.role} learned ${tech}!`);
                    
                    // 1. Floating Text
                    if (this.floatingText && p.mesh) {
                        this.floatingText.spawn(`LEARNED!`, p.mesh.position, "tech");
                    }
                    
                    // 2. Particle Effect (Spiral)
                    if (this.particleManager && p.mesh) {
                        // Spawn multiple particles for a swirl effect
                        for(let i=0; i<10; i++) {
                            setTimeout(() => {
                                this.particleManager.spawn('learned', p.mesh.position);
                            }, i * 50);
                        }
                    }
                }
            });
            
            this.endTechCopyWindow(true);
            return true;
        }

endTechCopyWindow(success) {
            this.techCopyState.active = false;
            if (this.ui.techFlash) {
                if (success) {
                    this.ui.techFlash.querySelector('.tech-text').innerText = "SUCCESS!";
                    // Flash success color (White flash)
                    this.ui.techFlash.style.background = "rgba(255, 255, 255, 0.8)";
                    
                    // Hide after short delay to show the success flash
                    setTimeout(() => { 
                        this.ui.techFlash.style.display = 'none'; 
                    }, 300);
                } else {
                    // Failed / Missed
                    this.ui.techFlash.style.display = 'none';
                }
            }
        }
_updatePlayerStatusUI() {
            if (!this.teams.home || !this.teams.home.activePlayer) return;
            
            const p = this.teams.home.activePlayer;
            const ui = this.ui.statusPanel;
            
// UI Updates (Action Button Context)
                ui.container.style.display = 'block';
                
                // Name & Level
                if (ui.name) ui.name.innerText = `${p.characterName || p.role} LV${p.level}`;
                
                // HP
                if (ui.hpBar) {
                    const hpPct = Math.max(0, Math.min(100, (p.stats.HP / p.stats.maxHP) * 100));
                    ui.hpBar.style.width = `${hpPct}%`;
                    // Color shift
                    if (hpPct < 25) ui.hpBar.style.background = 'linear-gradient(90deg, #ff0000, #ff4444)';
                    else if (hpPct < 50) ui.hpBar.style.background = 'linear-gradient(90deg, #ffff00, #ffff88)';
                    else ui.hpBar.style.background = 'linear-gradient(90deg, #00ff00, #ccffcc)';
                }
                if (ui.hpText) ui.hpText.innerText = `${Math.floor(p.stats.HP)}/${p.stats.maxHP}`;
                
                // EXP
                if (ui.expBar) {
                    const expPct = Math.max(0, Math.min(100, (p.exp / p.nextLevelExp) * 100));
                    ui.expBar.style.width = `${expPct}%`;
ui.expBar.style.width = `${expPct}%`;
                }
        }

_initParticles() {
            this.activeSparks = [];
            this.sparkPool = [];
            const poolSize = 40; // Sufficient for continuous grinding
            
            for (let i = 0; i < poolSize; i++) {
                const sprite = new THREE.Sprite(_sparkMaterial.clone());
                sprite.visible = false;
                this.scene.add(sprite);
                this.sparkPool.push(sprite);
            }
        }

        spawnClash(pos, intensity = 1.0) {
            // Find free spark
            const spark = this.sparkPool.find(s => !s.visible);
            if (!spark) return; // Pool exhausted
            
            spark.position.copy(pos);
            spark.visible = true;
            
            // Randomize rotation
            spark.material.rotation = Math.random() * Math.PI;
            
            // Initialize Active State
            this.activeSparks.push({
                mesh: spark,
                age: 0,
                life: 0.15 + Math.random() * 0.15, // Fast, punchy sparks
                maxScale: 2.5 * intensity,
                velocity: new THREE.Vector3(
                    (Math.random()-0.5)*8, 
                    (Math.random()-0.5)*8, 
                    (Math.random()-0.5)*8
                )
            });
        }

        _updateParticles(dt) {
            for (let i = this.activeSparks.length - 1; i >= 0; i--) {
                const p = this.activeSparks[i];
                p.age += dt;
                
                if (p.age >= p.life) {
                    p.mesh.visible = false;
                    this.activeSparks.splice(i, 1);
                    continue;
                }
                
                const t = p.age / p.life;
                
                // Expand
                const currentScale = 0.5 + (p.maxScale - 0.5) * t;
                p.mesh.scale.setScalar(currentScale);
                
                // Fade out
                p.mesh.material.opacity = 1.0 - (t * t); // Quadratic fade
                
                // Move
                p.mesh.position.addScaledVector(p.velocity, dt);
                p.mesh.material.rotation += 10.0 * dt;
            }
        }

// Helper for impact frames

triggerImpact(duration, type = 'default') {
            this.impactPause = duration;
            
            const container = document.getElementById('game-container');
            if (!container) return;

            // Reset classes to ensure animation restarts
            container.classList.remove('impact-fx', 'impact-heavy', 'impact-shatter');
            
            // Force reflow
            void container.offsetWidth;

            let className = 'impact-fx';
            if (type === 'heavy') className = 'impact-heavy';
            if (type === 'shatter') className = 'impact-shatter';

            container.classList.add(className);

            // Auto-remove class after duration
            setTimeout(() => {
                container.classList.remove(className);
            }, duration * 1000 + 100);
        }
    }

    window.flux.GameManager = GameManager;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class FloatingTextManager {
        constructor(scene, containerId, camera) {
            this.scene = scene;
            this.camera = camera;
            this.container = document.getElementById(containerId);
            this.texts = []; // Active instances
            this.pool = [];  // Inactive instances
            
            // Reusable vector for projection
            this._tempV = new THREE.Vector3();

            // Pre-allocate pool (30 elements)
            this._expandPool(30);
        }

        _expandPool(count) {
            if (!this.container) return;
            for (let i = 0; i < count; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = 'floating-text-wrapper';
                wrapper.style.display = 'none';
                // Force hardware acceleration hint
                wrapper.style.willChange = 'transform, opacity';
                
                const inner = document.createElement('span');
                inner.className = 'floating-text-inner';
                wrapper.appendChild(inner);
                this.container.appendChild(wrapper);

                this.pool.push({
                    el: wrapper,
                    inner: inner,
                    worldPos: new THREE.Vector3(),
                    offset: new THREE.Vector3(),
                    velocity: new THREE.Vector3(),
                    gravity: 0,
                    drag: 0,
                    elasticity: 0.6,
                    floorY: -999,
                    life: 0,
                    maxLife: 1.0,
                    target: null
                });
            }
        }

        spawn(text, worldPos, type = 'default', target = null) {
            if (!this.container || !this.camera) return;

            let instance = this.pool.pop();
            if (!instance) {
                this._expandPool(5);
                instance = this.pool.pop();
            }

            // Reset State
            instance.worldPos.copy(worldPos);
            instance.offset.set(0, 0, 0);
            instance.velocity.set(0, 0, 0);
            instance.gravity = 0;
            instance.drag = 0;
            instance.elasticity = 0.6;
            instance.floorY = -999;
            instance.target = target;
            instance.el.style.display = 'block';
            instance.el.style.opacity = '1';
            // Move offscreen initially to prevent flash
            instance.el.style.transform = 'translate3d(-9999px, -9999px, 0)'; 

            // Update Text & Classes
            instance.inner.innerText = text;
            
            // Smart Class Assignment
            let classes = ['floating-text-inner'];
            classes.push(type);

            const upper = text.toString().toUpperCase();
            if (upper.includes('POISON') || upper.includes('VENOM')) classes.push('venom');
            else if (upper.includes('SLEEP') || upper.includes('NAP') || upper.includes('ZZZ')) classes.push('sleep');
            else if (upper.includes('WITHER')) classes.push('wither');
            else if (type === 'tech' || upper.includes('SHOT') || upper.includes('JECHT') || upper.includes('TACKLE')) classes.push('tech');
            else if (type === 'comic-impact') classes.push('comic-impact');
            else if (type === 'comic-action') classes.push('comic-action');
            else if (!isNaN(parseInt(text)) && type !== 'score') classes.push('damage');
            else if (type === 'save' || type === 'block') classes.push('save');

            instance.inner.className = classes.join(' ');

            // Physics Setup
            if (classes.includes('damage') || classes.includes('save') || classes.includes('block')) {
                instance.target = null;
                instance.gravity = 40.0;
                instance.drag = 0.5;
                instance.floorY = -4.0;
                const spread = 6.0;
                instance.velocity.set(
                    (Math.random() - 0.5) * spread,
                    15.0 + Math.random() * 5.0,
                    (Math.random() - 0.5) * spread
                );
                instance.life = 2.0;
                instance.maxLife = 2.0;
            } else if (classes.includes('comic-impact')) {
                instance.gravity = 0;
                instance.velocity.set((Math.random()-0.5)*2, 1.0, (Math.random()-0.5)*2);
                instance.life = 0.5;
                instance.maxLife = 0.5;
            } else if (classes.includes('comic-action')) {
                instance.gravity = 0;
                instance.velocity.set(0, 2.0, 0);
                instance.life = 0.4;
                instance.maxLife = 0.4;
            } else if (classes.includes('tech')) {
                instance.gravity = 0;
                instance.velocity.set(0, 2.0, 0);
                instance.life = 2.5;
                instance.maxLife = 2.5;
                instance.offset.y = 2.0;
            } else if (classes.includes('sleep')) {
                instance.gravity = -0.5;
                instance.velocity.set(0, 0.5, 0);
                instance.life = 3.0;
                instance.maxLife = 3.0;
            } else {
                instance.velocity.set(0, 3.0, 0);
                instance.gravity = 5.0;
                instance.life = 1.0;
                instance.maxLife = 1.0;
            }

            if (!target) {
                instance.worldPos.x += (Math.random() - 0.5) * 0.5;
                instance.worldPos.z += (Math.random() - 0.5) * 0.5;
            }
            instance.worldPos.y += 1.0;

            this.texts.push(instance);
            this.updatePosition(instance);
        }

        update(dt) {
            for (let i = this.texts.length - 1; i >= 0; i--) {
                const t = this.texts[i];
                t.life -= dt;

                if (t.target && t.target.parent) { 
                    t.worldPos.copy(t.target.position);
                    t.worldPos.y += 1.0; 
                }

                if (t.gravity !== 0 || t.velocity.lengthSq() > 0) {
                    t.velocity.y -= t.gravity * dt;
                    if (t.drag > 0) {
                        t.velocity.multiplyScalar(Math.max(0, 1.0 - (t.drag * dt)));
                    }
                    t.offset.addScaledVector(t.velocity, dt);

                    if (t.offset.y < t.floorY) {
                        t.offset.y = t.floorY;
                        t.velocity.y *= -t.elasticity;
                        t.velocity.x *= 0.7;
                        t.velocity.z *= 0.7;
                        if (Math.abs(t.velocity.y) < 2.0) t.velocity.y = 0;
                    }
                }

                if (t.life <= 0) {
                    t.el.style.display = 'none';
                    this.pool.push(t);
                    this.texts.splice(i, 1);
                } else {
                    this.updatePosition(t);
                    if (t.life < t.maxLife * 0.3) {
                        t.el.style.opacity = t.life / (t.maxLife * 0.3);
                    }
                }
            }
        }

        updatePosition(t) {
            this._tempV.copy(t.worldPos).add(t.offset);
            this._tempV.project(this.camera);

            // Optimization: Check bounds before setting style to avoid unnecessary paint
            if (this._tempV.z > 1 || Math.abs(this._tempV.x) > 1.1 || Math.abs(this._tempV.y) > 1.1) {
                 // Offscreen
                 if (t.el.style.display !== 'none') t.el.style.display = 'none';
            } else {
                if (t.el.style.display === 'none') t.el.style.display = 'block';
                
                const x = (this._tempV.x * .5 + .5) * this.container.clientWidth;
                const y = (-(this._tempV.y * .5) + .5) * this.container.clientHeight;
                
                // Use translate3d for GPU acceleration
                t.el.style.transform = `translate3d(${x.toFixed(1)}px, ${y.toFixed(1)}px, 0)`;
            }
        }
    }

    window.flux.FloatingTextManager = FloatingTextManager;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    // --- TEXTURE GENERATORS ---
    
    // 1. Venom Bubble (Green, shiny, sharp)
    const _venomTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(32, 32, 4, 32, 32, 30);
        g.addColorStop(0, 'rgba(150, 255, 100, 0.9)');
        g.addColorStop(0.8, 'rgba(0, 200, 0, 0.5)');
        g.addColorStop(1, 'rgba(0, 50, 0, 0)');
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(32, 32, 30, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
        ctx.beginPath(); ctx.arc(20, 20, 6, 0, Math.PI*2); ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 2. Sleep Zzz
    const _napTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        ctx.font = 'bold italic 48px sans-serif';
        ctx.fillStyle = '#ffffff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.shadowColor = '#0000ff';
        ctx.shadowBlur = 4;
        ctx.fillText('Z', 32, 32);
        return new THREE.CanvasTexture(c);
    })();

    // 3. Wither Smoke (Optimized to 32x32)
    const _witherTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
        g.addColorStop(0, 'rgba(80, 80, 80, 0.8)');
        g.addColorStop(0.5, 'rgba(40, 40, 40, 0.4)');
        g.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, 32, 32);
        return new THREE.CanvasTexture(c);
    })();

    // 4. Shockwave Ring (Optimized to 64x64)
    const _shockwaveTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        const cx = 32, cy = 32;
        const g = ctx.createRadialGradient(cx, cy, 20, cx, cy, 30);
        g.addColorStop(0, 'rgba(255, 255, 255, 0)');
        g.addColorStop(0.5, 'rgba(255, 255, 255, 1)');
        g.addColorStop(1, 'rgba(255, 255, 255, 0)');
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, 64, 64);
        return new THREE.CanvasTexture(c);
    })();

    // 5. Flash Star (Optimized to 32x32)
    const _flashTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        const cx = 16, cy = 16;
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        for(let i=0; i<4; i++) {
            const a = (i * Math.PI / 2);
            ctx.moveTo(cx, cy);
            ctx.lineTo(cx + Math.cos(a)*15, cy + Math.sin(a)*15);
            ctx.lineTo(cx + Math.cos(a + 0.2)*5, cy + Math.sin(a + 0.2)*5);
        }
        ctx.fill();
        const g = ctx.createRadialGradient(cx, cy, 0, cx, cy, 10);
        g.addColorStop(0, 'rgba(255, 255, 255, 1)');
        g.addColorStop(1, 'rgba(255, 255, 255, 0)');
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(cx, cy, 10, 0, Math.PI*2); ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 6. Debris Shard (New)
    const _debrisTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.moveTo(16, 0); ctx.lineTo(32, 16); ctx.lineTo(16, 32); ctx.lineTo(0, 16);
        ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 7. Bubble Texture (New: Aesthetic & Subtle)
    const _bubbleTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        
        ctx.clearRect(0, 0, 64, 64);

        const g = ctx.createRadialGradient(32, 32, 0, 32, 32, 28);
        g.addColorStop(0, 'rgba(255, 255, 255, 0.95)'); 
        g.addColorStop(0.3, 'rgba(200, 240, 255, 0.4)');
        g.addColorStop(0.8, 'rgba(100, 200, 255, 0.1)');
        g.addColorStop(1, 'rgba(0, 0, 0, 0)');
        
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(32, 32, 30, 0, Math.PI*2); ctx.fill();
        
        ctx.fillStyle = 'rgba(255, 255, 255, 1.0)';
        ctx.beginPath(); 
        ctx.arc(20, 20, 4, 0, Math.PI * 2); 
        ctx.fill();
        
        return new THREE.CanvasTexture(c);
    })();

    // 8. Micro Bubble (New: Sharp, high-vis cavitation)
    const _microBubbleTex = (() => {
        const c = document.createElement('canvas');
        c.width = 32; c.height = 32;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, 32, 32);
        
        const g = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
        g.addColorStop(0, 'rgba(255, 255, 255, 1.0)');
        g.addColorStop(0.3, 'rgba(220, 255, 255, 0.8)');
        g.addColorStop(0.6, 'rgba(100, 200, 255, 0.3)');
        g.addColorStop(1.0, 'rgba(0, 0, 0, 0)');
        
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(16, 16, 16, 0, Math.PI*2); ctx.fill();
        return new THREE.CanvasTexture(c);
    })();

    // 9. Dash Stream (Square for Points)
    const _dashStreamTex = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        
        // Draw a streak in the middle
        const g = ctx.createLinearGradient(0, 0, 64, 0);
        g.addColorStop(0, 'rgba(0, 255, 255, 0)');
        g.addColorStop(0.5, 'rgba(200, 255, 255, 0.8)');
        g.addColorStop(1, 'rgba(0, 255, 255, 0)');
        
        ctx.fillStyle = g;
        ctx.fillRect(0, 28, 64, 8); // Centered vertically
        
        return new THREE.CanvasTexture(c);
    })();

    // --- PARTICLE BATCH SYSTEM (THREE.Points) ---
    class ParticleBatch {
        constructor(scene, texture, maxParticles = 200, blending = THREE.AdditiveBlending) {
            this.maxParticles = maxParticles;
            this.activeCount = 0;
            
            // CPU State
            this.particles = [];
            for(let i=0; i<maxParticles; i++) {
                this.particles.push({
                    active: false,
                    pos: new THREE.Vector3(),
                    vel: new THREE.Vector3(),
                    life: 0,
                    maxLife: 1,
                    scale: 1,
                    startScale: 1,
                    rotation: 0,
                    gravity: 0,
                    drag: 0,
                    color: new THREE.Color(1,1,1),
                    opacity: 1
                });
            }

            // GPU Buffers
            this.positions = new Float32Array(maxParticles * 3);
            this.sizes = new Float32Array(maxParticles);
            this.rotations = new Float32Array(maxParticles);
            this.opacities = new Float32Array(maxParticles);
            this.colors = new Float32Array(maxParticles * 3);

            const geo = new THREE.BufferGeometry();
            geo.setAttribute('position', new THREE.BufferAttribute(this.positions, 3));
            geo.setAttribute('size', new THREE.BufferAttribute(this.sizes, 1));
            geo.setAttribute('rotation', new THREE.BufferAttribute(this.rotations, 1));
            geo.setAttribute('opacity', new THREE.BufferAttribute(this.opacities, 1));
            geo.setAttribute('color', new THREE.BufferAttribute(this.colors, 3));

            // Shader Material
            const mat = new THREE.ShaderMaterial({
                uniforms: {
                    map: { value: texture }
                },
                vertexShader: `
                    attribute float size;
                    attribute float rotation;
                    attribute float opacity;
                    attribute vec3 color;
                    varying float vRotation;
                    varying float vOpacity;
                    varying vec3 vColor;
                    void main() {
                        vRotation = rotation;
                        vOpacity = opacity;
                        vColor = color;
                        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
                        gl_Position = projectionMatrix * mvPosition;
                        // Size attenuation
                        gl_PointSize = size * (300.0 / -mvPosition.z);
                    }
                `,
                fragmentShader: `
                    uniform sampler2D map;
                    varying float vRotation;
                    varying float vOpacity;
                    varying vec3 vColor;
                    void main() {
                        vec2 uv = gl_PointCoord;
                        vec2 centered = uv - 0.5;
                        float c = cos(vRotation);
                        float s = sin(vRotation);
                        vec2 rotated = vec2(centered.x * c - centered.y * s, centered.x * s + centered.y * c) + 0.5;
                        vec4 tex = texture2D(map, rotated);
                        gl_FragColor = vec4(tex.rgb * vColor, tex.a * vOpacity);
                    }
                `,
                transparent: true,
                depthWrite: false,
                blending: blending
            });

            this.mesh = new THREE.Points(geo, mat);
            this.mesh.frustumCulled = false;
            scene.add(this.mesh);
            
            // Logic hook
            this.updateLogic = null;
        }

        spawn(pos, options) {
            // Find first inactive
            let p = null;
            for(let i=0; i<this.maxParticles; i++) {
                if(!this.particles[i].active) {
                    p = this.particles[i];
                    break;
                }
            }
            
            if (!p) return; // Pool full

            p.active = true;
            p.pos.copy(pos);
            p.life = options.life || 1.0;
            p.maxLife = p.life;
            p.startScale = options.scale || 1.0;
            p.scale = p.startScale;
            p.rotation = options.rotation || 0;
            p.vel.copy(options.velocity || new THREE.Vector3());
            p.gravity = options.gravity || 0;
            p.drag = options.drag || 0;
            if (options.color) p.color.set(options.color);
            else p.color.setHex(0xffffff);
            p.opacity = 1.0;
        }

        update(dt) {
            let activeCount = 0;
            
            for(let i=0; i<this.maxParticles; i++) {
                const p = this.particles[i];
                if (!p.active) {
                    this.sizes[i] = 0; // Hide
                    continue;
                }

                p.life -= dt;
                if (p.life <= 0) {
                    p.active = false;
                    this.sizes[i] = 0;
                    continue;
                }

                // Physics
                if (p.gravity !== 0) p.vel.y -= p.gravity * dt;
                if (p.drag !== 0) p.vel.multiplyScalar(Math.max(0, 1.0 - p.drag * dt));
                p.pos.addScaledVector(p.vel, dt);

                // Logic
                const t = 1.0 - (p.life / p.maxLife);
                if (this.updateLogic) {
                    this.updateLogic(p, t, dt);
                } else {
                    p.opacity = 1.0 - t;
                }

                // Update Buffers
                this.positions[i*3] = p.pos.x;
                this.positions[i*3+1] = p.pos.y;
                this.positions[i*3+2] = p.pos.z;
                
                this.sizes[i] = p.scale;
                this.rotations[i] = p.rotation;
                this.opacities[i] = p.opacity;
                
                this.colors[i*3] = p.color.r;
                this.colors[i*3+1] = p.color.g;
                this.colors[i*3+2] = p.color.b;

                activeCount++;
            }

            if (activeCount > 0 || this.activeCount > 0) {
                this.mesh.geometry.attributes.position.needsUpdate = true;
                this.mesh.geometry.attributes.size.needsUpdate = true;
                this.mesh.geometry.attributes.rotation.needsUpdate = true;
                this.mesh.geometry.attributes.opacity.needsUpdate = true;
                this.mesh.geometry.attributes.color.needsUpdate = true;
            }
            this.activeCount = activeCount;
        }
    }

    class ParticleManager {
        constructor(scene) {
            this.scene = scene;
            this.batches = {};
            
            // Initialize Batches
            this._createBatch('venom', _venomTex, 100, THREE.AdditiveBlending, (p, t) => {
                p.pos.x += Math.sin(t * 10 + p.pos.y) * 0.05;
                p.opacity = 0.8 * (1.0 - Math.pow(t, 3));
            });

            this._createBatch('nap', _napTex, 50, THREE.NormalBlending, (p, t) => {
                p.scale = p.startScale * (0.5 + t * 1.5);
                p.opacity = 1.0 - Math.pow(t, 2);
                p.pos.x += Math.sin(t * 5) * 0.02;
            });

            this._createBatch('wither', _witherTex, 100, THREE.NormalBlending, (p, t) => {
                p.opacity = 0.6 * (1.0 - t);
                p.rotation += 0.05;
            });

            this._createBatch('learned', _venomTex, 50, THREE.AdditiveBlending, (p, t) => {
                p.opacity = 1.0 - t;
                p.color.setHex(0x00ffff);
            });

            this._createBatch('shockwave', _shockwaveTex, 20, THREE.AdditiveBlending, (p, t) => {
                p.scale = p.startScale * Math.pow(t, 0.5) * 5.0;
                p.opacity = 1.0 - Math.pow(t, 2);
            });

            this._createBatch('flash', _flashTex, 50, THREE.AdditiveBlending, (p, t) => {
                p.scale = p.startScale * (1.0 - t);
                p.rotation += 0.2;
            });

            this._createBatch('debris', _debrisTex, 100, THREE.NormalBlending, (p, t) => {
                p.rotation += 0.2;
                p.scale = p.startScale * (1.0 - t);
            });

            this._createBatch('bubble', _bubbleTex, 200, THREE.AdditiveBlending, (p, t) => {
                p.pos.x += Math.sin(t * 10 + p.pos.z) * 0.02;
                p.scale = p.startScale * (1.0 + t * 0.2);
                p.opacity = 0.6 * (1.0 - Math.pow(t, 2));
                p.color.setHex(0xaaccff);
            });

            this._createBatch('bubble_micro', _microBubbleTex, 300, THREE.AdditiveBlending, (p, t) => {
                p.scale = p.startScale * (1.0 - t);
                p.opacity = 0.9 * (1.0 - t);
            });

            this._createBatch('dash_stream', _dashStreamTex, 100, THREE.AdditiveBlending, (p, t) => {
                p.opacity = 0.8 * (1.0 - t);
            });
        }

        _createBatch(name, tex, count, blending, logic) {
            const batch = new ParticleBatch(this.scene, tex, count, blending);
            if (logic) batch.updateLogic = logic;
            this.batches[name] = batch;
        }

        spawn(type, pos, options = {}) {
            const batch = this.batches[type];
            if (batch) {
                // Default physics params if not provided
                const opts = { ...options };
                
                if (type === 'venom') {
                    opts.life = opts.life || 1.0 + Math.random() * 0.5;
                    opts.velocity = new THREE.Vector3(0, 1.0 + Math.random(), 0);
                    opts.scale = 0.3 + Math.random() * 0.2;
                } else if (type === 'nap') {
                    opts.life = 2.0;
                    opts.velocity = new THREE.Vector3((Math.random()-0.5)*0.2, 0.5, (Math.random()-0.5)*0.2);
                    opts.scale = 0.4;
                } else if (type === 'wither') {
                    opts.life = 1.5;
                    opts.velocity = new THREE.Vector3((Math.random()-0.5)*0.5, 0.5, (Math.random()-0.5)*0.5);
                    opts.rotation = Math.random() * Math.PI;
                } else if (type === 'shockwave') {
                    opts.life = opts.life || 0.4;
                    opts.scale = opts.scale || 2.0;
                } else if (type === 'flash') {
                    opts.life = 0.2;
                    opts.scale = opts.scale || 3.0;
                    opts.rotation = Math.random() * Math.PI;
                } else if (type === 'debris') {
                    opts.life = 1.5;
                    const speed = 5.0 + Math.random() * 10.0;
                    opts.velocity = new THREE.Vector3(
                        (Math.random()-0.5) * speed,
                        (Math.random() * speed * 0.5) + 2.0,
                        (Math.random()-0.5) * speed
                    );
                    opts.gravity = 20.0;
                    opts.drag = 1.0;
                    opts.scale = (opts.scale || 0.3) * (0.5 + Math.random());
                    opts.rotation = Math.random() * Math.PI;
                } else if (type === 'bubble') {
                    opts.life = 1.0 + Math.random() * 1.0;
                    opts.velocity = new THREE.Vector3(
                        (Math.random() - 0.5) * 0.5,
                        0.5 + Math.random() * 1.0,
                        (Math.random() - 0.5) * 0.5
                    );
                    opts.scale = (opts.scale || 0.15) * (0.8 + Math.random() * 0.4);
                } else if (type === 'bubble_micro') {
                    opts.life = 0.4 + Math.random() * 0.4;
                    opts.velocity = new THREE.Vector3(
                        (Math.random() - 0.5) * 1.5,
                        1.5 + Math.random() * 2.0,
                        (Math.random() - 0.5) * 1.5
                    );
                    opts.scale = (opts.scale || 0.15) * (0.8 + Math.random() * 0.5);
                } else if (type === 'dash_stream') {
                    opts.life = 0.3;
                    opts.scale = opts.scale || 2.0;
                    opts.rotation = Math.random() * Math.PI;
                }

                batch.spawn(pos, opts);
            }
        }

        update(dt) {
            for (const key in this.batches) {
                this.batches[key].update(dt);
            }
        }
    }

    window.flux.ParticleManager = ParticleManager;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // --- TEXTURE GENERATION ---
    const _createGlyphTexture = (colorStr, type) => {
        const size = 256;
        const c = document.createElement('canvas');
        c.width = size; c.height = size;
        const ctx = c.getContext('2d');
        
        ctx.clearRect(0, 0, size, size);
        
        // Glow settings
        ctx.shadowBlur = 15;
        ctx.shadowColor = colorStr;
        ctx.strokeStyle = colorStr;
        ctx.fillStyle = colorStr;
        ctx.lineCap = 'round';

        const cx = size / 2;
        const cy = size / 2;

        if (type === 'ring') {
            // Outer Ring
            ctx.lineWidth = 6;
            ctx.beginPath();
            ctx.arc(cx, cy, 110, 0, Math.PI * 2);
            ctx.stroke();

            // Inner Ring
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(cx, cy, 90, 0, Math.PI * 2);
            ctx.stroke();

            // Runes
ctx.font = '24px Spira, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            for(let i=0; i<8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const r = 100;
                const x = cx + Math.cos(angle) * r;
                const y = cy + Math.sin(angle) * r;
                
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(angle + Math.PI/2);
                // Draw a simple rune-like shape
                ctx.beginPath();
                ctx.moveTo(-5, -5); ctx.lineTo(5, 0); ctx.lineTo(-5, 5);
                ctx.stroke();
                ctx.restore();
            }
        } else if (type === 'rune') {
            // Central Complex Rune
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.arc(cx, cy, 60, 0, Math.PI * 2);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(cx, cy - 60);
            ctx.lineTo(cx, cy + 60);
            ctx.moveTo(cx - 60, cy);
            ctx.lineTo(cx + 60, cy);
            ctx.stroke();

            ctx.beginPath();
            ctx.arc(cx, cy, 20, 0, Math.PI * 2);
            ctx.fill();
        }

        const tex = new THREE.CanvasTexture(c);
        return tex;
    };

    const _techTexture = _createGlyphTexture('#00ffff', 'ring'); // Cyan Ring
    const _statusTexture = _createGlyphTexture('#ff00ff', 'rune'); // Magenta Rune
    const _chargeTexture = _createGlyphTexture('#ffff00', 'ring'); // Gold Ring

    class GlyphManager {
        constructor(scene) {
            this.scene = scene;
            this.glyphs = [];
            
            // Materials
            this.materials = {
                tech: new THREE.MeshBasicMaterial({ 
                    map: _techTexture, 
                    transparent: true, 
                    side: THREE.DoubleSide, 
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    color: 0xffffff
                }),
                status: new THREE.MeshBasicMaterial({ 
                    map: _statusTexture, 
                    transparent: true, 
                    side: THREE.DoubleSide, 
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    color: 0xffffff
                }),
                charge: new THREE.MeshBasicMaterial({ 
                    map: _chargeTexture, 
                    transparent: true, 
                    side: THREE.DoubleSide, 
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    color: 0xffffff
                })
            };

            // Pool
            this.pool = [];
            this.poolSize = 30;
            const geo = new THREE.PlaneGeometry(1, 1);
            
            for(let i=0; i<this.poolSize; i++) {
                const mesh = new THREE.Mesh(geo, this.materials.tech);
                mesh.visible = false;
                mesh.renderOrder = 2000; // Draw on top of water/arena
                this.scene.add(mesh);
                this.pool.push(mesh);
            }
        }

        spawn(type, pos, options = {}) {
            const mesh = this.pool.find(m => !m.visible);
            if (!mesh) return;

            mesh.visible = true;
            mesh.material = this.materials[type] || this.materials.tech;
            mesh.position.copy(pos);
            
            // Reset Material Opacity
            mesh.material.opacity = 1.0;

            // Defaults
            const scale = options.scale || 1.0;
            mesh.scale.set(scale, scale, scale);
            
            // Orientation
            if (options.faceCamera) {
                if (window.flux.gameInstance && window.flux.gameInstance.camera) {
                    mesh.lookAt(window.flux.gameInstance.camera.position);
                }
            } else if (options.orientation === 'vertical') {
                mesh.rotation.set(0, 0, 0);
                // Face camera Y-axis rotation only
                if (window.flux.gameInstance && window.flux.gameInstance.camera) {
                    const camPos = window.flux.gameInstance.camera.position;
                    const angle = Math.atan2(camPos.x - pos.x, camPos.z - pos.z);
                    mesh.rotation.y = angle;
                }
            } else {
                // Horizontal (Ground)
                mesh.rotation.set(-Math.PI / 2, 0, Math.random() * Math.PI);
            }

            if (options.offsetY) {
                mesh.position.y += options.offsetY;
            }

            this.glyphs.push({
                mesh: mesh,
                age: 0,
                life: options.life || 1.0,
                maxLife: options.life || 1.0,
                rotationSpeed: options.rotationSpeed || 1.0,
                scaleSpeed: options.scaleSpeed || 0,
                fade: options.fade !== undefined ? options.fade : true,
                followTarget: options.parent || null,
                offsetY: options.offsetY || 0
            });
        }
update(dt) {
            for (let i = this.glyphs.length - 1; i >= 0; i--) {
                const g = this.glyphs[i];
                g.age += dt;

                if (g.age >= g.life) {
                    g.mesh.visible = false;
                    this.glyphs.splice(i, 1);
                    continue;
                }

                const t = g.age / g.maxLife;

                // Follow target
                if (g.followTarget && g.followTarget.mesh) {
                    g.mesh.position.copy(g.followTarget.mesh.position);
                    g.mesh.position.y += g.offsetY;
                    
                    // If ground oriented, keep near floor
                    if (g.mesh.rotation.x === -Math.PI/2) {
                         g.mesh.position.y = 0.1 + g.offsetY;
                    }
                }

                // Animation
                g.mesh.rotation.z += g.rotationSpeed * dt;
                
                if (g.scaleSpeed !== 0) {
                    const s = g.mesh.scale.x + g.scaleSpeed * dt;
                    g.mesh.scale.set(s, s, s);
                }

                // Fade
                if (g.fade) {
                    let opacity = 1.0;
                    if (t < 0.1) opacity = t / 0.1;
                    else if (t > 0.7) opacity = 1.0 - ((t - 0.7) / 0.3);
                    g.mesh.material.opacity = opacity;
                }
            }
        }

        clear() {
            // Hide all active glyphs and reset list
            for (const g of this.glyphs) {
                if (g.mesh) g.mesh.visible = false;
            }
            this.glyphs = [];
        }
    }

    window.flux.GlyphManager = GlyphManager;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    // Reusable vectors to avoid Garbage Collection
    const _idealPos = new THREE.Vector3();
    const _idealLook = new THREE.Vector3();
    const _currentPos = new THREE.Vector3();
    const _currentLook = new THREE.Vector3();
    const _velocity = new THREE.Vector3();
    const _targetWorldPos = new THREE.Vector3();
    const _camOffset = new THREE.Vector3();
    const _lookAhead = new THREE.Vector3();
    const _goalPos = new THREE.Vector3();
    const _camFwd = new THREE.Vector3();
    const _camRight = new THREE.Vector3();

    class CameraManager {
        constructor(camera, scene) {
            this.camera = camera;
            this.scene = scene;

            // --- IMPROVED CONFIGURATION ---
// --- IMPROVED CONFIGURATION ---
            this.config = {
                // FIXED PERSPECTIVE SETTINGS
                baseDistance: 20.0,   // Slightly closer for immersion
                baseHeight: 12.0,     // Lower angle for chase feel

                // IMPROVED: Faster, more responsive smoothing
                followSpeed: 6.0,     // Snappier follow
                lookSpeed: 4.0,       // Responsive look-at

                // Dynamic FOV
                fovBase: 50,
                fovMax: 70,           // Higher max for speed sensation

                // IMPROVED: Look-ahead settings
                lookAheadDistance: 10.0, // Look further ahead
                lookAheadSmoothing: 4.0,

                // Smart framing
                ballTrackWeight: 0.15, 
                threatAwareness: true
            };

            // State
            this.target = null;
            this.ball = null; // Direct ball reference for smart framing
            this.targetVel = new THREE.Vector3();
            this.targetInput = new THREE.Vector3();
            this.smoothedInput = new THREE.Vector3();
            this.smoothedLookAhead = new THREE.Vector3();

            // Camera State
            this.pos = camera.position.clone();
            this.lookAt = new THREE.Vector3(0, 0, 0);

            // Orbit State
            this.currentYaw = Math.PI;
            this.targetYaw = Math.PI;

            // IMPROVED: Manual orbit from touch (right side of screen)
            this.manualOrbitYaw = 0;
            this.manualOrbitPitch = 0;
            this.orbitSensitivity = 0.004;
            this.autoRecenterTimer = 0;
            this.autoRecenterDelay = 3.0;

// Shake
            this.shakeIntensity = 0;
            this.shakeRoll = 0; // NEW: Rotational shake
this.shakeOffset = new THREE.Vector3();
            this.fovImpulse = 0;
            this.rollImpulse = 0; // NEW: Dynamic tilt for curves

            // Cinematic State
            this.isCinematic = false;
            this.cinematicTimer = 0;
            this.cinematicDuration = 0;
            this.cinematicType = 'default';
            this.cinematicStartPos = new THREE.Vector3();
            this.cinematicStartLook = new THREE.Vector3();
            this.cinematicEndPos = new THREE.Vector3();

            // IMPROVED: Dynamic pull-back based on action
            this.currentPullBack = 0;
            this.maxPullBack = 8;
        }

        // NEW: Set ball reference for smart framing
        setBall(ball) {
            this.ball = ball;
        }

        // IMPROVED: Get camera-relative input transformation
        getCameraRelativeInput(inputX, inputZ) {
            this.camera.getWorldDirection(_camFwd);
            _camFwd.y = 0;

            if (_camFwd.lengthSq() < 0.001) {
                _camFwd.set(0, 0, -1);
            } else {
                _camFwd.normalize();
            }

            _camRight.crossVectors(new THREE.Vector3(0, 1, 0), _camFwd).normalize();

            // Transform input to world space
            const worldX = (inputX * _camRight.x) + (inputZ * _camFwd.x);
            const worldZ = (inputX * _camRight.z) + (inputZ * _camFwd.z);

            return { x: worldX, z: worldZ };
        }

        // NEW: Manual orbit input from touch
        handleOrbitInput(dx, dy) {
            this.manualOrbitYaw += dx * this.orbitSensitivity;
            this.manualOrbitPitch += dy * this.orbitSensitivity * 0.5;

            // Clamp pitch
            this.manualOrbitPitch = Math.max(-0.3, Math.min(0.5, this.manualOrbitPitch));

            // Reset auto-recenter timer
            this.autoRecenterTimer = 0;
        }

        // NEW: Recenter camera
        recenter() {
            this.manualOrbitYaw = 0;
            this.manualOrbitPitch = 0;
        }

        playCinematic(type, target, duration = 1.5) {
            this.isCinematic = true;
            this.cinematicTimer = 0;
            this.cinematicDuration = duration;
            this.target = target;
            this.cinematicType = type;

            this.cinematicStartPos.copy(this.pos);
            this.cinematicStartLook.copy(this.lookAt);

            this.addFovImpulse(-15);
        }

        _updateCinematic(dt) {
            this.cinematicTimer += dt;
            const progress = Math.min(1.0, this.cinematicTimer / this.cinematicDuration);

            const t = 1 - Math.pow(1 - progress, 3);

            let activeTarget = this.target;
            let isBallTracking = false;
            const ball = window.flux.gameInstance ? window.flux.gameInstance.entities.ball : null;

            if (ball && ball.mesh && ball.state === 'free' && ball.velocity.lengthSq() > 2.0) {
                activeTarget = ball.mesh;
                isBallTracking = true;
            }

            if (!activeTarget) {
                this.isCinematic = false;
                return;
            }

            activeTarget.getWorldPosition(_targetWorldPos);

            const endLook = _targetWorldPos.clone();
            let fwd = new THREE.Vector3();
            let right = new THREE.Vector3();

            if (isBallTracking) {
                endLook.addScaledVector(ball.velocity, 0.3);

                fwd.copy(ball.velocity).normalize();
                fwd.y = 0;
                if (fwd.lengthSq() < 0.01) fwd.set(0,0,1);
                fwd.normalize();

                right.crossVectors(new THREE.Vector3(0,1,0), fwd).normalize();
            } else {
                endLook.y += 1.5;
                fwd.set(0, 0, 1).applyQuaternion(activeTarget.quaternion);
                right.set(1, 0, 0).applyQuaternion(activeTarget.quaternion);
            }

            const endPos = _targetWorldPos.clone();

            if (this.cinematicType === 'jecht') {
                const dist = isBallTracking ? 14.0 : 10.0;
                const offset = fwd.clone().multiplyScalar(-dist).add(right.clone().multiplyScalar(3.0));
                endPos.add(offset);
                endPos.y += 6.0;
            } else if (this.cinematicType === 'sphere') {
                const dist = isBallTracking ? 16.0 : 12.0;
                const offset = fwd.clone().multiplyScalar(-dist);
                endPos.add(offset);
                endPos.y += 10.0;
            } else if (this.cinematicType === 'invisible') {
                const dist = 12.0;
                const offset = fwd.clone().multiplyScalar(-dist * 0.5).add(right.clone().multiplyScalar(dist));
                endPos.add(offset);
                endPos.y += 5.0;
            } else {
                const dist = isBallTracking ? 14.0 : 10.0;
                const offset = fwd.clone().multiplyScalar(-dist);
                endPos.add(offset);
                endPos.y += 5.0;
            }

            this.pos.lerp(endPos, dt * 4.0);
            this.lookAt.lerp(endLook, dt * 6.0);

            this.camera.position.copy(this.pos);
            this.camera.lookAt(this.lookAt);

            if (this.cinematicTimer >= this.cinematicDuration) {
                this.isCinematic = false;
            }
        }

setTarget(mesh, velocity, input, isAiming = false) {
            this.target = mesh;
            if (velocity) this.targetVel.copy(velocity);
            if (input) this.targetInput.copy(input);
            else this.targetInput.set(0, 0, 0);
            this.isAiming = isAiming;
        }

        // Keep for compatibility
        handleInput(dx, dy) {
            this.handleOrbitInput(dx, dy);
        }

        getYaw() { return this.currentYaw; }

        addShake(amount) {

            this.shakeIntensity = Math.min(this.shakeIntensity + amount, 4.0); // Increased cap
            this.shakeRoll = Math.min(this.shakeRoll + amount * 0.2, 0.8); // Add roll
        }
        addFovImpulse(amount) {
            this.fovImpulse = Math.min(this.fovImpulse + amount, 30);

        }
        addRollImpulse(amount) {
            this.rollImpulse += amount;
            // Clamp
            this.rollImpulse = Math.max(-0.5, Math.min(0.5, this.rollImpulse));
}

        snapToTarget() {
            if (!this.target) return;
            this.target.getWorldPosition(_targetWorldPos);

            this._calculateIdealState(0);

            this.pos.copy(_idealPos);
            this.lookAt.copy(_idealLook);
            this.currentYaw = this.targetYaw;

            this.camera.position.copy(this.pos);
            this.camera.lookAt(this.lookAt);

            this.smoothedInput.set(0, 0, 0);
            this.smoothedLookAhead.set(0, 0, 0);
        }

        update(dt) {
            if (this.isCinematic) {
                this._updateCinematic(dt);
                return;
            }

            if (!this.target) return;

            const safeDt = Math.min(dt, 0.05);

            // IMPROVED: Auto-recenter logic (Only if not aiming)
            if (!this.isAiming) {
                this.autoRecenterTimer += safeDt;
                if (this.autoRecenterTimer > this.autoRecenterDelay) {
                    const recenterSpeed = 2.0 * safeDt;
                    this.manualOrbitYaw *= (1.0 - recenterSpeed);
                    this.manualOrbitPitch *= (1.0 - recenterSpeed);
                }
            }

            // IMPROVED: Smart pull-back based on ball speed
            if (this.ball && this.ball.velocity) {
                const ballSpeed = this.ball.velocity.length();
                const targetPullBack = Math.min(this.maxPullBack, ballSpeed * 0.3);
                this.currentPullBack += (targetPullBack - this.currentPullBack) * safeDt * 3.0;
            } else {
                this.currentPullBack *= (1.0 - safeDt * 2.0);
            }

            // 1. Update Target Info
            this.target.getWorldPosition(_targetWorldPos);

            // 2. Calculate Ideal State
            this._calculateIdealState(safeDt);

            // 3. IMPROVED: Faster, more responsive smoothing
// 3. IMPROVED: Faster, more responsive smoothing
            // Dynamic follow speed based on distance error (Catch-up logic)
            const distError = this.pos.distanceTo(_idealPos);
            const dynamicFollow = this.config.followSpeed + (distError * 0.2);
            
            const speedMult = this.isAiming ? 2.0 : 1.0;
            const lookFactor = 1.0 - Math.exp(-this.config.lookSpeed * speedMult * safeDt);
            const posFactor = 1.0 - Math.exp(-dynamicFollow * speedMult * safeDt);

            this.pos.lerp(_idealPos, posFactor);
            this.pos.lerp(_idealPos, posFactor);
            this.lookAt.lerp(_idealLook, lookFactor);

            // 4. Screen Shake (Position & Rotation)
            if (this.shakeIntensity > 0) {
                const decay = 8.0 * safeDt; // Fast decay for snappy feel
                this.shakeIntensity -= decay;
                if (this.shakeIntensity < 0) this.shakeIntensity = 0;

                const shakeMag = this.shakeIntensity * 0.5;
                this.shakeOffset.set(
                    (Math.random() - 0.5) * shakeMag,
                    (Math.random() - 0.5) * shakeMag,
                    (Math.random() - 0.5) * shakeMag
                );
            } else {
                this.shakeOffset.set(0, 0, 0);
            }

            // Roll Shake
            if (this.shakeRoll > 0) {
                this.shakeRoll -= 5.0 * safeDt;
                if (this.shakeRoll < 0) this.shakeRoll = 0;
                this.camera.rotation.z = (Math.random() - 0.5) * this.shakeRoll;
} else {
                this.camera.rotation.z = 0;
            }
            
            // Apply Curve Tilt (Roll Impulse)
            if (Math.abs(this.rollImpulse) > 0.001) {
                this.camera.rotation.z += this.rollImpulse;
                this.rollImpulse *= (1.0 - 4.0 * safeDt); // Decay
            }

            // 5. Dynamic FOV
// 5. Dynamic FOV
            const speed = this.targetVel.length();
            const speedRatio = Math.min(speed / 25.0, 1.0);
            const warp = speedRatio * speedRatio;

            // Zoom in slightly when aiming
            const aimZoom = this.isAiming ? -10 : 0;
            const targetFov = this.config.fovBase + (this.config.fovMax - this.config.fovBase) * warp + this.fovImpulse + aimZoom;

            this.fovImpulse *= Math.max(0, 1.0 - (6.0 * safeDt));

            this.camera.fov += (targetFov - this.camera.fov) * 4.0 * safeDt;
            this.camera.updateProjectionMatrix();

            // 6. Apply to Camera
            this.camera.position.copy(this.pos).add(this.shakeOffset);
            this.camera.lookAt(this.lookAt);
        }

_calculateIdealState(dt) {
            const tPos = _targetWorldPos;

            // --- AIM MODE OVERRIDE ---
            if (this.isAiming) {
                // Relaxed Aim Mode: Zoom in but maintain orientation
                const aimDist = 14.0; 
                const aimHeight = 6.0;
                
                // Use Manual Orbit Logic (Consistent with Standard Mode)
                const effectiveDistance = aimDist;
                const effectiveHeight = aimHeight + this.manualOrbitPitch * 10;
                
                // Base Z offset (Camera defaults to +Z)
                const camZ = effectiveDistance;
                
                // Apply Orbit Rotation
                const finalX = camZ * Math.sin(this.manualOrbitYaw);
                const finalZ = camZ * Math.cos(this.manualOrbitYaw);
                
                _idealPos.set(tPos.x + finalX, tPos.y + effectiveHeight, tPos.z + finalZ);
                
                _idealLook.copy(tPos);
                _idealLook.y += 1.0; // Look at player center
                
                // Disable look-ahead to keep framing stable while aiming
                this.smoothedLookAhead.set(0,0,0);
                
                return;
            }

            // --- STANDARD MODE ---

            // 0. Threat Assessment (Dynamic Pull-back)
            let threatPullback = 0;
            if (this.config.threatAwareness) {
                const threat = this._calculateThreatLevel(tPos);
                threatPullback = threat * 6.0; // Pull back up to 6 units
            }

            // IMPROVED: Apply manual orbit
            // 1. Calculate Ideal Position with pull-back
            const effectiveDistance = this.config.baseDistance + this.currentPullBack + threatPullback;
            const effectiveHeight = this.config.baseHeight + this.currentPullBack * 0.3 + threatPullback * 0.5 + this.manualOrbitPitch * 10;

            // Base offset (Camera usually sits at +Z relative to target)
            const camZ = effectiveDistance;

            // Apply Orbit Rotation
            const finalCamX = camZ * Math.sin(this.manualOrbitYaw);
            const finalCamZ = camZ * Math.cos(this.manualOrbitYaw);

            _idealPos.set(tPos.x + finalCamX, tPos.y + effectiveHeight, tPos.z + finalCamZ);

            // Clamp to arena bounds (roughly) to prevent clipping through walls
            if (_idealPos.z > 48.0) _idealPos.z = 48.0;
            if (_idealPos.z < -48.0) _idealPos.z = -48.0;

            // 2. Calculate Ideal LookAt with IMPROVED look-ahead
            _idealLook.copy(tPos);

            // IMPROVED: Velocity-based look-ahead
            if (this.targetVel.lengthSq() > 0.5) {
                const speed = this.targetVel.length();
                const lookAheadFactor = Math.min(1.0, speed / 15.0) * this.config.lookAheadDistance;

                const velDir = this.targetVel.clone().normalize();
                _lookAhead.copy(velDir).multiplyScalar(lookAheadFactor);

                // Smooth the look-ahead
                this.smoothedLookAhead.lerp(_lookAhead, dt * this.config.lookAheadSmoothing);
                _idealLook.add(this.smoothedLookAhead);
            } else {
                this.smoothedLookAhead.multiplyScalar(1.0 - dt * 3.0);
                _idealLook.add(this.smoothedLookAhead);
            }

            _idealLook.y *= 0.5; // Look slightly lower than actual target height

            // IMPROVED: Include ball in framing when nearby
            if (this.ball && this.ball.mesh && this.config.ballTrackWeight > 0) {
                const ballPos = this.ball.mesh.position;
                const distToBall = tPos.distanceTo(ballPos);

                if (distToBall < 25 && distToBall > 2) {
                    const ballWeight = Math.max(0, 1 - distToBall / 25) * this.config.ballTrackWeight;
                    _idealLook.lerp(ballPos, ballWeight);
                }
            }

            // 3. Input Anticipation (Smoothed)
            this.smoothedInput.lerp(this.targetInput, dt * 3.0);

            if (this.smoothedInput.lengthSq() > 0.01) {
                _idealLook.x += this.smoothedInput.x * 4.0;
                _idealLook.z += this.smoothedInput.z * 4.0;
            }
        }

        _calculateThreatLevel(centerPos) {
            if (!window.flux.gameInstance) return 0;
            const game = window.flux.gameInstance;
            
            let density = 0;
            const checkTeam = (team) => {
                if (!team) return;
                for (let i = 0; i < team.players.length; i++) {
                    const p = team.players[i];
                    if (p.mesh && p.mesh !== this.target) {
                        const dSq = p.mesh.position.distanceToSquared(centerPos);
                        if (dSq < 64.0) { // 8m radius
                            density += 1.0;
                        }
                    }
                }
            };
            checkTeam(game.teams.home);
            checkTeam(game.teams.away);
            
            return Math.min(1.0, density / 4.0); // Cap at 4 players
        }

        // NEW: Get forward direction for UI reference
        getForwardDirection() {
            this.camera.getWorldDirection(_camFwd);
            _camFwd.y = 0;
            if (_camFwd.lengthSq() < 0.001) {
                _camFwd.set(0, 0, -1);
            } else {
                _camFwd.normalize();
            }
            return _camFwd.clone();
        }

        // NEW: Get right direction
        getRightDirection() {
            const fwd = this.getForwardDirection();
            _camRight.crossVectors(new THREE.Vector3(0, 1, 0), fwd).normalize();
            return _camRight.clone();
        }
    }

    window.flux.CameraManager = CameraManager;
})();
</script>
    <script>(function() {
    window.flux = window.flux || {};

// Tooltip Descriptions for Long-Press
    const TOOLTIP_DESCRIPTIONS = {
        'SUBSTEPS': "Physics iterations per frame. Higher = more stable, more CPU.",
        'STOP_SPEED': "Velocity threshold below which the ball snaps to a halt.",
        'WATER_DRAG_LINEAR': "Base water resistance. Slows ball linearly.",
        'WATER_DRAG_QUAD': "Quadratic drag. Slows high-speed balls significantly.",
        'SPIN_DRAG': "How fast the ball's spin decays over time.",
        'MAGNUS_ENABLED': "Enables the Magnus effect (curve from spin).",
        'MAGNUS_COEFF': "Strength of the curve force relative to spin/speed.",
        'MAGNUS_CAP': "Maximum curve force allowed (prevents physics explosions).",
        'DEPTH_TARGET_Y': "Ideal Y height the ball tries to float at.",
        'DEPTH_SPRING': "Strength of the force pulling ball to Target Y.",
        'DEPTH_DAMP': "Damping on vertical movement to prevent oscillation.",
        'BOUNDARY_RADIUS': "Radius of the circular arena wall.",
        'BOUNDARY_HEIGHT': "Height of the arena ceiling/floor.",
        'WALL_SOFT_BUFFER': "Distance from wall where soft repulsion begins.",
        'WALL_SOFT_FORCE': "Force pushing ball away from wall before impact.",
        'WALL_ELASTICITY': "Bounciness of the wall (0 = dead thud, 1 = perfect bounce).",
        'WALL_FRICTION': "Friction when sliding along the wall.",
        'FLOOR_ELASTICITY': "Bounciness of the floor/ceiling.",
        'GOAL_POCKET_ENABLED': "Enables the extended corridor for the goal.",
        'GOAL_POCKET_X': "Half-width of the goal pocket corridor.",
        'GOAL_POCKET_Z': "Z-depth where the pocket starts.",
        'GOAL_POCKET_RADIUS': "Effective radius inside the pocket.",
        'LAUNCH_SPEED_SCALE': "Multiplier for converting Stat Power to Physics Velocity.",
        'LAUNCH_SPEED_CAP': "Maximum physical speed the ball can be thrown.",
        'SWIPE_MIN_PX': "Minimum swipe distance to register a throw.",
        'AIM_DX_SCALE': "Sensitivity of horizontal aim from swipe.",
        'AIM_DY_SCALE': "Sensitivity of vertical aim from swipe.",
        'POWER_BASE': "Base power multiplier for a quick tap.",
        'POWER_RANGE': "Additional power multiplier at full charge.",
        'POWER_MAX_BONUS_RATIO': "Charge threshold for 'Max Power' bonus.",
        'POWER_MAX_MULTIPLIER': "Multiplier applied when hitting Max Power.",
        'CURVE_ENABLED': "Enables curve shots via curved swipes.",
        'CURVE_INTENSITY_THRESHOLD': "How curved a swipe must be to trigger spin.",
        'CURVE_SPIN_SCALE': "Multiplier for converting swipe curve to ball spin.",
        'CURVE_SPEED_MULT': "Multiplier for spin based on swipe speed.",
        'CURVE_SPIN_CAP': "Maximum spin allowed from a curve throw.",
        'CURVE_PERFECT_SPIN': "Spin threshold to trigger 'Perfect Curve' FX.",
        'timeScale': "Global game speed multiplier.",
        'demoMode': "Toggle AI vs AI auto-play.",
        'resolution': "Internal render resolution scale (0.5 = half res).",
        'arenaOpacity': "Opacity of the outer arena grid.",
'arena2Opacity': "Opacity of the inner hex grid.",

        'GOAL_DISTANCE': "Distance of the goals from the center (Z-axis)."
    };
    class DevTools {
        constructor(gameManager) {
            this.game = gameManager;
            
            // lil-gui attaches to window.lil by default in UMD build
            if (!window.lil || !window.lil.GUI) {
                console.warn("DevTools: lil-gui not found.");
                return;
            }

const container = document.getElementById('game-container');
            this.gui = new window.lil.GUI({ title: 'Flux DevTools', container: container });
            
            // Position as a collapsed tab on the right frame
// Position as a sliding tab on the right frame
// Position as a sliding tab on the right frame
// Wrapper for sliding animation
            const wrapper = document.createElement('div');
            wrapper.style.position = 'absolute';
            wrapper.style.top = '100px';
            wrapper.style.right = '-260px';
            wrapper.style.width = '260px';
            wrapper.style.transition = 'right 0.3s cubic-bezier(0.2, 0.8, 0.2, 1.0)';
            wrapper.style.zIndex = '9999';
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = 'column';
            container.appendChild(wrapper);

            const dom = this.gui.domElement;
            dom.style.width = '100%';
            dom.style.setProperty('--width', '100%');
            dom.style.maxHeight = '80vh';
            dom.style.overflowY = 'auto';
            dom.style.overflowX = 'hidden';
            
            // Move GUI into wrapper
            wrapper.appendChild(dom);
            
            // Create Toggle Handle
            const handle = document.createElement('div');
            handle.style.position = 'absolute';
            handle.style.left = '-40px'; // Protrude to the left
            handle.style.top = '0';
            handle.style.width = '40px';
            handle.style.height = '40px';
            handle.style.backgroundColor = 'rgba(0, 20, 40, 0.9)';
            handle.style.border = '1px solid #00ffff';
            handle.style.borderRight = 'none';
            handle.style.borderTopLeftRadius = '8px';
            handle.style.borderBottomLeftRadius = '8px';
            handle.style.cursor = 'pointer';
            handle.style.display = 'flex';
            handle.style.justifyContent = 'center';
            handle.style.alignItems = 'center';
            handle.style.color = '#00ffff';
            handle.style.fontSize = '20px';
            handle.innerHTML = '';
            handle.style.boxShadow = '-5px 0 10px rgba(0,0,0,0.5)';
            
            wrapper.appendChild(handle);
            
            // Toggle Logic
            let isOpen = false;
            handle.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent game inputs
                isOpen = !isOpen;
                wrapper.style.right = isOpen ? '0px' : '-260px';
                handle.innerHTML = isOpen ? '' : '';
            });
            // Default global timeScale if not set
if (window.flux.timeScale === undefined) window.flux.timeScale = 0.8;

this._setupGeneral();
            this._setupGameState();
this._setupOverlays();
            this._setupTeams();
            this._setupPlayerInspector();
            this._setupBallSandbox();
this._setupFXLab();
            this._setupVisualDebug();
            this._setupVisuals();
this._setupVisuals();
            this._setupAudio();
            this._setupTooltips();
        }

        _setupTooltips() {
            // Create Tooltip DOM
            this.tooltipEl = document.createElement('div');
            Object.assign(this.tooltipEl.style, {
                position: 'fixed',
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                backgroundColor: 'rgba(0, 10, 30, 0.95)',
                border: '2px solid #00ffff',
                padding: '20px',
                color: '#fff',
                fontFamily: 'monospace',
                fontSize: '14px',
                maxWidth: '300px',
                zIndex: '10000',
                display: 'none',
                pointerEvents: 'none',
                boxShadow: '0 0 20px rgba(0, 255, 255, 0.3)',
                borderRadius: '8px',
                textAlign: 'center'
            });
            document.body.appendChild(this.tooltipEl);

            // Recursive function to attach listeners
            const attach = (gui) => {
                // Controllers
                if (gui.controllers) {
                    gui.controllers.forEach(c => {
                        const dom = c.domElement.closest('.controller'); // lil-gui structure
                        if(dom) {
                            const label = dom.querySelector('.name');
                            if(label) {
                                this._addLongPress(label, c.property, c._name);
                            }
                        }
                    });
                }
                // Sub-folders
                if(gui.folders) {
                    gui.folders.forEach(f => attach(f));
                }
            };

            // Wait a tick for GUI to fully render DOM
            setTimeout(() => attach(this.gui), 100);
        }

        _addLongPress(element, property, name) {
            let timer = null;
            const duration = 500; // 0.5s

            const start = (e) => {
                timer = setTimeout(() => {
                    this._showTooltip(property, name);
                }, duration);
            };

            const end = () => {
                if(timer) {
                    clearTimeout(timer);
                    timer = null;
                }
                this._hideTooltip();
            };

            element.addEventListener('mousedown', start);
            element.addEventListener('touchstart', start, {passive: true});
            
            element.addEventListener('mouseup', end);
            element.addEventListener('mouseleave', end);
            element.addEventListener('touchend', end);
            element.addEventListener('touchcancel', end);
        }

        _showTooltip(prop, name) {
            const desc = TOOLTIP_DESCRIPTIONS[prop];
            if(desc) {
                this.tooltipEl.innerHTML = `<strong style="color:#00ffff; font-size:16px;">${name || prop}</strong><br><br>${desc}`;
                this.tooltipEl.style.display = 'block';
            }
        }

        _hideTooltip() {
            if (this.tooltipEl) this.tooltipEl.style.display = 'none';
        }


_setupGeneral() {
            const folder = this.gui.addFolder('General');
            
const params = {
                timeScale: window.flux.timeScale,
                demoMode: this.game.isDemoMode,
                toggleHUD: true,
                resolution: 0.50,
arenaOpacity: 0.3,
                arena2Opacity: 0.25
            };

            folder.add(params, 'timeScale', 0.0, 5.0).name('Game Speed').onChange(v => {
                window.flux.timeScale = v;
            });

            folder.add(params, 'demoMode').name('Demo Mode').listen().onChange(v => {
                if (this.game.isDemoMode !== v) {
                    this.game.toggleDemoMode();
                }
            });

            folder.add(params, 'toggleHUD').name('Show HUD').onChange(v => {
                const hud = document.getElementById('ui-layer');
                if (hud) {
                    hud.style.visibility = v ? 'visible' : 'hidden';
                }
            });

            folder.add(params, 'resolution', 0.1, 2.0).name('Resolution Scale').onChange(v => {
                const w = window.innerWidth;
                const h = window.innerHeight;
                const renderer = this.game.renderer;
                if (renderer) {
                    renderer.setSize(w * v, h * v, false);
                }
            });

folder.add(params, 'arenaOpacity', 0.0, 1.0).name('Arena 1 Opacity').onChange(v => {
                if (window.flux.arenaMesh && window.flux.arenaMesh.material) {
                    window.flux.arenaMesh.material.opacity = v;
                }
            });

            const blendModes = {
                'Normal': THREE.NormalBlending,
                'Additive': THREE.AdditiveBlending,
                'Multiply': THREE.MultiplyBlending,
                'Subtractive': THREE.SubtractiveBlending,
                'NoBlending': THREE.NoBlending
            };
params.arenaBlend = 'Normal';

            folder.add(params, 'arenaBlend', Object.keys(blendModes)).name('Arena 1 Blend').onChange(v => {
                if (window.flux.arenaMesh && window.flux.arenaMesh.material) {
                    window.flux.arenaMesh.material.blending = blendModes[v];
                    window.flux.arenaMesh.material.needsUpdate = true;
                }
            });

            // Arena 2 Controls
folder.add(params, 'arena2Opacity', 0.0, 1.0).name('Arena 2 Opacity').onChange(v => {
                if (window.flux.arenaMesh2 && window.flux.arenaMesh2.material && window.flux.arenaMesh2.material.uniforms.uOpacity) {
                    window.flux.arenaMesh2.material.uniforms.uOpacity.value = v;
                }
            });

params.arena2Blend = 'Additive';
            folder.add(params, 'arena2Blend', Object.keys(blendModes)).name('Arena 2 Blend').onChange(v => {
                if (window.flux.arenaMesh2 && window.flux.arenaMesh2.material) {
                    window.flux.arenaMesh2.material.blending = blendModes[v];
                    window.flux.arenaMesh2.material.needsUpdate = true;
                }
            });
            
            // Apply defaults
            if (window.flux.arenaMesh && window.flux.arenaMesh.material) {
                window.flux.arenaMesh.material.opacity = params.arenaOpacity;
            }
            if (window.flux.arenaMesh2 && window.flux.arenaMesh2.material) {
                window.flux.arenaMesh2.material.opacity = params.arena2Opacity;
            }

            // --- Arena Graphics Controls ---
            this._setupArenaGraphics();
        }

        _setupArenaGraphics() {
            const folder = this.gui.addFolder('Arena Graphics');

            const threeBlends = {
                'Normal': THREE.NormalBlending,
                'Additive': THREE.AdditiveBlending,
                'Subtractive': THREE.SubtractiveBlending,
                'Multiply': THREE.MultiplyBlending,
                'NoBlending': THREE.NoBlending
            };

            // --- Blue Band ---
            if (window.flux.blueBandMat) {
                const blueFolder = folder.addFolder('Blue Band');
                const blueParams = {
                    visible: window.flux.blueBandMesh ? window.flux.blueBandMesh.visible : true,
                    opacity: window.flux.blueBandMat.opacity || 0.35,
                    blend: 'Normal'
                };
                blueFolder.add(blueParams, 'visible').name('Visible').onChange(v => {
                    if (window.flux.blueBandMesh) window.flux.blueBandMesh.visible = v;
                });
                blueFolder.add(blueParams, 'opacity', 0.0, 1.0).name('Opacity').onChange(v => {
                    if (window.flux.blueBandMat) window.flux.blueBandMat.opacity = v;
                });
                blueFolder.add(blueParams, 'blend', Object.keys(threeBlends)).name('Blend').onChange(v => {
                    if (window.flux.blueBandMat) {
                        window.flux.blueBandMat.blending = threeBlends[v];
                        window.flux.blueBandMat.needsUpdate = true;
                    }
                });
            }

            // --- Gold Band ---
            if (window.flux.goldBandMat) {
                const goldFolder = folder.addFolder('Gold Band');
                const goldParams = {
                    visible: window.flux.goldBandMesh ? window.flux.goldBandMesh.visible : false,
                    opacity: window.flux.goldBandMat.opacity || 0.35,
                    blend: 'Normal'
                };
                goldFolder.add(goldParams, 'visible').name('Visible').onChange(v => {
                    if (window.flux.goldBandMesh) window.flux.goldBandMesh.visible = v;
                });
                goldFolder.add(goldParams, 'opacity', 0.0, 1.0).name('Opacity').onChange(v => {
                    if (window.flux.goldBandMat) window.flux.goldBandMat.opacity = v;
                });
                goldFolder.add(goldParams, 'blend', Object.keys(threeBlends)).name('Blend').onChange(v => {
                    if (window.flux.goldBandMat) {
                        window.flux.goldBandMat.blending = threeBlends[v];
                        window.flux.goldBandMat.needsUpdate = true;
                    }
                });
            }

            // --- Yellow Arrows ---
            if (window.flux.arrowMat) {
                const arrowFolder = folder.addFolder('Yellow Arrows');
                const arrowParams = {
                    visible: window.flux.arrowGroup ? window.flux.arrowGroup.visible : true,
                    opacity: window.flux.arrowMat.opacity || 0.8,
                    blend: 'Additive'
                };
                arrowFolder.add(arrowParams, 'visible').name('Visible').onChange(v => {
                    if (window.flux.arrowGroup) window.flux.arrowGroup.visible = v;
                });
                arrowFolder.add(arrowParams, 'opacity', 0.0, 1.0).name('Opacity').onChange(v => {
                    if (window.flux.arrowMat) window.flux.arrowMat.opacity = v;
                });
                arrowFolder.add(arrowParams, 'blend', Object.keys(threeBlends)).name('Blend').onChange(v => {
                    if (window.flux.arrowMat) {
                        window.flux.arrowMat.blending = threeBlends[v];
                        window.flux.arrowMat.needsUpdate = true;
                    }
                });
            }

            // --- Floor Glyph ---
            if (window.flux.floorGlyphMat) {
                const floorFolder = folder.addFolder('Floor Glyph');
                const floorParams = {
                    visible: window.flux.floorGlyphMesh ? window.flux.floorGlyphMesh.visible : true,
                    opacity: window.flux.floorGlyphMat.opacity || 0.35,
                    blend: 'Additive'
                };
                floorFolder.add(floorParams, 'visible').name('Visible').onChange(v => {
                    if (window.flux.floorGlyphMesh) window.flux.floorGlyphMesh.visible = v;
                });
                floorFolder.add(floorParams, 'opacity', 0.0, 1.0).name('Opacity').onChange(v => {
                    if (window.flux.floorGlyphMat) window.flux.floorGlyphMat.opacity = v;
                });
                floorFolder.add(floorParams, 'blend', Object.keys(threeBlends)).name('Blend').onChange(v => {
                    if (window.flux.floorGlyphMat) {
                        window.flux.floorGlyphMat.blending = threeBlends[v];
                        window.flux.floorGlyphMat.needsUpdate = true;
                    }
                });
            }
        }

_setupOverlays() {
            const folder = this.gui.addFolder('Overlays & FX');
            
            // 1. GIF Overlay
            const gifEl = document.getElementById('screen-overlay-gif');
            if (gifEl) {
                const gifParams = {
                    visible: true,
opacity: 0.62,
                    blend: 'overlay'
                };
                
                const gFolder = folder.addFolder('Screen GIF');
                gFolder.add(gifParams, 'visible').onChange(v => gifEl.style.display = v ? 'block' : 'none');
                gFolder.add(gifParams, 'opacity', 0.0, 1.0).onChange(v => gifEl.style.opacity = v);
                
                const blendModes = [
                    'normal', 'multiply', 'screen', 'overlay', 
                    'darken', 'lighten', 'color-dodge', 'color-burn', 
                    'hard-light', 'soft-light', 'difference', 'exclusion', 
                    'hue', 'saturation', 'color', 'luminosity'
                ];
                gFolder.add(gifParams, 'blend', blendModes).onChange(v => gifEl.style.mixBlendMode = v);
            }

            // 2. Water Overlay
            const wo = this.game.waterOverlay;
            if (wo && wo.mesh) {
                const wFolder = folder.addFolder('Water Shader');
                const wParams = { 
                    visible: true,
                    opacity: wo.material.uniforms.uOpacity ? wo.material.uniforms.uOpacity.value : 0.5,
                    blend: 'Additive'
                };
                
                wFolder.add(wParams, 'visible').onChange(v => wo.mesh.visible = v);
                
                if (wo.material.uniforms.uOpacity) {
                    wFolder.add(wParams, 'opacity', 0.0, 2.0).onChange(v => wo.material.uniforms.uOpacity.value = v);
                }

                const threeBlends = {
                    'Normal': THREE.NormalBlending,
                    'Additive': THREE.AdditiveBlending,
                    'Subtractive': THREE.SubtractiveBlending,
                    'Multiply': THREE.MultiplyBlending,
                    'NoBlending': THREE.NoBlending
                };
                
                wFolder.add(wParams, 'blend', Object.keys(threeBlends)).onChange(v => {
                    wo.material.blending = threeBlends[v];
                    wo.material.needsUpdate = true;
                });
            }

            // 3. Light Shafts
            const ls = this.game.lightShafts;
            if (ls && ls.container) {
                const lParams = { visible: true };
                folder.add(lParams, 'visible').name('Light Shafts').onChange(v => ls.container.visible = v);
            }
        }

_setupGameState() {
            const folder = this.gui.addFolder('Game State');
            const gm = this.game;
            
            const params = {
                forceHomeGoal: () => { 
                    if(gm.state === 'active') gm.goalScored('home'); 
                    else console.warn("Game must be active to trigger goal");
                },
                forceAwayGoal: () => { 
                    if(gm.state === 'active') gm.goalScored('away');
                    else console.warn("Game must be active to trigger goal");
                },
                forceHalftime: () => {
                    if(gm.state === 'active') gm.endHalf();
                },
                resetRound: () => gm.resetRound(),
                exitToMenu: () => {
                    if (window.flux.gameInstance && window.flux.gameInstance.menuManager) {
                        window.flux.gameInstance.menuManager.show();
                        window.flux.gameInstance.state = 'menu';
                        // Stop practice if running
                        if (window.flux.gameInstance.practiceManager) {
                            window.flux.gameInstance.practiceManager.stop();
                        }
                    }
                }
            };

            folder.add(params, 'forceHomeGoal').name('Trigger Home Goal');
            folder.add(params, 'forceAwayGoal').name('Trigger Away Goal');
            folder.add(params, 'forceHalftime').name('Force Halftime');
            folder.add(params, 'resetRound').name('Reset Round');
            folder.add(params, 'exitToMenu').name('Exit to Menu');
        }

        _setupTeams() {
            const folder = this.gui.addFolder('Teams');
            if (!this.game.teams.home || !this.game.teams.away) return;

            const home = this.game.teams.home;
            const away = this.game.teams.away;

            // Home
            const hFolder = folder.addFolder('Home Team');
            hFolder.add(home, 'isHuman').name('Is Human Controlled').listen();
            hFolder.add(home, 'aiEnabled').name('AI Logic Enabled').listen();

            // Away
            const aFolder = folder.addFolder('Away Team');
            aFolder.add(away, 'isHuman').name('Is Human Controlled').listen();
            aFolder.add(away, 'aiEnabled').name('AI Logic Enabled').listen();

        }

_setupPlayerInspector() {
            const folder = this.gui.addFolder('Player Inspector (Home Active)');
            
            // Helper to get current active player safely
            const getActive = () => {
                return (this.game.teams.home && this.game.teams.home.activePlayer) 
                    ? this.game.teams.home.activePlayer 
                    : null;
            };

            // Proxy object to bind GUI to dynamic target
            const proxy = {
                get Role() { 
                    const p = getActive();
                    return p ? p.role : '-'; 
                },
                
                get GodMode() { 
                    const p = getActive();
                    return p ? p.isGodMode : false; 
                },
                set GodMode(v) { 
                    const p = getActive();
                    if(p) p.isGodMode = v; 
                },

                // Runtime Values
                get HP() { 
                    const p = getActive();
                    return p ? p.stats.HP : 0; 
                },
                set HP(v) { 
                    const p = getActive();
                    if(p) p.stats.HP = v; 
                },
                
                get CurrentEN() { 
                    const p = getActive();
                    return p ? p.currentEN : 0; 
                },
                set CurrentEN(v) { 
                    const p = getActive();
                    if(p) p.currentEN = v; 
                },

                // Base Stats
                get MaxHP() { 
                    const p = getActive();
                    return p ? p.stats.maxHP : 0; 
                },
                set MaxHP(v) { 
                    const p = getActive();
                    if(p) p.stats.maxHP = v; 
                },

                get SP() { 
                    const p = getActive();
                    return p ? p.stats.SP : 0; 
                },
                set SP(v) { 
                    const p = getActive();
                    if(p) { 
                        p.stats.SP = v; 
                        p._updateDerivedStats(); 
                    } 
                },

                get EN() { 
                    const p = getActive();
                    return p ? p.stats.EN : 0; 
                }, 
                set EN(v) { 
                    const p = getActive();
                    if(p) {
                        p.stats.EN = v;
                    }
                },

                get AT() { 
                    const p = getActive();
                    return p ? p.stats.AT : 0; 
                },
                set AT(v) { 
                    const p = getActive();
                    if(p) p.stats.AT = v; 
                },

                get PA() { 
                    const p = getActive();
                    return p ? p.stats.PA : 0; 
                },
                set PA(v) { 
                    const p = getActive();
                    if(p) p.stats.PA = v; 
                },

                get BL() { 
                    const p = getActive();
                    return p ? p.stats.BL : 0; 
                },
                set BL(v) { 
                    const p = getActive();
                    if(p) p.stats.BL = v; 
                },

                get SH() { 
                    const p = getActive();
                    return p ? p.stats.SH : 0; 
                },
                set SH(v) { 
                    const p = getActive();
                    if(p) p.stats.SH = v; 
                },

                get CA() { 
                    const p = getActive();
                    return p ? p.stats.CA : 0; 
                },
                set CA(v) { 
                    const p = getActive();
                    if(p) p.stats.CA = v; 
                },

                // Actions
                LevelUp: () => { 
                    const p = getActive();
                    if(p) p.levelUp(); 
                },
                FullHeal: () => { 
                    const p = getActive(); 
                    if(p) { 
                        p.stats.HP = p.stats.maxHP; 
                        p.currentEN = p.getStat('EN'); 
                        p.status.venom = 0; 
                        p.status.nap = 0; 
                        for(let k in p.status.wither) p.status.wither[k] = 0;
                        if(window.flux.gameInstance.floatingText) {
                            window.flux.gameInstance.floatingText.spawn("FULL HEAL", p.mesh.position, "heal");
                        }
                    } 
                },
                DrainEN: () => { 
                    const p = getActive();
                    if(p) {
                        p.currentEN = 0;
                        p.fumble(); // Trigger fumble logic
                    }
                }
            };

            folder.add(proxy, 'Role').listen().disable();
            folder.add(proxy, 'GodMode').name('God Mode (Inf HP/EN)').listen();

            const rtFolder = folder.addFolder('Runtime Status');
            rtFolder.add(proxy, 'HP', 0, 9999).listen();
            rtFolder.add(proxy, 'CurrentEN', 0, 100).name('Current EN').listen();

            const statFolder = folder.addFolder('Base Stats');
            statFolder.add(proxy, 'MaxHP', 100, 9999).listen();
            statFolder.add(proxy, 'EN', 0, 99).name('Max EN').listen();
            statFolder.add(proxy, 'SP', 0, 99).listen();
            statFolder.add(proxy, 'AT', 0, 99).listen();
            statFolder.add(proxy, 'PA', 0, 99).listen();
            statFolder.add(proxy, 'BL', 0, 99).listen();
            statFolder.add(proxy, 'SH', 0, 99).listen();
            statFolder.add(proxy, 'CA', 0, 99).listen();

            const actionFolder = folder.addFolder('Actions');
            actionFolder.add(proxy, 'LevelUp').name('Instant Level Up');
            actionFolder.add(proxy, 'FullHeal').name('Full Heal & Cure');
            actionFolder.add(proxy, 'DrainEN').name('Drain EN (Fumble)');
        }

_setupBallSandbox() {
    const root = this.gui.addFolder('Ball Lab (Throw & Physics)');

    // ------------------------------------------------------------
    // Shared state object (lives on window.flux so it survives reloads)
    // ------------------------------------------------------------
    const lab = window.flux.ballLab = window.flux.ballLab || {};
    lab.game = this.game;

    const C = window.flux.BallConfig;
    const TC = window.flux.ThrowConfig;

    if (!C || !TC) {
        console.warn("Ball Lab: Missing BallConfig or ThrowConfig.");
        return;
    }

    // ------------------------------------------------------------
    // Helpers
    // ------------------------------------------------------------
    const getBall = () => this.game && this.game.entities ? this.game.entities.ball : null;
    const getActive = () => this.game && this.game.teams && this.game.teams.home ? this.game.teams.home.activePlayer : null;

    const ensurePreviewLine = () => {
        if (lab.previewLine) return;
        if (!this.game || !this.game.scene) return;

        const geom = new THREE.BufferGeometry();
        const mat = new THREE.LineBasicMaterial({ transparent: true, opacity: 0.95 });
        const line = new THREE.Line(geom, mat);
        line.frustumCulled = false;
        line.renderOrder = 999;
        this.game.scene.add(line);
        lab.previewLine = line;
    };

    const clearPreviewLine = () => {
        if (lab.previewLine && lab.previewLine.geometry) {
            lab.previewLine.geometry.dispose();
            lab.previewLine.geometry = new THREE.BufferGeometry();
        }
    };

    // A safe "ghost ball" that can use Ball.updateFree without spawning FX
    const makeGhostBall = (pos, vel, spin) => {
        const gb = {
            mesh: { position: pos.clone() },
            velocity: vel.clone(),
            angularVelocity: (spin ? spin.clone() : new THREE.Vector3()),
            accumulatedRotation: new THREE.Quaternion(),
            power: 0,
            decayRate: 0,
            _bubbleTimer: 999,
            _ghost: true,
            deformNode: null
        };
        return gb;
    };

    // Use Ball.updateFree for faithful trajectory prediction
    const simulate = (ghostBall, steps, stepDt) => {
        const pts = [];
        pts.push(ghostBall.mesh.position.clone());
        const proto = window.flux.Ball && window.flux.Ball.prototype;
        if (!proto || typeof proto.updateFree !== 'function') return pts;

        for (let i = 0; i < steps; i++) {
            proto.updateFree.call(ghostBall, stepDt);
            pts.push(ghostBall.mesh.position.clone());
        }
        return pts;
    };

    // ------------------------------------------------------------
    // Preview + record/replay runtime loop
    // ------------------------------------------------------------
lab.preview = lab.preview || {
        enabled: false,
        source: 'Cannon',
        steps: 120,
        stepDt: 1/60,
        refreshHz: 10,
        showOnHeldOnly: false
    };

    lab.cannon = lab.cannon || {
        yaw: 0,
        pitch: 0,
        power: 20,
        type: 'SH',
        spinX: 0,
        spinY: 0,
        spinZ: 0,
        fireBurst: 1,
        spreadDeg: 0
    };

    lab.recording = lab.recording || {
        isRecording: false,
        frames: [],
        maxSeconds: 12
    };

    lab.replay = lab.replay || {
        isReplaying: false,
        frames: [],
        idx: 0,
        loop: true,
        speed: 1.0
    };

    lab.isReplaying = false;
    lab.targetBall = null;

    lab.applyReplayFrame = (ball, dt) => {
        const rep = lab.replay;
        if (!rep || !rep.isReplaying || !rep.frames || rep.frames.length === 0) {
            lab.isReplaying = false;
            return;
        }

        // Advance time by stepping indices (frame-based)
        const step = Math.max(1, Math.floor(rep.speed));
        rep.idx += step;

        if (rep.idx >= rep.frames.length) {
            if (rep.loop) rep.idx = 0;
            else { rep.isReplaying = false; lab.isReplaying = false; return; }
        }

        const f = rep.frames[rep.idx];
        if (!f) return;

        ball.drop(); // ensure no holder logic fights us
        ball.state = 'free';
        ball.mesh.position.set(f.px, f.py, f.pz);
        ball.velocity.set(f.vx, f.vy, f.vz);
        ball.angularVelocity.set(f.sx, f.sy, f.sz);
    };

    lab._previewTimer = lab._previewTimer || 0;

    lab.update = (dt) => {
        // --- recording ---
        const b = getBall();
        if (b && lab.recording && lab.recording.isRecording) {
            const r = lab.recording;
            const maxFrames = Math.floor((r.maxSeconds || 12) / (dt || (1/60)));
            if (r.frames.length > maxFrames) r.frames.shift();
            r.frames.push({
                px: b.mesh.position.x, py: b.mesh.position.y, pz: b.mesh.position.z,
                vx: b.velocity.x, vy: b.velocity.y, vz: b.velocity.z,
                sx: b.angularVelocity.x, sy: b.angularVelocity.y, sz: b.angularVelocity.z
            });
        }

        // --- preview refresh ---
        lab._previewTimer += dt;
        const refreshInterval = 1.0 / Math.max(1, (lab.preview.refreshHz || 10));
        if (lab.preview.enabled && lab._previewTimer >= refreshInterval) {
            lab._previewTimer = 0;
            lab.refreshPreview();
        }
    };

    lab.refreshPreview = () => {
        if (!lab.preview.enabled) { clearPreviewLine(); return; }
        ensurePreviewLine();

        const b = getBall();
        const p = getActive();
        if (!b || !b.mesh) return;

        if (lab.preview.showOnHeldOnly && b.state !== 'held') {
            clearPreviewLine();
            return;
        }

        // Decide preview source
        let startPos = b.mesh.position;
        let startVel = b.velocity;
        let startSpin = b.angularVelocity;

        if (lab.preview.source === 'Cannon') {
            // Cannon always launches from ball position (or player if held)
            const yawRad = (lab.cannon.yaw || 0) * Math.PI / 180;
            const pitchRad = (lab.cannon.pitch || 0) * Math.PI / 180;

            const dir = new THREE.Vector3(
                Math.sin(yawRad) * Math.cos(pitchRad),
                Math.sin(pitchRad),
                -Math.cos(yawRad) * Math.cos(pitchRad)
            ).normalize();

            const cap = (window.flux.BallConfig.LAUNCH_SPEED_CAP !== undefined ? window.flux.BallConfig.LAUNCH_SPEED_CAP : 85.0);
            const scale = (window.flux.BallConfig.LAUNCH_SPEED_SCALE !== undefined ? window.flux.BallConfig.LAUNCH_SPEED_SCALE : 1.0);
            const speed = Math.min((lab.cannon.power || 20) * scale, cap);

            startPos = (b.state === 'held' && p && p.mesh) ? p.mesh.position.clone().add(new THREE.Vector3(0, 1.2, 0)) : b.mesh.position.clone();
            startVel = dir.multiplyScalar(speed);
            startSpin = new THREE.Vector3(lab.cannon.spinX || 0, lab.cannon.spinY || 0, lab.cannon.spinZ || 0);
        }

        const ghost = makeGhostBall(startPos.clone(), startVel.clone(), startSpin);
        const pts = simulate(ghost, Math.floor(lab.preview.steps || 120), (lab.preview.stepDt || (1/60)));

        if (lab.previewLine) {
            lab.previewLine.geometry.dispose();
            lab.previewLine.geometry = new THREE.BufferGeometry().setFromPoints(pts);
        }
    };

    // ------------------------------------------------------------
    // Folder: Ball Physics (BallConfig)
    // ------------------------------------------------------------
    const phys = root.addFolder('Ball Physics (BallConfig)');

    const integ = phys.addFolder('Integration');
    integ.add(C, 'SUBSTEPS', 1, 12, 1).name('Substeps');
    integ.add(C, 'STOP_SPEED', 0.0, 0.2).name('Stop Speed');

    const drag = phys.addFolder('Water Drag');
    drag.add(C, 'WATER_DRAG_LINEAR', 0.0, 2.0).name('Linear Drag');
    drag.add(C, 'WATER_DRAG_QUAD', 0.0, 0.05).name('Quadratic Drag');

    const spin = phys.addFolder('Spin');
    spin.add(C, 'SPIN_DRAG', 0.0, 3.0).name('Spin Decay');

    const magnus = phys.addFolder('Magnus');
    magnus.add(C, 'MAGNUS_ENABLED').name('Enabled');
    magnus.add(C, 'MAGNUS_COEFF', 0.0, 0.5).name('Coeff');
    magnus.add(C, 'MAGNUS_CAP', 0.0, 200.0).name('Cap');

    const depth = phys.addFolder('Depth Constraint');
    depth.add(C, 'DEPTH_TARGET_Y', -5.0, 5.0).name('Target Y');
    depth.add(C, 'DEPTH_SPRING', 0.0, 10.0).name('Spring');
    depth.add(C, 'DEPTH_DAMP', 0.0, 6.0).name('Damp');

    const arena = phys.addFolder('Arena Boundary');
    arena.add(C, 'BOUNDARY_RADIUS', 10.0, 120.0).name('Radius');
    arena.add(C, 'BOUNDARY_HEIGHT', 2.0, 40.0).name('Height');
arena.add(C, 'BOUNDARY_HEIGHT', 2.0, 40.0).name('Height');
    arena.add(C, 'GOAL_DISTANCE', 20.0, 60.0).name('Goal Distance').onChange(v => {
        if (window.flux.goalA) window.flux.goalA.position.z = -v;
        if (window.flux.goalB) window.flux.goalB.position.z = v;
        // Update Debug Visuals if active
        if (window.flux.gameInstance && window.flux.gameInstance.debugVisualizer) {
            window.flux.gameInstance.debugVisualizer.updateGoalVolumes();
        }
    });
    arena.add(C, 'WALL_SOFT_BUFFER', 0.0, 20.0).name('Soft Buffer');
    arena.add(C, 'WALL_SOFT_FORCE', 0.0, 200.0).name('Soft Force');
    arena.add(C, 'WALL_ELASTICITY', 0.0, 1.0).name('Wall Bounce');
    arena.add(C, 'WALL_FRICTION', 0.0, 1.0).name('Wall Friction');
    arena.add(C, 'FLOOR_ELASTICITY', 0.0, 1.0).name('Ceil/Floor Bounce');

    const pocket = arena.addFolder('Goal Pocket');
    pocket.add(C, 'GOAL_POCKET_ENABLED').name('Enabled');
    pocket.add(C, 'GOAL_POCKET_X', 0.0, 40.0).name('Pocket Half-X');
    pocket.add(C, 'GOAL_POCKET_Z', 0.0, 50.0).name('Pocket Start |Z|');
    pocket.add(C, 'GOAL_POCKET_RADIUS', 10.0, 120.0).name('Pocket Radius');

    const launch = phys.addFolder('Launch Mapping');
    launch.add(C, 'LAUNCH_SPEED_SCALE', 0.1, 5.0).name('Speed Scale');
    launch.add(C, 'LAUNCH_SPEED_CAP', 10.0, 200.0).name('Speed Cap');

    // ------------------------------------------------------------
    // Folder: Throw mapping (Player.releaseCharge -> Ball.shoot)
    // ------------------------------------------------------------
    const throwMap = root.addFolder('Throw Mapping (ThrowConfig)');
    throwMap.add(TC, 'SWIPE_MIN_PX', 0, 120, 1).name('Swipe Min PX');
    throwMap.add(TC, 'AIM_DX_SCALE', 0.1, 5.0).name('Aim X Scale');
    throwMap.add(TC, 'AIM_DY_SCALE', 0.1, 5.0).name('Aim Y Scale');
    throwMap.add(TC, 'POWER_BASE', 0.1, 3.0).name('Power Base');
    throwMap.add(TC, 'POWER_RANGE', 0.0, 3.0).name('Power Range');
    throwMap.add(TC, 'POWER_MAX_BONUS_RATIO', 0.0, 1.0).name('Max Bonus Ratio');
    throwMap.add(TC, 'POWER_MAX_MULTIPLIER', 1.0, 6.0).name('Max Multiplier');

    const curveMap = throwMap.addFolder('Curve');
    curveMap.add(TC, 'CURVE_ENABLED').name('Enabled');
    curveMap.add(TC, 'CURVE_INTENSITY_THRESHOLD', 0.0, 1.0).name('Input Threshold');
    curveMap.add(TC, 'CURVE_SPIN_SCALE', 0.0, 4000.0).name('Spin Scale');
    curveMap.add(TC, 'CURVE_SPEED_MULT', 0.0, 5.0).name('Swipe Speed Mult');
    curveMap.add(TC, 'CURVE_SPIN_CAP', 0.0, 6000.0).name('Spin Cap');
    curveMap.add(TC, 'CURVE_PERFECT_SPIN', 0.0, 2000.0).name('Perfect Threshold');

    // ------------------------------------------------------------
    // Folder: Teleport / State tools
    // ------------------------------------------------------------
    const tp = root.addFolder('Teleport / Reset');
    const tpParams = {
        ToCenter: () => { const b = getBall(); if (b) b.reset(); },
        ToActivePlayer: () => { const b = getBall(); const p = getActive(); if (b && p) b.grab(p); },
        ToHomeGoal: () => { const b = getBall(); if (b) { b.drop(); b.mesh.position.set(0, 0, 25); b.velocity.set(0,0,0); b.angularVelocity.set(0,0,0); } },
        ToAwayGoal: () => { const b = getBall(); if (b) { b.drop(); b.mesh.position.set(0, 0, -25); b.velocity.set(0,0,0); b.angularVelocity.set(0,0,0); } },
        ToSky: () => { const b = getBall(); if (b) { b.drop(); b.mesh.position.set(0, 10, 0); b.velocity.set(0,0,0); b.angularVelocity.set(0,0,0); } },
        ClearPreview: () => clearPreviewLine()
    };
    tp.add(tpParams, 'ToCenter');
    tp.add(tpParams, 'ToActivePlayer');
    tp.add(tpParams, 'ToHomeGoal');
    tp.add(tpParams, 'ToAwayGoal');
    tp.add(tpParams, 'ToSky');
    tp.add(tpParams, 'ClearPreview');

    // ------------------------------------------------------------
    // Folder: Shot Cannon (force fire with params)
    // ------------------------------------------------------------
    const cannon = root.addFolder('Shot Cannon');
    cannon.add(lab.cannon, 'yaw', -180, 180, 1).name('Yaw (deg)');
    cannon.add(lab.cannon, 'pitch', -89, 89, 1).name('Pitch (deg)');
    cannon.add(lab.cannon, 'power', 0, 120, 0.1).name('Power');
    cannon.add(lab.cannon, 'type', ['PA','SH']).name('Type');
    cannon.add(lab.cannon, 'spinX', -3000, 3000, 1).name('Spin X');
    cannon.add(lab.cannon, 'spinY', -3000, 3000, 1).name('Spin Y');
    cannon.add(lab.cannon, 'spinZ', -3000, 3000, 1).name('Spin Z');
    cannon.add(lab.cannon, 'fireBurst', 1, 10, 1).name('Burst Count');
    cannon.add(lab.cannon, 'spreadDeg', 0, 30, 0.5).name('Spread (deg)');

    const fireParams = {
        Fire: () => {
            const b = getBall();
            const p = getActive();
            if (!b) return;

            const yawRad = (lab.cannon.yaw || 0) * Math.PI / 180;
            const pitchRad = (lab.cannon.pitch || 0) * Math.PI / 180;

            const baseDir = new THREE.Vector3(
                Math.sin(yawRad) * Math.cos(pitchRad),
                Math.sin(pitchRad),
                -Math.cos(yawRad) * Math.cos(pitchRad)
            ).normalize();

            const start = (b.state === 'held' && p && p.mesh) ? p.mesh.position.clone().add(new THREE.Vector3(0, 1.2, 0)) : b.mesh.position.clone();

            for (let i = 0; i < (lab.cannon.fireBurst || 1); i++) {
                const dir = baseDir.clone();
                if (lab.cannon.spreadDeg > 0) {
                    const spread = (lab.cannon.spreadDeg * Math.PI / 180);
                    dir.x += (Math.random()-0.5) * spread;
                    dir.y += (Math.random()-0.5) * spread;
                    dir.z += (Math.random()-0.5) * spread;
                    dir.normalize();
                }

                b.drop();
                b.mesh.position.copy(start);
                b.velocity.set(0,0,0);
                b.angularVelocity.set(0,0,0);

                const spin = new THREE.Vector3(lab.cannon.spinX || 0, lab.cannon.spinY || 0, lab.cannon.spinZ || 0);
                b.shoot(dir, lab.cannon.power || 20, lab.cannon.type || 'SH', null, spin);
            }
        }
    };
    cannon.add(fireParams, 'Fire');

    // ------------------------------------------------------------
    // Folder: Trajectory Preview
    // ------------------------------------------------------------
    const preview = root.addFolder('Trajectory Preview');
    preview.add(lab.preview, 'enabled').name('Enabled').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'source', ['Cannon', 'Live Ball']).name('Source').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'steps', 10, 600, 1).name('Steps').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'stepDt', 1/240, 1/15, 1/240).name('Step dt').onChange(() => lab.refreshPreview());
    preview.add(lab.preview, 'refreshHz', 1, 60, 1).name('Refresh Hz');
    preview.add(lab.preview, 'showOnHeldOnly').name('Only when Held').onChange(() => lab.refreshPreview());

    const previewBtns = {
        Refresh: () => lab.refreshPreview(),
        Hide: () => { lab.preview.enabled = false; clearPreviewLine(); }
    };
    preview.add(previewBtns, 'Refresh');
    preview.add(previewBtns, 'Hide');

    // ------------------------------------------------------------
    // Folder: Record / Replay
    // ------------------------------------------------------------
    const rr = root.addFolder('Record / Replay');
    const rrParams = {
        Record: () => {
            lab.recording.isRecording = true;
            lab.recording.frames = [];
        },
        Stop: () => {
            lab.recording.isRecording = false;
        },
        UseRecordingForReplay: () => {
            lab.replay.frames = (lab.recording.frames || []).slice();
            lab.replay.idx = 0;
        },
        Play: () => {
            const b = getBall();
            if (!b) return;
            lab.replay.isReplaying = true;
            lab.isReplaying = true;
            lab.targetBall = b;
            lab.replay.idx = 0;
        },
        Pause: () => {
            lab.replay.isReplaying = false;
            lab.isReplaying = false;
        },
        Clear: () => {
            lab.recording.frames = [];
            lab.replay.frames = [];
            lab.replay.idx = 0;
            lab.replay.isReplaying = false;
            lab.isReplaying = false;
        }
    };
    rr.add(rrParams, 'Record');
    rr.add(rrParams, 'Stop');
    rr.add(rrParams, 'UseRecordingForReplay').name('Copy Rec -> Replay');
    rr.add(lab.replay, 'loop').name('Loop');
    rr.add(lab.replay, 'speed', 0.25, 6.0, 0.25).name('Replay Speed');
    rr.add(rrParams, 'Play');
    rr.add(rrParams, 'Pause');
    rr.add(rrParams, 'Clear');

    // ------------------------------------------------------------
    // Folder: Presets
    // ------------------------------------------------------------
    const presets = root.addFolder('Presets');
    const P = {
        Vanilla: () => {
            Object.assign(C, {
                SUBSTEPS: 2,
                STOP_SPEED: 0.02,
                WATER_DRAG_LINEAR: 0.15,
                WATER_DRAG_QUAD: 0.002,
                SPIN_DRAG: 0.40,
                MAGNUS_ENABLED: true,
                MAGNUS_COEFF: 0.08,
                MAGNUS_CAP: 60.0,
                DEPTH_TARGET_Y: 0.0,
                DEPTH_SPRING: 1.0,
                DEPTH_DAMP: 1.5,
                BOUNDARY_RADIUS: 33.0,
                BOUNDARY_HEIGHT: 15.0,
                WALL_SOFT_BUFFER: 3.0,
                WALL_SOFT_FORCE: 20.0,
                WALL_ELASTICITY: 0.30,
                WALL_FRICTION: 0.95,
                FLOOR_ELASTICITY: 0.40,
                GOAL_POCKET_ENABLED: true,
                GOAL_POCKET_X: 12.0,
                GOAL_POCKET_Z: 25.0,
                GOAL_POCKET_RADIUS: 45.0,
                LAUNCH_SPEED_SCALE: 1.0,
                LAUNCH_SPEED_CAP: 85.0
            });
            lab.refreshPreview();
        },
        ArcadeCurve: () => {
            Object.assign(C, {
                MAGNUS_ENABLED: true,
                MAGNUS_COEFF: 0.16,
                MAGNUS_CAP: 90.0,
                SPIN_DRAG: 0.25,
                WATER_DRAG_LINEAR: 0.12,
                WATER_DRAG_QUAD: 0.001,
                WALL_SOFT_FORCE: 35.0,
                LAUNCH_SPEED_CAP: 110.0
            });
            Object.assign(TC, {
                CURVE_ENABLED: true,
                CURVE_SPIN_SCALE: 1500.0,
                CURVE_SPIN_CAP: 3000.0,
                CURVE_PERFECT_SPIN: 700.0
            });
            lab.refreshPreview();
        },
        SnappyRealistic: () => {
            Object.assign(C, {
                WATER_DRAG_LINEAR: 0.25,
                WATER_DRAG_QUAD: 0.006,
                MAGNUS_COEFF: 0.05,
                MAGNUS_CAP: 40.0,
                SPIN_DRAG: 0.75,
                STOP_SPEED: 0.05,
                LAUNCH_SPEED_CAP: 70.0
            });
            lab.refreshPreview();
        }
    };
    presets.add(P, 'Vanilla');
    presets.add(P, 'ArcadeCurve');
    presets.add(P, 'SnappyRealistic');

    // ------------------------------------------------------------
    // Folder: Snapshot / Export
    // ------------------------------------------------------------
    const snapshot = root.addFolder('Snapshot / Export');

    const _round = (n, places = 4) => {
        if (!Number.isFinite(n)) return null;
        const p = Math.pow(10, places);
        return Math.round(n * p) / p;
    };

    const _v3 = (v, places = 4) => {
        if (!v) return null;
        return [_round(v.x, places), _round(v.y, places), _round(v.z, places)];
    };

    const _cloneJson = (obj) => {
        if (!obj) return null;
        try { return JSON.parse(JSON.stringify(obj)); } catch (e) { return null; }
    };

    const _playerSnap = (p) => {
        if (!p) return null;
        const anim = (p.activeAction && p.activeAction._clip) ? p.activeAction._clip.name : (p.state || null);
        return {
            name: p.characterName || p.name || null,
            role: p.role || null,
            state: p.state || null,
            hasBall: !!p.hasBall,
            isThrowing: !!p.isThrowing,
            isCharging: !!p.isCharging,
            isDashing: !!p.isDashing,
            dashCooldown: _round(p.dashCooldown, 4),
            pos: _v3(p.mesh && p.mesh.position),
            vel: _v3(p.velocity),
            input: _v3(p.inputVector),
            stats: p.stats ? _cloneJson(p.stats) : null,
            anim
        };
    };

    const _teamSnap = (t) => {
        if (!t) return null;
        const active = t.activePlayer ? _playerSnap(t.activePlayer) : null;
        return {
            id: t.id || null,
            side: t.side,
            isHuman: !!t.isHuman,
            aiEnabled: !!t.aiEnabled,
            currentFormation: t.currentFormation || null,
            activePlayer: active,
            players: Array.isArray(t.players) ? t.players.map(_playerSnap) : []
        };
    };

    const buildSnapshot = () => {
        const game = this.game || window.flux.gameInstance || null;
        const ball = game && game.entities ? game.entities.ball : null;
        const camMgr = game ? game.cameraManager : null;
        const cam = (camMgr && camMgr.camera) ? camMgr.camera : (game ? game.camera : null);

        const ballSnap = ball ? {
            state: ball.state || null,
            isInvisible: !!ball.isInvisible,
            holder: ball.holder ? (ball.holder.characterName || ball.holder.name || null) : null,
            lastHolder: ball.lastHolder ? (ball.lastHolder.characterName || ball.lastHolder.name || null) : null,
            pos: _v3(ball.mesh && ball.mesh.position),
            vel: _v3(ball.velocity),
            angVel: _v3(ball.angularVelocity),
            power: _round(ball.power, 4),
            shotType: ball.shotType || null
        } : null;

        const cameraSnap = cam ? {
            pos: _v3(cam.position),
            rot: cam.rotation ? [_round(cam.rotation.x, 4), _round(cam.rotation.y, 4), _round(cam.rotation.z, 4)] : null,
            fov: _round(cam.fov, 4),
            near: _round(cam.near, 6),
            far: _round(cam.far, 4)
        } : null;

        const camMgrSnap = camMgr ? {
            mode: camMgr.mode || null,
            targetName: (camMgr.target && (camMgr.target.characterName || camMgr.target.name)) || null,
            settings: camMgr.settings ? _cloneJson(camMgr.settings) : null
        } : null;

        const debugIO = window.flux && window.flux._debugIO ? window.flux._debugIO : null;
        const inputSnap = debugIO ? {
            settings: debugIO.settings ? _cloneJson(debugIO.settings) : null,
            perf: debugIO.perf ? _cloneJson(debugIO.perf) : null,
            move: (debugIO.input && debugIO.input.move) ? {
                touchId: debugIO.input.move.touchId ?? null,
                dragging: !!debugIO.input.move.dragging,
                vector: debugIO.input.move.vector ? _cloneJson(debugIO.input.move.vector) : null
            } : null,
            aim: (debugIO.input && debugIO.input.aim) ? {
                touchId: debugIO.input.aim.touchId ?? null,
                dragging: !!debugIO.input.aim.dragging,
                vector: debugIO.input.aim.vector ? _cloneJson(debugIO.input.aim.vector) : null
            } : null,
            swipe: (debugIO.input && debugIO.input.swipe) ? {
                touchId: debugIO.input.swipe.touchId ?? null,
                start: debugIO.input.swipe.start ? _cloneJson(debugIO.input.swipe.start) : null,
                points: Array.isArray(debugIO.input.swipe.points) ? debugIO.input.swipe.points.slice(-32).map(_cloneJson) : []
            } : null
        } : null;

        return {
            meta: {
                timestampISO: new Date().toISOString(),
                href: (typeof location !== 'undefined' && location.href) ? location.href : null,
                userAgent: (typeof navigator !== 'undefined' && navigator.userAgent) ? navigator.userAgent : null
            },
            game: game ? {
                score: game.score ? _cloneJson(game.score) : null,
                time: _round(game.time, 4),
                half: game.half ?? null,
                halfDuration: _round(game.halfDuration, 4),
                isOvertime: !!game.isOvertime,
                isDemoMode: !!game.isDemoMode
            } : null,
            config: {
                BallConfig: (window.flux && window.flux.BallConfig) ? _cloneJson(window.flux.BallConfig) : null,
                ThrowConfig: (window.flux && window.flux.ThrowConfig) ? _cloneJson(window.flux.ThrowConfig) : null
            },
            camera: cameraSnap,
            cameraManager: camMgrSnap,
            ball: ballSnap,
            teams: game ? {
                home: _teamSnap(game.teams && game.teams.home),
                away: _teamSnap(game.teams && game.teams.away)
            } : null,
            input: inputSnap
        };
    };

    const _copyText = async (text) => {
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
                return true;
            }
        } catch (e) {}
        // Fallback
        try {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            ta.style.top = '-9999px';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            return ok;
        } catch (e) {}
        return false;
    };

    const _downloadText = (filename, text) => {
        try {
            const blob = new Blob([text], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        } catch (e) {
            console.warn('Snapshot download failed:', e);
        }
    };

    const snapshotActions = {
        CopySnapshot: async () => {
            const snap = buildSnapshot();
            const text = JSON.stringify(snap, null, 2);
            const ok = await _copyText(text);
            console.log('[Snapshot]', snap);
            if (!ok) console.warn('Snapshot: copy failed (see console).');
        },
        DownloadSnapshot: () => {
            const snap = buildSnapshot();
            const text = JSON.stringify(snap, null, 2);
            _downloadText('snapshot.json', text);
            console.log('[Snapshot]', snap);
        }
    };

    snapshot.add(snapshotActions, 'CopySnapshot').name('Copy JSON Snapshot');
    snapshot.add(snapshotActions, 'DownloadSnapshot').name('Download snapshot.json');

}
    }

    window.flux.DevTools = DevTools;

    DevTools.prototype._setupVisualDebug = function() {
        const folder = this.gui.addFolder('Visual Debugging');
        const dv = this.game.debugVisualizer;
        if (!dv) return;

const params = {
            enabled: dv.enabled,
            hitboxes: dv.showHitboxes,
            vectors: dv.showVectors,
            ai: dv.showAI,
            goalVolume: dv.showGoalVolume
        };

        folder.add(params, 'enabled').name('Enable Visualizer').onChange(v => dv.enabled = v);
        folder.add(params, 'hitboxes').name('Show Hitboxes').onChange(v => dv.showHitboxes = v);
        folder.add(params, 'vectors').name('Show Vectors').onChange(v => dv.showVectors = v);
        folder.add(params, 'ai').name('Show AI Perception').onChange(v => dv.showAI = v);
        folder.add(params, 'goalVolume').name('Show Goal Volume').onChange(v => dv.showGoalVolume = v);
    };

    DevTools.prototype._setupFXLab = function() {
        const folder = this.gui.addFolder('FX Lab & UI Test');
        
        const getTargetPos = () => {
            const p = this.game.teams.home.activePlayer;
            return p && p.mesh ? p.mesh.position : new THREE.Vector3(0, 2, 0);
        };

        const fxParams = {
            SpawnVenom: () => this.game.particleManager.spawn('venom', getTargetPos()),
            SpawnNap: () => this.game.particleManager.spawn('nap', getTargetPos()),
            SpawnWither: () => this.game.particleManager.spawn('wither', getTargetPos()),
            SpawnLearned: () => this.game.particleManager.spawn('learned', getTargetPos()),
            SpawnClash: () => this.game.spawnClash(getTargetPos()),
        };

        const fxSub = folder.addFolder('Particles');
        fxSub.add(fxParams, 'SpawnVenom');
        fxSub.add(fxParams, 'SpawnNap');
        fxSub.add(fxParams, 'SpawnWither');
        fxSub.add(fxParams, 'SpawnLearned');
        fxSub.add(fxParams, 'SpawnClash');

        const txtParams = {
            Text: "TEST",
            Type: "damage",
            Spawn: () => {
                if(this.game.floatingText) 
                    this.game.floatingText.spawn(txtParams.Text, getTargetPos(), txtParams.Type);
            }
        };
        
        const txtSub = folder.addFolder('Floating Text');
        txtSub.add(txtParams, 'Text');
        txtSub.add(txtParams, 'Type', ['damage', 'heal', 'status', 'tech', 'comic-impact', 'comic-action', 'save', 'block', 'default']);
        txtSub.add(txtParams, 'Spawn').name('Spawn Text');

        const camParams = {
            ShakeSmall: () => this.game.cameraManager.addShake(0.5),
            ShakeBig: () => this.game.cameraManager.addShake(2.0),
            ImpactLight: () => this.game.triggerImpact(0.1, 'default'),
            ImpactHeavy: () => this.game.triggerImpact(0.2, 'heavy'),
            ImpactShatter: () => this.game.triggerImpact(0.4, 'shatter'),
        };

        const camSub = folder.addFolder('Camera & Impact');
        camSub.add(camParams, 'ShakeSmall');
        camSub.add(camParams, 'ShakeBig');
        camSub.add(camParams, 'ImpactLight');
        camSub.add(camParams, 'ImpactHeavy');
        camSub.add(camParams, 'ImpactShatter');
    };


DevTools.prototype._setupVisuals = function() {
        const folder = this.gui.addFolder('Asset Forge');
        
        const forgeState = {
            active: false,
            assetName: 'Tidus',
            animName: 'idle',
            posX: 0, posY: 0, posZ: 0,
            rotX: 0, rotY: 0, rotZ: 0,
            scale: 1.0,
            camDist: 5, camHeight: 1.5, camRot: 0
        };

        const assets = {
            'Tidus': 'https://cdn.tinyglb.com/models/da788bef258c4f0b8d9ef1acc19c5567.glb',
            'Wakka': 'https://cdn.tinyglb.com/models/59114c98951647c9b8da74b0bd3636cb.glb',
            'Letty': 'https://cdn.tinyglb.com/models/43ace34c6fd94215967e842bf909da5e.glb',
            'Datto': 'https://cdn.tinyglb.com/models/e6d67ecb2e4c4715bd73a40795e1d3d5.glb',
            'Jassu': 'https://cdn.tinyglb.com/models/8216459567354e63958d4108d828de98.glb',
            'Botta': 'https://cdn.tinyglb.com/models/ad155efedc0d48fdad09da3e1cae9c97.glb',
            'Ball': 'https://cdn.tinyglb.com/models/521ae8788e584e378a79d9732a075356.glb',
            'Goal': 'https://cdn.tinyglb.com/models/a516bd90fa7c4dedb5dcbfdf803f13d5.glb'
        };

        let currentAsset = null;

        const updateTransform = () => {
            if (currentAsset) {
                currentAsset.position.set(forgeState.posX, forgeState.posY, forgeState.posZ);
                currentAsset.rotation.set(forgeState.rotX, forgeState.rotY, forgeState.rotZ);
                currentAsset.scale.setScalar(forgeState.scale);
            }
        };

        const updateCamera = () => {
            if (!forgeState.active) return;
            // Orbit around (1000, Y, 1000)
            const cx = 1000 + Math.sin(forgeState.camRot) * forgeState.camDist;
            const cz = 1000 + Math.cos(forgeState.camRot) * forgeState.camDist;
            this.game.camera.position.set(cx, forgeState.camHeight, cz);
            this.game.camera.lookAt(1000, forgeState.posY + 1, 1000);
        };

        const playAnimation = () => {
            if (!this.vizMixer || !this.vizClips) return;
            this.vizMixer.stopAllAction();
            if (forgeState.animName === 'none') return;
            
            let clip = this.vizClips.find(c => c.name === forgeState.animName);
            if (!clip) clip = this.vizClips.find(c => c.name.toLowerCase().includes(forgeState.animName.toLowerCase()));
            if (clip) this.vizMixer.clipAction(clip).play();
        };

        const spawnAsset = () => {
            if (!this.vizGroup) return;
            
            // Clear previous
            while(this.vizGroup.children.length > 0) {
                const child = this.vizGroup.children[0];
                this.vizGroup.remove(child);
            }
            
            this.vizMixer = null;
            currentAsset = null;

            const url = assets[forgeState.assetName];
            if (!url) return;

            console.log("Forge: Spawning", forgeState.assetName);

            window.flux.AssetLoader.loadModel(url, (gltf) => {
                // Check if we are still in forge mode before adding
                if (!forgeState.active) return;

                const model = gltf.scene;
                this.vizGroup.add(model);
                currentAsset = model;
                
                // Reset model transform relative to group
                model.position.set(0,0,0);
                model.rotation.set(0,0,0);
                
                updateTransform();

                if (gltf.animations && gltf.animations.length > 0) {
                    this.vizMixer = new THREE.AnimationMixer(model);
                    this.vizClips = gltf.animations;
                    playAnimation();
                }
            });
        };

        const toggleForge = (isActive) => {
            forgeState.active = isActive;
            this.game.isForgeMode = isActive; // Critical: Tell main.js to stop game loop
            
            // Toggle Game Visibility (Hide everything in the main arena)
            const gameLayer = [this.game.teams.home, this.game.teams.away, this.game.entities.ball];
            gameLayer.forEach(t => {
                if(t && t.players) t.players.forEach(p => { if(p.mesh) p.mesh.visible = !isActive; });
                else if(t && t.mesh) t.mesh.visible = !isActive;
            });
            if(window.flux.arenaMesh) window.flux.arenaMesh.visible = !isActive;
            if(window.flux.arenaMesh2) window.flux.arenaMesh2.visible = !isActive;
            if(this.game.stadium && this.game.stadium.container) this.game.stadium.container.visible = !isActive;
            if(this.game.waterOverlay && this.game.waterOverlay.mesh) this.game.waterOverlay.mesh.visible = !isActive;
            
            // Hide UI
            const ui = document.getElementById('ui-layer');
            if(ui) ui.style.display = isActive ? 'none' : 'flex';

            if (isActive) {
                // Initialize Forge Scene if needed
                if (!this.vizGroupParent) {
                    this.vizGroupParent = new THREE.Group();
                    this.game.scene.add(this.vizGroupParent);
                    
                    this.vizGroup = new THREE.Group();
                    this.vizGroup.position.set(1000, 0, 1000); // Far away from arena
                    this.vizGroupParent.add(this.vizGroup);

                    const grid = new THREE.GridHelper(20, 20, 0x00ffff, 0x444444);
                    grid.position.set(1000, 0, 1000);
                    this.vizGroupParent.add(grid);

                    this.vizLight = new THREE.DirectionalLight(0xffffff, 1.0);
                    this.vizLight.position.set(1005, 10, 1005);
                    this.game.scene.add(this.vizLight);
                    
                    this.vizAmbient = new THREE.AmbientLight(0x404040);
                    this.game.scene.add(this.vizAmbient);
                }
                
                this.vizGroupParent.visible = true;
                this.vizLight.visible = true;
                this.vizAmbient.visible = true;
                
                spawnAsset();
                updateCamera();
                
            } else {
                // Restore Game
                if (this.vizGroupParent) this.vizGroupParent.visible = false;
                if (this.vizLight) this.vizLight.visible = false;
                if (this.vizAmbient) this.vizAmbient.visible = false;
                
                // Snap camera back to game target
                if (this.game.cameraManager) this.game.cameraManager.snapToTarget();
            }
        };

        folder.add(forgeState, 'active').name('Enable Forge').onChange(toggleForge);
        folder.add(forgeState, 'assetName', Object.keys(assets)).name('Select Asset').onChange(spawnAsset);
        
        const tf = folder.addFolder('Transform');
        tf.add(forgeState, 'posX', -5, 5).onChange(updateTransform);
        tf.add(forgeState, 'posY', -5, 5).onChange(updateTransform);
        tf.add(forgeState, 'posZ', -5, 5).onChange(updateTransform);
        tf.add(forgeState, 'rotX', 0, 6.28).onChange(updateTransform);
        tf.add(forgeState, 'rotY', 0, 6.28).onChange(updateTransform);
        tf.add(forgeState, 'rotZ', 0, 6.28).onChange(updateTransform);
        tf.add(forgeState, 'scale', 0.1, 3.0).onChange(updateTransform);

        folder.add(forgeState, 'animName', ['none', 'idle', 'swim', 'throw', 'catch', 'react']).name('Animation').onChange(playAnimation);

        const cf = folder.addFolder('Camera');
        cf.add(forgeState, 'camDist', 2, 15).onChange(updateCamera);
        cf.add(forgeState, 'camHeight', 0, 10).onChange(updateCamera);
        cf.add(forgeState, 'camRot', 0, 6.28).onChange(updateCamera);

        // Hook Game Loop
        const originalUpdate = this.game.update.bind(this.game);
        this.game.update = (dt) => {
            if (forgeState.active) {
                // Forge Mode: Only update forge components and render
                if (this.vizMixer) this.vizMixer.update(dt);
                
                // Force Camera Update here since main.js loop is skipped
                updateCamera();

                if (this.game.renderer && this.game.scene && this.game.camera) {
                    this.game.renderer.render(this.game.scene, this.game.camera);
                }
            } else {
                // Normal Mode: Run standard game update
                originalUpdate(dt);
            }
};
        };

        DevTools.prototype._setupAudio = function() {
            const folder = this.gui.addFolder('Audio Settings');
            const am = this.game.audioManager;
            if (!am) return;

            const params = {
                master: am.masterVolume,
                bgm: am.bgmLevel,
                sfx: am.sfxLevel,
                mute: am.isMuted
            };

            folder.add(params, 'master', 0.0, 1.0).name('Master Volume').onChange(v => am.setMasterVolume(v));
            folder.add(params, 'bgm', 0.0, 2.0).name('BGM Level').onChange(v => am.setBGMLevel(v));
            folder.add(params, 'sfx', 0.0, 2.0).name('SFX Level').onChange(v => am.setSFXLevel(v));
            folder.add(params, 'mute').name('Mute').onChange(v => {
                am.toggleMute();
            });
        };

})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class DebugVisualizer {
constructor(scene) {
            this.scene = scene;
            this.enabled = false;
            this.showHitboxes = false;
            this.showVectors = false;
            this.showAI = false;
            this.showGoalVolume = false;

            this.visuals = new Map();
            
            // Materials
            this.matTackle = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true, transparent: true, opacity: 0.2 });
            this.matCatch = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true, transparent: true, opacity: 0.2 });
            this.matVel = new THREE.LineBasicMaterial({ color: 0xffff00 }); // Yellow Velocity
            this.matInput = new THREE.LineBasicMaterial({ color: 0x00ffff }); // Cyan Input
            this.matAI = new THREE.LineBasicMaterial({ color: 0xff00ff }); // Magenta AI Perception
            
            // Geometries
            this.geoCylinder = new THREE.CylinderGeometry(1, 1, 0.1, 16);
            this.geoCylinder.translate(0, 0.05, 0);

            // Goal Volume Visualization (Red Transparent Box)
            const goalGeo = new THREE.BoxGeometry(22, 18, 10);
            const goalMat = new THREE.MeshBasicMaterial({ 
                color: 0xff0000, 
                transparent: true, 
                opacity: 0.25, 
                side: THREE.DoubleSide, 
                depthWrite: false 
            });

this.goalVol1 = new THREE.Mesh(goalGeo, goalMat);
            this.goalVol1.visible = false;
            this.scene.add(this.goalVol1);

            this.goalVol2 = new THREE.Mesh(goalGeo, goalMat);
            this.goalVol2.visible = false;
            this.scene.add(this.goalVol2);
            
            this.updateGoalVolumes();
        }
        
        updateGoalVolumes() {
const goalDist = (window.flux.BallConfig && window.flux.BallConfig.GOAL_DISTANCE) || 41.5;
            if (this.goalVol1) this.goalVol1.position.set(0, -6.0, -(goalDist + 5.0));
            if (this.goalVol2) this.goalVol2.position.set(0, -6.0, (goalDist + 5.0));
        }


update() {
            // Update static debugs
            if (this.goalVol1) this.goalVol1.visible = this.enabled && this.showGoalVolume;
            if (this.goalVol2) this.goalVol2.visible = this.enabled && this.showGoalVolume;

            if (!this.enabled) {
                if (this.visuals.size > 0) this.clear();
                return;
            }

            const game = window.flux.gameInstance;
            if (!game || !game.teams.home) return;

            const entities = [
                ...game.teams.home.players,
                ...game.teams.away.players,
                game.entities.ball
            ];

            entities.forEach(e => {
                if (!e || !e.mesh) return;
                
                let v = this.visuals.get(e);
                if (!v) {
                    v = this.createVisual(e);
                    this.visuals.set(e, v);
                }
                this.updateVisual(e, v);
            });
        }

        createVisual(entity) {
            const group = new THREE.Group();
            this.scene.add(group);

            // Hitboxes
            const tackle = new THREE.Mesh(this.geoCylinder, this.matTackle);
            const catchR = new THREE.Mesh(this.geoCylinder, this.matCatch);
            group.add(tackle);
            group.add(catchR);

            // Lines
            const velLine = this.createLine(this.matVel);
            const inputLine = this.createLine(this.matInput);
            const aiLine = this.createLine(this.matAI); // Line to perceived target
            
            group.add(velLine);
            group.add(inputLine);
            group.add(aiLine);

            return { group, tackle, catchR, velLine, inputLine, aiLine };
        }

        createLine(mat) {
            const geo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(), new THREE.Vector3()]);
            return new THREE.Line(geo, mat);
        }

        updateLine(line, start, end) {
            const pos = line.geometry.attributes.position.array;
            pos[0] = start.x; pos[1] = start.y; pos[2] = start.z;
            pos[3] = end.x; pos[4] = end.y; pos[5] = end.z;
            line.geometry.attributes.position.needsUpdate = true;
            line.visible = true;
        }

        updateVisual(e, v) {
            v.group.visible = true;
            
            // Hitboxes (Local to entity position)
            v.tackle.position.copy(e.mesh.position);
            v.catchR.position.copy(e.mesh.position);
            
            if (this.showHitboxes && e.role) {
                v.tackle.visible = true;
                const rT = e.tackleRadius || 2.5;
                v.tackle.scale.set(rT, 1, rT);

                v.catchR.visible = true;
                // Logic from main.js checkBallGrab
                const rC = e.isDashing ? 4.0 : 2.5; 
                v.catchR.scale.set(rC, 1, rC);
                v.catchR.position.y = e.mesh.position.y + 0.1;
            } else {
                v.tackle.visible = false;
                v.catchR.visible = false;
            }

            // Vectors (Global lines)
            const origin = e.mesh.position.clone();
            origin.y += 1.0; // Lift up

            if (this.showVectors) {
                // Velocity
                if (e.velocity) {
                    const end = origin.clone().add(e.velocity);
                    this.updateLine(v.velLine, origin, end);
                }
                // Input
                if (e.inputVector && e.inputVector.lengthSq() > 0) {
                    const end = origin.clone().add(e.inputVector.clone().multiplyScalar(3.0));
                    this.updateLine(v.inputLine, origin, end);
                } else {
                    v.inputLine.visible = false;
                }
            } else {
                v.velLine.visible = false;
                v.inputLine.visible = false;
            }

            // AI
            if (this.showAI && e.perceivedTargetPos) {
                // Draw line to perceived target
                this.updateLine(v.aiLine, origin, e.perceivedTargetPos);
            } else {
                v.aiLine.visible = false;
            }
        }

        clear() {
            this.visuals.forEach(v => {
                this.scene.remove(v.group);
            });
            this.visuals.clear();
        }
    }
    window.flux.DebugVisualizer = DebugVisualizer;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class MenuManager {
        constructor(gameManager) {
            this.game = gameManager;
            this.container = document.getElementById('main-menu');
            this.items = document.querySelectorAll('.menu-item');
            
            this.setupEvents();
        }

        setupEvents() {
            this.items.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent click-through
                    this.handleSelection(item.dataset.action);
                });
                
item.addEventListener('mouseenter', () => {
                    // Optional: Play hover sound
                    if (this.game.audioManager) this.game.audioManager.playSFX('menu', { volume: 0.5, variance: 0.05 });
                });
            });
        }

        handleSelection(action) {
            console.log("Menu Selection:", action);
console.log("Menu Selection:", action);
if (action === 'normal') {
                if (this.game.audioManager) this.game.audioManager.playSFX('menu', { volume: 1.0 });
                this.hide();
                this.game.startMatch('normal');
} else if (action === 'practice') {
                this.hide();
                this.game.startMatch('practice');
            } else if (action === 'ball_lab') {
                this.hide();
                window.flux = window.flux || {};
                window.flux.requestedPracticeDrill = 'ball_lab';
                this.game.startMatch('practice');
            } else if (action === 'options') {
                console.log("Options clicked (Not implemented)");
            }
        }

        show() {
            if (this.container) {
                this.container.classList.add('active');
                this.game.setMenuMode(true);
            }
        }

        hide() {
            if (this.container) {
                this.container.classList.remove('active');
                this.game.setMenuMode(false);
            }
        }
    }

    window.flux.MenuManager = MenuManager;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    class PracticeManager {
        constructor(gameManager) {
            this.game = gameManager;
            this.isRunning = false;
            this.currentDrill = null;
            this.drillState = {}; 
            
this.drills = {
                'free': { name: 'FREE ROAM', setup: this._setupFree.bind(this), loop: this._loopFree.bind(this) },
                'ball_lab': { name: 'BALL LAB', setup: this._setupBallLab.bind(this), loop: this._loopBallLab.bind(this) },
                'shooting': { name: 'SHOOTING DRILL', setup: this._setupShooting.bind(this), loop: this._loopShooting.bind(this) },
                'passing': { name: 'PASSING DRILL', setup: this._setupPassing.bind(this), loop: this._loopPassing.bind(this) },
                'defense': { name: 'DEFENSE DRILL', setup: this._setupDefense.bind(this), loop: this._loopDefense.bind(this) },
                'curve': { name: 'CURVE SHOT', setup: this._setupCurve.bind(this), loop: this._loopCurve.bind(this) },
                'rapid_fire': { name: 'RAPID FIRE', setup: this._setupRapidFire.bind(this), loop: this._loopRapidFire.bind(this) }
            };

this.ui = document.getElementById('practice-overlay');
            this.gestureHint = document.getElementById('gesture-hint');
            
            this.options = {
                infStats: true,
                aiDummy: true,
                showHitboxes: false
            };
            
this.targetRing = null;
            this.ghostBalls = []; // Array to track visual copies of thrown balls
            this._initVisuals();
            this._setupEvents();
        }

        _initVisuals() {
            // Create a glowing ring for targets
            const geometry = new THREE.RingGeometry(1.5, 1.8, 32);
            geometry.rotateX(-Math.PI / 2);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x00ffff, 
                side: THREE.DoubleSide, 
                transparent: true, 
                opacity: 0.6,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            this.targetRing = new THREE.Mesh(geometry, material);
            this.targetRing.visible = false;
            // Add to scene via game manager reference
            if (this.game.scene) this.game.scene.add(this.targetRing);
        }

        start() {
this.isRunning = true;
            this._showPanel();
            // If menu requested a specific drill (e.g., Ball Lab), honor it once.
            const req = window.flux && window.flux.requestedPracticeDrill;
            if (req && this.drills[req]) {
                this.setDrill(req);
                window.flux.requestedPracticeDrill = null;
            } else {
                this.setDrill('free');
            }
            
            // Ensure HUD is visible
            const hud = document.getElementById('ui-layer');
            if(hud) hud.style.visibility = 'visible';
        }

        stop() {

            this.isRunning = false;
            this._hidePanel();
            this._hideRestoreBtn();
this._clearDrill();
            
// Clear Ghost Balls
            this.ghostBalls.forEach(b => {
                if (b.mesh) this.game.scene.remove(b.mesh);
                if (b.trail) {
                    this.game.scene.remove(b.trail.mesh);
                    if (b.trail.mesh.geometry) b.trail.mesh.geometry.dispose();
                }
            });
            this.ghostBalls = [];
            if (this.targetRing) this.targetRing.visible = false;

            // Restore Away Team Visibility for Normal Match
// Restore Away Team Visibility for Normal Match
            if (this.game.teams.away) {
                this.game.teams.away.players.forEach(p => {
                    if(p.mesh) {
                        p.mesh.visible = true;
                        p.mesh.position.y = 0; // Ensure they aren't stuck under floor
                        p.canCatch = true; // Restore catching
                    }
                });
            }

            // Disable debug visuals if they were on
            if (this.game.debugVisualizer) {
                this.game.debugVisualizer.enabled = false;
                this.game.debugVisualizer.showHitboxes = false;
            }
        }

        setDrill(key) {
            if (!this.drills[key]) return;
            this._clearDrill();
            this.currentDrill = key;
            
            // Update UI
            if (this.ui) {
                this.ui.querySelectorAll('.drill-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.drill === key);
                });
            }

            // Run Setup
            this.drills[key].setup();
            
            // Announcement
            if (this.game.showAnnouncement) {
                this.game.showAnnouncement(this.drills[key].name, 'normal');
            }
        }

        update(dt) {
            if (!this.isRunning) return;

            // Common Practice Logic (Infinite Stats)
            if (this.options.infStats) {
                this._applyInfiniteStats();
            }

            // Drill Logic
            if (this.currentDrill && this.drills[this.currentDrill].loop) {
                this.drills[this.currentDrill].loop(dt);
            }
            
            // Visuals Animation
// Visuals Animation
            if (this.targetRing && this.targetRing.visible) {
                this.targetRing.rotation.z += dt; // Spin
                const s = 1.0 + Math.sin(Date.now() * 0.005) * 0.1;
                this.targetRing.scale.set(s, s, s);
            }

// Update Ghost Balls
            for (let i = this.ghostBalls.length - 1; i >= 0; i--) {
                const b = this.ghostBalls[i];
                b.life -= dt;
                
                // --- PHYSICS & VISUALS DELEGATION ---
                if (window.flux.Ball && window.flux.Ball.prototype.updateFree) {
                    window.flux.Ball.prototype.updateFree.call(b, dt);
                    window.flux.Ball.prototype.updateVisuals.call(b, dt);
                }

                // Update Trail
                if (b.trail) {
                    const trailPos = b.mesh.position.clone();
                    if (b.deformNode) trailPos.y += b.deformNode.position.y;
                    b.trail.update(trailPos);
                }

                // --- GOAL DETECTION FOR GHOST BALLS ---
                const pos = b.mesh.position;
                // Check Z depth (Goal is at +/- 28, trigger at 29)
if (Math.abs(pos.z) > 40.0) {
                    // Goal Box Dimensions (Matches GameManager)
                    const halfWidth = 11.0;
                    const halfHeight = 9.0;
const goalYOffset = -6.0;
                    
                    if (Math.abs(pos.x) <= halfWidth && Math.abs(pos.y - goalYOffset) <= halfHeight) {
                        // GOAL!
                        if (this.game.particleManager) {
                            // Spawn Goal FX
                            this.game.particleManager.spawn('shockwave', pos, { scale: 8.0, life: 0.5 });
                            this.game.particleManager.spawn('flash', pos, { scale: 5.0 });
                            // Debris
                            for(let k=0; k<10; k++) this.game.particleManager.spawn('debris', pos, { scale: 0.5 });
                        }
                        if (this.game.floatingText) {
                            this.game.floatingText.spawn("GOAL", pos, "goal");
                        }
                        // Kill ball immediately
                        b.life = 0;
                    }
                }

                // Cleanup
                if (b.life <= 0 || b.mesh.position.y < -10) {
                    this.game.scene.remove(b.mesh);
                    if (b.trail) {
                        this.game.scene.remove(b.trail.mesh);
                        if (b.trail.mesh.geometry) b.trail.mesh.geometry.dispose();
                    }
                    this.ghostBalls.splice(i, 1);
                }
            }
        }

        _setupEvents() {

            // Minimize / Restore
            const minBtn = this.ui.querySelector('#p-minimize');
            if (minBtn) {
                minBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this._hidePanel();
                    this._showRestoreBtn();
                });
            }

            const restoreBtn = document.getElementById('practice-restore-btn');
            if (restoreBtn) {
                restoreBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this._showPanel();
                    this._hideRestoreBtn();
                });
            }

            // Drill Buttons
            this.ui.querySelectorAll('.drill-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.setDrill(btn.dataset.drill);
                });
            });

            // Reset Ball
            const resetBtn = this.ui.querySelector('#p-reset-ball');
            if (resetBtn) {
                resetBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this._resetBallToPlayer();
                });
            }

            // Exit
            const exitBtn = this.ui.querySelector('#p-exit');
            if (exitBtn) {
                exitBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (window.flux.gameInstance && window.flux.gameInstance.menuManager) {
                        window.flux.gameInstance.menuManager.show();
                        window.flux.gameInstance.state = 'menu';
                        this.stop();
                    }
                });
            }

            // Options Toggles
            this._bindToggle('opt-inf-stat', 'infStats');
            this._bindToggle('opt-ai-dummy', 'aiDummy', (val) => {
                // Update AI Dummy state immediately
                if (this.game.teams.away) {
                    this.game.teams.away.aiEnabled = !val; // If dummy is TRUE, AI is FALSE
                }
            });
            this._bindToggle('opt-hitboxes', 'showHitboxes', (val) => {
                if (this.game.debugVisualizer) {
                    this.game.debugVisualizer.enabled = val;
                    this.game.debugVisualizer.showHitboxes = val;
                }
            });

            // Keyboard Shortcut for Reset (R)
// Keyboard Shortcut for Reset (R)
            window.addEventListener('keydown', (e) => {
                if (this.isRunning && e.key.toLowerCase() === 'r' && !e.repeat) {
                    this._resetBallToPlayer();
                }
            });
        }

_bindToggle(id, optionKey, callback) {
            const el = this.ui.querySelector(`#${id}`);
            if (!el) return;

            // Helper to update visuals
            const updateVisual = () => {
                const isActive = this.options[optionKey];
                el.classList.toggle('active', isActive);
                const box = el.querySelector('.checkbox');
                if (box) box.innerText = isActive ? '' : '';
            };

            // Initialize visual state immediately
            updateVisual();

            el.addEventListener('click', (e) => {
                e.stopPropagation();
                this.options[optionKey] = !this.options[optionKey];
                
                updateVisual();

                if (callback) callback(this.options[optionKey]);
            });
        }


        _setupBallLab() {
            this._setInstruction("BALL LAB: Open DevTools  Ball Lab. Use Shot Cannon + trajectory preview + record/replay.");
            this.drillState.resetting = false;
            this.drillState._autoResetTimer = 0;

            const home = this.game.teams.home;
            const away = this.game.teams.away;
            const p = home ? home.activePlayer : null;
            if (!p) return;

            // Solo mode: hide everyone except the active player
            if (home && home.players) {
                home.players.forEach(mate => {
                    if (mate.mesh) mate.mesh.visible = (mate === p);
                });
            }
            if (away && away.players) {
                away.players.forEach(opp => {
                    if (opp.mesh) opp.mesh.visible = false;
                });
            }

            // Place active player at center facing the away goal
            if (p.mesh) {
                p.mesh.position.set(0, 0, 0);
const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
                p.mesh.lookAt(0, 0, -goalDist);
                p.velocity.set(0, 0, 0);
                if (p.syncRotation) p.syncRotation();
            }

            // Big stats so you can test extremes
            if (p.stats) {
                p.stats.SH = 99;
                p.stats.PA = 99;
                p.stats.EN = 99;
                p.stats.maxHP = Math.max(p.stats.maxHP || 999, 999);
                p.stats.HP = p.stats.maxHP;
            }

            // A clear target marker (purely visual)
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.set(0, 0.1, -18);
                this.targetRing.material.color.setHex(0xff00ff);
            }

            this._resetBallToPlayer();
        }

        _loopBallLab(dt) {
            const b = this.game.entities.ball;
            const p = this.game.teams.home.activePlayer;
            if (!b || !p) return;

            // Auto-reset ball back to player once it comes to rest,
            // so you can spam variations without touching anything.
            if (b.state === 'free') {
                const stopped = (b.velocity.lengthSq() < 0.01) && (b.power <= 0.01);
                if (stopped) {
                    this.drillState._autoResetTimer = (this.drillState._autoResetTimer || 0) + dt;
                    if (this.drillState._autoResetTimer > 0.45) {
                        this._resetBallToPlayer();
                        this.drillState._autoResetTimer = 0;
                    }
                } else {
                    this.drillState._autoResetTimer = 0;
                }
            } else {
                this.drillState._autoResetTimer = 0;
            }

            // Slight target bob (helps depth perception)
            if (this.targetRing && this.targetRing.visible) {
                this.targetRing.position.y = 0.1 + Math.sin(Date.now() * 0.003) * 0.05;
            }
        }

        _applyInfiniteStats() {
            const home = this.game.teams.home;
            if (home) {
                home.players.forEach(p => {
                    p.stats.HP = p.stats.maxHP;
                    p.currentEN = p.stats.EN;
                    p.status.venom = 0;
                    p.status.nap = 0;
                    p.stunTimer = 0;
                });
            }
        }

        _clearDrill() {

            // Reset positions, clear dummies, reset score
            if (this.drillState.hintTimeout) clearTimeout(this.drillState.hintTimeout);
            this.drillState = { score: 0, timer: 0, stage: 0, resetting: false };
            if (this.gestureHint) this.gestureHint.style.display = 'none';
            this._updateScoreUI(0);
            
            // Clear Glyphs
            if (this.game.glyphManager) this.game.glyphManager.clear();
            
            if (this.targetRing) this.targetRing.visible = false;

            // Reset teams to default positions

            // Reset teams to default positions
            this.game.teams.home.resetPositions();
            this.game.teams.away.resetPositions();
            
            // Apply AI Dummy setting
            if (this.game.teams.away) {
                this.game.teams.away.aiEnabled = !this.options.aiDummy;
            }
// Hide away team by default in drills unless specified
            this.game.teams.away.players.forEach(p => {
                if(p.mesh) p.mesh.visible = false;
                p.mesh.position.set(0, -1000, 0); // Move WAY away to prevent interaction
                p.velocity.set(0,0,0);
                p.canCatch = false; // Disable catching
            });
            
            // Ensure Home team is visible
            this.game.teams.home.players.forEach(p => {
                if(p.mesh) p.mesh.visible = true;
            });
        }

        _resetBallToPlayer() {
            const p = this.game.teams.home.activePlayer;
            const b = this.game.entities.ball;
            if (p && b) {
                b.reset();
                b.grab(p);
                if (this.game.floatingText) this.game.floatingText.spawn("RESET", p.mesh.position, "tech");
                
                // Snap camera
                if (this.game.cameraManager) this.game.cameraManager.snapToTarget();
            }
        }

        _updateScoreUI(val) {
            const el = this.ui.querySelector('#drill-score');
            if (el) el.innerText = `SCORE: ${val}`;
        }

        _setInstruction(text) {
             const el = this.ui.querySelector('#drill-instruction');
             if (el) el.innerText = text;
        }

        // --- DRILLS ---

_setupFree() {
            this._setInstruction("Free practice. Infinite HP/EN.");
            // Show everyone
            this.game.teams.away.players.forEach(p => {
                if(p.mesh) p.mesh.visible = true;
                p.mesh.position.copy(p.homePosition);
                p.canCatch = true; // Restore capability
            });
            this._resetBallToPlayer();
        }
        _loopFree(dt) {}

        _setupShooting() {

            this._setInstruction("Score on the Goalie!");
            this.drillState.resetting = false; // Clear reset flag
            
            // Setup: Active Player at 18m, Goalie in net.
            const p = this.game.teams.home.activePlayer;
            const g = this.game.teams.away.players.find(x => x.role === 'GL');
            
            if (p && p.mesh) {
                p.mesh.position.set(0, 0, -10); // 18m out (Home attacks -Z)
const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
                p.mesh.lookAt(0, 0, -goalDist);
                p.velocity.set(0,0,0);
            }
            if (g && g.mesh) {
                g.mesh.visible = true;
                g.mesh.position.set(0, 0, -27);
                g.mesh.lookAt(0, 0, 0);
                g.velocity.set(0,0,0);
            }
            
            this._resetBallToPlayer();
        }
        
        _loopShooting(dt) {
            if (this.drillState.resetting) return;

            // Check if goal scored (GameManager handles the actual goal event, but we track reset)
            if (this.game.state === 'goal') {
                this.drillState.resetting = true;
                this.drillState.score++;
                this._updateScoreUI(this.drillState.score);
                this.game.state = 'active'; // Hijack state back
                setTimeout(() => this._setupShooting(), 1000);
                return;
            }
            
            // If goalie catches
            const g = this.game.teams.away.players.find(x => x.role === 'GL');
            if (g && g.hasBall) {
                 this.drillState.resetting = true;
                 if (this.game.floatingText) this.game.floatingText.spawn("SAVED", g.mesh.position, "damage");
                 setTimeout(() => this._setupShooting(), 1000);
            }
        }

        _setupPassing() {

             this._setInstruction("Pass to the moving target!");
             this.drillState.resetting = false;

             // Setup: Active Player center. 1 Teammate running patterns.
             const p = this.game.teams.home.activePlayer;
             const target = this.game.teams.home.players.find(x => x !== p && x.role !== 'GL');
             
             this.drillState.target = target;
             
             if (p) {
                 p.mesh.position.set(0, 0, 10);
                 p.velocity.set(0,0,0);
             }
             if (target) {
                 target.mesh.position.set(0, 0, -10);
                 target.mesh.visible = true;
                 target.velocity.set(0,0,0);
             }
             
             this._resetBallToPlayer();
        }

        _loopPassing(dt) {
            if (this.drillState.resetting) return;

            const target = this.drillState.target;
            if (!target) return;
            
            // Move target in circle
            this.drillState.timer += dt;
            target.mesh.position.x = Math.sin(this.drillState.timer) * 10;
            target.mesh.position.z = -10 + Math.cos(this.drillState.timer * 0.5) * 5;
            target.mesh.lookAt(0,0,10);

            // Update Ring
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.copy(target.mesh.position);
                this.targetRing.position.y = 0.1;
                this.targetRing.material.color.setHex(0x00ffff); // Cyan
            }

            if (target.hasBall) {
                this.drillState.resetting = true;
                this.drillState.score++;
                this._updateScoreUI(this.drillState.score);
                if (this.game.floatingText) this.game.floatingText.spawn("NICE PASS!", target.mesh.position, "heal");
                
                // Reset
                setTimeout(() => {
                    target.loseBall();
                    this._setupPassing(); // Re-setup to reset positions
                }, 800);
            }
        }
        
        _setupDefense() {

            this._setInstruction("Tackle the attacker!");
            this.drillState.resetting = false;

            const p = this.game.teams.home.activePlayer;
            const attacker = this.game.teams.away.players.find(x => x.role === 'MF');
            
            this.drillState.attacker = attacker;
            
            if (p) {
                p.mesh.position.set(0, 0, 20); // Near own goal
                p.velocity.set(0,0,0);
            }
            if (attacker) {
                attacker.mesh.visible = true;
                attacker.mesh.position.set(0, 0, -10);
                attacker.velocity.set(0,0,0);
                // Give ball to attacker
                const b = this.game.entities.ball;
                b.reset();
                b.grab(attacker);
            }
        }
        
        _loopDefense(dt) {
            if (this.drillState.resetting) return;

            const attacker = this.drillState.attacker;
            const p = this.game.teams.home.activePlayer;
            
            if (!attacker || !p) return;
            
            // Attacker runs to goal (+Z)
// Attacker runs to goal (+Z)
            const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
            const goalPos = new THREE.Vector3(0, 0, goalDist);
            const dir = goalPos.clone().sub(attacker.mesh.position).normalize();
            
            // Update Ring on Attacker
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.copy(attacker.mesh.position);
                this.targetRing.position.y = 0.1;
                this.targetRing.material.color.setHex(0xff0000); // Red for enemy
            }

            if (attacker.hasBall) {
                attacker.setInput(dir.x, dir.z);
            } else {
                // Ball lost (Tackled)
                if (p.hasBall || this.game.entities.ball.state === 'free') {
                    this.drillState.resetting = true;
                    this.drillState.score++;
                    this._updateScoreUI(this.drillState.score);
                    if (this.game.floatingText) this.game.floatingText.spawn("STOPPED!", p.mesh.position, "block");
                    setTimeout(() => this._setupDefense(), 1000);
                }
            }
            
            // Fail condition: Attacker scores (GameManager handles goal check)
             if (this.game.state === 'goal') {
                this.drillState.resetting = true;
                this.game.state = 'active';
                if (this.game.floatingText) this.game.floatingText.spawn("FAILED", p.mesh.position, "damage");
                setTimeout(() => this._setupDefense(), 1000);
            }
}

        _setupCurve() {
this._setInstruction("Swipe a CURVE ( ) ) to bypass the defender!");
            this.drillState.resetting = false;

            // Show gesture hint
            if (this.gestureHint) {
                this.gestureHint.style.display = 'flex';
                this.gestureHint.classList.add('active');
                
                // Clear any existing timeout
                if (this.drillState.hintTimeout) clearTimeout(this.drillState.hintTimeout);
                
                // Auto hide after 4s
                this.drillState.hintTimeout = setTimeout(() => {
                    if (this.gestureHint) {
                        this.gestureHint.style.display = 'none';
                        this.gestureHint.classList.remove('active');
                    }
                }, 4000);
            }

            const p = this.game.teams.home.activePlayer;
            // Use a defender dummy
            const defender = this.game.teams.away.players.find(x => x.role === 'LD');
            this.drillState.defender = defender;

            if (p) {
                p.mesh.position.set(0, 0, 15);
const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
                p.mesh.lookAt(0, 0, -goalDist);
                p.velocity.set(0,0,0);
            }

            if (defender) {
                defender.mesh.visible = true;
                defender.mesh.position.set(0, 0, 5); // 10m in front of player
                defender.mesh.lookAt(0, 0, 15); // Face player
                defender.velocity.set(0,0,0);
                // Boost BL to ensure straight shots are blocked
                defender.stats.BL = 99; 
                // Ensure they don't move
                defender.aiState = 'IDLE';
            }

            // Target Ring behind defender
            if (this.targetRing) {
                this.targetRing.visible = true;
                this.targetRing.position.set(0, 0.1, -10);
                this.targetRing.material.color.setHex(0x00ffff);
            }

            this._resetBallToPlayer();
        }

_loopCurve(dt) {
            if (this.drillState.resetting) return;

            const ball = this.game.entities.ball;
            const defender = this.drillState.defender;

            // Check if ball passed the defender line (z < 0)
            if (ball.mesh.position.z < 0) {
                // Success zone (Within 5m width)
                if (Math.abs(ball.mesh.position.x) < 5) {
                    this.drillState.resetting = true;
                    this.drillState.score++;
                    this._updateScoreUI(this.drillState.score);
                    if (this.game.floatingText) this.game.floatingText.spawn("CURVED!", ball.mesh.position, "tech");
                    setTimeout(() => this._setupCurve(), 1000);
                    return;
                }
            }

            // Check if blocked (Ball stopped or power drained significantly near defender)
            if (defender && ball.mesh.position.distanceTo(defender.mesh.position) < 3.0) {
                if (ball.power <= 0 || ball.velocity.length() < 1.0) {
                    this.drillState.resetting = true;
                    if (this.game.floatingText) this.game.floatingText.spawn("BLOCKED", defender.mesh.position, "damage");
                    
                    // Re-show hint on failure to guide player
                    if (this.gestureHint) {
                        this.gestureHint.style.display = 'flex';
                        this.gestureHint.classList.add('active');
                        clearTimeout(this.drillState.hintTimeout);
                        this.drillState.hintTimeout = setTimeout(() => {
                            if (this.gestureHint) {
                                this.gestureHint.style.display = 'none';
                                this.gestureHint.classList.remove('active');
                            }
                        }, 4000);
                    }

                    setTimeout(() => this._setupCurve(), 1000);
                    return;
                }
            }

            // Missed / Out of bounds
            if (ball.mesh.position.z < -15) {
                 this.drillState.resetting = true;
                 if (this.game.floatingText) this.game.floatingText.spawn("MISSED", ball.mesh.position, "damage");
                 
                 // Re-show hint on miss
                 if (this.gestureHint) {
                    this.gestureHint.style.display = 'flex';
                    this.gestureHint.classList.add('active');
                    clearTimeout(this.drillState.hintTimeout);
                    this.drillState.hintTimeout = setTimeout(() => {
                        if (this.gestureHint) {
                            this.gestureHint.style.display = 'none';
                            this.gestureHint.classList.remove('active');
                        }
                    }, 4000);
                 }

                 setTimeout(() => this._setupCurve(), 1000);
            }
        }

_setupRapidFire() {
            this._setInstruction("UNLIMITED AMMO! Spam throws!");
            this.drillState.resetting = false;

            // Find Tidus or default to LF
            let p = this.game.teams.home.players.find(x => x.characterName && x.characterName.includes('Tidus'));
            if (!p) p = this.game.teams.home.players.find(x => x.role === 'LF');
            
            // Set active player
            if (p) {
                this.game.teams.home.setActivePlayer(p);
                p.mesh.position.set(0, 0, 0);
const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
                p.mesh.lookAt(0, 0, -goalDist);
                p.velocity.set(0,0,0);
                
                // Boost stats for fun
                p.stats.SH = 99;
                p.stats.PA = 99;
            }

            // HIDE EVERYONE (Alone Mode)
            this.game.teams.home.players.forEach(mate => {
                if (mate !== p && mate.mesh) mate.mesh.visible = false;
            });
            this.game.teams.away.players.forEach(opp => {
                if (opp.mesh) opp.mesh.visible = false;
            });

            this._resetBallToPlayer();
        }

_loopRapidFire(dt) {
            const p = this.game.teams.home.activePlayer;
            const b = this.game.entities.ball;

            if (!p || !b) return;

            // Detect if ball was just thrown (is free)
            if (b.state === 'free') {
                // 1. Spawn Ghost Ball (Visual Copy)
                // Clone the mesh hierarchy to preserve Deform/Spin nodes
                const ghostMesh = b.mesh.clone();
                
                // Ensure visibility and add to scene
                this.game.scene.add(ghostMesh);
                
                // Re-bind internal references for the physics engine
                // Hierarchy: Mesh -> DeformNode -> SpinNode
                const deformNode = ghostMesh.children[0];
                const spinNode = deformNode ? deformNode.children[0] : null;

                // Determine Trail Color based on Tech
                let trailColor = 0xff4400; // Default SH (Orange)
                if (b.technique) {
                    if (b.technique.type === 'venom') trailColor = 0xaa00ff;
                    else if (b.technique.type === 'wither') trailColor = 0x888888;
                    else if (b.technique.type === 'nap') trailColor = 0x000088;
                    else if (b.technique.type === 'sphere') trailColor = 0x00ffff;
                    else if (b.technique.type === 'jecht') trailColor = 0xff0000;
                    else if (b.technique.type === 'invisible') trailColor = 0x444444;
                } else if (b.powerType === 'PA') {
                    trailColor = 0x00aaff; // Pass (Blue)
                }

                // Create Trail
                const trail = new window.flux.TrailRenderer(this.game.scene);
                trail.active = true;
                trail.setColor(trailColor);
                trail.reset(ghostMesh.position);

                // Create a "Mock" Ball object that satisfies Ball.js physics requirements
                const ghostBall = {
                    mesh: ghostMesh,
                    deformNode: deformNode,
                    spinNode: spinNode,
                    velocity: b.velocity.clone(),
                    angularVelocity: b.angularVelocity ? b.angularVelocity.clone() : new THREE.Vector3(),
                    accumulatedRotation: b.accumulatedRotation ? b.accumulatedRotation.clone() : new THREE.Quaternion(),
                    state: 'free',
                    power: b.power,
                    powerType: b.powerType,
                    technique: b.technique,
                    isInvisible: b.isInvisible,
                    life: 5.0, // Enough time to reach goal
                    trail: trail,
                    _bubbleTimer: 0,
                    _ghost: true,
                    // Mock methods
                    reset: () => {}, 
                    drop: () => {},
                    reveal: () => {}
                };

                // Apply visibility
                ghostMesh.visible = !b.isInvisible;

                this.ghostBalls.push(ghostBall);

// 2. Reset Real Ball to Player INSTANTLY
                b.velocity.set(0, 0, 0);
                b.angularVelocity.set(0, 0, 0);
                
                // FIX: Force ball position to be explicitly in front of the player
                // This prevents any logic from thinking the ball is behind and triggering a turn
                const fwd = new THREE.Vector3(0, 0, 1).applyQuaternion(p.mesh.quaternion);
                b.mesh.position.copy(p.mesh.position).add(fwd.multiplyScalar(0.8));
                b.mesh.position.y += 1.0;

                // Manual Attach (Bypass 'catch' animation)
                b.holder = p;
                b.state = 'held';
                p.hasBall = true;
                
                // Reset Player Throw State so they can fire again immediately
                p.isThrowing = false;
                p.catchCooldown = 0;

                // Sync rotation to prevent snapping
                if (p.syncRotation) p.syncRotation();
            }
            
            // Ensure infinite stats
            p.currentEN = p.stats.EN;
            p.stats.HP = p.stats.maxHP;
        }

        _showPanel() {
            if (this.ui) this.ui.classList.add('active');
        }

        _hidePanel() {
            if (this.ui) this.ui.classList.remove('active');
        }

        _showRestoreBtn() {
            const btn = document.getElementById('practice-restore-btn');
            if (btn) btn.style.display = 'block';
        }

        _hideRestoreBtn() {
            const btn = document.getElementById('practice-restore-btn');
            if (btn) btn.style.display = 'none';
        }
    }
window.flux.PracticeManager = PracticeManager;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    // --- High-Quality Noise Texture Generator ---
    window.flux.noiseTexture = (() => {
        const size = 512;
        const c = document.createElement('canvas');
        c.width = size; c.height = size;
        const ctx = c.getContext('2d');
        
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, size, size);
        
        // Generate seamless noise (Perlin-ish via layered random circles/gradients)
        const drawNoiseLayer = (scale, alpha) => {
            ctx.globalAlpha = alpha;
            ctx.globalCompositeOperation = 'lighter'; // Additive
            const count = 300 * scale;
            for(let i=0; i<count; i++) {
                const x = Math.random() * size;
                const y = Math.random() * size;
                const r = (Math.random() * 30 + 10) / scale;
                
                const g = ctx.createRadialGradient(x, y, 0, x, y, r);
                g.addColorStop(0, '#888888');
                g.addColorStop(1, 'transparent');
                
                ctx.fillStyle = g;
                ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
                
                // Wrap around for seamless tiling
                [[x-size, y], [x+size, y], [x, y-size], [x, y+size]].forEach(pos => {
                    const g2 = ctx.createRadialGradient(pos[0], pos[1], 0, pos[0], pos[1], r);
                    g2.addColorStop(0, '#888888');
                    g2.addColorStop(1, 'transparent');
                    ctx.fillStyle = g2;
                    ctx.beginPath(); ctx.arc(pos[0], pos[1], r, 0, Math.PI*2); ctx.fill();
                });
            }
        };
        
        drawNoiseLayer(1.0, 0.3);
        drawNoiseLayer(2.0, 0.2);
        drawNoiseLayer(4.0, 0.1);
        
        const tex = new THREE.CanvasTexture(c);
        tex.wrapS = THREE.RepeatWrapping;
        tex.wrapT = THREE.RepeatWrapping;
        return tex;
    })();

    class WaterOverlay {
        constructor(camera) {
            this.camera = camera;
            
            // Fullscreen quad
            const geometry = new THREE.PlaneGeometry(2, 2);
            
            const vert = `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = vec4(position, 1.0);
                }
            `;

            const frag = `
                precision mediump float;
                uniform float uTime;
                uniform float uOpacity;
                uniform sampler2D tNoise;
                varying vec2 vUv;

                // FFX Palette (Additive Friendly)
                const vec3 C_DEEP = vec3(0.0, 0.05, 0.2);     // Deep Blue
                const vec3 C_GLOW = vec3(0.0, 0.6, 0.9);      // Cyan Glow
                const vec3 C_RAY  = vec3(0.5, 0.8, 1.0);      // Light Shafts
                const vec3 C_PYRE = vec3(1.0, 0.85, 0.5);     // Pyrefly Gold

                // 4x4 Bayer Matrix for Ordered Dithering
                float bayer4x4(vec2 uv) {
                    int x = int(mod(uv.x, 4.0));
                    int y = int(mod(uv.y, 4.0));
                    float v = 0.0;
                    if (y == 0) { if (x == 0) v = 0.0; else if (x == 1) v = 8.0; else if (x == 2) v = 2.0; else v = 10.0; }
                    else if (y == 1) { if (x == 0) v = 12.0; else if (x == 1) v = 4.0; else if (x == 2) v = 14.0; else v = 6.0; }
                    else if (y == 2) { if (x == 0) v = 3.0; else if (x == 1) v = 11.0; else if (x == 2) v = 1.0; else v = 9.0; }
                    else { if (x == 0) v = 15.0; else if (x == 1) v = 7.0; else if (x == 2) v = 13.0; else v = 5.0; }
                    return v / 16.0;
                }

                void main() {
                    vec2 uv = vUv;
                    float t = uTime * 0.12;

                    // 1. Distortion (Lookup 1)
                    float warp = texture2D(tNoise, uv * 0.4 + vec2(t * 0.04, t * 0.02)).r;
                    
                    // 2. Caustics (Lookup 2)
                    vec2 cUV = uv * 2.0 + vec2(warp * 0.5, warp * 0.2) - vec2(t * 0.05);
                    float c = texture2D(tNoise, cUV).r;
                    
                    c = (c - 0.4) * 2.5;
                    c = max(0.0, c);
                    c = pow(c, 3.0); // Sharper caustics
                    
                    float caustic = c * 10.0;
                    vec3 causticColor = vec3(caustic * 0.7, caustic, caustic * 1.3);

                    // 3. Rays (Lookup 3)
                    vec2 rayUV = vec2(uv.x + warp * 0.1, uv.y * 0.15 - t * 0.05);
                    float rays = texture2D(tNoise, rayUV).r;
                    rays = rays * rays;
                    
                    float rayMask = 1.0 - abs(uv.y * 2.0 - 1.0);
                    rays *= max(0.0, rayMask);

                    // 4. Pyreflies
                    vec2 p = uv * 6.0;
                    vec2 id = floor(p);
                    vec2 sub = fract(p) - 0.5;
                    
                    float n = fract(sin(dot(id, vec2(12.9898, 78.233))) * 43758.5453);
                    float px = fract(n * 13.0 + t * 0.3) - 0.5;
                    float py = fract(n * 7.0 + t * 0.2) - 0.5;
                    
                    vec2 flyPos = vec2(px, py);
                    float d2 = dot(sub - flyPos, sub - flyPos);
                    
                    float fly = 0.0006 / (d2 + 0.0005);
                    fly *= step(0.6, n); 
                    fly *= 0.5 + 0.5 * sin(t * 5.0 + n * 10.0);

                    // Composition
                    vec3 finalCol = vec3(0.0);

                    // Vignette
                    vec2 vd = uv - 0.5;
                    float vSq = dot(vd, vd);
                    float vig = vSq * 1.5; 
                    finalCol += C_DEEP * vig;

                    finalCol += causticColor * C_GLOW * 0.5;
                    finalCol += rays * C_RAY * 0.4;
                    finalCol += fly * C_PYRE;

                    // --- PSX DITHERING & QUANTIZATION ---
                    
                    // 1. Get Dither Value (Screen Space)
                    float dither = bayer4x4(gl_FragCoord.xy);
                    
                    // 2. Color Depth Reduction (e.g. 32 levels = 5 bit)
                    float colorDepth = 32.0;
                    
                    // 3. Apply Dither to Color
                    // We add noise before quantization to smooth bands
                    // The magnitude is 1/Depth centered around 0
                    vec3 dithered = finalCol + (dither - 0.5) * (1.0 / colorDepth);
                    
                    // 4. Quantize
                    dithered = floor(dithered * colorDepth) / colorDepth;
                    
                    // 5. Dithered Alpha/Intensity
                    // Instead of simple alpha blending, we can use dither to break up faint details
                    // This gives that "crunchy" look in dark areas
                    float intensity = length(dithered);
                    // Boost shadows with dither noise
                    dithered += (dither - 0.5) * 0.02;

                    gl_FragColor = vec4(dithered, uOpacity);
                }
            `;

            this.material = new THREE.ShaderMaterial({
                uniforms: {
                    uTime: { value: 0 },
                    uOpacity: { value: 0.5 },
                    tNoise: { value: window.flux.noiseTexture }
                },
                vertexShader: vert,
                fragmentShader: frag,
                transparent: true,
                depthTest: false,
                depthWrite: false,
                blending: THREE.AdditiveBlending // Additive blending prevents dark occlusion
            });

            this.mesh = new THREE.Mesh(geometry, this.material);
            this.mesh.frustumCulled = false;
            this.mesh.renderOrder = 9999;
            
            // Add to camera so it stays on screen
            this.camera.add(this.mesh);
        }
        
        update(dt) {
            if (this.material) {
                this.material.uniforms.uTime.value += dt;
            }
        }
    }
    
    window.flux.WaterOverlay = WaterOverlay;
})();</script>
<script>(function() {
    window.flux = window.flux || {};

    class LightShafts {
        constructor(scene) {
            this.scene = scene;
            this.mesh = null;
            this.uniforms = {
                uTime: { value: 0 },
                tNoise: { value: null }
            };

            this._init();
        }

_init() {
            // Geometry: A cluster of cones/cylinders
            // We use a single geometry with instancing or merged geometry for performance,
            // but for simplicity and aesthetic control, let's use a few large planes or a cylinder.
            // A large cylinder with open ends works well for a "pool" shaft effect.
            
            // Increased length to 90 to accommodate tilt without clipping top/bottom
            const geometry = new THREE.CylinderGeometry(30, 20, 90, 32, 1, true);
            
            // Shader
            const vert = `
                varying vec2 vUv;
                varying vec3 vPos;
                void main() {
                    vUv = uv;
                    vPos = position;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `;

            const frag = `
                uniform float uTime;
                uniform sampler2D tNoise;
                varying vec2 vUv;
                varying vec3 vPos;

                void main() {
                    // Vertical fade (Soft top and bottom)
                    float alpha = smoothstep(0.0, 0.3, vUv.y) * smoothstep(1.0, 0.6, vUv.y);

                    // Scrolling Rays
                    // Layer 1: Slow, broad rays
                    float n1 = texture2D(tNoise, vec2(vUv.x * 2.0 + uTime * 0.02, vUv.y * 0.5 - uTime * 0.05)).r;
                    
                    // Layer 2: Fast, interference rays
                    float n2 = texture2D(tNoise, vec2(vUv.x * 3.0 - uTime * 0.03, vUv.y * 0.5 - uTime * 0.1)).r;

                    float rays = n1 * n2;
                    // Boost intensity significantly (Removed pow to prevent crushing)
                    rays = rays * 3.0; 

                    // Glistening Sparkles (High frequency noise)
                    float sparkle = texture2D(tNoise, vUv * vec2(8.0, 2.0) + vec2(uTime * 0.1, uTime * 0.3)).r;
                    sparkle = pow(sparkle, 5.0) * 10.0; // Sharp points

                    // Color: Cyan/Blue/White (Brighter base)
                    vec3 color = vec3(0.6, 0.9, 1.0);
                    
                    // Combine (Higher multipliers)
                    float finalAlpha = (rays * 0.8 + sparkle * 0.4) * alpha;
                    
                    // Distance fade (optional, handled by fog usually but we want additive)
                    gl_FragColor = vec4(color, finalAlpha);
                }
            `;

            const material = new THREE.ShaderMaterial({
                uniforms: this.uniforms,
                vertexShader: vert,
                fragmentShader: frag,
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                side: THREE.DoubleSide
            });

            // Container for the angle (Realistic Light Source)
            this.container = new THREE.Group();
            // Angle: Coming from top-left (simulating surface sun penetrating deep water)
            this.container.rotation.z = Math.PI / 5; // ~36 degrees tilt
            this.container.rotation.x = Math.PI / 10; // ~18 degrees forward
            this.container.position.set(12, 8, 0); // Offset source to hit arena center
            this.scene.add(this.container);

            this.mesh = new THREE.Mesh(geometry, material);
            this.mesh.renderOrder = 100; 
            this.mesh.position.set(0, 0, 0);
            this.container.add(this.mesh);

            // Add a second layer for core intensity
            const coreGeo = new THREE.CylinderGeometry(12, 8, 90, 16, 1, true);
            this.coreMesh = new THREE.Mesh(coreGeo, material);
            this.coreMesh.renderOrder = 100;
            this.container.add(this.coreMesh);
        }

        update(dt) {
            this.uniforms.uTime.value += dt;
            
            // Lazy load texture
            if (!this.uniforms.tNoise.value && window.flux.noiseTexture) {
                this.uniforms.tNoise.value = window.flux.noiseTexture;
                // Ensure wrapping is correct for the cylinder UVs
                window.flux.noiseTexture.wrapS = THREE.RepeatWrapping;
                window.flux.noiseTexture.wrapT = THREE.RepeatWrapping;
            }

            // Slowly rotate shafts for dynamic feel
            if (this.mesh) this.mesh.rotation.y += dt * 0.02;
            if (this.coreMesh) this.coreMesh.rotation.y -= dt * 0.03;
        }
    }

    window.flux.LightShafts = LightShafts;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

// Reusable Glow for Lights
    const _glowTexture = (() => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
        g.addColorStop(0, 'rgba(255, 255, 255, 1)');
        g.addColorStop(0.4, 'rgba(0, 170, 255, 0.4)');
        g.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, 64, 64);
        return new THREE.CanvasTexture(c);
    })();

    const _glowMaterial = new THREE.SpriteMaterial({ 
        map: _glowTexture, 
        transparent: true, 
        blending: THREE.AdditiveBlending,
        depthWrite: false
    });

    class Stadium {
        constructor(scene) {
            this.scene = scene;
            this.container = new THREE.Group();
            this.scene.add(this.container);

            // Config for "Herculean" scale
// Config for "Herculean" scale
            this.config = {
                radius: 60,       // Start outside the arena (48 radius)
                tiers: 6,         // Number of seating rings
                tierHeight: 12,
                tierDepth: 15,
                crowdCount: 8000, // Increased density
                structureColor: 0x080c10, // Deep dark blue/black
                lightColor: 0x00aaff
            };

this.rings = [];
            this.lightSprites = []; // Store light sprites for cinematic control
            this.crowd = null;
            this.crowd = null;

this._buildArchitecture();
            this._buildCrowd();
            this._buildHerculeanRings();
            this._buildStadiumLights();
        }

        _buildArchitecture() {
            // 1. The Void Bowl (Background Occluder)
            // Massive cylinder to block the void
            const bowlGeo = new THREE.CylinderGeometry(180, 50, 120, 32, 1, true);
            const bowlMat = new THREE.MeshBasicMaterial({ 
                color: this.config.structureColor, 
                side: THREE.BackSide,
                fog: true 
            });
            const bowl = new THREE.Mesh(bowlGeo, bowlMat);
            bowl.position.y = 20;
            this.container.add(bowl);

            // 2. Seating Tiers (Concentric Rings)
            const tierMat = new THREE.MeshBasicMaterial({ color: 0x111a22, side: THREE.DoubleSide });
            const rimMat = new THREE.MeshBasicMaterial({ color: 0x004466 });

            for(let i=0; i<this.config.tiers; i++) {
                const y = (i * this.config.tierHeight) - 30;
                const rInner = this.config.radius + (i * (this.config.tierDepth * 0.8));
                const rOuter = rInner + this.config.tierDepth;
                
                // Floor Ring
                const ringGeo = new THREE.RingGeometry(rInner, rOuter, 64);
                ringGeo.rotateX(-Math.PI / 2);
                const mesh = new THREE.Mesh(ringGeo, tierMat);
                mesh.position.y = y;
                this.container.add(mesh);
                
                // Glowing Rim (The "Tech" feel)
                const rimGeo = new THREE.TorusGeometry(rInner, 0.8, 4, 64);
                rimGeo.rotateX(Math.PI / 2);
                const rim = new THREE.Mesh(rimGeo, rimMat);
                rim.position.y = y;
                this.container.add(rim);
            }

            // 3. Massive Pillars (The "Herculean" Support)
            const pillarGeo = new THREE.BoxGeometry(8, 200, 8);
            const pillarMat = new THREE.MeshBasicMaterial({ color: 0x050505 });
            
            for(let i=0; i<8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const r = 140; // Far out
                const mesh = new THREE.Mesh(pillarGeo, pillarMat);
                mesh.position.set(Math.cos(angle)*r, 0, Math.sin(angle)*r);
                mesh.lookAt(0,0,0);
                this.container.add(mesh);
            }
        }

_buildCrowd() {
            // Instanced Mesh for Crowd (Low Poly, High Count)
            // Using a simple vertical plane that faces center
            const geo = new THREE.PlaneGeometry(1.2, 2.5);
            
            // --- CROWD SHADER IMPLEMENTATION ---
            // Add instance-specific random offset for animation variation
            const offsets = new Float32Array(this.config.crowdCount);
            for(let i=0; i<this.config.crowdCount; i++) {
                offsets[i] = Math.random();
            }
            geo.setAttribute('aOffset', new THREE.InstancedBufferAttribute(offsets, 1));

            // Custom Shader via onBeforeCompile
            const mat = new THREE.MeshBasicMaterial({ side: THREE.DoubleSide });
            
            mat.onBeforeCompile = (shader) => {
                shader.uniforms.uTime = { value: 0 };
                this.crowdUniforms = shader.uniforms;

                shader.vertexShader = `
                    uniform float uTime;
                    attribute float aOffset;
                    varying float vJump; // Pass to fragment for color variation
                ` + shader.vertexShader;

                shader.vertexShader = shader.vertexShader.replace(
                    '#include <begin_vertex>',
                    `
                    #include <begin_vertex>
                    
                    // Animation Logic
                    float speed = 8.0;
                    float t = uTime * speed + (aOffset * 100.0);
                    
                    // Jump (Sine wave clipped)
                    float jump = max(0.0, sin(t));
                    jump = pow(jump, 2.0); // Sharpen the jump curve
                    
                    // Randomize jump height slightly
                    float height = 0.5 + 0.5 * aOffset;
                    
                    transformed.y += jump * height;
                    
                    // Sway (Side to side)
                    transformed.x += cos(t * 0.5) * 0.1;
                    
                    vJump = jump;
                    `
                );

                shader.fragmentShader = `
                    varying float vJump;
                ` + shader.fragmentShader;

                shader.fragmentShader = shader.fragmentShader.replace(
                    'vec4 diffuseColor = vec4( diffuse, opacity );',
                    `
                    vec4 diffuseColor = vec4( diffuse, opacity );
                    
                    // Brighten when jumping (Cheering effect)
                    diffuseColor.rgb += vec3(0.2) * vJump;
                    `
                );
            };
            
this.crowd = new THREE.InstancedMesh(geo, mat, this.config.crowdCount);
            this.crowd.instanceMatrix.setUsage(THREE.DynamicDrawUsage);
            
            // Optimization: Enable culling and manually set bounding sphere to cover the whole stadium
            // This prevents GPU from processing 2500 instances when the entire structure is out of view
            this.crowd.frustumCulled = true;
            this.crowd.geometry.boundingSphere = new THREE.Sphere(new THREE.Vector3(0, 0, 0), 150);
            
            const dummy = new THREE.Object3D();
            const color = new THREE.Color();
            
// 1. Calculate Total Circumference for distribution to ensure all tiers get people
            let totalCirc = 0;
            const tierRadii = [];
            for(let t=0; t<this.config.tiers; t++) {
                const rMin = this.config.radius + (t * (this.config.tierDepth * 0.8)) + 2;
                const circ = 2 * Math.PI * rMin;
                totalCirc += circ;
                tierRadii.push({ rMin: rMin, circ: circ });
            }

            let idx = 0;
            for(let t=0; t<this.config.tiers; t++) {
                const yBase = (t * this.config.tierHeight) - 30;
                const { rMin, circ } = tierRadii[t];
                const rMax = rMin + this.config.tierDepth - 2;
                
                // Distribute proportionally so upper rows don't get cut off
                const countPerTier = Math.floor(this.config.crowdCount * (circ / totalCirc));
                
                for(let i=0; i<countPerTier; i++) {
                    if (idx >= this.config.crowdCount) break;

                    const angle = Math.random() * Math.PI * 2;
                    const r = rMin + Math.random() * (rMax - rMin);
                    
                    dummy.position.set(
                        Math.cos(angle) * r,
                        yBase + 1.25, // Center of quad
                        Math.sin(angle) * r
                    );
                    
                    // Face center
                    dummy.lookAt(0, yBase, 0);
                    dummy.updateMatrix();
                    
                    this.crowd.setMatrixAt(idx, dummy.matrix);
                    
                    // Random Team Colors (Simulating fans)
                    const rand = Math.random();
                    if (rand < 0.45) color.setHex(0x0088ff); // Home Blue
                    else if (rand < 0.9) color.setHex(0xff4444); // Away Red
                    else color.setHex(0xffffff); // Neutral/Flash
                    
                    // Vary brightness for depth
                    color.multiplyScalar(0.5 + Math.random() * 0.5);
                    
                    this.crowd.setColorAt(idx, color);
                    idx++;
                }
            }
            
            this.container.add(this.crowd);
        }

        _buildHerculeanRings() {
            // Massive floating rings that rotate slowly
            const mat = new THREE.MeshBasicMaterial({ 
                color: 0x445566, 
                transparent: true, 
                opacity: 0.3,
                wireframe: true // Tech/Holographic feel
            });

            // 1. Equatorial Ring (Massive)
            const geo1 = new THREE.TorusGeometry(110, 1, 16, 100);
            const ring1 = new THREE.Mesh(geo1, mat);
            ring1.rotation.x = Math.PI / 2;
            this.container.add(ring1);
            this.rings.push({ mesh: ring1, axis: 'z', speed: 0.01 });

            // 2. Tilted Ring
            const geo2 = new THREE.TorusGeometry(130, 2, 16, 100);
            const ring2 = new THREE.Mesh(geo2, mat);
            ring2.rotation.x = Math.PI / 3;
            this.container.add(ring2);
            this.rings.push({ mesh: ring2, axis: 'y', speed: -0.008 });
            
            // 3. Vertical Ring
            const geo3 = new THREE.TorusGeometry(150, 3, 16, 100);
const ring3 = new THREE.Mesh(geo3, mat);
            this.container.add(ring3);
            this.rings.push({ mesh: ring3, axis: 'y', speed: 0.005 });
        }

        _buildStadiumLights() {
            const count = 16; // Number of lights around the equator
            const radius = 36; // Just outside the arena boundary (32)
            const yPos = 0; // Middle of the sphere
            
            const lightGeo = new THREE.SphereGeometry(0.4, 8, 8);
            const lightMat = new THREE.MeshBasicMaterial({ color: 0xffffff });

            for(let i=0; i<count; i++) {
                const angle = (i / count) * Math.PI * 2;
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;

                // 1. Physical Fixture (The bulb)
                const mesh = new THREE.Mesh(lightGeo, lightMat);
                mesh.position.set(x, yPos, z);
                this.container.add(mesh);

                // 2. Visual Glow (Flare)
                const sprite = new THREE.Sprite(_glowMaterial);
// 2. Visual Glow (Flare)

                sprite.position.set(x, yPos, z);
                sprite.scale.set(8, 8, 1); // Large glow
                this.container.add(sprite);
                this.lightSprites.push(sprite);

// 3. Actual Point Light - REMOVED for optimization
                // Since we use MeshBasicMaterial (Unlit), real lights waste CPU/GPU resources.
                // The sprite glow above provides the visual effect.
            }
        }
update(dt) {
            // Animate Rings
            this.rings.forEach(r => {
                if (r.mesh && r.axis) {
                    r.mesh.rotation[r.axis] += r.speed * dt;
                }
            });

            // Update Crowd Shader
            if (this.crowdUniforms) {
                this.crowdUniforms.uTime.value += dt;
            }

            // Update Light Pops (Cinematic)
            this.lightSprites.forEach(s => {
                if (s.visible && s.scale.x > 8.0) {
                    // Decay pop effect
                    s.scale.x -= dt * 30.0;
                    s.scale.y -= dt * 30.0;
                    if (s.scale.x < 8.0) s.scale.set(8, 8, 1);
                }
            });
        }

setAllLights(visible) {
            this.lightSprites.forEach(s => {
                s.visible = visible;
                s.scale.set(8, 8, 1); // Reset scale
            });
        }

        get lightCount() {
            return this.lightSprites.length;
        }

        resetLights() {
            this.setAllLights(false);
        }

        turnOnLight(index) {

            if (this.lightSprites[index]) {
                const s = this.lightSprites[index];
                s.visible = true;
                s.material.opacity = 1.0;
                s.scale.set(20, 20, 1); // Pop effect
            }
        }
    }

    window.flux.Stadium = Stadium;
})();</script>
    <script>(function() {
    window.flux = window.flux || {};

    class AudioManager {
        constructor() {
            // --- BGM SYSTEM (HTML5 Audio for streaming) ---
            this.bgm = new Audio();
            this.bgm.src = 'https://files.catbox.moe/sp2yhy.mp3'; // Existing BGM
            this.bgm.loop = true;
this.bgm.loop = true;
            this.bgm.volume = 0.5;
            
            // --- SFX SYSTEM (Web Audio API for precision & variance) ---
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
            
            this.sfxBuffers = new Map();
            
            // Master Gain for SFX
            this.sfxGain = this.ctx.createGain();
            this.sfxGain.connect(this.ctx.destination);
            this.sfxGain.gain.value = 0.5;

            // Volume State
this.masterVolume = 0.8; // Increased from 0.5
            this.bgmLevel = 1.0;
            this.sfxLevel = 1.0;
            this.isMuted = false;
            this.shouldBePlaying = false;

            // --- SFX DICTIONARY (Public Domain / CC0) ---
            // Note: These are direct links to Pixabay Audio (Public Domain).
            // In a production environment, these should be hosted locally to avoid hotlinking issues.
this.sfxLibrary = {
                // Throw: Fast whoosh/swish
                'throw': 'https://cdn.pixabay.com/download/audio/2022/03/24/audio_07659d95f0.mp3?filename=whoosh-motion-2-102589.mp3',
                
                // Catch: Leather glove impact (using punch/thud as proxy)
                'catch': 'https://cdn.pixabay.com/download/audio/2022/03/15/audio_273f0f7f32.mp3?filename=punch-140236.mp3',
                
                // Tackle: Heavy body thud
                'tackle': 'https://cdn.pixabay.com/download/audio/2021/08/09/audio_03e622602d.mp3?filename=body-impact-42777.mp3',
                
                // Swim: Water splashing
                'swim': 'https://cdn.pixabay.com/download/audio/2022/03/10/audio_c8c8a73467.mp3?filename=water-splash-80527.mp3',
                
                // Goal: Crowd cheer
                'goal': 'https://cdn.pixabay.com/download/audio/2021/08/04/audio_12b0c7443c.mp3?filename=crowd-cheer-ii-6263.mp3',
                
                // Whistle: Referee whistle
                'whistle': 'https://cdn.pixabay.com/download/audio/2022/03/22/audio_c2b3762b36.mp3?filename=referee-whistle-102972.mp3',
                
                // UI: Blips
                'menu': 'https://cdn.pixabay.com/download/audio/2021/08/04/audio_c6ddf1b39e.mp3?filename=ui-click-43196.mp3',
                
                // Dash: Air cut
                'dash': 'https://cdn.pixabay.com/download/audio/2022/01/18/audio_8db1f115a5.mp3?filename=whoosh-6316.mp3',
                
                // Impact: Heavy hit
                'impact': 'https://cdn.pixabay.com/download/audio/2022/03/15/audio_736f99056c.mp3?filename=punch-2-123369.mp3'
            };

            this._preloadSFX();
            this._initWatchdogs();
        }

_initWatchdogs() {
            // BGM Loop & Resume Logic
            this.bgm.addEventListener('ended', () => {
                if (this.shouldBePlaying && !this.isMuted) {
                    this.bgm.currentTime = 0;
                    this.bgm.play().catch(e => console.warn("BGM Replay fail:", e));
                }
            });

            // Robust Unlock Strategy for Mobile (iOS/Android)
            const unlock = () => {
                // 1. Resume Web Audio Context
                if (this.ctx.state !== 'running') {
                    this.ctx.resume().then(() => {
                        // console.log("AudioContext Resumed via interaction");
                    }).catch(e => console.warn("AudioContext Resume fail:", e));
                }

                // 2. Play Silent Buffer (Crucial for iOS wake-up)
                // Creates a tiny empty buffer and plays it instantly to engage the audio engine
                try {
                    const buffer = this.ctx.createBuffer(1, 1, 22050);
                    const source = this.ctx.createBufferSource();
                    source.buffer = buffer;
                    source.connect(this.ctx.destination);
                    source.start(0);
                } catch (e) {
                    // Ignore errors here
                }

                // 3. Resume HTML5 BGM if needed
                if (this.shouldBePlaying && this.bgm.paused && !this.isMuted) {
                    this.bgm.play().catch(e => {
                        // console.warn("BGM Resume fail:", e);
                    });
                }

                // 4. Cleanup listeners
                ['click', 'touchstart', 'touchend', 'keydown', 'mousedown'].forEach(evt => {
                    document.removeEventListener(evt, unlock, true);
                });
            };

            // Attach aggressive listeners
            const opts = { capture: true, passive: true };
            ['click', 'touchstart', 'touchend', 'keydown', 'mousedown'].forEach(evt => {
                document.addEventListener(evt, unlock, opts);
            });
        }

        _preloadSFX() {
            for (const [id, url] of Object.entries(this.sfxLibrary)) {
                this.loadSFX(id, url);
            }
        }

        async loadSFX(id, url) {
            try {
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await this.ctx.decodeAudioData(arrayBuffer);
                this.sfxBuffers.set(id, audioBuffer);
                // console.log(`SFX Loaded: ${id}`);
            } catch (e) {
                console.warn(`AudioManager: Failed to load SFX '${id}' from ${url}`, e);
            }
        }

        playSFX(id, options = {}) {
            if (this.isMuted) return;
            if (this.ctx.state === 'suspended') this.ctx.resume();

            const buffer = this.sfxBuffers.get(id);
            if (!buffer) return;

            const source = this.ctx.createBufferSource();
            source.buffer = buffer;

            // Pitch Variance (prevents repetitive fatigue)
// Pitch Variance & Base Rate
            const variance = options.variance !== undefined ? options.variance : 0.1;
            let rate = options.rate !== undefined ? options.rate : 1.0;

            if (variance > 0) {
                // Random rate between (rate - variance) and (rate + variance)
                rate += (Math.random() * variance * 2 - variance);
            }
            // Clamp rate to sane limits
            source.playbackRate.value = Math.max(0.1, Math.min(4.0, rate));

            // Volume
            const gainNode = this.ctx.createGain();
            const vol = options.volume !== undefined ? options.volume : 1.0;
            gainNode.gain.value = vol;

            // Graph: Source -> Gain -> MasterSFXGain -> Destination
            source.connect(gainNode);
            gainNode.connect(this.sfxGain);

            source.start(0);
        }

        // --- BGM CONTROLS ---

        playBGM() {
            if (this.isMuted) return;
            this.shouldBePlaying = true;
            this.bgm.play().catch(e => console.log("BGM Autoplay prevented, waiting for interaction."));
        }

        stopBGM() {
            this.shouldBePlaying = false;
            this.bgm.pause();
            this.bgm.currentTime = 0;
        }

        pauseBGM() {
            this.shouldBePlaying = false;
            this.bgm.pause();
        }

        resumeBGM() {
            if (!this.isMuted && this.shouldBePlaying) {
                this.bgm.play().catch(e => {});
            }
        }

setMasterVolume(volume) {
            this.masterVolume = Math.max(0, Math.min(1, volume));
            this._updateVolumes();
        }

        setBGMLevel(level) {
            this.bgmLevel = Math.max(0, level);
            this._updateVolumes();
        }

        setSFXLevel(level) {
            this.sfxLevel = Math.max(0, level);
            this._updateVolumes();
        }

        _updateVolumes() {
            if (this.bgm) {
                this.bgm.volume = Math.min(1, this.masterVolume * this.bgmLevel);
            }
            if (this.sfxGain) {
                this.sfxGain.gain.value = this.masterVolume * this.sfxLevel;
            }
        }

        toggleMute() {
            this.isMuted = !this.isMuted;
            if (this.isMuted) {
                this.bgm.pause();
                this.ctx.suspend();
            } else {
                if (this.shouldBePlaying) this.bgm.play().catch(e=>{});
                this.ctx.resume();
            }
            return this.isMuted;
        }
    }

    window.flux.AudioManager = AudioManager;
})();</script>
    <script>(function() {
    // Namespace
    window.flux = window.flux || {};
    window.flux._runtimeUpdaters = window.flux._runtimeUpdaters || [];

    // Config
const _config = {
        internalWidth: 360,
        internalHeight: 640,
        bgColor: 0x001e36,
        fogColor: 0x001e36,
        fogDensity: 0.0001, // Drastically reduced to ensure visibility
        arenaRadius: 48.0
    };

    // Globals
// Globals
    const _input = { x: 0, y: 0 }; // Input state
    
    // Shader Uniforms
    const _arenaUniforms = {
        uTime: { value: 0 },
        uImpactPos: { value: new THREE.Vector3() },
        uImpactStr: { value: 0.0 }
    };
    const _particleUniforms = {
        uTime: { value: 0 }
    };

    // Expose Impact Trigger
    window.flux.triggerArenaImpact = function(pos, strength) {
        _arenaUniforms.uImpactPos.value.copy(pos);
        _arenaUniforms.uImpactStr.value = strength * 2.0; // Scale up for visibility
    };
// _input already declared above
    const _tempVec1 = new THREE.Vector3(); // Reusable for physics/logic
    const _tempVec2 = new THREE.Vector3(); // Reusable for physics/logic
    let _scene, _camera, _renderer, _clock;
    let _homeTeam, _awayTeam;
    let _ball;
    let _gameManager;
    let _menuManager;
    let _audioManager;

    let _cameraManager;
    let _waterOverlay;
    let _lightShafts;
    let _stadium;
    let _glyphManager;

    // IMPROVED: Settings object
    const _settings = {
        joystickSensitivity: 1.0,
        aimAssist: true,
        cameraShake: true,
        hitStop: true,
        invertCamera: false,
        autoRecenter: true
    };

    // ---------------------------------------------------------------------
    // Debug IO Bridge (exposed for DevTools JSON snapshots)
    // ---------------------------------------------------------------------
    const _debugIO = window.flux._debugIO = window.flux._debugIO || {};
    _debugIO.settings = _settings;
    _debugIO.input = _debugIO.input || {};
    _debugIO.perf = _debugIO.perf || { frame: 0, rawDt: 0, dt: 0, fps: 0, avgFps: 0 };


    // ---------------------------------------------------------------------
    // Touch helpers (multi-touch safe)
    // ---------------------------------------------------------------------
    function _findTouchById(touchList, id) {
        if (id === null || id === undefined) return null;
        if (!touchList) return null;
        for (let i = 0; i < touchList.length; i++) {
            const t = touchList[i];
            if (t && t.identifier === id) return t;
        }
        return null;
    }

    function _endedTouchById(changedTouches, id) {
        if (id === null || id === undefined) return null;
        if (!changedTouches) return null;
        for (let i = 0; i < changedTouches.length; i++) {
            const t = changedTouches[i];
            if (t && t.identifier === id) return t;
        }
        return null;
    }


    function init() {
        _container = document.getElementById('game-container');

        // 1. Scene
        _scene = new THREE.Scene();
        _scene.background = new THREE.Color(_config.bgColor);
        _scene.fog = new THREE.FogExp2(_config.fogColor, _config.fogDensity);

        // 2. Camera
        const aspect = _config.internalWidth / _config.internalHeight;
_camera = new THREE.PerspectiveCamera(60, aspect, 0.1, 500);
_camera.position.set(0, 14, 22);
        _camera.lookAt(0, 0, 0);
        _scene.add(_camera); // Ensure camera is in scene for children to render

        // 3. Renderer
// 3. Renderer
        _renderer = new THREE.WebGLRenderer({ 
            antialias: false,
            powerPreference: "high-performance",
            precision: "mediump", // Mobile optimization: faster shaders
            stencil: false,       // Disable stencil buffer if not used
            depth: true
        });
        _renderer.setPixelRatio(1); // Force 1:1 pixel ratio, we handle scaling via setSize
        _renderer.autoClear = false; // We manage clearing via background or manual calls if needed (though scene.background handles color)
        // Expose renderer for DevTools
        if (_gameManager) _gameManager.renderer = _renderer; 
        else window.flux.gameInstance = { renderer: _renderer }; // Temp hook
_container.appendChild(_renderer.domElement);

// --- Video Overlay Enforcement ---
        // --- Overlay Video Logic Removed (Switched to GIF) ---
        // 5. Environment
        createParticles();
        createArena();
        createHolographicRings();
// 5.5 Game Manager
_gameManager = new window.flux.GameManager(_scene, 'ui-layer', _camera, _renderer);
        
        // 5.5.1 Audio Manager
        _audioManager = new window.flux.AudioManager();
        _gameManager.audioManager = _audioManager;

        // 5.6 Camera Manager
        _cameraManager = new window.flux.CameraManager(_camera, _scene);
        _gameManager.cameraManager = _cameraManager;

        // 5.7 Dev Tools
if (window.flux.DevTools) {
            new window.flux.DevTools(_gameManager);
        }
// 5.8 Water Overlay, Light Shafts, Stadium, Glyphs
        _waterOverlay = new window.flux.WaterOverlay(_camera);
        _lightShafts = new window.flux.LightShafts(_scene);
        _stadium = new window.flux.Stadium(_scene);
        _glyphManager = new window.flux.GlyphManager(_scene);
        
if (_gameManager) {
            _gameManager.glyphManager = _glyphManager;
            _gameManager.waterOverlay = _waterOverlay;
            _gameManager.lightShafts = _lightShafts;
            _gameManager.stadium = _stadium;
        }
        // 6. Teams Setup
        _homeTeam = new window.flux.Team(_scene, 'home', 1, 0x00aaff, true);
        _awayTeam = new window.flux.Team(_scene, 'away', -1, 0xff6666, false);

        // 7. Ball
        _ball = new window.flux.Ball(_scene);

        // IMPROVED: Link ball to camera for smart framing
        _cameraManager.setBall(_ball);

        // 8. Team Roster Models
        const roles = ['LF', 'RF', 'MF', 'LD', 'RD', 'GL'];
        const homeRoster = {
            LF: { name: 'Tidus', url: 'https://cdn.tinyglb.com/models/da788bef258c4f0b8d9ef1acc19c5567.glb' },
            RF: { name: 'Wakka', url: 'https://cdn.tinyglb.com/models/59114c98951647c9b8da74b0bd3636cb.glb' },
            MF: { name: 'Letty', url: 'https://cdn.tinyglb.com/models/43ace34c6fd94215967e842bf909da5e.glb' },
            LD: { name: 'Datto', url: 'https://cdn.tinyglb.com/models/e6d67ecb2e4c4715bd73a40795e1d3d5.glb' },
            RD: { name: 'Jassu', url: 'https://cdn.tinyglb.com/models/8216459567354e63958d4108d828de98.glb' },
            GL: { name: 'Botta', url: 'https://cdn.tinyglb.com/models/ad155efedc0d48fdad09da3e1cae9c97.glb' }
        };

const applyStats = (p, role, isHome) => {
const teamLevel = isHome ? 25 : 8; // Nerfed CPU level significantly (was 15)
            window.flux.Team.generateStats(p, role, teamLevel, isHome);

            if (p.characterName.includes('Tidus')) {
                p.stats.SH += 5;
                p.stats.SP += 3;
            } else if (p.characterName.includes('Wakka')) {
                p.stats.SH += 3;
                p.stats.EN += 5;
            } else if (p.characterName.includes('Brother')) {
                p.stats.SP = 99;
            }

            p._updateDerivedStats();
        };

        let homeLoaded = 0;
        const roleGltfs = {};

        const finalizeTeams = () => {
            roles.forEach(role => {
                const gltf = roleGltfs[role] || roleGltfs.LF;

                const p = (role === 'GL')
                    ? new window.flux.Goalie(_scene, role)
                    : new window.flux.AIPlayer(_scene, role);

                const entry = homeRoster[role];
                p.characterName = entry ? `CPU ${entry.name}` : 'CPU';
                applyStats(p, role, false);

                if (gltf && gltf.scene) {
                    const clone = THREE.SkeletonUtils.clone(gltf.scene);
                    p.setMesh(clone, gltf.animations || []);
                } else {
                    console.warn('Missing GLTF for away role:', role);
                }

                _awayTeam.addPlayer(p);
            });

            const allPlayers = [..._homeTeam.players, ..._awayTeam.players];
            allPlayers.forEach(p => {
                if (p.ballRef === null) p.ballRef = _ball;
            });

            _homeTeam.activePlayer = _homeTeam.players.find(p => p.role === 'MF');

            if (_homeTeam.activePlayer) {
                _homeTeam.activePlayer.techs.tackle = 'venom';
                _homeTeam.activePlayer.techs.shoot = 'sphere';
                console.log('Equipped Home MF with Venom Tackle & Sphere Shot');
            }

const awayMF = _awayTeam.players.find(p => p.role === 'MF');
            // Removed guaranteed Wither tackle for Away MF to reduce difficulty
            _awayTeam.setFormation('Counter');

            const awayGL = _awayTeam.players.find(p => p.role === 'GL');
            // Removed guaranteed Super Goalie for Away GL to make scoring easier

            _homeTeam.assignMarks(_awayTeam);
            _awayTeam.assignMarks(_homeTeam);

            document.getElementById('loading').style.display = 'none';
            if (_gameManager) {
                _gameManager.registerTeams(_homeTeam, _awayTeam, _ball);

                _menuManager = new window.flux.MenuManager(_gameManager);
                _menuManager.show();
            }
        };

roles.forEach(role => {
            const entry = homeRoster[role];
            if (!entry) return;

            const onComplete = () => {
                homeLoaded++;
                if (homeLoaded >= roles.length) {
                    finalizeTeams();
                }
            };

            window.flux.AssetLoader.loadModel(entry.url, (gltf) => {
                roleGltfs[role] = gltf;

                const p = (role === 'GL')
                    ? new window.flux.Goalie(_scene, role)
                    : new window.flux.AIPlayer(_scene, role);

                p.characterName = entry.name;
                applyStats(p, role, true);

                const clone = THREE.SkeletonUtils.clone(gltf.scene);
                p.setMesh(clone, gltf.animations);
                _homeTeam.addPlayer(p);

                onComplete();
            }, undefined, (err) => {
                console.error('Failed to load model', entry.name, entry.url, err);
                
                // Fallback Mesh (Red Box)
                const fallbackGeo = new THREE.BoxGeometry(1, 2, 1);
                const fallbackMat = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true });
                const fallbackMesh = new THREE.Mesh(fallbackGeo, fallbackMat);
                
                // Store dummy in roleGltfs for away team cloning
                roleGltfs[role] = { scene: fallbackMesh, animations: [] };

                const p = (role === 'GL')
                    ? new window.flux.Goalie(_scene, role)
                    : new window.flux.AIPlayer(_scene, role);

                p.characterName = entry.name + " (Error)";
                applyStats(p, role, true);
                
                p.setMesh(fallbackMesh.clone(), []);
                _homeTeam.addPlayer(p);

                onComplete();
            });
        });

        // 8. Input
        setupInputs();

        // 9. Loop
        _clock = new THREE.Clock();
        requestAnimationFrame(animate);

        // Handle resize
        window.addEventListener('resize', onResize);
        onResize();
    }

function createParticles() {
        const count = 1500; // Increased count
        const geometry = new THREE.BufferGeometry();
        const vertices = [];
        const offsets = []; // Random offsets for independent bobbing

        for (let i = 0; i < count; i++) {
            vertices.push(
                (Math.random() - 0.5) * 80, // Wider spread X
                (Math.random() - 0.5) * 50, // Wider spread Y
                (Math.random() - 0.5) * 80  // Wider spread Z
            );
            offsets.push(Math.random() * 100);
        }

        geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
        geometry.setAttribute('aOffset', new THREE.Float32BufferAttribute(offsets, 1));

        const material = new THREE.ShaderMaterial({
            uniforms: _particleUniforms,
            transparent: true,
            depthWrite: false,
            blending: THREE.AdditiveBlending,
vertexShader: `
                uniform float uTime;
                attribute float aOffset;
                varying float vAlpha;
                void main() {
                    vec3 pos = position;
                    // Bobbing motion: Sine wave based on time + random offset
                    float bob = sin(uTime * 0.5 + aOffset) * 2.0;
                    pos.y += bob;
                    
                    vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
                    gl_Position = projectionMatrix * mvPosition;
                    
                    // Size attenuation - Small and shimmery
                    float sizeBase = 2.0 + sin(uTime * 3.0 + aOffset) * 1.0; 
                    gl_PointSize = sizeBase * (20.0 / -mvPosition.z);
                    
                    // Fade based on distance/height
                    vAlpha = 0.5 + 0.5 * sin(uTime * 2.0 + aOffset);
                }
            `,
            fragmentShader: `
                varying float vAlpha;
                void main() {
                    // Soft glow particle (Dust mote)
                    vec2 coord = gl_PointCoord - vec2(0.5);
                    float dist = length(coord);
                    if(dist > 0.5) discard;
                    
                    // Soft falloff for shimmer
                    float strength = 1.0 - (dist * 2.0);
                    strength = pow(strength, 2.0);
                    
                    // Cyan/Blue tint, additive feel
                    gl_FragColor = vec4(0.7, 0.9, 1.0, vAlpha * strength * 0.8);
                }
            `
        });

        const points = new THREE.Points(geometry, material);
        points.frustumCulled = false;
        _scene.add(points);
    }

function createArena() {
        // Group for rotation
        window.flux.arenaGroup = new THREE.Group();
        _scene.add(window.flux.arenaGroup);

        const geometry = new THREE.SphereGeometry(_config.arenaRadius, 32, 32);
        
        // --- 1. Base Sphere (Faint Grid) ---
        const texLoader = new THREE.TextureLoader();
        const arenaTex = texLoader.load('https://i.postimg.cc/W1LsH68Q/file-0000000023ec71f596593829e8118760-(1).png');
        arenaTex.magFilter = THREE.NearestFilter;
        arenaTex.minFilter = THREE.NearestFilter;
        arenaTex.wrapS = THREE.RepeatWrapping;
        arenaTex.wrapT = THREE.RepeatWrapping;
        arenaTex.repeat.set(6, 4);

        const material = new THREE.MeshBasicMaterial({
            map: arenaTex,
            color: 0x446688,
            wireframe: false,
            transparent: true,
            opacity: 0.15, 
            blending: THREE.AdditiveBlending,
            side: THREE.BackSide,
            depthWrite: false
        });
            
        const arena = new THREE.Mesh(geometry, material);
        window.flux.arenaGroup.add(arena);
        window.flux.arenaMesh = arena;

        // --- 2. Inner Hex Grid (Warp Effect) ---
        // Reuse existing hex generation logic but attach to group
        const hexTex = (() => {
            const c = document.createElement('canvas');
            c.width = 512; c.height = 512;
            const ctx = c.getContext('2d');
            ctx.clearRect(0,0,512,512);
            ctx.strokeStyle = 'rgba(0, 255, 255, 0.5)';
            ctx.lineWidth = 2;
            const r = 64;
            const w = r * 2;
            const h = Math.sqrt(3) * r;
            for(let y = -1; y < 512/h + 2; y++) {
                for(let x = -1; x < 512/(w*0.75) + 2; x++) {
                    const cx = x * w * 0.75;
                    const cy = y * h + (x%2===0 ? 0 : h/2);
                    ctx.beginPath();
                    for(let i=0; i<6; i++) {
                        const ang = Math.PI/3 * i;
                        ctx.lineTo(cx + Math.cos(ang)*r, cy + Math.sin(ang)*r);
                    }
                    ctx.closePath();
                    ctx.stroke();
                }
            }
            return new THREE.CanvasTexture(c);
        })();
        hexTex.wrapS = THREE.RepeatWrapping;
        hexTex.wrapT = THREE.RepeatWrapping;
        hexTex.repeat.set(4, 2);

        const arenaUniforms = THREE.UniformsUtils.merge([
            THREE.UniformsLib['common'],
            _arenaUniforms,
            { 
                tMap: { value: hexTex },
                uOpacity: { value: 0.1 } 
            }
        ]);

        const material2 = new THREE.ShaderMaterial({
            uniforms: arenaUniforms,
            transparent: true,
            side: THREE.BackSide,
            blending: THREE.AdditiveBlending,
            depthWrite: false,
            vertexShader: `
                uniform float uTime;
                uniform vec3 uImpactPos;
                uniform float uImpactStr;
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    vec3 pos = position;
                    float dist = distance(pos, uImpactPos);
                    float radius = 20.0;
                    if (dist < radius) {
                        float t = dist / radius;
                        float bulge = (1.0 - t) * (1.0 - t);
                        vec3 normal = normalize(pos);
                        pos += normal * (bulge * uImpactStr);
                    }
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
                }
            `,
            fragmentShader: `
                uniform sampler2D tMap;
                uniform float uImpactStr;
                uniform float uOpacity;
                varying vec2 vUv;
                void main() {
                    vec4 texColor = texture2D(tMap, vUv);
                    float alpha = uOpacity * texColor.a;
                    alpha += uImpactStr * 0.02; 
                    vec3 color = texColor.rgb * vec3(0.2, 0.8, 1.0);
                    gl_FragColor = vec4(color, alpha);
                }
            `
        });

        const arena2 = new THREE.Mesh(geometry, material2);
        arena2.scale.setScalar(0.98);
        window.flux.arenaGroup.add(arena2);
        window.flux.arenaMesh2 = arena2;

        // --- 3. EQUATOR BANDS (Blue and Gold - possession based) ---
        const bandTexLoader = new THREE.TextureLoader();

        // Blue Band (shown when home team has ball) - thin band, no vertical stretch
        const blueBandTex = bandTexLoader.load('https://i.postimg.cc/SQnFpDHN/Blue-band.png');
        blueBandTex.wrapS = THREE.RepeatWrapping;
        blueBandTex.wrapT = THREE.ClampToEdgeWrapping;
        blueBandTex.repeat.set(1, 1); // Single wrap, image tiles naturally

        const blueBandMat = new THREE.MeshBasicMaterial({
            map: blueBandTex,
            transparent: true,
            opacity: 0.35,
            side: THREE.DoubleSide,
            blending: THREE.NormalBlending,
            depthWrite: false
        });
// Thin band - height of 3 to avoid stretching
        const blueBandGeo = new THREE.CylinderGeometry(_config.arenaRadius * 0.96, _config.arenaRadius * 0.96, 3, 64, 1, true);
        const blueBandMesh = new THREE.Mesh(blueBandGeo, blueBandMat);
        blueBandMesh.position.y = 0;
        blueBandMesh.visible = true;
        _scene.add(blueBandMesh);

        // Gold Band (shown when away team has ball)
        const goldBandTex = bandTexLoader.load('https://i.postimg.cc/MZn28dgq/Gold-band.png');
        goldBandTex.wrapS = THREE.RepeatWrapping;
        goldBandTex.wrapT = THREE.ClampToEdgeWrapping;
        goldBandTex.repeat.set(1, 1);

        const goldBandMat = new THREE.MeshBasicMaterial({
            map: goldBandTex,
            transparent: true,
            opacity: 0.35,
            side: THREE.DoubleSide,
            blending: THREE.NormalBlending,
            depthWrite: false
        });
const goldBandGeo = new THREE.CylinderGeometry(_config.arenaRadius * 0.96, _config.arenaRadius * 0.96, 3, 64, 1, true);
        const goldBandMesh = new THREE.Mesh(goldBandGeo, goldBandMat);
        goldBandMesh.position.y = 0;
        goldBandMesh.visible = false;
        _scene.add(goldBandMesh);

        // Store references
        window.flux.blueBandMesh = blueBandMesh;
        window.flux.goldBandMesh = goldBandMesh;
        window.flux.blueBandMat = blueBandMat;
        window.flux.goldBandMat = goldBandMat;

        window.flux.updateBandPossession = function(homeHasBall) {
            if (window.flux.blueBandMesh && window.flux.goldBandMesh) {
                window.flux.blueBandMesh.visible = homeHasBall;
                window.flux.goldBandMesh.visible = !homeHasBall;
            }
        };

        window.flux.tribalUniforms = {
            uTime: { value: 0 },
            uColor: { value: new THREE.Color(0x00ffff) }
        };

        // --- 4. VERTICAL ARROW STRIPS (Around sphere, above & below band) ---
        const arrowTexLoader = new THREE.TextureLoader();
        const arrowTex = arrowTexLoader.load('https://i.postimg.cc/dQhPK4gQ/Yellowarrows.png');
        arrowTex.wrapS = THREE.ClampToEdgeWrapping;
        arrowTex.wrapT = THREE.ClampToEdgeWrapping;

        const arrowMat = new THREE.MeshBasicMaterial({
            map: arrowTex,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending,
            side: THREE.DoubleSide,
            depthWrite: false
        });

        // Create vertical arrow strips around the sphere (curved to match sphere surface)
        const arrowGroup = new THREE.Group();
        const numArrows = 16;   // Number of arrow strips around circumference
        const arrowHeight = 30; // Height of each arrow strip
        const arrowWidth = 6;   // Width of each strip
        const arrowRadius = _config.arenaRadius * 0.94;

        const makeCurvedStrip = (baseAngle, yCenter, flipV = false) => {
            // More segments = smoother curvature (keep modest for mobile)
            const segW = 6;   // curvature resolution (width)
            const segH = 18;  // vertical resolution (height)

            // Convert desired world-space width into an angular span on the sphere
            const phiSpan = arrowWidth / arrowRadius; // radians (approx at equator)
            const phi0 = baseAngle - phiSpan * 0.5;
            const phi1 = baseAngle + phiSpan * 0.5;

            const y0 = yCenter - arrowHeight * 0.5;
            const y1 = yCenter + arrowHeight * 0.5;

            const positions = [];
            const normals = [];
            const uvs = [];
            const indices = [];

            for (let iy = 0; iy <= segH; iy++) {
                const v = iy / segH;
                const y = THREE.MathUtils.lerp(y0, y1, v);

                // Circle radius at this height on the sphere (x/z shrink as |y| grows)
                const ringR = Math.sqrt(Math.max(0.00001, arrowRadius * arrowRadius - y * y));

                for (let ix = 0; ix <= segW; ix++) {
                    const u = ix / segW;
                    const phi = THREE.MathUtils.lerp(phi0, phi1, u);

                    const x = Math.sin(phi) * ringR;
                    const z = Math.cos(phi) * ringR;

                    positions.push(x, y, z);

                    // Outward normal for a sphere centered at origin
                    const invLen = 1.0 / Math.sqrt(x * x + y * y + z * z);
                    normals.push(x * invLen, y * invLen, z * invLen);

                    const vv = flipV ? (1 - v) : v;
                    uvs.push(u, vv);
                }
            }

            const row = segW + 1;
            for (let iy = 0; iy < segH; iy++) {
                for (let ix = 0; ix < segW; ix++) {
                    const a = iy * row + ix;
                    const b = a + 1;
                    const c = a + row;
                    const d = c + 1;

                    indices.push(a, c, b);
                    indices.push(b, c, d);
                }
            }

            const geo = new THREE.BufferGeometry();
            geo.setIndex(indices);
            geo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geo.setAttribute('normal', new THREE.Float32BufferAttribute(normals, 3));
            geo.setAttribute('uv', new THREE.Float32BufferAttribute(uvs, 2));
            geo.computeBoundingSphere();

            return new THREE.Mesh(geo, arrowMat);
        };

        for (let i = 0; i < numArrows; i++) {
            const angle = (i / numArrows) * Math.PI * 2;

            // Upper arrow strip (above band)
            arrowGroup.add(makeCurvedStrip(angle, arrowHeight * 0.5 + 2, false));

            // Lower arrow strip (below band) - flip V so arrows point downward
            arrowGroup.add(makeCurvedStrip(angle, -arrowHeight * 0.5 - 2, true));
        }

        _scene.add(arrowGroup);

        // Store references for DevTools
        window.flux.arrowGroup = arrowGroup;
        window.flux.arrowMat = arrowMat;

        // --- 5. TOP GLYPHS (Dome) --- (Dome) ---
        const topGlyphTex = (() => {
            const c = document.createElement('canvas');
            c.width = 512; c.height = 512;
            const ctx = c.getContext('2d');
            ctx.clearRect(0,0,512,512);
            
            ctx.strokeStyle = 'rgba(100, 200, 255, 0.5)';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(256, 256, 200, 0, Math.PI*2);
            ctx.stroke();
            
            // Intricate pattern
            for(let i=0; i<8; i++) {
                const a = (i/8)*Math.PI*2;
                const x = 256 + Math.cos(a)*150;
                const y = 256 + Math.sin(a)*150;
                ctx.beginPath();
                ctx.arc(x, y, 40, 0, Math.PI*2);
                ctx.stroke();
                // Connector
                ctx.beginPath();
                ctx.moveTo(256, 256);
                ctx.lineTo(x, y);
                ctx.stroke();
            }
            return new THREE.CanvasTexture(c);
        })();

        const topGlyphMat = new THREE.MeshBasicMaterial({
            map: topGlyphTex,
            transparent: true,
            opacity: 0.4,
            blending: THREE.AdditiveBlending,
            side: THREE.DoubleSide,
            depthWrite: false
        });

        const topGlyphGeo = new THREE.PlaneGeometry(60, 60);
        const topGlyph = new THREE.Mesh(topGlyphGeo, topGlyphMat);
        topGlyph.rotation.x = -Math.PI / 2;
        topGlyph.position.y = 35; // Near top of dome
        window.flux.arenaGroup.add(topGlyph);

        // --- NEW: FFX GOAL MODELS ---
        const goalUrl = 'https://cdn.tinyglb.com/models/a516bd90fa7c4dedb5dcbfdf803f13d5.glb';
        
const onGoalLoaded = (model, isFallback) => {
            const goalA = model;
            const goalDist = window.flux.BallConfig.GOAL_DISTANCE || 41.5;
            
            // Moved down ~15ft (4.5m) total as requested, pushed back to edge
            goalA.position.set(0, -6.0, -goalDist);
            if (!isFallback) {
                goalA.scale.setScalar(54.0); // Increased 50% (was 36.0)
            }
            // Setup Goal A
            goalA.traverse(c => {
                if(c.isMesh) {
                    c.frustumCulled = false; // CRITICAL: Prevent culling
                    c.renderOrder = 0;
                    
                    // Ensure material is visible and unique
                    if (c.material) {
                        c.material = c.material.clone(); // Clone for independence
                        c.material.color.setHex(0xffffff); // White to show original texture/colors
                        c.material.transparent = false;
                        c.material.opacity = 1.0;
                        c.material.side = THREE.DoubleSide;
                        c.material.depthWrite = true;
                        c.material.depthTest = true;
                    }
                }
            });
            // Add goals to SCENE, not arenaGroup (they shouldn't rotate with the sphere)
            _scene.add(goalA);
            window.flux.goalA = goalA; // Expose for DevTools

            // Setup Goal B
            const goalB = isFallback ? goalA.clone() : THREE.SkeletonUtils.clone(goalA);

            goalB.position.set(0, -6.0, goalDist); // Moved closer (was 45) and down
            goalB.rotation.y = Math.PI;
            // Ensure Goal B meshes are also persistent and have unique materials
            goalB.traverse(c => {
                if(c.isMesh) {
                    c.frustumCulled = false;
                    if (c.material) {
                        c.material = c.material.clone(); // Clone again for B
                        c.material.transparent = false;
                        c.material.opacity = 1.0;
                        c.material.depthWrite = true;
                    }
                }
            });

            _scene.add(goalB);
            window.flux.goalB = goalB; // Expose for DevTools
        };

        window.flux.AssetLoader.loadModel(goalUrl, (gltf) => {
            onGoalLoaded(gltf.scene, false);
        }, undefined, (err) => {
            console.warn("Goal model failed to load. Using fallback.", err);
            const geo = new THREE.BoxGeometry(75, 45, 10); // Fallback massive box (Scaled 1.5x)
            const fallbackMat = new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true });
            const fallback = new THREE.Mesh(geo, fallbackMat);
            onGoalLoaded(fallback, true);
        });

        // --- NEW: MASSIVE FIELD MARKINGS ---
        createFieldMarkings();
    }

function createFieldMarkings() {
        // Load floor glyph from image
        const texLoader = new THREE.TextureLoader();
        const tex = texLoader.load('https://i.postimg.cc/v8CR85dQ/Floorglyph.png');
        tex.anisotropy = 16;

        // Floor Plane (Deep)
        const geo = new THREE.PlaneGeometry(90, 90);
        const mat = new THREE.MeshBasicMaterial({
            map: tex,
            transparent: true,
            opacity: 0.35,
            side: THREE.DoubleSide,
            depthWrite: false,
            blending: THREE.AdditiveBlending
        });

        const field = new THREE.Mesh(geo, mat);
        field.rotation.x = -Math.PI / 2;
        field.position.y = -8.0; // Sunk deep
        _scene.add(field);

        // Store references for DevTools
        window.flux.floorGlyphMesh = field;
        window.flux.floorGlyphMat = mat;
    }

function createHolographicRings() {
        // Floating Holographic Rings (Mid-height)
        const ringGeo = new THREE.TorusGeometry(20, 0.1, 16, 100);
        const ringMat = new THREE.MeshBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0.3, blending: THREE.AdditiveBlending });
        const ring1 = new THREE.Mesh(ringGeo, ringMat);
        ring1.rotation.x = Math.PI / 2;
        ring1.position.y = 0;
        _scene.add(ring1);
        
        const ring2 = new THREE.Mesh(ringGeo, ringMat);
        ring2.rotation.x = Math.PI / 2;
        ring2.scale.setScalar(1.2);
        ring2.position.y = 4.0;
        _scene.add(ring2);

        // Animate Rings (integrated into main loop to avoid a second RAF on mobile)
let _ringTime = 0;
        const _ringUpdate = (dt) => {
            _ringTime += dt;
            if (ring1) {
                ring1.rotation.z += dt * 0.9;
                ring1.scale.setScalar(1.0 + Math.sin(_ringTime * 0.5) * 0.05);
            }
            if (ring2) {
                ring2.rotation.z -= dt * 0.75;
                ring2.position.y = 4.0 + Math.cos(_ringTime * 0.7) * 1.0;
            }
        };
        if (window.flux && window.flux._runtimeUpdaters) window.flux._runtimeUpdaters.push(_ringUpdate);
    }

    // --- INPUT SYSTEM ---
// --- INPUT SYSTEM ---
const _keys = {};
// Globals moved to below helper

    // Helper: Analyze curve geometry for analog control
    const analyzeSwipeCurve = (points) => {
        if (points.length < 3) return { intensity: 0, speed: 0, dx: 0, dy: 0 };
        
        const pStart = points[0];
        const pEnd = points[points.length - 1];
        const midIdx = Math.floor(points.length / 2);
        const pMid = points[midIdx];

        const dx = pEnd.x - pStart.x;
        const dy = pEnd.y - pStart.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        const dt = pEnd.t - pStart.t;
        const speed = (dt > 0) ? dist / dt : 0; // px/ms

        if (dist < 50) return { intensity: 0, speed: speed, dx, dy };

        const vSM_x = pMid.x - pStart.x;
        const vSM_y = pMid.y - pStart.y;

        // Cross product gives signed area/curvature direction
        const cross = (dx * vSM_y) - (dy * vSM_x);
        // Normalize by distance squared to get a curvature ratio independent of scale
const intensity = cross / (dist * dist);

        return { intensity, speed, dx, dy };
    };
    let _swipePoints = []; // Track swipe history for curves
    const _aimInput = { x: 0, y: 0, active: false }; // NEW: Aim joystick

    const _actionBuffer = { active: false, timestamp: 0, duration: 300 };

    const _camFwd = new THREE.Vector3();
    const _camRight = new THREE.Vector3();
    const _upAxis = new THREE.Vector3(0, 1, 0);

function setupInputs() {
        // Skip Intro Listener
        const skipHandler = () => {
            if (window.flux.gameInstance && window.flux.gameInstance.state === 'intro') {
                window.flux.gameInstance.skipIntro();
            }
        };
        window.addEventListener('mousedown', skipHandler);
        window.addEventListener('touchstart', skipHandler, {passive: true});

        // Keyboard
        window.addEventListener('keydown', (e) => {
            _keys[e.key] = true;
            if (e.code === 'Space' && _homeTeam && _homeTeam.activePlayer && _ball) {
                _homeTeam.activePlayer.throwBall(_ball);
            }
            // NEW: Tackle on Shift
            if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') {
                if (_homeTeam && _homeTeam.activePlayer) {
                    const p = _homeTeam.activePlayer;
                    if (!p.hasBall) {
                        p.dash(p.inputVector.x, p.inputVector.z);
                    }
                }
            }
            updateInputVector();
        });
        window.addEventListener('keyup', (e) => { _keys[e.key] = false; updateInputVector(); });

        // --- FLOATING JOYSTICK (Movement) ---
        const hitZone = document.getElementById('joystick-hit-zone');
        const visuals = document.getElementById('joystick-visual-container');
        const base = document.getElementById('joystick-base');
        const knob = document.getElementById('joystick-knob');

        let startX = 0, startY = 0;
        let dragging = false;
        const maxDist = 40;

        let moveTouchId = null;
        const moveDeadzonePx = 6;

        // Expose move joystick state for snapshots
        const _dbg = window.flux._debugIO = window.flux._debugIO || {};
        _dbg.settings = _settings;
        _dbg.input = _dbg.input || {};
        _dbg.input.move = _dbg.input.move || {};
        _dbg.input.move.vector = _input;
        _dbg.input.move.dragging = dragging;
        _dbg.input.move.touchId = moveTouchId;


        const handleStart = (clientX, clientY) => {
            dragging = true;
            startX = clientX;

            if (_dbg && _dbg.input && _dbg.input.move) {
                _dbg.input.move.dragging = dragging;
            }

            startY = clientY;

            visuals.style.display = 'block';
            visuals.style.left = `${clientX}px`;
            visuals.style.top = `${clientY}px`;

            knob.style.transform = `translate(-50%, -50%)`;

            createRipple(clientX, clientY);

            _input.x = 0;
            _input.y = 0;
            updateInputVector();
        };

        const handleMove = (clientX, clientY) => {
            if (!dragging) return;

            let dx = clientX - startX;
            let dy = clientY - startY;

            const dist = Math.sqrt(dx*dx + dy*dy);


            // Deadzone to prevent drift from tiny thumb jitter
            if (dist < moveDeadzonePx) {
                dx = 0;
                dy = 0;
            }

            if (dist > maxDist) {
                dx = (dx / dist) * maxDist;
                dy = (dy / dist) * maxDist;
            }

            knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;

            _input.x = (dx / maxDist) * _settings.joystickSensitivity;
            _input.y = (dy / maxDist) * _settings.joystickSensitivity;
            updateInputVector();
        };

        const handleEnd = () => {
            if (!dragging) return;
            dragging = false;

            moveTouchId = null;

            visuals.style.display = 'none';

            if (_dbg && _dbg.input && _dbg.input.move) {
                _dbg.input.move.dragging = dragging;
                _dbg.input.move.touchId = moveTouchId;
            }


            _input.x = 0;
            _input.y = 0;
            updateInputVector();
        };

        if (hitZone) {
            hitZone.addEventListener('touchstart', (e) => {
                if (e.cancelable) e.preventDefault();
                const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e.touches[0];
                moveTouchId = t ? t.identifier : null;
                if (_dbg && _dbg.input && _dbg.input.move) {
                    _dbg.input.move.touchId = moveTouchId;
                }
                handleStart(t.clientX, t.clientY);
            }, { passive: false });

            window.addEventListener('touchmove', (e) => {
                if (!dragging) return;
                if (e.cancelable) e.preventDefault();
                const t = _findTouchById(e.touches, moveTouchId);
                if (!t) return;
                handleMove(t.clientX, t.clientY);
            }, { passive: false });

            window.addEventListener('touchend', (e) => {
                if (!dragging) return;
                const tEnd = _endedTouchById(e.changedTouches, moveTouchId);
                if (!tEnd) return; // Ignore other fingers lifting
                handleEnd();
            });
            window.addEventListener('touchcancel', (e) => {
                if (!dragging) return;
                const tEnd = _endedTouchById(e.changedTouches, moveTouchId);
                if (!tEnd) return;
                handleEnd();
            });

            hitZone.addEventListener('mousedown', (e) => {
                handleStart(e.clientX, e.clientY);
            });
            window.addEventListener('mousemove', (e) => {
                if (dragging) handleMove(e.clientX, e.clientY);
            });
            window.addEventListener('mouseup', handleEnd);
        }

        // --- NEW: AIM JOYSTICK (Right side) ---
        setupAimJoystick();

        // --- NEW: TACKLE BUTTON ---
        setupTackleButton();

        // Swipe Detection
// Swipe Detection
        let swipeStart = { x: 0, y: 0, t: 0 };
        let swipeTouchId = null;
        
        // Expose swipe/throw gesture state for snapshots
        _dbg.input.swipe = _dbg.input.swipe || {};
        _dbg.input.swipe.start = swipeStart;
        _dbg.input.swipe.touchId = swipeTouchId;
        _dbg.input.swipe.points = _swipePoints;
const onSwipeStart = (x, y) => {
            swipeStart.x = x;
            swipeStart.y = y;
            swipeStart.t = Date.now();
            _swipePoints = [{x, y, t: Date.now()}];
        };

const onSwipeMove = (x, y) => {
            if (_swipePoints.length > 0) {
                _swipePoints.push({x, y, t: Date.now()});
                createSwipeTrailDot(x, y); // Visual Feedback
            }
        };

const onSwipeEnd = (x, y) => {
            if (_swipePoints.length < 2) return;
            _swipePoints.push({x, y, t: Date.now()});

            const { intensity, speed, dx, dy } = analyzeSwipeCurve(_swipePoints);
            const dist = Math.sqrt(dx*dx + dy*dy);

            if (_homeTeam && _homeTeam.activePlayer && _camera) {
                const p = _homeTeam.activePlayer;

                // --- CURVE BALL DETECTION (Immediate Throw) ---
// --- CURVE BALL DETECTION (Immediate Throw) ---
                if (p.hasBall && !p.isThrowing && !p.isCharging) {
                    // Analog Curve Check: Threshold 0.25 requires a deliberate arc (The "Feat")
                    if (Math.abs(intensity) > 0.25 && dist > 100) {
                        _camera.getWorldDirection(_camFwd);
                        _camFwd.y = 0; _camFwd.normalize();
                        _camRight.crossVectors(_camFwd, _upAxis).normalize();

                        const worldX = (_camRight.x * dx) + (_camFwd.x * -dy);
                        const worldZ = (_camRight.z * dx) + (_camFwd.z * -dy);
                        const throwDir = new THREE.Vector3(worldX, 0, worldZ).normalize();

                        // Map intensity to spin - Drastically reduced sensitivity
                        const rawSpin = Math.abs(intensity) * 300.0; 
                        const speedFactor = Math.min(1.5, speed / 1.0);
                        const spinPower = Math.min(400.0, rawSpin * speedFactor);
                        const spinSign = Math.sign(intensity); 
                        const spinVec = new THREE.Vector3(0, spinPower * spinSign, 0);


                        p.setOverrideAim(throwDir.x, throwDir.z);
                        p.throwBall(window.flux.gameInstance.entities.ball, 'SH', 1.0, spinVec);
                        
                        if (window.flux.gameInstance.floatingText) {
                            window.flux.gameInstance.floatingText.spawn("CURVE", p.mesh.position, "tech");
                        }
                        createRipple(x, y);
                        _swipePoints = [];
                        return; 
                    }
                }

                // --- STANDARD DASH / AIM ---
                _camera.getWorldDirection(_camFwd);
                _camFwd.y = 0;
                if (_camFwd.lengthSq() < 0.001) _camFwd.set(0, 0, -1);
                else _camFwd.normalize();

                _camRight.crossVectors(_camFwd, _upAxis).normalize();

const worldX2 = (_camRight.x * dx) + (_camFwd.x * -dy);
                const worldZ2 = (_camRight.z * dx) + (_camFwd.z * -dy);

                if (p.isThrowing) {
p.setOverrideAim(worldX2, worldZ2);
                    if (window.flux.gameInstance.floatingText) {
                        window.flux.gameInstance.floatingText.spawn("AIM!", p.mesh.position, "default");
                    }
                } else {
if (dist > 50) p.dash(worldX2, worldZ2);
                }

                createRipple(x, y);
            }
_swipePoints = [];
        };

        window.addEventListener('touchstart', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;

            const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e.touches[0];
            swipeTouchId = t ? t.identifier : null;
// onSwipeStart(t.clientX, t.clientY); // Fixed syntax error
            if (_dbg && _dbg.input && _dbg.input.swipe) { _dbg.input.swipe.touchId = swipeTouchId; }
            onSwipeStart(t.clientX, t.clientY);
            createRipple(t.clientX, t.clientY);
        }, { passive: false });

window.addEventListener('touchmove', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone')) return;
            const t = _findTouchById(e.touches, swipeTouchId);
            if (!t) return;
            onSwipeMove(t.clientX, t.clientY);
        }, { passive: false });

        window.addEventListener('touchend', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;
            const tEnd = _endedTouchById(e.changedTouches, swipeTouchId);
            if (!tEnd) return; // Ignore other fingers lifting
            onSwipeEnd(tEnd.clientX, tEnd.clientY);
            swipeTouchId = null;
            if (_dbg && _dbg.input && _dbg.input.swipe) { _dbg.input.swipe.touchId = swipeTouchId; }
        });

                window.addEventListener('touchcancel', (e) => {
if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;
            const tEnd = _endedTouchById(e.changedTouches, swipeTouchId);
            if (!tEnd) return; // Ignore other fingers lifting
            onSwipeEnd(tEnd.clientX, tEnd.clientY);
            swipeTouchId = null;
            if (_dbg && _dbg.input && _dbg.input.swipe) { _dbg.input.swipe.touchId = swipeTouchId; }
        
        });
// Mouse Swipe
        window.addEventListener('mousedown', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;

            onSwipeStart(e.clientX, e.clientY);
            createRipple(e.clientX, e.clientY);
        });

        window.addEventListener('mousemove', (e) => {
             if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone')) return;
            // Only track if mouse is down (simulating drag)
            if (e.buttons === 1) {
                onSwipeMove(e.clientX, e.clientY);
            }
        });


        window.addEventListener('mouseup', (e) => {
            if (e.target.closest('#joystick-hit-zone') ||
                e.target.closest('#action-button') ||
                e.target.closest('#tackle-button') ||
                e.target.closest('#aim-joystick-zone') ||
                e.target.closest('#auto-toggle') ||
                e.target.closest('#settings-button')) return;
            onSwipeEnd(e.clientX, e.clientY);
        });

        // Action Button (Shoot/Pass)
        const actionBtn = document.getElementById('action-button');

const setupButton = (btn) => {
            if (!btn) return;

            let btnStartX = 0;
            let btnStartY = 0;
            let isDragging = false;
            let swipePoints = [];
            let actionTouchId = null;

            const attemptAction = () => {
                if (!_homeTeam || !_homeTeam.activePlayer) return false;
                const p = _homeTeam.activePlayer;

                if (p.hasBall && !p.isCharging && !p.isThrowing && p.status.nap <= 0) {
                    p.startCharge();
                    btn.classList.add('active');
                    return true;
                }
                return false;
            };

            const handleStart = (e) => {
                if (e.cancelable) e.preventDefault();

                if (_gameManager && _gameManager.techCopyState.active) {
                    _gameManager.attemptTechCopy();
                    btn.classList.add('active');
                    setTimeout(() => btn.classList.remove('active'), 100);
                    return;
                }

                if (_gameManager && _gameManager.isDemoMode) return;

                let clientX = e.clientX;
                let clientY = e.clientY;
                if (e.changedTouches && e.changedTouches.length) {
                    const t = e.changedTouches[0];
                    actionTouchId = t.identifier;
                    clientX = t.clientX;
                    clientY = t.clientY;
                } else {
                    actionTouchId = null; // mouse
                }
                btnStartX = clientX;
                btnStartY = clientY;
                isDragging = true;
                swipePoints = [{x: clientX, y: clientY, t: Date.now()}];

                _actionBuffer.active = true;
                _actionBuffer.timestamp = Date.now();

                if (attemptAction()) {
                    _actionBuffer.active = false;
                }

                // Attach global listeners to track swipe outside button
                window.addEventListener('touchmove', handleMove, { passive: false });
                window.addEventListener('touchend', handleEnd);
                window.addEventListener('touchcancel', handleEnd);
                window.addEventListener('mousemove', handleMove);
                window.addEventListener('mouseup', handleEnd);
            };

            const handleMove = (e) => {
                if (!isDragging) return;

                // Touch path (multi-touch safe)
                if (e.touches && actionTouchId !== null) {
                    const t = _findTouchById(e.touches, actionTouchId);
                    if (!t) return;
                    swipePoints.push({x: t.clientX, y: t.clientY, t: Date.now()});
                    return;
                }

                // Mouse path
                const clientX = e.clientX;
                const clientY = e.clientY;
                swipePoints.push({x: clientX, y: clientY, t: Date.now()});
            };

const handleEnd = (e) => {
                let dx = 0;
                let dy = 0;
                let validEnd = false;

                // 1. Check Touch
                if (e.changedTouches && actionTouchId !== null) {
                    const tEnd = _endedTouchById(e.changedTouches, actionTouchId);
                    if (tEnd) {
                        dx = tEnd.clientX - btnStartX;
                        dy = tEnd.clientY - btnStartY;
                        validEnd = true;
                        actionTouchId = null;
                    }
                } 
                // 2. Check Mouse
                else if (!e.changedTouches && isDragging) {
                    dx = e.clientX - btnStartX;
                    dy = e.clientY - btnStartY;
                    validEnd = true;
                }

                if (!validEnd) return;

                // Cleanup listeners
                window.removeEventListener('touchmove', handleMove);
                window.removeEventListener('touchend', handleEnd);
                window.removeEventListener('touchcancel', handleEnd);
                window.removeEventListener('mousemove', handleMove);
                window.removeEventListener('mouseup', handleEnd);

                if (!isDragging) return;
                isDragging = false;
                
                const wasBuffered = _actionBuffer.active;
                _actionBuffer.active = false;

                if (_homeTeam && _homeTeam.activePlayer) {
                    const p = _homeTeam.activePlayer;
                    
                    // Curve Analysis
                    let curveData = null;
                    let spinVec = null;

                    // Calculate curve if we have enough data
// Calculate curve if we have enough data
                    if (swipePoints.length > 2) {
                        const analysis = analyzeSwipeCurve(swipePoints);
                        // High threshold for button release too
                        if (Math.abs(analysis.intensity) > 0.25) {
                            curveData = analysis;
                            
                            // Calculate spin vector for mouse/touch unified (Conservative values)
                            const spinPower = Math.min(400.0, Math.abs(analysis.intensity) * 1500.0);
                            const spinSign = Math.sign(analysis.intensity);
                            spinVec = new THREE.Vector3(0, spinPower * spinSign, 0);
                        }
}

                    // EXECUTE
                    if (p.isCharging) {
                        // Normal Release
                        if (spinVec) {
                            // Unified spin passing
                            p.releaseCharge(dx, dy, { intensity: curveData.intensity, speed: curveData.speed }); 
                        } else {
                            p.releaseCharge(dx, dy, curveData);
                        }
                        btn.classList.remove('active');
                    } 
                    else if (wasBuffered && p.hasBall && !p.isThrowing && p.status.nap <= 0) {
                        // Buffered Tap (Instant Shot)
                        // Force start and release immediately
                        p.startCharge();
                        p.releaseCharge(dx, dy, curveData);
                        btn.classList.remove('active');
                    }
                }
            };

            btn.addEventListener('touchstart', handleStart, { passive: false });
            btn.addEventListener('mousedown', handleStart);
        };
        setupButton(actionBtn);

// Auto Toggle
        const autoBtn = document.getElementById('auto-toggle');
        if (autoBtn) {
            const handleToggle = () => {
                if (_gameManager) {
                    _gameManager.toggleDemoMode();
                    if (_homeTeam && _homeTeam.activePlayer) {
                        _homeTeam.activePlayer.setInput(0, 0);
                    }
                }
            };

            autoBtn.addEventListener('click', handleToggle);
autoBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleToggle();
            }, { passive: false });
        }

        // NEW: Settings Button
        setupSettingsButton();
    }

    // NEW: Aim Joystick Setup
// NEW: Aim Joystick Setup
function setupAimJoystick() {
        const aimKnob = document.getElementById('aim-joystick-knob');
        const aimVisuals = document.getElementById('aim-joystick-visual');
        const aimZone = document.getElementById('aim-joystick-zone');
        if (!aimZone) return;
        let aimStartX = 0, aimStartY = 0;
        let aimDragging = false;
        const aimMaxDist = 35;
        let aimTouchId = null;

        

        // Expose aim joystick state for snapshots
        const _dbg = window.flux._debugIO = window.flux._debugIO || {};
        _dbg.settings = _settings;
        _dbg.input = _dbg.input || {};
        _dbg.input.aim = _dbg.input.aim || {};
        _dbg.input.aim.vector = _aimInput;
        _dbg.input.aim.dragging = aimDragging;
        _dbg.input.aim.touchId = aimTouchId;
const handleAimStart = (clientX, clientY) => {
            aimDragging = true;
            aimStartX = clientX;

            if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.dragging = aimDragging; }

            aimStartY = clientY;
            _aimInput.active = true;

            if (aimVisuals) {
                aimVisuals.style.display = 'block';
                aimVisuals.style.left = `${clientX}px`;
                aimVisuals.style.top = `${clientY}px`;
            }
            if (aimKnob) {
                aimKnob.style.transform = `translate(-50%, -50%)`;
            }
        };

        const handleAimMove = (clientX, clientY) => {
            if (!aimDragging) return;

            let dx = clientX - aimStartX;
            let dy = clientY - aimStartY;

            const dist = Math.sqrt(dx*dx + dy*dy);

            if (dist > aimMaxDist) {
                dx = (dx / dist) * aimMaxDist;
                dy = (dy / dist) * aimMaxDist;
            }

            if (aimKnob) {
                aimKnob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            }

            // Normalize and transform to world space
            _aimInput.x = dx / aimMaxDist;
            _aimInput.y = dy / aimMaxDist;

            // Apply aim to player if charging
            if (_homeTeam && _homeTeam.activePlayer) {
                const p = _homeTeam.activePlayer;
                if (p.isCharging || p.isThrowing) {
                    // Transform screen aim to world space
                    _camera.getWorldDirection(_camFwd);
                    _camFwd.y = 0;
                    if (_camFwd.lengthSq() < 0.001) _camFwd.set(0, 0, -1);
                    else _camFwd.normalize();
                    _camRight.crossVectors(_camFwd, _upAxis).normalize();

                    const worldX = (_camRight.x * _aimInput.x) + (_camFwd.x * -_aimInput.y);
                    const worldZ = (_camRight.z * _aimInput.x) + (_camFwd.z * -_aimInput.y);

                    if (Math.abs(worldX) > 0.1 || Math.abs(worldZ) > 0.1) {
                        p.setOverrideAim(worldX, worldZ);
                    }
                }
            }
        };

const handleAimEnd = () => {
            if (!aimDragging) return;
            aimDragging = false;
            _aimInput.active = false;
            _aimInput.x = 0;
            _aimInput.y = 0;

            if (aimVisuals) {
                aimVisuals.style.display = 'none';
            }

            // Clear player aim override
            if (_homeTeam && _homeTeam.activePlayer) {
                _homeTeam.activePlayer.overrideAimVector = null;
            }
        };

        aimZone.addEventListener('touchstart', (e) => {
            if (e.cancelable) e.preventDefault();
            const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e.touches[0];
            aimTouchId = t ? t.identifier : null;
            if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.touchId = aimTouchId; }
            handleAimStart(t.clientX, t.clientY);
        }, { passive: false });

        window.addEventListener('touchmove', (e) => {
            if (!aimDragging) return;
            if (e.cancelable) e.preventDefault();
            const t = _findTouchById(e.touches, aimTouchId);
            if (!t) return;
            handleAimMove(t.clientX, t.clientY);
        }, { passive: false });

        window.addEventListener('touchend', (e) => {
            if (!aimDragging) return;
            const tEnd = _endedTouchById(e.changedTouches, aimTouchId);
            if (!tEnd) return;
            aimTouchId = null;
            handleAimEnd();
            if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.touchId = aimTouchId; _dbg.input.aim.dragging = aimDragging; }
            handleAimEnd();
        });

                window.addEventListener('touchcancel', (e) => {
            if (!aimDragging) return;
                        const tEnd = _endedTouchById(e.changedTouches, aimTouchId);
                        if (!tEnd) return;
                        aimTouchId = null;
                        handleAimEnd();
                        if (_dbg && _dbg.input && _dbg.input.aim) { _dbg.input.aim.touchId = aimTouchId; _dbg.input.aim.dragging = aimDragging; }
                        handleAimEnd();
        });
// Mouse support for desktop testing
        aimZone.addEventListener('mousedown', (e) => {
            handleAimStart(e.clientX, e.clientY);
        });
        window.addEventListener('mousemove', (e) => {
            if (aimDragging) handleAimMove(e.clientX, e.clientY);
        });
        window.addEventListener('mouseup', (e) => {
            if (aimDragging) handleAimEnd();
        });
    }

    // NEW: Tackle Button Setup
    function setupTackleButton() {
        const tackleBtn = document.getElementById('tackle-button');
        if (!tackleBtn) return;

const handleTackle = (e) => {
            if (e.cancelable) e.preventDefault();
            e.stopPropagation(); // Prevent bubbling to joystick

            if (_gameManager && _gameManager.isDemoMode) return;

            if (_homeTeam && _homeTeam.activePlayer) {
                const p = _homeTeam.activePlayer;

                // Visual Feedback immediately
                tackleBtn.classList.add('active');
                setTimeout(() => tackleBtn.classList.remove('active'), 150);

                // If we don't have the ball, dash/tackle
                if (!p.hasBall) {
                    // Get current movement direction or forward
                    let dashX = p.inputVector.x;
                    let dashZ = p.inputVector.z;

                    // If not moving, dash forward relative to player facing
                    if (Math.abs(dashX) < 0.1 && Math.abs(dashZ) < 0.1) {
                        const fwd = new THREE.Vector3(0, 0, 1).applyQuaternion(p.mesh.quaternion);
                        dashX = fwd.x;
                        dashZ = fwd.z;
                    }

                    p.dash(dashX, dashZ);

                    if (window.flux.gameInstance.floatingText) {
                        // Only show text if dash actually happened (cooldown check inside dash)
                        if (p.isDashing) {
                            window.flux.gameInstance.floatingText.spawn("TACKLE!", p.mesh.position, "tech");
                        }
                    }
                } else if (p.isEngaged) {
                    // Break tackle if engaged
                    p.dash(p.inputVector.x, p.inputVector.z);
                }
            }
        };

        tackleBtn.addEventListener('touchstart', handleTackle, { passive: false });
        tackleBtn.addEventListener('mousedown', handleTackle);
    }

    // NEW: Settings Button Setup
// NEW: Settings Button Setup
function setupSettingsButton() {
        const settingsBtn = document.getElementById('settings-button');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsClose = document.getElementById('settings-close');

        if (!settingsBtn || !settingsPanel) return;

        settingsBtn.addEventListener('click', () => {
            settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'block' : 'none';
        });

        if (settingsClose) {
            settingsClose.addEventListener('click', () => {
                settingsPanel.style.display = 'none';
            });
        }

        // Sensitivity slider
        const sensitivitySlider = document.getElementById('sensitivity-slider');
        if (sensitivitySlider) {
            sensitivitySlider.value = _settings.joystickSensitivity * 100;
            sensitivitySlider.addEventListener('input', (e) => {
                _settings.joystickSensitivity = e.target.value / 100;
            });
        }

        // Aim assist toggle
        const aimAssistToggle = document.getElementById('aim-assist-toggle');
        if (aimAssistToggle) {
            aimAssistToggle.checked = _settings.aimAssist;
            aimAssistToggle.addEventListener('change', (e) => {
                _settings.aimAssist = e.target.checked;
            });
        }

        // Camera shake toggle
        const shakeToggle = document.getElementById('shake-toggle');
        if (shakeToggle) {
            shakeToggle.checked = _settings.cameraShake;
            shakeToggle.addEventListener('change', (e) => {
                _settings.cameraShake = e.target.checked;
            });
        }

        // Volume slider
        const volumeSlider = document.getElementById('volume-slider');
        if (volumeSlider && _audioManager) {
            volumeSlider.addEventListener('input', (e) => {
                const vol = e.target.value / 100;
_audioManager.setMasterVolume(vol);
            });
        }

        // Exit to Menu
        const exitBtn = document.getElementById('exit-to-menu-btn');
        if (exitBtn) {
            exitBtn.addEventListener('click', () => {
                if (_menuManager) {
                    _menuManager.show();
                    if (_gameManager) {
                        _gameManager.state = 'menu';
                        // Stop practice if running
                        if (_gameManager.practiceManager) {
                            _gameManager.practiceManager.stop();
                        }
                    }
                    settingsPanel.style.display = 'none';
                }
            });
        }
    }

    function updateInputVector() {
        let x = _input.x || 0;
        let z = _input.y || 0;

        if (_keys['w'] || _keys['ArrowUp']) z -= 1;
        if (_keys['s'] || _keys['ArrowDown']) z += 1;
        if (_keys['a'] || _keys['ArrowLeft']) x -= 1;
        if (_keys['d'] || _keys['ArrowRight']) x += 1;

        const lenSq = x*x + z*z;
        if (lenSq > 1) {
            const len = Math.sqrt(lenSq);
            x /= len;
            z /= len;
        }

        if (isNaN(x)) x = 0;
        if (isNaN(z)) z = 0;

        if (_camera) {
            _camera.getWorldDirection(_camFwd);
            _camFwd.y = 0;

            if (_camFwd.lengthSq() < 0.001) {
                _camFwd.set(0, 0, -1);
            } else {
                _camFwd.normalize();
            }

            _camRight.crossVectors(_camFwd, _upAxis).normalize();
        } else {
            _camFwd.set(0, 0, -1);
            _camRight.set(1, 0, 0);
        }

        let worldX = (_camFwd.x * -z) + (_camRight.x * x);
        let worldZ = (_camFwd.z * -z) + (_camRight.z * x);

        if (isNaN(worldX) || isNaN(worldZ)) {
            worldX = 0;
            worldZ = 0;
        }

if (_homeTeam && _homeTeam.activePlayer) {
            // FIX: Only allow movement if game is active or in practice
            const gm = window.flux.gameInstance;
            const canMove = gm && !gm.isDemoMode && (gm.state === 'active');
            
            if (canMove) {
                _homeTeam.activePlayer.setInput(worldX, worldZ);
            } else {
                _homeTeam.activePlayer.setInput(0, 0);
            }
        }
}

    function createRipple(x, y) {
        const ripple = document.createElement('div');
        ripple.className = 'touch-ripple';
        ripple.style.left = `${x}px`;
        ripple.style.top = `${y}px`;
        document.getElementById('ui-layer').appendChild(ripple);

        setTimeout(() => {
            if (ripple.parentNode) ripple.parentNode.removeChild(ripple);
        }, 600);

    }

    // NEW: Visual Swipe Trail
    function createSwipeTrailDot(x, y) {
        const dot = document.createElement('div');
        dot.className = 'swipe-trail-dot';
        dot.style.left = `${x - 6}px`; // Center (12px width)
        dot.style.top = `${y - 6}px`;
        document.getElementById('ui-layer').appendChild(dot);
        
        // CSS animation handles removal, but we clean up DOM to be safe
        setTimeout(() => {
            if (dot.parentNode) dot.parentNode.removeChild(dot);
        }, 500);
    }

    function onResize() {
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        if (_camera) {
            _camera.aspect = width / height;
            _camera.updateProjectionMatrix();
        }
        
        // Strictly 0.50 as requested
        const resScale = 0.50;
        
        _config.internalWidth = Math.floor(width * resScale);
        _config.internalHeight = Math.floor(height * resScale);

        if (_renderer) {
            _renderer.setSize(_config.internalWidth, _config.internalHeight, false);
        }
    }

// --- FIXED TIMESTEP VARIABLES ---
    let _accumulator = 0;
    const _fixedStep = 1 / 60;

    function animate() {
        requestAnimationFrame(animate);

        const rawDt = _clock.getDelta();
        // Clamp dt to prevent spirals (max 0.1s)
        const dt = Math.min(rawDt, 0.1) * (window.flux.timeScale !== undefined ? window.flux.timeScale : 0.8);

        // Perf stats for DevTools
        if (window.flux && window.flux._debugIO && window.flux._debugIO.perf) {
            const perf = window.flux._debugIO.perf;
            perf.frame = (perf.frame || 0) + 1;
            perf.rawDt = rawDt;
            perf.dt = dt;
            const fps = dt > 0 ? (1 / dt) : 0;
            perf.fps = fps;
            perf.avgFps = (perf.avgFps && perf.avgFps > 0) ? (perf.avgFps * 0.9 + fps * 0.1) : fps;
        }

        // Impact Frames (Freeze Frame Effect)
        if (_gameManager && _gameManager.impactPause > 0) {
            _gameManager.impactPause -= dt;
            if (_renderer && _scene && _camera) {
                _renderer.render(_scene, _camera);
            }
            return;
        }

        updateInputVector();

        // Action Buffer Processing
        if (_actionBuffer.active) {
            if (Date.now() - _actionBuffer.timestamp > _actionBuffer.duration) {
                _actionBuffer.active = false;
            } else {
                if (_homeTeam && _homeTeam.activePlayer) {
                    const p = _homeTeam.activePlayer;
                    if (p.hasBall && !p.isCharging && !p.isThrowing && p.status.nap <= 0) {
                        p.startCharge();
                        const btn = document.getElementById('action-button');
                        if (btn) btn.classList.add('active');
                        _actionBuffer.active = false;
                    }
                }
            }
        }

        // --- FIXED UPDATE LOOP (Physics & Game Logic) ---
        _accumulator += dt;
        // Safety Cap: Prevent spiral of death if frame takes too long
        if (_accumulator > 0.2) _accumulator = 0.2;

        while (_accumulator >= _fixedStep) {
            const _sdt = _fixedStep;

            if (_gameManager) _gameManager.update(_sdt);

            // If in Asset Forge mode, skip game logic
            if (_gameManager && _gameManager.isForgeMode) {
                _accumulator = 0; 
                return;
            }

            const gmState = _gameManager ? _gameManager.state : '';
            const isIntro = gmState === 'intro';
            const isMenu = gmState === 'menu';

            // Update Entities (Physics/AI)
            if (_homeTeam && !isIntro && !isMenu) {
                _homeTeam.update(_sdt);
                _homeTeam.players.forEach(p => checkBallGrab(p));
            }

            if (_awayTeam && !isIntro && !isMenu) {
                _awayTeam.update(_sdt);
                _awayTeam.players.forEach(p => checkBallGrab(p));
            }

            if (_ball && !isIntro && !isMenu) {
                _ball.update(_sdt);
            }

            // Ball Lab
            if (window.flux && window.flux.ballLab && typeof window.flux.ballLab.update === 'function') {
                window.flux.ballLab.update(_sdt);
            }

            // Runtime Updaters (e.g. Rings logic)
            if (window.flux && window.flux._runtimeUpdaters && window.flux._runtimeUpdaters.length) {
                for (let ui = 0; ui < window.flux._runtimeUpdaters.length; ui++) {
                    const fn = window.flux._runtimeUpdaters[ui];
                    if (typeof fn === 'function') fn(_sdt);
                }
            }

            _accumulator -= _fixedStep;
        }

        // --- VISUAL UPDATE LOOP (Once Per Frame) ---
        // These systems don't affect gameplay outcome, so we update them with the visual delta `dt`
        // to ensure smooth animation at high refresh rates (90/120Hz) without wasting CPU on physics.

        const gmState = _gameManager ? _gameManager.state : '';
        const isIntro = gmState === 'intro';
        const isMenu = gmState === 'menu';

        // Camera
        if (!isIntro && !isMenu) {
            updateCameraLogic(dt);
        }

        // Visual FX Systems
        if (_waterOverlay) _waterOverlay.update(dt);
        if (_lightShafts) _lightShafts.update(dt);
        if (_stadium) _stadium.update(dt);
        if (_glyphManager) _glyphManager.update(dt);

if (_glyphManager) _glyphManager.update(dt);
        if (_gameManager) _gameManager.updateVisuals(dt);
        if (_arenaUniforms) {
            _arenaUniforms.uTime.value += dt;
            _arenaUniforms.uImpactStr.value *= Math.max(0, 1.0 - dt * 4.0);
        }

        if (window.flux.arenaGroup) {
            window.flux.arenaGroup.rotation.y += dt * 0.05;
        }

        if (window.flux.tribalUniforms) {
            window.flux.tribalUniforms.uTime.value += dt;
            let targetColor = new THREE.Color(0x00ffff);
            if (_ball && _ball.holder) {
                if (_ball.holder.team && _ball.holder.team.side === -1) {
                    targetColor.setHex(0xff8800);
                }
            }
            window.flux.tribalUniforms.uColor.value.lerp(targetColor, dt * 2.0);
        }

        if (_particleUniforms) {
            _particleUniforms.uTime.value += dt;
        }

        // Render
        if (_renderer && _scene && _camera) {
            _renderer.render(_scene, _camera);
        }

        // UI Updates
        updateUI();
    }

function updateUI() {
        // Prevent UI updates during intro to keep things hidden
        if (window.flux.gameInstance && window.flux.gameInstance.state === 'intro') return;

        if (!_homeTeam || !_homeTeam.activePlayer) return;
        const btn = document.getElementById('action-button');
        const lbl = document.getElementById('action-label');
        const tackleBtn = document.getElementById('tackle-button');
        const p = _homeTeam.activePlayer;

        if (btn && lbl) {
            const btnText = btn.querySelector('.btn-text');

            if (p.hasBall) {
                if (btnText && btnText.innerText !== "ACTION") {
                    btnText.innerText = "ACTION";
                    btn.classList.add('shoot-mode');
                    lbl.innerText = "OFFENSE";
                    lbl.classList.add('shoot-label');
                }

                const isHighEnergy = (p.stats.HP / p.stats.maxHP) > 0.4;
                if (isHighEnergy) {
                    if (!btn.classList.contains('limit-ready')) btn.classList.add('limit-ready');
                } else {
                    if (btn.classList.contains('limit-ready')) btn.classList.remove('limit-ready');
                }

            } else {
                if (btnText && btnText.innerText !== "SWIM") {
                    btnText.innerText = "SWIM";
                    btn.classList.remove('shoot-mode');
                    btn.classList.remove('limit-ready');
                    lbl.innerText = "NORMAL";
                    lbl.classList.remove('shoot-label');
                }
            }
        }

        // Update tackle button visibility
        if (tackleBtn) {
            if (!p.hasBall || p.isEngaged) {
                tackleBtn.style.display = 'flex';
                // Update tackle button text based on context
                const tackleText = tackleBtn.querySelector('.btn-text');
                if (tackleText) {
                    if (p.isEngaged && p.hasBall) {
                        tackleText.innerText = 'BREAK';
                        tackleBtn.classList.add('urgent');
                    } else {
                        tackleText.innerText = 'TACKLE';
                        tackleBtn.classList.remove('urgent');
                    }
                }
            } else {
                tackleBtn.style.display = 'none';
            }
        }

        // Update distance to goal indicator
        const distIndicator = document.getElementById('goal-distance');
        if (distIndicator && p.mesh) {
            const goalZ = (p.team && p.team.side === 1) ? -28 : 28;
            const dist = Math.abs(p.mesh.position.z - goalZ);
            distIndicator.innerText = `${Math.floor(dist)}m`;
        }
    }

function updateCameraLogic(dt) {
        if (!_cameraManager || !_ball) return;

        let targetMesh = _ball.mesh;
        let targetVel = _ball.velocity;
        let targetInput = null;
        let isAiming = false;

        if (_ball.holder && _ball.holder.mesh) {
            targetMesh = _ball.holder.mesh;
            targetVel = _ball.holder.velocity;
            if (_ball.holder.inputVector) {
                targetInput = _ball.holder.inputVector;
            }
// Check aiming state (Charging or Throwing)
            if (_ball.holder.isCharging || _ball.holder.isThrowing) {
                isAiming = true;
            }
        }

        _cameraManager.setTarget(targetMesh, targetVel, targetInput, isAiming);
        _cameraManager.update(dt);
    }

function checkBallGrab(entity) {
        if (!entity.canCatch) return;
        if (_ball && !_ball.isCatchable()) return;
        if (entity.stunTimer > 0 || (entity.status && entity.status.nap > 0)) return;
        if (_ball.state !== 'free') return;
        if (!_ball.mesh || !entity.mesh) return;

        const ballPos = _ball.mesh.position;
        const entPos = entity.mesh.position;

        const dx = ballPos.x - entPos.x;
        const dz = ballPos.z - entPos.z;
        const distXZ = Math.sqrt(dx*dx + dz*dz);
        const distY = Math.abs(ballPos.y - entPos.y);

        // --- RELAXED TOLERANCES FOR EASIER PICKUP ---
        const touchRadius = 1.5; // Increased from 1.0 (Auto-grab radius)
        let magnetRadius = 3.5;  // Increased from 1.8 (Magnetic radius)
        let interactionRadius = 6.0; // Increased from 3.5 (Turn-to radius)
        let catchHeight = 6.0;   // Increased from 3.0 (Vertical reach)

        if (entity.isDashing) {
            magnetRadius = 4.5;
            interactionRadius = 7.0;
            catchHeight = 7.0;
        }

        if (distXZ > interactionRadius || distY > catchHeight) return;

        // Optimization: Use shared vectors to avoid GC
        _tempVec1.copy(ballPos).sub(entPos).normalize(); // toBall
        _tempVec2.set(0, 0, 1).applyQuaternion(entity.mesh.quaternion).normalize(); // playerForward

        const facingDot = _tempVec2.dot(_tempVec1);

        const coneThreshold = -0.4; // More generous cone (was -0.2)
        const isInCone = facingDot > coneThreshold;
        
        // AUTO-TURN: If near but facing wrong way, turn towards ball
        if (distXZ < interactionRadius && !isInCone) {
            const targetAngle = Math.atan2(_tempVec1.x, _tempVec1.z);
            const q = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0), targetAngle);
            entity.mesh.quaternion.slerp(q, 0.2); // Faster turn (was 0.1)
            if (entity.syncRotation) entity.syncRotation();
        }

        // GRAB LOGIC
        // 1. Touch: Very close (ignore facing - prevents running over ball)
        // 2. Magnet: Close and facing
        const isTouch = distXZ < touchRadius;
        const isMagnet = distXZ < magnetRadius && isInCone;

        if (isTouch || isMagnet) {
            // BLAST THROUGH LOGIC
            const ballSpeed = _ball.velocity.length();
            let catchChance = 1.0;

            // If ball is moving fast (e.g. > 20), check CA
            if (ballSpeed > 20.0) {
                const ca = entity.getStat('CA');
                // Difficulty scales with speed. 
                const difficulty = ballSpeed * 1.2; 
                
                if (difficulty > ca) {
                    catchChance = 0.4 + (ca / difficulty) * 0.6;
                    
                    // Point Blank Penalty: Harder to react if ball is right on top of you moving fast
                    if (distXZ < 1.2) {
                        catchChance *= 0.6; // Blast through likely
                    }
                    
                    if (entity.isDashing) catchChance += 0.2;
                }
            } else if (_ball.powerType === 'SH' && _ball.power > 15.0) {
                // Shot power check
                const ca = entity.getStat('CA');
                if (_ball.power > ca * 1.2) {
                    const chance = Math.min(0.7, (_ball.power - ca) * 0.04);
                    catchChance = 1.0 - chance;
                }
            }

            let fumble = false;
            if (Math.random() > catchChance) {
                fumble = true;
            }

            if (fumble) {
                if (window.flux.gameInstance.floatingText) {
                    // Visual feedback for blast through
                    window.flux.gameInstance.floatingText.spawn("BLAST THROUGH!", entPos, "damage");
                }
                
                // Deflect slightly but keep moving fast (Blast Through)
                // Don't stop it completely like a block, just perturb it
                _ball.velocity.multiplyScalar(0.85); 
                _ball.velocity.x += (Math.random()-0.5) * 5.0;
                _ball.velocity.y += (Math.random()) * 5.0; // Pop up
                _ball.velocity.z += (Math.random()-0.5) * 5.0;
                
                _ball.power *= 0.7;

                entity.canCatch = false;
                // Stun briefly
                entity.stunTimer = 0.5;
                if(entity.play) entity.play('react', 0.1);
                
                setTimeout(() => { entity.canCatch = true; }, 1000);

            } else {
                _ball.magnetize(entity);
            }
        }
    }

    // Start
    init();
})();</script>


</body></html>